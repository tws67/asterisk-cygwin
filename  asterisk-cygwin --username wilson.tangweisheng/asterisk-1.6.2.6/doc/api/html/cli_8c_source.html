<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:37 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>cli.c</h1><a href="cli_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Standard Command Line Interface</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 236899 $&quot;</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &quot;asterisk/_private.h&quot;</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* use ast_config_AST_MODULE_DIR */</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;regex.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;grp.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;editline/readline/readline.h&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="threadstorage_8h.html" title="Definitions to aid in the use of thread local storage.">asterisk/threadstorage.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="comment"></span>
<a name="l00050"></a>00050 <span class="comment">/*!</span>
<a name="l00051"></a>00051 <span class="comment"> * \brief List of restrictions per user.</span>
<a name="l00052"></a>00052 <span class="comment"> */</span>
<a name="l00053"></a><a class="code" href="structcli__perm.html">00053</a> <span class="keyword">struct </span><a class="code" href="structcli__perm.html" title="List of restrictions per user.">cli_perm</a> {
<a name="l00054"></a><a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">00054</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">permit</a>:1;           <span class="comment">/*!&lt; 1=Permit 0=Deny */</span>
<a name="l00055"></a><a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">00055</a>    <span class="keywordtype">char</span> *<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>;          <span class="comment">/*!&lt; Command name (to apply restrictions) */</span>
<a name="l00056"></a><a class="code" href="structcli__perm.html#ad670f4bd3ed1de353cfd64c0a896cdf7">00056</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structcli__perm.html" title="List of restrictions per user.">cli_perm</a>) <a class="code" href="structcli__perm.html#a57fc49456ff8578b794001445a8f2249">list</a>;
<a name="l00057"></a>00057 };
<a name="l00058"></a>00058 
<a name="l00059"></a><a class="code" href="structcli__perm__head.html#a2cb85511bdf6c43d355907492a0c940c">00059</a> <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(<a class="code" href="structcli__perm__head.html">cli_perm_head</a>, <a class="code" href="structcli__perm.html" title="List of restrictions per user.">cli_perm</a>);
<a name="l00060"></a>00060 <span class="comment"></span>
<a name="l00061"></a>00061 <span class="comment">/*! \brief list of users to apply restrictions. */</span>
<a name="l00062"></a><a class="code" href="structusergroup__cli__perm.html">00062</a> struct <a class="code" href="structusergroup__cli__perm.html" title="list of users to apply restrictions.">usergroup_cli_perm</a> {
<a name="l00063"></a><a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">00063</a>    <span class="keywordtype">int</span> uid;          <span class="comment">/*!&lt; User ID (-1 disabled) */</span>
<a name="l00064"></a><a class="code" href="structusergroup__cli__perm.html#a6567680a890171fbaa1a026477a858d3">00064</a>    <span class="keywordtype">int</span> gid;          <span class="comment">/*!&lt; Group ID (-1 disabled) */</span>
<a name="l00065"></a><a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">00065</a>    <span class="keyword">struct </span>cli_perm_head *<a class="code" href="group__Group__AMI.html#gac34fccf799ea11437149bf669762f3da">perms</a>;     <span class="comment">/*!&lt; List of permissions. */</span>
<a name="l00066"></a><a class="code" href="structusergroup__cli__perm.html#a5a7acfe0fbb84f84d5a87888ebf9eebf">00066</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(usergroup_cli_perm) list;<span class="comment">/*!&lt; List mechanics */</span>
<a name="l00067"></a>00067 };<span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">/*! \brief CLI permissions config file. */</span>
<a name="l00069"></a><a class="code" href="cli_8c.html#ae473ef191024f9043e7388e1a0585791">00069</a> static const <span class="keywordtype">char</span> <a class="code" href="cli_8c.html#ae473ef191024f9043e7388e1a0585791" title="CLI permissions config file.">perms_config</a>[] = &quot;cli_permissions.conf&quot;;<span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">/*! \brief Default permissions value 1=Permit 0=Deny */</span>
<a name="l00071"></a><a class="code" href="cli_8c.html#a8b908b1af31513eae2e84e5346661d58">00071</a> static <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#a8b908b1af31513eae2e84e5346661d58" title="Default permissions value 1=Permit 0=Deny.">cli_default_perm</a> = 1;
<a name="l00072"></a>00072 <span class="comment"></span>
<a name="l00073"></a>00073 <span class="comment">/*! \brief mutex used to prevent a user from running the &apos;cli reload permissions&apos; command while</span>
<a name="l00074"></a>00074 <span class="comment"> * it is already running. */</span>
<a name="l00075"></a><a class="code" href="cli_8c.html#a69909b2c3c4a62443fc781e20ba3ddc5">00075</a> <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="cli_8c.html#a69909b2c3c4a62443fc781e20ba3ddc5" title="mutex used to prevent a user from running the &amp;#39;cli reload permissions&amp;#39; command...">permsconfiglock</a>);<span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">/*! \brief  List of users and permissions. */</span>
<a name="l00077"></a><a class="code" href="structcli__perms.html#ace4e0066a5b24f84b90536e9906619f6">00077</a> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structcli__perms.html" title="List of users and permissions.">cli_perms</a>, usergroup_cli_perm);
<a name="l00078"></a>00078 <span class="comment"></span>
<a name="l00079"></a>00079 <span class="comment">/*!</span>
<a name="l00080"></a>00080 <span class="comment"> * \brief map a debug or verbose value to a filename</span>
<a name="l00081"></a>00081 <span class="comment"> */</span>
<a name="l00082"></a><a class="code" href="structast__debug__file.html">00082</a> struct <a class="code" href="structast__debug__file.html" title="map a debug or verbose value to a filename">ast_debug_file</a> {
<a name="l00083"></a><a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">00083</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> level;
<a name="l00084"></a><a class="code" href="structast__debug__file.html#a89420e23cecf406734b19a5bbd547f68">00084</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(ast_debug_file) entry;
<a name="l00085"></a><a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">00085</a>    <span class="keywordtype">char</span> filename[0];
<a name="l00086"></a>00086 };
<a name="l00087"></a>00087 
<a name="l00088"></a><a class="code" href="structdebug__file__list.html#ace4e0066a5b24f84b90536e9906619f6">00088</a> <a class="code" href="linkedlists_8h.html#a93a29f1537444303ac1707e50b1a841d" title="Defines a structure to be used to hold a read/write list of specified type.">AST_RWLIST_HEAD</a>(<a class="code" href="structdebug__file__list.html">debug_file_list</a>, ast_debug_file);
<a name="l00089"></a>00089 <span class="comment"></span>
<a name="l00090"></a>00090 <span class="comment">/*! list of filenames and their debug settings */</span>
<a name="l00091"></a><a class="code" href="cli_8c.html#adf077cec50df93f97b46d8b6261c6f04">00091</a> static struct debug_file_list <a class="code" href="cli_8c.html#adf077cec50df93f97b46d8b6261c6f04">debug_files</a>;<span class="comment"></span>
<a name="l00092"></a>00092 <span class="comment">/*! list of filenames and their verbose settings */</span>
<a name="l00093"></a><a class="code" href="cli_8c.html#afeb8a3babc8d262f1ae1dabacc656b84">00093</a> static struct debug_file_list <a class="code" href="cli_8c.html#afeb8a3babc8d262f1ae1dabacc656b84">verbose_files</a>;
<a name="l00094"></a>00094 
<a name="l00095"></a><a class="code" href="cli_8c.html#a2b3ef6f86e718331bfe64b859228e388">00095</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="cli_8c.html#a2b3ef6f86e718331bfe64b859228e388">ast_cli_buf</a>);
<a name="l00096"></a>00096 <span class="comment"></span>
<a name="l00097"></a>00097 <span class="comment">/*! \brief Initial buffer size for resulting strings in ast_cli() */</span>
<a name="l00098"></a><a class="code" href="cli_8c.html#a36101c4872c2f1497c964aca51661c7f">00098</a> <span class="preprocessor">#define AST_CLI_INITLEN   256</span>
<a name="l00099"></a>00099 <span class="preprocessor"></span>
<a name="l00100"></a><a class="code" href="cli_8c.html#a791bf9f5637185bee5e8f0907c762130">00100</a> <span class="keywordtype">void</span> <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *fmt, ...)
<a name="l00101"></a>00101 {
<a name="l00102"></a>00102    <span class="keywordtype">int</span> res;
<a name="l00103"></a>00103    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00104"></a>00104    va_list ap;
<a name="l00105"></a>00105 
<a name="l00106"></a>00106    <span class="keywordflow">if</span> (!(buf = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;ast_cli_buf, <a class="code" href="cli_8c.html#a36101c4872c2f1497c964aca51661c7f" title="Initial buffer size for resulting strings in ast_cli().">AST_CLI_INITLEN</a>)))
<a name="l00107"></a>00107       <span class="keywordflow">return</span>;
<a name="l00108"></a>00108 
<a name="l00109"></a>00109    va_start(ap, fmt);
<a name="l00110"></a>00110    res = <a class="code" href="strings_8h.html#a7ce3f97dd6d3f76f92304c1f5066c77b" title="Set a dynamic string from a va_list.">ast_str_set_va</a>(&amp;buf, 0, fmt, ap);
<a name="l00111"></a>00111    va_end(ap);
<a name="l00112"></a>00112 
<a name="l00113"></a>00113    <span class="keywordflow">if</span> (res != <a class="code" href="strings_8h.html#a1e06e534e565b0e44afdf96c77951725a46fbdfa757aef01471bab9679ce4281f">AST_DYNSTR_BUILD_FAILED</a>) {
<a name="l00114"></a>00114       <a class="code" href="utils_8h.html#a38faf2987c375335b2773964aabf69b3" title="Try to write string, but wait no more than ms milliseconds before timing out.">ast_carefulwrite</a>(fd, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf), <a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(buf), 100);
<a name="l00115"></a>00115    }
<a name="l00116"></a>00116 }
<a name="l00117"></a>00117 
<a name="l00118"></a><a class="code" href="cli_8c.html#aaac45eb83fb2730cac249a509862110d">00118</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="logger_8h.html#aaac45eb83fb2730cac249a509862110d" title="Get the debug level for a file.">ast_debug_get_by_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file) 
<a name="l00119"></a>00119 {
<a name="l00120"></a>00120    <span class="keyword">struct </span>ast_debug_file *adf;
<a name="l00121"></a>00121    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> res = 0;
<a name="l00122"></a>00122 
<a name="l00123"></a>00123    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;debug_files);
<a name="l00124"></a>00124    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;debug_files, adf, entry) {
<a name="l00125"></a>00125       <span class="keywordflow">if</span> (!strncasecmp(adf-&gt;<a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">filename</a>, file, strlen(adf-&gt;<a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">filename</a>))) {
<a name="l00126"></a>00126          res = adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>;
<a name="l00127"></a>00127          <span class="keywordflow">break</span>;
<a name="l00128"></a>00128       }
<a name="l00129"></a>00129    }
<a name="l00130"></a>00130    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;debug_files);
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    <span class="keywordflow">return</span> res;
<a name="l00133"></a>00133 }
<a name="l00134"></a>00134 
<a name="l00135"></a><a class="code" href="cli_8c.html#a96552d7ad69aa626b6ab4fa9f93d1b2f">00135</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="logger_8h.html#a96552d7ad69aa626b6ab4fa9f93d1b2f" title="Get the debug level for a file.">ast_verbose_get_by_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *file) 
<a name="l00136"></a>00136 {
<a name="l00137"></a>00137    <span class="keyword">struct </span>ast_debug_file *adf;
<a name="l00138"></a>00138    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> res = 0;
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;verbose_files);
<a name="l00141"></a>00141    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;verbose_files, adf, entry) {
<a name="l00142"></a>00142       <span class="keywordflow">if</span> (!strncasecmp(adf-&gt;<a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">filename</a>, file, strlen(file))) {
<a name="l00143"></a>00143          res = adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>;
<a name="l00144"></a>00144          <span class="keywordflow">break</span>;
<a name="l00145"></a>00145       }
<a name="l00146"></a>00146    }
<a name="l00147"></a>00147    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;verbose_files);
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="keywordflow">return</span> res;
<a name="l00150"></a>00150 }
<a name="l00151"></a>00151 <span class="comment"></span>
<a name="l00152"></a>00152 <span class="comment">/*! \internal</span>
<a name="l00153"></a>00153 <span class="comment"> *  \brief Check if the user with &apos;uid&apos; and &apos;gid&apos; is allow to execute &apos;command&apos;,</span>
<a name="l00154"></a>00154 <span class="comment"> *    if command starts with &apos;_&apos; then not check permissions, just permit</span>
<a name="l00155"></a>00155 <span class="comment"> *    to run the &apos;command&apos;.</span>
<a name="l00156"></a>00156 <span class="comment"> *    if uid == -1 or gid == -1 do not check permissions.</span>
<a name="l00157"></a>00157 <span class="comment"> *    if uid == -2 and gid == -2 is because rasterisk client didn&apos;t send</span>
<a name="l00158"></a>00158 <span class="comment"> *    the credentials, so the cli_default_perm will be applied.</span>
<a name="l00159"></a>00159 <span class="comment"> *  \param uid User ID.</span>
<a name="l00160"></a>00160 <span class="comment"> *  \param gid Group ID.</span>
<a name="l00161"></a>00161 <span class="comment"> *  \param command Command name to check permissions.</span>
<a name="l00162"></a>00162 <span class="comment"> *  \retval 1 if has permission</span>
<a name="l00163"></a>00163 <span class="comment"> *  \retval 0 if it is not allowed.</span>
<a name="l00164"></a>00164 <span class="comment"> */</span>
<a name="l00165"></a><a class="code" href="cli_8c.html#a97c81620d61e3249bf35cada6df2a088">00165</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#a97c81620d61e3249bf35cada6df2a088">cli_has_permissions</a>(<span class="keywordtype">int</span> uid, <span class="keywordtype">int</span> gid, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>)
<a name="l00166"></a>00166 {
<a name="l00167"></a>00167    <span class="keyword">struct </span>usergroup_cli_perm *user_perm;
<a name="l00168"></a>00168    <span class="keyword">struct </span>cli_perm *perm;
<a name="l00169"></a>00169    <span class="comment">/* set to the default permissions general option. */</span>
<a name="l00170"></a>00170    <span class="keywordtype">int</span> isallowg = cli_default_perm, isallowu = -1, ispattern;
<a name="l00171"></a>00171    regex_t regexbuf;
<a name="l00172"></a>00172 
<a name="l00173"></a>00173    <span class="comment">/* if uid == -1 or gid == -1 do not check permissions.</span>
<a name="l00174"></a>00174 <span class="comment">      if uid == -2 and gid == -2 is because rasterisk client didn&apos;t send</span>
<a name="l00175"></a>00175 <span class="comment">      the credentials, so the cli_default_perm will be applied. */</span>
<a name="l00176"></a>00176    <span class="keywordflow">if</span> ((uid == <a class="code" href="cli_8h.html#a4f3ad5e5686a35a966c8bad5b8694654">CLI_NO_PERMS</a> &amp;&amp; gid == <a class="code" href="cli_8h.html#a4f3ad5e5686a35a966c8bad5b8694654">CLI_NO_PERMS</a>) || command[0] == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l00177"></a>00177       <span class="keywordflow">return</span> 1;
<a name="l00178"></a>00178    }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180    <span class="keywordflow">if</span> (gid &lt; 0 &amp;&amp; uid &lt; 0) {
<a name="l00181"></a>00181       <span class="keywordflow">return</span> cli_default_perm;
<a name="l00182"></a>00182    }
<a name="l00183"></a>00183 
<a name="l00184"></a>00184    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;cli_perms);
<a name="l00185"></a>00185    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cli_perms, user_perm, list) {
<a name="l00186"></a>00186       <span class="keywordflow">if</span> (user_perm-&gt;<a class="code" href="structusergroup__cli__perm.html#a6567680a890171fbaa1a026477a858d3">gid</a> != gid &amp;&amp; user_perm-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a> != uid) {
<a name="l00187"></a>00187          <span class="keywordflow">continue</span>;
<a name="l00188"></a>00188       }
<a name="l00189"></a>00189       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(user_perm-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>, perm, list) {
<a name="l00190"></a>00190          <span class="keywordflow">if</span> (strcasecmp(perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>, <span class="stringliteral">&quot;all&quot;</span>) &amp;&amp; strncasecmp(perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>, command, strlen(perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>))) {
<a name="l00191"></a>00191             <span class="comment">/* if the perm-&gt;command is a pattern, check it against command. */</span>
<a name="l00192"></a>00192             ispattern = !regcomp(&amp;regexbuf, perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>, REG_EXTENDED | REG_NOSUB | REG_ICASE);
<a name="l00193"></a>00193             <span class="keywordflow">if</span> (ispattern &amp;&amp; regexec(&amp;regexbuf, command, 0, NULL, 0)) {
<a name="l00194"></a>00194                regfree(&amp;regexbuf);
<a name="l00195"></a>00195                <span class="keywordflow">continue</span>;
<a name="l00196"></a>00196             }
<a name="l00197"></a>00197             <span class="keywordflow">if</span> (!ispattern) {
<a name="l00198"></a>00198                <span class="keywordflow">continue</span>;
<a name="l00199"></a>00199             }
<a name="l00200"></a>00200             regfree(&amp;regexbuf);
<a name="l00201"></a>00201          }
<a name="l00202"></a>00202          <span class="keywordflow">if</span> (user_perm-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a> == uid) {
<a name="l00203"></a>00203             <span class="comment">/* this is a user definition. */</span>
<a name="l00204"></a>00204             isallowu = perm-&gt;<a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">permit</a>;
<a name="l00205"></a>00205          } <span class="keywordflow">else</span> {
<a name="l00206"></a>00206             <span class="comment">/* otherwise is a group definition. */</span>
<a name="l00207"></a>00207             isallowg = perm-&gt;<a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">permit</a>;
<a name="l00208"></a>00208          }
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210    }
<a name="l00211"></a>00211    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;cli_perms);
<a name="l00212"></a>00212    <span class="keywordflow">if</span> (isallowu &gt; -1) {
<a name="l00213"></a>00213       <span class="comment">/* user definition override group definition. */</span>
<a name="l00214"></a>00214       isallowg = isallowu;
<a name="l00215"></a>00215    }
<a name="l00216"></a>00216 
<a name="l00217"></a>00217    <span class="keywordflow">return</span> isallowg;
<a name="l00218"></a>00218 }
<a name="l00219"></a>00219 
<a name="l00220"></a><a class="code" href="structhelpers.html#ace4e0066a5b24f84b90536e9906619f6">00220</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structhelpers.html">helpers</a>, <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a>);
<a name="l00221"></a>00221 
<a name="l00222"></a><a class="code" href="cli_8c.html#ab71256f27aa5cbbad9931bc2ae9b2e36">00222</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ab71256f27aa5cbbad9931bc2ae9b2e36">complete_fn</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l00223"></a>00223 {
<a name="l00224"></a>00224    <span class="keywordtype">char</span> *c, *d;
<a name="l00225"></a>00225    <span class="keywordtype">char</span> filename[PATH_MAX];
<a name="l00226"></a>00226 
<a name="l00227"></a>00227    <span class="keywordflow">if</span> (word[0] == <span class="charliteral">&apos;/&apos;</span>)
<a name="l00228"></a>00228       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(filename, word, <span class="keyword">sizeof</span>(filename));
<a name="l00229"></a>00229    <span class="keywordflow">else</span>
<a name="l00230"></a>00230       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#a5852d8e3bf5485c09b0f3d2c2375eec3">ast_config_AST_MODULE_DIR</a>, word);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232    c = d = filename_completion_function(filename, state);
<a name="l00233"></a>00233    
<a name="l00234"></a>00234    <span class="keywordflow">if</span> (c &amp;&amp; word[0] != <span class="charliteral">&apos;/&apos;</span>)
<a name="l00235"></a>00235       c += (strlen(<a class="code" href="paths_8h.html#a5852d8e3bf5485c09b0f3d2c2375eec3">ast_config_AST_MODULE_DIR</a>) + 1);
<a name="l00236"></a>00236    <span class="keywordflow">if</span> (c)
<a name="l00237"></a>00237       c = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(c);
<a name="l00238"></a>00238 
<a name="l00239"></a>00239    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(d);
<a name="l00240"></a>00240    
<a name="l00241"></a>00241    <span class="keywordflow">return</span> c;
<a name="l00242"></a>00242 }
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="cli_8c.html#ae1d61920ef9c62e876cc6d8ab809ce16">00244</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ae1d61920ef9c62e876cc6d8ab809ce16">handle_load</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00245"></a>00245 {
<a name="l00246"></a>00246    <span class="comment">/* &quot;module load &lt;mod&gt;&quot; */</span>
<a name="l00247"></a>00247    <span class="keywordflow">switch</span> (cmd) {
<a name="l00248"></a>00248    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00249"></a>00249       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;module load&quot;</span>;
<a name="l00250"></a>00250       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00251"></a>00251          <span class="stringliteral">&quot;Usage: module load &lt;module name&gt;\n&quot;</span>
<a name="l00252"></a>00252          <span class="stringliteral">&quot;       Loads the specified module into Asterisk.\n&quot;</span>;
<a name="l00253"></a>00253       <span class="keywordflow">return</span> NULL;
<a name="l00254"></a>00254 
<a name="l00255"></a>00255    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00256"></a>00256       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00257"></a>00257          <span class="keywordflow">return</span> NULL;
<a name="l00258"></a>00258       <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#ab71256f27aa5cbbad9931bc2ae9b2e36">complete_fn</a>(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l00259"></a>00259    }
<a name="l00260"></a>00260    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l00261"></a>00261       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00262"></a>00262    <span class="keywordflow">if</span> (<a class="code" href="module_8h.html#a841766995d4e10ebb3950b10aab97d9e" title="Load a module.">ast_load_resource</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>])) {
<a name="l00263"></a>00263       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to load module %s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l00264"></a>00264       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00265"></a>00265    }
<a name="l00266"></a>00266    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00267"></a>00267 }
<a name="l00268"></a>00268 
<a name="l00269"></a><a class="code" href="cli_8c.html#a22ca8c73dfd64aee98f04d3015c46bf4">00269</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a22ca8c73dfd64aee98f04d3015c46bf4">handle_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00270"></a>00270 {
<a name="l00271"></a>00271    <span class="keywordtype">int</span> x;
<a name="l00272"></a>00272 
<a name="l00273"></a>00273    <span class="keywordflow">switch</span> (cmd) {
<a name="l00274"></a>00274    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00275"></a>00275       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;module reload&quot;</span>;
<a name="l00276"></a>00276       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00277"></a>00277          <span class="stringliteral">&quot;Usage: module reload [module ...]\n&quot;</span>
<a name="l00278"></a>00278          <span class="stringliteral">&quot;       Reloads configuration files for all listed modules which support\n&quot;</span>
<a name="l00279"></a>00279          <span class="stringliteral">&quot;       reloading, or for all supported modules if none are listed.\n&quot;</span>;
<a name="l00280"></a>00280       <span class="keywordflow">return</span> NULL;
<a name="l00281"></a>00281 
<a name="l00282"></a>00282    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00283"></a>00283       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#a2114c90d58e7c3c3638965d1811301e9" title="Match modules names for the Asterisk cli.">ast_module_helper</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, 1);
<a name="l00284"></a>00284    }
<a name="l00285"></a>00285    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {
<a name="l00286"></a>00286       <a class="code" href="__private_8h.html#a0d0ff279ff3f2dbbbfb1b49ee6f57add" title="Reload asterisk modules.">ast_module_reload</a>(NULL);
<a name="l00287"></a>00287       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00288"></a>00288    }
<a name="l00289"></a>00289    <span class="keywordflow">for</span> (x = e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>; x &lt; a-&gt;argc; x++) {
<a name="l00290"></a>00290       <span class="keywordtype">int</span> res = <a class="code" href="__private_8h.html#a0d0ff279ff3f2dbbbfb1b49ee6f57add" title="Reload asterisk modules.">ast_module_reload</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[x]);
<a name="l00291"></a>00291       <span class="comment">/* XXX reload has multiple error returns, including -1 on error and 2 on success */</span>
<a name="l00292"></a>00292       <span class="keywordflow">switch</span> (res) {
<a name="l00293"></a>00293       <span class="keywordflow">case</span> 0:
<a name="l00294"></a>00294          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such module &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[x]);
<a name="l00295"></a>00295          <span class="keywordflow">break</span>;
<a name="l00296"></a>00296       <span class="keywordflow">case</span> 1:
<a name="l00297"></a>00297          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Module &apos;%s&apos; does not support reload\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[x]);
<a name="l00298"></a>00298          <span class="keywordflow">break</span>;
<a name="l00299"></a>00299       }
<a name="l00300"></a>00300    }
<a name="l00301"></a>00301    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00302"></a>00302 }
<a name="l00303"></a>00303 <span class="comment"></span>
<a name="l00304"></a>00304 <span class="comment">/*! </span>
<a name="l00305"></a>00305 <span class="comment"> * \brief Find the debug or verbose file setting </span>
<a name="l00306"></a>00306 <span class="comment"> * \arg debug 1 for debug, 0 for verbose</span>
<a name="l00307"></a>00307 <span class="comment"> */</span>
<a name="l00308"></a><a class="code" href="cli_8c.html#a765e2a1e8b6f1bb3ab5f6136d3a73564">00308</a> <span class="keyword">static</span> <span class="keyword">struct </span>ast_debug_file *<a class="code" href="cli_8c.html#a765e2a1e8b6f1bb3ab5f6136d3a73564" title="Find the debug or verbose file setting.">find_debug_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *fn, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>)
<a name="l00309"></a>00309 {
<a name="l00310"></a>00310    <span class="keyword">struct </span>ast_debug_file *df = NULL;
<a name="l00311"></a>00311    <span class="keyword">struct </span>debug_file_list *dfl = debug ? &amp;debug_files : &amp;verbose_files;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(dfl, df, entry) {
<a name="l00314"></a>00314       <span class="keywordflow">if</span> (!strcasecmp(df-&gt;<a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">filename</a>, fn))
<a name="l00315"></a>00315          <span class="keywordflow">break</span>;
<a name="l00316"></a>00316    }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318    <span class="keywordflow">return</span> df;
<a name="l00319"></a>00319 }
<a name="l00320"></a>00320 
<a name="l00321"></a><a class="code" href="cli_8c.html#a7b9a2847dbc64bf8d127b45890e21a89">00321</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a7b9a2847dbc64bf8d127b45890e21a89">complete_number</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *partial, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> min, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> max, <span class="keywordtype">int</span> n)
<a name="l00322"></a>00322 {
<a name="l00323"></a>00323    <span class="keywordtype">int</span> i, count = 0;
<a name="l00324"></a>00324    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> prospective[2];
<a name="l00325"></a>00325    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> part = strtoul(partial, NULL, 10);
<a name="l00326"></a>00326    <span class="keywordtype">char</span> <a class="code" href="structcli__perm.html#ad670f4bd3ed1de353cfd64c0a896cdf7">next</a>[12];
<a name="l00327"></a>00327 
<a name="l00328"></a>00328    <span class="keywordflow">if</span> (part &lt; min || part &gt; max) {
<a name="l00329"></a>00329       <span class="keywordflow">return</span> NULL;
<a name="l00330"></a>00330    }
<a name="l00331"></a>00331 
<a name="l00332"></a>00332    <span class="keywordflow">for</span> (i = 0; i &lt; 21; i++) {
<a name="l00333"></a>00333       <span class="keywordflow">if</span> (i == 0) {
<a name="l00334"></a>00334          prospective[0] = prospective[1] = part;
<a name="l00335"></a>00335       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (part == 0 &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(partial)) {
<a name="l00336"></a>00336          <span class="keywordflow">break</span>;
<a name="l00337"></a>00337       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (i &lt; 11) {
<a name="l00338"></a>00338          prospective[0] = prospective[1] = part * 10 + (i - 1);
<a name="l00339"></a>00339       } <span class="keywordflow">else</span> {
<a name="l00340"></a>00340          prospective[0] = (part * 10 + (i - 11)) * 10;
<a name="l00341"></a>00341          prospective[1] = prospective[0] + 9;
<a name="l00342"></a>00342       }
<a name="l00343"></a>00343       <span class="keywordflow">if</span> (i &lt; 11 &amp;&amp; (prospective[0] &lt; min || prospective[0] &gt; max)) {
<a name="l00344"></a>00344          <span class="keywordflow">continue</span>;
<a name="l00345"></a>00345       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (prospective[1] &lt; min || prospective[0] &gt; max) {
<a name="l00346"></a>00346          <span class="keywordflow">continue</span>;
<a name="l00347"></a>00347       }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (++count &gt; n) {
<a name="l00350"></a>00350          <span class="keywordflow">if</span> (i &lt; 11) {
<a name="l00351"></a>00351             snprintf(next, <span class="keyword">sizeof</span>(next), <span class="stringliteral">&quot;%u&quot;</span>, prospective[0]);
<a name="l00352"></a>00352          } <span class="keywordflow">else</span> {
<a name="l00353"></a>00353             snprintf(next, <span class="keyword">sizeof</span>(next), <span class="stringliteral">&quot;%u...&quot;</span>, prospective[0] / 10);
<a name="l00354"></a>00354          }
<a name="l00355"></a>00355          <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(next);
<a name="l00356"></a>00356       }
<a name="l00357"></a>00357    }
<a name="l00358"></a>00358    <span class="keywordflow">return</span> NULL;
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="cli_8c.html#a5151d42e59bf1fcba488149926269792">00361</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a5151d42e59bf1fcba488149926269792">handle_verbose</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363    <span class="keywordtype">int</span> oldval;
<a name="l00364"></a>00364    <span class="keywordtype">int</span> newlevel;
<a name="l00365"></a>00365    <span class="keywordtype">int</span> atleast = 0;
<a name="l00366"></a>00366    <span class="keywordtype">int</span> fd = a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l00367"></a>00367    <span class="keywordtype">int</span> argc = a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>;
<a name="l00368"></a>00368    <span class="keywordtype">char</span> **argv = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>;
<a name="l00369"></a>00369    <span class="keywordtype">char</span> *argv3 = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> ? <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;&quot;</span>) : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00370"></a>00370    <span class="keywordtype">int</span> *dst;
<a name="l00371"></a>00371    <span class="keywordtype">char</span> *what;
<a name="l00372"></a>00372    <span class="keyword">struct </span>debug_file_list *dfl;
<a name="l00373"></a>00373    <span class="keyword">struct </span>ast_debug_file *adf;
<a name="l00374"></a>00374    <span class="keywordtype">char</span> *fn;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    <span class="keywordflow">switch</span> (cmd) {
<a name="l00377"></a>00377    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00378"></a>00378       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core set {debug|verbose}&quot;</span>;
<a name="l00379"></a>00379       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00380"></a>00380 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>         <span class="stringliteral">&quot;Usage: core set {debug|verbose} [atleast] &lt;level&gt; [filename]\n&quot;</span>
<a name="l00382"></a>00382 <span class="preprocessor">#else</span>
<a name="l00383"></a>00383 <span class="preprocessor"></span>         <span class="stringliteral">&quot;Usage: core set {debug|verbose} [atleast] &lt;level&gt;\n&quot;</span>
<a name="l00384"></a>00384 <span class="preprocessor">#endif</span>
<a name="l00385"></a>00385 <span class="preprocessor"></span>         <span class="stringliteral">&quot;       core set {debug|verbose} off\n&quot;</span>
<a name="l00386"></a>00386 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00387"></a>00387 <span class="preprocessor"></span>         <span class="stringliteral">&quot;       Sets level of debug or verbose messages to be displayed or \n&quot;</span>
<a name="l00388"></a>00388          <span class="stringliteral">&quot;       sets a filename to display debug messages from.\n&quot;</span>
<a name="l00389"></a>00389 <span class="preprocessor">#else</span>
<a name="l00390"></a>00390 <span class="preprocessor"></span>         <span class="stringliteral">&quot;       Sets level of debug or verbose messages to be displayed.\n&quot;</span>
<a name="l00391"></a>00391 <span class="preprocessor">#endif</span>
<a name="l00392"></a>00392 <span class="preprocessor"></span>         <span class="stringliteral">&quot;  0 or off means no messages should be displayed.\n&quot;</span>
<a name="l00393"></a>00393          <span class="stringliteral">&quot;  Equivalent to -d[d[...]] or -v[v[v...]] on startup\n&quot;</span>;
<a name="l00394"></a>00394       <span class="keywordflow">return</span> NULL;
<a name="l00395"></a>00395 
<a name="l00396"></a>00396    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00397"></a>00397       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3 || (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;atleast&quot;</span>))) {
<a name="l00398"></a>00398          <span class="keywordtype">char</span> *pos = a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3 ? argv3 : <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;&quot;</span>);
<a name="l00399"></a>00399          <span class="keywordtype">int</span> numbermatch = (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pos) || strchr(<span class="stringliteral">&quot;123456789&quot;</span>, pos[0])) ? 0 : 21;
<a name="l00400"></a>00400          <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &lt; 21 &amp;&amp; numbermatch == 0) {
<a name="l00401"></a>00401             <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#a7b9a2847dbc64bf8d127b45890e21a89">complete_number</a>(pos, 0, 0x7fffffff, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l00402"></a>00402          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pos[0] == <span class="charliteral">&apos;0&apos;</span>) {
<a name="l00403"></a>00403             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0) {
<a name="l00404"></a>00404                <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;0&quot;</span>);
<a name="l00405"></a>00405             } <span class="keywordflow">else</span> {
<a name="l00406"></a>00406                <span class="keywordflow">return</span> NULL;
<a name="l00407"></a>00407             }
<a name="l00408"></a>00408          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == (21 - numbermatch)) {
<a name="l00409"></a>00409             <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3 &amp;&amp; !strncasecmp(argv3, <span class="stringliteral">&quot;off&quot;</span>, strlen(argv3))) {
<a name="l00410"></a>00410                <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;off&quot;</span>);
<a name="l00411"></a>00411             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3 &amp;&amp; !strncasecmp(argv3, <span class="stringliteral">&quot;atleast&quot;</span>, strlen(argv3))) {
<a name="l00412"></a>00412                <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;atleast&quot;</span>);
<a name="l00413"></a>00413             }
<a name="l00414"></a>00414          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == (22 - numbermatch) &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3 &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(argv3)) {
<a name="l00415"></a>00415             <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;atleast&quot;</span>);
<a name="l00416"></a>00416          }
<a name="l00417"></a>00417 <span class="preprocessor">#if !defined(LOW_MEMORY)</span>
<a name="l00418"></a>00418 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4 || (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 5 &amp;&amp; !strcasecmp(argv3, <span class="stringliteral">&quot;atleast&quot;</span>))) {
<a name="l00419"></a>00419          <span class="keywordflow">return</span> <a class="code" href="asterisk_8h.html#a826e3c1be1ea772fbdc32c1f312ec830">ast_complete_source_filename</a>(a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4 ? <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;&quot;</span>) : <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], <span class="stringliteral">&quot;&quot;</span>), a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l00420"></a>00420 <span class="preprocessor">#endif</span>
<a name="l00421"></a>00421 <span class="preprocessor"></span>      }
<a name="l00422"></a>00422       <span class="keywordflow">return</span> NULL;
<a name="l00423"></a>00423    }
<a name="l00424"></a>00424    <span class="comment">/* all the above return, so we proceed with the handler.</span>
<a name="l00425"></a>00425 <span class="comment">    * we are guaranteed to be called with argc &gt;= e-&gt;args;</span>
<a name="l00426"></a>00426 <span class="comment">    */</span>
<a name="l00427"></a>00427 
<a name="l00428"></a>00428    <span class="keywordflow">if</span> (argc &lt;= e-&gt;args)
<a name="l00429"></a>00429       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00430"></a>00430    <span class="keywordflow">if</span> (!strcasecmp(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;debug&quot;</span>)) {
<a name="l00431"></a>00431       dst = &amp;<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>;
<a name="l00432"></a>00432       oldval = <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>;
<a name="l00433"></a>00433       what = <span class="stringliteral">&quot;Core debug&quot;</span>;
<a name="l00434"></a>00434    } <span class="keywordflow">else</span> {
<a name="l00435"></a>00435       dst = &amp;<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a>;
<a name="l00436"></a>00436       oldval = <a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a>;
<a name="l00437"></a>00437       what = <span class="stringliteral">&quot;Verbosity&quot;</span>;
<a name="l00438"></a>00438    }
<a name="l00439"></a>00439    <span class="keywordflow">if</span> (argc == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1 &amp;&amp; !strcasecmp(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>], <span class="stringliteral">&quot;off&quot;</span>)) {
<a name="l00440"></a>00440       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = (*what == <span class="charliteral">&apos;C&apos;</span>);
<a name="l00441"></a>00441       newlevel = 0;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       dfl = debug ? &amp;debug_files : &amp;verbose_files;
<a name="l00444"></a>00444 
<a name="l00445"></a>00445       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(dfl);
<a name="l00446"></a>00446       <span class="keywordflow">while</span> ((adf = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(dfl, entry)))
<a name="l00447"></a>00447          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(adf);
<a name="l00448"></a>00448       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;<a class="code" href="group__main__options.html#gaa5dba371db31dc4ebecdff7c929ff263">ast_options</a>, debug ? <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a47453b67236995c94d001837d3ffe441">AST_OPT_FLAG_DEBUG_FILE</a> : <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a0672151e97a7e960c9563fdf75242b2b">AST_OPT_FLAG_VERBOSE_FILE</a>);
<a name="l00449"></a>00449       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(dfl);
<a name="l00450"></a>00450 
<a name="l00451"></a>00451       <span class="keywordflow">goto</span> done;
<a name="l00452"></a>00452    }
<a name="l00453"></a>00453    <span class="keywordflow">if</span> (!strcasecmp(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>], <span class="stringliteral">&quot;atleast&quot;</span>))
<a name="l00454"></a>00454       atleast = 1;
<a name="l00455"></a>00455    <span class="keywordflow">if</span> (argc != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + atleast + 1 &amp;&amp; argc != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + atleast + 2)
<a name="l00456"></a>00456       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00457"></a>00457    <span class="keywordflow">if</span> (sscanf(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + atleast], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;newlevel) != 1)
<a name="l00458"></a>00458       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00459"></a>00459    <span class="keywordflow">if</span> (argc == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + atleast + 2) {
<a name="l00460"></a>00460       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = (*what == <span class="charliteral">&apos;C&apos;</span>);
<a name="l00461"></a>00461       dfl = debug ? &amp;debug_files : &amp;verbose_files;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463       fn = argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + atleast + 1];
<a name="l00464"></a>00464 
<a name="l00465"></a>00465       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(dfl);
<a name="l00466"></a>00466 
<a name="l00467"></a>00467       <span class="keywordflow">if</span> ((adf = <a class="code" href="cli_8c.html#a765e2a1e8b6f1bb3ab5f6136d3a73564" title="Find the debug or verbose file setting.">find_debug_file</a>(fn, debug)) &amp;&amp; !newlevel) {
<a name="l00468"></a>00468          <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(dfl, adf, entry);
<a name="l00469"></a>00469          <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(dfl))
<a name="l00470"></a>00470             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;<a class="code" href="group__main__options.html#gaa5dba371db31dc4ebecdff7c929ff263">ast_options</a>, debug ? <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a47453b67236995c94d001837d3ffe441">AST_OPT_FLAG_DEBUG_FILE</a> : <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a0672151e97a7e960c9563fdf75242b2b">AST_OPT_FLAG_VERBOSE_FILE</a>);
<a name="l00471"></a>00471          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(dfl);
<a name="l00472"></a>00472          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s was %d and has been set to 0 for &apos;%s&apos;\n&quot;</span>, what, adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>, fn);
<a name="l00473"></a>00473          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(adf);
<a name="l00474"></a>00474          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00475"></a>00475       }
<a name="l00476"></a>00476 
<a name="l00477"></a>00477       <span class="keywordflow">if</span> (adf) {
<a name="l00478"></a>00478          <span class="keywordflow">if</span> ((atleast &amp;&amp; newlevel &lt; adf-&gt;level) || adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a> == newlevel) {
<a name="l00479"></a>00479             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s is %d for &apos;%s&apos;\n&quot;</span>, what, adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>, fn);
<a name="l00480"></a>00480             <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(dfl);
<a name="l00481"></a>00481             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00482"></a>00482          }
<a name="l00483"></a>00483       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(adf = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*adf) + strlen(fn) + 1))) {
<a name="l00484"></a>00484          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(dfl);
<a name="l00485"></a>00485          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00486"></a>00486       }
<a name="l00487"></a>00487 
<a name="l00488"></a>00488       oldval = adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>;
<a name="l00489"></a>00489       adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a> = newlevel;
<a name="l00490"></a>00490       strcpy(adf-&gt;<a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">filename</a>, fn);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="group__main__options.html#gaa5dba371db31dc4ebecdff7c929ff263">ast_options</a>, debug ? <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a47453b67236995c94d001837d3ffe441">AST_OPT_FLAG_DEBUG_FILE</a> : <a class="code" href="group__main__options.html#ggaf2588453b3a373a770741ad3ce353343a0672151e97a7e960c9563fdf75242b2b">AST_OPT_FLAG_VERBOSE_FILE</a>);
<a name="l00493"></a>00493 
<a name="l00494"></a>00494       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(dfl, adf, entry);
<a name="l00495"></a>00495       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(dfl);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s was %d and has been set to %d for &apos;%s&apos;\n&quot;</span>, what, oldval, adf-&gt;<a class="code" href="structast__debug__file.html#a9082f945c1d289684d0bcd51ee08e11e">level</a>, adf-&gt;<a class="code" href="structast__debug__file.html#afae8c108f5d360038fa8b099eb4ab2f3">filename</a>);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00500"></a>00500    }
<a name="l00501"></a>00501 
<a name="l00502"></a>00502 done:
<a name="l00503"></a>00503    <span class="keywordflow">if</span> (!atleast || newlevel &gt; *dst)
<a name="l00504"></a>00504       *dst = newlevel;
<a name="l00505"></a>00505    <span class="keywordflow">if</span> (oldval &gt; 0 &amp;&amp; *dst == 0)
<a name="l00506"></a>00506       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s is now OFF\n&quot;</span>, what);
<a name="l00507"></a>00507    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*dst &gt; 0) {
<a name="l00508"></a>00508       <span class="keywordflow">if</span> (oldval == *dst)
<a name="l00509"></a>00509          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s is at least %d\n&quot;</span>, what, *dst);
<a name="l00510"></a>00510       <span class="keywordflow">else</span>
<a name="l00511"></a>00511          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s was %d and is now %d\n&quot;</span>, what, oldval, *dst);
<a name="l00512"></a>00512    }
<a name="l00513"></a>00513 
<a name="l00514"></a>00514    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="cli_8c.html#a6271e5ca0474681db9b080dae8c544f4">00517</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a6271e5ca0474681db9b080dae8c544f4">handle_logger_mute</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519    <span class="keywordflow">switch</span> (cmd) {
<a name="l00520"></a>00520    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00521"></a>00521       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;logger mute&quot;</span>;
<a name="l00522"></a>00522       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00523"></a>00523          <span class="stringliteral">&quot;Usage: logger mute\n&quot;</span>
<a name="l00524"></a>00524          <span class="stringliteral">&quot;       Disables logging output to the current console, making it possible to\n&quot;</span>
<a name="l00525"></a>00525          <span class="stringliteral">&quot;       gather information without being disturbed by scrolling lines.\n&quot;</span>;
<a name="l00526"></a>00526       <span class="keywordflow">return</span> NULL;
<a name="l00527"></a>00527    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00528"></a>00528       <span class="keywordflow">return</span> NULL;
<a name="l00529"></a>00529    }
<a name="l00530"></a>00530 
<a name="l00531"></a>00531    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 2 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 3)
<a name="l00532"></a>00532       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;silent&quot;</span>))
<a name="l00535"></a>00535       <a class="code" href="logger_8h.html#a564debc26032b2a42212ac285b4113de" title="mute or unmute a console from logging">ast_console_toggle_mute</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, 1);
<a name="l00536"></a>00536    <span class="keywordflow">else</span>
<a name="l00537"></a>00537       <a class="code" href="logger_8h.html#a564debc26032b2a42212ac285b4113de" title="mute or unmute a console from logging">ast_console_toggle_mute</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, 0);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00540"></a>00540 }
<a name="l00541"></a>00541 
<a name="l00542"></a><a class="code" href="cli_8c.html#a066fdc101e74c3d7ec12645a44e48eb9">00542</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a066fdc101e74c3d7ec12645a44e48eb9">handle_unload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00543"></a>00543 {
<a name="l00544"></a>00544    <span class="comment">/* &quot;module unload mod_1 [mod_2 .. mod_N]&quot; */</span>
<a name="l00545"></a>00545    <span class="keywordtype">int</span> x;
<a name="l00546"></a>00546    <span class="keywordtype">int</span> force = <a class="code" href="module_8h.html#ac034ec04e9dd255a0d39bdfcb73113b9a10bb7955de423b36c75f645de78d2f39">AST_FORCE_SOFT</a>;
<a name="l00547"></a>00547    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549    <span class="keywordflow">switch</span> (cmd) {
<a name="l00550"></a>00550    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00551"></a>00551       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;module unload&quot;</span>;
<a name="l00552"></a>00552       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00553"></a>00553          <span class="stringliteral">&quot;Usage: module unload [-f|-h] &lt;module_1&gt; [&lt;module_2&gt; ... ]\n&quot;</span>
<a name="l00554"></a>00554          <span class="stringliteral">&quot;       Unloads the specified module from Asterisk. The -f\n&quot;</span>
<a name="l00555"></a>00555          <span class="stringliteral">&quot;       option causes the module to be unloaded even if it is\n&quot;</span>
<a name="l00556"></a>00556          <span class="stringliteral">&quot;       in use (may cause a crash) and the -h module causes the\n&quot;</span>
<a name="l00557"></a>00557          <span class="stringliteral">&quot;       module to be unloaded even if the module says it cannot, \n&quot;</span>
<a name="l00558"></a>00558          <span class="stringliteral">&quot;       which almost always will cause a crash.\n&quot;</span>;
<a name="l00559"></a>00559       <span class="keywordflow">return</span> NULL;
<a name="l00560"></a>00560 
<a name="l00561"></a>00561    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00562"></a>00562       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#a2114c90d58e7c3c3638965d1811301e9" title="Match modules names for the Asterisk cli.">ast_module_helper</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, 0);
<a name="l00563"></a>00563    }
<a name="l00564"></a>00564    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l00565"></a>00565       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00566"></a>00566    x = e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>;   <span class="comment">/* first argument */</span>
<a name="l00567"></a>00567    s = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[x];
<a name="l00568"></a>00568    <span class="keywordflow">if</span> (s[0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l00569"></a>00569       <span class="keywordflow">if</span> (s[1] == <span class="charliteral">&apos;f&apos;</span>)
<a name="l00570"></a>00570          force = <a class="code" href="module_8h.html#ac034ec04e9dd255a0d39bdfcb73113b9a8145144df4ddbc9122deba5069de0522">AST_FORCE_FIRM</a>;
<a name="l00571"></a>00571       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (s[1] == <span class="charliteral">&apos;h&apos;</span>)
<a name="l00572"></a>00572          force = <a class="code" href="module_8h.html#ac034ec04e9dd255a0d39bdfcb73113b9a4fbd520c0fa0b70495fe9dd6aee373b9">AST_FORCE_HARD</a>;
<a name="l00573"></a>00573       <span class="keywordflow">else</span>
<a name="l00574"></a>00574          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00575"></a>00575       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 2) <span class="comment">/* need at least one module name */</span>
<a name="l00576"></a>00576          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00577"></a>00577       x++;  <span class="comment">/* skip this argument */</span>
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <span class="keywordflow">for</span> (; x &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; x++) {
<a name="l00581"></a>00581       <span class="keywordflow">if</span> (<a class="code" href="module_8h.html#a52f6615f305951a0d61adc6e61920c34" title="Unload a module.">ast_unload_resource</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[x], force)) {
<a name="l00582"></a>00582          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to unload resource %s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[x]);
<a name="l00583"></a>00583          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00584"></a>00584       }
<a name="l00585"></a>00585    }
<a name="l00586"></a>00586    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00587"></a>00587 }
<a name="l00588"></a>00588 
<a name="l00589"></a><a class="code" href="cli_8c.html#a97d3f8deb4e3d6888056cf1149bcc61a">00589</a> <span class="preprocessor">#define MODLIST_FORMAT  &quot;%-30s %-40.40s %-10d\n&quot;</span>
<a name="l00590"></a><a class="code" href="cli_8c.html#ab4eccad80b693a6b52fd1706c60fef0e">00590</a> <span class="preprocessor"></span><span class="preprocessor">#define MODLIST_FORMAT2 &quot;%-30s %-40.40s %-10s\n&quot;</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span>
<a name="l00592"></a><a class="code" href="cli_8c.html#ac7a1346decd3388ab226f4bddc88189a">00592</a> <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="cli_8c.html#ac7a1346decd3388ab226f4bddc88189a">climodentrylock</a>);
<a name="l00593"></a><a class="code" href="cli_8c.html#aa5a37575f5e5a07b25c6ee3107d46008">00593</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#aa5a37575f5e5a07b25c6ee3107d46008">climodentryfd</a> = -1;
<a name="l00594"></a>00594 
<a name="l00595"></a><a class="code" href="cli_8c.html#af1e37c3b4eb5f2c938dff2311d621296">00595</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#af1e37c3b4eb5f2c938dff2311d621296">modlist_modentry</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *module, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>, <span class="keywordtype">int</span> <a class="code" href="chan__unistim_8c.html#a2f8d20b887dab5677a21b650895a0dec">usecnt</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *like)
<a name="l00596"></a>00596 {
<a name="l00597"></a>00597    <span class="comment">/* Comparing the like with the module */</span>
<a name="l00598"></a>00598    <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(module, like) ) {
<a name="l00599"></a>00599       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(climodentryfd, <a class="code" href="cli_8c.html#a97d3f8deb4e3d6888056cf1149bcc61a">MODLIST_FORMAT</a>, module, description, usecnt);
<a name="l00600"></a>00600       <span class="keywordflow">return</span> 1;
<a name="l00601"></a>00601    } 
<a name="l00602"></a>00602    <span class="keywordflow">return</span> 0;
<a name="l00603"></a>00603 }
<a name="l00604"></a>00604 
<a name="l00605"></a><a class="code" href="cli_8c.html#a39eebea4b2788ae0175ffa54c61fe276">00605</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="cli_8c.html#a39eebea4b2788ae0175ffa54c61fe276">print_uptimestr</a>(<span class="keywordtype">int</span> fd, <span class="keyword">struct</span> timeval timeval, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>, <span class="keywordtype">int</span> printsec)
<a name="l00606"></a>00606 {
<a name="l00607"></a>00607    <span class="keywordtype">int</span> x; <span class="comment">/* the main part - years, weeks, etc. */</span>
<a name="l00608"></a>00608    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out;
<a name="l00609"></a>00609 
<a name="l00610"></a>00610 <span class="preprocessor">#define SECOND (1)</span>
<a name="l00611"></a>00611 <span class="preprocessor"></span><span class="preprocessor">#define MINUTE (SECOND*60)</span>
<a name="l00612"></a>00612 <span class="preprocessor"></span><span class="preprocessor">#define HOUR (MINUTE*60)</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span><span class="preprocessor">#define DAY (HOUR*24)</span>
<a name="l00614"></a>00614 <span class="preprocessor"></span><span class="preprocessor">#define WEEK (DAY*7)</span>
<a name="l00615"></a>00615 <span class="preprocessor"></span><span class="preprocessor">#define YEAR (DAY*365)</span>
<a name="l00616"></a>00616 <span class="preprocessor"></span><span class="preprocessor">#define NEEDCOMMA(x) ((x)? &quot;,&quot;: &quot;&quot;) </span><span class="comment">/* define if we need a comma */</span>
<a name="l00617"></a>00617    <span class="keywordflow">if</span> (timeval.tv_sec &lt; 0) <span class="comment">/* invalid, nothing to show */</span>
<a name="l00618"></a>00618       <span class="keywordflow">return</span>;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620    <span class="keywordflow">if</span> (printsec)  {  <span class="comment">/* plain seconds output */</span>
<a name="l00621"></a>00621       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s: %lu\n&quot;</span>, prefix, (u_long)timeval.tv_sec);
<a name="l00622"></a>00622       <span class="keywordflow">return</span>;
<a name="l00623"></a>00623    }
<a name="l00624"></a>00624    out = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(256);
<a name="l00625"></a>00625    <span class="keywordflow">if</span> (timeval.tv_sec &gt; <a class="code" href="cli_8c.html#a5871356500f559add06ea81d60331b1b">YEAR</a>) {
<a name="l00626"></a>00626       x = (timeval.tv_sec / <a class="code" href="cli_8c.html#a5871356500f559add06ea81d60331b1b">YEAR</a>);
<a name="l00627"></a>00627       timeval.tv_sec -= (x * <a class="code" href="cli_8c.html#a5871356500f559add06ea81d60331b1b">YEAR</a>);
<a name="l00628"></a>00628       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d year%s%s &quot;</span>, x, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(x),<a class="code" href="cli_8c.html#a5f8f259f27c085a147c1f3d12dea87a5">NEEDCOMMA</a>(timeval.tv_sec));
<a name="l00629"></a>00629    }
<a name="l00630"></a>00630    <span class="keywordflow">if</span> (timeval.tv_sec &gt; <a class="code" href="cli_8c.html#a4a0cf4182a1661d0eb7a55494a2dd6e5">WEEK</a>) {
<a name="l00631"></a>00631       x = (timeval.tv_sec / <a class="code" href="cli_8c.html#a4a0cf4182a1661d0eb7a55494a2dd6e5">WEEK</a>);
<a name="l00632"></a>00632       timeval.tv_sec -= (x * <a class="code" href="cli_8c.html#a4a0cf4182a1661d0eb7a55494a2dd6e5">WEEK</a>);
<a name="l00633"></a>00633       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d week%s%s &quot;</span>, x, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(x),<a class="code" href="cli_8c.html#a5f8f259f27c085a147c1f3d12dea87a5">NEEDCOMMA</a>(timeval.tv_sec));
<a name="l00634"></a>00634    }
<a name="l00635"></a>00635    <span class="keywordflow">if</span> (timeval.tv_sec &gt; <a class="code" href="cli_8c.html#a509a01c55cbe47386fe24602b7c7fda1">DAY</a>) {
<a name="l00636"></a>00636       x = (timeval.tv_sec / <a class="code" href="cli_8c.html#a509a01c55cbe47386fe24602b7c7fda1">DAY</a>);
<a name="l00637"></a>00637       timeval.tv_sec -= (x * <a class="code" href="cli_8c.html#a509a01c55cbe47386fe24602b7c7fda1">DAY</a>);
<a name="l00638"></a>00638       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d day%s%s &quot;</span>, x, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(x),<a class="code" href="cli_8c.html#a5f8f259f27c085a147c1f3d12dea87a5">NEEDCOMMA</a>(timeval.tv_sec));
<a name="l00639"></a>00639    }
<a name="l00640"></a>00640    <span class="keywordflow">if</span> (timeval.tv_sec &gt; <a class="code" href="cli_8c.html#a4698ae12cf6a8acb5886fffd0ec897e6">HOUR</a>) {
<a name="l00641"></a>00641       x = (timeval.tv_sec / <a class="code" href="cli_8c.html#a4698ae12cf6a8acb5886fffd0ec897e6">HOUR</a>);
<a name="l00642"></a>00642       timeval.tv_sec -= (x * <a class="code" href="cli_8c.html#a4698ae12cf6a8acb5886fffd0ec897e6">HOUR</a>);
<a name="l00643"></a>00643       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d hour%s%s &quot;</span>, x, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(x),<a class="code" href="cli_8c.html#a5f8f259f27c085a147c1f3d12dea87a5">NEEDCOMMA</a>(timeval.tv_sec));
<a name="l00644"></a>00644    }
<a name="l00645"></a>00645    <span class="keywordflow">if</span> (timeval.tv_sec &gt; <a class="code" href="cli_8c.html#ac1454fa04f41c693f39425697a137d82">MINUTE</a>) {
<a name="l00646"></a>00646       x = (timeval.tv_sec / <a class="code" href="cli_8c.html#ac1454fa04f41c693f39425697a137d82">MINUTE</a>);
<a name="l00647"></a>00647       timeval.tv_sec -= (x * <a class="code" href="cli_8c.html#ac1454fa04f41c693f39425697a137d82">MINUTE</a>);
<a name="l00648"></a>00648       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d minute%s%s &quot;</span>, x, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(x),<a class="code" href="cli_8c.html#a5f8f259f27c085a147c1f3d12dea87a5">NEEDCOMMA</a>(timeval.tv_sec));
<a name="l00649"></a>00649    }
<a name="l00650"></a>00650    x = timeval.tv_sec;
<a name="l00651"></a>00651    <span class="keywordflow">if</span> (x &gt; 0 || <a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(out) == 0) <span class="comment">/* if there is nothing, print 0 seconds */</span>
<a name="l00652"></a>00652       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;out, 0, <span class="stringliteral">&quot;%d second%s &quot;</span>, x, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(x));
<a name="l00653"></a>00653    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s: %s\n&quot;</span>, prefix, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l00654"></a>00654 }
<a name="l00655"></a>00655 
<a name="l00656"></a><a class="code" href="cli_8c.html#adac48ec5ae21bd48d7f3dac6c44b2868">00656</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *<a class="code" href="cli_8c.html#adac48ec5ae21bd48d7f3dac6c44b2868">cli_next</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e)
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658    <span class="keywordflow">if</span> (e) {
<a name="l00659"></a>00659       <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(e, list);
<a name="l00660"></a>00660    } <span class="keywordflow">else</span> {
<a name="l00661"></a>00661       <span class="keywordflow">return</span> <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l00662"></a>00662    }
<a name="l00663"></a>00663 }
<a name="l00664"></a>00664 
<a name="l00665"></a><a class="code" href="cli_8c.html#ab1e834548243108d1f0a6ed298451f0e">00665</a> <span class="keyword">static</span> <span class="keywordtype">char</span> * <a class="code" href="cli_8c.html#ab1e834548243108d1f0a6ed298451f0e">handle_showuptime</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00666"></a>00666 {
<a name="l00667"></a>00667    <span class="keyword">struct </span>timeval curtime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00668"></a>00668    <span class="keywordtype">int</span> printsec;
<a name="l00669"></a>00669 
<a name="l00670"></a>00670    <span class="keywordflow">switch</span> (cmd) {
<a name="l00671"></a>00671    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00672"></a>00672       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show uptime [seconds]&quot;</span>;
<a name="l00673"></a>00673       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00674"></a>00674          <span class="stringliteral">&quot;Usage: core show uptime [seconds]\n&quot;</span>
<a name="l00675"></a>00675          <span class="stringliteral">&quot;       Shows Asterisk uptime information.\n&quot;</span>
<a name="l00676"></a>00676          <span class="stringliteral">&quot;       The seconds word returns the uptime in seconds only.\n&quot;</span>;
<a name="l00677"></a>00677       <span class="keywordflow">return</span> NULL;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00680"></a>00680       <span class="keywordflow">return</span> NULL;
<a name="l00681"></a>00681    }
<a name="l00682"></a>00682    <span class="comment">/* regular handler */</span>
<a name="l00683"></a>00683    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1],<span class="stringliteral">&quot;seconds&quot;</span>))
<a name="l00684"></a>00684       printsec = 1;
<a name="l00685"></a>00685    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1)
<a name="l00686"></a>00686       printsec = 0;
<a name="l00687"></a>00687    <span class="keywordflow">else</span>
<a name="l00688"></a>00688       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00689"></a>00689    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a>.tv_sec)
<a name="l00690"></a>00690       <a class="code" href="cli_8c.html#a39eebea4b2788ae0175ffa54c61fe276">print_uptimestr</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(curtime, <a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a>), <span class="stringliteral">&quot;System uptime&quot;</span>, printsec);
<a name="l00691"></a>00691    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a7cdafc5a121e87659887ffc9abe36760">ast_lastreloadtime</a>.tv_sec)
<a name="l00692"></a>00692       <a class="code" href="cli_8c.html#a39eebea4b2788ae0175ffa54c61fe276">print_uptimestr</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(curtime, <a class="code" href="options_8h.html#a7cdafc5a121e87659887ffc9abe36760">ast_lastreloadtime</a>), <span class="stringliteral">&quot;Last reload&quot;</span>, printsec);
<a name="l00693"></a>00693    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00694"></a>00694 }
<a name="l00695"></a>00695 
<a name="l00696"></a><a class="code" href="cli_8c.html#a0d2c4cd94a20114dd29790a508b83d99">00696</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a0d2c4cd94a20114dd29790a508b83d99">handle_modlist</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00697"></a>00697 {
<a name="l00698"></a>00698    <span class="keywordtype">char</span> *like;
<a name="l00699"></a>00699 
<a name="l00700"></a>00700    <span class="keywordflow">switch</span> (cmd) {
<a name="l00701"></a>00701    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00702"></a>00702       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;module show [like]&quot;</span>;
<a name="l00703"></a>00703       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00704"></a>00704          <span class="stringliteral">&quot;Usage: module show [like keyword]\n&quot;</span>
<a name="l00705"></a>00705          <span class="stringliteral">&quot;       Shows Asterisk modules currently in use, and usage statistics.\n&quot;</span>;
<a name="l00706"></a>00706       <span class="keywordflow">return</span> NULL;
<a name="l00707"></a>00707 
<a name="l00708"></a>00708    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00709"></a>00709       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00710"></a>00710          <span class="keywordflow">return</span> <a class="code" href="module_8h.html#a2114c90d58e7c3c3638965d1811301e9" title="Match modules names for the Asterisk cli.">ast_module_helper</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, 0);
<a name="l00711"></a>00711       <span class="keywordflow">else</span>
<a name="l00712"></a>00712          <span class="keywordflow">return</span> NULL;
<a name="l00713"></a>00713    }
<a name="l00714"></a>00714    <span class="comment">/* all the above return, so we proceed with the handler.</span>
<a name="l00715"></a>00715 <span class="comment">    * we are guaranteed to have argc &gt;= e-&gt;args</span>
<a name="l00716"></a>00716 <span class="comment">    */</span>
<a name="l00717"></a>00717    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1)
<a name="l00718"></a>00718       like = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00719"></a>00719    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;like&quot;</span>) )
<a name="l00720"></a>00720       like = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>];
<a name="l00721"></a>00721    <span class="keywordflow">else</span>
<a name="l00722"></a>00722       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00723"></a>00723       
<a name="l00724"></a>00724    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="cli_8c.html#ac7a1346decd3388ab226f4bddc88189a">climodentrylock</a>);
<a name="l00725"></a>00725    climodentryfd = a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>; <span class="comment">/* global, protected by climodentrylock */</span>
<a name="l00726"></a>00726    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="cli_8c.html#ab4eccad80b693a6b52fd1706c60fef0e">MODLIST_FORMAT2</a>, <span class="stringliteral">&quot;Module&quot;</span>, <span class="stringliteral">&quot;Description&quot;</span>, <span class="stringliteral">&quot;Use Count&quot;</span>);
<a name="l00727"></a>00727    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;%d modules loaded\n&quot;</span>, <a class="code" href="module_8h.html#a19adc7caa79fecaf1257325ffb366fe7" title="Ask for a list of modules, descriptions, and use counts.">ast_update_module_list</a>(<a class="code" href="cli_8c.html#af1e37c3b4eb5f2c938dff2311d621296">modlist_modentry</a>, like));
<a name="l00728"></a>00728    climodentryfd = -1;
<a name="l00729"></a>00729    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="cli_8c.html#ac7a1346decd3388ab226f4bddc88189a">climodentrylock</a>);
<a name="l00730"></a>00730    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 <span class="preprocessor">#undef MODLIST_FORMAT</span>
<a name="l00733"></a>00733 <span class="preprocessor"></span><span class="preprocessor">#undef MODLIST_FORMAT2</span>
<a name="l00734"></a>00734 <span class="preprocessor"></span>
<a name="l00735"></a><a class="code" href="cli_8c.html#a814d1ddca930627ac11a3b2d824fc62e">00735</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a814d1ddca930627ac11a3b2d824fc62e">handle_showcalls</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737    <span class="keyword">struct </span>timeval curtime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00738"></a>00738    <span class="keywordtype">int</span> showuptime, printsec;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740    <span class="keywordflow">switch</span> (cmd) {
<a name="l00741"></a>00741    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00742"></a>00742       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show calls [uptime]&quot;</span>;
<a name="l00743"></a>00743       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00744"></a>00744          <span class="stringliteral">&quot;Usage: core show calls [uptime] [seconds]\n&quot;</span>
<a name="l00745"></a>00745          <span class="stringliteral">&quot;       Lists number of currently active calls and total number of calls\n&quot;</span>
<a name="l00746"></a>00746          <span class="stringliteral">&quot;       processed through PBX since last restart. If &apos;uptime&apos; is specified\n&quot;</span>
<a name="l00747"></a>00747          <span class="stringliteral">&quot;       the system uptime is also displayed. If &apos;seconds&apos; is specified in\n&quot;</span>
<a name="l00748"></a>00748          <span class="stringliteral">&quot;       addition to &apos;uptime&apos;, the system uptime is displayed in seconds.\n&quot;</span>;
<a name="l00749"></a>00749       <span class="keywordflow">return</span> NULL;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00752"></a>00752       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00753"></a>00753          <span class="keywordflow">return</span> NULL;
<a name="l00754"></a>00754       <span class="keywordflow">return</span> a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0  ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;seconds&quot;</span>) : NULL;
<a name="l00755"></a>00755    }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    <span class="comment">/* regular handler */</span>
<a name="l00758"></a>00758    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt;= e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1],<span class="stringliteral">&quot;uptime&quot;</span>)) {
<a name="l00759"></a>00759       showuptime = 1;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>+1 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>],<span class="stringliteral">&quot;seconds&quot;</span>))
<a name="l00762"></a>00762          printsec = 1;
<a name="l00763"></a>00763       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00764"></a>00764          printsec = 0;
<a name="l00765"></a>00765       <span class="keywordflow">else</span>
<a name="l00766"></a>00766          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00767"></a>00767    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1) {
<a name="l00768"></a>00768       showuptime = 0;
<a name="l00769"></a>00769       printsec = 0;
<a name="l00770"></a>00770    } <span class="keywordflow">else</span>
<a name="l00771"></a>00771       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00772"></a>00772 
<a name="l00773"></a>00773    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>) {
<a name="l00774"></a>00774       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d of %d max active call%s (%5.2f%% of capacity)\n&quot;</span>,
<a name="l00775"></a>00775          <a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>(), <a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(<a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>()),
<a name="l00776"></a>00776          ((<span class="keywordtype">double</span>)<a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>() / (<span class="keywordtype">double</span>)<a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>) * 100.0);
<a name="l00777"></a>00777    } <span class="keywordflow">else</span> {
<a name="l00778"></a>00778       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d active call%s\n&quot;</span>, <a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>(), <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(<a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>()));
<a name="l00779"></a>00779    }
<a name="l00780"></a>00780    
<a name="l00781"></a>00781    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d call%s processed\n&quot;</span>, <a class="code" href="pbx_8h.html#a6cd4c64e374623ea3393fbc5d580f68e" title="Retrieve the total number of calls processed through the PBX since last restart.">ast_processed_calls</a>(), <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(<a class="code" href="pbx_8h.html#a6cd4c64e374623ea3393fbc5d580f68e" title="Retrieve the total number of calls processed through the PBX since last restart.">ast_processed_calls</a>()));
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a>.tv_sec &amp;&amp; showuptime) {
<a name="l00784"></a>00784       <a class="code" href="cli_8c.html#a39eebea4b2788ae0175ffa54c61fe276">print_uptimestr</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(curtime, <a class="code" href="options_8h.html#acd462f81fa607939af36a9fa33cdbf9d">ast_startuptime</a>), <span class="stringliteral">&quot;System uptime&quot;</span>, printsec);
<a name="l00785"></a>00785    }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l00788"></a>00788 }
<a name="l00789"></a>00789 
<a name="l00790"></a><a class="code" href="cli_8c.html#a864ccd72b72ef6f3e8595bd56d611f5f">00790</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a864ccd72b72ef6f3e8595bd56d611f5f">handle_chanlist</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00791"></a>00791 {
<a name="l00792"></a>00792 <span class="preprocessor">#define FORMAT_STRING  &quot;%-20.20s %-20.20s %-7.7s %-30.30s\n&quot;</span>
<a name="l00793"></a>00793 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT_STRING2 &quot;%-20.20s %-20.20s %-7.7s %-30.30s\n&quot;</span>
<a name="l00794"></a>00794 <span class="preprocessor"></span><span class="preprocessor">#define CONCISE_FORMAT_STRING  &quot;%s!%s!%s!%d!%s!%s!%s!%s!%s!%d!%s!%s!%s\n&quot;</span>
<a name="l00795"></a>00795 <span class="preprocessor"></span><span class="preprocessor">#define VERBOSE_FORMAT_STRING  &quot;%-20.20s %-20.20s %-16.16s %4d %-7.7s %-12.12s %-25.25s %-15.15s %8.8s %-11.11s %-20.20s\n&quot;</span>
<a name="l00796"></a>00796 <span class="preprocessor"></span><span class="preprocessor">#define VERBOSE_FORMAT_STRING2 &quot;%-20.20s %-20.20s %-16.16s %-4.4s %-7.7s %-12.12s %-25.25s %-15.15s %8.8s %-11.11s %-20.20s\n&quot;</span>
<a name="l00797"></a>00797 <span class="preprocessor"></span>
<a name="l00798"></a>00798    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = NULL;
<a name="l00799"></a>00799    <span class="keywordtype">int</span> numchans = 0, concise = 0, verbose = 0, count = 0;
<a name="l00800"></a>00800    <span class="keywordtype">int</span> fd, argc;
<a name="l00801"></a>00801    <span class="keywordtype">char</span> **argv;
<a name="l00802"></a>00802 
<a name="l00803"></a>00803    <span class="keywordflow">switch</span> (cmd) {
<a name="l00804"></a>00804    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00805"></a>00805       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show channels [concise|verbose|count]&quot;</span>;
<a name="l00806"></a>00806       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00807"></a>00807          <span class="stringliteral">&quot;Usage: core show channels [concise|verbose|count]\n&quot;</span>
<a name="l00808"></a>00808          <span class="stringliteral">&quot;       Lists currently defined channels and some information about them. If\n&quot;</span>
<a name="l00809"></a>00809          <span class="stringliteral">&quot;       &apos;concise&apos; is specified, the format is abridged and in a more easily\n&quot;</span>
<a name="l00810"></a>00810          <span class="stringliteral">&quot;       machine parsable format. If &apos;verbose&apos; is specified, the output includes\n&quot;</span>
<a name="l00811"></a>00811          <span class="stringliteral">&quot;       more and longer fields. If &apos;count&apos; is specified only the channel and call\n&quot;</span>
<a name="l00812"></a>00812          <span class="stringliteral">&quot;       count is output.\n&quot;</span>
<a name="l00813"></a>00813          <span class="stringliteral">&quot;  The &apos;concise&apos; option is deprecated and will be removed from future versions\n&quot;</span>
<a name="l00814"></a>00814          <span class="stringliteral">&quot;  of Asterisk.\n&quot;</span>;
<a name="l00815"></a>00815       <span class="keywordflow">return</span> NULL;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00818"></a>00818       <span class="keywordflow">return</span> NULL;
<a name="l00819"></a>00819    }
<a name="l00820"></a>00820    fd = a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l00821"></a>00821    argc = a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>;
<a name="l00822"></a>00822    argv = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>;
<a name="l00823"></a>00823 
<a name="l00824"></a>00824    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {
<a name="l00825"></a>00825       <span class="keywordflow">if</span> (!strcasecmp(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1],<span class="stringliteral">&quot;concise&quot;</span>))
<a name="l00826"></a>00826          concise = 1;
<a name="l00827"></a>00827       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1],<span class="stringliteral">&quot;verbose&quot;</span>))
<a name="l00828"></a>00828          verbose = 1;
<a name="l00829"></a>00829       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(argv[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1],<span class="stringliteral">&quot;count&quot;</span>))
<a name="l00830"></a>00830          count = 1;
<a name="l00831"></a>00831       <span class="keywordflow">else</span>
<a name="l00832"></a>00832          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00833"></a>00833    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1)
<a name="l00834"></a>00834       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    <span class="keywordflow">if</span> (!count) {
<a name="l00837"></a>00837       <span class="keywordflow">if</span> (!concise &amp;&amp; !verbose)
<a name="l00838"></a>00838          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="cli_8c.html#ae0d41c71069898a93aa08261e2b751e3">FORMAT_STRING2</a>, <span class="stringliteral">&quot;Channel&quot;</span>, <span class="stringliteral">&quot;Location&quot;</span>, <span class="stringliteral">&quot;State&quot;</span>, <span class="stringliteral">&quot;Application(Data)&quot;</span>);
<a name="l00839"></a>00839       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (verbose)
<a name="l00840"></a>00840          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="cli_8c.html#a6db2285a7884aad0dae73e6d6e523703">VERBOSE_FORMAT_STRING2</a>, <span class="stringliteral">&quot;Channel&quot;</span>, <span class="stringliteral">&quot;Context&quot;</span>, <span class="stringliteral">&quot;Extension&quot;</span>, <span class="stringliteral">&quot;Priority&quot;</span>, <span class="stringliteral">&quot;State&quot;</span>, <span class="stringliteral">&quot;Application&quot;</span>, <span class="stringliteral">&quot;Data&quot;</span>, 
<a name="l00841"></a>00841             <span class="stringliteral">&quot;CallerID&quot;</span>, <span class="stringliteral">&quot;Duration&quot;</span>, <span class="stringliteral">&quot;Accountcode&quot;</span>, <span class="stringliteral">&quot;BridgedTo&quot;</span>);
<a name="l00842"></a>00842    }
<a name="l00843"></a>00843 
<a name="l00844"></a>00844    <span class="keywordflow">while</span> ((c = <a class="code" href="channel_8h.html#af287194cacb2db8ac7bb50d16a3a2d60" title="Browse channels in use Browse the channels currently in use.">ast_channel_walk_locked</a>(c)) != NULL) {
<a name="l00845"></a>00845       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *bc = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(c);
<a name="l00846"></a>00846       <span class="keywordtype">char</span> durbuf[10] = <span class="stringliteral">&quot;-&quot;</span>;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848       <span class="keywordflow">if</span> (!count) {
<a name="l00849"></a>00849          <span class="keywordflow">if</span> ((concise || verbose)  &amp;&amp; c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> &amp;&amp; !<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ad80305b5e16da9c2675d5f057bd69386">start</a>)) {
<a name="l00850"></a>00850             <span class="keywordtype">int</span> duration = (int)(<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ad80305b5e16da9c2675d5f057bd69386">start</a>) / 1000);
<a name="l00851"></a>00851             <span class="keywordflow">if</span> (verbose) {
<a name="l00852"></a>00852                <span class="keywordtype">int</span> durh = duration / 3600;
<a name="l00853"></a>00853                <span class="keywordtype">int</span> durm = (duration % 3600) / 60;
<a name="l00854"></a>00854                <span class="keywordtype">int</span> durs = duration % 60;
<a name="l00855"></a>00855                snprintf(durbuf, <span class="keyword">sizeof</span>(durbuf), <span class="stringliteral">&quot;%02d:%02d:%02d&quot;</span>, durh, durm, durs);
<a name="l00856"></a>00856             } <span class="keywordflow">else</span> {
<a name="l00857"></a>00857                snprintf(durbuf, <span class="keyword">sizeof</span>(durbuf), <span class="stringliteral">&quot;%d&quot;</span>, duration);
<a name="l00858"></a>00858             }           
<a name="l00859"></a>00859          }
<a name="l00860"></a>00860          <span class="keywordflow">if</span> (concise) {
<a name="l00861"></a>00861             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="cli_8c.html#a823f7fdf9a34c2f6664d989c6ec7f5d1">CONCISE_FORMAT_STRING</a>, c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, <a class="code" href="channel_8h.html#ac97b5983ea4bf3cc217ea898ca002759" title="Gives the string form of a given channel state.">ast_state2str</a>(c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>),
<a name="l00862"></a>00862                c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> ? c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> : <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l00863"></a>00863                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="stringliteral">&quot;&quot;</span>),   <span class="comment">/* XXX different from verbose ? */</span>
<a name="l00864"></a>00864                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>),
<a name="l00865"></a>00865                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;accountcode, <span class="stringliteral">&quot;&quot;</span>),
<a name="l00866"></a>00866                c-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>, 
<a name="l00867"></a>00867                durbuf,
<a name="l00868"></a>00868                bc ? bc-&gt;name : <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l00869"></a>00869                c-&gt;uniqueid);
<a name="l00870"></a>00870          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (verbose) {
<a name="l00871"></a>00871             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="cli_8c.html#aefb5368e504e2c52d6f040ce7c17e4f7">VERBOSE_FORMAT_STRING</a>, c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, <a class="code" href="channel_8h.html#ac97b5983ea4bf3cc217ea898ca002759" title="Gives the string form of a given channel state.">ast_state2str</a>(c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>),
<a name="l00872"></a>00872                c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> ? c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> : <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l00873"></a>00873                c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> ? <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="stringliteral">&quot;(Empty)&quot;</span> ): <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l00874"></a>00874                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>),
<a name="l00875"></a>00875                durbuf,
<a name="l00876"></a>00876                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;accountcode, <span class="stringliteral">&quot;&quot;</span>),
<a name="l00877"></a>00877                bc ? bc-&gt;name : <span class="stringliteral">&quot;(None)&quot;</span>);
<a name="l00878"></a>00878          } <span class="keywordflow">else</span> {
<a name="l00879"></a>00879             <span class="keywordtype">char</span> locbuf[40] = <span class="stringliteral">&quot;(None)&quot;</span>;
<a name="l00880"></a>00880             <span class="keywordtype">char</span> appdata[40] = <span class="stringliteral">&quot;(None)&quot;</span>;
<a name="l00881"></a>00881             
<a name="l00882"></a>00882             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>)) 
<a name="l00883"></a>00883                snprintf(locbuf, <span class="keyword">sizeof</span>(locbuf), <span class="stringliteral">&quot;%s@%s:%d&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l00884"></a>00884             <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a>)
<a name="l00885"></a>00885                snprintf(appdata, <span class="keyword">sizeof</span>(appdata), <span class="stringliteral">&quot;%s(%s)&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l00886"></a>00886             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="cli_8c.html#a4610636f10e4604ba296cbf9287b0c7b">FORMAT_STRING</a>, c-&gt;name, locbuf, <a class="code" href="channel_8h.html#ac97b5983ea4bf3cc217ea898ca002759" title="Gives the string form of a given channel state.">ast_state2str</a>(c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>), appdata);
<a name="l00887"></a>00887          }
<a name="l00888"></a>00888       }
<a name="l00889"></a>00889       numchans++;
<a name="l00890"></a>00890       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l00891"></a>00891    }
<a name="l00892"></a>00892    <span class="keywordflow">if</span> (!concise) {
<a name="l00893"></a>00893       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%d active channel%s\n&quot;</span>, numchans, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(numchans));
<a name="l00894"></a>00894       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>)
<a name="l00895"></a>00895          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%d of %d max active call%s (%5.2f%% of capacity)\n&quot;</span>,
<a name="l00896"></a>00896             <a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>(), <a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(<a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>()),
<a name="l00897"></a>00897             ((<span class="keywordtype">double</span>)<a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>() / (<span class="keywordtype">double</span>)<a class="code" href="group__main__options.html#ga3e1a333df2c22351f326bbfcc509edf3">option_maxcalls</a>) * 100.0);
<a name="l00898"></a>00898       <span class="keywordflow">else</span>
<a name="l00899"></a>00899          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%d active call%s\n&quot;</span>, <a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>(), <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(<a class="code" href="pbx_8h.html#a52a37e9e2d9a1482ef5b7d91001b61ac" title="Retrieve the number of active calls.">ast_active_calls</a>()));
<a name="l00900"></a>00900 
<a name="l00901"></a>00901       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%d call%s processed\n&quot;</span>, <a class="code" href="pbx_8h.html#a6cd4c64e374623ea3393fbc5d580f68e" title="Retrieve the total number of calls processed through the PBX since last restart.">ast_processed_calls</a>(), <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(<a class="code" href="pbx_8h.html#a6cd4c64e374623ea3393fbc5d580f68e" title="Retrieve the total number of calls processed through the PBX since last restart.">ast_processed_calls</a>()));
<a name="l00902"></a>00902    }
<a name="l00903"></a>00903    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00904"></a>00904    
<a name="l00905"></a>00905 <span class="preprocessor">#undef FORMAT_STRING</span>
<a name="l00906"></a>00906 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT_STRING2</span>
<a name="l00907"></a>00907 <span class="preprocessor"></span><span class="preprocessor">#undef CONCISE_FORMAT_STRING</span>
<a name="l00908"></a>00908 <span class="preprocessor"></span><span class="preprocessor">#undef VERBOSE_FORMAT_STRING</span>
<a name="l00909"></a>00909 <span class="preprocessor"></span><span class="preprocessor">#undef VERBOSE_FORMAT_STRING2</span>
<a name="l00910"></a>00910 <span class="preprocessor"></span>}
<a name="l00911"></a>00911 
<a name="l00912"></a><a class="code" href="cli_8c.html#ac430b627eac1469fcadb602741d8c247">00912</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ac430b627eac1469fcadb602741d8c247">handle_softhangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00913"></a>00913 {
<a name="l00914"></a>00914    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c=NULL;
<a name="l00915"></a>00915 
<a name="l00916"></a>00916    <span class="keywordflow">switch</span> (cmd) {
<a name="l00917"></a>00917    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00918"></a>00918       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;channel request hangup&quot;</span>;
<a name="l00919"></a>00919       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00920"></a>00920          <span class="stringliteral">&quot;Usage: channel request hangup &lt;channel&gt;\n&quot;</span>
<a name="l00921"></a>00921          <span class="stringliteral">&quot;       Request that a channel be hung up. The hangup takes effect\n&quot;</span>
<a name="l00922"></a>00922          <span class="stringliteral">&quot;       the next time the driver reads or writes from the channel\n&quot;</span>;
<a name="l00923"></a>00923       <span class="keywordflow">return</span> NULL;
<a name="l00924"></a>00924    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00925"></a>00925       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>);
<a name="l00926"></a>00926    }
<a name="l00927"></a>00927    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l00928"></a>00928       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00929"></a>00929    c = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00930"></a>00930    <span class="keywordflow">if</span> (c) {
<a name="l00931"></a>00931       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Requested Hangup on channel &apos;%s&apos;\n&quot;</span>, c-&gt;name);
<a name="l00932"></a>00932       <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(c, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l00933"></a>00933       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l00934"></a>00934    } <span class="keywordflow">else</span>
<a name="l00935"></a>00935       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s is not a known channel\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00936"></a>00936    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00937"></a>00937 }
<a name="l00938"></a>00938 <span class="comment"></span>
<a name="l00939"></a>00939 <span class="comment">/*! \brief handles CLI command &apos;cli show permissions&apos; */</span>
<a name="l00940"></a><a class="code" href="cli_8c.html#a11684ce17d4f8b062422b7320eef1015">00940</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a11684ce17d4f8b062422b7320eef1015" title="handles CLI command &amp;#39;cli show permissions&amp;#39;">handle_cli_show_permissions</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00941"></a>00941 {
<a name="l00942"></a>00942    <span class="keyword">struct </span>usergroup_cli_perm *cp;
<a name="l00943"></a>00943    <span class="keyword">struct </span>cli_perm *perm;
<a name="l00944"></a>00944    <span class="keyword">struct </span>passwd *pw = NULL;
<a name="l00945"></a>00945    <span class="keyword">struct </span><a class="code" href="structgroup.html">group</a> *gr = NULL;
<a name="l00946"></a>00946 
<a name="l00947"></a>00947    <span class="keywordflow">switch</span> (cmd) {
<a name="l00948"></a>00948    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00949"></a>00949       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;cli show permissions&quot;</span>;
<a name="l00950"></a>00950       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00951"></a>00951          <span class="stringliteral">&quot;Usage: cli show permissions\n&quot;</span>
<a name="l00952"></a>00952          <span class="stringliteral">&quot;       Shows CLI configured permissions.\n&quot;</span>;
<a name="l00953"></a>00953       <span class="keywordflow">return</span> NULL;
<a name="l00954"></a>00954    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00955"></a>00955       <span class="keywordflow">return</span> NULL;
<a name="l00956"></a>00956    }
<a name="l00957"></a>00957 
<a name="l00958"></a>00958    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;cli_perms);
<a name="l00959"></a>00959    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cli_perms, cp, list) {
<a name="l00960"></a>00960       <span class="keywordflow">if</span> (cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a> &gt;= 0) {
<a name="l00961"></a>00961          pw = getpwuid(cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a>);
<a name="l00962"></a>00962          <span class="keywordflow">if</span> (pw) {
<a name="l00963"></a>00963             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;user: %s [uid=%d]\n&quot;</span>, pw-&gt;pw_name, cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a>);
<a name="l00964"></a>00964          }
<a name="l00965"></a>00965       } <span class="keywordflow">else</span> {
<a name="l00966"></a>00966          gr = getgrgid(cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a6567680a890171fbaa1a026477a858d3">gid</a>);
<a name="l00967"></a>00967          <span class="keywordflow">if</span> (gr) {
<a name="l00968"></a>00968             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;group: %s [gid=%d]\n&quot;</span>, gr-&gt;gr_name, cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a6567680a890171fbaa1a026477a858d3">gid</a>);
<a name="l00969"></a>00969          }
<a name="l00970"></a>00970       }
<a name="l00971"></a>00971       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Permissions:\n&quot;</span>);
<a name="l00972"></a>00972       <span class="keywordflow">if</span> (cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>) {
<a name="l00973"></a>00973          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(cp-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>, perm, list) {
<a name="l00974"></a>00974             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\t%s -&gt; %s\n&quot;</span>, perm-&gt;<a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">permit</a> ? <span class="stringliteral">&quot;permit&quot;</span> : <span class="stringliteral">&quot;deny&quot;</span>, perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>);
<a name="l00975"></a>00975          }
<a name="l00976"></a>00976       }
<a name="l00977"></a>00977       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00978"></a>00978    }
<a name="l00979"></a>00979    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;cli_perms);
<a name="l00980"></a>00980 
<a name="l00981"></a>00981    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00982"></a>00982 }
<a name="l00983"></a>00983 <span class="comment"></span>
<a name="l00984"></a>00984 <span class="comment">/*! \brief handles CLI command &apos;cli reload permissions&apos; */</span>
<a name="l00985"></a><a class="code" href="cli_8c.html#ac09450fa9355a3e44c87c1adada60307">00985</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ac09450fa9355a3e44c87c1adada60307" title="handles CLI command &amp;#39;cli reload permissions&amp;#39;">handle_cli_reload_permissions</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987    <span class="keywordflow">switch</span> (cmd) {
<a name="l00988"></a>00988    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00989"></a>00989       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;cli reload permissions&quot;</span>;
<a name="l00990"></a>00990       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00991"></a>00991          <span class="stringliteral">&quot;Usage: cli reload permissions\n&quot;</span>
<a name="l00992"></a>00992          <span class="stringliteral">&quot;       Reload the &apos;cli_permissions.conf&apos; file.\n&quot;</span>;
<a name="l00993"></a>00993       <span class="keywordflow">return</span> NULL;
<a name="l00994"></a>00994    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00995"></a>00995       <span class="keywordflow">return</span> NULL;
<a name="l00996"></a>00996    }
<a name="l00997"></a>00997 
<a name="l00998"></a>00998    <a class="code" href="__private_8h.html#ade6dbc4196f2fc99250aaafededfb41b">ast_cli_perms_init</a>(1);
<a name="l00999"></a>00999 
<a name="l01000"></a>01000    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01001"></a>01001 }
<a name="l01002"></a>01002 <span class="comment"></span>
<a name="l01003"></a>01003 <span class="comment">/*! \brief handles CLI command &apos;cli check permissions&apos; */</span>
<a name="l01004"></a><a class="code" href="cli_8c.html#a3e8d2dcbe23247ed8025ec7cbc383861">01004</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a3e8d2dcbe23247ed8025ec7cbc383861" title="handles CLI command &amp;#39;cli check permissions&amp;#39;">handle_cli_check_permissions</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01005"></a>01005 {
<a name="l01006"></a>01006    <span class="keyword">struct </span>passwd *pw = NULL;
<a name="l01007"></a>01007    <span class="keyword">struct </span><a class="code" href="structgroup.html">group</a> *gr;
<a name="l01008"></a>01008    <span class="keywordtype">int</span> gid = -1, uid = -1;
<a name="l01009"></a>01009    <span class="keywordtype">char</span> <a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>[<a class="code" href="cli_8h.html#a72e6114dccaa5a6f2c8e7d369360db9e">AST_MAX_ARGS</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01010"></a>01010    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *ce = NULL;
<a name="l01011"></a>01011    <span class="keywordtype">int</span> found = 0;
<a name="l01012"></a>01012    <span class="keywordtype">char</span> *<a class="code" href="structgroup.html">group</a>, *tmp;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014    <span class="keywordflow">switch</span> (cmd) {
<a name="l01015"></a>01015    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01016"></a>01016       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;cli check permissions&quot;</span>;
<a name="l01017"></a>01017       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01018"></a>01018          <span class="stringliteral">&quot;Usage: cli check permissions {&lt;username&gt;|@&lt;groupname&gt;|&lt;username&gt;@&lt;groupname&gt;} [&lt;command&gt;]\n&quot;</span>
<a name="l01019"></a>01019          <span class="stringliteral">&quot;       Check permissions config for a user@group or list the allowed commands for the specified user.\n&quot;</span>
<a name="l01020"></a>01020          <span class="stringliteral">&quot;       The username or the groupname may be omitted.\n&quot;</span>;
<a name="l01021"></a>01021       <span class="keywordflow">return</span> NULL;
<a name="l01022"></a>01022    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01023"></a>01023       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> &gt;= 4) {
<a name="l01024"></a>01024          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a21652cd28eeec8299b69288967f9a4a1" title="Readline madness Useful for readline, that&amp;#39;s about it.">ast_cli_generator</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a> + strlen(<span class="stringliteral">&quot;cli check permissions&quot;</span>) + strlen(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]) + 1, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l01025"></a>01025       }
<a name="l01026"></a>01026       <span class="keywordflow">return</span> NULL;
<a name="l01027"></a>01027    }
<a name="l01028"></a>01028 
<a name="l01029"></a>01029    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4) {
<a name="l01030"></a>01030       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01031"></a>01031    }
<a name="l01032"></a>01032 
<a name="l01033"></a>01033    tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01034"></a>01034    group = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>);
<a name="l01035"></a>01035    <span class="keywordflow">if</span> (group) {
<a name="l01036"></a>01036       gr = getgrnam(&amp;group[1]);
<a name="l01037"></a>01037       <span class="keywordflow">if</span> (!gr) {
<a name="l01038"></a>01038          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unknown group &apos;%s&apos;\n&quot;</span>, &amp;group[1]);
<a name="l01039"></a>01039          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01040"></a>01040       }
<a name="l01041"></a>01041       group[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01042"></a>01042       gid = gr-&gt;gr_gid;
<a name="l01043"></a>01043    }
<a name="l01044"></a>01044 
<a name="l01045"></a>01045    <span class="keywordflow">if</span> (!group &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tmp)) {
<a name="l01046"></a>01046       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;You didn&apos;t supply a username\n&quot;</span>);
<a name="l01047"></a>01047    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tmp) &amp;&amp; !(pw = getpwnam(tmp))) {
<a name="l01048"></a>01048       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unknown user &apos;%s&apos;\n&quot;</span>, tmp);
<a name="l01049"></a>01049       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01050"></a>01050    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pw) {
<a name="l01051"></a>01051       uid = pw-&gt;pw_uid;
<a name="l01052"></a>01052    }
<a name="l01053"></a>01053 
<a name="l01054"></a>01054    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4) {
<a name="l01055"></a>01055       <span class="keywordflow">while</span> ((ce = <a class="code" href="cli_8c.html#adac48ec5ae21bd48d7f3dac6c44b2868">cli_next</a>(ce))) {
<a name="l01056"></a>01056          <span class="comment">/* Hide commands that start with &apos;_&apos; */</span>
<a name="l01057"></a>01057          <span class="keywordflow">if</span> (ce-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>[0] == <span class="charliteral">&apos;_&apos;</span>) {
<a name="l01058"></a>01058             <span class="keywordflow">continue</span>;
<a name="l01059"></a>01059          }
<a name="l01060"></a>01060          <span class="keywordflow">if</span> (<a class="code" href="cli_8c.html#a97c81620d61e3249bf35cada6df2a088">cli_has_permissions</a>(uid, gid, ce-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>)) {
<a name="l01061"></a>01061             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%30.30s %s\n&quot;</span>, ce-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(ce-&gt;<a class="code" href="structast__cli__entry.html#a01f3e852fed0577d6c8f059530d55d50">summary</a>, <span class="stringliteral">&quot;&lt;no description available&gt;&quot;</span>));
<a name="l01062"></a>01062             found++;
<a name="l01063"></a>01063          }
<a name="l01064"></a>01064       }
<a name="l01065"></a>01065       <span class="keywordflow">if</span> (!found) {
<a name="l01066"></a>01066          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;You are not allowed to run any command on Asterisk\n&quot;</span>);
<a name="l01067"></a>01067       }
<a name="l01068"></a>01068    } <span class="keywordflow">else</span> {
<a name="l01069"></a>01069       <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(command, <span class="keyword">sizeof</span>(command), a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + 4);
<a name="l01070"></a>01070       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s &apos;%s%s%s&apos; is %s to run command: &apos;%s&apos;\n&quot;</span>, uid &gt;= 0 ? <span class="stringliteral">&quot;User&quot;</span> : <span class="stringliteral">&quot;Group&quot;</span>, tmp,
<a name="l01071"></a>01071          group &amp;&amp; uid &gt;= 0 ? <span class="stringliteral">&quot;@&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01072"></a>01072          group ? &amp;group[1] : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01073"></a>01073          <a class="code" href="cli_8c.html#a97c81620d61e3249bf35cada6df2a088">cli_has_permissions</a>(uid, gid, command) ? <span class="stringliteral">&quot;allowed&quot;</span> : <span class="stringliteral">&quot;not allowed&quot;</span>, command);
<a name="l01074"></a>01074    }
<a name="l01075"></a>01075 
<a name="l01076"></a>01076    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01077"></a>01077 }
<a name="l01078"></a>01078 
<a name="l01079"></a>01079 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ad05311723605fd9bf9bcf9ebe05323dc">__ast_cli_generator</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01080"></a>01080 
<a name="l01081"></a><a class="code" href="cli_8c.html#a6b6e0b5f4ca0072eadaddf04e6334f63">01081</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a6b6e0b5f4ca0072eadaddf04e6334f63">handle_commandmatchesarray</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01082"></a>01082 {
<a name="l01083"></a>01083    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, *obuf;
<a name="l01084"></a>01084    <span class="keywordtype">int</span> buflen = 2048;
<a name="l01085"></a>01085    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = 0;
<a name="l01086"></a>01086    <span class="keywordtype">char</span> **matches;
<a name="l01087"></a>01087    <span class="keywordtype">int</span> x, matchlen;
<a name="l01088"></a>01088    
<a name="l01089"></a>01089    <span class="keywordflow">switch</span> (cmd) {
<a name="l01090"></a>01090    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01091"></a>01091       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;_command matchesarray&quot;</span>;
<a name="l01092"></a>01092       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01093"></a>01093          <span class="stringliteral">&quot;Usage: _command matchesarray \&quot;&lt;line&gt;\&quot; text \n&quot;</span>
<a name="l01094"></a>01094          <span class="stringliteral">&quot;       This function is used internally to help with command completion and should.\n&quot;</span>
<a name="l01095"></a>01095          <span class="stringliteral">&quot;       never be called by the user directly.\n&quot;</span>;
<a name="l01096"></a>01096       <span class="keywordflow">return</span> NULL;
<a name="l01097"></a>01097    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01098"></a>01098       <span class="keywordflow">return</span> NULL;
<a name="l01099"></a>01099    }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l01102"></a>01102       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01103"></a>01103    <span class="keywordflow">if</span> (!(buf = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(buflen)))
<a name="l01104"></a>01104       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01105"></a>01105    buf[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01106"></a>01106    matches = <a class="code" href="cli_8h.html#a068d40212b118f7bc09e851af6a45015" title="Generates a NULL-terminated array of strings that 1) begin with the string in the...">ast_cli_completion_matches</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01107"></a>01107    <span class="keywordflow">if</span> (matches) {
<a name="l01108"></a>01108       <span class="keywordflow">for</span> (x=0; matches[x]; x++) {
<a name="l01109"></a>01109          matchlen = strlen(matches[x]) + 1;
<a name="l01110"></a>01110          <span class="keywordflow">if</span> (len + matchlen &gt;= buflen) {
<a name="l01111"></a>01111             buflen += matchlen * 3;
<a name="l01112"></a>01112             obuf = buf;
<a name="l01113"></a>01113             <span class="keywordflow">if</span> (!(buf = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(obuf, buflen))) 
<a name="l01114"></a>01114                <span class="comment">/* Memory allocation failure...  Just free old buffer and be done */</span>
<a name="l01115"></a>01115                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obuf);
<a name="l01116"></a>01116          }
<a name="l01117"></a>01117          <span class="keywordflow">if</span> (buf)
<a name="l01118"></a>01118             len += sprintf( buf + len, <span class="stringliteral">&quot;%s &quot;</span>, matches[x]);
<a name="l01119"></a>01119          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(matches[x]);
<a name="l01120"></a>01120          matches[x] = NULL;
<a name="l01121"></a>01121       }
<a name="l01122"></a>01122       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(matches);
<a name="l01123"></a>01123    }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125    <span class="keywordflow">if</span> (buf) {
<a name="l01126"></a>01126       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s%s&quot;</span>,buf, <a class="code" href="cli_8h.html#a4970cad1f99a12bc6f6838d538496079">AST_CLI_COMPLETE_EOF</a>);
<a name="l01127"></a>01127       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);
<a name="l01128"></a>01128    } <span class="keywordflow">else</span>
<a name="l01129"></a>01129       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;NULL\n&quot;</span>);
<a name="l01130"></a>01130 
<a name="l01131"></a>01131    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01132"></a>01132 }
<a name="l01133"></a>01133 
<a name="l01134"></a>01134 
<a name="l01135"></a>01135 
<a name="l01136"></a><a class="code" href="cli_8c.html#ad09ea0d383b50baecfa8d3c828e59a0f">01136</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ad09ea0d383b50baecfa8d3c828e59a0f">handle_commandnummatches</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01137"></a>01137 {
<a name="l01138"></a>01138    <span class="keywordtype">int</span> matches = 0;
<a name="l01139"></a>01139 
<a name="l01140"></a>01140    <span class="keywordflow">switch</span> (cmd) {
<a name="l01141"></a>01141    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01142"></a>01142       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;_command nummatches&quot;</span>;
<a name="l01143"></a>01143       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01144"></a>01144          <span class="stringliteral">&quot;Usage: _command nummatches \&quot;&lt;line&gt;\&quot; text \n&quot;</span>
<a name="l01145"></a>01145          <span class="stringliteral">&quot;       This function is used internally to help with command completion and should.\n&quot;</span>
<a name="l01146"></a>01146          <span class="stringliteral">&quot;       never be called by the user directly.\n&quot;</span>;
<a name="l01147"></a>01147       <span class="keywordflow">return</span> NULL;
<a name="l01148"></a>01148    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01149"></a>01149       <span class="keywordflow">return</span> NULL;
<a name="l01150"></a>01150    }
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l01153"></a>01153       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01154"></a>01154 
<a name="l01155"></a>01155    matches = <a class="code" href="cli_8h.html#aeb2e977805785f2382807318e26c4829" title="Return the number of unique matches for the generator.">ast_cli_generatornummatches</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01156"></a>01156 
<a name="l01157"></a>01157    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d&quot;</span>, matches);
<a name="l01158"></a>01158 
<a name="l01159"></a>01159    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01160"></a>01160 }
<a name="l01161"></a>01161 
<a name="l01162"></a><a class="code" href="cli_8c.html#ac1db63599c1347e2a626f63499c3c018">01162</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ac1db63599c1347e2a626f63499c3c018">handle_commandcomplete</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01163"></a>01163 {
<a name="l01164"></a>01164    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l01165"></a>01165    <span class="keywordflow">switch</span> (cmd) {
<a name="l01166"></a>01166    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01167"></a>01167       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;_command complete&quot;</span>;
<a name="l01168"></a>01168       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01169"></a>01169          <span class="stringliteral">&quot;Usage: _command complete \&quot;&lt;line&gt;\&quot; text state\n&quot;</span>
<a name="l01170"></a>01170          <span class="stringliteral">&quot;       This function is used internally to help with command completion and should.\n&quot;</span>
<a name="l01171"></a>01171          <span class="stringliteral">&quot;       never be called by the user directly.\n&quot;</span>;
<a name="l01172"></a>01172       <span class="keywordflow">return</span> NULL;
<a name="l01173"></a>01173    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01174"></a>01174       <span class="keywordflow">return</span> NULL;
<a name="l01175"></a>01175    }
<a name="l01176"></a>01176    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 5)
<a name="l01177"></a>01177       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01178"></a>01178    buf = <a class="code" href="cli_8c.html#ad05311723605fd9bf9bcf9ebe05323dc">__ast_cli_generator</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]), 0);
<a name="l01179"></a>01179    <span class="keywordflow">if</span> (buf) {
<a name="l01180"></a>01180       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s&quot;</span>, buf);
<a name="l01181"></a>01181       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);
<a name="l01182"></a>01182    } <span class="keywordflow">else</span>
<a name="l01183"></a>01183       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;NULL\n&quot;</span>);
<a name="l01184"></a>01184    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01185"></a>01185 }
<a name="l01186"></a>01186 
<a name="l01187"></a><a class="code" href="cli_8c.html#ab1c36f45ca7d85999d12b028d6445662">01187</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ab1c36f45ca7d85999d12b028d6445662">handle_core_set_debug_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = NULL;
<a name="l01190"></a>01190    <span class="keywordtype">int</span> is_all, is_off = 0;
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    <span class="keywordflow">switch</span> (cmd) {
<a name="l01193"></a>01193    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01194"></a>01194       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core set debug channel&quot;</span>;
<a name="l01195"></a>01195       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01196"></a>01196          <span class="stringliteral">&quot;Usage: core set debug channel &lt;all|channel&gt; [off]\n&quot;</span>
<a name="l01197"></a>01197          <span class="stringliteral">&quot;       Enables/disables debugging on all or on a specific channel.\n&quot;</span>;
<a name="l01198"></a>01198       <span class="keywordflow">return</span> NULL;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01201"></a>01201       <span class="comment">/* XXX remember to handle the optional &quot;off&quot; */</span>
<a name="l01202"></a>01202       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01203"></a>01203          <span class="keywordflow">return</span> NULL;
<a name="l01204"></a>01204       <span class="keywordflow">return</span> a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0 ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;all&quot;</span>) : <a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> - 1, e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>);
<a name="l01205"></a>01205    }
<a name="l01206"></a>01206    <span class="comment">/* &apos;core set debug channel {all|chan_id}&apos; */</span>
<a name="l01207"></a>01207    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 2) {
<a name="l01208"></a>01208       <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1], <span class="stringliteral">&quot;off&quot;</span>))
<a name="l01209"></a>01209          is_off = 1;
<a name="l01210"></a>01210       <span class="keywordflow">else</span>
<a name="l01211"></a>01211          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01212"></a>01212    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l01213"></a>01213       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01214"></a>01214 
<a name="l01215"></a>01215    is_all = !strcasecmp(<span class="stringliteral">&quot;all&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l01216"></a>01216    <span class="keywordflow">if</span> (is_all) {
<a name="l01217"></a>01217       <span class="keywordflow">if</span> (is_off) {
<a name="l01218"></a>01218          <a class="code" href="channel_8h.html#a7457a2311fc74cc4a5b0aa0d2001835c">global_fin</a> &amp;= ~<a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01219"></a>01219          <a class="code" href="channel_8h.html#ade9bc8493de7d579e2f06b55379fc673">global_fout</a> &amp;= ~<a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01220"></a>01220       } <span class="keywordflow">else</span> {
<a name="l01221"></a>01221          <a class="code" href="channel_8h.html#a7457a2311fc74cc4a5b0aa0d2001835c">global_fin</a> |= <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01222"></a>01222          <a class="code" href="channel_8h.html#ade9bc8493de7d579e2f06b55379fc673">global_fout</a> |= <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01223"></a>01223       }
<a name="l01224"></a>01224       c = <a class="code" href="channel_8h.html#af287194cacb2db8ac7bb50d16a3a2d60" title="Browse channels in use Browse the channels currently in use.">ast_channel_walk_locked</a>(NULL);
<a name="l01225"></a>01225    } <span class="keywordflow">else</span> {
<a name="l01226"></a>01226       c = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l01227"></a>01227       <span class="keywordflow">if</span> (c == NULL)
<a name="l01228"></a>01228          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such channel %s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l01229"></a>01229    }
<a name="l01230"></a>01230    <span class="keywordflow">while</span> (c) {
<a name="l01231"></a>01231       <span class="keywordflow">if</span> (!(c-&gt;<a class="code" href="structast__channel.html#aa4b0a5423e11c07e15c3a503c36be0fb">fin</a> &amp; <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>) || !(c-&gt;<a class="code" href="structast__channel.html#af2ef0dd0824e04b55a277f42c10f3dfa">fout</a> &amp; <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>)) {
<a name="l01232"></a>01232          <span class="keywordflow">if</span> (is_off) {
<a name="l01233"></a>01233             c-&gt;<a class="code" href="structast__channel.html#aa4b0a5423e11c07e15c3a503c36be0fb">fin</a> &amp;= ~<a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01234"></a>01234             c-&gt;<a class="code" href="structast__channel.html#af2ef0dd0824e04b55a277f42c10f3dfa">fout</a> &amp;= ~<a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01235"></a>01235          } <span class="keywordflow">else</span> {
<a name="l01236"></a>01236             c-&gt;<a class="code" href="structast__channel.html#aa4b0a5423e11c07e15c3a503c36be0fb">fin</a> |= <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01237"></a>01237             c-&gt;<a class="code" href="structast__channel.html#af2ef0dd0824e04b55a277f42c10f3dfa">fout</a> |= <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>;
<a name="l01238"></a>01238          }
<a name="l01239"></a>01239          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Debugging %s on channel %s\n&quot;</span>, is_off ? <span class="stringliteral">&quot;disabled&quot;</span> : <span class="stringliteral">&quot;enabled&quot;</span>, c-&gt;name);
<a name="l01240"></a>01240       }
<a name="l01241"></a>01241       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l01242"></a>01242       <span class="keywordflow">if</span> (!is_all)
<a name="l01243"></a>01243          <span class="keywordflow">break</span>;
<a name="l01244"></a>01244       c = <a class="code" href="channel_8h.html#af287194cacb2db8ac7bb50d16a3a2d60" title="Browse channels in use Browse the channels currently in use.">ast_channel_walk_locked</a>(c);
<a name="l01245"></a>01245    }
<a name="l01246"></a>01246    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Debugging on new channels is %s\n&quot;</span>, is_off ? <span class="stringliteral">&quot;disabled&quot;</span> : <span class="stringliteral">&quot;enabled&quot;</span>);
<a name="l01247"></a>01247    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01248"></a>01248 }
<a name="l01249"></a>01249 
<a name="l01250"></a><a class="code" href="cli_8c.html#ade46ebd034310224ed0055553eb89af9">01250</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ade46ebd034310224ed0055553eb89af9">handle_nodebugchan_deprecated</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01251"></a>01251 {
<a name="l01252"></a>01252    <span class="keywordtype">char</span> *res;
<a name="l01253"></a>01253    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea2e4a68503bbadbeacf842a24c7d7f2df">CLI_HANDLER</a>) {
<a name="l01254"></a>01254       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l01255"></a>01255          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01256"></a>01256       <span class="comment">/* pretend we have an extra &quot;off&quot; at the end. We can do this as the array</span>
<a name="l01257"></a>01257 <span class="comment">       * is NULL terminated so we overwrite that entry.</span>
<a name="l01258"></a>01258 <span class="comment">       */</span>
<a name="l01259"></a>01259       a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>+1] = <span class="stringliteral">&quot;off&quot;</span>;
<a name="l01260"></a>01260       a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>++;
<a name="l01261"></a>01261    }
<a name="l01262"></a>01262    res = <a class="code" href="cli_8c.html#ab1c36f45ca7d85999d12b028d6445662">handle_core_set_debug_channel</a>(e, cmd, a);
<a name="l01263"></a>01263    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>)
<a name="l01264"></a>01264       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;no debug channel&quot;</span>;
<a name="l01265"></a>01265    <span class="keywordflow">return</span> res;
<a name="l01266"></a>01266 }
<a name="l01267"></a>01267       
<a name="l01268"></a><a class="code" href="cli_8c.html#a9507ef3d00c28f297846fd44595db1c8">01268</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a9507ef3d00c28f297846fd44595db1c8">handle_showchan</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01269"></a>01269 {
<a name="l01270"></a>01270    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c=NULL;
<a name="l01271"></a>01271    <span class="keyword">struct </span>timeval now;
<a name="l01272"></a>01272    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *out = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;ast_str_thread_global_buf, 16);
<a name="l01273"></a>01273    <span class="keywordtype">char</span> cdrtime[256];
<a name="l01274"></a>01274    <span class="keywordtype">char</span> nf[256], wf[256], rf[256];
<a name="l01275"></a>01275    <span class="keywordtype">long</span> elapsed_seconds=0;
<a name="l01276"></a>01276    <span class="keywordtype">int</span> hour=0, min=0, <a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>=0;
<a name="l01277"></a>01277 <span class="preprocessor">#ifdef CHANNEL_TRACE</span>
<a name="l01278"></a>01278 <span class="preprocessor"></span>   <span class="keywordtype">int</span> trace_enabled;
<a name="l01279"></a>01279 <span class="preprocessor">#endif</span>
<a name="l01280"></a>01280 <span class="preprocessor"></span>
<a name="l01281"></a>01281    <span class="keywordflow">switch</span> (cmd) {
<a name="l01282"></a>01282    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01283"></a>01283       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show channel&quot;</span>;
<a name="l01284"></a>01284       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01285"></a>01285          <span class="stringliteral">&quot;Usage: core show channel &lt;channel&gt;\n&quot;</span>
<a name="l01286"></a>01286          <span class="stringliteral">&quot;       Shows lots of information about the specified channel.\n&quot;</span>;
<a name="l01287"></a>01287       <span class="keywordflow">return</span> NULL;
<a name="l01288"></a>01288    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01289"></a>01289       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 3);
<a name="l01290"></a>01290    }
<a name="l01291"></a>01291    
<a name="l01292"></a>01292    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l01293"></a>01293       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01294"></a>01294    now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01295"></a>01295    c = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01296"></a>01296    <span class="keywordflow">if</span> (!c) {
<a name="l01297"></a>01297       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s is not a known channel\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01298"></a>01298       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01299"></a>01299    }
<a name="l01300"></a>01300    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l01301"></a>01301       elapsed_seconds = now.tv_sec - c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ad80305b5e16da9c2675d5f057bd69386">start</a>.tv_sec;
<a name="l01302"></a>01302       hour = elapsed_seconds / 3600;
<a name="l01303"></a>01303       min = (elapsed_seconds % 3600) / 60;
<a name="l01304"></a>01304       <a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a> = elapsed_seconds % 60;
<a name="l01305"></a>01305       snprintf(cdrtime, <span class="keyword">sizeof</span>(cdrtime), <span class="stringliteral">&quot;%dh%dm%ds&quot;</span>, hour, min, <a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>);
<a name="l01306"></a>01306    } <span class="keywordflow">else</span>
<a name="l01307"></a>01307       strcpy(cdrtime, <span class="stringliteral">&quot;N/A&quot;</span>);
<a name="l01308"></a>01308    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, 
<a name="l01309"></a>01309       <span class="stringliteral">&quot; -- General --\n&quot;</span>
<a name="l01310"></a>01310       <span class="stringliteral">&quot;           Name: %s\n&quot;</span>
<a name="l01311"></a>01311       <span class="stringliteral">&quot;           Type: %s\n&quot;</span>
<a name="l01312"></a>01312       <span class="stringliteral">&quot;       UniqueID: %s\n&quot;</span>
<a name="l01313"></a>01313       <span class="stringliteral">&quot;      Caller ID: %s\n&quot;</span>
<a name="l01314"></a>01314       <span class="stringliteral">&quot; Caller ID Name: %s\n&quot;</span>
<a name="l01315"></a>01315       <span class="stringliteral">&quot;    DNID Digits: %s\n&quot;</span>
<a name="l01316"></a>01316       <span class="stringliteral">&quot;       Language: %s\n&quot;</span>
<a name="l01317"></a>01317       <span class="stringliteral">&quot;          State: %s (%d)\n&quot;</span>
<a name="l01318"></a>01318       <span class="stringliteral">&quot;          Rings: %d\n&quot;</span>
<a name="l01319"></a>01319       <span class="stringliteral">&quot;  NativeFormats: %s\n&quot;</span>
<a name="l01320"></a>01320       <span class="stringliteral">&quot;    WriteFormat: %s\n&quot;</span>
<a name="l01321"></a>01321       <span class="stringliteral">&quot;     ReadFormat: %s\n&quot;</span>
<a name="l01322"></a>01322       <span class="stringliteral">&quot; WriteTranscode: %s\n&quot;</span>
<a name="l01323"></a>01323       <span class="stringliteral">&quot;  ReadTranscode: %s\n&quot;</span>
<a name="l01324"></a>01324       <span class="stringliteral">&quot;1st File Descriptor: %d\n&quot;</span>
<a name="l01325"></a>01325       <span class="stringliteral">&quot;      Frames in: %d%s\n&quot;</span>
<a name="l01326"></a>01326       <span class="stringliteral">&quot;     Frames out: %d%s\n&quot;</span>
<a name="l01327"></a>01327       <span class="stringliteral">&quot; Time to Hangup: %ld\n&quot;</span>
<a name="l01328"></a>01328       <span class="stringliteral">&quot;   Elapsed Time: %s\n&quot;</span>
<a name="l01329"></a>01329       <span class="stringliteral">&quot;  Direct Bridge: %s\n&quot;</span>
<a name="l01330"></a>01330       <span class="stringliteral">&quot;Indirect Bridge: %s\n&quot;</span>
<a name="l01331"></a>01331       <span class="stringliteral">&quot; --   PBX   --\n&quot;</span>
<a name="l01332"></a>01332       <span class="stringliteral">&quot;        Context: %s\n&quot;</span>
<a name="l01333"></a>01333       <span class="stringliteral">&quot;      Extension: %s\n&quot;</span>
<a name="l01334"></a>01334       <span class="stringliteral">&quot;       Priority: %d\n&quot;</span>
<a name="l01335"></a>01335       <span class="stringliteral">&quot;     Call Group: %llu\n&quot;</span>
<a name="l01336"></a>01336       <span class="stringliteral">&quot;   Pickup Group: %llu\n&quot;</span>
<a name="l01337"></a>01337       <span class="stringliteral">&quot;    Application: %s\n&quot;</span>
<a name="l01338"></a>01338       <span class="stringliteral">&quot;           Data: %s\n&quot;</span>
<a name="l01339"></a>01339       <span class="stringliteral">&quot;    Blocking in: %s\n&quot;</span>,
<a name="l01340"></a>01340       c-&gt;name, c-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, c-&gt;uniqueid,
<a name="l01341"></a>01341       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;(N/A)&quot;</span>),
<a name="l01342"></a>01342       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;(N/A)&quot;</span>),
<a name="l01343"></a>01343       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aa54ab157f47ac529034d524781e2a7e2">cid_dnid</a>, <span class="stringliteral">&quot;(N/A)&quot;</span>), 
<a name="l01344"></a>01344       c-&gt;language,   
<a name="l01345"></a>01345       <a class="code" href="channel_8h.html#ac97b5983ea4bf3cc217ea898ca002759" title="Gives the string form of a given channel state.">ast_state2str</a>(c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>), c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>, c-&gt;<a class="code" href="structast__channel.html#a358fd14658a0c5276190e48f1b1f251a">rings</a>, 
<a name="l01346"></a>01346       <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(nf, <span class="keyword">sizeof</span>(nf), c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>), 
<a name="l01347"></a>01347       <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(wf, <span class="keyword">sizeof</span>(wf), c-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>), 
<a name="l01348"></a>01348       <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(rf, <span class="keyword">sizeof</span>(rf), c-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>),
<a name="l01349"></a>01349       c-&gt;<a class="code" href="structast__channel.html#a58d0c117fa64b075eda1d9a7a7d73531">writetrans</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l01350"></a>01350       c-&gt;<a class="code" href="structast__channel.html#a9601e6aff2a4c59cbeb9d6fef81184f4">readtrans</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l01351"></a>01351       c-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0],
<a name="l01352"></a>01352       c-&gt;<a class="code" href="structast__channel.html#aa4b0a5423e11c07e15c3a503c36be0fb">fin</a> &amp; ~<a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>, (c-&gt;<a class="code" href="structast__channel.html#aa4b0a5423e11c07e15c3a503c36be0fb">fin</a> &amp; <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>) ? <span class="stringliteral">&quot; (DEBUGGED)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01353"></a>01353       c-&gt;<a class="code" href="structast__channel.html#af2ef0dd0824e04b55a277f42c10f3dfa">fout</a> &amp; ~<a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>, (c-&gt;<a class="code" href="structast__channel.html#af2ef0dd0824e04b55a277f42c10f3dfa">fout</a> &amp; <a class="code" href="channel_8h.html#a2011c630205057fb4b67eb06145e4a7f">DEBUGCHAN_FLAG</a>) ? <span class="stringliteral">&quot; (DEBUGGED)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01354"></a>01354       (<span class="keywordtype">long</span>)c-&gt;<a class="code" href="structast__channel.html#a645928dea02ce2132b83e7e61ef5b80a">whentohangup</a>.tv_sec,
<a name="l01355"></a>01355       cdrtime, c-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a> ? c-&gt;<a class="code" href="structast__channel.html#a81ab061f1622c159fe55ba4f17309cc5">_bridge</a>-&gt;name : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(c) ? <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(c)-&gt;<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>, 
<a name="l01356"></a>01356       c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, c-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, c-&gt;<a class="code" href="structast__channel.html#af0f007b48a9c8cf0629428bd0483e0d1">callgroup</a>, c-&gt;<a class="code" href="structast__channel.html#abc0651bcec68410023c036b7d8ec4d11">pickupgroup</a>, ( c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> ? c-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> : <span class="stringliteral">&quot;(N/A)&quot;</span> ),
<a name="l01357"></a>01357       ( c-&gt; data ? <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(c-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="stringliteral">&quot;(Empty)&quot;</span>) : <span class="stringliteral">&quot;(None)&quot;</span>),
<a name="l01358"></a>01358       (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(c, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ab5b2bec9425dd0cfc789d96ef229cb3a">AST_FLAG_BLOCKING</a>) ? c-&gt;<a class="code" href="structast__channel.html#ae9ef3ba2141dce73f755cdd3a34408d3">blockproc</a> : <span class="stringliteral">&quot;(Not Blocking)&quot;</span>));
<a name="l01359"></a>01359    
<a name="l01360"></a>01360    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a847dc86089ce693d89a534512f16dad1" title="Create a human-readable string, specifying all variables and their corresponding...">pbx_builtin_serialize_variables</a>(c, &amp;out))
<a name="l01361"></a>01361       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;      Variables:\n%s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l01362"></a>01362    <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> &amp;&amp; <a class="code" href="cdr_8h.html#a3e3762a7867ecfa87531598bb8050874">ast_cdr_serialize_variables</a>(c-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, &amp;out, <span class="charliteral">&apos;=&apos;</span>, <span class="charliteral">&apos;\n&apos;</span>, 1))
<a name="l01363"></a>01363       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;  CDR Variables:\n%s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l01364"></a>01364 <span class="preprocessor">#ifdef CHANNEL_TRACE</span>
<a name="l01365"></a>01365 <span class="preprocessor"></span>   trace_enabled = ast_channel_trace_is_enabled(c);
<a name="l01366"></a>01366    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Context Trace: %s\n&quot;</span>, trace_enabled ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l01367"></a>01367    <span class="keywordflow">if</span> (trace_enabled &amp;&amp; ast_channel_trace_serialize(c, &amp;out))
<a name="l01368"></a>01368       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;          Trace:\n%s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(out));
<a name="l01369"></a>01369 <span class="preprocessor">#endif</span>
<a name="l01370"></a>01370 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l01371"></a>01371    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01372"></a>01372 }
<a name="l01373"></a>01373 
<a name="l01374"></a>01374 <span class="comment">/*</span>
<a name="l01375"></a>01375 <span class="comment"> * helper function to generate CLI matches from a fixed set of values.</span>
<a name="l01376"></a>01376 <span class="comment"> * A NULL word is acceptable.</span>
<a name="l01377"></a>01377 <span class="comment"> */</span>
<a name="l01378"></a><a class="code" href="cli_8c.html#a398bbbd46cab5e1fe414d43cb1f8e1a8">01378</a> <span class="keywordtype">char</span> *<a class="code" href="cli_8h.html#a7d198ac45b2d75bb30eb773582caf89f">ast_cli_complete</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">char</span> *<span class="keyword">const</span> choices[], <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l01379"></a>01379 {
<a name="l01380"></a>01380    <span class="keywordtype">int</span> i, which = 0, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01381"></a>01381    <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(word) ? 0 : strlen(word);
<a name="l01382"></a>01382 
<a name="l01383"></a>01383    <span class="keywordflow">for</span> (i = 0; choices[i]; i++) {
<a name="l01384"></a>01384       <span class="keywordflow">if</span> ((!<a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> || !strncasecmp(word, choices[i], <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)) &amp;&amp; ++which &gt; state)
<a name="l01385"></a>01385          <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(choices[i]);
<a name="l01386"></a>01386    }
<a name="l01387"></a>01387    <span class="keywordflow">return</span> NULL;
<a name="l01388"></a>01388 }
<a name="l01389"></a>01389 
<a name="l01390"></a><a class="code" href="cli_8c.html#a3a116acde8f18aa530e5b4a6df420273">01390</a> <span class="keywordtype">char</span> *<a class="code" href="cli_8h.html#a3a116acde8f18aa530e5b4a6df420273" title="Command completion for the list of active channels.">ast_complete_channels</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">int</span> rpos)
<a name="l01391"></a>01391 {
<a name="l01392"></a>01392    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = NULL;
<a name="l01393"></a>01393    <span class="keywordtype">int</span> which = 0;
<a name="l01394"></a>01394    <span class="keywordtype">int</span> wordlen;
<a name="l01395"></a>01395    <span class="keywordtype">char</span> notfound = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01396"></a>01396    <span class="keywordtype">char</span> *ret = &amp;notfound; <span class="comment">/* so NULL can break the loop */</span>
<a name="l01397"></a>01397 
<a name="l01398"></a>01398    <span class="keywordflow">if</span> (pos != rpos)
<a name="l01399"></a>01399       <span class="keywordflow">return</span> NULL;
<a name="l01400"></a>01400 
<a name="l01401"></a>01401    wordlen = strlen(word); 
<a name="l01402"></a>01402 
<a name="l01403"></a>01403    <span class="keywordflow">while</span> (ret == &amp;notfound &amp;&amp; (c = <a class="code" href="channel_8h.html#af287194cacb2db8ac7bb50d16a3a2d60" title="Browse channels in use Browse the channels currently in use.">ast_channel_walk_locked</a>(c))) {
<a name="l01404"></a>01404       <span class="keywordflow">if</span> (!strncasecmp(word, c-&gt;name, wordlen) &amp;&amp; ++which &gt; state)
<a name="l01405"></a>01405          ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(c-&gt;name);
<a name="l01406"></a>01406       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c);
<a name="l01407"></a>01407    }
<a name="l01408"></a>01408    <span class="keywordflow">return</span> ret == &amp;notfound ? NULL : ret;
<a name="l01409"></a>01409 }
<a name="l01410"></a>01410 
<a name="l01411"></a><a class="code" href="cli_8c.html#a37dd4151926b835c10cc956f14a47857">01411</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a37dd4151926b835c10cc956f14a47857">group_show_channels</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01412"></a>01412 {
<a name="l01413"></a>01413 <span class="preprocessor">#define FORMAT_STRING  &quot;%-25s  %-20s  %-20s\n&quot;</span>
<a name="l01414"></a>01414 <span class="preprocessor"></span>
<a name="l01415"></a>01415    <span class="keyword">struct </span><a class="code" href="structast__group__info.html" title="channel group info">ast_group_info</a> *gi = NULL;
<a name="l01416"></a>01416    <span class="keywordtype">int</span> numchans = 0;
<a name="l01417"></a>01417    regex_t regexbuf;
<a name="l01418"></a>01418    <span class="keywordtype">int</span> havepattern = 0;
<a name="l01419"></a>01419 
<a name="l01420"></a>01420    <span class="keywordflow">switch</span> (cmd) {
<a name="l01421"></a>01421    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01422"></a>01422       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;group show channels&quot;</span>;
<a name="l01423"></a>01423       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l01424"></a>01424          <span class="stringliteral">&quot;Usage: group show channels [pattern]\n&quot;</span>
<a name="l01425"></a>01425          <span class="stringliteral">&quot;       Lists all currently active channels with channel group(s) specified.\n&quot;</span>
<a name="l01426"></a>01426          <span class="stringliteral">&quot;       Optional regular expression pattern is matched to group names for each\n&quot;</span>
<a name="l01427"></a>01427          <span class="stringliteral">&quot;       channel.\n&quot;</span>;
<a name="l01428"></a>01428       <span class="keywordflow">return</span> NULL;
<a name="l01429"></a>01429    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01430"></a>01430       <span class="keywordflow">return</span> NULL;
<a name="l01431"></a>01431    }
<a name="l01432"></a>01432 
<a name="l01433"></a>01433    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 3 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 4)
<a name="l01434"></a>01434       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01435"></a>01435    
<a name="l01436"></a>01436    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4) {
<a name="l01437"></a>01437       <span class="keywordflow">if</span> (regcomp(&amp;regexbuf, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], REG_EXTENDED | REG_NOSUB))
<a name="l01438"></a>01438          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01439"></a>01439       havepattern = 1;
<a name="l01440"></a>01440    }
<a name="l01441"></a>01441 
<a name="l01442"></a>01442    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="cli_8c.html#a4610636f10e4604ba296cbf9287b0c7b">FORMAT_STRING</a>, <span class="stringliteral">&quot;Channel&quot;</span>, <span class="stringliteral">&quot;Group&quot;</span>, <span class="stringliteral">&quot;Category&quot;</span>);
<a name="l01443"></a>01443 
<a name="l01444"></a>01444    <a class="code" href="app_8h.html#afa354da7388ee1882ac981396f143bda" title="Read Lock the group count list.">ast_app_group_list_rdlock</a>();
<a name="l01445"></a>01445    
<a name="l01446"></a>01446    gi = <a class="code" href="app_8h.html#ae351dc6f23997a800e7a743d6411b8e7" title="Get the head of the group count list.">ast_app_group_list_head</a>();
<a name="l01447"></a>01447    <span class="keywordflow">while</span> (gi) {
<a name="l01448"></a>01448       <span class="keywordflow">if</span> (!havepattern || !regexec(&amp;regexbuf, gi-&gt;<a class="code" href="structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, 0, NULL, 0)) {
<a name="l01449"></a>01449          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="cli_8c.html#a4610636f10e4604ba296cbf9287b0c7b">FORMAT_STRING</a>, gi-&gt;<a class="code" href="structast__group__info.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, gi-&gt;<a class="code" href="structast__group__info.html#a443519726cbe3c4f2b2fe1d42ce2fd2f">group</a>, (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>) ? <span class="stringliteral">&quot;(default)&quot;</span> : gi-&gt;<a class="code" href="structast__group__info.html#a37188acb1b82f625d3313bc88ca82314">category</a>));
<a name="l01450"></a>01450          numchans++;
<a name="l01451"></a>01451       }
<a name="l01452"></a>01452       gi = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(gi, group_list);
<a name="l01453"></a>01453    }
<a name="l01454"></a>01454    
<a name="l01455"></a>01455    <a class="code" href="app_8h.html#aa3d01e65e04cddfa84781590b37732e8" title="Unlock the group count list.">ast_app_group_list_unlock</a>();
<a name="l01456"></a>01456    
<a name="l01457"></a>01457    <span class="keywordflow">if</span> (havepattern)
<a name="l01458"></a>01458       regfree(&amp;regexbuf);
<a name="l01459"></a>01459 
<a name="l01460"></a>01460    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d active channel%s\n&quot;</span>, numchans, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(numchans));
<a name="l01461"></a>01461    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01462"></a>01462 <span class="preprocessor">#undef FORMAT_STRING</span>
<a name="l01463"></a>01463 <span class="preprocessor"></span>}
<a name="l01464"></a>01464 
<a name="l01465"></a>01465 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a904ad4d54f223c3e46085fbe746d3891">handle_help</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l01466"></a>01466 
<a name="l01467"></a><a class="code" href="cli_8c.html#a4d8f5feeefd2ef02881efa9181b57913">01467</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="cli_8c.html#a4d8f5feeefd2ef02881efa9181b57913">cli_cli</a>[] = {
<a name="l01468"></a>01468    <span class="comment">/* Deprecated, but preferred command is now consolidated (and already has a deprecated command for it). */</span>
<a name="l01469"></a>01469    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ac1db63599c1347e2a626f63499c3c018">handle_commandcomplete</a>, <span class="stringliteral">&quot;Command complete&quot;</span>),
<a name="l01470"></a>01470    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ad09ea0d383b50baecfa8d3c828e59a0f">handle_commandnummatches</a>, <span class="stringliteral">&quot;Returns number of command matches&quot;</span>),
<a name="l01471"></a>01471    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a6b6e0b5f4ca0072eadaddf04e6334f63">handle_commandmatchesarray</a>, <span class="stringliteral">&quot;Returns command matches array&quot;</span>),
<a name="l01472"></a>01472 
<a name="l01473"></a>01473    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ade46ebd034310224ed0055553eb89af9">handle_nodebugchan_deprecated</a>, <span class="stringliteral">&quot;Disable debugging on channel(s)&quot;</span>),
<a name="l01474"></a>01474 
<a name="l01475"></a>01475    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a864ccd72b72ef6f3e8595bd56d611f5f">handle_chanlist</a>, <span class="stringliteral">&quot;Display information on channels&quot;</span>),
<a name="l01476"></a>01476 
<a name="l01477"></a>01477    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a814d1ddca930627ac11a3b2d824fc62e">handle_showcalls</a>, <span class="stringliteral">&quot;Display information on calls&quot;</span>),
<a name="l01478"></a>01478 
<a name="l01479"></a>01479    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a9507ef3d00c28f297846fd44595db1c8">handle_showchan</a>, <span class="stringliteral">&quot;Display information on a specific channel&quot;</span>),
<a name="l01480"></a>01480 
<a name="l01481"></a>01481    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ab1c36f45ca7d85999d12b028d6445662">handle_core_set_debug_channel</a>, <span class="stringliteral">&quot;Enable/disable debugging on a channel&quot;</span>),
<a name="l01482"></a>01482 
<a name="l01483"></a>01483    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a5151d42e59bf1fcba488149926269792">handle_verbose</a>, <span class="stringliteral">&quot;Set level of debug/verbose chattiness&quot;</span>),
<a name="l01484"></a>01484 
<a name="l01485"></a>01485    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a37dd4151926b835c10cc956f14a47857">group_show_channels</a>, <span class="stringliteral">&quot;Display active channels with group(s)&quot;</span>),
<a name="l01486"></a>01486 
<a name="l01487"></a>01487    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a904ad4d54f223c3e46085fbe746d3891">handle_help</a>, <span class="stringliteral">&quot;Display help list, or specific help on a command&quot;</span>),
<a name="l01488"></a>01488 
<a name="l01489"></a>01489    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a6271e5ca0474681db9b080dae8c544f4">handle_logger_mute</a>, <span class="stringliteral">&quot;Toggle logging output to a console&quot;</span>),
<a name="l01490"></a>01490 
<a name="l01491"></a>01491    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a0d2c4cd94a20114dd29790a508b83d99">handle_modlist</a>, <span class="stringliteral">&quot;List modules and info&quot;</span>),
<a name="l01492"></a>01492 
<a name="l01493"></a>01493    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ae1d61920ef9c62e876cc6d8ab809ce16">handle_load</a>, <span class="stringliteral">&quot;Load a module by name&quot;</span>),
<a name="l01494"></a>01494 
<a name="l01495"></a>01495    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a22ca8c73dfd64aee98f04d3015c46bf4">handle_reload</a>, <span class="stringliteral">&quot;Reload configuration&quot;</span>),
<a name="l01496"></a>01496 
<a name="l01497"></a>01497    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a066fdc101e74c3d7ec12645a44e48eb9">handle_unload</a>, <span class="stringliteral">&quot;Unload a module by name&quot;</span>),
<a name="l01498"></a>01498 
<a name="l01499"></a>01499    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ab1e834548243108d1f0a6ed298451f0e">handle_showuptime</a>, <span class="stringliteral">&quot;Show uptime information&quot;</span>),
<a name="l01500"></a>01500 
<a name="l01501"></a>01501    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ac430b627eac1469fcadb602741d8c247">handle_softhangup</a>, <span class="stringliteral">&quot;Request a hangup on a given channel&quot;</span>),
<a name="l01502"></a>01502 
<a name="l01503"></a>01503    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#ac09450fa9355a3e44c87c1adada60307" title="handles CLI command &amp;#39;cli reload permissions&amp;#39;">handle_cli_reload_permissions</a>, <span class="stringliteral">&quot;Reload CLI permissions config&quot;</span>),
<a name="l01504"></a>01504 
<a name="l01505"></a>01505    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a11684ce17d4f8b062422b7320eef1015" title="handles CLI command &amp;#39;cli show permissions&amp;#39;">handle_cli_show_permissions</a>, <span class="stringliteral">&quot;Show CLI permissions&quot;</span>),
<a name="l01506"></a>01506 
<a name="l01507"></a>01507    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="cli_8c.html#a3e8d2dcbe23247ed8025ec7cbc383861" title="handles CLI command &amp;#39;cli check permissions&amp;#39;">handle_cli_check_permissions</a>, <span class="stringliteral">&quot;Try a permissions config for a user&quot;</span>),
<a name="l01508"></a>01508 };
<a name="l01509"></a>01509 <span class="comment"></span>
<a name="l01510"></a>01510 <span class="comment">/*!</span>
<a name="l01511"></a>01511 <span class="comment"> * Some regexp characters in cli arguments are reserved and used as separators.</span>
<a name="l01512"></a>01512 <span class="comment"> */</span>
<a name="l01513"></a><a class="code" href="cli_8c.html#a895466d470ce2fa13f141e05c81225f6">01513</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="cli_8c.html#a895466d470ce2fa13f141e05c81225f6">cli_rsvd</a>[] = <span class="stringliteral">&quot;[]{}|*%&quot;</span>;
<a name="l01514"></a>01514 <span class="comment"></span>
<a name="l01515"></a>01515 <span class="comment">/*!</span>
<a name="l01516"></a>01516 <span class="comment"> * initialize the _full_cmd string and related parameters,</span>
<a name="l01517"></a>01517 <span class="comment"> * return 0 on success, -1 on error.</span>
<a name="l01518"></a>01518 <span class="comment"> */</span>
<a name="l01519"></a><a class="code" href="cli_8c.html#a49eaa638334191d1c0d9e901ed5e59f5">01519</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#a49eaa638334191d1c0d9e901ed5e59f5">set_full_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e)
<a name="l01520"></a>01520 {
<a name="l01521"></a>01521    <span class="keywordtype">int</span> i;
<a name="l01522"></a>01522    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[80];
<a name="l01523"></a>01523 
<a name="l01524"></a>01524    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(buf, <span class="keyword">sizeof</span>(buf), e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>);
<a name="l01525"></a>01525    e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(buf);
<a name="l01526"></a>01526    <span class="keywordflow">if</span> (!e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>) {
<a name="l01527"></a>01527       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;-- cannot allocate &lt;%s&gt;\n&quot;</span>, buf);
<a name="l01528"></a>01528       <span class="keywordflow">return</span> -1;
<a name="l01529"></a>01529    }
<a name="l01530"></a>01530    e-&gt;<a class="code" href="structast__cli__entry.html#a461d5235a36284d30ec1d9fe480a89f2">cmdlen</a> = strcspn(e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, cli_rsvd);
<a name="l01531"></a>01531    <span class="keywordflow">for</span> (i = 0; e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>[i]; i++)
<a name="l01532"></a>01532       ;
<a name="l01533"></a>01533    e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> = i;
<a name="l01534"></a>01534    <span class="keywordflow">return</span> 0;
<a name="l01535"></a>01535 }
<a name="l01536"></a>01536 <span class="comment"></span>
<a name="l01537"></a>01537 <span class="comment">/*! \brief cleanup (free) cli_perms linkedlist. */</span>
<a name="l01538"></a><a class="code" href="cli_8c.html#aa09e50353ce1962ccd90b269e3beb793">01538</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="cli_8c.html#aa09e50353ce1962ccd90b269e3beb793" title="cleanup (free) cli_perms linkedlist.">destroy_user_perms</a>(<span class="keywordtype">void</span>)
<a name="l01539"></a>01539 {
<a name="l01540"></a>01540    <span class="keyword">struct </span>cli_perm *perm;
<a name="l01541"></a>01541    <span class="keyword">struct </span>usergroup_cli_perm *user_perm;
<a name="l01542"></a>01542 
<a name="l01543"></a>01543    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;cli_perms);
<a name="l01544"></a>01544    <span class="keywordflow">while</span> ((user_perm = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;cli_perms, list))) {
<a name="l01545"></a>01545       <span class="keywordflow">while</span> ((perm = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(user_perm-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>, list))) {
<a name="l01546"></a>01546          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a>);
<a name="l01547"></a>01547          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(perm);
<a name="l01548"></a>01548       }
<a name="l01549"></a>01549       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(user_perm);
<a name="l01550"></a>01550    }
<a name="l01551"></a>01551    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;cli_perms);
<a name="l01552"></a>01552 }
<a name="l01553"></a>01553 
<a name="l01554"></a><a class="code" href="cli_8c.html#ade6dbc4196f2fc99250aaafededfb41b">01554</a> <span class="keywordtype">int</span> <a class="code" href="__private_8h.html#ade6dbc4196f2fc99250aaafededfb41b">ast_cli_perms_init</a>(<span class="keywordtype">int</span> <a class="code" href="app__amd_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l01555"></a>01555 {
<a name="l01556"></a>01556    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l01557"></a>01557    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01558"></a>01558    <span class="keywordtype">char</span> *cat = NULL;
<a name="l01559"></a>01559    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01560"></a>01560    <span class="keyword">struct </span>usergroup_cli_perm *user_group, *cp_entry;
<a name="l01561"></a>01561    <span class="keyword">struct </span>cli_perm *perm = NULL;
<a name="l01562"></a>01562    <span class="keyword">struct </span>passwd *pw;
<a name="l01563"></a>01563    <span class="keyword">struct </span><a class="code" href="structgroup.html">group</a> *gr;
<a name="l01564"></a>01564 
<a name="l01565"></a>01565    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a036ccafa2339f674a46bc269bbd48c5f">ast_mutex_trylock</a>(&amp;permsconfiglock)) {
<a name="l01566"></a>01566       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;You must wait until last &apos;cli reload permissions&apos; command finish\n&quot;</span>);
<a name="l01567"></a>01567       <span class="keywordflow">return</span> 1;
<a name="l01568"></a>01568    }
<a name="l01569"></a>01569 
<a name="l01570"></a>01570    cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<a class="code" href="cli_8c.html#ae473ef191024f9043e7388e1a0585791" title="CLI permissions config file.">perms_config</a>, <span class="stringliteral">&quot;&quot;</span> <span class="comment">/* core, can&apos;t reload */</span>, config_flags);
<a name="l01571"></a>01571    <span class="keywordflow">if</span> (!cfg) {
<a name="l01572"></a>01572       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;permsconfiglock);
<a name="l01573"></a>01573       <span class="keywordflow">return</span> 1;
<a name="l01574"></a>01574    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l01575"></a>01575       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;permsconfiglock);
<a name="l01576"></a>01576       <span class="keywordflow">return</span> 0;
<a name="l01577"></a>01577    }
<a name="l01578"></a>01578 
<a name="l01579"></a>01579    <span class="comment">/* free current structures. */</span>
<a name="l01580"></a>01580    <a class="code" href="cli_8c.html#aa09e50353ce1962ccd90b269e3beb793" title="cleanup (free) cli_perms linkedlist.">destroy_user_perms</a>();
<a name="l01581"></a>01581 
<a name="l01582"></a>01582    <span class="keywordflow">while</span> ((cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat))) {
<a name="l01583"></a>01583       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l01584"></a>01584          <span class="comment">/* General options */</span>
<a name="l01585"></a>01585          <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01586"></a>01586             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;default_perm&quot;</span>)) {
<a name="l01587"></a>01587                cli_default_perm = (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;permit&quot;</span>)) ? 1: 0;
<a name="l01588"></a>01588             }
<a name="l01589"></a>01589          }
<a name="l01590"></a>01590          <span class="keywordflow">continue</span>;
<a name="l01591"></a>01591       }
<a name="l01592"></a>01592 
<a name="l01593"></a>01593       <span class="comment">/* users or groups */</span>
<a name="l01594"></a>01594       gr = NULL, pw = NULL;
<a name="l01595"></a>01595       <span class="keywordflow">if</span> (cat[0] == <span class="charliteral">&apos;@&apos;</span>) {
<a name="l01596"></a>01596          <span class="comment">/* This is a group */</span>
<a name="l01597"></a>01597          gr = getgrnam(&amp;cat[1]);
<a name="l01598"></a>01598          <span class="keywordflow">if</span> (!gr) {
<a name="l01599"></a>01599             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown group &apos;%s&apos;\n&quot;</span>, &amp;cat[1]);
<a name="l01600"></a>01600             <span class="keywordflow">continue</span>;
<a name="l01601"></a>01601          }
<a name="l01602"></a>01602       } <span class="keywordflow">else</span> {
<a name="l01603"></a>01603          <span class="comment">/* This is a user */</span>
<a name="l01604"></a>01604          pw = getpwnam(cat);
<a name="l01605"></a>01605          <span class="keywordflow">if</span> (!pw) {
<a name="l01606"></a>01606             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown user &apos;%s&apos;\n&quot;</span>, cat);
<a name="l01607"></a>01607             <span class="keywordflow">continue</span>;
<a name="l01608"></a>01608          }
<a name="l01609"></a>01609       }
<a name="l01610"></a>01610       user_group = NULL;
<a name="l01611"></a>01611       <span class="comment">/* Check for duplicates */</span>
<a name="l01612"></a>01612       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;cli_perms);
<a name="l01613"></a>01613       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cli_perms, cp_entry, list) {
<a name="l01614"></a>01614          <span class="keywordflow">if</span> ((pw &amp;&amp; cp_entry-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a> == pw-&gt;pw_uid) || (gr &amp;&amp; cp_entry-&gt;<a class="code" href="structusergroup__cli__perm.html#a6567680a890171fbaa1a026477a858d3">gid</a> == gr-&gt;gr_gid)) {
<a name="l01615"></a>01615             <span class="comment">/* if it is duplicated, just added this new settings, to </span>
<a name="l01616"></a>01616 <span class="comment">            the current list. */</span>
<a name="l01617"></a>01617             user_group = cp_entry;
<a name="l01618"></a>01618             <span class="keywordflow">break</span>;
<a name="l01619"></a>01619          }
<a name="l01620"></a>01620       }
<a name="l01621"></a>01621       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;cli_perms);
<a name="l01622"></a>01622 
<a name="l01623"></a>01623       <span class="keywordflow">if</span> (!user_group) {
<a name="l01624"></a>01624          <span class="comment">/* alloc space for the new user config. */</span>
<a name="l01625"></a>01625          user_group = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*user_group));
<a name="l01626"></a>01626          <span class="keywordflow">if</span> (!user_group) {
<a name="l01627"></a>01627             <span class="keywordflow">continue</span>;
<a name="l01628"></a>01628          }
<a name="l01629"></a>01629          user_group-&gt;<a class="code" href="structusergroup__cli__perm.html#a60a34315f460179939054acaf3ed8163">uid</a> = (pw ? pw-&gt;pw_uid : -1);
<a name="l01630"></a>01630          user_group-&gt;<a class="code" href="structusergroup__cli__perm.html#a6567680a890171fbaa1a026477a858d3">gid</a> = (gr ? gr-&gt;gr_gid : -1);
<a name="l01631"></a>01631          user_group-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*user_group-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>));
<a name="l01632"></a>01632          <span class="keywordflow">if</span> (!user_group-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>) {
<a name="l01633"></a>01633             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(user_group);
<a name="l01634"></a>01634             <span class="keywordflow">continue</span>;
<a name="l01635"></a>01635          }
<a name="l01636"></a>01636       }
<a name="l01637"></a>01637       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01638"></a>01638          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l01639"></a>01639             <span class="comment">/* we need to check this condition cause it could break security. */</span>
<a name="l01640"></a>01640             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Empty permit/deny option in user &apos;%s&apos;\n&quot;</span>, cat);
<a name="l01641"></a>01641             <span class="keywordflow">continue</span>;
<a name="l01642"></a>01642          }
<a name="l01643"></a>01643          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;permit&quot;</span>)) {
<a name="l01644"></a>01644             perm = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*perm));
<a name="l01645"></a>01645             <span class="keywordflow">if</span> (perm) {
<a name="l01646"></a>01646                perm-&gt;<a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">permit</a> = 1;
<a name="l01647"></a>01647                perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01648"></a>01648             }
<a name="l01649"></a>01649          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;deny&quot;</span>)) {
<a name="l01650"></a>01650             perm = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*perm));
<a name="l01651"></a>01651             <span class="keywordflow">if</span> (perm) {
<a name="l01652"></a>01652                perm-&gt;<a class="code" href="structcli__perm.html#ab01e87324485f2f7b5858cab52e6726e">permit</a> = 0;
<a name="l01653"></a>01653                perm-&gt;<a class="code" href="structcli__perm.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01654"></a>01654             }
<a name="l01655"></a>01655          } <span class="keywordflow">else</span> {
<a name="l01656"></a>01656             <span class="comment">/* up to now, only &apos;permit&apos; and &apos;deny&apos; are possible values. */</span>
<a name="l01657"></a>01657             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown &apos;%s&apos; option\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l01658"></a>01658             <span class="keywordflow">continue</span>;
<a name="l01659"></a>01659          }
<a name="l01660"></a>01660          <span class="keywordflow">if</span> (perm) {
<a name="l01661"></a>01661             <span class="comment">/* Added the permission to the user&apos;s list. */</span>
<a name="l01662"></a>01662             <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(user_group-&gt;<a class="code" href="structusergroup__cli__perm.html#a367ea8bb88f1de1371cb6bbeda0451ba">perms</a>, perm, list);
<a name="l01663"></a>01663             perm = NULL;
<a name="l01664"></a>01664          }
<a name="l01665"></a>01665       }
<a name="l01666"></a>01666       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;cli_perms);
<a name="l01667"></a>01667       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;cli_perms, user_group, list);
<a name="l01668"></a>01668       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;cli_perms);
<a name="l01669"></a>01669    }
<a name="l01670"></a>01670 
<a name="l01671"></a>01671    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01672"></a>01672    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;permsconfiglock);
<a name="l01673"></a>01673    <span class="keywordflow">return</span> 0;
<a name="l01674"></a>01674 }
<a name="l01675"></a>01675 <span class="comment"></span>
<a name="l01676"></a>01676 <span class="comment">/*! \brief initialize the _full_cmd string in * each of the builtins. */</span>
<a name="l01677"></a><a class="code" href="cli_8c.html#aa0cfcd5a898ed77170a7f2c09581d91a">01677</a> <span class="keywordtype">void</span> <a class="code" href="__private_8h.html#aa0cfcd5a898ed77170a7f2c09581d91a" title="initialize the _full_cmd string in * each of the builtins.">ast_builtins_init</a>(<span class="keywordtype">void</span>)
<a name="l01678"></a>01678 {
<a name="l01679"></a>01679    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_cli, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_cli));
<a name="l01680"></a>01680 }
<a name="l01681"></a>01681 <span class="comment"></span>
<a name="l01682"></a>01682 <span class="comment">/*!</span>
<a name="l01683"></a>01683 <span class="comment"> * match a word in the CLI entry.</span>
<a name="l01684"></a>01684 <span class="comment"> * returns -1 on mismatch, 0 on match of an optional word,</span>
<a name="l01685"></a>01685 <span class="comment"> * 1 on match of a full word.</span>
<a name="l01686"></a>01686 <span class="comment"> *</span>
<a name="l01687"></a>01687 <span class="comment"> * The pattern can be</span>
<a name="l01688"></a>01688 <span class="comment"> *   any_word           match for equal</span>
<a name="l01689"></a>01689 <span class="comment"> *   [foo|bar|baz]      optionally, one of these words</span>
<a name="l01690"></a>01690 <span class="comment"> *   {foo|bar|baz}      exactly, one of these words</span>
<a name="l01691"></a>01691 <span class="comment"> *   %                  any word</span>
<a name="l01692"></a>01692 <span class="comment"> */</span>
<a name="l01693"></a><a class="code" href="cli_8c.html#a7e2ed1ce1c57688bd381362ae8918d23">01693</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#a7e2ed1ce1c57688bd381362ae8918d23">word_match</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keyword">const</span> <span class="keywordtype">char</span> *cli_word)
<a name="l01694"></a>01694 {
<a name="l01695"></a>01695    <span class="keywordtype">int</span> l;
<a name="l01696"></a>01696    <span class="keywordtype">char</span> *pos;
<a name="l01697"></a>01697 
<a name="l01698"></a>01698    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cmd) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cli_word))
<a name="l01699"></a>01699       <span class="keywordflow">return</span> -1;
<a name="l01700"></a>01700    <span class="keywordflow">if</span> (!strchr(cli_rsvd, cli_word[0])) <span class="comment">/* normal match */</span>
<a name="l01701"></a>01701       <span class="keywordflow">return</span> (strcasecmp(cmd, cli_word) == 0) ? 1 : -1;
<a name="l01702"></a>01702    <span class="comment">/* regexp match, takes [foo|bar] or {foo|bar} */</span>
<a name="l01703"></a>01703    l = strlen(cmd);
<a name="l01704"></a>01704    <span class="comment">/* wildcard match - will extend in the future */</span>
<a name="l01705"></a>01705    <span class="keywordflow">if</span> (l &gt; 0 &amp;&amp; cli_word[0] == <span class="charliteral">&apos;%&apos;</span>) {
<a name="l01706"></a>01706       <span class="keywordflow">return</span> 1;   <span class="comment">/* wildcard */</span>
<a name="l01707"></a>01707    }
<a name="l01708"></a>01708    pos = <a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(cli_word, cmd);
<a name="l01709"></a>01709    <span class="keywordflow">if</span> (pos == NULL) <span class="comment">/* not found, say ok if optional */</span>
<a name="l01710"></a>01710       <span class="keywordflow">return</span> cli_word[0] == <span class="charliteral">&apos;[&apos;</span> ? 0 : -1;
<a name="l01711"></a>01711    <span class="keywordflow">if</span> (pos == cli_word) <span class="comment">/* no valid match at the beginning */</span>
<a name="l01712"></a>01712       <span class="keywordflow">return</span> -1;
<a name="l01713"></a>01713    <span class="keywordflow">if</span> (strchr(cli_rsvd, pos[-1]) &amp;&amp; strchr(cli_rsvd, pos[l]))
<a name="l01714"></a>01714       <span class="keywordflow">return</span> 1;   <span class="comment">/* valid match */</span>
<a name="l01715"></a>01715    <span class="keywordflow">return</span> -1;  <span class="comment">/* not found */</span>
<a name="l01716"></a>01716 }
<a name="l01717"></a>01717 <span class="comment"></span>
<a name="l01718"></a>01718 <span class="comment">/*! \brief if word is a valid prefix for token, returns the pos-th</span>
<a name="l01719"></a>01719 <span class="comment"> * match as a malloced string, or NULL otherwise.</span>
<a name="l01720"></a>01720 <span class="comment"> * Always tell in *actual how many matches we got.</span>
<a name="l01721"></a>01721 <span class="comment"> */</span>
<a name="l01722"></a><a class="code" href="cli_8c.html#a5e4bb02679737eab93085669c640b778">01722</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a5e4bb02679737eab93085669c640b778" title="if word is a valid prefix for token, returns the pos-th match as a malloced string...">is_prefix</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *token,
<a name="l01723"></a>01723    <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> *actual)
<a name="l01724"></a>01724 {
<a name="l01725"></a>01725    <span class="keywordtype">int</span> lw;
<a name="l01726"></a>01726    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, *t1;
<a name="l01727"></a>01727 
<a name="l01728"></a>01728    *actual = 0;
<a name="l01729"></a>01729    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(token))
<a name="l01730"></a>01730       <span class="keywordflow">return</span> NULL;
<a name="l01731"></a>01731    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(word))
<a name="l01732"></a>01732       word = <span class="stringliteral">&quot;&quot;</span>;  <span class="comment">/* dummy */</span>
<a name="l01733"></a>01733    lw = strlen(word);
<a name="l01734"></a>01734    <span class="keywordflow">if</span> (strcspn(word, cli_rsvd) != lw)
<a name="l01735"></a>01735       <span class="keywordflow">return</span> NULL;   <span class="comment">/* no match if word has reserved chars */</span>
<a name="l01736"></a>01736    <span class="keywordflow">if</span> (strchr(cli_rsvd, token[0]) == NULL) { <span class="comment">/* regular match */</span>
<a name="l01737"></a>01737       <span class="keywordflow">if</span> (strncasecmp(token, word, lw))   <span class="comment">/* no match */</span>
<a name="l01738"></a>01738          <span class="keywordflow">return</span> NULL;
<a name="l01739"></a>01739       *actual = 1;
<a name="l01740"></a>01740       <span class="keywordflow">return</span> (pos != 0) ? NULL : <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(token);
<a name="l01741"></a>01741    }
<a name="l01742"></a>01742    <span class="comment">/* now handle regexp match */</span>
<a name="l01743"></a>01743 
<a name="l01744"></a>01744    <span class="comment">/* Wildcard always matches, so we never do is_prefix on them */</span>
<a name="l01745"></a>01745 
<a name="l01746"></a>01746    t1 = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(token + 1);  <span class="comment">/* copy, skipping first char */</span>
<a name="l01747"></a>01747    <span class="keywordflow">while</span> (pos &gt;= 0 &amp;&amp; (s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;t1, cli_rsvd)) &amp;&amp; *s) {
<a name="l01748"></a>01748       <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;%&apos;</span>) <span class="comment">/* wildcard */</span>
<a name="l01749"></a>01749          <span class="keywordflow">continue</span>;
<a name="l01750"></a>01750       <span class="keywordflow">if</span> (strncasecmp(s, word, lw)) <span class="comment">/* no match */</span>
<a name="l01751"></a>01751          <span class="keywordflow">continue</span>;
<a name="l01752"></a>01752       (*actual)++;
<a name="l01753"></a>01753       <span class="keywordflow">if</span> (pos-- == 0)
<a name="l01754"></a>01754          <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(s);
<a name="l01755"></a>01755    }
<a name="l01756"></a>01756    <span class="keywordflow">return</span> NULL;
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 <span class="comment"></span>
<a name="l01759"></a>01759 <span class="comment">/*!</span>
<a name="l01760"></a>01760 <span class="comment"> * \internal</span>
<a name="l01761"></a>01761 <span class="comment"> * \brief locate a cli command in the &apos;helpers&apos; list (which must be locked).</span>
<a name="l01762"></a>01762 <span class="comment"> *     The search compares word by word taking care of regexps in e-&gt;cmda</span>
<a name="l01763"></a>01763 <span class="comment"> *     This function will return NULL when nothing is matched, or the ast_cli_entry that matched.</span>
<a name="l01764"></a>01764 <span class="comment"> * \param cmds</span>
<a name="l01765"></a>01765 <span class="comment"> * \param match_type has 3 possible values:</span>
<a name="l01766"></a>01766 <span class="comment"> *      0       returns if the search key is equal or longer than the entry.</span>
<a name="l01767"></a>01767 <span class="comment"> *                note that trailing optional arguments are skipped.</span>
<a name="l01768"></a>01768 <span class="comment"> *      -1      true if the mismatch is on the last word XXX not true!</span>
<a name="l01769"></a>01769 <span class="comment"> *      1       true only on complete, exact match.</span>
<a name="l01770"></a>01770 <span class="comment"> *</span>
<a name="l01771"></a>01771 <span class="comment"> */</span>
<a name="l01772"></a><a class="code" href="cli_8c.html#a7ae95494897a62695433cb697e7fc53b">01772</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *<a class="code" href="cli_8c.html#a7ae95494897a62695433cb697e7fc53b">find_cli</a>(<span class="keywordtype">char</span> *<span class="keyword">const</span> cmds[], <span class="keywordtype">int</span> match_type)
<a name="l01773"></a>01773 {
<a name="l01774"></a>01774    <span class="keywordtype">int</span> matchlen = -1;   <span class="comment">/* length of longest match so far */</span>
<a name="l01775"></a>01775    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *cand = NULL, *e=NULL;
<a name="l01776"></a>01776 
<a name="l01777"></a>01777    <span class="keywordflow">while</span> ( (e = <a class="code" href="cli_8c.html#adac48ec5ae21bd48d7f3dac6c44b2868">cli_next</a>(e)) ) {
<a name="l01778"></a>01778       <span class="comment">/* word-by word regexp comparison */</span>
<a name="l01779"></a>01779       <span class="keywordtype">char</span> * <span class="keyword">const</span> *src = cmds;
<a name="l01780"></a>01780       <span class="keywordtype">char</span> * <span class="keyword">const</span> *dst = e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>;
<a name="l01781"></a>01781       <span class="keywordtype">int</span> n = 0;
<a name="l01782"></a>01782       <span class="keywordflow">for</span> (;; dst++, src += n) {
<a name="l01783"></a>01783          n = <a class="code" href="cli_8c.html#a7e2ed1ce1c57688bd381362ae8918d23">word_match</a>(*src, *dst);
<a name="l01784"></a>01784          <span class="keywordflow">if</span> (n &lt; 0)
<a name="l01785"></a>01785             <span class="keywordflow">break</span>;
<a name="l01786"></a>01786       }
<a name="l01787"></a>01787       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(*dst) || ((*dst)[0] == <span class="charliteral">&apos;[&apos;</span> &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(dst[1]))) {
<a name="l01788"></a>01788          <span class="comment">/* no more words in &apos;e&apos; */</span>
<a name="l01789"></a>01789          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(*src)) <span class="comment">/* exact match, cannot do better */</span>
<a name="l01790"></a>01790             <span class="keywordflow">break</span>;
<a name="l01791"></a>01791          <span class="comment">/* Here, cmds has more words than the entry &apos;e&apos; */</span>
<a name="l01792"></a>01792          <span class="keywordflow">if</span> (match_type != 0) <span class="comment">/* but we look for almost exact match... */</span>
<a name="l01793"></a>01793             <span class="keywordflow">continue</span>;   <span class="comment">/* so we skip this one. */</span>
<a name="l01794"></a>01794          <span class="comment">/* otherwise we like it (case 0) */</span>
<a name="l01795"></a>01795       } <span class="keywordflow">else</span> { <span class="comment">/* still words in &apos;e&apos; */</span>
<a name="l01796"></a>01796          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(*src))
<a name="l01797"></a>01797             <span class="keywordflow">continue</span>; <span class="comment">/* cmds is shorter than &apos;e&apos;, not good */</span>
<a name="l01798"></a>01798          <span class="comment">/* Here we have leftover words in cmds and &apos;e&apos;,</span>
<a name="l01799"></a>01799 <span class="comment">          * but there is a mismatch. We only accept this one if match_type == -1</span>
<a name="l01800"></a>01800 <span class="comment">          * and this is the last word for both.</span>
<a name="l01801"></a>01801 <span class="comment">          */</span>
<a name="l01802"></a>01802          <span class="keywordflow">if</span> (match_type != -1 || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(src[1]) ||
<a name="l01803"></a>01803              !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(dst[1])) <span class="comment">/* not the one we look for */</span>
<a name="l01804"></a>01804             <span class="keywordflow">continue</span>;
<a name="l01805"></a>01805          <span class="comment">/* good, we are in case match_type == -1 and mismatch on last word */</span>
<a name="l01806"></a>01806       }
<a name="l01807"></a>01807       <span class="keywordflow">if</span> (src - cmds &gt; matchlen) {  <span class="comment">/* remember the candidate */</span>
<a name="l01808"></a>01808          matchlen = src - cmds;
<a name="l01809"></a>01809          cand = e;
<a name="l01810"></a>01810       }
<a name="l01811"></a>01811    }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813    <span class="keywordflow">return</span> e ? e : cand;
<a name="l01814"></a>01814 }
<a name="l01815"></a>01815 
<a name="l01816"></a><a class="code" href="cli_8c.html#a8a1ff15e1264d5177e9975142a0e9be8">01816</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a8a1ff15e1264d5177e9975142a0e9be8">find_best</a>(<span class="keywordtype">char</span> *argv[])
<a name="l01817"></a>01817 {
<a name="l01818"></a>01818    <span class="keyword">static</span> <span class="keywordtype">char</span> cmdline[80];
<a name="l01819"></a>01819    <span class="keywordtype">int</span> x;
<a name="l01820"></a>01820    <span class="comment">/* See how close we get, then print the candidate */</span>
<a name="l01821"></a>01821    <span class="keywordtype">char</span> *myargv[<a class="code" href="cli_8h.html#ae88634c402fdd8b46fd5d686dad8bfb9">AST_MAX_CMD_LEN</a>];
<a name="l01822"></a>01822    <span class="keywordflow">for</span> (x=0;x&lt;<a class="code" href="cli_8h.html#ae88634c402fdd8b46fd5d686dad8bfb9">AST_MAX_CMD_LEN</a>;x++)
<a name="l01823"></a>01823       myargv[x]=NULL;
<a name="l01824"></a>01824    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01825"></a>01825    <span class="keywordflow">for</span> (x=0;argv[x];x++) {
<a name="l01826"></a>01826       myargv[x] = argv[x];
<a name="l01827"></a>01827       <span class="keywordflow">if</span> (!<a class="code" href="cli_8c.html#a7ae95494897a62695433cb697e7fc53b">find_cli</a>(myargv, -1))
<a name="l01828"></a>01828          <span class="keywordflow">break</span>;
<a name="l01829"></a>01829    }
<a name="l01830"></a>01830    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01831"></a>01831    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(cmdline, <span class="keyword">sizeof</span>(cmdline), myargv);
<a name="l01832"></a>01832    <span class="keywordflow">return</span> cmdline;
<a name="l01833"></a>01833 }
<a name="l01834"></a>01834 
<a name="l01835"></a><a class="code" href="cli_8c.html#af4b26605236b79438f56ddf82c7bfe4e">01835</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#af4b26605236b79438f56ddf82c7bfe4e">__ast_cli_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *ed)
<a name="l01836"></a>01836 {
<a name="l01837"></a>01837    <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__cli__entry.html#a679cabe3b846f2e363f43d8e57433834">inuse</a>) {
<a name="l01838"></a>01838       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t remove command that is in use\n&quot;</span>);
<a name="l01839"></a>01839    } <span class="keywordflow">else</span> {
<a name="l01840"></a>01840       <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01841"></a>01841       <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>, e, list);
<a name="l01842"></a>01842       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01843"></a>01843       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>);
<a name="l01844"></a>01844       e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a> = NULL;
<a name="l01845"></a>01845       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__cli__entry.html#af0e07e1d04656663ca8b452904abe99b">handler</a>) {
<a name="l01846"></a>01846          <span class="comment">/* this is a new-style entry. Reset fields and free memory. */</span>
<a name="l01847"></a>01847          <span class="keywordtype">char</span> *<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a> = (<span class="keywordtype">char</span> *) e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>;
<a name="l01848"></a>01848          memset(cmda, <span class="charliteral">&apos;\0&apos;</span>, <span class="keyword">sizeof</span>(e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>));
<a name="l01849"></a>01849          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a>);
<a name="l01850"></a>01850          e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = NULL;
<a name="l01851"></a>01851          e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = NULL;
<a name="l01852"></a>01852       }
<a name="l01853"></a>01853    }
<a name="l01854"></a>01854    <span class="keywordflow">return</span> 0;
<a name="l01855"></a>01855 }
<a name="l01856"></a>01856 
<a name="l01857"></a><a class="code" href="cli_8c.html#ad74d8c6eeaf21a198049ae7b9f6032f8">01857</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#ad74d8c6eeaf21a198049ae7b9f6032f8">__ast_cli_register</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *ed)
<a name="l01858"></a>01858 {
<a name="l01859"></a>01859    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *cur;
<a name="l01860"></a>01860    <span class="keywordtype">int</span> i, lf, ret = -1;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862    <span class="keyword">struct </span><a class="code" href="structast__cli__args.html">ast_cli_args</a> a;  <span class="comment">/* fake argument */</span>
<a name="l01863"></a>01863    <span class="keywordtype">char</span> **dst = (<span class="keywordtype">char</span> **)e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>;   <span class="comment">/* need to cast as the entry is readonly */</span>
<a name="l01864"></a>01864    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01865"></a>01865 
<a name="l01866"></a>01866    memset(&amp;a, <span class="charliteral">&apos;\0&apos;</span>, <span class="keyword">sizeof</span>(a));
<a name="l01867"></a>01867    e-&gt;<a class="code" href="structast__cli__entry.html#af0e07e1d04656663ca8b452904abe99b">handler</a>(e, <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>, &amp;a);
<a name="l01868"></a>01868    <span class="comment">/* XXX check that usage and command are filled up */</span>
<a name="l01869"></a>01869    <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a>);
<a name="l01870"></a>01870    <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>);
<a name="l01871"></a>01871    <span class="keywordflow">for</span> (i=0; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>) &amp;&amp; i &lt; <a class="code" href="cli_8h.html#ae88634c402fdd8b46fd5d686dad8bfb9">AST_MAX_CMD_LEN</a>-1; i++) {
<a name="l01872"></a>01872       *dst++ = <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>; <span class="comment">/* store string */</span>
<a name="l01873"></a>01873       <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="strings_8h.html#a7d452227c6dc0b921257b1dd01853fb8" title="Gets a pointer to first whitespace character in a string.">ast_skip_nonblanks</a>(<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>);
<a name="l01874"></a>01874       <span class="keywordflow">if</span> (*<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> == <span class="charliteral">&apos;\0&apos;</span>)   <span class="comment">/* we are done */</span>
<a name="l01875"></a>01875          <span class="keywordflow">break</span>;
<a name="l01876"></a>01876       *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01877"></a>01877       <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>);
<a name="l01878"></a>01878    }
<a name="l01879"></a>01879    *dst++ = NULL;
<a name="l01880"></a>01880    
<a name="l01881"></a>01881    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01882"></a>01882    
<a name="l01883"></a>01883    <span class="keywordflow">if</span> (<a class="code" href="cli_8c.html#a7ae95494897a62695433cb697e7fc53b">find_cli</a>(e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>, 1)) {
<a name="l01884"></a>01884       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Command &apos;%s&apos; already registered (or something close enough)\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a>));
<a name="l01885"></a>01885       <span class="keywordflow">goto</span> done;
<a name="l01886"></a>01886    }
<a name="l01887"></a>01887    <span class="keywordflow">if</span> (<a class="code" href="cli_8c.html#a49eaa638334191d1c0d9e901ed5e59f5">set_full_cmd</a>(e))
<a name="l01888"></a>01888       <span class="keywordflow">goto</span> done;
<a name="l01889"></a>01889 
<a name="l01890"></a>01890    lf = e-&gt;<a class="code" href="structast__cli__entry.html#a461d5235a36284d30ec1d9fe480a89f2">cmdlen</a>;
<a name="l01891"></a>01891    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>, cur, list) {
<a name="l01892"></a>01892       <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = cur-&gt;<a class="code" href="structast__cli__entry.html#a461d5235a36284d30ec1d9fe480a89f2">cmdlen</a>;
<a name="l01893"></a>01893       <span class="keywordflow">if</span> (lf &lt; len)
<a name="l01894"></a>01894          len = lf;
<a name="l01895"></a>01895       <span class="keywordflow">if</span> (strncasecmp(e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, cur-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, len) &lt; 0) {
<a name="l01896"></a>01896          <a class="code" href="linkedlists_8h.html#acf8253a64f9a4e2170454f4bf0559e33">AST_RWLIST_INSERT_BEFORE_CURRENT</a>(e, list); 
<a name="l01897"></a>01897          <span class="keywordflow">break</span>;
<a name="l01898"></a>01898       }
<a name="l01899"></a>01899    }
<a name="l01900"></a>01900    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l01901"></a>01901 
<a name="l01902"></a>01902    <span class="keywordflow">if</span> (!cur)
<a name="l01903"></a>01903       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>, e, list); 
<a name="l01904"></a>01904    ret = 0; <span class="comment">/* success */</span>
<a name="l01905"></a>01905 
<a name="l01906"></a>01906 done:
<a name="l01907"></a>01907    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01908"></a>01908 
<a name="l01909"></a>01909    <span class="keywordflow">return</span> ret;
<a name="l01910"></a>01910 }
<a name="l01911"></a>01911 
<a name="l01912"></a>01912 <span class="comment">/* wrapper function, so we can unregister deprecated commands recursively */</span>
<a name="l01913"></a><a class="code" href="cli_8c.html#a3189e6720486808603d13f5d2b58daf4">01913</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#a3189e6720486808603d13f5d2b58daf4" title="Unregisters a command or an array of commands.">ast_cli_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e)
<a name="l01914"></a>01914 {
<a name="l01915"></a>01915    <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#af4b26605236b79438f56ddf82c7bfe4e">__ast_cli_unregister</a>(e, NULL);
<a name="l01916"></a>01916 }
<a name="l01917"></a>01917 
<a name="l01918"></a>01918 <span class="comment">/* wrapper function, so we can register deprecated commands recursively */</span>
<a name="l01919"></a><a class="code" href="cli_8c.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc">01919</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc" title="Registers a command or an array of commands.">ast_cli_register</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e)
<a name="l01920"></a>01920 {
<a name="l01921"></a>01921    <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#ad74d8c6eeaf21a198049ae7b9f6032f8">__ast_cli_register</a>(e, NULL);
<a name="l01922"></a>01922 }
<a name="l01923"></a>01923 
<a name="l01924"></a>01924 <span class="comment">/*</span>
<a name="l01925"></a>01925 <span class="comment"> * register/unregister an array of entries.</span>
<a name="l01926"></a>01926 <span class="comment"> */</span>
<a name="l01927"></a><a class="code" href="cli_8c.html#aadeef34f3106bb78aeb3414032ad7fb7">01927</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l01928"></a>01928 {
<a name="l01929"></a>01929    <span class="keywordtype">int</span> i, res = 0;
<a name="l01930"></a>01930 
<a name="l01931"></a>01931    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
<a name="l01932"></a>01932       res |= <a class="code" href="cli_8h.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc" title="Registers a command or an array of commands.">ast_cli_register</a>(e + i);
<a name="l01933"></a>01933 
<a name="l01934"></a>01934    <span class="keywordflow">return</span> res;
<a name="l01935"></a>01935 }
<a name="l01936"></a>01936 
<a name="l01937"></a><a class="code" href="cli_8c.html#a56b6b59ee2eaa994597a5b0f4e9f9d09">01937</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l01938"></a>01938 {
<a name="l01939"></a>01939    <span class="keywordtype">int</span> i, res = 0;
<a name="l01940"></a>01940 
<a name="l01941"></a>01941    <span class="keywordflow">for</span> (i = 0; i &lt; len; i++)
<a name="l01942"></a>01942       res |= <a class="code" href="cli_8h.html#a3189e6720486808603d13f5d2b58daf4" title="Unregisters a command or an array of commands.">ast_cli_unregister</a>(e + i);
<a name="l01943"></a>01943 
<a name="l01944"></a>01944    <span class="keywordflow">return</span> res;
<a name="l01945"></a>01945 }
<a name="l01946"></a>01946 
<a name="l01947"></a>01947 <span class="comment"></span>
<a name="l01948"></a>01948 <span class="comment">/*! \brief helper for final part of handle_help</span>
<a name="l01949"></a>01949 <span class="comment"> *  if locked = 1, assume the list is already locked</span>
<a name="l01950"></a>01950 <span class="comment"> */</span>
<a name="l01951"></a><a class="code" href="cli_8c.html#a3b12e002bbf802ab6de30c1609838abd">01951</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a3b12e002bbf802ab6de30c1609838abd" title="helper for final part of handle_help if locked = 1, assume the list is already locked...">help1</a>(<span class="keywordtype">int</span> <a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>[], <span class="keywordtype">int</span> locked)
<a name="l01952"></a>01952 {
<a name="l01953"></a>01953    <span class="keywordtype">char</span> matchstr[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01954"></a>01954    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e = NULL;
<a name="l01955"></a>01955    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = 0;
<a name="l01956"></a>01956    <span class="keywordtype">int</span> found = 0;
<a name="l01957"></a>01957 
<a name="l01958"></a>01958    <span class="keywordflow">if</span> (match) {
<a name="l01959"></a>01959       <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(matchstr, <span class="keyword">sizeof</span>(matchstr), match);
<a name="l01960"></a>01960       len = strlen(matchstr);
<a name="l01961"></a>01961    }
<a name="l01962"></a>01962    <span class="keywordflow">if</span> (!locked)
<a name="l01963"></a>01963       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01964"></a>01964    <span class="keywordflow">while</span> ( (e = <a class="code" href="cli_8c.html#adac48ec5ae21bd48d7f3dac6c44b2868">cli_next</a>(e)) ) {
<a name="l01965"></a>01965       <span class="comment">/* Hide commands that start with &apos;_&apos; */</span>
<a name="l01966"></a>01966       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>[0] == <span class="charliteral">&apos;_&apos;</span>)
<a name="l01967"></a>01967          <span class="keywordflow">continue</span>;
<a name="l01968"></a>01968       <span class="keywordflow">if</span> (match &amp;&amp; strncasecmp(matchstr, e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, len))
<a name="l01969"></a>01969          <span class="keywordflow">continue</span>;
<a name="l01970"></a>01970       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%30.30s %s\n&quot;</span>, e-&gt;<a class="code" href="structast__cli__entry.html#ac15e0df3344959107453d9ba01503746">_full_cmd</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(e-&gt;<a class="code" href="structast__cli__entry.html#a01f3e852fed0577d6c8f059530d55d50">summary</a>, <span class="stringliteral">&quot;&lt;no description available&gt;&quot;</span>));
<a name="l01971"></a>01971       found++;
<a name="l01972"></a>01972    }
<a name="l01973"></a>01973    <span class="keywordflow">if</span> (!locked)
<a name="l01974"></a>01974       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l01975"></a>01975    <span class="keywordflow">if</span> (!found &amp;&amp; matchstr[0])
<a name="l01976"></a>01976       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;No such command &apos;%s&apos;.\n&quot;</span>, matchstr);
<a name="l01977"></a>01977    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 
<a name="l01980"></a><a class="code" href="cli_8c.html#a904ad4d54f223c3e46085fbe746d3891">01980</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#a904ad4d54f223c3e46085fbe746d3891">handle_help</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982    <span class="keywordtype">char</span> fullcmd[80];
<a name="l01983"></a>01983    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *my_e;
<a name="l01984"></a>01984    <span class="keywordtype">char</span> *res = <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01985"></a>01985 
<a name="l01986"></a>01986    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l01987"></a>01987       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;core show help&quot;</span>;
<a name="l01988"></a>01988       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01989"></a>01989          <span class="stringliteral">&quot;Usage: core show help [topic]\n&quot;</span>
<a name="l01990"></a>01990          <span class="stringliteral">&quot;       When called with a topic as an argument, displays usage\n&quot;</span>
<a name="l01991"></a>01991          <span class="stringliteral">&quot;       information on the given command. If called without a\n&quot;</span>
<a name="l01992"></a>01992          <span class="stringliteral">&quot;       topic, it provides a list of commands.\n&quot;</span>;
<a name="l01993"></a>01993       <span class="keywordflow">return</span> NULL;
<a name="l01994"></a>01994 
<a name="l01995"></a>01995    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>) {
<a name="l01996"></a>01996       <span class="comment">/* skip first 14 or 15 chars, &quot;core show help &quot; */</span>
<a name="l01997"></a>01997       <span class="keywordtype">int</span> l = strlen(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>);
<a name="l01998"></a>01998 
<a name="l01999"></a>01999       <span class="keywordflow">if</span> (l &gt; 15) {
<a name="l02000"></a>02000          l = 15;
<a name="l02001"></a>02001       }
<a name="l02002"></a>02002       <span class="comment">/* XXX watch out, should stop to the non-generator parts */</span>
<a name="l02003"></a>02003       <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#ad05311723605fd9bf9bcf9ebe05323dc">__ast_cli_generator</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a> + l, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 0);
<a name="l02004"></a>02004    }
<a name="l02005"></a>02005    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {
<a name="l02006"></a>02006       <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#a3b12e002bbf802ab6de30c1609838abd" title="helper for final part of handle_help if locked = 1, assume the list is already locked...">help1</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, NULL, 0);
<a name="l02007"></a>02007    }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02010"></a>02010    my_e = <a class="code" href="cli_8c.html#a7ae95494897a62695433cb697e7fc53b">find_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + 3, 1); <span class="comment">/* try exact match first */</span>
<a name="l02011"></a>02011    <span class="keywordflow">if</span> (!my_e) {
<a name="l02012"></a>02012       res = <a class="code" href="cli_8c.html#a3b12e002bbf802ab6de30c1609838abd" title="helper for final part of handle_help if locked = 1, assume the list is already locked...">help1</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + 3, 1 <span class="comment">/* locked */</span>);
<a name="l02013"></a>02013       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02014"></a>02014       <span class="keywordflow">return</span> res;
<a name="l02015"></a>02015    }
<a name="l02016"></a>02016    <span class="keywordflow">if</span> (my_e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a>)
<a name="l02017"></a>02017       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s&quot;</span>, my_e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a>);
<a name="l02018"></a>02018    <span class="keywordflow">else</span> {
<a name="l02019"></a>02019       <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(fullcmd, <span class="keyword">sizeof</span>(fullcmd), a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + 3);
<a name="l02020"></a>02020       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No help text available for &apos;%s&apos;.\n&quot;</span>, fullcmd);
<a name="l02021"></a>02021    }
<a name="l02022"></a>02022    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02023"></a>02023    <span class="keywordflow">return</span> res;
<a name="l02024"></a>02024 }
<a name="l02025"></a>02025 
<a name="l02026"></a><a class="code" href="cli_8c.html#ad1176051c0fb523f0e068ff4737f54ce">02026</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ad1176051c0fb523f0e068ff4737f54ce">parse_args</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> *argc, <span class="keywordtype">char</span> *argv[], <span class="keywordtype">int</span> max, <span class="keywordtype">int</span> *trailingwhitespace)
<a name="l02027"></a>02027 {
<a name="l02028"></a>02028    <span class="keywordtype">char</span> *duplicate, *cur;
<a name="l02029"></a>02029    <span class="keywordtype">int</span> x = 0;
<a name="l02030"></a>02030    <span class="keywordtype">int</span> quoted = 0;
<a name="l02031"></a>02031    <span class="keywordtype">int</span> escaped = 0;
<a name="l02032"></a>02032    <span class="keywordtype">int</span> whitespace = 1;
<a name="l02033"></a>02033    <span class="keywordtype">int</span> <a class="code" href="chan__unistim_8c.html#abc0ce15d00b4bfb69266c5fd016dc88c">dummy</a> = 0;
<a name="l02034"></a>02034 
<a name="l02035"></a>02035    <span class="keywordflow">if</span> (trailingwhitespace == NULL)
<a name="l02036"></a>02036       trailingwhitespace = &amp;dummy;
<a name="l02037"></a>02037    *trailingwhitespace = 0;
<a name="l02038"></a>02038    <span class="keywordflow">if</span> (s == NULL) <span class="comment">/* invalid, though! */</span>
<a name="l02039"></a>02039       <span class="keywordflow">return</span> NULL;
<a name="l02040"></a>02040    <span class="comment">/* make a copy to store the parsed string */</span>
<a name="l02041"></a>02041    <span class="keywordflow">if</span> (!(duplicate = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(s)))
<a name="l02042"></a>02042       <span class="keywordflow">return</span> NULL;
<a name="l02043"></a>02043 
<a name="l02044"></a>02044    cur = duplicate;
<a name="l02045"></a>02045    <span class="comment">/* scan the original string copying into cur when needed */</span>
<a name="l02046"></a>02046    <span class="keywordflow">for</span> (; *s ; s++) {
<a name="l02047"></a>02047       <span class="keywordflow">if</span> (x &gt;= max - 1) {
<a name="l02048"></a>02048          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Too many arguments, truncating at %s\n&quot;</span>, s);
<a name="l02049"></a>02049          <span class="keywordflow">break</span>;
<a name="l02050"></a>02050       }
<a name="l02051"></a>02051       <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;&quot;&apos;</span> &amp;&amp; !escaped) {
<a name="l02052"></a>02052          quoted = !quoted;
<a name="l02053"></a>02053          <span class="keywordflow">if</span> (quoted &amp;&amp; whitespace) {
<a name="l02054"></a>02054             <span class="comment">/* start a quoted string from previous whitespace: new argument */</span>
<a name="l02055"></a>02055             argv[x++] = cur;
<a name="l02056"></a>02056             whitespace = 0;
<a name="l02057"></a>02057          }
<a name="l02058"></a>02058       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((*s == <span class="charliteral">&apos; &apos;</span> || *s == <span class="charliteral">&apos;\t&apos;</span>) &amp;&amp; !(quoted || escaped)) {
<a name="l02059"></a>02059          <span class="comment">/* If we are not already in whitespace, and not in a quoted string or</span>
<a name="l02060"></a>02060 <span class="comment">            processing an escape sequence, and just entered whitespace, then</span>
<a name="l02061"></a>02061 <span class="comment">            finalize the previous argument and remember that we are in whitespace</span>
<a name="l02062"></a>02062 <span class="comment">         */</span>
<a name="l02063"></a>02063          <span class="keywordflow">if</span> (!whitespace) {
<a name="l02064"></a>02064             *cur++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02065"></a>02065             whitespace = 1;
<a name="l02066"></a>02066          }
<a name="l02067"></a>02067       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*s == <span class="charliteral">&apos;\\&apos;</span> &amp;&amp; !escaped) {
<a name="l02068"></a>02068          escaped = 1;
<a name="l02069"></a>02069       } <span class="keywordflow">else</span> {
<a name="l02070"></a>02070          <span class="keywordflow">if</span> (whitespace) {
<a name="l02071"></a>02071             <span class="comment">/* we leave whitespace, and are not quoted. So it&apos;s a new argument */</span>
<a name="l02072"></a>02072             argv[x++] = cur;
<a name="l02073"></a>02073             whitespace = 0;
<a name="l02074"></a>02074          }
<a name="l02075"></a>02075          *cur++ = *s;
<a name="l02076"></a>02076          escaped = 0;
<a name="l02077"></a>02077       }
<a name="l02078"></a>02078    }
<a name="l02079"></a>02079    <span class="comment">/* Null terminate */</span>
<a name="l02080"></a>02080    *cur++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02081"></a>02081    <span class="comment">/* XXX put a NULL in the last argument, because some functions that take</span>
<a name="l02082"></a>02082 <span class="comment">    * the array may want a null-terminated array.</span>
<a name="l02083"></a>02083 <span class="comment">    * argc still reflects the number of non-NULL entries.</span>
<a name="l02084"></a>02084 <span class="comment">    */</span>
<a name="l02085"></a>02085    argv[x] = NULL;
<a name="l02086"></a>02086    *argc = x;
<a name="l02087"></a>02087    *trailingwhitespace = whitespace;
<a name="l02088"></a>02088    <span class="keywordflow">return</span> duplicate;
<a name="l02089"></a>02089 }
<a name="l02090"></a>02090 <span class="comment"></span>
<a name="l02091"></a>02091 <span class="comment">/*! \brief Return the number of unique matches for the generator */</span>
<a name="l02092"></a><a class="code" href="cli_8c.html#af0454163e128ba7fdba510bb848f07cb">02092</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#aeb2e977805785f2382807318e26c4829" title="Return the number of unique matches for the generator.">ast_cli_generatornummatches</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>)
<a name="l02093"></a>02093 {
<a name="l02094"></a>02094    <span class="keywordtype">int</span> matches = 0, i = 0;
<a name="l02095"></a>02095    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = NULL, *oldbuf = NULL;
<a name="l02096"></a>02096 
<a name="l02097"></a>02097    <span class="keywordflow">while</span> ((buf = <a class="code" href="cli_8h.html#a21652cd28eeec8299b69288967f9a4a1" title="Readline madness Useful for readline, that&amp;#39;s about it.">ast_cli_generator</a>(text, word, i++))) {
<a name="l02098"></a>02098       <span class="keywordflow">if</span> (!oldbuf || strcmp(buf,oldbuf))
<a name="l02099"></a>02099          matches++;
<a name="l02100"></a>02100       <span class="keywordflow">if</span> (oldbuf)
<a name="l02101"></a>02101          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(oldbuf);
<a name="l02102"></a>02102       oldbuf = buf;
<a name="l02103"></a>02103    }
<a name="l02104"></a>02104    <span class="keywordflow">if</span> (oldbuf)
<a name="l02105"></a>02105       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(oldbuf);
<a name="l02106"></a>02106    <span class="keywordflow">return</span> matches;
<a name="l02107"></a>02107 }
<a name="l02108"></a>02108 
<a name="l02109"></a><a class="code" href="cli_8c.html#a1069d2d27b3c28328ab20ab898c36960">02109</a> <span class="keywordtype">char</span> **<a class="code" href="cli_8h.html#a068d40212b118f7bc09e851af6a45015" title="Generates a NULL-terminated array of strings that 1) begin with the string in the...">ast_cli_completion_matches</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>)
<a name="l02110"></a>02110 {
<a name="l02111"></a>02111    <span class="keywordtype">char</span> **match_list = NULL, *retstr, *prevstr;
<a name="l02112"></a>02112    <span class="keywordtype">size_t</span> match_list_len, max_equal, which, i;
<a name="l02113"></a>02113    <span class="keywordtype">int</span> matches = 0;
<a name="l02114"></a>02114 
<a name="l02115"></a>02115    <span class="comment">/* leave entry 0 free for the longest common substring */</span>
<a name="l02116"></a>02116    match_list_len = 1;
<a name="l02117"></a>02117    <span class="keywordflow">while</span> ((retstr = <a class="code" href="cli_8h.html#a21652cd28eeec8299b69288967f9a4a1" title="Readline madness Useful for readline, that&amp;#39;s about it.">ast_cli_generator</a>(text, word, matches)) != NULL) {
<a name="l02118"></a>02118       <span class="keywordflow">if</span> (matches + 1 &gt;= match_list_len) {
<a name="l02119"></a>02119          match_list_len &lt;&lt;= 1;
<a name="l02120"></a>02120          <span class="keywordflow">if</span> (!(match_list = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(match_list, match_list_len * <span class="keyword">sizeof</span>(*match_list))))
<a name="l02121"></a>02121             <span class="keywordflow">return</span> NULL;
<a name="l02122"></a>02122       }
<a name="l02123"></a>02123       match_list[++matches] = retstr;
<a name="l02124"></a>02124    }
<a name="l02125"></a>02125 
<a name="l02126"></a>02126    <span class="keywordflow">if</span> (!match_list)
<a name="l02127"></a>02127       <span class="keywordflow">return</span> match_list; <span class="comment">/* NULL */</span>
<a name="l02128"></a>02128 
<a name="l02129"></a>02129    <span class="comment">/* Find the longest substring that is common to all results</span>
<a name="l02130"></a>02130 <span class="comment">    * (it is a candidate for completion), and store a copy in entry 0.</span>
<a name="l02131"></a>02131 <span class="comment">    */</span>
<a name="l02132"></a>02132    prevstr = match_list[1];
<a name="l02133"></a>02133    max_equal = strlen(prevstr);
<a name="l02134"></a>02134    <span class="keywordflow">for</span> (which = 2; which &lt;= matches; which++) {
<a name="l02135"></a>02135       <span class="keywordflow">for</span> (i = 0; i &lt; max_equal &amp;&amp; toupper(prevstr[i]) == toupper(match_list[which][i]); i++)
<a name="l02136"></a>02136          <span class="keywordflow">continue</span>;
<a name="l02137"></a>02137       max_equal = i;
<a name="l02138"></a>02138    }
<a name="l02139"></a>02139 
<a name="l02140"></a>02140    <span class="keywordflow">if</span> (!(retstr = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(max_equal + 1)))
<a name="l02141"></a>02141       <span class="keywordflow">return</span> NULL;
<a name="l02142"></a>02142    
<a name="l02143"></a>02143    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retstr, match_list[1], max_equal + 1);
<a name="l02144"></a>02144    match_list[0] = retstr;
<a name="l02145"></a>02145 
<a name="l02146"></a>02146    <span class="comment">/* ensure that the array is NULL terminated */</span>
<a name="l02147"></a>02147    <span class="keywordflow">if</span> (matches + 1 &gt;= match_list_len) {
<a name="l02148"></a>02148       <span class="keywordflow">if</span> (!(match_list = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(match_list, (match_list_len + 1) * <span class="keyword">sizeof</span>(*match_list))))
<a name="l02149"></a>02149          <span class="keywordflow">return</span> NULL;
<a name="l02150"></a>02150    }
<a name="l02151"></a>02151    match_list[matches + 1] = NULL;
<a name="l02152"></a>02152 
<a name="l02153"></a>02153    <span class="keywordflow">return</span> match_list;
<a name="l02154"></a>02154 }
<a name="l02155"></a>02155 <span class="comment"></span>
<a name="l02156"></a>02156 <span class="comment">/*! \brief returns true if there are more words to match */</span>
<a name="l02157"></a><a class="code" href="cli_8c.html#aa19d0e275db21c1821c50b403517d1b1">02157</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="cli_8c.html#aa19d0e275db21c1821c50b403517d1b1" title="returns true if there are more words to match">more_words</a> (<span class="keywordtype">char</span> * <span class="keyword">const</span> *dst)
<a name="l02158"></a>02158 {
<a name="l02159"></a>02159    <span class="keywordtype">int</span> i;
<a name="l02160"></a>02160    <span class="keywordflow">for</span> (i = 0; dst[i]; i++) {
<a name="l02161"></a>02161       <span class="keywordflow">if</span> (dst[i][0] != <span class="charliteral">&apos;[&apos;</span>)
<a name="l02162"></a>02162          <span class="keywordflow">return</span> -1;
<a name="l02163"></a>02163    }
<a name="l02164"></a>02164    <span class="keywordflow">return</span> 0;
<a name="l02165"></a>02165 }
<a name="l02166"></a>02166    
<a name="l02167"></a>02167 <span class="comment">/*</span>
<a name="l02168"></a>02168 <span class="comment"> * generate the entry at position &apos;state&apos;</span>
<a name="l02169"></a>02169 <span class="comment"> */</span>
<a name="l02170"></a><a class="code" href="cli_8c.html#ad05311723605fd9bf9bcf9ebe05323dc">02170</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="cli_8c.html#ad05311723605fd9bf9bcf9ebe05323dc">__ast_cli_generator</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>)
<a name="l02171"></a>02171 {
<a name="l02172"></a>02172    <span class="keywordtype">char</span> *argv[<a class="code" href="cli_8h.html#a72e6114dccaa5a6f2c8e7d369360db9e">AST_MAX_ARGS</a>];
<a name="l02173"></a>02173    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e = NULL;
<a name="l02174"></a>02174    <span class="keywordtype">int</span> x = 0, argindex, matchlen;
<a name="l02175"></a>02175    <span class="keywordtype">int</span> matchnum=0;
<a name="l02176"></a>02176    <span class="keywordtype">char</span> *ret = NULL;
<a name="l02177"></a>02177    <span class="keywordtype">char</span> matchstr[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02178"></a>02178    <span class="keywordtype">int</span> tws = 0;
<a name="l02179"></a>02179    <span class="comment">/* Split the argument into an array of words */</span>
<a name="l02180"></a>02180    <span class="keywordtype">char</span> *duplicate = <a class="code" href="cli_8c.html#ad1176051c0fb523f0e068ff4737f54ce">parse_args</a>(text, &amp;x, argv, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(argv), &amp;tws);
<a name="l02181"></a>02181 
<a name="l02182"></a>02182    <span class="keywordflow">if</span> (!duplicate)   <span class="comment">/* malloc error */</span>
<a name="l02183"></a>02183       <span class="keywordflow">return</span> NULL;
<a name="l02184"></a>02184 
<a name="l02185"></a>02185    <span class="comment">/* Compute the index of the last argument (could be an empty string) */</span>
<a name="l02186"></a>02186    argindex = (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(word) &amp;&amp; x&gt;0) ? x-1 : x;
<a name="l02187"></a>02187 
<a name="l02188"></a>02188    <span class="comment">/* rebuild the command, ignore terminating white space and flatten space */</span>
<a name="l02189"></a>02189    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(matchstr, <span class="keyword">sizeof</span>(matchstr)-1, argv);
<a name="l02190"></a>02190    matchlen = strlen(matchstr);
<a name="l02191"></a>02191    <span class="keywordflow">if</span> (tws) {
<a name="l02192"></a>02192       strcat(matchstr, <span class="stringliteral">&quot; &quot;</span>); <span class="comment">/* XXX */</span>
<a name="l02193"></a>02193       <span class="keywordflow">if</span> (matchlen)
<a name="l02194"></a>02194          matchlen++;
<a name="l02195"></a>02195    }
<a name="l02196"></a>02196    <span class="keywordflow">if</span> (lock)
<a name="l02197"></a>02197       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02198"></a>02198    <span class="keywordflow">while</span> ( (e = <a class="code" href="cli_8c.html#adac48ec5ae21bd48d7f3dac6c44b2868">cli_next</a>(e)) ) {
<a name="l02199"></a>02199       <span class="comment">/* XXX repeated code */</span>
<a name="l02200"></a>02200       <span class="keywordtype">int</span> src = 0, dst = 0, n = 0;
<a name="l02201"></a>02201 
<a name="l02202"></a>02202       <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a>[0] == <span class="charliteral">&apos;_&apos;</span>)
<a name="l02203"></a>02203          <span class="keywordflow">continue</span>;
<a name="l02204"></a>02204 
<a name="l02205"></a>02205       <span class="comment">/*</span>
<a name="l02206"></a>02206 <span class="comment">       * Try to match words, up to and excluding the last word, which</span>
<a name="l02207"></a>02207 <span class="comment">       * is either a blank or something that we want to extend.</span>
<a name="l02208"></a>02208 <span class="comment">       */</span>
<a name="l02209"></a>02209       <span class="keywordflow">for</span> (;src &lt; argindex; dst++, src += n) {
<a name="l02210"></a>02210          n = <a class="code" href="cli_8c.html#a7e2ed1ce1c57688bd381362ae8918d23">word_match</a>(argv[src], e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>[dst]);
<a name="l02211"></a>02211          <span class="keywordflow">if</span> (n &lt; 0)
<a name="l02212"></a>02212             <span class="keywordflow">break</span>;
<a name="l02213"></a>02213       }
<a name="l02214"></a>02214 
<a name="l02215"></a>02215       <span class="keywordflow">if</span> (src != argindex &amp;&amp; <a class="code" href="cli_8c.html#aa19d0e275db21c1821c50b403517d1b1" title="returns true if there are more words to match">more_words</a>(e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a> + dst))  <span class="comment">/* not a match */</span>
<a name="l02216"></a>02216          <span class="keywordflow">continue</span>;
<a name="l02217"></a>02217       ret = <a class="code" href="cli_8c.html#a5e4bb02679737eab93085669c640b778" title="if word is a valid prefix for token, returns the pos-th match as a malloced string...">is_prefix</a>(argv[src], e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>[dst], state - matchnum, &amp;n);
<a name="l02218"></a>02218       matchnum += n; <span class="comment">/* this many matches here */</span>
<a name="l02219"></a>02219       <span class="keywordflow">if</span> (ret) {
<a name="l02220"></a>02220          <span class="comment">/*</span>
<a name="l02221"></a>02221 <span class="comment">          * argv[src] is a valid prefix of the next word in this</span>
<a name="l02222"></a>02222 <span class="comment">          * command. If this is also the correct entry, return it.</span>
<a name="l02223"></a>02223 <span class="comment">          */</span>
<a name="l02224"></a>02224          <span class="keywordflow">if</span> (matchnum &gt; state)
<a name="l02225"></a>02225             <span class="keywordflow">break</span>;
<a name="l02226"></a>02226          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ret);
<a name="l02227"></a>02227          ret = NULL;
<a name="l02228"></a>02228       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(e-&gt;<a class="code" href="structast__cli__entry.html#a17db870e4c2bb6e969b89cd6f96c991c">cmda</a>[dst])) {
<a name="l02229"></a>02229          <span class="comment">/*</span>
<a name="l02230"></a>02230 <span class="comment">          * This entry is a prefix of the command string entered</span>
<a name="l02231"></a>02231 <span class="comment">          * (only one entry in the list should have this property).</span>
<a name="l02232"></a>02232 <span class="comment">          * Run the generator if one is available. In any case we are done.</span>
<a name="l02233"></a>02233 <span class="comment">          */</span>
<a name="l02234"></a>02234          <span class="keywordflow">if</span> (e-&gt;<a class="code" href="structast__cli__entry.html#af0e07e1d04656663ca8b452904abe99b">handler</a>) { <span class="comment">/* new style command */</span>
<a name="l02235"></a>02235             <span class="keyword">struct </span><a class="code" href="structast__cli__args.html">ast_cli_args</a> a = {
<a name="l02236"></a>02236                .<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a> = matchstr, .word = word,
<a name="l02237"></a>02237                .pos = argindex,
<a name="l02238"></a>02238                .n = state - matchnum,
<a name="l02239"></a>02239                .argv = argv,
<a name="l02240"></a>02240                .argc = x};
<a name="l02241"></a>02241             ret = e-&gt;<a class="code" href="structast__cli__entry.html#af0e07e1d04656663ca8b452904abe99b">handler</a>(e, <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>, &amp;a);
<a name="l02242"></a>02242          }
<a name="l02243"></a>02243          <span class="keywordflow">if</span> (ret)
<a name="l02244"></a>02244             <span class="keywordflow">break</span>;
<a name="l02245"></a>02245       }
<a name="l02246"></a>02246    }
<a name="l02247"></a>02247    <span class="keywordflow">if</span> (lock)
<a name="l02248"></a>02248       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02249"></a>02249    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(duplicate);
<a name="l02250"></a>02250    <span class="keywordflow">return</span> ret;
<a name="l02251"></a>02251 }
<a name="l02252"></a>02252 
<a name="l02253"></a><a class="code" href="cli_8c.html#ab884a0f2d24bec68f1d61564d9f857b9">02253</a> <span class="keywordtype">char</span> *<a class="code" href="cli_8h.html#a21652cd28eeec8299b69288967f9a4a1" title="Readline madness Useful for readline, that&amp;#39;s about it.">ast_cli_generator</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l02254"></a>02254 {
<a name="l02255"></a>02255    <span class="keywordflow">return</span> <a class="code" href="cli_8c.html#ad05311723605fd9bf9bcf9ebe05323dc">__ast_cli_generator</a>(text, word, state, 1);
<a name="l02256"></a>02256 }
<a name="l02257"></a>02257 
<a name="l02258"></a><a class="code" href="cli_8c.html#aed9a4dab62dbb614240800509ccfac1c">02258</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#aed9a4dab62dbb614240800509ccfac1c" title="Interprets a command Interpret a command s, sending output to fd if uid:gid has permissions...">ast_cli_command_full</a>(<span class="keywordtype">int</span> uid, <span class="keywordtype">int</span> gid, <span class="keywordtype">int</span> <a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l02259"></a>02259 {
<a name="l02260"></a>02260    <span class="keywordtype">char</span> *args[<a class="code" href="cli_8h.html#a72e6114dccaa5a6f2c8e7d369360db9e">AST_MAX_ARGS</a> + 1];
<a name="l02261"></a>02261    <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e;
<a name="l02262"></a>02262    <span class="keywordtype">int</span> x;
<a name="l02263"></a>02263    <span class="keywordtype">char</span> *duplicate = <a class="code" href="cli_8c.html#ad1176051c0fb523f0e068ff4737f54ce">parse_args</a>(s, &amp;x, args + 1, <a class="code" href="cli_8h.html#a72e6114dccaa5a6f2c8e7d369360db9e">AST_MAX_ARGS</a>, NULL);
<a name="l02264"></a>02264    <span class="keywordtype">char</span> tmp[<a class="code" href="cli_8h.html#a72e6114dccaa5a6f2c8e7d369360db9e">AST_MAX_ARGS</a> + 1];
<a name="l02265"></a>02265    <span class="keywordtype">char</span> *retval = NULL;
<a name="l02266"></a>02266    <span class="keyword">struct </span><a class="code" href="structast__cli__args.html">ast_cli_args</a> a = {
<a name="l02267"></a>02267       .<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fd, .argc = x, .argv = args+1 };
<a name="l02268"></a>02268 
<a name="l02269"></a>02269    <span class="keywordflow">if</span> (duplicate == NULL)
<a name="l02270"></a>02270       <span class="keywordflow">return</span> -1;
<a name="l02271"></a>02271 
<a name="l02272"></a>02272    <span class="keywordflow">if</span> (x &lt; 1)  <span class="comment">/* We need at least one entry, otherwise ignore */</span>
<a name="l02273"></a>02273       <span class="keywordflow">goto</span> done;
<a name="l02274"></a>02274 
<a name="l02275"></a>02275    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02276"></a>02276    e = <a class="code" href="cli_8c.html#a7ae95494897a62695433cb697e7fc53b">find_cli</a>(args + 1, 0);
<a name="l02277"></a>02277    <span class="keywordflow">if</span> (e)
<a name="l02278"></a>02278       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;e-&gt;<a class="code" href="structast__cli__entry.html#a679cabe3b846f2e363f43d8e57433834">inuse</a>, 1);
<a name="l02279"></a>02279    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structhelpers.html">helpers</a>);
<a name="l02280"></a>02280    <span class="keywordflow">if</span> (e == NULL) {
<a name="l02281"></a>02281       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;No such command &apos;%s&apos; (type &apos;core show help %s&apos; for other possible commands)\n&quot;</span>, s, <a class="code" href="cli_8c.html#a8a1ff15e1264d5177e9975142a0e9be8">find_best</a>(args + 1));
<a name="l02282"></a>02282       <span class="keywordflow">goto</span> done;
<a name="l02283"></a>02283    }
<a name="l02284"></a>02284 
<a name="l02285"></a>02285    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(tmp, <span class="keyword">sizeof</span>(tmp), args + 1);
<a name="l02286"></a>02286    <span class="comment">/* Check if the user has rights to run this command. */</span>
<a name="l02287"></a>02287    <span class="keywordflow">if</span> (!<a class="code" href="cli_8c.html#a97c81620d61e3249bf35cada6df2a088">cli_has_permissions</a>(uid, gid, tmp)) {
<a name="l02288"></a>02288       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;You don&apos;t have permissions to run &apos;%s&apos; command\n&quot;</span>, tmp);
<a name="l02289"></a>02289       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(duplicate);
<a name="l02290"></a>02290       <span class="keywordflow">return</span> 0;
<a name="l02291"></a>02291    }
<a name="l02292"></a>02292 
<a name="l02293"></a>02293    <span class="comment">/*</span>
<a name="l02294"></a>02294 <span class="comment">    * Within the handler, argv[-1] contains a pointer to the ast_cli_entry.</span>
<a name="l02295"></a>02295 <span class="comment">    * Remember that the array returned by parse_args is NULL-terminated.</span>
<a name="l02296"></a>02296 <span class="comment">    */</span>
<a name="l02297"></a>02297    args[0] = (<span class="keywordtype">char</span> *)e;
<a name="l02298"></a>02298 
<a name="l02299"></a>02299    retval = e-&gt;<a class="code" href="structast__cli__entry.html#af0e07e1d04656663ca8b452904abe99b">handler</a>(e, <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea2e4a68503bbadbeacf842a24c7d7f2df">CLI_HANDLER</a>, &amp;a);
<a name="l02300"></a>02300 
<a name="l02301"></a>02301    <span class="keywordflow">if</span> (retval == <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>) {
<a name="l02302"></a>02302       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a>, <span class="stringliteral">&quot;Invalid usage, but no usage information available.\n&quot;</span>));
<a name="l02303"></a>02303    } <span class="keywordflow">else</span> {
<a name="l02304"></a>02304       <span class="keywordflow">if</span> (retval == <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>)
<a name="l02305"></a>02305          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;Command &apos;%s&apos; failed.\n&quot;</span>, s);
<a name="l02306"></a>02306    }
<a name="l02307"></a>02307    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;e-&gt;<a class="code" href="structast__cli__entry.html#a679cabe3b846f2e363f43d8e57433834">inuse</a>, -1);
<a name="l02308"></a>02308 done:
<a name="l02309"></a>02309    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(duplicate);
<a name="l02310"></a>02310    <span class="keywordflow">return</span> 0;
<a name="l02311"></a>02311 }
<a name="l02312"></a>02312 
<a name="l02313"></a><a class="code" href="cli_8c.html#ab1d4a1fb19a2a81cc450e1173b346eca">02313</a> <span class="keywordtype">int</span> <a class="code" href="cli_8h.html#ab1d4a1fb19a2a81cc450e1173b346eca" title="Executes multiple CLI commands Interpret strings separated by NULL and execute each...">ast_cli_command_multiple_full</a>(<span class="keywordtype">int</span> uid, <span class="keywordtype">int</span> gid, <span class="keywordtype">int</span> <a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="keywordtype">size_t</span> size, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l02314"></a>02314 {
<a name="l02315"></a>02315    <span class="keywordtype">char</span> cmd[512];
<a name="l02316"></a>02316    <span class="keywordtype">int</span> x, y = 0, count = 0;
<a name="l02317"></a>02317 
<a name="l02318"></a>02318    <span class="keywordflow">for</span> (x = 0; x &lt; size; x++) {
<a name="l02319"></a>02319       cmd[y] = s[x];
<a name="l02320"></a>02320       y++;
<a name="l02321"></a>02321       <span class="keywordflow">if</span> (s[x] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02322"></a>02322          <a class="code" href="cli_8h.html#aed9a4dab62dbb614240800509ccfac1c" title="Interprets a command Interpret a command s, sending output to fd if uid:gid has permissions...">ast_cli_command_full</a>(uid, gid, fd, cmd);
<a name="l02323"></a>02323          y = 0;
<a name="l02324"></a>02324          count++;
<a name="l02325"></a>02325       }
<a name="l02326"></a>02326    }
<a name="l02327"></a>02327    <span class="keywordflow">return</span> count;
<a name="l02328"></a>02328 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:38 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
