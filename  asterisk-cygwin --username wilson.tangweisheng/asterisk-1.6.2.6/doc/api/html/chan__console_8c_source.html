<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:30 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0ca6ff3bf6b340411b2c6edd15b1a34d.html">channels</a>
  </div>
</div>
<div class="contents">
<h1>chan_console.c</h1><a href="chan__console_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2006 - 2008, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! </span>
<a name="l00020"></a>00020 <span class="comment"> * \file </span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Cross-platform console channel driver </span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \note Some of the code in this file came from chan_oss and chan_alsa.</span>
<a name="l00026"></a>00026 <span class="comment"> *       chan_oss,  Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00027"></a>00027 <span class="comment"> *       chan_oss,  Luigi Rizzo</span>
<a name="l00028"></a>00028 <span class="comment"> *       chan_alsa, Matthew Fredrickson &lt;creslin@digium.com&gt;</span>
<a name="l00029"></a>00029 <span class="comment"> * </span>
<a name="l00030"></a>00030 <span class="comment"> * \ingroup channel_drivers</span>
<a name="l00031"></a>00031 <span class="comment"> *</span>
<a name="l00032"></a>00032 <span class="comment"> * \extref Portaudio http://www.portaudio.com/</span>
<a name="l00033"></a>00033 <span class="comment"> *</span>
<a name="l00034"></a>00034 <span class="comment"> * To install portaudio v19 from svn, check it out using the following command:</span>
<a name="l00035"></a>00035 <span class="comment"> *  - svn co https://www.portaudio.com/repos/portaudio/branches/v19-devel</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * \note Since this works with any audio system that libportaudio supports,</span>
<a name="l00038"></a>00038 <span class="comment"> * including ALSA and OSS, this may someday deprecate chan_alsa and chan_oss.</span>
<a name="l00039"></a>00039 <span class="comment"> * However, before that can be done, it needs to *at least* have all of the</span>
<a name="l00040"></a>00040 <span class="comment"> * features that these other channel drivers have.  The features implemented</span>
<a name="l00041"></a>00041 <span class="comment"> * in at least one of the other console channel drivers that are not yet</span>
<a name="l00042"></a>00042 <span class="comment"> * implemented here are:</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * - Set Auto-answer from the dialplan</span>
<a name="l00045"></a>00045 <span class="comment"> * - transfer CLI command</span>
<a name="l00046"></a>00046 <span class="comment"> * - boost CLI command and .conf option</span>
<a name="l00047"></a>00047 <span class="comment"> * - console_video support</span>
<a name="l00048"></a>00048 <span class="comment"> */</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">/*** MODULEINFO</span>
<a name="l00051"></a>00051 <span class="comment">   &lt;depend&gt;portaudio&lt;/depend&gt;</span>
<a name="l00052"></a>00052 <span class="comment"> ***/</span>
<a name="l00053"></a>00053 
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00055"></a>00055 
<a name="l00056"></a>00056 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 249895 $&quot;</span>)
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &lt;sys/signal.h&gt;  </span><span class="comment">/* SIGURG */</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &lt;portaudio.h&gt;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="comment"></span>
<a name="l00071"></a>00071 <span class="comment">/*! </span>
<a name="l00072"></a>00072 <span class="comment"> * \brief The sample rate to request from PortAudio </span>
<a name="l00073"></a>00073 <span class="comment"> *</span>
<a name="l00074"></a>00074 <span class="comment"> * \todo Make this optional.  If this is only going to talk to 8 kHz endpoints,</span>
<a name="l00075"></a>00075 <span class="comment"> *       then it makes sense to use 8 kHz natively.</span>
<a name="l00076"></a>00076 <span class="comment"> */</span>
<a name="l00077"></a><a class="code" href="chan__console_8c.html#a4b76a0c2859cfd819a343a780070ee2b">00077</a> <span class="preprocessor">#define SAMPLE_RATE      16000</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00079"></a>00079 <span class="comment">/*! </span>
<a name="l00080"></a>00080 <span class="comment"> * \brief The number of samples to configure the portaudio stream for</span>
<a name="l00081"></a>00081 <span class="comment"> *</span>
<a name="l00082"></a>00082 <span class="comment"> * 320 samples (20 ms) is the most common frame size in Asterisk.  So, the code</span>
<a name="l00083"></a>00083 <span class="comment"> * in this module reads 320 sample frames from the portaudio stream and queues</span>
<a name="l00084"></a>00084 <span class="comment"> * them up on the Asterisk channel.  Frames of any size can be written to a</span>
<a name="l00085"></a>00085 <span class="comment"> * portaudio stream, but the portaudio documentation does say that for high</span>
<a name="l00086"></a>00086 <span class="comment"> * performance applications, the data should be written to Pa_WriteStream in</span>
<a name="l00087"></a>00087 <span class="comment"> * the same size as what is used to initialize the stream.</span>
<a name="l00088"></a>00088 <span class="comment"> */</span>
<a name="l00089"></a><a class="code" href="chan__console_8c.html#af0b23eedf2352de4c1eff77e1401730c">00089</a> <span class="preprocessor">#define NUM_SAMPLES      320</span>
<a name="l00090"></a>00090 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00091"></a>00091 <span class="comment">/*! \brief Mono Input */</span>
<a name="l00092"></a><a class="code" href="chan__console_8c.html#a81ec44a9cf8d6d8abc80975382b5b26b">00092</a> <span class="preprocessor">#define INPUT_CHANNELS   1</span>
<a name="l00093"></a>00093 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00094"></a>00094 <span class="comment">/*! \brief Mono Output */</span>
<a name="l00095"></a><a class="code" href="chan__console_8c.html#a4d4855d9b709af9628540e41e5ebb925">00095</a> <span class="preprocessor">#define OUTPUT_CHANNELS  1</span>
<a name="l00096"></a>00096 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00097"></a>00097 <span class="comment">/*! </span>
<a name="l00098"></a>00098 <span class="comment"> * \brief Maximum text message length</span>
<a name="l00099"></a>00099 <span class="comment"> * \note This should be changed if there is a common definition somewhere</span>
<a name="l00100"></a>00100 <span class="comment"> *       that defines the maximum length of a text message.</span>
<a name="l00101"></a>00101 <span class="comment"> */</span>
<a name="l00102"></a><a class="code" href="chan__console_8c.html#afb6f36d91ffbf947cfa3f1114ca79764">00102</a> <span class="preprocessor">#define TEXT_SIZE 256</span>
<a name="l00103"></a>00103 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00104"></a>00104 <span class="comment">/*! \brief Dance, Kirby, Dance! @{ */</span>
<a name="l00105"></a><a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402">00105</a> <span class="preprocessor">#define V_BEGIN &quot; --- &lt;(\&quot;&lt;) --- &quot;</span>
<a name="l00106"></a><a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">00106</a> <span class="preprocessor"></span><span class="preprocessor">#define V_END   &quot; --- (&gt;\&quot;)&gt; ---\n&quot;</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span><span class="comment">/*! @} */</span>
<a name="l00108"></a>00108 
<a name="l00109"></a><a class="code" href="chan__console_8c.html#abb961ff543844412d044d48e6163b3a8">00109</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="chan__console_8c.html#abb961ff543844412d044d48e6163b3a8">config_file</a>[] = <span class="stringliteral">&quot;console.conf&quot;</span>;
<a name="l00110"></a>00110 <span class="comment"></span>
<a name="l00111"></a>00111 <span class="comment">/*!</span>
<a name="l00112"></a>00112 <span class="comment"> * \brief Console pvt structure</span>
<a name="l00113"></a>00113 <span class="comment"> *</span>
<a name="l00114"></a>00114 <span class="comment"> * Currently, this is a singleton object.  However, multiple instances will be</span>
<a name="l00115"></a>00115 <span class="comment"> * needed when this module is updated for multiple device support.</span>
<a name="l00116"></a>00116 <span class="comment"> */</span>
<a name="l00117"></a><a class="code" href="structconsole__pvt.html">00117</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> {
<a name="l00118"></a>00118    <a class="code" href="structconsole__pvt.html#a09862391207f6673343afaa89ca891f3">AST_DECLARE_STRING_FIELDS</a>(<span class="comment"></span>
<a name="l00119"></a>00119 <span class="comment">      /*! Name of the device */</span>
<a name="l00120"></a>00120       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00121"></a>00121       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(input_device);
<a name="l00122"></a>00122       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(output_device);<span class="comment"></span>
<a name="l00123"></a>00123 <span class="comment">      /*! Default context for outgoing calls */</span>
<a name="l00124"></a>00124       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);<span class="comment"></span>
<a name="l00125"></a>00125 <span class="comment">      /*! Default extension for outgoing calls */</span>
<a name="l00126"></a>00126       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);<span class="comment"></span>
<a name="l00127"></a>00127 <span class="comment">      /*! Default CallerID number */</span>
<a name="l00128"></a>00128       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);<span class="comment"></span>
<a name="l00129"></a>00129 <span class="comment">      /*! Default CallerID name */</span>
<a name="l00130"></a>00130       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>);<span class="comment"></span>
<a name="l00131"></a>00131 <span class="comment">      /*! Default MOH class to listen to, if:</span>
<a name="l00132"></a>00132 <span class="comment">       *    - No MOH class set on the channel</span>
<a name="l00133"></a>00133 <span class="comment">       *    - Peer channel putting this device on hold did not suggest a class */</span>
<a name="l00134"></a>00134       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>);<span class="comment"></span>
<a name="l00135"></a>00135 <span class="comment">      /*! Default language */</span>
<a name="l00136"></a>00136       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);<span class="comment"></span>
<a name="l00137"></a>00137 <span class="comment">      /*! Default parkinglot */</span>
<a name="l00138"></a>00138       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>);
<a name="l00139"></a>00139    );<span class="comment"></span>
<a name="l00140"></a>00140 <span class="comment">   /*! Current channel for this device */</span>
<a name="l00141"></a><a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">00141</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;<span class="comment"></span>
<a name="l00142"></a>00142 <span class="comment">   /*! Current PortAudio stream for this device */</span>
<a name="l00143"></a><a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">00143</a>    PaStream *<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>;<span class="comment"></span>
<a name="l00144"></a>00144 <span class="comment">   /*! A frame for preparing to queue on to the channel */</span>
<a name="l00145"></a><a class="code" href="structconsole__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">00145</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="structconsole__pvt.html#a0e0e3398d4f54057ddca440cae05f3d4">fr</a>;<span class="comment"></span>
<a name="l00146"></a>00146 <span class="comment">   /*! Running = 1, Not running = 0 */</span>
<a name="l00147"></a><a class="code" href="structconsole__pvt.html#a64af28acef456ada84fa80f90adae03e">00147</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structconsole__pvt.html#a64af28acef456ada84fa80f90adae03e">streamstate</a>:1;<span class="comment"></span>
<a name="l00148"></a>00148 <span class="comment">   /*! On-hook = 0, Off-hook = 1 */</span>
<a name="l00149"></a><a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">00149</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a>:1;<span class="comment"></span>
<a name="l00150"></a>00150 <span class="comment">   /*! Unmuted = 0, Muted = 1 */</span>
<a name="l00151"></a><a class="code" href="structconsole__pvt.html#a18a3a8f373661dd2e20ddb9035abead2">00151</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structconsole__pvt.html#a18a3a8f373661dd2e20ddb9035abead2">muted</a>:1;<span class="comment"></span>
<a name="l00152"></a>00152 <span class="comment">   /*! Automatically answer incoming calls */</span>
<a name="l00153"></a><a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">00153</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a>:1;<span class="comment"></span>
<a name="l00154"></a>00154 <span class="comment">   /*! Ignore context in the console dial CLI command */</span>
<a name="l00155"></a><a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">00155</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a>:1;<span class="comment"></span>
<a name="l00156"></a>00156 <span class="comment">   /*! Set during a reload so that we know to destroy this if it is no longer</span>
<a name="l00157"></a>00157 <span class="comment">    *  in the configuration file. */</span>
<a name="l00158"></a><a class="code" href="structconsole__pvt.html#ab16498ae4f96c29649dd52ac032e811d">00158</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structconsole__pvt.html#ab16498ae4f96c29649dd52ac032e811d">destroy</a>:1;<span class="comment"></span>
<a name="l00159"></a>00159 <span class="comment">   /*! ID for the stream monitor thread */</span>
<a name="l00160"></a><a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">00160</a>    pthread_t <a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l00161"></a>00161 } <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163 <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l00164"></a>00164 
<a name="l00165"></a><a class="code" href="chan__console_8c.html#a8088707c252266a9c68cca9355920c4f">00165</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__console_8c.html#a8088707c252266a9c68cca9355920c4f">pvts</a>;
<a name="l00166"></a><a class="code" href="chan__console_8c.html#a242c6c182abafb21beb43874f31493bc">00166</a> <span class="preprocessor">#define NUM_PVT_BUCKETS 7</span>
<a name="l00167"></a>00167 <span class="preprocessor"></span>
<a name="l00168"></a><a class="code" href="chan__console_8c.html#a3c5178f98ba2184637b8b4184f4451e6">00168</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *<a class="code" href="chan__console_8c.html#a3c5178f98ba2184637b8b4184f4451e6">active_pvt</a>;
<a name="l00169"></a>00169 <a class="code" href="lock_8h.html#a7443635fb39ae2aa946e2373dada3ac7">AST_RWLOCK_DEFINE_STATIC</a>(active_lock);
<a name="l00170"></a>00170 <span class="comment"></span>
<a name="l00171"></a>00171 <span class="comment">/*! </span>
<a name="l00172"></a>00172 <span class="comment"> * \brief Global jitterbuffer configuration </span>
<a name="l00173"></a>00173 <span class="comment"> *</span>
<a name="l00174"></a>00174 <span class="comment"> * \note Disabled by default.</span>
<a name="l00175"></a>00175 <span class="comment"> */</span>
<a name="l00176"></a><a class="code" href="chan__console_8c.html#a2d8d5920e90ccbad7832926becdadb29">00176</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__jb__conf.html" title="General jitterbuffer configuration.">ast_jb_conf</a> <a class="code" href="chan__console_8c.html#a2d8d5920e90ccbad7832926becdadb29" title="Global jitterbuffer configuration.">default_jbconf</a> = {
<a name="l00177"></a>00177    .<a class="code" href="structast__jb__conf.html#ac92588540e8c1d014a08cd8a45462b19" title="Combination of the AST_JB_ENABLED, AST_JB_FORCED and AST_JB_LOG flags.">flags</a> = 0,
<a name="l00178"></a>00178    .max_size = -1,
<a name="l00179"></a>00179    .resync_threshold = -1,
<a name="l00180"></a>00180    .impl = <span class="stringliteral">&quot;&quot;</span>,
<a name="l00181"></a>00181    .target_extra = -1,
<a name="l00182"></a>00182 };
<a name="l00183"></a><a class="code" href="chan__console_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">00183</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__jb__conf.html" title="General jitterbuffer configuration.">ast_jb_conf</a> <a class="code" href="chan__console_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>;
<a name="l00184"></a>00184 <span class="comment"></span>
<a name="l00185"></a>00185 <span class="comment">/*! Channel Technology Callbacks @{ */</span>
<a name="l00186"></a>00186 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__console_8c.html#a916ad1d9bece65ae509735d1d0427e11">console_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, 
<a name="l00187"></a>00187    <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>);
<a name="l00188"></a>00188 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a8186789bce79b6ec8a283dd477ba1547">console_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit);
<a name="l00189"></a>00189 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#aedd41b2e60d386c190d51c6b0fce4e05">console_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration);
<a name="l00190"></a>00190 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#aba7a748a03a1a6254ad77470a60ceed2">console_text</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a9834dcd1519346dd7012b0e64c9130f3">console_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c);
<a name="l00192"></a>00192 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a99c2ffd09d0561bc46582f1a3a32e0e1">console_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c);
<a name="l00193"></a>00193 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__console_8c.html#a89fd210a07c95a682f8098fb80274478">console_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>);
<a name="l00194"></a>00194 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#aa023b2b67bddc8d8ce409df2ff74f6ec">console_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout);
<a name="l00195"></a>00195 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a88f55ebcdc5e71d72454b048f4995990">console_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>);
<a name="l00196"></a>00196 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a858d85d2099015670ab0e2532cb61e42">console_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>, 
<a name="l00197"></a>00197    <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">size_t</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#acc72dc0d3c70bf2f646aee5a38232956">console_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan);<span class="comment"></span>
<a name="l00199"></a>00199 <span class="comment">/*! @} */</span>
<a name="l00200"></a>00200 <span class="comment"></span>
<a name="l00201"></a>00201 <span class="comment">/*!</span>
<a name="l00202"></a>00202 <span class="comment"> * \brief Formats natively supported by this module.</span>
<a name="l00203"></a>00203 <span class="comment"> */</span>
<a name="l00204"></a><a class="code" href="chan__console_8c.html#aa2645f8b7ada9ab80dbe210be9beb53e">00204</a> <span class="preprocessor">#define SUPPORTED_FORMATS ( AST_FORMAT_SLINEAR16 )</span>
<a name="l00205"></a>00205 <span class="preprocessor"></span>
<a name="l00206"></a><a class="code" href="chan__console_8c.html#acca4adccc7ecbc25f3beabeb76560139">00206</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> <a class="code" href="chan__console_8c.html#acca4adccc7ecbc25f3beabeb76560139">console_tech</a> = {
<a name="l00207"></a>00207    .<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> = <span class="stringliteral">&quot;Console&quot;</span>,
<a name="l00208"></a>00208    .description = <span class="stringliteral">&quot;Console Channel Driver&quot;</span>,
<a name="l00209"></a>00209    .capabilities = <a class="code" href="chan__console_8c.html#aa2645f8b7ada9ab80dbe210be9beb53e" title="Formats natively supported by this module.">SUPPORTED_FORMATS</a>,
<a name="l00210"></a>00210    .requester = <a class="code" href="chan__console_8c.html#a916ad1d9bece65ae509735d1d0427e11">console_request</a>,
<a name="l00211"></a>00211    .send_digit_begin = <a class="code" href="chan__console_8c.html#a8186789bce79b6ec8a283dd477ba1547">console_digit_begin</a>,
<a name="l00212"></a>00212    .send_digit_end = <a class="code" href="chan__console_8c.html#aedd41b2e60d386c190d51c6b0fce4e05">console_digit_end</a>,
<a name="l00213"></a>00213    .send_text = <a class="code" href="chan__console_8c.html#aba7a748a03a1a6254ad77470a60ceed2">console_text</a>,
<a name="l00214"></a>00214    .hangup = <a class="code" href="chan__console_8c.html#a9834dcd1519346dd7012b0e64c9130f3">console_hangup</a>,
<a name="l00215"></a>00215    .answer = <a class="code" href="chan__console_8c.html#a99c2ffd09d0561bc46582f1a3a32e0e1">console_answer</a>,
<a name="l00216"></a>00216    .read = <a class="code" href="chan__console_8c.html#a89fd210a07c95a682f8098fb80274478">console_read</a>,
<a name="l00217"></a>00217    .call = <a class="code" href="chan__console_8c.html#aa023b2b67bddc8d8ce409df2ff74f6ec">console_call</a>,
<a name="l00218"></a>00218    .write = <a class="code" href="chan__console_8c.html#a88f55ebcdc5e71d72454b048f4995990">console_write</a>,
<a name="l00219"></a>00219    .indicate = <a class="code" href="chan__console_8c.html#a858d85d2099015670ab0e2532cb61e42">console_indicate</a>,
<a name="l00220"></a>00220    .fixup = <a class="code" href="chan__console_8c.html#acc72dc0d3c70bf2f646aee5a38232956">console_fixup</a>,
<a name="l00221"></a>00221 };
<a name="l00222"></a>00222 <span class="comment"></span>
<a name="l00223"></a>00223 <span class="comment">/*! \brief lock a console_pvt struct */</span>
<a name="l00224"></a><a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313">00224</a> <span class="preprocessor">#define console_pvt_lock(pvt) ao2_lock(pvt)</span>
<a name="l00225"></a>00225 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00226"></a>00226 <span class="comment">/*! \brief unlock a console_pvt struct */</span>
<a name="l00227"></a><a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c">00227</a> <span class="preprocessor">#define console_pvt_unlock(pvt) ao2_unlock(pvt)</span>
<a name="l00228"></a>00228 <span class="preprocessor"></span>
<a name="l00229"></a><a class="code" href="chan__console_8c.html#a321d877e577b1fa3359e8df4e313bd9d">00229</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *<a class="code" href="chan__console_8c.html#a321d877e577b1fa3359e8df4e313bd9d">ref_pvt</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt)
<a name="l00230"></a>00230 {
<a name="l00231"></a>00231    <span class="keywordflow">if</span> (pvt)
<a name="l00232"></a>00232       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvt, +1);
<a name="l00233"></a>00233    <span class="keywordflow">return</span> pvt;
<a name="l00234"></a>00234 }
<a name="l00235"></a>00235 
<a name="l00236"></a><a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">00236</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *<a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt)
<a name="l00237"></a>00237 {
<a name="l00238"></a>00238    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvt, -1);
<a name="l00239"></a>00239    <span class="keywordflow">return</span> NULL;
<a name="l00240"></a>00240 }
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="chan__console_8c.html#acf620738e814c1eba7b3087899469cc0">00242</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *<a class="code" href="chan__console_8c.html#acf620738e814c1eba7b3087899469cc0">find_pvt</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> tmp_pvt = {
<a name="l00245"></a>00245       .name = name,
<a name="l00246"></a>00246    };
<a name="l00247"></a>00247 
<a name="l00248"></a>00248    <span class="keywordflow">return</span> <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(pvts, &amp;tmp_pvt, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l00249"></a>00249 }
<a name="l00250"></a>00250 <span class="comment"></span>
<a name="l00251"></a>00251 <span class="comment">/*!</span>
<a name="l00252"></a>00252 <span class="comment"> * \brief Stream monitor thread </span>
<a name="l00253"></a>00253 <span class="comment"> *</span>
<a name="l00254"></a>00254 <span class="comment"> * \arg data A pointer to the console_pvt structure that contains the portaudio</span>
<a name="l00255"></a>00255 <span class="comment"> *      stream that needs to be monitored.</span>
<a name="l00256"></a>00256 <span class="comment"> *</span>
<a name="l00257"></a>00257 <span class="comment"> * This function runs in its own thread to monitor data coming in from a</span>
<a name="l00258"></a>00258 <span class="comment"> * portaudio stream.  When enough data is available, it is queued up to</span>
<a name="l00259"></a>00259 <span class="comment"> * be read from the Asterisk channel.</span>
<a name="l00260"></a>00260 <span class="comment"> */</span>
<a name="l00261"></a><a class="code" href="chan__console_8c.html#a0d36cd7ded2b4a753ffb1bcd525baa56">00261</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__console_8c.html#a0d36cd7ded2b4a753ffb1bcd525baa56" title="Stream monitor thread.">stream_monitor</a>(<span class="keywordtype">void</span> *data)
<a name="l00262"></a>00262 {
<a name="l00263"></a>00263    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = data;
<a name="l00264"></a>00264    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="chan__console_8c.html#af0b23eedf2352de4c1eff77e1401730c" title="The number of samples to configure the portaudio stream for.">NUM_SAMPLES</a> * <span class="keyword">sizeof</span>(int16_t)];
<a name="l00265"></a>00265    PaError res;
<a name="l00266"></a>00266    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {
<a name="l00267"></a>00267       .<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>,
<a name="l00268"></a>00268       .subclass = <a class="code" href="frame_8h.html#a6e078550fcf3f2038f6c343b3d65a936">AST_FORMAT_SLINEAR16</a>,
<a name="l00269"></a>00269       .src = <span class="stringliteral">&quot;console_stream_monitor&quot;</span>,
<a name="l00270"></a>00270       .data.ptr = <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>,
<a name="l00271"></a>00271       .datalen = <span class="keyword">sizeof</span>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>),
<a name="l00272"></a>00272       .<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <span class="keyword">sizeof</span>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>) / <span class="keyword">sizeof</span>(int16_t),
<a name="l00273"></a>00273    };
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <span class="keywordflow">for</span> (;;) {
<a name="l00276"></a>00276       pthread_testcancel();
<a name="l00277"></a>00277       res = Pa_ReadStream(pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keyword">sizeof</span>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>) / <span class="keyword">sizeof</span>(int16_t));
<a name="l00278"></a>00278       pthread_testcancel();
<a name="l00279"></a>00279 
<a name="l00280"></a>00280       <span class="keywordflow">if</span> (res == paNoError)
<a name="l00281"></a>00281          <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00282"></a>00282    }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284    <span class="keywordflow">return</span> NULL;
<a name="l00285"></a>00285 }
<a name="l00286"></a>00286 
<a name="l00287"></a><a class="code" href="chan__console_8c.html#a254f8565c71f5d7f88de4c6e5083c9c2">00287</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a254f8565c71f5d7f88de4c6e5083c9c2">open_stream</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt)
<a name="l00288"></a>00288 {
<a name="l00289"></a>00289    <span class="keywordtype">int</span> res = paInternalError;
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <span class="keywordflow">if</span> (!strcasecmp(pvt-&gt;input_device, <span class="stringliteral">&quot;default&quot;</span>) &amp;&amp; 
<a name="l00292"></a>00292       !strcasecmp(pvt-&gt;output_device, <span class="stringliteral">&quot;default&quot;</span>)) {
<a name="l00293"></a>00293       res = Pa_OpenDefaultStream(&amp;pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>, <a class="code" href="chan__console_8c.html#a81ec44a9cf8d6d8abc80975382b5b26b" title="Mono Input.">INPUT_CHANNELS</a>, <a class="code" href="chan__console_8c.html#a4d4855d9b709af9628540e41e5ebb925" title="Mono Output.">OUTPUT_CHANNELS</a>, 
<a name="l00294"></a>00294          paInt16, <a class="code" href="chan__console_8c.html#a4b76a0c2859cfd819a343a780070ee2b" title="The sample rate to request from PortAudio.">SAMPLE_RATE</a>, <a class="code" href="chan__console_8c.html#af0b23eedf2352de4c1eff77e1401730c" title="The number of samples to configure the portaudio stream for.">NUM_SAMPLES</a>, NULL, NULL);
<a name="l00295"></a>00295    } <span class="keywordflow">else</span> {
<a name="l00296"></a>00296       PaStreamParameters input_params = { 
<a name="l00297"></a>00297          .channelCount = 1,
<a name="l00298"></a>00298          .sampleFormat = paInt16,
<a name="l00299"></a>00299          .suggestedLatency = (1.0 / 50.0), <span class="comment">/* 20 ms */</span>
<a name="l00300"></a>00300          .device = paNoDevice,
<a name="l00301"></a>00301       };
<a name="l00302"></a>00302       PaStreamParameters output_params = { 
<a name="l00303"></a>00303          .channelCount = 1, 
<a name="l00304"></a>00304          .sampleFormat = paInt16,
<a name="l00305"></a>00305          .suggestedLatency = (1.0 / 50.0), <span class="comment">/* 20 ms */</span>
<a name="l00306"></a>00306          .device = paNoDevice,
<a name="l00307"></a>00307       };
<a name="l00308"></a>00308       PaDeviceIndex idx, num_devices, def_input, def_output;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310       <span class="keywordflow">if</span> (!(num_devices = Pa_GetDeviceCount()))
<a name="l00311"></a>00311          <span class="keywordflow">return</span> res;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313       def_input = Pa_GetDefaultInputDevice();
<a name="l00314"></a>00314       def_output = Pa_GetDefaultOutputDevice();
<a name="l00315"></a>00315 
<a name="l00316"></a>00316       <span class="keywordflow">for</span> (idx = 0; 
<a name="l00317"></a>00317          idx &lt; num_devices &amp;&amp; (input_params.device == paNoDevice 
<a name="l00318"></a>00318             || output_params.device == paNoDevice); 
<a name="l00319"></a>00319          idx++) 
<a name="l00320"></a>00320       {
<a name="l00321"></a>00321          <span class="keyword">const</span> PaDeviceInfo *dev = Pa_GetDeviceInfo(idx);
<a name="l00322"></a>00322 
<a name="l00323"></a>00323          <span class="keywordflow">if</span> (dev-&gt;maxInputChannels) {
<a name="l00324"></a>00324             <span class="keywordflow">if</span> ( (idx == def_input &amp;&amp; !strcasecmp(pvt-&gt;input_device, <span class="stringliteral">&quot;default&quot;</span>)) ||
<a name="l00325"></a>00325                !strcasecmp(pvt-&gt;input_device, dev-&gt;name) )
<a name="l00326"></a>00326                input_params.device = idx;
<a name="l00327"></a>00327          }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329          <span class="keywordflow">if</span> (dev-&gt;maxOutputChannels) {
<a name="l00330"></a>00330             <span class="keywordflow">if</span> ( (idx == def_output &amp;&amp; !strcasecmp(pvt-&gt;output_device, <span class="stringliteral">&quot;default&quot;</span>)) ||
<a name="l00331"></a>00331                !strcasecmp(pvt-&gt;output_device, dev-&gt;name) )
<a name="l00332"></a>00332                output_params.device = idx;
<a name="l00333"></a>00333          }
<a name="l00334"></a>00334       }
<a name="l00335"></a>00335 
<a name="l00336"></a>00336       <span class="keywordflow">if</span> (input_params.device == paNoDevice)
<a name="l00337"></a>00337          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No input device found for console device &apos;%s&apos;\n&quot;</span>, pvt-&gt;name);
<a name="l00338"></a>00338       <span class="keywordflow">if</span> (output_params.device == paNoDevice)
<a name="l00339"></a>00339          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No output device found for console device &apos;%s&apos;\n&quot;</span>, pvt-&gt;name);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341       res = Pa_OpenStream(&amp;pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>, &amp;input_params, &amp;output_params,
<a name="l00342"></a>00342          <a class="code" href="chan__console_8c.html#a4b76a0c2859cfd819a343a780070ee2b" title="The sample rate to request from PortAudio.">SAMPLE_RATE</a>, <a class="code" href="chan__console_8c.html#af0b23eedf2352de4c1eff77e1401730c" title="The number of samples to configure the portaudio stream for.">NUM_SAMPLES</a>, paNoFlag, NULL, NULL);
<a name="l00343"></a>00343    }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345    <span class="keywordflow">return</span> res;
<a name="l00346"></a>00346 }
<a name="l00347"></a>00347 
<a name="l00348"></a><a class="code" href="chan__console_8c.html#afaa74e7dcf38f97e628cf0369d4ee3c8">00348</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#afaa74e7dcf38f97e628cf0369d4ee3c8">start_stream</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt)
<a name="l00349"></a>00349 {
<a name="l00350"></a>00350    PaError res;
<a name="l00351"></a>00351    <span class="keywordtype">int</span> ret_val = 0;
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l00354"></a>00354 
<a name="l00355"></a>00355    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#a64af28acef456ada84fa80f90adae03e">streamstate</a>)
<a name="l00356"></a>00356       <span class="keywordflow">goto</span> return_unlock;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358    pvt-&gt;<a class="code" href="structconsole__pvt.html#a64af28acef456ada84fa80f90adae03e">streamstate</a> = 1;
<a name="l00359"></a>00359    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Starting stream\n&quot;</span>);
<a name="l00360"></a>00360 
<a name="l00361"></a>00361    res = <a class="code" href="chan__console_8c.html#a254f8565c71f5d7f88de4c6e5083c9c2">open_stream</a>(pvt);
<a name="l00362"></a>00362    <span class="keywordflow">if</span> (res != paNoError) {
<a name="l00363"></a>00363       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open stream - (%d) %s\n&quot;</span>,
<a name="l00364"></a>00364          res, Pa_GetErrorText(res));
<a name="l00365"></a>00365       ret_val = -1;
<a name="l00366"></a>00366       <span class="keywordflow">goto</span> return_unlock;
<a name="l00367"></a>00367    }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    res = Pa_StartStream(pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>);
<a name="l00370"></a>00370    <span class="keywordflow">if</span> (res != paNoError) {
<a name="l00371"></a>00371       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to start stream - (%d) %s\n&quot;</span>,
<a name="l00372"></a>00372          res, Pa_GetErrorText(res));
<a name="l00373"></a>00373       ret_val = -1;
<a name="l00374"></a>00374       <span class="keywordflow">goto</span> return_unlock;
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;pvt-&gt;<a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>, NULL, <a class="code" href="chan__console_8c.html#a0d36cd7ded2b4a753ffb1bcd525baa56" title="Stream monitor thread.">stream_monitor</a>, pvt)) {
<a name="l00378"></a>00378       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to start stream monitor thread\n&quot;</span>);
<a name="l00379"></a>00379       ret_val = -1;
<a name="l00380"></a>00380    }
<a name="l00381"></a>00381 
<a name="l00382"></a>00382 return_unlock:
<a name="l00383"></a>00383    <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385    <span class="keywordflow">return</span> ret_val;
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 
<a name="l00388"></a><a class="code" href="chan__console_8c.html#a8767185d9587b817f7a2a0d81113eb6a">00388</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a8767185d9587b817f7a2a0d81113eb6a">stop_stream</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt)
<a name="l00389"></a>00389 {
<a name="l00390"></a>00390    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structconsole__pvt.html#a64af28acef456ada84fa80f90adae03e">streamstate</a> || pvt-&gt;<a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l00391"></a>00391       <span class="keywordflow">return</span> 0;
<a name="l00392"></a>00392 
<a name="l00393"></a>00393    pthread_cancel(pvt-&gt;<a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>);
<a name="l00394"></a>00394    pthread_kill(pvt-&gt;<a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>, SIGURG);
<a name="l00395"></a>00395    pthread_join(pvt-&gt;<a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>, NULL);
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l00398"></a>00398    Pa_AbortStream(pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>);
<a name="l00399"></a>00399    Pa_CloseStream(pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>);
<a name="l00400"></a>00400    pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a> = NULL;
<a name="l00401"></a>00401    pvt-&gt;<a class="code" href="structconsole__pvt.html#a64af28acef456ada84fa80f90adae03e">streamstate</a> = 0;
<a name="l00402"></a>00402    <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <span class="keywordflow">return</span> 0;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 <span class="comment"></span>
<a name="l00407"></a>00407 <span class="comment">/*!</span>
<a name="l00408"></a>00408 <span class="comment"> * \note Called with the pvt struct locked</span>
<a name="l00409"></a>00409 <span class="comment"> */</span>
<a name="l00410"></a><a class="code" href="chan__console_8c.html#a6fd78982d480770c7f580029549b3550">00410</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__console_8c.html#a6fd78982d480770c7f580029549b3550">console_new</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *ctx, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l00411"></a>00411 {
<a name="l00412"></a>00412    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(1, state, pvt-&gt;cid_num, pvt-&gt;cid_name, NULL, 
<a name="l00415"></a>00415       ext, ctx, 0, <span class="stringliteral">&quot;Console/%s&quot;</span>, pvt-&gt;name))) {
<a name="l00416"></a>00416       <span class="keywordflow">return</span> NULL;
<a name="l00417"></a>00417    }
<a name="l00418"></a>00418 
<a name="l00419"></a>00419    chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> = &amp;console_tech;
<a name="l00420"></a>00420    chan-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = <a class="code" href="frame_8h.html#a6e078550fcf3f2038f6c343b3d65a936">AST_FORMAT_SLINEAR16</a>;
<a name="l00421"></a>00421    chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = <a class="code" href="frame_8h.html#a6e078550fcf3f2038f6c343b3d65a936">AST_FORMAT_SLINEAR16</a>;
<a name="l00422"></a>00422    chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = <a class="code" href="frame_8h.html#a6e078550fcf3f2038f6c343b3d65a936">AST_FORMAT_SLINEAR16</a>;
<a name="l00423"></a>00423    chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = <a class="code" href="chan__console_8c.html#a321d877e577b1fa3359e8df4e313bd9d">ref_pvt</a>(pvt);
<a name="l00424"></a>00424 
<a name="l00425"></a>00425    pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = chan;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pvt-&gt;language))
<a name="l00428"></a>00428       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, pvt-&gt;language);
<a name="l00429"></a>00429 
<a name="l00430"></a>00430    <a class="code" href="abstract__jb_8h.html#a0981c84ac90dd79bc2a0fdd90aa6efba" title="Configures a jitterbuffer on a channel.">ast_jb_configure</a>(chan, &amp;<a class="code" href="chan__console_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    <span class="keywordflow">if</span> (state != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>) {
<a name="l00433"></a>00433       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(chan)) {
<a name="l00434"></a>00434          chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = <a class="code" href="causes_8h.html#a02b3785262e0be6843e8e9d235d8d78d">AST_CAUSE_SWITCH_CONGESTION</a>;
<a name="l00435"></a>00435          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l00436"></a>00436          chan = NULL;
<a name="l00437"></a>00437       } <span class="keywordflow">else</span>
<a name="l00438"></a>00438          <a class="code" href="chan__console_8c.html#afaa74e7dcf38f97e628cf0369d4ee3c8">start_stream</a>(pvt);
<a name="l00439"></a>00439    }
<a name="l00440"></a>00440 
<a name="l00441"></a>00441    <span class="keywordflow">return</span> chan;
<a name="l00442"></a>00442 }
<a name="l00443"></a>00443 
<a name="l00444"></a><a class="code" href="chan__console_8c.html#a916ad1d9bece65ae509735d1d0427e11">00444</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__console_8c.html#a916ad1d9bece65ae509735d1d0427e11">console_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>)
<a name="l00445"></a>00445 {
<a name="l00446"></a>00446    <span class="keywordtype">int</span> oldformat = format;
<a name="l00447"></a>00447    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> = NULL;
<a name="l00448"></a>00448    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (!(pvt = <a class="code" href="chan__console_8c.html#acf620738e814c1eba7b3087899469cc0">find_pvt</a>(data))) {
<a name="l00451"></a>00451       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Console device &apos;%s&apos; not found\n&quot;</span>, (<span class="keywordtype">char</span> *) data);
<a name="l00452"></a>00452       <span class="keywordflow">return</span> NULL;
<a name="l00453"></a>00453    }
<a name="l00454"></a>00454 
<a name="l00455"></a>00455    format &amp;= <a class="code" href="chan__console_8c.html#aa2645f8b7ada9ab80dbe210be9beb53e" title="Formats natively supported by this module.">SUPPORTED_FORMATS</a>;
<a name="l00456"></a>00456    <span class="keywordflow">if</span> (!format) {
<a name="l00457"></a>00457       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Channel requested with unsupported format(s): &apos;%d&apos;\n&quot;</span>, oldformat);
<a name="l00458"></a>00458       <span class="keywordflow">goto</span> return_unref;
<a name="l00459"></a>00459    }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l00462"></a>00462       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Console channel already active!\n&quot;</span>);
<a name="l00463"></a>00463       *cause = <a class="code" href="causes_8h.html#ae009c193522491f7de7ea28b23f20868">AST_CAUSE_BUSY</a>;
<a name="l00464"></a>00464       <span class="keywordflow">goto</span> return_unref;
<a name="l00465"></a>00465    }
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l00468"></a>00468    chan = <a class="code" href="chan__console_8c.html#a6fd78982d480770c7f580029549b3550">console_new</a>(pvt, NULL, NULL, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>);
<a name="l00469"></a>00469    <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="keywordflow">if</span> (!chan)
<a name="l00472"></a>00472       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create new Console channel!\n&quot;</span>);
<a name="l00473"></a>00473 
<a name="l00474"></a>00474 return_unref:
<a name="l00475"></a>00475    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477    <span class="keywordflow">return</span> chan;
<a name="l00478"></a>00478 }
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="chan__console_8c.html#a8186789bce79b6ec8a283dd477ba1547">00480</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a8186789bce79b6ec8a283dd477ba1547">console_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Console Received Beginning of Digit %c&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>, digit);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <span class="keywordflow">return</span> -1; <span class="comment">/* non-zero to request inband audio */</span>
<a name="l00485"></a>00485 }
<a name="l00486"></a>00486 
<a name="l00487"></a><a class="code" href="chan__console_8c.html#aedd41b2e60d386c190d51c6b0fce4e05">00487</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#aedd41b2e60d386c190d51c6b0fce4e05">console_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l00488"></a>00488 {
<a name="l00489"></a>00489    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Console Received End of Digit %c (duration %u)&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>, 
<a name="l00490"></a>00490       digit, duration);
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="keywordflow">return</span> -1; <span class="comment">/* non-zero to request inband audio */</span>
<a name="l00493"></a>00493 }
<a name="l00494"></a>00494 
<a name="l00495"></a><a class="code" href="chan__console_8c.html#aba7a748a03a1a6254ad77470a60ceed2">00495</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#aba7a748a03a1a6254ad77470a60ceed2">console_text</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)
<a name="l00496"></a>00496 {
<a name="l00497"></a>00497    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Console Received Text &apos;%s&apos;&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>, text);
<a name="l00498"></a>00498 
<a name="l00499"></a>00499    <span class="keywordflow">return</span> 0;
<a name="l00500"></a>00500 }
<a name="l00501"></a>00501 
<a name="l00502"></a><a class="code" href="chan__console_8c.html#a9834dcd1519346dd7012b0e64c9130f3">00502</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a9834dcd1519346dd7012b0e64c9130f3">console_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c)
<a name="l00503"></a>00503 {
<a name="l00504"></a>00504    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Hangup on Console&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508    pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a> = 0;
<a name="l00509"></a>00509    pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l00510"></a>00510    <a class="code" href="chan__console_8c.html#a8767185d9587b817f7a2a0d81113eb6a">stop_stream</a>(pvt);
<a name="l00511"></a>00511 
<a name="l00512"></a>00512    c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00513"></a>00513 
<a name="l00514"></a>00514    <span class="keywordflow">return</span> 0;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="chan__console_8c.html#a99c2ffd09d0561bc46582f1a3a32e0e1">00517</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a99c2ffd09d0561bc46582f1a3a32e0e1">console_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Call from Console has been Answered&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(c, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l00524"></a>00524 
<a name="l00525"></a>00525    <span class="keywordflow">return</span> <a class="code" href="chan__console_8c.html#afaa74e7dcf38f97e628cf0369d4ee3c8">start_stream</a>(pvt);
<a name="l00526"></a>00526 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 <span class="comment">/*</span>
<a name="l00529"></a>00529 <span class="comment"> * \brief Implementation of the ast_channel_tech read() callback</span>
<a name="l00530"></a>00530 <span class="comment"> *</span>
<a name="l00531"></a>00531 <span class="comment"> * Calling this function is harmless.  However, if it does get called, it</span>
<a name="l00532"></a>00532 <span class="comment"> * is an indication that something weird happened that really shouldn&apos;t</span>
<a name="l00533"></a>00533 <span class="comment"> * have and is worth looking into.</span>
<a name="l00534"></a>00534 <span class="comment"> * </span>
<a name="l00535"></a>00535 <span class="comment"> * Why should this function not get called?  Well, let me explain.  There are</span>
<a name="l00536"></a>00536 <span class="comment"> * a couple of ways to pass on audio that has come from this channel.  The way</span>
<a name="l00537"></a>00537 <span class="comment"> * that this channel driver uses is that once the audio is available, it is</span>
<a name="l00538"></a>00538 <span class="comment"> * wrapped in an ast_frame and queued onto the channel using ast_queue_frame().</span>
<a name="l00539"></a>00539 <span class="comment"> *</span>
<a name="l00540"></a>00540 <span class="comment"> * The other method would be signalling to the core that there is audio waiting,</span>
<a name="l00541"></a>00541 <span class="comment"> * and that it needs to call the channel&apos;s read() callback to get it.  The way</span>
<a name="l00542"></a>00542 <span class="comment"> * the channel gets signalled is that one or more file descriptors are placed</span>
<a name="l00543"></a>00543 <span class="comment"> * in the fds array on the ast_channel which the core will poll() on.  When the</span>
<a name="l00544"></a>00544 <span class="comment"> * fd indicates that input is available, the read() callback is called.  This</span>
<a name="l00545"></a>00545 <span class="comment"> * is especially useful when there is a dedicated file descriptor where the</span>
<a name="l00546"></a>00546 <span class="comment"> * audio is read from.  An example would be the socket for an RTP stream.</span>
<a name="l00547"></a>00547 <span class="comment"> */</span>
<a name="l00548"></a><a class="code" href="chan__console_8c.html#a89fd210a07c95a682f8098fb80274478">00548</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__console_8c.html#a89fd210a07c95a682f8098fb80274478">console_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I should not be called ...\n&quot;</span>);
<a name="l00551"></a>00551 
<a name="l00552"></a>00552    <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l00553"></a>00553 }
<a name="l00554"></a>00554 
<a name="l00555"></a><a class="code" href="chan__console_8c.html#aa023b2b67bddc8d8ce409df2ff74f6ec">00555</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#aa023b2b67bddc8d8ce409df2ff74f6ec">console_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout)
<a name="l00556"></a>00556 {
<a name="l00557"></a>00557    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { 0, };
<a name="l00558"></a>00558    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Call to device &apos;%s&apos; on console from &apos;%s&apos; &lt;%s&gt;&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>,
<a name="l00561"></a>00561       dest, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>);
<a name="l00562"></a>00562 
<a name="l00563"></a>00563    <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a>) {
<a name="l00566"></a>00566       pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a> = 1;
<a name="l00567"></a>00567       <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l00568"></a>00568       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Auto-answered&quot;</span> V_END);
<a name="l00569"></a>00569       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>;
<a name="l00570"></a>00570       f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>;
<a name="l00571"></a>00571    } <span class="keywordflow">else</span> {
<a name="l00572"></a>00572       <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l00573"></a>00573       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Type &apos;console answer&apos; to answer, or use the &apos;autoanswer&apos; option &quot;</span>
<a name="l00574"></a>00574             <span class="stringliteral">&quot;for future calls&quot;</span> V_END);
<a name="l00575"></a>00575       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>;
<a name="l00576"></a>00576       f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>;
<a name="l00577"></a>00577       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(c, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l00578"></a>00578    }
<a name="l00579"></a>00579 
<a name="l00580"></a>00580    <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(c, &amp;f);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582    <span class="keywordflow">return</span> <a class="code" href="chan__console_8c.html#afaa74e7dcf38f97e628cf0369d4ee3c8">start_stream</a>(pvt);
<a name="l00583"></a>00583 }
<a name="l00584"></a>00584 
<a name="l00585"></a><a class="code" href="chan__console_8c.html#a88f55ebcdc5e71d72454b048f4995990">00585</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a88f55ebcdc5e71d72454b048f4995990">console_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *f)
<a name="l00586"></a>00586 {
<a name="l00587"></a>00587    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    Pa_WriteStream(pvt-&gt;<a class="code" href="structconsole__pvt.html#aa2fbdaf8db29dee4b723a45b890cd92a">stream</a>, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>);
<a name="l00590"></a>00590 
<a name="l00591"></a>00591    <span class="keywordflow">return</span> 0;
<a name="l00592"></a>00592 }
<a name="l00593"></a>00593 
<a name="l00594"></a><a class="code" href="chan__console_8c.html#a858d85d2099015670ab0e2532cb61e42">00594</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a858d85d2099015670ab0e2532cb61e42">console_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen)
<a name="l00595"></a>00595 {
<a name="l00596"></a>00596    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00597"></a>00597    <span class="keywordtype">int</span> res = 0;
<a name="l00598"></a>00598 
<a name="l00599"></a>00599    <span class="keywordflow">switch</span> (cond) {
<a name="l00600"></a>00600    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>:
<a name="l00601"></a>00601    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>:
<a name="l00602"></a>00602    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>:
<a name="l00603"></a>00603    <span class="keywordflow">case</span> -1:
<a name="l00604"></a>00604       res = -1;  <span class="comment">/* Ask for inband indications */</span>
<a name="l00605"></a>00605       <span class="keywordflow">break</span>;
<a name="l00606"></a>00606    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd">AST_CONTROL_PROGRESS</a>:
<a name="l00607"></a>00607    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a50b7fe33bba67b74dd7b746539e81000">AST_CONTROL_PROCEEDING</a>:
<a name="l00608"></a>00608    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>:
<a name="l00609"></a>00609    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a009e81151b19671f42b5e84ab6a619f4">AST_CONTROL_SRCUPDATE</a>:
<a name="l00610"></a>00610       <span class="keywordflow">break</span>;
<a name="l00611"></a>00611    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l00612"></a>00612       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Console Has Been Placed on Hold&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>);
<a name="l00613"></a>00613       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, data, pvt-&gt;mohinterpret);
<a name="l00614"></a>00614       <span class="keywordflow">break</span>;
<a name="l00615"></a>00615    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>:
<a name="l00616"></a>00616       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;Console Has Been Retrieved from Hold&quot;</span> V_END);
<a name="l00617"></a>00617       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l00618"></a>00618       <span class="keywordflow">break</span>;
<a name="l00619"></a>00619    <span class="keywordflow">default</span>:
<a name="l00620"></a>00620       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to display condition %d on %s\n&quot;</span>, 
<a name="l00621"></a>00621          cond, chan-&gt;name);
<a name="l00622"></a>00622       <span class="comment">/* The core will play inband indications for us if appropriate */</span>
<a name="l00623"></a>00623       res = -1;
<a name="l00624"></a>00624    }
<a name="l00625"></a>00625 
<a name="l00626"></a>00626    <span class="keywordflow">return</span> res;
<a name="l00627"></a>00627 }
<a name="l00628"></a>00628 
<a name="l00629"></a><a class="code" href="chan__console_8c.html#acc72dc0d3c70bf2f646aee5a38232956">00629</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#acc72dc0d3c70bf2f646aee5a38232956">console_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan)
<a name="l00630"></a>00630 {
<a name="l00631"></a>00631    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = newchan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633    pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = newchan;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635    <span class="keywordflow">return</span> 0;
<a name="l00636"></a>00636 }
<a name="l00637"></a>00637 <span class="comment"></span>
<a name="l00638"></a>00638 <span class="comment">/*!</span>
<a name="l00639"></a>00639 <span class="comment"> * split a string in extension-context, returns pointers to malloc&apos;ed</span>
<a name="l00640"></a>00640 <span class="comment"> * strings.</span>
<a name="l00641"></a>00641 <span class="comment"> * If we do not have &apos;overridecontext&apos; then the last @ is considered as</span>
<a name="l00642"></a>00642 <span class="comment"> * a context separator, and the context is overridden.</span>
<a name="l00643"></a>00643 <span class="comment"> * This is usually not very necessary as you can play with the dialplan,</span>
<a name="l00644"></a>00644 <span class="comment"> * and it is nice not to need it because you have &apos;@&apos; in SIP addresses.</span>
<a name="l00645"></a>00645 <span class="comment"> * Return value is the buffer address.</span>
<a name="l00646"></a>00646 <span class="comment"> *</span>
<a name="l00647"></a>00647 <span class="comment"> * \note came from chan_oss</span>
<a name="l00648"></a>00648 <span class="comment"> */</span>
<a name="l00649"></a><a class="code" href="chan__console_8c.html#a0c59b17c122f75812a2f84030270ddb6">00649</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a0c59b17c122f75812a2f84030270ddb6">ast_ext_ctx</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt, <span class="keyword">const</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">char</span> **<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keywordtype">char</span> **ctx)
<a name="l00650"></a>00650 {
<a name="l00651"></a>00651    <span class="keywordflow">if</span> (ext == NULL || ctx == NULL)
<a name="l00652"></a>00652       <span class="keywordflow">return</span> NULL;         <span class="comment">/* error */</span>
<a name="l00653"></a>00653 
<a name="l00654"></a>00654    *ext = *ctx = NULL;
<a name="l00655"></a>00655 
<a name="l00656"></a>00656    <span class="keywordflow">if</span> (src &amp;&amp; *src != <span class="charliteral">&apos;\0&apos;</span>)
<a name="l00657"></a>00657       *ext = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(src);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659    <span class="keywordflow">if</span> (*ext == NULL)
<a name="l00660"></a>00660       <span class="keywordflow">return</span> NULL;
<a name="l00661"></a>00661 
<a name="l00662"></a>00662    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a>) {
<a name="l00663"></a>00663       <span class="comment">/* parse from the right */</span>
<a name="l00664"></a>00664       *ctx = strrchr(*ext, <span class="charliteral">&apos;@&apos;</span>);
<a name="l00665"></a>00665       <span class="keywordflow">if</span> (*ctx)
<a name="l00666"></a>00666          *(*ctx)++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00667"></a>00667    }
<a name="l00668"></a>00668 
<a name="l00669"></a>00669    <span class="keywordflow">return</span> *ext;
<a name="l00670"></a>00670 }
<a name="l00671"></a>00671 
<a name="l00672"></a><a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">00672</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *<a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>(<span class="keywordtype">void</span>)
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;active_lock);
<a name="l00677"></a>00677    pvt = <a class="code" href="chan__console_8c.html#a321d877e577b1fa3359e8df4e313bd9d">ref_pvt</a>(active_pvt); 
<a name="l00678"></a>00678    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;active_lock);
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    <span class="keywordflow">return</span> pvt;
<a name="l00681"></a>00681 }
<a name="l00682"></a>00682 
<a name="l00683"></a><a class="code" href="chan__console_8c.html#a8cb5648cadd9936a3822dc0d5a8228f0">00683</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a8cb5648cadd9936a3822dc0d5a8228f0">cli_console_autoanswer</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, 
<a name="l00684"></a>00684    <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00685"></a>00685 {
<a name="l00686"></a>00686    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l00687"></a>00687    <span class="keywordtype">char</span> *res = <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689    <span class="keywordflow">switch</span> (cmd) {
<a name="l00690"></a>00690    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00691"></a>00691       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console {set|show} autoanswer [on|off]&quot;</span>;
<a name="l00692"></a>00692       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00693"></a>00693          <span class="stringliteral">&quot;Usage: console {set|show} autoanswer [on|off]\n&quot;</span>
<a name="l00694"></a>00694          <span class="stringliteral">&quot;       Enables or disables autoanswer feature.  If used without\n&quot;</span>
<a name="l00695"></a>00695          <span class="stringliteral">&quot;       argument, displays the current on/off status of autoanswer.\n&quot;</span>
<a name="l00696"></a>00696          <span class="stringliteral">&quot;       The default value of autoanswer is in &apos;oss.conf&apos;.\n&quot;</span>;
<a name="l00697"></a>00697       <span class="keywordflow">return</span> NULL;
<a name="l00698"></a>00698 
<a name="l00699"></a>00699    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00700"></a>00700       <span class="keywordflow">return</span> NULL;
<a name="l00701"></a>00701    }
<a name="l00702"></a>00702 
<a name="l00703"></a>00703    <span class="keywordflow">if</span> (!pvt) {
<a name="l00704"></a>00704       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is set as active.\n&quot;</span>);
<a name="l00705"></a>00705       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00706"></a>00706    }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1) {
<a name="l00709"></a>00709       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Auto answer is %s.\n&quot;</span>, pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a> ? <span class="stringliteral">&quot;on&quot;</span> : <span class="stringliteral">&quot;off&quot;</span>);
<a name="l00710"></a>00710       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00711"></a>00711       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00712"></a>00712    }
<a name="l00713"></a>00713 
<a name="l00714"></a>00714    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {
<a name="l00715"></a>00715       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00716"></a>00716       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00717"></a>00717    }
<a name="l00718"></a>00718 
<a name="l00719"></a>00719    <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;on&quot;</span>))
<a name="l00720"></a>00720       pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a> = 1;
<a name="l00721"></a>00721    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;off&quot;</span>))
<a name="l00722"></a>00722       pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a> = 0;
<a name="l00723"></a>00723    <span class="keywordflow">else</span>
<a name="l00724"></a>00724       res = <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00725"></a>00725 
<a name="l00726"></a>00726    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00727"></a>00727 
<a name="l00728"></a>00728    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00729"></a>00729 }
<a name="l00730"></a>00730 
<a name="l00731"></a><a class="code" href="chan__console_8c.html#ae5252e31ce514b3296db73ec62a6b83e">00731</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#ae5252e31ce514b3296db73ec62a6b83e">cli_console_flash</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00732"></a>00732 {
<a name="l00733"></a>00733    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a> };
<a name="l00734"></a>00734    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l00735"></a>00735 
<a name="l00736"></a>00736    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l00737"></a>00737       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console flash&quot;</span>;
<a name="l00738"></a>00738       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00739"></a>00739          <span class="stringliteral">&quot;Usage: console flash\n&quot;</span>
<a name="l00740"></a>00740          <span class="stringliteral">&quot;       Flashes the call currently placed on the console.\n&quot;</span>;
<a name="l00741"></a>00741       <span class="keywordflow">return</span> NULL;
<a name="l00742"></a>00742    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l00743"></a>00743       <span class="keywordflow">return</span> NULL;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745    <span class="keywordflow">if</span> (!pvt) {
<a name="l00746"></a>00746       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is set as active\n&quot;</span>);
<a name="l00747"></a>00747       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00748"></a>00748    }
<a name="l00749"></a>00749 
<a name="l00750"></a>00750    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00751"></a>00751       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00752"></a>00752 
<a name="l00753"></a>00753    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l00754"></a>00754       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No call to flash\n&quot;</span>);
<a name="l00755"></a>00755       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00756"></a>00756       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00757"></a>00757    }
<a name="l00758"></a>00758 
<a name="l00759"></a>00759    pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a> = 0;
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00762"></a>00762 
<a name="l00763"></a>00763    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00764"></a>00764 
<a name="l00765"></a>00765    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00766"></a>00766 }
<a name="l00767"></a>00767 
<a name="l00768"></a><a class="code" href="chan__console_8c.html#ad8db1423a759784ea5c975d271d2e2df">00768</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#ad8db1423a759784ea5c975d271d2e2df">cli_console_dial</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00769"></a>00769 {
<a name="l00770"></a>00770    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l00771"></a>00771    <span class="keyword">const</span> <span class="keywordtype">char</span> *mye = NULL, *myc = NULL; 
<a name="l00772"></a>00772    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l00773"></a>00773 
<a name="l00774"></a>00774    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l00775"></a>00775       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console dial&quot;</span>;
<a name="l00776"></a>00776       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00777"></a>00777          <span class="stringliteral">&quot;Usage: console dial [extension[@context]]\n&quot;</span>
<a name="l00778"></a>00778          <span class="stringliteral">&quot;       Dials a given extension (and context if specified)\n&quot;</span>;
<a name="l00779"></a>00779       <span class="keywordflow">return</span> NULL;
<a name="l00780"></a>00780    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l00781"></a>00781       <span class="keywordflow">return</span> NULL;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    <span class="keywordflow">if</span> (!pvt) {
<a name="l00784"></a>00784       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is currently set as active\n&quot;</span>);
<a name="l00785"></a>00785       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00786"></a>00786    }
<a name="l00787"></a>00787    
<a name="l00788"></a>00788    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l00789"></a>00789       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) { <span class="comment">/* already in a call */</span>
<a name="l00792"></a>00792       <span class="keywordtype">int</span> i;
<a name="l00793"></a>00793       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>, 0 };
<a name="l00794"></a>00794 
<a name="l00795"></a>00795       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {  <span class="comment">/* argument is mandatory here */</span>
<a name="l00796"></a>00796          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Already in a call. You can only dial digits until you hangup.\n&quot;</span>);
<a name="l00797"></a>00797          <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00798"></a>00798          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00799"></a>00799       }
<a name="l00800"></a>00800       s = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>];
<a name="l00801"></a>00801       <span class="comment">/* send the string one char at a time */</span>
<a name="l00802"></a>00802       <span class="keywordflow">for</span> (i = 0; i &lt; strlen(s); i++) {
<a name="l00803"></a>00803          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = s[i];
<a name="l00804"></a>00804          <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l00805"></a>00805       }
<a name="l00806"></a>00806       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00807"></a>00807       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00808"></a>00808    }
<a name="l00809"></a>00809 
<a name="l00810"></a>00810    <span class="comment">/* if we have an argument split it into extension and context */</span>
<a name="l00811"></a>00811    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1) {
<a name="l00812"></a>00812       <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a> = NULL, *con = NULL;
<a name="l00813"></a>00813       s = <a class="code" href="chan__console_8c.html#a0c59b17c122f75812a2f84030270ddb6">ast_ext_ctx</a>(pvt, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>], &amp;ext, &amp;con);
<a name="l00814"></a>00814       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;provided &apos;%s&apos;, exten &apos;%s&apos; context &apos;%s&apos;\n&quot;</span>, 
<a name="l00815"></a>00815          a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>], mye, myc);
<a name="l00816"></a>00816       mye = ext;
<a name="l00817"></a>00817       myc = con;
<a name="l00818"></a>00818    }
<a name="l00819"></a>00819 
<a name="l00820"></a>00820    <span class="comment">/* supply default values if needed */</span>
<a name="l00821"></a>00821    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mye))
<a name="l00822"></a>00822       mye = pvt-&gt;exten;
<a name="l00823"></a>00823    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(myc))
<a name="l00824"></a>00824       myc = pvt-&gt;context;
<a name="l00825"></a>00825 
<a name="l00826"></a>00826    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, myc, mye, 1, NULL)) {
<a name="l00827"></a>00827       <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l00828"></a>00828       pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a> = 1;
<a name="l00829"></a>00829       <a class="code" href="chan__console_8c.html#a6fd78982d480770c7f580029549b3550">console_new</a>(pvt, mye, myc, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>);
<a name="l00830"></a>00830       <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l00831"></a>00831    } <span class="keywordflow">else</span>
<a name="l00832"></a>00832       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such extension &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, mye, myc);
<a name="l00833"></a>00833 
<a name="l00834"></a>00834    <span class="keywordflow">if</span> (s)
<a name="l00835"></a>00835       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(s);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00838"></a>00838 
<a name="l00839"></a>00839    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 
<a name="l00842"></a><a class="code" href="chan__console_8c.html#a45c8774a609f4f94780eb78d44b45e50">00842</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a45c8774a609f4f94780eb78d44b45e50">cli_console_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00843"></a>00843 {
<a name="l00844"></a>00844    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l00845"></a>00845 
<a name="l00846"></a>00846    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l00847"></a>00847       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console hangup&quot;</span>;
<a name="l00848"></a>00848       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00849"></a>00849          <span class="stringliteral">&quot;Usage: console hangup\n&quot;</span>
<a name="l00850"></a>00850          <span class="stringliteral">&quot;       Hangs up any call currently placed on the console.\n&quot;</span>;
<a name="l00851"></a>00851       <span class="keywordflow">return</span> NULL;
<a name="l00852"></a>00852    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l00853"></a>00853       <span class="keywordflow">return</span> NULL;
<a name="l00854"></a>00854 
<a name="l00855"></a>00855    <span class="keywordflow">if</span> (!pvt) {
<a name="l00856"></a>00856       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is set as active\n&quot;</span>);
<a name="l00857"></a>00857       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00858"></a>00858    }
<a name="l00859"></a>00859    
<a name="l00860"></a>00860    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00861"></a>00861       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; !pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a>) {
<a name="l00864"></a>00864       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No call to hang up\n&quot;</span>);
<a name="l00865"></a>00865       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00866"></a>00866       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00867"></a>00867    }
<a name="l00868"></a>00868 
<a name="l00869"></a>00869    pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a> = 0;
<a name="l00870"></a>00870    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l00871"></a>00871       <a class="code" href="channel_8h.html#a30bcf0418189567bc84ff32034f79f28" title="Queue a hangup frame.">ast_queue_hangup</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00876"></a>00876 }
<a name="l00877"></a>00877 
<a name="l00878"></a><a class="code" href="chan__console_8c.html#a4863e9c6ad80cd9767948347875490e6">00878</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a4863e9c6ad80cd9767948347875490e6">cli_console_mute</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00879"></a>00879 {
<a name="l00880"></a>00880    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00881"></a>00881    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l00882"></a>00882    <span class="keywordtype">char</span> *res = <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00883"></a>00883 
<a name="l00884"></a>00884    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l00885"></a>00885       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console {mute|unmute}&quot;</span>;
<a name="l00886"></a>00886       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00887"></a>00887          <span class="stringliteral">&quot;Usage: console {mute|unmute}\n&quot;</span>
<a name="l00888"></a>00888          <span class="stringliteral">&quot;       Mute/unmute the microphone.\n&quot;</span>;
<a name="l00889"></a>00889       <span class="keywordflow">return</span> NULL;
<a name="l00890"></a>00890    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l00891"></a>00891       <span class="keywordflow">return</span> NULL;
<a name="l00892"></a>00892 
<a name="l00893"></a>00893    <span class="keywordflow">if</span> (!pvt) {
<a name="l00894"></a>00894       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is set as active\n&quot;</span>);
<a name="l00895"></a>00895       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00896"></a>00896    }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00899"></a>00899       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901    s = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1];
<a name="l00902"></a>00902    <span class="keywordflow">if</span> (!strcasecmp(s, <span class="stringliteral">&quot;mute&quot;</span>))
<a name="l00903"></a>00903       pvt-&gt;<a class="code" href="structconsole__pvt.html#a18a3a8f373661dd2e20ddb9035abead2">muted</a> = 1;
<a name="l00904"></a>00904    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(s, <span class="stringliteral">&quot;unmute&quot;</span>))
<a name="l00905"></a>00905       pvt-&gt;<a class="code" href="structconsole__pvt.html#a18a3a8f373661dd2e20ddb9035abead2">muted</a> = 0;
<a name="l00906"></a>00906    <span class="keywordflow">else</span>
<a name="l00907"></a>00907       res = <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00908"></a>00908 
<a name="l00909"></a>00909    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(1, <a class="code" href="chan__console_8c.html#a069c3864fd2590e5b91eacc2eae8f402" title="Dance, Kirby, Dance!">V_BEGIN</a> <span class="stringliteral">&quot;The Console is now %s&quot;</span> <a class="code" href="chan__console_8c.html#ab465acade7930ebddfae67eab169aba4">V_END</a>, 
<a name="l00910"></a>00910       pvt-&gt;<a class="code" href="structconsole__pvt.html#a18a3a8f373661dd2e20ddb9035abead2">muted</a> ? <span class="stringliteral">&quot;Muted&quot;</span> : <span class="stringliteral">&quot;Unmuted&quot;</span>);
<a name="l00911"></a>00911 
<a name="l00912"></a>00912    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l00913"></a>00913 
<a name="l00914"></a>00914    <span class="keywordflow">return</span> res;
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="chan__console_8c.html#a8ce31176ad953128f2b3f0872e10ead9">00917</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a8ce31176ad953128f2b3f0872e10ead9">cli_list_available</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919    PaDeviceIndex idx, <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>, def_input, def_output;
<a name="l00920"></a>00920 
<a name="l00921"></a>00921    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l00922"></a>00922       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console list available&quot;</span>;
<a name="l00923"></a>00923       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00924"></a>00924          <span class="stringliteral">&quot;Usage: console list available\n&quot;</span>
<a name="l00925"></a>00925          <span class="stringliteral">&quot;       List all available devices.\n&quot;</span>;
<a name="l00926"></a>00926       <span class="keywordflow">return</span> NULL;
<a name="l00927"></a>00927    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l00928"></a>00928       <span class="keywordflow">return</span> NULL;
<a name="l00929"></a>00929 
<a name="l00930"></a>00930    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00931"></a>00931       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00932"></a>00932 
<a name="l00933"></a>00933    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00934"></a>00934                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l00935"></a>00935                <span class="stringliteral">&quot;=== Available Devices =======================================\n&quot;</span>
<a name="l00936"></a>00936                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l00937"></a>00937                <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l00938"></a>00938 
<a name="l00939"></a>00939    num = Pa_GetDeviceCount();
<a name="l00940"></a>00940    <span class="keywordflow">if</span> (!num) {
<a name="l00941"></a>00941       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;(None)\n&quot;</span>);
<a name="l00942"></a>00942       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00943"></a>00943    }
<a name="l00944"></a>00944 
<a name="l00945"></a>00945    def_input = Pa_GetDefaultInputDevice();
<a name="l00946"></a>00946    def_output = Pa_GetDefaultOutputDevice();
<a name="l00947"></a>00947    <span class="keywordflow">for</span> (idx = 0; idx &lt; num; idx++) {
<a name="l00948"></a>00948       <span class="keyword">const</span> PaDeviceInfo *dev = Pa_GetDeviceInfo(idx);
<a name="l00949"></a>00949       <span class="keywordflow">if</span> (!dev)
<a name="l00950"></a>00950          <span class="keywordflow">continue</span>;
<a name="l00951"></a>00951       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span>
<a name="l00952"></a>00952                      <span class="stringliteral">&quot;=== Device Name: %s\n&quot;</span>, dev-&gt;name);
<a name="l00953"></a>00953       <span class="keywordflow">if</span> (dev-&gt;maxInputChannels)
<a name="l00954"></a>00954          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---&gt; %sInput Device\n&quot;</span>, (idx == def_input) ? <span class="stringliteral">&quot;Default &quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00955"></a>00955       <span class="keywordflow">if</span> (dev-&gt;maxOutputChannels)
<a name="l00956"></a>00956          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---&gt; %sOutput Device\n&quot;</span>, (idx == def_output) ? <span class="stringliteral">&quot;Default &quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00957"></a>00957       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n===\n&quot;</span>);
<a name="l00958"></a>00958    }
<a name="l00959"></a>00959 
<a name="l00960"></a>00960    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=============================================================\n\n&quot;</span>);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00963"></a>00963 }
<a name="l00964"></a>00964 
<a name="l00965"></a><a class="code" href="chan__console_8c.html#a7de455a4f1910a80513ef2ec714794ed">00965</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a7de455a4f1910a80513ef2ec714794ed">cli_list_devices</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00966"></a>00966 {
<a name="l00967"></a>00967    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l00968"></a>00968    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l00969"></a>00969 
<a name="l00970"></a>00970    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l00971"></a>00971       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console list devices&quot;</span>;
<a name="l00972"></a>00972       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00973"></a>00973          <span class="stringliteral">&quot;Usage: console list devices\n&quot;</span>
<a name="l00974"></a>00974          <span class="stringliteral">&quot;       List all configured devices.\n&quot;</span>;
<a name="l00975"></a>00975       <span class="keywordflow">return</span> NULL;
<a name="l00976"></a>00976    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l00977"></a>00977       <span class="keywordflow">return</span> NULL;
<a name="l00978"></a>00978 
<a name="l00979"></a>00979    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00980"></a>00980       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00983"></a>00983                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l00984"></a>00984                <span class="stringliteral">&quot;=== Configured Devices ======================================\n&quot;</span>
<a name="l00985"></a>00985                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l00986"></a>00986                <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l00987"></a>00987 
<a name="l00988"></a>00988    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(pvts, 0);
<a name="l00989"></a>00989    <span class="keywordflow">while</span> ((pvt = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l00990"></a>00990       <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span>
<a name="l00993"></a>00993                      <span class="stringliteral">&quot;=== Device Name: %s\n&quot;</span>
<a name="l00994"></a>00994                      <span class="stringliteral">&quot;=== ---&gt; Active:           %s\n&quot;</span>
<a name="l00995"></a>00995                      <span class="stringliteral">&quot;=== ---&gt; Input Device:     %s\n&quot;</span>
<a name="l00996"></a>00996                      <span class="stringliteral">&quot;=== ---&gt; Output Device:    %s\n&quot;</span>
<a name="l00997"></a>00997                      <span class="stringliteral">&quot;=== ---&gt; Context:          %s\n&quot;</span>
<a name="l00998"></a>00998                      <span class="stringliteral">&quot;=== ---&gt; Extension:        %s\n&quot;</span>
<a name="l00999"></a>00999                      <span class="stringliteral">&quot;=== ---&gt; CallerID Num:     %s\n&quot;</span>
<a name="l01000"></a>01000                      <span class="stringliteral">&quot;=== ---&gt; CallerID Name:    %s\n&quot;</span>
<a name="l01001"></a>01001                      <span class="stringliteral">&quot;=== ---&gt; MOH Interpret:    %s\n&quot;</span>
<a name="l01002"></a>01002                      <span class="stringliteral">&quot;=== ---&gt; Language:         %s\n&quot;</span>
<a name="l01003"></a>01003                      <span class="stringliteral">&quot;=== ---&gt; Parkinglot:       %s\n&quot;</span>
<a name="l01004"></a>01004                      <span class="stringliteral">&quot;=== ---&gt; Muted:            %s\n&quot;</span>
<a name="l01005"></a>01005                      <span class="stringliteral">&quot;=== ---&gt; Auto-Answer:      %s\n&quot;</span>
<a name="l01006"></a>01006                      <span class="stringliteral">&quot;=== ---&gt; Override Context: %s\n&quot;</span>
<a name="l01007"></a>01007                      <span class="stringliteral">&quot;=== ---------------------------------------------------------\n===\n&quot;</span>,
<a name="l01008"></a>01008          pvt-&gt;name, (pvt == active_pvt) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l01009"></a>01009          pvt-&gt;input_device, pvt-&gt;output_device, pvt-&gt;context,
<a name="l01010"></a>01010          pvt-&gt;exten, pvt-&gt;cid_num, pvt-&gt;cid_name, pvt-&gt;mohinterpret,
<a name="l01011"></a>01011          pvt-&gt;language, pvt-&gt;parkinglot, pvt-&gt;<a class="code" href="structconsole__pvt.html#a18a3a8f373661dd2e20ddb9035abead2">muted</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>, pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l01012"></a>01012          pvt-&gt;<a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014       <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l01015"></a>01015       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01016"></a>01016    }
<a name="l01017"></a>01017    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=============================================================\n\n&quot;</span>);
<a name="l01020"></a>01020 
<a name="l01021"></a>01021    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01022"></a>01022 }<span class="comment"></span>
<a name="l01023"></a>01023 <span class="comment">/*!</span>
<a name="l01024"></a>01024 <span class="comment"> * \brief answer command from the console</span>
<a name="l01025"></a>01025 <span class="comment"> */</span>
<a name="l01026"></a><a class="code" href="chan__console_8c.html#a538e5129485302740b0528565b13dd15">01026</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a538e5129485302740b0528565b13dd15" title="answer command from the console">cli_console_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01027"></a>01027 {
<a name="l01028"></a>01028    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a> };
<a name="l01029"></a>01029    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    <span class="keywordflow">switch</span> (cmd) {
<a name="l01032"></a>01032    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01033"></a>01033       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console answer&quot;</span>;
<a name="l01034"></a>01034       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01035"></a>01035          <span class="stringliteral">&quot;Usage: console answer\n&quot;</span>
<a name="l01036"></a>01036          <span class="stringliteral">&quot;       Answers an incoming call on the console channel.\n&quot;</span>;
<a name="l01037"></a>01037       <span class="keywordflow">return</span> NULL;
<a name="l01038"></a>01038 
<a name="l01039"></a>01039    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01040"></a>01040       <span class="keywordflow">return</span> NULL;   <span class="comment">/* no completion */</span>
<a name="l01041"></a>01041    }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043    <span class="keywordflow">if</span> (!pvt) {
<a name="l01044"></a>01044       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is set as active\n&quot;</span>);
<a name="l01045"></a>01045       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01046"></a>01046    }
<a name="l01047"></a>01047 
<a name="l01048"></a>01048    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {
<a name="l01049"></a>01049       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01050"></a>01050       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01051"></a>01051    }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01054"></a>01054       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No one is calling us\n&quot;</span>);
<a name="l01055"></a>01055       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01056"></a>01056       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01057"></a>01057    }
<a name="l01058"></a>01058 
<a name="l01059"></a>01059    pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a> = 1;
<a name="l01060"></a>01060 
<a name="l01061"></a>01061    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, -1);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063    <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01066"></a>01066 
<a name="l01067"></a>01067    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01068"></a>01068 }
<a name="l01069"></a>01069 <span class="comment"></span>
<a name="l01070"></a>01070 <span class="comment">/*!</span>
<a name="l01071"></a>01071 <span class="comment"> * \brief Console send text CLI command</span>
<a name="l01072"></a>01072 <span class="comment"> *</span>
<a name="l01073"></a>01073 <span class="comment"> * \note concatenate all arguments into a single string. argv is NULL-terminated</span>
<a name="l01074"></a>01074 <span class="comment"> * so we can use it right away</span>
<a name="l01075"></a>01075 <span class="comment"> */</span>
<a name="l01076"></a><a class="code" href="chan__console_8c.html#a2e516187cb82628d0dca75170f60ee11">01076</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#a2e516187cb82628d0dca75170f60ee11" title="Console send text CLI command.">cli_console_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01077"></a>01077 {
<a name="l01078"></a>01078    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="chan__console_8c.html#afb6f36d91ffbf947cfa3f1114ca79764" title="Maximum text message length.">TEXT_SIZE</a>];
<a name="l01079"></a>01079    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l01080"></a>01080    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = {
<a name="l01081"></a>01081       .<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>,
<a name="l01082"></a>01082       .data.ptr = buf,
<a name="l01083"></a>01083       .src = <span class="stringliteral">&quot;console_send_text&quot;</span>,
<a name="l01084"></a>01084    };
<a name="l01085"></a>01085    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01086"></a>01086 
<a name="l01087"></a>01087    <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>) {
<a name="l01088"></a>01088       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console send text&quot;</span>;
<a name="l01089"></a>01089       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01090"></a>01090          <span class="stringliteral">&quot;Usage: console send text &lt;message&gt;\n&quot;</span>
<a name="l01091"></a>01091          <span class="stringliteral">&quot;       Sends a text message for display on the remote terminal.\n&quot;</span>;
<a name="l01092"></a>01092       <span class="keywordflow">return</span> NULL;
<a name="l01093"></a>01093    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>)
<a name="l01094"></a>01094       <span class="keywordflow">return</span> NULL;
<a name="l01095"></a>01095 
<a name="l01096"></a>01096    <span class="keywordflow">if</span> (!pvt) {
<a name="l01097"></a>01097       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No console device is set as active\n&quot;</span>);
<a name="l01098"></a>01098       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01099"></a>01099    }
<a name="l01100"></a>01100 
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1) {
<a name="l01102"></a>01102       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01103"></a>01103       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01104"></a>01104    }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01107"></a>01107       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Not in a call\n&quot;</span>);
<a name="l01108"></a>01108       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01109"></a>01109       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01110"></a>01110    }
<a name="l01111"></a>01111 
<a name="l01112"></a>01112    <a class="code" href="strings_8h.html#a0c9c27a9e6b4a6d1e2b868525ae3d0c1">ast_join</a>(buf, <span class="keyword">sizeof</span>(buf) - 1, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a> + e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>);
<a name="l01113"></a>01113    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(buf)) {
<a name="l01114"></a>01114       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01115"></a>01115       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01116"></a>01116    }
<a name="l01117"></a>01117 
<a name="l01118"></a>01118    len = strlen(buf);
<a name="l01119"></a>01119    buf[len] = <span class="charliteral">&apos;\n&apos;</span>;
<a name="l01120"></a>01120    f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = len + 1;
<a name="l01121"></a>01121 
<a name="l01122"></a>01122    <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(pvt-&gt;<a class="code" href="structconsole__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, &amp;f);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01125"></a>01125 
<a name="l01126"></a>01126    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01127"></a>01127 }
<a name="l01128"></a>01128 
<a name="l01129"></a><a class="code" href="chan__console_8c.html#ab19a005f2e29438d4457b4e368162df3">01129</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#ab19a005f2e29438d4457b4e368162df3">set_active</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l01130"></a>01130 {
<a name="l01131"></a>01131    <span class="keywordflow">if</span> (pvt == &amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>) {
<a name="l01132"></a>01132       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;active is only valid as a per-device setting\n&quot;</span>);
<a name="l01133"></a>01133       <span class="keywordflow">return</span>;
<a name="l01134"></a>01134    }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value))
<a name="l01137"></a>01137       <span class="keywordflow">return</span>;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;active_lock);
<a name="l01140"></a>01140    <span class="keywordflow">if</span> (active_pvt)
<a name="l01141"></a>01141       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(active_pvt);
<a name="l01142"></a>01142    active_pvt = <a class="code" href="chan__console_8c.html#a321d877e577b1fa3359e8df4e313bd9d">ref_pvt</a>(pvt);
<a name="l01143"></a>01143    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;active_lock);
<a name="l01144"></a>01144 }
<a name="l01145"></a>01145 
<a name="l01146"></a><a class="code" href="chan__console_8c.html#ab88bab4c64bb3ecc55b1422bf0b0c41a">01146</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__console_8c.html#ab88bab4c64bb3ecc55b1422bf0b0c41a">cli_console_active</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01147"></a>01147 {
<a name="l01148"></a>01148    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l01149"></a>01149 
<a name="l01150"></a>01150    <span class="keywordflow">switch</span> (cmd) {
<a name="l01151"></a>01151    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01152"></a>01152       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;console {set|show} active [&lt;device&gt;]&quot;</span>;
<a name="l01153"></a>01153       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01154"></a>01154          <span class="stringliteral">&quot;Usage: console {set|show} active [&lt;device&gt;]\n&quot;</span>
<a name="l01155"></a>01155          <span class="stringliteral">&quot;       Set or show the active console device for the Asterisk CLI.\n&quot;</span>;
<a name="l01156"></a>01156       <span class="keywordflow">return</span> NULL;
<a name="l01157"></a>01157    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01158"></a>01158       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) {
<a name="l01159"></a>01159          <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l01160"></a>01160          <span class="keywordtype">int</span> x = 0;
<a name="l01161"></a>01161          <span class="keywordtype">char</span> *res = NULL;
<a name="l01162"></a>01162          i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(pvts, 0);
<a name="l01163"></a>01163          <span class="keywordflow">while</span> ((pvt = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l01164"></a>01164             <span class="keywordflow">if</span> (++x &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &amp;&amp; !strncasecmp(pvt-&gt;name, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>)))
<a name="l01165"></a>01165                res = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(pvt-&gt;name);
<a name="l01166"></a>01166             <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01167"></a>01167             <span class="keywordflow">if</span> (res) {
<a name="l01168"></a>01168                <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01169"></a>01169                <span class="keywordflow">return</span> res;
<a name="l01170"></a>01170             }
<a name="l01171"></a>01171          }
<a name="l01172"></a>01172          <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01173"></a>01173       }
<a name="l01174"></a>01174       <span class="keywordflow">return</span> NULL;
<a name="l01175"></a>01175    }
<a name="l01176"></a>01176 
<a name="l01177"></a>01177    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l01178"></a>01178       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01179"></a>01179 
<a name="l01180"></a>01180    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {
<a name="l01181"></a>01181       pvt = <a class="code" href="chan__console_8c.html#ad12c10af3f15f064db0929165ee99518">get_active_pvt</a>();
<a name="l01182"></a>01182 
<a name="l01183"></a>01183       <span class="keywordflow">if</span> (!pvt)
<a name="l01184"></a>01184          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No device is currently set as the active console device.\n&quot;</span>);
<a name="l01185"></a>01185       <span class="keywordflow">else</span> {
<a name="l01186"></a>01186          <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l01187"></a>01187          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;The active console device is &apos;%s&apos;.\n&quot;</span>, pvt-&gt;name);
<a name="l01188"></a>01188          <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l01189"></a>01189          pvt = <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01190"></a>01190       }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01193"></a>01193    }
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="keywordflow">if</span> (!(pvt = <a class="code" href="chan__console_8c.html#acf620738e814c1eba7b3087899469cc0">find_pvt</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]))) {
<a name="l01196"></a>01196       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Could not find a device called &apos;%s&apos;.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>]);
<a name="l01197"></a>01197       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01198"></a>01198    }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200    <a class="code" href="chan__console_8c.html#ab19a005f2e29438d4457b4e368162df3">set_active</a>(pvt, <span class="stringliteral">&quot;yes&quot;</span>);
<a name="l01201"></a>01201 
<a name="l01202"></a>01202    <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l01203"></a>01203    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;The active console device has been set to &apos;%s&apos;\n&quot;</span>, pvt-&gt;name);
<a name="l01204"></a>01204    <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l01205"></a>01205 
<a name="l01206"></a>01206    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01209"></a>01209 }
<a name="l01210"></a>01210 
<a name="l01211"></a><a class="code" href="chan__console_8c.html#abb2885aeb7ccca3bc1a0944c239e2109">01211</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="chan__console_8c.html#abb2885aeb7ccca3bc1a0944c239e2109">cli_console</a>[] = {
<a name="l01212"></a>01212    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#ad8db1423a759784ea5c975d271d2e2df">cli_console_dial</a>,       <span class="stringliteral">&quot;Dial an extension from the console&quot;</span>),
<a name="l01213"></a>01213    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a45c8774a609f4f94780eb78d44b45e50">cli_console_hangup</a>,     <span class="stringliteral">&quot;Hangup a call on the console&quot;</span>),
<a name="l01214"></a>01214    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a4863e9c6ad80cd9767948347875490e6">cli_console_mute</a>,       <span class="stringliteral">&quot;Disable/Enable mic input&quot;</span>),
<a name="l01215"></a>01215    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a538e5129485302740b0528565b13dd15" title="answer command from the console">cli_console_answer</a>,     <span class="stringliteral">&quot;Answer an incoming console call&quot;</span>),
<a name="l01216"></a>01216    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a2e516187cb82628d0dca75170f60ee11" title="Console send text CLI command.">cli_console_sendtext</a>,   <span class="stringliteral">&quot;Send text to a connected party&quot;</span>),
<a name="l01217"></a>01217    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#ae5252e31ce514b3296db73ec62a6b83e">cli_console_flash</a>,      <span class="stringliteral">&quot;Send a flash to the connected party&quot;</span>),
<a name="l01218"></a>01218    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a8cb5648cadd9936a3822dc0d5a8228f0">cli_console_autoanswer</a>, <span class="stringliteral">&quot;Turn autoanswer on or off&quot;</span>),
<a name="l01219"></a>01219    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a8ce31176ad953128f2b3f0872e10ead9">cli_list_available</a>,     <span class="stringliteral">&quot;List available devices&quot;</span>),
<a name="l01220"></a>01220    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#a7de455a4f1910a80513ef2ec714794ed">cli_list_devices</a>,       <span class="stringliteral">&quot;List configured devices&quot;</span>),
<a name="l01221"></a>01221    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__console_8c.html#ab88bab4c64bb3ecc55b1422bf0b0c41a">cli_console_active</a>,     <span class="stringliteral">&quot;View or Set the active console device&quot;</span>),
<a name="l01222"></a>01222 };
<a name="l01223"></a>01223 <span class="comment"></span>
<a name="l01224"></a>01224 <span class="comment">/*!</span>
<a name="l01225"></a>01225 <span class="comment"> * \brief Set default values for a pvt struct</span>
<a name="l01226"></a>01226 <span class="comment"> *</span>
<a name="l01227"></a>01227 <span class="comment"> * \note This function expects the pvt lock to be held.</span>
<a name="l01228"></a>01228 <span class="comment"> */</span>
<a name="l01229"></a><a class="code" href="chan__console_8c.html#a39239ffa32dd7251d6a631fbb29cc67c">01229</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#a39239ffa32dd7251d6a631fbb29cc67c" title="Set default values for a pvt struct.">set_pvt_defaults</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt)
<a name="l01230"></a>01230 {
<a name="l01231"></a>01231    <span class="keywordflow">if</span> (pvt == &amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>) {
<a name="l01232"></a>01232       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l01233"></a>01233       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l01234"></a>01234       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;s&quot;</span>);
<a name="l01235"></a>01235       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01236"></a>01236       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01237"></a>01237       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01238"></a>01238       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01239"></a>01239    
<a name="l01240"></a>01240       pvt-&gt;<a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a> = 0;
<a name="l01241"></a>01241       pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a> = 0;
<a name="l01242"></a>01242    } <span class="keywordflow">else</span> {
<a name="l01243"></a>01243       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l01244"></a>01244 
<a name="l01245"></a>01245       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.mohinterpret);
<a name="l01246"></a>01246       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.context);
<a name="l01247"></a>01247       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.exten);
<a name="l01248"></a>01248       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.language);
<a name="l01249"></a>01249       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.cid_num);
<a name="l01250"></a>01250       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.cid_name);
<a name="l01251"></a>01251       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>, <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.parkinglot);
<a name="l01252"></a>01252 
<a name="l01253"></a>01253       pvt-&gt;<a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a> = <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.<a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a>;
<a name="l01254"></a>01254       pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a> = <a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>.<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a>;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l01257"></a>01257    }
<a name="l01258"></a>01258 }
<a name="l01259"></a>01259 
<a name="l01260"></a><a class="code" href="chan__console_8c.html#afdcb335a1ef2c86fcca00495bfe72dfb">01260</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#afdcb335a1ef2c86fcca00495bfe72dfb">store_callerid</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l01261"></a>01261 {
<a name="l01262"></a>01262    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>[256];
<a name="l01263"></a>01263    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>[256];
<a name="l01264"></a>01264 
<a name="l01265"></a>01265    <a class="code" href="callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(value, cid_name, <span class="keyword">sizeof</span>(cid_name), 
<a name="l01266"></a>01266       cid_num, <span class="keyword">sizeof</span>(cid_num));
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, cid_name, cid_name);
<a name="l01269"></a>01269    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, cid_num, cid_num);
<a name="l01270"></a>01270 }
<a name="l01271"></a>01271 <span class="comment"></span>
<a name="l01272"></a>01272 <span class="comment">/*!</span>
<a name="l01273"></a>01273 <span class="comment"> * \brief Store a configuration parameter in a pvt struct</span>
<a name="l01274"></a>01274 <span class="comment"> *</span>
<a name="l01275"></a>01275 <span class="comment"> * \note This function expects the pvt lock to be held.</span>
<a name="l01276"></a>01276 <span class="comment"> */</span>
<a name="l01277"></a><a class="code" href="chan__console_8c.html#ac71bb54880195c1752121529dcb1eaa0">01277</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#ac71bb54880195c1752121529dcb1eaa0" title="Store a configuration parameter in a pvt struct.">store_config_core</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l01278"></a>01278 {
<a name="l01279"></a>01279    <span class="keywordflow">if</span> (pvt == &amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a> &amp;&amp; !<a class="code" href="abstract__jb_8h.html#ae50ad081bd2ae6b58bcfc4687916c586" title="Sets jitterbuffer configuration property.">ast_jb_read_conf</a>(&amp;<a class="code" href="chan__console_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>, var, value))
<a name="l01280"></a>01280       <span class="keywordflow">return</span>;
<a name="l01281"></a>01281 
<a name="l01282"></a>01282    <a class="code" href="config_8h.html#a32da71a793e99764383cb3eb2080a346" title="the macro to open a block for variable parsing">CV_START</a>(var, value);
<a name="l01283"></a>01283 
<a name="l01284"></a>01284    <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;context&quot;</span>, pvt, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01285"></a>01285    <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;extension&quot;</span>, pvt, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l01286"></a>01286    <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;mohinterpret&quot;</span>, pvt, <a class="code" href="chan__alsa_8c.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>);
<a name="l01287"></a>01287    <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;language&quot;</span>, pvt, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);
<a name="l01288"></a>01288    <a class="code" href="config_8h.html#a573667b0b56503ba54ed0fbbb227b8ab" title="call a generic function if the name matches.">CV_F</a>(<span class="stringliteral">&quot;callerid&quot;</span>, <a class="code" href="chan__console_8c.html#afdcb335a1ef2c86fcca00495bfe72dfb">store_callerid</a>(pvt, value));
<a name="l01289"></a>01289    <a class="code" href="config_8h.html#aafea033c0475a1369e75b63aa36bf4fb" title="helper macros to assign the value to a BOOL, UINT, static string and dynamic string...">CV_BOOL</a>(<span class="stringliteral">&quot;overridecontext&quot;</span>, pvt-&gt;<a class="code" href="structconsole__pvt.html#a799a3c05045a8c94905492664b428e6f">overridecontext</a>);
<a name="l01290"></a>01290    <a class="code" href="config_8h.html#aafea033c0475a1369e75b63aa36bf4fb" title="helper macros to assign the value to a BOOL, UINT, static string and dynamic string...">CV_BOOL</a>(<span class="stringliteral">&quot;autoanswer&quot;</span>, pvt-&gt;<a class="code" href="structconsole__pvt.html#adc681d8ae5bd664cc959dd10177750cd">autoanswer</a>);
<a name="l01291"></a>01291    <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;parkinglot&quot;</span>, pvt, <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>);
<a name="l01292"></a>01292 
<a name="l01293"></a>01293    <span class="keywordflow">if</span> (pvt != &amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>) {
<a name="l01294"></a>01294       <a class="code" href="config_8h.html#a573667b0b56503ba54ed0fbbb227b8ab" title="call a generic function if the name matches.">CV_F</a>(<span class="stringliteral">&quot;active&quot;</span>, <a class="code" href="chan__console_8c.html#ab19a005f2e29438d4457b4e368162df3">set_active</a>(pvt, value))
<a name="l01295"></a>01295       <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;input_device&quot;</span>, pvt, input_device);
<a name="l01296"></a>01296       <a class="code" href="config_8h.html#a41a52fecb7825ca2a3b4884777378e8d">CV_STRFIELD</a>(<span class="stringliteral">&quot;output_device&quot;</span>, pvt, output_device);
<a name="l01297"></a>01297    }
<a name="l01298"></a>01298 
<a name="l01299"></a>01299    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown option &apos;%s&apos;\n&quot;</span>, var);
<a name="l01300"></a>01300 
<a name="l01301"></a>01301    <a class="code" href="config_8h.html#a4529d9f44c4461f1d4b5bde4e968447e" title="close a variable parsing block">CV_END</a>;
<a name="l01302"></a>01302 }
<a name="l01303"></a>01303 
<a name="l01304"></a><a class="code" href="chan__console_8c.html#a47895ec4a3f05979c25af90125a8e4b5">01304</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#a47895ec4a3f05979c25af90125a8e4b5">pvt_destructor</a>(<span class="keywordtype">void</span> *obj)
<a name="l01305"></a>01305 {
<a name="l01306"></a>01306    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = obj;
<a name="l01307"></a>01307 
<a name="l01308"></a>01308    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(pvt);
<a name="l01309"></a>01309 }
<a name="l01310"></a>01310 
<a name="l01311"></a><a class="code" href="chan__console_8c.html#a5bf8b3a2b39de3a254c332c76b2def39">01311</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a5bf8b3a2b39de3a254c332c76b2def39">init_pvt</a>(<span class="keyword">struct</span> <a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l01312"></a>01312 {
<a name="l01313"></a>01313    pvt-&gt;<a class="code" href="structconsole__pvt.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l01314"></a>01314 
<a name="l01315"></a>01315    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(pvt, 32))
<a name="l01316"></a>01316       <span class="keywordflow">return</span> -1;
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(pvt, name, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(name, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01319"></a>01319 
<a name="l01320"></a>01320    <span class="keywordflow">return</span> 0;
<a name="l01321"></a>01321 }
<a name="l01322"></a>01322 
<a name="l01323"></a><a class="code" href="chan__console_8c.html#a27275c97408ecb26dc2121693bdf6bb6">01323</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#a27275c97408ecb26dc2121693bdf6bb6">build_device</a>(<span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l01324"></a>01324 {
<a name="l01325"></a>01325    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01326"></a>01326    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l01327"></a>01327    <span class="keywordtype">int</span> <span class="keyword">new</span> = 0;
<a name="l01328"></a>01328 
<a name="l01329"></a>01329    <span class="keywordflow">if</span> ((pvt = <a class="code" href="chan__console_8c.html#acf620738e814c1eba7b3087899469cc0">find_pvt</a>(name))) {
<a name="l01330"></a>01330       <a class="code" href="chan__console_8c.html#a2926ec66af35a43fe745de643bdf1313" title="lock a console_pvt struct">console_pvt_lock</a>(pvt);
<a name="l01331"></a>01331       <a class="code" href="chan__console_8c.html#a39239ffa32dd7251d6a631fbb29cc67c" title="Set default values for a pvt struct.">set_pvt_defaults</a>(pvt);
<a name="l01332"></a>01332       pvt-&gt;<a class="code" href="structconsole__pvt.html#ab16498ae4f96c29649dd52ac032e811d">destroy</a> = 0;
<a name="l01333"></a>01333    } <span class="keywordflow">else</span> {
<a name="l01334"></a>01334       <span class="keywordflow">if</span> (!(pvt = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*pvt), <a class="code" href="chan__console_8c.html#a47895ec4a3f05979c25af90125a8e4b5">pvt_destructor</a>)))
<a name="l01335"></a>01335          <span class="keywordflow">return</span>;
<a name="l01336"></a>01336       <a class="code" href="chan__console_8c.html#a5bf8b3a2b39de3a254c332c76b2def39">init_pvt</a>(pvt, name);
<a name="l01337"></a>01337       <a class="code" href="chan__console_8c.html#a39239ffa32dd7251d6a631fbb29cc67c" title="Set default values for a pvt struct.">set_pvt_defaults</a>(pvt);
<a name="l01338"></a>01338       <span class="keyword">new</span> = 1;
<a name="l01339"></a>01339    }
<a name="l01340"></a>01340 
<a name="l01341"></a>01341    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, name); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>)
<a name="l01342"></a>01342       <a class="code" href="chan__console_8c.html#ac71bb54880195c1752121529dcb1eaa0" title="Store a configuration parameter in a pvt struct.">store_config_core</a>(pvt, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01343"></a>01343 
<a name="l01344"></a>01344    <span class="keywordflow">if</span> (<span class="keyword">new</span>)
<a name="l01345"></a>01345       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(pvts, pvt);
<a name="l01346"></a>01346    <span class="keywordflow">else</span>
<a name="l01347"></a>01347       <a class="code" href="chan__console_8c.html#a59e2f0ef739b7b97a2e98c00907dbe8c" title="unlock a console_pvt struct">console_pvt_unlock</a>(pvt);
<a name="l01348"></a>01348    
<a name="l01349"></a>01349    <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01350"></a>01350 }
<a name="l01351"></a>01351 
<a name="l01352"></a><a class="code" href="chan__console_8c.html#acab9ea30dcb18cbafbf03dc61e919463">01352</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#acab9ea30dcb18cbafbf03dc61e919463">pvt_mark_destroy_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l01353"></a>01353 {
<a name="l01354"></a>01354    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = obj;
<a name="l01355"></a>01355    pvt-&gt;<a class="code" href="structconsole__pvt.html#ab16498ae4f96c29649dd52ac032e811d">destroy</a> = 1;
<a name="l01356"></a>01356    <span class="keywordflow">return</span> 0;
<a name="l01357"></a>01357 }
<a name="l01358"></a>01358 
<a name="l01359"></a><a class="code" href="chan__console_8c.html#a2b97e313bf53ae40e47a1b39ae571462">01359</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#a2b97e313bf53ae40e47a1b39ae571462">destroy_pvts</a>(<span class="keywordtype">void</span>)
<a name="l01360"></a>01360 {
<a name="l01361"></a>01361    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l01362"></a>01362    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l01363"></a>01363 
<a name="l01364"></a>01364    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(pvts, 0);
<a name="l01365"></a>01365    <span class="keywordflow">while</span> ((pvt = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l01366"></a>01366       <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#ab16498ae4f96c29649dd52ac032e811d">destroy</a>) {
<a name="l01367"></a>01367          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(pvts, pvt);
<a name="l01368"></a>01368          <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;active_lock);
<a name="l01369"></a>01369          <span class="keywordflow">if</span> (active_pvt == pvt)
<a name="l01370"></a>01370             active_pvt = <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01371"></a>01371          <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;active_lock);
<a name="l01372"></a>01372       }
<a name="l01373"></a>01373       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01374"></a>01374    }
<a name="l01375"></a>01375    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01376"></a>01376 }
<a name="l01377"></a>01377 <span class="comment"></span>
<a name="l01378"></a>01378 <span class="comment">/*!</span>
<a name="l01379"></a>01379 <span class="comment"> * \brief Load the configuration</span>
<a name="l01380"></a>01380 <span class="comment"> * \param reload if this was called due to a reload</span>
<a name="l01381"></a>01381 <span class="comment"> * \retval 0 success</span>
<a name="l01382"></a>01382 <span class="comment"> * \retval -1 failure</span>
<a name="l01383"></a>01383 <span class="comment"> */</span>
<a name="l01384"></a><a class="code" href="chan__console_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">01384</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#ad0f6114d9cab58a8ec3d9555cb466534" title="Load the configuration.">load_config</a>(<span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l01385"></a>01385 {
<a name="l01386"></a>01386    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01387"></a>01387    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01388"></a>01388    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l01389"></a>01389    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> = NULL;
<a name="l01390"></a>01390 
<a name="l01391"></a>01391    <span class="comment">/* default values */</span>
<a name="l01392"></a>01392    memcpy(&amp;<a class="code" href="chan__console_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>, &amp;default_jbconf, <span class="keyword">sizeof</span>(<a class="code" href="chan__console_8c.html#abaabcb7f4349cc632dde3af5c6a5e1bd">global_jbconf</a>));
<a name="l01393"></a>01393    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l01394"></a>01394    <a class="code" href="chan__console_8c.html#a39239ffa32dd7251d6a631fbb29cc67c" title="Set default values for a pvt struct.">set_pvt_defaults</a>(&amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>);
<a name="l01395"></a>01395    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l01396"></a>01396 
<a name="l01397"></a>01397    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config_file, config_flags))) {
<a name="l01398"></a>01398       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to open configuration file %s!\n&quot;</span>, config_file);
<a name="l01399"></a>01399       <span class="keywordflow">return</span> -1;
<a name="l01400"></a>01400    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01401"></a>01401       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Config file %s has an invalid format\n&quot;</span>, config_file);
<a name="l01402"></a>01402       <span class="keywordflow">return</span> -1;
<a name="l01403"></a>01403    }
<a name="l01404"></a>01404    
<a name="l01405"></a>01405    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(pvts, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="chan__console_8c.html#acab9ea30dcb18cbafbf03dc61e919463">pvt_mark_destroy_cb</a>, NULL);
<a name="l01406"></a>01406 
<a name="l01407"></a>01407    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l01408"></a>01408    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>)
<a name="l01409"></a>01409       <a class="code" href="chan__console_8c.html#ac71bb54880195c1752121529dcb1eaa0" title="Store a configuration parameter in a pvt struct.">store_config_core</a>(&amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01410"></a>01410    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__phoneprov_8c.html#ac5e1d00d9d447cc961b9e31a34a96507">globals_lock</a>);
<a name="l01411"></a>01411 
<a name="l01412"></a>01412    <span class="keywordflow">while</span> ((context = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, context))) {
<a name="l01413"></a>01413       <span class="keywordflow">if</span> (strcasecmp(context, <span class="stringliteral">&quot;general&quot;</span>))
<a name="l01414"></a>01414          <a class="code" href="chan__console_8c.html#a27275c97408ecb26dc2121693bdf6bb6">build_device</a>(cfg, context);
<a name="l01415"></a>01415    }
<a name="l01416"></a>01416 
<a name="l01417"></a>01417    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01418"></a>01418 
<a name="l01419"></a>01419    <a class="code" href="chan__console_8c.html#a2b97e313bf53ae40e47a1b39ae571462">destroy_pvts</a>();
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    <span class="keywordflow">return</span> 0;
<a name="l01422"></a>01422 }
<a name="l01423"></a>01423 
<a name="l01424"></a><a class="code" href="chan__console_8c.html#a4877104d2177d77b958bd056e18c045d">01424</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a4877104d2177d77b958bd056e18c045d">pvt_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01425"></a>01425 {
<a name="l01426"></a>01426    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = obj;
<a name="l01427"></a>01427 
<a name="l01428"></a>01428    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#ab08f8db2a7258e538a0da7417f58db58" title="Compute a hash value on a case-insensitive string.">ast_str_case_hash</a>(pvt-&gt;name);
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a><a class="code" href="chan__console_8c.html#a7e4ef107c232c0ea8aa3d22d442535df">01431</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#a7e4ef107c232c0ea8aa3d22d442535df">pvt_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l01432"></a>01432 {
<a name="l01433"></a>01433    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt = obj, *pvt2 = arg;
<a name="l01434"></a>01434 
<a name="l01435"></a>01435    <span class="keywordflow">return</span> !strcasecmp(pvt-&gt;name, pvt2-&gt;name) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l01436"></a>01436 }
<a name="l01437"></a>01437 
<a name="l01438"></a><a class="code" href="chan__console_8c.html#a2ecd901f043483b24d52e94ab69e4e88">01438</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__console_8c.html#a2ecd901f043483b24d52e94ab69e4e88">stop_streams</a>(<span class="keywordtype">void</span>)
<a name="l01439"></a>01439 {
<a name="l01440"></a>01440    <span class="keyword">struct </span><a class="code" href="structconsole__pvt.html" title="Console pvt structure.">console_pvt</a> *pvt;
<a name="l01441"></a>01441    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l01442"></a>01442 
<a name="l01443"></a>01443    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(pvts, 0);
<a name="l01444"></a>01444    <span class="keywordflow">while</span> ((pvt = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l01445"></a>01445       <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structconsole__pvt.html#a03fec2acb2227892e2d0ca184369f77b">hookstate</a>)
<a name="l01446"></a>01446          <a class="code" href="chan__console_8c.html#a8767185d9587b817f7a2a0d81113eb6a">stop_stream</a>(pvt);
<a name="l01447"></a>01447       <a class="code" href="chan__console_8c.html#a4eee943025afc3185045dcb0b5a3b987">unref_pvt</a>(pvt);
<a name="l01448"></a>01448    }
<a name="l01449"></a>01449    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01450"></a>01450 }
<a name="l01451"></a>01451 
<a name="l01452"></a><a class="code" href="chan__console_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01452</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454    <a class="code" href="channel_8h.html#a53b708b7fc71dcbcd33acae0ad4d7ef8" title="Unregister a channel technology.">ast_channel_unregister</a>(&amp;console_tech);
<a name="l01455"></a>01455    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_console, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_console));
<a name="l01456"></a>01456 
<a name="l01457"></a>01457    <a class="code" href="chan__console_8c.html#a2ecd901f043483b24d52e94ab69e4e88">stop_streams</a>();
<a name="l01458"></a>01458 
<a name="l01459"></a>01459    Pa_Terminate();
<a name="l01460"></a>01460 
<a name="l01461"></a>01461    <span class="comment">/* Will unref all the pvts so they will get destroyed, too */</span>
<a name="l01462"></a>01462    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvts, -1);
<a name="l01463"></a>01463 
<a name="l01464"></a>01464    <a class="code" href="chan__console_8c.html#a47895ec4a3f05979c25af90125a8e4b5">pvt_destructor</a>(&amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466    <span class="keywordflow">return</span> 0;
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a><a class="code" href="chan__console_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01469</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01470"></a>01470 {
<a name="l01471"></a>01471    PaError res;
<a name="l01472"></a>01472 
<a name="l01473"></a>01473    <a class="code" href="chan__console_8c.html#a5bf8b3a2b39de3a254c332c76b2def39">init_pvt</a>(&amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>, NULL);
<a name="l01474"></a>01474 
<a name="l01475"></a>01475    <span class="keywordflow">if</span> (!(pvts = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="chan__console_8c.html#a242c6c182abafb21beb43874f31493bc">NUM_PVT_BUCKETS</a>, <a class="code" href="chan__console_8c.html#a4877104d2177d77b958bd056e18c045d">pvt_hash_cb</a>, <a class="code" href="chan__console_8c.html#a7e4ef107c232c0ea8aa3d22d442535df">pvt_cmp_cb</a>)))
<a name="l01476"></a>01476       <span class="keywordflow">goto</span> return_error;
<a name="l01477"></a>01477 
<a name="l01478"></a>01478    <span class="keywordflow">if</span> (<a class="code" href="chan__console_8c.html#ad0f6114d9cab58a8ec3d9555cb466534" title="Load the configuration.">load_config</a>(0))
<a name="l01479"></a>01479       <span class="keywordflow">goto</span> return_error;
<a name="l01480"></a>01480 
<a name="l01481"></a>01481    res = Pa_Initialize();
<a name="l01482"></a>01482    <span class="keywordflow">if</span> (res != paNoError) {
<a name="l01483"></a>01483       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to initialize audio system - (%d) %s\n&quot;</span>,
<a name="l01484"></a>01484          res, Pa_GetErrorText(res));
<a name="l01485"></a>01485       <span class="keywordflow">goto</span> return_error_pa_init;
<a name="l01486"></a>01486    }
<a name="l01487"></a>01487 
<a name="l01488"></a>01488    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ab5f3776fda943e52820ceeee5835c1b4" title="Register a channel technology (a new channel driver) Called by a channel module to...">ast_channel_register</a>(&amp;console_tech)) {
<a name="l01489"></a>01489       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register channel type &apos;Console&apos;\n&quot;</span>);
<a name="l01490"></a>01490       <span class="keywordflow">goto</span> return_error_chan_reg;
<a name="l01491"></a>01491    }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493    <span class="keywordflow">if</span> (<a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_console, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_console)))
<a name="l01494"></a>01494       <span class="keywordflow">goto</span> return_error_cli_reg;
<a name="l01495"></a>01495 
<a name="l01496"></a>01496    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01497"></a>01497 
<a name="l01498"></a>01498 return_error_cli_reg:
<a name="l01499"></a>01499    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_console, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_console));
<a name="l01500"></a>01500 return_error_chan_reg:
<a name="l01501"></a>01501    <a class="code" href="channel_8h.html#a53b708b7fc71dcbcd33acae0ad4d7ef8" title="Unregister a channel technology.">ast_channel_unregister</a>(&amp;console_tech);
<a name="l01502"></a>01502 return_error_pa_init:
<a name="l01503"></a>01503    Pa_Terminate();
<a name="l01504"></a>01504 return_error:
<a name="l01505"></a>01505    <span class="keywordflow">if</span> (pvts)
<a name="l01506"></a>01506       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvts, -1);
<a name="l01507"></a>01507    pvts = NULL;
<a name="l01508"></a>01508    <a class="code" href="chan__console_8c.html#a47895ec4a3f05979c25af90125a8e4b5">pvt_destructor</a>(&amp;<a class="code" href="chan__console_8c.html#aa36e3e2c486b920b166c2d17c5242221" title="Console pvt structure.">globals</a>);
<a name="l01509"></a>01509 
<a name="l01510"></a>01510    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01511"></a>01511 }
<a name="l01512"></a>01512 
<a name="l01513"></a><a class="code" href="chan__console_8c.html#ad1982509765f4870f1f63412a53ea668">01513</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__console_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l01514"></a>01514 {
<a name="l01515"></a>01515    <span class="keywordflow">return</span> <a class="code" href="chan__console_8c.html#ad0f6114d9cab58a8ec3d9555cb466534" title="Load the configuration.">load_config</a>(1);
<a name="l01516"></a>01516 }
<a name="l01517"></a>01517 
<a name="l01518"></a>01518 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Console Channel Driver&quot;</span>,
<a name="l01519"></a>01519       .load = <a class="code" href="chan__console_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l01520"></a>01520       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l01521"></a>01521       .<a class="code" href="chan__console_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="chan__console_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l01522"></a>01522 );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:30 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
