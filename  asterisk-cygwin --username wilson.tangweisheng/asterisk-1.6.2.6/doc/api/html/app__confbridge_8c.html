<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:54 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_confbridge.c File Reference</h1>
<p>Conference Bridge application.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;stdio.h&gt;</code><br/>
<code>#include &lt;stdlib.h&gt;</code><br/>
<code>#include &lt;unistd.h&gt;</code><br/>
<code>#include &lt;string.h&gt;</code><br/>
<code>#include &lt;signal.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="logger_8h_source.html">asterisk/logger.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="bridging_8h_source.html">asterisk/bridging.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="musiconhold_8h_source.html">asterisk/musiconhold.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="say_8h_source.html">asterisk/say.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="audiohook_8h_source.html">asterisk/audiohook.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astobj2_8h_source.html">asterisk/astobj2.h</a>&quot;</code><br/>

<p><a href="app__confbridge_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structconference__bridge.html">conference_bridge</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The structure that represents a conference bridge.  <a href="structconference__bridge.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structconference__bridge__user.html">conference_bridge_user</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The structure that represents a conference bridge <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a>.  <a href="structconference__bridge__user.html#_details">More...</a><br/></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a52a0e4c83c7ff4b0e7b1a4ec096d3419">CONFERENCE_BRIDGE_BUCKETS</a>&nbsp;&nbsp;&nbsp;53</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#af06136a3da0a98829d389f3d061bc8e8">MAX_CONF_NAME</a>&nbsp;&nbsp;&nbsp;32</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <br/>
&nbsp;&nbsp;<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8">OPTION_ADMIN</a> =  (1 &lt;&lt; 0), 
<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a3edf63531f6aaab8f4c54b1c633001e0">OPTION_MENU</a> =  (1 &lt;&lt; 1), 
<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a> =  (1 &lt;&lt; 2), 
<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a96c908c57e1804edef831ce961258d88">OPTION_NOONLYPERSON</a> =  (1 &lt;&lt; 3), 
<br/>
&nbsp;&nbsp;<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04ab9f10f68ab5ee0ad976db98ce321530f">OPTION_STARTMUTED</a> =  (1 &lt;&lt; 4), 
<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04ab3d3d664ddd8b1e2cdfaf34efcc01c4f">OPTION_ANNOUNCEUSERCOUNT</a> =  (1 &lt;&lt; 5), 
<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a> =  (1 &lt;&lt; 6), 
<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a83858d53c27d46d338330fb0175809f3">OPTION_WAITMARKED</a> =  (1 &lt;&lt; 7), 
<br/>
&nbsp;&nbsp;<a class="el" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a> =  (1 &lt;&lt; 8)
<br/>
 }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>, 
<a class="el" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6fbb37a6285376b28be858fd442cd46b">OPTION_ARRAY_SIZE</a>
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a5e6676d2b4d985b8fb2f0ecb3c46c5ee">announce_user_count</a> (struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *<a class="el" href="structconference__bridge.html">conference_bridge</a>, struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *<a class="el" href="structconference__bridge__user.html">conference_bridge_user</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Announce <a class="el" href="structnumber.html" title="Number structure.">number</a> of <a class="el" href="structusers.html" title="list of users found in the config file">users</a> in the conference bridge to the caller.  <a href="#a5e6676d2b4d985b8fb2f0ecb3c46c5ee"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a312a753890c96c227a52de53c4ffd682">AST_APP_OPTIONS</a> (app_opts,{AST_APP_OPTION('A', OPTION_MARKEDUSER), AST_APP_OPTION('a', OPTION_ADMIN), AST_APP_OPTION('c', OPTION_ANNOUNCEUSERCOUNT), AST_APP_OPTION('m', OPTION_STARTMUTED), AST_APP_OPTION_ARG('M', OPTION_MUSICONHOLD, OPTION_MUSICONHOLD_CLASS), AST_APP_OPTION('1', OPTION_NOONLYPERSON), AST_APP_OPTION('s', OPTION_MENU), AST_APP_OPTION('w', OPTION_WAITMARKED), AST_APP_OPTION('q', OPTION_QUIET),})</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a00d06bbcbadd5aa6a92914c223d25d88">AST_MODULE_INFO_STANDARD</a> (ASTERISK_GPL_KEY,&quot;Conference Bridge Application&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#af6c6ed0d870c3a527bb8b856f31d0e35">confbridge_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The ConfBridge application.  <a href="#af6c6ed0d870c3a527bb8b856f31d0e35"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a725ab63b13835417e5f9704a024a74dc">conference_bridge_cmp_cb</a> (void *obj, void *arg, int flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Comparison function used for conference bridges container.  <a href="#a725ab63b13835417e5f9704a024a74dc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#ab70a2ae9f2778c6c5a61328abe7acb90">conference_bridge_hash_cb</a> (const void *obj, const int flags)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Hashing function used for conference bridges container.  <a href="#ab70a2ae9f2778c6c5a61328abe7acb90"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#aafee70428b84848275fce95324283500">destroy_conference_bridge</a> (void *obj)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Destroy a conference bridge.  <a href="#aafee70428b84848275fce95324283500"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#ada261f94827ed6456ba3381a3595e11c">join_conference_bridge</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *<a class="el" href="structconference__bridge__user.html">conference_bridge_user</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Join a conference bridge.  <a href="#ada261f94827ed6456ba3381a3595e11c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a3cd9c6b73ff96b3f5395aa3085c91aa2">leave_conference_bridge</a> (struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *<a class="el" href="structconference__bridge.html">conference_bridge</a>, struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *<a class="el" href="structconference__bridge__user.html">conference_bridge_user</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Leave a conference bridge.  <a href="#a3cd9c6b73ff96b3f5395aa3085c91aa2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Called when module is being loaded.  <a href="#ac3382bf6da54c56b37069bd76bbdf4f9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a51aea82f99f18ba302a24b70e986ac99">menu_callback</a> (struct <a class="el" href="structast__bridge.html">ast_bridge</a> *bridge, struct <a class="el" href="structast__bridge__channel.html">ast_bridge_channel</a> *bridge_channel, void *hook_pvt)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">DTMF Menu Callback.  <a href="#a51aea82f99f18ba302a24b70e986ac99"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#aaee9253d8c8fe7016405a64f359ef921">play_prompt_to_channel</a> (struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *<a class="el" href="structconference__bridge.html">conference_bridge</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *file)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Play back an audio file to a channel.  <a href="#aaee9253d8c8fe7016405a64f359ef921"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#afc71c2a33b0d5fe94ae660beaf6370e1">play_sound_file</a> (struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *<a class="el" href="structconference__bridge.html">conference_bridge</a>, const char *filename)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Play <a class="el" href="structsound.html">sound</a> file into conference bridge.  <a href="#afc71c2a33b0d5fe94ae660beaf6370e1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#aa42f4e2be05e276ba0666f74f073b4c7">post_join_marked</a> (struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *<a class="el" href="structconference__bridge.html">conference_bridge</a>, struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *<a class="el" href="structconference__bridge__user.html">conference_bridge_user</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Perform post-joining marked specific <a class="el" href="structactions.html" title="list of actions registered">actions</a>.  <a href="#aa42f4e2be05e276ba0666f74f073b4c7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#ae08d149204b5b50e271873fc066ce204">post_join_unmarked</a> (struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *<a class="el" href="structconference__bridge.html">conference_bridge</a>, struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *<a class="el" href="structconference__bridge__user.html">conference_bridge_user</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Perform post-joining non-marked specific <a class="el" href="structactions.html" title="list of actions registered">actions</a>.  <a href="#ae08d149204b5b50e271873fc066ce204"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Called when module is being unloaded.  <a href="#ad09fa931f468002152a3cc2d5ce25eae"></a><br/></td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a> = &quot;ConfBridge&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structao2__container.html">ao2_container</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e">conference_bridges</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Container to hold all conference bridges in <a class="el" href="structprogress.html">progress</a>.  <a href="#aba18f75e10a4c0aaa4d6de41aa30c09e"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Conference Bridge application. </p>
<dl class="author"><dt><b>Author:</b></dt><dd><div class="fragment"><pre class="fragment">Joshua Colp &lt;jcolp@digium.com&gt; </pre></div></dd></dl>
<p>This is a conference bridge application utilizing the bridging core. </p>

<p>Definition in file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a52a0e4c83c7ff4b0e7b1a4ec096d3419"></a><!-- doxytag: member="app_confbridge.c::CONFERENCE_BRIDGE_BUCKETS" ref="a52a0e4c83c7ff4b0e7b1a4ec096d3419" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define CONFERENCE_BRIDGE_BUCKETS&nbsp;&nbsp;&nbsp;53</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00151">151</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00799">load_module()</a>.</p>

</div>
</div>
<a class="anchor" id="af06136a3da0a98829d389f3d061bc8e8"></a><!-- doxytag: member="app_confbridge.c::MAX_CONF_NAME" ref="af06136a3da0a98829d389f3d061bc8e8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_CONF_NAME&nbsp;&nbsp;&nbsp;32</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00148">148</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04"></a><!-- doxytag: member="app_confbridge.c::@3" ref="abc6126af1d45847bc59afa0aa3216b04" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8"></a><!-- doxytag: member="OPTION_ADMIN" ref="abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8" args="" -->OPTION_ADMIN</em>&nbsp;</td><td>
<p>Set if the caller is an administrator </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04a3edf63531f6aaab8f4c54b1c633001e0"></a><!-- doxytag: member="OPTION_MENU" ref="abc6126af1d45847bc59afa0aa3216b04a3edf63531f6aaab8f4c54b1c633001e0" args="" -->OPTION_MENU</em>&nbsp;</td><td>
<p>Set if the caller should have access to the conference bridge IVR menu </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598"></a><!-- doxytag: member="OPTION_MUSICONHOLD" ref="abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598" args="" -->OPTION_MUSICONHOLD</em>&nbsp;</td><td>
<p>Set if music on hold should be played if nobody else is in the conference bridge </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04a96c908c57e1804edef831ce961258d88"></a><!-- doxytag: member="OPTION_NOONLYPERSON" ref="abc6126af1d45847bc59afa0aa3216b04a96c908c57e1804edef831ce961258d88" args="" -->OPTION_NOONLYPERSON</em>&nbsp;</td><td>
<p>Set if the "you are currently the only person in this conference" <a class="el" href="structsound.html">sound</a> file should not be played </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04ab9f10f68ab5ee0ad976db98ce321530f"></a><!-- doxytag: member="OPTION_STARTMUTED" ref="abc6126af1d45847bc59afa0aa3216b04ab9f10f68ab5ee0ad976db98ce321530f" args="" -->OPTION_STARTMUTED</em>&nbsp;</td><td>
<p>Set if the caller should be initially set muted </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04ab3d3d664ddd8b1e2cdfaf34efcc01c4f"></a><!-- doxytag: member="OPTION_ANNOUNCEUSERCOUNT" ref="abc6126af1d45847bc59afa0aa3216b04ab3d3d664ddd8b1e2cdfaf34efcc01c4f" args="" -->OPTION_ANNOUNCEUSERCOUNT</em>&nbsp;</td><td>
<p>Set if the <a class="el" href="structnumber.html" title="Number structure.">number</a> of <a class="el" href="structusers.html" title="list of users found in the config file">users</a> should be announced to the caller </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8"></a><!-- doxytag: member="OPTION_MARKEDUSER" ref="abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8" args="" -->OPTION_MARKEDUSER</em>&nbsp;</td><td>
<p>Set if the caller is a marked <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04a83858d53c27d46d338330fb0175809f3"></a><!-- doxytag: member="OPTION_WAITMARKED" ref="abc6126af1d45847bc59afa0aa3216b04a83858d53c27d46d338330fb0175809f3" args="" -->OPTION_WAITMARKED</em>&nbsp;</td><td>
<p>Set if the conference must wait for a marked <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> before starting </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="abc6126af1d45847bc59afa0aa3216b04a694d0dbcb8cf31b3fd89309101e2eb65"></a><!-- doxytag: member="OPTION_QUIET" ref="abc6126af1d45847bc59afa0aa3216b04a694d0dbcb8cf31b3fd89309101e2eb65" args="" -->OPTION_QUIET</em>&nbsp;</td><td>
<p>Set if no audio prompts should be played </p>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00117">117</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00117"></a>00117      {
<a name="l00118"></a>00118    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8">OPTION_ADMIN</a> = (1 &lt;&lt; 0),             <span class="comment">/*!&lt; Set if the caller is an administrator */</span>
<a name="l00119"></a>00119    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a3edf63531f6aaab8f4c54b1c633001e0">OPTION_MENU</a> = (1 &lt;&lt; 1),              <span class="comment">/*!&lt; Set if the caller should have access to the conference bridge IVR menu */</span>
<a name="l00120"></a>00120    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a> = (1 &lt;&lt; 2),       <span class="comment">/*!&lt; Set if music on hold should be played if nobody else is in the conference bridge */</span>
<a name="l00121"></a>00121    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a96c908c57e1804edef831ce961258d88">OPTION_NOONLYPERSON</a> = (1 &lt;&lt; 3),      <span class="comment">/*!&lt; Set if the &quot;you are currently the only person in this conference&quot; sound file should not be played */</span>
<a name="l00122"></a>00122    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04ab9f10f68ab5ee0ad976db98ce321530f">OPTION_STARTMUTED</a> = (1 &lt;&lt; 4),        <span class="comment">/*!&lt; Set if the caller should be initially set muted */</span>
<a name="l00123"></a>00123    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04ab3d3d664ddd8b1e2cdfaf34efcc01c4f">OPTION_ANNOUNCEUSERCOUNT</a> = (1 &lt;&lt; 5), <span class="comment">/*!&lt; Set if the number of users should be announced to the caller */</span>
<a name="l00124"></a>00124    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a> = (1 &lt;&lt; 6),        <span class="comment">/*!&lt; Set if the caller is a marked user */</span>
<a name="l00125"></a>00125    <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a83858d53c27d46d338330fb0175809f3">OPTION_WAITMARKED</a> = (1 &lt;&lt; 7),        <span class="comment">/*!&lt; Set if the conference must wait for a marked user before starting */</span>
<a name="l00126"></a>00126    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a> = (1 &lt;&lt; 8),             <span class="comment">/*!&lt; Set if no audio prompts should be played */</span>
<a name="l00127"></a>00127 };
</pre></div></p>

</div>
</div>
<a class="anchor" id="adc29c2ff13d900c2f185ee95427fb06c"></a><!-- doxytag: member="app_confbridge.c::@4" ref="adc29c2ff13d900c2f185ee95427fb06c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3"></a><!-- doxytag: member="OPTION_MUSICONHOLD_CLASS" ref="adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3" args="" -->OPTION_MUSICONHOLD_CLASS</em>&nbsp;</td><td>
<p>If the 'M' option is set, the music on hold class to play </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="adc29c2ff13d900c2f185ee95427fb06ca6fbb37a6285376b28be858fd442cd46b"></a><!-- doxytag: member="OPTION_ARRAY_SIZE" ref="adc29c2ff13d900c2f185ee95427fb06ca6fbb37a6285376b28be858fd442cd46b" args="" -->OPTION_ARRAY_SIZE</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00129">129</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00129"></a>00129      {
<a name="l00130"></a>00130    <a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>,            <span class="comment">/*!&lt; If the &apos;M&apos; option is set, the music on hold class to play */</span>
<a name="l00131"></a>00131    <span class="comment">/*This must be the last element */</span>
<a name="l00132"></a>00132    <a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6fbb37a6285376b28be858fd442cd46b">OPTION_ARRAY_SIZE</a>,
<a name="l00133"></a>00133 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a5e6676d2b4d985b8fb2f0ecb3c46c5ee"></a><!-- doxytag: member="app_confbridge.c::announce_user_count" ref="a5e6676d2b4d985b8fb2f0ecb3c46c5ee" args="(struct conference_bridge *conference_bridge, struct conference_bridge_user *conference_bridge_user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void announce_user_count </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge_user</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Announce <a class="el" href="structnumber.html" title="Number structure.">number</a> of <a class="el" href="structusers.html" title="list of users found in the config file">users</a> in the conference bridge to the caller. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a></em>&nbsp;</td><td>Conference bridge to peek at </td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a></em>&nbsp;</td><td>Caller</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns nothing </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00203">203</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="channel_8c_source.html#l05815">ast_say_number()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, and <a class="el" href="app__confbridge_8c_source.html#l00157">conference_bridge::users</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00320">post_join_unmarked()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00204"></a>00204 {
<a name="l00205"></a>00205    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 1) {
<a name="l00206"></a>00206       <span class="comment">/* Awww we are the only person in the conference bridge */</span>
<a name="l00207"></a>00207       <span class="keywordflow">return</span>;
<a name="l00208"></a>00208    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 2) {
<a name="l00209"></a>00209       <span class="comment">/* Eep, there is one other person */</span>
<a name="l00210"></a>00210       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-onlyone&quot;</span>, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00211"></a>00211          <span class="keywordflow">return</span>;
<a name="l00212"></a>00212       }
<a name="l00213"></a>00213    } <span class="keywordflow">else</span> {
<a name="l00214"></a>00214       <span class="comment">/* Alas multiple others in here */</span>
<a name="l00215"></a>00215       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-thereare&quot;</span>, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00216"></a>00216          <span class="keywordflow">return</span>;
<a name="l00217"></a>00217       }
<a name="l00218"></a>00218       <span class="keywordflow">if</span> (<a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> - 1, <span class="stringliteral">&quot;&quot;</span>, conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language, NULL)) {
<a name="l00219"></a>00219          <span class="keywordflow">return</span>;
<a name="l00220"></a>00220       }
<a name="l00221"></a>00221       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-otherinparty&quot;</span>, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00222"></a>00222          <span class="keywordflow">return</span>;
<a name="l00223"></a>00223       }
<a name="l00224"></a>00224    }
<a name="l00225"></a>00225 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a312a753890c96c227a52de53c4ffd682"></a><!-- doxytag: member="app_confbridge.c::AST_APP_OPTIONS" ref="a312a753890c96c227a52de53c4ffd682" args="(app_opts,{AST_APP_OPTION('A', OPTION_MARKEDUSER), AST_APP_OPTION('a', OPTION_ADMIN), AST_APP_OPTION('c', OPTION_ANNOUNCEUSERCOUNT), AST_APP_OPTION('m', OPTION_STARTMUTED), AST_APP_OPTION_ARG('M', OPTION_MUSICONHOLD, OPTION_MUSICONHOLD_CLASS), AST_APP_OPTION('1', OPTION_NOONLYPERSON), AST_APP_OPTION('s', OPTION_MENU), AST_APP_OPTION('w', OPTION_WAITMARKED), AST_APP_OPTION('q', OPTION_QUIET),})" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AST_APP_OPTIONS </td>
          <td>(</td>
          <td class="paramtype">app_opts&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a00d06bbcbadd5aa6a92914c223d25d88"></a><!-- doxytag: member="app_confbridge.c::AST_MODULE_INFO_STANDARD" ref="a00d06bbcbadd5aa6a92914c223d25d88" args="(ASTERISK_GPL_KEY,&quot;Conference Bridge Application&quot;)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AST_MODULE_INFO_STANDARD </td>
          <td>(</td>
          <td class="paramtype">ASTERISK_GPL_KEY&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;Conference Bridge Application&quot;&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="af6c6ed0d870c3a527bb8b856f31d0e35"></a><!-- doxytag: member="app_confbridge.c::confbridge_exec" ref="af6c6ed0d870c3a527bb8b856f31d0e35" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int confbridge_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The ConfBridge application. </p>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00687">687</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8c_source.html#l01776">ast_app_parse_options()</a>, <a class="el" href="audiohook_8h_source.html#l00050">AST_AUDIOHOOK_DIRECTION_READ</a>, <a class="el" href="audiohook_8h_source.html#l00051">AST_AUDIOHOOK_DIRECTION_WRITE</a>, <a class="el" href="audiohook_8c_source.html#l00959">ast_audiohook_volume_get()</a>, <a class="el" href="audiohook_8c_source.html#l00934">ast_audiohook_volume_set()</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="bridging_8c_source.html#l01320">ast_bridge_features_cleanup()</a>, <a class="el" href="bridging_8c_source.html#l01261">ast_bridge_features_hook()</a>, <a class="el" href="bridging_8c_source.html#l01309">ast_bridge_features_init()</a>, <a class="el" href="bridging_8c_source.html#l00980">ast_bridge_join()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, <a class="el" href="app__confbridge_8c_source.html#l00171">conference_bridge_user::features</a>, <a class="el" href="app__confbridge_8c_source.html#l00169">conference_bridge_user::flags</a>, <a class="el" href="app__confbridge_8c_source.html#l00394">join_conference_bridge()</a>, <a class="el" href="app__confbridge_8c_source.html#l00172">conference_bridge_user::kicked</a>, <a class="el" href="app__confbridge_8c_source.html#l00485">leave_conference_bridge()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__confbridge_8c_source.html#l00607">menu_callback()</a>, <a class="el" href="bridging__features_8h_source.html#l00096">ast_bridge_features::mute</a>, <a class="el" href="app__confbridge_8c_source.html#l00170">conference_bridge_user::opt_args</a>, <a class="el" href="app__confbridge_8c_source.html#l00119">OPTION_MENU</a>, <a class="el" href="app__chanspy_8c_source.html#l00297">OPTION_QUIET</a>, <a class="el" href="app__confbridge_8c_source.html#l00122">OPTION_STARTMUTED</a>, <a class="el" href="chan__mgcp_8c_source.html#l01737">parse()</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="app__confbridge_8c_source.html#l00554">play_sound_file()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00157">conference_bridge::users</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00799">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00688"></a>00688 {
<a name="l00689"></a>00689    <span class="keywordtype">int</span> res = 0, volume_adjustments[2];
<a name="l00690"></a>00690    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l00691"></a>00691    <span class="keyword">struct </span><a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> *<a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> = NULL;
<a name="l00692"></a>00692    <span class="keyword">struct </span><a class="code" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a> <a class="code" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a> = {
<a name="l00693"></a>00693       .chan = chan,
<a name="l00694"></a>00694    };
<a name="l00695"></a>00695    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp, *join_sound = NULL, *leave_sound = NULL;
<a name="l00696"></a>00696    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00697"></a>00697       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(conf_name);
<a name="l00698"></a>00698       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l00699"></a>00699    );
<a name="l00700"></a>00700 
<a name="l00701"></a>00701    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l00702"></a>00702       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s requires an argument (conference name[,options])\n&quot;</span>, <a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>);
<a name="l00703"></a>00703       <span class="keywordflow">return</span> -1;
<a name="l00704"></a>00704    }
<a name="l00705"></a>00705 
<a name="l00706"></a>00706    <span class="comment">/* We need to make a copy of the input string if we are going to modify it! */</span>
<a name="l00707"></a>00707    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00708"></a>00708 
<a name="l00709"></a>00709    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711    <span class="keywordflow">if</span> (args.argc == 2) {
<a name="l00712"></a>00712       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(app_opts, &amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, conference_bridge_user.<a class="code" href="structconference__bridge__user.html#a328db3a83a9599f21163ec53525d2d1c">opt_args</a>, args.options);
<a name="l00713"></a>00713    }
<a name="l00714"></a>00714 
<a name="l00715"></a>00715    <span class="comment">/* Look for a conference bridge matching the provided name */</span>
<a name="l00716"></a>00716    <span class="keywordflow">if</span> (!(conference_bridge = <a class="code" href="app__confbridge_8c.html#ada261f94827ed6456ba3381a3595e11c" title="Join a conference bridge.">join_conference_bridge</a>(args.conf_name, &amp;conference_bridge_user))) {
<a name="l00717"></a>00717       <span class="keywordflow">return</span> -1;
<a name="l00718"></a>00718    }
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <span class="comment">/* Keep a copy of volume adjustments so we can restore them later if need be */</span>
<a name="l00721"></a>00721    volume_adjustments[0] = <a class="code" href="audiohook_8h.html#a39f5dbdf5ef7a979d4ba48f9ee71a422" title="Retrieve the volume adjustment value on frames read from or written to a channel...">ast_audiohook_volume_get</a>(chan, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>);
<a name="l00722"></a>00722    volume_adjustments[1] = <a class="code" href="audiohook_8h.html#a39f5dbdf5ef7a979d4ba48f9ee71a422" title="Retrieve the volume adjustment value on frames read from or written to a channel...">ast_audiohook_volume_get</a>(chan, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>);
<a name="l00723"></a>00723 
<a name="l00724"></a>00724    <span class="comment">/* Always initialize the features structure, we are in most cases always going to need it. */</span>
<a name="l00725"></a>00725    <a class="code" href="bridging__features_8h.html#a3128b52009fb3dd764dce90ea377fce1" title="Initialize bridge features structure.">ast_bridge_features_init</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>);
<a name="l00726"></a>00726 
<a name="l00727"></a>00727    <span class="comment">/* If the menu option is enabled provide a user or admin menu as a custom feature hook */</span>
<a name="l00728"></a>00728    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a3edf63531f6aaab8f4c54b1c633001e0">OPTION_MENU</a>)) {
<a name="l00729"></a>00729       <a class="code" href="bridging__features_8h.html#a2febee2c3ae0c31d248278818ca5edf7" title="Attach a custom hook to a bridge features structure.">ast_bridge_features_hook</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>, <span class="stringliteral">&quot;#&quot;</span>, <a class="code" href="app__confbridge_8c.html#a51aea82f99f18ba302a24b70e986ac99" title="DTMF Menu Callback.">menu_callback</a>, &amp;conference_bridge_user);
<a name="l00730"></a>00730    }
<a name="l00731"></a>00731 
<a name="l00732"></a>00732    <span class="comment">/* If the caller should be joined already muted, make it so */</span>
<a name="l00733"></a>00733    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04ab9f10f68ab5ee0ad976db98ce321530f">OPTION_STARTMUTED</a>)) {
<a name="l00734"></a>00734       conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> = 1;
<a name="l00735"></a>00735    }
<a name="l00736"></a>00736 
<a name="l00737"></a>00737    <span class="comment">/* Grab join/leave sounds from the channel */</span>
<a name="l00738"></a>00738    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00739"></a>00739    <span class="keywordflow">if</span> ((tmp = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;CONFBRIDGE_JOIN_SOUND&quot;</span>))) {
<a name="l00740"></a>00740       join_sound = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(tmp);
<a name="l00741"></a>00741    }
<a name="l00742"></a>00742    <span class="keywordflow">if</span> ((tmp = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;CONFBRIDGE_LEAVE_SOUND&quot;</span>))) {
<a name="l00743"></a>00743       leave_sound = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(tmp);
<a name="l00744"></a>00744    }
<a name="l00745"></a>00745    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00746"></a>00746 
<a name="l00747"></a>00747    <span class="comment">/* If there is 1 or more people already in the conference then play our join sound unless overridden */</span>
<a name="l00748"></a>00748    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(join_sound) &amp;&amp; conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> &gt;= 2) {
<a name="l00749"></a>00749       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00750"></a>00750       <a class="code" href="app__confbridge_8c.html#afc71c2a33b0d5fe94ae660beaf6370e1" title="Play sound file into conference bridge.">play_sound_file</a>(conference_bridge, join_sound);
<a name="l00751"></a>00751       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00752"></a>00752    }
<a name="l00753"></a>00753 
<a name="l00754"></a>00754    <span class="comment">/* Join our conference bridge for real */</span>
<a name="l00755"></a>00755    <a class="code" href="bridging_8h.html#adf7e5e313d2ed7e7b9dfd24891d38690" title="Join (blocking) a channel to a bridge.">ast_bridge_join</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, chan, NULL, &amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>);
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    <span class="comment">/* If there is 1 or more people (not including us) already in the conference then play our leave sound unless overridden */</span>
<a name="l00758"></a>00758    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(leave_sound) &amp;&amp; conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> &gt;= 2) {
<a name="l00759"></a>00759       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00760"></a>00760       <a class="code" href="app__confbridge_8c.html#afc71c2a33b0d5fe94ae660beaf6370e1" title="Play sound file into conference bridge.">play_sound_file</a>(conference_bridge, leave_sound);
<a name="l00761"></a>00761       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00762"></a>00762    }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764    <span class="comment">/* Easy as pie, depart this channel from the conference bridge */</span>
<a name="l00765"></a>00765    <a class="code" href="app__confbridge_8c.html#a3cd9c6b73ff96b3f5395aa3085c91aa2" title="Leave a conference bridge.">leave_conference_bridge</a>(conference_bridge, &amp;conference_bridge_user);
<a name="l00766"></a>00766    conference_bridge = NULL;
<a name="l00767"></a>00767 
<a name="l00768"></a>00768    <span class="comment">/* Can&apos;t forget to clean up the features structure, or else we risk a memory leak */</span>
<a name="l00769"></a>00769    <a class="code" href="bridging__features_8h.html#acd324df24035097d55e7ecf1f214fab3" title="Clean up the contents of a bridge features structure.">ast_bridge_features_cleanup</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>);
<a name="l00770"></a>00770 
<a name="l00771"></a>00771    <span class="comment">/* If the user was kicked from the conference play back the audio prompt for it */</span>
<a name="l00772"></a>00772    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user.<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>) &amp;&amp; conference_bridge_user.<a class="code" href="structconference__bridge__user.html#a0afbbd980cfe1d7c564c0f7850a82ed9">kicked</a>) {
<a name="l00773"></a>00773       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;conf-kicked&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00774"></a>00774    }
<a name="l00775"></a>00775 
<a name="l00776"></a>00776    <span class="comment">/* Restore volume adjustments to previous values in case they were changed */</span>
<a name="l00777"></a>00777    <span class="keywordflow">if</span> (volume_adjustments[0]) {
<a name="l00778"></a>00778       <a class="code" href="audiohook_8h.html#ae042519f3d210ea48604952be74044a2" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_set</a>(chan, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>, volume_adjustments[0]);
<a name="l00779"></a>00779    }
<a name="l00780"></a>00780    <span class="keywordflow">if</span> (volume_adjustments[1]) {
<a name="l00781"></a>00781       <a class="code" href="audiohook_8h.html#ae042519f3d210ea48604952be74044a2" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_set</a>(chan, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>, volume_adjustments[1]);
<a name="l00782"></a>00782    }
<a name="l00783"></a>00783 
<a name="l00784"></a>00784    <span class="keywordflow">return</span> res;
<a name="l00785"></a>00785 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a725ab63b13835417e5f9704a024a74dc"></a><!-- doxytag: member="app_confbridge.c::conference_bridge_cmp_cb" ref="a725ab63b13835417e5f9704a024a74dc" args="(void *obj, void *arg, int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int conference_bridge_cmp_cb </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>arg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Comparison function used for conference bridges container. </p>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00189">189</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00653">CMP_MATCH</a>, <a class="el" href="astobj2_8h_source.html#l00654">CMP_STOP</a>, and <a class="el" href="app__confbridge_8c_source.html#l00155">conference_bridge::name</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00799">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00190"></a>00190 {
<a name="l00191"></a>00191    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> *conference_bridge0 = obj, *conference_bridge1 = arg;
<a name="l00192"></a>00192    <span class="keywordflow">return</span> (!strcasecmp(conference_bridge0-&gt;<a class="code" href="structconference__bridge.html#a11c38fccfc194cc0f316e77f4494516f">name</a>, conference_bridge1-&gt;name) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0);
<a name="l00193"></a>00193 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab70a2ae9f2778c6c5a61328abe7acb90"></a><!-- doxytag: member="app_confbridge.c::conference_bridge_hash_cb" ref="ab70a2ae9f2778c6c5a61328abe7acb90" args="(const void *obj, const int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int conference_bridge_hash_cb </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Hashing function used for conference bridges container. </p>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00182">182</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00896">ast_str_case_hash()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00155">conference_bridge::name</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00799">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00183"></a>00183 {
<a name="l00184"></a>00184    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> *<a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> = obj;
<a name="l00185"></a>00185    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#ab08f8db2a7258e538a0da7417f58db58" title="Compute a hash value on a case-insensitive string.">ast_str_case_hash</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a11c38fccfc194cc0f316e77f4494516f">name</a>);
<a name="l00186"></a>00186 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aafee70428b84848275fce95324283500"></a><!-- doxytag: member="app_confbridge.c::destroy_conference_bridge" ref="aafee70428b84848275fce95324283500" args="(void *obj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void destroy_conference_bridge </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>obj</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Destroy a conference bridge. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>obj</em>&nbsp;</td><td>The conference bridge object</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns nothing </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00364">364</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="bridging_8c_source.html#l00514">ast_bridge_destroy()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="lock_8h_source.html#l01712">ast_mutex_destroy()</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, and <a class="el" href="app__confbridge_8c_source.html#l00155">conference_bridge::name</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00394">join_conference_bridge()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00365"></a>00365 {
<a name="l00366"></a>00366    <span class="keyword">struct </span><a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> *<a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> = obj;
<a name="l00367"></a>00367 
<a name="l00368"></a>00368    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Destroying conference bridge &apos;%s&apos;\n&quot;</span>, conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a11c38fccfc194cc0f316e77f4494516f">name</a>);
<a name="l00369"></a>00369 
<a name="l00370"></a>00370    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;conference_bridge-&gt;playback_lock);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    <span class="keywordflow">if</span> (conference_bridge-&gt;playback_chan) {
<a name="l00373"></a>00373       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *underlying_channel = conference_bridge-&gt;playback_chan-&gt;tech-&gt;bridged_channel(conference_bridge-&gt;playback_chan, NULL);
<a name="l00374"></a>00374       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(underlying_channel);
<a name="l00375"></a>00375       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(conference_bridge-&gt;playback_chan);
<a name="l00376"></a>00376       conference_bridge-&gt;playback_chan = NULL;
<a name="l00377"></a>00377    }
<a name="l00378"></a>00378 
<a name="l00379"></a>00379    <span class="comment">/* Destroying a conference bridge is simple, all we have to do is destroy the bridging object */</span>
<a name="l00380"></a>00380    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>) {
<a name="l00381"></a>00381       <a class="code" href="bridging_8h.html#a523fcc8aa1338afe507a3de9db0b84c3" title="Destroy a bridge.">ast_bridge_destroy</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>);
<a name="l00382"></a>00382       conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a> = NULL;
<a name="l00383"></a>00383    }
<a name="l00384"></a>00384 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ada261f94827ed6456ba3381a3595e11c"></a><!-- doxytag: member="app_confbridge.c::join_conference_bridge" ref="ada261f94827ed6456ba3381a3595e11c" args="(const char *name, struct conference_bridge_user *conference_bridge_user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structconference__bridge.html">conference_bridge</a>* join_conference_bridge </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge_user</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Join a conference bridge. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>The conference name </td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a></em>&nbsp;</td><td>Conference bridge <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> structure</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>A pointer to the conference bridge struct, or NULL if the conference room wasn't found. </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00394">394</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00413">ao2_alloc</a>, <a class="el" href="astobj2_8h_source.html#l00968">ao2_find</a>, <a class="el" href="astobj2_8h_source.html#l00782">ao2_link</a>, <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="bridging_8h_source.html#l00070">AST_BRIDGE_CAPABILITY_1TO1MIX</a>, <a class="el" href="bridging__features_8h_source.html#l00036">AST_BRIDGE_FLAG_SMART</a>, <a class="el" href="bridging_8c_source.html#l00448">ast_bridge_new()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="lock_8h_source.html#l01692">ast_mutex_init()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, <a class="el" href="app__confbridge_8c_source.html#l00167">conference_bridge_user::conference_bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00177">conference_bridges</a>, <a class="el" href="app__confbridge_8c_source.html#l00364">destroy_conference_bridge()</a>, <a class="el" href="app__confbridge_8c_source.html#l00169">conference_bridge_user::flags</a>, <a class="el" href="app__confbridge_8c_source.html#l00159">conference_bridge::locked</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="app__confbridge_8c_source.html#l00158">conference_bridge::markedusers</a>, <a class="el" href="app__confbridge_8c_source.html#l00155">conference_bridge::name</a>, <a class="el" href="astobj2_8h_source.html#l00678">OBJ_POINTER</a>, <a class="el" href="app__confbridge_8c_source.html#l00118">OPTION_ADMIN</a>, <a class="el" href="app__confbridge_8c_source.html#l00124">OPTION_MARKEDUSER</a>, <a class="el" href="app__confbridge_8c_source.html#l00125">OPTION_WAITMARKED</a>, <a class="el" href="app__confbridge_8c_source.html#l00253">post_join_marked()</a>, <a class="el" href="app__confbridge_8c_source.html#l00320">post_join_unmarked()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00157">conference_bridge::users</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00687">confbridge_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00395"></a>00395 {
<a name="l00396"></a>00396    <span class="keyword">struct </span><a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> *<a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> = NULL;
<a name="l00397"></a>00397    <span class="keyword">struct </span>conference_bridge tmp;
<a name="l00398"></a>00398 
<a name="l00399"></a>00399    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp.name, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">sizeof</span>(tmp.name));
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="comment">/* We explictly lock the conference bridges container ourselves so that other callers can not create duplicate conferences at the same */</span>
<a name="l00402"></a>00402    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>);
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Trying to find conference bridge &apos;%s&apos;\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00405"></a>00405 
<a name="l00406"></a>00406    <span class="comment">/* Attempt to find an existing conference bridge */</span>
<a name="l00407"></a>00407    conference_bridge = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409    <span class="comment">/* When finding a conference bridge that already exists make sure that it is not locked, and if so that we are not an admin */</span>
<a name="l00410"></a>00410    <span class="keywordflow">if</span> (conference_bridge &amp;&amp; conference_bridge-&gt;<a class="code" href="structconference__bridge.html#afa330a895fe8ef506be047091f21d940">locked</a> &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8">OPTION_ADMIN</a>)) {
<a name="l00411"></a>00411       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>);
<a name="l00412"></a>00412       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(conference_bridge, -1);
<a name="l00413"></a>00413       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Conference bridge &apos;%s&apos; is locked and caller is not an admin\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00414"></a>00414       <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-locked&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00415"></a>00415       <span class="keywordflow">return</span> NULL;
<a name="l00416"></a>00416    }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418    <span class="comment">/* If no conference bridge was found see if we can create one */</span>
<a name="l00419"></a>00419    <span class="keywordflow">if</span> (!conference_bridge) {
<a name="l00420"></a>00420       <span class="comment">/* Try to allocate memory for a new conference bridge, if we fail... this won&apos;t end well. */</span>
<a name="l00421"></a>00421       <span class="keywordflow">if</span> (!(conference_bridge = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*conference_bridge), <a class="code" href="app__confbridge_8c.html#aafee70428b84848275fce95324283500" title="Destroy a conference bridge.">destroy_conference_bridge</a>))) {
<a name="l00422"></a>00422          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>);
<a name="l00423"></a>00423          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Conference bridge &apos;%s&apos; does not exist.\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00424"></a>00424          <span class="keywordflow">return</span> NULL;
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426 
<a name="l00427"></a>00427       <span class="comment">/* Setup conference bridge parameters */</span>
<a name="l00428"></a>00428       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a11c38fccfc194cc0f316e77f4494516f">name</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">sizeof</span>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a11c38fccfc194cc0f316e77f4494516f">name</a>));
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       <span class="comment">/* Create an actual bridge that will do the audio mixing */</span>
<a name="l00431"></a>00431       <span class="keywordflow">if</span> (!(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a> = <a class="code" href="bridging_8h.html#ab9ac166bd85c7c76b5e13170d3a2f047" title="Create a new bridge.">ast_bridge_new</a>(<a class="code" href="bridging_8h.html#a815c9b3e933dfd4b8f523cf55caa5bbfaf483c951b835fcc35da807b6a4b12509">AST_BRIDGE_CAPABILITY_1TO1MIX</a>, <a class="code" href="bridging__features_8h.html#a65c2644d2eadb31bcec0aaeb41cb3444a8f8162f42b84a7eba37bfb551c31743b">AST_BRIDGE_FLAG_SMART</a>))) {
<a name="l00432"></a>00432          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(conference_bridge, -1);
<a name="l00433"></a>00433          conference_bridge = NULL;
<a name="l00434"></a>00434          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>);
<a name="l00435"></a>00435          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Conference bridge &apos;%s&apos; could not be created.\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00436"></a>00436          <span class="keywordflow">return</span> NULL;
<a name="l00437"></a>00437       }
<a name="l00438"></a>00438 
<a name="l00439"></a>00439       <span class="comment">/* Setup lock for playback channel */</span>
<a name="l00440"></a>00440       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;conference_bridge-&gt;playback_lock);
<a name="l00441"></a>00441 
<a name="l00442"></a>00442       <span class="comment">/* Link it into the conference bridges container */</span>
<a name="l00443"></a>00443       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>, conference_bridge);
<a name="l00444"></a>00444 
<a name="l00445"></a>00445       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Created conference bridge &apos;%s&apos; and linked to container &apos;%p&apos;\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>);
<a name="l00446"></a>00446    }
<a name="l00447"></a>00447 
<a name="l00448"></a>00448    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>);
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="comment">/* Setup conference bridge user parameters */</span>
<a name="l00451"></a>00451    conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a99f3edd6ca313abd8c3bd90ac074c044">conference_bridge</a> = conference_bridge;
<a name="l00452"></a>00452 
<a name="l00453"></a>00453    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455    <span class="comment">/* All good to go, add them in */</span>
<a name="l00456"></a>00456    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;conference_bridge-&gt;users_list, conference_bridge_user, list);
<a name="l00457"></a>00457 
<a name="l00458"></a>00458    <span class="comment">/* Increment the users count on the bridge, but record it as it is going to need to be known right after this */</span>
<a name="l00459"></a>00459    conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a>++;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    <span class="comment">/* If the caller is a marked user bump up the count */</span>
<a name="l00462"></a>00462    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a>)) {
<a name="l00463"></a>00463       conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a>++;
<a name="l00464"></a>00464    }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <span class="comment">/* If the caller is a marked user or is waiting for a marked user to enter pass &apos;em off, otherwise pass them off to do regular joining stuff */</span>
<a name="l00467"></a>00467    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a> | <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a83858d53c27d46d338330fb0175809f3">OPTION_WAITMARKED</a>)) {
<a name="l00468"></a>00468       <a class="code" href="app__confbridge_8c.html#aa42f4e2be05e276ba0666f74f073b4c7" title="Perform post-joining marked specific actions.">post_join_marked</a>(conference_bridge, conference_bridge_user);
<a name="l00469"></a>00469    } <span class="keywordflow">else</span> {
<a name="l00470"></a>00470       <a class="code" href="app__confbridge_8c.html#ae08d149204b5b50e271873fc066ce204" title="Perform post-joining non-marked specific actions.">post_join_unmarked</a>(conference_bridge, conference_bridge_user);
<a name="l00471"></a>00471    }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    <span class="keywordflow">return</span> conference_bridge;
<a name="l00476"></a>00476 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3cd9c6b73ff96b3f5395aa3085c91aa2"></a><!-- doxytag: member="app_confbridge.c::leave_conference_bridge" ref="a3cd9c6b73ff96b3f5395aa3085c91aa2" args="(struct conference_bridge *conference_bridge, struct conference_bridge_user *conference_bridge_user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void leave_conference_bridge </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge_user</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Leave a conference bridge. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a></em>&nbsp;</td><td>The conference bridge to leave </td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a></em>&nbsp;</td><td>The conference bridge <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> structure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00485">485</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="astobj2_8h_source.html#l00813">ao2_unlink</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="bridging_8c_source.html#l01187">ast_bridge_suspend()</a>, <a class="el" href="bridging_8c_source.html#l01205">ast_bridge_unsuspend()</a>, <a class="el" href="linkedlists_8h_source.html#l00420">AST_LIST_FIRST</a>, <a class="el" href="linkedlists_8h_source.html#l00838">AST_LIST_REMOVE</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="channel_8c_source.html#l05538">ast_moh_start()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, <a class="el" href="app__confbridge_8c_source.html#l00177">conference_bridges</a>, <a class="el" href="app__confbridge_8c_source.html#l00171">conference_bridge_user::features</a>, <a class="el" href="app__confbridge_8c_source.html#l00169">conference_bridge_user::flags</a>, <a class="el" href="app__confbridge_8c_source.html#l00158">conference_bridge::markedusers</a>, <a class="el" href="bridging__features_8h_source.html#l00096">ast_bridge_features::mute</a>, <a class="el" href="app__confbridge_8c_source.html#l00170">conference_bridge_user::opt_args</a>, <a class="el" href="app__confbridge_8c_source.html#l00124">OPTION_MARKEDUSER</a>, <a class="el" href="app__confbridge_8c_source.html#l00120">OPTION_MUSICONHOLD</a>, <a class="el" href="app__confbridge_8c_source.html#l00130">OPTION_MUSICONHOLD_CLASS</a>, <a class="el" href="app__chanspy_8c_source.html#l00297">OPTION_QUIET</a>, <a class="el" href="app__confbridge_8c_source.html#l00554">play_sound_file()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00157">conference_bridge::users</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00687">confbridge_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00486"></a>00486 {
<a name="l00487"></a>00487    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489    <span class="comment">/* If this caller is a marked user bump down the count */</span>
<a name="l00490"></a>00490    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a>)) {
<a name="l00491"></a>00491       conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a>--;
<a name="l00492"></a>00492    }
<a name="l00493"></a>00493 
<a name="l00494"></a>00494    <span class="comment">/* Decrement the users count while keeping the previous participant count */</span>
<a name="l00495"></a>00495    conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a>--;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497    <span class="comment">/* Drop conference bridge user from the list, they be going bye bye */</span>
<a name="l00498"></a>00498    <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;conference_bridge-&gt;users_list, conference_bridge_user, list);
<a name="l00499"></a>00499 
<a name="l00500"></a>00500    <span class="comment">/* If there are still users in the conference bridge we may need to do things (such as start MOH on them) */</span>
<a name="l00501"></a>00501    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a>) {
<a name="l00502"></a>00502       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a>) &amp;&amp; !conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a>) {
<a name="l00503"></a>00503          <span class="keyword">struct </span>conference_bridge_user *other_participant = NULL;
<a name="l00504"></a>00504 
<a name="l00505"></a>00505          <span class="comment">/* Start out with muting everyone */</span>
<a name="l00506"></a>00506          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conference_bridge-&gt;users_list, other_participant, list) {
<a name="l00507"></a>00507             other_participant-&gt;<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> = 1;
<a name="l00508"></a>00508          }
<a name="l00509"></a>00509 
<a name="l00510"></a>00510          <span class="comment">/* Play back the audio prompt saying the leader has left the conference */</span>
<a name="l00511"></a>00511          <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>)) {
<a name="l00512"></a>00512             <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00513"></a>00513             <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00514"></a>00514             <a class="code" href="app__confbridge_8c.html#afc71c2a33b0d5fe94ae660beaf6370e1" title="Play sound file into conference bridge.">play_sound_file</a>(conference_bridge, <span class="stringliteral">&quot;conf-leaderhasleft&quot;</span>);
<a name="l00515"></a>00515             <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00516"></a>00516             <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00517"></a>00517          }
<a name="l00518"></a>00518 
<a name="l00519"></a>00519          <span class="comment">/* Now on to starting MOH if needed */</span>
<a name="l00520"></a>00520          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conference_bridge-&gt;users_list, other_participant, list) {
<a name="l00521"></a>00521             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;other_participant-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>) &amp;&amp; !<a class="code" href="bridging_8h.html#a85bc0d4138ac2af7b207d8f1325f051a" title="Suspend a channel temporarily from a bridge.">ast_bridge_suspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, other_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00522"></a>00522                <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(other_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, other_participant-&gt;<a class="code" href="structconference__bridge__user.html#a328db3a83a9599f21163ec53525d2d1c">opt_args</a>[<a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>], NULL);
<a name="l00523"></a>00523                <a class="code" href="bridging_8h.html#aab4cd1153d39a6744eca6a84d5255820" title="Unsuspend a channel from a bridge.">ast_bridge_unsuspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, other_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00524"></a>00524             }
<a name="l00525"></a>00525          }
<a name="l00526"></a>00526       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 1) {
<a name="l00527"></a>00527          <span class="comment">/* Of course if there is one other person in here we may need to start up MOH on them */</span>
<a name="l00528"></a>00528          <span class="keyword">struct </span>conference_bridge_user *first_participant = <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;conference_bridge-&gt;users_list);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;first_participant-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>) &amp;&amp; !<a class="code" href="bridging_8h.html#a85bc0d4138ac2af7b207d8f1325f051a" title="Suspend a channel temporarily from a bridge.">ast_bridge_suspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00531"></a>00531             <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a328db3a83a9599f21163ec53525d2d1c">opt_args</a>[<a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>], NULL);
<a name="l00532"></a>00532             <a class="code" href="bridging_8h.html#aab4cd1153d39a6744eca6a84d5255820" title="Unsuspend a channel from a bridge.">ast_bridge_unsuspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00533"></a>00533          }
<a name="l00534"></a>00534       }
<a name="l00535"></a>00535    } <span class="keywordflow">else</span> {
<a name="l00536"></a>00536       <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>, conference_bridge);
<a name="l00537"></a>00537    }
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="comment">/* Done mucking with the conference bridge, huzzah */</span>
<a name="l00540"></a>00540    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00541"></a>00541 
<a name="l00542"></a>00542    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(conference_bridge, -1);
<a name="l00543"></a>00543 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="app_confbridge.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Called when module is being loaded. </p>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00799">799</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00727">ao2_container_alloc</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="module_8h_source.html#l00406">ast_register_application_xml</a>, <a class="el" href="app__confbridge_8c_source.html#l00687">confbridge_exec()</a>, <a class="el" href="app__confbridge_8c_source.html#l00151">CONFERENCE_BRIDGE_BUCKETS</a>, <a class="el" href="app__confbridge_8c_source.html#l00189">conference_bridge_cmp_cb()</a>, <a class="el" href="app__confbridge_8c_source.html#l00182">conference_bridge_hash_cb()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00177">conference_bridges</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00800"></a>00800 {
<a name="l00801"></a>00801    <span class="comment">/* Create a container to hold the conference bridges */</span>
<a name="l00802"></a>00802    <span class="keywordflow">if</span> (!(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="app__confbridge_8c.html#a52a0e4c83c7ff4b0e7b1a4ec096d3419">CONFERENCE_BRIDGE_BUCKETS</a>, <a class="code" href="app__confbridge_8c.html#ab70a2ae9f2778c6c5a61328abe7acb90" title="Hashing function used for conference bridges container.">conference_bridge_hash_cb</a>, <a class="code" href="app__confbridge_8c.html#a725ab63b13835417e5f9704a024a74dc" title="Comparison function used for conference bridges container.">conference_bridge_cmp_cb</a>))) {
<a name="l00803"></a>00803       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l00804"></a>00804    }
<a name="l00805"></a>00805 
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (<a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>, <a class="code" href="app__confbridge_8c.html#af6c6ed0d870c3a527bb8b856f31d0e35" title="The ConfBridge application.">confbridge_exec</a>)) {
<a name="l00807"></a>00807       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>, -1);
<a name="l00808"></a>00808       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l00809"></a>00809    }
<a name="l00810"></a>00810 
<a name="l00811"></a>00811    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l00812"></a>00812 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a51aea82f99f18ba302a24b70e986ac99"></a><!-- doxytag: member="app_confbridge.c::menu_callback" ref="a51aea82f99f18ba302a24b70e986ac99" args="(struct ast_bridge *bridge, struct ast_bridge_channel *bridge_channel, void *hook_pvt)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int menu_callback </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__bridge.html">ast_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__channel.html">ast_bridge_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>bridge_channel</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>hook_pvt</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>DTMF Menu Callback. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>bridge</em>&nbsp;</td><td>Bridge this is involving </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>bridge_channel</em>&nbsp;</td><td>Bridged channel this is involving </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>hook_pvt</em>&nbsp;</td><td>User's conference bridge structure</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00607">607</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="audiohook_8h_source.html#l00050">AST_AUDIOHOOK_DIRECTION_READ</a>, <a class="el" href="audiohook_8h_source.html#l00051">AST_AUDIOHOOK_DIRECTION_WRITE</a>, <a class="el" href="audiohook_8c_source.html#l00985">ast_audiohook_volume_adjust()</a>, <a class="el" href="bridging_8h_source.html#l00088">AST_BRIDGE_CHANNEL_STATE_WAIT</a>, <a class="el" href="bridging_8c_source.html#l01087">ast_bridge_remove()</a>, <a class="el" href="file_8h_source.html#l00047">AST_DIGIT_ANY</a>, <a class="el" href="linkedlists_8h_source.html#l00428">AST_LIST_LAST</a>, <a class="el" href="channel_8c_source.html#l05538">ast_moh_start()</a>, <a class="el" href="channel_8c_source.html#l05549">ast_moh_stop()</a>, <a class="el" href="file_8c_source.html#l00122">ast_stopstream()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="file_8c_source.html#l00943">ast_streamfile()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="file_8c_source.html#l01315">ast_waitstream()</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, <a class="el" href="bridging_8h_source.html#l00125">ast_bridge_channel::chan</a>, <a class="el" href="app__confbridge_8c_source.html#l00167">conference_bridge_user::conference_bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00171">conference_bridge_user::features</a>, <a class="el" href="app__confbridge_8c_source.html#l00169">conference_bridge_user::flags</a>, <a class="el" href="app__confbridge_8c_source.html#l00172">conference_bridge_user::kicked</a>, <a class="el" href="app__confbridge_8c_source.html#l00159">conference_bridge::locked</a>, <a class="el" href="app__confbridge_8c_source.html#l00158">conference_bridge::markedusers</a>, <a class="el" href="bridging__features_8h_source.html#l00096">ast_bridge_features::mute</a>, <a class="el" href="app__confbridge_8c_source.html#l00170">conference_bridge_user::opt_args</a>, <a class="el" href="app__confbridge_8c_source.html#l00118">OPTION_ADMIN</a>, <a class="el" href="app__confbridge_8c_source.html#l00120">OPTION_MUSICONHOLD</a>, <a class="el" href="app__confbridge_8c_source.html#l00130">OPTION_MUSICONHOLD_CLASS</a>, <a class="el" href="app__confbridge_8c_source.html#l00125">OPTION_WAITMARKED</a>, <a class="el" href="bridging_8h_source.html#l00123">ast_bridge_channel::state</a>, and <a class="el" href="app__confbridge_8c_source.html#l00157">conference_bridge::users</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00687">confbridge_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00608"></a>00608 {
<a name="l00609"></a>00609    <span class="keyword">struct </span><a class="code" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a> *<a class="code" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a> = hook_pvt;
<a name="l00610"></a>00610    <span class="keyword">struct </span><a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> *<a class="code" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> = conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a99f3edd6ca313abd8c3bd90ac074c044">conference_bridge</a>;
<a name="l00611"></a>00611    <span class="keywordtype">int</span> digit, res = 0, isadmin = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8">OPTION_ADMIN</a>);
<a name="l00612"></a>00612 
<a name="l00613"></a>00613    <span class="comment">/* See if music on hold is playing */</span>
<a name="l00614"></a>00614    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00615"></a>00615    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 1 &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>)) {
<a name="l00616"></a>00616       <span class="comment">/* Just us so MOH is probably indeed going, let&apos;s stop it */</span>
<a name="l00617"></a>00617       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00618"></a>00618    }
<a name="l00619"></a>00619    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00620"></a>00620 
<a name="l00621"></a>00621    <span class="comment">/* Try to play back the user menu, if it fails pass this back up so the bridging core will act on it */</span>
<a name="l00622"></a>00622    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, (isadmin ? <span class="stringliteral">&quot;conf-adminmenu&quot;</span> : <span class="stringliteral">&quot;conf-usermenu&quot;</span>), bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language)) {
<a name="l00623"></a>00623       res = -1;
<a name="l00624"></a>00624       <span class="keywordflow">goto</span> finished;
<a name="l00625"></a>00625    }
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <span class="comment">/* Wait for them to enter a digit from the user menu options */</span>
<a name="l00628"></a>00628    digit = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l00629"></a>00629    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631    <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;1&apos;</span>) {
<a name="l00632"></a>00632       <span class="comment">/* 1 - Mute or unmute yourself, note we only allow manipulation if they aren&apos;t waiting for a marked user or if marked users exist */</span>
<a name="l00633"></a>00633       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a83858d53c27d46d338330fb0175809f3">OPTION_WAITMARKED</a>) || conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a>) {
<a name="l00634"></a>00634          conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> = (!conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> ? 1 : 0);
<a name="l00635"></a>00635       }
<a name="l00636"></a>00636       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, (conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> ? <span class="stringliteral">&quot;conf-muted&quot;</span> : <span class="stringliteral">&quot;conf-unmuted&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00637"></a>00637    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isadmin &amp;&amp; digit == <span class="charliteral">&apos;2&apos;</span>) {
<a name="l00638"></a>00638       <span class="comment">/* 2 - Unlock or lock conference */</span>
<a name="l00639"></a>00639       conference_bridge-&gt;<a class="code" href="structconference__bridge.html#afa330a895fe8ef506be047091f21d940">locked</a> = (!conference_bridge-&gt;<a class="code" href="structconference__bridge.html#afa330a895fe8ef506be047091f21d940">locked</a> ? 1 : 0);
<a name="l00640"></a>00640       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#afa330a895fe8ef506be047091f21d940">locked</a> ? <span class="stringliteral">&quot;conf-lockednow&quot;</span> : <span class="stringliteral">&quot;conf-unlockednow&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l00641"></a>00641    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (isadmin &amp;&amp; digit == <span class="charliteral">&apos;3&apos;</span>) {
<a name="l00642"></a>00642       <span class="comment">/* 3 - Eject last user */</span>
<a name="l00643"></a>00643       <span class="keyword">struct </span>conference_bridge_user *last_participant = NULL;
<a name="l00644"></a>00644 
<a name="l00645"></a>00645       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00646"></a>00646       <span class="keywordflow">if</span> (((last_participant = <a class="code" href="linkedlists_8h.html#a1e37109bb72d95999821eb45f28c261c" title="Returns the last entry contained in a list.">AST_LIST_LAST</a>(&amp;conference_bridge-&gt;users_list)) == conference_bridge_user) || (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;last_participant-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04adfb84b141d66d583dc26e753d32579c8">OPTION_ADMIN</a>))) {
<a name="l00647"></a>00647          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00648"></a>00648          res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-errormenu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00649"></a>00649       } <span class="keywordflow">else</span> {
<a name="l00650"></a>00650          last_participant-&gt;<a class="code" href="structconference__bridge__user.html#a0afbbd980cfe1d7c564c0f7850a82ed9">kicked</a> = 1;
<a name="l00651"></a>00651          <a class="code" href="bridging_8h.html#a66d6a521530f4fb208eb8ee33e257b6c" title="Remove a channel from a bridge.">ast_bridge_remove</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, last_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00652"></a>00652          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00653"></a>00653       }
<a name="l00654"></a>00654    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;4&apos;</span>) {
<a name="l00655"></a>00655       <span class="comment">/* 4 - Decrease listening volume */</span>
<a name="l00656"></a>00656       <a class="code" href="audiohook_8h.html#acf8f4fc0dfd6a5f54e301ac66c5bc434" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_adjust</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>, -1);
<a name="l00657"></a>00657    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;6&apos;</span>) {
<a name="l00658"></a>00658       <span class="comment">/* 6 - Increase listening volume */</span>
<a name="l00659"></a>00659       <a class="code" href="audiohook_8h.html#acf8f4fc0dfd6a5f54e301ac66c5bc434" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_adjust</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>, 1);
<a name="l00660"></a>00660    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;7&apos;</span>) {
<a name="l00661"></a>00661       <span class="comment">/* 7 - Decrease talking volume */</span>
<a name="l00662"></a>00662       <a class="code" href="audiohook_8h.html#acf8f4fc0dfd6a5f54e301ac66c5bc434" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_adjust</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>, -1);
<a name="l00663"></a>00663    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;8&apos;</span>) {
<a name="l00664"></a>00664       <span class="comment">/* 8 - Exit the IVR */</span>
<a name="l00665"></a>00665    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;9&apos;</span>) {
<a name="l00666"></a>00666       <span class="comment">/* 9 - Increase talking volume */</span>
<a name="l00667"></a>00667       <a class="code" href="audiohook_8h.html#acf8f4fc0dfd6a5f54e301ac66c5bc434" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_adjust</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>, 1);
<a name="l00668"></a>00668    } <span class="keywordflow">else</span> {
<a name="l00669"></a>00669       <span class="comment">/* No valid option was selected */</span>
<a name="l00670"></a>00670       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-errormenu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00671"></a>00671    }
<a name="l00672"></a>00672 
<a name="l00673"></a>00673  finished:
<a name="l00674"></a>00674    <span class="comment">/* See if music on hold needs to be started back up again */</span>
<a name="l00675"></a>00675    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00676"></a>00676    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 1 &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>)) {
<a name="l00677"></a>00677       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a328db3a83a9599f21163ec53525d2d1c">opt_args</a>[<a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>], NULL);
<a name="l00678"></a>00678    }
<a name="l00679"></a>00679    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    bridge_channel-&gt;<a class="code" href="structast__bridge__channel.html#a5a8dce45720cd4222feb34abbdaa2c40">state</a> = <a class="code" href="bridging_8h.html#a78f46aa0abbe1f3bf98be03c884203a7a82e437d5aa10df5114a21ae794bce625">AST_BRIDGE_CHANNEL_STATE_WAIT</a>;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    <span class="keywordflow">return</span> res;
<a name="l00684"></a>00684 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aaee9253d8c8fe7016405a64f359ef921"></a><!-- doxytag: member="app_confbridge.c::play_prompt_to_channel" ref="aaee9253d8c8fe7016405a64f359ef921" args="(struct conference_bridge *conference_bridge, struct ast_channel *chan, const char *file)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void play_prompt_to_channel </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>file</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Play back an audio file to a channel. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a></em>&nbsp;</td><td>Conference bridge they are in </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>Channel to play audio prompt to </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>file</em>&nbsp;</td><td>Prompt to play</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns nothing</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>This function assumes that <a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a> is locked </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00238">238</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, and <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00253">post_join_marked()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00320">post_join_unmarked()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00239"></a>00239 {
<a name="l00240"></a>00240    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00241"></a>00241    <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, file, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00242"></a>00242    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00243"></a>00243 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afc71c2a33b0d5fe94ae660beaf6370e1"></a><!-- doxytag: member="app_confbridge.c::play_sound_file" ref="afc71c2a33b0d5fe94ae660beaf6370e1" args="(struct conference_bridge *conference_bridge, const char *filename)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int play_sound_file </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>filename</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Play <a class="el" href="structsound.html">sound</a> file into conference bridge. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a></em>&nbsp;</td><td>The conference bridge to play <a class="el" href="structsound.html">sound</a> file into </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>filename</em>&nbsp;</td><td>Sound file to play</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00554">554</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="bridging_8c_source.html#l01064">ast_bridge_depart()</a>, <a class="el" href="bridging_8c_source.html#l01030">ast_bridge_impart()</a>, <a class="el" href="channel_8c_source.html#l04042">ast_call()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="frame_8h_source.html#l00253">AST_FORMAT_SLINEAR</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="channel_8c_source.html#l03986">ast_request()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="channel_8c_source.html#l00136">cause</a>, and <a class="el" href="app__confbridge_8c_source.html#l00155">conference_bridge::name</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00687">confbridge_exec()</a>, <a class="el" href="app__confbridge_8c_source.html#l00485">leave_conference_bridge()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00253">post_join_marked()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00555"></a>00555 {
<a name="l00556"></a>00556    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *underlying_channel;
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conference_bridge-&gt;playback_lock);
<a name="l00559"></a>00559 
<a name="l00560"></a>00560    <span class="keywordflow">if</span> (!(conference_bridge-&gt;playback_chan)) {
<a name="l00561"></a>00561       <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>;
<a name="l00562"></a>00562 
<a name="l00563"></a>00563       <span class="keywordflow">if</span> (!(conference_bridge-&gt;playback_chan = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(<span class="stringliteral">&quot;Bridge&quot;</span>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>, <span class="stringliteral">&quot;&quot;</span>, &amp;cause))) {
<a name="l00564"></a>00564          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conference_bridge-&gt;playback_lock);
<a name="l00565"></a>00565          <span class="keywordflow">return</span> -1;
<a name="l00566"></a>00566       }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568       conference_bridge-&gt;playback_chan-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a> = conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ae212e5f3ae50a869bbf859fe9db7dee0" title="Make a call.">ast_call</a>(conference_bridge-&gt;playback_chan, <span class="stringliteral">&quot;&quot;</span>, 0)) {
<a name="l00571"></a>00571          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(conference_bridge-&gt;playback_chan);
<a name="l00572"></a>00572          conference_bridge-&gt;playback_chan = NULL;
<a name="l00573"></a>00573          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conference_bridge-&gt;playback_lock);
<a name="l00574"></a>00574          <span class="keywordflow">return</span> -1;
<a name="l00575"></a>00575       }
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Created a playback channel to conference bridge &apos;%s&apos;\n&quot;</span>, conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a11c38fccfc194cc0f316e77f4494516f">name</a>);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579       underlying_channel = conference_bridge-&gt;playback_chan-&gt;tech-&gt;bridged_channel(conference_bridge-&gt;playback_chan, NULL);
<a name="l00580"></a>00580    } <span class="keywordflow">else</span> {
<a name="l00581"></a>00581       <span class="comment">/* Channel was already available so we just need to add it back into the bridge */</span>
<a name="l00582"></a>00582       underlying_channel = conference_bridge-&gt;playback_chan-&gt;tech-&gt;bridged_channel(conference_bridge-&gt;playback_chan, NULL);
<a name="l00583"></a>00583       <a class="code" href="bridging_8h.html#a25866ef7f32ed6b8f49bd4bf8a8721d7" title="Impart (non-blocking) a channel on a bridge.">ast_bridge_impart</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, underlying_channel, NULL, NULL);
<a name="l00584"></a>00584    }
<a name="l00585"></a>00585 
<a name="l00586"></a>00586    <span class="comment">/* The channel is all under our control, in goes the prompt */</span>
<a name="l00587"></a>00587    <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(conference_bridge-&gt;playback_chan, filename, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Departing underlying channel &apos;%s&apos; from bridge &apos;%p&apos;\n&quot;</span>, underlying_channel-&gt;name, conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>);
<a name="l00590"></a>00590    <a class="code" href="bridging_8h.html#a2b432942317147cc6c42d1f0c0730393" title="Depart a channel from a bridge.">ast_bridge_depart</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, underlying_channel);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conference_bridge-&gt;playback_lock);
<a name="l00593"></a>00593 
<a name="l00594"></a>00594    <span class="keywordflow">return</span> 0;
<a name="l00595"></a>00595 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa42f4e2be05e276ba0666f74f073b4c7"></a><!-- doxytag: member="app_confbridge.c::post_join_marked" ref="aa42f4e2be05e276ba0666f74f073b4c7" args="(struct conference_bridge *conference_bridge, struct conference_bridge_user *conference_bridge_user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void post_join_marked </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge_user</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Perform post-joining marked specific <a class="el" href="structactions.html" title="list of actions registered">actions</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a></em>&nbsp;</td><td>Conference bridge being joined </td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a></em>&nbsp;</td><td>Conference bridge <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> joining</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns nothing </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00253">253</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="bridging_8c_source.html#l01187">ast_bridge_suspend()</a>, <a class="el" href="bridging_8c_source.html#l01205">ast_bridge_unsuspend()</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="channel_8c_source.html#l05538">ast_moh_start()</a>, <a class="el" href="channel_8c_source.html#l05549">ast_moh_stop()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, <a class="el" href="app__confbridge_8c_source.html#l00171">conference_bridge_user::features</a>, <a class="el" href="app__confbridge_8c_source.html#l00169">conference_bridge_user::flags</a>, <a class="el" href="app__confbridge_8c_source.html#l00158">conference_bridge::markedusers</a>, <a class="el" href="bridging__features_8h_source.html#l00096">ast_bridge_features::mute</a>, <a class="el" href="app__confbridge_8c_source.html#l00170">conference_bridge_user::opt_args</a>, <a class="el" href="app__confbridge_8c_source.html#l00124">OPTION_MARKEDUSER</a>, <a class="el" href="app__confbridge_8c_source.html#l00120">OPTION_MUSICONHOLD</a>, <a class="el" href="app__confbridge_8c_source.html#l00130">OPTION_MUSICONHOLD_CLASS</a>, <a class="el" href="app__chanspy_8c_source.html#l00297">OPTION_QUIET</a>, <a class="el" href="app__confbridge_8c_source.html#l00238">play_prompt_to_channel()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00554">play_sound_file()</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00394">join_conference_bridge()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00254"></a>00254 {
<a name="l00255"></a>00255    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a33f60e63a19d7f778ace7b1a0e0d8cc8">OPTION_MARKEDUSER</a>)) {
<a name="l00256"></a>00256       <span class="keyword">struct </span>conference_bridge_user *other_conference_bridge_user = NULL;
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       <span class="comment">/* If we are not the first marked user to join just bail out now */</span>
<a name="l00259"></a>00259       <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a> &gt;= 2) {
<a name="l00260"></a>00260          <span class="keywordflow">return</span>;
<a name="l00261"></a>00261       }
<a name="l00262"></a>00262 
<a name="l00263"></a>00263       <span class="comment">/* Iterate through every participant stopping MOH on them if need be */</span>
<a name="l00264"></a>00264       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conference_bridge-&gt;users_list, other_conference_bridge_user, list) {
<a name="l00265"></a>00265          <span class="keywordflow">if</span> (other_conference_bridge_user == conference_bridge_user) {
<a name="l00266"></a>00266             <span class="keywordflow">continue</span>;
<a name="l00267"></a>00267          }
<a name="l00268"></a>00268          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;other_conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>) &amp;&amp; !<a class="code" href="bridging_8h.html#a85bc0d4138ac2af7b207d8f1325f051a" title="Suspend a channel temporarily from a bridge.">ast_bridge_suspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, other_conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00269"></a>00269             <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(other_conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00270"></a>00270             <a class="code" href="bridging_8h.html#aab4cd1153d39a6744eca6a84d5255820" title="Unsuspend a channel from a bridge.">ast_bridge_unsuspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, other_conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00271"></a>00271          }
<a name="l00272"></a>00272       }
<a name="l00273"></a>00273 
<a name="l00274"></a>00274       <span class="comment">/* Next play the audio file stating they are going to be placed into the conference */</span>
<a name="l00275"></a>00275       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>)) {
<a name="l00276"></a>00276          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00277"></a>00277          <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00278"></a>00278          <a class="code" href="app__confbridge_8c.html#afc71c2a33b0d5fe94ae660beaf6370e1" title="Play sound file into conference bridge.">play_sound_file</a>(conference_bridge, <span class="stringliteral">&quot;conf-placeintoconf&quot;</span>);
<a name="l00279"></a>00279          <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00280"></a>00280          <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00281"></a>00281       }
<a name="l00282"></a>00282 
<a name="l00283"></a>00283       <span class="comment">/* Finally iterate through and unmute them all */</span>
<a name="l00284"></a>00284       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conference_bridge-&gt;users_list, other_conference_bridge_user, list) {
<a name="l00285"></a>00285          <span class="keywordflow">if</span> (other_conference_bridge_user == conference_bridge_user) {
<a name="l00286"></a>00286             <span class="keywordflow">continue</span>;
<a name="l00287"></a>00287          }
<a name="l00288"></a>00288          other_conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> = 0;
<a name="l00289"></a>00289       }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    } <span class="keywordflow">else</span> {
<a name="l00292"></a>00292       <span class="comment">/* If a marked user already exists in the conference bridge we can just bail out now */</span>
<a name="l00293"></a>00293       <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a>) {
<a name="l00294"></a>00294          <span class="keywordflow">return</span>;
<a name="l00295"></a>00295       }
<a name="l00296"></a>00296       <span class="comment">/* Be sure we are muted so we can&apos;t talk to anybody else waiting */</span>
<a name="l00297"></a>00297       conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aa5f7287d4bbab0f62a1bae18af89171d">features</a>.<a class="code" href="structast__bridge__features.html#aa09e22acd94cd548a204c100e11fd612">mute</a> = 1;
<a name="l00298"></a>00298       <span class="comment">/* If we have not been quieted play back that they are waiting for the leader */</span>
<a name="l00299"></a>00299       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>)) {
<a name="l00300"></a>00300          <a class="code" href="app__confbridge_8c.html#aaee9253d8c8fe7016405a64f359ef921" title="Play back an audio file to a channel.">play_prompt_to_channel</a>(conference_bridge, conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-waitforleader&quot;</span>);
<a name="l00301"></a>00301       }
<a name="l00302"></a>00302       <span class="comment">/* Start music on hold if needed */</span>
<a name="l00303"></a>00303       <span class="comment">/* We need to recheck the markedusers value here. play_prompt_to_channel unlocks the conference bridge, potentially</span>
<a name="l00304"></a>00304 <span class="comment">       * allowing a marked user to enter while the prompt was playing</span>
<a name="l00305"></a>00305 <span class="comment">       */</span>
<a name="l00306"></a>00306       <span class="keywordflow">if</span> (!conference_bridge-&gt;<a class="code" href="structconference__bridge.html#abccd4b1475b8b192c029e77ff0ded0c3">markedusers</a> &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>)) {
<a name="l00307"></a>00307          <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a328db3a83a9599f21163ec53525d2d1c">opt_args</a>[<a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>], NULL);
<a name="l00308"></a>00308       }
<a name="l00309"></a>00309    }
<a name="l00310"></a>00310 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae08d149204b5b50e271873fc066ce204"></a><!-- doxytag: member="app_confbridge.c::post_join_unmarked" ref="ae08d149204b5b50e271873fc066ce204" args="(struct conference_bridge *conference_bridge, struct conference_bridge_user *conference_bridge_user)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void post_join_unmarked </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge.html">conference_bridge</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structconference__bridge__user.html">conference_bridge_user</a> *&nbsp;</td>
          <td class="paramname"> <em>conference_bridge_user</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Perform post-joining non-marked specific <a class="el" href="structactions.html" title="list of actions registered">actions</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge.html" title="The structure that represents a conference bridge.">conference_bridge</a></em>&nbsp;</td><td>Conference bridge being joined </td></tr>
    <tr><td valign="top"></td><td valign="top"><em><a class="el" href="structconference__bridge__user.html" title="The structure that represents a conference bridge user.">conference_bridge_user</a></em>&nbsp;</td><td>Conference bridge <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> joining</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Returns nothing </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00320">320</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="app__confbridge_8c_source.html#l00203">announce_user_count()</a>, <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="bridging_8c_source.html#l01187">ast_bridge_suspend()</a>, <a class="el" href="bridging_8c_source.html#l01205">ast_bridge_unsuspend()</a>, <a class="el" href="linkedlists_8h_source.html#l00420">AST_LIST_FIRST</a>, <a class="el" href="channel_8c_source.html#l05538">ast_moh_start()</a>, <a class="el" href="channel_8c_source.html#l05549">ast_moh_stop()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="app__confbridge_8c_source.html#l00156">conference_bridge::bridge</a>, <a class="el" href="app__confbridge_8c_source.html#l00168">conference_bridge_user::chan</a>, <a class="el" href="app__confbridge_8c_source.html#l00169">conference_bridge_user::flags</a>, <a class="el" href="app__confbridge_8c_source.html#l00170">conference_bridge_user::opt_args</a>, <a class="el" href="app__confbridge_8c_source.html#l00123">OPTION_ANNOUNCEUSERCOUNT</a>, <a class="el" href="app__confbridge_8c_source.html#l00120">OPTION_MUSICONHOLD</a>, <a class="el" href="app__confbridge_8c_source.html#l00130">OPTION_MUSICONHOLD_CLASS</a>, <a class="el" href="app__confbridge_8c_source.html#l00121">OPTION_NOONLYPERSON</a>, <a class="el" href="app__chanspy_8c_source.html#l00297">OPTION_QUIET</a>, <a class="el" href="app__confbridge_8c_source.html#l00238">play_prompt_to_channel()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00157">conference_bridge::users</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00394">join_conference_bridge()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00321"></a>00321 {
<a name="l00322"></a>00322    <span class="comment">/* Play back audio prompt and start MOH if need be if we are the first participant */</span>
<a name="l00323"></a>00323    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 1) {
<a name="l00324"></a>00324       <span class="comment">/* If audio prompts have not been quieted or this prompt quieted play it on out */</span>
<a name="l00325"></a>00325       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a> | <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04a96c908c57e1804edef831ce961258d88">OPTION_NOONLYPERSON</a>)) {
<a name="l00326"></a>00326          <a class="code" href="app__confbridge_8c.html#aaee9253d8c8fe7016405a64f359ef921" title="Play back an audio file to a channel.">play_prompt_to_channel</a>(conference_bridge, conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;conf-onlyperson&quot;</span>);
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328       <span class="comment">/* If we need to start music on hold on the channel do so now */</span>
<a name="l00329"></a>00329       <span class="comment">/* We need to re-check the number of users in the conference bridge here because another conference bridge</span>
<a name="l00330"></a>00330 <span class="comment">       * participant could have joined while the above prompt was playing for the first user.</span>
<a name="l00331"></a>00331 <span class="comment">       */</span>
<a name="l00332"></a>00332       <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 1 &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>)) {
<a name="l00333"></a>00333          <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#a328db3a83a9599f21163ec53525d2d1c">opt_args</a>[<a class="code" href="app__confbridge_8c.html#adc29c2ff13d900c2f185ee95427fb06ca6d51457f40688747f0f9e4fa56c6a3f3">OPTION_MUSICONHOLD_CLASS</a>], NULL);
<a name="l00334"></a>00334       }
<a name="l00335"></a>00335       <span class="keywordflow">return</span>;
<a name="l00336"></a>00336    }
<a name="l00337"></a>00337 
<a name="l00338"></a>00338    <span class="comment">/* Announce number of users if need be */</span>
<a name="l00339"></a>00339    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;conference_bridge_user-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04ab3d3d664ddd8b1e2cdfaf34efcc01c4f">OPTION_ANNOUNCEUSERCOUNT</a>)) {
<a name="l00340"></a>00340       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(conference_bridge);
<a name="l00341"></a>00341       <a class="code" href="app__confbridge_8c.html#a5e6676d2b4d985b8fb2f0ecb3c46c5ee" title="Announce number of users in the conference bridge to the caller.">announce_user_count</a>(conference_bridge, conference_bridge_user);
<a name="l00342"></a>00342       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(conference_bridge);
<a name="l00343"></a>00343    }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345    <span class="comment">/* If we are the second participant we may need to stop music on hold on the first */</span>
<a name="l00346"></a>00346    <span class="keywordflow">if</span> (conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a8c1ab444244d71919e0dadb111c8c50c">users</a> == 2) {
<a name="l00347"></a>00347       <span class="keyword">struct </span>conference_bridge_user *first_participant = <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;conference_bridge-&gt;users_list);
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       <span class="comment">/* Temporarily suspend the above participant from the bridge so we have control to stop MOH if needed */</span>
<a name="l00350"></a>00350       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;first_participant-&gt;<a class="code" href="structconference__bridge__user.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="app__confbridge_8c.html#abc6126af1d45847bc59afa0aa3216b04aed3ea61919b17dde21ae2231f40a4598">OPTION_MUSICONHOLD</a>) &amp;&amp; !<a class="code" href="bridging_8h.html#a85bc0d4138ac2af7b207d8f1325f051a" title="Suspend a channel temporarily from a bridge.">ast_bridge_suspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00351"></a>00351          <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00352"></a>00352          <a class="code" href="bridging_8h.html#aab4cd1153d39a6744eca6a84d5255820" title="Unsuspend a channel from a bridge.">ast_bridge_unsuspend</a>(conference_bridge-&gt;<a class="code" href="structconference__bridge.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>, first_participant-&gt;<a class="code" href="structconference__bridge__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00353"></a>00353       }
<a name="l00354"></a>00354    }
<a name="l00355"></a>00355 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="app_confbridge.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Called when module is being unloaded. </p>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00788">788</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="pbx_8c_source.html#l06403">ast_unregister_application()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00177">conference_bridges</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00789"></a>00789 {
<a name="l00790"></a>00790    <span class="keywordtype">int</span> res = <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>);
<a name="l00791"></a>00791 
<a name="l00792"></a>00792    <span class="comment">/* Get rid of the conference bridges container. Since we only allow dynamic ones none will be active. */</span>
<a name="l00793"></a>00793    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e" title="Container to hold all conference bridges in progress.">conference_bridges</a>, -1);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795    <span class="keywordflow">return</span> res;
<a name="l00796"></a>00796 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a83a793edb3d6a3a15f2a7fc99ffe8c90"></a><!-- doxytag: member="app_confbridge.c::app" ref="a83a793edb3d6a3a15f2a7fc99ffe8c90" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* <a class="el" href="res__agi_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = &quot;ConfBridge&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl class="user"><dt><b>Playing back a file to a channel in a conference</b></dt><dd>You might notice in this application that while playing a <a class="el" href="structsound.html">sound</a> file to a channel the actual conference bridge lock is not held. This is done so that other <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> are not blocked from interacting with the conference bridge. Unfortunately because of this it is possible for things to change after the <a class="el" href="structsound.html">sound</a> file is done being played. Data must therefore be checked after reacquiring the conference bridge lock if it is important. </dd></dl>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00115">115</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

</div>
</div>
<a class="anchor" id="aba18f75e10a4c0aaa4d6de41aa30c09e"></a><!-- doxytag: member="app_confbridge.c::conference_bridges" ref="aba18f75e10a4c0aaa4d6de41aa30c09e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structao2__container.html">ao2_container</a>* <a class="el" href="app__confbridge_8c.html#aba18f75e10a4c0aaa4d6de41aa30c09e">conference_bridges</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Container to hold all conference bridges in <a class="el" href="structprogress.html">progress</a>. </p>

<p>Definition at line <a class="el" href="app__confbridge_8c_source.html#l00177">177</a> of file <a class="el" href="app__confbridge_8c_source.html">app_confbridge.c</a>.</p>

<p>Referenced by <a class="el" href="app__confbridge_8c_source.html#l00394">join_conference_bridge()</a>, <a class="el" href="app__confbridge_8c_source.html#l00485">leave_conference_bridge()</a>, <a class="el" href="app__confbridge_8c_source.html#l00799">load_module()</a>, and <a class="el" href="app__confbridge_8c_source.html#l00788">unload_module()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:54 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
