<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:11 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_crypto.c File Reference</h1>
<p>Provide Cryptographic Signature capability.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &lt;openssl/ssl.h&gt;</code><br/>
<code>#include &lt;openssl/err.h&gt;</code><br/>
<code>#include &lt;dirent.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="crypto_8h_source.html">asterisk/crypto.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="md5_8h_source.html">asterisk/md5.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="io_8h_source.html">asterisk/io.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>

<p><a href="res__crypto_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__key.html">ast_key</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structkeys.html">keys</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>&nbsp;&nbsp;&nbsp;&quot;%-18s %-8s %-16s %-33s\n&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>&nbsp;&nbsp;&nbsp;(1 &lt;&lt; 16)</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a47ea0a07bdecf6e564a85c53f8bf678a">__ast_check_signature</a> (struct <a class="el" href="structast__key.html">ast_key</a> *key, const char *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, const char *sig)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">base64 decode then sent to __ast_check_signature_bin  <a href="#a47ea0a07bdecf6e564a85c53f8bf678a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#af09836a36dc290e9b9ac8ea1d5769975">__ast_check_signature_bin</a> (struct <a class="el" href="structast__key.html">ast_key</a> *key, const char *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, int <a class="el" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, const unsigned char *dsig)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">check signature of a <a class="el" href="structmessage.html">message</a>  <a href="#af09836a36dc290e9b9ac8ea1d5769975"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a2356e21f17002e32926bd8735e7111b2">__ast_decrypt_bin</a> (unsigned char *dst, const unsigned char *src, int srclen, struct <a class="el" href="structast__key.html">ast_key</a> *key)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">decrypt a <a class="el" href="structmessage.html">message</a>  <a href="#a2356e21f17002e32926bd8735e7111b2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a7eaf0b18e766300c6f5f6a5d97ac409e">__ast_encrypt_bin</a> (unsigned char *dst, const unsigned char *src, int srclen, struct <a class="el" href="structast__key.html">ast_key</a> *key)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">encrypt a <a class="el" href="structmessage.html">message</a>  <a href="#a7eaf0b18e766300c6f5f6a5d97ac409e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a30abfec91d1a3e0fd585675d9fd8f297">__ast_key_get</a> (const char *kname, int ktype)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">return the <a class="el" href="structast__key.html">ast_key</a> structure for name  <a href="#a30abfec91d1a3e0fd585675d9fd8f297"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#aa72f25fe6809be13ce00022d2148c68e">__ast_sign</a> (struct <a class="el" href="structast__key.html">ast_key</a> *key, char *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, char *sig)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">wrapper for __ast_sign_bin then base64 encode it  <a href="#aa72f25fe6809be13ce00022d2148c68e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#aeff97278c4bc6d860ae743b9fd9e95f7">__ast_sign_bin</a> (struct <a class="el" href="structast__key.html">ast_key</a> *key, const char *<a class="el" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, int <a class="el" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, unsigned char *dsig)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">signs <a class="el" href="structoutgoing.html">outgoing</a> <a class="el" href="structmessage.html">message</a> with public key  <a href="#aeff97278c4bc6d860ae743b9fd9e95f7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#afe66c89b5695ee92f3f6125397c7573b">crypto_init</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">initialise the res_crypto module  <a href="#afe66c89b5695ee92f3f6125397c7573b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853">crypto_load</a> (int ifd, int ofd)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">refresh RSA <a class="el" href="structkeys.html">keys</a> from file  <a href="#a94ec58f8f5d3c47fa527da2eab8a4853"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a4483abe7b118418ecf2e559f5367313b">handle_cli_keys_init</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">initialize all RSA <a class="el" href="structkeys.html">keys</a>  <a href="#a4483abe7b118418ecf2e559f5367313b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a849125df8a0e30d08efe31e86729fffe">handle_cli_keys_show</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">show the list of RSA <a class="el" href="structkeys.html">keys</a>  <a href="#a849125df8a0e30d08efe31e86729fffe"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#a72c787a063d771439dadf924d51018f1">md52sum</a> (char *sum, unsigned char *md5)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218">pw_cb</a> (char *<a class="el" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, int size, int rwflag, void *userdata)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">setting of priv key  <a href="#ad29e293470b893d5d245c8f801c40218"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731">try_load_key</a> (const char *<a class="el" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, const char *fname, int ifd, int ofd, int *not2)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">load RSA key from file  <a href="#adeba9b20c20b7b76c7deb63af67f5731"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Cryptographic Digital Signatures&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a> []</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Provide Cryptographic Signature capability. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt;</dd></dl>
<dl class="extref"><dt><b><a class="el" href="extref.html#_extref000020">ExtRef:</a></b></dt><dd>Uses the OpenSSL library, available at <a href="http://www.openssl.org/">http://www.openssl.org/</a> </dd></dl>

<p>Definition in file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ac8dc47e3b39c930caed4bfd05b4ba805"></a><!-- doxytag: member="res_crypto.c::FORMAT" ref="ac8dc47e3b39c930caed4bfd05b4ba805" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define FORMAT&nbsp;&nbsp;&nbsp;&quot;%-18s %-8s %-16s %-33s\n&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a01d6bf8d0a54c0a8c00396ad239e1952"></a><!-- doxytag: member="res_crypto.c::KEY_NEEDS_PASSCODE" ref="a01d6bf8d0a54c0a8c00396ad239e1952" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define KEY_NEEDS_PASSCODE&nbsp;&nbsp;&nbsp;(1 &lt;&lt; 16)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00063">63</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00544">handle_cli_keys_init()</a>, <a class="el" href="res__crypto_8c_source.html#l00498">handle_cli_keys_show()</a>, and <a class="el" href="res__crypto_8c_source.html#l00153">try_load_key()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a47ea0a07bdecf6e564a85c53f8bf678a"></a><!-- doxytag: member="res_crypto.c::__ast_check_signature" ref="a47ea0a07bdecf6e564a85c53f8bf678a" args="(struct ast_key *key, const char *msg, const char *sig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_check_signature </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>sig</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>base64 decode then sent to __ast_check_signature_bin </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="crypto_8h.html#a50332dc613df6416ba467b5bde4934e2" title="Check the authenticity of a message signature using a given public key.">ast_check_signature</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00421">421</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="utils_8c_source.html#l00264">ast_base64decode()</a>, <a class="el" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9">ast_check_signature_bin</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00422"></a>00422 {
<a name="l00423"></a>00423    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsig[128];
<a name="l00424"></a>00424    <span class="keywordtype">int</span> res;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426    <span class="comment">/* Decode signature */</span>
<a name="l00427"></a>00427    <span class="keywordflow">if</span> ((res = <a class="code" href="utils_8h.html#a1e7e06bd20719ecfd58b67f230780ffa" title="Decode data from base64.">ast_base64decode</a>(dsig, sig, <span class="keyword">sizeof</span>(dsig))) != <span class="keyword">sizeof</span>(dsig)) {
<a name="l00428"></a>00428       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Signature improper length (expect %d, got %d)\n&quot;</span>, (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(dsig), (<span class="keywordtype">int</span>)res);
<a name="l00429"></a>00429       <span class="keywordflow">return</span> -1;
<a name="l00430"></a>00430    }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    res = <a class="code" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9" title="Check the authenticity of a message signature using a given public key.">ast_check_signature_bin</a>(key, <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, strlen(<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>), dsig);
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    <span class="keywordflow">return</span> res;
<a name="l00435"></a>00435 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af09836a36dc290e9b9ac8ea1d5769975"></a><!-- doxytag: member="res_crypto.c::__ast_check_signature_bin" ref="af09836a36dc290e9b9ac8ea1d5769975" args="(struct ast_key *key, const char *msg, int msglen, const unsigned char *dsig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_check_signature_bin </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>msglen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned char *&nbsp;</td>
          <td class="paramname"> <em>dsig</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>check signature of a <a class="el" href="structmessage.html">message</a> </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9" title="Check the authenticity of a message signature using a given public key.">ast_check_signature_bin</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00392">392</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="crypto_8h_source.html#l00030">AST_KEY_PUBLIC</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="res__crypto_8c_source.html#l00081">ast_key::digest</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>, and <a class="el" href="res__crypto_8c_source.html#l00073">ast_key::rsa</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00393"></a>00393 {
<a name="l00394"></a>00394    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[20];
<a name="l00395"></a>00395    <span class="keywordtype">int</span> res;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>) {
<a name="l00398"></a>00398       <span class="comment">/* Okay, so of course you really *can* but for our purposes</span>
<a name="l00399"></a>00399 <span class="comment">         we&apos;re going to say you can&apos;t */</span>
<a name="l00400"></a>00400       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot check message signature with a private key\n&quot;</span>);
<a name="l00401"></a>00401       <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402    }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <span class="comment">/* Calculate digest of message */</span>
<a name="l00405"></a>00405    SHA1((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, digest);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407    <span class="comment">/* Verify signature */</span>
<a name="l00408"></a>00408    <span class="keywordflow">if</span> (!(res = RSA_verify(NID_sha1, digest, <span class="keyword">sizeof</span>(digest), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)dsig, 128, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>))) {
<a name="l00409"></a>00409       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Key failed verification: %s\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00410"></a>00410       <span class="keywordflow">return</span> -1;
<a name="l00411"></a>00411    }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <span class="comment">/* Pass */</span>
<a name="l00414"></a>00414    <span class="keywordflow">return</span> 0;
<a name="l00415"></a>00415 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2356e21f17002e32926bd8735e7111b2"></a><!-- doxytag: member="res_crypto.c::__ast_decrypt_bin" ref="a2356e21f17002e32926bd8735e7111b2" args="(unsigned char *dst, const unsigned char *src, int srclen, struct ast_key *key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_decrypt_bin </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned char *&nbsp;</td>
          <td class="paramname"> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>srclen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td>
          <td class="paramname"> <em>key</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>decrypt a <a class="el" href="structmessage.html">message</a> </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="crypto_8h.html#ac28ff1b7a9621b7542f4f120b23c16ec" title="Decrypt a message using a given private key.">ast_decrypt_bin</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00315">315</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="crypto_8h_source.html#l00031">AST_KEY_PRIVATE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="res__crypto_8c_source.html#l00073">ast_key::rsa</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00316"></a>00316 {
<a name="l00317"></a>00317    <span class="keywordtype">int</span> res, pos = 0;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>) {
<a name="l00320"></a>00320       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot decrypt with a public key\n&quot;</span>);
<a name="l00321"></a>00321       <span class="keywordflow">return</span> -1;
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <span class="keywordflow">if</span> (srclen % 128) {
<a name="l00325"></a>00325       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Tried to decrypt something not a multiple of 128 bytes\n&quot;</span>);
<a name="l00326"></a>00326       <span class="keywordflow">return</span> -1;
<a name="l00327"></a>00327    }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    <span class="keywordflow">while</span>(srclen) {
<a name="l00330"></a>00330       <span class="comment">/* Process chunks 128 bytes at a time */</span>
<a name="l00331"></a>00331       <span class="keywordflow">if</span> ((res = RSA_private_decrypt(128, src, dst, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>, RSA_PKCS1_OAEP_PADDING)) &lt; 0)
<a name="l00332"></a>00332          <span class="keywordflow">return</span> -1;
<a name="l00333"></a>00333       pos += res;
<a name="l00334"></a>00334       src += 128;
<a name="l00335"></a>00335       srclen -= 128;
<a name="l00336"></a>00336       dst += res;
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339    <span class="keywordflow">return</span> pos;
<a name="l00340"></a>00340 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7eaf0b18e766300c6f5f6a5d97ac409e"></a><!-- doxytag: member="res_crypto.c::__ast_encrypt_bin" ref="a7eaf0b18e766300c6f5f6a5d97ac409e" args="(unsigned char *dst, const unsigned char *src, int srclen, struct ast_key *key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_encrypt_bin </td>
          <td>(</td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>dst</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const unsigned char *&nbsp;</td>
          <td class="paramname"> <em>src</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>srclen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td>
          <td class="paramname"> <em>key</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>encrypt a <a class="el" href="structmessage.html">message</a> </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="crypto_8h.html#aacb22f7c29907031152630b4628014fc" title="Encrypt a message using a given private key.">ast_encrypt_bin</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00346">346</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="crypto_8h_source.html#l00030">AST_KEY_PUBLIC</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="res__crypto_8c_source.html#l00073">ast_key::rsa</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00347"></a>00347 {
<a name="l00348"></a>00348    <span class="keywordtype">int</span> res, bytes, pos = 0;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>) {
<a name="l00351"></a>00351       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot encrypt with a private key\n&quot;</span>);
<a name="l00352"></a>00352       <span class="keywordflow">return</span> -1;
<a name="l00353"></a>00353    }
<a name="l00354"></a>00354    
<a name="l00355"></a>00355    <span class="keywordflow">while</span>(srclen) {
<a name="l00356"></a>00356       bytes = srclen;
<a name="l00357"></a>00357       <span class="keywordflow">if</span> (bytes &gt; 128 - 41)
<a name="l00358"></a>00358          bytes = 128 - 41;
<a name="l00359"></a>00359       <span class="comment">/* Process chunks 128-41 bytes at a time */</span>
<a name="l00360"></a>00360       <span class="keywordflow">if</span> ((res = RSA_public_encrypt(bytes, src, dst, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>, RSA_PKCS1_OAEP_PADDING)) != 128) {
<a name="l00361"></a>00361          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;How odd, encrypted size is %d\n&quot;</span>, res);
<a name="l00362"></a>00362          <span class="keywordflow">return</span> -1;
<a name="l00363"></a>00363       }
<a name="l00364"></a>00364       src += bytes;
<a name="l00365"></a>00365       srclen -= bytes;
<a name="l00366"></a>00366       pos += res;
<a name="l00367"></a>00367       dst += res;
<a name="l00368"></a>00368    }
<a name="l00369"></a>00369    <span class="keywordflow">return</span> pos;
<a name="l00370"></a>00370 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a30abfec91d1a3e0fd585675d9fd8f297"></a><!-- doxytag: member="res_crypto.c::__ast_key_get" ref="a30abfec91d1a3e0fd585675d9fd8f297" args="(const char *kname, int ktype)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__key.html">ast_key</a>* __ast_key_get </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>kname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ktype</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>return the <a class="el" href="structast__key.html">ast_key</a> structure for name </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="cryptostub_8c.html#ae616a3ae122fcb33a6f5937dc1295718" title="Retrieve a key.">ast_key_get</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00128">128</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">ast_key::list</a>, and <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00133"></a>00133    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00134"></a>00134       <span class="keywordflow">if</span> (!strcmp(kname, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>) &amp;&amp;
<a name="l00135"></a>00135           (<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>))
<a name="l00136"></a>00136          <span class="keywordflow">break</span>;
<a name="l00137"></a>00137    }
<a name="l00138"></a>00138    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    <span class="keywordflow">return</span> key;
<a name="l00141"></a>00141 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa72f25fe6809be13ce00022d2148c68e"></a><!-- doxytag: member="res_crypto.c::__ast_sign" ref="aa72f25fe6809be13ce00022d2148c68e" args="(struct ast_key *key, char *msg, char *sig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_sign </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>sig</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>wrapper for __ast_sign_bin then base64 encode it </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="crypto_8h.html#ac38f2d4ddec17857aaf5bc0dd13dab38" title="Sign a message signature using a given private key.">ast_sign</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00376">376</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="utils_8c_source.html#l00342">ast_base64encode()</a>, and <a class="el" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3">ast_sign_bin</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00377"></a>00377 {
<a name="l00378"></a>00378    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsig[128];
<a name="l00379"></a>00379    <span class="keywordtype">int</span> siglen = <span class="keyword">sizeof</span>(dsig), res;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <span class="keywordflow">if</span> (!(res = <a class="code" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3" title="Sign a message signature using a given private key.">ast_sign_bin</a>(key, <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, strlen(<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>), dsig)))
<a name="l00382"></a>00382       <span class="comment">/* Success -- encode (256 bytes max as documented) */</span>
<a name="l00383"></a>00383       <a class="code" href="utils_8h.html#a555dad1bd5b23acf01cf08f1affab879" title="Encode data in base64.">ast_base64encode</a>(sig, dsig, siglen, 256);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385    <span class="keywordflow">return</span> res;
<a name="l00386"></a>00386 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aeff97278c4bc6d860ae743b9fd9e95f7"></a><!-- doxytag: member="res_crypto.c::__ast_sign_bin" ref="aeff97278c4bc6d860ae743b9fd9e95f7" args="(struct ast_key *key, const char *msg, int msglen, unsigned char *dsig)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int __ast_sign_bin </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__key.html">ast_key</a> *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>msg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>msglen</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>dsig</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>signs <a class="el" href="structoutgoing.html">outgoing</a> <a class="el" href="structmessage.html">message</a> with public key </p>
<dl class="see"><dt><b>See also:</b></dt><dd><a class="el" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3" title="Sign a message signature using a given private key.">ast_sign_bin</a> </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00282">282</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="crypto_8h_source.html#l00031">AST_KEY_PRIVATE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="res__crypto_8c_source.html#l00081">ast_key::digest</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>, and <a class="el" href="res__crypto_8c_source.html#l00073">ast_key::rsa</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00283"></a>00283 {
<a name="l00284"></a>00284    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>[20];
<a name="l00285"></a>00285    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> siglen = 128;
<a name="l00286"></a>00286    <span class="keywordtype">int</span> res;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>) {
<a name="l00289"></a>00289       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot sign with a public key\n&quot;</span>);
<a name="l00290"></a>00290       <span class="keywordflow">return</span> -1;
<a name="l00291"></a>00291    }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="comment">/* Calculate digest of message */</span>
<a name="l00294"></a>00294    SHA1((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, digest);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="comment">/* Verify signature */</span>
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (!(res = RSA_sign(NID_sha1, digest, <span class="keyword">sizeof</span>(digest), dsig, &amp;siglen, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>))) {
<a name="l00298"></a>00298       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RSA Signature (key %s) failed\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00299"></a>00299       <span class="keywordflow">return</span> -1;
<a name="l00300"></a>00300    }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    <span class="keywordflow">if</span> (siglen != 128) {
<a name="l00303"></a>00303       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unexpected signature length %d, expecting %d\n&quot;</span>, (<span class="keywordtype">int</span>)siglen, (<span class="keywordtype">int</span>)128);
<a name="l00304"></a>00304       <span class="keywordflow">return</span> -1;
<a name="l00305"></a>00305    }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307    <span class="keywordflow">return</span> 0;
<a name="l00308"></a>00308    
<a name="l00309"></a>00309 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="res_crypto.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00628">628</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="res_crypto.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00628">628</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

</div>
</div>
<a class="anchor" id="afe66c89b5695ee92f3f6125397c7573b"></a><!-- doxytag: member="res_crypto.c::crypto_init" ref="afe66c89b5695ee92f3f6125397c7573b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int crypto_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>initialise the res_crypto module </p>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00586">586</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="res__crypto_8c_source.html#l00421">__ast_check_signature()</a>, <a class="el" href="res__crypto_8c_source.html#l00392">__ast_check_signature_bin()</a>, <a class="el" href="res__crypto_8c_source.html#l00315">__ast_decrypt_bin()</a>, <a class="el" href="res__crypto_8c_source.html#l00346">__ast_encrypt_bin()</a>, <a class="el" href="res__crypto_8c_source.html#l00128">__ast_key_get()</a>, <a class="el" href="res__crypto_8c_source.html#l00376">__ast_sign()</a>, <a class="el" href="res__crypto_8c_source.html#l00282">__ast_sign_bin()</a>, <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="crypto_8h.html#a50332dc613df6416ba467b5bde4934e2">ast_check_signature</a>, <a class="el" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9">ast_check_signature_bin</a>, <a class="el" href="cli_8c_source.html#l01927">ast_cli_register_multiple()</a>, <a class="el" href="crypto_8h.html#ac28ff1b7a9621b7542f4f120b23c16ec">ast_decrypt_bin</a>, <a class="el" href="crypto_8h.html#aacb22f7c29907031152630b4628014fc">ast_encrypt_bin</a>, <a class="el" href="crypto_8h.html#ae616a3ae122fcb33a6f5937dc1295718">ast_key_get</a>, <a class="el" href="crypto_8h.html#ac38f2d4ddec17857aaf5bc0dd13dab38">ast_sign</a>, <a class="el" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3">ast_sign_bin</a>, and <a class="el" href="res__crypto_8c_source.html#l00580">cli_crypto</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00607">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00587"></a>00587 {
<a name="l00588"></a>00588    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a>));
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <span class="comment">/* Install ourselves into stubs */</span>
<a name="l00591"></a>00591    <a class="code" href="crypto_8h.html#ae616a3ae122fcb33a6f5937dc1295718" title="Retrieve a key.">ast_key_get</a> = <a class="code" href="res__crypto_8c.html#a30abfec91d1a3e0fd585675d9fd8f297" title="return the ast_key structure for name">__ast_key_get</a>;
<a name="l00592"></a>00592    <a class="code" href="crypto_8h.html#a50332dc613df6416ba467b5bde4934e2" title="Check the authenticity of a message signature using a given public key.">ast_check_signature</a> = <a class="code" href="res__crypto_8c.html#a47ea0a07bdecf6e564a85c53f8bf678a" title="base64 decode then sent to __ast_check_signature_bin">__ast_check_signature</a>;
<a name="l00593"></a>00593    <a class="code" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9" title="Check the authenticity of a message signature using a given public key.">ast_check_signature_bin</a> = <a class="code" href="res__crypto_8c.html#af09836a36dc290e9b9ac8ea1d5769975" title="check signature of a message">__ast_check_signature_bin</a>;
<a name="l00594"></a>00594    <a class="code" href="crypto_8h.html#ac38f2d4ddec17857aaf5bc0dd13dab38" title="Sign a message signature using a given private key.">ast_sign</a> = <a class="code" href="res__crypto_8c.html#aa72f25fe6809be13ce00022d2148c68e" title="wrapper for __ast_sign_bin then base64 encode it">__ast_sign</a>;
<a name="l00595"></a>00595    <a class="code" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3" title="Sign a message signature using a given private key.">ast_sign_bin</a> = <a class="code" href="res__crypto_8c.html#aeff97278c4bc6d860ae743b9fd9e95f7" title="signs outgoing message with public key">__ast_sign_bin</a>;
<a name="l00596"></a>00596    <a class="code" href="crypto_8h.html#aacb22f7c29907031152630b4628014fc" title="Encrypt a message using a given private key.">ast_encrypt_bin</a> = <a class="code" href="res__crypto_8c.html#a7eaf0b18e766300c6f5f6a5d97ac409e" title="encrypt a message">__ast_encrypt_bin</a>;
<a name="l00597"></a>00597    <a class="code" href="crypto_8h.html#ac28ff1b7a9621b7542f4f120b23c16ec" title="Decrypt a message using a given private key.">ast_decrypt_bin</a> = <a class="code" href="res__crypto_8c.html#a2356e21f17002e32926bd8735e7111b2" title="decrypt a message">__ast_decrypt_bin</a>;
<a name="l00598"></a>00598    <span class="keywordflow">return</span> 0;
<a name="l00599"></a>00599 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a94ec58f8f5d3c47fa527da2eab8a4853"></a><!-- doxytag: member="res_crypto.c::crypto_load" ref="a94ec58f8f5d3c47fa527da2eab8a4853" args="(int ifd, int ofd)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void crypto_load </td>
          <td>(</td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ifd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ofd</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>refresh RSA <a class="el" href="structkeys.html">keys</a> from file </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ifd</em>&nbsp;</td><td>file descriptor </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ofd</em>&nbsp;</td><td>file descriptor </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>void </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00443">443</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00257">ast_config_AST_KEY_DIR</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="linkedlists_8h_source.html#l00564">AST_RWLIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00541">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00601">AST_RWLIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="res__crypto_8c_source.html#l00075">ast_key::delme</a>, <a class="el" href="adsistub_8c_source.html#l00077">dir</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">ast_key::list</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>, <a class="el" href="res__crypto_8c_source.html#l00073">ast_key::rsa</a>, and <a class="el" href="res__crypto_8c_source.html#l00153">try_load_key()</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00607">load_module()</a>, and <a class="el" href="res__crypto_8c_source.html#l00601">reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00444"></a>00444 {
<a name="l00445"></a>00445    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00446"></a>00446    DIR *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a> = NULL;
<a name="l00447"></a>00447    <span class="keyword">struct </span>dirent *ent;
<a name="l00448"></a>00448    <span class="keywordtype">int</span> note = 0;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452    <span class="comment">/* Mark all keys for deletion */</span>
<a name="l00453"></a>00453    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, list) {
<a name="l00454"></a>00454       key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 1;
<a name="l00455"></a>00455    }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457    <span class="comment">/* Load new keys */</span>
<a name="l00458"></a>00458    <span class="keywordflow">if</span> ((dir = opendir(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>))) {
<a name="l00459"></a>00459       <span class="keywordflow">while</span>((ent = readdir(dir))) {
<a name="l00460"></a>00460          <a class="code" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731" title="load RSA key from file">try_load_key</a>(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>, ent-&gt;d_name, ifd, ofd, &amp;note);
<a name="l00461"></a>00461       }
<a name="l00462"></a>00462       closedir(dir);
<a name="l00463"></a>00463    } <span class="keywordflow">else</span>
<a name="l00464"></a>00464       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open key directory &apos;%s&apos;\n&quot;</span>, <a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <span class="keywordflow">if</span> (note)
<a name="l00467"></a>00467       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Please run the command &apos;init keys&apos; to enter the passcodes for the keys\n&quot;</span>);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <span class="comment">/* Delete any keys that are no longer present */</span>
<a name="l00470"></a>00470    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, list) {
<a name="l00471"></a>00471       <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a>) {
<a name="l00472"></a>00472          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Deleting key %s type %d\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>, key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>);
<a name="l00473"></a>00473          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(list);
<a name="l00474"></a>00474          <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>)
<a name="l00475"></a>00475             RSA_free(key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>);
<a name="l00476"></a>00476          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(key);
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00482"></a>00482 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4483abe7b118418ecf2e559f5367313b"></a><!-- doxytag: member="res_crypto.c::handle_cli_keys_init" ref="a4483abe7b118418ecf2e559f5367313b" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_keys_init </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>initialize all RSA <a class="el" href="structkeys.html">keys</a> </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>e</em>&nbsp;</td><td>CLI command </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cmd</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>a</em>&nbsp;</td><td>list of CLI arguments </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00544">544</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="asterisk_8c_source.html#l00257">ast_config_AST_KEY_DIR</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="linkedlists_8h_source.html#l00541">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00601">AST_RWLIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="res__crypto_8c_source.html#l00069">ast_key::fn</a>, <a class="el" href="res__crypto_8c_source.html#l00063">KEY_NEEDS_PASSCODE</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">ast_key::list</a>, <a class="el" href="res__crypto_8c_source.html#l00153">try_load_key()</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00545"></a>00545 {
<a name="l00546"></a>00546    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00547"></a>00547    <span class="keywordtype">int</span> ign;
<a name="l00548"></a>00548    <span class="keywordtype">char</span> *kn, tmp[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550    <span class="keywordflow">switch</span> (cmd) {
<a name="l00551"></a>00551    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00552"></a>00552       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;keys init&quot;</span>;
<a name="l00553"></a>00553       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00554"></a>00554          <span class="stringliteral">&quot;Usage: keys init\n&quot;</span>
<a name="l00555"></a>00555          <span class="stringliteral">&quot;       Initializes private keys (by reading in pass code from\n&quot;</span>
<a name="l00556"></a>00556          <span class="stringliteral">&quot;       the user)\n&quot;</span>;
<a name="l00557"></a>00557       <span class="keywordflow">return</span> NULL;
<a name="l00558"></a>00558    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00559"></a>00559       <span class="keywordflow">return</span> NULL;
<a name="l00560"></a>00560    }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2)
<a name="l00563"></a>00563       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00566"></a>00566    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00567"></a>00567       <span class="comment">/* Reload keys that need pass codes now */</span>
<a name="l00568"></a>00568       <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>) {
<a name="l00569"></a>00569          kn = key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a> + strlen(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>) + 1;
<a name="l00570"></a>00570          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, kn, <span class="keyword">sizeof</span>(tmp));
<a name="l00571"></a>00571          <a class="code" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731" title="load RSA key from file">try_load_key</a>(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>, tmp, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;ign);
<a name="l00572"></a>00572       }
<a name="l00573"></a>00573    }
<a name="l00574"></a>00574    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l00575"></a>00575    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00578"></a>00578 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a849125df8a0e30d08efe31e86729fffe"></a><!-- doxytag: member="res_crypto.c::handle_cli_keys_show" ref="a849125df8a0e30d08efe31e86729fffe" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_cli_keys_show </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>show the list of RSA <a class="el" href="structkeys.html">keys</a> </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>e</em>&nbsp;</td><td>CLI command </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cmd</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>a</em>&nbsp;</td><td>list of CLI arguments </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>CLI_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00498">498</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="crypto_8h_source.html#l00030">AST_KEY_PUBLIC</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="res__crypto_8c_source.html#l00081">ast_key::digest</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <a class="el" href="res__crypto_8c_source.html#l00063">KEY_NEEDS_PASSCODE</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">ast_key::list</a>, <a class="el" href="res__crypto_8c_source.html#l00484">md52sum()</a>, <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00499"></a>00499 {
<a name="l00500"></a>00500 <span class="preprocessor">#define FORMAT &quot;%-18s %-8s %-16s %-33s\n&quot;</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>
<a name="l00502"></a>00502    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00503"></a>00503    <span class="keywordtype">char</span> sum[16 * 2 + 1];
<a name="l00504"></a>00504    <span class="keywordtype">int</span> count_keys = 0;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <span class="keywordflow">switch</span> (cmd) {
<a name="l00507"></a>00507    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00508"></a>00508       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;keys show&quot;</span>;
<a name="l00509"></a>00509       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00510"></a>00510          <span class="stringliteral">&quot;Usage: keys show\n&quot;</span>
<a name="l00511"></a>00511          <span class="stringliteral">&quot;       Displays information about RSA keys known by Asterisk\n&quot;</span>;
<a name="l00512"></a>00512       <span class="keywordflow">return</span> NULL;
<a name="l00513"></a>00513    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00514"></a>00514       <span class="keywordflow">return</span> NULL;
<a name="l00515"></a>00515    }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, FORMAT, <span class="stringliteral">&quot;Key Name&quot;</span>, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;Status&quot;</span>, <span class="stringliteral">&quot;Sum&quot;</span>);
<a name="l00518"></a>00518    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, FORMAT, <span class="stringliteral">&quot;------------------&quot;</span>, <span class="stringliteral">&quot;--------&quot;</span>, <span class="stringliteral">&quot;----------------&quot;</span>, <span class="stringliteral">&quot;--------------------------------&quot;</span>);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00521"></a>00521    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00522"></a>00522       <a class="code" href="res__crypto_8c.html#a72c787a063d771439dadf924d51018f1">md52sum</a>(sum, key-&gt;<a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>);
<a name="l00523"></a>00523       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, FORMAT, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>, 
<a name="l00524"></a>00524          (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; 0xf) == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a> ? <span class="stringliteral">&quot;PUBLIC&quot;</span> : <span class="stringliteral">&quot;PRIVATE&quot;</span>,
<a name="l00525"></a>00525          key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a> ? <span class="stringliteral">&quot;[Needs Passcode]&quot;</span> : <span class="stringliteral">&quot;[Loaded]&quot;</span>, sum);
<a name="l00526"></a>00526       count_keys++;
<a name="l00527"></a>00527    }
<a name="l00528"></a>00528    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n%d known RSA keys.\n&quot;</span>, count_keys);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="preprocessor">#undef FORMAT</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>}
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="res_crypto.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00607">607</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="options_8h_source.html#l00103">ast_opt_init_keys</a>, <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>, and <a class="el" href="res__crypto_8c_source.html#l00443">crypto_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00608"></a>00608 {
<a name="l00609"></a>00609    <a class="code" href="res__crypto_8c.html#afe66c89b5695ee92f3f6125397c7573b" title="initialise the res_crypto module">crypto_init</a>();
<a name="l00610"></a>00610    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#aaf18f1b7244aa93f796cae9a2a531008">ast_opt_init_keys</a>)
<a name="l00611"></a>00611       <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(STDIN_FILENO, STDOUT_FILENO);
<a name="l00612"></a>00612    <span class="keywordflow">else</span>
<a name="l00613"></a>00613       <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(-1, -1);
<a name="l00614"></a>00614    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l00615"></a>00615 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a72c787a063d771439dadf924d51018f1"></a><!-- doxytag: member="res_crypto.c::md52sum" ref="a72c787a063d771439dadf924d51018f1" args="(char *sum, unsigned char *md5)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void md52sum </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>sum</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">unsigned char *&nbsp;</td>
          <td class="paramname"> <em>md5</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00484">484</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00498">handle_cli_keys_show()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00485"></a>00485 {
<a name="l00486"></a>00486    <span class="keywordtype">int</span> x;
<a name="l00487"></a>00487    <span class="keywordflow">for</span> (x = 0; x &lt; 16; x++) 
<a name="l00488"></a>00488       sum += sprintf(sum, <span class="stringliteral">&quot;%02x&quot;</span>, *(<a class="code" href="func__md5_8c.html#a058fc1589da2b9b0d8e404ba0482c3af">md5</a>++));
<a name="l00489"></a>00489 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad29e293470b893d5d245c8f801c40218"></a><!-- doxytag: member="res_crypto.c::pw_cb" ref="ad29e293470b893d5d245c8f801c40218" args="(char *buf, int size, int rwflag, void *userdata)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int pw_cb </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>buf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>size</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>rwflag</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>userdata</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>setting of priv key </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>buf</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>size</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>rwflag</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>userdata</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>length of string,-1 on failure </dd></dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00095">95</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="io_8c_source.html#l00328">ast_hide_password()</a>, <a class="el" href="crypto_8h_source.html#l00031">AST_KEY_PRIVATE</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="io_8c_source.html#l00347">ast_restore_tty()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="res__crypto_8c_source.html#l00077">ast_key::infd</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>, <a class="el" href="res__crypto_8c_source.html#l00079">ast_key::outfd</a>, and <a class="el" href="asterisk_8c_source.html#l02162">prompt</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00153">try_load_key()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00096"></a>00096 {
<a name="l00097"></a>00097    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key = (<span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *)userdata;
<a name="l00098"></a>00098    <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a>[256];
<a name="l00099"></a>00099    <span class="keywordtype">int</span> res, tmp;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> &lt; 0) {
<a name="l00102"></a>00102       <span class="comment">/* Note that we were at least called */</span>
<a name="l00103"></a>00103       key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> = -2;
<a name="l00104"></a>00104       <span class="keywordflow">return</span> -1;
<a name="l00105"></a>00105    }
<a name="l00106"></a>00106    
<a name="l00107"></a>00107    snprintf(prompt, <span class="keyword">sizeof</span>(prompt), <span class="stringliteral">&quot;&gt;&gt;&gt;&gt; passcode for %s key &apos;%s&apos;: &quot;</span>,
<a name="l00108"></a>00108        key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a> ? <span class="stringliteral">&quot;PRIVATE&quot;</span> : <span class="stringliteral">&quot;PUBLIC&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00109"></a>00109    <span class="keywordflow">if</span> (write(key-&gt;<a class="code" href="structast__key.html#abc4dff7fa063d9a7b5f56d0273d40f7a">outfd</a>, prompt, strlen(prompt)) &lt; 0) {
<a name="l00110"></a>00110       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00111"></a>00111       key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> = -2;
<a name="l00112"></a>00112       <span class="keywordflow">return</span> -1;
<a name="l00113"></a>00113    }
<a name="l00114"></a>00114    memset(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>));
<a name="l00115"></a>00115    tmp = <a class="code" href="io_8h.html#a30c650d779bfadbb34c52d7de2c616a9">ast_hide_password</a>(key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>);
<a name="l00116"></a>00116    memset(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, 0, size);
<a name="l00117"></a>00117    res = read(key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>, <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, size);
<a name="l00118"></a>00118    <a class="code" href="io_8h.html#aa77b49897e9d1ca9640a8fdc8bc5c69b" title="Restores TTY mode. Call with result from previous ast_hide_password.">ast_restore_tty</a>(key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>, tmp);
<a name="l00119"></a>00119    <span class="keywordflow">if</span> (<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[strlen(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>) -1] == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l00120"></a>00120       <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[strlen(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00121"></a>00121    <span class="keywordflow">return</span> strlen(<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>);
<a name="l00122"></a>00122 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad1982509765f4870f1f63412a53ea668"></a><!-- doxytag: member="res_crypto.c::reload" ref="ad1982509765f4870f1f63412a53ea668" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00601">601</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="res__crypto_8c_source.html#l00443">crypto_load()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00602"></a>00602 {
<a name="l00603"></a>00603    <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(-1, -1);
<a name="l00604"></a>00604    <span class="keywordflow">return</span> 0;
<a name="l00605"></a>00605 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="adeba9b20c20b7b76c7deb63af67f5731"></a><!-- doxytag: member="res_crypto.c::try_load_key" ref="adeba9b20c20b7b76c7deb63af67f5731" args="(const char *dir, const char *fname, int ifd, int ofd, int *not2)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__key.html">ast_key</a>* try_load_key </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>dir</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>fname</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ifd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>ofd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>not2</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>load RSA key from file </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>dir</em>&nbsp;</td><td>directory string </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fname</em>&nbsp;</td><td>name of file </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ifd</em>&nbsp;</td><td>incoming file descriptor </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>ofd</em>&nbsp;</td><td><a class="el" href="structoutgoing.html">outgoing</a> file descriptor </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>not2</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>key</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>NULL</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00153">153</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="crypto_8h_source.html#l00031">AST_KEY_PRIVATE</a>, <a class="el" href="crypto_8h_source.html#l00030">AST_KEY_PUBLIC</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="options_8h_source.html#l00103">ast_opt_init_keys</a>, <a class="el" href="linkedlists_8h_source.html#l00725">AST_RWLIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="res__crypto_8c_source.html#l00075">ast_key::delme</a>, <a class="el" href="res__crypto_8c_source.html#l00081">ast_key::digest</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="res__crypto_8c_source.html#l00069">ast_key::fn</a>, <a class="el" href="res__crypto_8c_source.html#l00077">ast_key::infd</a>, <a class="el" href="res__crypto_8c_source.html#l00063">KEY_NEEDS_PASSCODE</a>, <a class="el" href="res__crypto_8c_source.html#l00071">ast_key::ktype</a>, <a class="el" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">ast_key::list</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="md5_8c_source.html#l00122">MD5Final()</a>, <a class="el" href="md5_8c_source.html#l00059">MD5Init()</a>, <a class="el" href="md5_8c_source.html#l00074">MD5Update()</a>, <a class="el" href="res__crypto_8c_source.html#l00067">ast_key::name</a>, <a class="el" href="res__crypto_8c_source.html#l00079">ast_key::outfd</a>, <a class="el" href="res__crypto_8c_source.html#l00095">pw_cb()</a>, and <a class="el" href="res__crypto_8c_source.html#l00073">ast_key::rsa</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00443">crypto_load()</a>, and <a class="el" href="res__crypto_8c_source.html#l00544">handle_cli_keys_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00154"></a>00154 {
<a name="l00155"></a>00155    <span class="keywordtype">int</span> <a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> = 0, found = 0;
<a name="l00156"></a>00156    <span class="keywordtype">char</span> *c = NULL, ffname[256];
<a name="l00157"></a>00157    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>[16];
<a name="l00158"></a>00158    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00159"></a>00159    <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> <a class="code" href="func__md5_8c.html#a058fc1589da2b9b0d8e404ba0482c3af">md5</a>;
<a name="l00160"></a>00160    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00161"></a>00161    <span class="keyword">static</span> <span class="keywordtype">int</span> notice = 0;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163    <span class="comment">/* Make sure its name is a public or private key */</span>
<a name="l00164"></a>00164    <span class="keywordflow">if</span> ((c = strstr(fname, <span class="stringliteral">&quot;.pub&quot;</span>)) &amp;&amp; !strcmp(c, <span class="stringliteral">&quot;.pub&quot;</span>))
<a name="l00165"></a>00165       ktype = <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>;
<a name="l00166"></a>00166    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c = strstr(fname, <span class="stringliteral">&quot;.key&quot;</span>)) &amp;&amp; !strcmp(c, <span class="stringliteral">&quot;.key&quot;</span>))
<a name="l00167"></a>00167       ktype = <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>;
<a name="l00168"></a>00168    <span class="keywordflow">else</span>
<a name="l00169"></a>00169       <span class="keywordflow">return</span> NULL;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171    <span class="comment">/* Get actual filename */</span>
<a name="l00172"></a>00172    snprintf(ffname, <span class="keyword">sizeof</span>(ffname), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, fname);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    <span class="comment">/* Open file */</span>
<a name="l00175"></a>00175    <span class="keywordflow">if</span> (!(f = fopen(ffname, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l00176"></a>00176       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open key file %s: %s\n&quot;</span>, ffname, strerror(errno));
<a name="l00177"></a>00177       <span class="keywordflow">return</span> NULL;
<a name="l00178"></a>00178    }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180    <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;<a class="code" href="func__md5_8c.html#a058fc1589da2b9b0d8e404ba0482c3af">md5</a>);
<a name="l00181"></a>00181    <span class="keywordflow">while</span>(!feof(f)) {
<a name="l00182"></a>00182       <span class="comment">/* Calculate a &quot;whatever&quot; quality md5sum of the key */</span>
<a name="l00183"></a>00183       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00184"></a>00184       <span class="keywordflow">if</span> (!fgets(buf, <span class="keyword">sizeof</span>(buf), f)) {
<a name="l00185"></a>00185          <span class="keywordflow">continue</span>;
<a name="l00186"></a>00186       }
<a name="l00187"></a>00187       <span class="keywordflow">if</span> (!feof(f))
<a name="l00188"></a>00188          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;<a class="code" href="func__md5_8c.html#a058fc1589da2b9b0d8e404ba0482c3af">md5</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) buf, strlen(buf));
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190    <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(digest, &amp;<a class="code" href="func__md5_8c.html#a058fc1589da2b9b0d8e404ba0482c3af">md5</a>);
<a name="l00191"></a>00191 
<a name="l00192"></a>00192    <span class="comment">/* Look for an existing key */</span>
<a name="l00193"></a>00193    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00194"></a>00194       <span class="keywordflow">if</span> (!strcasecmp(key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>, ffname))
<a name="l00195"></a>00195          <span class="keywordflow">break</span>;
<a name="l00196"></a>00196    }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198    <span class="keywordflow">if</span> (key) {
<a name="l00199"></a>00199       <span class="comment">/* If the MD5 sum is the same, and it isn&apos;t awaiting a passcode </span>
<a name="l00200"></a>00200 <span class="comment">         then this is far enough */</span>
<a name="l00201"></a>00201       <span class="keywordflow">if</span> (!memcmp(digest, key-&gt;<a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>, 16) &amp;&amp;
<a name="l00202"></a>00202           !(key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>)) {
<a name="l00203"></a>00203          fclose(f);
<a name="l00204"></a>00204          key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 0;
<a name="l00205"></a>00205          <span class="keywordflow">return</span> NULL;
<a name="l00206"></a>00206       } <span class="keywordflow">else</span> {
<a name="l00207"></a>00207          <span class="comment">/* Preserve keytype */</span>
<a name="l00208"></a>00208          ktype = key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>;
<a name="l00209"></a>00209          <span class="comment">/* Recycle the same structure */</span>
<a name="l00210"></a>00210          found++;
<a name="l00211"></a>00211       }
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <span class="comment">/* Make fname just be the normal name now */</span>
<a name="l00215"></a>00215    *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00216"></a>00216    <span class="keywordflow">if</span> (!key) {
<a name="l00217"></a>00217       <span class="keywordflow">if</span> (!(key = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*key)))) {
<a name="l00218"></a>00218          fclose(f);
<a name="l00219"></a>00219          <span class="keywordflow">return</span> NULL;
<a name="l00220"></a>00220       }
<a name="l00221"></a>00221    }
<a name="l00222"></a>00222    <span class="comment">/* First the filename */</span>
<a name="l00223"></a>00223    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>, ffname, <span class="keyword">sizeof</span>(key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>));
<a name="l00224"></a>00224    <span class="comment">/* Then the name */</span>
<a name="l00225"></a>00225    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>, fname, <span class="keyword">sizeof</span>(key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l00226"></a>00226    key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> = ktype;
<a name="l00227"></a>00227    <span class="comment">/* Yes, assume we&apos;re going to be deleted */</span>
<a name="l00228"></a>00228    key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 1;
<a name="l00229"></a>00229    <span class="comment">/* Keep the key type */</span>
<a name="l00230"></a>00230    memcpy(key-&gt;<a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>, digest, 16);
<a name="l00231"></a>00231    <span class="comment">/* Can I/O takes the FD we&apos;re given */</span>
<a name="l00232"></a>00232    key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> = ifd;
<a name="l00233"></a>00233    key-&gt;<a class="code" href="structast__key.html#abc4dff7fa063d9a7b5f56d0273d40f7a">outfd</a> = ofd;
<a name="l00234"></a>00234    <span class="comment">/* Reset the file back to the beginning */</span>
<a name="l00235"></a>00235    rewind(f);
<a name="l00236"></a>00236    <span class="comment">/* Now load the key with the right method */</span>
<a name="l00237"></a>00237    <span class="keywordflow">if</span> (ktype == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>)
<a name="l00238"></a>00238       key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a> = PEM_read_RSA_PUBKEY(f, NULL, <a class="code" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218" title="setting of priv key">pw_cb</a>, key);
<a name="l00239"></a>00239    <span class="keywordflow">else</span>
<a name="l00240"></a>00240       key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a> = PEM_read_RSAPrivateKey(f, NULL, <a class="code" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218" title="setting of priv key">pw_cb</a>, key);
<a name="l00241"></a>00241    fclose(f);
<a name="l00242"></a>00242    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>) {
<a name="l00243"></a>00243       <span class="keywordflow">if</span> (RSA_size(key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>) == 128) {
<a name="l00244"></a>00244          <span class="comment">/* Key loaded okay */</span>
<a name="l00245"></a>00245          key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp;= ~<a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>;
<a name="l00246"></a>00246          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Loaded %s key &apos;%s&apos;\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a> ? <span class="stringliteral">&quot;PUBLIC&quot;</span> : <span class="stringliteral">&quot;PRIVATE&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00247"></a>00247          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Key &apos;%s&apos; loaded OK\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00248"></a>00248          key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 0;
<a name="l00249"></a>00249       } <span class="keywordflow">else</span>
<a name="l00250"></a>00250          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Key &apos;%s&apos; is not expected size.\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00251"></a>00251    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> != -2) {
<a name="l00252"></a>00252       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Key load %s &apos;%s&apos; failed\n&quot;</span>,key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a> ? <span class="stringliteral">&quot;PUBLIC&quot;</span> : <span class="stringliteral">&quot;PRIVATE&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00253"></a>00253       <span class="keywordflow">if</span> (ofd &gt; -1)
<a name="l00254"></a>00254          ERR_print_errors_fp(stderr);
<a name="l00255"></a>00255       <span class="keywordflow">else</span>
<a name="l00256"></a>00256          ERR_print_errors_fp(stderr);
<a name="l00257"></a>00257    } <span class="keywordflow">else</span> {
<a name="l00258"></a>00258       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Key &apos;%s&apos; needs passcode.\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00259"></a>00259       key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> |= <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>;
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (!notice) {
<a name="l00261"></a>00261          <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#aaf18f1b7244aa93f796cae9a2a531008">ast_opt_init_keys</a>) 
<a name="l00262"></a>00262             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Add the &apos;-i&apos; flag to the asterisk command line if you want to automatically initialize passcodes at launch.\n&quot;</span>);
<a name="l00263"></a>00263          notice++;
<a name="l00264"></a>00264       }
<a name="l00265"></a>00265       <span class="comment">/* Keep it anyway */</span>
<a name="l00266"></a>00266       key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 0;
<a name="l00267"></a>00267       <span class="comment">/* Print final notice about &quot;init keys&quot; when done */</span>
<a name="l00268"></a>00268       *not2 = 1;
<a name="l00269"></a>00269    }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271    <span class="comment">/* If this is a new key add it to the list */</span>
<a name="l00272"></a>00272    <span class="keywordflow">if</span> (!found)
<a name="l00273"></a>00273       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <span class="keywordflow">return</span> key;
<a name="l00276"></a>00276 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="res_crypto.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00617">617</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00618"></a>00618 {
<a name="l00619"></a>00619    <span class="comment">/* Can&apos;t unload this once we&apos;re loaded */</span>
<a name="l00620"></a>00620    <span class="keywordflow">return</span> -1;
<a name="l00621"></a>00621 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="res_crypto.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Cryptographic Digital Signatures&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00628">628</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="res_crypto.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00628">628</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

</div>
</div>
<a class="anchor" id="ad8ebfa3eee117aca9365da1ceec6dbd3"></a><!-- doxytag: member="res_crypto.c::cli_crypto" ref="ad8ebfa3eee117aca9365da1ceec6dbd3" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__crypto_8c.html#a849125df8a0e30d08efe31e86729fffe" title="show the list of RSA keys">handle_cli_keys_show</a>, <span class="stringliteral">&quot;Displays RSA key information&quot;</span>),
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__crypto_8c.html#a4483abe7b118418ecf2e559f5367313b" title="initialize all RSA keys">handle_cli_keys_init</a>, <span class="stringliteral">&quot;Initialize RSA key passcodes&quot;</span>)
}
</pre></div>
<p>Definition at line <a class="el" href="res__crypto_8c_source.html#l00580">580</a> of file <a class="el" href="res__crypto_8c_source.html">res_crypto.c</a>.</p>

<p>Referenced by <a class="el" href="res__crypto_8c_source.html#l00586">crypto_init()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:11 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
