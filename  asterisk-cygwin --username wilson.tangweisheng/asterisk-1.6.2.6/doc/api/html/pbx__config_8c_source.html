<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:44 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_6ae6169cd48d88136f0d813c029ee18c.html">pbx</a>
  </div>
</div>
<div class="contents">
<h1>pbx_config.c</h1><a href="pbx__config_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Populate and remember extensions from static config file</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * </span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 233240 $&quot;</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* ast_config_AST_CONFIG_DIR */</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="logger_8h.html" title="Support for logging to various files, console and syslog Configuration in file logger...">asterisk/logger.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span> <span class="comment">/* AST_MAX_EXTENSION */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="pbx__config_8c.html#a38e5cf77f388e5cad6434699f28ec3aa">00041</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="pbx__config_8c.html#a38e5cf77f388e5cad6434699f28ec3aa">config</a>[] = <span class="stringliteral">&quot;extensions.conf&quot;</span>;
<a name="l00042"></a><a class="code" href="pbx__config_8c.html#a3bf3137ab50a150517956e39f5b24cc2">00042</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="pbx__config_8c.html#a3bf3137ab50a150517956e39f5b24cc2">registrar</a>[] = <span class="stringliteral">&quot;pbx_config&quot;</span>;
<a name="l00043"></a><a class="code" href="pbx__config_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">00043</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="pbx__config_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l00044"></a>00044 
<a name="l00045"></a><a class="code" href="pbx__config_8c.html#aacf2e48579f22117914de9de6cfe9132">00045</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#aacf2e48579f22117914de9de6cfe9132">static_config</a> = 0;
<a name="l00046"></a><a class="code" href="pbx__config_8c.html#afa93406b234607b55f06119bfc160c8d">00046</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#afa93406b234607b55f06119bfc160c8d">write_protect_config</a> = 1;
<a name="l00047"></a><a class="code" href="pbx__config_8c.html#a2f7b81835c70c096f9e0e668189de837">00047</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a2f7b81835c70c096f9e0e668189de837">autofallthrough_config</a> = 1;
<a name="l00048"></a><a class="code" href="pbx__config_8c.html#a8a2a6b0ac568ababaf78190692d0b9d6">00048</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a8a2a6b0ac568ababaf78190692d0b9d6">clearglobalvars_config</a> = 0;
<a name="l00049"></a><a class="code" href="pbx__config_8c.html#a23e23286ba72830f34d29d3b028c9624">00049</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a23e23286ba72830f34d29d3b028c9624">extenpatternmatchnew_config</a> = 0;
<a name="l00050"></a><a class="code" href="pbx__config_8c.html#a1d3acbe66f257d6ec70a2c2e7bd7a1fa">00050</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a1d3acbe66f257d6ec70a2c2e7bd7a1fa">overrideswitch_config</a> = NULL;
<a name="l00051"></a>00051 
<a name="l00052"></a><a class="code" href="pbx__config_8c.html#ad916c8366b5027888b762aae71fe0af6">00052</a> <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="pbx__config_8c.html#ad916c8366b5027888b762aae71fe0af6">save_dialplan_lock</a>);
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="pbx__config_8c.html#a71549c9ba7fb62eeb7c04b697e716543">00054</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="pbx__config_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a> = NULL;
<a name="l00055"></a><a class="code" href="pbx__config_8c.html#aef1908f65d352529fe334d22f9df25cb">00055</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__hashtab.html">ast_hashtab</a> *<a class="code" href="pbx__config_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a> = NULL;
<a name="l00056"></a>00056 <span class="comment">/*</span>
<a name="l00057"></a>00057 <span class="comment"> * Prototypes for our completion functions</span>
<a name="l00058"></a>00058 <span class="comment"> */</span>
<a name="l00059"></a>00059 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a9d8e70395147056990aff851de16f283">complete_dialplan_remove_include</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *);
<a name="l00060"></a>00060 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a132a75a03ace49314708e810c051cf55">complete_dialplan_add_include</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *);
<a name="l00061"></a>00061 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#ae7d67e34cee0389f6001c664733be796">complete_dialplan_remove_ignorepat</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *);
<a name="l00062"></a>00062 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a31bfc2065da6ed14289f8e2ec3b4e969">complete_dialplan_add_ignorepat</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *);
<a name="l00063"></a>00063 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a01f01afe3a7ede66df729d467951bba6">complete_dialplan_remove_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *);
<a name="l00064"></a>00064 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a0813e753c67b53ef188c369766d84d74">complete_dialplan_add_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *);
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">/*</span>
<a name="l00067"></a>00067 <span class="comment"> * Implementation of functions provided by this module</span>
<a name="l00068"></a>00068 <span class="comment"> */</span>
<a name="l00069"></a>00069 <span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">/*!</span>
<a name="l00071"></a>00071 <span class="comment"> * REMOVE INCLUDE command stuff</span>
<a name="l00072"></a>00072 <span class="comment"> */</span>
<a name="l00073"></a><a class="code" href="pbx__config_8c.html#a3c90bef28aacc0d9552be3b6ac28af65">00073</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a3c90bef28aacc0d9552be3b6ac28af65">handle_cli_dialplan_remove_include</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00074"></a>00074 {
<a name="l00075"></a>00075    <span class="keywordflow">switch</span> (cmd) {
<a name="l00076"></a>00076    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00077"></a>00077       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan remove include&quot;</span>;
<a name="l00078"></a>00078       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00079"></a>00079          <span class="stringliteral">&quot;Usage: dialplan remove include &lt;context&gt; from &lt;context&gt;\n&quot;</span>
<a name="l00080"></a>00080          <span class="stringliteral">&quot;       Remove an included context from another context.\n&quot;</span>;
<a name="l00081"></a>00081       <span class="keywordflow">return</span> NULL;
<a name="l00082"></a>00082    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00083"></a>00083       <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#a9d8e70395147056990aff851de16f283">complete_dialplan_remove_include</a>(a);
<a name="l00084"></a>00084    }
<a name="l00085"></a>00085 
<a name="l00086"></a>00086    <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;from&quot;</span>))
<a name="l00087"></a>00087       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#acec5cab19e772712434bf03875b57e9a" title="Remove a context include.">ast_context_remove_include</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], registrar)) {
<a name="l00090"></a>00090       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;We are not including &apos;%s&apos; into &apos;%s&apos; now\n&quot;</span>,
<a name="l00091"></a>00091          a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00092"></a>00092       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00093"></a>00093    }
<a name="l00094"></a>00094 
<a name="l00095"></a>00095    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to remove &apos;%s&apos; include from &apos;%s&apos; context\n&quot;</span>,
<a name="l00096"></a>00096       a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00097"></a>00097    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00098"></a>00098 }
<a name="l00099"></a>00099 <span class="comment"></span>
<a name="l00100"></a>00100 <span class="comment">/*! \brief return true if &apos;name&apos; is included by context c */</span>
<a name="l00101"></a><a class="code" href="pbx__config_8c.html#abd7b01012afac7881231edce7abe1eae">00101</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#abd7b01012afac7881231edce7abe1eae" title="return true if &amp;#39;name&amp;#39; is included by context c">lookup_ci</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00102"></a>00102 {
<a name="l00103"></a>00103    <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i = NULL;
<a name="l00104"></a>00104 
<a name="l00105"></a>00105    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) <span class="comment">/* error, skip */</span>
<a name="l00106"></a>00106       <span class="keywordflow">return</span> 0;
<a name="l00107"></a>00107    <span class="keywordflow">while</span> ( (i = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(c, i)) )
<a name="l00108"></a>00108       <span class="keywordflow">if</span> (!strcmp(name, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i)))
<a name="l00109"></a>00109          <span class="keywordflow">break</span>;
<a name="l00110"></a>00110    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l00111"></a>00111    <span class="keywordflow">return</span> i ? -1 <span class="comment">/* success */</span> : 0;
<a name="l00112"></a>00112 }
<a name="l00113"></a>00113 <span class="comment"></span>
<a name="l00114"></a>00114 <span class="comment">/*! \brief return true if &apos;name&apos; is in the ignorepats for context c */</span>
<a name="l00115"></a><a class="code" href="pbx__config_8c.html#a59f5c70f51cd454cd6e1521ff4db0b71">00115</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a59f5c70f51cd454cd6e1521ff4db0b71" title="return true if &amp;#39;name&amp;#39; is in the ignorepats for context c">lookup_c_ip</a>(<span class="keyword">struct</span> <a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00116"></a>00116 {
<a name="l00117"></a>00117    <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip = NULL;
<a name="l00118"></a>00118 
<a name="l00119"></a>00119    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) <span class="comment">/* error, skip */</span>
<a name="l00120"></a>00120       <span class="keywordflow">return</span> 0;
<a name="l00121"></a>00121    <span class="keywordflow">while</span> ( (ip = <a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(c, ip)) )
<a name="l00122"></a>00122       <span class="keywordflow">if</span> (!strcmp(name, <a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip)))
<a name="l00123"></a>00123          <span class="keywordflow">break</span>;
<a name="l00124"></a>00124    <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l00125"></a>00125    <span class="keywordflow">return</span> ip ? -1 <span class="comment">/* success */</span> : 0;
<a name="l00126"></a>00126 }
<a name="l00127"></a>00127 <span class="comment"></span>
<a name="l00128"></a>00128 <span class="comment">/*! \brief moves to the n-th word in the string, or empty string if none */</span>
<a name="l00129"></a><a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace">00129</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *p, <span class="keywordtype">int</span> n)
<a name="l00130"></a>00130 {
<a name="l00131"></a>00131    <span class="keywordtype">int</span> in_blank = 0;
<a name="l00132"></a>00132    <span class="keywordflow">for</span> (;n &amp;&amp; *p; p++) {
<a name="l00133"></a>00133       <span class="keywordflow">if</span> (isblank(*p) <span class="comment">/* XXX order is important */</span> &amp;&amp; !in_blank) {
<a name="l00134"></a>00134          n--;  <span class="comment">/* one word is gone */</span>
<a name="l00135"></a>00135          in_blank = 1;
<a name="l00136"></a>00136       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<span class="comment">/* !is_blank(*p), we know already, &amp;&amp; */</span> in_blank) {
<a name="l00137"></a>00137          in_blank = 0;
<a name="l00138"></a>00138       }
<a name="l00139"></a>00139    }
<a name="l00140"></a>00140    <span class="keywordflow">return</span> p;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 <span class="comment"></span>
<a name="l00143"></a>00143 <span class="comment">/*! \brief match the first &apos;len&apos; chars of word. len==0 always succeeds */</span>
<a name="l00144"></a><a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0">00144</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146    <span class="keywordflow">return</span> (len == 0 || !strncmp(s, word, len));
<a name="l00147"></a>00147 }
<a name="l00148"></a>00148 <span class="comment"></span>
<a name="l00149"></a>00149 <span class="comment">/*! \brief split extension\@context in two parts, return -1 on error.</span>
<a name="l00150"></a>00150 <span class="comment"> * The return string is malloc&apos;ed and pointed by *ext</span>
<a name="l00151"></a>00151 <span class="comment"> */</span>
<a name="l00152"></a><a class="code" href="pbx__config_8c.html#a8c5570455969475bfb41e612c2eb37b1">00152</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a8c5570455969475bfb41e612c2eb37b1" title="split extension@context in two parts, return -1 on error. The return string is malloc&amp;#39;ed...">split_ec</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">char</span> **<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keywordtype">char</span> ** <span class="keyword">const</span> ctx, <span class="keywordtype">char</span> ** <span class="keyword">const</span> cid)
<a name="l00153"></a>00153 {
<a name="l00154"></a>00154    <span class="keywordtype">char</span> *i, *c, *e = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(src); <span class="comment">/* now src is not used anymore */</span>
<a name="l00155"></a>00155 
<a name="l00156"></a>00156    <span class="keywordflow">if</span> (e == NULL)
<a name="l00157"></a>00157       <span class="keywordflow">return</span> -1;  <span class="comment">/* malloc error */</span>
<a name="l00158"></a>00158    <span class="comment">/* now, parse values from &apos;exten@context&apos; */</span>
<a name="l00159"></a>00159    *ext = e;
<a name="l00160"></a>00160    c = strchr(e, <span class="charliteral">&apos;@&apos;</span>);
<a name="l00161"></a>00161    <span class="keywordflow">if</span> (c == NULL) <span class="comment">/* no context part */</span>
<a name="l00162"></a>00162       *ctx = <span class="stringliteral">&quot;&quot;</span>;  <span class="comment">/* it is not overwritten, anyways */</span>
<a name="l00163"></a>00163    <span class="keywordflow">else</span> {   <span class="comment">/* found context, check for duplicity ... */</span>
<a name="l00164"></a>00164       *c++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00165"></a>00165       *ctx = c;
<a name="l00166"></a>00166       <span class="keywordflow">if</span> (strchr(c, <span class="charliteral">&apos;@&apos;</span>)) { <span class="comment">/* two @, not allowed */</span>
<a name="l00167"></a>00167          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(e);
<a name="l00168"></a>00168          <span class="keywordflow">return</span> -1;
<a name="l00169"></a>00169       }
<a name="l00170"></a>00170    }
<a name="l00171"></a>00171    <span class="keywordflow">if</span> (cid &amp;&amp; (i = strchr(e, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l00172"></a>00172       *i++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00173"></a>00173       *cid = i;
<a name="l00174"></a>00174    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cid) {
<a name="l00175"></a>00175       <span class="comment">/* Signal none detected */</span>
<a name="l00176"></a>00176       *cid = NULL;
<a name="l00177"></a>00177    }
<a name="l00178"></a>00178    <span class="keywordflow">return</span> 0;
<a name="l00179"></a>00179 }
<a name="l00180"></a>00180 
<a name="l00181"></a>00181 <span class="comment">/* _X_ is the string we need to complete */</span>
<a name="l00182"></a><a class="code" href="pbx__config_8c.html#a9d8e70395147056990aff851de16f283">00182</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a9d8e70395147056990aff851de16f283">complete_dialplan_remove_include</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00183"></a>00183 {
<a name="l00184"></a>00184    <span class="keywordtype">int</span> which = 0;
<a name="l00185"></a>00185    <span class="keywordtype">char</span> *res = NULL;
<a name="l00186"></a>00186    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>); <span class="comment">/* how many bytes to match */</span>
<a name="l00187"></a>00187    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l00188"></a>00188 
<a name="l00189"></a>00189    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3) {      <span class="comment">/* &quot;dialplan remove include _X_&quot; */</span>
<a name="l00190"></a>00190       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a18c87dac5f7f4368c11b67d8026adc22" title="Write locks the context list.">ast_wrlock_contexts</a>()) {
<a name="l00191"></a>00191          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00192"></a>00192          <span class="keywordflow">return</span> NULL;
<a name="l00193"></a>00193       }
<a name="l00194"></a>00194       <span class="comment">/* walk contexts and their includes, return the n-th match */</span>
<a name="l00195"></a>00195       <span class="keywordflow">while</span> (!res &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c))) {
<a name="l00196"></a>00196          <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i = NULL;
<a name="l00197"></a>00197 
<a name="l00198"></a>00198          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) <span class="comment">/* error ? skip this one */</span>
<a name="l00199"></a>00199             <span class="keywordflow">continue</span>;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201          <span class="keywordflow">while</span> ( !res &amp;&amp; (i = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(c, i)) ) {
<a name="l00202"></a>00202             <span class="keyword">const</span> <span class="keywordtype">char</span> *i_name = <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i);
<a name="l00203"></a>00203             <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *nc = NULL;
<a name="l00204"></a>00204             <span class="keywordtype">int</span> already_served = 0;
<a name="l00205"></a>00205 
<a name="l00206"></a>00206             <span class="keywordflow">if</span> (!<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(i_name, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len))
<a name="l00207"></a>00207                <span class="keywordflow">continue</span>;   <span class="comment">/* not matched */</span>
<a name="l00208"></a>00208 
<a name="l00209"></a>00209             <span class="comment">/* check if this include is already served or not */</span>
<a name="l00210"></a>00210 
<a name="l00211"></a>00211             <span class="comment">/* go through all contexts again till we reach actual</span>
<a name="l00212"></a>00212 <span class="comment">             * context or already_served = 1</span>
<a name="l00213"></a>00213 <span class="comment">             */</span>
<a name="l00214"></a>00214             <span class="keywordflow">while</span> ( (nc = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(nc)) &amp;&amp; nc != c &amp;&amp; !already_served)
<a name="l00215"></a>00215                already_served = <a class="code" href="pbx__config_8c.html#abd7b01012afac7881231edce7abe1eae" title="return true if &amp;#39;name&amp;#39; is included by context c">lookup_ci</a>(nc, i_name);
<a name="l00216"></a>00216 
<a name="l00217"></a>00217             <span class="keywordflow">if</span> (!already_served &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00218"></a>00218                res = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(i_name);
<a name="l00219"></a>00219          }
<a name="l00220"></a>00220          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l00221"></a>00221       }
<a name="l00222"></a>00222 
<a name="l00223"></a>00223       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00224"></a>00224       <span class="keywordflow">return</span> res;
<a name="l00225"></a>00225    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4) { <span class="comment">/* &quot;dialplan remove include CTX _X_&quot; */</span>
<a name="l00226"></a>00226       <span class="comment">/*</span>
<a name="l00227"></a>00227 <span class="comment">       * complete as &apos;from&apos;, but only if previous context is really</span>
<a name="l00228"></a>00228 <span class="comment">       * included somewhere</span>
<a name="l00229"></a>00229 <span class="comment">       */</span>
<a name="l00230"></a>00230       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *dupline;
<a name="l00231"></a>00231       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, 3); <span class="comment">/* skip &apos;dialplan&apos; &apos;remove&apos; &apos;include&apos; */</span>
<a name="l00232"></a>00232 
<a name="l00233"></a>00233       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> &gt; 0)
<a name="l00234"></a>00234          <span class="keywordflow">return</span> NULL;
<a name="l00235"></a>00235       context = dupline = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(s);
<a name="l00236"></a>00236       <span class="keywordflow">if</span> (!dupline) {
<a name="l00237"></a>00237          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l00238"></a>00238          <span class="keywordflow">return</span> NULL;
<a name="l00239"></a>00239       }
<a name="l00240"></a>00240       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00241"></a>00241 
<a name="l00242"></a>00242       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00243"></a>00243          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock contexts list\n&quot;</span>);
<a name="l00244"></a>00244          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00245"></a>00245          <span class="keywordflow">return</span> NULL;
<a name="l00246"></a>00246       }
<a name="l00247"></a>00247 
<a name="l00248"></a>00248       <span class="comment">/* go through all contexts and check if is included ... */</span>
<a name="l00249"></a>00249       <span class="keywordflow">while</span> (!res &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)))
<a name="l00250"></a>00250          <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#abd7b01012afac7881231edce7abe1eae" title="return true if &amp;#39;name&amp;#39; is included by context c">lookup_ci</a>(c, context)) <span class="comment">/* context is really included, complete &quot;from&quot; command */</span>
<a name="l00251"></a>00251             res = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;from&quot;</span>);
<a name="l00252"></a>00252       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00253"></a>00253       <span class="keywordflow">if</span> (!res)
<a name="l00254"></a>00254          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s not included anywhere\n&quot;</span>, context);
<a name="l00255"></a>00255       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00256"></a>00256       <span class="keywordflow">return</span> res;
<a name="l00257"></a>00257    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 5) { <span class="comment">/* &quot;dialplan remove include CTX from _X_&quot; */</span>
<a name="l00258"></a>00258       <span class="comment">/*</span>
<a name="l00259"></a>00259 <span class="comment">       * Context from which we removing include ... </span>
<a name="l00260"></a>00260 <span class="comment">       */</span>
<a name="l00261"></a>00261       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *dupline, *from;
<a name="l00262"></a>00262       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, 3); <span class="comment">/* skip &apos;dialplan&apos; &apos;remove&apos; &apos;include&apos; */</span>
<a name="l00263"></a>00263       context = dupline = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(s);
<a name="l00264"></a>00264       <span class="keywordflow">if</span> (!dupline) {
<a name="l00265"></a>00265          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l00266"></a>00266          <span class="keywordflow">return</span> NULL;
<a name="l00267"></a>00267       }
<a name="l00268"></a>00268 
<a name="l00269"></a>00269       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>); <span class="comment">/* skip context */</span>
<a name="l00270"></a>00270 
<a name="l00271"></a>00271       <span class="comment">/* fourth word must be &apos;from&apos; */</span>
<a name="l00272"></a>00272       from = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00273"></a>00273       <span class="keywordflow">if</span> (!from || strcmp(from, <span class="stringliteral">&quot;from&quot;</span>)) {
<a name="l00274"></a>00274          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00275"></a>00275          <span class="keywordflow">return</span> NULL;
<a name="l00276"></a>00276       }
<a name="l00277"></a>00277 
<a name="l00278"></a>00278       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00279"></a>00279          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00280"></a>00280          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00281"></a>00281          <span class="keywordflow">return</span> NULL;
<a name="l00282"></a>00282       }
<a name="l00283"></a>00283 
<a name="l00284"></a>00284       <span class="comment">/* walk through all contexts ... */</span>
<a name="l00285"></a>00285       c = NULL;
<a name="l00286"></a>00286       <span class="keywordflow">while</span> ( !res &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c))) {
<a name="l00287"></a>00287          <span class="keyword">const</span> <span class="keywordtype">char</span> *c_name = <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c);
<a name="l00288"></a>00288          <span class="keywordflow">if</span> (!<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(c_name, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len)) <span class="comment">/* not a good target */</span>
<a name="l00289"></a>00289             <span class="keywordflow">continue</span>;
<a name="l00290"></a>00290          <span class="comment">/* walk through all includes and check if it is our context */</span> 
<a name="l00291"></a>00291          <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#abd7b01012afac7881231edce7abe1eae" title="return true if &amp;#39;name&amp;#39; is included by context c">lookup_ci</a>(c, context) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00292"></a>00292             res = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(c_name);
<a name="l00293"></a>00293       }
<a name="l00294"></a>00294       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00295"></a>00295       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00296"></a>00296       <span class="keywordflow">return</span> res;
<a name="l00297"></a>00297    }
<a name="l00298"></a>00298 
<a name="l00299"></a>00299    <span class="keywordflow">return</span> NULL;
<a name="l00300"></a>00300 }
<a name="l00301"></a>00301 <span class="comment"></span>
<a name="l00302"></a>00302 <span class="comment">/*!</span>
<a name="l00303"></a>00303 <span class="comment"> * REMOVE EXTENSION command stuff</span>
<a name="l00304"></a>00304 <span class="comment"> */</span>
<a name="l00305"></a><a class="code" href="pbx__config_8c.html#a7c53d064336cfa9201114eded4ab536b">00305</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a7c53d064336cfa9201114eded4ab536b">handle_cli_dialplan_remove_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00306"></a>00306 {
<a name="l00307"></a>00307    <span class="keywordtype">int</span> removing_priority = 0;
<a name="l00308"></a>00308    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *cid;
<a name="l00309"></a>00309    <span class="keywordtype">char</span> *ret = <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">switch</span> (cmd) {
<a name="l00312"></a>00312    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00313"></a>00313       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan remove extension&quot;</span>;
<a name="l00314"></a>00314       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00315"></a>00315          <span class="stringliteral">&quot;Usage: dialplan remove extension exten[/cid]@context [priority]\n&quot;</span>
<a name="l00316"></a>00316          <span class="stringliteral">&quot;       Remove an extension from a given context. If a priority\n&quot;</span>
<a name="l00317"></a>00317          <span class="stringliteral">&quot;       is given, only that specific priority from the given extension\n&quot;</span>
<a name="l00318"></a>00318          <span class="stringliteral">&quot;       will be removed.\n&quot;</span>;
<a name="l00319"></a>00319       <span class="keywordflow">return</span> NULL;
<a name="l00320"></a>00320    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00321"></a>00321       <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#a01f01afe3a7ede66df729d467951bba6">complete_dialplan_remove_extension</a>(a);
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 5 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l00325"></a>00325       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00326"></a>00326 
<a name="l00327"></a>00327    <span class="comment">/*</span>
<a name="l00328"></a>00328 <span class="comment">    * Priority input checking ...</span>
<a name="l00329"></a>00329 <span class="comment">    */</span>
<a name="l00330"></a>00330    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5) {
<a name="l00331"></a>00331       <span class="keywordtype">char</span> *c = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4];
<a name="l00332"></a>00332 
<a name="l00333"></a>00333       <span class="comment">/* check for digits in whole parameter for right priority ...</span>
<a name="l00334"></a>00334 <span class="comment">       * why? because atoi (strtol) returns 0 if any characters in</span>
<a name="l00335"></a>00335 <span class="comment">       * string and whole extension will be removed, it&apos;s not good</span>
<a name="l00336"></a>00336 <span class="comment">       */</span>
<a name="l00337"></a>00337       <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;hint&quot;</span>, c))
<a name="l00338"></a>00338          removing_priority = <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>;
<a name="l00339"></a>00339       <span class="keywordflow">else</span> {
<a name="l00340"></a>00340          <span class="keywordflow">while</span> (*c &amp;&amp; isdigit(*c))
<a name="l00341"></a>00341             c++;
<a name="l00342"></a>00342          <span class="keywordflow">if</span> (*c) { <span class="comment">/* non-digit in string */</span>
<a name="l00343"></a>00343             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Invalid priority &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l00344"></a>00344             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00345"></a>00345          }
<a name="l00346"></a>00346          removing_priority = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l00347"></a>00347       }
<a name="l00348"></a>00348 
<a name="l00349"></a>00349       <span class="keywordflow">if</span> (removing_priority == 0) {
<a name="l00350"></a>00350          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;If you want to remove whole extension, please &quot;</span> \
<a name="l00351"></a>00351             <span class="stringliteral">&quot;omit priority argument\n&quot;</span>);
<a name="l00352"></a>00352          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00353"></a>00353       }
<a name="l00354"></a>00354    }
<a name="l00355"></a>00355 
<a name="l00356"></a>00356    <span class="comment">/* XXX original overwrote argv[3] */</span>
<a name="l00357"></a>00357    <span class="comment">/*</span>
<a name="l00358"></a>00358 <span class="comment">    * Format exten@context checking ...</span>
<a name="l00359"></a>00359 <span class="comment">    */</span>
<a name="l00360"></a>00360    <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#a8c5570455969475bfb41e612c2eb37b1" title="split extension@context in two parts, return -1 on error. The return string is malloc&amp;#39;ed...">split_ec</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], &amp;exten, &amp;context, &amp;cid))
<a name="l00361"></a>00361       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>; <span class="comment">/* XXX malloc failure */</span>
<a name="l00362"></a>00362    <span class="keywordflow">if</span> ((!strlen(exten)) || (!(strlen(context)))) {
<a name="l00363"></a>00363       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Missing extension or context name in third argument &apos;%s&apos;\n&quot;</span>,
<a name="l00364"></a>00364          a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00365"></a>00365       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(exten);
<a name="l00366"></a>00366       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00367"></a>00367    }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a85ffdbb47cc54f8d125b4276d6bd3170">ast_context_remove_extension_callerid</a>(context, exten, removing_priority,
<a name="l00370"></a>00370          <span class="comment">/* Do NOT substitute S_OR; it is NOT the same thing */</span>
<a name="l00371"></a>00371          cid ? cid : (removing_priority ? <span class="stringliteral">&quot;&quot;</span> : NULL), cid ? 1 : 0, registrar)) {
<a name="l00372"></a>00372       <span class="keywordflow">if</span> (!removing_priority)
<a name="l00373"></a>00373          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Whole extension %s@%s removed\n&quot;</span>,
<a name="l00374"></a>00374             exten, context);
<a name="l00375"></a>00375       <span class="keywordflow">else</span>
<a name="l00376"></a>00376          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Extension %s@%s with priority %d removed\n&quot;</span>,
<a name="l00377"></a>00377             exten, context, removing_priority);
<a name="l00378"></a>00378          
<a name="l00379"></a>00379       ret = <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00380"></a>00380    } <span class="keywordflow">else</span> {
<a name="l00381"></a>00381       <span class="keywordflow">if</span> (cid) {
<a name="l00382"></a>00382          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to remove extension %s/%s@%s\n&quot;</span>, exten, cid, context);
<a name="l00383"></a>00383       } <span class="keywordflow">else</span> {
<a name="l00384"></a>00384          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to remove extension %s@%s\n&quot;</span>, exten, context);
<a name="l00385"></a>00385       }
<a name="l00386"></a>00386       ret = <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00387"></a>00387    }
<a name="l00388"></a>00388    <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(exten);
<a name="l00389"></a>00389    <span class="keywordflow">return</span> ret;
<a name="l00390"></a>00390 }
<a name="l00391"></a>00391 
<a name="l00392"></a><a class="code" href="pbx__config_8c.html#a01f01afe3a7ede66df729d467951bba6">00392</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a01f01afe3a7ede66df729d467951bba6">complete_dialplan_remove_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394    <span class="keywordtype">char</span> *ret = NULL;
<a name="l00395"></a>00395    <span class="keywordtype">int</span> which = 0;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3) { <span class="comment">/* &apos;dialplan remove extension _X_&apos; (exten@context ... */</span>
<a name="l00398"></a>00398       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l00399"></a>00399       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> = NULL, *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = NULL, *cid = NULL;
<a name="l00400"></a>00400       <span class="keywordtype">int</span> le = 0; <span class="comment">/* length of extension */</span>
<a name="l00401"></a>00401       <span class="keywordtype">int</span> lc = 0; <span class="comment">/* length of context */</span>
<a name="l00402"></a>00402       <span class="keywordtype">int</span> lcid = 0; <span class="comment">/* length of cid */</span>
<a name="l00403"></a>00403 
<a name="l00404"></a>00404       lc = <a class="code" href="pbx__config_8c.html#a8c5570455969475bfb41e612c2eb37b1" title="split extension@context in two parts, return -1 on error. The return string is malloc&amp;#39;ed...">split_ec</a>(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, &amp;exten, &amp;context, &amp;cid);
<a name="l00405"></a>00405       <span class="keywordflow">if</span> (lc)  { <span class="comment">/* error */</span>
<a name="l00406"></a>00406          <span class="keywordflow">return</span> NULL;
<a name="l00407"></a>00407       }
<a name="l00408"></a>00408       le = strlen(exten);
<a name="l00409"></a>00409       lc = strlen(context);
<a name="l00410"></a>00410       lcid = cid ? strlen(cid) : -1;
<a name="l00411"></a>00411 
<a name="l00412"></a>00412       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00413"></a>00413          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00414"></a>00414          <span class="keywordflow">goto</span> error2;
<a name="l00415"></a>00415       }
<a name="l00416"></a>00416 
<a name="l00417"></a>00417       <span class="comment">/* find our context ... */</span>
<a name="l00418"></a>00418       <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) { <span class="comment">/* match our context if any */</span>
<a name="l00419"></a>00419          <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e = NULL;
<a name="l00420"></a>00420          <span class="comment">/* XXX locking ? */</span>
<a name="l00421"></a>00421          <span class="keywordflow">if</span> (!<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context, lc))
<a name="l00422"></a>00422             <span class="keywordflow">continue</span>;   <span class="comment">/* context not matched */</span>
<a name="l00423"></a>00423          <span class="keywordflow">while</span> ( (e = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(c, e)) ) { <span class="comment">/* try to complete extensions ... */</span>
<a name="l00424"></a>00424             <span class="keywordflow">if</span> ( !strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;/&apos;</span>) ||
<a name="l00425"></a>00425                   (!strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; <a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aee004b6fcfccea3fa6acf9b7264f42c9">ast_get_extension_cidmatch</a>(e), cid, lcid)) ||
<a name="l00426"></a>00426                   (strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; !strcmp(<a class="code" href="pbx_8h.html#aee004b6fcfccea3fa6acf9b7264f42c9">ast_get_extension_cidmatch</a>(e), cid))) {
<a name="l00427"></a>00427                <span class="keywordflow">if</span> ( ((strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;/&apos;</span>) || strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;@&apos;</span>)) &amp;&amp; !strcmp(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), exten)) ||
<a name="l00428"></a>00428                    (!strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;/&apos;</span>) &amp;&amp; !strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; <a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), exten, le))) { <span class="comment">/* n-th match */</span>
<a name="l00429"></a>00429                   <span class="keywordflow">if</span> (++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l00430"></a>00430                      <span class="comment">/* If there is an extension then return exten@context. */</span>
<a name="l00431"></a>00431                      <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a26c679c70c1a8dd0968579be0c1755ab">ast_get_extension_matchcid</a>(e) &amp;&amp; (!strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;@&apos;</span>) || strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l00432"></a>00432                         <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;ret, <span class="stringliteral">&quot;%s/%s@%s&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), <a class="code" href="pbx_8h.html#aee004b6fcfccea3fa6acf9b7264f42c9">ast_get_extension_cidmatch</a>(e), <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c)) &lt; 0) {
<a name="l00433"></a>00433                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00434"></a>00434                            ret = NULL;
<a name="l00435"></a>00435                         }
<a name="l00436"></a>00436                         <span class="keywordflow">break</span>;
<a name="l00437"></a>00437                      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a26c679c70c1a8dd0968579be0c1755ab">ast_get_extension_matchcid</a>(e) &amp;&amp; !strchr(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, <span class="charliteral">&apos;/&apos;</span>)) {
<a name="l00438"></a>00438                         <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;ret, <span class="stringliteral">&quot;%s@%s&quot;</span>, <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c)) &lt; 0) {
<a name="l00439"></a>00439                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00440"></a>00440                            ret = NULL;
<a name="l00441"></a>00441                         }
<a name="l00442"></a>00442                         <span class="keywordflow">break</span>;
<a name="l00443"></a>00443                      }
<a name="l00444"></a>00444                   }
<a name="l00445"></a>00445                }
<a name="l00446"></a>00446             }
<a name="l00447"></a>00447          }
<a name="l00448"></a>00448          <span class="keywordflow">if</span> (e)   <span class="comment">/* got a match */</span>
<a name="l00449"></a>00449             <span class="keywordflow">break</span>;
<a name="l00450"></a>00450       }
<a name="l00451"></a>00451 
<a name="l00452"></a>00452       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00453"></a>00453    error2:
<a name="l00454"></a>00454       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(exten);
<a name="l00455"></a>00455    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4) { <span class="comment">/* &apos;dialplan remove extension EXT _X_&apos; (priority) */</span>
<a name="l00456"></a>00456       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = NULL, *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *cid, *p;
<a name="l00457"></a>00457       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c;
<a name="l00458"></a>00458       <span class="keywordtype">int</span> le, lc, lcid, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00459"></a>00459       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, 3); <span class="comment">/* skip &apos;dialplan&apos; &apos;remove&apos; &apos;extension&apos; */</span>
<a name="l00460"></a>00460       <span class="keywordtype">int</span> i = <a class="code" href="pbx__config_8c.html#a8c5570455969475bfb41e612c2eb37b1" title="split extension@context in two parts, return -1 on error. The return string is malloc&amp;#39;ed...">split_ec</a>(s, &amp;exten, &amp;context, &amp;cid); <span class="comment">/* parse ext@context */</span>
<a name="l00461"></a>00461 
<a name="l00462"></a>00462       <span class="keywordflow">if</span> (i)   <span class="comment">/* error */</span>
<a name="l00463"></a>00463          <span class="keywordflow">goto</span> error3;
<a name="l00464"></a>00464       <span class="keywordflow">if</span> ( (p = strchr(exten, <span class="charliteral">&apos; &apos;</span>)) ) <span class="comment">/* remove space after extension */</span>
<a name="l00465"></a>00465          *p = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00466"></a>00466       <span class="keywordflow">if</span> ( (p = strchr(context, <span class="charliteral">&apos; &apos;</span>)) ) <span class="comment">/* remove space after context */</span>
<a name="l00467"></a>00467          *p = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00468"></a>00468       le = strlen(exten);
<a name="l00469"></a>00469       lc = strlen(context);
<a name="l00470"></a>00470       lcid = strlen(cid);
<a name="l00471"></a>00471       len = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l00472"></a>00472       <span class="keywordflow">if</span> (le == 0 || lc == 0)
<a name="l00473"></a>00473          <span class="keywordflow">goto</span> error3;
<a name="l00474"></a>00474 
<a name="l00475"></a>00475       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00476"></a>00476          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00477"></a>00477          <span class="keywordflow">goto</span> error3;
<a name="l00478"></a>00478       }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480       <span class="comment">/* walk contexts */</span>
<a name="l00481"></a>00481       c = NULL;
<a name="l00482"></a>00482       <span class="keywordflow">while</span> ( (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) ) {
<a name="l00483"></a>00483          <span class="comment">/* XXX locking on c ? */</span>
<a name="l00484"></a>00484          <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *e;
<a name="l00485"></a>00485          <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), context) != 0)
<a name="l00486"></a>00486             <span class="keywordflow">continue</span>;
<a name="l00487"></a>00487          <span class="comment">/* got it, we must match here */</span>
<a name="l00488"></a>00488          e = NULL;
<a name="l00489"></a>00489          <span class="keywordflow">while</span> ( (e = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(c, e)) ) {
<a name="l00490"></a>00490             <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="structast__exten.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l00491"></a>00491             <span class="keywordtype">char</span> buffer[10];
<a name="l00492"></a>00492 
<a name="l00493"></a>00493             <span class="keywordflow">if</span> (cid &amp;&amp; strcmp(<a class="code" href="pbx_8h.html#aee004b6fcfccea3fa6acf9b7264f42c9">ast_get_extension_cidmatch</a>(e), cid) != 0) {
<a name="l00494"></a>00494                <span class="keywordflow">continue</span>;
<a name="l00495"></a>00495             }
<a name="l00496"></a>00496             <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(e), exten) != 0)
<a name="l00497"></a>00497                <span class="keywordflow">continue</span>;
<a name="l00498"></a>00498             <span class="comment">/* XXX lock e ? */</span>
<a name="l00499"></a>00499             priority = NULL;
<a name="l00500"></a>00500             <span class="keywordflow">while</span> ( !ret &amp;&amp; (priority = <a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(e, priority)) ) {
<a name="l00501"></a>00501                snprintf(buffer, <span class="keyword">sizeof</span>(buffer), <span class="stringliteral">&quot;%u&quot;</span>, <a class="code" href="pbx_8h.html#a1662981db35d4125afaf6de98b2ba52f">ast_get_extension_priority</a>(priority));
<a name="l00502"></a>00502                <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(buffer, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) <span class="comment">/* n-th match */</span>
<a name="l00503"></a>00503                   ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(buffer);
<a name="l00504"></a>00504             }
<a name="l00505"></a>00505             <span class="keywordflow">break</span>;
<a name="l00506"></a>00506          }
<a name="l00507"></a>00507          <span class="keywordflow">break</span>;
<a name="l00508"></a>00508       }
<a name="l00509"></a>00509       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00510"></a>00510    error3:
<a name="l00511"></a>00511       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(exten);
<a name="l00512"></a>00512    }
<a name="l00513"></a>00513    <span class="keywordflow">return</span> ret; 
<a name="l00514"></a>00514 }
<a name="l00515"></a>00515 <span class="comment"></span>
<a name="l00516"></a>00516 <span class="comment">/*!</span>
<a name="l00517"></a>00517 <span class="comment"> * Include context ...</span>
<a name="l00518"></a>00518 <span class="comment"> */</span>
<a name="l00519"></a><a class="code" href="pbx__config_8c.html#a36cd9454ed5a5342b0bfed2d40369480">00519</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a36cd9454ed5a5342b0bfed2d40369480">handle_cli_dialplan_add_include</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00520"></a>00520 {
<a name="l00521"></a>00521    <span class="keywordflow">switch</span> (cmd) {
<a name="l00522"></a>00522    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00523"></a>00523       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan add include&quot;</span>;
<a name="l00524"></a>00524       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00525"></a>00525          <span class="stringliteral">&quot;Usage: dialplan add include &lt;context&gt; into &lt;context&gt;\n&quot;</span>
<a name="l00526"></a>00526          <span class="stringliteral">&quot;       Include a context in another context.\n&quot;</span>;
<a name="l00527"></a>00527       <span class="keywordflow">return</span> NULL;
<a name="l00528"></a>00528    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00529"></a>00529       <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#a132a75a03ace49314708e810c051cf55">complete_dialplan_add_include</a>(a);
<a name="l00530"></a>00530    }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6) <span class="comment">/* dialplan add include CTX in CTX */</span>
<a name="l00533"></a>00533       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535    <span class="comment">/* fifth arg must be &apos;into&apos; ... */</span>
<a name="l00536"></a>00536    <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;into&quot;</span>))
<a name="l00537"></a>00537       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a3903111827b675ec313e56a28ac80cf9" title="Add a context include.">ast_context_add_include</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], registrar)) {
<a name="l00540"></a>00540       <span class="keywordflow">switch</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00541"></a>00541       <span class="keywordflow">case</span> ENOMEM:
<a name="l00542"></a>00542          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Out of memory for context addition\n&quot;</span>);
<a name="l00543"></a>00543          <span class="keywordflow">break</span>;
<a name="l00544"></a>00544 
<a name="l00545"></a>00545       <span class="keywordflow">case</span> EBUSY:
<a name="l00546"></a>00546          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to lock context(s) list, please try again later\n&quot;</span>);
<a name="l00547"></a>00547          <span class="keywordflow">break</span>;
<a name="l00548"></a>00548 
<a name="l00549"></a>00549       <span class="keywordflow">case</span> EEXIST:
<a name="l00550"></a>00550          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Context &apos;%s&apos; already included in &apos;%s&apos; context\n&quot;</span>,
<a name="l00551"></a>00551             a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00552"></a>00552          <span class="keywordflow">break</span>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554       <span class="keywordflow">case</span> ENOENT:
<a name="l00555"></a>00555       <span class="keywordflow">case</span> EINVAL:
<a name="l00556"></a>00556          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of context &apos;%s&apos;\n&quot;</span>,
<a name="l00557"></a>00557             <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOENT ? a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5] : a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l00558"></a>00558          <span class="keywordflow">break</span>;
<a name="l00559"></a>00559 
<a name="l00560"></a>00560       <span class="keywordflow">default</span>:
<a name="l00561"></a>00561          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to include &apos;%s&apos; in &apos;%s&apos; context\n&quot;</span>,
<a name="l00562"></a>00562             a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00563"></a>00563          <span class="keywordflow">break</span>;
<a name="l00564"></a>00564       }
<a name="l00565"></a>00565       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00566"></a>00566    }
<a name="l00567"></a>00567 
<a name="l00568"></a>00568    <span class="comment">/* show some info ... */</span>
<a name="l00569"></a>00569    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Context &apos;%s&apos; included in &apos;%s&apos; context\n&quot;</span>,
<a name="l00570"></a>00570       a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 
<a name="l00575"></a><a class="code" href="pbx__config_8c.html#a132a75a03ace49314708e810c051cf55">00575</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a132a75a03ace49314708e810c051cf55">complete_dialplan_add_include</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00576"></a>00576 {
<a name="l00577"></a>00577    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c;
<a name="l00578"></a>00578    <span class="keywordtype">int</span> which = 0;
<a name="l00579"></a>00579    <span class="keywordtype">char</span> *ret = NULL;
<a name="l00580"></a>00580    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l00581"></a>00581 
<a name="l00582"></a>00582    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3) {      <span class="comment">/* &apos;dialplan add include _X_&apos; (context) ... */</span>
<a name="l00583"></a>00583       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00584"></a>00584          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00585"></a>00585          <span class="keywordflow">return</span> NULL;
<a name="l00586"></a>00586       }
<a name="l00587"></a>00587       <span class="keywordflow">for</span> (c = NULL; !ret &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)); )
<a name="l00588"></a>00588          <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00589"></a>00589             ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l00590"></a>00590       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00591"></a>00591       <span class="keywordflow">return</span> ret;
<a name="l00592"></a>00592    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4) { <span class="comment">/* dialplan add include CTX _X_ */</span>
<a name="l00593"></a>00593       <span class="comment">/* complete  as &apos;into&apos; if context exists or we are unable to check */</span>
<a name="l00594"></a>00594       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *dupline;
<a name="l00595"></a>00595       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, 3); <span class="comment">/* should not fail */</span>
<a name="l00596"></a>00596 
<a name="l00597"></a>00597       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> != 0) <span class="comment">/* only once */</span>
<a name="l00598"></a>00598          <span class="keywordflow">return</span> NULL;
<a name="l00599"></a>00599 
<a name="l00600"></a>00600       <span class="comment">/* parse context from line ... */</span>
<a name="l00601"></a>00601       context = dupline = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(s);
<a name="l00602"></a>00602       <span class="keywordflow">if</span> (!context) {
<a name="l00603"></a>00603          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l00604"></a>00604          <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;into&quot;</span>);
<a name="l00605"></a>00605       }
<a name="l00606"></a>00606       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00607"></a>00607 
<a name="l00608"></a>00608       <span class="comment">/* check for context existence ... */</span>
<a name="l00609"></a>00609       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00610"></a>00610          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00611"></a>00611          <span class="comment">/* our fault, we can&apos;t check, so complete &apos;into&apos; ... */</span>
<a name="l00612"></a>00612          ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;into&quot;</span>);
<a name="l00613"></a>00613       } <span class="keywordflow">else</span> {
<a name="l00614"></a>00614          <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *ctx;
<a name="l00615"></a>00615          <span class="keywordflow">for</span> (ctx = NULL; !ret &amp;&amp; (ctx = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(ctx)); )
<a name="l00616"></a>00616             <span class="keywordflow">if</span> (!strcmp(context, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(ctx)))
<a name="l00617"></a>00617                ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;into&quot;</span>); <span class="comment">/* found */</span>
<a name="l00618"></a>00618          <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00619"></a>00619       }
<a name="l00620"></a>00620       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00621"></a>00621       <span class="keywordflow">return</span> ret;
<a name="l00622"></a>00622    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 5) { <span class="comment">/* &apos;dialplan add include CTX into _X_&apos; (dst context) */</span>
<a name="l00623"></a>00623       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *dupline, *into;
<a name="l00624"></a>00624       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, 3); <span class="comment">/* should not fail */</span>
<a name="l00625"></a>00625       context = dupline = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(s);
<a name="l00626"></a>00626       <span class="keywordflow">if</span> (!dupline) {
<a name="l00627"></a>00627          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l00628"></a>00628          <span class="keywordflow">return</span> NULL;
<a name="l00629"></a>00629       }
<a name="l00630"></a>00630       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>); <span class="comment">/* skip context */</span>
<a name="l00631"></a>00631       into = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>);
<a name="l00632"></a>00632       <span class="comment">/* error if missing context or fifth word is not &apos;into&apos; */</span>
<a name="l00633"></a>00633       <span class="keywordflow">if</span> (!strlen(context) || strcmp(into, <span class="stringliteral">&quot;into&quot;</span>)) {
<a name="l00634"></a>00634          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;bad context %s or missing into %s\n&quot;</span>,
<a name="l00635"></a>00635             context, into);
<a name="l00636"></a>00636          <span class="keywordflow">goto</span> error3;
<a name="l00637"></a>00637       }
<a name="l00638"></a>00638 
<a name="l00639"></a>00639       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00640"></a>00640          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock context list\n&quot;</span>);
<a name="l00641"></a>00641          <span class="keywordflow">goto</span> error3;
<a name="l00642"></a>00642       }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644       <span class="keywordflow">for</span> (c = NULL; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)); )
<a name="l00645"></a>00645          <span class="keywordflow">if</span> (!strcmp(context, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c)))
<a name="l00646"></a>00646             <span class="keywordflow">break</span>;
<a name="l00647"></a>00647       <span class="keywordflow">if</span> (c) { <span class="comment">/* first context exists, go on... */</span>
<a name="l00648"></a>00648          <span class="comment">/* go through all contexts ... */</span>
<a name="l00649"></a>00649          <span class="keywordflow">for</span> (c = NULL; !ret &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)); ) {
<a name="l00650"></a>00650             <span class="keywordflow">if</span> (!strcmp(context, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c)))
<a name="l00651"></a>00651                <span class="keywordflow">continue</span>; <span class="comment">/* skip ourselves */</span>
<a name="l00652"></a>00652             <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len) &amp;&amp;
<a name="l00653"></a>00653                   !<a class="code" href="pbx__config_8c.html#abd7b01012afac7881231edce7abe1eae" title="return true if &amp;#39;name&amp;#39; is included by context c">lookup_ci</a>(c, context) <span class="comment">/* not included yet */</span> &amp;&amp;
<a name="l00654"></a>00654                   ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l00655"></a>00655                ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l00656"></a>00656          }
<a name="l00657"></a>00657       } <span class="keywordflow">else</span> {
<a name="l00658"></a>00658          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;context %s not found\n&quot;</span>, context);
<a name="l00659"></a>00659       }
<a name="l00660"></a>00660       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00661"></a>00661    error3:
<a name="l00662"></a>00662       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(context);
<a name="l00663"></a>00663       <span class="keywordflow">return</span> ret;
<a name="l00664"></a>00664    }
<a name="l00665"></a>00665 
<a name="l00666"></a>00666    <span class="keywordflow">return</span> NULL;
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 <span class="comment"></span>
<a name="l00669"></a>00669 <span class="comment">/*!</span>
<a name="l00670"></a>00670 <span class="comment"> * \brief &apos;save dialplan&apos; CLI command implementation functions ...</span>
<a name="l00671"></a>00671 <span class="comment"> */</span>
<a name="l00672"></a><a class="code" href="pbx__config_8c.html#a7c88cc0f438374eacdd9d1d00392dd2c">00672</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a7c88cc0f438374eacdd9d1d00392dd2c" title="&amp;#39;save dialplan&amp;#39; CLI command implementation functions ...">handle_cli_dialplan_save</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00673"></a>00673 {
<a name="l00674"></a>00674    <span class="keywordtype">char</span> filename[256], <a class="code" href="pbx_8c.html#a8f600ca9999b2d9c3d64cbcdb503895c">overrideswitch</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00675"></a>00675    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c;
<a name="l00676"></a>00676    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l00677"></a>00677    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00678"></a>00678    <span class="keywordtype">int</span> incomplete = 0; <span class="comment">/* incomplete config write? */</span>
<a name="l00679"></a>00679    FILE *output;
<a name="l00680"></a>00680    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l00681"></a>00681    <span class="keyword">const</span> <span class="keywordtype">char</span> *base, *slash, *file;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    <span class="keywordflow">switch</span> (cmd) {
<a name="l00684"></a>00684    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00685"></a>00685       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan save&quot;</span>;
<a name="l00686"></a>00686       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00687"></a>00687          <span class="stringliteral">&quot;Usage: dialplan save [/path/to/extension/file]\n&quot;</span>
<a name="l00688"></a>00688          <span class="stringliteral">&quot;       Save dialplan created by pbx_config module.\n&quot;</span>
<a name="l00689"></a>00689          <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00690"></a>00690          <span class="stringliteral">&quot;Example: dialplan save                 (/etc/asterisk/extensions.conf)\n&quot;</span>
<a name="l00691"></a>00691          <span class="stringliteral">&quot;         dialplan save /home/markster  (/home/markster/extensions.conf)\n&quot;</span>;
<a name="l00692"></a>00692       <span class="keywordflow">return</span> NULL;
<a name="l00693"></a>00693    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00694"></a>00694       <span class="keywordflow">return</span> NULL;
<a name="l00695"></a>00695    }
<a name="l00696"></a>00696 
<a name="l00697"></a>00697    <span class="keywordflow">if</span> (! (static_config &amp;&amp; !write_protect_config)) {
<a name="l00698"></a>00698       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,
<a name="l00699"></a>00699          <span class="stringliteral">&quot;I can&apos;t save dialplan now, see &apos;%s&apos; example file.\n&quot;</span>,
<a name="l00700"></a>00700          config);
<a name="l00701"></a>00701       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00702"></a>00702    }
<a name="l00703"></a>00703 
<a name="l00704"></a>00704    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l00705"></a>00705       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00706"></a>00706 
<a name="l00707"></a>00707    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="pbx__config_8c.html#ad916c8366b5027888b762aae71fe0af6">save_dialplan_lock</a>)) {
<a name="l00708"></a>00708       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,
<a name="l00709"></a>00709          <span class="stringliteral">&quot;Failed to lock dialplan saving (another proccess saving?)\n&quot;</span>);
<a name="l00710"></a>00710       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00711"></a>00711    }
<a name="l00712"></a>00712    <span class="comment">/* XXX the code here is quite loose, a pathname with .conf in it</span>
<a name="l00713"></a>00713 <span class="comment">    * is assumed to be a complete pathname</span>
<a name="l00714"></a>00714 <span class="comment">    */</span>
<a name="l00715"></a>00715    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) {  <span class="comment">/* have config path. Look for *.conf */</span>
<a name="l00716"></a>00716       base = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2];
<a name="l00717"></a>00717       <span class="keywordflow">if</span> (!strstr(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;.conf&quot;</span>)) { <span class="comment">/*no, this is assumed to be a pathname */</span>
<a name="l00718"></a>00718          <span class="comment">/* if filename ends with &apos;/&apos;, do not add one */</span>
<a name="l00719"></a>00719          slash = (*(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2] + strlen(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]) -1) == <span class="charliteral">&apos;/&apos;</span>) ? <span class="stringliteral">&quot;/&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l00720"></a>00720          file = config; <span class="comment">/* default: &apos;extensions.conf&apos; */</span>
<a name="l00721"></a>00721       } <span class="keywordflow">else</span> { <span class="comment">/* yes, complete file name */</span>
<a name="l00722"></a>00722          slash = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00723"></a>00723          file = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00724"></a>00724       }
<a name="l00725"></a>00725    } <span class="keywordflow">else</span> {
<a name="l00726"></a>00726       <span class="comment">/* no config file, default one */</span>
<a name="l00727"></a>00727       base = <a class="code" href="paths_8h.html#a7d3836e5581e433c9f5edd30300cc187">ast_config_AST_CONFIG_DIR</a>;
<a name="l00728"></a>00728       slash = <span class="stringliteral">&quot;/&quot;</span>;
<a name="l00729"></a>00729       file = config;
<a name="l00730"></a>00730    }
<a name="l00731"></a>00731    snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s%s%s&quot;</span>, base, slash, config);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;extensions.conf&quot;</span>, config_flags);
<a name="l00734"></a>00734 
<a name="l00735"></a>00735    <span class="comment">/* try to lock contexts list */</span>
<a name="l00736"></a>00736    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l00737"></a>00737       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to lock contexts list\n&quot;</span>);
<a name="l00738"></a>00738       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__config_8c.html#ad916c8366b5027888b762aae71fe0af6">save_dialplan_lock</a>);
<a name="l00739"></a>00739       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00740"></a>00740       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00741"></a>00741    }
<a name="l00742"></a>00742 
<a name="l00743"></a>00743    <span class="comment">/* create new file ... */</span>
<a name="l00744"></a>00744    <span class="keywordflow">if</span> (!(output = fopen(filename, <span class="stringliteral">&quot;wt&quot;</span>))) {
<a name="l00745"></a>00745       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to create file &apos;%s&apos;\n&quot;</span>,
<a name="l00746"></a>00746          filename);
<a name="l00747"></a>00747       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00748"></a>00748       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__config_8c.html#ad916c8366b5027888b762aae71fe0af6">save_dialplan_lock</a>);
<a name="l00749"></a>00749       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00750"></a>00750       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00751"></a>00751    }
<a name="l00752"></a>00752 
<a name="l00753"></a>00753    <span class="comment">/* fireout general info */</span>
<a name="l00754"></a>00754    <span class="keywordflow">if</span> (overrideswitch_config) {
<a name="l00755"></a>00755       snprintf(overrideswitch, <span class="keyword">sizeof</span>(overrideswitch), <span class="stringliteral">&quot;overrideswitch=%s\n&quot;</span>, overrideswitch_config);
<a name="l00756"></a>00756    }
<a name="l00757"></a>00757    fprintf(output, <span class="stringliteral">&quot;[general]\nstatic=%s\nwriteprotect=%s\nautofallthrough=%s\nclearglobalvars=%s\n%sextenpatternmatchnew=%s\n\n&quot;</span>,
<a name="l00758"></a>00758       static_config ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l00759"></a>00759       write_protect_config ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l00760"></a>00760                 autofallthrough_config ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l00761"></a>00761             clearglobalvars_config ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l00762"></a>00762             overrideswitch_config ? overrideswitch : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00763"></a>00763             extenpatternmatchnew_config ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>);
<a name="l00764"></a>00764 
<a name="l00765"></a>00765    <span class="keywordflow">if</span> ((v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;globals&quot;</span>))) {
<a name="l00766"></a>00766       fprintf(output, <span class="stringliteral">&quot;[globals]\n&quot;</span>);
<a name="l00767"></a>00767       <span class="keywordflow">while</span>(v) {
<a name="l00768"></a>00768          fprintf(output, <span class="stringliteral">&quot;%s =&gt; %s\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00769"></a>00769          v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l00770"></a>00770       }
<a name="l00771"></a>00771       fprintf(output, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00772"></a>00772    }
<a name="l00773"></a>00773 
<a name="l00774"></a>00774    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l00775"></a>00775    
<a name="l00776"></a>00776 <span class="preprocessor">#define PUT_CTX_HDR  do { \</span>
<a name="l00777"></a>00777 <span class="preprocessor">   if (!context_header_written) {   \</span>
<a name="l00778"></a>00778 <span class="preprocessor">      fprintf(output, &quot;[%s]\n&quot;, ast_get_context_name(c));   \</span>
<a name="l00779"></a>00779 <span class="preprocessor">      context_header_written = 1;   \</span>
<a name="l00780"></a>00780 <span class="preprocessor">   }  \</span>
<a name="l00781"></a>00781 <span class="preprocessor">   } while (0)</span>
<a name="l00782"></a>00782 <span class="preprocessor"></span>
<a name="l00783"></a>00783    <span class="comment">/* walk all contexts */</span>
<a name="l00784"></a>00784    <span class="keywordflow">for</span> (c = NULL; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)); ) {
<a name="l00785"></a>00785       <span class="keywordtype">int</span> context_header_written = 0;
<a name="l00786"></a>00786       <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, *last_written_e = NULL;
<a name="l00787"></a>00787       <span class="keyword">struct </span><a class="code" href="structast__include.html" title="ast_include: include= support in extensions.conf">ast_include</a> *i;
<a name="l00788"></a>00788       <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip;
<a name="l00789"></a>00789       <span class="keyword">struct </span><a class="code" href="structast__sw.html" title="ast_sw: Switch statement in extensions.conf">ast_sw</a> *sw;
<a name="l00790"></a>00790 
<a name="l00791"></a>00791       <span class="comment">/* try to lock context and fireout all info */</span>  
<a name="l00792"></a>00792       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) { <span class="comment">/* lock failure */</span>
<a name="l00793"></a>00793          incomplete = 1;
<a name="l00794"></a>00794          <span class="keywordflow">continue</span>;
<a name="l00795"></a>00795       }
<a name="l00796"></a>00796       <span class="comment">/* registered by this module? */</span>
<a name="l00797"></a>00797       <span class="comment">/* XXX do we need this ? */</span>
<a name="l00798"></a>00798       <span class="keywordflow">if</span> (!strcmp(<a class="code" href="pbx_8h.html#a9df0a5d301454fe924172cf89c7165a4">ast_get_context_registrar</a>(c), registrar)) {
<a name="l00799"></a>00799          fprintf(output, <span class="stringliteral">&quot;[%s]\n&quot;</span>, <a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l00800"></a>00800          context_header_written = 1;
<a name="l00801"></a>00801       }
<a name="l00802"></a>00802 
<a name="l00803"></a>00803       <span class="comment">/* walk extensions ... */</span>
<a name="l00804"></a>00804       <span class="keywordflow">for</span> (ext = NULL; (ext = <a class="code" href="pbx_8h.html#aa63685577f3479dcf31a9e77b2ff05a7">ast_walk_context_extensions</a>(c, ext)); ) {
<a name="l00805"></a>00805          <span class="keyword">struct </span><a class="code" href="structast__exten.html" title="ast_exten: An extension The dialplan is saved as a linked list with each context...">ast_exten</a> *p = NULL;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807          <span class="comment">/* fireout priorities */</span>
<a name="l00808"></a>00808          <span class="keywordflow">while</span> ( (p = <a class="code" href="pbx_8h.html#a6772ce6e8de86d4b6c382dbf68ea4755">ast_walk_extension_priorities</a>(ext, p)) ) {
<a name="l00809"></a>00809             <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a7f23f7c798d61e68c32b21d3e0cd15a2">ast_get_extension_registrar</a>(p), registrar) != 0) <span class="comment">/* not this source */</span>
<a name="l00810"></a>00810                <span class="keywordflow">continue</span>;
<a name="l00811"></a>00811       
<a name="l00812"></a>00812             <span class="comment">/* make empty line between different extensions */</span> 
<a name="l00813"></a>00813             <span class="keywordflow">if</span> (last_written_e != NULL &amp;&amp;
<a name="l00814"></a>00814                    strcmp(<a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(last_written_e),
<a name="l00815"></a>00815                       <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(p)))
<a name="l00816"></a>00816                fprintf(output, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00817"></a>00817             last_written_e = p;
<a name="l00818"></a>00818          
<a name="l00819"></a>00819             <a class="code" href="pbx__config_8c.html#ae28cd0df7b3c5c030dd3c0ad12a1267e">PUT_CTX_HDR</a>;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a1662981db35d4125afaf6de98b2ba52f">ast_get_extension_priority</a>(p) == <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>) { <span class="comment">/* easy */</span>
<a name="l00822"></a>00822                fprintf(output, <span class="stringliteral">&quot;exten =&gt; %s,hint,%s\n&quot;</span>,
<a name="l00823"></a>00823                       <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(p),
<a name="l00824"></a>00824                       <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(p));
<a name="l00825"></a>00825             } <span class="keywordflow">else</span> {
<a name="l00826"></a>00826                <span class="keyword">const</span> <span class="keywordtype">char</span> *sep, *cid;
<a name="l00827"></a>00827                <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="asterisk_8c.html#a617d1486ee651b4c894d02e1fe68fe04">el</a> = <a class="code" href="pbx_8h.html#a266960fe6aa4db1066ed0b012fb7eb62">ast_get_extension_label</a>(p);
<a name="l00828"></a>00828                <span class="keywordtype">char</span> <a class="code" href="structast__exten.html#ab5fbdb5052858ca8d2538566229fbe64">label</a>[128] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00829"></a>00829  
<a name="l00830"></a>00830                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a26c679c70c1a8dd0968579be0c1755ab">ast_get_extension_matchcid</a>(p)) {
<a name="l00831"></a>00831                   sep = <span class="stringliteral">&quot;/&quot;</span>;
<a name="l00832"></a>00832                   cid = <a class="code" href="pbx_8h.html#aee004b6fcfccea3fa6acf9b7264f42c9">ast_get_extension_cidmatch</a>(p);
<a name="l00833"></a>00833                } <span class="keywordflow">else</span>
<a name="l00834"></a>00834                   sep = cid = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00835"></a>00835             
<a name="l00836"></a>00836                <span class="keywordflow">if</span> (el &amp;&amp; (snprintf(label, <span class="keyword">sizeof</span>(label), <span class="stringliteral">&quot;(%s)&quot;</span>, el) != (strlen(el) + 2)))
<a name="l00837"></a>00837                   incomplete = 1;   <span class="comment">/* error encountered or label &gt; 125 chars */</span>
<a name="l00838"></a>00838                
<a name="l00839"></a>00839                fprintf(output, <span class="stringliteral">&quot;exten =&gt; %s%s%s,%d%s,%s(%s)\n&quot;</span>,
<a name="l00840"></a>00840                    <a class="code" href="pbx_8h.html#a6fb940c1fd9c74b9d573e0a91bb23697">ast_get_extension_name</a>(p), (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(sep) ? <span class="stringliteral">&quot;&quot;</span> : sep), (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cid) ? <span class="stringliteral">&quot;&quot;</span> : cid),
<a name="l00841"></a>00841                    <a class="code" href="pbx_8h.html#a1662981db35d4125afaf6de98b2ba52f">ast_get_extension_priority</a>(p), label,
<a name="l00842"></a>00842                    <a class="code" href="pbx_8h.html#a6594bb017b4d4fe1bc42370cc32ec974">ast_get_extension_app</a>(p), (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(p)) ? <span class="stringliteral">&quot;&quot;</span> : (<span class="keyword">const</span> <span class="keywordtype">char</span> *)<a class="code" href="pbx_8h.html#ac0a6c0c39796f36864868365d8989f02">ast_get_extension_app_data</a>(p)));
<a name="l00843"></a>00843             }
<a name="l00844"></a>00844          }
<a name="l00845"></a>00845       }
<a name="l00846"></a>00846 
<a name="l00847"></a>00847       <span class="comment">/* written any extensions? ok, write space between exten &amp; inc */</span>
<a name="l00848"></a>00848       <span class="keywordflow">if</span> (last_written_e)
<a name="l00849"></a>00849          fprintf(output, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00850"></a>00850 
<a name="l00851"></a>00851       <span class="comment">/* walk through includes */</span>
<a name="l00852"></a>00852       <span class="keywordflow">for</span> (i = NULL; (i = <a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(c, i)) ; ) {
<a name="l00853"></a>00853          <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a7a9aa5cd362edc7d593196f57686c2b9">ast_get_include_registrar</a>(i), registrar) != 0)
<a name="l00854"></a>00854             <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l00855"></a>00855          <a class="code" href="pbx__config_8c.html#ae28cd0df7b3c5c030dd3c0ad12a1267e">PUT_CTX_HDR</a>;
<a name="l00856"></a>00856          fprintf(output, <span class="stringliteral">&quot;include =&gt; %s\n&quot;</span>, <a class="code" href="pbx_8h.html#acb52f47bcc03f9dd5d781d7e272040b0">ast_get_include_name</a>(i));
<a name="l00857"></a>00857       }
<a name="l00858"></a>00858       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a142de6e0271ada6b306f2f7420a3fd77">ast_walk_context_includes</a>(c, NULL))
<a name="l00859"></a>00859          fprintf(output, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00860"></a>00860 
<a name="l00861"></a>00861       <span class="comment">/* walk through switches */</span>
<a name="l00862"></a>00862       <span class="keywordflow">for</span> (sw = NULL; (sw = <a class="code" href="pbx_8h.html#a64653e3c5cdfab48075b4001bd74655d">ast_walk_context_switches</a>(c, sw)) ; ) {
<a name="l00863"></a>00863          <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a1361d2a84278cee910c8ca0c7964c84c">ast_get_switch_registrar</a>(sw), registrar) != 0)
<a name="l00864"></a>00864             <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l00865"></a>00865          <a class="code" href="pbx__config_8c.html#ae28cd0df7b3c5c030dd3c0ad12a1267e">PUT_CTX_HDR</a>;
<a name="l00866"></a>00866          fprintf(output, <span class="stringliteral">&quot;switch =&gt; %s/%s\n&quot;</span>,
<a name="l00867"></a>00867                 <a class="code" href="pbx_8h.html#a87693eca302936ade0be97cab21e4f56">ast_get_switch_name</a>(sw), <a class="code" href="pbx_8h.html#accdca3b300f8f1ff523872bd3a129adc">ast_get_switch_data</a>(sw));
<a name="l00868"></a>00868       }
<a name="l00869"></a>00869 
<a name="l00870"></a>00870       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64653e3c5cdfab48075b4001bd74655d">ast_walk_context_switches</a>(c, NULL))
<a name="l00871"></a>00871          fprintf(output, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00872"></a>00872 
<a name="l00873"></a>00873       <span class="comment">/* fireout ignorepats ... */</span>
<a name="l00874"></a>00874       <span class="keywordflow">for</span> (ip = NULL; (ip = <a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(c, ip)); ) {
<a name="l00875"></a>00875          <span class="keywordflow">if</span> (strcmp(<a class="code" href="pbx_8h.html#a1a219215514e9ed08ff67cc02c2dd1d3">ast_get_ignorepat_registrar</a>(ip), registrar) != 0)
<a name="l00876"></a>00876             <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l00877"></a>00877          <a class="code" href="pbx__config_8c.html#ae28cd0df7b3c5c030dd3c0ad12a1267e">PUT_CTX_HDR</a>;
<a name="l00878"></a>00878          fprintf(output, <span class="stringliteral">&quot;ignorepat =&gt; %s\n&quot;</span>,
<a name="l00879"></a>00879                   <a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip));
<a name="l00880"></a>00880       }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882       <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l00883"></a>00883    }  
<a name="l00884"></a>00884 
<a name="l00885"></a>00885    <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l00886"></a>00886    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__config_8c.html#ad916c8366b5027888b762aae71fe0af6">save_dialplan_lock</a>);
<a name="l00887"></a>00887    fclose(output);
<a name="l00888"></a>00888 
<a name="l00889"></a>00889    <span class="keywordflow">if</span> (incomplete) {
<a name="l00890"></a>00890       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Saved dialplan is incomplete\n&quot;</span>);
<a name="l00891"></a>00891       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l00892"></a>00892    }
<a name="l00893"></a>00893 
<a name="l00894"></a>00894    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Dialplan successfully saved into &apos;%s&apos;\n&quot;</span>,
<a name="l00895"></a>00895       filename);
<a name="l00896"></a>00896    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00897"></a>00897 }
<a name="l00898"></a>00898 <span class="comment"></span>
<a name="l00899"></a>00899 <span class="comment">/*!</span>
<a name="l00900"></a>00900 <span class="comment"> * \brief ADD EXTENSION command stuff</span>
<a name="l00901"></a>00901 <span class="comment"> */</span>
<a name="l00902"></a><a class="code" href="pbx__config_8c.html#ae1666c9eeb486a2b8475d926eddf0b7c">00902</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#ae1666c9eeb486a2b8475d926eddf0b7c" title="ADD EXTENSION command stuff.">handle_cli_dialplan_add_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00903"></a>00903 {
<a name="l00904"></a>00904    <span class="keywordtype">char</span> *whole_exten;
<a name="l00905"></a>00905    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, *prior;
<a name="l00906"></a>00906    <span class="keywordtype">int</span> iprior = -2;
<a name="l00907"></a>00907    <span class="keywordtype">char</span> *<a class="code" href="structast__exten.html#aa40e509d3af869c736d2c5e2d67ce97e">cidmatch</a>, *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>, *app_data;
<a name="l00908"></a>00908    <span class="keywordtype">char</span> *start, *end;
<a name="l00909"></a>00909 
<a name="l00910"></a>00910    <span class="keywordflow">switch</span> (cmd) {
<a name="l00911"></a>00911    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00912"></a>00912       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan add extension&quot;</span>;
<a name="l00913"></a>00913       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00914"></a>00914          <span class="stringliteral">&quot;Usage: dialplan add extension &lt;exten&gt;,&lt;priority&gt;,&lt;app&gt;,&lt;app-data&gt;\n&quot;</span>
<a name="l00915"></a>00915          <span class="stringliteral">&quot;       into &lt;context&gt; [replace]\n\n&quot;</span>
<a name="l00916"></a>00916          <span class="stringliteral">&quot;       This command will add new extension into &lt;context&gt;. If there is an\n&quot;</span>
<a name="l00917"></a>00917          <span class="stringliteral">&quot;       existence of extension with the same priority and last &apos;replace&apos;\n&quot;</span>
<a name="l00918"></a>00918          <span class="stringliteral">&quot;       arguments is given here we simply replace this extension.\n&quot;</span>
<a name="l00919"></a>00919          <span class="stringliteral">&quot;\n&quot;</span>
<a name="l00920"></a>00920          <span class="stringliteral">&quot;Example: dialplan add extension 6123,1,Dial,IAX/216.207.245.56/6123 into local\n&quot;</span>
<a name="l00921"></a>00921          <span class="stringliteral">&quot;         Now, you can dial 6123 and talk to Markster :)\n&quot;</span>;
<a name="l00922"></a>00922       <span class="keywordflow">return</span> NULL;
<a name="l00923"></a>00923    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00924"></a>00924       <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#a0813e753c67b53ef188c369766d84d74">complete_dialplan_add_extension</a>(a);
<a name="l00925"></a>00925    }
<a name="l00926"></a>00926 
<a name="l00927"></a>00927    <span class="comment">/* check for arguments at first */</span>
<a name="l00928"></a>00928    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 7)
<a name="l00929"></a>00929       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00930"></a>00930    <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;into&quot;</span>))
<a name="l00931"></a>00931       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00932"></a>00932    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 7)
<a name="l00933"></a>00933       <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[6], <span class="stringliteral">&quot;replace&quot;</span>))
<a name="l00934"></a>00934          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00935"></a>00935 
<a name="l00936"></a>00936    <span class="comment">/* XXX overwrite argv[3] */</span>
<a name="l00937"></a>00937    whole_exten = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3];
<a name="l00938"></a>00938    exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;whole_exten,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l00939"></a>00939    <span class="keywordflow">if</span> (strchr(exten, <span class="charliteral">&apos;/&apos;</span>)) {
<a name="l00940"></a>00940       cidmatch = exten;
<a name="l00941"></a>00941       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;cidmatch,<span class="stringliteral">&quot;/&quot;</span>);
<a name="l00942"></a>00942    } <span class="keywordflow">else</span> {
<a name="l00943"></a>00943       cidmatch = NULL;
<a name="l00944"></a>00944    }
<a name="l00945"></a>00945    prior = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;whole_exten,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l00946"></a>00946    <span class="keywordflow">if</span> (prior) {
<a name="l00947"></a>00947       <span class="keywordflow">if</span> (!strcmp(prior, <span class="stringliteral">&quot;hint&quot;</span>)) {
<a name="l00948"></a>00948          iprior = <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>;
<a name="l00949"></a>00949       } <span class="keywordflow">else</span> {
<a name="l00950"></a>00950          <span class="keywordflow">if</span> (sscanf(prior, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;iprior) != 1) {
<a name="l00951"></a>00951             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid priority\n&quot;</span>, prior);
<a name="l00952"></a>00952             prior = NULL;
<a name="l00953"></a>00953          }
<a name="l00954"></a>00954       }
<a name="l00955"></a>00955    }
<a name="l00956"></a>00956    app = whole_exten;
<a name="l00957"></a>00957    <span class="keywordflow">if</span> (app &amp;&amp; (start = strchr(app, <span class="charliteral">&apos;(&apos;</span>)) &amp;&amp; (end = strrchr(app, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l00958"></a>00958       *start = *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00959"></a>00959       app_data = start + 1;
<a name="l00960"></a>00960    } <span class="keywordflow">else</span> {
<a name="l00961"></a>00961       <span class="keywordflow">if</span> (app) {
<a name="l00962"></a>00962          app_data = strchr(app, <span class="charliteral">&apos;,&apos;</span>);
<a name="l00963"></a>00963          <span class="keywordflow">if</span> (app_data) {
<a name="l00964"></a>00964             *app_data = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00965"></a>00965             app_data++;
<a name="l00966"></a>00966          }
<a name="l00967"></a>00967       } <span class="keywordflow">else</span>   
<a name="l00968"></a>00968          app_data = NULL;
<a name="l00969"></a>00969    }
<a name="l00970"></a>00970 
<a name="l00971"></a>00971    <span class="keywordflow">if</span> (!exten || !prior || !app || (!app_data &amp;&amp; iprior != <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>))
<a name="l00972"></a>00972       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00973"></a>00973 
<a name="l00974"></a>00974    <span class="keywordflow">if</span> (!app_data)
<a name="l00975"></a>00975       app_data=<span class="stringliteral">&quot;&quot;</span>;
<a name="l00976"></a>00976    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a07176e8d314eb68b3b50279fafa11390" title="Add and extension to an extension context.">ast_add_extension</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 7 ? 1 : 0, exten, iprior, NULL, cidmatch, app,
<a name="l00977"></a>00977       (<span class="keywordtype">void</span> *)<a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(app_data), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, registrar)) {
<a name="l00978"></a>00978       <span class="keywordflow">switch</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l00979"></a>00979       <span class="keywordflow">case</span> ENOMEM:
<a name="l00980"></a>00980          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l00981"></a>00981          <span class="keywordflow">break</span>;
<a name="l00982"></a>00982 
<a name="l00983"></a>00983       <span class="keywordflow">case</span> EBUSY:
<a name="l00984"></a>00984          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to lock context(s) list, please try again later\n&quot;</span>);
<a name="l00985"></a>00985          <span class="keywordflow">break</span>;
<a name="l00986"></a>00986 
<a name="l00987"></a>00987       <span class="keywordflow">case</span> ENOENT:
<a name="l00988"></a>00988          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No existence of &apos;%s&apos; context\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00989"></a>00989          <span class="keywordflow">break</span>;
<a name="l00990"></a>00990 
<a name="l00991"></a>00991       <span class="keywordflow">case</span> EEXIST:
<a name="l00992"></a>00992          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Extension %s@%s with priority %s already exists\n&quot;</span>,
<a name="l00993"></a>00993             exten, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], prior);
<a name="l00994"></a>00994          <span class="keywordflow">break</span>;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996       <span class="keywordflow">default</span>:
<a name="l00997"></a>00997          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to add &apos;%s,%s,%s,%s&apos; extension into &apos;%s&apos; context\n&quot;</span>,
<a name="l00998"></a>00998                exten, prior, app, app_data, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l00999"></a>00999          <span class="keywordflow">break</span>;
<a name="l01000"></a>01000       }
<a name="l01001"></a>01001       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01002"></a>01002    }
<a name="l01003"></a>01003 
<a name="l01004"></a>01004    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 7)
<a name="l01005"></a>01005       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Extension %s@%s (%s) replace by &apos;%s,%s,%s,%s&apos;\n&quot;</span>,
<a name="l01006"></a>01006          exten, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], prior, exten, prior, app, app_data);
<a name="l01007"></a>01007    <span class="keywordflow">else</span>
<a name="l01008"></a>01008       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Extension &apos;%s,%s,%s,%s&apos; added into &apos;%s&apos; context\n&quot;</span>,
<a name="l01009"></a>01009          exten, prior, app, app_data, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01010"></a>01010 
<a name="l01011"></a>01011    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01012"></a>01012 }
<a name="l01013"></a>01013 <span class="comment"></span>
<a name="l01014"></a>01014 <span class="comment">/*! dialplan add extension 6123,1,Dial,IAX/212.71.138.13/6123 into local */</span>
<a name="l01015"></a><a class="code" href="pbx__config_8c.html#a0813e753c67b53ef188c369766d84d74">01015</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a0813e753c67b53ef188c369766d84d74">complete_dialplan_add_extension</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01016"></a>01016 {
<a name="l01017"></a>01017    <span class="keywordtype">int</span> which = 0;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4) {      <span class="comment">/* complete &apos;into&apos; word ... */</span>
<a name="l01020"></a>01020       <span class="keywordflow">return</span> (a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0) ? <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;into&quot;</span>) : NULL;
<a name="l01021"></a>01021    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 5) { <span class="comment">/* complete context */</span>
<a name="l01022"></a>01022       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c = NULL;
<a name="l01023"></a>01023       <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l01024"></a>01024       <span class="keywordtype">char</span> *res = NULL;
<a name="l01025"></a>01025 
<a name="l01026"></a>01026       <span class="comment">/* try to lock contexts list ... */</span>
<a name="l01027"></a>01027       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l01028"></a>01028          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock contexts list\n&quot;</span>);
<a name="l01029"></a>01029          <span class="keywordflow">return</span> NULL;
<a name="l01030"></a>01030       }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032       <span class="comment">/* walk through all contexts */</span>
<a name="l01033"></a>01033       <span class="keywordflow">while</span> ( !res &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)) )
<a name="l01034"></a>01034          <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l01035"></a>01035             res = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l01036"></a>01036       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l01037"></a>01037       <span class="keywordflow">return</span> res;
<a name="l01038"></a>01038    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 6) {
<a name="l01039"></a>01039       <span class="keywordflow">return</span> a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0 ? <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;replace&quot;</span>) : NULL;
<a name="l01040"></a>01040    }
<a name="l01041"></a>01041    <span class="keywordflow">return</span> NULL;
<a name="l01042"></a>01042 }
<a name="l01043"></a>01043 <span class="comment"></span>
<a name="l01044"></a>01044 <span class="comment">/*!</span>
<a name="l01045"></a>01045 <span class="comment"> * IGNOREPAT CLI stuff</span>
<a name="l01046"></a>01046 <span class="comment"> */</span>
<a name="l01047"></a><a class="code" href="pbx__config_8c.html#a0e2785e550b1c651dcb87a4f4d4c23c0">01047</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a0e2785e550b1c651dcb87a4f4d4c23c0">handle_cli_dialplan_add_ignorepat</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01048"></a>01048 {
<a name="l01049"></a>01049    <span class="keywordflow">switch</span> (cmd) {
<a name="l01050"></a>01050    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01051"></a>01051       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan add ignorepat&quot;</span>;
<a name="l01052"></a>01052       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01053"></a>01053          <span class="stringliteral">&quot;Usage: dialplan add ignorepat &lt;pattern&gt; into &lt;context&gt;\n&quot;</span>
<a name="l01054"></a>01054          <span class="stringliteral">&quot;       This command adds a new ignore pattern into context &lt;context&gt;\n&quot;</span>
<a name="l01055"></a>01055          <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01056"></a>01056          <span class="stringliteral">&quot;Example: dialplan add ignorepat _3XX into local\n&quot;</span>;
<a name="l01057"></a>01057       <span class="keywordflow">return</span> NULL;
<a name="l01058"></a>01058    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01059"></a>01059       <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#a31bfc2065da6ed14289f8e2ec3b4e969">complete_dialplan_add_ignorepat</a>(a);
<a name="l01060"></a>01060    }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6)
<a name="l01063"></a>01063       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;into&quot;</span>))
<a name="l01066"></a>01066       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a24d57cdfe3409c388e4b81b67ecdee70" title="Add an ignorepat.">ast_context_add_ignorepat</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], registrar)) {
<a name="l01069"></a>01069       <span class="keywordflow">switch</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l01070"></a>01070       <span class="keywordflow">case</span> ENOMEM:
<a name="l01071"></a>01071          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l01072"></a>01072          <span class="keywordflow">break</span>;
<a name="l01073"></a>01073 
<a name="l01074"></a>01074       <span class="keywordflow">case</span> ENOENT:
<a name="l01075"></a>01075          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of &apos;%s&apos; context\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01076"></a>01076          <span class="keywordflow">break</span>;
<a name="l01077"></a>01077 
<a name="l01078"></a>01078       <span class="keywordflow">case</span> EEXIST:
<a name="l01079"></a>01079          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Ignore pattern &apos;%s&apos; already included in &apos;%s&apos; context\n&quot;</span>,
<a name="l01080"></a>01080             a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01081"></a>01081          <span class="keywordflow">break</span>;
<a name="l01082"></a>01082 
<a name="l01083"></a>01083       <span class="keywordflow">case</span> EBUSY:
<a name="l01084"></a>01084          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to lock context(s) list, please, try again later\n&quot;</span>);
<a name="l01085"></a>01085          <span class="keywordflow">break</span>;
<a name="l01086"></a>01086 
<a name="l01087"></a>01087       <span class="keywordflow">default</span>:
<a name="l01088"></a>01088          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to add ingore pattern &apos;%s&apos; into &apos;%s&apos; context\n&quot;</span>,
<a name="l01089"></a>01089             a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01090"></a>01090          <span class="keywordflow">break</span>;
<a name="l01091"></a>01091       }
<a name="l01092"></a>01092       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01093"></a>01093    }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Ignore pattern &apos;%s&apos; added into &apos;%s&apos; context\n&quot;</span>,
<a name="l01096"></a>01096       a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01097"></a>01097 
<a name="l01098"></a>01098    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01099"></a>01099 }
<a name="l01100"></a>01100 
<a name="l01101"></a><a class="code" href="pbx__config_8c.html#a31bfc2065da6ed14289f8e2ec3b4e969">01101</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a31bfc2065da6ed14289f8e2ec3b4e969">complete_dialplan_add_ignorepat</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01102"></a>01102 {
<a name="l01103"></a>01103    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4)
<a name="l01104"></a>01104       <span class="keywordflow">return</span> a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0 ? <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;into&quot;</span>) : NULL;
<a name="l01105"></a>01105    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 5) {
<a name="l01106"></a>01106       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c;
<a name="l01107"></a>01107       <span class="keywordtype">int</span> which = 0;
<a name="l01108"></a>01108       <span class="keywordtype">char</span> *dupline, *ignorepat = NULL;
<a name="l01109"></a>01109       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01110"></a>01110       <span class="keywordtype">char</span> *ret = NULL;
<a name="l01111"></a>01111       <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113       <span class="comment">/* XXX skip first three words &apos;dialplan&apos; &apos;add&apos; &apos;ignorepat&apos; */</span>
<a name="l01114"></a>01114       s = <a class="code" href="pbx__config_8c.html#aa77bc29b6dcf98ceb37fb182138a1ace" title="moves to the n-th word in the string, or empty string if none">skip_words</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, 3);
<a name="l01115"></a>01115       <span class="keywordflow">if</span> (s == NULL)
<a name="l01116"></a>01116          <span class="keywordflow">return</span> NULL;
<a name="l01117"></a>01117       dupline = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(s);
<a name="l01118"></a>01118       <span class="keywordflow">if</span> (!dupline) {
<a name="l01119"></a>01119          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Malloc failure\n&quot;</span>);
<a name="l01120"></a>01120          <span class="keywordflow">return</span> NULL;
<a name="l01121"></a>01121       }
<a name="l01122"></a>01122       ignorepat = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;dupline, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l01125"></a>01125          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to lock contexts list\n&quot;</span>);
<a name="l01126"></a>01126          <span class="keywordflow">return</span> NULL;
<a name="l01127"></a>01127       }
<a name="l01128"></a>01128 
<a name="l01129"></a>01129       <span class="keywordflow">for</span> (c = NULL; !ret &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c));) {
<a name="l01130"></a>01130          <span class="keywordtype">int</span> found = 0;
<a name="l01131"></a>01131 
<a name="l01132"></a>01132          <span class="keywordflow">if</span> (!<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len))
<a name="l01133"></a>01133             <span class="keywordflow">continue</span>; <span class="comment">/* not mine */</span>
<a name="l01134"></a>01134          <span class="keywordflow">if</span> (ignorepat) <span class="comment">/* there must be one, right ? */</span>
<a name="l01135"></a>01135             found = <a class="code" href="pbx__config_8c.html#a59f5c70f51cd454cd6e1521ff4db0b71" title="return true if &amp;#39;name&amp;#39; is in the ignorepats for context c">lookup_c_ip</a>(c, ignorepat);
<a name="l01136"></a>01136          <span class="keywordflow">if</span> (!found &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l01137"></a>01137             ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l01138"></a>01138       }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(ignorepat);
<a name="l01141"></a>01141       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l01142"></a>01142       <span class="keywordflow">return</span> ret;
<a name="l01143"></a>01143    }
<a name="l01144"></a>01144 
<a name="l01145"></a>01145    <span class="keywordflow">return</span> NULL;
<a name="l01146"></a>01146 }
<a name="l01147"></a>01147 
<a name="l01148"></a><a class="code" href="pbx__config_8c.html#a711bb65834560e8de3209ecc1c669520">01148</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a711bb65834560e8de3209ecc1c669520">handle_cli_dialplan_remove_ignorepat</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01149"></a>01149 {
<a name="l01150"></a>01150    <span class="keywordflow">switch</span> (cmd) {
<a name="l01151"></a>01151    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01152"></a>01152       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan remove ignorepat&quot;</span>;
<a name="l01153"></a>01153       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01154"></a>01154          <span class="stringliteral">&quot;Usage: dialplan remove ignorepat &lt;pattern&gt; from &lt;context&gt;\n&quot;</span>
<a name="l01155"></a>01155          <span class="stringliteral">&quot;       This command removes an ignore pattern from context &lt;context&gt;\n&quot;</span>
<a name="l01156"></a>01156          <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01157"></a>01157          <span class="stringliteral">&quot;Example: dialplan remove ignorepat _3XX from local\n&quot;</span>;
<a name="l01158"></a>01158       <span class="keywordflow">return</span> NULL;
<a name="l01159"></a>01159    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01160"></a>01160       <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#ae7d67e34cee0389f6001c664733be796">complete_dialplan_remove_ignorepat</a>(a);
<a name="l01161"></a>01161    }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 6)
<a name="l01164"></a>01164       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01165"></a>01165 
<a name="l01166"></a>01166    <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;from&quot;</span>))
<a name="l01167"></a>01167       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01168"></a>01168 
<a name="l01169"></a>01169    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a08e43dc093c586991af4e2f86fa14f2e">ast_context_remove_ignorepat</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], registrar)) {
<a name="l01170"></a>01170       <span class="keywordflow">switch</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l01171"></a>01171       <span class="keywordflow">case</span> EBUSY:
<a name="l01172"></a>01172          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to lock context(s) list, please try again later\n&quot;</span>);
<a name="l01173"></a>01173          <span class="keywordflow">break</span>;
<a name="l01174"></a>01174 
<a name="l01175"></a>01175       <span class="keywordflow">case</span> ENOENT:
<a name="l01176"></a>01176          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of &apos;%s&apos; context\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01177"></a>01177          <span class="keywordflow">break</span>;
<a name="l01178"></a>01178 
<a name="l01179"></a>01179       <span class="keywordflow">case</span> EINVAL:
<a name="l01180"></a>01180          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There is no existence of &apos;%s&apos; ignore pattern in &apos;%s&apos; context\n&quot;</span>,
<a name="l01181"></a>01181                a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01182"></a>01182          <span class="keywordflow">break</span>;
<a name="l01183"></a>01183 
<a name="l01184"></a>01184       <span class="keywordflow">default</span>:
<a name="l01185"></a>01185          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Failed to remove ignore pattern &apos;%s&apos; from &apos;%s&apos; context\n&quot;</span>,
<a name="l01186"></a>01186                a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01187"></a>01187          <span class="keywordflow">break</span>;
<a name="l01188"></a>01188       }
<a name="l01189"></a>01189       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01190"></a>01190    }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Ignore pattern &apos;%s&apos; removed from &apos;%s&apos; context\n&quot;</span>,
<a name="l01193"></a>01193       a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[5]);
<a name="l01194"></a>01194    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01195"></a>01195 }
<a name="l01196"></a>01196 
<a name="l01197"></a><a class="code" href="pbx__config_8c.html#ae7d67e34cee0389f6001c664733be796">01197</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#ae7d67e34cee0389f6001c664733be796">complete_dialplan_remove_ignorepat</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01198"></a>01198 {
<a name="l01199"></a>01199    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *c;
<a name="l01200"></a>01200    <span class="keywordtype">int</span> which = 0;
<a name="l01201"></a>01201    <span class="keywordtype">char</span> *ret = NULL;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3) {
<a name="l01204"></a>01204       <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l01205"></a>01205       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l01206"></a>01206          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock contexts list\n&quot;</span>);
<a name="l01207"></a>01207          <span class="keywordflow">return</span> NULL;
<a name="l01208"></a>01208       }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210       <span class="keywordflow">for</span> (c = NULL; !ret &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c));) {
<a name="l01211"></a>01211          <span class="keyword">struct </span><a class="code" href="structast__ignorepat.html" title="ast_ignorepat: Ignore patterns in dial plan">ast_ignorepat</a> *ip;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) <span class="comment">/* error, skip it */</span>
<a name="l01214"></a>01214             <span class="keywordflow">continue</span>;
<a name="l01215"></a>01215          
<a name="l01216"></a>01216          <span class="keywordflow">for</span> (ip = NULL; !ret &amp;&amp; (ip = <a class="code" href="pbx_8h.html#a0e9dbe4e0003f65b67c78979f2fbfa8e">ast_walk_context_ignorepats</a>(c, ip));) {
<a name="l01217"></a>01217             <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip), a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>) {
<a name="l01218"></a>01218                <span class="comment">/* n-th match */</span>
<a name="l01219"></a>01219                <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *cw = NULL;
<a name="l01220"></a>01220                <span class="keywordtype">int</span> found = 0;
<a name="l01221"></a>01221                <span class="keywordflow">while</span> ( (cw = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(cw)) &amp;&amp; cw != c &amp;&amp; !found) {
<a name="l01222"></a>01222                   <span class="comment">/* XXX do i stop on c, or skip it ? */</span>
<a name="l01223"></a>01223                   found = <a class="code" href="pbx__config_8c.html#a59f5c70f51cd454cd6e1521ff4db0b71" title="return true if &amp;#39;name&amp;#39; is in the ignorepats for context c">lookup_c_ip</a>(cw, <a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip));
<a name="l01224"></a>01224                }
<a name="l01225"></a>01225                <span class="keywordflow">if</span> (!found)
<a name="l01226"></a>01226                   ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<a class="code" href="pbx_8h.html#a0c324514fc22df9cc5b32ceb68006e79">ast_get_ignorepat_name</a>(ip));
<a name="l01227"></a>01227             }
<a name="l01228"></a>01228          }
<a name="l01229"></a>01229          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l01230"></a>01230       }
<a name="l01231"></a>01231       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l01232"></a>01232       <span class="keywordflow">return</span> ret;
<a name="l01233"></a>01233    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4) {
<a name="l01234"></a>01234        <span class="keywordflow">return</span> a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> == 0 ? <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;from&quot;</span>) : NULL;
<a name="l01235"></a>01235    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 5) { <span class="comment">/* XXX check this */</span>
<a name="l01236"></a>01236       <span class="keywordtype">char</span> *dupline, *duplinet, *ignorepat;
<a name="l01237"></a>01237       <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>);
<a name="l01238"></a>01238 
<a name="l01239"></a>01239       dupline = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>);
<a name="l01240"></a>01240       <span class="keywordflow">if</span> (!dupline) {
<a name="l01241"></a>01241          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of free memory\n&quot;</span>);
<a name="l01242"></a>01242          <span class="keywordflow">return</span> NULL;
<a name="l01243"></a>01243       }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245       duplinet = dupline;
<a name="l01246"></a>01246       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;duplinet, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01247"></a>01247       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;duplinet, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01248"></a>01248       ignorepat = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;duplinet, <span class="stringliteral">&quot; &quot;</span>);
<a name="l01249"></a>01249 
<a name="l01250"></a>01250       <span class="keywordflow">if</span> (!ignorepat) {
<a name="l01251"></a>01251          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(dupline);
<a name="l01252"></a>01252          <span class="keywordflow">return</span> NULL;
<a name="l01253"></a>01253       }
<a name="l01254"></a>01254 
<a name="l01255"></a>01255       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa2c309331fff0a086ab8e216f803d546" title="Read locks the context list.">ast_rdlock_contexts</a>()) {
<a name="l01256"></a>01256          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock contexts list\n&quot;</span>);
<a name="l01257"></a>01257          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(dupline);
<a name="l01258"></a>01258          <span class="keywordflow">return</span> NULL;
<a name="l01259"></a>01259       }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261       <span class="keywordflow">for</span> (c = NULL; !ret &amp;&amp; (c = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(c)); ) {
<a name="l01262"></a>01262          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#af1a624244a07626a8f70843005206c95" title="Read locks a given context.">ast_rdlock_context</a>(c)) <span class="comment">/* fail, skip it */</span>
<a name="l01263"></a>01263             <span class="keywordflow">continue</span>;
<a name="l01264"></a>01264          <span class="keywordflow">if</span> (!<a class="code" href="pbx__config_8c.html#ae8a47febba42ad736c85a10f00f792f0" title="match the first &amp;#39;len&amp;#39; chars of word. len==0 always succeeds">partial_match</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c), a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, len))
<a name="l01265"></a>01265             <span class="keywordflow">continue</span>;
<a name="l01266"></a>01266          <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#a59f5c70f51cd454cd6e1521ff4db0b71" title="return true if &amp;#39;name&amp;#39; is in the ignorepats for context c">lookup_c_ip</a>(c, ignorepat) &amp;&amp; ++which &gt; a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>)
<a name="l01267"></a>01267             ret = <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<a class="code" href="pbx_8h.html#aa42372790072cff15f75c674917115b0">ast_get_context_name</a>(c));
<a name="l01268"></a>01268          <a class="code" href="pbx_8h.html#a805796e4728845bff70c4caf5b224308">ast_unlock_context</a>(c);
<a name="l01269"></a>01269       }
<a name="l01270"></a>01270       <a class="code" href="pbx_8h.html#ae517a87b356aec60d5de4591ef94581b" title="Unlocks contexts.">ast_unlock_contexts</a>();
<a name="l01271"></a>01271       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(dupline);
<a name="l01272"></a>01272       <span class="keywordflow">return</span> NULL;
<a name="l01273"></a>01273    }
<a name="l01274"></a>01274 
<a name="l01275"></a>01275    <span class="keywordflow">return</span> NULL;
<a name="l01276"></a>01276 }
<a name="l01277"></a>01277 
<a name="l01278"></a>01278 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a5cded49ee99bdd58e2bb9f4f7ca3cb77">pbx_load_module</a>(<span class="keywordtype">void</span>);
<a name="l01279"></a>01279 
<a name="l01280"></a><a class="code" href="pbx__config_8c.html#a19c2685430f267dd6610d1fa827848cb">01280</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a19c2685430f267dd6610d1fa827848cb">handle_cli_dialplan_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01281"></a>01281 {
<a name="l01282"></a>01282    <span class="keywordflow">switch</span> (cmd) {
<a name="l01283"></a>01283    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01284"></a>01284       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;dialplan reload&quot;</span>;
<a name="l01285"></a>01285       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01286"></a>01286          <span class="stringliteral">&quot;Usage: dialplan reload\n&quot;</span>
<a name="l01287"></a>01287          <span class="stringliteral">&quot;       Reload extensions.conf without reloading any other\n&quot;</span>
<a name="l01288"></a>01288          <span class="stringliteral">&quot;       modules.  This command does not delete global variables\n&quot;</span>
<a name="l01289"></a>01289          <span class="stringliteral">&quot;       unless clearglobalvars is set to yes in extensions.conf\n&quot;</span>;
<a name="l01290"></a>01290       <span class="keywordflow">return</span> NULL;
<a name="l01291"></a>01291    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01292"></a>01292       <span class="keywordflow">return</span> NULL;
<a name="l01293"></a>01293    }
<a name="l01294"></a>01294 
<a name="l01295"></a>01295    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2)
<a name="l01296"></a>01296       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298    <span class="keywordflow">if</span> (clearglobalvars_config)
<a name="l01299"></a>01299       <a class="code" href="pbx_8h.html#a92a606276589c513842f0cd7e455126b">pbx_builtin_clear_globals</a>();
<a name="l01300"></a>01300 
<a name="l01301"></a>01301    <a class="code" href="pbx__config_8c.html#a5cded49ee99bdd58e2bb9f4f7ca3cb77">pbx_load_module</a>();
<a name="l01302"></a>01302    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Dialplan reloaded.\n&quot;</span>);
<a name="l01303"></a>01303    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01304"></a>01304 }
<a name="l01305"></a>01305 <span class="comment"></span>
<a name="l01306"></a>01306 <span class="comment">/*!</span>
<a name="l01307"></a>01307 <span class="comment"> * CLI entries for commands provided by this module</span>
<a name="l01308"></a>01308 <span class="comment"> */</span>
<a name="l01309"></a><a class="code" href="pbx__config_8c.html#a7d1a455e6d10d06b7a729d347077c3b2">01309</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="pbx__config_8c.html#a7d1a455e6d10d06b7a729d347077c3b2">cli_pbx_config</a>[] = {
<a name="l01310"></a>01310    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#ae1666c9eeb486a2b8475d926eddf0b7c" title="ADD EXTENSION command stuff.">handle_cli_dialplan_add_extension</a>,    <span class="stringliteral">&quot;Add new extension into context&quot;</span>),
<a name="l01311"></a>01311    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a7c53d064336cfa9201114eded4ab536b">handle_cli_dialplan_remove_extension</a>, <span class="stringliteral">&quot;Remove a specified extension&quot;</span>),
<a name="l01312"></a>01312    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a0e2785e550b1c651dcb87a4f4d4c23c0">handle_cli_dialplan_add_ignorepat</a>,    <span class="stringliteral">&quot;Add new ignore pattern&quot;</span>),
<a name="l01313"></a>01313    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a711bb65834560e8de3209ecc1c669520">handle_cli_dialplan_remove_ignorepat</a>, <span class="stringliteral">&quot;Remove ignore pattern from context&quot;</span>),
<a name="l01314"></a>01314    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a36cd9454ed5a5342b0bfed2d40369480">handle_cli_dialplan_add_include</a>,      <span class="stringliteral">&quot;Include context in other context&quot;</span>),
<a name="l01315"></a>01315    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a3c90bef28aacc0d9552be3b6ac28af65">handle_cli_dialplan_remove_include</a>,   <span class="stringliteral">&quot;Remove a specified include from context&quot;</span>),
<a name="l01316"></a>01316    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a19c2685430f267dd6610d1fa827848cb">handle_cli_dialplan_reload</a>,           <span class="stringliteral">&quot;Reload extensions and *only* extensions&quot;</span>)
<a name="l01317"></a>01317 };
<a name="l01318"></a>01318 
<a name="l01319"></a><a class="code" href="pbx__config_8c.html#a3a72af156eebdb47f94f66a35470ecb5">01319</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="pbx__config_8c.html#a3a72af156eebdb47f94f66a35470ecb5">cli_dialplan_save</a> =
<a name="l01320"></a>01320    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="pbx__config_8c.html#a7c88cc0f438374eacdd9d1d00392dd2c" title="&amp;#39;save dialplan&amp;#39; CLI command implementation functions ...">handle_cli_dialplan_save</a>, <span class="stringliteral">&quot;Save dialplan&quot;</span>);
<a name="l01321"></a>01321 <span class="comment"></span>
<a name="l01322"></a>01322 <span class="comment">/*!</span>
<a name="l01323"></a>01323 <span class="comment"> * Standard module functions ...</span>
<a name="l01324"></a>01324 <span class="comment"> */</span>
<a name="l01325"></a><a class="code" href="pbx__config_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01325</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01326"></a>01326 {
<a name="l01327"></a>01327    <span class="keywordflow">if</span> (static_config &amp;&amp; !write_protect_config)
<a name="l01328"></a>01328       <a class="code" href="cli_8h.html#a3189e6720486808603d13f5d2b58daf4" title="Unregisters a command or an array of commands.">ast_cli_unregister</a>(&amp;cli_dialplan_save);
<a name="l01329"></a>01329    <span class="keywordflow">if</span> (overrideswitch_config) {
<a name="l01330"></a>01330       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(overrideswitch_config);
<a name="l01331"></a>01331    }
<a name="l01332"></a>01332    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_pbx_config, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_pbx_config));
<a name="l01333"></a>01333    <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(NULL, registrar);
<a name="l01334"></a>01334    <span class="keywordflow">return</span> 0;
<a name="l01335"></a>01335 }
<a name="l01336"></a>01336 <span class="comment"></span>
<a name="l01337"></a>01337 <span class="comment">/*!\note Protect against misparsing based upon commas in the middle of fields</span>
<a name="l01338"></a>01338 <span class="comment"> * like character classes.  We&apos;ve taken steps to permit pretty much every other</span>
<a name="l01339"></a>01339 <span class="comment"> * printable character in a character class, so properly handling a comma at</span>
<a name="l01340"></a>01340 <span class="comment"> * this level is a natural extension.  This is almost like the standard</span>
<a name="l01341"></a>01341 <span class="comment"> * application parser in app.c, except that it handles square brackets. */</span>
<a name="l01342"></a><a class="code" href="pbx__config_8c.html#a76db778b44c776c3b6719b8f19f01601">01342</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="pbx__config_8c.html#a76db778b44c776c3b6719b8f19f01601">pbx_strsep</a>(<span class="keywordtype">char</span> **destructible, <span class="keyword">const</span> <span class="keywordtype">char</span> *delim)
<a name="l01343"></a>01343 {
<a name="l01344"></a>01344    <span class="keywordtype">int</span> square = 0;
<a name="l01345"></a>01345    <span class="keywordtype">char</span> *res = *destructible;
<a name="l01346"></a>01346    <span class="keywordflow">for</span> (; destructible &amp;&amp; *destructible &amp;&amp; **destructible; (*destructible)++) {
<a name="l01347"></a>01347       <span class="keywordflow">if</span> (**destructible == <span class="charliteral">&apos;[&apos;</span> &amp;&amp; !strchr(delim, <span class="charliteral">&apos;[&apos;</span>)) {
<a name="l01348"></a>01348          square++;
<a name="l01349"></a>01349       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (**destructible == <span class="charliteral">&apos;]&apos;</span> &amp;&amp; !strchr(delim, <span class="charliteral">&apos;]&apos;</span>)) {
<a name="l01350"></a>01350          <span class="keywordflow">if</span> (square) {
<a name="l01351"></a>01351             square--;
<a name="l01352"></a>01352          }
<a name="l01353"></a>01353       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (**destructible == <span class="charliteral">&apos;\\&apos;</span> &amp;&amp; !strchr(delim, <span class="charliteral">&apos;\\&apos;</span>)) {
<a name="l01354"></a>01354          (*destructible)++;
<a name="l01355"></a>01355       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strchr(delim, **destructible) &amp;&amp; !square) {
<a name="l01356"></a>01356          **destructible = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01357"></a>01357          (*destructible)++;
<a name="l01358"></a>01358          <span class="keywordflow">break</span>;
<a name="l01359"></a>01359       }
<a name="l01360"></a>01360    }
<a name="l01361"></a>01361    <span class="keywordflow">if</span> (destructible &amp;&amp; *destructible &amp;&amp; **destructible == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01362"></a>01362       *destructible = NULL;
<a name="l01363"></a>01363    }
<a name="l01364"></a>01364    <span class="keywordflow">return</span> res;
<a name="l01365"></a>01365 }
<a name="l01366"></a>01366 
<a name="l01367"></a><a class="code" href="pbx__config_8c.html#ab852e40dd8f14855804301dc82ff08df">01367</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#ab852e40dd8f14855804301dc82ff08df">pbx_load_config</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#ac269be8b91ae4b24df48de5d8ad7e7a7">config_file</a>)
<a name="l01368"></a>01368 {
<a name="l01369"></a>01369    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01370"></a>01370    <span class="keywordtype">char</span> *end;
<a name="l01371"></a>01371    <span class="keywordtype">char</span> *label;
<a name="l01372"></a>01372 <span class="preprocessor">#ifdef LOW_MEMORY</span>
<a name="l01373"></a>01373 <span class="preprocessor"></span>   <span class="keywordtype">char</span> realvalue[256];
<a name="l01374"></a>01374 <span class="preprocessor">#else</span>
<a name="l01375"></a>01375 <span class="preprocessor"></span>   <span class="keywordtype">char</span> realvalue[8192];
<a name="l01376"></a>01376 <span class="preprocessor">#endif</span>
<a name="l01377"></a>01377 <span class="preprocessor"></span>   <span class="keywordtype">int</span> lastpri = -2;
<a name="l01378"></a>01378    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l01379"></a>01379    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01380"></a>01380    <span class="keyword">const</span> <span class="keywordtype">char</span> *cxt;
<a name="l01381"></a>01381    <span class="keyword">const</span> <span class="keywordtype">char</span> *aft;
<a name="l01382"></a>01382    <span class="keyword">const</span> <span class="keywordtype">char</span> *newpm, *ovsw;
<a name="l01383"></a>01383    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l01384"></a>01384    <span class="keywordtype">char</span> lastextension[256];
<a name="l01385"></a>01385    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config_file, config_flags);
<a name="l01386"></a>01386    <span class="keywordflow">if</span> (!cfg || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>)
<a name="l01387"></a>01387       <span class="keywordflow">return</span> 0;
<a name="l01388"></a>01388 
<a name="l01389"></a>01389    <span class="comment">/* Use existing config to populate the PBX table */</span>
<a name="l01390"></a>01390    static_config = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;static&quot;</span>));
<a name="l01391"></a>01391    write_protect_config = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;writeprotect&quot;</span>));
<a name="l01392"></a>01392    <span class="keywordflow">if</span> ((aft = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;autofallthrough&quot;</span>)))
<a name="l01393"></a>01393       autofallthrough_config = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(aft);
<a name="l01394"></a>01394    <span class="keywordflow">if</span> ((newpm = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;extenpatternmatchnew&quot;</span>)))
<a name="l01395"></a>01395       extenpatternmatchnew_config = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(newpm);
<a name="l01396"></a>01396    clearglobalvars_config = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;clearglobalvars&quot;</span>));
<a name="l01397"></a>01397    <span class="keywordflow">if</span> ((ovsw = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;overrideswitch&quot;</span>))) {
<a name="l01398"></a>01398       <span class="keywordflow">if</span> (overrideswitch_config) {
<a name="l01399"></a>01399          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(overrideswitch_config);
<a name="l01400"></a>01400       }
<a name="l01401"></a>01401       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(ovsw)) {
<a name="l01402"></a>01402          overrideswitch_config = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(ovsw);
<a name="l01403"></a>01403       } <span class="keywordflow">else</span> {
<a name="l01404"></a>01404          overrideswitch_config = NULL;
<a name="l01405"></a>01405       }
<a name="l01406"></a>01406    }
<a name="l01407"></a>01407 
<a name="l01408"></a>01408    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(userscontext, <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;userscontext&quot;</span>) ?: <span class="stringliteral">&quot;default&quot;</span>, <span class="keyword">sizeof</span>(userscontext));
<a name="l01409"></a>01409                             
<a name="l01410"></a>01410    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;globals&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01411"></a>01411       <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, realvalue, <span class="keyword">sizeof</span>(realvalue) - 1);
<a name="l01412"></a>01412       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(NULL, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, realvalue);
<a name="l01413"></a>01413    }
<a name="l01414"></a>01414    <span class="keywordflow">for</span> (cxt = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l01415"></a>01415         cxt;
<a name="l01416"></a>01416         cxt = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cxt)) {
<a name="l01417"></a>01417       <span class="comment">/* All categories but &quot;general&quot; or &quot;globals&quot; are considered contexts */</span>
<a name="l01418"></a>01418       <span class="keywordflow">if</span> (!strcasecmp(cxt, <span class="stringliteral">&quot;general&quot;</span>) || !strcasecmp(cxt, <span class="stringliteral">&quot;globals&quot;</span>)) {
<a name="l01419"></a>01419          <span class="keywordflow">continue</span>;
<a name="l01420"></a>01420       }
<a name="l01421"></a>01421       <span class="keywordflow">if</span> (!(con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(&amp;local_contexts, local_table, cxt, registrar))) {
<a name="l01422"></a>01422          <span class="keywordflow">continue</span>;
<a name="l01423"></a>01423       }
<a name="l01424"></a>01424 
<a name="l01425"></a>01425       <span class="comment">/* Reset continuation items at the beginning of each context */</span>
<a name="l01426"></a>01426       lastextension[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01427"></a>01427       lastpri = -2;
<a name="l01428"></a>01428 
<a name="l01429"></a>01429       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cxt); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01430"></a>01430          <span class="keywordtype">char</span> *tc = NULL;
<a name="l01431"></a>01431          <span class="keywordtype">char</span> realext[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01432"></a>01432          <span class="keywordtype">char</span> *stringp, *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>;
<a name="l01433"></a>01433 
<a name="l01434"></a>01434          <span class="keywordflow">if</span> (!strncasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;same&quot;</span>, 4)) {
<a name="l01435"></a>01435             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(lastextension)) {
<a name="l01436"></a>01436                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No previous pattern in the first entry of context &apos;%s&apos; to match &apos;%s&apos;!\n&quot;</span>, cxt, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l01437"></a>01437                <span class="keywordflow">continue</span>;
<a name="l01438"></a>01438             }
<a name="l01439"></a>01439             <span class="keywordflow">if</span> ((stringp = tc = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))) {
<a name="l01440"></a>01440                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(realext, lastextension, <span class="keyword">sizeof</span>(realext));
<a name="l01441"></a>01441                <span class="keywordflow">goto</span> process_extension;
<a name="l01442"></a>01442             }
<a name="l01443"></a>01443          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;exten&quot;</span>)) {
<a name="l01444"></a>01444             <span class="keywordtype">int</span> ipri;
<a name="l01445"></a>01445             <span class="keywordtype">char</span> *plus, *firstp;
<a name="l01446"></a>01446             <span class="keywordtype">char</span> *pri, *appl, *data, *cidmatch;
<a name="l01447"></a>01447 
<a name="l01448"></a>01448             <span class="keywordflow">if</span> (!(stringp = tc = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))) {
<a name="l01449"></a>01449                <span class="keywordflow">continue</span>;
<a name="l01450"></a>01450             }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452             ext = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="pbx__config_8c.html#a76db778b44c776c3b6719b8f19f01601">pbx_strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l01453"></a>01453             <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, ext, realext, <span class="keyword">sizeof</span>(realext) - 1);
<a name="l01454"></a>01454             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(lastextension, realext, <span class="keyword">sizeof</span>(lastextension));
<a name="l01455"></a>01455 process_extension:
<a name="l01456"></a>01456             ipri = -2;
<a name="l01457"></a>01457             <span class="keywordflow">if</span> ((cidmatch = strchr(realext, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l01458"></a>01458                *cidmatch++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01459"></a>01459                <a class="code" href="callerid_8h.html#a6a61669b28d0f994e44db5e3baab6ef2" title="Shrink a phone number in place to just digits (more accurately it just removes ()&amp;#39;s...">ast_shrink_phone_number</a>(cidmatch);
<a name="l01460"></a>01460             }
<a name="l01461"></a>01461             pri = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>), <span class="stringliteral">&quot;&quot;</span>);
<a name="l01462"></a>01462             pri = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(pri);
<a name="l01463"></a>01463             pri = <a class="code" href="strings_8h.html#ac5899ca9e586caf3041865762e770550" title="Trims trailing whitespace characters from a string.">ast_trim_blanks</a>(pri);
<a name="l01464"></a>01464             <span class="keywordflow">if</span> ((label = strchr(pri, <span class="charliteral">&apos;(&apos;</span>))) {
<a name="l01465"></a>01465                *label++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01466"></a>01466                <span class="keywordflow">if</span> ((end = strchr(label, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l01467"></a>01467                   *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01468"></a>01468                } <span class="keywordflow">else</span> {
<a name="l01469"></a>01469                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Label missing trailing &apos;)&apos; at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l01470"></a>01470                }
<a name="l01471"></a>01471             }
<a name="l01472"></a>01472             <span class="keywordflow">if</span> ((plus = strchr(pri, <span class="charliteral">&apos;+&apos;</span>))) {
<a name="l01473"></a>01473                *plus++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01474"></a>01474             }
<a name="l01475"></a>01475             <span class="keywordflow">if</span> (!strcmp(pri,<span class="stringliteral">&quot;hint&quot;</span>)) {
<a name="l01476"></a>01476                ipri = <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>;
<a name="l01477"></a>01477             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(pri, <span class="stringliteral">&quot;next&quot;</span>) || !strcmp(pri, <span class="stringliteral">&quot;n&quot;</span>)) {
<a name="l01478"></a>01478                <span class="keywordflow">if</span> (lastpri &gt; -2) {
<a name="l01479"></a>01479                   ipri = lastpri + 1;
<a name="l01480"></a>01480                } <span class="keywordflow">else</span> {
<a name="l01481"></a>01481                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t use &apos;next&apos; priority on the first entry!\n&quot;</span>);
<a name="l01482"></a>01482                }
<a name="l01483"></a>01483             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(pri, <span class="stringliteral">&quot;same&quot;</span>) || !strcmp(pri, <span class="stringliteral">&quot;s&quot;</span>)) {
<a name="l01484"></a>01484                <span class="keywordflow">if</span> (lastpri &gt; -2) {
<a name="l01485"></a>01485                   ipri = lastpri;
<a name="l01486"></a>01486                } <span class="keywordflow">else</span> {
<a name="l01487"></a>01487                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t use &apos;same&apos; priority on the first entry!\n&quot;</span>);
<a name="l01488"></a>01488                }
<a name="l01489"></a>01489             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(pri, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;ipri) != 1 &amp;&amp;
<a name="l01490"></a>01490                   (ipri = <a class="code" href="pbx_8h.html#aa3c47773f118e7775a5c052dbb4bb3aa" title="Find the priority of an extension that has the specified label.">ast_findlabel_extension2</a>(NULL, con, realext, pri, cidmatch)) &lt; 1) {
<a name="l01491"></a>01491                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid priority/label &apos;%s&apos; at line %d\n&quot;</span>, pri, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l01492"></a>01492                ipri = 0;
<a name="l01493"></a>01493             }
<a name="l01494"></a>01494             appl = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(stringp, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01495"></a>01495             <span class="comment">/* Find the first occurrence of &apos;(&apos; */</span>
<a name="l01496"></a>01496             <span class="keywordflow">if</span> (!(firstp = strchr(appl, <span class="charliteral">&apos;(&apos;</span>))) {
<a name="l01497"></a>01497                <span class="comment">/* No arguments */</span>
<a name="l01498"></a>01498                data = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01499"></a>01499             } <span class="keywordflow">else</span> {
<a name="l01500"></a>01500                <span class="keywordtype">char</span> *orig_appl = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(appl);
<a name="l01501"></a>01501 
<a name="l01502"></a>01502                <span class="keywordflow">if</span> (!orig_appl)
<a name="l01503"></a>01503                   <span class="keywordflow">return</span> -1;
<a name="l01504"></a>01504                
<a name="l01505"></a>01505                appl = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;(&quot;</span>);
<a name="l01506"></a>01506 
<a name="l01507"></a>01507                <span class="comment">/* check if there are variables or expressions without an application, like: exten =&gt; 100,hint,DAHDI/g0/${GLOBAL(var)}  */</span>
<a name="l01508"></a>01508                <span class="keywordflow">if</span> (strstr(appl, <span class="stringliteral">&quot;${&quot;</span>) || strstr(appl, <span class="stringliteral">&quot;$[&quot;</span>)){
<a name="l01509"></a>01509                   <span class="comment">/* set appl to original one */</span>
<a name="l01510"></a>01510                   strcpy(appl, orig_appl);
<a name="l01511"></a>01511                   <span class="comment">/* set no data */</span>
<a name="l01512"></a>01512                   data = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01513"></a>01513                <span class="comment">/* no variable before application found -&gt; go ahead */</span>
<a name="l01514"></a>01514                } <span class="keywordflow">else</span> {
<a name="l01515"></a>01515                   data = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(stringp, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01516"></a>01516                   <span class="keywordflow">if</span> ((end = strrchr(data, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l01517"></a>01517                      *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01518"></a>01518                   } <span class="keywordflow">else</span> {
<a name="l01519"></a>01519                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No closing parenthesis found? &apos;%s(%s&apos;\n&quot;</span>, appl, data);
<a name="l01520"></a>01520                   }
<a name="l01521"></a>01521                }
<a name="l01522"></a>01522                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(orig_appl);
<a name="l01523"></a>01523             }
<a name="l01524"></a>01524 
<a name="l01525"></a>01525             appl = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(appl);
<a name="l01526"></a>01526             <span class="keywordflow">if</span> (ipri) {
<a name="l01527"></a>01527                <span class="keywordflow">if</span> (plus) {
<a name="l01528"></a>01528                   ipri += atoi(plus);
<a name="l01529"></a>01529                }
<a name="l01530"></a>01530                lastpri = ipri;
<a name="l01531"></a>01531                <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#a5240f07b6ff8003ff47b856d44ef7226">ast_opt_dont_warn</a> &amp;&amp; !strcmp(realext, <span class="stringliteral">&quot;_.&quot;</span>)) {
<a name="l01532"></a>01532                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;The use of &apos;_.&apos; for an extension is strongly discouraged and can have unexpected behavior.  Please use &apos;_X.&apos; instead at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l01533"></a>01533                }
<a name="l01534"></a>01534                <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 0, realext, ipri, label, cidmatch, appl, <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(data), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, registrar)) {
<a name="l01535"></a>01535                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to register extension at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l01536"></a>01536                }
<a name="l01537"></a>01537             }
<a name="l01538"></a>01538             <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(tc);
<a name="l01539"></a>01539          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;include&quot;</span>)) {
<a name="l01540"></a>01540             <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, realvalue, <span class="keyword">sizeof</span>(realvalue) - 1);
<a name="l01541"></a>01541             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aceaa74fb91df5e8f7892f59953ff6283" title="Add a context include.">ast_context_add_include2</a>(con, realvalue, registrar)) {
<a name="l01542"></a>01542                <span class="keywordflow">switch</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>) {
<a name="l01543"></a>01543                   <span class="keywordflow">case</span> ENOMEM:
<a name="l01544"></a>01544                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory for context addition\n&quot;</span>);
<a name="l01545"></a>01545                      <span class="keywordflow">break</span>;
<a name="l01546"></a>01546 
<a name="l01547"></a>01547                   <span class="keywordflow">case</span> EBUSY:
<a name="l01548"></a>01548                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to lock context(s) list, please try again later\n&quot;</span>);
<a name="l01549"></a>01549                      <span class="keywordflow">break</span>;
<a name="l01550"></a>01550 
<a name="l01551"></a>01551                   <span class="keywordflow">case</span> EEXIST:
<a name="l01552"></a>01552                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Context &apos;%s&apos; already included in &apos;%s&apos; context\n&quot;</span>,
<a name="l01553"></a>01553                            v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, cxt);
<a name="l01554"></a>01554                      <span class="keywordflow">break</span>;
<a name="l01555"></a>01555 
<a name="l01556"></a>01556                   <span class="keywordflow">case</span> ENOENT:
<a name="l01557"></a>01557                   <span class="keywordflow">case</span> EINVAL:
<a name="l01558"></a>01558                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;There is no existence of context &apos;%s&apos;\n&quot;</span>,
<a name="l01559"></a>01559                            <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOENT ? v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a> : cxt);
<a name="l01560"></a>01560                      <span class="keywordflow">break</span>;
<a name="l01561"></a>01561 
<a name="l01562"></a>01562                   <span class="keywordflow">default</span>:
<a name="l01563"></a>01563                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to include &apos;%s&apos; in &apos;%s&apos; context\n&quot;</span>,
<a name="l01564"></a>01564                            v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, cxt);
<a name="l01565"></a>01565                      <span class="keywordflow">break</span>;
<a name="l01566"></a>01566                }
<a name="l01567"></a>01567             }
<a name="l01568"></a>01568          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;ignorepat&quot;</span>)) {
<a name="l01569"></a>01569             <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, realvalue, <span class="keyword">sizeof</span>(realvalue) - 1);
<a name="l01570"></a>01570             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a82c040aa706c09bd6294b2333a2a0587">ast_context_add_ignorepat2</a>(con, realvalue, registrar)) {
<a name="l01571"></a>01571                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to include ignorepat &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, cxt);
<a name="l01572"></a>01572             }
<a name="l01573"></a>01573          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;switch&quot;</span>) || !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;lswitch&quot;</span>) || !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;eswitch&quot;</span>)) {
<a name="l01574"></a>01574             <span class="keywordtype">char</span> *stringp = realvalue;
<a name="l01575"></a>01575             <span class="keywordtype">char</span> *appl, *data;
<a name="l01576"></a>01576             
<a name="l01577"></a>01577             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;switch&quot;</span>)) {
<a name="l01578"></a>01578                <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(NULL, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, realvalue, <span class="keyword">sizeof</span>(realvalue) - 1);
<a name="l01579"></a>01579             } <span class="keywordflow">else</span> {
<a name="l01580"></a>01580                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(realvalue, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(realvalue));
<a name="l01581"></a>01581             }
<a name="l01582"></a>01582             appl = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01583"></a>01583             data = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(stringp, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01584"></a>01584             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a98b8af4a068416ee570f9d78cb9af724" title="Adds a switch (first param is a ast_context).">ast_context_add_switch2</a>(con, appl, data, !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;eswitch&quot;</span>), registrar)) {
<a name="l01585"></a>01585                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to include switch &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, cxt);
<a name="l01586"></a>01586             }
<a name="l01587"></a>01587          } <span class="keywordflow">else</span> {
<a name="l01588"></a>01588             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;==!!== Unknown directive: %s at line %d -- IGNORING!!!\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l01589"></a>01589          }
<a name="l01590"></a>01590       }
<a name="l01591"></a>01591    }
<a name="l01592"></a>01592    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01593"></a>01593    <span class="keywordflow">return</span> 1;
<a name="l01594"></a>01594 }
<a name="l01595"></a>01595 
<a name="l01596"></a><a class="code" href="pbx__config_8c.html#ad08f3b0d3ed4074ddd8eb8ddcf88f28b">01596</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx__config_8c.html#ad08f3b0d3ed4074ddd8eb8ddcf88f28b">append_interface</a>(<span class="keywordtype">char</span> *iface, <span class="keywordtype">int</span> maxlen, <span class="keywordtype">char</span> *add)
<a name="l01597"></a>01597 {
<a name="l01598"></a>01598    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(iface);
<a name="l01599"></a>01599    <span class="keywordflow">if</span> (strlen(add) + len &lt; maxlen - 2) {
<a name="l01600"></a>01600       <span class="keywordflow">if</span> (strlen(iface)) {
<a name="l01601"></a>01601          iface[len] = <span class="charliteral">&apos;&amp;&apos;</span>;
<a name="l01602"></a>01602          strcpy(iface + len + 1, add);
<a name="l01603"></a>01603       } <span class="keywordflow">else</span>
<a name="l01604"></a>01604          strcpy(iface, add);
<a name="l01605"></a>01605    }
<a name="l01606"></a>01606 }
<a name="l01607"></a>01607 
<a name="l01608"></a><a class="code" href="pbx__config_8c.html#a107259a531ec907ee5c56fbb4448bc44">01608</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="pbx__config_8c.html#a107259a531ec907ee5c56fbb4448bc44">pbx_load_users</a>(<span class="keywordtype">void</span>)
<a name="l01609"></a>01609 {
<a name="l01610"></a>01610    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01611"></a>01611    <span class="keywordtype">char</span> *cat, *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l01612"></a>01612    <span class="keyword">const</span> <span class="keywordtype">char</span> *dahdichan;
<a name="l01613"></a>01613    <span class="keyword">const</span> <span class="keywordtype">char</span> *hasexten, *altexts;
<a name="l01614"></a>01614    <span class="keywordtype">char</span> tmp[256];
<a name="l01615"></a>01615    <span class="keywordtype">char</span> iface[256];
<a name="l01616"></a>01616    <span class="keywordtype">char</span> dahdicopy[256];
<a name="l01617"></a>01617    <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, altcopy[256];
<a name="l01618"></a>01618    <span class="keywordtype">char</span> *c;
<a name="l01619"></a>01619    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01620"></a>01620    <span class="keywordtype">int</span> hasvoicemail;
<a name="l01621"></a>01621    <span class="keywordtype">int</span> start, finish, x;
<a name="l01622"></a>01622    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con = NULL;
<a name="l01623"></a>01623    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l01624"></a>01624    
<a name="l01625"></a>01625    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags);
<a name="l01626"></a>01626    <span class="keywordflow">if</span> (!cfg)
<a name="l01627"></a>01627       <span class="keywordflow">return</span>;
<a name="l01628"></a>01628 
<a name="l01629"></a>01629    <span class="keywordflow">for</span> (cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL); cat ; cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat)) {
<a name="l01630"></a>01630       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>))
<a name="l01631"></a>01631          <span class="keywordflow">continue</span>;
<a name="l01632"></a>01632       iface[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01633"></a>01633       len = <span class="keyword">sizeof</span>(iface);
<a name="l01634"></a>01634       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ad9fd2625614158b152434e45acf1d78b" title="Retrieve a configuration variable within the configuration set. Retrieves the named...">ast_config_option</a>(cfg, cat, <span class="stringliteral">&quot;hassip&quot;</span>))) {
<a name="l01635"></a>01635          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;SIP/%s&quot;</span>, cat);
<a name="l01636"></a>01636          <a class="code" href="pbx__config_8c.html#ad08f3b0d3ed4074ddd8eb8ddcf88f28b">append_interface</a>(iface, <span class="keyword">sizeof</span>(iface), tmp);
<a name="l01637"></a>01637       }
<a name="l01638"></a>01638       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ad9fd2625614158b152434e45acf1d78b" title="Retrieve a configuration variable within the configuration set. Retrieves the named...">ast_config_option</a>(cfg, cat, <span class="stringliteral">&quot;hasiax&quot;</span>))) {
<a name="l01639"></a>01639          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;IAX2/%s&quot;</span>, cat);
<a name="l01640"></a>01640          <a class="code" href="pbx__config_8c.html#ad08f3b0d3ed4074ddd8eb8ddcf88f28b">append_interface</a>(iface, <span class="keyword">sizeof</span>(iface), tmp);
<a name="l01641"></a>01641       }
<a name="l01642"></a>01642       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ad9fd2625614158b152434e45acf1d78b" title="Retrieve a configuration variable within the configuration set. Retrieves the named...">ast_config_option</a>(cfg, cat, <span class="stringliteral">&quot;hash323&quot;</span>))) {
<a name="l01643"></a>01643          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;H323/%s&quot;</span>, cat);
<a name="l01644"></a>01644          <a class="code" href="pbx__config_8c.html#ad08f3b0d3ed4074ddd8eb8ddcf88f28b">append_interface</a>(iface, <span class="keyword">sizeof</span>(iface), tmp);
<a name="l01645"></a>01645       }
<a name="l01646"></a>01646       hasexten = <a class="code" href="config_8h.html#ad9fd2625614158b152434e45acf1d78b" title="Retrieve a configuration variable within the configuration set. Retrieves the named...">ast_config_option</a>(cfg, cat, <span class="stringliteral">&quot;hasexten&quot;</span>);
<a name="l01647"></a>01647       <span class="keywordflow">if</span> (hasexten &amp;&amp; !<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(hasexten))
<a name="l01648"></a>01648          <span class="keywordflow">continue</span>;
<a name="l01649"></a>01649       hasvoicemail = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ad9fd2625614158b152434e45acf1d78b" title="Retrieve a configuration variable within the configuration set. Retrieves the named...">ast_config_option</a>(cfg, cat, <span class="stringliteral">&quot;hasvoicemail&quot;</span>));
<a name="l01650"></a>01650       dahdichan = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">&quot;dahdichan&quot;</span>);
<a name="l01651"></a>01651       <span class="keywordflow">if</span> (!dahdichan)
<a name="l01652"></a>01652          dahdichan = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dahdichan&quot;</span>);
<a name="l01653"></a>01653       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(dahdichan)) {
<a name="l01654"></a>01654          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dahdicopy, dahdichan, <span class="keyword">sizeof</span>(dahdicopy));
<a name="l01655"></a>01655          c = dahdicopy;
<a name="l01656"></a>01656          chan = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01657"></a>01657          <span class="keywordflow">while</span> (chan) {
<a name="l01658"></a>01658             <span class="keywordflow">if</span> (sscanf(chan, <span class="stringliteral">&quot;%30d-%30d&quot;</span>, &amp;start, &amp;finish) == 2) {
<a name="l01659"></a>01659                <span class="comment">/* Range */</span>
<a name="l01660"></a>01660             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(chan, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;start)) {
<a name="l01661"></a>01661                <span class="comment">/* Just one */</span>
<a name="l01662"></a>01662                finish = start;
<a name="l01663"></a>01663             } <span class="keywordflow">else</span> {
<a name="l01664"></a>01664                start = 0; finish = 0;
<a name="l01665"></a>01665             }
<a name="l01666"></a>01666             <span class="keywordflow">if</span> (finish &lt; start) {
<a name="l01667"></a>01667                x = finish;
<a name="l01668"></a>01668                finish = start;
<a name="l01669"></a>01669                start = x;
<a name="l01670"></a>01670             }
<a name="l01671"></a>01671             <span class="keywordflow">for</span> (x = start; x &lt;= finish; x++) {
<a name="l01672"></a>01672                snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;DAHDI/%d&quot;</span>, x);
<a name="l01673"></a>01673                <a class="code" href="pbx__config_8c.html#ad08f3b0d3ed4074ddd8eb8ddcf88f28b">append_interface</a>(iface, <span class="keyword">sizeof</span>(iface), tmp);
<a name="l01674"></a>01674             }
<a name="l01675"></a>01675             chan = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01676"></a>01676          }
<a name="l01677"></a>01677       }
<a name="l01678"></a>01678       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(iface)) {
<a name="l01679"></a>01679          <span class="comment">/* Only create a context here when it is really needed. Otherwise default empty context</span>
<a name="l01680"></a>01680 <span class="comment">         created by pbx_config may conflict with the one explicitly created by pbx_ael */</span>
<a name="l01681"></a>01681          <span class="keywordflow">if</span> (!con)
<a name="l01682"></a>01682             con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(&amp;local_contexts, local_table, userscontext, registrar);
<a name="l01683"></a>01683 
<a name="l01684"></a>01684          <span class="keywordflow">if</span> (!con) {
<a name="l01685"></a>01685             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Can&apos;t find/create user context &apos;%s&apos;\n&quot;</span>, userscontext);
<a name="l01686"></a>01686             <span class="keywordflow">return</span>;
<a name="l01687"></a>01687          }
<a name="l01688"></a>01688 
<a name="l01689"></a>01689          <span class="comment">/* Add hint */</span>
<a name="l01690"></a>01690          <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 0, cat, -1, NULL, NULL, iface, NULL, NULL, registrar);
<a name="l01691"></a>01691          <span class="comment">/* If voicemail, use &quot;stdexten&quot; else use plain old dial */</span>
<a name="l01692"></a>01692          <span class="keywordflow">if</span> (hasvoicemail) {
<a name="l01693"></a>01693             snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;stdexten,%s,${HINT}&quot;</span>, cat);
<a name="l01694"></a>01694             <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 0, cat, 1, NULL, NULL, <span class="stringliteral">&quot;Macro&quot;</span>, <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(tmp), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, registrar);
<a name="l01695"></a>01695          } <span class="keywordflow">else</span> {
<a name="l01696"></a>01696             <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 0, cat, 1, NULL, NULL, <span class="stringliteral">&quot;Dial&quot;</span>, <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;${HINT}&quot;</span>), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, registrar);
<a name="l01697"></a>01697          }
<a name="l01698"></a>01698          altexts = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">&quot;alternateexts&quot;</span>);
<a name="l01699"></a>01699          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(altexts)) {
<a name="l01700"></a>01700             snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s,1&quot;</span>, cat);
<a name="l01701"></a>01701             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(altcopy, altexts, <span class="keyword">sizeof</span>(altcopy));
<a name="l01702"></a>01702             c = altcopy;
<a name="l01703"></a>01703             ext = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01704"></a>01704             <span class="keywordflow">while</span> (ext) {
<a name="l01705"></a>01705                <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 0, ext, 1, NULL, NULL, <span class="stringliteral">&quot;Goto&quot;</span>, <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(tmp), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, registrar);
<a name="l01706"></a>01706                ext = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01707"></a>01707             }
<a name="l01708"></a>01708          }
<a name="l01709"></a>01709       }
<a name="l01710"></a>01710    }
<a name="l01711"></a>01711    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01712"></a>01712 }
<a name="l01713"></a>01713 
<a name="l01714"></a><a class="code" href="pbx__config_8c.html#a5cded49ee99bdd58e2bb9f4f7ca3cb77">01714</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#a5cded49ee99bdd58e2bb9f4f7ca3cb77">pbx_load_module</a>(<span class="keywordtype">void</span>)
<a name="l01715"></a>01715 {
<a name="l01716"></a>01716    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l01717"></a>01717 
<a name="l01718"></a>01718    <span class="keywordflow">if</span> (!local_table)
<a name="l01719"></a>01719       local_table = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(17, <a class="code" href="pbx_8h.html#a20a2f5668173430437db02cdd0acc9f3" title="hashtable functions for contexts">ast_hashtab_compare_contexts</a>, <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>, <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>, <a class="code" href="pbx_8h.html#a56461864a4e21b14e753b78f9ac7afb7">ast_hashtab_hash_contexts</a>, 0);
<a name="l01720"></a>01720 
<a name="l01721"></a>01721    <span class="keywordflow">if</span> (!<a class="code" href="pbx__config_8c.html#ab852e40dd8f14855804301dc82ff08df">pbx_load_config</a>(config))
<a name="l01722"></a>01722       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01723"></a>01723    
<a name="l01724"></a>01724    <a class="code" href="pbx__config_8c.html#a107259a531ec907ee5c56fbb4448bc44">pbx_load_users</a>();
<a name="l01725"></a>01725 
<a name="l01726"></a>01726    <a class="code" href="pbx_8h.html#a833a703b21d8f6bcb9f68e57185bca67" title="Merge the temporary contexts into a global contexts list and delete from the global...">ast_merge_contexts_and_delete</a>(&amp;local_contexts, local_table, registrar);
<a name="l01727"></a>01727    local_table = NULL; <span class="comment">/* the local table has been moved into the global one. */</span>
<a name="l01728"></a>01728    local_contexts = NULL;
<a name="l01729"></a>01729 
<a name="l01730"></a>01730    <span class="keywordflow">for</span> (con = NULL; (con = <a class="code" href="pbx_8h.html#a4cd5282ca555370652a7304c0c7ea4c4">ast_walk_contexts</a>(con));)
<a name="l01731"></a>01731       <a class="code" href="pbx_8h.html#aca6b16b4b7433a12e65103a2f1ab8028" title="Verifies includes in an ast_contect structure.">ast_context_verify_includes</a>(con);
<a name="l01732"></a>01732 
<a name="l01733"></a>01733    <a class="code" href="pbx_8h.html#a7a46e2644221be6cb7ca7ba2723006cd">pbx_set_overrideswitch</a>(overrideswitch_config);
<a name="l01734"></a>01734    <a class="code" href="pbx_8h.html#aeb0407c693573096981db1a00fab4eb8">pbx_set_autofallthrough</a>(autofallthrough_config);
<a name="l01735"></a>01735    <a class="code" href="pbx_8h.html#a86a7469073a22661d4db7086245c5b18">pbx_set_extenpatternmatchnew</a>(extenpatternmatchnew_config);
<a name="l01736"></a>01736 
<a name="l01737"></a>01737    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01738"></a>01738 }
<a name="l01739"></a>01739 
<a name="l01740"></a><a class="code" href="pbx__config_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01740</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01741"></a>01741 {
<a name="l01742"></a>01742    <span class="keywordflow">if</span> (<a class="code" href="pbx__config_8c.html#a5cded49ee99bdd58e2bb9f4f7ca3cb77">pbx_load_module</a>())
<a name="l01743"></a>01743       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01744"></a>01744  
<a name="l01745"></a>01745    <span class="keywordflow">if</span> (static_config &amp;&amp; !write_protect_config)
<a name="l01746"></a>01746       <a class="code" href="cli_8h.html#a0ca7e108aceb1cd488bb9e3ee26e4ebc" title="Registers a command or an array of commands.">ast_cli_register</a>(&amp;cli_dialplan_save);
<a name="l01747"></a>01747    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_pbx_config, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_pbx_config));
<a name="l01748"></a>01748 
<a name="l01749"></a>01749    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01750"></a>01750 }
<a name="l01751"></a>01751 
<a name="l01752"></a><a class="code" href="pbx__config_8c.html#ad1982509765f4870f1f63412a53ea668">01752</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="pbx__config_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l01753"></a>01753 {
<a name="l01754"></a>01754    <span class="keywordflow">if</span> (clearglobalvars_config)
<a name="l01755"></a>01755       <a class="code" href="pbx_8h.html#a92a606276589c513842f0cd7e455126b">pbx_builtin_clear_globals</a>();
<a name="l01756"></a>01756    <span class="keywordflow">return</span> <a class="code" href="pbx__config_8c.html#a5cded49ee99bdd58e2bb9f4f7ca3cb77">pbx_load_module</a>();
<a name="l01757"></a>01757 }
<a name="l01758"></a>01758 
<a name="l01759"></a>01759 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Text Extension Configuration&quot;</span>,
<a name="l01760"></a>01760       .load = <a class="code" href="pbx__config_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l01761"></a>01761       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l01762"></a>01762       .<a class="code" href="pbx__config_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="pbx__config_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l01763"></a><a class="code" href="pbx__config_8c.html#ae25b9f3970870610911f8850897e8ead">01763</a>           );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:44 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
