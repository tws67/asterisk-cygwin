<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:22:54 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_6ae6169cd48d88136f0d813c029ee18c.html">pbx</a>
  </div>
</div>
<div class="contents">
<h1>pbx_spool.c File Reference</h1>
<p>Full-featured <a class="el" href="structoutgoing.html">outgoing</a> call spool support.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;sys/stat.h&gt;</code><br/>
<code>#include &lt;<a class="el" href="time_8h_source.html">time.h</a>&gt;</code><br/>
<code>#include &lt;utime.h&gt;</code><br/>
<code>#include &lt;dirent.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="logger_8h_source.html">asterisk/logger.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="callerid_8h_source.html">asterisk/callerid.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="options_8h_source.html">asterisk/options.h</a>&quot;</code><br/>

<p><a href="pbx__spool_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structoutgoing.html">outgoing</a></td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734">SPOOL_FLAG_ALWAYS_DELETE</a> =  (1 &lt;&lt; 0), 
<a class="el" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a97b25e061a292ff951dcff7a39959304">SPOOL_FLAG_ARCHIVE</a> =  (1 &lt;&lt; 1)
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a01075546e5467d308ddeb14169bc1311">apply_outgoing</a> (struct <a class="el" href="structoutgoing.html">outgoing</a> *o, char *fn, FILE *<a class="el" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#aa7a68d0622f6db212f1f50e10268905d">attempt_thread</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a> (struct <a class="el" href="structoutgoing.html">outgoing</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a6093aaaf74716132e72d65db5324447a">init_outgoing</a> (struct <a class="el" href="structoutgoing.html">outgoing</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a56de20a1d449ec5c3f5bcdebd41656f7">launch_service</a> (struct <a class="el" href="structoutgoing.html">outgoing</a> *o)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#af79325470445e6e4d889a461ea654873">remove_from_queue</a> (struct <a class="el" href="structoutgoing.html">outgoing</a> *o, const char *<a class="el" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove a call file from the <a class="el" href="structoutgoing.html">outgoing</a> queue optionally moving it in the archive dir.  <a href="#af79325470445e6e4d889a461ea654873"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a42a40f55167da57243f6865030c9a83e">safe_append</a> (struct <a class="el" href="structoutgoing.html">outgoing</a> *o, time_t now, char *s)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a4f8fe1c050846feea728125460a8181d">scan_service</a> (char *fn, time_t now, time_t atime)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a55635376623ac9afd203650fb458907a">scan_thread</a> (void *unused)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Outgoing Spool Support&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a> [255]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__spool_8c.html#a9fba478e22f3c9ba363a2ab697c72c74">qdonedir</a> [255]</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Full-featured <a class="el" href="structoutgoing.html">outgoing</a> call spool support. </p>

<p>Definition in file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a3e279efabf854742684341c3e4f50d31"></a><!-- doxytag: member="pbx_spool.c::@235" ref="a3e279efabf854742684341c3e4f50d31" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734"></a><!-- doxytag: member="SPOOL_FLAG_ALWAYS_DELETE" ref="a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734" args="" -->SPOOL_FLAG_ALWAYS_DELETE</em>&nbsp;</td><td>
<p>Always delete the call file after a call succeeds or the maximum <a class="el" href="structnumber.html" title="Number structure.">number</a> of retries is exceeded, even if the modification time of the call file is in the future. </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a3e279efabf854742684341c3e4f50d31a97b25e061a292ff951dcff7a39959304"></a><!-- doxytag: member="SPOOL_FLAG_ARCHIVE" ref="a3e279efabf854742684341c3e4f50d31a97b25e061a292ff951dcff7a39959304" args="" -->SPOOL_FLAG_ARCHIVE</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00050">50</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00050"></a>00050      {<span class="comment"></span>
<a name="l00051"></a>00051 <span class="comment">   /*! Always delete the call file after a call succeeds or the</span>
<a name="l00052"></a>00052 <span class="comment">    * maximum number of retries is exceeded, even if the</span>
<a name="l00053"></a>00053 <span class="comment">    * modification time of the call file is in the future.</span>
<a name="l00054"></a>00054 <span class="comment">    */</span>
<a name="l00055"></a>00055    <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734">SPOOL_FLAG_ALWAYS_DELETE</a> = (1 &lt;&lt; 0),
<a name="l00056"></a>00056    <span class="comment">/* Don&apos;t unlink the call file after processing, move in qdonedir */</span>
<a name="l00057"></a>00057    <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a97b25e061a292ff951dcff7a39959304">SPOOL_FLAG_ARCHIVE</a> = (1 &lt;&lt; 1)
<a name="l00058"></a>00058 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="pbx_spool.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00532">532</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="pbx_spool.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00532">532</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

</div>
</div>
<a class="anchor" id="a01075546e5467d308ddeb14169bc1311"></a><!-- doxytag: member="pbx_spool.c::apply_outgoing" ref="a01075546e5467d308ddeb14169bc1311" args="(struct outgoing *o, char *fn, FILE *f)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int apply_outgoing </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structoutgoing.html">outgoing</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>f</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00110">110</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::app</a>, <a class="el" href="adsistub_8c_source.html#l00053">app</a>, <a class="el" href="callerid_8c_source.html#l01087">ast_callerid_split()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="frame_8c_source.html#l01233">ast_parse_allow_disallow()</a>, <a class="el" href="utils_8h_source.html#l00092">ast_set2_flag</a>, <a class="el" href="stringfields_8h_source.html#l00285">ast_string_field_set</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="config_8c_source.html#l00223">ast_variable_new()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="pbx__spool_8c_source.html#l00068">outgoing::callingpid</a>, <a class="el" href="chan__mgcp_8c_source.html#l00149">cid_name</a>, <a class="el" href="chan__mgcp_8c_source.html#l00148">cid_num</a>, <a class="el" href="chan__alsa_8c_source.html#l00105">context</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::dest</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::exten</a>, <a class="el" href="chan__alsa_8c_source.html#l00107">exten</a>, <a class="el" href="pbx__spool_8c_source.html#l00069">outgoing::format</a>, <a class="el" href="devicestate_8c_source.html#l00198">last</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx__spool_8c_source.html#l00065">outgoing::maxretries</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="pbx__spool_8c_source.html#l00085">outgoing::options</a>, <a class="el" href="pbx__spool_8c_source.html#l00082">outgoing::priority</a>, <a class="el" href="pbx__spool_8c_source.html#l00064">outgoing::retries</a>, <a class="el" href="pbx__spool_8c_source.html#l00066">outgoing::retrytime</a>, <a class="el" href="pbx__spool_8c_source.html#l00055">SPOOL_FLAG_ALWAYS_DELETE</a>, <a class="el" href="pbx__spool_8c_source.html#l00057">SPOOL_FLAG_ARCHIVE</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::tech</a>, <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>, <a class="el" href="pbx__spool_8c_source.html#l00083">outgoing::vars</a>, and <a class="el" href="pbx__spool_8c_source.html#l00067">outgoing::waittime</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00111"></a>00111 {
<a name="l00112"></a>00112    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l00113"></a>00113    <span class="keywordtype">char</span> *c, *c2;
<a name="l00114"></a>00114    <span class="keywordtype">int</span> lineno = 0;
<a name="l00115"></a>00115    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a> = o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>;
<a name="l00116"></a>00116 
<a name="l00117"></a>00117    <span class="keywordflow">while</span> (last &amp;&amp; last-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00118"></a>00118       last = last-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l00119"></a>00119    }
<a name="l00120"></a>00120 
<a name="l00121"></a>00121    <span class="keywordflow">while</span>(fgets(buf, <span class="keyword">sizeof</span>(buf), <a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)) {
<a name="l00122"></a>00122       lineno++;
<a name="l00123"></a>00123       <span class="comment">/* Trim comments */</span>
<a name="l00124"></a>00124       c = buf;
<a name="l00125"></a>00125       <span class="keywordflow">while</span> ((c = strchr(c, <span class="charliteral">&apos;#&apos;</span>))) {
<a name="l00126"></a>00126          <span class="keywordflow">if</span> ((c == buf) || (*(c-1) == <span class="charliteral">&apos; &apos;</span>) || (*(c-1) == <span class="charliteral">&apos;\t&apos;</span>))
<a name="l00127"></a>00127             *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00128"></a>00128          <span class="keywordflow">else</span>
<a name="l00129"></a>00129             c++;
<a name="l00130"></a>00130       }
<a name="l00131"></a>00131 
<a name="l00132"></a>00132       c = buf;
<a name="l00133"></a>00133       <span class="keywordflow">while</span> ((c = strchr(c, <span class="charliteral">&apos;;&apos;</span>))) {
<a name="l00134"></a>00134          <span class="keywordflow">if</span> ((c &gt; buf) &amp;&amp; (c[-1] == <span class="charliteral">&apos;\\&apos;</span>)) {
<a name="l00135"></a>00135             memmove(c - 1, c, strlen(c) + 1);
<a name="l00136"></a>00136             c++;
<a name="l00137"></a>00137          } <span class="keywordflow">else</span> {
<a name="l00138"></a>00138             *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00139"></a>00139             <span class="keywordflow">break</span>;
<a name="l00140"></a>00140          }
<a name="l00141"></a>00141       }
<a name="l00142"></a>00142 
<a name="l00143"></a>00143       <span class="comment">/* Trim trailing white space */</span>
<a name="l00144"></a>00144       <span class="keywordflow">while</span>(!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(buf) &amp;&amp; buf[strlen(buf) - 1] &lt; 33)
<a name="l00145"></a>00145          buf[strlen(buf) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00146"></a>00146       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(buf)) {
<a name="l00147"></a>00147          c = strchr(buf, <span class="charliteral">&apos;:&apos;</span>);
<a name="l00148"></a>00148          <span class="keywordflow">if</span> (c) {
<a name="l00149"></a>00149             *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00150"></a>00150             c++;
<a name="l00151"></a>00151             <span class="keywordflow">while</span> ((*c) &amp;&amp; (*c &lt; 33))
<a name="l00152"></a>00152                c++;
<a name="l00153"></a>00153 <span class="preprocessor">#if 0</span>
<a name="l00154"></a>00154 <span class="preprocessor"></span>            printf(<span class="stringliteral">&quot;&apos;%s&apos; is &apos;%s&apos; at line %d\n&quot;</span>, buf, c, lineno);
<a name="l00155"></a>00155 <span class="preprocessor">#endif</span>
<a name="l00156"></a>00156 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;channel&quot;</span>)) {
<a name="l00157"></a>00157                <span class="keywordflow">if</span> ((c2 = strchr(c, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l00158"></a>00158                   *c2 = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00159"></a>00159                   c2++;
<a name="l00160"></a>00160                   <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, tech, c);
<a name="l00161"></a>00161                   <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, dest, c2);
<a name="l00162"></a>00162                } <span class="keywordflow">else</span> {
<a name="l00163"></a>00163                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Channel should be in form Tech/Dest at line %d of %s\n&quot;</span>, lineno, fn);
<a name="l00164"></a>00164                }
<a name="l00165"></a>00165             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;callerid&quot;</span>)) {
<a name="l00166"></a>00166                <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>[80] = {0}, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>[80] = {0};
<a name="l00167"></a>00167                <a class="code" href="callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(c, cid_name, <span class="keyword">sizeof</span>(cid_name), <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="keyword">sizeof</span>(<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>));
<a name="l00168"></a>00168                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);
<a name="l00169"></a>00169                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, cid_name, cid_name);
<a name="l00170"></a>00170             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;application&quot;</span>)) {
<a name="l00171"></a>00171                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, <a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>, c);
<a name="l00172"></a>00172             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;data&quot;</span>)) {
<a name="l00173"></a>00173                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, data, c);
<a name="l00174"></a>00174             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;maxretries&quot;</span>)) {
<a name="l00175"></a>00175                <span class="keywordflow">if</span> (sscanf(c, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;o-&gt;<a class="code" href="structoutgoing.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a>) != 1) {
<a name="l00176"></a>00176                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max retries at line %d of %s\n&quot;</span>, lineno, fn);
<a name="l00177"></a>00177                   o-&gt;<a class="code" href="structoutgoing.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a> = 0;
<a name="l00178"></a>00178                }
<a name="l00179"></a>00179             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;codecs&quot;</span>)) {
<a name="l00180"></a>00180                <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(NULL, &amp;o-&gt;<a class="code" href="structoutgoing.html#a317afff57d87a89158c2b038d37b2b08">format</a>, c, 1);
<a name="l00181"></a>00181             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l00182"></a>00182                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c);
<a name="l00183"></a>00183             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;extension&quot;</span>)) {
<a name="l00184"></a>00184                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, c);
<a name="l00185"></a>00185             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;priority&quot;</span>)) {
<a name="l00186"></a>00186                <span class="keywordflow">if</span> ((sscanf(c, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;o-&gt;<a class="code" href="structoutgoing.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) != 1) || (o-&gt;<a class="code" href="structoutgoing.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> &lt; 1)) {
<a name="l00187"></a>00187                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid priority at line %d of %s\n&quot;</span>, lineno, fn);
<a name="l00188"></a>00188                   o-&gt;<a class="code" href="structoutgoing.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 1;
<a name="l00189"></a>00189                }
<a name="l00190"></a>00190             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;retrytime&quot;</span>)) {
<a name="l00191"></a>00191                <span class="keywordflow">if</span> ((sscanf(c, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;o-&gt;<a class="code" href="structoutgoing.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a>) != 1) || (o-&gt;<a class="code" href="structoutgoing.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> &lt; 1)) {
<a name="l00192"></a>00192                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid retrytime at line %d of %s\n&quot;</span>, lineno, fn);
<a name="l00193"></a>00193                   o-&gt;<a class="code" href="structoutgoing.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = 300;
<a name="l00194"></a>00194                }
<a name="l00195"></a>00195             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;waittime&quot;</span>)) {
<a name="l00196"></a>00196                <span class="keywordflow">if</span> ((sscanf(c, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;o-&gt;<a class="code" href="structoutgoing.html#a6044abdba0f2d5658d4d8ecf083060cf">waittime</a>) != 1) || (o-&gt;<a class="code" href="structoutgoing.html#a6044abdba0f2d5658d4d8ecf083060cf">waittime</a> &lt; 1)) {
<a name="l00197"></a>00197                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid waittime at line %d of %s\n&quot;</span>, lineno, fn);
<a name="l00198"></a>00198                   o-&gt;<a class="code" href="structoutgoing.html#a6044abdba0f2d5658d4d8ecf083060cf">waittime</a> = 45;
<a name="l00199"></a>00199                }
<a name="l00200"></a>00200             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;retry&quot;</span>)) {
<a name="l00201"></a>00201                o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>++;
<a name="l00202"></a>00202             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;startretry&quot;</span>)) {
<a name="l00203"></a>00203                <span class="keywordflow">if</span> (sscanf(c, <span class="stringliteral">&quot;%30ld&quot;</span>, &amp;o-&gt;<a class="code" href="structoutgoing.html#a9b1da606e4cbafee7516346240cfe6fe">callingpid</a>) != 1) {
<a name="l00204"></a>00204                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to retrieve calling PID!\n&quot;</span>);
<a name="l00205"></a>00205                   o-&gt;<a class="code" href="structoutgoing.html#a9b1da606e4cbafee7516346240cfe6fe">callingpid</a> = 0;
<a name="l00206"></a>00206                }
<a name="l00207"></a>00207             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;endretry&quot;</span>) || !strcasecmp(buf, <span class="stringliteral">&quot;abortretry&quot;</span>)) {
<a name="l00208"></a>00208                o-&gt;<a class="code" href="structoutgoing.html#a9b1da606e4cbafee7516346240cfe6fe">callingpid</a> = 0;
<a name="l00209"></a>00209                o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>++;
<a name="l00210"></a>00210             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;delayedretry&quot;</span>)) {
<a name="l00211"></a>00211             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;setvar&quot;</span>) || !strcasecmp(buf, <span class="stringliteral">&quot;set&quot;</span>)) {
<a name="l00212"></a>00212                c2 = c;
<a name="l00213"></a>00213                <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;c2, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l00214"></a>00214                <span class="keywordflow">if</span> (c2) {
<a name="l00215"></a>00215                   var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(c, c2, fn);
<a name="l00216"></a>00216                   <span class="keywordflow">if</span> (var) {
<a name="l00217"></a>00217                      <span class="comment">/* Always insert at the end, because some people want to treat the spool file as a script */</span>
<a name="l00218"></a>00218                      <span class="keywordflow">if</span> (last) {
<a name="l00219"></a>00219                         last-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a> = var;
<a name="l00220"></a>00220                      } <span class="keywordflow">else</span> {
<a name="l00221"></a>00221                         o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = var;
<a name="l00222"></a>00222                      }
<a name="l00223"></a>00223                      last = var;
<a name="l00224"></a>00224                   }
<a name="l00225"></a>00225                } <span class="keywordflow">else</span>
<a name="l00226"></a>00226                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Malformed \&quot;%s\&quot; argument.  Should be \&quot;%s: variable=value\&quot;\n&quot;</span>, buf, buf);
<a name="l00227"></a>00227             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;account&quot;</span>)) {
<a name="l00228"></a>00228                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, account, c);
<a name="l00229"></a>00229             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;alwaysdelete&quot;</span>)) {
<a name="l00230"></a>00230                <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;o-&gt;<a class="code" href="structoutgoing.html#a5675a902ed1cbfcd7b797f0774c17120">options</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(c), <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734">SPOOL_FLAG_ALWAYS_DELETE</a>);
<a name="l00231"></a>00231             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(buf, <span class="stringliteral">&quot;archive&quot;</span>)) {
<a name="l00232"></a>00232                <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;o-&gt;<a class="code" href="structoutgoing.html#a5675a902ed1cbfcd7b797f0774c17120">options</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(c), <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a97b25e061a292ff951dcff7a39959304">SPOOL_FLAG_ARCHIVE</a>);
<a name="l00233"></a>00233             } <span class="keywordflow">else</span> {
<a name="l00234"></a>00234                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown keyword &apos;%s&apos; at line %d of %s\n&quot;</span>, buf, lineno, fn);
<a name="l00235"></a>00235             }
<a name="l00236"></a>00236          } <span class="keywordflow">else</span>
<a name="l00237"></a>00237             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Syntax error at line %d of %s\n&quot;</span>, lineno, fn);
<a name="l00238"></a>00238       }
<a name="l00239"></a>00239    }
<a name="l00240"></a>00240    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(o, fn, fn);
<a name="l00241"></a>00241    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>) || (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structoutgoing.html#a66066052ae6571f5495a4e7f8df6c0bb">app</a>) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structoutgoing.html#aaee31f4cc48985167efcd38ab252dac8">exten</a>))) {
<a name="l00242"></a>00242       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;At least one of app or extension must be specified, along with tech and dest in file %s\n&quot;</span>, fn);
<a name="l00243"></a>00243       <span class="keywordflow">return</span> -1;
<a name="l00244"></a>00244    }
<a name="l00245"></a>00245    <span class="keywordflow">return</span> 0;
<a name="l00246"></a>00246 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa7a68d0622f6db212f1f50e10268905d"></a><!-- doxytag: member="pbx_spool.c::attempt_thread" ref="aa7a68d0622f6db212f1f50e10268905d" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* attempt_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00325">325</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::account</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::app</a>, <a class="el" href="channel_8c_source.html#l03743">ast_channel_reason2str()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="pbx_8c_source.html#l08106">ast_pbx_outgoing_app()</a>, <a class="el" href="pbx_8c_source.html#l07940">ast_pbx_outgoing_exten()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::cid_name</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::cid_num</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::context</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::data</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::dest</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::exten</a>, <a class="el" href="pbx__spool_8c_source.html#l00069">outgoing::format</a>, <a class="el" href="pbx__spool_8c_source.html#l00101">free_outgoing()</a>, <a class="el" href="logger_8h_source.html#l00130">LOG_EVENT</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="pbx__spool_8c_source.html#l00065">outgoing::maxretries</a>, <a class="el" href="pbx__spool_8c_source.html#l00082">outgoing::priority</a>, <a class="el" href="pbx__spool_8c_source.html#l00276">remove_from_queue()</a>, <a class="el" href="pbx__spool_8c_source.html#l00064">outgoing::retries</a>, <a class="el" href="pbx__spool_8c_source.html#l00248">safe_append()</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::tech</a>, <a class="el" href="pbx__spool_8c_source.html#l00083">outgoing::vars</a>, and <a class="el" href="pbx__spool_8c_source.html#l00067">outgoing::waittime</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00357">launch_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00326"></a>00326 {
<a name="l00327"></a>00327    <span class="keyword">struct </span><a class="code" href="structoutgoing.html">outgoing</a> *o = <a class="code" href="structoutgoing.html#a7870f447ef3c43ebf148da15363b25dd">data</a>;
<a name="l00328"></a>00328    <span class="keywordtype">int</span> res, reason;
<a name="l00329"></a>00329    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(o-&gt;<a class="code" href="structoutgoing.html#a66066052ae6571f5495a4e7f8df6c0bb">app</a>)) {
<a name="l00330"></a>00330       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Attempting call on %s/%s for application %s(%s) (Retry %d)\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>, o-&gt;<a class="code" href="structoutgoing.html#a66066052ae6571f5495a4e7f8df6c0bb">app</a>, o-&gt;<a class="code" href="structoutgoing.html#a7870f447ef3c43ebf148da15363b25dd">data</a>, o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>);
<a name="l00331"></a>00331       res = <a class="code" href="pbx_8h.html#ade584ae5e3eafb878535626ebe79e26d">ast_pbx_outgoing_app</a>(o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#a317afff57d87a89158c2b038d37b2b08">format</a>, (<span class="keywordtype">void</span> *) o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>, o-&gt;<a class="code" href="structoutgoing.html#a6044abdba0f2d5658d4d8ecf083060cf">waittime</a> * 1000, o-&gt;<a class="code" href="structoutgoing.html#a66066052ae6571f5495a4e7f8df6c0bb">app</a>, o-&gt;<a class="code" href="structoutgoing.html#a7870f447ef3c43ebf148da15363b25dd">data</a>, &amp;reason, 2 <span class="comment">/* wait to finish */</span>, o-&gt;<a class="code" href="structoutgoing.html#a1db41d2bb5281151490fa74f8f8de95d">cid_num</a>, o-&gt;<a class="code" href="structoutgoing.html#acea391ea9b4b2ee61b5b84bce2187f12">cid_name</a>, o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>, o-&gt;<a class="code" href="structoutgoing.html#a626176754f57f4dc291e44916a5354f8">account</a>, NULL);
<a name="l00332"></a>00332       o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l00333"></a>00333    } <span class="keywordflow">else</span> {
<a name="l00334"></a>00334       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Attempting call on %s/%s for %s@%s:%d (Retry %d)\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>, o-&gt;<a class="code" href="structoutgoing.html#aaee31f4cc48985167efcd38ab252dac8">exten</a>, o-&gt;<a class="code" href="structoutgoing.html#a7faec841658b88ad0cfbc684853acad3">context</a>,o-&gt;<a class="code" href="structoutgoing.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>);
<a name="l00335"></a>00335       res = <a class="code" href="pbx_8h.html#a7705e0c38bd69f8dceb03861f7527b60">ast_pbx_outgoing_exten</a>(o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#a317afff57d87a89158c2b038d37b2b08">format</a>, (<span class="keywordtype">void</span> *) o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>, o-&gt;<a class="code" href="structoutgoing.html#a6044abdba0f2d5658d4d8ecf083060cf">waittime</a> * 1000, o-&gt;<a class="code" href="structoutgoing.html#a7faec841658b88ad0cfbc684853acad3">context</a>, o-&gt;<a class="code" href="structoutgoing.html#aaee31f4cc48985167efcd38ab252dac8">exten</a>, o-&gt;<a class="code" href="structoutgoing.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, &amp;reason, 2 <span class="comment">/* wait to finish */</span>, o-&gt;<a class="code" href="structoutgoing.html#a1db41d2bb5281151490fa74f8f8de95d">cid_num</a>, o-&gt;<a class="code" href="structoutgoing.html#acea391ea9b4b2ee61b5b84bce2187f12">cid_name</a>, o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>, o-&gt;<a class="code" href="structoutgoing.html#a626176754f57f4dc291e44916a5354f8">account</a>, NULL);
<a name="l00336"></a>00336       o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338    <span class="keywordflow">if</span> (res) {
<a name="l00339"></a>00339       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Call failed to go through, reason (%d) %s\n&quot;</span>, reason, <a class="code" href="channel_8h.html#a25ec12c3abdc7ad6d7971f4ad3737d94" title="return an english explanation of the code returned thru __ast_request_and_dial&amp;#39;s...">ast_channel_reason2str</a>(reason));
<a name="l00340"></a>00340       <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &gt;= o-&gt;<a class="code" href="structoutgoing.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a> + 1) {
<a name="l00341"></a>00341          <span class="comment">/* Max retries exceeded */</span>
<a name="l00342"></a>00342          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Queued call to %s/%s expired without completion after %d attempt%s\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>, o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> - 1, ((o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> - 1) != 1) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00343"></a>00343          <a class="code" href="pbx__spool_8c.html#af79325470445e6e4d889a461ea654873" title="Remove a call file from the outgoing queue optionally moving it in the archive dir...">remove_from_queue</a>(o, <span class="stringliteral">&quot;Expired&quot;</span>);
<a name="l00344"></a>00344       } <span class="keywordflow">else</span> {
<a name="l00345"></a>00345          <span class="comment">/* Notate that the call is still active */</span>
<a name="l00346"></a>00346          <a class="code" href="pbx__spool_8c.html#a42a40f55167da57243f6865030c9a83e">safe_append</a>(o, time(NULL), <span class="stringliteral">&quot;EndRetry&quot;</span>);
<a name="l00347"></a>00347       }
<a name="l00348"></a>00348    } <span class="keywordflow">else</span> {
<a name="l00349"></a>00349       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Call completed to %s/%s\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>);
<a name="l00350"></a>00350       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Queued call to %s/%s completed\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>);
<a name="l00351"></a>00351       <a class="code" href="pbx__spool_8c.html#af79325470445e6e4d889a461ea654873" title="Remove a call file from the outgoing queue optionally moving it in the archive dir...">remove_from_queue</a>(o, <span class="stringliteral">&quot;Completed&quot;</span>);
<a name="l00352"></a>00352    }
<a name="l00353"></a>00353    <a class="code" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a>(o);
<a name="l00354"></a>00354    <span class="keywordflow">return</span> NULL;
<a name="l00355"></a>00355 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a25da8535544761b80644470bb43e2798"></a><!-- doxytag: member="pbx_spool.c::free_outgoing" ref="a25da8535544761b80644470bb43e2798" args="(struct outgoing *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void free_outgoing </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structoutgoing.html">outgoing</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00101">101</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="stringfields_8h_source.html#l00245">ast_string_field_free_memory</a>, <a class="el" href="config_8c_source.html#l00397">ast_variables_destroy()</a>, and <a class="el" href="pbx__spool_8c_source.html#l00083">outgoing::vars</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00325">attempt_thread()</a>, <a class="el" href="pbx__spool_8c_source.html#l00357">launch_service()</a>, and <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00102"></a>00102 {
<a name="l00103"></a>00103    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l00104"></a>00104       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(o-&gt;<a class="code" href="structoutgoing.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>);
<a name="l00105"></a>00105    }
<a name="l00106"></a>00106    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(o);
<a name="l00107"></a>00107    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(o);
<a name="l00108"></a>00108 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6093aaaf74716132e72d65db5324447a"></a><!-- doxytag: member="pbx_spool.c::init_outgoing" ref="a6093aaaf74716132e72d65db5324447a" args="(struct outgoing *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int init_outgoing </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structoutgoing.html">outgoing</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00088">88</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="frame_8h_source.html#l00253">AST_FORMAT_SLINEAR</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="stringfields_8h_source.html#l00241">ast_string_field_init</a>, <a class="el" href="pbx__spool_8c_source.html#l00069">outgoing::format</a>, <a class="el" href="pbx__spool_8c_source.html#l00085">outgoing::options</a>, <a class="el" href="pbx__spool_8c_source.html#l00082">outgoing::priority</a>, <a class="el" href="pbx__spool_8c_source.html#l00066">outgoing::retrytime</a>, <a class="el" href="pbx__spool_8c_source.html#l00055">SPOOL_FLAG_ALWAYS_DELETE</a>, and <a class="el" href="pbx__spool_8c_source.html#l00067">outgoing::waittime</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00089"></a>00089 {
<a name="l00090"></a>00090    o-&gt;<a class="code" href="structoutgoing.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 1;
<a name="l00091"></a>00091    o-&gt;<a class="code" href="structoutgoing.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = 300;
<a name="l00092"></a>00092    o-&gt;<a class="code" href="structoutgoing.html#a6044abdba0f2d5658d4d8ecf083060cf">waittime</a> = 45;
<a name="l00093"></a>00093    o-&gt;<a class="code" href="structoutgoing.html#a317afff57d87a89158c2b038d37b2b08">format</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l00094"></a>00094    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;o-&gt;<a class="code" href="structoutgoing.html#a5675a902ed1cbfcd7b797f0774c17120">options</a>, <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734">SPOOL_FLAG_ALWAYS_DELETE</a>);
<a name="l00095"></a>00095    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(o, 128)) {
<a name="l00096"></a>00096       <span class="keywordflow">return</span> -1;
<a name="l00097"></a>00097    }
<a name="l00098"></a>00098    <span class="keywordflow">return</span> 0;
<a name="l00099"></a>00099 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a56de20a1d449ec5c3f5bcdebd41656f7"></a><!-- doxytag: member="pbx_spool.c::launch_service" ref="a56de20a1d449ec5c3f5bcdebd41656f7" args="(struct outgoing *o)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void launch_service </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structoutgoing.html">outgoing</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00357">357</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00380">ast_pthread_create_detached</a>, <a class="el" href="pbx__spool_8c_source.html#l00325">attempt_thread()</a>, <a class="el" href="pbx__spool_8c_source.html#l00101">free_outgoing()</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00358"></a>00358 {
<a name="l00359"></a>00359    pthread_t t;
<a name="l00360"></a>00360    <span class="keywordtype">int</span> ret;
<a name="l00361"></a>00361 
<a name="l00362"></a>00362    <span class="keywordflow">if</span> ((ret = <a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;t, NULL, <a class="code" href="pbx__spool_8c.html#aa7a68d0622f6db212f1f50e10268905d">attempt_thread</a>, o))) {
<a name="l00363"></a>00363       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create thread :( (returned error: %d)\n&quot;</span>, ret);
<a name="l00364"></a>00364       <a class="code" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a>(o);
<a name="l00365"></a>00365    }
<a name="l00366"></a>00366 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="pbx_spool.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00513">513</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00251">ast_config_AST_SPOOL_DIR</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l01765">ast_mkdir()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00065">AST_MODULE_LOAD_FAILURE</a>, <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="utils_8h_source.html#l00389">ast_pthread_create_detached_background</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx__spool_8c_source.html#l00436">scan_thread()</a>, and <a class="el" href="app__meetme_8c_source.html#l00840">thread</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00514"></a>00514 {
<a name="l00515"></a>00515    pthread_t <a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l00516"></a>00516    <span class="keywordtype">int</span> ret;
<a name="l00517"></a>00517    snprintf(<a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>, <span class="keyword">sizeof</span>(<a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>, <span class="stringliteral">&quot;outgoing&quot;</span>);
<a name="l00518"></a>00518    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(<a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>, 0777)) {
<a name="l00519"></a>00519       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create queue directory %s -- outgoing spool disabled\n&quot;</span>, <a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>);
<a name="l00520"></a>00520       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l00521"></a>00521    }
<a name="l00522"></a>00522    snprintf(<a class="code" href="pbx__spool_8c.html#a9fba478e22f3c9ba363a2ab697c72c74">qdonedir</a>, <span class="keyword">sizeof</span>(<a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>, <span class="stringliteral">&quot;outgoing_done&quot;</span>);
<a name="l00523"></a>00523 
<a name="l00524"></a>00524    <span class="keywordflow">if</span> ((ret = <a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;thread, NULL, <a class="code" href="pbx__spool_8c.html#a55635376623ac9afd203650fb458907a">scan_thread</a>, NULL))) {
<a name="l00525"></a>00525       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create thread :( (returned error: %d)\n&quot;</span>, ret);
<a name="l00526"></a>00526       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l00527"></a>00527    }
<a name="l00528"></a>00528 
<a name="l00529"></a>00529    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l00530"></a>00530 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af79325470445e6e4d889a461ea654873"></a><!-- doxytag: member="pbx_spool.c::remove_from_queue" ref="af79325470445e6e4d889a461ea654873" args="(struct outgoing *o, const char *status)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int remove_from_queue </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structoutgoing.html">outgoing</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>status</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove a call file from the <a class="el" href="structoutgoing.html">outgoing</a> queue optionally moving it in the archive dir. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>o</em>&nbsp;</td><td>the pointer to <a class="el" href="structoutgoing.html">outgoing</a> struct </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>status</em>&nbsp;</td><td>the exit status of the call. Can be "Completed", "Failed" or "Expired" </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00276">276</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l01765">ast_mkdir()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::fn</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx__spool_8c_source.html#l00085">outgoing::options</a>, <a class="el" href="pbx__spool_8c_source.html#l00055">SPOOL_FLAG_ALWAYS_DELETE</a>, and <a class="el" href="pbx__spool_8c_source.html#l00057">SPOOL_FLAG_ARCHIVE</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00325">attempt_thread()</a>, and <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00277"></a>00277 {
<a name="l00278"></a>00278    <span class="keywordtype">int</span> fd;
<a name="l00279"></a>00279    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00280"></a>00280    <span class="keywordtype">char</span> newfn[256];
<a name="l00281"></a>00281    <span class="keyword">const</span> <span class="keywordtype">char</span> *bname;
<a name="l00282"></a>00282 
<a name="l00283"></a>00283    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;o-&gt;<a class="code" href="structoutgoing.html#a5675a902ed1cbfcd7b797f0774c17120">options</a>, <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a14e84f6cdcd0ed15b748cc08a65b1734">SPOOL_FLAG_ALWAYS_DELETE</a>)) {
<a name="l00284"></a>00284       <span class="keyword">struct </span>stat current_file_status;
<a name="l00285"></a>00285 
<a name="l00286"></a>00286       <span class="keywordflow">if</span> (!stat(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, &amp;current_file_status)) {
<a name="l00287"></a>00287          <span class="keywordflow">if</span> (time(NULL) &lt; current_file_status.st_mtime)
<a name="l00288"></a>00288             <span class="keywordflow">return</span> 0;
<a name="l00289"></a>00289       }
<a name="l00290"></a>00290    }
<a name="l00291"></a>00291 
<a name="l00292"></a>00292    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;o-&gt;<a class="code" href="structoutgoing.html#a5675a902ed1cbfcd7b797f0774c17120">options</a>, <a class="code" href="pbx__spool_8c.html#a3e279efabf854742684341c3e4f50d31a97b25e061a292ff951dcff7a39959304">SPOOL_FLAG_ARCHIVE</a>)) {
<a name="l00293"></a>00293       unlink(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>);
<a name="l00294"></a>00294       <span class="keywordflow">return</span> 0;
<a name="l00295"></a>00295    }
<a name="l00296"></a>00296 
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(<a class="code" href="pbx__spool_8c.html#a9fba478e22f3c9ba363a2ab697c72c74">qdonedir</a>, 0777)) {
<a name="l00298"></a>00298       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create queue directory %s -- outgoing spool archiving disabled\n&quot;</span>, <a class="code" href="pbx__spool_8c.html#a9fba478e22f3c9ba363a2ab697c72c74">qdonedir</a>);
<a name="l00299"></a>00299       unlink(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>);
<a name="l00300"></a>00300       <span class="keywordflow">return</span> -1;
<a name="l00301"></a>00301    }
<a name="l00302"></a>00302 
<a name="l00303"></a>00303    <span class="keywordflow">if</span> ((fd = open(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, O_WRONLY | O_APPEND))) {
<a name="l00304"></a>00304       <span class="keywordflow">if</span> ((f = fdopen(fd, <span class="stringliteral">&quot;a&quot;</span>))) {
<a name="l00305"></a>00305          fprintf(f, <span class="stringliteral">&quot;Status: %s\n&quot;</span>, <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>);
<a name="l00306"></a>00306          fclose(f);
<a name="l00307"></a>00307       } <span class="keywordflow">else</span>
<a name="l00308"></a>00308          close(fd);
<a name="l00309"></a>00309    }
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">if</span> (!(bname = strrchr(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, <span class="charliteral">&apos;/&apos;</span>)))
<a name="l00312"></a>00312       bname = o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>;
<a name="l00313"></a>00313    <span class="keywordflow">else</span>
<a name="l00314"></a>00314       bname++; 
<a name="l00315"></a>00315    snprintf(newfn, <span class="keyword">sizeof</span>(newfn), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="pbx__spool_8c.html#a9fba478e22f3c9ba363a2ab697c72c74">qdonedir</a>, bname);
<a name="l00316"></a>00316    <span class="comment">/* a existing call file the archive dir is overwritten */</span>
<a name="l00317"></a>00317    unlink(newfn);
<a name="l00318"></a>00318    <span class="keywordflow">if</span> (rename(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, newfn) != 0) {
<a name="l00319"></a>00319       unlink(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>);
<a name="l00320"></a>00320       <span class="keywordflow">return</span> -1;
<a name="l00321"></a>00321    } <span class="keywordflow">else</span>
<a name="l00322"></a>00322       <span class="keywordflow">return</span> 0;
<a name="l00323"></a>00323 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a42a40f55167da57243f6865030c9a83e"></a><!-- doxytag: member="pbx_spool.c::safe_append" ref="a42a40f55167da57243f6865030c9a83e" args="(struct outgoing *o, time_t now, char *s)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void safe_append </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structoutgoing.html">outgoing</a> *&nbsp;</td>
          <td class="paramname"> <em>o</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">time_t&nbsp;</td>
          <td class="paramname"> <em>now</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>s</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00248">248</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="asterisk_8c_source.html#l00192">ast_mainpid</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::fn</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx__spool_8c_source.html#l00064">outgoing::retries</a>, and <a class="el" href="pbx__spool_8c_source.html#l00066">outgoing::retrytime</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00325">attempt_thread()</a>, and <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00249"></a>00249 {
<a name="l00250"></a>00250    <span class="keywordtype">int</span> fd;
<a name="l00251"></a>00251    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00252"></a>00252    <span class="keyword">struct </span>utimbuf tbuf;
<a name="l00253"></a>00253 
<a name="l00254"></a>00254    <span class="keywordflow">if</span> ((fd = open(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, O_WRONLY | O_APPEND)) &lt; 0)
<a name="l00255"></a>00255       <span class="keywordflow">return</span>;
<a name="l00256"></a>00256 
<a name="l00257"></a>00257    <span class="keywordflow">if</span> ((f = fdopen(fd, <span class="stringliteral">&quot;a&quot;</span>))) {
<a name="l00258"></a>00258       fprintf(f, <span class="stringliteral">&quot;\n%s: %ld %d (%ld)\n&quot;</span>, <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, (<span class="keywordtype">long</span>)<a class="code" href="options_8h.html#ae1517891417ae2f6e398e95ae79dadf1">ast_mainpid</a>, o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>, (<span class="keywordtype">long</span>) now);
<a name="l00259"></a>00259       fclose(f);
<a name="l00260"></a>00260    } <span class="keywordflow">else</span>
<a name="l00261"></a>00261       close(fd);
<a name="l00262"></a>00262 
<a name="l00263"></a>00263    <span class="comment">/* Update the file time */</span>
<a name="l00264"></a>00264    tbuf.actime = now;
<a name="l00265"></a>00265    tbuf.modtime = now + o-&gt;<a class="code" href="structoutgoing.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a>;
<a name="l00266"></a>00266    <span class="keywordflow">if</span> (utime(o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, &amp;tbuf))
<a name="l00267"></a>00267       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set utime on %s: %s\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, strerror(errno));
<a name="l00268"></a>00268 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4f8fe1c050846feea728125460a8181d"></a><!-- doxytag: member="pbx_spool.c::scan_service" ref="a4f8fe1c050846feea728125460a8181d" args="(char *fn, time_t now, time_t atime)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int scan_service </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>fn</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">time_t&nbsp;</td>
          <td class="paramname"> <em>now</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">time_t&nbsp;</td>
          <td class="paramname"> <em>atime</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00368">368</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="pbx__spool_8c_source.html#l00110">apply_outgoing()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="asterisk_8c_source.html#l00192">ast_mainpid</a>, <a class="el" href="pbx__spool_8c_source.html#l00068">outgoing::callingpid</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::dest</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::fn</a>, <a class="el" href="pbx__spool_8c_source.html#l00101">free_outgoing()</a>, <a class="el" href="pbx__spool_8c_source.html#l00088">init_outgoing()</a>, <a class="el" href="pbx__spool_8c_source.html#l00357">launch_service()</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00130">LOG_EVENT</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx__spool_8c_source.html#l00065">outgoing::maxretries</a>, <a class="el" href="pbx__spool_8c_source.html#l00276">remove_from_queue()</a>, <a class="el" href="pbx__spool_8c_source.html#l00064">outgoing::retries</a>, <a class="el" href="pbx__spool_8c_source.html#l00066">outgoing::retrytime</a>, <a class="el" href="pbx__spool_8c_source.html#l00248">safe_append()</a>, and <a class="el" href="pbx__spool_8c_source.html#l00081">outgoing::tech</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00436">scan_thread()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00369"></a>00369 {
<a name="l00370"></a>00370    <span class="keyword">struct </span><a class="code" href="structoutgoing.html">outgoing</a> *o = NULL;
<a name="l00371"></a>00371    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00372"></a>00372    <span class="keywordtype">int</span> res = 0;
<a name="l00373"></a>00373 
<a name="l00374"></a>00374    <span class="keywordflow">if</span> (!(o = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*o)))) {
<a name="l00375"></a>00375       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory ;(\n&quot;</span>);
<a name="l00376"></a>00376       <span class="keywordflow">return</span> -1;
<a name="l00377"></a>00377    }
<a name="l00378"></a>00378    
<a name="l00379"></a>00379    <span class="keywordflow">if</span> (<a class="code" href="pbx__spool_8c.html#a6093aaaf74716132e72d65db5324447a">init_outgoing</a>(o)) {
<a name="l00380"></a>00380       <span class="comment">/* No need to call free_outgoing here since we know the failure</span>
<a name="l00381"></a>00381 <span class="comment">       * was to allocate string fields and no variables have been allocated</span>
<a name="l00382"></a>00382 <span class="comment">       * yet.</span>
<a name="l00383"></a>00383 <span class="comment">       */</span>
<a name="l00384"></a>00384       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(o);
<a name="l00385"></a>00385       <span class="keywordflow">return</span> -1;
<a name="l00386"></a>00386    }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388    <span class="comment">/* Attempt to open the file */</span>
<a name="l00389"></a>00389    <span class="keywordflow">if</span> (!(f = fopen(<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, <span class="stringliteral">&quot;r+&quot;</span>))) {
<a name="l00390"></a>00390       <a class="code" href="pbx__spool_8c.html#af79325470445e6e4d889a461ea654873" title="Remove a call file from the outgoing queue optionally moving it in the archive dir...">remove_from_queue</a>(o, <span class="stringliteral">&quot;Failed&quot;</span>);
<a name="l00391"></a>00391       <a class="code" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a>(o);
<a name="l00392"></a>00392       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s: %s, deleting\n&quot;</span>, <a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, strerror(errno));
<a name="l00393"></a>00393       <span class="keywordflow">return</span> -1;
<a name="l00394"></a>00394    }
<a name="l00395"></a>00395 
<a name="l00396"></a>00396    <span class="comment">/* Read in and verify the contents */</span>
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (<a class="code" href="pbx__spool_8c.html#a01075546e5467d308ddeb14169bc1311">apply_outgoing</a>(o, <a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, f)) {
<a name="l00398"></a>00398       <a class="code" href="pbx__spool_8c.html#af79325470445e6e4d889a461ea654873" title="Remove a call file from the outgoing queue optionally moving it in the archive dir...">remove_from_queue</a>(o, <span class="stringliteral">&quot;Failed&quot;</span>);
<a name="l00399"></a>00399       <a class="code" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a>(o);
<a name="l00400"></a>00400       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid file contents in %s, deleting\n&quot;</span>, <a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>);
<a name="l00401"></a>00401       fclose(f);
<a name="l00402"></a>00402       <span class="keywordflow">return</span> -1;
<a name="l00403"></a>00403    }
<a name="l00404"></a>00404    
<a name="l00405"></a>00405 <span class="preprocessor">#if 0</span>
<a name="l00406"></a>00406 <span class="preprocessor"></span>   printf(<span class="stringliteral">&quot;Filename: %s, Retries: %d, max: %d\n&quot;</span>, <a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>, o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>, o-&gt;<a class="code" href="structoutgoing.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a>);
<a name="l00407"></a>00407 <span class="preprocessor">#endif</span>
<a name="l00408"></a>00408 <span class="preprocessor"></span>   fclose(f);
<a name="l00409"></a>00409    <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &lt;= o-&gt;<a class="code" href="structoutgoing.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a>) {
<a name="l00410"></a>00410       now += o-&gt;<a class="code" href="structoutgoing.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a>;
<a name="l00411"></a>00411       <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structoutgoing.html#a9b1da606e4cbafee7516346240cfe6fe">callingpid</a> &amp;&amp; (o-&gt;<a class="code" href="structoutgoing.html#a9b1da606e4cbafee7516346240cfe6fe">callingpid</a> == <a class="code" href="options_8h.html#ae1517891417ae2f6e398e95ae79dadf1">ast_mainpid</a>)) {
<a name="l00412"></a>00412          <a class="code" href="pbx__spool_8c.html#a42a40f55167da57243f6865030c9a83e">safe_append</a>(o, time(NULL), <span class="stringliteral">&quot;DelayedRetry&quot;</span>);
<a name="l00413"></a>00413          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Delaying retry since we&apos;re currently running &apos;%s&apos;\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a395945c81e0dba8b61668da661d5b01a">fn</a>);
<a name="l00414"></a>00414          <a class="code" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a>(o);
<a name="l00415"></a>00415       } <span class="keywordflow">else</span> {
<a name="l00416"></a>00416          <span class="comment">/* Increment retries */</span>
<a name="l00417"></a>00417          o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>++;
<a name="l00418"></a>00418          <span class="comment">/* If someone else was calling, they&apos;re presumably gone now</span>
<a name="l00419"></a>00419 <span class="comment">            so abort their retry and continue as we were... */</span>
<a name="l00420"></a>00420          <span class="keywordflow">if</span> (o-&gt;<a class="code" href="structoutgoing.html#a9b1da606e4cbafee7516346240cfe6fe">callingpid</a>)
<a name="l00421"></a>00421             <a class="code" href="pbx__spool_8c.html#a42a40f55167da57243f6865030c9a83e">safe_append</a>(o, time(NULL), <span class="stringliteral">&quot;AbortRetry&quot;</span>);
<a name="l00422"></a>00422          
<a name="l00423"></a>00423          <a class="code" href="pbx__spool_8c.html#a42a40f55167da57243f6865030c9a83e">safe_append</a>(o, now, <span class="stringliteral">&quot;StartRetry&quot;</span>);
<a name="l00424"></a>00424          <a class="code" href="pbx__spool_8c.html#a56de20a1d449ec5c3f5bcdebd41656f7">launch_service</a>(o);
<a name="l00425"></a>00425       }
<a name="l00426"></a>00426       res = now;
<a name="l00427"></a>00427    } <span class="keywordflow">else</span> {
<a name="l00428"></a>00428       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#af7c8529df13c84f0c9d1122f36a94a41">LOG_EVENT</a>, <span class="stringliteral">&quot;Queued call to %s/%s expired without completion after %d attempt%s\n&quot;</span>, o-&gt;<a class="code" href="structoutgoing.html#a6379def8cefd9afdea29d5ed673cf8a0">tech</a>, o-&gt;<a class="code" href="structoutgoing.html#aed48c29baf79b703d3f84d791e08ac4f">dest</a>, o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> - 1, ((o-&gt;<a class="code" href="structoutgoing.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> - 1) != 1) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l00429"></a>00429       <a class="code" href="pbx__spool_8c.html#af79325470445e6e4d889a461ea654873" title="Remove a call file from the outgoing queue optionally moving it in the archive dir...">remove_from_queue</a>(o, <span class="stringliteral">&quot;Expired&quot;</span>);
<a name="l00430"></a>00430       <a class="code" href="pbx__spool_8c.html#a25da8535544761b80644470bb43e2798">free_outgoing</a>(o);
<a name="l00431"></a>00431    }
<a name="l00432"></a>00432 
<a name="l00433"></a>00433    <span class="keywordflow">return</span> res;
<a name="l00434"></a>00434 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a55635376623ac9afd203650fb458907a"></a><!-- doxytag: member="pbx_spool.c::scan_thread" ref="a55635376623ac9afd203650fb458907a" args="(void *unused)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* scan_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>unused</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00436">436</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p>References <a class="el" href="options_8h_source.html#l00107">ast_fully_booted</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="adsistub_8c_source.html#l00077">dir</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="devicestate_8c_source.html#l00198">last</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, and <a class="el" href="pbx__spool_8c_source.html#l00368">scan_service()</a>.</p>

<p>Referenced by <a class="el" href="pbx__spool_8c_source.html#l00513">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00437"></a>00437 {
<a name="l00438"></a>00438    <span class="keyword">struct </span>stat st;
<a name="l00439"></a>00439    DIR *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>;
<a name="l00440"></a>00440    <span class="keyword">struct </span>dirent *de;
<a name="l00441"></a>00441    <span class="keywordtype">char</span> fn[256];
<a name="l00442"></a>00442    <span class="keywordtype">int</span> res;
<a name="l00443"></a>00443    time_t <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a> = 0, next = 0, now;
<a name="l00444"></a>00444    <span class="keyword">struct </span>timespec ts = { .tv_sec = 1 };
<a name="l00445"></a>00445   
<a name="l00446"></a>00446    <span class="keywordflow">while</span> (!<a class="code" href="options_8h.html#a6da2c0ee84c135b777b761b443861f19">ast_fully_booted</a>) {
<a name="l00447"></a>00447       nanosleep(&amp;ts, NULL);
<a name="l00448"></a>00448    }
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <span class="keywordflow">for</span>(;;) {
<a name="l00451"></a>00451       <span class="comment">/* Wait a sec */</span>
<a name="l00452"></a>00452       nanosleep(&amp;ts, NULL);
<a name="l00453"></a>00453       time(&amp;now);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455       <span class="keywordflow">if</span> (stat(<a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>, &amp;st)) {
<a name="l00456"></a>00456          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stat %s\n&quot;</span>, <a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>);
<a name="l00457"></a>00457          <span class="keywordflow">continue</span>;
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459 
<a name="l00460"></a>00460       <span class="comment">/* Make sure it is time for us to execute our check */</span>
<a name="l00461"></a>00461       <span class="keywordflow">if</span> ((st.st_mtime == last) &amp;&amp; (next &amp;&amp; (next &gt; now)))
<a name="l00462"></a>00462          <span class="keywordflow">continue</span>;
<a name="l00463"></a>00463       
<a name="l00464"></a>00464 <span class="preprocessor">#if 0</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span>      printf(<span class="stringliteral">&quot;atime: %ld, mtime: %ld, ctime: %ld\n&quot;</span>, st.st_atime, st.st_mtime, st.st_ctime);
<a name="l00466"></a>00466       printf(<span class="stringliteral">&quot;Ooh, something changed / timeout\n&quot;</span>);
<a name="l00467"></a>00467 <span class="preprocessor">#endif</span>
<a name="l00468"></a>00468 <span class="preprocessor"></span>      next = 0;
<a name="l00469"></a>00469       last = st.st_mtime;
<a name="l00470"></a>00470 
<a name="l00471"></a>00471       <span class="keywordflow">if</span> (!(dir = opendir(<a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>))) {
<a name="l00472"></a>00472          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open directory %s: %s\n&quot;</span>, <a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>, strerror(errno));
<a name="l00473"></a>00473          <span class="keywordflow">continue</span>;
<a name="l00474"></a>00474       }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476       <span class="keywordflow">while</span> ((de = readdir(dir))) {
<a name="l00477"></a>00477          snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>, de-&gt;d_name);
<a name="l00478"></a>00478          <span class="keywordflow">if</span> (stat(fn, &amp;st)) {
<a name="l00479"></a>00479             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stat %s: %s\n&quot;</span>, fn, strerror(errno));
<a name="l00480"></a>00480             <span class="keywordflow">continue</span>;
<a name="l00481"></a>00481          }
<a name="l00482"></a>00482          <span class="keywordflow">if</span> (!S_ISREG(st.st_mode))
<a name="l00483"></a>00483             <span class="keywordflow">continue</span>;
<a name="l00484"></a>00484          <span class="keywordflow">if</span> (st.st_mtime &lt;= now) {
<a name="l00485"></a>00485             res = <a class="code" href="pbx__spool_8c.html#a4f8fe1c050846feea728125460a8181d">scan_service</a>(fn, now, st.st_atime);
<a name="l00486"></a>00486             <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00487"></a>00487                <span class="comment">/* Update next service time */</span>
<a name="l00488"></a>00488                <span class="keywordflow">if</span> (!next || (res &lt; next)) {
<a name="l00489"></a>00489                   next = res;
<a name="l00490"></a>00490                }
<a name="l00491"></a>00491             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res) {
<a name="l00492"></a>00492                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to scan service &apos;%s&apos;\n&quot;</span>, fn);
<a name="l00493"></a>00493             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!next) {
<a name="l00494"></a>00494                <span class="comment">/* Expired entry: must recheck on the next go-around */</span>
<a name="l00495"></a>00495                next = st.st_mtime;
<a name="l00496"></a>00496             }
<a name="l00497"></a>00497          } <span class="keywordflow">else</span> {
<a name="l00498"></a>00498             <span class="comment">/* Update &quot;next&quot; update if necessary */</span>
<a name="l00499"></a>00499             <span class="keywordflow">if</span> (!next || (st.st_mtime &lt; next))
<a name="l00500"></a>00500                next = st.st_mtime;
<a name="l00501"></a>00501          }
<a name="l00502"></a>00502       }
<a name="l00503"></a>00503       closedir(dir);
<a name="l00504"></a>00504    }
<a name="l00505"></a>00505    <span class="keywordflow">return</span> NULL;
<a name="l00506"></a>00506 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="pbx_spool.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00508">508</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00509"></a>00509 {
<a name="l00510"></a>00510    <span class="keywordflow">return</span> -1;
<a name="l00511"></a>00511 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="pbx_spool.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_DEFAULT , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Outgoing Spool Support&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00532">532</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="pbx_spool.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00532">532</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

</div>
</div>
<a class="anchor" id="a03acec5c3fd04176854f6c7104e60398"></a><!-- doxytag: member="pbx_spool.c::qdir" ref="a03acec5c3fd04176854f6c7104e60398" args="[255]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="pbx__spool_8c.html#a03acec5c3fd04176854f6c7104e60398">qdir</a>[255]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00060">60</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

</div>
</div>
<a class="anchor" id="a9fba478e22f3c9ba363a2ab697c72c74"></a><!-- doxytag: member="pbx_spool.c::qdonedir" ref="a9fba478e22f3c9ba363a2ab697c72c74" args="[255]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="pbx__spool_8c.html#a9fba478e22f3c9ba363a2ab697c72c74">qdonedir</a>[255]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__spool_8c_source.html#l00061">61</a> of file <a class="el" href="pbx__spool_8c_source.html">pbx_spool.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:22:54 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
