<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:55 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_externalivr.c File Reference</h1>
<p>External IVR application interface.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &lt;signal.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="linkedlists_8h_source.html">asterisk/linkedlists.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="tcptls_8h_source.html">asterisk/tcptls.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astobj2_8h_source.html">asterisk/astobj2.h</a>&quot;</code><br/>

<p><a href="app__externalivr_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structgen__state.html">gen_state</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structivr__localuser.html">ivr_localuser</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structplaylist__entry.html">playlist_entry</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(level, channel, <a class="el" href="chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>,...)&nbsp;&nbsp;&nbsp;ast_log(level, &quot;%s: &quot; format, channel-&gt;<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> , ## __VA_ARGS__)</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8ab2c37eabfc371d1486a4897b43d0aaf8">noanswer</a> =  (1 &lt;&lt; 0), 
<a class="el" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a96a84a93b0268cefea3c2be2d521e2c5">ignore_hangup</a> =  (1 &lt;&lt; 1), 
<a class="el" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133">run_dead</a> =  (1 &lt;&lt; 2)
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a0e20eb0c1f8fdf6ca75e70db33f47ef9">app_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a273c1137a8d1eaec9dfc0eebeba32219">AST_APP_OPTIONS</a> (app_opts,{AST_APP_OPTION('n', noanswer), AST_APP_OPTION('i', ignore_hangup), AST_APP_OPTION('d', run_dead),})</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a29c0c2d271de198a0bf3ab27296c53b1">ast_eivr_getvariable</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, char *data, char *outbuf, int outbuflen)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a7519daeb6629555c1153758951f6669b">ast_eivr_setvariable</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, char *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a8d2b832f4183623bac8598ab4e036752">AST_MODULE_INFO_STANDARD</a> (ASTERISK_GPL_KEY,&quot;External IVR Interface Application&quot;)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#adbe489a18baa75f556a07affd102820d">eivr_comm</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structivr__localuser.html">ivr_localuser</a> *u, int *eivr_events_fd, int *eivr_commands_fd, int *eivr_errors_fd, const struct <a class="el" href="structast__str.html">ast_str</a> *args, const struct <a class="el" href="structast__flags.html">ast_flags</a> flags)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a6e697466db0635dd0976dd5b228be52c">eivr_connect_socket</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *host, int port)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a6ec9982be678cb347f3904d7b991b4aa">gen_alloc</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *params)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#aebd3a053a8965d528039694927675852">gen_closestream</a> (struct <a class="el" href="structgen__state.html">gen_state</a> *<a class="el" href="structstate.html">state</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#adc63b5a111facfe63ef20d3295985acc">gen_generate</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data, int len, int samples)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#aa62b5083ffcbe41dbf88794dfa6e59c0">gen_nextfile</a> (struct <a class="el" href="structgen__state.html">gen_state</a> *<a class="el" href="structstate.html">state</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__frame.html">ast_frame</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#aa28413641f22ded44433bf8ed11f3e83">gen_readframe</a> (struct <a class="el" href="structgen__state.html">gen_state</a> *<a class="el" href="structstate.html">state</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#ab6844db64e0751c8cbc2366ccc0e1639">gen_release</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structplaylist__entry.html">playlist_entry</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#ae8e091b6f32bd28245cae3ffaae5f04b">make_entry</a> (const char *filename)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a> (FILE *handle, const char event, const char *data, const struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">app</a> = &quot;ExternalIVR&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#a39aaf66c43ce14a3febf2c17aa7738d2">descrip</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__generator.html">ast_generator</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#abe143f1bae4445e9b3798e1dec3bda60">gen</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum  { ... } &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#aac288992af388f04afb23dbfdaa9ee38">options_flags</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a> = &quot;Interfaces with an external IVR application&quot;</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>External IVR application interface. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Kevin P. Fleming &lt;<a href="mailto:kpfleming@digium.com">kpfleming@digium.com</a>&gt;</dd></dl>
<dl class="note"><dt><b>Note:</b></dt><dd>Portions taken from the file-based music-on-hold work created by Anthony Minessale II in <a class="el" href="res__musiconhold_8c.html" title="Routines implementing music on hold.">res_musiconhold.c</a> </dd></dl>

<p>Definition in file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a627bf656df8f3e58bd42e51b51fbb4d5"></a><!-- doxytag: member="app_externalivr.c::ast_chan_log" ref="a627bf656df8f3e58bd42e51b51fbb4d5" args="(level, channel, format,...)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define ast_chan_log</td>
          <td>(</td>
          <td class="paramtype">level, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">channel, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"> <em>...</em>&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td>&nbsp;&nbsp;&nbsp;ast_log(level, &quot;%s: &quot; format, channel-&gt;<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> , ## __VA_ARGS__)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00072">72</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00314">app_exec()</a>, <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>, <a class="el" href="app__externalivr_8c_source.html#l00219">gen_generate()</a>, and <a class="el" href="app__externalivr_8c_source.html#l00161">gen_nextfile()</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="ac36f475ca5b446f4fde4c9b90bec77c8"></a><!-- doxytag: member="app_externalivr.c::@12" ref="ac36f475ca5b446f4fde4c9b90bec77c8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="ac36f475ca5b446f4fde4c9b90bec77c8ab2c37eabfc371d1486a4897b43d0aaf8"></a><!-- doxytag: member="noanswer" ref="ac36f475ca5b446f4fde4c9b90bec77c8ab2c37eabfc371d1486a4897b43d0aaf8" args="" -->noanswer</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ac36f475ca5b446f4fde4c9b90bec77c8a96a84a93b0268cefea3c2be2d521e2c5"></a><!-- doxytag: member="ignore_hangup" ref="ac36f475ca5b446f4fde4c9b90bec77c8a96a84a93b0268cefea3c2be2d521e2c5" args="" -->ignore_hangup</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133"></a><!-- doxytag: member="run_dead" ref="ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133" args="" -->run_dead</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00074">74</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00074"></a>00074      {
<a name="l00075"></a>00075    <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8ab2c37eabfc371d1486a4897b43d0aaf8">noanswer</a> = (1 &lt;&lt; 0),
<a name="l00076"></a>00076    <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a96a84a93b0268cefea3c2be2d521e2c5">ignore_hangup</a> = (1 &lt;&lt; 1),
<a name="l00077"></a>00077    <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133">run_dead</a> = (1 &lt;&lt; 2),
<a name="l00078"></a>00078 } <a class="code" href="app__externalivr_8c.html#aac288992af388f04afb23dbfdaa9ee38">options_flags</a>;
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a0e20eb0c1f8fdf6ca75e70db33f47ef9"></a><!-- doxytag: member="app_externalivr.c::app_exec" ref="a0e20eb0c1f8fdf6ca75e70db33f47ef9" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int app_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00314">314</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="tcptls_8h_source.html#l00121">ast_tcptls_session_args::accept_fd</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="channel_8c_source.html#l02001">ast_activate_generator()</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8c_source.html#l01776">ast_app_parse_options()</a>, <a class="el" href="app__externalivr_8c_source.html#l00072">ast_chan_log</a>, <a class="el" href="app_8c_source.html#l01982">ast_close_fds_above_n()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="channel_8c_source.html#l01956">ast_deactivate_generator()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="utils_8c_source.html#l00182">ast_gethostbyname()</a>, <a class="el" href="linkedlists_8h_source.html#l00233">AST_LIST_HEAD_INIT_VALUE</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="options_8h_source.html#l00102">ast_opt_high_priority</a>, <a class="el" href="app_8c_source.html#l02004">ast_safe_fork()</a>, <a class="el" href="asterisk_8c_source.html#l01504">ast_set_priority()</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>, <a class="el" href="strings_8h_source.html#l00431">ast_str_reset()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="tcptls_8c_source.html#l00376">ast_tcptls_client_create()</a>, <a class="el" href="tcptls_8c_source.html#l00339">ast_tcptls_client_start()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="app__externalivr_8c_source.html#l00092">ivr_localuser::chan</a>, <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="tcptls_8h_source.html#l00135">ast_tcptls_session_instance::fd</a>, <a class="el" href="app__externalivr_8c_source.html#l00243">gen</a>, <a class="el" href="logger_8c_source.html#l00112">hostname</a>, <a class="el" href="utils_8h_source.html#l00209">ast_hostent::hp</a>, <a class="el" href="app__externalivr_8c_source.html#l00076">ignore_hangup</a>, <a class="el" href="tcptls_8h_source.html#l00116">ast_tcptls_session_args::local_address</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__externalivr_8c_source.html#l00075">noanswer</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="app__externalivr_8c_source.html#l00077">run_dead</a>, and <a class="el" href="aesopt_8h_source.html#l00399">s</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00803">load_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00315"></a>00315 {
<a name="l00316"></a>00316    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = { 0, };
<a name="l00317"></a>00317    <span class="keywordtype">char</span> *opts[0];
<a name="l00318"></a>00318    <span class="keyword">struct </span><a class="code" href="structplaylist__entry.html">playlist_entry</a> *entry;
<a name="l00319"></a>00319    <span class="keywordtype">int</span> child_stdin[2] = { -1, -1 };
<a name="l00320"></a>00320    <span class="keywordtype">int</span> child_stdout[2] = { -1, -1 };
<a name="l00321"></a>00321    <span class="keywordtype">int</span> child_stderr[2] = { -1, -1 };
<a name="l00322"></a>00322    <span class="keywordtype">int</span> res = -1;
<a name="l00323"></a>00323    <span class="keywordtype">int</span> pid;
<a name="l00324"></a>00324 
<a name="l00325"></a>00325    <span class="keywordtype">char</span> <a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>[1024];
<a name="l00326"></a>00326    <span class="keywordtype">char</span> *port_str = NULL;
<a name="l00327"></a>00327    <span class="keywordtype">int</span> port = 0;
<a name="l00328"></a>00328    <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__instance.html">ast_tcptls_session_instance</a> *ser = NULL;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330    <span class="keyword">struct </span><a class="code" href="structivr__localuser.html">ivr_localuser</a> foo = {
<a name="l00331"></a>00331       .playlist = <a class="code" href="linkedlists_8h.html#a312e85d30d91d1db3ad0573c37c3f0cf" title="Defines initial values for a declaration of AST_LIST_HEAD.">AST_LIST_HEAD_INIT_VALUE</a>,
<a name="l00332"></a>00332       .finishlist = <a class="code" href="linkedlists_8h.html#a312e85d30d91d1db3ad0573c37c3f0cf" title="Defines initial values for a declaration of AST_LIST_HEAD.">AST_LIST_HEAD_INIT_VALUE</a>,
<a name="l00333"></a>00333       .gen_active = 0,
<a name="l00334"></a>00334    };
<a name="l00335"></a>00335    <span class="keyword">struct </span><a class="code" href="structivr__localuser.html">ivr_localuser</a> *u = &amp;foo;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00338"></a>00338    <span class="keywordtype">int</span> j;
<a name="l00339"></a>00339    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, **app_args, *e; 
<a name="l00340"></a>00340    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *pipe_delim_args = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(100);
<a name="l00341"></a>00341 
<a name="l00342"></a>00342    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(eivr_args,
<a name="l00343"></a>00343       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(cmd)[32];
<a name="l00344"></a>00344    );
<a name="l00345"></a>00345    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(application_args,
<a name="l00346"></a>00346       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(cmd)[32];
<a name="l00347"></a>00347    );
<a name="l00348"></a>00348 
<a name="l00349"></a>00349    u-&gt;abort_current_sound = 0;
<a name="l00350"></a>00350    u-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l00351"></a>00351 
<a name="l00352"></a>00352    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l00353"></a>00353       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ExternalIVR requires a command to execute\n&quot;</span>);
<a name="l00354"></a>00354       <span class="keywordflow">return</span> -1;
<a name="l00355"></a>00355    }
<a name="l00356"></a>00356 
<a name="l00357"></a>00357    buf = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00358"></a>00358    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(eivr_args, buf);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360    <span class="keywordflow">if</span> ((s = strchr(eivr_args.cmd[0], <span class="charliteral">&apos;(&apos;</span>))) {
<a name="l00361"></a>00361       s[0] = <span class="charliteral">&apos;,&apos;</span>;
<a name="l00362"></a>00362       <span class="keywordflow">if</span> (( e = strrchr(s, <span class="charliteral">&apos;)&apos;</span>)) ) {
<a name="l00363"></a>00363          *e = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00364"></a>00364       } <span class="keywordflow">else</span> {
<a name="l00365"></a>00365          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Parse error, no closing paren?\n&quot;</span>);
<a name="l00366"></a>00366       }
<a name="l00367"></a>00367       <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(application_args, eivr_args.cmd[0]);
<a name="l00368"></a>00368       app_args = application_args.argv;
<a name="l00369"></a>00369 
<a name="l00370"></a>00370       <span class="comment">/* Put the application + the arguments in a | delimited list */</span>
<a name="l00371"></a>00371       <a class="code" href="strings_8h.html#a7820deea616cbb2e28f16d518de91c80" title="Reset the content of a dynamic string. Useful before a series of ast_str_append.">ast_str_reset</a>(pipe_delim_args);
<a name="l00372"></a>00372       <span class="keywordflow">for</span> (j = 0; application_args.cmd[j] != NULL; j++) {
<a name="l00373"></a>00373          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;pipe_delim_args, 0, <span class="stringliteral">&quot;%s%s&quot;</span>, j == 0 ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>, application_args.cmd[j]);
<a name="l00374"></a>00374       }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376       <span class="comment">/* Parse the ExternalIVR() arguments */</span>
<a name="l00377"></a>00377       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00378"></a>00378          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Parsing options from: [%s]\n&quot;</span>, eivr_args.cmd[1]);
<a name="l00379"></a>00379       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(app_opts, &amp;flags, opts, eivr_args.cmd[1]);
<a name="l00380"></a>00380       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l00381"></a>00381          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8ab2c37eabfc371d1486a4897b43d0aaf8">noanswer</a>))
<a name="l00382"></a>00382             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;noanswer is set\n&quot;</span>);
<a name="l00383"></a>00383          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a96a84a93b0268cefea3c2be2d521e2c5">ignore_hangup</a>))
<a name="l00384"></a>00384             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ignore_hangup is set\n&quot;</span>);
<a name="l00385"></a>00385          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133">run_dead</a>))
<a name="l00386"></a>00386             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;run_dead is set\n&quot;</span>);
<a name="l00387"></a>00387       }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    } <span class="keywordflow">else</span> {
<a name="l00390"></a>00390       app_args = eivr_args.argv;
<a name="l00391"></a>00391       <span class="keywordflow">for</span> (j = 0; eivr_args.cmd[j] != NULL; j++) {
<a name="l00392"></a>00392          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;pipe_delim_args, 0, <span class="stringliteral">&quot;%s%s&quot;</span>, j == 0 ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;|&quot;</span>, eivr_args.cmd[j]);
<a name="l00393"></a>00393       }
<a name="l00394"></a>00394    }
<a name="l00395"></a>00395    
<a name="l00396"></a>00396    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l00397"></a>00397       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ExternalIVR requires a command to execute\n&quot;</span>);
<a name="l00398"></a>00398       <span class="keywordflow">return</span> -1;
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400 
<a name="l00401"></a>00401    <span class="keywordflow">if</span> (!(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8ab2c37eabfc371d1486a4897b43d0aaf8">noanswer</a>))) {
<a name="l00402"></a>00402       <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Answering channel and starting generator\n&quot;</span>);
<a name="l00403"></a>00403       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00404"></a>00404          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133">run_dead</a>)) {
<a name="l00405"></a>00405             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Running ExternalIVR with &apos;d&apos;ead flag on non-hungup channel isn&apos;t supported\n&quot;</span>);
<a name="l00406"></a>00406             <span class="keywordflow">goto</span> exit;
<a name="l00407"></a>00407          }
<a name="l00408"></a>00408          <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l00409"></a>00409       }
<a name="l00410"></a>00410       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;<a class="code" href="app__externalivr_8c.html#abe143f1bae4445e9b3798e1dec3bda60">gen</a>, u) &lt; 0) {
<a name="l00411"></a>00411          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Failed to activate generator\n&quot;</span>);
<a name="l00412"></a>00412          <span class="keywordflow">goto</span> exit;
<a name="l00413"></a>00413       } <span class="keywordflow">else</span> {
<a name="l00414"></a>00414          u-&gt;gen_active = 1;
<a name="l00415"></a>00415       }
<a name="l00416"></a>00416    }
<a name="l00417"></a>00417 
<a name="l00418"></a>00418    <span class="keywordflow">if</span> (!strncmp(app_args[0], <span class="stringliteral">&quot;ivr://&quot;</span>, 6)) {
<a name="l00419"></a>00419       <span class="keyword">struct </span><a class="code" href="structast__tcptls__session__args.html" title="arguments for the accepting thread">ast_tcptls_session_args</a> ivr_desc = {
<a name="l00420"></a>00420          .accept_fd = -1,
<a name="l00421"></a>00421          .name = <span class="stringliteral">&quot;IVR&quot;</span>,
<a name="l00422"></a>00422       };
<a name="l00423"></a>00423       <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> <a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l00424"></a>00424 
<a name="l00425"></a>00425       <span class="comment">/*communicate through socket to server*/</span>
<a name="l00426"></a>00426       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Parsing hostname:port for socket connect from \&quot;%s\&quot;\n&quot;</span>, app_args[0]);
<a name="l00427"></a>00427       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(hostname, app_args[0] + 6, <span class="keyword">sizeof</span>(hostname));
<a name="l00428"></a>00428       <span class="keywordflow">if</span> ((port_str = strchr(hostname, <span class="charliteral">&apos;:&apos;</span>)) != NULL) {
<a name="l00429"></a>00429          port_str[0] = 0;
<a name="l00430"></a>00430          port_str += 1;
<a name="l00431"></a>00431          port = atoi(port_str);
<a name="l00432"></a>00432       }
<a name="l00433"></a>00433       <span class="keywordflow">if</span> (!port) {
<a name="l00434"></a>00434          port = 2949;  <span class="comment">/* default port, if one is not provided */</span>
<a name="l00435"></a>00435       }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437       <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(hostname, &amp;<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>);
<a name="l00438"></a>00438       ivr_desc.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_family = AF_INET;
<a name="l00439"></a>00439       ivr_desc.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_port = htons(port);
<a name="l00440"></a>00440       memcpy(&amp;ivr_desc.<a class="code" href="structast__tcptls__session__args.html#a38212d367966159801236cfb1b78b1b1">local_address</a>.sin_addr.s_addr, <a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>.hp.h_addr, <a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>.hp.h_length);
<a name="l00441"></a>00441       <span class="keywordflow">if</span> (!(ser = <a class="code" href="tcptls_8h.html#a9bf6d5b9eb8b646983d127c2b1ac1822">ast_tcptls_client_create</a>(&amp;ivr_desc)) || !(ser = <a class="code" href="tcptls_8h.html#afbdc75838c2b7c41b7cb4a7740f49851" title="attempts to connect and start tcptls session, on error the tcptls_session&amp;#39;s ref...">ast_tcptls_client_start</a>(ser))) {
<a name="l00442"></a>00442          <span class="keywordflow">goto</span> exit;
<a name="l00443"></a>00443       }
<a name="l00444"></a>00444       res = <a class="code" href="app__externalivr_8c.html#adbe489a18baa75f556a07affd102820d">eivr_comm</a>(chan, u, &amp;ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;ser-&gt;<a class="code" href="structast__tcptls__session__instance.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, NULL, pipe_delim_args, flags);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446    } <span class="keywordflow">else</span> {
<a name="l00447"></a>00447       <span class="keywordflow">if</span> (pipe(child_stdin)) {
<a name="l00448"></a>00448          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Could not create pipe for child input: %s\n&quot;</span>, strerror(errno));
<a name="l00449"></a>00449          <span class="keywordflow">goto</span> exit;
<a name="l00450"></a>00450       }
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (pipe(child_stdout)) {
<a name="l00452"></a>00452          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Could not create pipe for child output: %s\n&quot;</span>, strerror(errno));
<a name="l00453"></a>00453          <span class="keywordflow">goto</span> exit;
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455       <span class="keywordflow">if</span> (pipe(child_stderr)) {
<a name="l00456"></a>00456          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Could not create pipe for child errors: %s\n&quot;</span>, strerror(errno));
<a name="l00457"></a>00457          <span class="keywordflow">goto</span> exit;
<a name="l00458"></a>00458       }
<a name="l00459"></a>00459    
<a name="l00460"></a>00460       pid = <a class="code" href="app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0" title="Common routine to safely fork without a chance of a signal handler firing badly in...">ast_safe_fork</a>(0);
<a name="l00461"></a>00461       <span class="keywordflow">if</span> (pid &lt; 0) {
<a name="l00462"></a>00462          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to fork(): %s\n&quot;</span>, strerror(errno));
<a name="l00463"></a>00463          <span class="keywordflow">goto</span> exit;
<a name="l00464"></a>00464       }
<a name="l00465"></a>00465    
<a name="l00466"></a>00466       <span class="keywordflow">if</span> (!pid) {
<a name="l00467"></a>00467          <span class="comment">/* child process */</span>
<a name="l00468"></a>00468          <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#a8445b47cb18dde73b1b233358a25ed68">ast_opt_high_priority</a>)
<a name="l00469"></a>00469             <a class="code" href="asterisk_8h.html#ad649acedd512a45c748a440e78a281c9" title="We set ourselves to a high priority, that we might pre-empt everything else. If your...">ast_set_priority</a>(0);
<a name="l00470"></a>00470    
<a name="l00471"></a>00471          dup2(child_stdin[0], STDIN_FILENO);
<a name="l00472"></a>00472          dup2(child_stdout[1], STDOUT_FILENO);
<a name="l00473"></a>00473          dup2(child_stderr[1], STDERR_FILENO);
<a name="l00474"></a>00474          <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(STDERR_FILENO);
<a name="l00475"></a>00475          execv(app_args[0], app_args);
<a name="l00476"></a>00476          fprintf(stderr, <span class="stringliteral">&quot;Failed to execute &apos;%s&apos;: %s\n&quot;</span>, app_args[0], strerror(errno));
<a name="l00477"></a>00477          _exit(1);
<a name="l00478"></a>00478       } <span class="keywordflow">else</span> {
<a name="l00479"></a>00479          <span class="comment">/* parent process */</span>
<a name="l00480"></a>00480          close(child_stdin[0]);
<a name="l00481"></a>00481          child_stdin[0] = -1;
<a name="l00482"></a>00482          close(child_stdout[1]);
<a name="l00483"></a>00483          child_stdout[1] = -1;
<a name="l00484"></a>00484          close(child_stderr[1]);
<a name="l00485"></a>00485          child_stderr[1] = -1;
<a name="l00486"></a>00486          res = <a class="code" href="app__externalivr_8c.html#adbe489a18baa75f556a07affd102820d">eivr_comm</a>(chan, u, &amp;child_stdin[1], &amp;child_stdout[0], &amp;child_stderr[0], pipe_delim_args, flags);
<a name="l00487"></a>00487       }
<a name="l00488"></a>00488    }
<a name="l00489"></a>00489 
<a name="l00490"></a>00490    exit:
<a name="l00491"></a>00491    <span class="keywordflow">if</span> (u-&gt;gen_active) {
<a name="l00492"></a>00492       <a class="code" href="channel_8h.html#a7160355005776732fba88cc020f4a45b">ast_deactivate_generator</a>(chan);
<a name="l00493"></a>00493    }
<a name="l00494"></a>00494    <span class="keywordflow">if</span> (child_stdin[0] &gt; -1) {
<a name="l00495"></a>00495       close(child_stdin[0]);
<a name="l00496"></a>00496    }
<a name="l00497"></a>00497    <span class="keywordflow">if</span> (child_stdin[1] &gt; -1) {
<a name="l00498"></a>00498       close(child_stdin[1]);
<a name="l00499"></a>00499    }
<a name="l00500"></a>00500    <span class="keywordflow">if</span> (child_stdout[0] &gt; -1) {
<a name="l00501"></a>00501       close(child_stdout[0]);
<a name="l00502"></a>00502    }
<a name="l00503"></a>00503    <span class="keywordflow">if</span> (child_stdout[1] &gt; -1) {
<a name="l00504"></a>00504       close(child_stdout[1]);
<a name="l00505"></a>00505    }
<a name="l00506"></a>00506    <span class="keywordflow">if</span> (child_stderr[0] &gt; -1) {
<a name="l00507"></a>00507       close(child_stderr[0]);
<a name="l00508"></a>00508    }
<a name="l00509"></a>00509    <span class="keywordflow">if</span> (child_stderr[1] &gt; -1) {
<a name="l00510"></a>00510       close(child_stderr[1]);
<a name="l00511"></a>00511    }
<a name="l00512"></a>00512    <span class="keywordflow">if</span> (ser) {
<a name="l00513"></a>00513       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(ser, -1);
<a name="l00514"></a>00514    }
<a name="l00515"></a>00515    <span class="keywordflow">while</span> ((entry = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;u-&gt;playlist, list))) {
<a name="l00516"></a>00516       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(entry);
<a name="l00517"></a>00517    }
<a name="l00518"></a>00518    <span class="keywordflow">return</span> res;
<a name="l00519"></a>00519 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a273c1137a8d1eaec9dfc0eebeba32219"></a><!-- doxytag: member="app_externalivr.c::AST_APP_OPTIONS" ref="a273c1137a8d1eaec9dfc0eebeba32219" args="(app_opts,{AST_APP_OPTION('n', noanswer), AST_APP_OPTION('i', ignore_hangup), AST_APP_OPTION('d', run_dead),})" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AST_APP_OPTIONS </td>
          <td>(</td>
          <td class="paramtype">app_opts&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a29c0c2d271de198a0bf3ab27296c53b1"></a><!-- doxytag: member="app_externalivr.c::ast_eivr_getvariable" ref="a29c0c2d271de198a0bf3ab27296c53b1" args="(struct ast_channel *chan, char *data, char *outbuf, int outbuflen)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_eivr_getvariable </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>outbuf</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>outbuflen</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00250">250</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="strings_8h_source.html#l00576">ast_str_alloca</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="app__voicemail_8c_source.html#l03855">inbuf()</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00251"></a>00251 {
<a name="l00252"></a>00252    <span class="comment">/* original input data: &quot;G,var1,var2,&quot; */</span>
<a name="l00253"></a>00253    <span class="comment">/* data passed as &quot;data&quot;:  &quot;var1,var2&quot; */</span>
<a name="l00254"></a>00254 
<a name="l00255"></a>00255    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a>, *variable;
<a name="l00256"></a>00256    <span class="keyword">const</span> <span class="keywordtype">char</span> *value;
<a name="l00257"></a>00257    <span class="keywordtype">int</span> j;
<a name="l00258"></a>00258    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *newstring = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(outbuflen); 
<a name="l00259"></a>00259 
<a name="l00260"></a>00260    outbuf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00261"></a>00261 
<a name="l00262"></a>00262    <span class="keywordflow">for</span> (j = 1, inbuf = data; ; j++) {
<a name="l00263"></a>00263       variable = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;inbuf, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00264"></a>00264       <span class="keywordflow">if</span> (variable == NULL) {
<a name="l00265"></a>00265          <span class="keywordtype">int</span> outstrlen = strlen(outbuf);
<a name="l00266"></a>00266          <span class="keywordflow">if</span> (outstrlen &amp;&amp; outbuf[outstrlen - 1] == <span class="charliteral">&apos;,&apos;</span>) {
<a name="l00267"></a>00267             outbuf[outstrlen - 1] = 0;
<a name="l00268"></a>00268          }
<a name="l00269"></a>00269          <span class="keywordflow">break</span>;
<a name="l00270"></a>00270       }
<a name="l00271"></a>00271       
<a name="l00272"></a>00272       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00273"></a>00273       <span class="keywordflow">if</span> (!(value = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, variable))) {
<a name="l00274"></a>00274          value = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00275"></a>00275       }
<a name="l00276"></a>00276 
<a name="l00277"></a>00277       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;newstring, 0, <span class="stringliteral">&quot;%s=%s,&quot;</span>, variable, value);
<a name="l00278"></a>00278       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00279"></a>00279       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(outbuf, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(newstring), outbuflen);
<a name="l00280"></a>00280    }
<a name="l00281"></a>00281 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7519daeb6629555c1153758951f6669b"></a><!-- doxytag: member="app_externalivr.c::ast_eivr_setvariable" ref="a7519daeb6629555c1153758951f6669b" args="(struct ast_channel *chan, char *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_eivr_setvariable </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00283">283</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="app__voicemail_8c_source.html#l03855">inbuf()</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00284"></a>00284 {
<a name="l00285"></a>00285    <span class="keywordtype">char</span> *value;
<a name="l00286"></a>00286 
<a name="l00287"></a>00287    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data), *variable;
<a name="l00288"></a>00288 
<a name="l00289"></a>00289    <span class="keywordflow">for</span> (variable = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;inbuf, <span class="stringliteral">&quot;,&quot;</span>); variable; variable = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;inbuf, <span class="stringliteral">&quot;,&quot;</span>)) {
<a name="l00290"></a>00290       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Setting up a variable: %s\n&quot;</span>, variable);
<a name="l00291"></a>00291       <span class="comment">/* variable contains &quot;varname=value&quot; */</span>
<a name="l00292"></a>00292       value = strchr(variable, <span class="charliteral">&apos;=&apos;</span>);
<a name="l00293"></a>00293       <span class="keywordflow">if</span> (!value) {
<a name="l00294"></a>00294          value = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00295"></a>00295       } <span class="keywordflow">else</span> {
<a name="l00296"></a>00296          *value++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00297"></a>00297       }
<a name="l00298"></a>00298       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, variable, value);
<a name="l00299"></a>00299    }
<a name="l00300"></a>00300 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a8d2b832f4183623bac8598ab4e036752"></a><!-- doxytag: member="app_externalivr.c::AST_MODULE_INFO_STANDARD" ref="a8d2b832f4183623bac8598ab4e036752" args="(ASTERISK_GPL_KEY,&quot;External IVR Interface Application&quot;)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">AST_MODULE_INFO_STANDARD </td>
          <td>(</td>
          <td class="paramtype">ASTERISK_GPL_KEY&nbsp;</td>
          <td class="paramname">, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">&quot;External IVR Interface Application&quot;&nbsp;</td>
          <td class="paramname"></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="adbe489a18baa75f556a07affd102820d"></a><!-- doxytag: member="app_externalivr.c::eivr_comm" ref="adbe489a18baa75f556a07affd102820d" args="(struct ast_channel *chan, struct ivr_localuser *u, int *eivr_events_fd, int *eivr_commands_fd, int *eivr_errors_fd, const struct ast_str *args, const struct ast_flags flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int eivr_comm </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structivr__localuser.html">ivr_localuser</a> *&nbsp;</td>
          <td class="paramname"> <em>u</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>eivr_events_fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>eivr_commands_fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>eivr_errors_fd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structast__str.html">ast_str</a> *&nbsp;</td>
          <td class="paramname"> <em>args</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structast__flags.html">ast_flags</a>&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000003">Todo:</a></b></dt><dd>add deprecation debug <a class="el" href="structmessage.html">message</a> for X command here </dd></dl>
</p>

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00521">521</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l02001">ast_activate_generator()</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="app__externalivr_8c_source.html#l00072">ast_chan_log</a>, <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, <a class="el" href="frame_8h_source.html#l00298">AST_CONTROL_HANGUP</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="app__externalivr_8c_source.html#l00250">ast_eivr_getvariable()</a>, <a class="el" href="app__externalivr_8c_source.html#l00283">ast_eivr_setvariable()</a>, <a class="el" href="file_8c_source.html#l00914">ast_fileexists()</a>, <a class="el" href="channel_8h_source.html#l00529">AST_FLAG_ZOMBIE</a>, <a class="el" href="frame_8h_source.html#l00105">AST_FRAME_CONTROL</a>, <a class="el" href="frame_8h_source.html#l00124">AST_FRAME_DTMF</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="linkedlists_8h_source.html#l00449">AST_LIST_EMPTY</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="channel_8c_source.html#l03100">ast_read()</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, <a class="el" href="strings_8h_source.html#l00150">ast_strip()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="channel_8c_source.html#l02041">ast_waitfor_nandfds()</a>, <a class="el" href="app__externalivr_8c_source.html#l00092">ivr_localuser::chan</a>, <a class="el" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">ast_frame::data</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="frame_8h_source.html#l00143">ast_frame::frametype</a>, <a class="el" href="app__externalivr_8c_source.html#l00243">gen</a>, <a class="el" href="channel_8h_source.html#l00479">ast_channel::hangupcause</a>, <a class="el" href="app__externalivr_8c_source.html#l00076">ignore_hangup</a>, <a class="el" href="ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input()</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__externalivr_8c_source.html#l00302">make_entry()</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="app__externalivr_8c_source.html#l00077">run_dead</a>, <a class="el" href="app__externalivr_8c_source.html#l00115">send_eivr_event()</a>, <a class="el" href="frame_8h_source.html#l00145">ast_frame::subclass</a>, and <a class="el" href="frame_8h_source.html#l00159">ast_frame::uint32</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00314">app_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00524"></a>00524 {
<a name="l00525"></a>00525    <span class="keyword">struct </span><a class="code" href="structplaylist__entry.html">playlist_entry</a> *entry;
<a name="l00526"></a>00526    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00527"></a>00527    <span class="keywordtype">int</span> ms;
<a name="l00528"></a>00528    <span class="keywordtype">int</span> exception;
<a name="l00529"></a>00529    <span class="keywordtype">int</span> ready_fd;
<a name="l00530"></a>00530    <span class="keywordtype">int</span> waitfds[2] = { *eivr_commands_fd, (eivr_errors_fd) ? *eivr_errors_fd : -1 };
<a name="l00531"></a>00531    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *rchan;
<a name="l00532"></a>00532    <span class="keywordtype">char</span> *command;
<a name="l00533"></a>00533    <span class="keywordtype">int</span> res = -1;
<a name="l00534"></a>00534    <span class="keywordtype">int</span> test_available_fd = -1;
<a name="l00535"></a>00535    <span class="keywordtype">int</span> hangup_info_sent = 0;
<a name="l00536"></a>00536   
<a name="l00537"></a>00537    FILE *eivr_commands = NULL;
<a name="l00538"></a>00538    FILE *eivr_errors = NULL;
<a name="l00539"></a>00539    FILE *eivr_events = NULL;
<a name="l00540"></a>00540 
<a name="l00541"></a>00541    <span class="keywordflow">if</span> (!(eivr_events = fdopen(*eivr_events_fd, <span class="stringliteral">&quot;w&quot;</span>))) {
<a name="l00542"></a>00542       <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Could not open stream to send events\n&quot;</span>);
<a name="l00543"></a>00543       <span class="keywordflow">goto</span> exit;
<a name="l00544"></a>00544    }
<a name="l00545"></a>00545    <span class="keywordflow">if</span> (!(eivr_commands = fdopen(*eivr_commands_fd, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l00546"></a>00546       <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Could not open stream to receive commands\n&quot;</span>);
<a name="l00547"></a>00547       <span class="keywordflow">goto</span> exit;
<a name="l00548"></a>00548    }
<a name="l00549"></a>00549    <span class="keywordflow">if</span> (eivr_errors_fd) {  <span class="comment">/* if opening a socket connection, error stream will not be used */</span>
<a name="l00550"></a>00550       <span class="keywordflow">if</span> (!(eivr_errors = fdopen(*eivr_errors_fd, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l00551"></a>00551          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Could not open stream to receive errors\n&quot;</span>);
<a name="l00552"></a>00552          <span class="keywordflow">goto</span> exit;
<a name="l00553"></a>00553       }
<a name="l00554"></a>00554    }
<a name="l00555"></a>00555 
<a name="l00556"></a>00556    test_available_fd = open(<span class="stringliteral">&quot;/dev/null&quot;</span>, O_RDONLY);
<a name="l00557"></a>00557  
<a name="l00558"></a>00558    setvbuf(eivr_events, NULL, _IONBF, 0);
<a name="l00559"></a>00559    setvbuf(eivr_commands, NULL, _IONBF, 0);
<a name="l00560"></a>00560    <span class="keywordflow">if</span> (eivr_errors) {
<a name="l00561"></a>00561       setvbuf(eivr_errors, NULL, _IONBF, 0);
<a name="l00562"></a>00562    }
<a name="l00563"></a>00563 
<a name="l00564"></a>00564    res = 0;
<a name="l00565"></a>00565  
<a name="l00566"></a>00566    <span class="keywordflow">while</span> (1) {
<a name="l00567"></a>00567       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a26796fa52cc5857446eec8d16a4b718d">AST_FLAG_ZOMBIE</a>)) {
<a name="l00568"></a>00568          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Is a zombie\n&quot;</span>);
<a name="l00569"></a>00569          res = -1;
<a name="l00570"></a>00570          <span class="keywordflow">break</span>;
<a name="l00571"></a>00571       }
<a name="l00572"></a>00572       <span class="keywordflow">if</span> (!hangup_info_sent &amp;&amp; !(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133">run_dead</a>)) &amp;&amp; <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00573"></a>00573          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a96a84a93b0268cefea3c2be2d521e2c5">ignore_hangup</a>)) {
<a name="l00574"></a>00574             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Got check_hangup, but ignore_hangup set so sending &apos;I&apos; command\n&quot;</span>);
<a name="l00575"></a>00575             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;I&apos;</span>, <span class="stringliteral">&quot;HANGUP&quot;</span>, chan);
<a name="l00576"></a>00576             hangup_info_sent = 1;
<a name="l00577"></a>00577          } <span class="keywordflow">else</span> {
<a name="l00578"></a>00578             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Got check_hangup\n&quot;</span>);
<a name="l00579"></a>00579             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;H&apos;</span>, NULL, chan);
<a name="l00580"></a>00580             res = -1;
<a name="l00581"></a>00581             <span class="keywordflow">break</span>;
<a name="l00582"></a>00582          }
<a name="l00583"></a>00583       }
<a name="l00584"></a>00584  
<a name="l00585"></a>00585       ready_fd = 0;
<a name="l00586"></a>00586       ms = 100;
<a name="l00587"></a>00587       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = 0;
<a name="l00588"></a>00588       exception = 0;
<a name="l00589"></a>00589  
<a name="l00590"></a>00590       rchan = <a class="code" href="channel_8h.html#a5e62602ca9e229304f60ab5c2b32e13b" title="Waits for activity on a group of channels.">ast_waitfor_nandfds</a>(&amp;chan, 1, waitfds, (eivr_errors_fd) ? 2 : 1, &amp;exception, &amp;ready_fd, &amp;ms);
<a name="l00591"></a>00591  
<a name="l00592"></a>00592       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a> &amp;&amp; !<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;u-&gt;finishlist)) {
<a name="l00593"></a>00593          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;u-&gt;finishlist);
<a name="l00594"></a>00594          <span class="keywordflow">while</span> ((entry = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;u-&gt;finishlist, list))) {
<a name="l00595"></a>00595             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;F&apos;</span>, entry-&gt;filename, chan);
<a name="l00596"></a>00596             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(entry);
<a name="l00597"></a>00597          }
<a name="l00598"></a>00598          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;u-&gt;finishlist);
<a name="l00599"></a>00599       }
<a name="l00600"></a>00600  
<a name="l00601"></a>00601       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a> &amp;&amp; !(<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) &amp;&amp; rchan) {
<a name="l00602"></a>00602          <span class="comment">/* the channel has something */</span>
<a name="l00603"></a>00603          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l00604"></a>00604          <span class="keywordflow">if</span> (!f) {
<a name="l00605"></a>00605             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Returned no frame\n&quot;</span>);
<a name="l00606"></a>00606             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;H&apos;</span>, NULL, chan);
<a name="l00607"></a>00607             res = -1;
<a name="l00608"></a>00608             <span class="keywordflow">break</span>;
<a name="l00609"></a>00609          }
<a name="l00610"></a>00610          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l00611"></a>00611             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, NULL, chan);
<a name="l00612"></a>00612             <span class="keywordflow">if</span> (u-&gt;option_autoclear) {
<a name="l00613"></a>00613                <span class="keywordflow">if</span> (!u-&gt;abort_current_sound &amp;&amp; !u-&gt;playing_silence)
<a name="l00614"></a>00614                   <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;T&apos;</span>, NULL, chan);
<a name="l00615"></a>00615                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;u-&gt;playlist);
<a name="l00616"></a>00616                <span class="keywordflow">while</span> ((entry = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;u-&gt;playlist, list))) {
<a name="l00617"></a>00617                   <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;D&apos;</span>, entry-&gt;filename, chan);
<a name="l00618"></a>00618                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(entry);
<a name="l00619"></a>00619                }
<a name="l00620"></a>00620                <span class="keywordflow">if</span> (!u-&gt;playing_silence)
<a name="l00621"></a>00621                   u-&gt;abort_current_sound = 1;
<a name="l00622"></a>00622                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;u-&gt;playlist);
<a name="l00623"></a>00623             }
<a name="l00624"></a>00624          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>)) {
<a name="l00625"></a>00625             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Got AST_CONTROL_HANGUP\n&quot;</span>);
<a name="l00626"></a>00626             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;H&apos;</span>, NULL, chan);
<a name="l00627"></a>00627             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#a5ad776be1fb768f3399aafcd1b58b3a2">uint32</a>) {
<a name="l00628"></a>00628                chan-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#a5ad776be1fb768f3399aafcd1b58b3a2">uint32</a>;
<a name="l00629"></a>00629             }
<a name="l00630"></a>00630             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00631"></a>00631             res = -1;
<a name="l00632"></a>00632             <span class="keywordflow">break</span>;
<a name="l00633"></a>00633          }
<a name="l00634"></a>00634          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00635"></a>00635       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ready_fd == *eivr_commands_fd) {
<a name="l00636"></a>00636          <span class="keywordtype">char</span> <a class="code" href="ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input</a>[1024];
<a name="l00637"></a>00637  
<a name="l00638"></a>00638          <span class="keywordflow">if</span> (exception || (dup2(*eivr_commands_fd, test_available_fd) == -1) || feof(eivr_commands)) {
<a name="l00639"></a>00639             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Child process went away\n&quot;</span>);
<a name="l00640"></a>00640             res = -1;
<a name="l00641"></a>00641             <span class="keywordflow">break</span>;
<a name="l00642"></a>00642          }
<a name="l00643"></a>00643   
<a name="l00644"></a>00644          <span class="keywordflow">if</span> (!fgets(input, <span class="keyword">sizeof</span>(input), eivr_commands))
<a name="l00645"></a>00645             <span class="keywordflow">continue</span>;
<a name="l00646"></a>00646  
<a name="l00647"></a>00647          command = <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(input);
<a name="l00648"></a>00648   
<a name="l00649"></a>00649          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00650"></a>00650             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;got command &apos;%s&apos;\n&quot;</span>, input);
<a name="l00651"></a>00651   
<a name="l00652"></a>00652          <span class="keywordflow">if</span> (strlen(input) &lt; 4)
<a name="l00653"></a>00653             <span class="keywordflow">continue</span>;
<a name="l00654"></a>00654   
<a name="l00655"></a>00655          <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;P&apos;</span>) {
<a name="l00656"></a>00656             <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *tmp = (<span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *) args;
<a name="l00657"></a>00657             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;P&apos;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmp), chan);
<a name="l00658"></a>00658          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( input[0] == <span class="charliteral">&apos;T&apos;</span> ) {
<a name="l00659"></a>00659             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Answering channel if needed and starting generator\n&quot;</span>);
<a name="l00660"></a>00660             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00661"></a>00661                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__externalivr_8c.html#ac36f475ca5b446f4fde4c9b90bec77c8a0bc8be00b3e47ea4f4eefbc1e5e57133">run_dead</a>)) {
<a name="l00662"></a>00662                   <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Running ExternalIVR with &apos;d&apos;ead flag on non-hungup channel isn&apos;t supported\n&quot;</span>);
<a name="l00663"></a>00663                   <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, <span class="stringliteral">&quot;ANSWER_FAILURE&quot;</span>, chan);
<a name="l00664"></a>00664                   <span class="keywordflow">continue</span>;
<a name="l00665"></a>00665                }
<a name="l00666"></a>00666                <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l00667"></a>00667             }
<a name="l00668"></a>00668             <span class="keywordflow">if</span> (!(u-&gt;gen_active)) {
<a name="l00669"></a>00669                <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;<a class="code" href="app__externalivr_8c.html#abe143f1bae4445e9b3798e1dec3bda60">gen</a>, u) &lt; 0) {
<a name="l00670"></a>00670                   <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Failed to activate generator\n&quot;</span>);
<a name="l00671"></a>00671                   <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, <span class="stringliteral">&quot;GENERATOR_FAILURE&quot;</span>, chan);
<a name="l00672"></a>00672                } <span class="keywordflow">else</span> {
<a name="l00673"></a>00673                   u-&gt;gen_active = 1;
<a name="l00674"></a>00674                }
<a name="l00675"></a>00675             }
<a name="l00676"></a>00676          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;S&apos;</span>) {
<a name="l00677"></a>00677             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a> || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00678"></a>00678                <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Queue &apos;S&apos;et called on unanswered channel\n&quot;</span>);
<a name="l00679"></a>00679                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, NULL, chan);
<a name="l00680"></a>00680                <span class="keywordflow">continue</span>;
<a name="l00681"></a>00681             }
<a name="l00682"></a>00682             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(&amp;input[2], NULL, u-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language) == -1) {
<a name="l00683"></a>00683                <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Unknown file requested &apos;%s&apos;\n&quot;</span>, &amp;input[2]);
<a name="l00684"></a>00684                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, NULL, chan);
<a name="l00685"></a>00685                strcpy(&amp;input[2], <span class="stringliteral">&quot;exception&quot;</span>);
<a name="l00686"></a>00686             }
<a name="l00687"></a>00687             <span class="keywordflow">if</span> (!u-&gt;abort_current_sound &amp;&amp; !u-&gt;playing_silence)
<a name="l00688"></a>00688                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;T&apos;</span>, NULL, chan);
<a name="l00689"></a>00689             <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;u-&gt;playlist);
<a name="l00690"></a>00690             <span class="keywordflow">while</span> ((entry = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;u-&gt;playlist, list))) {
<a name="l00691"></a>00691                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;D&apos;</span>, entry-&gt;filename, chan);
<a name="l00692"></a>00692                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(entry);
<a name="l00693"></a>00693             }
<a name="l00694"></a>00694             <span class="keywordflow">if</span> (!u-&gt;playing_silence)
<a name="l00695"></a>00695                u-&gt;abort_current_sound = 1;
<a name="l00696"></a>00696             entry = <a class="code" href="app__externalivr_8c.html#ae8e091b6f32bd28245cae3ffaae5f04b">make_entry</a>(&amp;input[2]);
<a name="l00697"></a>00697             <span class="keywordflow">if</span> (entry)
<a name="l00698"></a>00698                <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;u-&gt;playlist, entry, list);
<a name="l00699"></a>00699             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;u-&gt;playlist);
<a name="l00700"></a>00700          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;A&apos;</span>) {
<a name="l00701"></a>00701             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a> || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00702"></a>00702                <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Queue &apos;A&apos;ppend called on unanswered channel\n&quot;</span>);
<a name="l00703"></a>00703                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, NULL, chan);
<a name="l00704"></a>00704                <span class="keywordflow">continue</span>;
<a name="l00705"></a>00705             }
<a name="l00706"></a>00706             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(&amp;input[2], NULL, u-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language) == -1) {
<a name="l00707"></a>00707                <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Unknown file requested &apos;%s&apos;\n&quot;</span>, &amp;input[2]);
<a name="l00708"></a>00708                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, NULL, chan);
<a name="l00709"></a>00709                strcpy(&amp;input[2], <span class="stringliteral">&quot;exception&quot;</span>);
<a name="l00710"></a>00710             }
<a name="l00711"></a>00711             entry = <a class="code" href="app__externalivr_8c.html#ae8e091b6f32bd28245cae3ffaae5f04b">make_entry</a>(&amp;input[2]);
<a name="l00712"></a>00712             <span class="keywordflow">if</span> (entry) {
<a name="l00713"></a>00713                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;u-&gt;playlist);
<a name="l00714"></a>00714                <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;u-&gt;playlist, entry, list);
<a name="l00715"></a>00715                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;u-&gt;playlist);
<a name="l00716"></a>00716             }
<a name="l00717"></a>00717          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;G&apos;</span>) {
<a name="l00718"></a>00718             <span class="comment">/* A get variable message:  &quot;G,variable1,variable2,...&quot; */</span>
<a name="l00719"></a>00719             <span class="keywordtype">char</span> response[2048];
<a name="l00720"></a>00720 
<a name="l00721"></a>00721             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Getting a Variable out of the channel: %s\n&quot;</span>, &amp;input[2]);
<a name="l00722"></a>00722             <a class="code" href="app__externalivr_8c.html#a29c0c2d271de198a0bf3ab27296c53b1">ast_eivr_getvariable</a>(chan, &amp;input[2], response, <span class="keyword">sizeof</span>(response));
<a name="l00723"></a>00723             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;G&apos;</span>, response, chan);
<a name="l00724"></a>00724          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;V&apos;</span>) {
<a name="l00725"></a>00725             <span class="comment">/* A set variable message:  &quot;V,variablename=foo&quot; */</span>
<a name="l00726"></a>00726             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Setting a Variable up: %s\n&quot;</span>, &amp;input[2]);
<a name="l00727"></a>00727             <a class="code" href="app__externalivr_8c.html#a7519daeb6629555c1153758951f6669b">ast_eivr_setvariable</a>(chan, &amp;input[2]);
<a name="l00728"></a>00728          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;L&apos;</span>) {
<a name="l00729"></a>00729             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Log message from EIVR: %s\n&quot;</span>, &amp;input[2]);
<a name="l00730"></a>00730          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;X&apos;</span>) {
<a name="l00731"></a>00731             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Exiting ExternalIVR: %s\n&quot;</span>, &amp;input[2]);<span class="comment"></span>
<a name="l00732"></a>00732 <span class="comment">            /*! \todo add deprecation debug message for X command here */</span>
<a name="l00733"></a>00733             res = 0;
<a name="l00734"></a>00734             <span class="keywordflow">break</span>;
<a name="l00735"></a>00735          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;E&apos;</span>) {
<a name="l00736"></a>00736             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Exiting: %s\n&quot;</span>, &amp;input[2]);
<a name="l00737"></a>00737             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;E&apos;</span>, NULL, chan);
<a name="l00738"></a>00738             res = 0;
<a name="l00739"></a>00739             <span class="keywordflow">break</span>;
<a name="l00740"></a>00740          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;H&apos;</span>) {
<a name="l00741"></a>00741             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;Hanging up: %s\n&quot;</span>, &amp;input[2]);
<a name="l00742"></a>00742             <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;H&apos;</span>, NULL, chan);
<a name="l00743"></a>00743             res = -1;
<a name="l00744"></a>00744             <span class="keywordflow">break</span>;
<a name="l00745"></a>00745          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (input[0] == <span class="charliteral">&apos;O&apos;</span>) {
<a name="l00746"></a>00746             <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a> || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00747"></a>00747                <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Option called on unanswered channel\n&quot;</span>);
<a name="l00748"></a>00748                <a class="code" href="app__externalivr_8c.html#a1c32f3e84fd2b14234e450cc18e90cb0">send_eivr_event</a>(eivr_events, <span class="charliteral">&apos;Z&apos;</span>, NULL, chan);
<a name="l00749"></a>00749                <span class="keywordflow">continue</span>;
<a name="l00750"></a>00750             }
<a name="l00751"></a>00751             <span class="keywordflow">if</span> (!strcasecmp(&amp;input[2], <span class="stringliteral">&quot;autoclear&quot;</span>))
<a name="l00752"></a>00752                u-&gt;option_autoclear = 1;
<a name="l00753"></a>00753             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(&amp;input[2], <span class="stringliteral">&quot;noautoclear&quot;</span>))
<a name="l00754"></a>00754                u-&gt;option_autoclear = 0;
<a name="l00755"></a>00755             <span class="keywordflow">else</span>
<a name="l00756"></a>00756                <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Unknown option requested &apos;%s&apos;\n&quot;</span>, &amp;input[2]);
<a name="l00757"></a>00757          }
<a name="l00758"></a>00758       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (eivr_errors_fd &amp;&amp; (ready_fd == *eivr_errors_fd)) {
<a name="l00759"></a>00759          <span class="keywordtype">char</span> input[1024];
<a name="l00760"></a>00760   
<a name="l00761"></a>00761          <span class="keywordflow">if</span> (exception || feof(eivr_errors)) {
<a name="l00762"></a>00762             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Child process went away\n&quot;</span>);
<a name="l00763"></a>00763             res = -1;
<a name="l00764"></a>00764             <span class="keywordflow">break</span>;
<a name="l00765"></a>00765          }
<a name="l00766"></a>00766          <span class="keywordflow">if</span> (fgets(input, <span class="keyword">sizeof</span>(input), eivr_errors)) {
<a name="l00767"></a>00767             command = <a class="code" href="strings_8h.html#aeb1c54e6e100c63176d8e22b0d5ca865" title="Strip leading/trailing whitespace from a string.">ast_strip</a>(input);
<a name="l00768"></a>00768             <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, chan, <span class="stringliteral">&quot;stderr: %s\n&quot;</span>, command);
<a name="l00769"></a>00769          }
<a name="l00770"></a>00770       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((ready_fd &lt; 0) &amp;&amp; ms) { 
<a name="l00771"></a>00771          <span class="keywordflow">if</span> (errno == 0 || errno == EINTR)
<a name="l00772"></a>00772             <span class="keywordflow">continue</span>;
<a name="l00773"></a>00773  
<a name="l00774"></a>00774          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Wait failed (%s)\n&quot;</span>, strerror(errno));
<a name="l00775"></a>00775          <span class="keywordflow">break</span>;
<a name="l00776"></a>00776       }
<a name="l00777"></a>00777    }
<a name="l00778"></a>00778  
<a name="l00779"></a>00779    exit:
<a name="l00780"></a>00780    <span class="keywordflow">if</span> (test_available_fd &gt; -1) {
<a name="l00781"></a>00781       close(test_available_fd);
<a name="l00782"></a>00782    }
<a name="l00783"></a>00783    <span class="keywordflow">if</span> (eivr_events) {
<a name="l00784"></a>00784       fclose(eivr_events);
<a name="l00785"></a>00785       *eivr_events_fd = -1;
<a name="l00786"></a>00786    }
<a name="l00787"></a>00787    <span class="keywordflow">if</span> (eivr_commands) {
<a name="l00788"></a>00788       fclose(eivr_commands);
<a name="l00789"></a>00789       *eivr_commands_fd = -1;
<a name="l00790"></a>00790    }
<a name="l00791"></a>00791    <span class="keywordflow">if</span> (eivr_errors) {
<a name="l00792"></a>00792       fclose(eivr_errors);
<a name="l00793"></a>00793       *eivr_errors_fd = -1;
<a name="l00794"></a>00794    }
<a name="l00795"></a>00795    <span class="keywordflow">return</span> res;
<a name="l00796"></a>00796 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6e697466db0635dd0976dd5b228be52c"></a><!-- doxytag: member="app_externalivr.c::eivr_connect_socket" ref="a6e697466db0635dd0976dd5b228be52c" args="(struct ast_channel *chan, const char *host, int port)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int eivr_connect_socket </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>host</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>port</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="a6ec9982be678cb347f3904d7b991b4aa"></a><!-- doxytag: member="app_externalivr.c::gen_alloc" ref="a6ec9982be678cb347f3904d7b991b4aa" args="(struct ast_channel *chan, void *params)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* gen_alloc </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>params</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00129">129</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, and <a class="el" href="app__externalivr_8c_source.html#l00103">gen_state::u</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00130"></a>00130 {
<a name="l00131"></a>00131    <span class="keyword">struct </span><a class="code" href="structivr__localuser.html">ivr_localuser</a> *u = params;
<a name="l00132"></a>00132    <span class="keyword">struct </span><a class="code" href="structgen__state.html">gen_state</a> *<a class="code" href="structstate.html">state</a>;
<a name="l00133"></a>00133 
<a name="l00134"></a>00134    <span class="keywordflow">if</span> (!(state = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*state))))
<a name="l00135"></a>00135       <span class="keywordflow">return</span> NULL;
<a name="l00136"></a>00136 
<a name="l00137"></a>00137    state-&gt;<a class="code" href="structgen__state.html#afc3eb4974efe0db114c777b6022f6836">u</a> = u;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    <span class="keywordflow">return</span> state;
<a name="l00140"></a>00140 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aebd3a053a8965d528039694927675852"></a><!-- doxytag: member="app_externalivr.c::gen_closestream" ref="aebd3a053a8965d528039694927675852" args="(struct gen_state *state)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void gen_closestream </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structgen__state.html">gen_state</a> *&nbsp;</td>
          <td class="paramname"> <em>state</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00142">142</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="file_8c_source.html#l00887">ast_closestream()</a>, <a class="el" href="app__externalivr_8c_source.html#l00092">ivr_localuser::chan</a>, <a class="el" href="channel_8h_source.html#l00414">ast_channel::stream</a>, <a class="el" href="app__externalivr_8c_source.html#l00104">gen_state::stream</a>, and <a class="el" href="app__externalivr_8c_source.html#l00103">gen_state::u</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00161">gen_nextfile()</a>, <a class="el" href="app__externalivr_8c_source.html#l00192">gen_readframe()</a>, and <a class="el" href="app__externalivr_8c_source.html#l00152">gen_release()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00143"></a>00143 {
<a name="l00144"></a>00144    <span class="keywordflow">if</span> (!state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>)
<a name="l00145"></a>00145       <span class="keywordflow">return</span>;
<a name="l00146"></a>00146 
<a name="l00147"></a>00147    <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00148"></a>00148    state-&gt;<a class="code" href="structgen__state.html#afc3eb4974efe0db114c777b6022f6836">u</a>-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00149"></a>00149    state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = NULL;
<a name="l00150"></a>00150 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="adc63b5a111facfe63ef20d3295985acc"></a><!-- doxytag: member="app_externalivr.c::gen_generate" ref="adc63b5a111facfe63ef20d3295985acc" args="(struct ast_channel *chan, void *data, int len, int samples)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int gen_generate </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>len</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>samples</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00219">219</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="app__externalivr_8c_source.html#l00072">ast_chan_log</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l03411">ast_write()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="app__externalivr_8c_source.html#l00192">gen_readframe()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__externalivr_8c_source.html#l00106">gen_state::sample_queue</a>, and <a class="el" href="frame_8h_source.html#l00149">ast_frame::samples</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00220"></a>00220 {
<a name="l00221"></a>00221    <span class="keyword">struct </span><a class="code" href="structgen__state.html">gen_state</a> *<a class="code" href="structstate.html">state</a> = data;
<a name="l00222"></a>00222    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l00223"></a>00223    <span class="keywordtype">int</span> res = 0;
<a name="l00224"></a>00224 
<a name="l00225"></a>00225    state-&gt;<a class="code" href="structgen__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a> += <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227    <span class="keywordflow">while</span> (state-&gt;<a class="code" href="structgen__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a> &gt; 0) {
<a name="l00228"></a>00228       <span class="keywordflow">if</span> (!(f = <a class="code" href="app__externalivr_8c.html#aa28413641f22ded44433bf8ed11f3e83">gen_readframe</a>(state)))
<a name="l00229"></a>00229          <span class="keywordflow">return</span> -1;
<a name="l00230"></a>00230 
<a name="l00231"></a>00231       res = <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, f);
<a name="l00232"></a>00232       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00233"></a>00233       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00234"></a>00234          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, chan, <span class="stringliteral">&quot;Failed to write frame: %s\n&quot;</span>, strerror(errno));
<a name="l00235"></a>00235          <span class="keywordflow">return</span> -1;
<a name="l00236"></a>00236       }
<a name="l00237"></a>00237       state-&gt;<a class="code" href="structgen__state.html#ab45f20669bce21a6e7a16eff0fba0792">sample_queue</a> -= f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00238"></a>00238    }
<a name="l00239"></a>00239 
<a name="l00240"></a>00240    <span class="keywordflow">return</span> res;
<a name="l00241"></a>00241 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa62b5083ffcbe41dbf88794dfa6e59c0"></a><!-- doxytag: member="app_externalivr.c::gen_nextfile" ref="aa62b5083ffcbe41dbf88794dfa6e59c0" args="(struct gen_state *state)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int gen_nextfile </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structgen__state.html">gen_state</a> *&nbsp;</td>
          <td class="paramname"> <em>state</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00161">161</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="app__externalivr_8c_source.html#l00072">ast_chan_log</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="file_8c_source.html#l00624">ast_openstream_full()</a>, <a class="el" href="app__externalivr_8c_source.html#l00092">ivr_localuser::chan</a>, <a class="el" href="app__externalivr_8c_source.html#l00105">gen_state::current</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="app__externalivr_8c_source.html#l00142">gen_closestream()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="app__externalivr_8c_source.html#l00104">gen_state::stream</a>, and <a class="el" href="app__externalivr_8c_source.html#l00103">gen_state::u</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00192">gen_readframe()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00162"></a>00162 {
<a name="l00163"></a>00163    <span class="keyword">struct </span><a class="code" href="structivr__localuser.html">ivr_localuser</a> *u = state-&gt;<a class="code" href="structgen__state.html#afc3eb4974efe0db114c777b6022f6836">u</a>;
<a name="l00164"></a>00164    <span class="keywordtype">char</span> *file_to_stream;
<a name="l00165"></a>00165 
<a name="l00166"></a>00166    u-&gt;abort_current_sound = 0;
<a name="l00167"></a>00167    u-&gt;playing_silence = 0;
<a name="l00168"></a>00168    <a class="code" href="app__externalivr_8c.html#aebd3a053a8965d528039694927675852">gen_closestream</a>(state);
<a name="l00169"></a>00169 
<a name="l00170"></a>00170    <span class="keywordflow">while</span> (!state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>) {
<a name="l00171"></a>00171       state-&gt;<a class="code" href="structgen__state.html#a2341960433cbe594ee1ea5f797533522">current</a> = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;u-&gt;playlist, list);
<a name="l00172"></a>00172       <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structgen__state.html#a2341960433cbe594ee1ea5f797533522">current</a>) {
<a name="l00173"></a>00173          file_to_stream = state-&gt;<a class="code" href="structgen__state.html#a2341960433cbe594ee1ea5f797533522">current</a>-&gt;filename;
<a name="l00174"></a>00174       } <span class="keywordflow">else</span> {
<a name="l00175"></a>00175          file_to_stream = <span class="stringliteral">&quot;silence/10&quot;</span>;
<a name="l00176"></a>00176          u-&gt;playing_silence = 1;
<a name="l00177"></a>00177       }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179       <span class="keywordflow">if</span> (!(state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> = <a class="code" href="file_8h.html#ae2d6dfeafd18a99d47195178cd752a3d" title="Opens stream for use in seeking, playing.">ast_openstream_full</a>(u-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, file_to_stream, u-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;language, 1))) {
<a name="l00180"></a>00180          <a class="code" href="app__externalivr_8c.html#a627bf656df8f3e58bd42e51b51fbb4d5">ast_chan_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, u-&gt;<a class="code" href="structivr__localuser.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="stringliteral">&quot;File &apos;%s&apos; could not be opened: %s\n&quot;</span>, file_to_stream, strerror(errno));
<a name="l00181"></a>00181          <span class="keywordflow">if</span> (!u-&gt;playing_silence) {
<a name="l00182"></a>00182             <span class="keywordflow">continue</span>;
<a name="l00183"></a>00183          } <span class="keywordflow">else</span> {
<a name="l00184"></a>00184             <span class="keywordflow">break</span>;
<a name="l00185"></a>00185          }
<a name="l00186"></a>00186       }
<a name="l00187"></a>00187    }
<a name="l00188"></a>00188 
<a name="l00189"></a>00189    <span class="keywordflow">return</span> (!state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00190"></a>00190 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa28413641f22ded44433bf8ed11f3e83"></a><!-- doxytag: member="app_externalivr.c::gen_readframe" ref="aa28413641f22ded44433bf8ed11f3e83" args="(struct gen_state *state)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__frame.html">ast_frame</a>* gen_readframe </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structgen__state.html">gen_state</a> *&nbsp;</td>
          <td class="paramname"> <em>state</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00192">192</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00420">AST_LIST_FIRST</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="file_8c_source.html#l00720">ast_readframe()</a>, <a class="el" href="app__externalivr_8c_source.html#l00105">gen_state::current</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="app__externalivr_8c_source.html#l00142">gen_closestream()</a>, <a class="el" href="app__externalivr_8c_source.html#l00161">gen_nextfile()</a>, <a class="el" href="app__externalivr_8c_source.html#l00104">gen_state::stream</a>, and <a class="el" href="app__externalivr_8c_source.html#l00103">gen_state::u</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00219">gen_generate()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00193"></a>00193 {
<a name="l00194"></a>00194    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l00195"></a>00195    <span class="keyword">struct </span><a class="code" href="structivr__localuser.html">ivr_localuser</a> *u = state-&gt;<a class="code" href="structgen__state.html#afc3eb4974efe0db114c777b6022f6836">u</a>;
<a name="l00196"></a>00196 
<a name="l00197"></a>00197    <span class="keywordflow">if</span> (u-&gt;abort_current_sound ||
<a name="l00198"></a>00198       (u-&gt;playing_silence &amp;&amp; <a class="code" href="linkedlists_8h.html#adf1959c5c03a3a706da97ad2f49617e5" title="Returns the first entry contained in a list.">AST_LIST_FIRST</a>(&amp;u-&gt;playlist))) {
<a name="l00199"></a>00199       <a class="code" href="app__externalivr_8c.html#aebd3a053a8965d528039694927675852">gen_closestream</a>(state);
<a name="l00200"></a>00200       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;u-&gt;playlist);
<a name="l00201"></a>00201       <a class="code" href="app__externalivr_8c.html#aa62b5083ffcbe41dbf88794dfa6e59c0">gen_nextfile</a>(state);
<a name="l00202"></a>00202       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;u-&gt;playlist);
<a name="l00203"></a>00203    }
<a name="l00204"></a>00204 
<a name="l00205"></a>00205    <span class="keywordflow">if</span> (!(state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a> &amp;&amp; (f = <a class="code" href="file_8h.html#a962bc31d7a953b0a0290c72b168d41a7" title="Read a frame from a filestream.">ast_readframe</a>(state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>)))) {
<a name="l00206"></a>00206       <span class="keywordflow">if</span> (state-&gt;<a class="code" href="structgen__state.html#a2341960433cbe594ee1ea5f797533522">current</a>) {
<a name="l00207"></a>00207          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;u-&gt;finishlist);
<a name="l00208"></a>00208          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;u-&gt;finishlist, state-&gt;<a class="code" href="structgen__state.html#a2341960433cbe594ee1ea5f797533522">current</a>, list);
<a name="l00209"></a>00209          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;u-&gt;finishlist);
<a name="l00210"></a>00210          state-&gt;<a class="code" href="structgen__state.html#a2341960433cbe594ee1ea5f797533522">current</a> = NULL;
<a name="l00211"></a>00211       }
<a name="l00212"></a>00212       <span class="keywordflow">if</span> (!<a class="code" href="app__externalivr_8c.html#aa62b5083ffcbe41dbf88794dfa6e59c0">gen_nextfile</a>(state))
<a name="l00213"></a>00213          f = <a class="code" href="file_8h.html#a962bc31d7a953b0a0290c72b168d41a7" title="Read a frame from a filestream.">ast_readframe</a>(state-&gt;<a class="code" href="structgen__state.html#a016ccfa2a88444ffde0ad0168a0f231d">stream</a>);
<a name="l00214"></a>00214    }
<a name="l00215"></a>00215 
<a name="l00216"></a>00216    <span class="keywordflow">return</span> f;
<a name="l00217"></a>00217 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab6844db64e0751c8cbc2366ccc0e1639"></a><!-- doxytag: member="app_externalivr.c::gen_release" ref="ab6844db64e0751c8cbc2366ccc0e1639" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void gen_release </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00152">152</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, and <a class="el" href="app__externalivr_8c_source.html#l00142">gen_closestream()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00153"></a>00153 {
<a name="l00154"></a>00154    <span class="keyword">struct </span><a class="code" href="structgen__state.html">gen_state</a> *<a class="code" href="structstate.html">state</a> = data;
<a name="l00155"></a>00155 
<a name="l00156"></a>00156    <a class="code" href="app__externalivr_8c.html#aebd3a053a8965d528039694927675852">gen_closestream</a>(state);
<a name="l00157"></a>00157    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(data);
<a name="l00158"></a>00158 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="app_externalivr.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00803">803</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="app__externalivr_8c_source.html#l00314">app_exec()</a>, and <a class="el" href="module_8h_source.html#l00390">ast_register_application</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00804"></a>00804 {
<a name="l00805"></a>00805    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#aa47a7223480d23a864cf83fef0f8585e" title="Register an application.">ast_register_application</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>, <a class="code" href="app__externalivr_8c.html#a0e20eb0c1f8fdf6ca75e70db33f47ef9">app_exec</a>, <a class="code" href="app__externalivr_8c.html#afa26529a1480355101f5b6d883a7d37e">synopsis</a>, <a class="code" href="app__externalivr_8c.html#a39aaf66c43ce14a3febf2c17aa7738d2">descrip</a>);
<a name="l00806"></a>00806 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae8e091b6f32bd28245cae3ffaae5f04b"></a><!-- doxytag: member="app_externalivr.c::make_entry" ref="ae8e091b6f32bd28245cae3ffaae5f04b" args="(const char *filename)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structplaylist__entry.html">playlist_entry</a>* make_entry </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>filename</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00302">302</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00303"></a>00303 {
<a name="l00304"></a>00304    <span class="keyword">struct </span><a class="code" href="structplaylist__entry.html">playlist_entry</a> *entry;
<a name="l00305"></a>00305 
<a name="l00306"></a>00306    <span class="keywordflow">if</span> (!(entry = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*entry) + strlen(filename) + 10))) <span class="comment">/* XXX why 10 ? */</span>
<a name="l00307"></a>00307       <span class="keywordflow">return</span> NULL;
<a name="l00308"></a>00308 
<a name="l00309"></a>00309    strcpy(entry-&gt;filename, filename);
<a name="l00310"></a>00310 
<a name="l00311"></a>00311    <span class="keywordflow">return</span> entry;
<a name="l00312"></a>00312 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1c32f3e84fd2b14234e450cc18e90cb0"></a><!-- doxytag: member="app_externalivr.c::send_eivr_event" ref="a1c32f3e84fd2b14234e450cc18e90cb0" args="(FILE *handle, const char event, const char *data, const struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void send_eivr_event </td>
          <td>(</td>
          <td class="paramtype">FILE *&nbsp;</td>
          <td class="paramname"> <em>handle</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char&nbsp;</td>
          <td class="paramname"> <em>event</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00115">115</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="strings_8h_source.html#l00846">ast_str_append()</a>, <a class="el" href="strings_8h_source.html#l00488">ast_str_buffer()</a>, and <a class="el" href="strings_8h_source.html#l00415">ast_str_create()</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00117"></a>00117 {
<a name="l00118"></a>00118    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *tmp = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(12);
<a name="l00119"></a>00119 
<a name="l00120"></a>00120    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;tmp, 0, <span class="stringliteral">&quot;%c,%10d&quot;</span>, event, (<span class="keywordtype">int</span>)time(NULL));
<a name="l00121"></a>00121    <span class="keywordflow">if</span> (data) {
<a name="l00122"></a>00122       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;tmp, 0, <span class="stringliteral">&quot;,%s&quot;</span>, data);
<a name="l00123"></a>00123    }
<a name="l00124"></a>00124 
<a name="l00125"></a>00125    fprintf(handle, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmp));
<a name="l00126"></a>00126    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;sent &apos;%s&apos;\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmp));
<a name="l00127"></a>00127 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="app_externalivr.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00798">798</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l06403">ast_unregister_application()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00799"></a>00799 {
<a name="l00800"></a>00800    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>);
<a name="l00801"></a>00801 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a83a793edb3d6a3a15f2a7fc99ffe8c90"></a><!-- doxytag: member="app_externalivr.c::app" ref="a83a793edb3d6a3a15f2a7fc99ffe8c90" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* <a class="el" href="res__agi_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = &quot;ExternalIVR&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00051">51</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

</div>
</div>
<a class="anchor" id="a39aaf66c43ce14a3febf2c17aa7738d2"></a><!-- doxytag: member="app_externalivr.c::descrip" ref="a39aaf66c43ce14a3febf2c17aa7738d2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* <a class="el" href="res__agi_8c.html#a877f822586004ea40111a93db702cf15">descrip</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00054">54</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>Referenced by <a class="el" href="res__jabber_8c_source.html#l01604">aji_handle_presence()</a>.</p>

</div>
</div>
<a class="anchor" id="abe143f1bae4445e9b3798e1dec3bda60"></a><!-- doxytag: member="app_externalivr.c::gen" ref="abe143f1bae4445e9b3798e1dec3bda60" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__generator.html">ast_generator</a> <a class="el" href="app__externalivr_8c.html#abe143f1bae4445e9b3798e1dec3bda60">gen</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00243">243</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>Referenced by <a class="el" href="app__externalivr_8c_source.html#l00314">app_exec()</a>, <a class="el" href="app__externalivr_8c_source.html#l00521">eivr_comm()</a>, <a class="el" href="chan__h323_8c_source.html#l02832">reload_config()</a>, and <a class="el" href="chan__iax2_8c_source.html#l12493">set_config()</a>.</p>

</div>
</div>
<a class="anchor" id="aac288992af388f04afb23dbfdaa9ee38"></a><!-- doxytag: member="app_externalivr.c::options_flags" ref="aac288992af388f04afb23dbfdaa9ee38" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum { ... }   <a class="el" href="app__externalivr_8c.html#aac288992af388f04afb23dbfdaa9ee38">options_flags</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

</div>
</div>
<a class="anchor" id="afa26529a1480355101f5b6d883a7d37e"></a><!-- doxytag: member="app_externalivr.c::synopsis" ref="afa26529a1480355101f5b6d883a7d37e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* <a class="el" href="res__agi_8c.html#a1539fbb78128c8c72e41d1e9d2c09351">synopsis</a> = &quot;Interfaces with an external IVR application&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="app__externalivr_8c_source.html#l00053">53</a> of file <a class="el" href="app__externalivr_8c_source.html">app_externalivr.c</a>.</p>

<p>Referenced by <a class="el" href="pbx_8c_source.html#l03244">acf_retrieve_docs()</a>, <a class="el" href="pbx_8c_source.html#l03095">handle_show_function()</a>, <a class="el" href="func__odbc_8c_source.html#l00745">init_acf_query()</a>, and <a class="el" href="pbx_8c_source.html#l05186">print_app_docs()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:55 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
