<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:22:03 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>features.c File Reference</h1>
<p>Routines implementing call features as call pickup, parking and transfer.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="__private_8h_source.html">asterisk/_private.h</a>&quot;</code><br/>
<code>#include &lt;pthread.h&gt;</code><br/>
<code>#include &lt;sys/time.h&gt;</code><br/>
<code>#include &lt;sys/signal.h&gt;</code><br/>
<code>#include &lt;netinet/in.h&gt;</code><br/>
<code>#include &quot;<a class="el" href="lock_8h_source.html">asterisk/lock.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="file_8h_source.html">asterisk/file.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="causes_8h_source.html">asterisk/causes.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="translate_8h_source.html">asterisk/translate.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="app_8h_source.html">asterisk/app.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="say_8h_source.html">asterisk/say.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="features_8h_source.html">asterisk/features.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="musiconhold_8h_source.html">asterisk/musiconhold.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="config_8h_source.html">asterisk/config.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="manager_8h_source.html">asterisk/manager.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="adsi_8h_source.html">asterisk/adsi.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="devicestate_8h_source.html">asterisk/devicestate.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="monitor_8h_source.html">asterisk/monitor.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="audiohook_8h_source.html">asterisk/audiohook.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="global__datastores_8h_source.html">asterisk/global_datastores.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="astobj2_8h_source.html">asterisk/astobj2.h</a>&quot;</code><br/>

<p><a href="features_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__dial__features.html">ast_dial_features</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__park__call__args.html">ast_park_call_args</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__parkinglot.html">ast_parkinglot</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Structure for parking lots which are put in a container.  <a href="structast__parkinglot.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structfeature__group.html">feature_group</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structfeature__group__exten.html">feature_group_exten</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structfeature__groups.html">feature_groups</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structfeature__list.html">feature_list</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structparkeduser.html">parkeduser</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Description of one parked call, added to a list while active, then removed. The list belongs to a parkinglot.  <a href="structparkeduser.html#_details">More...</a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__parkinglot_1_1parkinglot__parklist.html">parkinglot_parklist</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a618d839aac1e2aa80050a5d54598a33d">AST_MAX_WATCHERS</a>&nbsp;&nbsp;&nbsp;256</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6aea006810fab96e7f7d0026d8cb0053">DEFAULT_ATXFER_CALLBACK_RETRIES</a>&nbsp;&nbsp;&nbsp;2</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aa425b91a354e0a8f57183c3ee46c0e48">DEFAULT_ATXFER_DROP_CALL</a>&nbsp;&nbsp;&nbsp;0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a29d8a8c818257651cccbb6e6c9b06292">DEFAULT_ATXFER_LOOP_DELAY</a>&nbsp;&nbsp;&nbsp;10000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a80a4f6e11f5c65942aedf59452cc7f54">DEFAULT_FEATURE_DIGIT_TIMEOUT</a>&nbsp;&nbsp;&nbsp;1000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a13e107144da4d6f673328e73b17bc62c">DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER</a>&nbsp;&nbsp;&nbsp;15000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#abc52bb32a2f26f43e2c82795a0d0ea38">DEFAULT_PARK_TIME</a>&nbsp;&nbsp;&nbsp;45000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a0c5645209e777b34a100a0ead18144c2">DEFAULT_PARKINGLOT</a>&nbsp;&nbsp;&nbsp;&quot;default&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a846bf05c38e729e38e932726833d9596">DEFAULT_TRANSFER_DIGIT_TIMEOUT</a>&nbsp;&nbsp;&nbsp;3000</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a43d76622becf50779cbf68a3419a42e5">FEATURE_SENSE_CHAN</a>&nbsp;&nbsp;&nbsp;(1 &lt;&lt; 0)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a715d6b99230466c16f14e1d0fa77ffac">FEATURE_SENSE_PEER</a>&nbsp;&nbsp;&nbsp;(1 &lt;&lt; 1)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>&nbsp;&nbsp;&nbsp;ARRAY_LEN(<a class="el" href="res__features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a0ac894a3d58c2850064c53aeab4c4b98">HFS_FORMAT</a>&nbsp;&nbsp;&nbsp;&quot;%-25s %-7s %-7s\n&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a58b5e7c82122d6925893b4a50fb37860">MAX_DIAL_FEATURE_OPTIONS</a>&nbsp;&nbsp;&nbsp;30</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom">{ <a class="el" href="features_8c.html#a282841548f1d79a386bbeb4172ebf942ac6c5fc9f2156b5d690587dc1fdcbc6b3">BRIDGE_OPT_PLAYTONE</a> =  (1 &lt;&lt; 0)
 }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192">ast_park_call_options</a> { <br/>
&nbsp;&nbsp;<a class="el" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4">AST_PARK_OPT_RINGING</a> =  (1 &lt;&lt; 0), 
<a class="el" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b">AST_PARK_OPT_RANDOMIZE</a> =  (1 &lt;&lt; 1), 
<a class="el" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f">AST_PARK_OPT_SILENCE</a> =  (1 &lt;&lt; 2), 
<a class="el" href="res__features_8c.html#aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4">AST_PARK_OPT_RINGING</a> =  (1 &lt;&lt; 0), 
<br/>
&nbsp;&nbsp;<a class="el" href="res__features_8c.html#aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b">AST_PARK_OPT_RANDOMIZE</a> =  (1 &lt;&lt; 1), 
<a class="el" href="res__features_8c.html#aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f">AST_PARK_OPT_SILENCE</a> =  (1 &lt;&lt; 2)
<br/>
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a51755e20bdcffb65c53468b7c4eead32">action_bridge</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Bridge <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> together.  <a href="#a51755e20bdcffb65c53468b7c4eead32"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a3b41083253e12b6a71f4188e4e74a170">add_features_datastores</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *caller, struct <a class="el" href="structast__channel.html">ast_channel</a> *callee, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a64c01948390e5eca145537b88f268e07">adsi_announce_park</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, char *parkingexten)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Announce call parking by ADSI.  <a href="#a64c01948390e5eca145537b88f268e07"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a3fe7c7e43b8f3140716d836816bf827f">ast_bridge_call</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">bridge the call and set CDR  <a href="#a3fe7c7e43b8f3140716d836816bf827f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6b2ac231f2658dd8169218a8e4cad4ae">ast_features_init</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a425ed69a5937fc5a26508084a11ceb47">ast_features_reload</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reload call features from features.conf.  <a href="#a425ed69a5937fc5a26508084a11ceb47"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#afe968c2bd566a03c0bc212faa7a37e17">ast_find_call_feature</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">look for a call feature entry by its sname  <a href="#afe968c2bd566a03c0bc212faa7a37e17"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aa34f70cbfec78481c228be7255fae4d8">ast_masq_park_call</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *rchan, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, int timeout, int *extout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Park a call via a masqueraded channel.  <a href="#aa34f70cbfec78481c228be7255fae4d8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a79dd77e214dcdba17d47e04f82b41874">ast_park_call</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, int timeout, int *extout)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Park a call.  <a href="#a79dd77e214dcdba17d47e04f82b41874"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a716860609c92cd4b7fb8f6eb724ac700">ast_parking_ext</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Determine system parking <a class="el" href="structextension.html">extension</a>.  <a href="#a716860609c92cd4b7fb8f6eb724ac700"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a4890be42c2add5f52028705d6bc02201">ast_pickup_call</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Pickup a call.  <a href="#a4890be42c2add5f52028705d6bc02201"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a849b0c1bd72a0339408c7e6026768e40">ast_pickup_ext</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Determine system call pickup <a class="el" href="structextension.html">extension</a>.  <a href="#a849b0c1bd72a0339408c7e6026768e40"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#adea59e175a9f8500c0eb848918849c67">ast_rdlock_call_features</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aa148867dd4dde459d181fc84be58c0f0">ast_register_feature</a> (struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *feature)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">register new feature into <a class="el" href="structfeature__list.html">feature_list</a>  <a href="#aa148867dd4dde459d181fc84be58c0f0"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a7c163c3ad2e31110c5fc9e0d3b27d81d">ast_unlock_call_features</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ad151dea8a1d676a4eac6206597ae980a">ast_unregister_feature</a> (struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *feature)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">unregister feature from feature_set  <a href="#ad151dea8a1d676a4eac6206597ae980a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a3230befbb308c37f984f069bf129b73b">ast_unregister_features</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove all features in the list.  <a href="#a3230befbb308c37f984f069bf129b73b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ad9244bff3ee975cad01b501ad64ecc5d">ast_unregister_groups</a> (void)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove all feature <a class="el" href="structgroups.html">groups</a> in the list.  <a href="#ad9244bff3ee975cad01b501ad64ecc5d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a77a74ae0a8425ff3ac5fef9ce7d2b9ef">bridge_call_thread</a> (void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">bridge the call  <a href="#a77a74ae0a8425ff3ac5fef9ce7d2b9ef"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a9cb8151f1a64734b68ee8cafcc37cf3e">bridge_call_thread_launch</a> (void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">create thread for the parked call  <a href="#a9cb8151f1a64734b68ee8cafcc37cf3e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a274fc5b522ca5cfc7d7d8e871482480b">bridge_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Bridge <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>.  <a href="#a274fc5b522ca5cfc7d7d8e871482480b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aadd28dbd7590a172d15245291dfaae1e">build_parkinglot</a> (char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, struct <a class="el" href="structast__variable.html">ast_variable</a> *var)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Build parkinglot from configuration and chain it in.  <a href="#aadd28dbd7590a172d15245291dfaae1e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a0ba3a29aff36306cb6baae2799f5cbbe">builtin_atxfer</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Attended transfer.  <a href="#a0ba3a29aff36306cb6baae2799f5cbbe"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab70776da6fa50ce2057f4401fd1f676e">builtin_automixmonitor</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a61aab8abfc9670c05a03793d9ed4f597">builtin_automonitor</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Monitor a channel by DTMF.  <a href="#a61aab8abfc9670c05a03793d9ed4f597"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab15661cb2b776df35b0ae031fc5b0be1">builtin_blindtransfer</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Blind transfer <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> to another <a class="el" href="structextension.html">extension</a>.  <a href="#ab15661cb2b776df35b0ae031fc5b0be1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a2ad9c6a6c7f2864f65291114b64543b7">builtin_disconnect</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a15da7831191d1f662ee4413a71f505a2">builtin_parkcall</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">support routing for one touch call parking  <a href="#a15da7831191d1f662ee4413a71f505a2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a88974a178f7f1c082551b0516c5fe7fd">callback_dialoptions</a> (struct <a class="el" href="structast__flags.html">ast_flags</a> *features_callee, struct <a class="el" href="structast__flags.html">ast_flags</a> *features_caller, char *options, size_t len)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a90ee9a80505894386848734fea6683fb">check_compat</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *c, struct <a class="el" href="structast__channel.html">ast_channel</a> *newchan)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">make <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> compatible  <a href="#a90ee9a80505894386848734fea6683fb"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a44c105a1da30fd5e1155653a681e6de5">check_goto_on_transfer</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check goto on transfer.  <a href="#a44c105a1da30fd5e1155653a681e6de5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a9b6a832c081aa8f2cd5287bcf54023a2">create_parkinglot</a> (char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Allocate parking lot structure.  <a href="#a9b6a832c081aa8f2cd5287bcf54023a2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a1f3c786719a3735242e22d86b1ce4f08">dial_features_destroy</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#adef8fadeae29c7bd0b0f5133352f636d">dial_features_duplicate</a> (void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#acf1dcf498f0e94d517221edd746f71ce">do_bridge_masquerade</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *tmpchan)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Actual bridge.  <a href="#acf1dcf498f0e94d517221edd746f71ce"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ad9b02e0b0449b215a699f0a64d19107a">do_parking_thread</a> (void *ignore)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Take care of parked calls and unpark them if needed.  <a href="#ad9b02e0b0449b215a699f0a64d19107a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a7d36808a9da972e429854519d6ced84c">feature_exec_app</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">exec an app by feature  <a href="#a7d36808a9da972e429854519d6ced84c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ae89302e12bbcc8ffec898244cc3b73fe">feature_interpret</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, char *code, int sense)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Check the dynamic features.  <a href="#ae89302e12bbcc8ffec898244cc3b73fe"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ac2ea73c446e5630743ce9e6e90634e05">feature_request_and_dial</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *caller, struct <a class="el" href="structast__channel.html">ast_channel</a> *transferee, const char *<a class="el" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, int <a class="el" href="chan__alsa_8c.html#a98f5e70e98f6dc48e3c5ba316066d540">format</a>, void *data, int timeout, int *outstate, const char *<a class="el" href="chan__phone_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, const char *<a class="el" href="chan__phone_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, int igncallerstate, const char *<a class="el" href="chan__phone_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get feature and dial.  <a href="#ac2ea73c446e5630743ce9e6e90634e05"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a1d1eac183cc14bd4a8bc679fc68200e4">find_channel_by_group</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *c, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a0109970dc3ef884910b9dc1a5fede2e7">find_dynamic_feature</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">find a call feature by name  <a href="#a0109970dc3ef884910b9dc1a5fede2e7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structfeature__group.html">feature_group</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a2de36634b2790793c2629ac1a25f64ea">find_group</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find a <a class="el" href="structgroup.html">group</a> by name.  <a href="#a2de36634b2790793c2629ac1a25f64ea"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab7cacbc2a5f8e49ab8c548df6201601b">find_parkinglot</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find parkinglot by name.  <a href="#ab7cacbc2a5f8e49ab8c548df6201601b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a5ff0df3df1473ce3b5cec8f947a6fe69">findparkinglotname</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find parking lot name from channel.  <a href="#a5ff0df3df1473ce3b5cec8f947a6fe69"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a39926b835e958ba09edbb2cb21a09f6a">handle_feature_show</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">CLI command to list configured features.  <a href="#a39926b835e958ba09edbb2cb21a09f6a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6d6f533532d3168968124e360ad9a935">handle_features_reload</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a4b52dc88a4201cfae82e106c4b6e4079">handle_parkedcalls</a> (struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *e, int cmd, struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *a)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">CLI command to list parked calls.  <a href="#a4b52dc88a4201cfae82e106c4b6e4079"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aed5779f84d4ebb67745d801d3ebede43">load_config</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ac513c11fb4717d40cf8cd46cf387c0fe">manage_parkinglot</a> (struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *curlot, fd_set *rfds, fd_set *efds, fd_set *nrfds, fd_set *nefds, int *ms, int *max)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Run management on parkinglots, called once per parkinglot.  <a href="#ac513c11fb4717d40cf8cd46cf387c0fe"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a81ea8c1f888844f3ba5aade3be0bbeba">manager_park</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create manager event for parked calls.  <a href="#a81ea8c1f888844f3ba5aade3be0bbeba"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ae173627ea061ac13a887ad640feac171">manager_parking_status</a> (struct <a class="el" href="structmansession.html">mansession</a> *s, const struct <a class="el" href="structmessage.html">message</a> *m)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Dump parking lot status.  <a href="#ae173627ea061ac13a887ad640feac171"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a87a222a1d617d1917126357f27861442">masq_park_call</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *rchan, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, int timeout, int *extout, int play_announcement, struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *args)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6969031880bd3d320cec5f1f89c83325">masq_park_call_announce</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *rchan, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, int timeout, int *extout)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ac9a6ee321a8ce8cb17bc81306f401844">masq_park_call_announce_args</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *rchan, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *args)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static enum <a class="el" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee">ast_device_state</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a803092f58ccdc8d7562ed7c5f2151380">metermaidstate</a> (const char *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">metermaids callback from <a class="el" href="devicestate_8c.html" title="Device state management.">devicestate.c</a>  <a href="#a803092f58ccdc8d7562ed7c5f2151380"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9">notify_metermaids</a> (const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, enum <a class="el" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee">ast_device_state</a> <a class="el" href="structstate.html">state</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Notify metermaids that we've changed an <a class="el" href="structextension.html">extension</a>.  <a href="#a5eed24a00b3ff396ca4135f2cacf76f9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aa3b3766aea99a4ace3b34a21c9d73624">park_add_hints</a> (char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, int start, int <a class="el" href="res__timing__pthread_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add parking <a class="el" href="structhints.html">hints</a> for all defined parking lots.  <a href="#aa3b3766aea99a4ace3b34a21c9d73624"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a2cec676e4ea8d8e13b3852e97fc28552">park_call_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Park a call.  <a href="#a2cec676e4ea8d8e13b3852e97fc28552"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#af750802cffe6ab46e36412a8a47a68e2">park_call_full</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *args)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#add37fc3ed9c410d20dd4de34644f5c7b">park_exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a30d20fba12b1a6a72a8fe90c6d546406">park_exec_full</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, void *data, struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *<a class="el" href="chan__mgcp_8c.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">parkinglot</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Pickup parked call.  <a href="#a30d20fba12b1a6a72a8fe90c6d546406"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structparkeduser.html">parkeduser</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#acc8e6a5be7f5d697c14627a5119c8199">park_space_reserve</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *args)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#afd36dda493e0930aed5e3d6dc59de095">parkinglot_addref</a> (struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *<a class="el" href="chan__mgcp_8c.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">parkinglot</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a1798ad70b3c43377f3d89f7c4830b940">parkinglot_cmp_cb</a> (void *obj, void *arg, int flags)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#af048c9c1f337c794fec319fe666ab8b8">parkinglot_destroy</a> (void *obj)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Destroy a parking lot.  <a href="#af048c9c1f337c794fec319fe666ab8b8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a231b8dd6b2803def28a66cc640d3186f">parkinglot_hash_cb</a> (const void *obj, const int flags)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab85223aa95d23fb716027953e555c28b">parkinglot_unref</a> (struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *<a class="el" href="chan__mgcp_8c.html#a6b31bfcc769a5b5c31e13aa6d8a9a286">parkinglot</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unreference parkinglot object. If no more references, then go ahead and delete it.  <a href="#ab85223aa95d23fb716027953e555c28b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cdr.html">ast_cdr</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a82ec1e5a1738ece6284922cf189ce3f2">pick_unlocked_cdr</a> (struct <a class="el" href="structast__cdr.html">ast_cdr</a> *cdr)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">return the first unlocked cdr in a possible chain  <a href="#a82ec1e5a1738ece6284922cf189ce3f2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab9136d54e94186e675c182cc933a46f9">play_message_in_bridged_call</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *caller_chan, struct <a class="el" href="structast__channel.html">ast_channel</a> *callee_chan, const char *audiofile)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Play <a class="el" href="structmessage.html">message</a> to both caller and callee in bridged call, plays synchronously, autoservicing the other channel during the <a class="el" href="structmessage.html">message</a>, so please don't use this for very long messages.  <a href="#ab9136d54e94186e675c182cc933a46f9"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a357c36e1b760f6742b5803dd78905306">post_manager_event</a> (const char *s, struct <a class="el" href="structparkeduser.html">parkeduser</a> *pu)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Output parking event to manager.  <a href="#a357c36e1b760f6742b5803dd78905306"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static const char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aaae36759026f17aea180b5ba7fad3918">real_ctx</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *transferer, struct <a class="el" href="structast__channel.html">ast_channel</a> *transferee)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Find the context for the transfer.  <a href="#aaae36759026f17aea180b5ba7fad3918"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structfeature__group.html">feature_group</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aec9d75b1e054035dae95035292c36937">register_group</a> (const char *fgname)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add new feature <a class="el" href="structgroup.html">group</a>.  <a href="#aec9d75b1e054035dae95035292c36937"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ae592cf7dec3edf756bc8647f56a740d7">register_group_feature</a> (struct <a class="el" href="structfeature__group.html">feature_group</a> *fg, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *feature)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Add feature to <a class="el" href="structgroup.html">group</a>.  <a href="#ae592cf7dec3edf756bc8647f56a740d7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a2b1a39d793bfb9bde86eaddf9e901885">remap_feature</a> (const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, const char *value)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aebf26a3de75e83d0137e596d85522436">set_bridge_features_on_config</a> (struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, const char *features)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c">set_c_e_p</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="res__phoneprov_8c.html#a71ac783a3ca66bd546dc964f1dd0e0f0">ext</a>, int pri)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">store context, <a class="el" href="structextension.html">extension</a> and priority  <a href="#aa1863982006a2c87e09556807d2d4a7c"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ae6d5d03f4835d75bcc1fbc119c646ddb">set_config_flags</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *<a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a130d6c414eebccdc195fa893b47be865">set_peers</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> **caller, struct <a class="el" href="structast__channel.html">ast_channel</a> **callee, struct <a class="el" href="structast__channel.html">ast_channel</a> *peer, struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, int sense)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">set caller and callee according to the direction  <a href="#a130d6c414eebccdc195fa893b47be865"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a0873e755f478aa3fdcd12ad51a9e9783">unmap_features</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a644feb4e8d3f7dcd077c7c7321af8d5a">adsipark</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a30cf144e208ddc17e51b2f1e600052e8">app_bridge</a> = &quot;Bridge&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a42aaa9bbb76f30a8d697eb7c79901045">atxfercallbackretries</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a3a4aff3656629deadbb2294abb1b2e50">atxferdropcall</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static unsigned int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__app__option.html">ast_app_option</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a217d93bf8d70c1b07dcc8aa6380cfae9">bridge_exec_options</a> [128] = { [ 'p' ] = { .flag = BRIDGE_OPT_PLAYTONE } }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__call__feature.html">ast_call_feature</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a53d8f03eb64267f168b7a966a64915f8">cli_features</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a1788f4d16d98aa5348dffa550d2632b2">comebacktoorigin</a> = 1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a> [256]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab0ae9c20e04fb84e78d7596559c33b11">default_parkinglot</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structast__datastore__info.html">ast_datastore_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="lock_8h.html#af7598796d461f7dcb95cea6be65806f8">ast_rwlock_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a> = PTHREAD_RWLOCK_INITIALIZER</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a88045cf5a2dca0498141f69a5e2d54b3">mandescr_bridge</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab646ce88b1017513554ea26a0d24557b">mandescr_park</a> []</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__app.html">ast_app</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a863e1104b2f52359385b7764b1f727f4">mixmonitor_app</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ad76df5fd37675aefb1b43395687d81f5">mixmonitor_ok</a> = 1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__app.html">ast_app</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a31438b92e816fd5c5b858f7424205aaa">monitor_ok</a> = 1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__app__option.html">ast_app_option</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a9e1a57d86c3bd004f9a9a32f90cfb1f5">park_call_options</a> [128] = { [ 'r' ] = { .flag = AST_PARK_OPT_RINGING }, [ 'R' ] = { .flag = AST_PARK_OPT_RANDOMIZE }, [ 's' ] = { .flag = AST_PARK_OPT_SILENCE }, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ac3950a3179488304a97d02de9488c205">parkcall</a> = PARK_APP_NAME</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a45fde2767ab498a74ee0edc3fa3c3dbf">parkedcall</a> = &quot;ParkedCall&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> = 0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a> [AST_MAX_EXTENSION]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static pthread_t&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ac66fb87ae86fa37b36fa78286c237fd2">parking_thread</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structao2__container.html">ao2_container</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509">parkinglots</a></td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The list of parking lots configured. Always at least one - the default parking lot.  <a href="#ad1dd6c1dd542a6e34c68a1c5c5d40509"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a7af3a76f3f29d5a21be63ef43f89840e">pickup_ext</a> [AST_MAX_EXTENSION]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a> [256]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a> [256]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a> = &quot;features&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__app.html">ast_app</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a6e92ba0da6795c93b26c0e839fb4687e">stopmixmonitor_app</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a76d9bec7d89bd468e2af244893c23c3e">stopmixmonitor_ok</a> = 1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a> [256]</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a> [256]</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Routines implementing call features as call pickup, parking and transfer. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Mark Spencer &lt;<a href="mailto:markster@digium.com">markster@digium.com</a>&gt; </dd></dl>

<p>Definition in file <a class="el" href="features_8c_source.html">features.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a618d839aac1e2aa80050a5d54598a33d"></a><!-- doxytag: member="features.c::AST_MAX_WATCHERS" ref="a618d839aac1e2aa80050a5d54598a33d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define AST_MAX_WATCHERS&nbsp;&nbsp;&nbsp;256</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00171">171</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="a6aea006810fab96e7f7d0026d8cb0053"></a><!-- doxytag: member="features.c::DEFAULT_ATXFER_CALLBACK_RETRIES" ref="a6aea006810fab96e7f7d0026d8cb0053" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_ATXFER_CALLBACK_RETRIES&nbsp;&nbsp;&nbsp;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00169">169</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="aa425b91a354e0a8f57183c3ee46c0e48"></a><!-- doxytag: member="features.c::DEFAULT_ATXFER_DROP_CALL" ref="aa425b91a354e0a8f57183c3ee46c0e48" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_ATXFER_DROP_CALL&nbsp;&nbsp;&nbsp;0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00167">167</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a29d8a8c818257651cccbb6e6c9b06292"></a><!-- doxytag: member="features.c::DEFAULT_ATXFER_LOOP_DELAY" ref="a29d8a8c818257651cccbb6e6c9b06292" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_ATXFER_LOOP_DELAY&nbsp;&nbsp;&nbsp;10000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00168">168</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a80a4f6e11f5c65942aedf59452cc7f54"></a><!-- doxytag: member="features.c::DEFAULT_FEATURE_DIGIT_TIMEOUT" ref="a80a4f6e11f5c65942aedf59452cc7f54" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_FEATURE_DIGIT_TIMEOUT&nbsp;&nbsp;&nbsp;1000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00164">164</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a13e107144da4d6f673328e73b17bc62c"></a><!-- doxytag: member="features.c::DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER" ref="a13e107144da4d6f673328e73b17bc62c" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER&nbsp;&nbsp;&nbsp;15000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00165">165</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="abc52bb32a2f26f43e2c82795a0d0ea38"></a><!-- doxytag: member="features.c::DEFAULT_PARK_TIME" ref="abc52bb32a2f26f43e2c82795a0d0ea38" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_PARK_TIME&nbsp;&nbsp;&nbsp;45000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00162">162</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a0c5645209e777b34a100a0ead18144c2"></a><!-- doxytag: member="features.c::DEFAULT_PARKINGLOT" ref="a0c5645209e777b34a100a0ead18144c2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_PARKINGLOT&nbsp;&nbsp;&nbsp;&quot;default&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Default parking lot </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00166">166</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a846bf05c38e729e38e932726833d9596"></a><!-- doxytag: member="features.c::DEFAULT_TRANSFER_DIGIT_TIMEOUT" ref="a846bf05c38e729e38e932726833d9596" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define DEFAULT_TRANSFER_DIGIT_TIMEOUT&nbsp;&nbsp;&nbsp;3000</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00163">163</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a43d76622becf50779cbf68a3419a42e5"></a><!-- doxytag: member="features.c::FEATURE_SENSE_CHAN" ref="a43d76622becf50779cbf68a3419a42e5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define FEATURE_SENSE_CHAN&nbsp;&nbsp;&nbsp;(1 &lt;&lt; 0)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00909">909</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, <a class="el" href="features_8c_source.html#l01903">feature_exec_app()</a>, and <a class="el" href="features_8c_source.html#l01996">feature_interpret()</a>.</p>

</div>
</div>
<a class="anchor" id="a715d6b99230466c16f14e1d0fa77ffac"></a><!-- doxytag: member="features.c::FEATURE_SENSE_PEER" ref="a715d6b99230466c16f14e1d0fa77ffac" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define FEATURE_SENSE_PEER&nbsp;&nbsp;&nbsp;(1 &lt;&lt; 1)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00910">910</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, and <a class="el" href="features_8c_source.html#l00918">set_peers()</a>.</p>

</div>
</div>
<a class="anchor" id="a6b4ef6d37a4790e15ce87945840cc350"></a><!-- doxytag: member="features.c::FEATURES_COUNT" ref="a6b4ef6d37a4790e15ce87945840cc350" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define FEATURES_COUNT&nbsp;&nbsp;&nbsp;ARRAY_LEN(<a class="el" href="res__features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>)</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01693">1693</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01884">ast_find_call_feature()</a>, <a class="el" href="features_8c_source.html#l01996">feature_interpret()</a>, <a class="el" href="features_8c_source.html#l02152">feature_request_and_dial()</a>, <a class="el" href="features_8c_source.html#l04019">handle_feature_show()</a>, <a class="el" href="features_8c_source.html#l01970">remap_feature()</a>, <a class="el" href="features_8c_source.html#l02099">set_config_flags()</a>, and <a class="el" href="features_8c_source.html#l01960">unmap_features()</a>.</p>

</div>
</div>
<a class="anchor" id="a0ac894a3d58c2850064c53aeab4c4b98"></a><!-- doxytag: member="features.c::HFS_FORMAT" ref="a0ac894a3d58c2850064c53aeab4c4b98" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define HFS_FORMAT&nbsp;&nbsp;&nbsp;&quot;%-25s %-7s %-7s\n&quot;</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Referenced by <a class="el" href="features_8c_source.html#l04019">handle_feature_show()</a>.</p>

</div>
</div>
<a class="anchor" id="a58b5e7c82122d6925893b4a50fb37860"></a><!-- doxytag: member="features.c::MAX_DIAL_FEATURE_OPTIONS" ref="a58b5e7c82122d6925893b4a50fb37860" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define MAX_DIAL_FEATURE_OPTIONS&nbsp;&nbsp;&nbsp;30</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00172">172</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a282841548f1d79a386bbeb4172ebf942"></a><!-- doxytag: member="features.c::@184" ref="a282841548f1d79a386bbeb4172ebf942" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">anonymous enum</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a282841548f1d79a386bbeb4172ebf942ac6c5fc9f2156b5d690587dc1fdcbc6b3"></a><!-- doxytag: member="BRIDGE_OPT_PLAYTONE" ref="a282841548f1d79a386bbeb4172ebf942ac6c5fc9f2156b5d690587dc1fdcbc6b3" args="" -->BRIDGE_OPT_PLAYTONE</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04507">4507</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04507"></a>04507      {
<a name="l04508"></a>04508    <a class="code" href="features_8c.html#a282841548f1d79a386bbeb4172ebf942ac6c5fc9f2156b5d690587dc1fdcbc6b3">BRIDGE_OPT_PLAYTONE</a> = (1 &lt;&lt; 0),
<a name="l04509"></a>04509 };
</pre></div></p>

</div>
</div>
<a class="anchor" id="aabb62351ca403089e5d36755a0f3f192"></a><!-- doxytag: member="features.c::ast_park_call_options" ref="aabb62351ca403089e5d36755a0f3f192" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192">ast_park_call_options</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Options to pass to park_call_full </p>
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4"></a><!-- doxytag: member="AST_PARK_OPT_RINGING" ref="aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4" args="" -->AST_PARK_OPT_RINGING</em>&nbsp;</td><td>
<p>Provide ringing to the parked caller instead of music on hold </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b"></a><!-- doxytag: member="AST_PARK_OPT_RANDOMIZE" ref="aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b" args="" -->AST_PARK_OPT_RANDOMIZE</em>&nbsp;</td><td>
<p>Randomly choose a parking spot for the caller instead of choosing the first one that is available. </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f"></a><!-- doxytag: member="AST_PARK_OPT_SILENCE" ref="aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f" args="" -->AST_PARK_OPT_SILENCE</em>&nbsp;</td><td>
<p>Do not announce the parking <a class="el" href="structnumber.html" title="Number structure.">number</a> </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4"></a><!-- doxytag: member="AST_PARK_OPT_RINGING" ref="aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4" args="" -->AST_PARK_OPT_RINGING</em>&nbsp;</td><td>
<p>Provide ringing to the parked caller instead of music on hold </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b"></a><!-- doxytag: member="AST_PARK_OPT_RANDOMIZE" ref="aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b" args="" -->AST_PARK_OPT_RANDOMIZE</em>&nbsp;</td><td>
<p>Randomly choose a parking spot for the caller instead of choosing the first one that is available. </p>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f"></a><!-- doxytag: member="AST_PARK_OPT_SILENCE" ref="aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f" args="" -->AST_PARK_OPT_SILENCE</em>&nbsp;</td><td>
<p>Do not announce the parking <a class="el" href="structnumber.html" title="Number structure.">number</a> </p>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00539">539</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00539"></a>00539                            {<span class="comment"></span>
<a name="l00540"></a>00540 <span class="comment">   /*! Provide ringing to the parked caller instead of music on hold */</span>
<a name="l00541"></a>00541    <a class="code" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4">AST_PARK_OPT_RINGING</a> =   (1 &lt;&lt; 0),<span class="comment"></span>
<a name="l00542"></a>00542 <span class="comment">   /*! Randomly choose a parking spot for the caller instead of choosing</span>
<a name="l00543"></a>00543 <span class="comment">    *  the first one that is available. */</span>
<a name="l00544"></a>00544    <a class="code" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b">AST_PARK_OPT_RANDOMIZE</a> = (1 &lt;&lt; 1),<span class="comment"></span>
<a name="l00545"></a>00545 <span class="comment">   /*! Do not announce the parking number */</span>
<a name="l00546"></a>00546    <a class="code" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f">AST_PARK_OPT_SILENCE</a> = (1 &lt;&lt; 2),
<a name="l00547"></a>00547 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a51755e20bdcffb65c53468b7c4eead32"></a><!-- doxytag: member="features.c::action_bridge" ref="a51755e20bdcffb65c53468b7c4eead32" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int action_bridge </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Bridge <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> together. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>m</em>&nbsp;</td><td>Make sure valid <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> were specified, send errors if any of the <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> could not be found/locked, answer <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> if needed, create the placeholder <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> and grab the other <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> make the <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> compatible, send error if we fail doing so setup the bridge thread object and start the bridge.</td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success or on incorrect use. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>on failure to bridge <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04156">4156</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="channel_8h_source.html#l00730">ast_channel_alloc</a>, <a class="el" href="channel_8c_source.html#l04200">ast_channel_make_compatible()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="channel_8c_source.html#l01284">ast_get_channel_by_name_prefix_locked()</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8h_source.html#l00359">AST_STATE_DOWN</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="file_8c_source.html#l00943">ast_streamfile()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="file_8c_source.html#l01315">ast_waitstream()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>, <a class="el" href="features_8c_source.html#l00455">bridge_call_thread_launch()</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="features_8c_source.html#l00328">ast_bridge_thread_obj::chan</a>, <a class="el" href="features_8c_source.html#l04126">do_bridge_masquerade()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00329">ast_bridge_thread_obj::peer</a>, <a class="el" href="app__morsecode_8c_source.html#l00112">playtone()</a>, <a class="el" href="features_8c_source.html#l00330">ast_bridge_thread_obj::return_to_pbx</a>, and <a class="el" href="features_8c_source.html#l00243">xfersound</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04157"></a>04157 {
<a name="l04158"></a>04158    <span class="keyword">const</span> <span class="keywordtype">char</span> *channela = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Channel1&quot;</span>);
<a name="l04159"></a>04159    <span class="keyword">const</span> <span class="keywordtype">char</span> *channelb = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Channel2&quot;</span>);
<a name="l04160"></a>04160    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__morsecode_8c.html#af24b8fdac86b5dd5af7b427fcec7ce4c">playtone</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Tone&quot;</span>);
<a name="l04161"></a>04161    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chana = NULL, *chanb = NULL;
<a name="l04162"></a>04162    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmpchana = NULL, *tmpchanb = NULL;
<a name="l04163"></a>04163    <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> *tobj = NULL;
<a name="l04164"></a>04164 
<a name="l04165"></a>04165    <span class="comment">/* make sure valid channels were specified */</span>
<a name="l04166"></a>04166    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(channela) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(channelb)) {
<a name="l04167"></a>04167       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Missing channel parameter in request&quot;</span>);
<a name="l04168"></a>04168       <span class="keywordflow">return</span> 0;
<a name="l04169"></a>04169    }
<a name="l04170"></a>04170 
<a name="l04171"></a>04171    <span class="comment">/* The same code must be executed for chana and chanb.  To avoid a</span>
<a name="l04172"></a>04172 <span class="comment">    * theoretical deadlock, this code is separated so both chana and chanb will</span>
<a name="l04173"></a>04173 <span class="comment">    * not hold locks at the same time. */</span>
<a name="l04174"></a>04174 
<a name="l04175"></a>04175    <span class="comment">/* Start with chana */</span>
<a name="l04176"></a>04176    chana = <a class="code" href="channel_8h.html#a67239a95ab93867fb9da5a8b20281224" title="Get channel by name or uniqueid prefix (locks channel).">ast_get_channel_by_name_prefix_locked</a>(channela, strlen(channela));
<a name="l04177"></a>04177 
<a name="l04178"></a>04178    <span class="comment">/* send errors if any of the channels could not be found/locked */</span>
<a name="l04179"></a>04179    <span class="keywordflow">if</span> (!chana) {
<a name="l04180"></a>04180       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l04181"></a>04181       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Channel1 does not exists: %s&quot;</span>, channela);
<a name="l04182"></a>04182       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, buf);
<a name="l04183"></a>04183       <span class="keywordflow">return</span> 0;
<a name="l04184"></a>04184    }
<a name="l04185"></a>04185 
<a name="l04186"></a>04186    <span class="comment">/* Answer the channels if needed */</span>
<a name="l04187"></a>04187    <span class="keywordflow">if</span> (chana-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l04188"></a>04188       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chana);
<a name="l04189"></a>04189 
<a name="l04190"></a>04190    <span class="comment">/* create the placeholder channels and grab the other channels */</span>
<a name="l04191"></a>04191    <span class="keywordflow">if</span> (!(tmpchana = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, NULL, NULL, NULL, 
<a name="l04192"></a>04192       NULL, NULL, 0, <span class="stringliteral">&quot;Bridge/%s&quot;</span>, chana-&gt;name))) {
<a name="l04193"></a>04193       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to create temporary channel!&quot;</span>);
<a name="l04194"></a>04194       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chana);
<a name="l04195"></a>04195       <span class="keywordflow">return</span> 1;
<a name="l04196"></a>04196    }
<a name="l04197"></a>04197 
<a name="l04198"></a>04198    <a class="code" href="features_8c.html#acf1dcf498f0e94d517221edd746f71ce" title="Actual bridge.">do_bridge_masquerade</a>(chana, tmpchana);
<a name="l04199"></a>04199    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chana);
<a name="l04200"></a>04200    chana = NULL;
<a name="l04201"></a>04201 
<a name="l04202"></a>04202    <span class="comment">/* now do chanb */</span>
<a name="l04203"></a>04203    chanb = <a class="code" href="channel_8h.html#a67239a95ab93867fb9da5a8b20281224" title="Get channel by name or uniqueid prefix (locks channel).">ast_get_channel_by_name_prefix_locked</a>(channelb, strlen(channelb));
<a name="l04204"></a>04204    <span class="comment">/* send errors if any of the channels could not be found/locked */</span>
<a name="l04205"></a>04205    <span class="keywordflow">if</span> (!chanb) {
<a name="l04206"></a>04206       <span class="keywordtype">char</span> buf[256];
<a name="l04207"></a>04207       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Channel2 does not exists: %s&quot;</span>, channelb);
<a name="l04208"></a>04208       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchana);
<a name="l04209"></a>04209       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, buf);
<a name="l04210"></a>04210       <span class="keywordflow">return</span> 0;
<a name="l04211"></a>04211    }
<a name="l04212"></a>04212 
<a name="l04213"></a>04213    <span class="comment">/* Answer the channels if needed */</span>
<a name="l04214"></a>04214    <span class="keywordflow">if</span> (chanb-&gt;_state != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l04215"></a>04215       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chanb);
<a name="l04216"></a>04216 
<a name="l04217"></a>04217    <span class="comment">/* create the placeholder channels and grab the other channels */</span>
<a name="l04218"></a>04218    <span class="keywordflow">if</span> (!(tmpchanb = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, NULL, NULL, NULL, 
<a name="l04219"></a>04219       NULL, NULL, 0, <span class="stringliteral">&quot;Bridge/%s&quot;</span>, chanb-&gt;name))) {
<a name="l04220"></a>04220       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to create temporary channels!&quot;</span>);
<a name="l04221"></a>04221       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchana);
<a name="l04222"></a>04222       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chanb);
<a name="l04223"></a>04223       <span class="keywordflow">return</span> 1;
<a name="l04224"></a>04224    }
<a name="l04225"></a>04225    <a class="code" href="features_8c.html#acf1dcf498f0e94d517221edd746f71ce" title="Actual bridge.">do_bridge_masquerade</a>(chanb, tmpchanb);
<a name="l04226"></a>04226    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chanb);
<a name="l04227"></a>04227    chanb = NULL;
<a name="l04228"></a>04228 
<a name="l04229"></a>04229    <span class="comment">/* make the channels compatible, send error if we fail doing so */</span>
<a name="l04230"></a>04230    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a57646ce13ff95b5fc66dea2e741b21ff" title="Makes two channel formats compatible.">ast_channel_make_compatible</a>(tmpchana, tmpchanb)) {
<a name="l04231"></a>04231       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not make channels %s and %s compatible for manager bridge\n&quot;</span>, tmpchana-&gt;name, tmpchanb-&gt;name);
<a name="l04232"></a>04232       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Could not make channels compatible for manager bridge&quot;</span>);
<a name="l04233"></a>04233       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchana);
<a name="l04234"></a>04234       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchanb);
<a name="l04235"></a>04235       <span class="keywordflow">return</span> 1;
<a name="l04236"></a>04236    }
<a name="l04237"></a>04237 
<a name="l04238"></a>04238    <span class="comment">/* setup the bridge thread object and start the bridge */</span>
<a name="l04239"></a>04239    <span class="keywordflow">if</span> (!(tobj = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tobj)))) {
<a name="l04240"></a>04240       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to spawn a new bridge thread on %s and %s: %s\n&quot;</span>, tmpchana-&gt;name, tmpchanb-&gt;name, strerror(errno));
<a name="l04241"></a>04241       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Unable to spawn a new bridge thread&quot;</span>);
<a name="l04242"></a>04242       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchana);
<a name="l04243"></a>04243       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmpchanb);
<a name="l04244"></a>04244       <span class="keywordflow">return</span> 1;
<a name="l04245"></a>04245    }
<a name="l04246"></a>04246 
<a name="l04247"></a>04247    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a> = tmpchana;
<a name="l04248"></a>04248    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a> = tmpchanb;
<a name="l04249"></a>04249    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#acffa9c033850b0d1ab2b93ca1be518d1">return_to_pbx</a> = 1;
<a name="l04250"></a>04250 
<a name="l04251"></a>04251    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(playtone)) {
<a name="l04252"></a>04252       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>) &amp;&amp; !<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(tmpchanb, <a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, tmpchanb-&gt;language)) {
<a name="l04253"></a>04253          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(tmpchanb, <span class="stringliteral">&quot;&quot;</span>) &lt; 0)
<a name="l04254"></a>04254             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play a courtesy tone on chan %s\n&quot;</span>, tmpchanb-&gt;name);
<a name="l04255"></a>04255       }
<a name="l04256"></a>04256    }
<a name="l04257"></a>04257 
<a name="l04258"></a>04258    <a class="code" href="features_8c.html#a9cb8151f1a64734b68ee8cafcc37cf3e" title="create thread for the parked call">bridge_call_thread_launch</a>(tobj);
<a name="l04259"></a>04259 
<a name="l04260"></a>04260    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Launched bridge thread with success&quot;</span>);
<a name="l04261"></a>04261 
<a name="l04262"></a>04262    <span class="keywordflow">return</span> 0;
<a name="l04263"></a>04263 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3b41083253e12b6a71f4188e4e74a170"></a><!-- doxytag: member="features.c::add_features_datastores" ref="a3b41083253e12b6a71f4188e4e74a170" args="(struct ast_channel *caller, struct ast_channel *callee, struct ast_bridge_config *config)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void add_features_datastores </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>caller</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>callee</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l02374">2374</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="channel_8c_source.html#l01534">ast_channel_datastore_add()</a>, <a class="el" href="channel_8c_source.html#l01548">ast_channel_datastore_find()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="utils_8h_source.html#l00082">ast_copy_flags</a>, <a class="el" href="datastore_8h_source.html#l00071">ast_datastore_alloc</a>, <a class="el" href="datastore_8c_source.html#l00058">ast_datastore_free()</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="channel_8h_source.html#l00151">DATASTORE_INHERIT_FOREVER</a>, <a class="el" href="features_8c_source.html#l00276">ast_dial_features::features_callee</a>, <a class="el" href="channel_8h_source.html#l00590">ast_bridge_config::features_callee</a>, <a class="el" href="features_8c_source.html#l00275">ast_dial_features::features_caller</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, <a class="el" href="datastore_8h_source.html#l00058">ast_datastore::inheritance</a>, <a class="el" href="features_8c_source.html#l00277">ast_dial_features::is_caller</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02375"></a>02375 {
<a name="l02376"></a>02376    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *ds_callee_features = NULL, *ds_caller_features = NULL;
<a name="l02377"></a>02377    <span class="keyword">struct </span><a class="code" href="structast__dial__features.html">ast_dial_features</a> *callee_features = NULL, *caller_features = NULL;
<a name="l02378"></a>02378 
<a name="l02379"></a>02379    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(caller);
<a name="l02380"></a>02380    ds_caller_features = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(caller, &amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL);
<a name="l02381"></a>02381    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(caller);
<a name="l02382"></a>02382    <span class="keywordflow">if</span> (!ds_caller_features) {
<a name="l02383"></a>02383       <span class="keywordflow">if</span> (!(ds_caller_features = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL))) {
<a name="l02384"></a>02384          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create channel datastore for caller features. Aborting!\n&quot;</span>);
<a name="l02385"></a>02385          <span class="keywordflow">return</span>;
<a name="l02386"></a>02386       }
<a name="l02387"></a>02387       <span class="keywordflow">if</span> (!(caller_features = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*caller_features)))) {
<a name="l02388"></a>02388          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate memory for callee feature flags. Aborting!\n&quot;</span>);
<a name="l02389"></a>02389          <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(ds_caller_features);
<a name="l02390"></a>02390          <span class="keywordflow">return</span>;
<a name="l02391"></a>02391       }
<a name="l02392"></a>02392       ds_caller_features-&gt;inheritance = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l02393"></a>02393       caller_features-&gt;is_caller = 1;
<a name="l02394"></a>02394       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(caller_features-&gt;features_callee), &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02395"></a>02395       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(caller_features-&gt;features_caller), &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02396"></a>02396       ds_caller_features-&gt;data = caller_features;
<a name="l02397"></a>02397       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(caller);
<a name="l02398"></a>02398       <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(caller, ds_caller_features);
<a name="l02399"></a>02399       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(caller);
<a name="l02400"></a>02400    } <span class="keywordflow">else</span> {
<a name="l02401"></a>02401       <span class="comment">/* If we don&apos;t return here, then when we do a builtin_atxfer we will copy the disconnect</span>
<a name="l02402"></a>02402 <span class="comment">       * flags over from the atxfer to the caller */</span>
<a name="l02403"></a>02403       <span class="keywordflow">return</span>;
<a name="l02404"></a>02404    }
<a name="l02405"></a>02405 
<a name="l02406"></a>02406    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(callee);
<a name="l02407"></a>02407    ds_callee_features = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(callee, &amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL);
<a name="l02408"></a>02408    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(callee);
<a name="l02409"></a>02409    <span class="keywordflow">if</span> (!ds_callee_features) {
<a name="l02410"></a>02410       <span class="keywordflow">if</span> (!(ds_callee_features = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL))) {
<a name="l02411"></a>02411          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create channel datastore for callee features. Aborting!\n&quot;</span>);
<a name="l02412"></a>02412          <span class="keywordflow">return</span>;
<a name="l02413"></a>02413       }
<a name="l02414"></a>02414       <span class="keywordflow">if</span> (!(callee_features = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*callee_features)))) {
<a name="l02415"></a>02415          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate memory for callee feature flags. Aborting!\n&quot;</span>);
<a name="l02416"></a>02416          <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(ds_callee_features);
<a name="l02417"></a>02417          <span class="keywordflow">return</span>;
<a name="l02418"></a>02418       }
<a name="l02419"></a>02419       ds_callee_features-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l02420"></a>02420       callee_features-&gt;<a class="code" href="structast__dial__features.html#aaef08621750180fbcf3ce4de6736fafd">is_caller</a> = 0;
<a name="l02421"></a>02421       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(callee_features-&gt;<a class="code" href="structast__dial__features.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02422"></a>02422       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(callee_features-&gt;<a class="code" href="structast__dial__features.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02423"></a>02423       ds_callee_features-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = callee_features;
<a name="l02424"></a>02424       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(callee);
<a name="l02425"></a>02425       <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(callee, ds_callee_features);
<a name="l02426"></a>02426       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(callee);
<a name="l02427"></a>02427    }
<a name="l02428"></a>02428 
<a name="l02429"></a>02429    <span class="keywordflow">return</span>;
<a name="l02430"></a>02430 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a64c01948390e5eca145537b88f268e07"></a><!-- doxytag: member="features.c::adsi_announce_park" ref="a64c01948390e5eca145537b88f268e07" args="(struct ast_channel *chan, char *parkingexten)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int adsi_announce_park </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>parkingexten</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Announce call parking by ADSI. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>parkingexten</em>&nbsp;</td><td>. Create <a class="el" href="structmessage.html">message</a> to show for ADSI, display <a class="el" href="structmessage.html">message</a>. </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00477">477</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="adsi_8h_source.html#l00113">ADSI_JUST_CENT</a>, <a class="el" href="adsi_8h.html#a4c7e441bdf356ad4cbc6e549c2ff0ea1">ast_adsi_load_session</a>, <a class="el" href="adsi_8h.html#a6c89ea70599bb3b2de0aba1a3e2defa5">ast_adsi_print</a>, and <a class="el" href="app__adsiprog_8c_source.html#l00104">justify</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00478"></a>00478 {
<a name="l00479"></a>00479    <span class="keywordtype">int</span> res;
<a name="l00480"></a>00480    <span class="keywordtype">int</span> <a class="code" href="app__adsiprog_8c.html#ac63d06057e89bc34a690d16229374079">justify</a>[5] = {<a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, ADSI_JUST_CENT, ADSI_JUST_CENT};
<a name="l00481"></a>00481    <span class="keywordtype">char</span> tmp[256];
<a name="l00482"></a>00482    <span class="keywordtype">char</span> *<a class="code" href="structmessage.html">message</a>[5] = {NULL, NULL, NULL, NULL, NULL};
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;Parked on %s&quot;</span>, parkingexten);
<a name="l00485"></a>00485    message[0] = tmp;
<a name="l00486"></a>00486    res = <a class="code" href="adsi_8h.html#a4c7e441bdf356ad4cbc6e549c2ff0ea1" title="Check if scripts for a given app are already loaded. Version may be -1, if any version...">ast_adsi_load_session</a>(chan, NULL, 0, 1);
<a name="l00487"></a>00487    <span class="keywordflow">if</span> (res == -1)
<a name="l00488"></a>00488       <span class="keywordflow">return</span> res;
<a name="l00489"></a>00489    <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#a6c89ea70599bb3b2de0aba1a3e2defa5" title="Display some stuff on the screen.">ast_adsi_print</a>(chan, message, justify, 1);
<a name="l00490"></a>00490 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3fe7c7e43b8f3140716d836816bf827f"></a><!-- doxytag: member="features.c::ast_bridge_call" ref="a3fe7c7e43b8f3140716d836816bf827f" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_bridge_call </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>bridge the call and set CDR </p>
<p>Bridge a call, optionally allowing redirection.</p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan,peer,config</em>&nbsp;</td><td>Set start time, check for two <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>,check if monitor on check for feature activation, create new CDR </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>res</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure to bridge. </td></tr>
  </table>
  </dd>
</dl>

<p><p>append the event to featurecode. we rely on the string being zero-filled, and not overflowing it. </p>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000072">Todo:</a></b></dt><dd>XXX how do we guarantee the latter ? </dd></dl>
</p>

<p>Definition at line <a class="el" href="features_8c_source.html#l02441">2441</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="cdr_8h_source.html#l00101">ast_cdr::accountcode</a>, <a class="el" href="features_8c_source.html#l02374">add_features_datastores()</a>, <a class="el" href="channel_8h_source.html#l00473">ast_channel::amaflags</a>, <a class="el" href="cdr_8h_source.html#l00099">ast_cdr::amaflags</a>, <a class="el" href="cdr_8h_source.html#l00089">ast_cdr::answer</a>, <a class="el" href="channel_8h_source.html#l00411">ast_channel::appl</a>, <a class="el" href="channel_8h_source.html#l00167">AST_BRIDGE_RETRY</a>, <a class="el" href="channel_8c_source.html#l04733">ast_bridged_channel()</a>, <a class="el" href="cdr_8c_source.html#l00452">ast_cdr_alloc()</a>, <a class="el" href="cdr_8c_source.html#l00687">ast_cdr_answer()</a>, <a class="el" href="cdr_8h_source.html#l00051">AST_CDR_ANSWERED</a>, <a class="el" href="cdr_8c_source.html#l01234">ast_cdr_detach()</a>, <a class="el" href="cdr_8c_source.html#l00441">ast_cdr_discard()</a>, <a class="el" href="cdr_8c_source.html#l00168">ast_cdr_dup()</a>, <a class="el" href="cdr_8c_source.html#l00879">ast_cdr_end()</a>, <a class="el" href="cdr_8h_source.html#l00035">AST_CDR_FLAG_BRIDGED</a>, <a class="el" href="cdr_8h_source.html#l00036">AST_CDR_FLAG_MAIN</a>, <a class="el" href="cdr_8h_source.html#l00034">AST_CDR_FLAG_POST_DISABLED</a>, <a class="el" href="cdr_8h_source.html#l00048">AST_CDR_NULL</a>, <a class="el" href="cdr_8c_source.html#l00936">ast_cdr_setaccount()</a>, <a class="el" href="cdr_8c_source.html#l00835">ast_cdr_setcid()</a>, <a class="el" href="cdr_8c_source.html#l01105">ast_cdr_specialized_reset()</a>, <a class="el" href="cdr_8c_source.html#l00674">ast_cdr_start()</a>, <a class="el" href="cdr_8c_source.html#l00996">ast_cdr_update()</a>, <a class="el" href="channel_8c_source.html#l05055">ast_channel_bridge()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="channel_8c_source.html#l05307">ast_channel_setoption()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="frame_8h_source.html#l00302">AST_CONTROL_BUSY</a>, <a class="el" href="frame_8h_source.html#l00305">AST_CONTROL_CONGESTION</a>, <a class="el" href="frame_8h_source.html#l00306">AST_CONTROL_FLASH</a>, <a class="el" href="frame_8h_source.html#l00298">AST_CONTROL_HANGUP</a>, <a class="el" href="frame_8h_source.html#l00313">AST_CONTROL_HOLD</a>, <a class="el" href="frame_8h_source.html#l00308">AST_CONTROL_OPTION</a>, <a class="el" href="frame_8h_source.html#l00300">AST_CONTROL_RINGING</a>, <a class="el" href="frame_8h_source.html#l00314">AST_CONTROL_UNHOLD</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="cdr_8c_source.html#l00054">ast_default_amaflags</a>, <a class="el" href="app_8c_source.html#l00314">ast_dtmf_stream()</a>, <a class="el" href="pbx_8c_source.html#l04143">ast_exists_extension()</a>, <a class="el" href="channel_8h_source.html#l00583">AST_FEATURE_NO_H_EXTEN</a>, <a class="el" href="channel_8h_source.html#l00576">AST_FEATURE_PLAY_WARNING</a>, <a class="el" href="features_8h_source.html#l00066">AST_FEATURE_RETURN_PASSDIGITS</a>, <a class="el" href="features_8h_source.html#l00068">AST_FEATURE_RETURN_SUCCESS</a>, <a class="el" href="channel_8h_source.html#l00565">AST_FLAG_BRIDGE_HANGUP_DONT</a>, <a class="el" href="channel_8h_source.html#l00561">AST_FLAG_BRIDGE_HANGUP_RUN</a>, <a class="el" href="channel_8h_source.html#l00541">AST_FLAG_IN_AUTOLOOP</a>, <a class="el" href="channel_8h_source.html#l00529">AST_FLAG_ZOMBIE</a>, <a class="el" href="frame_8h_source.html#l00105">AST_FRAME_CONTROL</a>, <a class="el" href="frame_8h_source.html#l00124">AST_FRAME_DTMF</a>, <a class="el" href="frame_8h_source.html#l00122">AST_FRAME_DTMF_BEGIN</a>, <a class="el" href="frame_8h_source.html#l00099">AST_FRAME_DTMF_END</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l01278">ast_get_channel_by_name_locked()</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="channel_8c_source.html#l03150">ast_indicate_data()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="options_8h_source.html#l00116">ast_opt_end_cdr_before_h_exten</a>, <a class="el" href="frame_8h_source.html#l00358">AST_OPTION_FLAG_REQUEST</a>, <a class="el" href="channel_8c_source.html#l01799">ast_raw_answer()</a>, <a class="el" href="utils_8h_source.html#l00092">ast_set2_flag</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="pbx_8c_source.html#l04168">ast_spawn_extension()</a>, <a class="el" href="channel_8h_source.html#l00364">AST_STATE_RINGING</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="time_8h_source.html#l00119">ast_tvcmp()</a>, <a class="el" href="time_8h_source.html#l00089">ast_tvdiff_ms()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="time_8h_source.html#l00099">ast_tvzero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="channel_8h_source.html#l00422">ast_channel::cdr</a>, <a class="el" href="cdr_8h_source.html#l00079">ast_cdr::channel</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="frame_8h_source.html#l00424">ast_option_header::data</a>, <a class="el" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">ast_frame::data</a>, <a class="el" href="channel_8h_source.html#l00412">ast_channel::data</a>, <a class="el" href="frame_8h_source.html#l00147">ast_frame::datalen</a>, <a class="el" href="cdr_8h_source.html#l00077">ast_cdr::dcontext</a>, <a class="el" href="cdr_8h_source.html#l00097">ast_cdr::disposition</a>, <a class="el" href="cdr_8h_source.html#l00075">ast_cdr::dst</a>, <a class="el" href="cdr_8h_source.html#l00081">ast_cdr::dstchannel</a>, <a class="el" href="structast__bridge__config.html#a03acb9e092c45d88e1fb9e146e5e554e">ast_bridge_config::end_bridge_callback</a>, <a class="el" href="channel_8h_source.html#l00604">ast_bridge_config::end_bridge_callback_data</a>, <a class="el" href="channel_8h_source.html#l00599">ast_bridge_config::end_sound</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="features_8c_source.html#l01996">feature_interpret()</a>, <a class="el" href="features_8h_source.html#l00030">FEATURE_MAX_LEN</a>, <a class="el" href="features_8c_source.html#l00909">FEATURE_SENSE_CHAN</a>, <a class="el" href="features_8c_source.html#l00910">FEATURE_SENSE_PEER</a>, <a class="el" href="channel_8h_source.html#l00594">ast_bridge_config::feature_timer</a>, <a class="el" href="features_8c_source.html#l00251">featuredigittimeout</a>, <a class="el" href="channel_8h_source.html#l00590">ast_bridge_config::features_callee</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, <a class="el" href="channel_8h_source.html#l00601">ast_bridge_config::firstpass</a>, <a class="el" href="frame_8h_source.html#l00143">ast_frame::frametype</a>, <a class="el" href="cdr_8h_source.html#l00083">ast_cdr::lastapp</a>, <a class="el" href="cdr_8h_source.html#l00085">ast_cdr::lastdata</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00264">monitor_app</a>, <a class="el" href="features_8c_source.html#l00265">monitor_ok</a>, <a class="el" href="cdr_8h_source.html#l00113">ast_cdr::next</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l01322">pbx_exec()</a>, <a class="el" href="pbx_8c_source.html#l01363">pbx_findapp()</a>, <a class="el" href="features_8c_source.html#l02331">pick_unlocked_cdr()</a>, <a class="el" href="channel_8h_source.html#l00596">ast_bridge_config::play_warning</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="frame_8h_source.html#l00159">ast_frame::ptr</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="features_8c_source.html#l02342">set_bridge_features_on_config()</a>, <a class="el" href="features_8c_source.html#l02099">set_config_flags()</a>, <a class="el" href="cdr_8h_source.html#l00087">ast_cdr::start</a>, <a class="el" href="channel_8h_source.html#l00600">ast_bridge_config::start_sound</a>, <a class="el" href="channel_8h_source.html#l00591">ast_bridge_config::start_time</a>, <a class="el" href="frame_8h_source.html#l00145">ast_frame::subclass</a>, <a class="el" href="cdr_8h_source.html#l00106">ast_cdr::uniqueid</a>, <a class="el" href="cdr_8h_source.html#l00108">ast_cdr::userfield</a>, <a class="el" href="channel_8h_source.html#l00491">ast_channel::visible_indication</a>, <a class="el" href="channel_8h_source.html#l00597">ast_bridge_config::warning_freq</a>, and <a class="el" href="channel_8h_source.html#l00598">ast_bridge_config::warning_sound</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02442"></a>02442 {
<a name="l02443"></a>02443    <span class="comment">/* Copy voice back and forth between the two channels.  Give the peer</span>
<a name="l02444"></a>02444 <span class="comment">      the ability to transfer calls with &apos;#&lt;extension&apos; syntax. */</span>
<a name="l02445"></a>02445    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l02446"></a>02446    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *who;
<a name="l02447"></a>02447    <span class="keywordtype">char</span> chan_featurecode[<a class="code" href="features_8h.html#aaa72e2b220201e352ddedb91db4d7f31">FEATURE_MAX_LEN</a> + 1]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l02448"></a>02448    <span class="keywordtype">char</span> peer_featurecode[<a class="code" href="features_8h.html#aaa72e2b220201e352ddedb91db4d7f31">FEATURE_MAX_LEN</a> + 1]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l02449"></a>02449    <span class="keywordtype">char</span> orig_channame[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l02450"></a>02450    <span class="keywordtype">char</span> orig_peername[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l02451"></a>02451    <span class="keywordtype">int</span> res;
<a name="l02452"></a>02452    <span class="keywordtype">int</span> diff;
<a name="l02453"></a>02453    <span class="keywordtype">int</span> hasfeatures=0;
<a name="l02454"></a>02454    <span class="keywordtype">int</span> hadfeatures=0;
<a name="l02455"></a>02455    <span class="keywordtype">int</span> autoloopflag;
<a name="l02456"></a>02456    <span class="keyword">struct </span><a class="code" href="structast__option__header.html">ast_option_header</a> *aoh;
<a name="l02457"></a>02457    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a> backup_config;
<a name="l02458"></a>02458    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *bridge_cdr = NULL;
<a name="l02459"></a>02459    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *orig_peer_cdr = NULL;
<a name="l02460"></a>02460    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *chan_cdr = <a class="code" href="features_8c.html#a82ec1e5a1738ece6284922cf189ce3f2" title="return the first unlocked cdr in a possible chain">pick_unlocked_cdr</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>); <span class="comment">/* the proper chan cdr, if there are forked cdrs */</span>
<a name="l02461"></a>02461    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *peer_cdr = <a class="code" href="features_8c.html#a82ec1e5a1738ece6284922cf189ce3f2" title="return the first unlocked cdr in a possible chain">pick_unlocked_cdr</a>(peer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>); <span class="comment">/* the proper chan cdr, if there are forked cdrs */</span>
<a name="l02462"></a>02462    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *new_chan_cdr = NULL; <span class="comment">/* the proper chan cdr, if there are forked cdrs */</span>
<a name="l02463"></a>02463    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *new_peer_cdr = NULL; <span class="comment">/* the proper chan cdr, if there are forked cdrs */</span>
<a name="l02464"></a>02464 
<a name="l02465"></a>02465    memset(&amp;backup_config, 0, <span class="keyword">sizeof</span>(backup_config));
<a name="l02466"></a>02466 
<a name="l02467"></a>02467    config-&gt;<a class="code" href="structast__bridge__config.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02468"></a>02468 
<a name="l02469"></a>02469    <span class="keywordflow">if</span> (chan &amp;&amp; peer) {
<a name="l02470"></a>02470       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BRIDGEPEER&quot;</span>, peer-&gt;name);
<a name="l02471"></a>02471       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(peer, <span class="stringliteral">&quot;BRIDGEPEER&quot;</span>, chan-&gt;name);
<a name="l02472"></a>02472    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan) {
<a name="l02473"></a>02473       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BLINDTRANSFER&quot;</span>, NULL);
<a name="l02474"></a>02474    }
<a name="l02475"></a>02475 
<a name="l02476"></a>02476    <a class="code" href="features_8c.html#aebf26a3de75e83d0137e596d85522436">set_bridge_features_on_config</a>(config, <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;BRIDGE_FEATURES&quot;</span>));
<a name="l02477"></a>02477    <a class="code" href="features_8c.html#a3b41083253e12b6a71f4188e4e74a170">add_features_datastores</a>(chan, peer, config);
<a name="l02478"></a>02478 
<a name="l02479"></a>02479    <span class="comment">/* This is an interesting case.  One example is if a ringing channel gets redirected to</span>
<a name="l02480"></a>02480 <span class="comment">    * an extension that picks up a parked call.  This will make sure that the call taken</span>
<a name="l02481"></a>02481 <span class="comment">    * out of parking gets told that the channel it just got bridged to is still ringing. */</span>
<a name="l02482"></a>02482    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a> &amp;&amp; peer-&gt;<a class="code" href="structast__channel.html#a5ad10add51120d9c9122eca4201dd645">visible_indication</a> != <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>) {
<a name="l02483"></a>02483       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(peer, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l02484"></a>02484    }
<a name="l02485"></a>02485 
<a name="l02486"></a>02486    <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a31438b92e816fd5c5b858f7424205aaa">monitor_ok</a>) {
<a name="l02487"></a>02487       <span class="keyword">const</span> <span class="keywordtype">char</span> *monitor_exec;
<a name="l02488"></a>02488       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *src = NULL;
<a name="l02489"></a>02489       <span class="keywordflow">if</span> (!<a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a>) { 
<a name="l02490"></a>02490          <span class="keywordflow">if</span> (!(<a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a> = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;Monitor&quot;</span>)))
<a name="l02491"></a>02491             <a class="code" href="features_8c.html#a31438b92e816fd5c5b858f7424205aaa">monitor_ok</a>=0;
<a name="l02492"></a>02492       }
<a name="l02493"></a>02493       <span class="keywordflow">if</span> ((monitor_exec = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;AUTO_MONITOR&quot;</span>))) 
<a name="l02494"></a>02494          src = chan;
<a name="l02495"></a>02495       <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((monitor_exec = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(peer, <span class="stringliteral">&quot;AUTO_MONITOR&quot;</span>)))
<a name="l02496"></a>02496          src = peer;
<a name="l02497"></a>02497       <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a> &amp;&amp; src) {
<a name="l02498"></a>02498          <span class="keywordtype">char</span> *tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(monitor_exec);
<a name="l02499"></a>02499          <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(src, <a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a>, tmp);
<a name="l02500"></a>02500       }
<a name="l02501"></a>02501    }
<a name="l02502"></a>02502 
<a name="l02503"></a>02503    <a class="code" href="features_8c.html#ae6d5d03f4835d75bcc1fbc119c646ddb">set_config_flags</a>(chan, peer, config);
<a name="l02504"></a>02504    config-&gt;<a class="code" href="structast__bridge__config.html#a1c72cdec53606007c15bd661d74d07d4">firstpass</a> = 1;
<a name="l02505"></a>02505 
<a name="l02506"></a>02506    <span class="comment">/* Answer if need be */</span>
<a name="l02507"></a>02507    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l02508"></a>02508       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a8b05a8419e1abb88ae5dde4070b6b7f6" title="Answer a channel.">ast_raw_answer</a>(chan, 1)) {
<a name="l02509"></a>02509          <span class="keywordflow">return</span> -1;
<a name="l02510"></a>02510       }
<a name="l02511"></a>02511    }
<a name="l02512"></a>02512 
<a name="l02513"></a>02513    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(orig_channame,chan-&gt;name,<span class="keyword">sizeof</span>(orig_channame));
<a name="l02514"></a>02514    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(orig_peername,peer-&gt;name,<span class="keyword">sizeof</span>(orig_peername));
<a name="l02515"></a>02515    orig_peer_cdr = peer_cdr;
<a name="l02516"></a>02516    
<a name="l02517"></a>02517    <span class="keywordflow">if</span> (!chan_cdr || (chan_cdr &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan_cdr, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>))) {
<a name="l02518"></a>02518       
<a name="l02519"></a>02519       <span class="keywordflow">if</span> (chan_cdr) {
<a name="l02520"></a>02520          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan_cdr, <a class="code" href="cdr_8h.html#a171b52de554369b58cb121312f46bff1">AST_CDR_FLAG_MAIN</a>);
<a name="l02521"></a>02521          <a class="code" href="cdr_8h.html#a92b2e3b685887b48d228f7546ae1a9f1">ast_cdr_update</a>(chan);
<a name="l02522"></a>02522          bridge_cdr = <a class="code" href="cdr_8h.html#a7e8acc90934bc4647dd675a251d9e6ab" title="Duplicate a record.">ast_cdr_dup</a>(chan_cdr);
<a name="l02523"></a>02523          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a>, <span class="stringliteral">&quot;&quot;</span>), <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>));
<a name="l02524"></a>02524          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="stringliteral">&quot;&quot;</span>), <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>));
<a name="l02525"></a>02525          <span class="keywordflow">if</span> (peer_cdr &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>)) {
<a name="l02526"></a>02526             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>, peer_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>));
<a name="l02527"></a>02527          }
<a name="l02528"></a>02528          <span class="keywordflow">if</span> (peer_cdr &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;accountcode)) {
<a name="l02529"></a>02529             <a class="code" href="cdr_8h.html#af6bbc762c1482a5489a761733d785813" title="Set account code, will generate AMI event.">ast_cdr_setaccount</a>(peer, chan-&gt;accountcode);
<a name="l02530"></a>02530          }
<a name="l02531"></a>02531 
<a name="l02532"></a>02532       } <span class="keywordflow">else</span> {
<a name="l02533"></a>02533          <span class="comment">/* better yet, in a xfer situation, find out why the chan cdr got zapped (pun unintentional) */</span>
<a name="l02534"></a>02534          bridge_cdr = <a class="code" href="cdr_8h.html#a29ba08b358224b4c820e5df826273b5b" title="Allocate a CDR record.">ast_cdr_alloc</a>(); <span class="comment">/* this should be really, really rare/impossible? */</span>
<a name="l02535"></a>02535          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>, chan-&gt;name, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>));
<a name="l02536"></a>02536          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>, peer-&gt;name, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>));
<a name="l02537"></a>02537          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#aa7a934e4f070b98b9113d24737a40ec5">uniqueid</a>, chan-&gt;uniqueid, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#aa7a934e4f070b98b9113d24737a40ec5">uniqueid</a>));
<a name="l02538"></a>02538          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a>, <span class="stringliteral">&quot;&quot;</span>), <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>));
<a name="l02539"></a>02539          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="stringliteral">&quot;&quot;</span>), <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>));
<a name="l02540"></a>02540          <a class="code" href="cdr_8h.html#a19f0809fbe171d4223ae48808a27ac15" title="Initialize based on a channel.">ast_cdr_setcid</a>(bridge_cdr, chan);
<a name="l02541"></a>02541          bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a1f9669e5d9d64aa831cd9db2dd71534f">disposition</a> = (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) ?  <a class="code" href="cdr_8h.html#ac7614ef6faaa8b913df85f229f0e037e">AST_CDR_ANSWERED</a> : <a class="code" href="cdr_8h.html#af20894acc82ed87553fc81355890f152">AST_CDR_NULL</a>;
<a name="l02542"></a>02542          bridge_cdr-&gt;<a class="code" href="structast__cdr.html#aa2112d5526f7d98a80d5da0abea1cc7d">amaflags</a> = chan-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> ? chan-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> :  <a class="code" href="cdr_8h.html#a40d6ca75f86ae72a310c1cdceab8d345">ast_default_amaflags</a>;
<a name="l02543"></a>02543          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>, chan-&gt;accountcode, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>));
<a name="l02544"></a>02544          <span class="comment">/* Destination information */</span>
<a name="l02545"></a>02545          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ab30db746a1bf5c869a5dc9dbfaa864d4">dst</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ab30db746a1bf5c869a5dc9dbfaa864d4">dst</a>));
<a name="l02546"></a>02546          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#af27d556683a4a28e6564618bcf00bec1">dcontext</a>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#af27d556683a4a28e6564618bcf00bec1">dcontext</a>));
<a name="l02547"></a>02547          <span class="keywordflow">if</span> (peer_cdr) {
<a name="l02548"></a>02548             bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ad80305b5e16da9c2675d5f057bd69386">start</a> = peer_cdr-&gt;<a class="code" href="structast__cdr.html#ad80305b5e16da9c2675d5f057bd69386">start</a>;
<a name="l02549"></a>02549             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>, peer_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2d480b13820a3a97582a1a138036aa25">userfield</a>));
<a name="l02550"></a>02550          } <span class="keywordflow">else</span> {
<a name="l02551"></a>02551             <a class="code" href="cdr_8h.html#af788ef701483a64b77656f272843bcd4" title="Start a call.">ast_cdr_start</a>(bridge_cdr);
<a name="l02552"></a>02552          }
<a name="l02553"></a>02553       }
<a name="l02554"></a>02554       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4,<span class="stringliteral">&quot;bridge answer set, chan answer set\n&quot;</span>);
<a name="l02555"></a>02555       <span class="comment">/* peer_cdr-&gt;answer will be set when a macro runs on the peer;</span>
<a name="l02556"></a>02556 <span class="comment">         in that case, the bridge answer will be delayed while the</span>
<a name="l02557"></a>02557 <span class="comment">         macro plays on the peer channel. The peer answered the call</span>
<a name="l02558"></a>02558 <span class="comment">         before the macro started playing. To the phone system,</span>
<a name="l02559"></a>02559 <span class="comment">         this is billable time for the call, even tho the caller</span>
<a name="l02560"></a>02560 <span class="comment">         hears nothing but ringing while the macro does its thing. */</span>
<a name="l02561"></a>02561 
<a name="l02562"></a>02562       <span class="comment">/* Another case where the peer cdr&apos;s time will be set, is when</span>
<a name="l02563"></a>02563 <span class="comment">         A self-parks by pickup up phone and dialing 700, then B</span>
<a name="l02564"></a>02564 <span class="comment">         picks up A by dialing its parking slot; there may be more </span>
<a name="l02565"></a>02565 <span class="comment">         practical paths that get the same result, tho... in which</span>
<a name="l02566"></a>02566 <span class="comment">         case you get the previous answer time from the Park... which</span>
<a name="l02567"></a>02567 <span class="comment">         is before the bridge&apos;s start time, so I added in the </span>
<a name="l02568"></a>02568 <span class="comment">         tvcmp check to the if below */</span>
<a name="l02569"></a>02569 
<a name="l02570"></a>02570       <span class="keywordflow">if</span> (peer_cdr &amp;&amp; !<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(peer_cdr-&gt;<a class="code" href="structast__cdr.html#a621c14aed7c59835c5bc93bc88e8f3d9">answer</a>) &amp;&amp; <a class="code" href="time_8h.html#acc9e13e54ed18f92956c748a38f82430" title="Compres two struct timeval instances returning -1, 0, 1 if the first arg is smaller...">ast_tvcmp</a>(peer_cdr-&gt;<a class="code" href="structast__cdr.html#a621c14aed7c59835c5bc93bc88e8f3d9">answer</a>, bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ad80305b5e16da9c2675d5f057bd69386">start</a>) &gt;= 0) {
<a name="l02571"></a>02571          bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a621c14aed7c59835c5bc93bc88e8f3d9">answer</a> = peer_cdr-&gt;<a class="code" href="structast__cdr.html#a621c14aed7c59835c5bc93bc88e8f3d9">answer</a>;
<a name="l02572"></a>02572          bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a1f9669e5d9d64aa831cd9db2dd71534f">disposition</a> = peer_cdr-&gt;<a class="code" href="structast__cdr.html#a1f9669e5d9d64aa831cd9db2dd71534f">disposition</a>;
<a name="l02573"></a>02573          <span class="keywordflow">if</span> (chan_cdr) {
<a name="l02574"></a>02574             chan_cdr-&gt;<a class="code" href="structast__cdr.html#a621c14aed7c59835c5bc93bc88e8f3d9">answer</a> = peer_cdr-&gt;<a class="code" href="structast__cdr.html#a621c14aed7c59835c5bc93bc88e8f3d9">answer</a>;
<a name="l02575"></a>02575             chan_cdr-&gt;<a class="code" href="structast__cdr.html#a1f9669e5d9d64aa831cd9db2dd71534f">disposition</a> = peer_cdr-&gt;<a class="code" href="structast__cdr.html#a1f9669e5d9d64aa831cd9db2dd71534f">disposition</a>;
<a name="l02576"></a>02576          }
<a name="l02577"></a>02577       } <span class="keywordflow">else</span> {
<a name="l02578"></a>02578          <a class="code" href="cdr_8h.html#afec38ce5d72ac5bfda689d3a2c877012" title="Answer a call.">ast_cdr_answer</a>(bridge_cdr);
<a name="l02579"></a>02579          <span class="keywordflow">if</span> (chan_cdr) {
<a name="l02580"></a>02580             <a class="code" href="cdr_8h.html#afec38ce5d72ac5bfda689d3a2c877012" title="Answer a call.">ast_cdr_answer</a>(chan_cdr); <span class="comment">/* for the sake of cli status checks */</span>
<a name="l02581"></a>02581          }
<a name="l02582"></a>02582       }
<a name="l02583"></a>02583       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan,<a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a833a312f49eac50f239fd42dc9e61ffb">AST_FLAG_BRIDGE_HANGUP_DONT</a>) &amp;&amp; (chan_cdr || peer_cdr)) {
<a name="l02584"></a>02584          <span class="keywordflow">if</span> (chan_cdr) {
<a name="l02585"></a>02585             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan_cdr, <a class="code" href="cdr_8h.html#a61e17153131c3f7832cf2f3224fcfec4">AST_CDR_FLAG_BRIDGED</a>);
<a name="l02586"></a>02586          }
<a name="l02587"></a>02587          <span class="keywordflow">if</span> (peer_cdr) {
<a name="l02588"></a>02588             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer_cdr, <a class="code" href="cdr_8h.html#a61e17153131c3f7832cf2f3224fcfec4">AST_CDR_FLAG_BRIDGED</a>);
<a name="l02589"></a>02589          }
<a name="l02590"></a>02590       }
<a name="l02591"></a>02591    }
<a name="l02592"></a>02592    <span class="keywordflow">for</span> (;;) {
<a name="l02593"></a>02593       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *other; <span class="comment">/* used later */</span>
<a name="l02594"></a>02594    
<a name="l02595"></a>02595       res = <a class="code" href="channel_8h.html#a475a9c0a7714ec4499b2fab283388a69" title="Bridge two channels together.">ast_channel_bridge</a>(chan, peer, config, &amp;f, &amp;who);
<a name="l02596"></a>02596       
<a name="l02597"></a>02597       <span class="comment">/* When frame is not set, we are probably involved in a situation</span>
<a name="l02598"></a>02598 <span class="comment">         where we&apos;ve timed out.</span>
<a name="l02599"></a>02599 <span class="comment">         When frame is set, we&apos;ll come this code twice; once for DTMF_BEGIN</span>
<a name="l02600"></a>02600 <span class="comment">         and also for DTMF_END. If we flow into the following &apos;if&apos; for both, then </span>
<a name="l02601"></a>02601 <span class="comment">         our wait times are cut in half, as both will subtract from the</span>
<a name="l02602"></a>02602 <span class="comment">         feature_timer. Not good!</span>
<a name="l02603"></a>02603 <span class="comment">      */</span>
<a name="l02604"></a>02604       <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> &amp;&amp; (!f || f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>)) {
<a name="l02605"></a>02605          <span class="comment">/* Update time limit for next pass */</span>
<a name="l02606"></a>02606          diff = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), config-&gt;<a class="code" href="structast__bridge__config.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a>);
<a name="l02607"></a>02607          <span class="keywordflow">if</span> (res == <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ac83c1441a620f7bdae5ef84692f8e7a5">AST_BRIDGE_RETRY</a>) {
<a name="l02608"></a>02608             <span class="comment">/* The feature fully timed out but has not been updated. Skip</span>
<a name="l02609"></a>02609 <span class="comment">             * the potential round error from the diff calculation and</span>
<a name="l02610"></a>02610 <span class="comment">             * explicitly set to expired. */</span>
<a name="l02611"></a>02611             config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> = -1;
<a name="l02612"></a>02612          } <span class="keywordflow">else</span> {
<a name="l02613"></a>02613             config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> -= diff;
<a name="l02614"></a>02614          }
<a name="l02615"></a>02615 
<a name="l02616"></a>02616          <span class="keywordflow">if</span> (hasfeatures) {
<a name="l02617"></a>02617             <span class="comment">/* Running on backup config, meaning a feature might be being</span>
<a name="l02618"></a>02618 <span class="comment">               activated, but that&apos;s no excuse to keep things going </span>
<a name="l02619"></a>02619 <span class="comment">               indefinitely! */</span>
<a name="l02620"></a>02620             <span class="keywordflow">if</span> (backup_config.feature_timer &amp;&amp; ((backup_config.feature_timer -= diff) &lt;= 0)) {
<a name="l02621"></a>02621                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Timed out, realtime this time!\n&quot;</span>);
<a name="l02622"></a>02622                config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> = 0;
<a name="l02623"></a>02623                who = chan;
<a name="l02624"></a>02624                <span class="keywordflow">if</span> (f)
<a name="l02625"></a>02625                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02626"></a>02626                f = NULL;
<a name="l02627"></a>02627                res = 0;
<a name="l02628"></a>02628             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> &lt;= 0) {
<a name="l02629"></a>02629                <span class="comment">/* Not *really* out of time, just out of time for</span>
<a name="l02630"></a>02630 <span class="comment">                  digits to come in for features. */</span>
<a name="l02631"></a>02631                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Timed out for feature!\n&quot;</span>);
<a name="l02632"></a>02632                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer_featurecode)) {
<a name="l02633"></a>02633                   <a class="code" href="app_8h.html#af20b8ac2e28e659be352bbaecdf0ab03" title="Send DTMF to a channel.">ast_dtmf_stream</a>(chan, peer, peer_featurecode, 0, 0);
<a name="l02634"></a>02634                   memset(peer_featurecode, 0, <span class="keyword">sizeof</span>(peer_featurecode));
<a name="l02635"></a>02635                }
<a name="l02636"></a>02636                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan_featurecode)) {
<a name="l02637"></a>02637                   <a class="code" href="app_8h.html#af20b8ac2e28e659be352bbaecdf0ab03" title="Send DTMF to a channel.">ast_dtmf_stream</a>(peer, chan, chan_featurecode, 0, 0);
<a name="l02638"></a>02638                   memset(chan_featurecode, 0, <span class="keyword">sizeof</span>(chan_featurecode));
<a name="l02639"></a>02639                }
<a name="l02640"></a>02640                <span class="keywordflow">if</span> (f)
<a name="l02641"></a>02641                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02642"></a>02642                hasfeatures = !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan_featurecode) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer_featurecode);
<a name="l02643"></a>02643                <span class="keywordflow">if</span> (!hasfeatures) {
<a name="l02644"></a>02644                   <span class="comment">/* Restore original (possibly time modified) bridge config */</span>
<a name="l02645"></a>02645                   memcpy(config, &amp;backup_config, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a>));
<a name="l02646"></a>02646                   memset(&amp;backup_config, 0, <span class="keyword">sizeof</span>(backup_config));
<a name="l02647"></a>02647                }
<a name="l02648"></a>02648                hadfeatures = hasfeatures;
<a name="l02649"></a>02649                <span class="comment">/* Continue as we were */</span>
<a name="l02650"></a>02650                <span class="keywordflow">continue</span>;
<a name="l02651"></a>02651             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!f) {
<a name="l02652"></a>02652                <span class="comment">/* The bridge returned without a frame and there is a feature in progress.</span>
<a name="l02653"></a>02653 <span class="comment">                * However, we don&apos;t think the feature has quite yet timed out, so just</span>
<a name="l02654"></a>02654 <span class="comment">                * go back into the bridge. */</span>
<a name="l02655"></a>02655                <span class="keywordflow">continue</span>;
<a name="l02656"></a>02656             }
<a name="l02657"></a>02657          } <span class="keywordflow">else</span> {
<a name="l02658"></a>02658             <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> &lt;=0) {
<a name="l02659"></a>02659                <span class="comment">/* We ran out of time */</span>
<a name="l02660"></a>02660                config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> = 0;
<a name="l02661"></a>02661                who = chan;
<a name="l02662"></a>02662                <span class="keywordflow">if</span> (f)
<a name="l02663"></a>02663                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02664"></a>02664                f = NULL;
<a name="l02665"></a>02665                res = 0;
<a name="l02666"></a>02666             }
<a name="l02667"></a>02667          }
<a name="l02668"></a>02668       }
<a name="l02669"></a>02669       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l02670"></a>02670          <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a26796fa52cc5857446eec8d16a4b718d">AST_FLAG_ZOMBIE</a>) &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a26796fa52cc5857446eec8d16a4b718d">AST_FLAG_ZOMBIE</a>) &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan) &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(peer))
<a name="l02671"></a>02671             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Bridge failed on channels %s and %s\n&quot;</span>, chan-&gt;name, peer-&gt;name);
<a name="l02672"></a>02672          <span class="keywordflow">goto</span> before_you_go;
<a name="l02673"></a>02673       }
<a name="l02674"></a>02674       
<a name="l02675"></a>02675       <span class="keywordflow">if</span> (!f || (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a> &amp;&amp;
<a name="l02676"></a>02676             (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a> || f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a> || 
<a name="l02677"></a>02677                f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>))) {
<a name="l02678"></a>02678          res = -1;
<a name="l02679"></a>02679          <span class="keywordflow">break</span>;
<a name="l02680"></a>02680       }
<a name="l02681"></a>02681       <span class="comment">/* many things should be sent to the &apos;other&apos; channel */</span>
<a name="l02682"></a>02682       other = (who == chan) ? peer : chan;
<a name="l02683"></a>02683       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) {
<a name="l02684"></a>02684          <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l02685"></a>02685          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>:
<a name="l02686"></a>02686          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a>:
<a name="l02687"></a>02687          <span class="keywordflow">case</span> -1:
<a name="l02688"></a>02688             <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(other, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l02689"></a>02689             <span class="keywordflow">break</span>;
<a name="l02690"></a>02690          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l02691"></a>02691          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>:
<a name="l02692"></a>02692             <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(other, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l02693"></a>02693             <span class="keywordflow">break</span>;
<a name="l02694"></a>02694          <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ac4106406e269667ff84ee49e0a634f94">AST_CONTROL_OPTION</a>:
<a name="l02695"></a>02695             aoh = f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;
<a name="l02696"></a>02696             <span class="comment">/* Forward option Requests */</span>
<a name="l02697"></a>02697             <span class="keywordflow">if</span> (aoh &amp;&amp; aoh-&gt;flag == <a class="code" href="frame_8h.html#aaec646e296938635ffb97c5c7d6b05c8">AST_OPTION_FLAG_REQUEST</a>) {
<a name="l02698"></a>02698                <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(other, ntohs(aoh-&gt;option), aoh-&gt;<a class="code" href="structast__option__header.html#ac3c027f9a365f5741871df5ace13943f">data</a>, 
<a name="l02699"></a>02699                   f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__option__header.html">ast_option_header</a>), 0);
<a name="l02700"></a>02700             }
<a name="l02701"></a>02701             <span class="keywordflow">break</span>;
<a name="l02702"></a>02702          }
<a name="l02703"></a>02703       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>) {
<a name="l02704"></a>02704          <span class="comment">/* eat it */</span>
<a name="l02705"></a>02705       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l02706"></a>02706          <span class="keywordtype">char</span> *featurecode;
<a name="l02707"></a>02707          <span class="keywordtype">int</span> sense;
<a name="l02708"></a>02708 
<a name="l02709"></a>02709          hadfeatures = hasfeatures;
<a name="l02710"></a>02710          <span class="comment">/* This cannot overrun because the longest feature is one shorter than our buffer */</span>
<a name="l02711"></a>02711          <span class="keywordflow">if</span> (who == chan) {
<a name="l02712"></a>02712             sense = <a class="code" href="features_8c.html#a43d76622becf50779cbf68a3419a42e5">FEATURE_SENSE_CHAN</a>;
<a name="l02713"></a>02713             featurecode = chan_featurecode;
<a name="l02714"></a>02714          } <span class="keywordflow">else</span>  {
<a name="l02715"></a>02715             sense = <a class="code" href="features_8c.html#a715d6b99230466c16f14e1d0fa77ffac">FEATURE_SENSE_PEER</a>;
<a name="l02716"></a>02716             featurecode = peer_featurecode;
<a name="l02717"></a>02717          }<span class="comment"></span>
<a name="l02718"></a>02718 <span class="comment">         /*! append the event to featurecode. we rely on the string being zero-filled, and</span>
<a name="l02719"></a>02719 <span class="comment">          * not overflowing it. </span>
<a name="l02720"></a>02720 <span class="comment">          * \todo XXX how do we guarantee the latter ?</span>
<a name="l02721"></a>02721 <span class="comment">          */</span>
<a name="l02722"></a>02722          featurecode[strlen(featurecode)] = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02723"></a>02723          <span class="comment">/* Get rid of the frame before we start doing &quot;stuff&quot; with the channels */</span>
<a name="l02724"></a>02724          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02725"></a>02725          f = NULL;
<a name="l02726"></a>02726          config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> = backup_config.feature_timer;
<a name="l02727"></a>02727          res = <a class="code" href="features_8c.html#ae89302e12bbcc8ffec898244cc3b73fe" title="Check the dynamic features.">feature_interpret</a>(chan, peer, config, featurecode, sense);
<a name="l02728"></a>02728          <span class="keywordflow">switch</span>(res) {
<a name="l02729"></a>02729          <span class="keywordflow">case</span> <a class="code" href="features_8h.html#a6fe63cc369dcb5f31ee37b64cc68d4b2">AST_FEATURE_RETURN_PASSDIGITS</a>:
<a name="l02730"></a>02730             <a class="code" href="app_8h.html#af20b8ac2e28e659be352bbaecdf0ab03" title="Send DTMF to a channel.">ast_dtmf_stream</a>(other, who, featurecode, 0, 0);
<a name="l02731"></a>02731             <span class="comment">/* Fall through */</span>
<a name="l02732"></a>02732          <span class="keywordflow">case</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>:
<a name="l02733"></a>02733             memset(featurecode, 0, <span class="keyword">sizeof</span>(chan_featurecode));
<a name="l02734"></a>02734             <span class="keywordflow">break</span>;
<a name="l02735"></a>02735          }
<a name="l02736"></a>02736          <span class="keywordflow">if</span> (res &gt;= <a class="code" href="features_8h.html#a6fe63cc369dcb5f31ee37b64cc68d4b2">AST_FEATURE_RETURN_PASSDIGITS</a>) {
<a name="l02737"></a>02737             res = 0;
<a name="l02738"></a>02738          } <span class="keywordflow">else</span> 
<a name="l02739"></a>02739             <span class="keywordflow">break</span>;
<a name="l02740"></a>02740          hasfeatures = !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan_featurecode) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer_featurecode);
<a name="l02741"></a>02741          <span class="keywordflow">if</span> (hadfeatures &amp;&amp; !hasfeatures) {
<a name="l02742"></a>02742             <span class="comment">/* Restore backup */</span>
<a name="l02743"></a>02743             memcpy(config, &amp;backup_config, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a>));
<a name="l02744"></a>02744             memset(&amp;backup_config, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a>));
<a name="l02745"></a>02745          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (hasfeatures) {
<a name="l02746"></a>02746             <span class="keywordflow">if</span> (!hadfeatures) {
<a name="l02747"></a>02747                <span class="comment">/* Backup configuration */</span>
<a name="l02748"></a>02748                memcpy(&amp;backup_config, config, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a>));
<a name="l02749"></a>02749                <span class="comment">/* Setup temporary config options */</span>
<a name="l02750"></a>02750                config-&gt;<a class="code" href="structast__bridge__config.html#af3d16394c849390df1c8f72569faeb37">play_warning</a> = 0;
<a name="l02751"></a>02751                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae6373d88ce4e9e5d9b7031272a9bc5ab">AST_FEATURE_PLAY_WARNING</a>);
<a name="l02752"></a>02752                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae6373d88ce4e9e5d9b7031272a9bc5ab">AST_FEATURE_PLAY_WARNING</a>);
<a name="l02753"></a>02753                config-&gt;<a class="code" href="structast__bridge__config.html#abc09654c9b36de6b0bd0bfd92d31c0c0">warning_freq</a> = 0;
<a name="l02754"></a>02754                config-&gt;<a class="code" href="structast__bridge__config.html#a1fa6cb6235cf4abe198a8561e3c18bae">warning_sound</a> = NULL;
<a name="l02755"></a>02755                config-&gt;<a class="code" href="structast__bridge__config.html#a0b23b4ebfc857809d07d1ced94c9a6eb">end_sound</a> = NULL;
<a name="l02756"></a>02756                config-&gt;<a class="code" href="structast__bridge__config.html#af134a8361d8611e10872c9c0f806ba64">start_sound</a> = NULL;
<a name="l02757"></a>02757                config-&gt;<a class="code" href="structast__bridge__config.html#a1c72cdec53606007c15bd661d74d07d4">firstpass</a> = 0;
<a name="l02758"></a>02758             }
<a name="l02759"></a>02759             config-&gt;<a class="code" href="structast__bridge__config.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02760"></a>02760             config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a> = <a class="code" href="features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a>;
<a name="l02761"></a>02761             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Set time limit to %ld\n&quot;</span>, config-&gt;<a class="code" href="structast__bridge__config.html#af083a5b636f7b870cea1aea1eeadf6ff">feature_timer</a>);
<a name="l02762"></a>02762          }
<a name="l02763"></a>02763       }
<a name="l02764"></a>02764       <span class="keywordflow">if</span> (f)
<a name="l02765"></a>02765          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02766"></a>02766 
<a name="l02767"></a>02767    }
<a name="l02768"></a>02768    before_you_go:
<a name="l02769"></a>02769 
<a name="l02770"></a>02770    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan,<a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a833a312f49eac50f239fd42dc9e61ffb">AST_FLAG_BRIDGE_HANGUP_DONT</a>)) {
<a name="l02771"></a>02771       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan,<a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a833a312f49eac50f239fd42dc9e61ffb">AST_FLAG_BRIDGE_HANGUP_DONT</a>); <span class="comment">/* its job is done */</span>
<a name="l02772"></a>02772       <span class="keywordflow">if</span> (bridge_cdr) {
<a name="l02773"></a>02773          <a class="code" href="cdr_8h.html#a0a672ffbd29adf8622596a36ccb25e65" title="Discard and free a CDR record.">ast_cdr_discard</a>(bridge_cdr);
<a name="l02774"></a>02774          <span class="comment">/* QUESTION: should we copy bridge_cdr fields to the peer before we throw it away? */</span>
<a name="l02775"></a>02775       }
<a name="l02776"></a>02776       <span class="keywordflow">return</span> res; <span class="comment">/* if we shouldn&apos;t do the h-exten, we shouldn&apos;t do the bridge cdr, either! */</span>
<a name="l02777"></a>02777    }
<a name="l02778"></a>02778 
<a name="l02779"></a>02779    <span class="keywordflow">if</span> (config-&gt;<a class="code" href="structast__bridge__config.html#a03acb9e092c45d88e1fb9e146e5e554e">end_bridge_callback</a>) {
<a name="l02780"></a>02780       config-&gt;<a class="code" href="structast__bridge__config.html#a03acb9e092c45d88e1fb9e146e5e554e">end_bridge_callback</a>(config-&gt;<a class="code" href="structast__bridge__config.html#a30cb875f49910a9515ee92d8dfdf8b83">end_bridge_callback_data</a>);
<a name="l02781"></a>02781    }
<a name="l02782"></a>02782 
<a name="l02783"></a>02783    <span class="comment">/* run the hangup exten on the chan object IFF it was NOT involved in a parking situation </span>
<a name="l02784"></a>02784 <span class="comment">    * if it were, then chan belongs to a different thread now, and might have been hung up long</span>
<a name="l02785"></a>02785 <span class="comment">     * ago.</span>
<a name="l02786"></a>02786 <span class="comment">    */</span>
<a name="l02787"></a>02787    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>),<a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a84500213ed3a17d1959c36062a7ba474">AST_FEATURE_NO_H_EXTEN</a>) &amp;&amp;
<a name="l02788"></a>02788       <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;h&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l02789"></a>02789       <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *swapper = NULL;
<a name="l02790"></a>02790       <span class="keywordtype">char</span> savelastapp[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l02791"></a>02791       <span class="keywordtype">char</span> savelastdata[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l02792"></a>02792       <span class="keywordtype">char</span> save_exten[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l02793"></a>02793       <span class="keywordtype">int</span>  save_prio;
<a name="l02794"></a>02794       <span class="keywordtype">int</span>  found = 0;   <span class="comment">/* set if we find at least one match */</span>
<a name="l02795"></a>02795       <span class="keywordtype">int</span>  spawn_error = 0;
<a name="l02796"></a>02796       
<a name="l02797"></a>02797       autoloopflag = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>);
<a name="l02798"></a>02798       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>);
<a name="l02799"></a>02799       <span class="keywordflow">if</span> (bridge_cdr &amp;&amp; <a class="code" href="options_8h.html#ac4df5fcd7bf0175ad37e2da65e91e75b">ast_opt_end_cdr_before_h_exten</a>) {
<a name="l02800"></a>02800          <a class="code" href="cdr_8h.html#a9884cbdaef20e9f266bc2220772bf52b" title="End a call.">ast_cdr_end</a>(bridge_cdr);
<a name="l02801"></a>02801       }
<a name="l02802"></a>02802       <span class="comment">/* swap the bridge cdr and the chan cdr for a moment, and let the endbridge</span>
<a name="l02803"></a>02803 <span class="comment">         dialplan code operate on it */</span>
<a name="l02804"></a>02804       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02805"></a>02805       <span class="keywordflow">if</span> (bridge_cdr) {
<a name="l02806"></a>02806          swapper = chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>;
<a name="l02807"></a>02807          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(savelastapp, bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>));
<a name="l02808"></a>02808          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(savelastdata, bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>));
<a name="l02809"></a>02809          chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = bridge_cdr;
<a name="l02810"></a>02810       }
<a name="l02811"></a>02811       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(save_exten, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(save_exten));
<a name="l02812"></a>02812       save_prio = chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l02813"></a>02813       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;h&quot;</span>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l02814"></a>02814       chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 1;
<a name="l02815"></a>02815       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02816"></a>02816       <span class="keywordflow">while</span> ((spawn_error = <a class="code" href="pbx_8h.html#a94ca71e502d95d1cb0a815072e059aee" title="Launch a new extension (i.e. new stack).">ast_spawn_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, &amp;found, 1)) == 0) {
<a name="l02817"></a>02817          chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>++;
<a name="l02818"></a>02818       }
<a name="l02819"></a>02819       <span class="keywordflow">if</span> (spawn_error &amp;&amp; (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan))) {
<a name="l02820"></a>02820          <span class="comment">/* if the extension doesn&apos;t exist or a hangup occurred, this isn&apos;t really a spawn error */</span>
<a name="l02821"></a>02821          spawn_error = 0;
<a name="l02822"></a>02822       }
<a name="l02823"></a>02823       <span class="keywordflow">if</span> (found &amp;&amp; spawn_error) {
<a name="l02824"></a>02824          <span class="comment">/* Something bad happened, or a hangup has been requested. */</span>
<a name="l02825"></a>02825          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Spawn extension (%s,%s,%d) exited non-zero on &apos;%s&apos;\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, chan-&gt;name);
<a name="l02826"></a>02826          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Spawn extension (%s, %s, %d) exited non-zero on &apos;%s&apos;\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, chan-&gt;name);
<a name="l02827"></a>02827       }
<a name="l02828"></a>02828       <span class="comment">/* swap it back */</span>
<a name="l02829"></a>02829       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02830"></a>02830       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, save_exten, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l02831"></a>02831       chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = save_prio;
<a name="l02832"></a>02832       <span class="keywordflow">if</span> (bridge_cdr) {
<a name="l02833"></a>02833          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> == bridge_cdr) {
<a name="l02834"></a>02834             chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = swapper;
<a name="l02835"></a>02835          } <span class="keywordflow">else</span> {
<a name="l02836"></a>02836             bridge_cdr = NULL;
<a name="l02837"></a>02837          }
<a name="l02838"></a>02838       }
<a name="l02839"></a>02839       <span class="keywordflow">if</span> (!spawn_error) {
<a name="l02840"></a>02840          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a3f96b2798b1f93fa27bc2dff7dfd9a26">AST_FLAG_BRIDGE_HANGUP_RUN</a>);
<a name="l02841"></a>02841       }
<a name="l02842"></a>02842       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02843"></a>02843       <span class="comment">/* protect the lastapp/lastdata against the effects of the hangup/dialplan code */</span>
<a name="l02844"></a>02844       <span class="keywordflow">if</span> (bridge_cdr) {
<a name="l02845"></a>02845          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, savelastapp, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>));
<a name="l02846"></a>02846          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, savelastdata, <span class="keyword">sizeof</span>(bridge_cdr-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>));
<a name="l02847"></a>02847       }
<a name="l02848"></a>02848       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(chan, autoloopflag, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a5ff4f7a94a36fcc2b8628186cb643d4b">AST_FLAG_IN_AUTOLOOP</a>);
<a name="l02849"></a>02849    }
<a name="l02850"></a>02850    
<a name="l02851"></a>02851    <span class="comment">/* obey the NoCDR() wishes. -- move the DISABLED flag to the bridge CDR if it was set on the channel during the bridge... */</span>
<a name="l02852"></a>02852    new_chan_cdr = <a class="code" href="features_8c.html#a82ec1e5a1738ece6284922cf189ce3f2" title="return the first unlocked cdr in a possible chain">pick_unlocked_cdr</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>); <span class="comment">/* the proper chan cdr, if there are forked cdrs */</span>
<a name="l02853"></a>02853    <span class="keywordflow">if</span> (bridge_cdr &amp;&amp; new_chan_cdr &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(new_chan_cdr, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>))
<a name="l02854"></a>02854       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(bridge_cdr, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>);
<a name="l02855"></a>02855 
<a name="l02856"></a>02856    <span class="comment">/* we can post the bridge CDR at this point */</span>
<a name="l02857"></a>02857    <span class="keywordflow">if</span> (bridge_cdr) {
<a name="l02858"></a>02858       <a class="code" href="cdr_8h.html#a9884cbdaef20e9f266bc2220772bf52b" title="End a call.">ast_cdr_end</a>(bridge_cdr);
<a name="l02859"></a>02859       <a class="code" href="cdr_8h.html#aaac5bba86e430704119f70df937701f8" title="Detaches the detail record for posting (and freeing) either now or at a later time...">ast_cdr_detach</a>(bridge_cdr);
<a name="l02860"></a>02860    }
<a name="l02861"></a>02861    
<a name="l02862"></a>02862    <span class="comment">/* do a specialized reset on the beginning channel</span>
<a name="l02863"></a>02863 <span class="comment">      CDR&apos;s, if they still exist, so as not to mess up</span>
<a name="l02864"></a>02864 <span class="comment">      issues in future bridges;</span>
<a name="l02865"></a>02865 <span class="comment">      </span>
<a name="l02866"></a>02866 <span class="comment">      Here are the rules of the game:</span>
<a name="l02867"></a>02867 <span class="comment">      1. The chan and peer channel pointers will not change</span>
<a name="l02868"></a>02868 <span class="comment">         during the life of the bridge.</span>
<a name="l02869"></a>02869 <span class="comment">      2. But, in transfers, the channel names will change.</span>
<a name="l02870"></a>02870 <span class="comment">         between the time the bridge is started, and the</span>
<a name="l02871"></a>02871 <span class="comment">         time the channel ends. </span>
<a name="l02872"></a>02872 <span class="comment">         Usually, when a channel changes names, it will</span>
<a name="l02873"></a>02873 <span class="comment">         also change CDR pointers.</span>
<a name="l02874"></a>02874 <span class="comment">      3. Usually, only one of the two channels (chan or peer)</span>
<a name="l02875"></a>02875 <span class="comment">         will change names.</span>
<a name="l02876"></a>02876 <span class="comment">      4. Usually, if a channel changes names during a bridge,</span>
<a name="l02877"></a>02877 <span class="comment">         it is because of a transfer. Usually, in these situations,</span>
<a name="l02878"></a>02878 <span class="comment">         it is normal to see 2 bridges running simultaneously, and</span>
<a name="l02879"></a>02879 <span class="comment">         it is not unusual to see the two channels that change</span>
<a name="l02880"></a>02880 <span class="comment">         swapped between bridges.</span>
<a name="l02881"></a>02881 <span class="comment">      5. After a bridge occurs, we have 2 or 3 channels&apos; CDRs</span>
<a name="l02882"></a>02882 <span class="comment">         to attend to; if the chan or peer changed names,</span>
<a name="l02883"></a>02883 <span class="comment">         we have the before and after attached CDR&apos;s.</span>
<a name="l02884"></a>02884 <span class="comment">   */</span>
<a name="l02885"></a>02885    
<a name="l02886"></a>02886    <span class="keywordflow">if</span> (new_chan_cdr) {
<a name="l02887"></a>02887       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan_ptr = NULL;
<a name="l02888"></a>02888  
<a name="l02889"></a>02889       <span class="keywordflow">if</span> (strcasecmp(orig_channame, chan-&gt;name) != 0) { 
<a name="l02890"></a>02890          <span class="comment">/* old channel */</span>
<a name="l02891"></a>02891          chan_ptr = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(orig_channame);
<a name="l02892"></a>02892          <span class="keywordflow">if</span> (chan_ptr) {
<a name="l02893"></a>02893             <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(chan_ptr)) {
<a name="l02894"></a>02894                <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *cur;
<a name="l02895"></a>02895                <span class="keywordflow">for</span> (cur = chan_ptr-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>; cur; cur = cur-&gt;<a class="code" href="structast__cdr.html#a8098d02138e27b57d184b260b6669eed">next</a>) {
<a name="l02896"></a>02896                   <span class="keywordflow">if</span> (cur == chan_cdr) {
<a name="l02897"></a>02897                      <span class="keywordflow">break</span>;
<a name="l02898"></a>02898                   }
<a name="l02899"></a>02899                }
<a name="l02900"></a>02900                <span class="keywordflow">if</span> (cur)
<a name="l02901"></a>02901                   <a class="code" href="cdr_8h.html#af676cf6077871ee6988a5defa6f81798">ast_cdr_specialized_reset</a>(chan_cdr,0);
<a name="l02902"></a>02902             }
<a name="l02903"></a>02903             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan_ptr);
<a name="l02904"></a>02904          }
<a name="l02905"></a>02905          <span class="comment">/* new channel */</span>
<a name="l02906"></a>02906          <a class="code" href="cdr_8h.html#af676cf6077871ee6988a5defa6f81798">ast_cdr_specialized_reset</a>(new_chan_cdr,0);
<a name="l02907"></a>02907       } <span class="keywordflow">else</span> {
<a name="l02908"></a>02908          <a class="code" href="cdr_8h.html#af676cf6077871ee6988a5defa6f81798">ast_cdr_specialized_reset</a>(chan_cdr,0); <span class="comment">/* nothing changed, reset the chan_cdr  */</span>
<a name="l02909"></a>02909       }
<a name="l02910"></a>02910    }
<a name="l02911"></a>02911    
<a name="l02912"></a>02912    {
<a name="l02913"></a>02913       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan_ptr = NULL;
<a name="l02914"></a>02914       new_peer_cdr = <a class="code" href="features_8c.html#a82ec1e5a1738ece6284922cf189ce3f2" title="return the first unlocked cdr in a possible chain">pick_unlocked_cdr</a>(peer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>); <span class="comment">/* the proper chan cdr, if there are forked cdrs */</span>
<a name="l02915"></a>02915       <span class="keywordflow">if</span> (new_chan_cdr &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(new_chan_cdr, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>) &amp;&amp; new_peer_cdr &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(new_peer_cdr, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>))
<a name="l02916"></a>02916          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(new_peer_cdr, <a class="code" href="cdr_8h.html#ad1c97f787a4ae3481dd9b48fef118572">AST_CDR_FLAG_POST_DISABLED</a>); <span class="comment">/* DISABLED is viral-- it will propagate across a bridge */</span>
<a name="l02917"></a>02917       <span class="keywordflow">if</span> (strcasecmp(orig_peername, peer-&gt;name) != 0) { 
<a name="l02918"></a>02918          <span class="comment">/* old channel */</span>
<a name="l02919"></a>02919          chan_ptr = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(orig_peername);
<a name="l02920"></a>02920          <span class="keywordflow">if</span> (chan_ptr) {
<a name="l02921"></a>02921             <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(chan_ptr)) {
<a name="l02922"></a>02922                <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *cur;
<a name="l02923"></a>02923                <span class="keywordflow">for</span> (cur = chan_ptr-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>; cur; cur = cur-&gt;<a class="code" href="structast__cdr.html#a8098d02138e27b57d184b260b6669eed">next</a>) {
<a name="l02924"></a>02924                   <span class="keywordflow">if</span> (cur == peer_cdr) {
<a name="l02925"></a>02925                      <span class="keywordflow">break</span>;
<a name="l02926"></a>02926                   }
<a name="l02927"></a>02927                }
<a name="l02928"></a>02928                <span class="keywordflow">if</span> (cur)
<a name="l02929"></a>02929                   <a class="code" href="cdr_8h.html#af676cf6077871ee6988a5defa6f81798">ast_cdr_specialized_reset</a>(peer_cdr,0);
<a name="l02930"></a>02930             }
<a name="l02931"></a>02931             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan_ptr);
<a name="l02932"></a>02932          }
<a name="l02933"></a>02933          <span class="comment">/* new channel */</span>
<a name="l02934"></a>02934          <span class="keywordflow">if</span> (new_peer_cdr) {
<a name="l02935"></a>02935             <a class="code" href="cdr_8h.html#af676cf6077871ee6988a5defa6f81798">ast_cdr_specialized_reset</a>(new_peer_cdr, 0);
<a name="l02936"></a>02936          }
<a name="l02937"></a>02937       } <span class="keywordflow">else</span> {
<a name="l02938"></a>02938          <a class="code" href="cdr_8h.html#af676cf6077871ee6988a5defa6f81798">ast_cdr_specialized_reset</a>(peer_cdr,0); <span class="comment">/* nothing changed, reset the peer_cdr  */</span>
<a name="l02939"></a>02939       }
<a name="l02940"></a>02940    }
<a name="l02941"></a>02941    
<a name="l02942"></a>02942    <span class="keywordflow">return</span> res;
<a name="l02943"></a>02943 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6b2ac231f2658dd8169218a8e4cad4ae"></a><!-- doxytag: member="features.c::ast_features_init" ref="a6b2ac231f2658dd8169218a8e4cad4ae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_features_init </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Provided by <a class="el" href="features_8c.html" title="Routines implementing call features as call pickup, parking and transfer.">features.c</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l04642">4642</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l04156">action_bridge()</a>, <a class="el" href="astobj2_8h_source.html#l00727">ao2_container_alloc</a>, <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="cli_8c_source.html#l01927">ast_cli_register_multiple()</a>, <a class="el" href="devicestate_8c_source.html#l00369">ast_devstate_prov_add()</a>, <a class="el" href="manager_8h_source.html#l00133">ast_manager_register</a>, <a class="el" href="manager_8c_source.html#l03448">ast_manager_register2()</a>, <a class="el" href="utils_8h_source.html#l00376">ast_pthread_create</a>, <a class="el" href="pbx_8c_source.html#l05062">ast_register_application2()</a>, <a class="el" href="features_8c_source.html#l04524">bridge_exec()</a>, <a class="el" href="features_8c_source.html#l03189">do_parking_thread()</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="features_8c_source.html#l03672">load_config()</a>, <a class="el" href="features_8c_source.html#l04401">manager_park()</a>, <a class="el" href="features_8c_source.html#l04340">manager_parking_status()</a>, <a class="el" href="features_8c_source.html#l00519">metermaidstate()</a>, <a class="el" href="features_8c_source.html#l03249">park_call_exec()</a>, <a class="el" href="features_8c_source.html#l03502">park_exec()</a>, <a class="el" href="features_8c_source.html#l00262">parkcall</a>, <a class="el" href="features_8c_source.html#l00192">parkedcall</a>, <a class="el" href="features_8c_source.html#l00273">parking_thread</a>, <a class="el" href="features_8c_source.html#l00340">parkinglot_cmp_cb()</a>, <a class="el" href="features_8c_source.html#l00333">parkinglot_hash_cb()</a>, and <a class="el" href="features_8c_source.html#l00236">parkinglots</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04643"></a>04643 {
<a name="l04644"></a>04644    <span class="keywordtype">int</span> res;
<a name="l04645"></a>04645 
<a name="l04646"></a>04646    <a class="code" href="module_8h.html#a6814b6d7b0a7d23c41df65124eb77171" title="Register an application.">ast_register_application2</a>(<a class="code" href="features_8c.html#a30cf144e208ddc17e51b2f1e600052e8">app_bridge</a>, <a class="code" href="features_8c.html#a274fc5b522ca5cfc7d7d8e871482480b" title="Bridge channels.">bridge_exec</a>, NULL, NULL, NULL);
<a name="l04647"></a>04647 
<a name="l04648"></a>04648    <a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(7, <a class="code" href="features_8c.html#a231b8dd6b2803def28a66cc640d3186f">parkinglot_hash_cb</a>, <a class="code" href="features_8c.html#a1798ad70b3c43377f3d89f7c4830b940">parkinglot_cmp_cb</a>);
<a name="l04649"></a>04649 
<a name="l04650"></a>04650    <span class="keywordflow">if</span> ((res = <a class="code" href="features_8c.html#aed5779f84d4ebb67745d801d3ebede43">load_config</a>()))
<a name="l04651"></a>04651       <span class="keywordflow">return</span> res;
<a name="l04652"></a>04652    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="features_8c.html#a53d8f03eb64267f168b7a966a64915f8">cli_features</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="features_8c.html#a53d8f03eb64267f168b7a966a64915f8">cli_features</a>));
<a name="l04653"></a>04653    <a class="code" href="utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;<a class="code" href="features_8c.html#ac66fb87ae86fa37b36fa78286c237fd2">parking_thread</a>, NULL, <a class="code" href="features_8c.html#ad9b02e0b0449b215a699f0a64d19107a" title="Take care of parked calls and unpark them if needed.">do_parking_thread</a>, NULL);
<a name="l04654"></a>04654    res = <a class="code" href="module_8h.html#a6814b6d7b0a7d23c41df65124eb77171" title="Register an application.">ast_register_application2</a>(<a class="code" href="features_8c.html#a45fde2767ab498a74ee0edc3fa3c3dbf">parkedcall</a>, <a class="code" href="features_8c.html#add37fc3ed9c410d20dd4de34644f5c7b">park_exec</a>, NULL, NULL, NULL);
<a name="l04655"></a>04655    <span class="keywordflow">if</span> (!res)
<a name="l04656"></a>04656       res = <a class="code" href="module_8h.html#a6814b6d7b0a7d23c41df65124eb77171" title="Register an application.">ast_register_application2</a>(<a class="code" href="features_8c.html#ac3950a3179488304a97d02de9488c205">parkcall</a>, <a class="code" href="features_8c.html#a2cec676e4ea8d8e13b3852e97fc28552" title="Park a call.">park_call_exec</a>, NULL, NULL, NULL);
<a name="l04657"></a>04657    <span class="keywordflow">if</span> (!res) {
<a name="l04658"></a>04658       <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;ParkedCalls&quot;</span>, 0, <a class="code" href="features_8c.html#ae173627ea061ac13a887ad640feac171" title="Dump parking lot status.">manager_parking_status</a>, <span class="stringliteral">&quot;List parked calls&quot;</span>);
<a name="l04659"></a>04659       <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;Park&quot;</span>, <a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <a class="code" href="features_8c.html#a81ea8c1f888844f3ba5aade3be0bbeba" title="Create manager event for parked calls.">manager_park</a>, <span class="stringliteral">&quot;Park a channel&quot;</span>, <a class="code" href="features_8c.html#ab646ce88b1017513554ea26a0d24557b">mandescr_park</a>); 
<a name="l04660"></a>04660       <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;Bridge&quot;</span>, <a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <a class="code" href="features_8c.html#a51755e20bdcffb65c53468b7c4eead32" title="Bridge channels together.">action_bridge</a>, <span class="stringliteral">&quot;Bridge two channels already in the PBX&quot;</span>, <a class="code" href="features_8c.html#a88045cf5a2dca0498141f69a5e2d54b3">mandescr_bridge</a>);
<a name="l04661"></a>04661    }
<a name="l04662"></a>04662 
<a name="l04663"></a>04663    res |= <a class="code" href="devicestate_8h.html#ae832fcc32c88962e73025ffeafe2961e" title="Add device state provider.">ast_devstate_prov_add</a>(<span class="stringliteral">&quot;Park&quot;</span>, <a class="code" href="features_8c.html#a803092f58ccdc8d7562ed7c5f2151380" title="metermaids callback from devicestate.c">metermaidstate</a>);
<a name="l04664"></a>04664 
<a name="l04665"></a>04665    <span class="keywordflow">return</span> res;
<a name="l04666"></a>04666 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a425ed69a5937fc5a26508084a11ceb47"></a><!-- doxytag: member="features.c::ast_features_reload" ref="a425ed69a5937fc5a26508084a11ceb47" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_features_reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reload call features from features.conf. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l04079">4079</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04080"></a>04080 {
<a name="l04081"></a>04081    <span class="keywordtype">int</span> res;
<a name="l04082"></a>04082    <span class="comment">/* Release parking lot list */</span>
<a name="l04083"></a>04083    <span class="comment">//ASTOBJ_CONTAINER_MARKALL(&amp;parkinglots);</span>
<a name="l04084"></a>04084    <span class="comment">// TODO: I don&apos;t think any marking is necessary</span>
<a name="l04085"></a>04085 
<a name="l04086"></a>04086    <span class="comment">/* Reload configuration */</span>
<a name="l04087"></a>04087    res = <a class="code" href="features_8c.html#aed5779f84d4ebb67745d801d3ebede43">load_config</a>();
<a name="l04088"></a>04088    
<a name="l04089"></a>04089    <span class="comment">//ASTOBJ_CONTAINER_PRUNE_MARKED(&amp;parkinglots, parkinglot_destroy);</span>
<a name="l04090"></a>04090    <span class="keywordflow">return</span> res;
<a name="l04091"></a>04091 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afe968c2bd566a03c0bc212faa7a37e17"></a><!-- doxytag: member="features.c::ast_find_call_feature" ref="afe968c2bd566a03c0bc212faa7a37e17" args="(const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__call__feature.html">ast_call_feature</a>* ast_find_call_feature </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>look for a call feature entry by its sname </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>a string ptr, should match "automon", "blindxfer", "atxfer", etc. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01884">1884</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, and <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01885"></a>01885 {
<a name="l01886"></a>01886    <span class="keywordtype">int</span> x;
<a name="l01887"></a>01887    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; x++) {
<a name="l01888"></a>01888       <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].sname))
<a name="l01889"></a>01889          <span class="keywordflow">return</span> &amp;<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x];
<a name="l01890"></a>01890    }
<a name="l01891"></a>01891    <span class="keywordflow">return</span> NULL;
<a name="l01892"></a>01892 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa34f70cbfec78481c228be7255fae4d8"></a><!-- doxytag: member="features.c::ast_masq_park_call" ref="aa34f70cbfec78481c228be7255fae4d8" args="(struct ast_channel *rchan, struct ast_channel *peer, int timeout, int *extout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_masq_park_call </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>rchan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>host</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>extout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Park a call via a masqueraded channel. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>rchan</em>&nbsp;</td><td>the real channel to be parked </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>host</em>&nbsp;</td><td>the channel to have the parking read to. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>timeout</em>&nbsp;</td><td>is a timeout in milliseconds </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>extout</em>&nbsp;</td><td>is a parameter to an int that will hold the parked location, or NULL if you want.</td></tr>
  </table>
  </dd>
</dl>
<p>Masquerade the channel rchan into a new, empty channel which is then parked with ast_park_call </p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00894">894</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00833">masq_park_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00895"></a>00895 {
<a name="l00896"></a>00896    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#a87a222a1d617d1917126357f27861442">masq_park_call</a>(rchan, peer, timeout, extout, 0, NULL);
<a name="l00897"></a>00897 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a79dd77e214dcdba17d47e04f82b41874"></a><!-- doxytag: member="features.c::ast_park_call" ref="a79dd77e214dcdba17d47e04f82b41874" args="(struct ast_channel *chan, struct ast_channel *peer, int timeout, int *extout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_park_call </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>extout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Park a call. </p>
<p>Park a call and read back parked location. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00823">823</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>, and <a class="el" href="features_8c_source.html#l00553">ast_park_call_args::timeout</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00824"></a>00824 {
<a name="l00825"></a>00825    <span class="keyword">struct </span><a class="code" href="structast__park__call__args.html">ast_park_call_args</a> args = {
<a name="l00826"></a>00826       .timeout = <a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>,
<a name="l00827"></a>00827       .extout = <a class="code" href="structast__park__call__args.html#a1d7b0cf33a765e5f0f70e0535709fe9e">extout</a>,
<a name="l00828"></a>00828    };
<a name="l00829"></a>00829 
<a name="l00830"></a>00830    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#af750802cffe6ab46e36412a8a47a68e2">park_call_full</a>(chan, peer, &amp;args);
<a name="l00831"></a>00831 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a716860609c92cd4b7fb8f6eb724ac700"></a><!-- doxytag: member="features.c::ast_parking_ext" ref="a716860609c92cd4b7fb8f6eb724ac700" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* ast_parking_ext </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Determine system parking <a class="el" href="structextension.html">extension</a>. </p>
<dl class="return"><dt><b>Returns:</b></dt><dd>the call parking <a class="el" href="structextension.html">extension</a> for drivers that provide special call parking help </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00315">315</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00239">parking_ext</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00316"></a>00316 {
<a name="l00317"></a>00317    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>;
<a name="l00318"></a>00318 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4890be42c2add5f52028705d6bc02201"></a><!-- doxytag: member="features.c::ast_pickup_call" ref="a4890be42c2add5f52028705d6bc02201" args="(struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_pickup_call </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Pickup a call. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>channel that initiated pickup.</td></tr>
  </table>
  </dd>
</dl>
<p>Walk list of <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>, checking it is not itself, channel is pbx one, check that the callgroup for both <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> are the same and the channel is ringing. Answer calling channel, flag channel as answered on queue, masq <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> together. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l04475">4475</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="channel_8c_source.html#l04217">ast_channel_masquerade()</a>, <a class="el" href="channel_8c_source.html#l01310">ast_channel_search_locked()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="frame_8h_source.html#l00301">AST_CONTROL_ANSWER</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l01123">ast_queue_control()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="features_8c_source.html#l04455">find_channel_by_group()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00246">pickupfailsound</a>, and <a class="el" href="features_8c_source.html#l00245">pickupsound</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04476"></a>04476 {
<a name="l04477"></a>04477    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *cur = <a class="code" href="channel_8h.html#a4c61dfe488472b90f811c319cdba7741" title="Search for a channel based on the passed channel matching callback Search for a channel...">ast_channel_search_locked</a>(<a class="code" href="features_8c.html#a1d1eac183cc14bd4a8bc679fc68200e4">find_channel_by_group</a>, chan);
<a name="l04478"></a>04478 
<a name="l04479"></a>04479    <span class="keywordflow">if</span> (cur) {
<a name="l04480"></a>04480       <span class="keywordtype">int</span> res = -1;
<a name="l04481"></a>04481       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Call pickup on chan &apos;%s&apos; by &apos;%s&apos;\n&quot;</span>,cur-&gt;name, chan-&gt;name);
<a name="l04482"></a>04482       res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l04483"></a>04483       <span class="keywordflow">if</span> (res)
<a name="l04484"></a>04484          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to answer &apos;%s&apos;\n&quot;</span>, chan-&gt;name);
<a name="l04485"></a>04485       res = <a class="code" href="channel_8h.html#a60f9d2b0ab8b7a839902313321163b28" title="Queue a control frame with payload.">ast_queue_control</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>);
<a name="l04486"></a>04486       <span class="keywordflow">if</span> (res)
<a name="l04487"></a>04487          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to queue answer on &apos;%s&apos;\n&quot;</span>, chan-&gt;name);
<a name="l04488"></a>04488       res = <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(cur, chan);
<a name="l04489"></a>04489       <span class="keywordflow">if</span> (res)
<a name="l04490"></a>04490          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to masquerade &apos;%s&apos; into &apos;%s&apos;\n&quot;</span>, chan-&gt;name, cur-&gt;name);     <span class="comment">/* Done */</span>
<a name="l04491"></a>04491       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a>)) {
<a name="l04492"></a>04492          <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(cur, <a class="code" href="features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04493"></a>04493       }
<a name="l04494"></a>04494       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(cur);
<a name="l04495"></a>04495       <span class="keywordflow">return</span> res;
<a name="l04496"></a>04496    } <span class="keywordflow">else</span>   {
<a name="l04497"></a>04497       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No call pickup possible...\n&quot;</span>);
<a name="l04498"></a>04498       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a>)) {
<a name="l04499"></a>04499          <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <a class="code" href="features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l04500"></a>04500       }
<a name="l04501"></a>04501    }
<a name="l04502"></a>04502    <span class="keywordflow">return</span> -1;
<a name="l04503"></a>04503 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a849b0c1bd72a0339408c7e6026768e40"></a><!-- doxytag: member="features.c::ast_pickup_ext" ref="a849b0c1bd72a0339408c7e6026768e40" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">const char* ast_pickup_ext </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Determine system call pickup <a class="el" href="structextension.html">extension</a>. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00320">320</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00194">pickup_ext</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00321"></a>00321 {
<a name="l00322"></a>00322    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#a7af3a76f3f29d5a21be63ef43f89840e">pickup_ext</a>;
<a name="l00323"></a>00323 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="adea59e175a9f8500c0eb848918849c67"></a><!-- doxytag: member="features.c::ast_rdlock_call_features" ref="adea59e175a9f8500c0eb848918849c67" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_rdlock_call_features </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01874">1874</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01796">ast_rwlock_rdlock()</a>, and <a class="el" href="features_8c_source.html#l01695">features_lock</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01875"></a>01875 {
<a name="l01876"></a>01876    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l01877"></a>01877 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa148867dd4dde459d181fc84be58c0f0"></a><!-- doxytag: member="features.c::ast_register_feature" ref="aa148867dd4dde459d181fc84be58c0f0" args="(struct ast_call_feature *feature)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_register_feature </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *&nbsp;</td>
          <td class="paramname"> <em>feature</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>register new feature into <a class="el" href="structfeature__list.html">feature_list</a> </p>
<p>register new feature into feature_set </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l01711">1711</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="linkedlists_8h_source.html#l00702">AST_RWLIST_INSERT_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, and <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01712"></a>01712 {
<a name="l01713"></a>01713    <span class="keywordflow">if</span> (!feature) {
<a name="l01714"></a>01714       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;You didn&apos;t pass a feature!\n&quot;</span>);
<a name="l01715"></a>01715       <span class="keywordflow">return</span>;
<a name="l01716"></a>01716    }
<a name="l01717"></a>01717   
<a name="l01718"></a>01718    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l01719"></a>01719    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>,feature,feature_entry);
<a name="l01720"></a>01720    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l01721"></a>01721 
<a name="l01722"></a>01722    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Registered Feature &apos;%s&apos;\n&quot;</span>,feature-&gt;<a class="code" href="structast__call__feature.html#a63c4048019f00ef118af9c631c1e7665">sname</a>);
<a name="l01723"></a>01723 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7c163c3ad2e31110c5fc9e0d3b27d81d"></a><!-- doxytag: member="features.c::ast_unlock_call_features" ref="a7c163c3ad2e31110c5fc9e0d3b27d81d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_unlock_call_features </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01879">1879</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, and <a class="el" href="features_8c_source.html#l01695">features_lock</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01880"></a>01880 {
<a name="l01881"></a>01881    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l01882"></a>01882 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad151dea8a1d676a4eac6206597ae980a"></a><!-- doxytag: member="features.c::ast_unregister_feature" ref="ad151dea8a1d676a4eac6206597ae980a" args="(struct ast_call_feature *feature)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_unregister_feature </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *&nbsp;</td>
          <td class="paramname"> <em>feature</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>unregister feature from feature_set </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>feature</em>&nbsp;</td><td>the <a class="el" href="structast__call__feature.html">ast_call_feature</a> object which was registered before </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01799">1799</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00860">AST_RWLIST_REMOVE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, and <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01800"></a>01800 {
<a name="l01801"></a>01801    <span class="keywordflow">if</span> (!feature) {
<a name="l01802"></a>01802       <span class="keywordflow">return</span>;
<a name="l01803"></a>01803    }
<a name="l01804"></a>01804 
<a name="l01805"></a>01805    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l01806"></a>01806    <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>, feature, feature_entry);
<a name="l01807"></a>01807    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l01808"></a>01808 
<a name="l01809"></a>01809    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(feature);
<a name="l01810"></a>01810 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a3230befbb308c37f984f069bf129b73b"></a><!-- doxytag: member="features.c::ast_unregister_features" ref="a3230befbb308c37f984f069bf129b73b" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_unregister_features </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove all features in the list. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l01813">1813</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00828">AST_RWLIST_REMOVE_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, and <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01814"></a>01814 {
<a name="l01815"></a>01815    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l01816"></a>01816 
<a name="l01817"></a>01817    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l01818"></a>01818    <span class="keywordflow">while</span> ((feature = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>, feature_entry))) {
<a name="l01819"></a>01819       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(feature);
<a name="l01820"></a>01820    }
<a name="l01821"></a>01821    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l01822"></a>01822 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad9244bff3ee975cad01b501ad64ecc5d"></a><!-- doxytag: member="features.c::ast_unregister_groups" ref="ad9244bff3ee975cad01b501ad64ecc5d" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void ast_unregister_groups </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove all feature <a class="el" href="structgroups.html">groups</a> in the list. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l01839">1839</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00817">AST_LIST_REMOVE_HEAD</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="stringfields_8h_source.html#l00245">ast_string_field_free_memory</a>, and <a class="el" href="structfeature__group.html#a9f496cd6d406637c34b0685e45269921">feature_group::features</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01840"></a>01840 {
<a name="l01841"></a>01841    <span class="keyword">struct </span><a class="code" href="structfeature__group.html">feature_group</a> *fg;
<a name="l01842"></a>01842    <span class="keyword">struct </span><a class="code" href="structfeature__group__exten.html">feature_group_exten</a> *fge;
<a name="l01843"></a>01843 
<a name="l01844"></a>01844    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l01845"></a>01845    <span class="keywordflow">while</span> ((fg = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>, <a class="code" href="structfeature__group__exten.html#a07bbbfd18184d736794fc71e74a381ca">entry</a>))) {
<a name="l01846"></a>01846       <span class="keywordflow">while</span> ((fge = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;fg-&gt;<a class="code" href="structfeature__group.html#a9f496cd6d406637c34b0685e45269921">features</a>, <a class="code" href="structfeature__group__exten.html#a07bbbfd18184d736794fc71e74a381ca">entry</a>))) {
<a name="l01847"></a>01847          <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(fge);
<a name="l01848"></a>01848          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fge);
<a name="l01849"></a>01849       }
<a name="l01850"></a>01850 
<a name="l01851"></a>01851       <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(fg);
<a name="l01852"></a>01852       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fg);
<a name="l01853"></a>01853    }
<a name="l01854"></a>01854    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l01855"></a>01855 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a77a74ae0a8425ff3ac5fef9ce7d2b9ef"></a><!-- doxytag: member="features.c::bridge_call_thread" ref="a77a74ae0a8425ff3ac5fef9ce7d2b9ef" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* bridge_call_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>bridge the call </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>thread bridge.</td></tr>
  </table>
  </dd>
</dl>
<p>Set Last Data for respective <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>, reset cdr for <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> bridge call, check if we're going back to dialplan if not hangup both legs of the call </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00412">412</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00411">ast_channel::appl</a>, <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="pbx_8c_source.html#l04559">ast_pbx_start()</a>, <a class="el" href="pbx_8h_source.html#l00263">AST_PBX_SUCCESS</a>, <a class="el" href="features_8c_source.html#l00327">ast_bridge_thread_obj::bconfig</a>, <a class="el" href="features_8c_source.html#l00328">ast_bridge_thread_obj::chan</a>, <a class="el" href="channel_8h_source.html#l00412">ast_channel::data</a>, <a class="el" href="logger_8h_source.html#l00179">LOG_VERBOSE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00329">ast_bridge_thread_obj::peer</a>, and <a class="el" href="features_8c_source.html#l00330">ast_bridge_thread_obj::return_to_pbx</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00455">bridge_call_thread_launch()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00413"></a>00413 {
<a name="l00414"></a>00414    <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> *tobj = data;
<a name="l00415"></a>00415    <span class="keywordtype">int</span> res;
<a name="l00416"></a>00416 
<a name="l00417"></a>00417    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> = !tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#acffa9c033850b0d1ab2b93ca1be518d1">return_to_pbx</a> ? <span class="stringliteral">&quot;Transferred Call&quot;</span> : <span class="stringliteral">&quot;ManagerBridge&quot;</span>;
<a name="l00418"></a>00418    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> = tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>-&gt;name;
<a name="l00419"></a>00419    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> = !tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#acffa9c033850b0d1ab2b93ca1be518d1">return_to_pbx</a> ? <span class="stringliteral">&quot;Transferred Call&quot;</span> : <span class="stringliteral">&quot;ManagerBridge&quot;</span>;
<a name="l00420"></a>00420    tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> = tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name;
<a name="l00421"></a>00421 
<a name="l00422"></a>00422    <a class="code" href="features_8h.html#a3fe7c7e43b8f3140716d836816bf827f" title="Bridge a call, optionally allowing redirection.">ast_bridge_call</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>, &amp;tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424    <span class="keywordflow">if</span> (tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#acffa9c033850b0d1ab2b93ca1be518d1">return_to_pbx</a>) {
<a name="l00425"></a>00425       <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>)) {
<a name="l00426"></a>00426          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a44f7f25988447c6a7064f1a31c0133a2">LOG_VERBOSE</a>, <span class="stringliteral">&quot;putting peer %s into PBX again\n&quot;</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>-&gt;name);
<a name="l00427"></a>00427          res = <a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>);
<a name="l00428"></a>00428          <span class="keywordflow">if</span> (res != <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ae1482e87c137b03ef9f9c17cf4fb5ec4">AST_PBX_SUCCESS</a>)
<a name="l00429"></a>00429             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;FAILED continuing PBX on peer %s\n&quot;</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>-&gt;name);
<a name="l00430"></a>00430       } <span class="keywordflow">else</span>
<a name="l00431"></a>00431          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>);
<a name="l00432"></a>00432       <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>)) {
<a name="l00433"></a>00433          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a44f7f25988447c6a7064f1a31c0133a2">LOG_VERBOSE</a>, <span class="stringliteral">&quot;putting chan %s into PBX again\n&quot;</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name);
<a name="l00434"></a>00434          res = <a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>);
<a name="l00435"></a>00435          <span class="keywordflow">if</span> (res != <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ae1482e87c137b03ef9f9c17cf4fb5ec4">AST_PBX_SUCCESS</a>)
<a name="l00436"></a>00436             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;FAILED continuing PBX on chan %s\n&quot;</span>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name);
<a name="l00437"></a>00437       } <span class="keywordflow">else</span>
<a name="l00438"></a>00438          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>);
<a name="l00439"></a>00439    } <span class="keywordflow">else</span> {
<a name="l00440"></a>00440       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>);
<a name="l00441"></a>00441       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>);
<a name="l00442"></a>00442    }
<a name="l00443"></a>00443 
<a name="l00444"></a>00444    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tobj);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446    <span class="keywordflow">return</span> NULL;
<a name="l00447"></a>00447 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9cb8151f1a64734b68ee8cafcc37cf3e"></a><!-- doxytag: member="features.c::bridge_call_thread_launch" ref="a9cb8151f1a64734b68ee8cafcc37cf3e" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void bridge_call_thread_launch </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>create thread for the parked call </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>Create thread and attributes, call bridge_call_thread </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00455">455</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="utils_8h_source.html#l00376">ast_pthread_create</a>, <a class="el" href="features_8c_source.html#l00412">bridge_call_thread()</a>, and <a class="el" href="app__meetme_8c_source.html#l00840">thread</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04156">action_bridge()</a>, and <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00456"></a>00456 {
<a name="l00457"></a>00457    pthread_t <a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l00458"></a>00458    pthread_attr_t attr;
<a name="l00459"></a>00459    <span class="keyword">struct </span>sched_param <a class="code" href="structsched.html">sched</a>;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    pthread_attr_init(&amp;attr);
<a name="l00462"></a>00462    pthread_attr_setdetachstate(&amp;attr, PTHREAD_CREATE_DETACHED);
<a name="l00463"></a>00463    <a class="code" href="utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;thread, &amp;attr, <a class="code" href="features_8c.html#a77a74ae0a8425ff3ac5fef9ce7d2b9ef" title="bridge the call">bridge_call_thread</a>, data);
<a name="l00464"></a>00464    pthread_attr_destroy(&amp;attr);
<a name="l00465"></a>00465    memset(&amp;<a class="code" href="structsched.html">sched</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="structsched.html">sched</a>));
<a name="l00466"></a>00466    pthread_setschedparam(thread, SCHED_RR, &amp;<a class="code" href="structsched.html">sched</a>);
<a name="l00467"></a>00467 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a274fc5b522ca5cfc7d7d8e871482480b"></a><!-- doxytag: member="features.c::bridge_exec" ref="a274fc5b522ca5cfc7d7d8e871482480b" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int bridge_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Bridge <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>channel to bridge with.</td></tr>
  </table>
  </dd>
</dl>
<p>Split data, check we aren't bridging with ourself, check valid channel, answer call if not already, check compatible <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>, setup bridge config now bridge call, if transfered party hangs up return to PBX <a class="el" href="structextension.html">extension</a>. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l04524">4524</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8c_source.html#l01776">ast_app_parse_options()</a>, <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, <a class="el" href="channel_8h_source.html#l00730">ast_channel_alloc</a>, <a class="el" href="channel_8c_source.html#l04200">ast_channel_make_compatible()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="channel_8c_source.html#l01284">ast_get_channel_by_name_prefix_locked()</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="pbx_8c_source.html#l04559">ast_pbx_start()</a>, <a class="el" href="pbx_8h_source.html#l00263">AST_PBX_SUCCESS</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="channel_8h_source.html#l00359">AST_STATE_DOWN</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="file_8c_source.html#l00943">ast_streamfile()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="file_8c_source.html#l01315">ast_waitstream()</a>, <a class="el" href="features_8c_source.html#l04513">bridge_exec_options</a>, <a class="el" href="features_8c_source.html#l04508">BRIDGE_OPT_PLAYTONE</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="features_8c_source.html#l04126">do_bridge_masquerade()</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, and <a class="el" href="features_8c_source.html#l00243">xfersound</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04525"></a>04525 {
<a name="l04526"></a>04526    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *current_dest_chan, *final_dest_chan;
<a name="l04527"></a>04527    <span class="keywordtype">char</span> *tmp_data  = NULL;
<a name="l04528"></a>04528    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> opts = { 0, };
<a name="l04529"></a>04529    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a> bconfig = { { 0, }, };
<a name="l04530"></a>04530 
<a name="l04531"></a>04531    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04532"></a>04532       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(dest_chan);
<a name="l04533"></a>04533       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l04534"></a>04534    );
<a name="l04535"></a>04535    
<a name="l04536"></a>04536    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04537"></a>04537       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Bridge require at least 1 argument specifying the other end of the bridge\n&quot;</span>);
<a name="l04538"></a>04538       <span class="keywordflow">return</span> -1;
<a name="l04539"></a>04539    }
<a name="l04540"></a>04540 
<a name="l04541"></a>04541    tmp_data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04542"></a>04542    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, tmp_data);
<a name="l04543"></a>04543    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.options))
<a name="l04544"></a>04544       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<a class="code" href="features_8c.html#a217d93bf8d70c1b07dcc8aa6380cfae9">bridge_exec_options</a>, &amp;opts, NULL, args.options);
<a name="l04545"></a>04545 
<a name="l04546"></a>04546    <span class="comment">/* avoid bridge with ourselves */</span>
<a name="l04547"></a>04547    <span class="keywordflow">if</span> (!strcmp(chan-&gt;name, args.dest_chan)) {
<a name="l04548"></a>04548       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to bridge channel %s with itself\n&quot;</span>, chan-&gt;name);
<a name="l04549"></a>04549       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;BridgeExec&quot;</span>,
<a name="l04550"></a>04550                <span class="stringliteral">&quot;Response: Failed\r\n&quot;</span>
<a name="l04551"></a>04551                <span class="stringliteral">&quot;Reason: Unable to bridge channel to itself\r\n&quot;</span>
<a name="l04552"></a>04552                <span class="stringliteral">&quot;Channel1: %s\r\n&quot;</span>
<a name="l04553"></a>04553                <span class="stringliteral">&quot;Channel2: %s\r\n&quot;</span>,
<a name="l04554"></a>04554                chan-&gt;name, args.dest_chan);
<a name="l04555"></a>04555       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BRIDGERESULT&quot;</span>, <span class="stringliteral">&quot;LOOP&quot;</span>);
<a name="l04556"></a>04556       <span class="keywordflow">return</span> 0;
<a name="l04557"></a>04557    }
<a name="l04558"></a>04558 
<a name="l04559"></a>04559    <span class="comment">/* make sure we have a valid end point */</span>
<a name="l04560"></a>04560    <span class="keywordflow">if</span> (!(current_dest_chan = <a class="code" href="channel_8h.html#a67239a95ab93867fb9da5a8b20281224" title="Get channel by name or uniqueid prefix (locks channel).">ast_get_channel_by_name_prefix_locked</a>(args.dest_chan, 
<a name="l04561"></a>04561       strlen(args.dest_chan)))) {
<a name="l04562"></a>04562       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Bridge failed because channel %s does not exists or we &quot;</span>
<a name="l04563"></a>04563          <span class="stringliteral">&quot;cannot get its lock\n&quot;</span>, args.dest_chan);
<a name="l04564"></a>04564       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;BridgeExec&quot;</span>,
<a name="l04565"></a>04565                <span class="stringliteral">&quot;Response: Failed\r\n&quot;</span>
<a name="l04566"></a>04566                <span class="stringliteral">&quot;Reason: Cannot grab end point\r\n&quot;</span>
<a name="l04567"></a>04567                <span class="stringliteral">&quot;Channel1: %s\r\n&quot;</span>
<a name="l04568"></a>04568                <span class="stringliteral">&quot;Channel2: %s\r\n&quot;</span>, chan-&gt;name, args.dest_chan);
<a name="l04569"></a>04569       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BRIDGERESULT&quot;</span>, <span class="stringliteral">&quot;NONEXISTENT&quot;</span>);
<a name="l04570"></a>04570       <span class="keywordflow">return</span> 0;
<a name="l04571"></a>04571    }
<a name="l04572"></a>04572 
<a name="l04573"></a>04573    <span class="comment">/* answer the channel if needed */</span>
<a name="l04574"></a>04574    <span class="keywordflow">if</span> (current_dest_chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l04575"></a>04575       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(current_dest_chan);
<a name="l04576"></a>04576 
<a name="l04577"></a>04577    <span class="comment">/* try to allocate a place holder where current_dest_chan will be placed */</span>
<a name="l04578"></a>04578    <span class="keywordflow">if</span> (!(final_dest_chan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, NULL, NULL, NULL, 
<a name="l04579"></a>04579       NULL, NULL, 0, <span class="stringliteral">&quot;Bridge/%s&quot;</span>, current_dest_chan-&gt;name))) {
<a name="l04580"></a>04580       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot create placeholder channel for chan %s\n&quot;</span>, args.dest_chan);
<a name="l04581"></a>04581       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;BridgeExec&quot;</span>,
<a name="l04582"></a>04582                <span class="stringliteral">&quot;Response: Failed\r\n&quot;</span>
<a name="l04583"></a>04583                <span class="stringliteral">&quot;Reason: cannot create placeholder\r\n&quot;</span>
<a name="l04584"></a>04584                <span class="stringliteral">&quot;Channel1: %s\r\n&quot;</span>
<a name="l04585"></a>04585                <span class="stringliteral">&quot;Channel2: %s\r\n&quot;</span>, chan-&gt;name, args.dest_chan);
<a name="l04586"></a>04586    }
<a name="l04587"></a>04587    <a class="code" href="features_8c.html#acf1dcf498f0e94d517221edd746f71ce" title="Actual bridge.">do_bridge_masquerade</a>(current_dest_chan, final_dest_chan);
<a name="l04588"></a>04588 
<a name="l04589"></a>04589    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(current_dest_chan);
<a name="l04590"></a>04590 
<a name="l04591"></a>04591    <span class="comment">/* now current_dest_chan is a ZOMBIE and with softhangup set to 1 and final_dest_chan is our end point */</span>
<a name="l04592"></a>04592    <span class="comment">/* try to make compatible, send error if we fail */</span>
<a name="l04593"></a>04593    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a57646ce13ff95b5fc66dea2e741b21ff" title="Makes two channel formats compatible.">ast_channel_make_compatible</a>(chan, final_dest_chan) &lt; 0) {
<a name="l04594"></a>04594       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not make channels %s and %s compatible for bridge\n&quot;</span>, chan-&gt;name, final_dest_chan-&gt;name);
<a name="l04595"></a>04595       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;BridgeExec&quot;</span>,
<a name="l04596"></a>04596                <span class="stringliteral">&quot;Response: Failed\r\n&quot;</span>
<a name="l04597"></a>04597                <span class="stringliteral">&quot;Reason: Could not make channels compatible for bridge\r\n&quot;</span>
<a name="l04598"></a>04598                <span class="stringliteral">&quot;Channel1: %s\r\n&quot;</span>
<a name="l04599"></a>04599                <span class="stringliteral">&quot;Channel2: %s\r\n&quot;</span>, chan-&gt;name, final_dest_chan-&gt;name);
<a name="l04600"></a>04600       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(final_dest_chan); <span class="comment">/* may be we should return this channel to the PBX? */</span>
<a name="l04601"></a>04601       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BRIDGERESULT&quot;</span>, <span class="stringliteral">&quot;INCOMPATIBLE&quot;</span>);
<a name="l04602"></a>04602       <span class="keywordflow">return</span> 0;
<a name="l04603"></a>04603    }
<a name="l04604"></a>04604 
<a name="l04605"></a>04605    <span class="comment">/* Report that the bridge will be successfull */</span>
<a name="l04606"></a>04606    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;BridgeExec&quot;</span>,
<a name="l04607"></a>04607             <span class="stringliteral">&quot;Response: Success\r\n&quot;</span>
<a name="l04608"></a>04608             <span class="stringliteral">&quot;Channel1: %s\r\n&quot;</span>
<a name="l04609"></a>04609             <span class="stringliteral">&quot;Channel2: %s\r\n&quot;</span>, chan-&gt;name, final_dest_chan-&gt;name);
<a name="l04610"></a>04610 
<a name="l04611"></a>04611    <span class="comment">/* we have 2 valid channels to bridge, now it is just a matter of setting up the bridge config and starting the bridge */</span>  
<a name="l04612"></a>04612    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;opts, <a class="code" href="features_8c.html#a282841548f1d79a386bbeb4172ebf942ac6c5fc9f2156b5d690587dc1fdcbc6b3">BRIDGE_OPT_PLAYTONE</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>)) {
<a name="l04613"></a>04613       <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(final_dest_chan, <a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, final_dest_chan-&gt;language)) {
<a name="l04614"></a>04614          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(final_dest_chan, <span class="stringliteral">&quot;&quot;</span>) &lt; 0)
<a name="l04615"></a>04615             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play courtesy tone on %s\n&quot;</span>, final_dest_chan-&gt;name);
<a name="l04616"></a>04616       }
<a name="l04617"></a>04617    }
<a name="l04618"></a>04618    
<a name="l04619"></a>04619    <span class="comment">/* do the bridge */</span>
<a name="l04620"></a>04620    <a class="code" href="features_8h.html#a3fe7c7e43b8f3140716d836816bf827f" title="Bridge a call, optionally allowing redirection.">ast_bridge_call</a>(chan, final_dest_chan, &amp;bconfig);
<a name="l04621"></a>04621 
<a name="l04622"></a>04622    <span class="comment">/* the bridge has ended, set BRIDGERESULT to SUCCESS. If the other channel has not been hung up, return it to the PBX */</span>
<a name="l04623"></a>04623    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;BRIDGERESULT&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l04624"></a>04624    <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(final_dest_chan)) {
<a name="l04625"></a>04625       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;starting new PBX in %s,%s,%d for chan %s\n&quot;</span>, 
<a name="l04626"></a>04626          final_dest_chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, final_dest_chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, 
<a name="l04627"></a>04627          final_dest_chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, final_dest_chan-&gt;name);
<a name="l04628"></a>04628 
<a name="l04629"></a>04629       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(final_dest_chan) != <a class="code" href="pbx_8h.html#a0e4eb357d2ef42629fbcf191a473f735ae1482e87c137b03ef9f9c17cf4fb5ec4">AST_PBX_SUCCESS</a>) {
<a name="l04630"></a>04630          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;FAILED continuing PBX on dest chan %s\n&quot;</span>, final_dest_chan-&gt;name);
<a name="l04631"></a>04631          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(final_dest_chan);
<a name="l04632"></a>04632       } <span class="keywordflow">else</span>
<a name="l04633"></a>04633          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SUCCESS continuing PBX on chan %s\n&quot;</span>, final_dest_chan-&gt;name);
<a name="l04634"></a>04634    } <span class="keywordflow">else</span> {
<a name="l04635"></a>04635       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;hangup chan %s since the other endpoint has hung up\n&quot;</span>, final_dest_chan-&gt;name);
<a name="l04636"></a>04636       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(final_dest_chan);
<a name="l04637"></a>04637    }
<a name="l04638"></a>04638 
<a name="l04639"></a>04639    <span class="keywordflow">return</span> 0;
<a name="l04640"></a>04640 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aadd28dbd7590a172d15245291dfaae1e"></a><!-- doxytag: member="features.c::build_parkinglot" ref="aadd28dbd7590a172d15245291dfaae1e" args="(char *name, struct ast_variable *var)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a>* build_parkinglot </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__variable.html">ast_variable</a> *&nbsp;</td>
          <td class="paramname"> <em>var</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Build parkinglot from configuration and chain it in. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03554">3554</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00782">ao2_link</a>, <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="pbx_8c_source.html#l07624">ast_add_extension2()</a>, <a class="el" href="pbx_8c_source.html#l06424">ast_context_find_or_create()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="utils_8h_source.html#l00415">ast_free_ptr()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="features_8c_source.html#l00315">ast_parking_ext()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="features_8c_source.html#l03525">create_parkinglot()</a>, <a class="el" href="features_8c_source.html#l00162">DEFAULT_PARK_TIME</a>, <a class="el" href="features_8c_source.html#l03224">find_parkinglot()</a>, <a class="el" href="config_8h_source.html#l00081">ast_variable::lineno</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00226">ast_parkinglot::mohclass</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="features_8c_source.html#l00262">parkcall</a>, <a class="el" href="features_8c_source.html#l00224">ast_parkinglot::parkfindnext</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00220">ast_parkinglot::parking_con_dial</a>, <a class="el" href="features_8c_source.html#l00221">ast_parkinglot::parking_start</a>, <a class="el" href="features_8c_source.html#l00222">ast_parkinglot::parking_stop</a>, <a class="el" href="features_8c_source.html#l03543">parkinglot_destroy()</a>, <a class="el" href="features_8c_source.html#l03509">parkinglot_unref()</a>, <a class="el" href="features_8c_source.html#l00236">parkinglots</a>, <a class="el" href="features_8c_source.html#l00225">ast_parkinglot::parkingtime</a>, <a class="el" href="features_8c_source.html#l00259">registrar</a>, <a class="el" href="astmm_8h_source.html#l00096">strdup</a>, and <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03555"></a>03555 {
<a name="l03556"></a>03556    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>;
<a name="l03557"></a>03557    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con = NULL;
<a name="l03558"></a>03558 
<a name="l03559"></a>03559    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *confvar = var;
<a name="l03560"></a>03560    <span class="keywordtype">int</span> error = 0;
<a name="l03561"></a>03561    <span class="keywordtype">int</span> start = 0, end = 0;
<a name="l03562"></a>03562    <span class="keywordtype">int</span> oldparkinglot = 0;
<a name="l03563"></a>03563 
<a name="l03564"></a>03564    parkinglot = <a class="code" href="features_8c.html#ab7cacbc2a5f8e49ab8c548df6201601b" title="Find parkinglot by name.">find_parkinglot</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l03565"></a>03565    <span class="keywordflow">if</span> (parkinglot)
<a name="l03566"></a>03566       oldparkinglot = 1;
<a name="l03567"></a>03567    <span class="keywordflow">else</span>
<a name="l03568"></a>03568       parkinglot = <a class="code" href="features_8c.html#a9b6a832c081aa8f2cd5287bcf54023a2" title="Allocate parking lot structure.">create_parkinglot</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l03569"></a>03569 
<a name="l03570"></a>03570    <span class="keywordflow">if</span> (!parkinglot)
<a name="l03571"></a>03571       <span class="keywordflow">return</span> NULL;
<a name="l03572"></a>03572 
<a name="l03573"></a>03573    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(parkinglot);
<a name="l03574"></a>03574 
<a name="l03575"></a>03575    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l03576"></a>03576       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Building parking lot %s\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l03577"></a>03577    
<a name="l03578"></a>03578    <span class="comment">/* Do some config stuff */</span>
<a name="l03579"></a>03579    <span class="keywordflow">while</span>(confvar) {
<a name="l03580"></a>03580       <span class="keywordflow">if</span> (!strcasecmp(confvar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l03581"></a>03581          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, confvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>));
<a name="l03582"></a>03582       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(confvar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkingtime&quot;</span>)) {
<a name="l03583"></a>03583          <span class="keywordflow">if</span> ((sscanf(confvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a>) != 1) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> &lt; 1)) {
<a name="l03584"></a>03584             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid parkingtime\n&quot;</span>, confvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03585"></a>03585             parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> = <a class="code" href="features_8c.html#abc52bb32a2f26f43e2c82795a0d0ea38">DEFAULT_PARK_TIME</a>;
<a name="l03586"></a>03586          } <span class="keywordflow">else</span>
<a name="l03587"></a>03587             parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> = parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> * 1000;
<a name="l03588"></a>03588       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(confvar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkpos&quot;</span>)) {
<a name="l03589"></a>03589          <span class="keywordflow">if</span> (sscanf(confvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d-%30d&quot;</span>, &amp;start, &amp;end) != 2) {
<a name="l03590"></a>03590             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Format for parking positions is a-b, where a and b are numbers at line %d of parking.conf\n&quot;</span>, confvar-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l03591"></a>03591             error = 1;
<a name="l03592"></a>03592          } <span class="keywordflow">else</span> {
<a name="l03593"></a>03593             parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a> = start;
<a name="l03594"></a>03594             parkinglot-&gt;<a class="code" href="structast__parkinglot.html#ac6c6bea761c82a98ef22c655cfbf5a56">parking_stop</a> = end;
<a name="l03595"></a>03595          }
<a name="l03596"></a>03596       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(confvar-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;findslot&quot;</span>)) {
<a name="l03597"></a>03597          parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5cbf8179fd861c82eb9f63f538469ceb">parkfindnext</a> = (!strcasecmp(confvar-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;next&quot;</span>));
<a name="l03598"></a>03598       }
<a name="l03599"></a>03599       confvar = confvar-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l03600"></a>03600    }
<a name="l03601"></a>03601    <span class="comment">/* make sure parkingtime is set if not specified */</span>
<a name="l03602"></a>03602    <span class="keywordflow">if</span> (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> == 0) {
<a name="l03603"></a>03603       parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> = <a class="code" href="features_8c.html#abc52bb32a2f26f43e2c82795a0d0ea38">DEFAULT_PARK_TIME</a>;
<a name="l03604"></a>03604    }
<a name="l03605"></a>03605 
<a name="l03606"></a>03606    <span class="keywordflow">if</span> (!var) { <span class="comment">/* Default parking lot */</span>
<a name="l03607"></a>03607       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <span class="stringliteral">&quot;parkedcalls&quot;</span>, <span class="keyword">sizeof</span>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>));
<a name="l03608"></a>03608       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a71758464557c527ec3767402f8f31208">parking_con_dial</a>, <span class="stringliteral">&quot;park-dial&quot;</span>, <span class="keyword">sizeof</span>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a71758464557c527ec3767402f8f31208">parking_con_dial</a>));
<a name="l03609"></a>03609       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>, <span class="stringliteral">&quot;default&quot;</span>, <span class="keyword">sizeof</span>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>));
<a name="l03610"></a>03610    }
<a name="l03611"></a>03611 
<a name="l03612"></a>03612    <span class="comment">/* Check for errors */</span>
<a name="l03613"></a>03613    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>)) {
<a name="l03614"></a>03614       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parking lot %s lacks context\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l03615"></a>03615       error = 1;
<a name="l03616"></a>03616    }
<a name="l03617"></a>03617 
<a name="l03618"></a>03618    <span class="comment">/* Create context */</span>
<a name="l03619"></a>03619    <span class="keywordflow">if</span> (!error &amp;&amp; !(con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>))) {
<a name="l03620"></a>03620       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Parking context &apos;%s&apos; does not exist and unable to create\n&quot;</span>, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l03621"></a>03621       error = 1;
<a name="l03622"></a>03622    }
<a name="l03623"></a>03623 
<a name="l03624"></a>03624    <span class="comment">/* Add a parking extension into the context */</span>
<a name="l03625"></a>03625    <span class="keywordflow">if</span> (!error &amp;&amp; !oldparkinglot) {
<a name="l03626"></a>03626       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>())) {
<a name="l03627"></a>03627          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 1, <a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>(), 1, NULL, NULL, <a class="code" href="features_8c.html#ac3950a3179488304a97d02de9488c205">parkcall</a>, <a class="code" href="astmm_8h.html#a33bc8f85636226ba23bf348f78352aef">strdup</a>(<span class="stringliteral">&quot;&quot;</span>), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>) == -1)
<a name="l03628"></a>03628             error = 1;
<a name="l03629"></a>03629       }
<a name="l03630"></a>03630    }
<a name="l03631"></a>03631 
<a name="l03632"></a>03632    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(parkinglot);
<a name="l03633"></a>03633 
<a name="l03634"></a>03634    <span class="keywordflow">if</span> (error) {
<a name="l03635"></a>03635       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parking %s not open for business. Configuration error.\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l03636"></a>03636       <a class="code" href="features_8c.html#af048c9c1f337c794fec319fe666ab8b8" title="Destroy a parking lot.">parkinglot_destroy</a>(parkinglot);
<a name="l03637"></a>03637       <span class="keywordflow">return</span> NULL;
<a name="l03638"></a>03638    }
<a name="l03639"></a>03639    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l03640"></a>03640       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Parking %s now open for business. (start exten %d end %d)\n&quot;</span>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, start, end);
<a name="l03641"></a>03641 
<a name="l03642"></a>03642 
<a name="l03643"></a>03643    <span class="comment">/* Move it into the list, if it wasn&apos;t already there */</span>
<a name="l03644"></a>03644    <span class="keywordflow">if</span> (!oldparkinglot) {
<a name="l03645"></a>03645       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, parkinglot);
<a name="l03646"></a>03646    }
<a name="l03647"></a>03647    <a class="code" href="features_8c.html#ab85223aa95d23fb716027953e555c28b" title="Unreference parkinglot object. If no more references, then go ahead and delete it...">parkinglot_unref</a>(parkinglot);
<a name="l03648"></a>03648 
<a name="l03649"></a>03649    <span class="keywordflow">return</span> parkinglot;
<a name="l03650"></a>03650 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ba3a29aff36306cb6baae2799f5cbbe"></a><!-- doxytag: member="features.c::builtin_atxfer" ref="a0ba3a29aff36306cb6baae2799f5cbbe" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int builtin_atxfer </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Attended transfer. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>transfered <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>peer</em>&nbsp;</td><td>person transfering call </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>config</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>code</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sense</em>&nbsp;</td><td>feature options</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>Get <a class="el" href="structextension.html">extension</a> to transfer to, if you cannot generate channel (or find <a class="el" href="structextension.html">extension</a>) return to host channel. After called channel answered wait for hangup of transferer, bridge call between transfer peer (taking them off hold) to attended transfer channel.</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>-1 on failure </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01396">1396</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00462">ast_channel::_softhangup</a>, <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="app_8c_source.html#l00076">ast_app_dtget()</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="channel_8c_source.html#l00711">ast_best_codec()</a>, <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="channel_8h_source.html#l00730">ast_channel_alloc</a>, <a class="el" href="channel_8c_source.html#l01548">ast_channel_datastore_find()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="channel_8c_source.html#l04217">ast_channel_masquerade()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="frame_8h_source.html#l00302">AST_CONTROL_BUSY</a>, <a class="el" href="frame_8h_source.html#l00313">AST_CONTROL_HOLD</a>, <a class="el" href="frame_8h_source.html#l00314">AST_CONTROL_UNHOLD</a>, <a class="el" href="utils_8h_source.html#l00082">ast_copy_flags</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="file_8h_source.html#l00047">AST_DIGIT_ANY</a>, <a class="el" href="pbx_8c_source.html#l04143">ast_exists_extension()</a>, <a class="el" href="pbx_8c_source.html#l07321">ast_explicit_goto()</a>, <a class="el" href="channel_8h_source.html#l00578">AST_FEATURE_DISCONNECT</a>, <a class="el" href="features_8h_source.html#l00068">AST_FEATURE_RETURN_SUCCESS</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="features_8c_source.html#l00315">ast_parking_ext()</a>, <a class="el" href="channel_8c_source.html#l03100">ast_read()</a>, <a class="el" href="channel_8c_source.html#l01367">ast_safe_sleep()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="channel_8h_source.html#l00359">AST_STATE_DOWN</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="channel_8c_source.html#l02400">ast_waitfordigit()</a>, <a class="el" href="features_8c_source.html#l00257">atxfercallbackretries</a>, <a class="el" href="features_8c_source.html#l00255">atxferdropcall</a>, <a class="el" href="features_8c_source.html#l00256">atxferloopdelay</a>, <a class="el" href="features_8c_source.html#l00254">atxfernoanswertimeout</a>, <a class="el" href="features_8c_source.html#l00327">ast_bridge_thread_obj::bconfig</a>, <a class="el" href="features_8c_source.html#l00455">bridge_call_thread_launch()</a>, <a class="el" href="features_8c_source.html#l00942">builtin_parkcall()</a>, <a class="el" href="features_8c_source.html#l00328">ast_bridge_thread_obj::chan</a>, <a class="el" href="features_8c_source.html#l01370">check_compat()</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00204">ast_callerid::cid_name</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="structast__bridge__config.html#acf41a4cfd7f144294e2d14ab8738704a">ast_bridge_config::end_bridge_callback_data_fixup</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="features_8c_source.html#l02152">feature_request_and_dial()</a>, <a class="el" href="channel_8h_source.html#l00590">ast_bridge_config::features_callee</a>, <a class="el" href="features_8c_source.html#l00275">ast_dial_features::features_caller</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, <a class="el" href="features_8c_source.html#l01221">finishup()</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="channel_8h_source.html#l00482">ast_channel::nativeformats</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="features_8c_source.html#l00329">ast_bridge_thread_obj::peer</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="channel_8h_source.html#l00483">ast_channel::readformat</a>, <a class="el" href="features_8c_source.html#l01236">real_ctx()</a>, <a class="el" href="features_8c_source.html#l00918">set_peers()</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, <a class="el" href="features_8c_source.html#l00250">transferdigittimeout</a>, <a class="el" href="channel_8h_source.html#l00491">ast_channel::visible_indication</a>, <a class="el" href="channel_8h_source.html#l00484">ast_channel::writeformat</a>, <a class="el" href="features_8c_source.html#l00244">xferfailsound</a>, and <a class="el" href="features_8c_source.html#l00243">xfersound</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01397"></a>01397 {
<a name="l01398"></a>01398    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *transferer;
<a name="l01399"></a>01399    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *transferee;
<a name="l01400"></a>01400    <span class="keyword">const</span> <span class="keywordtype">char</span> *transferer_real_context;
<a name="l01401"></a>01401    <span class="keywordtype">char</span> xferto[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01402"></a>01402    <span class="keywordtype">int</span> res;
<a name="l01403"></a>01403    <span class="keywordtype">int</span> outstate=0;
<a name="l01404"></a>01404    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan;
<a name="l01405"></a>01405    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *xferchan;
<a name="l01406"></a>01406    <span class="keyword">struct </span><a class="code" href="structast__bridge__thread__obj.html">ast_bridge_thread_obj</a> *tobj;
<a name="l01407"></a>01407    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a> bconfig;
<a name="l01408"></a>01408    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01409"></a>01409    <span class="keywordtype">int</span> l;
<a name="l01410"></a>01410    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *features_datastore;
<a name="l01411"></a>01411    <span class="keyword">struct </span><a class="code" href="structast__dial__features.html">ast_dial_features</a> *dialfeatures = NULL;
<a name="l01412"></a>01412 
<a name="l01413"></a>01413    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Executing Attended Transfer %s, %s (sense=%d) \n&quot;</span>, chan-&gt;name, peer-&gt;name, sense);
<a name="l01414"></a>01414    <a class="code" href="features_8c.html#a130d6c414eebccdc195fa893b47be865" title="set caller and callee according to the direction">set_peers</a>(&amp;transferer, &amp;transferee, peer, chan, sense);
<a name="l01415"></a>01415    transferer_real_context = <a class="code" href="features_8c.html#aaae36759026f17aea180b5ba7fad3918" title="Find the context for the transfer.">real_ctx</a>(transferer, transferee);
<a name="l01416"></a>01416    <span class="comment">/* Start autoservice on chan while we talk to the originator */</span>
<a name="l01417"></a>01417    <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(transferee);
<a name="l01418"></a>01418    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>);
<a name="l01419"></a>01419    
<a name="l01420"></a>01420    <span class="comment">/* Transfer */</span>
<a name="l01421"></a>01421    res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <span class="stringliteral">&quot;pbx-transfer&quot;</span>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l01422"></a>01422    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01423"></a>01423       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01424"></a>01424       <span class="keywordflow">return</span> res;
<a name="l01425"></a>01425    }
<a name="l01426"></a>01426    <span class="keywordflow">if</span> (res &gt; 0) <span class="comment">/* If they&apos;ve typed a digit already, handle it */</span>
<a name="l01427"></a>01427       xferto[0] = (char) res;
<a name="l01428"></a>01428 
<a name="l01429"></a>01429    <span class="comment">/* this is specific of atxfer */</span>
<a name="l01430"></a>01430    res = <a class="code" href="app_8h.html#af4825b337b9cd145a059852ce85ec6cd" title="Present a dialtone and collect a certain length extension.">ast_app_dtget</a>(transferer, transferer_real_context, xferto, <span class="keyword">sizeof</span>(xferto), 100, <a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a>);
<a name="l01431"></a>01431    <span class="keywordflow">if</span> (res &lt; 0) {  <span class="comment">/* hangup, would be 0 for invalid and 1 for valid */</span>
<a name="l01432"></a>01432       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01433"></a>01433       <span class="keywordflow">return</span> res;
<a name="l01434"></a>01434    }
<a name="l01435"></a>01435    <span class="keywordflow">if</span> (res == 0) {
<a name="l01436"></a>01436       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Did not read data.\n&quot;</span>);
<a name="l01437"></a>01437       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01438"></a>01438       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <span class="stringliteral">&quot;beeperr&quot;</span>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01439"></a>01439          <span class="keywordflow">return</span> -1;
<a name="l01440"></a>01440       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01441"></a>01441    }
<a name="l01442"></a>01442 
<a name="l01443"></a>01443    <span class="comment">/* valid extension, res == 1 */</span>
<a name="l01444"></a>01444    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(transferer, transferer_real_context, xferto, 1, transferer-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l01445"></a>01445       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Extension %s does not exist in context %s\n&quot;</span>,xferto,transferer_real_context);
<a name="l01446"></a>01446       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01447"></a>01447       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <span class="stringliteral">&quot;beeperr&quot;</span>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01448"></a>01448          <span class="keywordflow">return</span> -1;
<a name="l01449"></a>01449       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01450"></a>01450    }
<a name="l01451"></a>01451 
<a name="l01452"></a>01452    <span class="comment">/* If we are attended transfering to parking, just use builtin_parkcall instead of trying to track all of</span>
<a name="l01453"></a>01453 <span class="comment">    * the different variables for handling this properly with a builtin_atxfer */</span>
<a name="l01454"></a>01454    <span class="keywordflow">if</span> (!strcmp(xferto, <a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>())) {
<a name="l01455"></a>01455       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01456"></a>01456       <span class="keywordflow">return</span> <a class="code" href="features_8c.html#a15da7831191d1f662ee4413a71f505a2" title="support routing for one touch call parking">builtin_parkcall</a>(chan, peer, config, code, sense, data);
<a name="l01457"></a>01457    }
<a name="l01458"></a>01458 
<a name="l01459"></a>01459    l = strlen(xferto);
<a name="l01460"></a>01460    snprintf(xferto + l, <span class="keyword">sizeof</span>(xferto) - l, <span class="stringliteral">&quot;@%s/n&quot;</span>, transferer_real_context);   <span class="comment">/* append context */</span>
<a name="l01461"></a>01461 
<a name="l01462"></a>01462    <span class="comment">/* If we are performing an attended transfer and we have two channels involved then</span>
<a name="l01463"></a>01463 <span class="comment">      copy sound file information to play upon attended transfer completion */</span>
<a name="l01464"></a>01464    <span class="keywordflow">if</span> (transferee) {
<a name="l01465"></a>01465       <span class="keyword">const</span> <span class="keywordtype">char</span> *chan1_attended_sound = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(transferer, <span class="stringliteral">&quot;ATTENDED_TRANSFER_COMPLETE_SOUND&quot;</span>);
<a name="l01466"></a>01466       <span class="keyword">const</span> <span class="keywordtype">char</span> *chan2_attended_sound = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(transferee, <span class="stringliteral">&quot;ATTENDED_TRANSFER_COMPLETE_SOUND&quot;</span>);
<a name="l01467"></a>01467 
<a name="l01468"></a>01468       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan1_attended_sound)) {
<a name="l01469"></a>01469          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(transferer, <span class="stringliteral">&quot;BRIDGE_PLAY_SOUND&quot;</span>, chan1_attended_sound);
<a name="l01470"></a>01470       }
<a name="l01471"></a>01471       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan2_attended_sound)) {
<a name="l01472"></a>01472          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(transferee, <span class="stringliteral">&quot;BRIDGE_PLAY_SOUND&quot;</span>, chan2_attended_sound);
<a name="l01473"></a>01473       }
<a name="l01474"></a>01474    }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476    newchan = <a class="code" href="features_8c.html#ac2ea73c446e5630743ce9e6e90634e05" title="Get feature and dial.">feature_request_and_dial</a>(transferer, transferee, <span class="stringliteral">&quot;Local&quot;</span>, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(transferer-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>),
<a name="l01477"></a>01477       xferto, <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a>, &amp;outstate, transferer-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, transferer-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, 1, transferer-&gt;language);
<a name="l01478"></a>01478 
<a name="l01479"></a>01479    <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(transferer)) {
<a name="l01480"></a>01480       <span class="comment">/* Transferer is up - old behaviour */</span>
<a name="l01481"></a>01481       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(transferer, -1);
<a name="l01482"></a>01482       <span class="keywordflow">if</span> (!newchan) {
<a name="l01483"></a>01483          <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01484"></a>01484          <span class="comment">/* any reason besides user requested cancel and busy triggers the failed sound */</span>
<a name="l01485"></a>01485          <span class="keywordflow">if</span> (outstate != <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a> &amp;&amp; outstate != <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a> &amp;&amp;
<a name="l01486"></a>01486             <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <a class="code" href="features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01487"></a>01487             <span class="keywordflow">return</span> -1;
<a name="l01488"></a>01488          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01489"></a>01489             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play transfer sound!\n&quot;</span>);
<a name="l01490"></a>01490          <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01491"></a>01491       }
<a name="l01492"></a>01492 
<a name="l01493"></a>01493       <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a90ee9a80505894386848734fea6683fb" title="make channels compatible">check_compat</a>(transferer, newchan)) {
<a name="l01494"></a>01494          <span class="comment">/* we do mean transferee here, NOT transferer */</span>
<a name="l01495"></a>01495          <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01496"></a>01496          <span class="keywordflow">return</span> -1;
<a name="l01497"></a>01497       }
<a name="l01498"></a>01498       memset(&amp;bconfig,0,<span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a>));
<a name="l01499"></a>01499       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bconfig.features_caller), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l01500"></a>01500       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(bconfig.features_callee), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l01501"></a>01501       res = <a class="code" href="features_8h.html#a3fe7c7e43b8f3140716d836816bf827f" title="Bridge a call, optionally allowing redirection.">ast_bridge_call</a>(transferer, newchan, &amp;bconfig);
<a name="l01502"></a>01502       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(newchan) || !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(transferer)) {
<a name="l01503"></a>01503          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01504"></a>01504          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01505"></a>01505             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play transfer sound!\n&quot;</span>);
<a name="l01506"></a>01506          <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01507"></a>01507          transferer-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l01508"></a>01508          <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01509"></a>01509       }
<a name="l01510"></a>01510       <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a90ee9a80505894386848734fea6683fb" title="make channels compatible">check_compat</a>(transferee, newchan)) {
<a name="l01511"></a>01511          <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01512"></a>01512          <span class="keywordflow">return</span> -1;
<a name="l01513"></a>01513       }
<a name="l01514"></a>01514       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l01515"></a>01515 
<a name="l01516"></a>01516       <span class="keywordflow">if</span> ((<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(transferee) &lt; 0)
<a name="l01517"></a>01517        || (<a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(transferee, 100) &lt; 0)
<a name="l01518"></a>01518        || (<a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(newchan, 100) &lt; 0)
<a name="l01519"></a>01519        || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(transferee)
<a name="l01520"></a>01520        || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(newchan)) {
<a name="l01521"></a>01521          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01522"></a>01522          <span class="keywordflow">return</span> -1;
<a name="l01523"></a>01523       }
<a name="l01524"></a>01524       xferchan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Transfered/%s&quot;</span>, transferee-&gt;name);
<a name="l01525"></a>01525       <span class="keywordflow">if</span> (!xferchan) {
<a name="l01526"></a>01526          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01527"></a>01527          <span class="keywordflow">return</span> -1;
<a name="l01528"></a>01528       }
<a name="l01529"></a>01529       <span class="comment">/* Make formats okay */</span>
<a name="l01530"></a>01530       xferchan-&gt;<a class="code" href="structast__channel.html#a5ad10add51120d9c9122eca4201dd645">visible_indication</a> = transferer-&gt;<a class="code" href="structast__channel.html#a5ad10add51120d9c9122eca4201dd645">visible_indication</a>;
<a name="l01531"></a>01531       xferchan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = transferee-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l01532"></a>01532       xferchan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = transferee-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l01533"></a>01533       <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(xferchan, transferee);
<a name="l01534"></a>01534       <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(xferchan, transferee-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, transferee-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, transferee-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l01535"></a>01535       xferchan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>;
<a name="l01536"></a>01536       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(xferchan, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01537"></a>01537       xferchan-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l01538"></a>01538       <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(xferchan)))
<a name="l01539"></a>01539          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l01540"></a>01540       newchan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>;
<a name="l01541"></a>01541       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(newchan, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01542"></a>01542       newchan-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l01543"></a>01543       <span class="keywordflow">if</span> (!(tobj = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tobj)))) {
<a name="l01544"></a>01544          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(xferchan);
<a name="l01545"></a>01545          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01546"></a>01546          <span class="keywordflow">return</span> -1;
<a name="l01547"></a>01547       }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(newchan);
<a name="l01550"></a>01550       <span class="keywordflow">if</span> ((features_datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(newchan, &amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL))) {
<a name="l01551"></a>01551             dialfeatures = features_datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l01552"></a>01552       }
<a name="l01553"></a>01553       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(newchan);
<a name="l01554"></a>01554 
<a name="l01555"></a>01555       <span class="keywordflow">if</span> (dialfeatures) {
<a name="l01556"></a>01556          <span class="comment">/* newchan should always be the callee and shows up as callee in dialfeatures, but for some reason</span>
<a name="l01557"></a>01557 <span class="comment">            I don&apos;t currently understand, the abilities of newchan seem to be stored on the caller side */</span>
<a name="l01558"></a>01558          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), &amp;(dialfeatures-&gt;<a class="code" href="structast__dial__features.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01559"></a>01559          dialfeatures = NULL;
<a name="l01560"></a>01560       }
<a name="l01561"></a>01561 
<a name="l01562"></a>01562       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(xferchan);
<a name="l01563"></a>01563       <span class="keywordflow">if</span> ((features_datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(xferchan, &amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL))) {
<a name="l01564"></a>01564          dialfeatures = features_datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l01565"></a>01565       }
<a name="l01566"></a>01566       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(xferchan);
<a name="l01567"></a>01567     
<a name="l01568"></a>01568       <span class="keywordflow">if</span> (dialfeatures) {
<a name="l01569"></a>01569          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), &amp;(dialfeatures-&gt;<a class="code" href="structast__dial__features.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01570"></a>01570       }
<a name="l01571"></a>01571     
<a name="l01572"></a>01572       tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a> = newchan;
<a name="l01573"></a>01573       tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a> = xferchan;
<a name="l01574"></a>01574       tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a> = *config;
<a name="l01575"></a>01575 
<a name="l01576"></a>01576       <span class="keywordflow">if</span> (tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>.<a class="code" href="structast__bridge__config.html#acf41a4cfd7f144294e2d14ab8738704a">end_bridge_callback_data_fixup</a>) {
<a name="l01577"></a>01577          tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>.<a class="code" href="structast__bridge__config.html#acf41a4cfd7f144294e2d14ab8738704a">end_bridge_callback_data_fixup</a>(&amp;tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>);
<a name="l01578"></a>01578       }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(newchan, <a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01581"></a>01581          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play transfer sound!\n&quot;</span>);
<a name="l01582"></a>01582       <a class="code" href="features_8c.html#a9cb8151f1a64734b68ee8cafcc37cf3e" title="create thread for the parked call">bridge_call_thread_launch</a>(tobj);
<a name="l01583"></a>01583       <span class="keywordflow">return</span> -1;      <span class="comment">/* XXX meaning the channel is bridged ? */</span>
<a name="l01584"></a>01584    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(transferee)) {
<a name="l01585"></a>01585       <span class="comment">/* act as blind transfer */</span>
<a name="l01586"></a>01586       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(transferee) &lt; 0) {
<a name="l01587"></a>01587          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01588"></a>01588          <span class="keywordflow">return</span> -1;
<a name="l01589"></a>01589       }
<a name="l01590"></a>01590 
<a name="l01591"></a>01591       <span class="keywordflow">if</span> (!newchan) {
<a name="l01592"></a>01592          <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tries = 0;
<a name="l01593"></a>01593          <span class="keywordtype">char</span> *transferer_tech, *transferer_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(transferer-&gt;name);
<a name="l01594"></a>01594 
<a name="l01595"></a>01595          transferer_tech = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;transferer_name, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l01596"></a>01596          transferer_name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;transferer_name, <span class="stringliteral">&quot;-&quot;</span>);
<a name="l01597"></a>01597 
<a name="l01598"></a>01598          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(transferer_name) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(transferer_tech)) {
<a name="l01599"></a>01599             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Transferer has invalid channel name: &apos;%s&apos;\n&quot;</span>, transferer-&gt;name);
<a name="l01600"></a>01600             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferee, <span class="stringliteral">&quot;beeperr&quot;</span>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01601"></a>01601                <span class="keywordflow">return</span> -1;
<a name="l01602"></a>01602             <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01603"></a>01603          }
<a name="l01604"></a>01604 
<a name="l01605"></a>01605          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;We&apos;re trying to call %s/%s\n&quot;</span>, transferer_tech, transferer_name);
<a name="l01606"></a>01606          newchan = <a class="code" href="features_8c.html#ac2ea73c446e5630743ce9e6e90634e05" title="Get feature and dial.">feature_request_and_dial</a>(transferee, NULL, transferer_tech, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(transferee-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>),
<a name="l01607"></a>01607             transferer_name, <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a>, &amp;outstate, transferee-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, transferee-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, 0, transferer-&gt;language);
<a name="l01608"></a>01608          <span class="keywordflow">while</span> (!newchan &amp;&amp; !<a class="code" href="features_8c.html#a3a4aff3656629deadbb2294abb1b2e50">atxferdropcall</a> &amp;&amp; tries &lt; <a class="code" href="features_8c.html#a42aaa9bbb76f30a8d697eb7c79901045">atxfercallbackretries</a>) {
<a name="l01609"></a>01609             <span class="comment">/* Trying to transfer again */</span>
<a name="l01610"></a>01610             <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(transferee);
<a name="l01611"></a>01611             <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>);
<a name="l01612"></a>01612 
<a name="l01613"></a>01613             newchan = <a class="code" href="features_8c.html#ac2ea73c446e5630743ce9e6e90634e05" title="Get feature and dial.">feature_request_and_dial</a>(transferer, transferee, <span class="stringliteral">&quot;Local&quot;</span>, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(transferer-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>),
<a name="l01614"></a>01614                xferto, <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a>, &amp;outstate, transferer-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, transferer-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, 1, transferer-&gt;language);
<a name="l01615"></a>01615             <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(transferee) &lt; 0) {
<a name="l01616"></a>01616                <span class="keywordflow">if</span> (newchan)
<a name="l01617"></a>01617                   <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01618"></a>01618                <span class="keywordflow">return</span> -1;
<a name="l01619"></a>01619             }
<a name="l01620"></a>01620             <span class="keywordflow">if</span> (!newchan) {
<a name="l01621"></a>01621                <span class="comment">/* Transfer failed, sleeping */</span>
<a name="l01622"></a>01622                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sleeping for %d ms before callback.\n&quot;</span>, <a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a>);
<a name="l01623"></a>01623                <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(transferee, <a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a>);
<a name="l01624"></a>01624                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Trying to callback...\n&quot;</span>);
<a name="l01625"></a>01625                newchan = <a class="code" href="features_8c.html#ac2ea73c446e5630743ce9e6e90634e05" title="Get feature and dial.">feature_request_and_dial</a>(transferee, NULL, transferer_tech, <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(transferee-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>),
<a name="l01626"></a>01626                   transferer_name, <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a>, &amp;outstate, transferee-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, transferee-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, 0, transferer-&gt;language);
<a name="l01627"></a>01627             }
<a name="l01628"></a>01628             tries++;
<a name="l01629"></a>01629          }
<a name="l01630"></a>01630       }
<a name="l01631"></a>01631       <span class="keywordflow">if</span> (!newchan)
<a name="l01632"></a>01632          <span class="keywordflow">return</span> -1;
<a name="l01633"></a>01633 
<a name="l01634"></a>01634       <span class="comment">/* newchan is up, we should prepare transferee and bridge them */</span>
<a name="l01635"></a>01635       <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a90ee9a80505894386848734fea6683fb" title="make channels compatible">check_compat</a>(transferee, newchan)) {
<a name="l01636"></a>01636          <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01637"></a>01637          <span class="keywordflow">return</span> -1;
<a name="l01638"></a>01638       }
<a name="l01639"></a>01639       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l01640"></a>01640 
<a name="l01641"></a>01641       <span class="keywordflow">if</span> ((<a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(transferee, 100) &lt; 0)
<a name="l01642"></a>01642          || (<a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(newchan, 100) &lt; 0)
<a name="l01643"></a>01643          || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(transferee)
<a name="l01644"></a>01644          || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(newchan)) {
<a name="l01645"></a>01645          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01646"></a>01646          <span class="keywordflow">return</span> -1;
<a name="l01647"></a>01647       }
<a name="l01648"></a>01648 
<a name="l01649"></a>01649       xferchan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Transfered/%s&quot;</span>, transferee-&gt;name);
<a name="l01650"></a>01650       <span class="keywordflow">if</span> (!xferchan) {
<a name="l01651"></a>01651          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01652"></a>01652          <span class="keywordflow">return</span> -1;
<a name="l01653"></a>01653       }
<a name="l01654"></a>01654       <span class="comment">/* Make formats okay */</span>
<a name="l01655"></a>01655       xferchan-&gt;<a class="code" href="structast__channel.html#a5ad10add51120d9c9122eca4201dd645">visible_indication</a> = transferer-&gt;<a class="code" href="structast__channel.html#a5ad10add51120d9c9122eca4201dd645">visible_indication</a>;
<a name="l01656"></a>01656       xferchan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = transferee-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l01657"></a>01657       xferchan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = transferee-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l01658"></a>01658       <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(xferchan, transferee);
<a name="l01659"></a>01659       <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(xferchan, transferee-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, transferee-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, transferee-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l01660"></a>01660       xferchan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>;
<a name="l01661"></a>01661       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(xferchan, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01662"></a>01662       xferchan-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l01663"></a>01663       <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(xferchan)))
<a name="l01664"></a>01664          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l01665"></a>01665       newchan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>;
<a name="l01666"></a>01666       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(newchan, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01667"></a>01667       newchan-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l01668"></a>01668       <span class="keywordflow">if</span> (!(tobj = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tobj)))) {
<a name="l01669"></a>01669          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(xferchan);
<a name="l01670"></a>01670          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01671"></a>01671          <span class="keywordflow">return</span> -1;
<a name="l01672"></a>01672       }
<a name="l01673"></a>01673       tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a> = newchan;
<a name="l01674"></a>01674       tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a> = xferchan;
<a name="l01675"></a>01675       tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a> = *config;
<a name="l01676"></a>01676 
<a name="l01677"></a>01677       <span class="keywordflow">if</span> (tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>.<a class="code" href="structast__bridge__config.html#acf41a4cfd7f144294e2d14ab8738704a">end_bridge_callback_data_fixup</a>) {
<a name="l01678"></a>01678          tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>.<a class="code" href="structast__bridge__config.html#acf41a4cfd7f144294e2d14ab8738704a">end_bridge_callback_data_fixup</a>(&amp;tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a73a47a6002f06855dd9680bffbebe9eb">bconfig</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#aeae940a911bb245ea9e431344af07ae9">peer</a>, tobj-&gt;<a class="code" href="structast__bridge__thread__obj.html#a9e9c636288a37a233813953123bf7dcc">chan</a>);
<a name="l01679"></a>01679       }
<a name="l01680"></a>01680 
<a name="l01681"></a>01681       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(newchan, <a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l01682"></a>01682          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play transfer sound!\n&quot;</span>);
<a name="l01683"></a>01683       <a class="code" href="features_8c.html#a9cb8151f1a64734b68ee8cafcc37cf3e" title="create thread for the parked call">bridge_call_thread_launch</a>(tobj);
<a name="l01684"></a>01684       <span class="keywordflow">return</span> -1;      <span class="comment">/* XXX meaning the channel is bridged ? */</span>
<a name="l01685"></a>01685    } <span class="keywordflow">else</span> {
<a name="l01686"></a>01686       <span class="comment">/* Transferee hung up */</span>
<a name="l01687"></a>01687       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01688"></a>01688       <span class="keywordflow">return</span> -1;
<a name="l01689"></a>01689    }
<a name="l01690"></a>01690 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab70776da6fa50ce2057f4401fd1f676e"></a><!-- doxytag: member="features.c::builtin_automixmonitor" ref="ab70776da6fa50ce2057f4401fd1f676e" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int builtin_automixmonitor </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01105">1105</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="audiohook_8h_source.html#l00037">AST_AUDIOHOOK_TYPE_SPY</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="audiohook_8c_source.html#l00740">ast_channel_audiohook_count_by_source()</a>, <a class="el" href="audiohook_8c_source.html#l00782">ast_channel_audiohook_count_by_source_running()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="features_8h_source.html#l00068">AST_FEATURE_RETURN_SUCCESS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="features_8c_source.html#l00241">courtesytone</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00267">mixmonitor_app</a>, <a class="el" href="features_8c_source.html#l00268">mixmonitor_ok</a>, <a class="el" href="app__mixmonitor_8c_source.html#l00137">mixmonitor_spy_type</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l01322">pbx_exec()</a>, <a class="el" href="pbx_8c_source.html#l01363">pbx_findapp()</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="features_8c_source.html#l00918">set_peers()</a>, <a class="el" href="features_8c_source.html#l00270">stopmixmonitor_app</a>, and <a class="el" href="features_8c_source.html#l00271">stopmixmonitor_ok</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01106"></a>01106 {
<a name="l01107"></a>01107    <span class="keywordtype">char</span> *caller_chan_id = NULL, *callee_chan_id = NULL, *args = NULL, *touch_filename = NULL;
<a name="l01108"></a>01108    <span class="keywordtype">int</span> x = 0;
<a name="l01109"></a>01109    <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01110"></a>01110    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *caller_chan, *callee_chan;
<a name="l01111"></a>01111    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__mixmonitor_8c.html#a7ba77e7cd471948c1b310598805cbb72">mixmonitor_spy_type</a> = <span class="stringliteral">&quot;MixMonitor&quot;</span>;
<a name="l01112"></a>01112    <span class="keywordtype">int</span> count = 0;
<a name="l01113"></a>01113 
<a name="l01114"></a>01114    <span class="keywordflow">if</span> (!<a class="code" href="features_8c.html#ad76df5fd37675aefb1b43395687d81f5">mixmonitor_ok</a>) {
<a name="l01115"></a>01115       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Cannot record the call. The mixmonitor application is disabled.\n&quot;</span>);
<a name="l01116"></a>01116       <span class="keywordflow">return</span> -1;
<a name="l01117"></a>01117    }
<a name="l01118"></a>01118 
<a name="l01119"></a>01119    <span class="keywordflow">if</span> (!(<a class="code" href="features_8c.html#a863e1104b2f52359385b7764b1f727f4">mixmonitor_app</a> = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;MixMonitor&quot;</span>))) {
<a name="l01120"></a>01120       <a class="code" href="features_8c.html#ad76df5fd37675aefb1b43395687d81f5">mixmonitor_ok</a> = 0;
<a name="l01121"></a>01121       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Cannot record the call. The mixmonitor application is disabled.\n&quot;</span>);
<a name="l01122"></a>01122       <span class="keywordflow">return</span> -1;
<a name="l01123"></a>01123    }
<a name="l01124"></a>01124 
<a name="l01125"></a>01125    <a class="code" href="features_8c.html#a130d6c414eebccdc195fa893b47be865" title="set caller and callee according to the direction">set_peers</a>(&amp;caller_chan, &amp;callee_chan, peer, chan, sense);
<a name="l01126"></a>01126 
<a name="l01127"></a>01127    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>)) {
<a name="l01128"></a>01128       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(callee_chan))
<a name="l01129"></a>01129          <span class="keywordflow">return</span> -1;
<a name="l01130"></a>01130       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(caller_chan, <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l01131"></a>01131          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play courtesy tone!\n&quot;</span>);
<a name="l01132"></a>01132          <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(callee_chan);
<a name="l01133"></a>01133          <span class="keywordflow">return</span> -1;
<a name="l01134"></a>01134       }
<a name="l01135"></a>01135       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(callee_chan))
<a name="l01136"></a>01136          <span class="keywordflow">return</span> -1;
<a name="l01137"></a>01137    }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(callee_chan);
<a name="l01140"></a>01140    count = <a class="code" href="audiohook_8h.html#a86f07afe75e6c2405d124d98faaf9800" title="Find out how many audiohooks from a certain source exist on a given channel, regardless...">ast_channel_audiohook_count_by_source</a>(callee_chan, mixmonitor_spy_type, <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>);
<a name="l01141"></a>01141    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(callee_chan);
<a name="l01142"></a>01142 
<a name="l01143"></a>01143    <span class="comment">/* This means a mixmonitor is attached to the channel, running or not is unknown. */</span>
<a name="l01144"></a>01144    <span class="keywordflow">if</span> (count &gt; 0) {
<a name="l01145"></a>01145       
<a name="l01146"></a>01146       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hit &apos;%s&apos; to stop recording call.\n&quot;</span>, code);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148       <span class="comment">/* Make sure they are running */</span>
<a name="l01149"></a>01149       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(callee_chan);
<a name="l01150"></a>01150       count = <a class="code" href="audiohook_8h.html#a9c85bb250bc65d74fecce3a388ef30bd" title="Find out how many spies of a certain type exist on a given channel, and are in state...">ast_channel_audiohook_count_by_source_running</a>(callee_chan, mixmonitor_spy_type, <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>);
<a name="l01151"></a>01151       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(callee_chan);
<a name="l01152"></a>01152       <span class="keywordflow">if</span> (count &gt; 0) {
<a name="l01153"></a>01153          <span class="keywordflow">if</span> (!<a class="code" href="features_8c.html#a76d9bec7d89bd468e2af244893c23c3e">stopmixmonitor_ok</a>) {
<a name="l01154"></a>01154             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Cannot stop recording the call. The stopmixmonitor application is disabled.\n&quot;</span>);
<a name="l01155"></a>01155             <span class="keywordflow">return</span> -1;
<a name="l01156"></a>01156          }
<a name="l01157"></a>01157          <span class="keywordflow">if</span> (!(<a class="code" href="features_8c.html#a6e92ba0da6795c93b26c0e839fb4687e">stopmixmonitor_app</a> = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;StopMixMonitor&quot;</span>))) {
<a name="l01158"></a>01158             <a class="code" href="features_8c.html#a76d9bec7d89bd468e2af244893c23c3e">stopmixmonitor_ok</a> = 0;
<a name="l01159"></a>01159             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Cannot stop recording the call. The stopmixmonitor application is disabled.\n&quot;</span>);
<a name="l01160"></a>01160             <span class="keywordflow">return</span> -1;
<a name="l01161"></a>01161          } <span class="keywordflow">else</span> {
<a name="l01162"></a>01162             <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(callee_chan, <a class="code" href="features_8c.html#a6e92ba0da6795c93b26c0e839fb4687e">stopmixmonitor_app</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01163"></a>01163             <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01164"></a>01164          }
<a name="l01165"></a>01165       }
<a name="l01166"></a>01166       
<a name="l01167"></a>01167       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,<span class="stringliteral">&quot;Stopped MixMonitors are attached to the channel.\n&quot;</span>); 
<a name="l01168"></a>01168    }        
<a name="l01169"></a>01169 
<a name="l01170"></a>01170    <span class="keywordflow">if</span> (caller_chan &amp;&amp; callee_chan) {
<a name="l01171"></a>01171       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_format = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MIXMONITOR_FORMAT&quot;</span>);
<a name="l01172"></a>01172       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_monitor = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MIXMONITOR&quot;</span>);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174       <span class="keywordflow">if</span> (!touch_format)
<a name="l01175"></a>01175          touch_format = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MIXMONITOR_FORMAT&quot;</span>);
<a name="l01176"></a>01176 
<a name="l01177"></a>01177       <span class="keywordflow">if</span> (!touch_monitor)
<a name="l01178"></a>01178          touch_monitor = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MIXMONITOR&quot;</span>);
<a name="l01179"></a>01179 
<a name="l01180"></a>01180       <span class="keywordflow">if</span> (touch_monitor) {
<a name="l01181"></a>01181          len = strlen(touch_monitor) + 50;
<a name="l01182"></a>01182          args = alloca(len);
<a name="l01183"></a>01183          touch_filename = alloca(len);
<a name="l01184"></a>01184          snprintf(touch_filename, len, <span class="stringliteral">&quot;auto-%ld-%s&quot;</span>, (<span class="keywordtype">long</span>)time(NULL), touch_monitor);
<a name="l01185"></a>01185          snprintf(args, len, <span class="stringliteral">&quot;%s.%s,b&quot;</span>, touch_filename, (touch_format) ? touch_format : <span class="stringliteral">&quot;wav&quot;</span>);
<a name="l01186"></a>01186       } <span class="keywordflow">else</span> {
<a name="l01187"></a>01187          caller_chan_id = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(caller_chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, caller_chan-&gt;name));
<a name="l01188"></a>01188          callee_chan_id = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(callee_chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, callee_chan-&gt;name));
<a name="l01189"></a>01189          len = strlen(caller_chan_id) + strlen(callee_chan_id) + 50;
<a name="l01190"></a>01190          args = alloca(len);
<a name="l01191"></a>01191          touch_filename = alloca(len);
<a name="l01192"></a>01192          snprintf(touch_filename, len, <span class="stringliteral">&quot;auto-%ld-%s-%s&quot;</span>, (<span class="keywordtype">long</span>)time(NULL), caller_chan_id, callee_chan_id);
<a name="l01193"></a>01193          snprintf(args, len, <span class="stringliteral">&quot;%s.%s,b&quot;</span>, touch_filename, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(touch_format, <span class="stringliteral">&quot;wav&quot;</span>));
<a name="l01194"></a>01194       }
<a name="l01195"></a>01195 
<a name="l01196"></a>01196       <span class="keywordflow">for</span>( x = 0; x &lt; strlen(args); x++) {
<a name="l01197"></a>01197          <span class="keywordflow">if</span> (args[x] == <span class="charliteral">&apos;/&apos;</span>)
<a name="l01198"></a>01198             args[x] = <span class="charliteral">&apos;-&apos;</span>;
<a name="l01199"></a>01199       }
<a name="l01200"></a>01200 
<a name="l01201"></a>01201       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hit &apos;%s&apos; to record call. filename: %s\n&quot;</span>, code, touch_filename);
<a name="l01202"></a>01202 
<a name="l01203"></a>01203       <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(callee_chan, <a class="code" href="features_8c.html#a863e1104b2f52359385b7764b1f727f4">mixmonitor_app</a>, args);
<a name="l01204"></a>01204       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MIXMONITOR_OUTPUT&quot;</span>, touch_filename);
<a name="l01205"></a>01205       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MIXMONITOR_OUTPUT&quot;</span>, touch_filename);
<a name="l01206"></a>01206       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01207"></a>01207    
<a name="l01208"></a>01208    }
<a name="l01209"></a>01209 
<a name="l01210"></a>01210    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Cannot record the call. One or both channels have gone away.\n&quot;</span>);
<a name="l01211"></a>01211    <span class="keywordflow">return</span> -1;
<a name="l01212"></a>01212 
<a name="l01213"></a>01213 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a61aab8abfc9670c05a03793d9ed4f597"></a><!-- doxytag: member="features.c::builtin_automonitor" ref="a61aab8abfc9670c05a03793d9ed4f597" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int builtin_automonitor </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Monitor a channel by DTMF. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>channel requesting monitor </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>peer</em>&nbsp;</td><td>channel to be monitored </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>config</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>code</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sense</em>&nbsp;</td><td>feature options</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>Check monitor app enabled, setup <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>, both caller/callee chans not null get TOUCH_MONITOR variable for filename if exists, exec monitor app. </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>AST_FEATURE_RETURN_SUCCESS</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on error. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01012">1012</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8h_source.html#l00068">AST_FEATURE_RETURN_SUCCESS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="features_8c_source.html#l00241">courtesytone</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="channel_8h_source.html#l00425">ast_channel::monitor</a>, <a class="el" href="features_8c_source.html#l00264">monitor_app</a>, <a class="el" href="features_8c_source.html#l00265">monitor_ok</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="pbx_8c_source.html#l01322">pbx_exec()</a>, <a class="el" href="pbx_8c_source.html#l01363">pbx_findapp()</a>, <a class="el" href="features_8c_source.html#l00973">play_message_in_bridged_call()</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="features_8c_source.html#l00918">set_peers()</a>, and <a class="el" href="structast__channel__monitor.html#ad5c0f502e23625be7e65715c03c54748">ast_channel_monitor::stop</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01013"></a>01013 {
<a name="l01014"></a>01014    <span class="keywordtype">char</span> *caller_chan_id = NULL, *callee_chan_id = NULL, *args = NULL, *touch_filename = NULL;
<a name="l01015"></a>01015    <span class="keywordtype">int</span> x = 0;
<a name="l01016"></a>01016    <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01017"></a>01017    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *caller_chan, *callee_chan;
<a name="l01018"></a>01018    <span class="keyword">const</span> <span class="keywordtype">char</span> *automon_message_start = NULL;
<a name="l01019"></a>01019    <span class="keyword">const</span> <span class="keywordtype">char</span> *automon_message_stop = NULL;
<a name="l01020"></a>01020 
<a name="l01021"></a>01021    <span class="keywordflow">if</span> (!<a class="code" href="features_8c.html#a31438b92e816fd5c5b858f7424205aaa">monitor_ok</a>) {
<a name="l01022"></a>01022       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Cannot record the call. The monitor application is disabled.\n&quot;</span>);
<a name="l01023"></a>01023       <span class="keywordflow">return</span> -1;
<a name="l01024"></a>01024    }
<a name="l01025"></a>01025 
<a name="l01026"></a>01026    <span class="keywordflow">if</span> (!<a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a> &amp;&amp; !(<a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a> = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;Monitor&quot;</span>))) {
<a name="l01027"></a>01027       <a class="code" href="features_8c.html#a31438b92e816fd5c5b858f7424205aaa">monitor_ok</a> = 0;
<a name="l01028"></a>01028       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Cannot record the call. The monitor application is disabled.\n&quot;</span>);
<a name="l01029"></a>01029       <span class="keywordflow">return</span> -1;
<a name="l01030"></a>01030    }
<a name="l01031"></a>01031 
<a name="l01032"></a>01032    <a class="code" href="features_8c.html#a130d6c414eebccdc195fa893b47be865" title="set caller and callee according to the direction">set_peers</a>(&amp;caller_chan, &amp;callee_chan, peer, chan, sense);
<a name="l01033"></a>01033    <span class="keywordflow">if</span> (caller_chan) {   <span class="comment">/* Find extra messages */</span>
<a name="l01034"></a>01034       automon_message_start = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_MESSAGE_START&quot;</span>);
<a name="l01035"></a>01035       automon_message_stop = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_MESSAGE_STOP&quot;</span>);
<a name="l01036"></a>01036    }
<a name="l01037"></a>01037 
<a name="l01038"></a>01038    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>)) {  <span class="comment">/* Play courtesy tone if configured */</span>
<a name="l01039"></a>01039       <span class="keywordflow">if</span>(<a class="code" href="features_8c.html#ab9136d54e94186e675c182cc933a46f9" title="Play message to both caller and callee in bridged call, plays synchronously, autoservicing...">play_message_in_bridged_call</a>(caller_chan, callee_chan, <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>) == -1) {
<a name="l01040"></a>01040          <span class="keywordflow">return</span> -1;
<a name="l01041"></a>01041       }
<a name="l01042"></a>01042    }
<a name="l01043"></a>01043    
<a name="l01044"></a>01044    <span class="keywordflow">if</span> (callee_chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>) {
<a name="l01045"></a>01045       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;User hit &apos;%s&apos; to stop recording call.\n&quot;</span>, code);
<a name="l01046"></a>01046       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(automon_message_stop)) {
<a name="l01047"></a>01047          <a class="code" href="features_8c.html#ab9136d54e94186e675c182cc933a46f9" title="Play message to both caller and callee in bridged call, plays synchronously, autoservicing...">play_message_in_bridged_call</a>(caller_chan, callee_chan, automon_message_stop);
<a name="l01048"></a>01048       }
<a name="l01049"></a>01049       callee_chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#ad5c0f502e23625be7e65715c03c54748">stop</a>(callee_chan, 1);
<a name="l01050"></a>01050       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01051"></a>01051    }
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    <span class="keywordflow">if</span> (caller_chan &amp;&amp; callee_chan) {
<a name="l01054"></a>01054       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_format = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_FORMAT&quot;</span>);
<a name="l01055"></a>01055       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_monitor = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MONITOR&quot;</span>);
<a name="l01056"></a>01056       <span class="keyword">const</span> <span class="keywordtype">char</span> *touch_monitor_prefix = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_PREFIX&quot;</span>);
<a name="l01057"></a>01057 
<a name="l01058"></a>01058       <span class="keywordflow">if</span> (!touch_format)
<a name="l01059"></a>01059          touch_format = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_FORMAT&quot;</span>);
<a name="l01060"></a>01060 
<a name="l01061"></a>01061       <span class="keywordflow">if</span> (!touch_monitor)
<a name="l01062"></a>01062          touch_monitor = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MONITOR&quot;</span>);
<a name="l01063"></a>01063    
<a name="l01064"></a>01064       <span class="keywordflow">if</span> (!touch_monitor_prefix)
<a name="l01065"></a>01065          touch_monitor_prefix = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_PREFIX&quot;</span>);
<a name="l01066"></a>01066    
<a name="l01067"></a>01067       <span class="keywordflow">if</span> (touch_monitor) {
<a name="l01068"></a>01068          len = strlen(touch_monitor) + 50;
<a name="l01069"></a>01069          args = alloca(len);
<a name="l01070"></a>01070          touch_filename = alloca(len);
<a name="l01071"></a>01071          snprintf(touch_filename, len, <span class="stringliteral">&quot;%s-%ld-%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(touch_monitor_prefix, <span class="stringliteral">&quot;auto&quot;</span>), (<span class="keywordtype">long</span>)time(NULL), touch_monitor);
<a name="l01072"></a>01072          snprintf(args, len, <span class="stringliteral">&quot;%s,%s,m&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(touch_format, <span class="stringliteral">&quot;wav&quot;</span>), touch_filename);
<a name="l01073"></a>01073       } <span class="keywordflow">else</span> {
<a name="l01074"></a>01074          caller_chan_id = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(caller_chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, caller_chan-&gt;name));
<a name="l01075"></a>01075          callee_chan_id = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(callee_chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, callee_chan-&gt;name));
<a name="l01076"></a>01076          len = strlen(caller_chan_id) + strlen(callee_chan_id) + 50;
<a name="l01077"></a>01077          args = alloca(len);
<a name="l01078"></a>01078          touch_filename = alloca(len);
<a name="l01079"></a>01079          snprintf(touch_filename, len, <span class="stringliteral">&quot;%s-%ld-%s-%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(touch_monitor_prefix, <span class="stringliteral">&quot;auto&quot;</span>), (<span class="keywordtype">long</span>)time(NULL), caller_chan_id, callee_chan_id);
<a name="l01080"></a>01080          snprintf(args, len, <span class="stringliteral">&quot;%s,%s,m&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(touch_format, <span class="stringliteral">&quot;wav&quot;</span>), touch_filename);
<a name="l01081"></a>01081       }
<a name="l01082"></a>01082 
<a name="l01083"></a>01083       <span class="keywordflow">for</span>(x = 0; x &lt; strlen(args); x++) {
<a name="l01084"></a>01084          <span class="keywordflow">if</span> (args[x] == <span class="charliteral">&apos;/&apos;</span>)
<a name="l01085"></a>01085             args[x] = <span class="charliteral">&apos;-&apos;</span>;
<a name="l01086"></a>01086       }
<a name="l01087"></a>01087       
<a name="l01088"></a>01088       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;User hit &apos;%s&apos; to record call. filename: %s\n&quot;</span>, code, args);
<a name="l01089"></a>01089 
<a name="l01090"></a>01090       <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(callee_chan, <a class="code" href="features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a>, args);
<a name="l01091"></a>01091       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(callee_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_OUTPUT&quot;</span>, touch_filename);
<a name="l01092"></a>01092       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(caller_chan, <span class="stringliteral">&quot;TOUCH_MONITOR_OUTPUT&quot;</span>, touch_filename);
<a name="l01093"></a>01093 
<a name="l01094"></a>01094       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(automon_message_start)) {  <span class="comment">/* Play start message for both channels */</span>
<a name="l01095"></a>01095          <a class="code" href="features_8c.html#ab9136d54e94186e675c182cc933a46f9" title="Play message to both caller and callee in bridged call, plays synchronously, autoservicing...">play_message_in_bridged_call</a>(caller_chan, callee_chan, automon_message_start);
<a name="l01096"></a>01096       }
<a name="l01097"></a>01097    
<a name="l01098"></a>01098       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01099"></a>01099    }
<a name="l01100"></a>01100    
<a name="l01101"></a>01101    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;Cannot record the call. One or both channels have gone away.\n&quot;</span>);  
<a name="l01102"></a>01102    <span class="keywordflow">return</span> -1;
<a name="l01103"></a>01103 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab15661cb2b776df35b0ae031fc5b0be1"></a><!-- doxytag: member="features.c::builtin_blindtransfer" ref="ab15661cb2b776df35b0ae031fc5b0be1" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int builtin_blindtransfer </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Blind transfer <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> to another <a class="el" href="structextension.html">extension</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>channel to be transfered </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>peer</em>&nbsp;</td><td>channel initiated blind transfer </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>config</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>code</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sense</em>&nbsp;</td><td>feature options</td></tr>
  </table>
  </dd>
</dl>
<p>Place chan on hold, check if transferred to parkinglot <a class="el" href="structextension.html">extension</a>, otherwise check <a class="el" href="structextension.html">extension</a> exists and transfer caller. </p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>AST_FEATURE_RETURN_SUCCESS.</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000069">Todo:</a></b></dt><dd>XXX Maybe we should have another <a class="el" href="structmessage.html">message</a> here instead of invalid <a class="el" href="structextension.html">extension</a> XXX </dd></dl>
</p>

<p>Definition at line <a class="el" href="features_8c_source.html#l01265">1265</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="app_8c_source.html#l00076">ast_app_dtget()</a>, <a class="el" href="pbx_8c_source.html#l07344">ast_async_goto()</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="cdr_8c_source.html#l00452">ast_cdr_alloc()</a>, <a class="el" href="cdr_8c_source.html#l00844">ast_cdr_init()</a>, <a class="el" href="cdr_8c_source.html#l00674">ast_cdr_start()</a>, <a class="el" href="frame_8h_source.html#l00313">AST_CONTROL_HOLD</a>, <a class="el" href="file_8h_source.html#l00047">AST_DIGIT_ANY</a>, <a class="el" href="pbx_8c_source.html#l04143">ast_exists_extension()</a>, <a class="el" href="features_8h_source.html#l00070">AST_FEATURE_RETURN_PARKFAILED</a>, <a class="el" href="features_8h_source.html#l00068">AST_FEATURE_RETURN_SUCCESS</a>, <a class="el" href="channel_8h_source.html#l00565">AST_FLAG_BRIDGE_HANGUP_DONT</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="features_8c_source.html#l00315">ast_parking_ext()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="file_8c_source.html#l00122">ast_stopstream()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="channel_8h_source.html#l00422">ast_channel::cdr</a>, <a class="el" href="cdr_8h_source.html#l00079">ast_cdr::channel</a>, <a class="el" href="features_8c_source.html#l00366">check_goto_on_transfer()</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="cdr_8h_source.html#l00081">ast_cdr::dstchannel</a>, <a class="el" href="features_8c_source.html#l01221">finishup()</a>, <a class="el" href="cdr_8h_source.html#l00083">ast_cdr::lastapp</a>, <a class="el" href="cdr_8h_source.html#l00085">ast_cdr::lastdata</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00904">masq_park_call_announce()</a>, <a class="el" href="channel_8h_source.html#l00418">ast_channel::pbx</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="features_8c_source.html#l01236">real_ctx()</a>, <a class="el" href="features_8c_source.html#l00351">set_c_e_p()</a>, <a class="el" href="features_8c_source.html#l00918">set_peers()</a>, <a class="el" href="features_8c_source.html#l00250">transferdigittimeout</a>, and <a class="el" href="features_8c_source.html#l00244">xferfailsound</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01266"></a>01266 {
<a name="l01267"></a>01267    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *transferer;
<a name="l01268"></a>01268    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *transferee;
<a name="l01269"></a>01269    <span class="keyword">const</span> <span class="keywordtype">char</span> *transferer_real_context;
<a name="l01270"></a>01270    <span class="keywordtype">char</span> xferto[256];
<a name="l01271"></a>01271    <span class="keywordtype">int</span> res, parkstatus = 0;
<a name="l01272"></a>01272 
<a name="l01273"></a>01273    <a class="code" href="features_8c.html#a130d6c414eebccdc195fa893b47be865" title="set caller and callee according to the direction">set_peers</a>(&amp;transferer, &amp;transferee, peer, chan, sense);
<a name="l01274"></a>01274    transferer_real_context = <a class="code" href="features_8c.html#aaae36759026f17aea180b5ba7fad3918" title="Find the context for the transfer.">real_ctx</a>(transferer, transferee);
<a name="l01275"></a>01275    <span class="comment">/* Start autoservice on chan while we talk to the originator */</span>
<a name="l01276"></a>01276    <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(transferee);
<a name="l01277"></a>01277    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(transferee, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>);
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    memset(xferto, 0, <span class="keyword">sizeof</span>(xferto));
<a name="l01280"></a>01280 
<a name="l01281"></a>01281    <span class="comment">/* Transfer */</span>
<a name="l01282"></a>01282    res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <span class="stringliteral">&quot;pbx-transfer&quot;</span>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l01283"></a>01283    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01284"></a>01284       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01285"></a>01285       <span class="keywordflow">return</span> -1; <span class="comment">/* error ? */</span>
<a name="l01286"></a>01286    }
<a name="l01287"></a>01287    <span class="keywordflow">if</span> (res &gt; 0)   <span class="comment">/* If they&apos;ve typed a digit already, handle it */</span>
<a name="l01288"></a>01288       xferto[0] = (char) res;
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(transferer);
<a name="l01291"></a>01291    res = <a class="code" href="app_8h.html#af4825b337b9cd145a059852ce85ec6cd" title="Present a dialtone and collect a certain length extension.">ast_app_dtget</a>(transferer, transferer_real_context, xferto, <span class="keyword">sizeof</span>(xferto), 100, <a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a>);
<a name="l01292"></a>01292    <span class="keywordflow">if</span> (res &lt; 0) {  <span class="comment">/* hangup, would be 0 for invalid and 1 for valid */</span>
<a name="l01293"></a>01293       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01294"></a>01294       <span class="keywordflow">return</span> res;
<a name="l01295"></a>01295    }
<a name="l01296"></a>01296    <span class="keywordflow">if</span> (!strcmp(xferto, <a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>())) {
<a name="l01297"></a>01297       res = <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01298"></a>01298       <span class="keywordflow">if</span> (res)
<a name="l01299"></a>01299          res = -1;
<a name="l01300"></a>01300       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(parkstatus = <a class="code" href="features_8c.html#a6969031880bd3d320cec5f1f89c83325">masq_park_call_announce</a>(transferee, transferer, 0, NULL))) {   <span class="comment">/* success */</span>
<a name="l01301"></a>01301          <span class="comment">/* We return non-zero, but tell the PBX not to hang the channel when</span>
<a name="l01302"></a>01302 <span class="comment">            the thread dies -- We have to be careful now though.  We are responsible for </span>
<a name="l01303"></a>01303 <span class="comment">            hanging up the channel, else it will never be hung up! */</span>
<a name="l01304"></a>01304 
<a name="l01305"></a>01305          <span class="keywordflow">return</span> 0;
<a name="l01306"></a>01306       } <span class="keywordflow">else</span> {
<a name="l01307"></a>01307          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to park call %s, parkstatus = %d\n&quot;</span>, transferee-&gt;name, parkstatus);
<a name="l01308"></a>01308       }<span class="comment"></span>
<a name="l01309"></a>01309 <span class="comment">      /*! \todo XXX Maybe we should have another message here instead of invalid extension XXX */</span>
<a name="l01310"></a>01310    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(transferee, transferer_real_context, xferto, 1, transferer-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l01311"></a>01311       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(transferer, <span class="stringliteral">&quot;BLINDTRANSFER&quot;</span>, transferee-&gt;name);
<a name="l01312"></a>01312       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(transferee, <span class="stringliteral">&quot;BLINDTRANSFER&quot;</span>, transferer-&gt;name);
<a name="l01313"></a>01313       res=<a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01314"></a>01314       <span class="keywordflow">if</span> (!transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) { <span class="comment">/* this code should never get called (in a perfect world) */</span>
<a name="l01315"></a>01315          transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>=<a class="code" href="cdr_8h.html#a29ba08b358224b4c820e5df826273b5b" title="Allocate a CDR record.">ast_cdr_alloc</a>();
<a name="l01316"></a>01316          <span class="keywordflow">if</span> (transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l01317"></a>01317             <a class="code" href="cdr_8h.html#a551fbacb2f2b4caaf57243c601c28a83" title="Initialize based on a channel.">ast_cdr_init</a>(transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, transferer); <span class="comment">/* initialize our channel&apos;s cdr */</span>
<a name="l01318"></a>01318             <a class="code" href="cdr_8h.html#af788ef701483a64b77656f272843bcd4" title="Start a call.">ast_cdr_start</a>(transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>);
<a name="l01319"></a>01319          }
<a name="l01320"></a>01320       }
<a name="l01321"></a>01321       <span class="keywordflow">if</span> (transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>) {
<a name="l01322"></a>01322          <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *swap = transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>;
<a name="l01323"></a>01323          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;transferer=%s; transferee=%s; lastapp=%s; lastdata=%s; chan=%s; dstchan=%s\n&quot;</span>,
<a name="l01324"></a>01324                transferer-&gt;name, transferee-&gt;name, transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, 
<a name="l01325"></a>01325                transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>, transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>);
<a name="l01326"></a>01326          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;TRANSFEREE; lastapp=%s; lastdata=%s, chan=%s; dstchan=%s\n&quot;</span>,
<a name="l01327"></a>01327                transferee-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#ae7697234189954ec7c6a81b4ab691b85">lastapp</a>, transferee-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a2176704f41b4368f2dfa94b64bfcfb6a">lastdata</a>, transferee-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a6396dbd53fd6fedc1fc3ba2743f00eca">channel</a>, transferee-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>-&gt;<a class="code" href="structast__cdr.html#a0d43f7cac6179c7c4f9521f3138195b4">dstchannel</a>);
<a name="l01328"></a>01328          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;transferer_real_context=%s; xferto=%s\n&quot;</span>, transferer_real_context, xferto);
<a name="l01329"></a>01329          <span class="comment">/* swap cdrs-- it will save us some time &amp; work */</span>
<a name="l01330"></a>01330          transferer-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = transferee-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>;
<a name="l01331"></a>01331          transferee-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a> = swap;
<a name="l01332"></a>01332       }
<a name="l01333"></a>01333       <span class="keywordflow">if</span> (!transferee-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>) {
<a name="l01334"></a>01334          <span class="comment">/* Doh!  Use our handy async_goto functions */</span>
<a name="l01335"></a>01335          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Transferring %s to &apos;%s&apos; (context %s) priority 1\n&quot;</span>
<a name="l01336"></a>01336                         ,transferee-&gt;name, xferto, transferer_real_context);
<a name="l01337"></a>01337          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#ae0ba2eb966a9e3376de61d30513f7302" title="Set the channel to next execute the specified dialplan location.">ast_async_goto</a>(transferee, transferer_real_context, xferto, 1))
<a name="l01338"></a>01338             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Async goto failed :-(\n&quot;</span>);
<a name="l01339"></a>01339       } <span class="keywordflow">else</span> {
<a name="l01340"></a>01340          <span class="comment">/* Set the channel&apos;s new extension, since it exists, using transferer context */</span>
<a name="l01341"></a>01341          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(transferee, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a833a312f49eac50f239fd42dc9e61ffb">AST_FLAG_BRIDGE_HANGUP_DONT</a>); <span class="comment">/* don&apos;t let the after-bridge code run the h-exten */</span>
<a name="l01342"></a>01342          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;ABOUT TO AST_ASYNC_GOTO, have a pbx... set HANGUP_DONT on chan=%s\n&quot;</span>, transferee-&gt;name);
<a name="l01343"></a>01343          <a class="code" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c" title="store context, extension and priority">set_c_e_p</a>(transferee, transferer_real_context, xferto, 0);
<a name="l01344"></a>01344       }
<a name="l01345"></a>01345       <a class="code" href="features_8c.html#a44c105a1da30fd5e1155653a681e6de5" title="Check goto on transfer.">check_goto_on_transfer</a>(transferer);
<a name="l01346"></a>01346       <span class="keywordflow">return</span> res;
<a name="l01347"></a>01347    } <span class="keywordflow">else</span> {
<a name="l01348"></a>01348       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Unable to find extension &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, xferto, transferer_real_context);
<a name="l01349"></a>01349    }
<a name="l01350"></a>01350    <span class="keywordflow">if</span> (parkstatus != <a class="code" href="features_8h.html#a67087b9e4e17fecd92350e2b5cfcb493">AST_FEATURE_RETURN_PARKFAILED</a> &amp;&amp; <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(transferer, <a class="code" href="features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>) &lt; 0) {
<a name="l01351"></a>01351       <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01352"></a>01352       <span class="keywordflow">return</span> -1;
<a name="l01353"></a>01353    }
<a name="l01354"></a>01354    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(transferer);
<a name="l01355"></a>01355    res = <a class="code" href="features_8c.html#abea3124e77c14c3a0388e53c3da3231e">finishup</a>(transferee);
<a name="l01356"></a>01356    <span class="keywordflow">if</span> (res) {
<a name="l01357"></a>01357       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Hungup during autoservice stop on &apos;%s&apos;\n&quot;</span>, transferee-&gt;name);
<a name="l01358"></a>01358       <span class="keywordflow">return</span> res;
<a name="l01359"></a>01359    }
<a name="l01360"></a>01360    <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;
<a name="l01361"></a>01361 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2ad9c6a6c7f2864f65291114b64543b7"></a><!-- doxytag: member="features.c::builtin_disconnect" ref="a2ad9c6a6c7f2864f65291114b64543b7" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int builtin_disconnect </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01215">1215</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8h_source.html#l00064">AST_FEATURE_RETURN_HANGUP</a>, and <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01216"></a>01216 {
<a name="l01217"></a>01217    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;User hit &apos;%s&apos; to disconnect call.\n&quot;</span>, code);
<a name="l01218"></a>01218    <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a15a8f2f0ac06ed7209ce480e1d4b6352">AST_FEATURE_RETURN_HANGUP</a>;
<a name="l01219"></a>01219 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a15da7831191d1f662ee4413a71f505a2"></a><!-- doxytag: member="features.c::builtin_parkcall" ref="a15da7831191d1f662ee4413a71f505a2" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int builtin_parkcall </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>support routing for one touch call parking </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>channel parking call </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>peer</em>&nbsp;</td><td>channel to be parked </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>config</em>&nbsp;</td><td>unsed </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>code</em>&nbsp;</td><td>unused </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>sense</em>&nbsp;</td><td>feature options</td></tr>
    <tr><td valign="top"></td><td valign="top"><em>data</em>&nbsp;</td><td>Setup channel, set return exten,priority to 's,1' answer chan, sleep chan, park call </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00942">942</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="channel_8c_source.html#l01367">ast_safe_sleep()</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="features_8c_source.html#l00904">masq_park_call_announce()</a>, and <a class="el" href="features_8c_source.html#l00918">set_peers()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00943"></a>00943 {
<a name="l00944"></a>00944    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *parker;
<a name="l00945"></a>00945    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *parkee;
<a name="l00946"></a>00946    <span class="keywordtype">int</span> res = 0;
<a name="l00947"></a>00947 
<a name="l00948"></a>00948    <a class="code" href="features_8c.html#a130d6c414eebccdc195fa893b47be865" title="set caller and callee according to the direction">set_peers</a>(&amp;parker, &amp;parkee, peer, chan, sense);
<a name="l00949"></a>00949    <span class="comment">/* we used to set chan&apos;s exten and priority to &quot;s&quot; and 1</span>
<a name="l00950"></a>00950 <span class="comment">      here, but this generates (in some cases) an invalid</span>
<a name="l00951"></a>00951 <span class="comment">      extension, and if &quot;s&quot; exists, could errantly</span>
<a name="l00952"></a>00952 <span class="comment">      cause execution of extensions you don&apos;t expect. It</span>
<a name="l00953"></a>00953 <span class="comment">      makes more sense to let nature take its course</span>
<a name="l00954"></a>00954 <span class="comment">      when chan finishes, and let the pbx do its thing</span>
<a name="l00955"></a>00955 <span class="comment">      and hang up when the park is over.</span>
<a name="l00956"></a>00956 <span class="comment">   */</span>
<a name="l00957"></a>00957    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l00958"></a>00958       res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l00959"></a>00959    <span class="keywordflow">if</span> (!res)
<a name="l00960"></a>00960       res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 1000);
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    <span class="keywordflow">if</span> (!res) { <span class="comment">/* one direction used to call park_call.... */</span>
<a name="l00963"></a>00963       res = <a class="code" href="features_8c.html#a6969031880bd3d320cec5f1f89c83325">masq_park_call_announce</a>(parkee, parker, 0, NULL);
<a name="l00964"></a>00964       <span class="comment">/* PBX should hangup zombie channel if a masquerade actually occurred (res=0) */</span>
<a name="l00965"></a>00965    }
<a name="l00966"></a>00966 
<a name="l00967"></a>00967    <span class="keywordflow">return</span> res;
<a name="l00968"></a>00968 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a88974a178f7f1c082551b0516c5fe7fd"></a><!-- doxytag: member="features.c::callback_dialoptions" ref="a88974a178f7f1c082551b0516c5fe7fd" args="(struct ast_flags *features_callee, struct ast_flags *features_caller, char *options, size_t len)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* callback_dialoptions </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__flags.html">ast_flags</a> *&nbsp;</td>
          <td class="paramname"> <em>features_callee</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__flags.html">ast_flags</a> *&nbsp;</td>
          <td class="paramname"> <em>features_caller</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>options</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">size_t&nbsp;</td>
          <td class="paramname"> <em>len</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l02964">2964</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00580">AST_FEATURE_AUTOMON</a>, <a class="el" href="channel_8h_source.html#l00578">AST_FEATURE_DISCONNECT</a>, <a class="el" href="channel_8h_source.html#l00581">AST_FEATURE_PARKCALL</a>, <a class="el" href="channel_8h_source.html#l00577">AST_FEATURE_REDIRECT</a>, and <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02965"></a>02965 {
<a name="l02966"></a>02966    <span class="keywordtype">int</span> i = 0;
<a name="l02967"></a>02967    <span class="keyword">enum</span> {
<a name="l02968"></a>02968       OPT_CALLEE_REDIRECT   = <span class="charliteral">&apos;t&apos;</span>,
<a name="l02969"></a>02969       OPT_CALLER_REDIRECT   = <span class="charliteral">&apos;T&apos;</span>,
<a name="l02970"></a>02970       OPT_CALLEE_AUTOMON    = <span class="charliteral">&apos;w&apos;</span>,
<a name="l02971"></a>02971       OPT_CALLER_AUTOMON    = <span class="charliteral">&apos;W&apos;</span>,
<a name="l02972"></a>02972       OPT_CALLEE_DISCONNECT = <span class="charliteral">&apos;h&apos;</span>,
<a name="l02973"></a>02973       OPT_CALLER_DISCONNECT = <span class="charliteral">&apos;H&apos;</span>,
<a name="l02974"></a>02974       OPT_CALLEE_PARKCALL   = <span class="charliteral">&apos;k&apos;</span>,
<a name="l02975"></a>02975       OPT_CALLER_PARKCALL   = <span class="charliteral">&apos;K&apos;</span>,
<a name="l02976"></a>02976    };
<a name="l02977"></a>02977 
<a name="l02978"></a>02978    memset(options, 0, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l02979"></a>02979    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_caller, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02980"></a>02980       options[i++] = OPT_CALLER_REDIRECT;
<a name="l02981"></a>02981    }
<a name="l02982"></a>02982    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_caller, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02983"></a>02983       options[i++] = OPT_CALLER_AUTOMON;
<a name="l02984"></a>02984    }
<a name="l02985"></a>02985    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_caller, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02986"></a>02986       options[i++] = OPT_CALLER_DISCONNECT;
<a name="l02987"></a>02987    }
<a name="l02988"></a>02988    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_caller, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02989"></a>02989       options[i++] = OPT_CALLER_PARKCALL;
<a name="l02990"></a>02990    }
<a name="l02991"></a>02991 
<a name="l02992"></a>02992    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_callee, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02993"></a>02993       options[i++] = OPT_CALLEE_REDIRECT;
<a name="l02994"></a>02994    }
<a name="l02995"></a>02995    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_callee, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02996"></a>02996       options[i++] = OPT_CALLEE_AUTOMON;
<a name="l02997"></a>02997    }
<a name="l02998"></a>02998    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_callee, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l02999"></a>02999       options[i++] = OPT_CALLEE_DISCONNECT;
<a name="l03000"></a>03000    }
<a name="l03001"></a>03001    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(features_callee, <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>) &amp;&amp; i &lt; <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) {
<a name="l03002"></a>03002       options[i++] = OPT_CALLEE_PARKCALL;
<a name="l03003"></a>03003    }
<a name="l03004"></a>03004 
<a name="l03005"></a>03005    <span class="keywordflow">return</span> options;
<a name="l03006"></a>03006 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a90ee9a80505894386848734fea6683fb"></a><!-- doxytag: member="features.c::check_compat" ref="a90ee9a80505894386848734fea6683fb" args="(struct ast_channel *c, struct ast_channel *newchan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int check_compat </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>c</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>newchan</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>make <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> compatible </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>c</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>newchan</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01370">1370</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8c_source.html#l04200">ast_channel_make_compatible()</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01371"></a>01371 {
<a name="l01372"></a>01372    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a57646ce13ff95b5fc66dea2e741b21ff" title="Makes two channel formats compatible.">ast_channel_make_compatible</a>(c, newchan) &lt; 0) {
<a name="l01373"></a>01373       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Had to drop call because I couldn&apos;t make %s compatible with %s\n&quot;</span>,
<a name="l01374"></a>01374          c-&gt;name, newchan-&gt;name);
<a name="l01375"></a>01375       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(newchan);
<a name="l01376"></a>01376       <span class="keywordflow">return</span> -1;
<a name="l01377"></a>01377    }
<a name="l01378"></a>01378    <span class="keywordflow">return</span> 0;
<a name="l01379"></a>01379 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a44c105a1da30fd5e1155653a681e6de5"></a><!-- doxytag: member="features.c::check_goto_on_transfer" ref="a44c105a1da30fd5e1155653a681e6de5" args="(struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void check_goto_on_transfer </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check goto on transfer. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>Check if channel has 'GOTO_ON_BLINDXFR' set, if not exit. When found make sure the types are compatible. Check if channel is valid if so start the new channel else hangup the call. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00366">366</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00462">ast_channel::_softhangup</a>, <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8h_source.html#l00730">ast_channel_alloc</a>, <a class="el" href="channel_8c_source.html#l04217">ast_channel_masquerade()</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="pbx_8c_source.html#l09633">ast_parseable_goto()</a>, <a class="el" href="pbx_8c_source.html#l04559">ast_pbx_start()</a>, <a class="el" href="channel_8c_source.html#l03100">ast_read()</a>, <a class="el" href="channel_8h_source.html#l00359">AST_STATE_DOWN</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="channel_8h_source.html#l00483">ast_channel::readformat</a>, and <a class="el" href="channel_8h_source.html#l00484">ast_channel::writeformat</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00367"></a>00367 {
<a name="l00368"></a>00368    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *xferchan;
<a name="l00369"></a>00369    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a> = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;GOTO_ON_BLINDXFR&quot;</span>);
<a name="l00370"></a>00370    <span class="keywordtype">char</span> *x, *goto_on_transfer;
<a name="l00371"></a>00371    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00372"></a>00372 
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(val))
<a name="l00374"></a>00374       <span class="keywordflow">return</span>;
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    goto_on_transfer = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(val);
<a name="l00377"></a>00377 
<a name="l00378"></a>00378    <span class="keywordflow">if</span> (!(xferchan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;%s&quot;</span>, chan-&gt;name)))
<a name="l00379"></a>00379       <span class="keywordflow">return</span>;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <span class="keywordflow">for</span> (x = goto_on_transfer; x &amp;&amp; *x; x++) {
<a name="l00382"></a>00382       <span class="keywordflow">if</span> (*x == <span class="charliteral">&apos;^&apos;</span>)
<a name="l00383"></a>00383          *x = <span class="charliteral">&apos;|&apos;</span>;
<a name="l00384"></a>00384    }
<a name="l00385"></a>00385    <span class="comment">/* Make formats okay */</span>
<a name="l00386"></a>00386    xferchan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l00387"></a>00387    xferchan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l00388"></a>00388    <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(xferchan, chan);
<a name="l00389"></a>00389    <a class="code" href="pbx_8h.html#ae9b65b0515d88371a5293dd354bfd92f">ast_parseable_goto</a>(xferchan, goto_on_transfer);
<a name="l00390"></a>00390    xferchan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> = <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>;
<a name="l00391"></a>00391    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(xferchan, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);  
<a name="l00392"></a>00392    xferchan-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> = 0;
<a name="l00393"></a>00393    <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(xferchan))) {
<a name="l00394"></a>00394       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00395"></a>00395       f = NULL;
<a name="l00396"></a>00396       <a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(xferchan);
<a name="l00397"></a>00397    } <span class="keywordflow">else</span> {
<a name="l00398"></a>00398       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(xferchan);
<a name="l00399"></a>00399    }
<a name="l00400"></a>00400 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a9b6a832c081aa8f2cd5287bcf54023a2"></a><!-- doxytag: member="features.c::create_parkinglot" ref="a9b6a832c081aa8f2cd5287bcf54023a2" args="(char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a>* create_parkinglot </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Allocate parking lot structure. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03525">3525</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00413">ao2_alloc</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="linkedlists_8h_source.html#l00610">AST_LIST_HEAD_INIT</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l03543">parkinglot_destroy()</a>, and <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03526"></a>03526 {
<a name="l03527"></a>03527    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *newlot = (<span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *) NULL;
<a name="l03528"></a>03528 
<a name="l03529"></a>03529    <span class="keywordflow">if</span> (!<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l03530"></a>03530       <span class="keywordflow">return</span> NULL;
<a name="l03531"></a>03531 
<a name="l03532"></a>03532    newlot = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*newlot), <a class="code" href="features_8c.html#af048c9c1f337c794fec319fe666ab8b8" title="Destroy a parking lot.">parkinglot_destroy</a>);
<a name="l03533"></a>03533    <span class="keywordflow">if</span> (!newlot)
<a name="l03534"></a>03534       <span class="keywordflow">return</span> NULL;
<a name="l03535"></a>03535    
<a name="l03536"></a>03536    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(newlot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">sizeof</span>(newlot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>));
<a name="l03537"></a>03537    <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(&amp;newlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l03538"></a>03538 
<a name="l03539"></a>03539    <span class="keywordflow">return</span> newlot;
<a name="l03540"></a>03540 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1f3c786719a3735242e22d86b1ce4f08"></a><!-- doxytag: member="features.c::dial_features_destroy" ref="a1f3c786719a3735242e22d86b1ce4f08" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void dial_features_destroy </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00293">293</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00294"></a>00294  {
<a name="l00295"></a>00295    <span class="keyword">struct </span><a class="code" href="structast__dial__features.html">ast_dial_features</a> *df = data;
<a name="l00296"></a>00296    <span class="keywordflow">if</span> (df) {
<a name="l00297"></a>00297       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(df);
<a name="l00298"></a>00298    }
<a name="l00299"></a>00299  }
</pre></div></p>

</div>
</div>
<a class="anchor" id="adef8fadeae29c7bd0b0f5133352f636d"></a><!-- doxytag: member="features.c::dial_features_duplicate" ref="adef8fadeae29c7bd0b0f5133352f636d" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* dial_features_duplicate </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00280">280</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00281"></a>00281 {
<a name="l00282"></a>00282    <span class="keyword">struct </span><a class="code" href="structast__dial__features.html">ast_dial_features</a> *df = data, *df_copy;
<a name="l00283"></a>00283  
<a name="l00284"></a>00284    <span class="keywordflow">if</span> (!(df_copy = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*df)))) {
<a name="l00285"></a>00285       <span class="keywordflow">return</span> NULL;
<a name="l00286"></a>00286    }
<a name="l00287"></a>00287  
<a name="l00288"></a>00288    memcpy(df_copy, df, <span class="keyword">sizeof</span>(*df));
<a name="l00289"></a>00289  
<a name="l00290"></a>00290    <span class="keywordflow">return</span> df_copy;
<a name="l00291"></a>00291  }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acf1dcf498f0e94d517221edd746f71ce"></a><!-- doxytag: member="features.c::do_bridge_masquerade" ref="acf1dcf498f0e94d517221edd746f71ce" args="(struct ast_channel *chan, struct ast_channel *tmpchan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void do_bridge_masquerade </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>tmpchan</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Actual bridge. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>tmpchan</em>&nbsp;</td><td>Stop hold music, lock both <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>, masq <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a>, after bridge return channel to next priority. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04126">4126</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="channel_8c_source.html#l04217">ast_channel_masquerade()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="channel_8c_source.html#l04393">ast_do_masquerade()</a>, <a class="el" href="pbx_8c_source.html#l07321">ast_explicit_goto()</a>, <a class="el" href="channel_8c_source.html#l05549">ast_moh_stop()</a>, <a class="el" href="channel_8c_source.html#l04695">ast_setstate()</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="channel_8h_source.html#l00483">ast_channel::readformat</a>, and <a class="el" href="channel_8h_source.html#l00484">ast_channel::writeformat</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04156">action_bridge()</a>, and <a class="el" href="features_8c_source.html#l04524">bridge_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04127"></a>04127 {
<a name="l04128"></a>04128    <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l04129"></a>04129    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l04130"></a>04130    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(tmpchan, chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a>);
<a name="l04131"></a>04131    tmpchan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l04132"></a>04132    tmpchan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l04133"></a>04133    <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(tmpchan, chan);
<a name="l04134"></a>04134    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(tmpchan);
<a name="l04135"></a>04135    <a class="code" href="channel_8h.html#ab26f03fb10f1b2e8e52bfbbb1ee02f78" title="Start masquerading a channel XXX This is a seriously whacked out operation. We&amp;#39;re...">ast_do_masquerade</a>(tmpchan);
<a name="l04136"></a>04136    <span class="comment">/* when returning from bridge, the channel will continue at the next priority */</span>
<a name="l04137"></a>04137    <a class="code" href="pbx_8h.html#a9f840db4b5ef461ac2c0c975a57c9e89">ast_explicit_goto</a>(tmpchan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> + 1);
<a name="l04138"></a>04138    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(tmpchan);
<a name="l04139"></a>04139    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l04140"></a>04140 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad9b02e0b0449b215a699f0a64d19107a"></a><!-- doxytag: member="features.c::do_parking_thread" ref="ad9b02e0b0449b215a699f0a64d19107a" args="(void *ignore)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void* do_parking_thread </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>ignore</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Take care of parked calls and unpark them if needed. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>ignore</em>&nbsp;</td><td>unused var.</td></tr>
  </table>
  </dd>
</dl>
<p>Start inf loop, lock parking lot, check if any parked <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> have gone above timeout if so, remove channel from parking lot and return it to the <a class="el" href="structextension.html">extension</a> that parked it. Check if parked channel decided to hangup, wait until next FD via select(). </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03189">3189</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00780">ao2_iterator_init()</a>, <a class="el" href="astobj2_8h_source.html#l01120">ao2_iterator_next</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="time_8h_source.html#l00176">ast_samp2tv()</a>, <a class="el" href="channel_8h_source.html#l01726">ast_select()</a>, <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>, and <a class="el" href="features_8c_source.html#l00236">parkinglots</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03190"></a>03190 {
<a name="l03191"></a>03191    fd_set rfds, efds;   <span class="comment">/* results from previous select, to be preserved across loops. */</span>
<a name="l03192"></a>03192    fd_set nrfds, nefds; <span class="comment">/* args for the next select */</span>
<a name="l03193"></a>03193    FD_ZERO(&amp;rfds);
<a name="l03194"></a>03194    FD_ZERO(&amp;efds);
<a name="l03195"></a>03195 
<a name="l03196"></a>03196    <span class="keywordflow">for</span> (;;) {
<a name="l03197"></a>03197       <span class="keywordtype">int</span> res = 0;
<a name="l03198"></a>03198       <span class="keywordtype">int</span> ms = -1;   <span class="comment">/* select timeout, uninitialized */</span>
<a name="l03199"></a>03199       <span class="keywordtype">int</span> max = -1;  <span class="comment">/* max fd, none there yet */</span>
<a name="l03200"></a>03200       <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> iter;
<a name="l03201"></a>03201       <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *curlot;
<a name="l03202"></a>03202       FD_ZERO(&amp;nrfds);
<a name="l03203"></a>03203       FD_ZERO(&amp;nefds);
<a name="l03204"></a>03204       iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, 0);
<a name="l03205"></a>03205 
<a name="l03206"></a>03206       <span class="keywordflow">while</span> ((curlot = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;iter))) {
<a name="l03207"></a>03207          res = <a class="code" href="features_8c.html#ac513c11fb4717d40cf8cd46cf387c0fe" title="Run management on parkinglots, called once per parkinglot.">manage_parkinglot</a>(curlot, &amp;rfds, &amp;efds, &amp;nrfds, &amp;nefds, &amp;ms, &amp;max);
<a name="l03208"></a>03208          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(curlot, -1);
<a name="l03209"></a>03209       }
<a name="l03210"></a>03210 
<a name="l03211"></a>03211       rfds = nrfds;
<a name="l03212"></a>03212       efds = nefds;
<a name="l03213"></a>03213       {
<a name="l03214"></a>03214          <span class="keyword">struct </span>timeval wait = <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(ms, 1000);
<a name="l03215"></a>03215          <span class="comment">/* Wait for something to happen */</span>
<a name="l03216"></a>03216          <a class="code" href="channel_8h.html#a056ed4f99440f01c251b2e8ca4501a56" title="Waits for activity on a group of channels.">ast_select</a>(max + 1, &amp;rfds, NULL, &amp;efds, (ms &gt; -1) ? &amp;wait : NULL);
<a name="l03217"></a>03217       }
<a name="l03218"></a>03218       pthread_testcancel();
<a name="l03219"></a>03219    }
<a name="l03220"></a>03220    <span class="keywordflow">return</span> NULL;   <span class="comment">/* Never reached */</span>
<a name="l03221"></a>03221 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a7d36808a9da972e429854519d6ced84c"></a><!-- doxytag: member="features.c::feature_exec_app" ref="a7d36808a9da972e429854519d6ced84c" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int feature_exec_app </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>exec an app by feature </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan,peer,config,code,sense,data</em>&nbsp;</td><td>Find a feature, determine which channel activated </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>AST_FEATURE_RETURN_NO_HANGUP_PEER</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>error. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-2</em>&nbsp;</td><td>when an application cannot be found. </td></tr>
  </table>
  </dd>
</dl>

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000070">Todo:</a></b></dt><dd>XXX should probably return res </dd></dl>
</p>

<p>Definition at line <a class="el" href="features_8c_source.html#l01903">1903</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8h_source.html#l00058">ast_call_feature::app</a>, <a class="el" href="adsistub_8c_source.html#l00053">app</a>, <a class="el" href="features_8h_source.html#l00059">ast_call_feature::app_args</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="features_8h_source.html#l00045">AST_FEATURE_FLAG_BYCALLEE</a>, <a class="el" href="features_8h_source.html#l00046">AST_FEATURE_FLAG_BYCALLER</a>, <a class="el" href="features_8h_source.html#l00044">AST_FEATURE_FLAG_ONSELF</a>, <a class="el" href="features_8h_source.html#l00069">AST_FEATURE_RETURN_KEEPTRYING</a>, <a class="el" href="features_8h_source.html#l00068">AST_FEATURE_RETURN_SUCCESS</a>, <a class="el" href="features_8h_source.html#l00065">AST_FEATURE_RETURN_SUCCESSBREAK</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l05538">ast_moh_start()</a>, <a class="el" href="channel_8c_source.html#l05549">ast_moh_stop()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="features_8c_source.html#l00909">FEATURE_SENSE_CHAN</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8h_source.html#l00060">ast_call_feature::moh_class</a>, <a class="el" href="pbx_8c_source.html#l01322">pbx_exec()</a>, and <a class="el" href="pbx_8c_source.html#l01363">pbx_findapp()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01904"></a>01904 {
<a name="l01905"></a>01905    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>;
<a name="l01906"></a>01906    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature = data;
<a name="l01907"></a>01907    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *work, *idle;
<a name="l01908"></a>01908    <span class="keywordtype">int</span> res;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910    <span class="keywordflow">if</span> (!feature) { <span class="comment">/* shouldn&apos;t ever happen! */</span>
<a name="l01911"></a>01911       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Found feature before, but at execing we&apos;ve lost it??\n&quot;</span>);
<a name="l01912"></a>01912       <span class="keywordflow">return</span> -1; 
<a name="l01913"></a>01913    }
<a name="l01914"></a>01914 
<a name="l01915"></a>01915    <span class="keywordflow">if</span> (sense == <a class="code" href="features_8c.html#a43d76622becf50779cbf68a3419a42e5">FEATURE_SENSE_CHAN</a>) {
<a name="l01916"></a>01916       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>))
<a name="l01917"></a>01917          <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a3ab7e6a7cee8d7b8cf23190d3b58b0c8">AST_FEATURE_RETURN_KEEPTRYING</a>;
<a name="l01918"></a>01918       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca2400fd06fffa892d753ab1957f653d41">AST_FEATURE_FLAG_ONSELF</a>)) {
<a name="l01919"></a>01919          work = chan;
<a name="l01920"></a>01920          idle = peer;
<a name="l01921"></a>01921       } <span class="keywordflow">else</span> {
<a name="l01922"></a>01922          work = peer;
<a name="l01923"></a>01923          idle = chan;
<a name="l01924"></a>01924       }
<a name="l01925"></a>01925    } <span class="keywordflow">else</span> {
<a name="l01926"></a>01926       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>))
<a name="l01927"></a>01927          <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a3ab7e6a7cee8d7b8cf23190d3b58b0c8">AST_FEATURE_RETURN_KEEPTRYING</a>;
<a name="l01928"></a>01928       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca2400fd06fffa892d753ab1957f653d41">AST_FEATURE_FLAG_ONSELF</a>)) {
<a name="l01929"></a>01929          work = peer;
<a name="l01930"></a>01930          idle = chan;
<a name="l01931"></a>01931       } <span class="keywordflow">else</span> {
<a name="l01932"></a>01932          work = chan;
<a name="l01933"></a>01933          idle = peer;
<a name="l01934"></a>01934       }
<a name="l01935"></a>01935    }
<a name="l01936"></a>01936 
<a name="l01937"></a>01937    <span class="keywordflow">if</span> (!(app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(feature-&gt;<a class="code" href="structast__call__feature.html#aeee08a60543bdd432ce7d81027445ad2">app</a>))) {
<a name="l01938"></a>01938       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find application (%s)\n&quot;</span>, feature-&gt;<a class="code" href="structast__call__feature.html#aeee08a60543bdd432ce7d81027445ad2">app</a>);
<a name="l01939"></a>01939       <span class="keywordflow">return</span> -2;
<a name="l01940"></a>01940    }
<a name="l01941"></a>01941 
<a name="l01942"></a>01942    <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(idle);
<a name="l01943"></a>01943    
<a name="l01944"></a>01944    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(feature-&gt;<a class="code" href="structast__call__feature.html#ae8d6ce9122f07e793836c229c7e4d318">moh_class</a>))
<a name="l01945"></a>01945       <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(idle, feature-&gt;<a class="code" href="structast__call__feature.html#ae8d6ce9122f07e793836c229c7e4d318">moh_class</a>, NULL);
<a name="l01946"></a>01946 
<a name="l01947"></a>01947    res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(work, app, feature-&gt;<a class="code" href="structast__call__feature.html#a022a806be6b7b1b700453fd4575481d8">app_args</a>);
<a name="l01948"></a>01948 
<a name="l01949"></a>01949    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(feature-&gt;<a class="code" href="structast__call__feature.html#ae8d6ce9122f07e793836c229c7e4d318">moh_class</a>))
<a name="l01950"></a>01950       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(idle);
<a name="l01951"></a>01951 
<a name="l01952"></a>01952    <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(idle);
<a name="l01953"></a>01953 
<a name="l01954"></a>01954    <span class="keywordflow">if</span> (res) {
<a name="l01955"></a>01955       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#aa8cd95ffa7e16936d70678f2fa7c96e1">AST_FEATURE_RETURN_SUCCESSBREAK</a>;
<a name="l01956"></a>01956    }
<a name="l01957"></a>01957    <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a262aca923fa7156c10fdc92c99d66bc7">AST_FEATURE_RETURN_SUCCESS</a>;  <span class="comment">/*! \todo XXX should probably return res */</span>
<a name="l01958"></a>01958 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae89302e12bbcc8ffec898244cc3b73fe"></a><!-- doxytag: member="features.c::feature_interpret" ref="ae89302e12bbcc8ffec898244cc3b73fe" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config, char *code, int sense)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int feature_interpret </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>code</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Check the dynamic features. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan,peer,config,code,sense</em>&nbsp;</td><td>Lock features list, browse for code, unlock list </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>res</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01996">1996</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="utils_8h_source.html#l00082">ast_copy_flags</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="features_8h_source.html#l00069">AST_FEATURE_RETURN_KEEPTRYING</a>, <a class="el" href="features_8h_source.html#l00066">AST_FEATURE_RETURN_PASSDIGITS</a>, <a class="el" href="features_8h_source.html#l00067">AST_FEATURE_RETURN_STOREDIGITS</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="lock_8h_source.html#l01796">ast_rwlock_rdlock()</a>, <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="features_8h_source.html#l00054">ast_call_feature::exten</a>, <a class="el" href="features_8c_source.html#l00178">feature_group_exten::exten</a>, <a class="el" href="features_8c_source.html#l00179">feature_group_exten::feature</a>, <a class="el" href="features_8c_source.html#l00909">FEATURE_SENSE_CHAN</a>, <a class="el" href="structfeature__group.html#a9f496cd6d406637c34b0685e45269921">feature_group::features</a>, <a class="el" href="channel_8h_source.html#l00590">ast_bridge_config::features_callee</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, <a class="el" href="features_8c_source.html#l01695">features_lock</a>, <a class="el" href="features_8c_source.html#l01825">find_dynamic_feature()</a>, <a class="el" href="features_8c_source.html#l01863">find_group()</a>, <a class="el" href="utils_8h_source.html#l00199">ast_flags::flags</a>, <a class="el" href="structast__call__feature.html#a9c2eda72263cd25696a89edeaa815fda">ast_call_feature::operation</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01997"></a>01997 {
<a name="l01998"></a>01998    <span class="keywordtype">int</span> x;
<a name="l01999"></a>01999    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> features;
<a name="l02000"></a>02000    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l02001"></a>02001    <span class="keyword">struct </span><a class="code" href="structfeature__group.html">feature_group</a> *fg = NULL;
<a name="l02002"></a>02002    <span class="keyword">struct </span><a class="code" href="structfeature__group__exten.html">feature_group_exten</a> *fge;
<a name="l02003"></a>02003    <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_dynamic_features, *chan_dynamic_features;
<a name="l02004"></a>02004    <span class="keywordtype">char</span> dynamic_features_buf[128];
<a name="l02005"></a>02005    <span class="keywordtype">char</span> *tmp, *tok;
<a name="l02006"></a>02006    <span class="keywordtype">int</span> res = <a class="code" href="features_8h.html#a6fe63cc369dcb5f31ee37b64cc68d4b2">AST_FEATURE_RETURN_PASSDIGITS</a>;
<a name="l02007"></a>02007    <span class="keywordtype">int</span> feature_detected = 0;
<a name="l02008"></a>02008 
<a name="l02009"></a>02009    <span class="keywordflow">if</span> (sense == <a class="code" href="features_8c.html#a43d76622becf50779cbf68a3419a42e5">FEATURE_SENSE_CHAN</a>) {
<a name="l02010"></a>02010       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;features, &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02011"></a>02011    }
<a name="l02012"></a>02012    <span class="keywordflow">else</span> {
<a name="l02013"></a>02013       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;features, &amp;(config-&gt;<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02014"></a>02014    }
<a name="l02015"></a>02015 
<a name="l02016"></a>02016    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(peer);
<a name="l02017"></a>02017    peer_dynamic_features = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(peer, <span class="stringliteral">&quot;DYNAMIC_FEATURES&quot;</span>),<span class="stringliteral">&quot;&quot;</span>));
<a name="l02018"></a>02018    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l02019"></a>02019 
<a name="l02020"></a>02020    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02021"></a>02021    chan_dynamic_features = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;DYNAMIC_FEATURES&quot;</span>),<span class="stringliteral">&quot;&quot;</span>));
<a name="l02022"></a>02022    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02023"></a>02023 
<a name="l02024"></a>02024    snprintf(dynamic_features_buf, <span class="keyword">sizeof</span>(dynamic_features_buf), <span class="stringliteral">&quot;%s%s%s&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan_dynamic_features, <span class="stringliteral">&quot;&quot;</span>), chan_dynamic_features &amp;&amp; peer_dynamic_features ? <span class="stringliteral">&quot;#&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(peer_dynamic_features,<span class="stringliteral">&quot;&quot;</span>));
<a name="l02025"></a>02025 
<a name="l02026"></a>02026    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Feature interpret: chan=%s, peer=%s, code=%s, sense=%d, features=%d, dynamic=%s\n&quot;</span>, chan-&gt;name, peer-&gt;name, code, sense, features.<a class="code" href="structast__channel.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, dynamic_features_buf);
<a name="l02027"></a>02027 
<a name="l02028"></a>02028    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l02029"></a>02029    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; x++) {
<a name="l02030"></a>02030       <span class="keywordflow">if</span> ((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;features, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].feature_mask)) &amp;&amp;
<a name="l02031"></a>02031           !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>)) {
<a name="l02032"></a>02032          <span class="comment">/* Feature is up for consideration */</span>
<a name="l02033"></a>02033          <span class="keywordflow">if</span> (!strcmp(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].exten, code)) {
<a name="l02034"></a>02034             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Feature detected: fname=%s sname=%s exten=%s\n&quot;</span>, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].fname, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].sname, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].exten);
<a name="l02035"></a>02035             res = <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="structast__call__feature.html#a9c2eda72263cd25696a89edeaa815fda">operation</a>(chan, peer, config, code, sense, NULL);
<a name="l02036"></a>02036             feature_detected = 1;
<a name="l02037"></a>02037             <span class="keywordflow">break</span>;
<a name="l02038"></a>02038          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].exten, code, strlen(code))) {
<a name="l02039"></a>02039             <span class="keywordflow">if</span> (res == <a class="code" href="features_8h.html#a6fe63cc369dcb5f31ee37b64cc68d4b2">AST_FEATURE_RETURN_PASSDIGITS</a>)
<a name="l02040"></a>02040                res = <a class="code" href="features_8h.html#ae16feaff434ab443f245cf610797a70c">AST_FEATURE_RETURN_STOREDIGITS</a>;
<a name="l02041"></a>02041          }
<a name="l02042"></a>02042       }
<a name="l02043"></a>02043    }
<a name="l02044"></a>02044    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l02045"></a>02045 
<a name="l02046"></a>02046    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(dynamic_features_buf) || feature_detected)
<a name="l02047"></a>02047       <span class="keywordflow">return</span> res;
<a name="l02048"></a>02048 
<a name="l02049"></a>02049    tmp = dynamic_features_buf;
<a name="l02050"></a>02050 
<a name="l02051"></a>02051    <span class="keywordflow">while</span> ((tok = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp, <span class="stringliteral">&quot;#&quot;</span>))) {
<a name="l02052"></a>02052       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l02053"></a>02053 
<a name="l02054"></a>02054       fg = <a class="code" href="features_8c.html#a2de36634b2790793c2629ac1a25f64ea" title="Find a group by name.">find_group</a>(tok);
<a name="l02055"></a>02055 
<a name="l02056"></a>02056       <span class="keywordflow">if</span> (fg) {
<a name="l02057"></a>02057          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;fg-&gt;<a class="code" href="structfeature__group.html#a9f496cd6d406637c34b0685e45269921">features</a>, fge, <a class="code" href="structfeature__group__exten.html#a07bbbfd18184d736794fc71e74a381ca">entry</a>) {
<a name="l02058"></a>02058             <span class="keywordflow">if</span> (strcasecmp(fge-&gt;<a class="code" href="structfeature__group__exten.html#aaee31f4cc48985167efcd38ab252dac8">exten</a>, code))
<a name="l02059"></a>02059                <span class="keywordflow">continue</span>;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061             res = fge-&gt;<a class="code" href="structfeature__group__exten.html#a57a1afe8e1e8e5f6bc64b77aa363996f">feature</a>-&gt;<a class="code" href="structast__call__feature.html#a9c2eda72263cd25696a89edeaa815fda">operation</a>(chan, peer, config, code, sense, fge-&gt;<a class="code" href="structfeature__group__exten.html#a57a1afe8e1e8e5f6bc64b77aa363996f">feature</a>);
<a name="l02062"></a>02062             <span class="keywordflow">if</span> (res != <a class="code" href="features_8h.html#a3ab7e6a7cee8d7b8cf23190d3b58b0c8">AST_FEATURE_RETURN_KEEPTRYING</a>) {
<a name="l02063"></a>02063                <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l02064"></a>02064                <span class="keywordflow">break</span>;
<a name="l02065"></a>02065             }
<a name="l02066"></a>02066             res = <a class="code" href="features_8h.html#a6fe63cc369dcb5f31ee37b64cc68d4b2">AST_FEATURE_RETURN_PASSDIGITS</a>;
<a name="l02067"></a>02067          }
<a name="l02068"></a>02068          <span class="keywordflow">if</span> (fge)
<a name="l02069"></a>02069             <span class="keywordflow">break</span>;
<a name="l02070"></a>02070       }
<a name="l02071"></a>02071 
<a name="l02072"></a>02072       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l02073"></a>02073 
<a name="l02074"></a>02074       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l02075"></a>02075 
<a name="l02076"></a>02076       <span class="keywordflow">if</span> (!(feature = <a class="code" href="features_8c.html#a0109970dc3ef884910b9dc1a5fede2e7" title="find a call feature by name">find_dynamic_feature</a>(tok))) {
<a name="l02077"></a>02077          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l02078"></a>02078          <span class="keywordflow">continue</span>;
<a name="l02079"></a>02079       }
<a name="l02080"></a>02080          
<a name="l02081"></a>02081       <span class="comment">/* Feature is up for consideration */</span>
<a name="l02082"></a>02082       <span class="keywordflow">if</span> (!strcmp(feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>, code)) {
<a name="l02083"></a>02083          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot; Feature Found: %s exten: %s\n&quot;</span>,feature-&gt;<a class="code" href="structast__call__feature.html#a63c4048019f00ef118af9c631c1e7665">sname</a>, tok);
<a name="l02084"></a>02084          res = feature-&gt;<a class="code" href="structast__call__feature.html#a9c2eda72263cd25696a89edeaa815fda">operation</a>(chan, peer, config, code, sense, feature);
<a name="l02085"></a>02085          <span class="keywordflow">if</span> (res != <a class="code" href="features_8h.html#a3ab7e6a7cee8d7b8cf23190d3b58b0c8">AST_FEATURE_RETURN_KEEPTRYING</a>) {
<a name="l02086"></a>02086             <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l02087"></a>02087             <span class="keywordflow">break</span>;
<a name="l02088"></a>02088          }
<a name="l02089"></a>02089          res = <a class="code" href="features_8h.html#a6fe63cc369dcb5f31ee37b64cc68d4b2">AST_FEATURE_RETURN_PASSDIGITS</a>;
<a name="l02090"></a>02090       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>, code, strlen(code)))
<a name="l02091"></a>02091          res = <a class="code" href="features_8h.html#ae16feaff434ab443f245cf610797a70c">AST_FEATURE_RETURN_STOREDIGITS</a>;
<a name="l02092"></a>02092 
<a name="l02093"></a>02093       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l02094"></a>02094    }
<a name="l02095"></a>02095    
<a name="l02096"></a>02096    <span class="keywordflow">return</span> res;
<a name="l02097"></a>02097 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac2ea73c446e5630743ce9e6e90634e05"></a><!-- doxytag: member="features.c::feature_request_and_dial" ref="ac2ea73c446e5630743ce9e6e90634e05" args="(struct ast_channel *caller, struct ast_channel *transferee, const char *type, int format, void *data, int timeout, int *outstate, const char *cid_num, const char *cid_name, int igncallerstate, const char *language)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__channel.html">ast_channel</a> * feature_request_and_dial </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>caller</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>transferee</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>type</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>format</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>outstate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>cid_num</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>cid_name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>igncallerstate</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>language</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get feature and dial. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>caller,transferee,type,format,data,timeout,outstate,cid_num,cid_name,igncallerstate</em>&nbsp;</td><td>Request channel, set channel variables, initiate call,check if they want to disconnect go into loop, check if timeout has elapsed, check if person to be transfered hung up, check for answer break loop, set cdr return channel.</td></tr>
  </table>
  </dd>
</dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000071">Todo:</a></b></dt><dd>XXX Check - this is very similar to the code in <a class="el" href="channel_8c.html" title="Channel Management.">channel.c</a> </dd></dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>always a channel </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l02152">2152</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l04042">ast_call()</a>, <a class="el" href="channel_8c_source.html#l03779">ast_call_forward()</a>, <a class="el" href="causes_8h_source.html#l00147">AST_CAUSE_BUSY</a>, <a class="el" href="causes_8h_source.html#l00151">AST_CAUSE_CONGESTION</a>, <a class="el" href="channel_8c_source.html#l04302">ast_channel_inherit_variables()</a>, <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, <a class="el" href="frame_8h_source.html#l00301">AST_CONTROL_ANSWER</a>, <a class="el" href="frame_8h_source.html#l00302">AST_CONTROL_BUSY</a>, <a class="el" href="frame_8h_source.html#l00305">AST_CONTROL_CONGESTION</a>, <a class="el" href="frame_8h_source.html#l00298">AST_CONTROL_HANGUP</a>, <a class="el" href="frame_8h_source.html#l00311">AST_CONTROL_PROGRESS</a>, <a class="el" href="frame_8h_source.html#l00300">AST_CONTROL_RINGING</a>, <a class="el" href="frame_8h_source.html#l00314">AST_CONTROL_UNHOLD</a>, <a class="el" href="frame_8h_source.html#l00105">AST_FRAME_CONTROL</a>, <a class="el" href="frame_8h_source.html#l00124">AST_FRAME_DTMF</a>, <a class="el" href="frame_8h_source.html#l00111">AST_FRAME_TEXT</a>, <a class="el" href="frame_8h_source.html#l00103">AST_FRAME_VIDEO</a>, <a class="el" href="frame_8h_source.html#l00101">AST_FRAME_VOICE</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l01610">ast_poll_channel_add()</a>, <a class="el" href="channel_8c_source.html#l01633">ast_poll_channel_del()</a>, <a class="el" href="channel_8c_source.html#l03100">ast_read()</a>, <a class="el" href="channel_8c_source.html#l03986">ast_request()</a>, <a class="el" href="lock_8h_source.html#l01796">ast_rwlock_rdlock()</a>, <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="channel_8c_source.html#l04670">ast_set_callerid()</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="stringfields_8h_source.html#l00285">ast_string_field_set</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="time_8h_source.html#l00089">ast_tvdiff_ms()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="channel_8c_source.html#l02384">ast_waitfor_n()</a>, <a class="el" href="channel_8c_source.html#l03411">ast_write()</a>, <a class="el" href="channel_8c_source.html#l00136">cause</a>, <a class="el" href="features_8h_source.html#l00054">ast_call_feature::exten</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, <a class="el" href="features_8c_source.html#l01695">features_lock</a>, <a class="el" href="frame_8h_source.html#l00143">ast_frame::frametype</a>, <a class="el" href="func__strings_8c_source.html#l00821">len()</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, and <a class="el" href="frame_8h_source.html#l00145">ast_frame::subclass</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02153"></a>02153 {
<a name="l02154"></a>02154    <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a> = 0;
<a name="l02155"></a>02155    <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a> = 0;
<a name="l02156"></a>02156    <span class="keywordtype">int</span> to;
<a name="l02157"></a>02157    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l02158"></a>02158    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *monitor_chans[2];
<a name="l02159"></a>02159    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *active_channel;
<a name="l02160"></a>02160    <span class="keywordtype">int</span> res = 0, ready = 0;
<a name="l02161"></a>02161    <span class="keyword">struct </span>timeval started;
<a name="l02162"></a>02162    <span class="keywordtype">int</span> x, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = 0;
<a name="l02163"></a>02163    <span class="keywordtype">char</span> *disconnect_code = NULL, *dialed_code = NULL;
<a name="l02164"></a>02164 
<a name="l02165"></a>02165    <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, data, &amp;cause))) {
<a name="l02166"></a>02166       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to request channel %s/%s\n&quot;</span>, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, (<span class="keywordtype">char</span> *)data);
<a name="l02167"></a>02167       <span class="keywordflow">switch</span>(cause) {
<a name="l02168"></a>02168       <span class="keywordflow">case</span> <a class="code" href="causes_8h.html#ae009c193522491f7de7ea28b23f20868">AST_CAUSE_BUSY</a>:
<a name="l02169"></a>02169          state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>;
<a name="l02170"></a>02170          <span class="keywordflow">break</span>;
<a name="l02171"></a>02171       <span class="keywordflow">case</span> <a class="code" href="causes_8h.html#a0a35518d7b448a53da368cf57f354fba">AST_CAUSE_CONGESTION</a>:
<a name="l02172"></a>02172          state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>;
<a name="l02173"></a>02173          <span class="keywordflow">break</span>;
<a name="l02174"></a>02174       }
<a name="l02175"></a>02175       <span class="keywordflow">goto</span> done;
<a name="l02176"></a>02176    }
<a name="l02177"></a>02177 
<a name="l02178"></a>02178    <a class="code" href="channel_8h.html#a88d833a56ea7de33e230281c5c12b75d" title="Set caller ID number, name and ANI.">ast_set_callerid</a>(chan, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);
<a name="l02179"></a>02179    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);
<a name="l02180"></a>02180    <a class="code" href="channel_8h.html#a892b6550a4f90b70ad92198c9d05cedc" title="Inherits channel variable from parent to child channel.">ast_channel_inherit_variables</a>(caller, chan); 
<a name="l02181"></a>02181    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;TRANSFERERNAME&quot;</span>, caller-&gt;name);
<a name="l02182"></a>02182       
<a name="l02183"></a>02183    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ae212e5f3ae50a869bbf859fe9db7dee0" title="Make a call.">ast_call</a>(chan, data, timeout)) {
<a name="l02184"></a>02184       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to call channel %s/%s\n&quot;</span>, <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, (<span class="keywordtype">char</span> *)data);
<a name="l02185"></a>02185       <span class="keywordflow">goto</span> done;
<a name="l02186"></a>02186    }
<a name="l02187"></a>02187    
<a name="l02188"></a>02188    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(caller, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l02189"></a>02189    <span class="comment">/* support dialing of the featuremap disconnect code while performing an attended tranfer */</span>
<a name="l02190"></a>02190    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l02191"></a>02191    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; x++) {
<a name="l02192"></a>02192       <span class="keywordflow">if</span> (strcasecmp(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].sname, <span class="stringliteral">&quot;disconnect&quot;</span>))
<a name="l02193"></a>02193          <span class="keywordflow">continue</span>;
<a name="l02194"></a>02194 
<a name="l02195"></a>02195       disconnect_code = <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>;
<a name="l02196"></a>02196       len = strlen(disconnect_code) + 1;
<a name="l02197"></a>02197       dialed_code = alloca(len);
<a name="l02198"></a>02198       memset(dialed_code, 0, len);
<a name="l02199"></a>02199       <span class="keywordflow">break</span>;
<a name="l02200"></a>02200    }
<a name="l02201"></a>02201    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l02202"></a>02202    x = 0;
<a name="l02203"></a>02203    started = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02204"></a>02204    to = timeout;
<a name="l02205"></a>02205 
<a name="l02206"></a>02206    <a class="code" href="channel_8h.html#a1b3f92e2239cd9e9bc20c783e1dedc80">ast_poll_channel_add</a>(caller, chan);
<a name="l02207"></a>02207 
<a name="l02208"></a>02208    <span class="keywordflow">while</span> (!((transferee &amp;&amp; <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(transferee)) &amp;&amp; (!igncallerstate &amp;&amp; <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(caller))) &amp;&amp; timeout &amp;&amp; (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)) {
<a name="l02209"></a>02209       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l02210"></a>02210 
<a name="l02211"></a>02211       monitor_chans[0] = caller;
<a name="l02212"></a>02212       monitor_chans[1] = chan;
<a name="l02213"></a>02213       active_channel = <a class="code" href="channel_8h.html#aec8ce59b78afbd3651f3de011f13290a" title="Waits for input on a group of channels Wait for input on an array of channels for...">ast_waitfor_n</a>(monitor_chans, 2, &amp;to);
<a name="l02214"></a>02214 
<a name="l02215"></a>02215       <span class="comment">/* see if the timeout has been violated */</span>
<a name="l02216"></a>02216       <span class="keywordflow">if</span>(<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), started) &gt; timeout) {
<a name="l02217"></a>02217          state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>;
<a name="l02218"></a>02218          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;We exceeded our AT-timeout\n&quot;</span>);
<a name="l02219"></a>02219          <span class="keywordflow">break</span>; <span class="comment">/*doh! timeout*/</span>
<a name="l02220"></a>02220       }
<a name="l02221"></a>02221 
<a name="l02222"></a>02222       <span class="keywordflow">if</span> (!active_channel)
<a name="l02223"></a>02223          <span class="keywordflow">continue</span>;
<a name="l02224"></a>02224 
<a name="l02225"></a>02225       <span class="keywordflow">if</span> (chan &amp;&amp; (chan == active_channel)){
<a name="l02226"></a>02226          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;call_forward)) {
<a name="l02227"></a>02227             <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8h.html#a05e7ee16979b176273568bea55d2e87d" title="Forwards a call to a new channel specified by the original channel&amp;#39;s call_forward...">ast_call_forward</a>(caller, chan, &amp;to, <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, NULL, outstate))) {
<a name="l02228"></a>02228                <span class="keywordflow">return</span> NULL;
<a name="l02229"></a>02229             }
<a name="l02230"></a>02230             <span class="keywordflow">continue</span>;
<a name="l02231"></a>02231          }
<a name="l02232"></a>02232          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l02233"></a>02233          <span class="keywordflow">if</span> (f == NULL) { <span class="comment">/*doh! where&apos;d he go?*/</span>
<a name="l02234"></a>02234             state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>;
<a name="l02235"></a>02235             res = 0;
<a name="l02236"></a>02236             <span class="keywordflow">break</span>;
<a name="l02237"></a>02237          }
<a name="l02238"></a>02238          
<a name="l02239"></a>02239          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a> || f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a> || f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>) {
<a name="l02240"></a>02240             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>) {
<a name="l02241"></a>02241                state = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02242"></a>02242                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s is ringing\n&quot;</span>, chan-&gt;name);
<a name="l02243"></a>02243                <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(caller, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l02244"></a>02244             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>) || (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>)) {
<a name="l02245"></a>02245                state = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02246"></a>02246                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;%s is busy\n&quot;</span>, chan-&gt;name);
<a name="l02247"></a>02247                <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(caller, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>);
<a name="l02248"></a>02248                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02249"></a>02249                f = NULL;
<a name="l02250"></a>02250                <span class="keywordflow">break</span>;
<a name="l02251"></a>02251             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>) {
<a name="l02252"></a>02252                <span class="comment">/* This is what we are hoping for */</span>
<a name="l02253"></a>02253                state = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02254"></a>02254                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02255"></a>02255                f = NULL;
<a name="l02256"></a>02256                ready=1;
<a name="l02257"></a>02257                <span class="keywordflow">break</span>;
<a name="l02258"></a>02258             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != -1 &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd">AST_CONTROL_PROGRESS</a>) {
<a name="l02259"></a>02259                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Don&apos;t know what to do about control frame: %d\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l02260"></a>02260             }
<a name="l02261"></a>02261             <span class="comment">/* else who cares */</span>
<a name="l02262"></a>02262          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> || f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l02263"></a>02263             <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(caller, f);
<a name="l02264"></a>02264          }
<a name="l02265"></a>02265 
<a name="l02266"></a>02266       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (caller &amp;&amp; (active_channel == caller)) {
<a name="l02267"></a>02267          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(caller);
<a name="l02268"></a>02268          <span class="keywordflow">if</span> (f == NULL) { <span class="comment">/*doh! where&apos;d he go?*/</span>
<a name="l02269"></a>02269             <span class="keywordflow">if</span> (!igncallerstate) {
<a name="l02270"></a>02270                <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(caller) &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l02271"></a>02271                   <span class="comment">/* make this a blind transfer */</span>
<a name="l02272"></a>02272                   ready = 1;
<a name="l02273"></a>02273                   <span class="keywordflow">break</span>;
<a name="l02274"></a>02274                }
<a name="l02275"></a>02275                state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>;
<a name="l02276"></a>02276                res = 0;
<a name="l02277"></a>02277                <span class="keywordflow">break</span>;
<a name="l02278"></a>02278             }
<a name="l02279"></a>02279          } <span class="keywordflow">else</span> {
<a name="l02280"></a>02280          
<a name="l02281"></a>02281             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l02282"></a>02282                dialed_code[x++] = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02283"></a>02283                dialed_code[x] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02284"></a>02284                <span class="keywordflow">if</span> (strlen(dialed_code) == len) {
<a name="l02285"></a>02285                   x = 0;
<a name="l02286"></a>02286                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &amp;&amp; strncmp(dialed_code, disconnect_code, x)) {
<a name="l02287"></a>02287                   x = 0;
<a name="l02288"></a>02288                   dialed_code[x] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02289"></a>02289                }
<a name="l02290"></a>02290                <span class="keywordflow">if</span> (*dialed_code &amp;&amp; !strcmp(dialed_code, disconnect_code)) {
<a name="l02291"></a>02291                   <span class="comment">/* Caller Canceled the call */</span>
<a name="l02292"></a>02292                   state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>;
<a name="l02293"></a>02293                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02294"></a>02294                   f = NULL;
<a name="l02295"></a>02295                   <span class="keywordflow">break</span>;
<a name="l02296"></a>02296                }
<a name="l02297"></a>02297             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> || f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l02298"></a>02298                <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, f);
<a name="l02299"></a>02299             }
<a name="l02300"></a>02300          }
<a name="l02301"></a>02301       }
<a name="l02302"></a>02302       <span class="keywordflow">if</span> (f)
<a name="l02303"></a>02303          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02304"></a>02304    } <span class="comment">/* end while */</span>
<a name="l02305"></a>02305 
<a name="l02306"></a>02306    <a class="code" href="channel_8h.html#a6b2da1bbe090143571ba1db7f94055a0">ast_poll_channel_del</a>(caller, chan);
<a name="l02307"></a>02307       
<a name="l02308"></a>02308 done:
<a name="l02309"></a>02309    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(caller, -1);
<a name="l02310"></a>02310    <span class="keywordflow">if</span> (chan &amp;&amp; ready) {
<a name="l02311"></a>02311       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) 
<a name="l02312"></a>02312          state = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>;
<a name="l02313"></a>02313       res = 0;
<a name="l02314"></a>02314    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chan) {
<a name="l02315"></a>02315       res = -1;
<a name="l02316"></a>02316       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l02317"></a>02317       chan = NULL;
<a name="l02318"></a>02318    } <span class="keywordflow">else</span> {
<a name="l02319"></a>02319       res = -1;
<a name="l02320"></a>02320    }
<a name="l02321"></a>02321    
<a name="l02322"></a>02322    <span class="keywordflow">if</span> (outstate)
<a name="l02323"></a>02323       *outstate = state;
<a name="l02324"></a>02324 
<a name="l02325"></a>02325    <span class="keywordflow">return</span> chan;
<a name="l02326"></a>02326 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1d1eac183cc14bd4a8bc679fc68200e4"></a><!-- doxytag: member="features.c::find_channel_by_group" ref="a1d1eac183cc14bd4a8bc679fc68200e4" args="(struct ast_channel *c, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int find_channel_by_group </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>c</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l04455">4455</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8h_source.html#l00363">AST_STATE_RING</a>, <a class="el" href="channel_8h_source.html#l00364">AST_STATE_RINGING</a>, <a class="el" href="channel_8h_source.html#l00447">ast_channel::callgroup</a>, <a class="el" href="channel_8h_source.html#l00418">ast_channel::pbx</a>, and <a class="el" href="channel_8h_source.html#l00448">ast_channel::pickupgroup</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04475">ast_pickup_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04455"></a>04455                                                                     {
<a name="l04456"></a>04456    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> = <a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>;
<a name="l04457"></a>04457 
<a name="l04458"></a>04458    <span class="keywordflow">return</span> !c-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a> &amp;&amp;
<a name="l04459"></a>04459       <span class="comment">/* Accessing &apos;chan&apos; here is safe without locking, because there is no way for</span>
<a name="l04460"></a>04460 <span class="comment">         the channel do disappear from under us at this point.  pickupgroup *could*</span>
<a name="l04461"></a>04461 <span class="comment">         change while we&apos;re here, but that isn&apos;t a problem. */</span>
<a name="l04462"></a>04462       (c != chan) &amp;&amp;
<a name="l04463"></a>04463       (chan-&gt;<a class="code" href="structast__channel.html#abc0651bcec68410023c036b7d8ec4d11">pickupgroup</a> &amp; c-&gt;<a class="code" href="structast__channel.html#af0f007b48a9c8cf0629428bd0483e0d1">callgroup</a>) &amp;&amp;
<a name="l04464"></a>04464       ((c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>) || (c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>));
<a name="l04465"></a>04465 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0109970dc3ef884910b9dc1a5fede2e7"></a><!-- doxytag: member="features.c::find_dynamic_feature" ref="a0109970dc3ef884910b9dc1a5fede2e7" args="(const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__call__feature.html">ast_call_feature</a>* find_dynamic_feature </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>find a call feature by name </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l01825">1825</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, and <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01996">feature_interpret()</a>, <a class="el" href="features_8c_source.html#l03672">load_config()</a>, and <a class="el" href="features_8c_source.html#l02099">set_config_flags()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01826"></a>01826 {
<a name="l01827"></a>01827    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *tmp;
<a name="l01828"></a>01828 
<a name="l01829"></a>01829    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>, tmp, feature_entry) {
<a name="l01830"></a>01830       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__call__feature.html#a63c4048019f00ef118af9c631c1e7665">sname</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)) {
<a name="l01831"></a>01831          <span class="keywordflow">break</span>;
<a name="l01832"></a>01832       }
<a name="l01833"></a>01833    }
<a name="l01834"></a>01834 
<a name="l01835"></a>01835    <span class="keywordflow">return</span> tmp;
<a name="l01836"></a>01836 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2de36634b2790793c2629ac1a25f64ea"></a><!-- doxytag: member="features.c::find_group" ref="a2de36634b2790793c2629ac1a25f64ea" args="(const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structfeature__group.html">feature_group</a>* find_group </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find a <a class="el" href="structgroup.html">group</a> by name. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>feature name </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>feature</em>&nbsp;</td><td><a class="el" href="structgroup.html">group</a> on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>NULL</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01863">1863</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, and <a class="el" href="features_8c_source.html#l00186">feature_group::gname</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01996">feature_interpret()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01863"></a>01863                                                           {
<a name="l01864"></a>01864    <span class="keyword">struct </span><a class="code" href="structfeature__group.html">feature_group</a> *fg = NULL;
<a name="l01865"></a>01865 
<a name="l01866"></a>01866    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>, fg, <a class="code" href="structfeature__group.html#acb068077d19df4263373a35c35a49592">entry</a>) {
<a name="l01867"></a>01867       <span class="keywordflow">if</span> (!strcasecmp(fg-&gt;<a class="code" href="structfeature__group.html#ac9e941f7772e1e0c1e1a4b4691d6184e">gname</a>, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>))
<a name="l01868"></a>01868          <span class="keywordflow">break</span>;
<a name="l01869"></a>01869    }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871    <span class="keywordflow">return</span> fg;
<a name="l01872"></a>01872 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab7cacbc2a5f8e49ab8c548df6201601b"></a><!-- doxytag: member="features.c::find_parkinglot" ref="ab7cacbc2a5f8e49ab8c548df6201601b" args="(const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> * find_parkinglot </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find parkinglot by name. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03224">3224</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00968">ao2_find</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="astobj2_8h_source.html#l00678">OBJ_POINTER</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, and <a class="el" href="features_8c_source.html#l00236">parkinglots</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, <a class="el" href="features_8c_source.html#l03335">park_exec_full()</a>, and <a class="el" href="features_8c_source.html#l00566">park_space_reserve()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03225"></a>03225 {
<a name="l03226"></a>03226    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a> = NULL;
<a name="l03227"></a>03227    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> tmp_parkinglot;
<a name="l03228"></a>03228    
<a name="l03229"></a>03229    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>))
<a name="l03230"></a>03230       <span class="keywordflow">return</span> NULL;
<a name="l03231"></a>03231 
<a name="l03232"></a>03232    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp_parkinglot.name, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">sizeof</span>(tmp_parkinglot.name));
<a name="l03233"></a>03233 
<a name="l03234"></a>03234    parkinglot = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, &amp;tmp_parkinglot, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l03235"></a>03235 
<a name="l03236"></a>03236    <span class="keywordflow">if</span> (parkinglot &amp;&amp; <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l03237"></a>03237       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Found Parkinglot: %s\n&quot;</span>, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l03238"></a>03238 
<a name="l03239"></a>03239    <span class="keywordflow">return</span> parkinglot;
<a name="l03240"></a>03240 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5ff0df3df1473ce3b5cec8f947a6fe69"></a><!-- doxytag: member="features.c::findparkinglotname" ref="a5ff0df3df1473ce3b5cec8f947a6fe69" args="(struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static const char* findparkinglotname </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find parking lot name from channel. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00493">493</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, and <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03335">park_exec_full()</a>, and <a class="el" href="features_8c_source.html#l00566">park_space_reserve()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00494"></a>00494 {
<a name="l00495"></a>00495    <span class="keyword">const</span> <span class="keywordtype">char</span> *temp, *<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a> = NULL;
<a name="l00496"></a>00496 
<a name="l00497"></a>00497    <span class="comment">/* Check if the channel has a parking lot */</span>
<a name="l00498"></a>00498    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;parkinglot))
<a name="l00499"></a>00499       parkinglot = chan-&gt;parkinglot;
<a name="l00500"></a>00500 
<a name="l00501"></a>00501    <span class="comment">/* Channel variables override everything */</span>
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    <span class="keywordflow">if</span> ((temp  = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;PARKINGLOT&quot;</span>)))
<a name="l00504"></a>00504       <span class="keywordflow">return</span> temp;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <span class="keywordflow">return</span> parkinglot;
<a name="l00507"></a>00507 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="abea3124e77c14c3a0388e53c3da3231e"></a><!-- doxytag: member="features.c::finishup" ref="abea3124e77c14c3a0388e53c3da3231e" args="(struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int finishup </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01221">1221</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="frame_8h_source.html#l00314">AST_CONTROL_UNHOLD</a>, and <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, and <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01222"></a>01222 {
<a name="l01223"></a>01223    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l01224"></a>01224 
<a name="l01225"></a>01225    <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l01226"></a>01226 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a39926b835e958ba09edbb2cb21a09f6a"></a><!-- doxytag: member="features.c::handle_feature_show" ref="a39926b835e958ba09edbb2cb21a09f6a" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_feature_show </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>CLI command to list configured features. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>e</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cmd</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>a</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>CLI_SUCCESS</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>NULL</em>&nbsp;</td><td>when tab completion is used. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04019">4019</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00780">ao2_iterator_init()</a>, <a class="el" href="astobj2_8h_source.html#l01120">ao2_iterator_next</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="features_8c_source.html#l00320">ast_pickup_ext()</a>, <a class="el" href="linkedlists_8h_source.html#l00451">AST_RWLIST_EMPTY</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00493">AST_RWLIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="lock_8h_source.html#l01796">ast_rwlock_rdlock()</a>, <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="features_8h_source.html#l00055">ast_call_feature::default_exten</a>, <a class="el" href="features_8h_source.html#l00054">ast_call_feature::exten</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, <a class="el" href="features_8c_source.html#l01695">features_lock</a>, <a class="el" href="features_8h_source.html#l00052">ast_call_feature::fname</a>, <a class="el" href="features_8c.html#a0ac894a3d58c2850064c53aeab4c4b98">HFS_FORMAT</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00239">parking_ext</a>, <a class="el" href="features_8c_source.html#l00221">ast_parkinglot::parking_start</a>, <a class="el" href="features_8c_source.html#l00222">ast_parkinglot::parking_stop</a>, <a class="el" href="features_8c_source.html#l00236">parkinglots</a>, <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04020"></a>04020 {
<a name="l04021"></a>04021    <span class="keywordtype">int</span> i;
<a name="l04022"></a>04022    <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l04023"></a>04023    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> iter;
<a name="l04024"></a>04024    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *curlot;
<a name="l04025"></a>04025 <span class="preprocessor">#define HFS_FORMAT &quot;%-25s %-7s %-7s\n&quot;</span>
<a name="l04026"></a>04026 <span class="preprocessor"></span>
<a name="l04027"></a>04027    <span class="keywordflow">switch</span> (cmd) {
<a name="l04028"></a>04028    
<a name="l04029"></a>04029    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04030"></a>04030       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;features show&quot;</span>;
<a name="l04031"></a>04031       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04032"></a>04032          <span class="stringliteral">&quot;Usage: features show\n&quot;</span>
<a name="l04033"></a>04033          <span class="stringliteral">&quot;       Lists configured features\n&quot;</span>;
<a name="l04034"></a>04034       <span class="keywordflow">return</span> NULL;
<a name="l04035"></a>04035    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04036"></a>04036       <span class="keywordflow">return</span> NULL;
<a name="l04037"></a>04037    }
<a name="l04038"></a>04038 
<a name="l04039"></a>04039    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, <span class="stringliteral">&quot;Builtin Feature&quot;</span>, <span class="stringliteral">&quot;Default&quot;</span>, <span class="stringliteral">&quot;Current&quot;</span>);
<a name="l04040"></a>04040    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, <span class="stringliteral">&quot;---------------&quot;</span>, <span class="stringliteral">&quot;-------&quot;</span>, <span class="stringliteral">&quot;-------&quot;</span>);
<a name="l04041"></a>04041 
<a name="l04042"></a>04042    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, <span class="stringliteral">&quot;Pickup&quot;</span>, <span class="stringliteral">&quot;*8&quot;</span>, <a class="code" href="features_8h.html#a849b0c1bd72a0339408c7e6026768e40" title="Determine system call pickup extension.">ast_pickup_ext</a>());          <span class="comment">/* default hardcoded above, so we&apos;ll hardcode it here */</span>
<a name="l04043"></a>04043 
<a name="l04044"></a>04044    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l04045"></a>04045    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; i++)
<a name="l04046"></a>04046       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[i].<a class="code" href="structast__call__feature.html#ae96bbe3347b319ee7bdbd1f2e2ba9f5b">fname</a>, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[i].<a class="code" href="structast__call__feature.html#ab7ea20080a7609ed36233a0aa3f4f42f">default_exten</a>, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[i].<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>);
<a name="l04047"></a>04047    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l04048"></a>04048 
<a name="l04049"></a>04049    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l04050"></a>04050    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, <span class="stringliteral">&quot;Dynamic Feature&quot;</span>, <span class="stringliteral">&quot;Default&quot;</span>, <span class="stringliteral">&quot;Current&quot;</span>);
<a name="l04051"></a>04051    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, <span class="stringliteral">&quot;---------------&quot;</span>, <span class="stringliteral">&quot;-------&quot;</span>, <span class="stringliteral">&quot;-------&quot;</span>);
<a name="l04052"></a>04052    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a0044f6572f50a89049b3b5272e51b0e7">AST_RWLIST_EMPTY</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>)) {
<a name="l04053"></a>04053       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;(none)\n&quot;</span>);
<a name="l04054"></a>04054    } <span class="keywordflow">else</span> {
<a name="l04055"></a>04055       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l04056"></a>04056       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>, feature, feature_entry) {
<a name="l04057"></a>04057          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, HFS_FORMAT, feature-&gt;<a class="code" href="structast__call__feature.html#a63c4048019f00ef118af9c631c1e7665">sname</a>, <span class="stringliteral">&quot;no def&quot;</span>, feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>);
<a name="l04058"></a>04058       }
<a name="l04059"></a>04059       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l04060"></a>04060    }
<a name="l04061"></a>04061 
<a name="l04062"></a>04062    <span class="comment">// loop through all the parking lots</span>
<a name="l04063"></a>04063    iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, 0);
<a name="l04064"></a>04064 
<a name="l04065"></a>04065    <span class="keywordflow">while</span> ((curlot = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;iter))) {
<a name="l04066"></a>04066       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\nCall parking (Parking lot: %s)\n&quot;</span>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l04067"></a>04067       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;------------\n&quot;</span>);
<a name="l04068"></a>04068       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;%-22s:      %s\n&quot;</span>, <span class="stringliteral">&quot;Parking extension&quot;</span>, <a class="code" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>);
<a name="l04069"></a>04069       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;%-22s:      %s\n&quot;</span>, <span class="stringliteral">&quot;Parking context&quot;</span>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l04070"></a>04070       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;%-22s:      %d-%d\n&quot;</span>, <span class="stringliteral">&quot;Parked call extensions&quot;</span>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a>, curlot-&gt;<a class="code" href="structast__parkinglot.html#ac6c6bea761c82a98ef22c655cfbf5a56">parking_stop</a>);
<a name="l04071"></a>04071       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\n&quot;</span>);
<a name="l04072"></a>04072       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(curlot, -1);
<a name="l04073"></a>04073    }
<a name="l04074"></a>04074 
<a name="l04075"></a>04075 
<a name="l04076"></a>04076    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04077"></a>04077 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6d6f533532d3168968124e360ad9a935"></a><!-- doxytag: member="features.c::handle_features_reload" ref="a6d6f533532d3168968124e360ad9a935" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_features_reload </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l04093">4093</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l04079">ast_features_reload()</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04094"></a>04094 {
<a name="l04095"></a>04095    <span class="keywordflow">switch</span> (cmd) { 
<a name="l04096"></a>04096    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04097"></a>04097       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;features reload&quot;</span>;
<a name="l04098"></a>04098       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04099"></a>04099          <span class="stringliteral">&quot;Usage: features reload\n&quot;</span>
<a name="l04100"></a>04100          <span class="stringliteral">&quot;       Reloads configured call features from features.conf\n&quot;</span>;
<a name="l04101"></a>04101       <span class="keywordflow">return</span> NULL;
<a name="l04102"></a>04102    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04103"></a>04103       <span class="keywordflow">return</span> NULL;
<a name="l04104"></a>04104    }
<a name="l04105"></a>04105    <a class="code" href="features_8h.html#a425ed69a5937fc5a26508084a11ceb47" title="Reload call features from features.conf.">ast_features_reload</a>();
<a name="l04106"></a>04106 
<a name="l04107"></a>04107    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04108"></a>04108 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a4b52dc88a4201cfae82e106c4b6e4079"></a><!-- doxytag: member="features.c::handle_parkedcalls" ref="a4b52dc88a4201cfae82e106c4b6e4079" args="(struct ast_cli_entry *e, int cmd, struct ast_cli_args *a)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char* handle_parkedcalls </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> *&nbsp;</td>
          <td class="paramname"> <em>e</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>cmd</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__cli__args.html">ast_cli_args</a> *&nbsp;</td>
          <td class="paramname"> <em>a</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>CLI command to list parked calls. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>e</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>cmd</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>a</em>&nbsp;</td><td>Check right usage, lock parking lot, display parked calls, unlock parking lot list. </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>CLI_SUCCESS</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>CLI_SHOWUSAGE</em>&nbsp;</td><td>on incorrect <a class="el" href="structnumber.html" title="Number structure.">number</a> of arguments. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>NULL</em>&nbsp;</td><td>when tab completion is used. </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04276">4276</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00780">ao2_iterator_init()</a>, <a class="el" href="astobj2_8h_source.html#l01120">ao2_iterator_next</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="cli_8h_source.html#l00140">ast_cli_args::argc</a>, <a class="el" href="cli_8h_source.html#l00167">ast_cli_entry::args</a>, <a class="el" href="cli_8c_source.html#l00100">ast_cli()</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="features_8c_source.html#l00200">parkeduser::chan</a>, <a class="el" href="cli_8h_source.html#l00133">CLI_GENERATE</a>, <a class="el" href="cli_8h_source.html#l00132">CLI_INIT</a>, <a class="el" href="cli_8h_source.html#l00044">CLI_SHOWUSAGE</a>, <a class="el" href="cli_8h_source.html#l00043">CLI_SUCCESS</a>, <a class="el" href="cli_8h_source.html#l00168">ast_cli_entry::command</a>, <a class="el" href="features_8c_source.html#l00204">parkeduser::context</a>, <a class="el" href="cli_8h_source.html#l00058">ESS</a>, <a class="el" href="features_8c_source.html#l00205">parkeduser::exten</a>, <a class="el" href="cli_8h_source.html#l00139">ast_cli_args::fd</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l00203">parkeduser::parkingexten</a>, <a class="el" href="features_8c_source.html#l00236">parkinglots</a>, <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>, <a class="el" href="features_8c_source.html#l00207">parkeduser::parkingtime</a>, <a class="el" href="features_8c_source.html#l00206">parkeduser::priority</a>, <a class="el" href="features_8c_source.html#l00201">parkeduser::start</a>, and <a class="el" href="cli_8h_source.html#l00159">ast_cli_entry::usage</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04277"></a>04277 {
<a name="l04278"></a>04278    <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *cur;
<a name="l04279"></a>04279    <span class="keywordtype">int</span> numparked = 0;
<a name="l04280"></a>04280    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> iter;
<a name="l04281"></a>04281    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *curlot;
<a name="l04282"></a>04282 
<a name="l04283"></a>04283    <span class="keywordflow">switch</span> (cmd) {
<a name="l04284"></a>04284    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04285"></a>04285       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;parkedcalls show&quot;</span>;
<a name="l04286"></a>04286       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04287"></a>04287          <span class="stringliteral">&quot;Usage: parkedcalls show\n&quot;</span>
<a name="l04288"></a>04288          <span class="stringliteral">&quot;       List currently parked calls\n&quot;</span>;
<a name="l04289"></a>04289       <span class="keywordflow">return</span> NULL;
<a name="l04290"></a>04290    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04291"></a>04291       <span class="keywordflow">return</span> NULL;
<a name="l04292"></a>04292    }
<a name="l04293"></a>04293 
<a name="l04294"></a>04294    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l04295"></a>04295       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l04296"></a>04296 
<a name="l04297"></a>04297    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%4s %25s (%-15s %-12s %-4s) %-6s \n&quot;</span>, <span class="stringliteral">&quot;Num&quot;</span>, <span class="stringliteral">&quot;Channel&quot;</span>
<a name="l04298"></a>04298       , <span class="stringliteral">&quot;Context&quot;</span>, <span class="stringliteral">&quot;Extension&quot;</span>, <span class="stringliteral">&quot;Pri&quot;</span>, <span class="stringliteral">&quot;Timeout&quot;</span>);
<a name="l04299"></a>04299 
<a name="l04300"></a>04300    iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, 0);
<a name="l04301"></a>04301    <span class="keywordflow">while</span> ((curlot = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;iter))) {
<a name="l04302"></a>04302       <span class="keywordtype">int</span> lotparked = 0;
<a name="l04303"></a>04303       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;*** Parking lot: %s\n&quot;</span>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l04304"></a>04304 
<a name="l04305"></a>04305       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l04306"></a>04306       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>, cur, list) {
<a name="l04307"></a>04307          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-10.10s %25s (%-15s %-12s %-4d) %6lds\n&quot;</span>
<a name="l04308"></a>04308             ,cur-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, cur-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name, cur-&gt;<a class="code" href="structparkeduser.html#a8c707bb4b898891a7ce41bf1a69f3b66">context</a>, cur-&gt;<a class="code" href="structparkeduser.html#a5bdbf4e9d824b371840d552d602f1384">exten</a>
<a name="l04309"></a>04309             ,cur-&gt;<a class="code" href="structparkeduser.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>,
<a name="l04310"></a>04310             (<span class="keywordtype">long</span>)(cur-&gt;<a class="code" href="structparkeduser.html#ad80305b5e16da9c2675d5f057bd69386">start</a>.tv_sec + (cur-&gt;<a class="code" href="structparkeduser.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a>/1000) - time(NULL)) );
<a name="l04311"></a>04311          numparked++;
<a name="l04312"></a>04312          numparked += lotparked;
<a name="l04313"></a>04313       }
<a name="l04314"></a>04314       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l04315"></a>04315       <span class="keywordflow">if</span> (lotparked)
<a name="l04316"></a>04316          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;   %d parked call%s in parking lot %s\n&quot;</span>, lotparked, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(lotparked), curlot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l04317"></a>04317 
<a name="l04318"></a>04318       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(curlot, -1);
<a name="l04319"></a>04319    }
<a name="l04320"></a>04320 
<a name="l04321"></a>04321    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;---\n%d parked call%s in total.\n&quot;</span>, numparked, <a class="code" href="cli_8h.html#aa09c07179fe1c89f52bb28bc126d26f2">ESS</a>(numparked));
<a name="l04322"></a>04322 
<a name="l04323"></a>04323    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04324"></a>04324 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aed5779f84d4ebb67745d801d3ebede43"></a><!-- doxytag: member="features.c::load_config" ref="aed5779f84d4ebb67745d801d3ebede43" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_config </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000075">Todo:</a></b></dt><dd>XXX var_name or app_args ? </dd></dl>
</p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03672">3672</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00248">adsipark</a>, <a class="el" href="astobj2_8c_source.html#l00147">ao2_lock()</a>, <a class="el" href="astobj2_8c_source.html#l00169">ao2_unlock()</a>, <a class="el" href="features_8h_source.html#l00058">ast_call_feature::app</a>, <a class="el" href="adsistub_8c_source.html#l00053">app</a>, <a class="el" href="features_8h_source.html#l00059">ast_call_feature::app_args</a>, <a class="el" href="isdn__lib_8c_source.html#l00040">ARRAY_LEN</a>, <a class="el" href="pbx_8c_source.html#l07624">ast_add_extension2()</a>, <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="config_8c_source.html#l00613">ast_category_browse()</a>, <a class="el" href="config_8c_source.html#l00827">ast_config_destroy()</a>, <a class="el" href="config_8c_source.html#l02071">ast_config_load2()</a>, <a class="el" href="pbx_8c_source.html#l02430">ast_context_find()</a>, <a class="el" href="pbx_8c_source.html#l06424">ast_context_find_or_create()</a>, <a class="el" href="pbx_8c_source.html#l04823">ast_context_remove_extension2()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="devicestate_8h_source.html#l00054">AST_DEVICE_INUSE</a>, <a class="el" href="devicestate_8h_source.html#l00053">AST_DEVICE_NOT_INUSE</a>, <a class="el" href="features_8h_source.html#l00047">AST_FEATURE_FLAG_BYBOTH</a>, <a class="el" href="features_8h_source.html#l00045">AST_FEATURE_FLAG_BYCALLEE</a>, <a class="el" href="features_8h_source.html#l00046">AST_FEATURE_FLAG_BYCALLER</a>, <a class="el" href="features_8h_source.html#l00042">AST_FEATURE_FLAG_NEEDSDTMF</a>, <a class="el" href="features_8h_source.html#l00043">AST_FEATURE_FLAG_ONPEER</a>, <a class="el" href="features_8h_source.html#l00044">AST_FEATURE_FLAG_ONSELF</a>, <a class="el" href="features_8c_source.html#l01884">ast_find_call_feature()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="features_8c_source.html#l00315">ast_parking_ext()</a>, <a class="el" href="features_8c_source.html#l01711">ast_register_feature()</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00051">AST_RWLIST_WRLOCK</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8c_source.html#l01311">ast_true()</a>, <a class="el" href="features_8c_source.html#l01813">ast_unregister_features()</a>, <a class="el" href="features_8c_source.html#l01839">ast_unregister_groups()</a>, <a class="el" href="config_8c_source.html#l00411">ast_variable_browse()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="features_8c_source.html#l00257">atxfercallbackretries</a>, <a class="el" href="features_8c_source.html#l00255">atxferdropcall</a>, <a class="el" href="features_8c_source.html#l00256">atxferloopdelay</a>, <a class="el" href="features_8c_source.html#l00254">atxfernoanswertimeout</a>, <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, <a class="el" href="features_8c_source.html#l00252">comebacktoorigin</a>, <a class="el" href="config_8h_source.html#l00050">CONFIG_STATUS_FILEINVALID</a>, <a class="el" href="config_8h_source.html#l00048">CONFIG_STATUS_FILEMISSING</a>, <a class="el" href="config_8h_source.html#l00049">CONFIG_STATUS_FILEUNCHANGED</a>, <a class="el" href="features_8c_source.html#l00241">courtesytone</a>, <a class="el" href="features_8c_source.html#l00169">DEFAULT_ATXFER_CALLBACK_RETRIES</a>, <a class="el" href="features_8c_source.html#l00167">DEFAULT_ATXFER_DROP_CALL</a>, <a class="el" href="features_8c_source.html#l00168">DEFAULT_ATXFER_LOOP_DELAY</a>, <a class="el" href="features_8c_source.html#l00164">DEFAULT_FEATURE_DIGIT_TIMEOUT</a>, <a class="el" href="features_8c_source.html#l00165">DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER</a>, <a class="el" href="features_8c_source.html#l00162">DEFAULT_PARK_TIME</a>, <a class="el" href="features_8c_source.html#l00166">DEFAULT_PARKINGLOT</a>, <a class="el" href="chan__iax2_8c_source.html#l00223">default_parkinglot</a>, <a class="el" href="features_8c_source.html#l00163">DEFAULT_TRANSFER_DIGIT_TIMEOUT</a>, <a class="el" href="features_8h_source.html#l00054">ast_call_feature::exten</a>, <a class="el" href="features_8h_source.html#l00032">FEATURE_APP_ARGS_LEN</a>, <a class="el" href="features_8h_source.html#l00031">FEATURE_APP_LEN</a>, <a class="el" href="features_8c_source.html#l01903">feature_exec_app()</a>, <a class="el" href="features_8h_source.html#l00034">FEATURE_EXTEN_LEN</a>, <a class="el" href="features_8h_source.html#l00035">FEATURE_MOH_LEN</a>, <a class="el" href="features_8h_source.html#l00033">FEATURE_SNAME_LEN</a>, <a class="el" href="features_8c_source.html#l00251">featuredigittimeout</a>, <a class="el" href="features_8c_source.html#l01825">find_dynamic_feature()</a>, <a class="el" href="config_8h_source.html#l00081">ast_variable::lineno</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8h_source.html#l00060">ast_call_feature::moh_class</a>, <a class="el" href="config_8h_source.html#l00075">ast_variable::name</a>, <a class="el" href="config_8h_source.html#l00077">ast_variable::next</a>, <a class="el" href="features_8c_source.html#l00510">notify_metermaids()</a>, <a class="el" href="structast__call__feature.html#a9c2eda72263cd25696a89edeaa815fda">ast_call_feature::operation</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="features_8c_source.html#l03659">park_add_hints()</a>, <a class="el" href="features_8c_source.html#l00262">parkcall</a>, <a class="el" href="features_8c_source.html#l00242">parkedplay</a>, <a class="el" href="features_8c_source.html#l00239">parking_ext</a>, <a class="el" href="features_8c_source.html#l00194">pickup_ext</a>, <a class="el" href="features_8c_source.html#l00246">pickupfailsound</a>, <a class="el" href="features_8c_source.html#l00245">pickupsound</a>, <a class="el" href="features_8c_source.html#l01732">register_group()</a>, <a class="el" href="features_8c_source.html#l01767">register_group_feature()</a>, <a class="el" href="features_8c_source.html#l00259">registrar</a>, <a class="el" href="features_8c_source.html#l01970">remap_feature()</a>, <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>, <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>, <a class="el" href="features_8c_source.html#l00250">transferdigittimeout</a>, <a class="el" href="features_8c_source.html#l01960">unmap_features()</a>, <a class="el" href="config_8h_source.html#l00076">ast_variable::value</a>, <a class="el" href="ast__expr2f_8c_source.html#l00613">var</a>, <a class="el" href="features_8c_source.html#l00244">xferfailsound</a>, and <a class="el" href="features_8c_source.html#l00243">xfersound</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>, and <a class="el" href="features_8c_source.html#l04079">ast_features_reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03673"></a>03673 {
<a name="l03674"></a>03674    <span class="keywordtype">int</span> start = 0, end = 0;
<a name="l03675"></a>03675    <span class="keywordtype">int</span> res;
<a name="l03676"></a>03676    <span class="keywordtype">int</span> i;
<a name="l03677"></a>03677    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con = NULL;
<a name="l03678"></a>03678    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l03679"></a>03679    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l03680"></a>03680    <span class="keyword">struct </span><a class="code" href="structfeature__group.html">feature_group</a> *fg = NULL;
<a name="l03681"></a>03681    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { 0 };
<a name="l03682"></a>03682    <span class="keywordtype">char</span> old_parking_ext[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l03683"></a>03683    <span class="keywordtype">char</span> old_parking_con[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03684"></a>03684    <span class="keywordtype">char</span> *ctg; 
<a name="l03685"></a>03685    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *categories[] = { 
<a name="l03686"></a>03686       <span class="comment">/* Categories in features.conf that are not</span>
<a name="l03687"></a>03687 <span class="comment">       * to be parsed as group categories</span>
<a name="l03688"></a>03688 <span class="comment">       */</span>
<a name="l03689"></a>03689       <span class="stringliteral">&quot;general&quot;</span>,
<a name="l03690"></a>03690       <span class="stringliteral">&quot;featuremap&quot;</span>,
<a name="l03691"></a>03691       <span class="stringliteral">&quot;applicationmap&quot;</span>
<a name="l03692"></a>03692    };
<a name="l03693"></a>03693 
<a name="l03694"></a>03694    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>) {
<a name="l03695"></a>03695       strcpy(old_parking_con, <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con);
<a name="l03696"></a>03696       strcpy(old_parking_ext, <a class="code" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>);
<a name="l03697"></a>03697    } <span class="keywordflow">else</span> {
<a name="l03698"></a>03698       <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a> = <a class="code" href="features_8c.html#aadd28dbd7590a172d15245291dfaae1e" title="Build parkinglot from configuration and chain it in.">build_parkinglot</a>(<a class="code" href="features_8c.html#a0c5645209e777b34a100a0ead18144c2">DEFAULT_PARKINGLOT</a>, NULL);
<a name="l03699"></a>03699       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>) {
<a name="l03700"></a>03700          <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>);
<a name="l03701"></a>03701          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_start = 701;
<a name="l03702"></a>03702          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_stop = 750;
<a name="l03703"></a>03703          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_offset = 0;
<a name="l03704"></a>03704          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkfindnext = 0;
<a name="l03705"></a>03705          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkingtime = <a class="code" href="features_8c.html#abc52bb32a2f26f43e2c82795a0d0ea38">DEFAULT_PARK_TIME</a>;
<a name="l03706"></a>03706          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>);
<a name="l03707"></a>03707       }
<a name="l03708"></a>03708    }
<a name="l03709"></a>03709    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>) {
<a name="l03710"></a>03710       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l03711"></a>03711          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Configuration of default parkinglot done.\n&quot;</span>);
<a name="l03712"></a>03712    } <span class="keywordflow">else</span> {
<a name="l03713"></a>03713       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Configuration of default parkinglot failed.\n&quot;</span>);
<a name="l03714"></a>03714       <span class="keywordflow">return</span> -1;
<a name="l03715"></a>03715    }
<a name="l03716"></a>03716    
<a name="l03717"></a>03717 
<a name="l03718"></a>03718    <span class="comment">/* Reset to defaults */</span>
<a name="l03719"></a>03719    strcpy(<a class="code" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>, <span class="stringliteral">&quot;700&quot;</span>);
<a name="l03720"></a>03720    strcpy(<a class="code" href="features_8c.html#a7af3a76f3f29d5a21be63ef43f89840e">pickup_ext</a>, <span class="stringliteral">&quot;*8&quot;</span>);
<a name="l03721"></a>03721    <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03722"></a>03722    strcpy(<a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, <span class="stringliteral">&quot;beep&quot;</span>);
<a name="l03723"></a>03723    strcpy(<a class="code" href="features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a>, <span class="stringliteral">&quot;pbx-invalid&quot;</span>);
<a name="l03724"></a>03724    <a class="code" href="features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03725"></a>03725    <a class="code" href="features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03726"></a>03726    <a class="code" href="features_8c.html#a644feb4e8d3f7dcd077c7c7321af8d5a">adsipark</a> = 0;
<a name="l03727"></a>03727    <a class="code" href="features_8c.html#a1788f4d16d98aa5348dffa550d2632b2">comebacktoorigin</a> = 1;
<a name="l03728"></a>03728 
<a name="l03729"></a>03729    <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkaddhints = 0;
<a name="l03730"></a>03730    <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcalltransfers = 0;
<a name="l03731"></a>03731    <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallreparking = 0;
<a name="l03732"></a>03732    <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallrecording = 0;
<a name="l03733"></a>03733    <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallhangup = 0;
<a name="l03734"></a>03734 
<a name="l03735"></a>03735    <a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a> = <a class="code" href="features_8c.html#a846bf05c38e729e38e932726833d9596">DEFAULT_TRANSFER_DIGIT_TIMEOUT</a>;
<a name="l03736"></a>03736    <a class="code" href="features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a> = <a class="code" href="features_8c.html#a80a4f6e11f5c65942aedf59452cc7f54">DEFAULT_FEATURE_DIGIT_TIMEOUT</a>;
<a name="l03737"></a>03737    <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a> = <a class="code" href="features_8c.html#a13e107144da4d6f673328e73b17bc62c">DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER</a>;
<a name="l03738"></a>03738    <a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a> = <a class="code" href="features_8c.html#a29d8a8c818257651cccbb6e6c9b06292">DEFAULT_ATXFER_LOOP_DELAY</a>;
<a name="l03739"></a>03739    <a class="code" href="features_8c.html#a3a4aff3656629deadbb2294abb1b2e50">atxferdropcall</a> = <a class="code" href="features_8c.html#aa425b91a354e0a8f57183c3ee46c0e48">DEFAULT_ATXFER_DROP_CALL</a>;
<a name="l03740"></a>03740    <a class="code" href="features_8c.html#a42aaa9bbb76f30a8d697eb7c79901045">atxfercallbackretries</a> = <a class="code" href="features_8c.html#a6aea006810fab96e7f7d0026d8cb0053">DEFAULT_ATXFER_CALLBACK_RETRIES</a>;
<a name="l03741"></a>03741 
<a name="l03742"></a>03742    cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;features.conf&quot;</span>, <span class="stringliteral">&quot;features&quot;</span>, config_flags);
<a name="l03743"></a>03743    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l03744"></a>03744       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,<span class="stringliteral">&quot;Could not load features.conf\n&quot;</span>);
<a name="l03745"></a>03745       <span class="keywordflow">return</span> 0;
<a name="l03746"></a>03746    }
<a name="l03747"></a>03747    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03748"></a>03748       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkext&quot;</span>)) {
<a name="l03749"></a>03749          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>));
<a name="l03750"></a>03750       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l03751"></a>03751          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con));
<a name="l03752"></a>03752       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkingtime&quot;</span>)) {
<a name="l03753"></a>03753          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkingtime) != 1) || (<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkingtime &lt; 1)) {
<a name="l03754"></a>03754             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid parkingtime\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03755"></a>03755             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkingtime = <a class="code" href="features_8c.html#abc52bb32a2f26f43e2c82795a0d0ea38">DEFAULT_PARK_TIME</a>;
<a name="l03756"></a>03756          } <span class="keywordflow">else</span>
<a name="l03757"></a>03757             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkingtime = <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkingtime * 1000;
<a name="l03758"></a>03758       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkpos&quot;</span>)) {
<a name="l03759"></a>03759          <span class="keywordflow">if</span> (sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d-%30d&quot;</span>, &amp;start, &amp;end) != 2) {
<a name="l03760"></a>03760             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Format for parking positions is a-b, where a and b are numbers at line %d of features.conf\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l03761"></a>03761          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>) {
<a name="l03762"></a>03762             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_start = start;
<a name="l03763"></a>03763             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_stop = end;
<a name="l03764"></a>03764          } <span class="keywordflow">else</span> {
<a name="l03765"></a>03765             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No default parking lot!\n&quot;</span>);
<a name="l03766"></a>03766          }
<a name="l03767"></a>03767       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;findslot&quot;</span>)) {
<a name="l03768"></a>03768          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkfindnext = (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;next&quot;</span>));
<a name="l03769"></a>03769       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkinghints&quot;</span>)) {
<a name="l03770"></a>03770          <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkaddhints = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03771"></a>03771       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkedcalltransfers&quot;</span>)) {
<a name="l03772"></a>03772          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;both&quot;</span>))
<a name="l03773"></a>03773             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcalltransfers = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>;
<a name="l03774"></a>03774          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l03775"></a>03775             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcalltransfers = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>;
<a name="l03776"></a>03776          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;callee&quot;</span>))
<a name="l03777"></a>03777             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcalltransfers = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>;
<a name="l03778"></a>03778       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkedcallreparking&quot;</span>)) {
<a name="l03779"></a>03779          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;both&quot;</span>))
<a name="l03780"></a>03780             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallreparking = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>;
<a name="l03781"></a>03781          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l03782"></a>03782             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallreparking = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>;
<a name="l03783"></a>03783          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;callee&quot;</span>))
<a name="l03784"></a>03784             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallreparking = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>;
<a name="l03785"></a>03785       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkedcallhangup&quot;</span>)) {
<a name="l03786"></a>03786          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;both&quot;</span>))
<a name="l03787"></a>03787             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallhangup = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>;
<a name="l03788"></a>03788          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l03789"></a>03789             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallhangup = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>;
<a name="l03790"></a>03790          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;callee&quot;</span>))
<a name="l03791"></a>03791             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallhangup = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>;
<a name="l03792"></a>03792       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkedcallrecording&quot;</span>)) {
<a name="l03793"></a>03793          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;both&quot;</span>))
<a name="l03794"></a>03794             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallrecording = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>;
<a name="l03795"></a>03795          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l03796"></a>03796             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallrecording = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>;
<a name="l03797"></a>03797          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;callee&quot;</span>))
<a name="l03798"></a>03798             <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkedcallrecording = <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>;
<a name="l03799"></a>03799       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;adsipark&quot;</span>)) {
<a name="l03800"></a>03800          <a class="code" href="features_8c.html#a644feb4e8d3f7dcd077c7c7321af8d5a">adsipark</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03801"></a>03801       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transferdigittimeout&quot;</span>)) {
<a name="l03802"></a>03802          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;<a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a>) != 1) || (<a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a> &lt; 1)) {
<a name="l03803"></a>03803             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid transferdigittimeout\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03804"></a>03804             <a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a> = <a class="code" href="features_8c.html#a846bf05c38e729e38e932726833d9596">DEFAULT_TRANSFER_DIGIT_TIMEOUT</a>;
<a name="l03805"></a>03805          } <span class="keywordflow">else</span>
<a name="l03806"></a>03806             <a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a> = <a class="code" href="features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a> * 1000;
<a name="l03807"></a>03807       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;featuredigittimeout&quot;</span>)) {
<a name="l03808"></a>03808          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;<a class="code" href="features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a>) != 1) || (<a class="code" href="features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a> &lt; 1)) {
<a name="l03809"></a>03809             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid featuredigittimeout\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03810"></a>03810             <a class="code" href="features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a> = <a class="code" href="features_8c.html#a80a4f6e11f5c65942aedf59452cc7f54">DEFAULT_FEATURE_DIGIT_TIMEOUT</a>;
<a name="l03811"></a>03811          }
<a name="l03812"></a>03812       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;atxfernoanswertimeout&quot;</span>)) {
<a name="l03813"></a>03813          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;<a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a>) != 1) || (<a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a> &lt; 1)) {
<a name="l03814"></a>03814             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid atxfernoanswertimeout\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03815"></a>03815             <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a> = <a class="code" href="features_8c.html#a13e107144da4d6f673328e73b17bc62c">DEFAULT_NOANSWER_TIMEOUT_ATTENDED_TRANSFER</a>;
<a name="l03816"></a>03816          } <span class="keywordflow">else</span>
<a name="l03817"></a>03817             <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a> = <a class="code" href="features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a> * 1000;
<a name="l03818"></a>03818       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;atxferloopdelay&quot;</span>)) {
<a name="l03819"></a>03819          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;<a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a>) != 1)) {
<a name="l03820"></a>03820             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid atxferloopdelay\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03821"></a>03821             <a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a> = <a class="code" href="features_8c.html#a29d8a8c818257651cccbb6e6c9b06292">DEFAULT_ATXFER_LOOP_DELAY</a>;
<a name="l03822"></a>03822          } <span class="keywordflow">else</span> 
<a name="l03823"></a>03823             <a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a> *= 1000;
<a name="l03824"></a>03824       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;atxferdropcall&quot;</span>)) {
<a name="l03825"></a>03825          <a class="code" href="features_8c.html#a3a4aff3656629deadbb2294abb1b2e50">atxferdropcall</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03826"></a>03826       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;atxfercallbackretries&quot;</span>)) {
<a name="l03827"></a>03827          <span class="keywordflow">if</span> ((sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;<a class="code" href="features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a>) != 1)) {
<a name="l03828"></a>03828             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid atxfercallbackretries\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03829"></a>03829             <a class="code" href="features_8c.html#a42aaa9bbb76f30a8d697eb7c79901045">atxfercallbackretries</a> = <a class="code" href="features_8c.html#a6aea006810fab96e7f7d0026d8cb0053">DEFAULT_ATXFER_CALLBACK_RETRIES</a>;
<a name="l03830"></a>03830          }
<a name="l03831"></a>03831       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;courtesytone&quot;</span>)) {
<a name="l03832"></a>03832          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>));
<a name="l03833"></a>03833       }  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkedplay&quot;</span>)) {
<a name="l03834"></a>03834          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;both&quot;</span>))
<a name="l03835"></a>03835             <a class="code" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> = 2;
<a name="l03836"></a>03836          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;parked&quot;</span>))
<a name="l03837"></a>03837             <a class="code" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> = 1;
<a name="l03838"></a>03838          <span class="keywordflow">else</span>
<a name="l03839"></a>03839             <a class="code" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> = 0;
<a name="l03840"></a>03840       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;xfersound&quot;</span>)) {
<a name="l03841"></a>03841          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>));
<a name="l03842"></a>03842       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;xferfailsound&quot;</span>)) {
<a name="l03843"></a>03843          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a>));
<a name="l03844"></a>03844       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pickupexten&quot;</span>)) {
<a name="l03845"></a>03845          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#a7af3a76f3f29d5a21be63ef43f89840e">pickup_ext</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#a7af3a76f3f29d5a21be63ef43f89840e">pickup_ext</a>));
<a name="l03846"></a>03846       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pickupsound&quot;</span>)) {
<a name="l03847"></a>03847          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a>));
<a name="l03848"></a>03848       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pickupfailsound&quot;</span>)) {
<a name="l03849"></a>03849          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a>));
<a name="l03850"></a>03850       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;comebacktoorigin&quot;</span>)) {
<a name="l03851"></a>03851          <a class="code" href="features_8c.html#a1788f4d16d98aa5348dffa550d2632b2">comebacktoorigin</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03852"></a>03852       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkedmusicclass&quot;</span>)) {
<a name="l03853"></a>03853          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;mohclass, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;mohclass));
<a name="l03854"></a>03854       }
<a name="l03855"></a>03855    }
<a name="l03856"></a>03856 
<a name="l03857"></a>03857    <a class="code" href="features_8c.html#a0873e755f478aa3fdcd12ad51a9e9783">unmap_features</a>();
<a name="l03858"></a>03858    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;featuremap&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03859"></a>03859       <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a2b1a39d793bfb9bde86eaddf9e901885">remap_feature</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l03860"></a>03860          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unknown feature &apos;%s&apos;\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03861"></a>03861    }
<a name="l03862"></a>03862 
<a name="l03863"></a>03863    <span class="comment">/* Map a key combination to an application*/</span>
<a name="l03864"></a>03864    <a class="code" href="features_8c.html#a3230befbb308c37f984f069bf129b73b" title="Remove all features in the list.">ast_unregister_features</a>();
<a name="l03865"></a>03865    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;applicationmap&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03866"></a>03866       <span class="keywordtype">char</span> *tmp_val = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03867"></a>03867       <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, *activateon, *activatedby, *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>, *app_args, *moh_class; 
<a name="l03868"></a>03868       <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l03869"></a>03869 
<a name="l03870"></a>03870       <span class="comment">/* strsep() sets the argument to NULL if match not found, and it</span>
<a name="l03871"></a>03871 <span class="comment">       * is safe to use it with a NULL argument, so we don&apos;t check</span>
<a name="l03872"></a>03872 <span class="comment">       * between calls.</span>
<a name="l03873"></a>03873 <span class="comment">       */</span>
<a name="l03874"></a>03874       exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp_val,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l03875"></a>03875       activatedby = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp_val,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l03876"></a>03876       app = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp_val,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l03877"></a>03877       app_args = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp_val,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l03878"></a>03878       moh_class = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp_val,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l03879"></a>03879 
<a name="l03880"></a>03880       activateon = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;activatedby, <span class="stringliteral">&quot;/&quot;</span>);   
<a name="l03881"></a>03881 <span class="comment"></span>
<a name="l03882"></a>03882 <span class="comment">      /*! \todo XXX var_name or app_args ? */</span>
<a name="l03883"></a>03883       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(app) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(activateon) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)) {
<a name="l03884"></a>03884          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Please check the feature Mapping Syntax, either extension, name, or app aren&apos;t provided %s %s %s %s\n&quot;</span>,
<a name="l03885"></a>03885             app, exten, activateon, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03886"></a>03886          <span class="keywordflow">continue</span>;
<a name="l03887"></a>03887       }
<a name="l03888"></a>03888 
<a name="l03889"></a>03889       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l03890"></a>03890       <span class="keywordflow">if</span> ((feature = <a class="code" href="features_8c.html#a0109970dc3ef884910b9dc1a5fede2e7" title="find a call feature by name">find_dynamic_feature</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>))) {
<a name="l03891"></a>03891          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l03892"></a>03892          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Dynamic Feature &apos;%s&apos; specified more than once!\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03893"></a>03893          <span class="keywordflow">continue</span>;
<a name="l03894"></a>03894       }
<a name="l03895"></a>03895       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l03896"></a>03896             
<a name="l03897"></a>03897       <span class="keywordflow">if</span> (!(feature = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*feature))))
<a name="l03898"></a>03898          <span class="keywordflow">continue</span>;               
<a name="l03899"></a>03899 
<a name="l03900"></a>03900       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(feature-&gt;<a class="code" href="structast__call__feature.html#a63c4048019f00ef118af9c631c1e7665">sname</a>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <a class="code" href="features_8h.html#af67231f5862bb84b9a1b33b2eacecdc8">FEATURE_SNAME_LEN</a>);
<a name="l03901"></a>03901       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(feature-&gt;<a class="code" href="structast__call__feature.html#aeee08a60543bdd432ce7d81027445ad2">app</a>, app, <a class="code" href="features_8h.html#a5dd21373ce06047f1fc916ef86a3644c">FEATURE_APP_LEN</a>);
<a name="l03902"></a>03902       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>, exten, <a class="code" href="features_8h.html#a1c5e2f1a4178d55ed017613a10d5bd66">FEATURE_EXTEN_LEN</a>);
<a name="l03903"></a>03903       
<a name="l03904"></a>03904       <span class="keywordflow">if</span> (app_args) 
<a name="l03905"></a>03905          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(feature-&gt;<a class="code" href="structast__call__feature.html#a022a806be6b7b1b700453fd4575481d8">app_args</a>, app_args, <a class="code" href="features_8h.html#a15dec7b203bbbe9b2876542e11192038">FEATURE_APP_ARGS_LEN</a>);
<a name="l03906"></a>03906 
<a name="l03907"></a>03907       <span class="keywordflow">if</span> (moh_class)
<a name="l03908"></a>03908          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(feature-&gt;<a class="code" href="structast__call__feature.html#ae8d6ce9122f07e793836c229c7e4d318">moh_class</a>, moh_class, <a class="code" href="features_8h.html#a5b60615b76d1e41b08f220ed65050e9c">FEATURE_MOH_LEN</a>);
<a name="l03909"></a>03909          
<a name="l03910"></a>03910       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>, exten, <span class="keyword">sizeof</span>(feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>));
<a name="l03911"></a>03911       feature-&gt;<a class="code" href="structast__call__feature.html#a9c2eda72263cd25696a89edeaa815fda">operation</a> = <a class="code" href="features_8c.html#a7d36808a9da972e429854519d6ced84c" title="exec an app by feature">feature_exec_app</a>;
<a name="l03912"></a>03912       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca7e260a8ce4ea1f7036380328a503f417">AST_FEATURE_FLAG_NEEDSDTMF</a>);
<a name="l03913"></a>03913 
<a name="l03914"></a>03914       <span class="comment">/* Allow caller and calle to be specified for backwards compatability */</span>
<a name="l03915"></a>03915       <span class="keywordflow">if</span> (!strcasecmp(activateon, <span class="stringliteral">&quot;self&quot;</span>) || !strcasecmp(activateon, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l03916"></a>03916          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca2400fd06fffa892d753ab1957f653d41">AST_FEATURE_FLAG_ONSELF</a>);
<a name="l03917"></a>03917       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activateon, <span class="stringliteral">&quot;peer&quot;</span>) || !strcasecmp(activateon, <span class="stringliteral">&quot;callee&quot;</span>))
<a name="l03918"></a>03918          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca1d106267aa4d386c2354dc57b8ec6a40">AST_FEATURE_FLAG_ONPEER</a>);
<a name="l03919"></a>03919       <span class="keywordflow">else</span> {
<a name="l03920"></a>03920          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid &apos;ActivateOn&apos; specification for feature &apos;%s&apos;,&quot;</span>
<a name="l03921"></a>03921             <span class="stringliteral">&quot; must be &apos;self&apos;, or &apos;peer&apos;\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03922"></a>03922          <span class="keywordflow">continue</span>;
<a name="l03923"></a>03923       }
<a name="l03924"></a>03924 
<a name="l03925"></a>03925       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(activatedby))
<a name="l03926"></a>03926          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>);
<a name="l03927"></a>03927       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activatedby, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l03928"></a>03928          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>);
<a name="l03929"></a>03929       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activatedby, <span class="stringliteral">&quot;callee&quot;</span>))
<a name="l03930"></a>03930          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>);
<a name="l03931"></a>03931       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(activatedby, <span class="stringliteral">&quot;both&quot;</span>))
<a name="l03932"></a>03932          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>);
<a name="l03933"></a>03933       <span class="keywordflow">else</span> {
<a name="l03934"></a>03934          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid &apos;ActivatedBy&apos; specification for feature &apos;%s&apos;,&quot;</span>
<a name="l03935"></a>03935             <span class="stringliteral">&quot; must be &apos;caller&apos;, or &apos;callee&apos;, or &apos;both&apos;\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03936"></a>03936          <span class="keywordflow">continue</span>;
<a name="l03937"></a>03937       }
<a name="l03938"></a>03938 
<a name="l03939"></a>03939       <a class="code" href="features_8h.html#aa148867dd4dde459d181fc84be58c0f0" title="register new feature into feature_set">ast_register_feature</a>(feature);
<a name="l03940"></a>03940          
<a name="l03941"></a>03941       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Mapping Feature &apos;%s&apos; to app &apos;%s(%s)&apos; with code &apos;%s&apos;\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, app, app_args, exten);
<a name="l03942"></a>03942    }
<a name="l03943"></a>03943 
<a name="l03944"></a>03944    <a class="code" href="features_8c.html#ad9244bff3ee975cad01b501ad64ecc5d" title="Remove all feature groups in the list.">ast_unregister_groups</a>();
<a name="l03945"></a>03945    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l03946"></a>03946 
<a name="l03947"></a>03947    ctg = NULL;
<a name="l03948"></a>03948    <span class="keywordflow">while</span> ((ctg = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, ctg))) {
<a name="l03949"></a>03949       <span class="comment">/* Is this a parkinglot definition ? */</span>
<a name="l03950"></a>03950       <span class="keywordflow">if</span> (!strncasecmp(ctg, <span class="stringliteral">&quot;parkinglot_&quot;</span>, strlen(<span class="stringliteral">&quot;parkinglot_&quot;</span>))) {
<a name="l03951"></a>03951          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Found configuration section %s, assume parking context\n&quot;</span>, ctg);
<a name="l03952"></a>03952          <span class="keywordflow">if</span>(!<a class="code" href="features_8c.html#aadd28dbd7590a172d15245291dfaae1e" title="Build parkinglot from configuration and chain it in.">build_parkinglot</a>(ctg, <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, ctg)))
<a name="l03953"></a>03953             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not build parking lot %s. Configuration error.\n&quot;</span>, ctg);
<a name="l03954"></a>03954          <span class="keywordflow">else</span>
<a name="l03955"></a>03955             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Configured parking context %s\n&quot;</span>, ctg);
<a name="l03956"></a>03956          <span class="keywordflow">continue</span>;   
<a name="l03957"></a>03957       }
<a name="l03958"></a>03958       <span class="comment">/* No, check if it&apos;s a group */</span>
<a name="l03959"></a>03959       <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(categories); i++) {
<a name="l03960"></a>03960          <span class="keywordflow">if</span> (!strcasecmp(categories[i], ctg))
<a name="l03961"></a>03961             <span class="keywordflow">break</span>;
<a name="l03962"></a>03962       }
<a name="l03963"></a>03963 
<a name="l03964"></a>03964       <span class="keywordflow">if</span> (i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(categories)) 
<a name="l03965"></a>03965          <span class="keywordflow">continue</span>;
<a name="l03966"></a>03966 
<a name="l03967"></a>03967       <span class="keywordflow">if</span> (!(fg = <a class="code" href="features_8c.html#aec9d75b1e054035dae95035292c36937" title="Add new feature group.">register_group</a>(ctg)))
<a name="l03968"></a>03968          <span class="keywordflow">continue</span>;
<a name="l03969"></a>03969 
<a name="l03970"></a>03970       <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, ctg); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03971"></a>03971          <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l03972"></a>03972 
<a name="l03973"></a>03973          <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l03974"></a>03974          <span class="keywordflow">if</span> (!(feature = <a class="code" href="features_8c.html#a0109970dc3ef884910b9dc1a5fede2e7" title="find a call feature by name">find_dynamic_feature</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)) &amp;&amp; 
<a name="l03975"></a>03975              !(feature = <a class="code" href="features_8h.html#afe968c2bd566a03c0bc212faa7a37e17" title="look for a call feature entry by its sname">ast_find_call_feature</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>))) {
<a name="l03976"></a>03976             <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l03977"></a>03977             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Feature &apos;%s&apos; was not found.\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l03978"></a>03978             <span class="keywordflow">continue</span>;
<a name="l03979"></a>03979          }
<a name="l03980"></a>03980          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l03981"></a>03981 
<a name="l03982"></a>03982          <a class="code" href="features_8c.html#ae592cf7dec3edf756bc8647f56a740d7" title="Add feature to group.">register_group_feature</a>(fg, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, feature);
<a name="l03983"></a>03983       }
<a name="l03984"></a>03984    }
<a name="l03985"></a>03985 
<a name="l03986"></a>03986    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>);
<a name="l03987"></a>03987 
<a name="l03988"></a>03988    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03989"></a>03989 
<a name="l03990"></a>03990    <span class="comment">/* Remove the old parking extension */</span>
<a name="l03991"></a>03991    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(old_parking_con) &amp;&amp; (con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(old_parking_con))) {
<a name="l03992"></a>03992       <span class="keywordflow">if</span>(<a class="code" href="pbx_8h.html#a25dad382feec89a9bbc6c5284bb30e25" title="This functionc locks given context, search for the right extension and fires out...">ast_context_remove_extension2</a>(con, old_parking_ext, 1, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>, 0))
<a name="l03993"></a>03993             <a class="code" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9" title="Notify metermaids that we&amp;#39;ve changed an extension.">notify_metermaids</a>(old_parking_ext, old_parking_con, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>);
<a name="l03994"></a>03994       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Removed old parking extension %s@%s\n&quot;</span>, old_parking_ext, old_parking_con);
<a name="l03995"></a>03995    }
<a name="l03996"></a>03996    
<a name="l03997"></a>03997    <span class="keywordflow">if</span> (!(con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>))) {
<a name="l03998"></a>03998       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Parking context &apos;%s&apos; does not exist and unable to create\n&quot;</span>, <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con);
<a name="l03999"></a>03999       <span class="keywordflow">return</span> -1;
<a name="l04000"></a>04000    }
<a name="l04001"></a>04001    res = <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 1, <a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>(), 1, NULL, NULL, <a class="code" href="features_8c.html#ac3950a3179488304a97d02de9488c205">parkcall</a>, NULL, NULL, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l04002"></a>04002    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parkaddhints)
<a name="l04003"></a>04003       <a class="code" href="features_8c.html#aa3b3766aea99a4ace3b34a21c9d73624" title="Add parking hints for all defined parking lots.">park_add_hints</a>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con, <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_start, <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_stop);
<a name="l04004"></a>04004    <span class="keywordflow">if</span> (!res)
<a name="l04005"></a>04005       <a class="code" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9" title="Notify metermaids that we&amp;#39;ve changed an extension.">notify_metermaids</a>(<a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>(), <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>-&gt;parking_con, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>);
<a name="l04006"></a>04006    <span class="keywordflow">return</span> res;
<a name="l04007"></a>04007 
<a name="l04008"></a>04008 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac513c11fb4717d40cf8cd46cf387c0fe"></a><!-- doxytag: member="features.c::manage_parkinglot" ref="ac513c11fb4717d40cf8cd46cf387c0fe" args="(struct ast_parkinglot *curlot, fd_set *rfds, fd_set *efds, fd_set *nrfds, fd_set *nefds, int *ms, int *max)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int manage_parkinglot </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td>
          <td class="paramname"> <em>curlot</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">fd_set *&nbsp;</td>
          <td class="paramname"> <em>rfds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">fd_set *&nbsp;</td>
          <td class="paramname"> <em>efds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">fd_set *&nbsp;</td>
          <td class="paramname"> <em>nrfds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">fd_set *&nbsp;</td>
          <td class="paramname"> <em>nefds</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>fs</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>max</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Run management on parkinglots, called once per parkinglot. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03009">3009</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l07624">ast_add_extension2()</a>, <a class="el" href="channel_8c_source.html#l01548">ast_channel_datastore_find()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="pbx_8c_source.html#l02430">ast_context_find()</a>, <a class="el" href="pbx_8c_source.html#l06424">ast_context_find_or_create()</a>, <a class="el" href="pbx_8c_source.html#l04823">ast_context_remove_extension2()</a>, <a class="el" href="frame_8h_source.html#l00298">AST_CONTROL_HANGUP</a>, <a class="el" href="frame_8h_source.html#l00313">AST_CONTROL_HOLD</a>, <a class="el" href="frame_8h_source.html#l00314">AST_CONTROL_UNHOLD</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="devicestate_8h_source.html#l00053">AST_DEVICE_NOT_INUSE</a>, <a class="el" href="channel_8h_source.html#l00531">AST_FLAG_EXCEPTION</a>, <a class="el" href="frame_8h_source.html#l00105">AST_FRAME_CONTROL</a>, <a class="el" href="utils_8h_source.html#l00415">ast_free_ptr()</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="channel_8c_source.html#l03150">ast_indicate_data()</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00553">AST_LIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h_source.html#l00528">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00599">AST_LIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8h_source.html#l00153">AST_MAX_FDS</a>, <a class="el" href="pbx_8c_source.html#l04559">ast_pbx_start()</a>, <a class="el" href="channel_8c_source.html#l03100">ast_read()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="time_8h_source.html#l00089">ast_tvdiff_ms()</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="adsistub_8c_source.html#l00059">buf</a>, <a class="el" href="features_8c_source.html#l02964">callback_dialoptions()</a>, <a class="el" href="features_8c_source.html#l00200">parkeduser::chan</a>, <a class="el" href="features_8c_source.html#l00252">comebacktoorigin</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="features_8c_source.html#l00204">parkeduser::context</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="features_8c_source.html#l00205">parkeduser::exten</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="channel_8h_source.html#l00464">ast_channel::fdno</a>, <a class="el" href="channel_8h_source.html#l00458">ast_channel::fds</a>, <a class="el" href="features_8c_source.html#l00276">ast_dial_features::features_callee</a>, <a class="el" href="features_8c_source.html#l00275">ast_dial_features::features_caller</a>, <a class="el" href="frame_8h_source.html#l00143">ast_frame::frametype</a>, <a class="el" href="astmm_8h_source.html#l00084">free</a>, <a class="el" href="channel_8h_source.html#l00403">ast_channel::generatordata</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00172">MAX_DIAL_FEATURE_OPTIONS</a>, <a class="el" href="features_8c_source.html#l00211">parkeduser::moh_trys</a>, <a class="el" href="features_8c_source.html#l00226">ast_parkinglot::mohclass</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l00510">notify_metermaids()</a>, <a class="el" href="features_8c_source.html#l00208">parkeduser::notquiteyet</a>, <a class="el" href="features_8c_source.html#l00209">parkeduser::options_specified</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00220">ast_parkinglot::parking_con_dial</a>, <a class="el" href="features_8c_source.html#l00203">parkeduser::parkingexten</a>, <a class="el" href="features_8c_source.html#l00212">parkeduser::parkinglot</a>, <a class="el" href="features_8c_source.html#l00202">parkeduser::parkingnum</a>, <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>, <a class="el" href="features_8c_source.html#l00207">parkeduser::parkingtime</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="features_8c_source.html#l00210">parkeduser::peername</a>, <a class="el" href="features_8c_source.html#l02946">post_manager_event()</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="features_8c_source.html#l00206">parkeduser::priority</a>, <a class="el" href="features_8c_source.html#l00259">registrar</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="features_8c_source.html#l00351">set_c_e_p()</a>, <a class="el" href="features_8c_source.html#l00201">parkeduser::start</a>, and <a class="el" href="frame_8h_source.html#l00145">ast_frame::subclass</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03189">do_parking_thread()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03010"></a>03010 {
<a name="l03011"></a>03011 
<a name="l03012"></a>03012    <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *pu;
<a name="l03013"></a>03013    <span class="keywordtype">int</span> res = 0;
<a name="l03014"></a>03014    <span class="keywordtype">char</span> parkingslot[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l03015"></a>03015 
<a name="l03016"></a>03016    <span class="comment">/* Lock parking list */</span>
<a name="l03017"></a>03017    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l03018"></a>03018    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>, pu, <a class="code" href="structparkeduser.html#ac46ac8b4dbcd711b75c11ba7044a94c0">list</a>) {
<a name="l03019"></a>03019       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a> = pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>;   <span class="comment">/* shorthand */</span>
<a name="l03020"></a>03020       <span class="keywordtype">int</span> tms;        <span class="comment">/* timeout for this item */</span>
<a name="l03021"></a>03021       <span class="keywordtype">int</span> x;          <span class="comment">/* fd index in channel */</span>
<a name="l03022"></a>03022       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l03023"></a>03023 
<a name="l03024"></a>03024       <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#aeaf3504d3f44186d5fcfaced55711751">notquiteyet</a>) { <span class="comment">/* Pretend this one isn&apos;t here yet */</span>
<a name="l03025"></a>03025          <span class="keywordflow">continue</span>;
<a name="l03026"></a>03026       }
<a name="l03027"></a>03027       tms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), pu-&gt;<a class="code" href="structparkeduser.html#ad80305b5e16da9c2675d5f057bd69386">start</a>);
<a name="l03028"></a>03028       <span class="keywordflow">if</span> (tms &gt; pu-&gt;<a class="code" href="structparkeduser.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a>) {
<a name="l03029"></a>03029          <span class="comment">/* Stop music on hold */</span>
<a name="l03030"></a>03030          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l03031"></a>03031          <span class="comment">/* Get chan, exten from derived kludge */</span>
<a name="l03032"></a>03032          <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>[0]) {
<a name="l03033"></a>03033             <span class="keywordtype">char</span> *peername = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(pu-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>);
<a name="l03034"></a>03034             <span class="keywordtype">char</span> *cp = strrchr(peername, <span class="charliteral">&apos;-&apos;</span>);
<a name="l03035"></a>03035             <span class="keywordtype">char</span> peername_flat[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>]; <span class="comment">/* using something like DAHDI/52 for an extension name is NOT a good idea */</span>
<a name="l03036"></a>03036             <span class="keywordtype">int</span> i;
<a name="l03037"></a>03037 
<a name="l03038"></a>03038             <span class="keywordflow">if</span> (cp) 
<a name="l03039"></a>03039                *cp = 0;
<a name="l03040"></a>03040             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(peername_flat,peername,<span class="keyword">sizeof</span>(peername_flat));
<a name="l03041"></a>03041             <span class="keywordflow">for</span>(i=0; peername_flat[i] &amp;&amp; i &lt; <a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>; i++) {
<a name="l03042"></a>03042                <span class="keywordflow">if</span> (peername_flat[i] == <span class="charliteral">&apos;/&apos;</span>) 
<a name="l03043"></a>03043                   peername_flat[i]= <span class="charliteral">&apos;0&apos;</span>;
<a name="l03044"></a>03044             }
<a name="l03045"></a>03045             con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a71758464557c527ec3767402f8f31208">parking_con_dial</a>, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l03046"></a>03046             <span class="keywordflow">if</span> (!con) {
<a name="l03047"></a>03047                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Parking dial context &apos;%s&apos; does not exist and unable to create\n&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a71758464557c527ec3767402f8f31208">parking_con_dial</a>);
<a name="l03048"></a>03048             }
<a name="l03049"></a>03049             <span class="keywordflow">if</span> (con) {
<a name="l03050"></a>03050                <span class="keywordtype">char</span> returnexten[AST_MAX_EXTENSION];
<a name="l03051"></a>03051                <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *features_datastore;
<a name="l03052"></a>03052                <span class="keyword">struct </span><a class="code" href="structast__dial__features.html">ast_dial_features</a> *dialfeatures = NULL;
<a name="l03053"></a>03053 
<a name="l03054"></a>03054                <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l03055"></a>03055 
<a name="l03056"></a>03056                <span class="keywordflow">if</span> ((features_datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL)))
<a name="l03057"></a>03057                   dialfeatures = features_datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03058"></a>03058 
<a name="l03059"></a>03059                <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l03060"></a>03060 
<a name="l03061"></a>03061                <span class="keywordflow">if</span> (!strncmp(peername, <span class="stringliteral">&quot;Parked/&quot;</span>, 7)) {
<a name="l03062"></a>03062                   peername += 7;
<a name="l03063"></a>03063                }
<a name="l03064"></a>03064 
<a name="l03065"></a>03065                <span class="keywordflow">if</span> (dialfeatures) {
<a name="l03066"></a>03066                   <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="features_8c.html#a58b5e7c82122d6925893b4a50fb37860">MAX_DIAL_FEATURE_OPTIONS</a>] = {0,};
<a name="l03067"></a>03067                   snprintf(returnexten, <span class="keyword">sizeof</span>(returnexten), <span class="stringliteral">&quot;%s,30,%s&quot;</span>, peername, <a class="code" href="features_8c.html#a88974a178f7f1c082551b0516c5fe7fd">callback_dialoptions</a>(&amp;(dialfeatures-&gt;<a class="code" href="structast__dial__features.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), &amp;(dialfeatures-&gt;<a class="code" href="structast__dial__features.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), buf, <span class="keyword">sizeof</span>(buf)));
<a name="l03068"></a>03068                } <span class="keywordflow">else</span> { <span class="comment">/* Existing default */</span>
<a name="l03069"></a>03069                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Dialfeatures not found on %s, using default!\n&quot;</span>, chan-&gt;name);
<a name="l03070"></a>03070                   snprintf(returnexten, <span class="keyword">sizeof</span>(returnexten), <span class="stringliteral">&quot;%s,30,t&quot;</span>, peername);
<a name="l03071"></a>03071                }
<a name="l03072"></a>03072 
<a name="l03073"></a>03073                <a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 1, peername_flat, 1, NULL, NULL, <span class="stringliteral">&quot;Dial&quot;</span>, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(returnexten), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l03074"></a>03074             }
<a name="l03075"></a>03075             <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#a8d4a181d04b1fc1448ca0d48047a4e27">options_specified</a> == 1) {
<a name="l03076"></a>03076                <span class="comment">/* Park() was called with overriding return arguments, respect those arguments */</span>
<a name="l03077"></a>03077                <a class="code" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c" title="store context, extension and priority">set_c_e_p</a>(chan, pu-&gt;<a class="code" href="structparkeduser.html#a8c707bb4b898891a7ce41bf1a69f3b66">context</a>, pu-&gt;<a class="code" href="structparkeduser.html#a5bdbf4e9d824b371840d552d602f1384">exten</a>, pu-&gt;<a class="code" href="structparkeduser.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l03078"></a>03078             } <span class="keywordflow">else</span> {
<a name="l03079"></a>03079                <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a1788f4d16d98aa5348dffa550d2632b2">comebacktoorigin</a>) {
<a name="l03080"></a>03080                   <a class="code" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c" title="store context, extension and priority">set_c_e_p</a>(chan, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a71758464557c527ec3767402f8f31208">parking_con_dial</a>, peername_flat, 1);
<a name="l03081"></a>03081                } <span class="keywordflow">else</span> {
<a name="l03082"></a>03082                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;now going to parkedcallstimeout,s,1 | ps is %d\n&quot;</span>,pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>);
<a name="l03083"></a>03083                   snprintf(parkingslot, <span class="keyword">sizeof</span>(parkingslot), <span class="stringliteral">&quot;%d&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>);
<a name="l03084"></a>03084                   <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;PARKINGSLOT&quot;</span>, parkingslot);
<a name="l03085"></a>03085                   <a class="code" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c" title="store context, extension and priority">set_c_e_p</a>(chan, <span class="stringliteral">&quot;parkedcallstimeout&quot;</span>, peername_flat, 1);
<a name="l03086"></a>03086                }
<a name="l03087"></a>03087             }
<a name="l03088"></a>03088          } <span class="keywordflow">else</span> {
<a name="l03089"></a>03089             <span class="comment">/* They&apos;ve been waiting too long, send them back to where they came.  Theoretically they</span>
<a name="l03090"></a>03090 <span class="comment">               should have their original extensions and such, but we copy to be on the safe side */</span>
<a name="l03091"></a>03091             <a class="code" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c" title="store context, extension and priority">set_c_e_p</a>(chan, pu-&gt;<a class="code" href="structparkeduser.html#a8c707bb4b898891a7ce41bf1a69f3b66">context</a>, pu-&gt;<a class="code" href="structparkeduser.html#a5bdbf4e9d824b371840d552d602f1384">exten</a>, pu-&gt;<a class="code" href="structparkeduser.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l03092"></a>03092          }
<a name="l03093"></a>03093          <a class="code" href="features_8c.html#a357c36e1b760f6742b5803dd78905306" title="Output parking event to manager.">post_manager_event</a>(<span class="stringliteral">&quot;ParkedCallTimeOut&quot;</span>, pu);
<a name="l03094"></a>03094 
<a name="l03095"></a>03095          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Timeout for %s parked on %d (%s). Returning to %s,%s,%d\n&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name, pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l03096"></a>03096          <span class="comment">/* Start up the PBX, or hang them up */</span>
<a name="l03097"></a>03097          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(chan))  {
<a name="l03098"></a>03098             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restart the PBX for user on &apos;%s&apos;, hanging them up...\n&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name);
<a name="l03099"></a>03099             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l03100"></a>03100          }
<a name="l03101"></a>03101          <span class="comment">/* And take them out of the parking lot */</span>
<a name="l03102"></a>03102          con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l03103"></a>03103          <span class="keywordflow">if</span> (con) {
<a name="l03104"></a>03104             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a25dad382feec89a9bbc6c5284bb30e25" title="This functionc locks given context, search for the right extension and fires out...">ast_context_remove_extension2</a>(con, pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, 1, NULL, 0))
<a name="l03105"></a>03105                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, failed to remove the parking extension!\n&quot;</span>);
<a name="l03106"></a>03106             <span class="keywordflow">else</span>
<a name="l03107"></a>03107                <a class="code" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9" title="Notify metermaids that we&amp;#39;ve changed an extension.">notify_metermaids</a>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>);
<a name="l03108"></a>03108          } <span class="keywordflow">else</span>
<a name="l03109"></a>03109             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, no parking context?\n&quot;</span>);
<a name="l03110"></a>03110          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l03111"></a>03111          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(pu);
<a name="l03112"></a>03112       } <span class="keywordflow">else</span> { <span class="comment">/* still within parking time, process descriptors */</span>
<a name="l03113"></a>03113          <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="channel_8h.html#aa3fc504e7ca90586e4d249831838de3c">AST_MAX_FDS</a>; x++) {
<a name="l03114"></a>03114             <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l03115"></a>03115 
<a name="l03116"></a>03116             <span class="keywordflow">if</span> ((chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x] == -1) || (!FD_ISSET(chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x], rfds) &amp;&amp; !FD_ISSET(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x], efds))) 
<a name="l03117"></a>03117                <span class="keywordflow">continue</span>;
<a name="l03118"></a>03118             
<a name="l03119"></a>03119             <span class="keywordflow">if</span> (FD_ISSET(chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x], efds))
<a name="l03120"></a>03120                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a75202bcfa58fce5d40e2daddc73b8d11">AST_FLAG_EXCEPTION</a>);
<a name="l03121"></a>03121             <span class="keywordflow">else</span>
<a name="l03122"></a>03122                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a75202bcfa58fce5d40e2daddc73b8d11">AST_FLAG_EXCEPTION</a>);
<a name="l03123"></a>03123             chan-&gt;<a class="code" href="structast__channel.html#a3a804162c4be609a8def28f69b3e93b2">fdno</a> = x;
<a name="l03124"></a>03124 
<a name="l03125"></a>03125             <span class="comment">/* See if they need servicing */</span>
<a name="l03126"></a>03126             f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>);
<a name="l03127"></a>03127             <span class="comment">/* Hangup? */</span>
<a name="l03128"></a>03128             <span class="keywordflow">if</span> (!f || ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> ==  <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>))) {
<a name="l03129"></a>03129                <span class="keywordflow">if</span> (f)
<a name="l03130"></a>03130                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03131"></a>03131                <a class="code" href="features_8c.html#a357c36e1b760f6742b5803dd78905306" title="Output parking event to manager.">post_manager_event</a>(<span class="stringliteral">&quot;ParkedCallGiveUp&quot;</span>, pu);
<a name="l03132"></a>03132 
<a name="l03133"></a>03133                <span class="comment">/* There&apos;s a problem, hang them up*/</span>
<a name="l03134"></a>03134                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;%s got tired of being parked\n&quot;</span>, chan-&gt;name);
<a name="l03135"></a>03135                <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l03136"></a>03136                <span class="comment">/* And take them out of the parking lot */</span>
<a name="l03137"></a>03137                con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(curlot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l03138"></a>03138                <span class="keywordflow">if</span> (con) {
<a name="l03139"></a>03139                   <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a25dad382feec89a9bbc6c5284bb30e25" title="This functionc locks given context, search for the right extension and fires out...">ast_context_remove_extension2</a>(con, pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, 1, NULL, 0))
<a name="l03140"></a>03140                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, failed to remove the extension!\n&quot;</span>);
<a name="l03141"></a>03141                   <span class="keywordflow">else</span>
<a name="l03142"></a>03142                      <a class="code" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9" title="Notify metermaids that we&amp;#39;ve changed an extension.">notify_metermaids</a>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>);
<a name="l03143"></a>03143                } <span class="keywordflow">else</span>
<a name="l03144"></a>03144                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, no parking context for parking lot %s?\n&quot;</span>, curlot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l03145"></a>03145                <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l03146"></a>03146                <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(pu);
<a name="l03147"></a>03147                <span class="keywordflow">break</span>;
<a name="l03148"></a>03148             } <span class="keywordflow">else</span> {
<a name="l03149"></a>03149                <span class="comment">/* XXX Maybe we could do something with packets, like dial &quot;0&quot; for operator or something XXX */</span>
<a name="l03150"></a>03150                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03151"></a>03151                <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#a93027293ecabf599113cbdb94384b1e0">moh_trys</a> &lt; 3 &amp;&amp; !chan-&gt;<a class="code" href="structast__channel.html#abe7876f86e249ea3db5fbacd2231389c">generatordata</a>) {
<a name="l03152"></a>03152                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;MOH on parked call stopped by outside source.  Restarting on channel %s.\n&quot;</span>, chan-&gt;name);
<a name="l03153"></a>03153                   <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, 
<a name="l03154"></a>03154                      <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(curlot-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>, NULL),
<a name="l03155"></a>03155                      (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(curlot-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>) ? strlen(curlot-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>) + 1 : 0));
<a name="l03156"></a>03156                   pu-&gt;<a class="code" href="structparkeduser.html#a93027293ecabf599113cbdb94384b1e0">moh_trys</a>++;
<a name="l03157"></a>03157                }
<a name="l03158"></a>03158                <span class="keywordflow">goto</span> std;   <span class="comment">/* XXX Ick: jumping into an else statement??? XXX */</span>
<a name="l03159"></a>03159             }
<a name="l03160"></a>03160          } <span class="comment">/* End for */</span>
<a name="l03161"></a>03161          <span class="keywordflow">if</span> (x &gt;= AST_MAX_FDS) {
<a name="l03162"></a>03162 std:           <span class="keywordflow">for</span> (x=0; x&lt;AST_MAX_FDS; x++) {  <span class="comment">/* mark fds for next round */</span>
<a name="l03163"></a>03163                <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x] &gt; -1) {
<a name="l03164"></a>03164                   FD_SET(chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x], nrfds);
<a name="l03165"></a>03165                   FD_SET(chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x], nefds);
<a name="l03166"></a>03166                   <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x] &gt; *max)
<a name="l03167"></a>03167                      *max = chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[x];
<a name="l03168"></a>03168                }
<a name="l03169"></a>03169             }
<a name="l03170"></a>03170             <span class="comment">/* Keep track of our shortest wait */</span>
<a name="l03171"></a>03171             <span class="keywordflow">if</span> (tms &lt; *ms || *ms &lt; 0)
<a name="l03172"></a>03172                *ms = tms;
<a name="l03173"></a>03173          }
<a name="l03174"></a>03174       }
<a name="l03175"></a>03175    }
<a name="l03176"></a>03176    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l03177"></a>03177    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l03178"></a>03178    <span class="keywordflow">return</span> res;
<a name="l03179"></a>03179 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a81ea8c1f888844f3ba5aade3be0bbeba"></a><!-- doxytag: member="features.c::manager_park" ref="a81ea8c1f888844f3ba5aade3be0bbeba" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_park </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create manager event for parked calls. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>m</em>&nbsp;</td><td>Get <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> involved in park, create event. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Always 0 </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04401">4401</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="channel_8c_source.html#l01278">ast_get_channel_by_name_locked()</a>, <a class="el" href="features_8c_source.html#l00894">ast_masq_park_call()</a>, <a class="el" href="channel_8c_source.html#l01666">ast_softhangup()</a>, <a class="el" href="channel_8h_source.html#l00639">AST_SOFTHANGUP_EXPLICIT</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, <a class="el" href="manager_8c_source.html#l01027">astman_send_error()</a>, and <a class="el" href="adsistub_8c_source.html#l00059">buf</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04402"></a>04402 {
<a name="l04403"></a>04403    <span class="keyword">const</span> <span class="keywordtype">char</span> *channel = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Channel&quot;</span>);
<a name="l04404"></a>04404    <span class="keyword">const</span> <span class="keywordtype">char</span> *channel2 = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Channel2&quot;</span>);
<a name="l04405"></a>04405    <span class="keyword">const</span> <span class="keywordtype">char</span> *timeout = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Timeout&quot;</span>);
<a name="l04406"></a>04406    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[BUFSIZ];
<a name="l04407"></a>04407    <span class="keywordtype">int</span> to = 0;
<a name="l04408"></a>04408    <span class="keywordtype">int</span> res = 0;
<a name="l04409"></a>04409    <span class="keywordtype">int</span> parkExt = 0;
<a name="l04410"></a>04410    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ch1, *ch2;
<a name="l04411"></a>04411 
<a name="l04412"></a>04412    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(channel)) {
<a name="l04413"></a>04413       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Channel not specified&quot;</span>);
<a name="l04414"></a>04414       <span class="keywordflow">return</span> 0;
<a name="l04415"></a>04415    }
<a name="l04416"></a>04416 
<a name="l04417"></a>04417    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(channel2)) {
<a name="l04418"></a>04418       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Channel2 not specified&quot;</span>);
<a name="l04419"></a>04419       <span class="keywordflow">return</span> 0;
<a name="l04420"></a>04420    }
<a name="l04421"></a>04421 
<a name="l04422"></a>04422    ch1 = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(channel);
<a name="l04423"></a>04423    <span class="keywordflow">if</span> (!ch1) {
<a name="l04424"></a>04424       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Channel does not exist: %s&quot;</span>, channel);
<a name="l04425"></a>04425       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, buf);
<a name="l04426"></a>04426       <span class="keywordflow">return</span> 0;
<a name="l04427"></a>04427    }
<a name="l04428"></a>04428 
<a name="l04429"></a>04429    ch2 = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(channel2);
<a name="l04430"></a>04430    <span class="keywordflow">if</span> (!ch2) {
<a name="l04431"></a>04431       snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;Channel does not exist: %s&quot;</span>, channel2);
<a name="l04432"></a>04432       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, buf);
<a name="l04433"></a>04433       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(ch1);
<a name="l04434"></a>04434       <span class="keywordflow">return</span> 0;
<a name="l04435"></a>04435    }
<a name="l04436"></a>04436 
<a name="l04437"></a>04437    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(timeout)) {
<a name="l04438"></a>04438       sscanf(timeout, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;to);
<a name="l04439"></a>04439    }
<a name="l04440"></a>04440 
<a name="l04441"></a>04441    res = <a class="code" href="features_8h.html#a70a2de2bf789996ae5e66142294ca18f" title="Park a call via a masqueraded channel.">ast_masq_park_call</a>(ch1, ch2, to, &amp;parkExt);
<a name="l04442"></a>04442    <span class="keywordflow">if</span> (!res) {
<a name="l04443"></a>04443       <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(ch2, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l04444"></a>04444       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Park successful&quot;</span>);
<a name="l04445"></a>04445    } <span class="keywordflow">else</span> {
<a name="l04446"></a>04446       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Park failure&quot;</span>);
<a name="l04447"></a>04447    }
<a name="l04448"></a>04448 
<a name="l04449"></a>04449    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(ch1);
<a name="l04450"></a>04450    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(ch2);
<a name="l04451"></a>04451 
<a name="l04452"></a>04452    <span class="keywordflow">return</span> 0;
<a name="l04453"></a>04453 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae173627ea061ac13a887ad640feac171"></a><!-- doxytag: member="features.c::manager_parking_status" ref="ae173627ea061ac13a887ad640feac171" args="(struct mansession *s, const struct message *m)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int manager_parking_status </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structmansession.html">mansession</a> *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const struct <a class="el" href="structmessage.html">message</a> *&nbsp;</td>
          <td class="paramname"> <em>m</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Dump parking lot status. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>s</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>m</em>&nbsp;</td><td>Lock parking lot, iterate list and append parked calls status, unlock parking lot. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Always RESULT_SUCCESS </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l04340">4340</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8c_source.html#l00780">ao2_iterator_init()</a>, <a class="el" href="astobj2_8h_source.html#l01120">ao2_iterator_next</a>, <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="manager_8c_source.html#l00969">astman_append()</a>, <a class="el" href="manager_8c_source.html#l00897">astman_get_header()</a>, <a class="el" href="manager_8c_source.html#l01032">astman_send_ack()</a>, <a class="el" href="features_8c_source.html#l00200">parkeduser::chan</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00204">ast_callerid::cid_name</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="features_8c_source.html#l00236">parkinglots</a>, <a class="el" href="features_8c_source.html#l00202">parkeduser::parkingnum</a>, <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>, <a class="el" href="features_8c_source.html#l00207">parkeduser::parkingtime</a>, <a class="el" href="features_8c_source.html#l00210">parkeduser::peername</a>, <a class="el" href="cli_8h_source.html#l00039">RESULT_SUCCESS</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, and <a class="el" href="features_8c_source.html#l00201">parkeduser::start</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l04341"></a>04341 {
<a name="l04342"></a>04342    <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *cur;
<a name="l04343"></a>04343    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l04344"></a>04344    <span class="keywordtype">char</span> idText[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04345"></a>04345    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> iter;
<a name="l04346"></a>04346    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *curlot;
<a name="l04347"></a>04347 
<a name="l04348"></a>04348    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l04349"></a>04349       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l04350"></a>04350 
<a name="l04351"></a>04351    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Parked calls will follow&quot;</span>);
<a name="l04352"></a>04352 
<a name="l04353"></a>04353    iter = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, 0);
<a name="l04354"></a>04354    <span class="keywordflow">while</span> ((curlot = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;iter))) {
<a name="l04355"></a>04355 
<a name="l04356"></a>04356       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l04357"></a>04357       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>, cur, list) {
<a name="l04358"></a>04358          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: ParkedCall\r\n&quot;</span>
<a name="l04359"></a>04359             <span class="stringliteral">&quot;Exten: %d\r\n&quot;</span>
<a name="l04360"></a>04360             <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l04361"></a>04361             <span class="stringliteral">&quot;From: %s\r\n&quot;</span>
<a name="l04362"></a>04362             <span class="stringliteral">&quot;Timeout: %ld\r\n&quot;</span>
<a name="l04363"></a>04363             <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l04364"></a>04364             <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l04365"></a>04365             <span class="stringliteral">&quot;%s&quot;</span>
<a name="l04366"></a>04366             <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l04367"></a>04367             cur-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>, cur-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name, cur-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>,
<a name="l04368"></a>04368             (<span class="keywordtype">long</span>) cur-&gt;<a class="code" href="structparkeduser.html#ad80305b5e16da9c2675d5f057bd69386">start</a>.tv_sec + (<span class="keywordtype">long</span>) (cur-&gt;<a class="code" href="structparkeduser.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> / 1000) - (<span class="keywordtype">long</span>) time(NULL),
<a name="l04369"></a>04369             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(cur-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>),   <span class="comment">/* XXX in other places it is &lt;unknown&gt; */</span>
<a name="l04370"></a>04370             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(cur-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>),
<a name="l04371"></a>04371             idText);
<a name="l04372"></a>04372       }
<a name="l04373"></a>04373       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;curlot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l04374"></a>04374       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(curlot, -1);
<a name="l04375"></a>04375    }
<a name="l04376"></a>04376 
<a name="l04377"></a>04377    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l04378"></a>04378       <span class="stringliteral">&quot;Event: ParkedCallsComplete\r\n&quot;</span>
<a name="l04379"></a>04379       <span class="stringliteral">&quot;%s&quot;</span>
<a name="l04380"></a>04380       <span class="stringliteral">&quot;\r\n&quot;</span>,idText);
<a name="l04381"></a>04381 
<a name="l04382"></a>04382 
<a name="l04383"></a>04383    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l04384"></a>04384 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a87a222a1d617d1917126357f27861442"></a><!-- doxytag: member="features.c::masq_park_call" ref="a87a222a1d617d1917126357f27861442" args="(struct ast_channel *rchan, struct ast_channel *peer, int timeout, int *extout, int play_announcement, struct ast_park_call_args *args)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int masq_park_call </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>rchan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>extout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>play_announcement</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *&nbsp;</td>
          <td class="paramname"> <em>args</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00833">833</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00473">ast_channel::amaflags</a>, <a class="el" href="channel_8h_source.html#l00730">ast_channel_alloc</a>, <a class="el" href="channel_8c_source.html#l04217">ast_channel_masquerade()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="features_8h_source.html#l00070">AST_FEATURE_RETURN_PARKFAILED</a>, <a class="el" href="frame_8h_source.html#l00462">ast_frfree</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l03100">ast_read()</a>, <a class="el" href="channel_8h_source.html#l00359">AST_STATE_DOWN</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="features_8c_source.html#l00556">ast_park_call_args::extout</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="channel_8h_source.html#l00505">ast_channel::macrocontext</a>, <a class="el" href="channel_8h_source.html#l00506">ast_channel::macroexten</a>, <a class="el" href="channel_8h_source.html#l00472">ast_channel::macropriority</a>, <a class="el" href="features_8c_source.html#l00557">ast_park_call_args::orig_chan_name</a>, <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>, <a class="el" href="features_8c_source.html#l00566">park_space_reserve()</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="features_8c_source.html#l00563">ast_park_call_args::pu</a>, <a class="el" href="channel_8h_source.html#l00483">ast_channel::readformat</a>, <a class="el" href="features_8c_source.html#l00351">set_c_e_p()</a>, <a class="el" href="features_8c_source.html#l00553">ast_park_call_args::timeout</a>, and <a class="el" href="channel_8h_source.html#l00484">ast_channel::writeformat</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00894">ast_masq_park_call()</a>, <a class="el" href="features_8c_source.html#l00904">masq_park_call_announce()</a>, and <a class="el" href="features_8c_source.html#l00899">masq_park_call_announce_args()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00834"></a>00834 {
<a name="l00835"></a>00835    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00836"></a>00836    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00837"></a>00837    <span class="keywordtype">int</span> park_status;
<a name="l00838"></a>00838    <span class="keyword">struct </span><a class="code" href="structast__park__call__args.html">ast_park_call_args</a> park_args = {0,};
<a name="l00839"></a>00839 
<a name="l00840"></a>00840    <span class="keywordflow">if</span> (!args) {
<a name="l00841"></a>00841       args = &amp;park_args;
<a name="l00842"></a>00842       args-&gt;<a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = <a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>;
<a name="l00843"></a>00843       args-&gt;<a class="code" href="structast__park__call__args.html#a1d7b0cf33a765e5f0f70e0535709fe9e">extout</a> = <a class="code" href="structast__park__call__args.html#a1d7b0cf33a765e5f0f70e0535709fe9e">extout</a>;
<a name="l00844"></a>00844    }
<a name="l00845"></a>00845 
<a name="l00846"></a>00846    <span class="keywordflow">if</span> ((args-&gt;<a class="code" href="structast__park__call__args.html#aaccac398ed78a20f65ba8a16f06bbb6a">pu</a> = <a class="code" href="features_8c.html#acc8e6a5be7f5d697c14627a5119c8199">park_space_reserve</a>(rchan, peer, args)) == NULL) {
<a name="l00847"></a>00847       <span class="keywordflow">if</span> (peer)
<a name="l00848"></a>00848          <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(peer, <span class="stringliteral">&quot;beeperr&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00849"></a>00849       <span class="keywordflow">return</span> <a class="code" href="features_8h.html#a67087b9e4e17fecd92350e2b5cfcb493">AST_FEATURE_RETURN_PARKFAILED</a>;
<a name="l00850"></a>00850    }
<a name="l00851"></a>00851 
<a name="l00852"></a>00852    <span class="comment">/* Make a new, fake channel that we&apos;ll use to masquerade in the real one */</span>
<a name="l00853"></a>00853    <span class="keywordflow">if</span> (!(chan = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, rchan-&gt;accountcode, rchan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, rchan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, rchan-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>, <span class="stringliteral">&quot;Parked/%s&quot;</span>,rchan-&gt;name))) {
<a name="l00854"></a>00854       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create parked channel\n&quot;</span>);
<a name="l00855"></a>00855       <span class="keywordflow">return</span> -1;
<a name="l00856"></a>00856    }
<a name="l00857"></a>00857 
<a name="l00858"></a>00858    <span class="comment">/* Make formats okay */</span>
<a name="l00859"></a>00859    chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = rchan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l00860"></a>00860    chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = rchan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l00861"></a>00861    <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(chan, rchan);
<a name="l00862"></a>00862 
<a name="l00863"></a>00863    <span class="comment">/* Setup the extensions and such */</span>
<a name="l00864"></a>00864    <a class="code" href="features_8c.html#aa1863982006a2c87e09556807d2d4a7c" title="store context, extension and priority">set_c_e_p</a>(chan, rchan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, rchan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, rchan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l00865"></a>00865 
<a name="l00866"></a>00866    <span class="comment">/* Setup the macro extension and such */</span>
<a name="l00867"></a>00867    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>,rchan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>,<span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>));
<a name="l00868"></a>00868    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a582cff3075953f73ba96888167acf009">macroexten</a>,rchan-&gt;<a class="code" href="structast__channel.html#a582cff3075953f73ba96888167acf009">macroexten</a>,<span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a582cff3075953f73ba96888167acf009">macroexten</a>));
<a name="l00869"></a>00869    chan-&gt;<a class="code" href="structast__channel.html#a2e8aa27b1152794b273b6edb5fa7412a">macropriority</a> = rchan-&gt;<a class="code" href="structast__channel.html#a2e8aa27b1152794b273b6edb5fa7412a">macropriority</a>;
<a name="l00870"></a>00870 
<a name="l00871"></a>00871    <span class="comment">/* Make the masq execute */</span>
<a name="l00872"></a>00872    <span class="keywordflow">if</span> ((f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan)))
<a name="l00873"></a>00873       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00874"></a>00874 
<a name="l00875"></a>00875    <span class="keywordflow">if</span> (peer == rchan) {
<a name="l00876"></a>00876       peer = chan;
<a name="l00877"></a>00877    }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879    <span class="keywordflow">if</span> (peer &amp;&amp; (!play_announcement &amp;&amp; args == &amp;park_args)) {
<a name="l00880"></a>00880       args-&gt;<a class="code" href="structast__park__call__args.html#af13f43273e8909807d7a2f990a1ca03b">orig_chan_name</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(peer-&gt;name);
<a name="l00881"></a>00881    }
<a name="l00882"></a>00882 
<a name="l00883"></a>00883    park_status = <a class="code" href="features_8c.html#af750802cffe6ab46e36412a8a47a68e2">park_call_full</a>(chan, peer, args);
<a name="l00884"></a>00884    <span class="keywordflow">if</span> (park_status == 1) {
<a name="l00885"></a>00885    <span class="comment">/* would be nice to play &quot;invalid parking extension&quot; */</span>
<a name="l00886"></a>00886       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan);
<a name="l00887"></a>00887       <span class="keywordflow">return</span> -1;
<a name="l00888"></a>00888    }
<a name="l00889"></a>00889 
<a name="l00890"></a>00890    <span class="keywordflow">return</span> 0;
<a name="l00891"></a>00891 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6969031880bd3d320cec5f1f89c83325"></a><!-- doxytag: member="features.c::masq_park_call_announce" ref="a6969031880bd3d320cec5f1f89c83325" args="(struct ast_channel *rchan, struct ast_channel *peer, int timeout, int *extout)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int masq_park_call_announce </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>rchan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>timeout</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int *&nbsp;</td>
          <td class="paramname"> <em>extout</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00904">904</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00833">masq_park_call()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>, and <a class="el" href="features_8c_source.html#l00942">builtin_parkcall()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00905"></a>00905 {
<a name="l00906"></a>00906    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#a87a222a1d617d1917126357f27861442">masq_park_call</a>(rchan, peer, <a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>, <a class="code" href="structast__park__call__args.html#a1d7b0cf33a765e5f0f70e0535709fe9e">extout</a>, 1, NULL);
<a name="l00907"></a>00907 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac9a6ee321a8ce8cb17bc81306f401844"></a><!-- doxytag: member="features.c::masq_park_call_announce_args" ref="ac9a6ee321a8ce8cb17bc81306f401844" args="(struct ast_channel *rchan, struct ast_channel *peer, struct ast_park_call_args *args)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int masq_park_call_announce_args </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>rchan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *&nbsp;</td>
          <td class="paramname"> <em>args</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00899">899</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00833">masq_park_call()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03249">park_call_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00900"></a>00900 {
<a name="l00901"></a>00901    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#a87a222a1d617d1917126357f27861442">masq_park_call</a>(rchan, peer, 0, NULL, 1, args);
<a name="l00902"></a>00902 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a803092f58ccdc8d7562ed7c5f2151380"></a><!-- doxytag: member="features.c::metermaidstate" ref="a803092f58ccdc8d7562ed7c5f2151380" args="(const char *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static enum <a class="el" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee">ast_device_state</a> metermaidstate </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>metermaids callback from <a class="el" href="devicestate_8c.html" title="Device state management.">devicestate.c</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00519">519</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="devicestate_8h_source.html#l00054">AST_DEVICE_INUSE</a>, <a class="el" href="devicestate_8h_source.html#l00056">AST_DEVICE_INVALID</a>, <a class="el" href="devicestate_8h_source.html#l00053">AST_DEVICE_NOT_INUSE</a>, <a class="el" href="pbx_8c_source.html#l04143">ast_exists_extension()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00520"></a>00520 {
<a name="l00521"></a>00521    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l00522"></a>00522    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>;
<a name="l00523"></a>00523 
<a name="l00524"></a>00524    context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526    exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l00527"></a>00527    <span class="keywordflow">if</span> (!context)
<a name="l00528"></a>00528       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l00529"></a>00529    
<a name="l00530"></a>00530    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Checking state of exten %s in context %s\n&quot;</span>, exten, context);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, context, exten, 1, NULL))
<a name="l00533"></a>00533       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>;
<a name="l00534"></a>00534 
<a name="l00535"></a>00535    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l00536"></a>00536 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5eed24a00b3ff396ca4135f2cacf76f9"></a><!-- doxytag: member="features.c::notify_metermaids" ref="a5eed24a00b3ff396ca4135f2cacf76f9" args="(const char *exten, char *context, enum ast_device_state state)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void notify_metermaids </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">enum <a class="el" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee">ast_device_state</a>&nbsp;</td>
          <td class="paramname"> <em>state</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Notify metermaids that we've changed an <a class="el" href="structextension.html">extension</a>. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00510">510</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="devicestate_8c_source.html#l00209">ast_devstate2str()</a>, and <a class="el" href="devicestate_8c_source.html#l00508">ast_devstate_changed()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>, <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>, <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>, and <a class="el" href="features_8c_source.html#l03335">park_exec_full()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00511"></a>00511 {
<a name="l00512"></a>00512    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Notification of state change to metermaids %s@%s\n to state &apos;%s&apos;&quot;</span>, 
<a name="l00513"></a>00513       <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="devicestate_8h.html#ac3a57910a6eb04d12d793fe3df796b8e" title="Find devicestate as text message for output.">ast_devstate2str</a>(<a class="code" href="structstate.html">state</a>));
<a name="l00514"></a>00514 
<a name="l00515"></a>00515    <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="structstate.html">state</a>, <span class="stringliteral">&quot;park:%s@%s&quot;</span>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l00516"></a>00516 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa3b3766aea99a4ace3b34a21c9d73624"></a><!-- doxytag: member="features.c::park_add_hints" ref="aa3b3766aea99a4ace3b34a21c9d73624" args="(char *context, int start, int stop)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void park_add_hints </td>
          <td>(</td>
          <td class="paramtype">char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>start</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>stop</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add parking <a class="el" href="structhints.html">hints</a> for all defined parking lots. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>context</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>start</em>&nbsp;</td><td>starting parkinglot <a class="el" href="structnumber.html" title="Number structure.">number</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>stop</em>&nbsp;</td><td>ending parkinglot <a class="el" href="structnumber.html" title="Number structure.">number</a> </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l03659">3659</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l07305">ast_add_extension()</a>, <a class="el" href="pbx_8h_source.html#l00049">PRIORITY_HINT</a>, and <a class="el" href="features_8c_source.html#l00259">registrar</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03660"></a>03660 {
<a name="l03661"></a>03661    <span class="keywordtype">int</span> numext;
<a name="l03662"></a>03662    <span class="keywordtype">char</span> device[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l03663"></a>03663    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[10];
<a name="l03664"></a>03664 
<a name="l03665"></a>03665    <span class="keywordflow">for</span> (numext = start; numext &lt;= <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>; numext++) {
<a name="l03666"></a>03666       snprintf(exten, <span class="keyword">sizeof</span>(exten), <span class="stringliteral">&quot;%d&quot;</span>, numext);
<a name="l03667"></a>03667       snprintf(device, <span class="keyword">sizeof</span>(device), <span class="stringliteral">&quot;park:%s@%s&quot;</span>, exten, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l03668"></a>03668       <a class="code" href="pbx_8h.html#a07176e8d314eb68b3b50279fafa11390" title="Add and extension to an extension context.">ast_add_extension</a>(<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 1, exten, <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>, NULL, NULL, device, NULL, NULL, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l03669"></a>03669    }
<a name="l03670"></a>03670 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2cec676e4ea8d8e13b3852e97fc28552"></a><!-- doxytag: member="features.c::park_call_exec" ref="a2cec676e4ea8d8e13b3852e97fc28552" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int park_call_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Park a call. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03249">3249</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="app_8h_source.html#l00338">AST_APP_ARG</a>, <a class="el" href="app_8c_source.html#l01776">ast_app_parse_options()</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="app_8h_source.html#l00355">AST_DECLARE_APP_ARGS</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="channel_8c_source.html#l01367">ast_safe_sleep()</a>, <a class="el" href="app_8h_source.html#l00387">AST_STANDARD_APP_ARGS</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="utils_8h_source.html#l00199">ast_flags::flags</a>, <a class="el" href="features_8c_source.html#l00561">ast_park_call_args::flags</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00899">masq_park_call_announce_args()</a>, <a class="el" href="features_8c_source.html#l00557">ast_park_call_args::orig_chan_name</a>, <a class="el" href="res__clioriginate_8c_source.html#l00080">orig_exten()</a>, <a class="el" href="features_8c_source.html#l03246">park_call_options</a>, <a class="el" href="chan__mgcp_8c_source.html#l01737">parse()</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="features_8c_source.html#l00558">ast_park_call_args::return_con</a>, <a class="el" href="features_8c_source.html#l00559">ast_park_call_args::return_ext</a>, <a class="el" href="features_8c_source.html#l00560">ast_park_call_args::return_pri</a>, and <a class="el" href="features_8c_source.html#l00553">ast_park_call_args::timeout</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03250"></a>03250 {
<a name="l03251"></a>03251    <span class="comment">/* Cache the original channel name in case we get masqueraded in the middle</span>
<a name="l03252"></a>03252 <span class="comment">    * of a park--it is still theoretically possible for a transfer to happen before</span>
<a name="l03253"></a>03253 <span class="comment">    * we get here, but it is _really_ unlikely */</span>
<a name="l03254"></a>03254    <span class="keywordtype">char</span> *<a class="code" href="structast__park__call__args.html#af13f43273e8909807d7a2f990a1ca03b">orig_chan_name</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;name);
<a name="l03255"></a>03255    <span class="keywordtype">char</span> <a class="code" href="res__clioriginate_8c.html#a2bc6249fad4d4be874fb52cb420b6106" title="orginate from extension">orig_exten</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l03256"></a>03256    <span class="keywordtype">int</span> orig_priority = chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l03257"></a>03257 
<a name="l03258"></a>03258    <span class="comment">/* Data is unused at the moment but could contain a parking</span>
<a name="l03259"></a>03259 <span class="comment">      lot context eventually */</span>
<a name="l03260"></a>03260    <span class="keywordtype">int</span> res = 0;
<a name="l03261"></a>03261 
<a name="l03262"></a>03262    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a> = NULL;
<a name="l03263"></a>03263    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(app_args,
<a name="l03264"></a>03264       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>);
<a name="l03265"></a>03265       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__park__call__args.html#a21ff6b53a59adea20ad0883e0bc5c580">return_con</a>);
<a name="l03266"></a>03266       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__park__call__args.html#a1ec7ffd61605c18230a4ffaa7c517363">return_ext</a>);
<a name="l03267"></a>03267       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__park__call__args.html#ab84e83466457537d7a9f5cd116e2d219">return_pri</a>);
<a name="l03268"></a>03268       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l03269"></a>03269    );
<a name="l03270"></a>03270 
<a name="l03271"></a>03271    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l03272"></a>03272    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(app_args, parse);
<a name="l03273"></a>03273 
<a name="l03274"></a>03274    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(orig_exten, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(orig_exten));
<a name="l03275"></a>03275 
<a name="l03276"></a>03276    <span class="comment">/* Setup the exten/priority to be s/1 since we don&apos;t know</span>
<a name="l03277"></a>03277 <span class="comment">      where this call should return */</span>
<a name="l03278"></a>03278    strcpy(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;s&quot;</span>);
<a name="l03279"></a>03279    chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 1;
<a name="l03280"></a>03280 
<a name="l03281"></a>03281    <span class="comment">/* Answer if call is not up */</span>
<a name="l03282"></a>03282    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l03283"></a>03283       res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l03284"></a>03284 
<a name="l03285"></a>03285    <span class="comment">/* Sleep to allow VoIP streams to settle down */</span>
<a name="l03286"></a>03286    <span class="keywordflow">if</span> (!res)
<a name="l03287"></a>03287       res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 1000);
<a name="l03288"></a>03288 
<a name="l03289"></a>03289    <span class="comment">/* Park the call */</span>
<a name="l03290"></a>03290    <span class="keywordflow">if</span> (!res) {
<a name="l03291"></a>03291       <span class="keyword">struct </span><a class="code" href="structast__park__call__args.html">ast_park_call_args</a> args = {
<a name="l03292"></a>03292          .orig_chan_name = orig_chan_name,
<a name="l03293"></a>03293       };
<a name="l03294"></a>03294       <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a> = { 0 };
<a name="l03295"></a>03295 
<a name="l03296"></a>03296       <span class="keywordflow">if</span> (parse) {
<a name="l03297"></a>03297          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(app_args.timeout)) {
<a name="l03298"></a>03298             <span class="keywordflow">if</span> (sscanf(app_args.timeout, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;args.<a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>) != 1) {
<a name="l03299"></a>03299                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid timeout &apos;%s&apos; provided\n&quot;</span>, app_args.timeout);
<a name="l03300"></a>03300                args.<a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = 0;
<a name="l03301"></a>03301             }
<a name="l03302"></a>03302          }
<a name="l03303"></a>03303          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(app_args.return_con)) {
<a name="l03304"></a>03304             args.<a class="code" href="structast__park__call__args.html#a21ff6b53a59adea20ad0883e0bc5c580">return_con</a> = app_args.return_con;
<a name="l03305"></a>03305          }
<a name="l03306"></a>03306          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(app_args.return_ext)) {
<a name="l03307"></a>03307             args.<a class="code" href="structast__park__call__args.html#a1ec7ffd61605c18230a4ffaa7c517363">return_ext</a> = app_args.return_ext;
<a name="l03308"></a>03308          }
<a name="l03309"></a>03309          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(app_args.return_pri)) {
<a name="l03310"></a>03310             <span class="keywordflow">if</span> (sscanf(app_args.return_pri, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;args.<a class="code" href="structast__park__call__args.html#ab84e83466457537d7a9f5cd116e2d219">return_pri</a>) != 1) {
<a name="l03311"></a>03311                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid priority &apos;%s&apos; specified\n&quot;</span>, app_args.return_pri);
<a name="l03312"></a>03312                args.<a class="code" href="structast__park__call__args.html#ab84e83466457537d7a9f5cd116e2d219">return_pri</a> = 0;
<a name="l03313"></a>03313             }
<a name="l03314"></a>03314          }
<a name="l03315"></a>03315       }
<a name="l03316"></a>03316 
<a name="l03317"></a>03317       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(<a class="code" href="features_8c.html#a9e1a57d86c3bd004f9a9a32f90cfb1f5">park_call_options</a>, &amp;flags, NULL, app_args.options);
<a name="l03318"></a>03318       args.<a class="code" href="structast__park__call__args.html#a773b39d480759f67926cb18ae2219281">flags</a> = flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l03319"></a>03319 
<a name="l03320"></a>03320       res = <a class="code" href="features_8c.html#ac9a6ee321a8ce8cb17bc81306f401844">masq_park_call_announce_args</a>(chan, chan, &amp;args);
<a name="l03321"></a>03321       <span class="comment">/* Continue on in the dialplan */</span>
<a name="l03322"></a>03322       <span class="keywordflow">if</span> (res == 1) {
<a name="l03323"></a>03323          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, orig_exten, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l03324"></a>03324          chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = orig_priority;
<a name="l03325"></a>03325          res = 0;
<a name="l03326"></a>03326       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l03327"></a>03327          res = 1;
<a name="l03328"></a>03328       }
<a name="l03329"></a>03329    }
<a name="l03330"></a>03330 
<a name="l03331"></a>03331    <span class="keywordflow">return</span> res;
<a name="l03332"></a>03332 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af750802cffe6ab46e36412a8a47a68e2"></a><!-- doxytag: member="features.c::park_call_full" ref="af750802cffe6ab46e36412a8a47a68e2" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_park_call_args *args)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int park_call_full </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *&nbsp;</td>
          <td class="paramname"> <em>args</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00678">678</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00477">adsi_announce_park()</a>, <a class="el" href="features_8c_source.html#l00248">adsipark</a>, <a class="el" href="channel_8h_source.html#l00411">ast_channel::appl</a>, <a class="el" href="pbx_8c_source.html#l07624">ast_add_extension2()</a>, <a class="el" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3">ast_adsi_available</a>, <a class="el" href="adsi_8h.html#aa65291a80a241bda57a53d4f26ec5bed">ast_adsi_unload_session</a>, <a class="el" href="channel_8c_source.html#l04733">ast_bridged_channel()</a>, <a class="el" href="channel_8h_source.html#l00136">AST_CHANNEL_NAME</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="pbx_8c_source.html#l06424">ast_context_find_or_create()</a>, <a class="el" href="frame_8h_source.html#l00313">AST_CONTROL_HOLD</a>, <a class="el" href="frame_8h_source.html#l00300">AST_CONTROL_RINGING</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="devicestate_8h_source.html#l00054">AST_DEVICE_INUSE</a>, <a class="el" href="channel_8h_source.html#l00557">AST_FLAG_MASQ_NOSTREAM</a>, <a class="el" href="utils_8h_source.html#l00415">ast_free_ptr()</a>, <a class="el" href="channel_8c_source.html#l01278">ast_get_channel_by_name_locked()</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="channel_8c_source.html#l03150">ast_indicate_data()</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="features_8c_source.html#l00541">AST_PARK_OPT_RINGING</a>, <a class="el" href="features_8c_source.html#l00546">AST_PARK_OPT_SILENCE</a>, <a class="el" href="channel_8c_source.html#l05827">ast_say_digits()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="time_8h_source.html#l00141">ast_tvnow()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="features_8c_source.html#l00200">parkeduser::chan</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00204">ast_callerid::cid_name</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="features_8c_source.html#l00204">parkeduser::context</a>, <a class="el" href="channel_8h_source.html#l00412">ast_channel::data</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, <a class="el" href="features_8c_source.html#l00205">parkeduser::exten</a>, <a class="el" href="features_8c_source.html#l00556">ast_park_call_args::extout</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="channel_8h_source.html#l00505">ast_channel::macrocontext</a>, <a class="el" href="channel_8h_source.html#l00506">ast_channel::macroexten</a>, <a class="el" href="channel_8h_source.html#l00472">ast_channel::macropriority</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="features_8c_source.html#l00226">ast_parkinglot::mohclass</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l00510">notify_metermaids()</a>, <a class="el" href="features_8c_source.html#l00208">parkeduser::notquiteyet</a>, <a class="el" href="features_8c_source.html#l00209">parkeduser::options_specified</a>, <a class="el" href="features_8c_source.html#l00557">ast_park_call_args::orig_chan_name</a>, <a class="el" href="features_8c_source.html#l00566">park_space_reserve()</a>, <a class="el" href="features_8c_source.html#l00192">parkedcall</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00273">parking_thread</a>, <a class="el" href="features_8c_source.html#l00203">parkeduser::parkingexten</a>, <a class="el" href="features_8c_source.html#l00212">parkeduser::parkinglot</a>, <a class="el" href="features_8c_source.html#l00202">parkeduser::parkingnum</a>, <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>, <a class="el" href="features_8c_source.html#l00225">ast_parkinglot::parkingtime</a>, <a class="el" href="features_8c_source.html#l00207">parkeduser::parkingtime</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="features_8c_source.html#l00210">parkeduser::peername</a>, <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>, <a class="el" href="features_8c_source.html#l00206">parkeduser::priority</a>, <a class="el" href="features_8c_source.html#l00563">ast_park_call_args::pu</a>, <a class="el" href="features_8c_source.html#l00259">registrar</a>, <a class="el" href="features_8c_source.html#l00558">ast_park_call_args::return_con</a>, <a class="el" href="features_8c_source.html#l00559">ast_park_call_args::return_ext</a>, <a class="el" href="features_8c_source.html#l00560">ast_park_call_args::return_pri</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, <a class="el" href="features_8c_source.html#l00201">parkeduser::start</a>, <a class="el" href="channel_8h_source.html#l00400">ast_channel::tech</a>, <a class="el" href="features_8c_source.html#l00553">ast_park_call_args::timeout</a>, and <a class="el" href="channel_8h_source.html#l00226">ast_channel_tech::type</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00823">ast_park_call()</a>, and <a class="el" href="features_8c_source.html#l00833">masq_park_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00679"></a>00679 {
<a name="l00680"></a>00680    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l00681"></a>00681    <span class="keywordtype">int</span> parkingnum_copy;
<a name="l00682"></a>00682    <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *pu = args-&gt;<a class="code" href="structast__park__call__args.html#aaccac398ed78a20f65ba8a16f06bbb6a">pu</a>;
<a name="l00683"></a>00683    <span class="keyword">const</span> <span class="keywordtype">char</span> *event_from;
<a name="l00684"></a>00684 
<a name="l00685"></a>00685    <span class="keywordflow">if</span> (pu == NULL)
<a name="l00686"></a>00686       pu = <a class="code" href="features_8c.html#acc8e6a5be7f5d697c14627a5119c8199">park_space_reserve</a>(chan, peer, args);
<a name="l00687"></a>00687    <span class="keywordflow">if</span> (pu == NULL)
<a name="l00688"></a>00688       <span class="keywordflow">return</span> 1; <span class="comment">/* Continue execution if possible */</span>
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    snprintf(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>), <span class="stringliteral">&quot;%d&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>);
<a name="l00691"></a>00691    
<a name="l00692"></a>00692    chan-&gt;<a class="code" href="structast__channel.html#a1fe656155481623fac9882b1f79bc5a3">appl</a> = <span class="stringliteral">&quot;Parked Call&quot;</span>;
<a name="l00693"></a>00693    chan-&gt;<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a> = NULL; 
<a name="l00694"></a>00694 
<a name="l00695"></a>00695    pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a> = chan;
<a name="l00696"></a>00696    
<a name="l00697"></a>00697    <span class="comment">/* Put the parked channel on hold if we have two different channels */</span>
<a name="l00698"></a>00698    <span class="keywordflow">if</span> (chan != peer) {
<a name="l00699"></a>00699       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(args, <a class="code" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192aad150ef49f09c891744a4bba555826c4">AST_PARK_OPT_RINGING</a>)) {
<a name="l00700"></a>00700          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l00701"></a>00701       } <span class="keywordflow">else</span> {
<a name="l00702"></a>00702          <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, 
<a name="l00703"></a>00703             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>, NULL),
<a name="l00704"></a>00704             !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>) ? strlen(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>) + 1 : 0);
<a name="l00705"></a>00705       }
<a name="l00706"></a>00706    }
<a name="l00707"></a>00707    
<a name="l00708"></a>00708    pu-&gt;<a class="code" href="structparkeduser.html#ad80305b5e16da9c2675d5f057bd69386">start</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00709"></a>00709    pu-&gt;<a class="code" href="structparkeduser.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a> = (args-&gt;<a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> &gt; 0) ? args-&gt;<a class="code" href="structast__park__call__args.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> : pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a>;
<a name="l00710"></a>00710    parkingnum_copy = pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>;
<a name="l00711"></a>00711    if (args-&gt;<a class="code" href="structast__park__call__args.html#a1d7b0cf33a765e5f0f70e0535709fe9e">extout</a>)
<a name="l00712"></a>00712       *(args-&gt;<a class="code" href="structast__park__call__args.html#a1d7b0cf33a765e5f0f70e0535709fe9e">extout</a>) = pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>;
<a name="l00713"></a>00713 
<a name="l00714"></a>00714    if (peer) { 
<a name="l00715"></a>00715       <span class="comment">/* This is so ugly that it hurts, but implementing get_base_channel() on local channels</span>
<a name="l00716"></a>00716 <span class="comment">         could have ugly side effects.  We could have transferer&lt;-&gt;local,1&lt;-&gt;local,2&lt;-&gt;parking</span>
<a name="l00717"></a>00717 <span class="comment">         and we need the callback name to be that of transferer.  Since local,1/2 have the same</span>
<a name="l00718"></a>00718 <span class="comment">         name we can be tricky and just grab the bridged channel from the other side of the local</span>
<a name="l00719"></a>00719 <span class="comment">      */</span>
<a name="l00720"></a>00720       <span class="keywordflow">if</span> (!strcasecmp(peer-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, <span class="stringliteral">&quot;Local&quot;</span>)) {
<a name="l00721"></a>00721          <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmpchan, *base_peer;
<a name="l00722"></a>00722          <span class="keywordtype">char</span> other_side[<a class="code" href="channel_8h.html#ab57c278099ea5f8d7cedbb41eba58b56">AST_CHANNEL_NAME</a>];
<a name="l00723"></a>00723          <span class="keywordtype">char</span> *c;
<a name="l00724"></a>00724          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(other_side, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args-&gt;<a class="code" href="structast__park__call__args.html#af13f43273e8909807d7a2f990a1ca03b">orig_chan_name</a>, peer-&gt;name), <span class="keyword">sizeof</span>(other_side));
<a name="l00725"></a>00725          <span class="keywordflow">if</span> ((c = strrchr(other_side, <span class="charliteral">&apos;;&apos;</span>))) {
<a name="l00726"></a>00726             *++c = <span class="charliteral">&apos;1&apos;</span>;
<a name="l00727"></a>00727          }
<a name="l00728"></a>00728          <span class="keywordflow">if</span> ((tmpchan = <a class="code" href="channel_8h.html#a03e8287876c59ddc00f5567064b2b9ca" title="Get channel by name or uniqueid (locks channel).">ast_get_channel_by_name_locked</a>(other_side))) {
<a name="l00729"></a>00729             <span class="keywordflow">if</span> ((base_peer = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(tmpchan))) {
<a name="l00730"></a>00730                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pu-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>, base_peer-&gt;name, <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>));
<a name="l00731"></a>00731             }
<a name="l00732"></a>00732             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(tmpchan);
<a name="l00733"></a>00733          }
<a name="l00734"></a>00734       } <span class="keywordflow">else</span> {
<a name="l00735"></a>00735          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pu-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args-&gt;<a class="code" href="structast__park__call__args.html#af13f43273e8909807d7a2f990a1ca03b">orig_chan_name</a>, peer-&gt;name), <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a1bb03a349da937011c99395f0e4946ed">peername</a>));
<a name="l00736"></a>00736       }
<a name="l00737"></a>00737    }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739    <span class="comment">/* Remember what had been dialed, so that if the parking</span>
<a name="l00740"></a>00740 <span class="comment">      expires, we try to come back to the same place */</span>
<a name="l00741"></a>00741 
<a name="l00742"></a>00742    pu-&gt;<a class="code" href="structparkeduser.html#a8d4a181d04b1fc1448ca0d48047a4e27">options_specified</a> = (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args-&gt;<a class="code" href="structast__park__call__args.html#a21ff6b53a59adea20ad0883e0bc5c580">return_con</a>) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args-&gt;<a class="code" href="structast__park__call__args.html#a1ec7ffd61605c18230a4ffaa7c517363">return_ext</a>) || args-&gt;<a class="code" href="structast__park__call__args.html#ab84e83466457537d7a9f5cd116e2d219">return_pri</a>);
<a name="l00743"></a>00743 
<a name="l00744"></a>00744    <span class="comment">/* If extension has options specified, they override all other possibilities</span>
<a name="l00745"></a>00745 <span class="comment">   such as the returntoorigin flag and transferred context. Information on</span>
<a name="l00746"></a>00746 <span class="comment">   extension options is lost here, so we set a flag */</span>
<a name="l00747"></a>00747 
<a name="l00748"></a>00748    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pu-&gt;<a class="code" href="structparkeduser.html#a8c707bb4b898891a7ce41bf1a69f3b66">context</a>, 
<a name="l00749"></a>00749       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args-&gt;<a class="code" href="structast__park__call__args.html#a21ff6b53a59adea20ad0883e0bc5c580">return_con</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)), 
<a name="l00750"></a>00750       <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a8c707bb4b898891a7ce41bf1a69f3b66">context</a>));
<a name="l00751"></a>00751    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pu-&gt;<a class="code" href="structparkeduser.html#a5bdbf4e9d824b371840d552d602f1384">exten</a>, 
<a name="l00752"></a>00752       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args-&gt;<a class="code" href="structast__park__call__args.html#a1ec7ffd61605c18230a4ffaa7c517363">return_ext</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#a582cff3075953f73ba96888167acf009">macroexten</a>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>)), 
<a name="l00753"></a>00753       <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a5bdbf4e9d824b371840d552d602f1384">exten</a>));
<a name="l00754"></a>00754    pu-&gt;<a class="code" href="structparkeduser.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = args-&gt;<a class="code" href="structast__park__call__args.html#ab84e83466457537d7a9f5cd116e2d219">return_pri</a> ? args-&gt;<a class="code" href="structast__park__call__args.html#ab84e83466457537d7a9f5cd116e2d219">return_pri</a> : 
<a name="l00755"></a>00755       (chan-&gt;<a class="code" href="structast__channel.html#a2e8aa27b1152794b273b6edb5fa7412a">macropriority</a> ? chan-&gt;<a class="code" href="structast__channel.html#a2e8aa27b1152794b273b6edb5fa7412a">macropriority</a> : chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    <span class="comment">/* If parking a channel directly, don&apos;t quiet yet get parking running on it.</span>
<a name="l00758"></a>00758 <span class="comment">    * All parking lot entries are put into the parking lot with notquiteyet on. */</span>
<a name="l00759"></a>00759    <span class="keywordflow">if</span> (peer != chan) 
<a name="l00760"></a>00760       pu-&gt;<a class="code" href="structparkeduser.html#aeaf3504d3f44186d5fcfaced55711751">notquiteyet</a> = 0;
<a name="l00761"></a>00761 
<a name="l00762"></a>00762    <span class="comment">/* Wake up the (presumably select()ing) thread */</span>
<a name="l00763"></a>00763    pthread_kill(<a class="code" href="features_8c.html#ac66fb87ae86fa37b36fa78286c237fd2">parking_thread</a>, SIGURG);
<a name="l00764"></a>00764    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Parked %s on %d (lot %s). Will timeout back to extension [%s] %s, %d in %d seconds\n&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name, pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, pu-&gt;<a class="code" href="structparkeduser.html#a8c707bb4b898891a7ce41bf1a69f3b66">context</a>, pu-&gt;<a class="code" href="structparkeduser.html#a5bdbf4e9d824b371840d552d602f1384">exten</a>, pu-&gt;<a class="code" href="structparkeduser.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, (pu-&gt;<a class="code" href="structparkeduser.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a>/1000));
<a name="l00765"></a>00765 
<a name="l00766"></a>00766    <span class="keywordflow">if</span> (peer) {
<a name="l00767"></a>00767       event_from = peer-&gt;name;
<a name="l00768"></a>00768    } <span class="keywordflow">else</span> {
<a name="l00769"></a>00769       event_from = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;BLINDTRANSFER&quot;</span>);
<a name="l00770"></a>00770    }
<a name="l00771"></a>00771 
<a name="l00772"></a>00772    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;ParkedCall&quot;</span>,
<a name="l00773"></a>00773       <span class="stringliteral">&quot;Exten: %s\r\n&quot;</span>
<a name="l00774"></a>00774       <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l00775"></a>00775       <span class="stringliteral">&quot;Parkinglot: %s\r\n&quot;</span>
<a name="l00776"></a>00776       <span class="stringliteral">&quot;From: %s\r\n&quot;</span>
<a name="l00777"></a>00777       <span class="stringliteral">&quot;Timeout: %ld\r\n&quot;</span>
<a name="l00778"></a>00778       <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l00779"></a>00779       <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l00780"></a>00780       <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l00781"></a>00781       pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, event_from ? event_from : <span class="stringliteral">&quot;&quot;</span>,
<a name="l00782"></a>00782       (<span class="keywordtype">long</span>)pu-&gt;<a class="code" href="structparkeduser.html#ad80305b5e16da9c2675d5f057bd69386">start</a>.tv_sec + (<span class="keywordtype">long</span>)(pu-&gt;<a class="code" href="structparkeduser.html#a5e349d2f1f232365d3795e872324c657">parkingtime</a>/1000) - (<span class="keywordtype">long</span>)time(NULL),
<a name="l00783"></a>00783       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l00784"></a>00784       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l00785"></a>00785       pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;uniqueid
<a name="l00786"></a>00786       );
<a name="l00787"></a>00787 
<a name="l00788"></a>00788    <span class="keywordflow">if</span> (peer &amp;&amp; <a class="code" href="features_8c.html#a644feb4e8d3f7dcd077c7c7321af8d5a">adsipark</a> &amp;&amp; <a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(peer)) {
<a name="l00789"></a>00789       <a class="code" href="features_8c.html#a64c01948390e5eca145537b88f268e07" title="Announce call parking by ADSI.">adsi_announce_park</a>(peer, pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>);  <span class="comment">/* Only supports parking numbers */</span>
<a name="l00790"></a>00790       <a class="code" href="adsi_8h.html#aa65291a80a241bda57a53d4f26ec5bed">ast_adsi_unload_session</a>(peer);
<a name="l00791"></a>00791    }
<a name="l00792"></a>00792 
<a name="l00793"></a>00793    con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l00794"></a>00794    <span class="keywordflow">if</span> (!con)   <span class="comment">/* Still no context? Bad */</span>
<a name="l00795"></a>00795       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Parking context &apos;%s&apos; does not exist and unable to create\n&quot;</span>, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l00796"></a>00796    <span class="keywordflow">if</span> (con) {
<a name="l00797"></a>00797       <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(con, 1, pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, 1, NULL, NULL, <a class="code" href="features_8c.html#a45fde2767ab498a74ee0edc3fa3c3dbf">parkedcall</a>, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>))
<a name="l00798"></a>00798          <a class="code" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9" title="Notify metermaids that we&amp;#39;ve changed an extension.">notify_metermaids</a>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>);
<a name="l00799"></a>00799    }
<a name="l00800"></a>00800 
<a name="l00801"></a>00801    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803    <span class="comment">/* Only say number if it&apos;s a number and the channel hasn&apos;t been masqueraded away */</span>
<a name="l00804"></a>00804    <span class="keywordflow">if</span> (peer &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(args, <a class="code" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192aedb9a35d7618aace9b019defbe50be6f">AST_PARK_OPT_SILENCE</a>) &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args-&gt;<a class="code" href="structast__park__call__args.html#af13f43273e8909807d7a2f990a1ca03b">orig_chan_name</a>) || !strcasecmp(peer-&gt;name, args-&gt;<a class="code" href="structast__park__call__args.html#af13f43273e8909807d7a2f990a1ca03b">orig_chan_name</a>))) {
<a name="l00805"></a>00805       <span class="comment">/* If a channel is masqueraded into peer while playing back the parking slot number do not continue playing it back. This is the case if an attended transfer occurs. */</span>
<a name="l00806"></a>00806       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a44e6b334058bf9555fd4b834ad532046">AST_FLAG_MASQ_NOSTREAM</a>);
<a name="l00807"></a>00807       <span class="comment">/* Tell the peer channel the number of the parking space */</span>
<a name="l00808"></a>00808       <a class="code" href="say_8h.html#a7cf9dcf6ae6fcedb7752d0deac683b3b" title="says digits">ast_say_digits</a>(peer, pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a>, <span class="stringliteral">&quot;&quot;</span>, peer-&gt;language);
<a name="l00809"></a>00809       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a44e6b334058bf9555fd4b834ad532046">AST_FLAG_MASQ_NOSTREAM</a>);
<a name="l00810"></a>00810    }
<a name="l00811"></a>00811    <span class="keywordflow">if</span> (peer == chan) { <span class="comment">/* pu-&gt;notquiteyet = 1 */</span>
<a name="l00812"></a>00812       <span class="comment">/* Wake up parking thread if we&apos;re really done */</span>
<a name="l00813"></a>00813       <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, 
<a name="l00814"></a>00814          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>, NULL),
<a name="l00815"></a>00815          !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>) ? strlen(pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#ae3166dc2b450d6462f59bc531abab9d7">mohclass</a>) + 1 : 0);
<a name="l00816"></a>00816       pu-&gt;<a class="code" href="structparkeduser.html#aeaf3504d3f44186d5fcfaced55711751">notquiteyet</a> = 0;
<a name="l00817"></a>00817       pthread_kill(<a class="code" href="features_8c.html#ac66fb87ae86fa37b36fa78286c237fd2">parking_thread</a>, SIGURG);
<a name="l00818"></a>00818    }
<a name="l00819"></a>00819    <span class="keywordflow">return</span> 0;
<a name="l00820"></a>00820 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="add37fc3ed9c410d20dd4de34644f5c7b"></a><!-- doxytag: member="features.c::park_exec" ref="add37fc3ed9c410d20dd4de34644f5c7b" args="(struct ast_channel *chan, void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int park_exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l03502">3502</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="chan__iax2_8c_source.html#l00223">default_parkinglot</a>, and <a class="el" href="features_8c_source.html#l03335">park_exec_full()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03503"></a>03503 {
<a name="l03504"></a>03504    <span class="keywordflow">return</span> <a class="code" href="features_8c.html#a30d20fba12b1a6a72a8fe90c6d546406" title="Pickup parked call.">park_exec_full</a>(chan, <a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>);
<a name="l03505"></a>03505 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a30d20fba12b1a6a72a8fe90c6d546406"></a><!-- doxytag: member="features.c::park_exec_full" ref="a30d20fba12b1a6a72a8fe90c6d546406" args="(struct ast_channel *chan, void *data, struct ast_parkinglot *parkinglot)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int park_exec_full </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td>
          <td class="paramname"> <em>parkinglot</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Pickup parked call. </p>

<p><dl class="todo"><dt><b><a class="el" href="todo.html#_todo000073">Todo:</a></b></dt><dd>XXX we would like to wait on both! </dd></dl>
<dl class="todo"><dt><b><a class="el" href="todo.html#_todo000074">Todo:</a></b></dt><dd>XXX Play a <a class="el" href="structmessage.html">message</a> XXX </dd></dl>
</p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03335">3335</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00469">ast_channel::_state</a>, <a class="el" href="channel_8c_source.html#l01951">ast_answer()</a>, <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, <a class="el" href="cdr_8c_source.html#l00768">ast_cdr_setdestchan()</a>, <a class="el" href="channel_8c_source.html#l01548">ast_channel_datastore_find()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="channel_8c_source.html#l04200">ast_channel_make_compatible()</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="pbx_8c_source.html#l02430">ast_context_find()</a>, <a class="el" href="pbx_8c_source.html#l04823">ast_context_remove_extension2()</a>, <a class="el" href="frame_8h_source.html#l00314">AST_CONTROL_UNHOLD</a>, <a class="el" href="utils_8h_source.html#l00082">ast_copy_flags</a>, <a class="el" href="devicestate_8h_source.html#l00053">AST_DEVICE_NOT_INUSE</a>, <a class="el" href="channel_8h_source.html#l00580">AST_FEATURE_AUTOMON</a>, <a class="el" href="channel_8h_source.html#l00578">AST_FEATURE_DISCONNECT</a>, <a class="el" href="features_8h_source.html#l00047">AST_FEATURE_FLAG_BYBOTH</a>, <a class="el" href="features_8h_source.html#l00045">AST_FEATURE_FLAG_BYCALLEE</a>, <a class="el" href="features_8h_source.html#l00046">AST_FEATURE_FLAG_BYCALLER</a>, <a class="el" href="channel_8h_source.html#l00581">AST_FEATURE_PARKCALL</a>, <a class="el" href="channel_8h_source.html#l00577">AST_FEATURE_REDIRECT</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="channel_8c_source.html#l01690">ast_hangup()</a>, <a class="el" href="channel_8c_source.html#l03110">ast_indicate()</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00553">AST_LIST_REMOVE_CURRENT</a>, <a class="el" href="linkedlists_8h_source.html#l00528">AST_LIST_TRAVERSE_SAFE_BEGIN</a>, <a class="el" href="linkedlists_8h_source.html#l00599">AST_LIST_TRAVERSE_SAFE_END</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="channel_8h_source.html#l00365">AST_STATE_UP</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, <a class="el" href="file_8c_source.html#l00943">ast_streamfile()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="file_8c_source.html#l01315">ast_waitstream()</a>, <a class="el" href="channel_8h_source.html#l00422">ast_channel::cdr</a>, <a class="el" href="features_8c_source.html#l00200">parkeduser::chan</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00204">ast_callerid::cid_name</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="features_8c_source.html#l00241">courtesytone</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="chan__iax2_8c_source.html#l00223">default_parkinglot</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="channel_8h_source.html#l00590">ast_bridge_config::features_callee</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, <a class="el" href="features_8c_source.html#l00275">ast_dial_features::features_caller</a>, <a class="el" href="features_8c_source.html#l03224">find_parkinglot()</a>, <a class="el" href="features_8c_source.html#l00493">findparkinglotname()</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="features_8c_source.html#l00510">notify_metermaids()</a>, <a class="el" href="features_8c_source.html#l00230">ast_parkinglot::parkedcallhangup</a>, <a class="el" href="features_8c_source.html#l00231">ast_parkinglot::parkedcallrecording</a>, <a class="el" href="features_8c_source.html#l00229">ast_parkinglot::parkedcallreparking</a>, <a class="el" href="features_8c_source.html#l00228">ast_parkinglot::parkedcalltransfers</a>, <a class="el" href="features_8c_source.html#l00242">parkedplay</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00203">parkeduser::parkingexten</a>, <a class="el" href="features_8c_source.html#l00202">parkeduser::parkingnum</a>, <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>, <a class="el" href="channel_8h_source.html#l00418">ast_channel::pbx</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, and <a class="el" href="strings_8h_source.html#l00072">S_OR</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03502">park_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03336"></a>03336 {
<a name="l03337"></a>03337    <span class="keywordtype">int</span> res = 0;
<a name="l03338"></a>03338    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *peer=NULL;
<a name="l03339"></a>03339    <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *pu;
<a name="l03340"></a>03340    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l03341"></a>03341    <span class="keywordtype">int</span> park = 0;
<a name="l03342"></a>03342    <span class="keyword">struct </span><a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a> <a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>;
<a name="l03343"></a>03343 
<a name="l03344"></a>03344    <span class="keywordflow">if</span> (data)
<a name="l03345"></a>03345       park = atoi((<span class="keywordtype">char</span> *)data);
<a name="l03346"></a>03346 
<a name="l03347"></a>03347    parkinglot = <a class="code" href="features_8c.html#ab7cacbc2a5f8e49ab8c548df6201601b" title="Find parkinglot by name.">find_parkinglot</a>(<a class="code" href="features_8c.html#a5ff0df3df1473ce3b5cec8f947a6fe69" title="Find parking lot name from channel.">findparkinglotname</a>(chan));  
<a name="l03348"></a>03348    <span class="keywordflow">if</span> (!parkinglot)
<a name="l03349"></a>03349       parkinglot = <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>;
<a name="l03350"></a>03350 
<a name="l03351"></a>03351    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l03352"></a>03352    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>, pu, list) {
<a name="l03353"></a>03353       <span class="keywordflow">if</span> (!data || pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a> == park) {
<a name="l03354"></a>03354          <span class="keywordflow">if</span> (pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#aebc9ecdf679da616c7d975b827e1f4b4">pbx</a>) { <span class="comment">/* do not allow call to be picked up until the PBX thread is finished */</span>
<a name="l03355"></a>03355             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l03356"></a>03356             <span class="keywordflow">return</span> -1;
<a name="l03357"></a>03357          }
<a name="l03358"></a>03358          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l03359"></a>03359          <span class="keywordflow">break</span>;
<a name="l03360"></a>03360       }
<a name="l03361"></a>03361    }
<a name="l03362"></a>03362    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l03363"></a>03363    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l03364"></a>03364 
<a name="l03365"></a>03365    <span class="keywordflow">if</span> (pu) {
<a name="l03366"></a>03366       peer = pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>;
<a name="l03367"></a>03367       con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l03368"></a>03368       <span class="keywordflow">if</span> (con) {
<a name="l03369"></a>03369          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a25dad382feec89a9bbc6c5284bb30e25" title="This functionc locks given context, search for the right extension and fires out...">ast_context_remove_extension2</a>(con, pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, 1, NULL, 0))
<a name="l03370"></a>03370             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, failed to remove the extension!\n&quot;</span>);
<a name="l03371"></a>03371          <span class="keywordflow">else</span>
<a name="l03372"></a>03372             <a class="code" href="features_8c.html#a5eed24a00b3ff396ca4135f2cacf76f9" title="Notify metermaids that we&amp;#39;ve changed an extension.">notify_metermaids</a>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>);
<a name="l03373"></a>03373       } <span class="keywordflow">else</span>
<a name="l03374"></a>03374          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Whoa, no parking context?\n&quot;</span>);
<a name="l03375"></a>03375 
<a name="l03376"></a>03376       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;UnParkedCall&quot;</span>,
<a name="l03377"></a>03377          <span class="stringliteral">&quot;Exten: %s\r\n&quot;</span>
<a name="l03378"></a>03378          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l03379"></a>03379          <span class="stringliteral">&quot;From: %s\r\n&quot;</span>
<a name="l03380"></a>03380          <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l03381"></a>03381          <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>,
<a name="l03382"></a>03382          pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name, chan-&gt;name,
<a name="l03383"></a>03383          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l03384"></a>03384          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>)
<a name="l03385"></a>03385          );
<a name="l03386"></a>03386 
<a name="l03387"></a>03387       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pu);
<a name="l03388"></a>03388    }
<a name="l03389"></a>03389    <span class="comment">/* JK02: it helps to answer the channel if not already up */</span>
<a name="l03390"></a>03390    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l03391"></a>03391       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l03392"></a>03392 
<a name="l03393"></a>03393    <span class="comment">//XXX Why do we unlock here ?</span>
<a name="l03394"></a>03394    <span class="comment">// uncomment it for now, till my setup with debug_threads and detect_deadlocks starts to complain</span>
<a name="l03395"></a>03395    <span class="comment">//ASTOBJ_UNLOCK(parkinglot);</span>
<a name="l03396"></a>03396 
<a name="l03397"></a>03397    <span class="keywordflow">if</span> (peer) {
<a name="l03398"></a>03398       <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *features_datastore;
<a name="l03399"></a>03399       <span class="keyword">struct </span><a class="code" href="structast__dial__features.html">ast_dial_features</a> *dialfeatures = NULL;
<a name="l03400"></a>03400 
<a name="l03401"></a>03401       <span class="comment">/* Play a courtesy to the source(s) configured to prefix the bridge connecting */</span>
<a name="l03402"></a>03402 
<a name="l03403"></a>03403       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>)) {
<a name="l03404"></a>03404          <span class="keywordtype">int</span> error = 0;
<a name="l03405"></a>03405          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(peer, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l03406"></a>03406          <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> == 0) {
<a name="l03407"></a>03407             error = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03408"></a>03408          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> == 1) {
<a name="l03409"></a>03409             error = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(peer, <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03410"></a>03410          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> == 2) {
<a name="l03411"></a>03411             <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>, chan-&gt;language) &amp;&amp;
<a name="l03412"></a>03412                   !<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(peer, <a class="code" href="features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>, chan-&gt;language)) {<span class="comment"></span>
<a name="l03413"></a>03413 <span class="comment">               /*! \todo XXX we would like to wait on both! */</span>
<a name="l03414"></a>03414                res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03415"></a>03415                <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l03416"></a>03416                   res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(peer, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03417"></a>03417                <span class="keywordflow">if</span> (res &lt; 0)
<a name="l03418"></a>03418                   error = 1;
<a name="l03419"></a>03419             }
<a name="l03420"></a>03420          }
<a name="l03421"></a>03421          <span class="keywordflow">if</span> (error) {
<a name="l03422"></a>03422             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play courtesy tone!\n&quot;</span>);
<a name="l03423"></a>03423             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l03424"></a>03424             <span class="keywordflow">return</span> -1;
<a name="l03425"></a>03425          }
<a name="l03426"></a>03426       } <span class="keywordflow">else</span>
<a name="l03427"></a>03427          <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(peer, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l03428"></a>03428 
<a name="l03429"></a>03429       res = <a class="code" href="channel_8h.html#a57646ce13ff95b5fc66dea2e741b21ff" title="Makes two channel formats compatible.">ast_channel_make_compatible</a>(chan, peer);
<a name="l03430"></a>03430       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03431"></a>03431          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not make channels %s and %s compatible for bridge\n&quot;</span>, chan-&gt;name, peer-&gt;name);
<a name="l03432"></a>03432          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l03433"></a>03433          <span class="keywordflow">return</span> -1;
<a name="l03434"></a>03434       }
<a name="l03435"></a>03435       <span class="comment">/* This runs sorta backwards, since we give the incoming channel control, as if it</span>
<a name="l03436"></a>03436 <span class="comment">         were the person called. */</span>
<a name="l03437"></a>03437       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Channel %s connected to parked call %d\n&quot;</span>, chan-&gt;name, park);
<a name="l03438"></a>03438 
<a name="l03439"></a>03439       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;PARKEDCHANNEL&quot;</span>, peer-&gt;name);
<a name="l03440"></a>03440       <a class="code" href="cdr_8h.html#aa7ed883d22142f873c13cf5364b95e1e" title="Set the destination channel, if there was one.">ast_cdr_setdestchan</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, peer-&gt;name);
<a name="l03441"></a>03441       memset(&amp;<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__bridge__config.html" title="bridge configuration">ast_bridge_config</a>));
<a name="l03442"></a>03442 
<a name="l03443"></a>03443       <span class="comment">/* Get datastore for peer and apply it&apos;s features to the callee side of the bridge config */</span>
<a name="l03444"></a>03444       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(peer);
<a name="l03445"></a>03445       <span class="keywordflow">if</span> ((features_datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(peer, &amp;<a class="code" href="features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a>, NULL))) {
<a name="l03446"></a>03446          dialfeatures = features_datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03447"></a>03447       }
<a name="l03448"></a>03448       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l03449"></a>03449 
<a name="l03450"></a>03450       <span class="comment">/* When the datastores for both caller and callee are created, both the callee and caller channels</span>
<a name="l03451"></a>03451 <span class="comment">       * use the features_caller flag variable to represent themselves. With that said, the config.features_callee</span>
<a name="l03452"></a>03452 <span class="comment">       * flags should be copied from the datastore&apos;s caller feature flags regardless if peer was a callee</span>
<a name="l03453"></a>03453 <span class="comment">       * or caller. */</span>
<a name="l03454"></a>03454       <span class="keywordflow">if</span> (dialfeatures) {
<a name="l03455"></a>03455          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_callee), &amp;(dialfeatures-&gt;<a class="code" href="structast__dial__features.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l03456"></a>03456       }
<a name="l03457"></a>03457 
<a name="l03458"></a>03458       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a1b7ebcd57a463747583fbdbe04659f87">parkedcalltransfers</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a1b7ebcd57a463747583fbdbe04659f87">parkedcalltransfers</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03459"></a>03459          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_callee), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>);
<a name="l03460"></a>03460       }
<a name="l03461"></a>03461       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a1b7ebcd57a463747583fbdbe04659f87">parkedcalltransfers</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a1b7ebcd57a463747583fbdbe04659f87">parkedcalltransfers</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03462"></a>03462          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_caller), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>);
<a name="l03463"></a>03463       }
<a name="l03464"></a>03464       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a24927d2710176c1a6a2c3a9eaa2f81c8">parkedcallreparking</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a24927d2710176c1a6a2c3a9eaa2f81c8">parkedcallreparking</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03465"></a>03465          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_callee), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>);
<a name="l03466"></a>03466       }
<a name="l03467"></a>03467       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a24927d2710176c1a6a2c3a9eaa2f81c8">parkedcallreparking</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a24927d2710176c1a6a2c3a9eaa2f81c8">parkedcallreparking</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03468"></a>03468          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_caller), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>);
<a name="l03469"></a>03469       }
<a name="l03470"></a>03470       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a0e02756579d965599dee2698239a2e0b">parkedcallhangup</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a0e02756579d965599dee2698239a2e0b">parkedcallhangup</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03471"></a>03471          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_callee), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l03472"></a>03472       }
<a name="l03473"></a>03473       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a0e02756579d965599dee2698239a2e0b">parkedcallhangup</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a0e02756579d965599dee2698239a2e0b">parkedcallhangup</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03474"></a>03474          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_caller), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l03475"></a>03475       }
<a name="l03476"></a>03476       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#afdd70572c127b18cec17efb3cb2515cb">parkedcallrecording</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#afdd70572c127b18cec17efb3cb2515cb">parkedcallrecording</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03477"></a>03477          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_callee), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>);
<a name="l03478"></a>03478       }
<a name="l03479"></a>03479       <span class="keywordflow">if</span> ((parkinglot-&gt;<a class="code" href="structast__parkinglot.html#afdd70572c127b18cec17efb3cb2515cb">parkedcallrecording</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>) || (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#afdd70572c127b18cec17efb3cb2515cb">parkedcallrecording</a> == <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca54b7e168009244e5f9bb4182c8fda16c">AST_FEATURE_FLAG_BYBOTH</a>)) {
<a name="l03480"></a>03480          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>.features_caller), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>);
<a name="l03481"></a>03481       }
<a name="l03482"></a>03482 
<a name="l03483"></a>03483       res = <a class="code" href="features_8h.html#a3fe7c7e43b8f3140716d836816bf827f" title="Bridge a call, optionally allowing redirection.">ast_bridge_call</a>(chan, peer, &amp;<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>);
<a name="l03484"></a>03484 
<a name="l03485"></a>03485       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;PARKEDCHANNEL&quot;</span>, peer-&gt;name);
<a name="l03486"></a>03486       <a class="code" href="cdr_8h.html#aa7ed883d22142f873c13cf5364b95e1e" title="Set the destination channel, if there was one.">ast_cdr_setdestchan</a>(chan-&gt;<a class="code" href="structast__channel.html#a0b6fbd632bcf2e09017a0b82c2ed41ff">cdr</a>, peer-&gt;name);
<a name="l03487"></a>03487 
<a name="l03488"></a>03488       <span class="comment">/* Simulate the PBX hanging up */</span>
<a name="l03489"></a>03489       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(peer);
<a name="l03490"></a>03490       <span class="keywordflow">return</span> -1;
<a name="l03491"></a>03491    } <span class="keywordflow">else</span> {<span class="comment"></span>
<a name="l03492"></a>03492 <span class="comment">      /*! \todo XXX Play a message XXX */</span>
<a name="l03493"></a>03493       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;pbx-invalidpark&quot;</span>, <span class="stringliteral">&quot;&quot;</span>))
<a name="l03494"></a>03494          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ast_streamfile of %s failed on %s\n&quot;</span>, <span class="stringliteral">&quot;pbx-invalidpark&quot;</span>, chan-&gt;name);
<a name="l03495"></a>03495       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Channel %s tried to talk to nonexistent parked call %d\n&quot;</span>, chan-&gt;name, park);
<a name="l03496"></a>03496       res = -1;
<a name="l03497"></a>03497    }
<a name="l03498"></a>03498 
<a name="l03499"></a>03499    <span class="keywordflow">return</span> -1;
<a name="l03500"></a>03500 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acc8e6a5be7f5d697c14627a5119c8199"></a><!-- doxytag: member="features.c::park_space_reserve" ref="acc8e6a5be7f5d697c14627a5119c8199" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_park_call_args *args)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structparkeduser.html">parkeduser</a>* park_space_reserve </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__park__call__args.html">ast_park_call_args</a> *&nbsp;</td>
          <td class="paramname"> <em>args</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p><dl class="note"><dt><b>Note:</b></dt><dd>The API forces us to specify a numeric parking slot, even though the architecture would tend to support non-numeric extensions (as are possible with SIP, for example). Hence, we enforce that limitation here. If extout was not numeric, we could permit arbitrary non-numeric extensions.</dd></dl>
</p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00566">566</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="pbx_8c_source.html#l04143">ast_exists_extension()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00715">AST_LIST_INSERT_TAIL</a>, <a class="el" href="linkedlists_8h_source.html#l00039">AST_LIST_LOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00490">AST_LIST_TRAVERSE</a>, <a class="el" href="linkedlists_8h_source.html#l00139">AST_LIST_UNLOCK</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="features_8c_source.html#l00544">AST_PARK_OPT_RANDOMIZE</a>, <a class="el" href="utils_8c_source.html#l01401">ast_random()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="chan__iax2_8c_source.html#l00223">default_parkinglot</a>, <a class="el" href="features_8c_source.html#l03224">find_parkinglot()</a>, <a class="el" href="features_8c_source.html#l00493">findparkinglotname()</a>, <a class="el" href="astmm_8h_source.html#l00084">free</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l00208">parkeduser::notquiteyet</a>, <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>, <a class="el" href="features_8c_source.html#l00224">ast_parkinglot::parkfindnext</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00223">ast_parkinglot::parking_offset</a>, <a class="el" href="features_8c_source.html#l00221">ast_parkinglot::parking_start</a>, <a class="el" href="features_8c_source.html#l00222">ast_parkinglot::parking_stop</a>, <a class="el" href="features_8c_source.html#l00203">parkeduser::parkingexten</a>, <a class="el" href="features_8c_source.html#l00212">parkeduser::parkinglot</a>, <a class="el" href="features_8c_source.html#l03516">parkinglot_addref()</a>, <a class="el" href="features_8c_source.html#l03509">parkinglot_unref()</a>, <a class="el" href="features_8c_source.html#l00202">parkeduser::parkingnum</a>, <a class="el" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">ast_parkinglot::parkings</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, and <a class="el" href="strings_8h_source.html#l00072">S_OR</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00833">masq_park_call()</a>, and <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00568"></a>00568 {
<a name="l00569"></a>00569    <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *pu;
<a name="l00570"></a>00570    <span class="keywordtype">int</span> i, parking_space = -1, parking_range;
<a name="l00571"></a>00571    <span class="keyword">const</span> <span class="keywordtype">char</span> *parkinglotname = NULL;
<a name="l00572"></a>00572    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>;
<a name="l00573"></a>00573    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a> = NULL;
<a name="l00574"></a>00574    
<a name="l00575"></a>00575    <span class="keywordflow">if</span> (peer)
<a name="l00576"></a>00576       parkinglotname = <a class="code" href="features_8c.html#a5ff0df3df1473ce3b5cec8f947a6fe69" title="Find parking lot name from channel.">findparkinglotname</a>(peer);
<a name="l00577"></a>00577 
<a name="l00578"></a>00578    <span class="keywordflow">if</span> (parkinglotname) {
<a name="l00579"></a>00579       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00580"></a>00580          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Found chanvar Parkinglot: %s\n&quot;</span>, parkinglotname);
<a name="l00581"></a>00581       parkinglot = <a class="code" href="features_8c.html#ab7cacbc2a5f8e49ab8c548df6201601b" title="Find parkinglot by name.">find_parkinglot</a>(parkinglotname);   
<a name="l00582"></a>00582    }
<a name="l00583"></a>00583    <span class="keywordflow">if</span> (!parkinglot) {
<a name="l00584"></a>00584       parkinglot = <a class="code" href="features_8c.html#afd36dda493e0930aed5e3d6dc59de095">parkinglot_addref</a>(<a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>);
<a name="l00585"></a>00585    }
<a name="l00586"></a>00586 
<a name="l00587"></a>00587    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00588"></a>00588       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Parkinglot: %s\n&quot;</span>, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <span class="comment">/* Allocate memory for parking data */</span>
<a name="l00591"></a>00591    <span class="keywordflow">if</span> (!(pu = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*pu)))) {
<a name="l00592"></a>00592       <a class="code" href="features_8c.html#ab85223aa95d23fb716027953e555c28b" title="Unreference parkinglot object. If no more references, then go ahead and delete it...">parkinglot_unref</a>(parkinglot);
<a name="l00593"></a>00593       <span class="keywordflow">return</span> NULL;
<a name="l00594"></a>00594    }
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    <span class="comment">/* Lock parking list */</span>
<a name="l00597"></a>00597    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l00598"></a>00598    <span class="comment">/* Check for channel variable PARKINGEXTEN */</span>
<a name="l00599"></a>00599    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00600"></a>00600    parkingexten = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;PARKINGEXTEN&quot;</span>), <span class="stringliteral">&quot;&quot;</span>));
<a name="l00601"></a>00601    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00602"></a>00602    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(parkingexten)) {<span class="comment"></span>
<a name="l00603"></a>00603 <span class="comment">      /*!\note The API forces us to specify a numeric parking slot, even</span>
<a name="l00604"></a>00604 <span class="comment">       * though the architecture would tend to support non-numeric extensions</span>
<a name="l00605"></a>00605 <span class="comment">       * (as are possible with SIP, for example).  Hence, we enforce that</span>
<a name="l00606"></a>00606 <span class="comment">       * limitation here.  If extout was not numeric, we could permit</span>
<a name="l00607"></a>00607 <span class="comment">       * arbitrary non-numeric extensions.</span>
<a name="l00608"></a>00608 <span class="comment">       */</span>
<a name="l00609"></a>00609         <span class="keywordflow">if</span> (sscanf(parkingexten, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;parking_space) != 1 || parking_space &lt; 0) {
<a name="l00610"></a>00610          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l00611"></a>00611          <a class="code" href="features_8c.html#ab85223aa95d23fb716027953e555c28b" title="Unreference parkinglot object. If no more references, then go ahead and delete it...">parkinglot_unref</a>(parkinglot);
<a name="l00612"></a>00612             <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(pu);
<a name="l00613"></a>00613             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;PARKINGEXTEN does not indicate a valid parking slot: &apos;%s&apos;.\n&quot;</span>, parkingexten);
<a name="l00614"></a>00614             <span class="keywordflow">return</span> NULL;
<a name="l00615"></a>00615         }
<a name="l00616"></a>00616         snprintf(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>), <span class="stringliteral">&quot;%d&quot;</span>, parking_space);
<a name="l00617"></a>00617 
<a name="l00618"></a>00618       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>, pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, 1, NULL)) {
<a name="l00619"></a>00619          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Requested parking extension already exists: %s@%s\n&quot;</span>, parkingexten, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l00620"></a>00620          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l00621"></a>00621          <a class="code" href="features_8c.html#ab85223aa95d23fb716027953e555c28b" title="Unreference parkinglot object. If no more references, then go ahead and delete it...">parkinglot_unref</a>(parkinglot);
<a name="l00622"></a>00622          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pu);
<a name="l00623"></a>00623          <span class="keywordflow">return</span> NULL;
<a name="l00624"></a>00624       }
<a name="l00625"></a>00625    } <span class="keywordflow">else</span> {
<a name="l00626"></a>00626       <span class="keywordtype">int</span> start;
<a name="l00627"></a>00627       <span class="keyword">struct </span><a class="code" href="structparkeduser.html" title="Description of one parked call, added to a list while active, then removed. The list...">parkeduser</a> *cur = NULL;
<a name="l00628"></a>00628 
<a name="l00629"></a>00629       <span class="comment">/* Select parking space within range */</span>
<a name="l00630"></a>00630       parking_range = parkinglot-&gt;<a class="code" href="structast__parkinglot.html#ac6c6bea761c82a98ef22c655cfbf5a56">parking_stop</a> - parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a> + 1;
<a name="l00631"></a>00631 
<a name="l00632"></a>00632       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(args, <a class="code" href="features_8c.html#aabb62351ca403089e5d36755a0f3f192a488c61b7f65dac006eb73215dc0de44b">AST_PARK_OPT_RANDOMIZE</a>)) {
<a name="l00633"></a>00633          start = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#ac6c6bea761c82a98ef22c655cfbf5a56">parking_stop</a> - parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a> + 1);
<a name="l00634"></a>00634       } <span class="keywordflow">else</span> {
<a name="l00635"></a>00635          start = parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a>;
<a name="l00636"></a>00636       }
<a name="l00637"></a>00637 
<a name="l00638"></a>00638       <span class="keywordflow">for</span> (i = start; 1; i++) {
<a name="l00639"></a>00639          <span class="keywordflow">if</span> (i == parkinglot-&gt;<a class="code" href="structast__parkinglot.html#ac6c6bea761c82a98ef22c655cfbf5a56">parking_stop</a> + 1) {
<a name="l00640"></a>00640             i = parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a> - 1;
<a name="l00641"></a>00641             <span class="keywordflow">break</span>;
<a name="l00642"></a>00642          }
<a name="l00643"></a>00643 
<a name="l00644"></a>00644          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>, cur, <a class="code" href="structparkeduser.html#ac46ac8b4dbcd711b75c11ba7044a94c0">list</a>) {
<a name="l00645"></a>00645             <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a> == i) {
<a name="l00646"></a>00646                <span class="keywordflow">break</span>;
<a name="l00647"></a>00647             }
<a name="l00648"></a>00648          }
<a name="l00649"></a>00649          <span class="keywordflow">if</span> (!cur) {
<a name="l00650"></a>00650             parking_space = i;
<a name="l00651"></a>00651             <span class="keywordflow">break</span>;
<a name="l00652"></a>00652          }
<a name="l00653"></a>00653       }
<a name="l00654"></a>00654 
<a name="l00655"></a>00655       <span class="keywordflow">if</span> (i == start - 1 &amp;&amp; cur) {
<a name="l00656"></a>00656          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No more parking spaces\n&quot;</span>);
<a name="l00657"></a>00657          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pu);
<a name="l00658"></a>00658          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>);
<a name="l00659"></a>00659          <a class="code" href="features_8c.html#ab85223aa95d23fb716027953e555c28b" title="Unreference parkinglot object. If no more references, then go ahead and delete it...">parkinglot_unref</a>(parkinglot);
<a name="l00660"></a>00660          <span class="keywordflow">return</span> NULL;
<a name="l00661"></a>00661       }
<a name="l00662"></a>00662       <span class="comment">/* Set pointer for next parking */</span>
<a name="l00663"></a>00663       <span class="keywordflow">if</span> (parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a5cbf8179fd861c82eb9f63f538469ceb">parkfindnext</a>) 
<a name="l00664"></a>00664          parkinglot-&gt;<a class="code" href="structast__parkinglot.html#aba8decb8b51c217ec96797b53fd996e4">parking_offset</a> = parking_space - parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a22b6d3f18ce27630b9f7220cd3639e48">parking_start</a> + 1;
<a name="l00665"></a>00665       snprintf(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, <span class="keyword">sizeof</span>(pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>), <span class="stringliteral">&quot;%d&quot;</span>, parking_space);
<a name="l00666"></a>00666    }
<a name="l00667"></a>00667 
<a name="l00668"></a>00668    pu-&gt;<a class="code" href="structparkeduser.html#aeaf3504d3f44186d5fcfaced55711751">notquiteyet</a> = 1;
<a name="l00669"></a>00669    pu-&gt;<a class="code" href="structparkeduser.html#a31ed63d696180683e0680d2fcfacf9af">parkingnum</a> = parking_space;
<a name="l00670"></a>00670    pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a> = <a class="code" href="features_8c.html#afd36dda493e0930aed5e3d6dc59de095">parkinglot_addref</a>(parkinglot);
<a name="l00671"></a>00671    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;parkinglot-&gt;<a class="code" href="structast__parkinglot.html#af9a805fd08d397a0ffc9731a979fdbf2">parkings</a>, pu, <a class="code" href="structparkeduser.html#ac46ac8b4dbcd711b75c11ba7044a94c0">list</a>);
<a name="l00672"></a>00672    <a class="code" href="features_8c.html#ab85223aa95d23fb716027953e555c28b" title="Unreference parkinglot object. If no more references, then go ahead and delete it...">parkinglot_unref</a>(parkinglot);
<a name="l00673"></a>00673 
<a name="l00674"></a>00674    <span class="keywordflow">return</span> pu;
<a name="l00675"></a>00675 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="afd36dda493e0930aed5e3d6dc59de095"></a><!-- doxytag: member="features.c::parkinglot_addref" ref="afd36dda493e0930aed5e3d6dc59de095" args="(struct ast_parkinglot *parkinglot)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> * parkinglot_addref </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td>
          <td class="paramname"> <em>parkinglot</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l03516">3516</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, and <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00566">park_space_reserve()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03517"></a>03517 {
<a name="l03518"></a>03518    <span class="keywordtype">int</span> refcount = <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(parkinglot, +1);
<a name="l03519"></a>03519    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l03520"></a>03520       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Multiparking: %s refcount now %d\n&quot;</span>, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, refcount + 1);
<a name="l03521"></a>03521    <span class="keywordflow">return</span> parkinglot;
<a name="l03522"></a>03522 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1798ad70b3c43377f3d89f7c4830b940"></a><!-- doxytag: member="features.c::parkinglot_cmp_cb" ref="a1798ad70b3c43377f3d89f7c4830b940" args="(void *obj, void *arg, int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int parkinglot_cmp_cb </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>arg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00340">340</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00653">CMP_MATCH</a>, <a class="el" href="astobj2_8h_source.html#l00654">CMP_STOP</a>, and <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00341"></a>00341 {
<a name="l00342"></a>00342    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a> = obj, *parkinglot2 = arg;
<a name="l00343"></a>00343 
<a name="l00344"></a>00344    <span class="keywordflow">return</span> !strcasecmp(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, parkinglot2-&gt;name) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l00345"></a>00345 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af048c9c1f337c794fec319fe666ab8b8"></a><!-- doxytag: member="features.c::parkinglot_destroy" ref="af048c9c1f337c794fec319fe666ab8b8" args="(void *obj)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void parkinglot_destroy </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>obj</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Destroy a parking lot. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03543">3543</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00813">ao2_unlink</a>, <a class="el" href="pbx_8c_source.html#l08415">ast_context_destroy()</a>, <a class="el" href="pbx_8c_source.html#l02430">ast_context_find()</a>, <a class="el" href="features_8c_source.html#l00219">ast_parkinglot::parking_con</a>, <a class="el" href="features_8c_source.html#l00236">parkinglots</a>, and <a class="el" href="features_8c_source.html#l00259">registrar</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, and <a class="el" href="features_8c_source.html#l03525">create_parkinglot()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03544"></a>03544 {
<a name="l03545"></a>03545    <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *ruin = obj;
<a name="l03546"></a>03546    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l03547"></a>03547    con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(ruin-&gt;<a class="code" href="structast__parkinglot.html#a141565357cdaf8edb3c6b52c20fef933">parking_con</a>);
<a name="l03548"></a>03548    <span class="keywordflow">if</span> (con)
<a name="l03549"></a>03549       <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(con, <a class="code" href="features_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l03550"></a>03550    <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(<a class="code" href="features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509" title="The list of parking lots configured. Always at least one - the default parking lot...">parkinglots</a>, ruin);
<a name="l03551"></a>03551 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a231b8dd6b2803def28a66cc640d3186f"></a><!-- doxytag: member="features.c::parkinglot_hash_cb" ref="a231b8dd6b2803def28a66cc640d3186f" args="(const void *obj, const int flags)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int parkinglot_hash_cb </td>
          <td>(</td>
          <td class="paramtype">const void *&nbsp;</td>
          <td class="paramname"> <em>obj</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const int&nbsp;</td>
          <td class="paramname"> <em>flags</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00333">333</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00896">ast_str_case_hash()</a>, and <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00334"></a>00334 {
<a name="l00335"></a>00335    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__parkinglot.html" title="Structure for parking lots which are put in a container.">ast_parkinglot</a> *<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a> = obj;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#ab08f8db2a7258e538a0da7417f58db58" title="Compute a hash value on a case-insensitive string.">ast_str_case_hash</a>(parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>);
<a name="l00338"></a>00338 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab85223aa95d23fb716027953e555c28b"></a><!-- doxytag: member="features.c::parkinglot_unref" ref="ab85223aa95d23fb716027953e555c28b" args="(struct ast_parkinglot *parkinglot)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void parkinglot_unref </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a> *&nbsp;</td>
          <td class="paramname"> <em>parkinglot</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unreference parkinglot object. If no more references, then go ahead and delete it. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l03509">3509</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astobj2_8h_source.html#l00459">ao2_ref</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="logger_8h_source.html#l00119">LOG_DEBUG</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, and <a class="el" href="asterisk_8c_source.html#l00175">option_debug</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, and <a class="el" href="features_8c_source.html#l00566">park_space_reserve()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l03510"></a>03510 {
<a name="l03511"></a>03511    <span class="keywordtype">int</span> refcount = <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(parkinglot, -1);
<a name="l03512"></a>03512    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l03513"></a>03513       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Multiparking: %s refcount now %d\n&quot;</span>, parkinglot-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>, refcount - 1);
<a name="l03514"></a>03514 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a82ec1e5a1738ece6284922cf189ce3f2"></a><!-- doxytag: member="features.c::pick_unlocked_cdr" ref="a82ec1e5a1738ece6284922cf189ce3f2" args="(struct ast_cdr *cdr)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structast__cdr.html">ast_cdr</a>* pick_unlocked_cdr </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__cdr.html">ast_cdr</a> *&nbsp;</td>
          <td class="paramname"> <em>cdr</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>return the first unlocked cdr in a possible chain </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l02331">2331</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="cdr_8h_source.html#l00032">AST_CDR_FLAG_LOCKED</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, and <a class="el" href="cdr_8h_source.html#l00113">ast_cdr::next</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02332"></a>02332 {
<a name="l02333"></a>02333    <span class="keyword">struct </span><a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *cdr_orig = cdr;
<a name="l02334"></a>02334    <span class="keywordflow">while</span> (cdr) {
<a name="l02335"></a>02335       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(cdr,<a class="code" href="cdr_8h.html#ad19495bac7dec6a99190f93e21965da6">AST_CDR_FLAG_LOCKED</a>))
<a name="l02336"></a>02336          <span class="keywordflow">return</span> cdr;
<a name="l02337"></a>02337       cdr = cdr-&gt;<a class="code" href="structast__cdr.html#a8098d02138e27b57d184b260b6669eed">next</a>;
<a name="l02338"></a>02338    }
<a name="l02339"></a>02339    <span class="keywordflow">return</span> cdr_orig; <span class="comment">/* everybody LOCKED or some other weirdness, like a NULL */</span>
<a name="l02340"></a>02340 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab9136d54e94186e675c182cc933a46f9"></a><!-- doxytag: member="features.c::play_message_in_bridged_call" ref="ab9136d54e94186e675c182cc933a46f9" args="(struct ast_channel *caller_chan, struct ast_channel *callee_chan, const char *audiofile)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int play_message_in_bridged_call </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>caller_chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>callee_chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>audiofile</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Play <a class="el" href="structmessage.html">message</a> to both caller and callee in bridged call, plays synchronously, autoservicing the other channel during the <a class="el" href="structmessage.html">message</a>, so please don't use this for very long messages. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00973">973</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="file_8c_source.html#l01342">ast_stream_and_wait()</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01012">builtin_automonitor()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00974"></a>00974 {
<a name="l00975"></a>00975    <span class="comment">/* First play for caller, put other channel on auto service */</span>
<a name="l00976"></a>00976    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(callee_chan))
<a name="l00977"></a>00977       <span class="keywordflow">return</span> -1;
<a name="l00978"></a>00978    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(caller_chan, audiofile, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00979"></a>00979       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play automon message!\n&quot;</span>);
<a name="l00980"></a>00980       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(callee_chan);
<a name="l00981"></a>00981       <span class="keywordflow">return</span> -1;
<a name="l00982"></a>00982    }
<a name="l00983"></a>00983    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(callee_chan))
<a name="l00984"></a>00984       <span class="keywordflow">return</span> -1;
<a name="l00985"></a>00985    <span class="comment">/* Then play for callee, put other channel on auto service */</span>
<a name="l00986"></a>00986    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(caller_chan))
<a name="l00987"></a>00987       <span class="keywordflow">return</span> -1;
<a name="l00988"></a>00988    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(callee_chan, audiofile, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l00989"></a>00989       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to play automon message !\n&quot;</span>);
<a name="l00990"></a>00990       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(caller_chan);
<a name="l00991"></a>00991       <span class="keywordflow">return</span> -1;
<a name="l00992"></a>00992    }
<a name="l00993"></a>00993    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(caller_chan))
<a name="l00994"></a>00994       <span class="keywordflow">return</span> -1;
<a name="l00995"></a>00995    <span class="keywordflow">return</span>(0);
<a name="l00996"></a>00996 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a357c36e1b760f6742b5803dd78905306"></a><!-- doxytag: member="features.c::post_manager_event" ref="a357c36e1b760f6742b5803dd78905306" args="(const char *s, struct parkeduser *pu)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void post_manager_event </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>s</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structparkeduser.html">parkeduser</a> *&nbsp;</td>
          <td class="paramname"> <em>pu</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Output parking event to manager. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l02946">2946</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00200">parkeduser::chan</a>, <a class="el" href="channel_8h_source.html#l00444">ast_channel::cid</a>, <a class="el" href="channel_8h_source.html#l00204">ast_callerid::cid_name</a>, <a class="el" href="channel_8h_source.html#l00203">ast_callerid::cid_num</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="features_8c_source.html#l00218">ast_parkinglot::name</a>, <a class="el" href="features_8c_source.html#l00203">parkeduser::parkingexten</a>, <a class="el" href="features_8c_source.html#l00212">parkeduser::parkinglot</a>, and <a class="el" href="strings_8h_source.html#l00072">S_OR</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02947"></a>02947 {
<a name="l02948"></a>02948    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>,
<a name="l02949"></a>02949       <span class="stringliteral">&quot;Exten: %s\r\n&quot;</span>
<a name="l02950"></a>02950       <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02951"></a>02951       <span class="stringliteral">&quot;Parkinglot: %s\r\n&quot;</span>
<a name="l02952"></a>02952       <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l02953"></a>02953       <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l02954"></a>02954       <span class="stringliteral">&quot;UniqueID: %s\r\n\r\n&quot;</span>,
<a name="l02955"></a>02955       pu-&gt;<a class="code" href="structparkeduser.html#a6a876814bc5786fd7d6b9090fd3040ff">parkingexten</a>, 
<a name="l02956"></a>02956       pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;name,
<a name="l02957"></a>02957       pu-&gt;<a class="code" href="structparkeduser.html#a58ddc83c1f664f2de726b2294338b660">parkinglot</a>-&gt;<a class="code" href="structast__parkinglot.html#a2fed60c377a459471bf8fcb1ff0626eb">name</a>,
<a name="l02958"></a>02958       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l02959"></a>02959       <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l02960"></a>02960       pu-&gt;<a class="code" href="structparkeduser.html#a9e9c636288a37a233813953123bf7dcc">chan</a>-&gt;uniqueid
<a name="l02961"></a>02961       );
<a name="l02962"></a>02962 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aaae36759026f17aea180b5ba7fad3918"></a><!-- doxytag: member="features.c::real_ctx" ref="aaae36759026f17aea180b5ba7fad3918" args="(struct ast_channel *transferer, struct ast_channel *transferee)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static const char* real_ctx </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>transferer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>transferee</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Find the context for the transfer. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>transferer</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>transferee</em>&nbsp;</td><td>Grab the TRANSFER_CONTEXT, if fails try grabbing macrocontext. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a context string </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01236">1236</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="channel_8h_source.html#l00505">ast_channel::macrocontext</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, and <a class="el" href="aesopt_8h_source.html#l00399">s</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, and <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01237"></a>01237 {
<a name="l01238"></a>01238    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(transferer, <span class="stringliteral">&quot;TRANSFER_CONTEXT&quot;</span>);
<a name="l01239"></a>01239    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(s)) {
<a name="l01240"></a>01240       s = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(transferee, <span class="stringliteral">&quot;TRANSFER_CONTEXT&quot;</span>);
<a name="l01241"></a>01241    }
<a name="l01242"></a>01242    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(s)) { <span class="comment">/* Use the non-macro context to transfer the call XXX ? */</span>
<a name="l01243"></a>01243       s = transferer-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>;
<a name="l01244"></a>01244    }
<a name="l01245"></a>01245    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(s)) {
<a name="l01246"></a>01246       s = transferer-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l01247"></a>01247    }
<a name="l01248"></a>01248    <span class="keywordflow">return</span> s;  
<a name="l01249"></a>01249 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aec9d75b1e054035dae95035292c36937"></a><!-- doxytag: member="features.c::register_group" ref="aec9d75b1e054035dae95035292c36937" args="(const char *fgname)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static struct <a class="el" href="structfeature__group.html">feature_group</a>* register_group </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>fgname</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static, read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add new feature <a class="el" href="structgroup.html">group</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>fgname</em>&nbsp;</td><td>feature <a class="el" href="structgroup.html">group</a> name.</td></tr>
  </table>
  </dd>
</dl>
<p>Add new feature <a class="el" href="structgroup.html">group</a> to the feature <a class="el" href="structgroup.html">group</a> list insert at head of list. </p>
<dl class="note"><dt><b>Note:</b></dt><dd>This function MUST be called while <a class="el" href="structfeature__groups.html">feature_groups</a> is locked. </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01732">1732</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00695">AST_LIST_INSERT_HEAD</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="stringfields_8h_source.html#l00241">ast_string_field_init</a>, <a class="el" href="stringfields_8h_source.html#l00285">ast_string_field_set</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="features_8c_source.html#l00186">feature_group::gname</a>, and <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01733"></a>01733 {
<a name="l01734"></a>01734    <span class="keyword">struct </span><a class="code" href="structfeature__group.html">feature_group</a> *fg;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736    <span class="keywordflow">if</span> (!fgname) {
<a name="l01737"></a>01737       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;You didn&apos;t pass a new group name!\n&quot;</span>);
<a name="l01738"></a>01738       <span class="keywordflow">return</span> NULL;
<a name="l01739"></a>01739    }
<a name="l01740"></a>01740 
<a name="l01741"></a>01741    <span class="keywordflow">if</span> (!(fg = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*fg))))
<a name="l01742"></a>01742       <span class="keywordflow">return</span> NULL;
<a name="l01743"></a>01743 
<a name="l01744"></a>01744    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(fg, 128)) {
<a name="l01745"></a>01745       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fg);
<a name="l01746"></a>01746       <span class="keywordflow">return</span> NULL;
<a name="l01747"></a>01747    }
<a name="l01748"></a>01748 
<a name="l01749"></a>01749    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(fg, <a class="code" href="structfeature__group.html#ac9e941f7772e1e0c1e1a4b4691d6184e">gname</a>, fgname);
<a name="l01750"></a>01750 
<a name="l01751"></a>01751    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;<a class="code" href="structfeature__groups.html">feature_groups</a>, fg, <a class="code" href="structfeature__group.html#acb068077d19df4263373a35c35a49592">entry</a>);
<a name="l01752"></a>01752 
<a name="l01753"></a>01753    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Registered group &apos;%s&apos;\n&quot;</span>, fg-&gt;<a class="code" href="structfeature__group.html#ac9e941f7772e1e0c1e1a4b4691d6184e">gname</a>);
<a name="l01754"></a>01754 
<a name="l01755"></a>01755    <span class="keywordflow">return</span> fg;
<a name="l01756"></a>01756 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae592cf7dec3edf756bc8647f56a740d7"></a><!-- doxytag: member="features.c::register_group_feature" ref="ae592cf7dec3edf756bc8647f56a740d7" args="(struct feature_group *fg, const char *exten, struct ast_call_feature *feature)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void register_group_feature </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structfeature__group.html">feature_group</a> *&nbsp;</td>
          <td class="paramname"> <em>fg</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> *&nbsp;</td>
          <td class="paramname"> <em>feature</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Add feature to <a class="el" href="structgroup.html">group</a>. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>fg</em>&nbsp;</td><td>feature <a class="el" href="structgroup.html">group</a> </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>exten</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>feature</em>&nbsp;</td><td>feature to add.</td></tr>
  </table>
  </dd>
</dl>
<p>Check fg and feature specified, add feature to list </p>
<dl class="note"><dt><b>Note:</b></dt><dd>This function MUST be called while <a class="el" href="structfeature__groups.html">feature_groups</a> is locked. </dd></dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l01767">1767</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="linkedlists_8h_source.html#l00695">AST_LIST_INSERT_HEAD</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="stringfields_8h_source.html#l00241">ast_string_field_init</a>, <a class="el" href="stringfields_8h_source.html#l00285">ast_string_field_set</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="features_8h_source.html#l00054">ast_call_feature::exten</a>, <a class="el" href="features_8c_source.html#l00179">feature_group_exten::feature</a>, <a class="el" href="structfeature__group.html#a9f496cd6d406637c34b0685e45269921">feature_group::features</a>, <a class="el" href="features_8c_source.html#l00186">feature_group::gname</a>, <a class="el" href="logger_8h_source.html#l00141">LOG_NOTICE</a>, <a class="el" href="strings_8h_source.html#l00072">S_OR</a>, and <a class="el" href="features_8h_source.html#l00053">ast_call_feature::sname</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01768"></a>01768 {
<a name="l01769"></a>01769    <span class="keyword">struct </span><a class="code" href="structfeature__group__exten.html">feature_group_exten</a> *fge;
<a name="l01770"></a>01770 
<a name="l01771"></a>01771    <span class="keywordflow">if</span> (!fg) {
<a name="l01772"></a>01772       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;You didn&apos;t pass a group!\n&quot;</span>);
<a name="l01773"></a>01773       <span class="keywordflow">return</span>;
<a name="l01774"></a>01774    }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776    <span class="keywordflow">if</span> (!feature) {
<a name="l01777"></a>01777       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;You didn&apos;t pass a feature!\n&quot;</span>);
<a name="l01778"></a>01778       <span class="keywordflow">return</span>;
<a name="l01779"></a>01779    }
<a name="l01780"></a>01780 
<a name="l01781"></a>01781    <span class="keywordflow">if</span> (!(fge = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*fge))))
<a name="l01782"></a>01782       <span class="keywordflow">return</span>;
<a name="l01783"></a>01783 
<a name="l01784"></a>01784    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(fge, 128)) {
<a name="l01785"></a>01785       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(fge);
<a name="l01786"></a>01786       <span class="keywordflow">return</span>;
<a name="l01787"></a>01787    }
<a name="l01788"></a>01788 
<a name="l01789"></a>01789    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(fge, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, feature-&gt;<a class="code" href="structast__call__feature.html#a271083a3f8b3bc8499e739bd52ec7fe4">exten</a>));
<a name="l01790"></a>01790 
<a name="l01791"></a>01791    fge-&gt;<a class="code" href="structfeature__group__exten.html#a57a1afe8e1e8e5f6bc64b77aa363996f">feature</a> = feature;
<a name="l01792"></a>01792 
<a name="l01793"></a>01793    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;fg-&gt;<a class="code" href="structfeature__group.html#a9f496cd6d406637c34b0685e45269921">features</a>, fge, <a class="code" href="structfeature__group__exten.html#a07bbbfd18184d736794fc71e74a381ca">entry</a>);      
<a name="l01794"></a>01794 
<a name="l01795"></a>01795    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Registered feature &apos;%s&apos; for group &apos;%s&apos; at exten &apos;%s&apos;\n&quot;</span>,
<a name="l01796"></a>01796                feature-&gt;<a class="code" href="structast__call__feature.html#a63c4048019f00ef118af9c631c1e7665">sname</a>, fg-&gt;<a class="code" href="structfeature__group.html#ac9e941f7772e1e0c1e1a4b4691d6184e">gname</a>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l01797"></a>01797 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2b1a39d793bfb9bde86eaddf9e901885"></a><!-- doxytag: member="features.c::remap_feature" ref="a2b1a39d793bfb9bde86eaddf9e901885" args="(const char *name, const char *value)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int remap_feature </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>value</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01970">1970</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="lock_8h_source.html#l01827">ast_rwlock_wrlock()</a>, <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, and <a class="el" href="features_8c_source.html#l01695">features_lock</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01971"></a>01971 {
<a name="l01972"></a>01972    <span class="keywordtype">int</span> x, res = -1;
<a name="l01973"></a>01973 
<a name="l01974"></a>01974    <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l01975"></a>01975    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; x++) {
<a name="l01976"></a>01976       <span class="keywordflow">if</span> (strcasecmp(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].sname, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>))
<a name="l01977"></a>01977          <span class="keywordflow">continue</span>;
<a name="l01978"></a>01978 
<a name="l01979"></a>01979       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, value, <span class="keyword">sizeof</span>(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].exten));
<a name="l01980"></a>01980       res = 0;
<a name="l01981"></a>01981       <span class="keywordflow">break</span>;
<a name="l01982"></a>01982    }
<a name="l01983"></a>01983    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l01984"></a>01984 
<a name="l01985"></a>01985    <span class="keywordflow">return</span> res;
<a name="l01986"></a>01986 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aebf26a3de75e83d0137e596d85522436"></a><!-- doxytag: member="features.c::set_bridge_features_on_config" ref="aebf26a3de75e83d0137e596d85522436" args="(struct ast_bridge_config *config, const char *features)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void set_bridge_features_on_config </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>features</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l02342">2342</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l00580">AST_FEATURE_AUTOMON</a>, <a class="el" href="channel_8h_source.html#l00578">AST_FEATURE_DISCONNECT</a>, <a class="el" href="channel_8h_source.html#l00581">AST_FEATURE_PARKCALL</a>, <a class="el" href="channel_8h_source.html#l00577">AST_FEATURE_REDIRECT</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, and <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02343"></a>02343 {
<a name="l02344"></a>02344    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structfeature__group__exten.html#a57a1afe8e1e8e5f6bc64b77aa363996f">feature</a>;
<a name="l02345"></a>02345 
<a name="l02346"></a>02346    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(features)) {
<a name="l02347"></a>02347       <span class="keywordflow">return</span>;
<a name="l02348"></a>02348    }
<a name="l02349"></a>02349 
<a name="l02350"></a>02350    <span class="keywordflow">for</span> (feature = features; *feature; feature++) {
<a name="l02351"></a>02351       <span class="keywordflow">switch</span> (*feature) {
<a name="l02352"></a>02352       <span class="keywordflow">case</span> <span class="charliteral">&apos;T&apos;</span> :
<a name="l02353"></a>02353       <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span> :
<a name="l02354"></a>02354          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93a33e339fbf78c26377f6c7057dda06ccc">AST_FEATURE_REDIRECT</a>);
<a name="l02355"></a>02355          <span class="keywordflow">break</span>;
<a name="l02356"></a>02356       <span class="keywordflow">case</span> <span class="charliteral">&apos;K&apos;</span> :
<a name="l02357"></a>02357       <span class="keywordflow">case</span> <span class="charliteral">&apos;k&apos;</span> :
<a name="l02358"></a>02358          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ace68898ce2f86298d8e39e0473a55e28">AST_FEATURE_PARKCALL</a>);
<a name="l02359"></a>02359          <span class="keywordflow">break</span>;
<a name="l02360"></a>02360       <span class="keywordflow">case</span> <span class="charliteral">&apos;H&apos;</span> :
<a name="l02361"></a>02361       <span class="keywordflow">case</span> <span class="charliteral">&apos;h&apos;</span> :
<a name="l02362"></a>02362          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae4ef6bff70f5837c4ccfcef8d789a9cc">AST_FEATURE_DISCONNECT</a>);
<a name="l02363"></a>02363          <span class="keywordflow">break</span>;
<a name="l02364"></a>02364       <span class="keywordflow">case</span> <span class="charliteral">&apos;W&apos;</span> :
<a name="l02365"></a>02365       <span class="keywordflow">case</span> <span class="charliteral">&apos;w&apos;</span> :
<a name="l02366"></a>02366          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="channel_8h.html#a7495a48740c9d555f7fbcb48246dbd93ae16218a9dfb2123d391f959e3d078362">AST_FEATURE_AUTOMON</a>);
<a name="l02367"></a>02367          <span class="keywordflow">break</span>;
<a name="l02368"></a>02368       <span class="keywordflow">default</span> :
<a name="l02369"></a>02369          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Skipping unknown feature code &apos;%c&apos;\n&quot;</span>, *feature);
<a name="l02370"></a>02370       }
<a name="l02371"></a>02371    }
<a name="l02372"></a>02372 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa1863982006a2c87e09556807d2d4a7c"></a><!-- doxytag: member="features.c::set_c_e_p" ref="aa1863982006a2c87e09556807d2d4a7c" args="(struct ast_channel *chan, const char *context, const char *ext, int pri)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void set_c_e_p </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>ext</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>pri</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>store context, <a class="el" href="structextension.html">extension</a> and priority </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan,context,ext,pri</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00351">351</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="channel_8h_source.html#l00503">ast_channel::context</a>, <a class="el" href="channel_8h_source.html#l00504">ast_channel::exten</a>, and <a class="el" href="channel_8h_source.html#l00471">ast_channel::priority</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>, <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>, and <a class="el" href="features_8c_source.html#l00833">masq_park_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00352"></a>00352 {
<a name="l00353"></a>00353    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l00354"></a>00354    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l00355"></a>00355    chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = pri;
<a name="l00356"></a>00356 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ae6d5d03f4835d75bcc1fbc119c646ddb"></a><!-- doxytag: member="features.c::set_config_flags" ref="ae6d5d03f4835d75bcc1fbc119c646ddb" args="(struct ast_channel *chan, struct ast_channel *peer, struct ast_bridge_config *config)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void set_config_flags </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__bridge__config.html">ast_bridge_config</a> *&nbsp;</td>
          <td class="paramname"> <em>config</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l02099">2099</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="channel_8h_source.html#l01370">AST_BRIDGE_DTMF_CHANNEL_0</a>, <a class="el" href="channel_8h_source.html#l01372">AST_BRIDGE_DTMF_CHANNEL_1</a>, <a class="el" href="utils_8h_source.html#l00075">ast_clear_flag</a>, <a class="el" href="features_8h_source.html#l00045">AST_FEATURE_FLAG_BYCALLEE</a>, <a class="el" href="features_8h_source.html#l00046">AST_FEATURE_FLAG_BYCALLER</a>, <a class="el" href="features_8h_source.html#l00042">AST_FEATURE_FLAG_NEEDSDTMF</a>, <a class="el" href="utils_8h_source.html#l00194">AST_FLAGS_ALL</a>, <a class="el" href="linkedlists_8h_source.html#l00077">AST_RWLIST_RDLOCK</a>, <a class="el" href="linkedlists_8h_source.html#l00150">AST_RWLIST_UNLOCK</a>, <a class="el" href="lock_8h_source.html#l01796">ast_rwlock_rdlock()</a>, <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="utils_8h_source.html#l00068">ast_set_flag</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="utils_8h_source.html#l00061">ast_test_flag</a>, <a class="el" href="features_8h_source.html#l00051">ast_call_feature::feature_mask</a>, <a class="el" href="channel_8h_source.html#l00590">ast_bridge_config::features_callee</a>, <a class="el" href="channel_8h_source.html#l00589">ast_bridge_config::features_caller</a>, <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, <a class="el" href="features_8c_source.html#l01695">features_lock</a>, <a class="el" href="features_8c_source.html#l01825">find_dynamic_feature()</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, and <a class="el" href="agi_2strcompat_8c_source.html#l00027">strsep()</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l02100"></a>02100 {
<a name="l02101"></a>02101    <span class="keywordtype">int</span> x;
<a name="l02102"></a>02102    
<a name="l02103"></a>02103    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(config, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02104"></a>02104 
<a name="l02105"></a>02105    <a class="code" href="lock_8h.html#ae6703edce409c34119e27bdca1186d10">ast_rwlock_rdlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l02106"></a>02106    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; x++) {
<a name="l02107"></a>02107       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a> + x, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca7e260a8ce4ea1f7036380328a503f417">AST_FEATURE_FLAG_NEEDSDTMF</a>))
<a name="l02108"></a>02108          <span class="keywordflow">continue</span>;
<a name="l02109"></a>02109 
<a name="l02110"></a>02110       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#aa9510db9c5a776dfbd1aaab8c48970f0">features_caller</a>), <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="structast__call__feature.html#a69ae95a08c37b66001d216204e241676">feature_mask</a>))
<a name="l02111"></a>02111          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a>);
<a name="l02112"></a>02112 
<a name="l02113"></a>02113       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;(config-&gt;<a class="code" href="structast__bridge__config.html#a725b051d26c3350f8cd04467b4202c60">features_callee</a>), <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="structast__call__feature.html#a69ae95a08c37b66001d216204e241676">feature_mask</a>))
<a name="l02114"></a>02114          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>);
<a name="l02115"></a>02115    }
<a name="l02116"></a>02116    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l02117"></a>02117    
<a name="l02118"></a>02118    <span class="keywordflow">if</span> (chan &amp;&amp; peer &amp;&amp; !(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(config, <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a>) &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(config, <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>))) {
<a name="l02119"></a>02119       <span class="keyword">const</span> <span class="keywordtype">char</span> *dynamic_features = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;DYNAMIC_FEATURES&quot;</span>);
<a name="l02120"></a>02120 
<a name="l02121"></a>02121       <span class="keywordflow">if</span> (dynamic_features) {
<a name="l02122"></a>02122          <span class="keywordtype">char</span> *tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(dynamic_features);
<a name="l02123"></a>02123          <span class="keywordtype">char</span> *tok;
<a name="l02124"></a>02124          <span class="keyword">struct </span><a class="code" href="structast__call__feature.html">ast_call_feature</a> *feature;
<a name="l02125"></a>02125 
<a name="l02126"></a>02126          <span class="comment">/* while we have a feature */</span>
<a name="l02127"></a>02127          <span class="keywordflow">while</span> ((tok = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp, <span class="stringliteral">&quot;#&quot;</span>))) {
<a name="l02128"></a>02128             <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l02129"></a>02129             <span class="keywordflow">if</span> ((feature = <a class="code" href="features_8c.html#a0109970dc3ef884910b9dc1a5fede2e7" title="find a call feature by name">find_dynamic_feature</a>(tok)) &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca7e260a8ce4ea1f7036380328a503f417">AST_FEATURE_FLAG_NEEDSDTMF</a>)) {
<a name="l02130"></a>02130                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1ca56f450ad592f4fe14a2619bd13a5c62e">AST_FEATURE_FLAG_BYCALLER</a>))
<a name="l02131"></a>02131                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a>);
<a name="l02132"></a>02132                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(feature, <a class="code" href="features_8h.html#a1f3b6c692395e5007ff47ce5d9304c1cafbc6e73e751f0075b505a5fbdec63056">AST_FEATURE_FLAG_BYCALLEE</a>))
<a name="l02133"></a>02133                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(config, <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>);
<a name="l02134"></a>02134             }
<a name="l02135"></a>02135             <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structfeature__list.html">feature_list</a>);
<a name="l02136"></a>02136          }
<a name="l02137"></a>02137       }
<a name="l02138"></a>02138    }
<a name="l02139"></a>02139 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a130d6c414eebccdc195fa893b47be865"></a><!-- doxytag: member="features.c::set_peers" ref="a130d6c414eebccdc195fa893b47be865" args="(struct ast_channel **caller, struct ast_channel **callee, struct ast_channel *peer, struct ast_channel *chan, int sense)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void set_peers </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> **&nbsp;</td>
          <td class="paramname"> <em>caller</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> **&nbsp;</td>
          <td class="paramname"> <em>callee</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>peer</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>sense</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>set caller and callee according to the direction </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>caller,callee,peer,chan,sense</em>&nbsp;</td><td>Detect who triggered feature and set callee/caller variables accordingly </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="features_8c_source.html#l00918">918</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="features_8c_source.html#l00910">FEATURE_SENSE_PEER</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, <a class="el" href="features_8c_source.html#l01105">builtin_automixmonitor()</a>, <a class="el" href="features_8c_source.html#l01012">builtin_automonitor()</a>, <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>, and <a class="el" href="features_8c_source.html#l00942">builtin_parkcall()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00920"></a>00920 {
<a name="l00921"></a>00921    <span class="keywordflow">if</span> (sense == <a class="code" href="features_8c.html#a715d6b99230466c16f14e1d0fa77ffac">FEATURE_SENSE_PEER</a>) {
<a name="l00922"></a>00922       *caller = peer;
<a name="l00923"></a>00923       *callee = chan;
<a name="l00924"></a>00924    } <span class="keywordflow">else</span> {
<a name="l00925"></a>00925       *callee = peer;
<a name="l00926"></a>00926       *caller = chan;
<a name="l00927"></a>00927    }
<a name="l00928"></a>00928 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0873e755f478aa3fdcd12ad51a9e9783"></a><!-- doxytag: member="features.c::unmap_features" ref="a0873e755f478aa3fdcd12ad51a9e9783" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void unmap_features </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01960">1960</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01791">ast_rwlock_unlock()</a>, <a class="el" href="lock_8h_source.html#l01827">ast_rwlock_wrlock()</a>, <a class="el" href="features_8c_source.html#l01693">FEATURES_COUNT</a>, and <a class="el" href="features_8c_source.html#l01695">features_lock</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01961"></a>01961 {
<a name="l01962"></a>01962    <span class="keywordtype">int</span> x;
<a name="l01963"></a>01963 
<a name="l01964"></a>01964    <a class="code" href="lock_8h.html#a952527792bba2a323118ae911f9aa1f7">ast_rwlock_wrlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l01965"></a>01965    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="features_8c.html#a6b4ef6d37a4790e15ce87945840cc350">FEATURES_COUNT</a>; x++)
<a name="l01966"></a>01966       strcpy(<a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[x].<a class="code" href="structast__call__feature.html#ab7ea20080a7609ed36233a0aa3f4f42f">default_exten</a>);
<a name="l01967"></a>01967    <a class="code" href="lock_8h.html#a21ce13cd6c771d5855f47ae7a1dd50b6">ast_rwlock_unlock</a>(&amp;<a class="code" href="features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a>);
<a name="l01968"></a>01968 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="a644feb4e8d3f7dcd077c7c7321af8d5a"></a><!-- doxytag: member="features.c::adsipark" ref="a644feb4e8d3f7dcd077c7c7321af8d5a" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a644feb4e8d3f7dcd077c7c7321af8d5a">adsipark</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00248">248</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>, and <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>.</p>

</div>
</div>
<a class="anchor" id="a30cf144e208ddc17e51b2f1e600052e8"></a><!-- doxytag: member="features.c::app_bridge" ref="a30cf144e208ddc17e51b2f1e600052e8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="res__features_8c.html#a30cf144e208ddc17e51b2f1e600052e8">app_bridge</a> = &quot;Bridge&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l04505">4505</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="a42aaa9bbb76f30a8d697eb7c79901045"></a><!-- doxytag: member="features.c::atxfercallbackretries" ref="a42aaa9bbb76f30a8d697eb7c79901045" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int <a class="el" href="res__features_8c.html#a42aaa9bbb76f30a8d697eb7c79901045">atxfercallbackretries</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00257">257</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a3a4aff3656629deadbb2294abb1b2e50"></a><!-- doxytag: member="features.c::atxferdropcall" ref="a3a4aff3656629deadbb2294abb1b2e50" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int <a class="el" href="res__features_8c.html#a3a4aff3656629deadbb2294abb1b2e50">atxferdropcall</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00255">255</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="ae20cac4cd972474f3ce8efd3be64ca8d"></a><!-- doxytag: member="features.c::atxferloopdelay" ref="ae20cac4cd972474f3ce8efd3be64ca8d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">unsigned int <a class="el" href="res__features_8c.html#ae20cac4cd972474f3ce8efd3be64ca8d">atxferloopdelay</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00256">256</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a7322bc7373f8fafaa70eaf4ed6d84095"></a><!-- doxytag: member="features.c::atxfernoanswertimeout" ref="a7322bc7373f8fafaa70eaf4ed6d84095" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a7322bc7373f8fafaa70eaf4ed6d84095">atxfernoanswertimeout</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00254">254</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a217d93bf8d70c1b07dcc8aa6380cfae9"></a><!-- doxytag: member="features.c::bridge_exec_options" ref="a217d93bf8d70c1b07dcc8aa6380cfae9" args="[128]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__app__option.html">ast_app_option</a> <a class="el" href="res__features_8c.html#a217d93bf8d70c1b07dcc8aa6380cfae9">bridge_exec_options</a>[128] = { [ 'p' ] = { .flag = BRIDGE_OPT_PLAYTONE } }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l04513">4513</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04524">bridge_exec()</a>.</p>

</div>
</div>
<a class="anchor" id="a51fb76347e22614ff1495de1af0c5e62"></a><!-- doxytag: member="features.c::builtin_features" ref="a51fb76347e22614ff1495de1af0c5e62" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__call__feature.html">ast_call_feature</a> <a class="el" href="res__features_8c.html#a51fb76347e22614ff1495de1af0c5e62">builtin_features</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01697">1697</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="a53d8f03eb64267f168b7a966a64915f8"></a><!-- doxytag: member="features.c::cli_features" ref="a53d8f03eb64267f168b7a966a64915f8" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__cli__entry.html">ast_cli_entry</a> <a class="el" href="res__features_8c.html#a53d8f03eb64267f168b7a966a64915f8">cli_features</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="features_8c.html#a39926b835e958ba09edbb2cb21a09f6a" title="CLI command to list configured features.">handle_feature_show</a>, <span class="stringliteral">&quot;Lists configured features&quot;</span>),
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="features_8c.html#a6d6f533532d3168968124e360ad9a935">handle_features_reload</a>, <span class="stringliteral">&quot;Reloads configured features&quot;</span>),
   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="features_8c.html#a4b52dc88a4201cfae82e106c4b6e4079" title="CLI command to list parked calls.">handle_parkedcalls</a>, <span class="stringliteral">&quot;List currently parked calls&quot;</span>),
}
</pre></div>
<p>Definition at line <a class="el" href="features_8c_source.html#l04326">4326</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="a1788f4d16d98aa5348dffa550d2632b2"></a><!-- doxytag: member="features.c::comebacktoorigin" ref="a1788f4d16d98aa5348dffa550d2632b2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a1788f4d16d98aa5348dffa550d2632b2">comebacktoorigin</a> = 1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00252">252</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>, and <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>.</p>

</div>
</div>
<a class="anchor" id="a19a68bcbf3e81baacfd350c97d4f56ed"></a><!-- doxytag: member="features.c::courtesytone" ref="a19a68bcbf3e81baacfd350c97d4f56ed" args="[256]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#a19a68bcbf3e81baacfd350c97d4f56ed">courtesytone</a>[256]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Courtesy tone </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00241">241</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01105">builtin_automixmonitor()</a>, <a class="el" href="features_8c_source.html#l01012">builtin_automonitor()</a>, <a class="el" href="features_8c_source.html#l03672">load_config()</a>, and <a class="el" href="features_8c_source.html#l03335">park_exec_full()</a>.</p>

</div>
</div>
<a class="anchor" id="ab0ae9c20e04fb84e78d7596559c33b11"></a><!-- doxytag: member="features.c::default_parkinglot" ref="ab0ae9c20e04fb84e78d7596559c33b11" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__parkinglot.html">ast_parkinglot</a>* <a class="el" href="res__features_8c.html#ab0ae9c20e04fb84e78d7596559c33b11">default_parkinglot</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00238">238</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="af00ad0f87f5a9d412bb456cf3766404f"></a><!-- doxytag: member="features.c::dial_features_info" ref="af00ad0f87f5a9d412bb456cf3766404f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__datastore__info.html">ast_datastore_info</a> <a class="el" href="res__features_8c.html#af00ad0f87f5a9d412bb456cf3766404f">dial_features_info</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   .type = <span class="stringliteral">&quot;dial-features&quot;</span>,
   .destroy = <a class="code" href="features_8c.html#a1f3c786719a3735242e22d86b1ce4f08">dial_features_destroy</a>,
   .duplicate = <a class="code" href="features_8c.html#adef8fadeae29c7bd0b0f5133352f636d">dial_features_duplicate</a>,
 }
</pre></div>
<p>Definition at line <a class="el" href="features_8c_source.html#l00301">301</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="res__features_8c_source.html#l02374">add_features_datastores()</a>, <a class="el" href="res__features_8c_source.html#l01396">builtin_atxfer()</a>, <a class="el" href="res__features_8c_source.html#l03009">manage_parkinglot()</a>, and <a class="el" href="res__features_8c_source.html#l03335">park_exec_full()</a>.</p>

</div>
</div>
<a class="anchor" id="a846427c0fcd8e7f387e43b465f74e810"></a><!-- doxytag: member="features.c::featuredigittimeout" ref="a846427c0fcd8e7f387e43b465f74e810" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a846427c0fcd8e7f387e43b465f74e810">featuredigittimeout</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00251">251</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a7ec4971298483245322468cd41fdf103"></a><!-- doxytag: member="features.c::features_lock" ref="a7ec4971298483245322468cd41fdf103" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#af7598796d461f7dcb95cea6be65806f8">ast_rwlock_t</a> <a class="el" href="res__features_8c.html#a7ec4971298483245322468cd41fdf103">features_lock</a> = PTHREAD_RWLOCK_INITIALIZER<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l01695">1695</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01874">ast_rdlock_call_features()</a>, <a class="el" href="features_8c_source.html#l01879">ast_unlock_call_features()</a>, <a class="el" href="features_8c_source.html#l01996">feature_interpret()</a>, <a class="el" href="features_8c_source.html#l02152">feature_request_and_dial()</a>, <a class="el" href="features_8c_source.html#l04019">handle_feature_show()</a>, <a class="el" href="features_8c_source.html#l01970">remap_feature()</a>, <a class="el" href="features_8c_source.html#l02099">set_config_flags()</a>, and <a class="el" href="features_8c_source.html#l01960">unmap_features()</a>.</p>

</div>
</div>
<a class="anchor" id="a88045cf5a2dca0498141f69a5e2d54b3"></a><!-- doxytag: member="features.c::mandescr_bridge" ref="a88045cf5a2dca0498141f69a5e2d54b3" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#a88045cf5a2dca0498141f69a5e2d54b3">mandescr_bridge</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l04110">4110</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab646ce88b1017513554ea26a0d24557b"></a><!-- doxytag: member="features.c::mandescr_park" ref="ab646ce88b1017513554ea26a0d24557b" args="[]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#ab646ce88b1017513554ea26a0d24557b">mandescr_park</a>[]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l04386">4386</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

</div>
</div>
<a class="anchor" id="a863e1104b2f52359385b7764b1f727f4"></a><!-- doxytag: member="features.c::mixmonitor_app" ref="a863e1104b2f52359385b7764b1f727f4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__app.html">ast_app</a>* <a class="el" href="res__features_8c.html#a863e1104b2f52359385b7764b1f727f4">mixmonitor_app</a> = NULL<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00267">267</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01105">builtin_automixmonitor()</a>.</p>

</div>
</div>
<a class="anchor" id="ad76df5fd37675aefb1b43395687d81f5"></a><!-- doxytag: member="features.c::mixmonitor_ok" ref="ad76df5fd37675aefb1b43395687d81f5" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#ad76df5fd37675aefb1b43395687d81f5">mixmonitor_ok</a> = 1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00268">268</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01105">builtin_automixmonitor()</a>.</p>

</div>
</div>
<a class="anchor" id="a1a788862b8ee6dece692ce2b965fbfb3"></a><!-- doxytag: member="features.c::monitor_app" ref="a1a788862b8ee6dece692ce2b965fbfb3" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__app.html">ast_app</a>* <a class="el" href="res__features_8c.html#a1a788862b8ee6dece692ce2b965fbfb3">monitor_app</a> = NULL<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00264">264</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, and <a class="el" href="features_8c_source.html#l01012">builtin_automonitor()</a>.</p>

</div>
</div>
<a class="anchor" id="a31438b92e816fd5c5b858f7424205aaa"></a><!-- doxytag: member="features.c::monitor_ok" ref="a31438b92e816fd5c5b858f7424205aaa" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a31438b92e816fd5c5b858f7424205aaa">monitor_ok</a> = 1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00265">265</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l02441">ast_bridge_call()</a>, and <a class="el" href="features_8c_source.html#l01012">builtin_automonitor()</a>.</p>

</div>
</div>
<a class="anchor" id="a9e1a57d86c3bd004f9a9a32f90cfb1f5"></a><!-- doxytag: member="features.c::park_call_options" ref="a9e1a57d86c3bd004f9a9a32f90cfb1f5" args="[128]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__app__option.html">ast_app_option</a> <a class="el" href="res__features_8c.html#a9e1a57d86c3bd004f9a9a32f90cfb1f5">park_call_options</a>[128] = { [ 'r' ] = { .flag = AST_PARK_OPT_RINGING }, [ 'R' ] = { .flag = AST_PARK_OPT_RANDOMIZE }, [ 's' ] = { .flag = AST_PARK_OPT_SILENCE }, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l03246">3246</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03249">park_call_exec()</a>.</p>

</div>
</div>
<a class="anchor" id="ac3950a3179488304a97d02de9488c205"></a><!-- doxytag: member="features.c::parkcall" ref="ac3950a3179488304a97d02de9488c205" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="res__features_8c.html#ac3950a3179488304a97d02de9488c205">parkcall</a> = PARK_APP_NAME<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00262">262</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>, <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a45fde2767ab498a74ee0edc3fa3c3dbf"></a><!-- doxytag: member="features.c::parkedcall" ref="a45fde2767ab498a74ee0edc3fa3c3dbf" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="res__features_8c.html#a45fde2767ab498a74ee0edc3fa3c3dbf">parkedcall</a> = &quot;ParkedCall&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00192">192</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>, and <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>.</p>

</div>
</div>
<a class="anchor" id="a6c83f6bb528d1bb02f8d54996b2de0a9"></a><!-- doxytag: member="features.c::parkedplay" ref="a6c83f6bb528d1bb02f8d54996b2de0a9" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a6c83f6bb528d1bb02f8d54996b2de0a9">parkedplay</a> = 0<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Who to play the courtesy tone to </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00242">242</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03672">load_config()</a>, and <a class="el" href="features_8c_source.html#l03335">park_exec_full()</a>.</p>

</div>
</div>
<a class="anchor" id="aab2f16f83e13b9eeac2c69a864d877ed"></a><!-- doxytag: member="features.c::parking_ext" ref="aab2f16f83e13b9eeac2c69a864d877ed" args="[AST_MAX_EXTENSION]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#aab2f16f83e13b9eeac2c69a864d877ed">parking_ext</a>[AST_MAX_EXTENSION]</td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Extension you type to park the call </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00239">239</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00315">ast_parking_ext()</a>, <a class="el" href="features_8c_source.html#l04019">handle_feature_show()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="ac66fb87ae86fa37b36fa78286c237fd2"></a><!-- doxytag: member="features.c::parking_thread" ref="ac66fb87ae86fa37b36fa78286c237fd2" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">pthread_t <a class="el" href="res__features_8c.html#ac66fb87ae86fa37b36fa78286c237fd2">parking_thread</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00273">273</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>, and <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>.</p>

</div>
</div>
<a class="anchor" id="ad1dd6c1dd542a6e34c68a1c5c5d40509"></a><!-- doxytag: member="features.c::parkinglots" ref="ad1dd6c1dd542a6e34c68a1c5c5d40509" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structao2__container.html">ao2_container</a>* <a class="el" href="res__features_8c.html#ad1dd6c1dd542a6e34c68a1c5c5d40509">parkinglots</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The list of parking lots configured. Always at least one - the default parking lot. </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00236">236</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04642">ast_features_init()</a>, <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, <a class="el" href="features_8c_source.html#l03189">do_parking_thread()</a>, <a class="el" href="features_8c_source.html#l03224">find_parkinglot()</a>, <a class="el" href="features_8c_source.html#l04019">handle_feature_show()</a>, <a class="el" href="features_8c_source.html#l04276">handle_parkedcalls()</a>, <a class="el" href="features_8c_source.html#l04340">manager_parking_status()</a>, and <a class="el" href="features_8c_source.html#l03543">parkinglot_destroy()</a>.</p>

</div>
</div>
<a class="anchor" id="a7af3a76f3f29d5a21be63ef43f89840e"></a><!-- doxytag: member="features.c::pickup_ext" ref="a7af3a76f3f29d5a21be63ef43f89840e" args="[AST_MAX_EXTENSION]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#a7af3a76f3f29d5a21be63ef43f89840e">pickup_ext</a>[AST_MAX_EXTENSION]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Call pickup <a class="el" href="structextension.html">extension</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00194">194</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l00320">ast_pickup_ext()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="accc7698698a0f2d7c9cf718fd88b35bd"></a><!-- doxytag: member="features.c::pickupfailsound" ref="accc7698698a0f2d7c9cf718fd88b35bd" args="[256]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#accc7698698a0f2d7c9cf718fd88b35bd">pickupfailsound</a>[256]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Pickup failure <a class="el" href="structsound.html">sound</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00246">246</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04475">ast_pickup_call()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a584b06b24c055eed20fe7e1e32f577f5"></a><!-- doxytag: member="features.c::pickupsound" ref="a584b06b24c055eed20fe7e1e32f577f5" args="[256]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#a584b06b24c055eed20fe7e1e32f577f5">pickupsound</a>[256]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Pickup <a class="el" href="structsound.html">sound</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00245">245</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04475">ast_pickup_call()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="ab990a3529ebde2681a00468cad7c0b48"></a><!-- doxytag: member="features.c::registrar" ref="ab990a3529ebde2681a00468cad7c0b48" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="pval_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a> = &quot;features&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Registrar for operations </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00259">259</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l03554">build_parkinglot()</a>, <a class="el" href="features_8c_source.html#l03672">load_config()</a>, <a class="el" href="features_8c_source.html#l03009">manage_parkinglot()</a>, <a class="el" href="features_8c_source.html#l03659">park_add_hints()</a>, <a class="el" href="features_8c_source.html#l00678">park_call_full()</a>, and <a class="el" href="features_8c_source.html#l03543">parkinglot_destroy()</a>.</p>

</div>
</div>
<a class="anchor" id="a6e92ba0da6795c93b26c0e839fb4687e"></a><!-- doxytag: member="features.c::stopmixmonitor_app" ref="a6e92ba0da6795c93b26c0e839fb4687e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__app.html">ast_app</a>* <a class="el" href="res__features_8c.html#a6e92ba0da6795c93b26c0e839fb4687e">stopmixmonitor_app</a> = NULL<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00270">270</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01105">builtin_automixmonitor()</a>.</p>

</div>
</div>
<a class="anchor" id="a76d9bec7d89bd468e2af244893c23c3e"></a><!-- doxytag: member="features.c::stopmixmonitor_ok" ref="a76d9bec7d89bd468e2af244893c23c3e" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#a76d9bec7d89bd468e2af244893c23c3e">stopmixmonitor_ok</a> = 1<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00271">271</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01105">builtin_automixmonitor()</a>.</p>

</div>
</div>
<a class="anchor" id="ac9e9135177b3720ea1306530670e294b"></a><!-- doxytag: member="features.c::transferdigittimeout" ref="ac9e9135177b3720ea1306530670e294b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int <a class="el" href="res__features_8c.html#ac9e9135177b3720ea1306530670e294b">transferdigittimeout</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="features_8c_source.html#l00250">250</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="a320b9238b63823008e79196f81756ebb"></a><!-- doxytag: member="features.c::xferfailsound" ref="a320b9238b63823008e79196f81756ebb" args="[256]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#a320b9238b63823008e79196f81756ebb">xferfailsound</a>[256]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Call transfer failure <a class="el" href="structsound.html">sound</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00244">244</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, <a class="el" href="features_8c_source.html#l01265">builtin_blindtransfer()</a>, and <a class="el" href="features_8c_source.html#l03672">load_config()</a>.</p>

</div>
</div>
<a class="anchor" id="affed126bd81bdb7a12ee166ae870c38e"></a><!-- doxytag: member="features.c::xfersound" ref="affed126bd81bdb7a12ee166ae870c38e" args="[256]" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char <a class="el" href="res__features_8c.html#affed126bd81bdb7a12ee166ae870c38e">xfersound</a>[256]<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<p>Call transfer <a class="el" href="structsound.html">sound</a> </p>

<p>Definition at line <a class="el" href="features_8c_source.html#l00243">243</a> of file <a class="el" href="features_8c_source.html">features.c</a>.</p>

<p>Referenced by <a class="el" href="features_8c_source.html#l04156">action_bridge()</a>, <a class="el" href="features_8c_source.html#l04524">bridge_exec()</a>, <a class="el" href="features_8c_source.html#l01396">builtin_atxfer()</a>, <a class="el" href="features_8c_source.html#l03672">load_config()</a>, and <a class="el" href="chan__sip_8c_source.html#l20405">local_attended_transfer()</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:22:05 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
