<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:31 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_0ca6ff3bf6b340411b2c6edd15b1a34d.html">channels</a>
  </div>
</div>
<div class="contents">
<h1>chan_iax2.c</h1><a href="chan__iax2_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Implementation of Inter-Asterisk eXchange Version 2</span>
<a name="l00022"></a>00022 <span class="comment"> *        as specified in RFC 5456</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * \par See also</span>
<a name="l00027"></a>00027 <span class="comment"> * \arg \ref Config_iax</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * \ingroup channel_drivers</span>
<a name="l00030"></a>00030 <span class="comment"> * </span>
<a name="l00031"></a>00031 <span class="comment"> * \todo Implement musicclass settings for IAX2 devices</span>
<a name="l00032"></a>00032 <span class="comment"> */</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <span class="comment">/*** MODULEINFO</span>
<a name="l00035"></a>00035 <span class="comment">   &lt;use&gt;crypto&lt;/use&gt;</span>
<a name="l00036"></a>00036 <span class="comment"> ***/</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 250396 $&quot;</span>)
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &lt;netinet/in.h&gt;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &lt;arpa/inet.h&gt;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &lt;netinet/in_systm.h&gt;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &lt;netinet/ip.h&gt;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &lt;<a class="code" href="strings_8h.html" title="String manipulation functions.">strings.h</a>&gt;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &lt;regex.h&gt;</span>
<a name="l00057"></a>00057 
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>   <span class="comment">/* need ast_config_AST_DATA_DIR for firmware */</span>
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="frame_8h.html" title="Asterisk internal frame definitions.">asterisk/frame.h</a>&quot;</span> 
<a name="l00062"></a>00062 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00065"></a>00065 <span class="preprocessor">#include &quot;<a class="code" href="sched_8h.html" title="Scheduler Routines (derived from cheops).">asterisk/sched.h</a>&quot;</span>
<a name="l00066"></a>00066 <span class="preprocessor">#include &quot;<a class="code" href="io_8h.html" title="I/O Management (derived from Cheops-NG).">asterisk/io.h</a>&quot;</span>
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00068"></a>00068 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00069"></a>00069 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00070"></a>00070 <span class="preprocessor">#include &quot;<a class="code" href="md5_8h.html" title="MD5 digest functions.">asterisk/md5.h</a>&quot;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &quot;<a class="code" href="cdr_8h.html" title="Call Detail Record API.">asterisk/cdr.h</a>&quot;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &quot;<a class="code" href="crypto_8h.html" title="Provide cryptographic signature routines.">asterisk/crypto.h</a>&quot;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#include &quot;<a class="code" href="acl_8h.html" title="Access Control of various sorts.">asterisk/acl.h</a>&quot;</span>
<a name="l00074"></a>00074 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#include &quot;<a class="code" href="astdb_8h.html" title="Persistant data storage (akin to *doze registry).">asterisk/astdb.h</a>&quot;</span>
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &quot;<a class="code" href="features_8h.html" title="Call Parking and Pickup API Includes code and algorithms from the Zapata library...">asterisk/features.h</a>&quot;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00082"></a>00082 <span class="preprocessor">#include &quot;<a class="code" href="localtime_8h.html" title="Custom localtime functions for multiple timezones.">asterisk/localtime.h</a>&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="aes_8h.html">asterisk/aes.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="dnsmgr_8h.html" title="Background DNS update manager.">asterisk/dnsmgr.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="netsock_8h.html" title="Network socket handling.">asterisk/netsock.h</a>&quot;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="event_8h.html">asterisk/event.h</a>&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="timing_8h.html" title="Timing source management.">asterisk/timing.h</a>&quot;</span>
<a name="l00092"></a>00092 
<a name="l00093"></a>00093 <span class="preprocessor">#include &quot;<a class="code" href="iax2_8h.html" title="Implementation of Inter-Asterisk eXchange, version 2 iax2-parser.c iax2-parser.h...">iax2.h</a>&quot;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &quot;<a class="code" href="iax2-parser_8h.html" title="Implementation of the IAX2 protocol.">iax2-parser.h</a>&quot;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &quot;<a class="code" href="iax2-provision_8h.html" title="IAX2 Provisioning protocol.">iax2-provision.h</a>&quot;</span>
<a name="l00096"></a>00096 <span class="preprocessor">#include &quot;<a class="code" href="jitterbuf_8h.html" title="jitterbuf: an application-independent jitterbuffer jitterbuf.c">jitterbuf.h</a>&quot;</span>
<a name="l00097"></a>00097 
<a name="l00098"></a>00098 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00099"></a>00099 <span class="comment">   &lt;application name=&quot;IAX2Provision&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00100"></a>00100 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00101"></a>00101 <span class="comment">         Provision a calling IAXy with a given template.</span>
<a name="l00102"></a>00102 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00103"></a>00103 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00104"></a>00104 <span class="comment">         &lt;parameter name=&quot;template&quot;&gt;</span>
<a name="l00105"></a>00105 <span class="comment">            &lt;para&gt;If not specified, defaults to &lt;literal&gt;default&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00106"></a>00106 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00107"></a>00107 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00108"></a>00108 <span class="comment">      &lt;description&gt;</span>
<a name="l00109"></a>00109 <span class="comment">         &lt;para&gt;Provisions the calling IAXy (assuming the calling entity is in fact an IAXy) with the</span>
<a name="l00110"></a>00110 <span class="comment">         given &lt;replaceable&gt;template&lt;/replaceable&gt;. Returns &lt;literal&gt;-1&lt;/literal&gt; on error</span>
<a name="l00111"></a>00111 <span class="comment">         or &lt;literal&gt;0&lt;/literal&gt; on success.&lt;/para&gt;</span>
<a name="l00112"></a>00112 <span class="comment">      &lt;/description&gt;</span>
<a name="l00113"></a>00113 <span class="comment">   &lt;/application&gt;</span>
<a name="l00114"></a>00114 <span class="comment">   &lt;function name=&quot;IAXPEER&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00115"></a>00115 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00116"></a>00116 <span class="comment">         Gets IAX peer information.</span>
<a name="l00117"></a>00117 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00118"></a>00118 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00119"></a>00119 <span class="comment">         &lt;parameter name=&quot;peername&quot; required=&quot;true&quot;&gt;</span>
<a name="l00120"></a>00120 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00121"></a>00121 <span class="comment">               &lt;enum name=&quot;CURRENTCHANNEL&quot;&gt;</span>
<a name="l00122"></a>00122 <span class="comment">                  &lt;para&gt;If &lt;replaceable&gt;peername&lt;/replaceable&gt; is specified to this value, return the IP address of the</span>
<a name="l00123"></a>00123 <span class="comment">                  endpoint of the current channel&lt;/para&gt;</span>
<a name="l00124"></a>00124 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00125"></a>00125 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00126"></a>00126 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00127"></a>00127 <span class="comment">         &lt;parameter name=&quot;item&quot;&gt;</span>
<a name="l00128"></a>00128 <span class="comment">            &lt;para&gt;If &lt;replaceable&gt;peername&lt;/replaceable&gt; is specified, valid items are:&lt;/para&gt;</span>
<a name="l00129"></a>00129 <span class="comment">            &lt;enumlist&gt;</span>
<a name="l00130"></a>00130 <span class="comment">               &lt;enum name=&quot;ip&quot;&gt;</span>
<a name="l00131"></a>00131 <span class="comment">                  &lt;para&gt;(default) The IP address.&lt;/para&gt;</span>
<a name="l00132"></a>00132 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00133"></a>00133 <span class="comment">               &lt;enum name=&quot;status&quot;&gt;</span>
<a name="l00134"></a>00134 <span class="comment">                  &lt;para&gt;The peer&apos;s status (if &lt;literal&gt;qualify=yes&lt;/literal&gt;)&lt;/para&gt;</span>
<a name="l00135"></a>00135 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00136"></a>00136 <span class="comment">               &lt;enum name=&quot;mailbox&quot;&gt;</span>
<a name="l00137"></a>00137 <span class="comment">                  &lt;para&gt;The configured mailbox.&lt;/para&gt;</span>
<a name="l00138"></a>00138 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00139"></a>00139 <span class="comment">               &lt;enum name=&quot;context&quot;&gt;</span>
<a name="l00140"></a>00140 <span class="comment">                  &lt;para&gt;The configured context.&lt;/para&gt;</span>
<a name="l00141"></a>00141 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00142"></a>00142 <span class="comment">               &lt;enum name=&quot;expire&quot;&gt;</span>
<a name="l00143"></a>00143 <span class="comment">                  &lt;para&gt;The epoch time of the next expire.&lt;/para&gt;</span>
<a name="l00144"></a>00144 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00145"></a>00145 <span class="comment">               &lt;enum name=&quot;dynamic&quot;&gt;</span>
<a name="l00146"></a>00146 <span class="comment">                  &lt;para&gt;Is it dynamic? (yes/no).&lt;/para&gt;</span>
<a name="l00147"></a>00147 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00148"></a>00148 <span class="comment">               &lt;enum name=&quot;callerid_name&quot;&gt;</span>
<a name="l00149"></a>00149 <span class="comment">                  &lt;para&gt;The configured Caller ID name.&lt;/para&gt;</span>
<a name="l00150"></a>00150 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00151"></a>00151 <span class="comment">               &lt;enum name=&quot;callerid_num&quot;&gt;</span>
<a name="l00152"></a>00152 <span class="comment">                  &lt;para&gt;The configured Caller ID number.&lt;/para&gt;</span>
<a name="l00153"></a>00153 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00154"></a>00154 <span class="comment">               &lt;enum name=&quot;codecs&quot;&gt;</span>
<a name="l00155"></a>00155 <span class="comment">                  &lt;para&gt;The configured codecs.&lt;/para&gt;</span>
<a name="l00156"></a>00156 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00157"></a>00157 <span class="comment">               &lt;enum name=&quot;codec[x]&quot;&gt;</span>
<a name="l00158"></a>00158 <span class="comment">                  &lt;para&gt;Preferred codec index number &lt;replaceable&gt;x&lt;/replaceable&gt; (beginning</span>
<a name="l00159"></a>00159 <span class="comment">                  with &lt;literal&gt;0&lt;/literal&gt;)&lt;/para&gt;</span>
<a name="l00160"></a>00160 <span class="comment">               &lt;/enum&gt;</span>
<a name="l00161"></a>00161 <span class="comment">            &lt;/enumlist&gt;</span>
<a name="l00162"></a>00162 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00163"></a>00163 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00164"></a>00164 <span class="comment">      &lt;description /&gt;</span>
<a name="l00165"></a>00165 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00166"></a>00166 <span class="comment">         &lt;ref type=&quot;function&quot;&gt;SIPPEER&lt;/ref&gt;</span>
<a name="l00167"></a>00167 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00168"></a>00168 <span class="comment">   &lt;/function&gt;</span>
<a name="l00169"></a>00169 <span class="comment">   &lt;function name=&quot;IAXVAR&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00170"></a>00170 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00171"></a>00171 <span class="comment">         Sets or retrieves a remote variable.</span>
<a name="l00172"></a>00172 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00173"></a>00173 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00174"></a>00174 <span class="comment">         &lt;parameter name=&quot;varname&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00175"></a>00175 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00176"></a>00176 <span class="comment">      &lt;description /&gt;</span>
<a name="l00177"></a>00177 <span class="comment">   &lt;/function&gt;</span>
<a name="l00178"></a>00178 <span class="comment"> ***/</span>
<a name="l00179"></a>00179 
<a name="l00180"></a>00180 <span class="comment">/* Define SCHED_MULTITHREADED to run the scheduler in a special</span>
<a name="l00181"></a>00181 <span class="comment">   multithreaded mode. */</span>
<a name="l00182"></a><a class="code" href="chan__iax2_8c.html#ac5718877405aa99f399bc41054f8c0a0">00182</a> <span class="preprocessor">#define SCHED_MULTITHREADED</span>
<a name="l00183"></a>00183 <span class="preprocessor"></span>
<a name="l00184"></a>00184 <span class="comment">/* Define DEBUG_SCHED_MULTITHREADED to keep track of where each</span>
<a name="l00185"></a>00185 <span class="comment">   thread is actually doing. */</span>
<a name="l00186"></a><a class="code" href="chan__iax2_8c.html#a467d9044fba43937821996a2d11d3894">00186</a> <span class="preprocessor">#define DEBUG_SCHED_MULTITHREAD</span>
<a name="l00187"></a>00187 <span class="preprocessor"></span>
<a name="l00188"></a>00188 
<a name="l00189"></a>00189 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> nochecksums = 0;
<a name="l00191"></a>00191 <span class="preprocessor">#endif</span>
<a name="l00192"></a>00192 <span class="preprocessor"></span>
<a name="l00193"></a><a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">00193</a> <span class="preprocessor">#define PTR_TO_CALLNO(a) ((unsigned short)(unsigned long)(a))</span>
<a name="l00194"></a><a class="code" href="chan__iax2_8c.html#a7510329b1cbee3d732b54d94586a975c">00194</a> <span class="preprocessor"></span><span class="preprocessor">#define CALLNO_TO_PTR(a) ((void *)(unsigned long)(a))</span>
<a name="l00195"></a>00195 <span class="preprocessor"></span>
<a name="l00196"></a><a class="code" href="chan__iax2_8c.html#ac9e94064e8ce15d44ef2b94289b1548b">00196</a> <span class="preprocessor">#define DEFAULT_THREAD_COUNT 10</span>
<a name="l00197"></a><a class="code" href="chan__iax2_8c.html#a3481fc1249cbdfd59881c41542b7c687">00197</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_MAX_THREAD_COUNT 100</span>
<a name="l00198"></a><a class="code" href="chan__iax2_8c.html#aa3f7ad7d609f71fde68e79f9a7a478f2">00198</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_RETRY_TIME 1000</span>
<a name="l00199"></a><a class="code" href="chan__iax2_8c.html#a5ad3f75a4e38fd9bbed917c71ca4e9e0">00199</a> <span class="preprocessor"></span><span class="preprocessor">#define MEMORY_SIZE 100</span>
<a name="l00200"></a><a class="code" href="chan__iax2_8c.html#ada001ee4237bb2559b95045b4d4a6317">00200</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_DROP 3</span>
<a name="l00201"></a>00201 <span class="preprocessor"></span>
<a name="l00202"></a><a class="code" href="chan__iax2_8c.html#a6ca67891dca25d0ed322bc20faf14711">00202</a> <span class="preprocessor">#define DEBUG_SUPPORT</span>
<a name="l00203"></a>00203 <span class="preprocessor"></span>
<a name="l00204"></a><a class="code" href="chan__iax2_8c.html#acf1617df6e6203c6c0d87b5ff53e61dc">00204</a> <span class="preprocessor">#define MIN_REUSE_TIME     60 </span><span class="comment">/* Don&apos;t reuse a call number within 60 seconds */</span>
<a name="l00205"></a>00205 
<a name="l00206"></a>00206 <span class="comment">/* Sample over last 100 units to determine historic jitter */</span>
<a name="l00207"></a><a class="code" href="chan__iax2_8c.html#a8659b9de3e544ff142b153b076f30fd5">00207</a> <span class="preprocessor">#define GAMMA (0.01)</span>
<a name="l00208"></a>00208 <span class="preprocessor"></span>
<a name="l00209"></a><a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">00209</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l00210"></a>00210 
<a name="l00211"></a><a class="code" href="chan__iax2_8c.html#a71535bf985a1a06d548fd73a0a0ec32c">00211</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">tdesc</a>[] = <span class="stringliteral">&quot;Inter Asterisk eXchange Driver (Ver 2)&quot;</span>;
<a name="l00212"></a>00212 
<a name="l00213"></a>00213 <span class="comment"></span>
<a name="l00214"></a>00214 <span class="comment">/*! \brief Maximum transmission unit for the UDP packet in the trunk not to be</span>
<a name="l00215"></a>00215 <span class="comment">    fragmented. This is based on 1516 - ethernet - ip - udp - iax minus one g711 frame = 1240 */</span>
<a name="l00216"></a><a class="code" href="chan__iax2_8c.html#a48a4382bfd50a02e75939c5ac05e25eb">00216</a> <span class="preprocessor">#define MAX_TRUNK_MTU 1240 </span>
<a name="l00217"></a>00217 <span class="preprocessor"></span>
<a name="l00218"></a><a class="code" href="chan__iax2_8c.html#aff6ebe491ce1d1af7727317c0c33f09d">00218</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aff6ebe491ce1d1af7727317c0c33f09d">global_max_trunk_mtu</a>;    <span class="comment">/*!&lt; Maximum MTU, 0 if not used */</span>
<a name="l00219"></a><a class="code" href="chan__iax2_8c.html#a460c44a211f49e6fe66fd7c1e93ec272">00219</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#abe1b2019c626d92db9962cdcb6787eb0">trunk_timed</a>, <a class="code" href="chan__iax2_8c.html#a460c44a211f49e6fe66fd7c1e93ec272">trunk_untimed</a>, <a class="code" href="chan__iax2_8c.html#a6adba585126e2b38c95193ba412ab627">trunk_maxmtu</a>, <a class="code" href="chan__iax2_8c.html#a94f8cfe13889ff3263c38cf479749eb4">trunk_nmaxmtu</a> ;    <span class="comment">/*!&lt; Trunk MTU statistics */</span>
<a name="l00220"></a>00220 
<a name="l00221"></a><a class="code" href="chan__iax2_8c.html#a65482022daa21b4f2424677e9f3c2f65">00221</a> <span class="preprocessor">#define DEFAULT_CONTEXT &quot;default&quot;</span>
<a name="l00222"></a>00222 <span class="preprocessor"></span>
<a name="l00223"></a><a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">00223</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#a2a992fd5800f5ef8814fb3ea15b81dc7">default_parkinglot</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];
<a name="l00224"></a>00224 
<a name="l00225"></a><a class="code" href="chan__iax2_8c.html#adf416dc058363e2fd5750c77e2d78bee">00225</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00226"></a><a class="code" href="chan__iax2_8c.html#a4d41e07a86f9575719f396ac801b0208">00226</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#a4d41e07a86f9575719f396ac801b0208">regcontext</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00227"></a>00227 
<a name="l00228"></a><a class="code" href="chan__iax2_8c.html#a9eba23c66306b7c3c996716efa20e54c">00228</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a> = 3;
<a name="l00229"></a><a class="code" href="chan__iax2_8c.html#ace00444b699a504d1de875ae287796ed">00229</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ace00444b699a504d1de875ae287796ed">max_retries</a> = 4;
<a name="l00230"></a><a class="code" href="chan__iax2_8c.html#a4176abd8565bf845698b475dbb21aba3">00230</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a4176abd8565bf845698b475dbb21aba3">ping_time</a> = 21;
<a name="l00231"></a><a class="code" href="chan__iax2_8c.html#aa6f295fcb4e256758b51518984b6045f">00231</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa6f295fcb4e256758b51518984b6045f">lagrq_time</a> = 10;
<a name="l00232"></a><a class="code" href="chan__iax2_8c.html#a23714bf70065f01e7d5aeb1306da3e55">00232</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a23714bf70065f01e7d5aeb1306da3e55">maxjitterbuffer</a>=1000;
<a name="l00233"></a><a class="code" href="chan__iax2_8c.html#a66d9f655040b80077e0f3b28c8f52756">00233</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a66d9f655040b80077e0f3b28c8f52756">resyncthreshold</a>=1000;
<a name="l00234"></a><a class="code" href="chan__iax2_8c.html#a3e8760b196fa037207f5bdac92387ad3">00234</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3e8760b196fa037207f5bdac92387ad3">maxjitterinterps</a>=10;
<a name="l00235"></a><a class="code" href="chan__iax2_8c.html#ab7085c7d1b00a37f2a59d7bd32f4ec51">00235</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab7085c7d1b00a37f2a59d7bd32f4ec51">jittertargetextra</a> = 40; <span class="comment">/* number of milliseconds the new jitter buffer adds on to its size */</span>
<a name="l00236"></a>00236 
<a name="l00237"></a><a class="code" href="chan__iax2_8c.html#a69dd6fc2ce3f24790dffff13d25173c5">00237</a> <span class="preprocessor">#define MAX_TRUNKDATA           640 * 200       </span><span class="comment">/*!&lt; 40ms, uncompressed linear * 200 channels */</span>
<a name="l00238"></a>00238 
<a name="l00239"></a><a class="code" href="chan__iax2_8c.html#ab0f0080b9e7c0366ed5f850118fddd70">00239</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab0f0080b9e7c0366ed5f850118fddd70">trunkfreq</a> = 20;
<a name="l00240"></a><a class="code" href="chan__iax2_8c.html#aa8f48296981848c9cc8ca5cf2bb976ba">00240</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa8f48296981848c9cc8ca5cf2bb976ba">trunkmaxsize</a> = <a class="code" href="chan__iax2_8c.html#a69dd6fc2ce3f24790dffff13d25173c5">MAX_TRUNKDATA</a>;
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="chan__iax2_8c.html#a936591bfc4ac4515aa621afe79dbcd35">00242</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a936591bfc4ac4515aa621afe79dbcd35">authdebug</a> = 1;
<a name="l00243"></a><a class="code" href="chan__iax2_8c.html#a0e684af5528a44c6ae9fdf9e704cfa4e">00243</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0e684af5528a44c6ae9fdf9e704cfa4e">autokill</a> = 0;
<a name="l00244"></a><a class="code" href="chan__iax2_8c.html#a1dbf63d7916e79c96bb759fd960bf0dd">00244</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1dbf63d7916e79c96bb759fd960bf0dd">iaxcompat</a> = 0;
<a name="l00245"></a><a class="code" href="chan__iax2_8c.html#a43b9b90a4da22b40a062fa1442d1a51d">00245</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a43b9b90a4da22b40a062fa1442d1a51d">last_authmethod</a> = 0;
<a name="l00246"></a>00246 
<a name="l00247"></a><a class="code" href="chan__iax2_8c.html#a93b4d1e25d93b65ad2ba166eeefb35cc">00247</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a93b4d1e25d93b65ad2ba166eeefb35cc">iaxdefaultdpcache</a>=10 * 60;  <span class="comment">/* Cache dialplan entries for 10 minutes by default */</span>
<a name="l00248"></a>00248 
<a name="l00249"></a><a class="code" href="chan__iax2_8c.html#a82f89856f803916f1a1a2f4109c5216a">00249</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a82f89856f803916f1a1a2f4109c5216a">iaxdefaulttimeout</a> = 5;      <span class="comment">/* Default to wait no more than 5 seconds for a reply to come back */</span>
<a name="l00250"></a>00250 
<a name="l00251"></a>00251 <span class="keyword">static</span> <span class="keyword">struct </span>{
<a name="l00252"></a><a class="code" href="chan__iax2_8c.html#a25a9305efab3b493ca2519562fcec3d5">00252</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__h323_8c.html#a25a9305efab3b493ca2519562fcec3d5">tos</a>;
<a name="l00253"></a><a class="code" href="chan__iax2_8c.html#ae91dad65f553f7afebe4af507803bc7f">00253</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__h323_8c.html#ae91dad65f553f7afebe4af507803bc7f">cos</a>;
<a name="l00254"></a>00254 } <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a> = { 0, 0 };
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="chan__iax2_8c.html#a5b3c0ad1ed9f380f0934a655a8c411b9">00256</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5b3c0ad1ed9f380f0934a655a8c411b9">min_reg_expire</a>;
<a name="l00257"></a><a class="code" href="chan__iax2_8c.html#a9f029f6d8da7662c130685b7e3214ae8">00257</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9f029f6d8da7662c130685b7e3214ae8">max_reg_expire</a>;
<a name="l00258"></a>00258 
<a name="l00259"></a><a class="code" href="chan__iax2_8c.html#aa9de145820f728d55e5e5c5507e7da92">00259</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa9de145820f728d55e5e5c5507e7da92">srvlookup</a> = 0;
<a name="l00260"></a>00260 
<a name="l00261"></a><a class="code" href="chan__iax2_8c.html#a9aed6490b63794e6c9c00af4533f255f">00261</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__timer.html">ast_timer</a> *<a class="code" href="chan__iax2_8c.html#a9aed6490b63794e6c9c00af4533f255f">timer</a>;           <span class="comment">/* Timer for trunking */</span>
<a name="l00262"></a>00262 
<a name="l00263"></a><a class="code" href="chan__iax2_8c.html#a5a411c8b538fee54d0cfbdc299d433da">00263</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__netsock__list.html">ast_netsock_list</a> *<a class="code" href="chan__iax2_8c.html#a5a411c8b538fee54d0cfbdc299d433da">netsock</a>;
<a name="l00264"></a><a class="code" href="chan__iax2_8c.html#a64b550ec327461e57297524ed98fb0b8">00264</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__netsock__list.html">ast_netsock_list</a> *<a class="code" href="chan__iax2_8c.html#a64b550ec327461e57297524ed98fb0b8">outsock</a>;     <span class="comment">/*!&lt; used if sourceaddress specified and bindaddr == INADDR_ANY */</span>
<a name="l00265"></a><a class="code" href="chan__iax2_8c.html#afca2baa86e92d52a391ababc583b4f3c">00265</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afca2baa86e92d52a391ababc583b4f3c">defaultsockfd</a> = -1;
<a name="l00266"></a>00266 
<a name="l00267"></a>00267 int (*<a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>)(<span class="keyword">const</span> <span class="keywordtype">char</span> *username, <span class="keywordtype">int</span> onoff) = NULL;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269 <span class="comment">/* Ethernet, etc */</span>
<a name="l00270"></a><a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">00270</a> <span class="preprocessor">#define IAX_CAPABILITY_FULLBANDWIDTH   0xFFFF</span>
<a name="l00271"></a>00271 <span class="preprocessor"></span><span class="comment">/* T1, maybe ISDN */</span>
<a name="l00272"></a><a class="code" href="chan__iax2_8c.html#ac37936cf32e98fb7a03973cfacb39214">00272</a> <span class="preprocessor">#define IAX_CAPABILITY_MEDBANDWIDTH    (IAX_CAPABILITY_FULLBANDWIDTH &amp;  \</span>
<a name="l00273"></a>00273 <span class="preprocessor">                ~AST_FORMAT_SLINEAR &amp;        \</span>
<a name="l00274"></a>00274 <span class="preprocessor">                ~AST_FORMAT_SLINEAR16 &amp;         \</span>
<a name="l00275"></a>00275 <span class="preprocessor">                ~AST_FORMAT_SIREN7 &amp;         \</span>
<a name="l00276"></a>00276 <span class="preprocessor">                ~AST_FORMAT_SIREN14 &amp;        \</span>
<a name="l00277"></a>00277 <span class="preprocessor">                ~AST_FORMAT_ULAW &amp;        \</span>
<a name="l00278"></a>00278 <span class="preprocessor">                ~AST_FORMAT_ALAW &amp;        \</span>
<a name="l00279"></a>00279 <span class="preprocessor">                ~AST_FORMAT_G722) </span>
<a name="l00280"></a>00280 <span class="preprocessor"></span><span class="comment">/* A modem */</span>
<a name="l00281"></a><a class="code" href="chan__iax2_8c.html#ad73ac99e59386b240b2ce221f5647a01">00281</a> <span class="preprocessor">#define IAX_CAPABILITY_LOWBANDWIDTH (IAX_CAPABILITY_MEDBANDWIDTH &amp;      \</span>
<a name="l00282"></a>00282 <span class="preprocessor">                ~AST_FORMAT_G726 &amp;        \</span>
<a name="l00283"></a>00283 <span class="preprocessor">                ~AST_FORMAT_G726_AAL2 &amp;      \</span>
<a name="l00284"></a>00284 <span class="preprocessor">                ~AST_FORMAT_ADPCM)</span>
<a name="l00285"></a>00285 <span class="preprocessor"></span>
<a name="l00286"></a><a class="code" href="chan__iax2_8c.html#a974154146a547ef9b12fe0f51ee192fd">00286</a> <span class="preprocessor">#define IAX_CAPABILITY_LOWFREE      (IAX_CAPABILITY_LOWBANDWIDTH &amp;      \</span>
<a name="l00287"></a>00287 <span class="preprocessor">                ~AST_FORMAT_G723_1)</span>
<a name="l00288"></a>00288 <span class="preprocessor"></span>
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="chan__iax2_8c.html#a960e3be6d1f16d936afd3d6fba7f31b0">00290</a> <span class="preprocessor">#define DEFAULT_MAXMS      2000     </span><span class="comment">/* Must be faster than 2 seconds by default */</span>
<a name="l00291"></a><a class="code" href="chan__iax2_8c.html#a6c7e84078c9453a91a17644b02a40f31">00291</a> <span class="preprocessor">#define DEFAULT_FREQ_OK    60 * 1000   </span><span class="comment">/* How often to check for the host to be up */</span>
<a name="l00292"></a><a class="code" href="chan__iax2_8c.html#aa73619a83d0834665edbf86a7bde0d91">00292</a> <span class="preprocessor">#define DEFAULT_FREQ_NOTOK 10 * 1000   </span><span class="comment">/* How often to check, if the host is down... */</span>
<a name="l00293"></a>00293 
<a name="l00294"></a>00294 <span class="comment">/* if a pvt has encryption setup done and is running on the call */</span>
<a name="l00295"></a><a class="code" href="chan__iax2_8c.html#a3d9496bb3807918ec2fef65f1d25f6e5">00295</a> <span class="preprocessor">#define IAX_CALLENCRYPTED(pvt) \</span>
<a name="l00296"></a>00296 <span class="preprocessor">   (ast_test_flag(pvt, IAX_ENCRYPTED) &amp;&amp; ast_test_flag(pvt, IAX_KEYPOPULATED))</span>
<a name="l00297"></a>00297 <span class="preprocessor"></span>
<a name="l00298"></a><a class="code" href="chan__iax2_8c.html#a70f36235709ab44d3a046577cb5dc40e">00298</a> <span class="preprocessor">#define IAX_DEBUGDIGEST(msg, key) do { \</span>
<a name="l00299"></a>00299 <span class="preprocessor">      int idx; \</span>
<a name="l00300"></a>00300 <span class="preprocessor">      char digest[33] = &quot;&quot;; \</span>
<a name="l00301"></a>00301 <span class="preprocessor">      \</span>
<a name="l00302"></a>00302 <span class="preprocessor">      if (!iaxdebug) \</span>
<a name="l00303"></a>00303 <span class="preprocessor">         break; \</span>
<a name="l00304"></a>00304 <span class="preprocessor">      \</span>
<a name="l00305"></a>00305 <span class="preprocessor">      for (idx = 0; idx &lt; 16; idx++) \</span>
<a name="l00306"></a>00306 <span class="preprocessor">         sprintf(digest + (idx &lt;&lt; 1), &quot;%2.2x&quot;, (unsigned char) key[idx]); \</span>
<a name="l00307"></a>00307 <span class="preprocessor">      \</span>
<a name="l00308"></a>00308 <span class="preprocessor">      ast_log(LOG_NOTICE, msg &quot; IAX_COMMAND_RTKEY to rotate key to &apos;%s&apos;\n&quot;, digest); \</span>
<a name="l00309"></a>00309 <span class="preprocessor">   } while(0)</span>
<a name="l00310"></a>00310 <span class="preprocessor"></span>
<a name="l00311"></a><a class="code" href="chan__iax2_8c.html#abda48311b6abe5a4dd8b6904ddde0a6d">00311</a> <span class="keyword">static</span>   <span class="keyword">struct </span><a class="code" href="structio__context.html" title="Global IO variables are now in a struct in order to be made threadsafe.">io_context</a> *<a class="code" href="chan__iax2_8c.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>;
<a name="l00312"></a><a class="code" href="chan__iax2_8c.html#a398835bb775b9f77f5d5257908382ed6">00312</a> <span class="keyword">static</span>   <span class="keyword">struct </span><a class="code" href="structast__sched__thread.html">ast_sched_thread</a> *<a class="code" href="structsched.html">sched</a>;
<a name="l00313"></a>00313 
<a name="l00314"></a><a class="code" href="chan__iax2_8c.html#a2b64fca48a698695bcc08b89fa4b7788">00314</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2b64fca48a698695bcc08b89fa4b7788">iax2_capability</a> = <a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">IAX_CAPABILITY_FULLBANDWIDTH</a>;
<a name="l00315"></a>00315 
<a name="l00316"></a><a class="code" href="chan__iax2_8c.html#aca08f409880d0889471279e0ff22a5f6">00316</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aca08f409880d0889471279e0ff22a5f6">iaxdebug</a> = 0;
<a name="l00317"></a>00317 
<a name="l00318"></a><a class="code" href="chan__iax2_8c.html#ad8bdf2b011bb3f7a465466e8ff143da7">00318</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad8bdf2b011bb3f7a465466e8ff143da7">iaxtrunkdebug</a> = 0;
<a name="l00319"></a>00319 
<a name="l00320"></a><a class="code" href="chan__iax2_8c.html#aa98e8fc864be5ecc7c25852740df20b6">00320</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa98e8fc864be5ecc7c25852740df20b6">test_losspct</a> = 0;
<a name="l00321"></a>00321 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l00322"></a>00322 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> test_late = 0;
<a name="l00323"></a>00323 <span class="keyword">static</span> <span class="keywordtype">int</span> test_resync = 0;
<a name="l00324"></a>00324 <span class="keyword">static</span> <span class="keywordtype">int</span> test_jit = 0;
<a name="l00325"></a>00325 <span class="keyword">static</span> <span class="keywordtype">int</span> test_jitpct = 0;
<a name="l00326"></a>00326 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="chan__iax2_8c.html#adfee50d07a98645d4d20b896ce03785a">00328</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a>[<a class="code" href="cdr_8h.html#aa5a0589e78ac9e010524872ca0a3cf49">AST_MAX_ACCOUNT_CODE</a>];
<a name="l00329"></a><a class="code" href="chan__iax2_8c.html#af689da2b77d1265192a78a5b0994a1d5">00329</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>];
<a name="l00330"></a><a class="code" href="chan__iax2_8c.html#aec4e201113703e94cd365aaa6dabd4f0">00330</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#aec4e201113703e94cd365aaa6dabd4f0">mohsuggest</a>[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>];
<a name="l00331"></a><a class="code" href="chan__iax2_8c.html#ad2cfb0f821c065261382a9298bb5a16b">00331</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> = 0;
<a name="l00332"></a><a class="code" href="chan__iax2_8c.html#a61fbadf21e15a109d0703a01e0302535">00332</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = 0;
<a name="l00333"></a><a class="code" href="chan__iax2_8c.html#a11d514ef9e73ce20832377f4fa8f23bd">00333</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a11d514ef9e73ce20832377f4fa8f23bd">delayreject</a> = 0;
<a name="l00334"></a><a class="code" href="chan__iax2_8c.html#aaa58fb90c453b4775196531ea5579d27">00334</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aaa58fb90c453b4775196531ea5579d27">iax2_encryption</a> = 0;
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="chan__iax2_8c.html#a3888fe259904a2eb18b173cbf56bfa86">00336</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="chan__iax2_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a> = { 0 };
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="chan__iax2_8c.html#aaccf62d7fc810d5b42da0a3069ba7651">00338</a> <span class="keyword">static</span> pthread_t <a class="code" href="chan__iax2_8c.html#aaccf62d7fc810d5b42da0a3069ba7651">netthreadid</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00339"></a>00339 
<a name="l00340"></a><a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773">00340</a> <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773">iax2_state</a> {
<a name="l00341"></a><a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">00341</a>    <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a> =        (1 &lt;&lt; 0),
<a name="l00342"></a><a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">00342</a>    <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a> =  (1 &lt;&lt; 1),
<a name="l00343"></a><a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">00343</a>    <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a> =            (1 &lt;&lt; 2),
<a name="l00344"></a>00344 };
<a name="l00345"></a>00345 
<a name="l00346"></a><a class="code" href="structiax2__context.html">00346</a> <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> {
<a name="l00347"></a><a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">00347</a>    <span class="keywordtype">char</span> <a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];
<a name="l00348"></a><a class="code" href="structiax2__context.html#adda68386bebcd983920d3f129230f277">00348</a>    <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *<a class="code" href="structiax2__context.html#adda68386bebcd983920d3f129230f277">next</a>;
<a name="l00349"></a>00349 };
<a name="l00350"></a>00350 
<a name="l00351"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeb">00351</a> <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeb">iax2_flags</a> {
<a name="l00352"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">00352</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a> =    (1 &lt;&lt; 0),   <span class="comment">/*!&lt; CallerID has been specified */</span>
<a name="l00353"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">00353</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a> =    (1 &lt;&lt; 1),   <span class="comment">/*!&lt; Needs to be deleted */</span>
<a name="l00354"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">00354</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a> =    (1 &lt;&lt; 2),   <span class="comment">/*!&lt; Temporary (realtime) */</span>
<a name="l00355"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">00355</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a> =    (1 &lt;&lt; 3),   <span class="comment">/*!&lt; Treat as a trunk */</span>
<a name="l00356"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">00356</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a> =  (1 &lt;&lt; 4),   <span class="comment">/*!&lt; Don&apos;t native bridge */</span>
<a name="l00357"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">00357</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> =   (1 &lt;&lt; 5),   <span class="comment">/*!&lt; Use jitter buffer */</span>
<a name="l00358"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">00358</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a> =     (1 &lt;&lt; 6),   <span class="comment">/*!&lt; dynamic peer */</span>
<a name="l00359"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">00359</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">IAX_SENDANI</a> =     (1 &lt;&lt; 7),   <span class="comment">/*!&lt; Send ANI along with CallerID */</span>
<a name="l00360"></a>00360         <span class="comment">/* (1 &lt;&lt; 8) is currently unused due to the deprecation of an old option. Go ahead, take it! */</span>
<a name="l00361"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">00361</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a> = (1 &lt;&lt; 9),   <span class="comment">/*!&lt; Already disconnected */</span>
<a name="l00362"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaaeca8376f09c96f96ffd39107da8aefd">00362</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaaeca8376f09c96f96ffd39107da8aefd">IAX_PROVISION</a> =      (1 &lt;&lt; 10),  <span class="comment">/*!&lt; This is a provisioning request */</span>
<a name="l00363"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba5c0041238c2195bc988f0b77ce0972d6">00363</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba5c0041238c2195bc988f0b77ce0972d6">IAX_QUELCH</a> =      (1 &lt;&lt; 11),  <span class="comment">/*!&lt; Whether or not we quelch audio */</span>
<a name="l00364"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">00364</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a> =      (1 &lt;&lt; 12),  <span class="comment">/*!&lt; Whether we should assume encrypted tx/rx */</span>
<a name="l00365"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">00365</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">IAX_KEYPOPULATED</a> =   (1 &lt;&lt; 13),  <span class="comment">/*!&lt; Whether we have a key populated */</span>
<a name="l00366"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">00366</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a> =  (1 &lt;&lt; 14),  <span class="comment">/*!&lt; are we willing to let the other guy choose the codec? */</span>
<a name="l00367"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">00367</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a> =     (1 &lt;&lt; 15),  <span class="comment">/*!&lt; Force old behaviour by turning off prefs */</span>
<a name="l00368"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">00368</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a> =    (1 &lt;&lt; 16),  <span class="comment">/*!&lt; only consider requested format and ignore capabilities*/</span>
<a name="l00369"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">00369</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a> =    (1 &lt;&lt; 17),  <span class="comment">/*!&lt; let realtime stay till your reload */</span>
<a name="l00370"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba3b832a927807f0e518e9e18fee76d3a6">00370</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba3b832a927807f0e518e9e18fee76d3a6">IAX_RTUPDATE</a> =       (1 &lt;&lt; 18),  <span class="comment">/*!&lt; Send a realtime update */</span>
<a name="l00371"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">00371</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a> =    (1 &lt;&lt; 19),  <span class="comment">/*!&lt; erase me on expire */</span> 
<a name="l00372"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">00372</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a> = (1 &lt;&lt; 20),  <span class="comment">/*!&lt; Force jitterbuffer, even when bridged to a channel that can take jitter */</span> 
<a name="l00373"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab6a1016b2b84bd5d410a1a9d6994deb1">00373</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab6a1016b2b84bd5d410a1a9d6994deb1">IAX_RTIGNOREREGEXPIRE</a> = (1 &lt;&lt; 21),  <span class="comment">/*!&lt; When using realtime, ignore registration expiration */</span>
<a name="l00374"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba0af69b242af8f9f71d7c94452ce86088">00374</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba0af69b242af8f9f71d7c94452ce86088">IAX_TRUNKTIMESTAMPS</a> =   (1 &lt;&lt; 22),  <span class="comment">/*!&lt; Send trunk timestamps */</span>
<a name="l00375"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">00375</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a> =     (1 &lt;&lt; 23),      <span class="comment">/*!&lt; When doing IAX2 transfers, transfer media only */</span>
<a name="l00376"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">00376</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a> =        (1 &lt;&lt; 24),      <span class="comment">/*!&lt; Maximum outstanding AUTHREQ restriction is in place */</span>
<a name="l00377"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8182bed8f54e0fb3cc0575d24519b1ef">00377</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8182bed8f54e0fb3cc0575d24519b1ef">IAX_DELAYPBXSTART</a> =  (1 &lt;&lt; 25),  <span class="comment">/*!&lt; Don&apos;t start a PBX on the channel until the peer sends us a</span>
<a name="l00378"></a>00378 <span class="comment">                       response, so that we&apos;ve achieved a three-way handshake with</span>
<a name="l00379"></a>00379 <span class="comment">                       them before sending voice or anything else*/</span>
<a name="l00380"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba481a383cdd29d94527853f60bf6516cd">00380</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba481a383cdd29d94527853f60bf6516cd">IAX_ALLOWFWDOWNLOAD</a> =   (1 &lt;&lt; 26),  <span class="comment">/*!&lt; Allow the FWDOWNL command? */</span>
<a name="l00381"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae233a3edc609990a3402d03d4ddd5f1e">00381</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae233a3edc609990a3402d03d4ddd5f1e">IAX_IMMEDIATE</a> =      (1 &lt;&lt; 27),      <span class="comment">/*!&lt; Allow immediate off-hook to extension s */</span>
<a name="l00382"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">00382</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a> =  (1 &lt;&lt; 28),      <span class="comment">/*!&lt; Forces call encryption, if encryption not possible hangup */</span>
<a name="l00383"></a><a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae22e2b945ef6ffda9b550fbb2a6787ce">00383</a>    <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae22e2b945ef6ffda9b550fbb2a6787ce">IAX_SHRINKCALLERID</a> = (1 &lt;&lt; 29),   <span class="comment">/*!&lt; Turn on and off caller id shrinking */</span>
<a name="l00384"></a>00384 };
<a name="l00385"></a>00385 
<a name="l00386"></a><a class="code" href="chan__iax2_8c.html#a71fc9d93e60c12405c59cadfaa0fabc8">00386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a71fc9d93e60c12405c59cadfaa0fabc8">global_rtautoclear</a> = 120;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab0a267a38c194073f7bf6dc1c5b97011">reload_config</a>(<span class="keywordtype">void</span>);
<a name="l00389"></a>00389 <span class="comment"></span>
<a name="l00390"></a>00390 <span class="comment">/*!</span>
<a name="l00391"></a>00391 <span class="comment"> * \brief Call token validation settings.</span>
<a name="l00392"></a>00392 <span class="comment"> */</span>
<a name="l00393"></a><a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32">00393</a> <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32" title="Call token validation settings.">calltoken_peer_enum</a> {<span class="comment"></span>
<a name="l00394"></a>00394 <span class="comment">   /*! \brief Default calltoken required unless the ip is in the ignorelist */</span>
<a name="l00395"></a><a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a5e7188ffc2bdb50ce90b5f8e0a1d7ac3">00395</a>    <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a5e7188ffc2bdb50ce90b5f8e0a1d7ac3" title="Default calltoken required unless the ip is in the ignorelist.">CALLTOKEN_DEFAULT</a> = 0,<span class="comment"></span>
<a name="l00396"></a>00396 <span class="comment">   /*! \brief Require call token validation. */</span>
<a name="l00397"></a><a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8">00397</a>    <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8" title="Require call token validation.">CALLTOKEN_YES</a> = 1,<span class="comment"></span>
<a name="l00398"></a>00398 <span class="comment">   /*! \brief Require call token validation after a successful registration</span>
<a name="l00399"></a>00399 <span class="comment">    *         using call token validation occurs. */</span>
<a name="l00400"></a><a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8">00400</a>    <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a> = 2,<span class="comment"></span>
<a name="l00401"></a>00401 <span class="comment">   /*! \brief Do not require call token validation. */</span>
<a name="l00402"></a><a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a7ee00866dc8402f0f253e0f8fff829fd">00402</a>    <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a7ee00866dc8402f0f253e0f8fff829fd" title="Do not require call token validation.">CALLTOKEN_NO</a> = 3,
<a name="l00403"></a>00403 };
<a name="l00404"></a>00404 
<a name="l00405"></a><a class="code" href="structiax2__user.html">00405</a> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> {
<a name="l00406"></a>00406    <a class="code" href="structiax2__user.html#a40709b9be3104cb0d6367f1f677d0fbe">AST_DECLARE_STRING_FIELDS</a>(
<a name="l00407"></a>00407       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00408"></a>00408       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>);
<a name="l00409"></a>00409       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(dbsecret);
<a name="l00410"></a>00410       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(accountcode);
<a name="l00411"></a>00411       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(mohinterpret);
<a name="l00412"></a>00412       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(mohsuggest);
<a name="l00413"></a>00413       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(inkeys);               <span class="comment">/*!&lt; Key(s) this user can use to authenticate to us */</span>
<a name="l00414"></a>00414       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(language);
<a name="l00415"></a>00415       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);
<a name="l00416"></a>00416       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>);
<a name="l00417"></a>00417       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>);           <span class="comment">/*!&lt; Default parkinglot for device */</span>
<a name="l00418"></a>00418    );
<a name="l00419"></a>00419    
<a name="l00420"></a><a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">00420</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>;
<a name="l00421"></a><a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">00421</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>;
<a name="l00422"></a><a class="code" href="structiax2__user.html#ad2cfb0f821c065261382a9298bb5a16b">00422</a>    <span class="keywordtype">int</span> amaflags;
<a name="l00423"></a><a class="code" href="structiax2__user.html#a61fbadf21e15a109d0703a01e0302535">00423</a>    <span class="keywordtype">int</span> adsi;
<a name="l00424"></a><a class="code" href="structiax2__user.html#ac92588540e8c1d014a08cd8a45462b19">00424</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l00425"></a><a class="code" href="structiax2__user.html#afa05b14ff7f76f303c784c00c4c63fa7">00425</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l00426"></a><a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">00426</a>    <span class="keywordtype">int</span> maxauthreq; <span class="comment">/*!&lt; Maximum allowed outstanding AUTHREQs */</span>
<a name="l00427"></a><a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">00427</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a>; <span class="comment">/*!&lt; Current number of outstanding AUTHREQs */</span>
<a name="l00428"></a><a class="code" href="structiax2__user.html#a46262e3cc2baf55a72542567ccfe86d9">00428</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="structiax2__user.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l00429"></a><a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">00429</a>    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> *<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>;
<a name="l00430"></a><a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">00430</a>    <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>;
<a name="l00431"></a><a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">00431</a>    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>;
<a name="l00432"></a><a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">00432</a>    <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32" title="Call token validation settings.">calltoken_peer_enum</a> <a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a>;        <span class="comment">/*!&lt; Is calltoken validation required or not, can be YES, NO, or AUTO */</span>
<a name="l00433"></a>00433 };
<a name="l00434"></a>00434 
<a name="l00435"></a><a class="code" href="structiax2__peer.html">00435</a> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> {
<a name="l00436"></a>00436    <a class="code" href="structiax2__peer.html#a47eaecddc2cd0cfb3b473064e316a512">AST_DECLARE_STRING_FIELDS</a>(
<a name="l00437"></a>00437       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00438"></a>00438       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(username);
<a name="l00439"></a>00439       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>);
<a name="l00440"></a>00440       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(dbsecret);
<a name="l00441"></a>00441       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(outkey);      <span class="comment">/*!&lt; What key we use to talk to this peer */</span>
<a name="l00442"></a>00442 
<a name="l00443"></a>00443       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(regexten);     <span class="comment">/*!&lt; Extension to register (if regcontext is used) */</span>
<a name="l00444"></a>00444       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);      <span class="comment">/*!&lt; For transfers only */</span>
<a name="l00445"></a>00445       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(peercontext);  <span class="comment">/*!&lt; Context to pass to peer */</span>
<a name="l00446"></a>00446       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);     <span class="comment">/*!&lt; Mailbox */</span>
<a name="l00447"></a>00447       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(mohinterpret);
<a name="l00448"></a>00448       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(mohsuggest);
<a name="l00449"></a>00449       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(inkeys);     <span class="comment">/*!&lt; Key(s) this peer can use to authenticate to us */</span>
<a name="l00450"></a>00450       <span class="comment">/* Suggested caller id if registering */</span>
<a name="l00451"></a>00451       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);    <span class="comment">/*!&lt; Default context (for transfer really) */</span>
<a name="l00452"></a>00452       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>);      <span class="comment">/*!&lt; Default context (for transfer really) */</span>
<a name="l00453"></a>00453       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>);    <span class="comment">/*!&lt; Time Zone */</span>
<a name="l00454"></a>00454       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>);   <span class="comment">/*!&lt; Default parkinglot for device */</span>
<a name="l00455"></a>00455    );
<a name="l00456"></a><a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">00456</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l00457"></a><a class="code" href="structiax2__peer.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">00457</a>    <span class="keyword">struct </span><a class="code" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *<a class="code" href="structiax2__peer.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>;    <span class="comment">/*!&lt; DNS refresh manager */</span>
<a name="l00458"></a><a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">00458</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>;
<a name="l00459"></a><a class="code" href="structiax2__peer.html#abec2f9ddc3eb615d8e6c80e356f57043">00459</a>    <span class="keywordtype">int</span> <a class="code" href="structformats.html">formats</a>;
<a name="l00460"></a><a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">00460</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>;             <span class="comment">/*!&lt; Socket to use for transmission */</span>
<a name="l00461"></a><a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">00461</a>    <span class="keyword">struct </span>in_addr <a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>;
<a name="l00462"></a><a class="code" href="structiax2__peer.html#a61fbadf21e15a109d0703a01e0302535">00462</a>    <span class="keywordtype">int</span> adsi;
<a name="l00463"></a><a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">00463</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    <span class="comment">/* Dynamic Registration fields */</span>
<a name="l00466"></a><a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">00466</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>;         <span class="comment">/*!&lt; Default address if there is one */</span>
<a name="l00467"></a><a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">00467</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>;           <span class="comment">/*!&lt; Authentication methods (IAX_AUTH_*) */</span>
<a name="l00468"></a><a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">00468</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>;               <span class="comment">/*!&lt; Encryption methods (IAX_ENCRYPT_*) */</span>
<a name="l00469"></a>00469 
<a name="l00470"></a><a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">00470</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>;             <span class="comment">/*!&lt; Schedule entry for expiry */</span>
<a name="l00471"></a><a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">00471</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a>;             <span class="comment">/*!&lt; How soon to expire */</span>
<a name="l00472"></a><a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">00472</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;               <span class="comment">/*!&lt; Capability */</span>
<a name="l00473"></a>00473 
<a name="l00474"></a>00474    <span class="comment">/* Qualification */</span>
<a name="l00475"></a><a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">00475</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>;             <span class="comment">/*!&lt; Call number of POKE request */</span>
<a name="l00476"></a><a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">00476</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a>;               <span class="comment">/*!&lt; Scheduled qualification-related task (ie iax2_poke_peer_s or iax2_poke_noanswer) */</span>
<a name="l00477"></a><a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">00477</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>;             <span class="comment">/*!&lt; How long last response took (in ms), or -1 for no response */</span>
<a name="l00478"></a><a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">00478</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>;              <span class="comment">/*!&lt; Max ms we will accept for the host to be up, 0 to not monitor */</span>
<a name="l00479"></a>00479 
<a name="l00480"></a><a class="code" href="structiax2__peer.html#a0fc1d0f0302835103c4b7c291c2467b1">00480</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a0fc1d0f0302835103c4b7c291c2467b1">pokefreqok</a>;               <span class="comment">/*!&lt; How often to check if the host is up */</span>
<a name="l00481"></a><a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">00481</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>;            <span class="comment">/*!&lt; How often to check when the host has been determined to be down */</span>
<a name="l00482"></a><a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">00482</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a>;               <span class="comment">/*!&lt; How long recent average responses took */</span>
<a name="l00483"></a><a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">00483</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">smoothing</a>;             <span class="comment">/*!&lt; Sample over how many units to determine historic ms */</span>
<a name="l00484"></a><a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">00484</a>    uint16_t <a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a>;              <span class="comment">/*!&lt; Max call number limit for this peer.  Set on registration */</span>
<a name="l00485"></a>00485 
<a name="l00486"></a><a class="code" href="structiax2__peer.html#a7dec0df43032d5c53d9a125030385a30">00486</a>    <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *<a class="code" href="structiax2__peer.html#a7dec0df43032d5c53d9a125030385a30">mwi_event_sub</a>;
<a name="l00487"></a>00487 
<a name="l00488"></a><a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">00488</a>    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> *<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>;
<a name="l00489"></a><a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">00489</a>    <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32" title="Call token validation settings.">calltoken_peer_enum</a> <a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a>;        <span class="comment">/*!&lt; Is calltoken validation required or not, can be YES, NO, or AUTO */</span>
<a name="l00490"></a>00490 };
<a name="l00491"></a>00491 
<a name="l00492"></a><a class="code" href="chan__iax2_8c.html#ac1d06616566c06c92ea23cbe8f210e43">00492</a> <span class="preprocessor">#define IAX2_TRUNK_PREFACE (sizeof(struct iax_frame) + sizeof(struct ast_iax2_meta_hdr) + sizeof(struct ast_iax2_meta_trunk_hdr))</span>
<a name="l00493"></a>00493 <span class="preprocessor"></span>
<a name="l00494"></a><a class="code" href="structiax2__trunk__peer.html">00494</a> <span class="keyword">struct </span><a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> {
<a name="l00495"></a><a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">00495</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l00496"></a><a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">00496</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>;
<a name="l00497"></a><a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">00497</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>;
<a name="l00498"></a><a class="code" href="structiax2__trunk__peer.html#af0592c858aeacabf8566786c1bbd3f1f">00498</a>    <span class="keyword">struct </span>timeval <a class="code" href="structiax2__trunk__peer.html#af0592c858aeacabf8566786c1bbd3f1f">txtrunktime</a>;      <span class="comment">/*!&lt; Transmit trunktime */</span>
<a name="l00499"></a><a class="code" href="structiax2__trunk__peer.html#a29f80e536bea489aed0b8ae715a60622">00499</a>    <span class="keyword">struct </span>timeval <a class="code" href="structiax2__trunk__peer.html#a29f80e536bea489aed0b8ae715a60622">rxtrunktime</a>;      <span class="comment">/*!&lt; Receive trunktime */</span>
<a name="l00500"></a><a class="code" href="structiax2__trunk__peer.html#a2147e507686c1caa0cb9e43f7e629b10">00500</a>    <span class="keyword">struct </span>timeval <a class="code" href="structiax2__trunk__peer.html#a2147e507686c1caa0cb9e43f7e629b10">lasttxtime</a>;    <span class="comment">/*!&lt; Last transmitted trunktime */</span>
<a name="l00501"></a><a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">00501</a>    <span class="keyword">struct </span>timeval <a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">trunkact</a>;      <span class="comment">/*!&lt; Last trunk activity */</span>
<a name="l00502"></a><a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">00502</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>;        <span class="comment">/*!&lt; Last sent time */</span>
<a name="l00503"></a>00503    <span class="comment">/* Trunk data and length */</span>
<a name="l00504"></a><a class="code" href="structiax2__trunk__peer.html#a9d7d795e75eb67c3d19f9b86d326c588">00504</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structiax2__trunk__peer.html#a9d7d795e75eb67c3d19f9b86d326c588">trunkdata</a>;
<a name="l00505"></a><a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">00505</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a>;
<a name="l00506"></a><a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">00506</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a>;
<a name="l00507"></a><a class="code" href="structiax2__trunk__peer.html#a855342229327cfc12d8e9e63e926d4d3">00507</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a855342229327cfc12d8e9e63e926d4d3">trunkmaxmtu</a>;
<a name="l00508"></a><a class="code" href="structiax2__trunk__peer.html#aaf440ae138a9a42b5b4492dc5df5679d">00508</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#aaf440ae138a9a42b5b4492dc5df5679d">trunkerror</a>;
<a name="l00509"></a><a class="code" href="structiax2__trunk__peer.html#a5f1c773ac1d2f42241d25d73373885ab">00509</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>;
<a name="l00510"></a>00510    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a>) list;
<a name="l00511"></a>00511 };
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(tpeers, <a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a>);
<a name="l00514"></a>00514 
<a name="l00515"></a><a class="code" href="structiax__firmware.html">00515</a> struct <a class="code" href="structiax__firmware.html">iax_firmware</a> {
<a name="l00516"></a>00516    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(iax_firmware) list;
<a name="l00517"></a>00517    <span class="keywordtype">int</span> fd;
<a name="l00518"></a>00518    <span class="keywordtype">int</span> mmaplen;
<a name="l00519"></a>00519    <span class="keywordtype">int</span> dead;
<a name="l00520"></a>00520    <span class="keyword">struct </span><a class="code" href="structast__iax2__firmware__header.html">ast_iax2_firmware_header</a> *fwh;
<a name="l00521"></a>00521    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00522"></a>00522 };
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329">00524</a> <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329">iax_reg_state</a> {
<a name="l00525"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329afa6b79a3ca077d41b22de448c7ab34fb">00525</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329afa6b79a3ca077d41b22de448c7ab34fb">REG_STATE_UNREGISTERED</a> = 0,
<a name="l00526"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a024ddf2de7a878eb4da843c844dfd2e3">00526</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a024ddf2de7a878eb4da843c844dfd2e3">REG_STATE_REGSENT</a>,
<a name="l00527"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0fc848e483149fa4f30c05562591db11">00527</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0fc848e483149fa4f30c05562591db11">REG_STATE_AUTHSENT</a>,
<a name="l00528"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a5cb994f5165979d5e32dff13aaff9c53">00528</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a5cb994f5165979d5e32dff13aaff9c53">REG_STATE_REGISTERED</a>,
<a name="l00529"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a769d5aec3f52823efc8cea5b24794d8d">00529</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a769d5aec3f52823efc8cea5b24794d8d">REG_STATE_REJECTED</a>,
<a name="l00530"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0ceb5a0d8116282669c98effcffe96e3">00530</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0ceb5a0d8116282669c98effcffe96e3">REG_STATE_TIMEOUT</a>,
<a name="l00531"></a><a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a4fd8866724976c0a65ddded1c5ca952b">00531</a>    <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a4fd8866724976c0a65ddded1c5ca952b">REG_STATE_NOAUTH</a>
<a name="l00532"></a>00532 };
<a name="l00533"></a>00533 
<a name="l00534"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6">00534</a> <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6">iax_transfer_state</a> {
<a name="l00535"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a049e8add4a22f1065570f0b66067b22f">00535</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a049e8add4a22f1065570f0b66067b22f">TRANSFER_NONE</a> = 0,
<a name="l00536"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">00536</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">TRANSFER_BEGIN</a>,
<a name="l00537"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a960c983f99e76d8c1d8ba1bce27a1dab">00537</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a960c983f99e76d8c1d8ba1bce27a1dab">TRANSFER_READY</a>,
<a name="l00538"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6acbf3b44134a197e4b10c6493a809b2bc">00538</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6acbf3b44134a197e4b10c6493a809b2bc">TRANSFER_RELEASED</a>,
<a name="l00539"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a637842d519ecbdf46c55caf8545dad5a">00539</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a637842d519ecbdf46c55caf8545dad5a">TRANSFER_PASSTHROUGH</a>,
<a name="l00540"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6aaba79bebe929b7016a3cad879cd6ddfa">00540</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6aaba79bebe929b7016a3cad879cd6ddfa">TRANSFER_MBEGIN</a>,
<a name="l00541"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a936f20a7113740dedb28cbb5db075bd3">00541</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a936f20a7113740dedb28cbb5db075bd3">TRANSFER_MREADY</a>,
<a name="l00542"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a8170ab3825094e385056321184da713f">00542</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a8170ab3825094e385056321184da713f">TRANSFER_MRELEASED</a>,
<a name="l00543"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a0b142706019a1b2e72dc7cebd44fd1ab">00543</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a0b142706019a1b2e72dc7cebd44fd1ab">TRANSFER_MPASSTHROUGH</a>,
<a name="l00544"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a0370a7bf15bf0986fdf65ec0eb0441f3">00544</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a0370a7bf15bf0986fdf65ec0eb0441f3">TRANSFER_MEDIA</a>,
<a name="l00545"></a><a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a3fe2a477f9e84842066802bb8ad8a2b8">00545</a>    <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a3fe2a477f9e84842066802bb8ad8a2b8">TRANSFER_MEDIAPASS</a>
<a name="l00546"></a>00546 };
<a name="l00547"></a>00547 
<a name="l00548"></a><a class="code" href="structiax2__registry.html">00548</a> <span class="keyword">struct </span><a class="code" href="structiax2__registry.html">iax2_registry</a> {
<a name="l00549"></a><a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">00549</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>;      <span class="comment">/*!&lt; Who we connect to for registration purposes */</span>
<a name="l00550"></a><a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">00550</a>    <span class="keywordtype">char</span> username[80];
<a name="l00551"></a><a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">00551</a>    <span class="keywordtype">char</span> <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>[80];        <span class="comment">/*!&lt; Password or key name in []&apos;s */</span>
<a name="l00552"></a><a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">00552</a>    <span class="keywordtype">int</span> expire;          <span class="comment">/*!&lt; Sched ID of expiration */</span>
<a name="l00553"></a><a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">00553</a>    <span class="keywordtype">int</span> refresh;            <span class="comment">/*!&lt; How often to refresh */</span>
<a name="l00554"></a><a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">00554</a>    <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329">iax_reg_state</a> regstate;
<a name="l00555"></a><a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">00555</a>    <span class="keywordtype">int</span> messages;           <span class="comment">/*!&lt; Message count, low 8 bits = new, high 8 bits = old */</span>
<a name="l00556"></a><a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">00556</a>    <span class="keywordtype">int</span> callno;          <span class="comment">/*!&lt; Associated call number if applicable */</span>
<a name="l00557"></a><a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">00557</a>    <span class="keyword">struct </span>sockaddr_in us;        <span class="comment">/*!&lt; Who the server thinks we are */</span>
<a name="l00558"></a><a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">00558</a>    <span class="keyword">struct </span><a class="code" href="structast__dnsmgr__entry.html">ast_dnsmgr_entry</a> *dnsmgr; <span class="comment">/*!&lt; DNS refresh manager */</span>
<a name="l00559"></a>00559    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structiax2__registry.html">iax2_registry</a>) entry;
<a name="l00560"></a>00560 };
<a name="l00561"></a>00561 
<a name="l00562"></a>00562 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(registrations, <a class="code" href="structiax2__registry.html">iax2_registry</a>);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564 <span class="comment">/* Don&apos;t retry more frequently than every 10 ms, or less frequently than every 5 seconds */</span>
<a name="l00565"></a><a class="code" href="chan__iax2_8c.html#a7a91ecc2d6181c0e5f804a4d517c3e4f">00565</a> <span class="preprocessor">#define MIN_RETRY_TIME     100</span>
<a name="l00566"></a><a class="code" href="chan__iax2_8c.html#a67d22005a8e4f7fecdfbfe9856b089e3">00566</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_RETRY_TIME     10000</span>
<a name="l00567"></a>00567 <span class="preprocessor"></span>
<a name="l00568"></a><a class="code" href="chan__iax2_8c.html#aa46cedb48267038515d185e9492e18cf">00568</a> <span class="preprocessor">#define MAX_JITTER_BUFFER  50</span>
<a name="l00569"></a><a class="code" href="chan__iax2_8c.html#afdaf53060612ab3bdeb794681ed9be60">00569</a> <span class="preprocessor"></span><span class="preprocessor">#define MIN_JITTER_BUFFER  10</span>
<a name="l00570"></a>00570 <span class="preprocessor"></span>
<a name="l00571"></a><a class="code" href="chan__iax2_8c.html#ac39ac2b74f9ef87c0eea085a1fde05e1">00571</a> <span class="preprocessor">#define DEFAULT_TRUNKDATA  640 * 10 </span><span class="comment">/*!&lt; 40ms, uncompressed linear * 10 channels */</span>
<a name="l00572"></a>00572 
<a name="l00573"></a><a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">00573</a> <span class="preprocessor">#define MAX_TIMESTAMP_SKEW 160      </span><span class="comment">/*!&lt; maximum difference between actual and predicted ts for sending */</span>
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="comment">/* If consecutive voice frame timestamps jump by more than this many milliseconds, then jitter buffer will resync */</span>
<a name="l00576"></a><a class="code" href="chan__iax2_8c.html#ae2913d62d9f63662f83a09a74ee473a8">00576</a> <span class="preprocessor">#define TS_GAP_FOR_JB_RESYNC  5000</span>
<a name="l00577"></a>00577 <span class="preprocessor"></span>
<a name="l00578"></a>00578 <span class="comment">/* used for first_iax_message and last_iax_message.  If this bit is set it was TX, else RX */</span>
<a name="l00579"></a><a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">00579</a> <span class="preprocessor">#define MARK_IAX_SUBCLASS_TX  0x8000</span>
<a name="l00580"></a>00580 <span class="preprocessor"></span>
<a name="l00581"></a><a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">00581</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a> = <a class="code" href="chan__iax2_8c.html#ac9e94064e8ce15d44ef2b94289b1548b">DEFAULT_THREAD_COUNT</a>;
<a name="l00582"></a><a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">00582</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> = <a class="code" href="chan__iax2_8c.html#a3481fc1249cbdfd59881c41542b7c687">DEFAULT_MAX_THREAD_COUNT</a>;
<a name="l00583"></a><a class="code" href="chan__iax2_8c.html#a11480fc9a0f5a2c9cadb7a15a6c9c0e6">00583</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a11480fc9a0f5a2c9cadb7a15a6c9c0e6">iaxdynamicthreadcount</a> = 0;
<a name="l00584"></a><a class="code" href="chan__iax2_8c.html#a6891db50aed418c4c7416789958a7f76">00584</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a6891db50aed418c4c7416789958a7f76">iaxdynamicthreadnum</a> = 0;
<a name="l00585"></a><a class="code" href="chan__iax2_8c.html#a7b6613353aee0a0b41a8f18ffcc7268f">00585</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a7b6613353aee0a0b41a8f18ffcc7268f">iaxactivethreadcount</a> = 0;
<a name="l00586"></a>00586 
<a name="l00587"></a><a class="code" href="structiax__rr.html">00587</a> <span class="keyword">struct </span><a class="code" href="structiax__rr.html">iax_rr</a> {
<a name="l00588"></a><a class="code" href="structiax__rr.html#abea835169f47490d02cdda5205602fab">00588</a>    <span class="keywordtype">int</span> jitter;
<a name="l00589"></a><a class="code" href="structiax__rr.html#a701efcc47f4b1d6c0f8b76dcbc5df88b">00589</a>    <span class="keywordtype">int</span> losspct;
<a name="l00590"></a><a class="code" href="structiax__rr.html#a32ff8eb061980d446340f7ff3793a237">00590</a>    <span class="keywordtype">int</span> losscnt;
<a name="l00591"></a><a class="code" href="structiax__rr.html#acb7b2259cca68a4a88294167d16a27d1">00591</a>    <span class="keywordtype">int</span> packets;
<a name="l00592"></a><a class="code" href="structiax__rr.html#a6f1be1f780ff54ec75b41451cd4d90bd">00592</a>    <span class="keywordtype">int</span> delay;
<a name="l00593"></a><a class="code" href="structiax__rr.html#aa2d1978056690ed78ace30923f6adf80">00593</a>    <span class="keywordtype">int</span> dropped;
<a name="l00594"></a><a class="code" href="structiax__rr.html#a15f3b9042ba3e401d4fec79e58f2f2c3">00594</a>    <span class="keywordtype">int</span> ooo;
<a name="l00595"></a>00595 };
<a name="l00596"></a>00596 
<a name="l00597"></a>00597 <span class="keyword">struct </span>iax2_pvt_ref;
<a name="l00598"></a>00598 
<a name="l00599"></a><a class="code" href="structchan__iax2__pvt.html">00599</a> <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> {<span class="comment"></span>
<a name="l00600"></a>00600 <span class="comment">   /*! Socket to send/receive on for this call */</span>
<a name="l00601"></a><a class="code" href="structchan__iax2__pvt.html#ad2c8fb3df3a737e0685e902870a611d2">00601</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>;<span class="comment"></span>
<a name="l00602"></a>00602 <span class="comment">   /*! Last received voice format */</span>
<a name="l00603"></a><a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">00603</a>    <span class="keywordtype">int</span> voiceformat;<span class="comment"></span>
<a name="l00604"></a>00604 <span class="comment">   /*! Last received video format */</span>
<a name="l00605"></a><a class="code" href="structchan__iax2__pvt.html#a3592e144b79a8ac41ec04e9d7fd4423d">00605</a>    <span class="keywordtype">int</span> videoformat;<span class="comment"></span>
<a name="l00606"></a>00606 <span class="comment">   /*! Last sent voice format */</span>
<a name="l00607"></a><a class="code" href="structchan__iax2__pvt.html#a651f52e68c435d2cd74e0a6ee9f018f0">00607</a>    <span class="keywordtype">int</span> svoiceformat;<span class="comment"></span>
<a name="l00608"></a>00608 <span class="comment">   /*! Last sent video format */</span>
<a name="l00609"></a><a class="code" href="structchan__iax2__pvt.html#a2cd6784c5cdb13e5ff845fab09d51593">00609</a>    <span class="keywordtype">int</span> svideoformat;<span class="comment"></span>
<a name="l00610"></a>00610 <span class="comment">   /*! What we are capable of sending */</span>
<a name="l00611"></a><a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">00611</a>    <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;<span class="comment"></span>
<a name="l00612"></a>00612 <span class="comment">   /*! Last received timestamp */</span>
<a name="l00613"></a><a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">00613</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>;<span class="comment"></span>
<a name="l00614"></a>00614 <span class="comment">   /*! Last sent timestamp - never send the same timestamp twice in a single call */</span>
<a name="l00615"></a><a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">00615</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>;<span class="comment"></span>
<a name="l00616"></a>00616 <span class="comment">   /*! Timestamp of the last video frame sent */</span>
<a name="l00617"></a><a class="code" href="structchan__iax2__pvt.html#a62a00cfbf5b85ad8006fb563a8d3acdd">00617</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lastvsent;<span class="comment"></span>
<a name="l00618"></a>00618 <span class="comment">   /*! Next outgoing timestamp if everything is good */</span>
<a name="l00619"></a><a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">00619</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> nextpred;<span class="comment"></span>
<a name="l00620"></a>00620 <span class="comment">   /*! iax frame subclass that began iax2_pvt entry. 0x8000 bit is set on TX */</span>
<a name="l00621"></a><a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">00621</a>    <span class="keywordtype">int</span> first_iax_message;<span class="comment"></span>
<a name="l00622"></a>00622 <span class="comment">   /*! Last iax frame subclass sent or received for a iax2_pvt. 0x8000 bit is set on TX */</span>
<a name="l00623"></a><a class="code" href="structchan__iax2__pvt.html#ad236fe8543f05839d5978753bd7068a3">00623</a>    <span class="keywordtype">int</span> last_iax_message;<span class="comment"></span>
<a name="l00624"></a>00624 <span class="comment">   /*! True if the last voice we transmitted was not silence/CNG */</span>
<a name="l00625"></a><a class="code" href="structchan__iax2__pvt.html#a5ae15e9f658a6de2719dc28dc735ed7f">00625</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> notsilenttx:1;<span class="comment"></span>
<a name="l00626"></a>00626 <span class="comment">   /*! Ping time */</span>
<a name="l00627"></a><a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">00627</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> pingtime;<span class="comment"></span>
<a name="l00628"></a>00628 <span class="comment">   /*! Max time for initial response */</span>
<a name="l00629"></a><a class="code" href="structchan__iax2__pvt.html#a511d77bac179514b149c432cba8a920a">00629</a>    <span class="keywordtype">int</span> maxtime;<span class="comment"></span>
<a name="l00630"></a>00630 <span class="comment">   /*! Peer Address */</span>
<a name="l00631"></a><a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">00631</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>;<span class="comment"></span>
<a name="l00632"></a>00632 <span class="comment">   /*! Actual used codec preferences */</span>
<a name="l00633"></a><a class="code" href="structchan__iax2__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">00633</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;<span class="comment"></span>
<a name="l00634"></a>00634 <span class="comment">   /*! Requested codec preferences */</span>
<a name="l00635"></a><a class="code" href="structchan__iax2__pvt.html#a6b3f8d1d57c047529c48b59da2ccbced">00635</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> rprefs;<span class="comment"></span>
<a name="l00636"></a>00636 <span class="comment">   /*! Our call number */</span>
<a name="l00637"></a><a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">00637</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno;<span class="comment"></span>
<a name="l00638"></a>00638 <span class="comment">   /*! Our callno_entry entry */</span>
<a name="l00639"></a><a class="code" href="structchan__iax2__pvt.html#a9511e23258e37ebfeadfdb80d55c10f9">00639</a>    <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a>;<span class="comment"></span>
<a name="l00640"></a>00640 <span class="comment">   /*! Peer callno */</span>
<a name="l00641"></a><a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">00641</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> peercallno;<span class="comment"></span>
<a name="l00642"></a>00642 <span class="comment">   /*! Negotiated format, this is only used to remember what format was</span>
<a name="l00643"></a>00643 <span class="comment">       chosen for an unauthenticated call so that the channel can get</span>
<a name="l00644"></a>00644 <span class="comment">       created later using the right format */</span>
<a name="l00645"></a><a class="code" href="structchan__iax2__pvt.html#a118e127ad054dd53da114de1a0cb8522">00645</a>    <span class="keywordtype">int</span> chosenformat;<span class="comment"></span>
<a name="l00646"></a>00646 <span class="comment">   /*! Peer selected format */</span>
<a name="l00647"></a><a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">00647</a>    <span class="keywordtype">int</span> peerformat;<span class="comment"></span>
<a name="l00648"></a>00648 <span class="comment">   /*! Peer capability */</span>
<a name="l00649"></a><a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">00649</a>    <span class="keywordtype">int</span> peercapability;<span class="comment"></span>
<a name="l00650"></a>00650 <span class="comment">   /*! timeval that we base our transmission on */</span>
<a name="l00651"></a><a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">00651</a>    <span class="keyword">struct </span>timeval offset;<span class="comment"></span>
<a name="l00652"></a>00652 <span class="comment">   /*! timeval that we base our delivery on */</span>
<a name="l00653"></a><a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">00653</a>    <span class="keyword">struct </span>timeval rxcore;<span class="comment"></span>
<a name="l00654"></a>00654 <span class="comment">   /*! The jitterbuffer */</span>
<a name="l00655"></a><a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">00655</a>    <a class="code" href="structjitterbuf.html">jitterbuf</a> *jb;<span class="comment"></span>
<a name="l00656"></a>00656 <span class="comment">   /*! active jb read scheduler id */</span>
<a name="l00657"></a><a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">00657</a>    <span class="keywordtype">int</span> jbid;                       <span class="comment"></span>
<a name="l00658"></a>00658 <span class="comment">   /*! LAG */</span>
<a name="l00659"></a><a class="code" href="structchan__iax2__pvt.html#ad8e99943b4e40b52e9ecde280a212b37">00659</a>    <span class="keywordtype">int</span> lag;<span class="comment"></span>
<a name="l00660"></a>00660 <span class="comment">   /*! Error, as discovered by the manager */</span>
<a name="l00661"></a><a class="code" href="structchan__iax2__pvt.html#a11614f44ef4d939bdd984953346a7572">00661</a>    <span class="keywordtype">int</span> error;<span class="comment"></span>
<a name="l00662"></a>00662 <span class="comment">   /*! Owner if we have one */</span>
<a name="l00663"></a><a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">00663</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *owner;<span class="comment"></span>
<a name="l00664"></a>00664 <span class="comment">   /*! What&apos;s our state? */</span>
<a name="l00665"></a><a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">00665</a>    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="structstate.html">state</a>;<span class="comment"></span>
<a name="l00666"></a>00666 <span class="comment">   /*! Expiry (optional) */</span>
<a name="l00667"></a><a class="code" href="structchan__iax2__pvt.html#ace78f8a8d8e97294b2c81eece4bb8b4f">00667</a>    <span class="keywordtype">int</span> expiry;<span class="comment"></span>
<a name="l00668"></a>00668 <span class="comment">   /*! Next outgoing sequence number */</span>
<a name="l00669"></a><a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">00669</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> oseqno;<span class="comment"></span>
<a name="l00670"></a>00670 <span class="comment">   /*! Next sequence number they have not yet acknowledged */</span>
<a name="l00671"></a><a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">00671</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> rseqno;<span class="comment"></span>
<a name="l00672"></a>00672 <span class="comment">   /*! Next incoming sequence number */</span>
<a name="l00673"></a><a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">00673</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iseqno;<span class="comment"></span>
<a name="l00674"></a>00674 <span class="comment">   /*! Last incoming sequence number we have acknowledged */</span>
<a name="l00675"></a><a class="code" href="structchan__iax2__pvt.html#a994263e05f34cf3e146bd54903b7a053">00675</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> aseqno;
<a name="l00676"></a>00676 
<a name="l00677"></a>00677    <a class="code" href="stringfields_8h.html#a061580e89c55282a7140fa3fdfd52b6d" title="Declare the fields needed in a structure.">AST_DECLARE_STRING_FIELDS</a>(<span class="comment"></span>
<a name="l00678"></a>00678 <span class="comment">      /*! Peer name */</span>
<a name="l00679"></a>00679       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(peer);<span class="comment"></span>
<a name="l00680"></a>00680 <span class="comment">      /*! Default Context */</span>
<a name="l00681"></a>00681       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);<span class="comment"></span>
<a name="l00682"></a>00682 <span class="comment">      /*! Caller ID if available */</span>
<a name="l00683"></a>00683       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>);
<a name="l00684"></a>00684       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>);<span class="comment"></span>
<a name="l00685"></a>00685 <span class="comment">      /*! Hidden Caller ID (i.e. ANI) if appropriate */</span>
<a name="l00686"></a>00686       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(ani);<span class="comment"></span>
<a name="l00687"></a>00687 <span class="comment">      /*! DNID */</span>
<a name="l00688"></a>00688       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(dnid);<span class="comment"></span>
<a name="l00689"></a>00689 <span class="comment">      /*! RDNIS */</span>
<a name="l00690"></a>00690       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(rdnis);<span class="comment"></span>
<a name="l00691"></a>00691 <span class="comment">      /*! Requested Extension */</span>
<a name="l00692"></a>00692       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);<span class="comment"></span>
<a name="l00693"></a>00693 <span class="comment">      /*! Expected Username */</span>
<a name="l00694"></a>00694       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(username);<span class="comment"></span>
<a name="l00695"></a>00695 <span class="comment">      /*! Expected Secret */</span>
<a name="l00696"></a>00696       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>);<span class="comment"></span>
<a name="l00697"></a>00697 <span class="comment">      /*! MD5 challenge */</span>
<a name="l00698"></a>00698       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(challenge);<span class="comment"></span>
<a name="l00699"></a>00699 <span class="comment">      /*! Public keys permitted keys for incoming authentication */</span>
<a name="l00700"></a>00700       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(inkeys);<span class="comment"></span>
<a name="l00701"></a>00701 <span class="comment">      /*! Private key for outgoing authentication */</span>
<a name="l00702"></a>00702       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(outkey);<span class="comment"></span>
<a name="l00703"></a>00703 <span class="comment">      /*! Preferred language */</span>
<a name="l00704"></a>00704       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(language);<span class="comment"></span>
<a name="l00705"></a>00705 <span class="comment">      /*! Hostname/peername for naming purposes */</span>
<a name="l00706"></a>00706       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(host);
<a name="l00707"></a>00707 
<a name="l00708"></a>00708       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(dproot);
<a name="l00709"></a>00709       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(accountcode);
<a name="l00710"></a>00710       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(mohinterpret);
<a name="l00711"></a>00711       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(mohsuggest);<span class="comment"></span>
<a name="l00712"></a>00712 <span class="comment">      /*! received OSP token */</span>
<a name="l00713"></a>00713       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(osptoken);<span class="comment"></span>
<a name="l00714"></a>00714 <span class="comment">      /*! Default parkinglot */</span>
<a name="l00715"></a>00715       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>);
<a name="l00716"></a>00716    );<span class="comment"></span>
<a name="l00717"></a>00717 <span class="comment">   /*! AUTHREJ all AUTHREP frames */</span>
<a name="l00718"></a><a class="code" href="structchan__iax2__pvt.html#a8be922ac9e9631df65118757da989390">00718</a>    <span class="keywordtype">int</span> authrej;<span class="comment"></span>
<a name="l00719"></a>00719 <span class="comment">   /*! permitted authentication methods */</span>
<a name="l00720"></a><a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">00720</a>    <span class="keywordtype">int</span> authmethods;<span class="comment"></span>
<a name="l00721"></a>00721 <span class="comment">   /*! permitted encryption methods */</span>
<a name="l00722"></a><a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">00722</a>    <span class="keywordtype">int</span> encmethods;<span class="comment"></span>
<a name="l00723"></a>00723 <span class="comment">   /*! Encryption AES-128 Key */</span>
<a name="l00724"></a><a class="code" href="structchan__iax2__pvt.html#ae119b8bbe294cad12c32cd093eb81e4c">00724</a>    <a class="code" href="structaes__encrypt__ctx.html">ast_aes_encrypt_key</a> ecx;<span class="comment"></span>
<a name="l00725"></a>00725 <span class="comment">   /*! Decryption AES-128 Key corresponding to ecx */</span>
<a name="l00726"></a><a class="code" href="structchan__iax2__pvt.html#acb5abb83f0ce114bf0dee2c3217ff466">00726</a>    <a class="code" href="structaes__decrypt__ctx.html">ast_aes_decrypt_key</a> mydcx;<span class="comment"></span>
<a name="l00727"></a>00727 <span class="comment">   /*! Decryption AES-128 Key used to decrypt peer frames */</span>
<a name="l00728"></a><a class="code" href="structchan__iax2__pvt.html#ab0073ccb3c8600726f37b28438094bd8">00728</a>    <a class="code" href="structaes__decrypt__ctx.html">ast_aes_decrypt_key</a> dcx;<span class="comment"></span>
<a name="l00729"></a>00729 <span class="comment">   /*! scheduler id associated with iax_key_rotate </span>
<a name="l00730"></a>00730 <span class="comment">    * for encrypted calls*/</span>
<a name="l00731"></a><a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">00731</a>    <span class="keywordtype">int</span> keyrotateid;<span class="comment"></span>
<a name="l00732"></a>00732 <span class="comment">   /*! 32 bytes of semi-random data */</span>
<a name="l00733"></a><a class="code" href="structchan__iax2__pvt.html#a00f102e8d935ee4cfecea51855c146a9">00733</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> semirand[32];<span class="comment"></span>
<a name="l00734"></a>00734 <span class="comment">   /*! Associated registry */</span>
<a name="l00735"></a><a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">00735</a>    <span class="keyword">struct </span>iax2_registry *reg;<span class="comment"></span>
<a name="l00736"></a>00736 <span class="comment">   /*! Associated peer for poking */</span>
<a name="l00737"></a><a class="code" href="structchan__iax2__pvt.html#aee64b401a3bf4b7712eb81846d140df6">00737</a>    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peerpoke;<span class="comment"></span>
<a name="l00738"></a>00738 <span class="comment">   /*! IAX_ flags */</span>
<a name="l00739"></a><a class="code" href="structchan__iax2__pvt.html#ac92588540e8c1d014a08cd8a45462b19">00739</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l00740"></a><a class="code" href="structchan__iax2__pvt.html#a61fbadf21e15a109d0703a01e0302535">00740</a>    <span class="keywordtype">int</span> adsi;
<a name="l00741"></a>00741 <span class="comment"></span>
<a name="l00742"></a>00742 <span class="comment">   /*! Transferring status */</span>
<a name="l00743"></a><a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">00743</a>    <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6">iax_transfer_state</a> transferring;<span class="comment"></span>
<a name="l00744"></a>00744 <span class="comment">   /*! Transfer identifier */</span>
<a name="l00745"></a><a class="code" href="structchan__iax2__pvt.html#af2f1a1a9f5f5ef89eda74ce4b17a7889">00745</a>    <span class="keywordtype">int</span> transferid;<span class="comment"></span>
<a name="l00746"></a>00746 <span class="comment">   /*! Who we are IAX transferring to */</span>
<a name="l00747"></a><a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">00747</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>;<span class="comment"></span>
<a name="l00748"></a>00748 <span class="comment">   /*! What&apos;s the new call number for the transfer */</span>
<a name="l00749"></a><a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">00749</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> transfercallno;<span class="comment"></span>
<a name="l00750"></a>00750 <span class="comment">   /*! Transfer encrypt AES-128 Key */</span>
<a name="l00751"></a><a class="code" href="structchan__iax2__pvt.html#ab43ff869a32436ab9a284e723647235b">00751</a>    <a class="code" href="structaes__encrypt__ctx.html">ast_aes_encrypt_key</a> tdcx;
<a name="l00752"></a>00752 <span class="comment"></span>
<a name="l00753"></a>00753 <span class="comment">   /*! Status of knowledge of peer ADSI capability */</span>
<a name="l00754"></a><a class="code" href="structchan__iax2__pvt.html#a078ad1b9bbd2dab166a844bdb0d89b5c">00754</a>    <span class="keywordtype">int</span> peeradsicpe;
<a name="l00755"></a>00755 <span class="comment"></span>
<a name="l00756"></a>00756 <span class="comment">   /*! Who we are bridged to */</span>
<a name="l00757"></a><a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">00757</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> bridgecallno;
<a name="l00758"></a>00758    
<a name="l00759"></a><a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">00759</a>    <span class="keywordtype">int</span> pingid;       <span class="comment">/*!&lt; Transmit PING request */</span>
<a name="l00760"></a><a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">00760</a>    <span class="keywordtype">int</span> lagid;        <span class="comment">/*!&lt; Retransmit lag request */</span>
<a name="l00761"></a><a class="code" href="structchan__iax2__pvt.html#a59bae7aaf2ef69cbcf5ffb6e0b9ba060">00761</a>    <span class="keywordtype">int</span> autoid;       <span class="comment">/*!&lt; Auto hangup for Dialplan requestor */</span>
<a name="l00762"></a><a class="code" href="structchan__iax2__pvt.html#a94bf6ec5b99ea2a6378669fe6021e2e8">00762</a>    <span class="keywordtype">int</span> authid;       <span class="comment">/*!&lt; Authentication rejection ID */</span>
<a name="l00763"></a><a class="code" href="structchan__iax2__pvt.html#a2768911893070f3536acd19c6cb62819">00763</a>    <span class="keywordtype">int</span> authfail;        <span class="comment">/*!&lt; Reason to report failure */</span>
<a name="l00764"></a><a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">00764</a>    <span class="keywordtype">int</span> initid;       <span class="comment">/*!&lt; Initial peer auto-congest ID (based on qualified peers) */</span>
<a name="l00765"></a><a class="code" href="structchan__iax2__pvt.html#a57eabf92fe7c9f440fe38fb529c57f91">00765</a>    <span class="keywordtype">int</span> calling_ton;
<a name="l00766"></a><a class="code" href="structchan__iax2__pvt.html#a7ab4a847c94ceca414d76c2abe5587aa">00766</a>    <span class="keywordtype">int</span> calling_tns;
<a name="l00767"></a><a class="code" href="structchan__iax2__pvt.html#aa16fb44247d3656e98d82796a24c0ec6">00767</a>    <span class="keywordtype">int</span> calling_pres;
<a name="l00768"></a><a class="code" href="structchan__iax2__pvt.html#ad2cfb0f821c065261382a9298bb5a16b">00768</a>    <span class="keywordtype">int</span> amaflags;
<a name="l00769"></a>00769    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structiax2__dpcache.html">iax2_dpcache</a>) dpentries;<span class="comment"></span>
<a name="l00770"></a>00770 <span class="comment">   /*! variables inherited from the user definition */</span>
<a name="l00771"></a>00771    struct <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *vars;<span class="comment"></span>
<a name="l00772"></a>00772 <span class="comment">   /*! variables transmitted in a NEW packet */</span>
<a name="l00773"></a>00773    struct <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *iaxvars;<span class="comment"></span>
<a name="l00774"></a>00774 <span class="comment">   /*! last received remote rr */</span>
<a name="l00775"></a>00775    struct <a class="code" href="structiax__rr.html">iax_rr</a> remote_rr;<span class="comment"></span>
<a name="l00776"></a>00776 <span class="comment">   /*! Current base time: (just for stats) */</span>
<a name="l00777"></a>00777    <span class="keywordtype">int</span> min;<span class="comment"></span>
<a name="l00778"></a>00778 <span class="comment">   /*! Dropped frame count: (just for stats) */</span>
<a name="l00779"></a>00779    <span class="keywordtype">int</span> frames_dropped;<span class="comment"></span>
<a name="l00780"></a>00780 <span class="comment">   /*! received frame count: (just for stats) */</span>
<a name="l00781"></a>00781    <span class="keywordtype">int</span> frames_received;<span class="comment"></span>
<a name="l00782"></a>00782 <span class="comment">   /*! num bytes used for calltoken ie, even an empty ie should contain 2 */</span>
<a name="l00783"></a>00783    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> calltoken_ie_len;<span class="comment"></span>
<a name="l00784"></a>00784 <span class="comment">   /*! hold all signaling frames from the pbx thread until we have a destination callno */</span>
<a name="l00785"></a>00785    <span class="keywordtype">char</span> hold_signaling;<span class="comment"></span>
<a name="l00786"></a>00786 <span class="comment">   /*! frame queue for signaling frames from pbx thread waiting for destination callno */</span>
<a name="l00787"></a>00787    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(signaling_queue, <a class="code" href="structsignaling__queue__entry.html">signaling_queue_entry</a>) signaling_queue;
<a name="l00788"></a>00788 };
<a name="l00789"></a>00789 
<a name="l00790"></a><a class="code" href="structsignaling__queue__entry.html">00790</a> struct <a class="code" href="structsignaling__queue__entry.html">signaling_queue_entry</a> {
<a name="l00791"></a><a class="code" href="structsignaling__queue__entry.html#a735f764b1095611ace084e7c6c06857d">00791</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00792"></a>00792    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(signaling_queue_entry) next;
<a name="l00793"></a>00793 };
<a name="l00794"></a>00794 <span class="comment"></span>
<a name="l00795"></a>00795 <span class="comment">/*! table of available call numbers */</span>
<a name="l00796"></a><a class="code" href="chan__iax2_8c.html#a341ab1e8292460d49b81d5f4d2952075">00796</a> static struct <a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#a341ab1e8292460d49b81d5f4d2952075">callno_pool</a>;
<a name="l00797"></a>00797 <span class="comment"></span>
<a name="l00798"></a>00798 <span class="comment">/*! table of available trunk call numbers */</span>
<a name="l00799"></a><a class="code" href="chan__iax2_8c.html#adf7b7b9b71fa81da906eb05a0cb13124">00799</a> static struct <a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#adf7b7b9b71fa81da906eb05a0cb13124">callno_pool_trunk</a>;
<a name="l00800"></a>00800 
<a name="l00801"></a><a class="code" href="chan__iax2_8c.html#aa5ecfd5a7db1eae1e17cf766b32a8f0a">00801</a> static const <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa5ecfd5a7db1eae1e17cf766b32a8f0a">CALLNO_POOL_BUCKETS</a> = 2699;
<a name="l00802"></a>00802 <span class="comment"></span>
<a name="l00803"></a>00803 <span class="comment">/*!</span>
<a name="l00804"></a>00804 <span class="comment"> * \brief a list of frames that may need to be retransmitted</span>
<a name="l00805"></a>00805 <span class="comment"> *</span>
<a name="l00806"></a>00806 <span class="comment"> * \note The contents of this list do not need to be explicitly destroyed</span>
<a name="l00807"></a>00807 <span class="comment"> * on module unload.  This is because all active calls are destroyed, and</span>
<a name="l00808"></a>00808 <span class="comment"> * all frames in this queue will get destroyed as a part of that process.</span>
<a name="l00809"></a>00809 <span class="comment"> */</span>
<a name="l00810"></a>00810 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(frame_queue, <a class="code" href="structiax__frame.html">iax_frame</a>);
<a name="l00811"></a>00811 
<a name="l00812"></a><a class="code" href="chan__iax2_8c.html#a10cc871ecd97bf24650d3d478d6b7305">00812</a> static <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a10cc871ecd97bf24650d3d478d6b7305">randomcalltokendata</a>;
<a name="l00813"></a>00813 
<a name="l00814"></a><a class="code" href="chan__iax2_8c.html#ac29205ed412a1bfc5c278db4b7788388">00814</a> static const time_t <a class="code" href="chan__iax2_8c.html#ac29205ed412a1bfc5c278db4b7788388">MAX_CALLTOKEN_DELAY</a> = 10;
<a name="l00815"></a>00815 <span class="comment"></span>
<a name="l00816"></a>00816 <span class="comment">/*!</span>
<a name="l00817"></a>00817 <span class="comment"> * This module will get much higher performance when doing a lot of</span>
<a name="l00818"></a>00818 <span class="comment"> * user and peer lookups if the number of buckets is increased from 1.</span>
<a name="l00819"></a>00819 <span class="comment"> * However, to maintain old behavior for Asterisk 1.4, these are set to</span>
<a name="l00820"></a>00820 <span class="comment"> * 1 by default.  When using multiple buckets, search order through these</span>
<a name="l00821"></a>00821 <span class="comment"> * containers is considered random, so you will not be able to depend on</span>
<a name="l00822"></a>00822 <span class="comment"> * the order the entires are specified in iax.conf for matching order. */</span>
<a name="l00823"></a>00823 <span class="preprocessor">#ifdef LOW_MEMORY</span>
<a name="l00824"></a>00824 <span class="preprocessor"></span><span class="preprocessor">#define MAX_PEER_BUCKETS 17</span>
<a name="l00825"></a>00825 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00826"></a><a class="code" href="chan__iax2_8c.html#af951e872e0ade75ce2faa6b5660ab78a">00826</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_PEER_BUCKETS 563</span>
<a name="l00827"></a>00827 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00828"></a><a class="code" href="chan__iax2_8c.html#a4e2275900b4d74cdd6b30e894c6a1d46">00828</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="structpeers.html">peers</a>;
<a name="l00829"></a>00829 
<a name="l00830"></a><a class="code" href="chan__iax2_8c.html#a0093d2299b135a3be5d1e7775f2af02d">00830</a> <span class="preprocessor">#define MAX_USER_BUCKETS MAX_PEER_BUCKETS</span>
<a name="l00831"></a><a class="code" href="chan__iax2_8c.html#a83dc8a4d62a5fdcd27ed6756cdaeb114">00831</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="structusers.html" title="list of users found in the config file">users</a>;
<a name="l00832"></a>00832 <span class="comment"></span>
<a name="l00833"></a>00833 <span class="comment">/*! Table containing peercnt objects for every ip address consuming a callno */</span>
<a name="l00834"></a><a class="code" href="chan__iax2_8c.html#a04fd856637ffe2774c6040355b3b19e2">00834</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#a04fd856637ffe2774c6040355b3b19e2">peercnts</a>;
<a name="l00835"></a>00835 <span class="comment"></span>
<a name="l00836"></a>00836 <span class="comment">/*! Table containing custom callno limit rules for a range of ip addresses. */</span>
<a name="l00837"></a><a class="code" href="chan__iax2_8c.html#a568245f32e68015f2f73397fb5c2217f">00837</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#a568245f32e68015f2f73397fb5c2217f">callno_limits</a>;
<a name="l00838"></a>00838 <span class="comment"></span>
<a name="l00839"></a>00839 <span class="comment">/*! Table containing ip addresses not requiring calltoken validation */</span>
<a name="l00840"></a><a class="code" href="chan__iax2_8c.html#abf9b42ea92d3db5c6a644abe92f82921">00840</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#abf9b42ea92d3db5c6a644abe92f82921">calltoken_ignores</a>;
<a name="l00841"></a>00841 
<a name="l00842"></a><a class="code" href="chan__iax2_8c.html#a38887f23a5179b7a2e411bad384a3870">00842</a> <span class="keyword">static</span> uint16_t <a class="code" href="chan__iax2_8c.html#a38887f23a5179b7a2e411bad384a3870">DEFAULT_MAXCALLNO_LIMIT</a> = 2048;
<a name="l00843"></a>00843 
<a name="l00844"></a><a class="code" href="chan__iax2_8c.html#a35d1e4673eb120a4cca904da0b9947e0">00844</a> <span class="keyword">static</span> uint16_t <a class="code" href="chan__iax2_8c.html#a35d1e4673eb120a4cca904da0b9947e0">DEFAULT_MAXCALLNO_LIMIT_NONVAL</a> = 8192;
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="chan__iax2_8c.html#ae47c0fcaab3a7ebdae237431bdabcf55">00846</a> <span class="keyword">static</span> uint16_t <a class="code" href="chan__iax2_8c.html#ae47c0fcaab3a7ebdae237431bdabcf55">global_maxcallno</a>;
<a name="l00847"></a>00847 <span class="comment"></span>
<a name="l00848"></a>00848 <span class="comment">/*! Total num of call numbers allowed to be allocated without calltoken validation */</span>
<a name="l00849"></a><a class="code" href="chan__iax2_8c.html#a3e693433438cbe30cc9ae786c1052350">00849</a> <span class="keyword">static</span> uint16_t <a class="code" href="chan__iax2_8c.html#a3e693433438cbe30cc9ae786c1052350">global_maxcallno_nonval</a>;
<a name="l00850"></a>00850 
<a name="l00851"></a><a class="code" href="chan__iax2_8c.html#a7007ab48ea99c15b2e7e6de14f705d37">00851</a> <span class="keyword">static</span> uint16_t <a class="code" href="chan__iax2_8c.html#a7007ab48ea99c15b2e7e6de14f705d37">total_nonval_callno_used</a> = 0;
<a name="l00852"></a>00852 <span class="comment"></span>
<a name="l00853"></a>00853 <span class="comment">/*! peer connection private, keeps track of all the call numbers</span>
<a name="l00854"></a>00854 <span class="comment"> *  consumed by a single ip address */</span>
<a name="l00855"></a><a class="code" href="structpeercnt.html">00855</a> <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> {<span class="comment"></span>
<a name="l00856"></a>00856 <span class="comment">   /*! ip address consuming call numbers */</span>
<a name="l00857"></a><a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">00857</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>;<span class="comment"></span>
<a name="l00858"></a>00858 <span class="comment">   /*! Number of call numbers currently used by this ip address */</span>
<a name="l00859"></a><a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">00859</a>    uint16_t cur;<span class="comment"></span>
<a name="l00860"></a>00860 <span class="comment">   /*! Max call numbers allowed for this ip address */</span>
<a name="l00861"></a><a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">00861</a>    uint16_t limit;<span class="comment"></span>
<a name="l00862"></a>00862 <span class="comment">   /*! Specifies whether limit is set by a registration or not, if so normal</span>
<a name="l00863"></a>00863 <span class="comment">    *  limit setting rules do not apply to this address. */</span>
<a name="l00864"></a><a class="code" href="structpeercnt.html#a1d7b6d3b02227576b00992aece354e8d">00864</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> reg;
<a name="l00865"></a>00865 };
<a name="l00866"></a>00866 <span class="comment"></span>
<a name="l00867"></a>00867 <span class="comment">/*! used by both callno_limits and calltoken_ignores containers */</span>
<a name="l00868"></a><a class="code" href="structaddr__range.html">00868</a> <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> {<span class="comment"></span>
<a name="l00869"></a>00869 <span class="comment">   /*! ip address range for custom callno limit rule */</span>
<a name="l00870"></a><a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">00870</a>    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> ha;<span class="comment"></span>
<a name="l00871"></a>00871 <span class="comment">   /*! callno limit for this ip address range, only used in callno_limits container */</span>
<a name="l00872"></a><a class="code" href="structaddr__range.html#ab28e82ae69032cb4ad3ec3a0be3d7129">00872</a>    uint16_t limit;<span class="comment"></span>
<a name="l00873"></a>00873 <span class="comment">   /*! delete me marker for reloads */</span>
<a name="l00874"></a><a class="code" href="structaddr__range.html#aaf5ee49ffd469534bb3c2e3bf68dc510">00874</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> delme;
<a name="l00875"></a>00875 };
<a name="l00876"></a>00876 
<a name="l00877"></a><a class="code" href="structcallno__entry.html">00877</a> <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> {<span class="comment"></span>
<a name="l00878"></a>00878 <span class="comment">   /*! callno used for this entry */</span>
<a name="l00879"></a><a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">00879</a>    uint16_t callno;<span class="comment"></span>
<a name="l00880"></a>00880 <span class="comment">   /*! was this callno calltoken validated or not */</span>
<a name="l00881"></a><a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">00881</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> validated;
<a name="l00882"></a>00882 };
<a name="l00883"></a>00883 
<a name="l00884"></a>00884 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(firmwares, <a class="code" href="structiax__firmware.html">iax_firmware</a>);
<a name="l00885"></a>00885 
<a name="l00886"></a>00886 <span class="keyword">enum</span> {<span class="comment"></span>
<a name="l00887"></a>00887 <span class="comment">   /*! Extension exists */</span>
<a name="l00888"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a237ba33c07f39880a6da1134630be695">00888</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a237ba33c07f39880a6da1134630be695">CACHE_FLAG_EXISTS</a>      = (1 &lt;&lt; 0),<span class="comment"></span>
<a name="l00889"></a>00889 <span class="comment">   /*! Extension is nonexistent */</span>
<a name="l00890"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493adfc168b6cdf09223dad610c65b04c19e">00890</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493adfc168b6cdf09223dad610c65b04c19e">CACHE_FLAG_NONEXISTENT</a> = (1 &lt;&lt; 1),<span class="comment"></span>
<a name="l00891"></a>00891 <span class="comment">   /*! Extension can exist */</span>
<a name="l00892"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a9cc184231f4419e681d6de9ca43df81a">00892</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a9cc184231f4419e681d6de9ca43df81a">CACHE_FLAG_CANEXIST</a>    = (1 &lt;&lt; 2),<span class="comment"></span>
<a name="l00893"></a>00893 <span class="comment">   /*! Waiting to hear back response */</span>
<a name="l00894"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">00894</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>     = (1 &lt;&lt; 3),<span class="comment"></span>
<a name="l00895"></a>00895 <span class="comment">   /*! Timed out */</span>
<a name="l00896"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a049a9a889bef0328a9a726036fc45aac">00896</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a049a9a889bef0328a9a726036fc45aac">CACHE_FLAG_TIMEOUT</a>     = (1 &lt;&lt; 4),<span class="comment"></span>
<a name="l00897"></a>00897 <span class="comment">   /*! Request transmitted */</span>
<a name="l00898"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493af75a0829e95bf2ea13767b29d505a5ed">00898</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493af75a0829e95bf2ea13767b29d505a5ed">CACHE_FLAG_TRANSMITTED</a> = (1 &lt;&lt; 5),<span class="comment"></span>
<a name="l00899"></a>00899 <span class="comment">   /*! Timeout */</span>
<a name="l00900"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a354d01072cc821460370e437dbca151e">00900</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a354d01072cc821460370e437dbca151e">CACHE_FLAG_UNKNOWN</a>     = (1 &lt;&lt; 6),<span class="comment"></span>
<a name="l00901"></a>00901 <span class="comment">   /*! Matchmore */</span>
<a name="l00902"></a><a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a497c2d7c7e5e120d0f497fac309d65c5">00902</a>    <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a497c2d7c7e5e120d0f497fac309d65c5">CACHE_FLAG_MATCHMORE</a>   = (1 &lt;&lt; 7),
<a name="l00903"></a>00903 };
<a name="l00904"></a>00904 
<a name="l00905"></a><a class="code" href="structiax2__dpcache.html">00905</a> <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> {
<a name="l00906"></a><a class="code" href="structiax2__dpcache.html#ac95e38343e3ce6cbca0a07c0d38c093a">00906</a>    <span class="keywordtype">char</span> peercontext[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];
<a name="l00907"></a><a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">00907</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l00908"></a><a class="code" href="structiax2__dpcache.html#a9192c26844abf50c80ad5803b710a904">00908</a>    <span class="keyword">struct </span>timeval orig;
<a name="l00909"></a><a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">00909</a>    <span class="keyword">struct </span>timeval expiry;
<a name="l00910"></a><a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">00910</a>    <span class="keywordtype">int</span> flags;
<a name="l00911"></a><a class="code" href="structiax2__dpcache.html#a80cb2705f540fcd4a6d6276addb98819">00911</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno;
<a name="l00912"></a><a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">00912</a>    <span class="keywordtype">int</span> waiters[256];
<a name="l00913"></a>00913    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structiax2__dpcache.html">iax2_dpcache</a>) cache_list;
<a name="l00914"></a>00914    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structiax2__dpcache.html">iax2_dpcache</a>) peer_list;
<a name="l00915"></a>00915 };
<a name="l00916"></a>00916 
<a name="l00917"></a>00917 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(dpcache, <a class="code" href="structiax2__dpcache.html">iax2_dpcache</a>);
<a name="l00918"></a>00918 
<a name="l00919"></a>00919 static <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a53f291d9224d73701f3a2a097d2457a7">reg_source_db</a>(struct <a class="code" href="structiax2__peer.html">iax2_peer</a> *p);
<a name="l00920"></a>00920 static struct <a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">realtime_peer</a>(const <span class="keywordtype">char</span> *peername, struct sockaddr_in *sin);
<a name="l00921"></a>00921 static struct <a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#afb25e20b1fe40ed319996fdd9c289085">realtime_user</a>(const <span class="keywordtype">char</span> *username, struct sockaddr_in *sin);
<a name="l00922"></a>00922 
<a name="l00923"></a>00923 static <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa97568aae0bbccb48217b5bd8e96bf3a">ast_cli_netstats</a>(struct <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> limit_fmt);
<a name="l00924"></a>00924 static <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a4c1705908c9696e6bd564ca8bd297a4d">complete_iax2_peers</a>(const <span class="keywordtype">char</span> *line, const <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">int</span> flags);
<a name="l00925"></a>00925 static <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#abe7189ac2109339aabccb7a46b915110">complete_iax2_unregister</a>(const <span class="keywordtype">char</span> *line, const <span class="keywordtype">char</span> *word, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> state);
<a name="l00926"></a>00926 
<a name="l00927"></a><a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3">00927</a> enum <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3">iax2_thread_iostate</a> {
<a name="l00928"></a><a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">00928</a>    <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">IAX_IOSTATE_IDLE</a>,
<a name="l00929"></a><a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3ac99d54ed94b3fffa9269fc588e37122d">00929</a>    <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3ac99d54ed94b3fffa9269fc588e37122d">IAX_IOSTATE_READY</a>,
<a name="l00930"></a><a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a20ef1b3afb82bc33e11a43687b95c0cc">00930</a>    <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a20ef1b3afb82bc33e11a43687b95c0cc">IAX_IOSTATE_PROCESSING</a>,
<a name="l00931"></a><a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a758a8b5bbba4debe9f4c40ace2526563">00931</a>    <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a758a8b5bbba4debe9f4c40ace2526563">IAX_IOSTATE_SCHEDREADY</a>,
<a name="l00932"></a>00932 };
<a name="l00933"></a>00933 
<a name="l00934"></a><a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7">00934</a> <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7">iax2_thread_type</a> {
<a name="l00935"></a><a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7ac270aa278d19d5394cdfd5dd3552b5d7">00935</a>    <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7ac270aa278d19d5394cdfd5dd3552b5d7">IAX_THREAD_TYPE_POOL</a>,
<a name="l00936"></a><a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7a0acfd1204de5016e9d076890e96a7d95">00936</a>    <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7a0acfd1204de5016e9d076890e96a7d95">IAX_THREAD_TYPE_DYNAMIC</a>,
<a name="l00937"></a>00937 };
<a name="l00938"></a>00938 
<a name="l00939"></a><a class="code" href="structiax2__pkt__buf.html">00939</a> <span class="keyword">struct </span><a class="code" href="structiax2__pkt__buf.html">iax2_pkt_buf</a> {
<a name="l00940"></a>00940    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structiax2__pkt__buf.html">iax2_pkt_buf</a>) entry;
<a name="l00941"></a>00941    <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00942"></a>00942    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1];
<a name="l00943"></a>00943 };
<a name="l00944"></a>00944 
<a name="l00945"></a><a class="code" href="structiax2__thread.html">00945</a> <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> {
<a name="l00946"></a><a class="code" href="structiax2__thread.html#a6604ad65895fd95735e5b38849d1d4de">00946</a>    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structiax2__thread.html">iax2_thread</a>) list;
<a name="l00947"></a>00947    enum <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7">iax2_thread_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>;
<a name="l00948"></a>00948    enum <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3">iax2_thread_iostate</a> iostate;
<a name="l00949"></a>00949 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l00950"></a>00950 <span class="preprocessor"></span>   void (*schedfunc)(<span class="keyword">const</span> <span class="keywordtype">void</span> *);
<a name="l00951"></a>00951    <span class="keyword">const</span> <span class="keywordtype">void</span> *scheddata;
<a name="l00952"></a>00952 <span class="preprocessor">#endif</span>
<a name="l00953"></a>00953 <span class="preprocessor"></span><span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l00954"></a>00954 <span class="preprocessor"></span>   <span class="keywordtype">char</span> curfunc[80];
<a name="l00955"></a>00955 <span class="preprocessor">#endif   </span>
<a name="l00956"></a>00956 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="structactions.html" title="list of actions registered">actions</a>;
<a name="l00957"></a>00957    pthread_t threadid;
<a name="l00958"></a>00958    <span class="keywordtype">int</span> threadnum;
<a name="l00959"></a>00959    <span class="keyword">struct </span>sockaddr_in iosin;
<a name="l00960"></a>00960    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> readbuf[4096]; 
<a name="l00961"></a>00961    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>;
<a name="l00962"></a>00962    ssize_t buf_len;
<a name="l00963"></a>00963    <span class="keywordtype">size_t</span> buf_size;
<a name="l00964"></a>00964    <span class="keywordtype">int</span> iofd;
<a name="l00965"></a>00965    time_t checktime;
<a name="l00966"></a>00966    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l00967"></a>00967    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>;
<a name="l00968"></a>00968    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> init_lock;
<a name="l00969"></a>00969    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> init_cond;<span class="comment"></span>
<a name="l00970"></a>00970 <span class="comment">   /*! if this thread is processing a full frame,</span>
<a name="l00971"></a>00971 <span class="comment">     some information about that frame will be stored</span>
<a name="l00972"></a>00972 <span class="comment">     here, so we can avoid dispatching any more full</span>
<a name="l00973"></a>00973 <span class="comment">     frames for that callno to other threads */</span>
<a name="l00974"></a>00974    <span class="keyword">struct </span>{
<a name="l00975"></a>00975       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno;
<a name="l00976"></a>00976       <span class="keyword">struct </span>sockaddr_in sin;
<a name="l00977"></a>00977       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> type;
<a name="l00978"></a>00978       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> csub;
<a name="l00979"></a><a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">00979</a>    } ffinfo;<span class="comment"></span>
<a name="l00980"></a>00980 <span class="comment">   /*! Queued up full frames for processing.  If more full frames arrive for</span>
<a name="l00981"></a>00981 <span class="comment">    *  a call which this thread is already processing a full frame for, they</span>
<a name="l00982"></a>00982 <span class="comment">    *  are queued up here. */</span>
<a name="l00983"></a>00983    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structiax2__pkt__buf.html">iax2_pkt_buf</a>) full_frames;
<a name="l00984"></a>00984 };
<a name="l00985"></a>00985 
<a name="l00986"></a>00986 <span class="comment">/* Thread lists */</span>
<a name="l00987"></a>00987 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(idle_list, <a class="code" href="structiax2__thread.html">iax2_thread</a>);
<a name="l00988"></a>00988 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(active_list, iax2_thread);
<a name="l00989"></a>00989 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(dynamic_list, iax2_thread);
<a name="l00990"></a>00990 
<a name="l00991"></a>00991 static <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#a4b01adf25449fb80786fe1af045c3d0c">iax2_process_thread</a>(<span class="keywordtype">void</span> *data);
<a name="l00992"></a>00992 static <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(<span class="keywordtype">int</span> callno);
<a name="l00993"></a>00993 
<a name="l00994"></a><a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">00994</a> static <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(<a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> *<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>, <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> *<a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>)
<a name="l00995"></a>00995 {
<a name="l00996"></a>00996    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(lock);
<a name="l00997"></a>00997    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(cond);
<a name="l00998"></a>00998    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(lock);
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 <span class="comment"></span>
<a name="l01001"></a>01001 <span class="comment">/*!</span>
<a name="l01002"></a>01002 <span class="comment"> * \brief an array of iax2 pvt structures</span>
<a name="l01003"></a>01003 <span class="comment"> *</span>
<a name="l01004"></a>01004 <span class="comment"> * The container for active chan_iax2_pvt structures is implemented as an</span>
<a name="l01005"></a>01005 <span class="comment"> * array for extremely quick direct access to the correct pvt structure</span>
<a name="l01006"></a>01006 <span class="comment"> * based on the local call number.  The local call number is used as the</span>
<a name="l01007"></a>01007 <span class="comment"> * index into the array where the associated pvt structure is stored.</span>
<a name="l01008"></a>01008 <span class="comment"> */</span>
<a name="l01009"></a><a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7">01009</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[<a class="code" href="iax2_8h.html#ae9b21f0bc9515b8e4d605437993b5b5f">IAX_MAX_CALLS</a> + 1];
<a name="l01010"></a>01010 <span class="comment"></span>
<a name="l01011"></a>01011 <span class="comment">/*!</span>
<a name="l01012"></a>01012 <span class="comment"> * \brief Another container of iax2_pvt structures</span>
<a name="l01013"></a>01013 <span class="comment"> *</span>
<a name="l01014"></a>01014 <span class="comment"> * Active IAX2 pvt structs are also stored in this container, if they are a part</span>
<a name="l01015"></a>01015 <span class="comment"> * of an active call where we know the remote side&apos;s call number.  The reason</span>
<a name="l01016"></a>01016 <span class="comment"> * for this is that incoming media frames do not contain our call number.  So,</span>
<a name="l01017"></a>01017 <span class="comment"> * instead of having to iterate the entire iaxs array, we use this container to</span>
<a name="l01018"></a>01018 <span class="comment"> * look up calls where the remote side is using a given call number.</span>
<a name="l01019"></a>01019 <span class="comment"> */</span>
<a name="l01020"></a><a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de">01020</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>;
<a name="l01021"></a>01021 <span class="comment"></span>
<a name="l01022"></a>01022 <span class="comment">/*!</span>
<a name="l01023"></a>01023 <span class="comment"> * \brief chan_iax2_pvt structure locks</span>
<a name="l01024"></a>01024 <span class="comment"> *</span>
<a name="l01025"></a>01025 <span class="comment"> * These locks are used when accessing a pvt structure in the iaxs array.</span>
<a name="l01026"></a>01026 <span class="comment"> * The index used here is the same as used in the iaxs array.  It is the</span>
<a name="l01027"></a>01027 <span class="comment"> * local call number for the associated pvt struct.</span>
<a name="l01028"></a>01028 <span class="comment"> */</span>
<a name="l01029"></a><a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376">01029</a> <span class="keyword">static</span> <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[<a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>)];
<a name="l01030"></a>01030 <span class="comment"></span>
<a name="l01031"></a>01031 <span class="comment">/*!</span>
<a name="l01032"></a>01032 <span class="comment"> *  * \brief Another container of iax2_pvt structures</span>
<a name="l01033"></a>01033 <span class="comment"> *  </span>
<a name="l01034"></a>01034 <span class="comment"> *  Active IAX2 pvt stucts used during transfering a call are stored here.  </span>
<a name="l01035"></a>01035 <span class="comment"> */</span>
<a name="l01036"></a><a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474">01036</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>;
<a name="l01037"></a>01037 
<a name="l01038"></a>01038 <span class="comment">/* Flag to use with trunk calls, keeping these calls high up.  It halves our effective use</span>
<a name="l01039"></a>01039 <span class="comment">   but keeps the division between trunked and non-trunked better. */</span>
<a name="l01040"></a><a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">01040</a> <span class="preprocessor">#define TRUNK_CALL_START   IAX_MAX_CALLS / 2</span>
<a name="l01041"></a>01041 <span class="preprocessor"></span>
<a name="l01042"></a>01042 <span class="comment">/* Debug routines... */</span>
<a name="l01043"></a><a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">01043</a> <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in <a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>;
<a name="l01044"></a>01044 
<a name="l01045"></a><a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">01045</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">iax_outputframe</a>(<span class="keyword">struct</span> iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fhi, <span class="keywordtype">int</span> rx, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> datalen)
<a name="l01046"></a>01046 {
<a name="l01047"></a>01047    <span class="keywordflow">if</span> (iaxdebug ||
<a name="l01048"></a>01048        (sin &amp;&amp; <a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_addr.s_addr &amp;&amp; 
<a name="l01049"></a>01049         (!ntohs(<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_port) ||
<a name="l01050"></a>01050          <a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_port == sin-&gt;sin_port) &amp;&amp;
<a name="l01051"></a>01051         <a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_addr.s_addr == sin-&gt;sin_addr.s_addr)) {
<a name="l01052"></a>01052       <span class="keywordflow">if</span> (iaxdebug) {
<a name="l01053"></a>01053          <a class="code" href="iax2-parser_8c.html#a2865d35dffad22a73ab8f0ef67db8b99">iax_showframe</a>(f, fhi, rx, sin, datalen);
<a name="l01054"></a>01054       } <span class="keywordflow">else</span> {
<a name="l01055"></a>01055          iaxdebug = 1;
<a name="l01056"></a>01056          <a class="code" href="iax2-parser_8c.html#a2865d35dffad22a73ab8f0ef67db8b99">iax_showframe</a>(f, fhi, rx, sin, datalen);
<a name="l01057"></a>01057          iaxdebug = 0;
<a name="l01058"></a>01058       }
<a name="l01059"></a>01059    }
<a name="l01060"></a>01060 }
<a name="l01061"></a>01061 
<a name="l01062"></a><a class="code" href="chan__iax2_8c.html#a3d74c6e06cab9e36d323b36c830052f4">01062</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a3d74c6e06cab9e36d323b36c830052f4">iax_debug_output</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l01063"></a>01063 {
<a name="l01064"></a>01064    <span class="keywordflow">if</span> (iaxdebug)
<a name="l01065"></a>01065       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;%s&quot;</span>, data);
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01068"></a><a class="code" href="chan__iax2_8c.html#a2b63a2e2db657cf7f745228ea6f573b4">01068</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a2b63a2e2db657cf7f745228ea6f573b4">iax_error_output</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l01069"></a>01069 {
<a name="l01070"></a>01070    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s&quot;</span>, data);
<a name="l01071"></a>01071 }
<a name="l01072"></a>01072 
<a name="l01073"></a><a class="code" href="chan__iax2_8c.html#a151931af9817e64f2785ab62a97fee11">01073</a> <span class="keyword">static</span> <span class="keywordtype">void</span> __attribute__((<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>(printf, 1, 2))) <a class="code" href="chan__iax2_8c.html#a151931af9817e64f2785ab62a97fee11">jb_error_output</a>(const <span class="keywordtype">char</span> *fmt, ...)
<a name="l01074"></a>01074 {
<a name="l01075"></a>01075    va_list args;
<a name="l01076"></a>01076    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l01077"></a>01077 
<a name="l01078"></a>01078    va_start(args, fmt);
<a name="l01079"></a>01079    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), fmt, args);
<a name="l01080"></a>01080    va_end(args);
<a name="l01081"></a>01081 
<a name="l01082"></a>01082    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s&quot;</span>, buf);
<a name="l01083"></a>01083 }
<a name="l01084"></a>01084 
<a name="l01085"></a><a class="code" href="chan__iax2_8c.html#ab56f48224a51b039df6eee8168cc6e96">01085</a> <span class="keyword">static</span> <span class="keywordtype">void</span> __attribute__((<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>(printf, 1, 2))) <a class="code" href="chan__iax2_8c.html#ab56f48224a51b039df6eee8168cc6e96">jb_warning_output</a>(const <span class="keywordtype">char</span> *fmt, ...)
<a name="l01086"></a>01086 {
<a name="l01087"></a>01087    va_list args;
<a name="l01088"></a>01088    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l01089"></a>01089 
<a name="l01090"></a>01090    va_start(args, fmt);
<a name="l01091"></a>01091    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), fmt, args);
<a name="l01092"></a>01092    va_end(args);
<a name="l01093"></a>01093 
<a name="l01094"></a>01094    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s&quot;</span>, buf);
<a name="l01095"></a>01095 }
<a name="l01096"></a>01096 
<a name="l01097"></a><a class="code" href="chan__iax2_8c.html#a40ecc93fa72cd6980c5ea3cba315d11d">01097</a> <span class="keyword">static</span> <span class="keywordtype">void</span> __attribute__((<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>(printf, 1, 2))) <a class="code" href="chan__iax2_8c.html#a40ecc93fa72cd6980c5ea3cba315d11d">jb_debug_output</a>(const <span class="keywordtype">char</span> *fmt, ...)
<a name="l01098"></a>01098 {
<a name="l01099"></a>01099    va_list args;
<a name="l01100"></a>01100    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l01101"></a>01101 
<a name="l01102"></a>01102    va_start(args, fmt);
<a name="l01103"></a>01103    vsnprintf(buf, <span class="keyword">sizeof</span>(buf), fmt, args);
<a name="l01104"></a>01104    va_end(args);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106    <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;%s&quot;</span>, buf);
<a name="l01107"></a>01107 }
<a name="l01108"></a>01108 
<a name="l01109"></a><a class="code" href="chan__iax2_8c.html#a0adf1f10ece8bb420a7538be14aeeb8a">01109</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0adf1f10ece8bb420a7538be14aeeb8a">maxtrunkcall</a> = <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>;
<a name="l01110"></a><a class="code" href="chan__iax2_8c.html#ab3fe1bdf89336ce3c36bb6bbc3d085ae">01110</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab3fe1bdf89336ce3c36bb6bbc3d085ae">maxnontrunkcall</a> = 1;
<a name="l01111"></a>01111 
<a name="l01112"></a>01112 <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> <a class="code" href="chan__iax2_8c.html#a2ac728e203e330d25beb144f2ccbac7f">iax2_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c1, <span class="keywordtype">int</span> flags, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> **fo, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **rc, <span class="keywordtype">int</span> timeoutms);
<a name="l01113"></a>01113 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data);
<a name="l01114"></a>01114 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a76f9db3943af0e0cf07ded5f2f6640c3">iax2_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c);
<a name="l01115"></a>01115 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#acfb7625fffb7d724ce068b63af1ef059">iax2_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout);
<a name="l01116"></a>01116 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a515bccac6d7dd9eb618205747a40bdad" title="Part of the device state notification system ---.">iax2_devicestate</a>(<span class="keywordtype">void</span> *data);
<a name="l01117"></a>01117 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a4ca36cb64d4c1e5e0c424f4bcd32fa5c">iax2_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit);
<a name="l01118"></a>01118 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a34ff90ed6262326696cb6a0921fa6ffc">iax2_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration);
<a name="l01119"></a>01119 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">iax2_do_register</a>(<span class="keyword">struct</span> iax2_registry *reg);
<a name="l01120"></a>01120 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3cd64402c0950d2f09e22986cf109e8c">iax2_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchannel, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan);
<a name="l01121"></a>01121 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a21a2f61a4598a0bb8e499cbb119f775c">iax2_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c);
<a name="l01122"></a>01122 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a01c296968962704d146fb5d092dae41d">iax2_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen);
<a name="l01123"></a>01123 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer, <span class="keywordtype">int</span> heldcall);
<a name="l01124"></a>01124 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">iax2_provision</a>(<span class="keyword">struct</span> sockaddr_in *end, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">char</span> *dest, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>, <span class="keywordtype">int</span> force);
<a name="l01125"></a>01125 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">iax2_send</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts, <span class="keywordtype">int</span> seqno, <span class="keywordtype">int</span> now, <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>, <span class="keywordtype">int</span> <span class="keyword">final</span>);
<a name="l01126"></a>01126 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac5ef709a0f3f7f07d5ea153393cd0b4f">iax2_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> subclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> datalen);
<a name="l01127"></a>01127 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9ace36259de419f91e09676b34ad307d">iax2_sendimage</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *img);
<a name="l01128"></a>01128 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#adc1d904d607d6a0bb579921639521f0a">iax2_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>);
<a name="l01129"></a>01129 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1fd7477447da4f351cec9185cde8cd8e">iax2_setoption</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> option, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> datalen);
<a name="l01130"></a>01130 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5ce66d44a2d37c60cb143d6a0335a708">iax2_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *dest);
<a name="l01131"></a>01131 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a07ac61089c4cf36df9f6cfed49197b2a">iax2_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>);
<a name="l01132"></a>01132 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad598b8e9746a49f7a86a1c29d87b5dba">send_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer, <span class="keyword">struct</span> timeval *now);
<a name="l01133"></a>01133 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *, <span class="keywordtype">char</span>, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
<a name="l01134"></a>01134 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *, <span class="keywordtype">char</span>, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
<a name="l01135"></a>01135 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *, <span class="keywordtype">char</span>, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
<a name="l01136"></a>01136 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno, <span class="keywordtype">char</span>, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>, <span class="keywordtype">int</span>);
<a name="l01137"></a>01137 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1ff700fbef2b011689770294a3f1bec9">send_command_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *, <span class="keywordtype">char</span>, <span class="keywordtype">int</span>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *, <span class="keywordtype">int</span>);
<a name="l01138"></a>01138 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__iax2_8c.html#a550f1c4da789484cff80ee170bb13f08">iax2_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *type, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>);
<a name="l01139"></a>01139 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__iax2_8c.html#a58daa5f05740960810f983135b4e1ee4">iax2_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c);
<a name="l01140"></a>01140 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#a49e3974d5f7880c5ec01eb631bb4062b" title="Create peer structure based on configuration.">build_peer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *alt, <span class="keywordtype">int</span> temponly);
<a name="l01141"></a>01141 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#a4ce55a34cd5160db030be4355f7b4386" title="Create in-memory user structure from configuration.">build_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *alt, <span class="keywordtype">int</span> temponly);
<a name="l01142"></a>01142 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">realtime_update_peer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *peername, <span class="keyword">struct</span> sockaddr_in *sin, time_t regtime);
<a name="l01143"></a>01143 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#abfc23097a436c8655aceab14a5c0a761">iax2_dup_variable_datastore</a>(<span class="keywordtype">void</span> *);
<a name="l01144"></a>01144 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a55c82d81ce37ebe5125d5a017c12b5ac">prune_peers</a>(<span class="keywordtype">void</span>);
<a name="l01145"></a>01145 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a64dccf856273fe23ad33955a0a491bc2">prune_users</a>(<span class="keywordtype">void</span>);
<a name="l01146"></a>01146 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#acae1cfc438abd6760471fac743734f6b">iax2_free_variable_datastore</a>(<span class="keywordtype">void</span> *);
<a name="l01147"></a>01147 
<a name="l01148"></a>01148 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2c2f15da97a2869766f6f68baa644705">acf_channel_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname, <span class="keywordtype">char</span> *preparse, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> buflen);
<a name="l01149"></a>01149 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aabb84cc107d8ba6ad24986225778efa4">decode_frame</a>(<a class="code" href="structaes__decrypt__ctx.html">ast_aes_decrypt_key</a> *dcx, <span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keywordtype">int</span> *datalen);
<a name="l01150"></a>01150 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a6423f55e3c003cc765531b7b1eebaeea">encrypt_frame</a>(<a class="code" href="structaes__encrypt__ctx.html">ast_aes_encrypt_key</a> *ecx, <span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *poo, <span class="keywordtype">int</span> *datalen);
<a name="l01151"></a>01151 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a623a7a7afa10106e5dff18a2540ba34e">build_ecx_key</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *digest, <span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt);
<a name="l01152"></a>01152 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ab11c1510aa7efdbb6bb4cedcd13390d8">build_rand_pad</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, ssize_t <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l01153"></a>01153 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="chan__iax2_8c.html#a6eb424bb73908133f54e5839926e6a50">get_unused_callno</a>(<span class="keywordtype">int</span> trunk, <span class="keywordtype">int</span> <a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">validated</a>);
<a name="l01154"></a>01154 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a17a9399beec50b63e368c36d7c0d872d">replace_callno</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj);
<a name="l01155"></a>01155 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#adbf5862b8a073aaa64ca049601eef7ec">sched_delay_remove</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a>);
<a name="l01156"></a>01156 
<a name="l01157"></a><a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">01157</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__channel__tech.html" title="Structure to describe a channel &amp;quot;technology&amp;quot;, ie a channel driver See for...">ast_channel_tech</a> <a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a> = {
<a name="l01158"></a>01158    .<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> = <span class="stringliteral">&quot;IAX2&quot;</span>,
<a name="l01159"></a>01159    .description = tdesc,
<a name="l01160"></a>01160    .capabilities = <a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">IAX_CAPABILITY_FULLBANDWIDTH</a>,
<a name="l01161"></a>01161    .properties = <a class="code" href="channel_8h.html#a4f126a0a9b1d8c6a8f46a051ef8830bba54130226ec87f80c48ee98aa5cc9168c" title="Channels have this property if they can accept input with jitter; i.e. most VoIP...">AST_CHAN_TP_WANTSJITTER</a>,
<a name="l01162"></a>01162    .requester = <a class="code" href="chan__iax2_8c.html#a550f1c4da789484cff80ee170bb13f08">iax2_request</a>,
<a name="l01163"></a>01163    .devicestate = <a class="code" href="chan__iax2_8c.html#a515bccac6d7dd9eb618205747a40bdad" title="Part of the device state notification system ---.">iax2_devicestate</a>,
<a name="l01164"></a>01164    .send_digit_begin = <a class="code" href="chan__iax2_8c.html#a4ca36cb64d4c1e5e0c424f4bcd32fa5c">iax2_digit_begin</a>,
<a name="l01165"></a>01165    .send_digit_end = <a class="code" href="chan__iax2_8c.html#a34ff90ed6262326696cb6a0921fa6ffc">iax2_digit_end</a>,
<a name="l01166"></a>01166    .send_text = <a class="code" href="chan__iax2_8c.html#adc1d904d607d6a0bb579921639521f0a">iax2_sendtext</a>,
<a name="l01167"></a>01167    .send_image = <a class="code" href="chan__iax2_8c.html#a9ace36259de419f91e09676b34ad307d">iax2_sendimage</a>,
<a name="l01168"></a>01168    .send_html = <a class="code" href="chan__iax2_8c.html#ac5ef709a0f3f7f07d5ea153393cd0b4f">iax2_sendhtml</a>,
<a name="l01169"></a>01169    .call = <a class="code" href="chan__iax2_8c.html#acfb7625fffb7d724ce068b63af1ef059">iax2_call</a>,
<a name="l01170"></a>01170    .hangup = <a class="code" href="chan__iax2_8c.html#a21a2f61a4598a0bb8e499cbb119f775c">iax2_hangup</a>,
<a name="l01171"></a>01171    .answer = <a class="code" href="chan__iax2_8c.html#a76f9db3943af0e0cf07ded5f2f6640c3">iax2_answer</a>,
<a name="l01172"></a>01172    .read = <a class="code" href="chan__iax2_8c.html#a58daa5f05740960810f983135b4e1ee4">iax2_read</a>,
<a name="l01173"></a>01173    .write = <a class="code" href="chan__iax2_8c.html#a07ac61089c4cf36df9f6cfed49197b2a">iax2_write</a>,
<a name="l01174"></a>01174    .write_video = <a class="code" href="chan__iax2_8c.html#a07ac61089c4cf36df9f6cfed49197b2a">iax2_write</a>,
<a name="l01175"></a>01175    .indicate = <a class="code" href="chan__iax2_8c.html#a01c296968962704d146fb5d092dae41d">iax2_indicate</a>,
<a name="l01176"></a>01176    .setoption = <a class="code" href="chan__iax2_8c.html#a1fd7477447da4f351cec9185cde8cd8e">iax2_setoption</a>,
<a name="l01177"></a>01177    .bridge = <a class="code" href="chan__iax2_8c.html#a2ac728e203e330d25beb144f2ccbac7f">iax2_bridge</a>,
<a name="l01178"></a>01178    .transfer = <a class="code" href="chan__iax2_8c.html#a5ce66d44a2d37c60cb143d6a0335a708">iax2_transfer</a>,
<a name="l01179"></a>01179    .fixup = <a class="code" href="chan__iax2_8c.html#a3cd64402c0950d2f09e22986cf109e8c">iax2_fixup</a>,
<a name="l01180"></a>01180    .func_channel_read = <a class="code" href="chan__iax2_8c.html#a2c2f15da97a2869766f6f68baa644705">acf_channel_read</a>,
<a name="l01181"></a>01181 };
<a name="l01182"></a>01182 
<a name="l01183"></a><a class="code" href="chan__iax2_8c.html#a46e4523f99409c6696dc775ed6a5e5ed">01183</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a46e4523f99409c6696dc775ed6a5e5ed">mwi_event_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *userdata)
<a name="l01184"></a>01184 {
<a name="l01185"></a>01185    <span class="comment">/* The MWI subscriptions exist just so the core knows we care about those</span>
<a name="l01186"></a>01186 <span class="comment">    * mailboxes.  However, we just grab the events out of the cache when it</span>
<a name="l01187"></a>01187 <span class="comment">    * is time to send MWI, since it is only sent with a REGACK. */</span>
<a name="l01188"></a>01188 }
<a name="l01189"></a>01189 <span class="comment"></span>
<a name="l01190"></a>01190 <span class="comment">/*! \brief Send manager event at call setup to link between Asterisk channel name</span>
<a name="l01191"></a>01191 <span class="comment">   and IAX2 call identifiers */</span>
<a name="l01192"></a><a class="code" href="chan__iax2_8c.html#a5c6ae109c64e40ee02e813f6dc1e01b7">01192</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a5c6ae109c64e40ee02e813f6dc1e01b7" title="Send manager event at call setup to link between Asterisk channel name and IAX2 call...">iax2_ami_channelupdate</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt) 
<a name="l01193"></a>01193 {
<a name="l01194"></a>01194    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;ChannelUpdate&quot;</span>,
<a name="l01195"></a>01195       <span class="stringliteral">&quot;Channel: %s\r\nChanneltype: IAX2\r\nIAX2-callno-local: %d\r\nIAX2-callno-remote: %d\r\nIAX2-peer: %s\r\n&quot;</span>,
<a name="l01196"></a>01196       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> ? pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01197"></a>01197       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>, pvt-&gt;peer ? pvt-&gt;peer : <span class="stringliteral">&quot;&quot;</span>);
<a name="l01198"></a>01198 }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200 
<a name="l01201"></a><a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">01201</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__datastore__info.html" title="Structure for a data store type.">ast_datastore_info</a> <a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a> = {
<a name="l01202"></a>01202    .<a class="code" href="structast__datastore__info.html#a763fd8db6bba8fbbbc113ca0d61c47c2">type</a> = <span class="stringliteral">&quot;IAX2_VARIABLE&quot;</span>,
<a name="l01203"></a>01203    .duplicate = <a class="code" href="chan__iax2_8c.html#abfc23097a436c8655aceab14a5c0a761">iax2_dup_variable_datastore</a>,
<a name="l01204"></a>01204    .destroy = <a class="code" href="chan__iax2_8c.html#acae1cfc438abd6760471fac743734f6b">iax2_free_variable_datastore</a>,
<a name="l01205"></a>01205 };
<a name="l01206"></a>01206 
<a name="l01207"></a><a class="code" href="chan__iax2_8c.html#abfc23097a436c8655aceab14a5c0a761">01207</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#abfc23097a436c8655aceab14a5c0a761">iax2_dup_variable_datastore</a>(<span class="keywordtype">void</span> *old)
<a name="l01208"></a>01208 {
<a name="l01209"></a>01209    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *oldlist = old, *newlist;
<a name="l01210"></a>01210    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *oldvar, *newvar;
<a name="l01211"></a>01211 
<a name="l01212"></a>01212    newlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(<span class="keyword">sizeof</span>(*newlist), 1);
<a name="l01213"></a>01213    <span class="keywordflow">if</span> (!newlist) {
<a name="l01214"></a>01214       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to duplicate iax2 variables\n&quot;</span>);
<a name="l01215"></a>01215       <span class="keywordflow">return</span> NULL;
<a name="l01216"></a>01216    }
<a name="l01217"></a>01217 
<a name="l01218"></a>01218    <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(newlist);
<a name="l01219"></a>01219    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(oldlist);
<a name="l01220"></a>01220    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(oldlist, oldvar, entries) {
<a name="l01221"></a>01221       newvar = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(<a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(oldvar), <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(oldvar));
<a name="l01222"></a>01222       <span class="keywordflow">if</span> (newvar)
<a name="l01223"></a>01223          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(newlist, newvar, entries);
<a name="l01224"></a>01224       <span class="keywordflow">else</span>
<a name="l01225"></a>01225          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to duplicate iax2 variable &apos;%s&apos;\n&quot;</span>, <a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(oldvar));
<a name="l01226"></a>01226    }
<a name="l01227"></a>01227    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(oldlist);
<a name="l01228"></a>01228    <span class="keywordflow">return</span> newlist;
<a name="l01229"></a>01229 }
<a name="l01230"></a>01230 
<a name="l01231"></a><a class="code" href="chan__iax2_8c.html#acae1cfc438abd6760471fac743734f6b">01231</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#acae1cfc438abd6760471fac743734f6b">iax2_free_variable_datastore</a>(<span class="keywordtype">void</span> *old)
<a name="l01232"></a>01232 {
<a name="l01233"></a>01233    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *oldlist = old;
<a name="l01234"></a>01234    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *oldvar;
<a name="l01235"></a>01235 
<a name="l01236"></a>01236    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(oldlist);
<a name="l01237"></a>01237    <span class="keywordflow">while</span> ((oldvar = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(oldlist, entries))) {
<a name="l01238"></a>01238       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(oldvar);
<a name="l01239"></a>01239    }
<a name="l01240"></a>01240    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(oldlist);
<a name="l01241"></a>01241    <a class="code" href="linkedlists_8h.html#a47bafe663a14b91827082787d7654d7c" title="Destroys a list head structure.">AST_LIST_HEAD_DESTROY</a>(oldlist);
<a name="l01242"></a>01242    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(oldlist);
<a name="l01243"></a>01243 }
<a name="l01244"></a>01244 
<a name="l01245"></a>01245 
<a name="l01246"></a>01246 <span class="comment">/* WARNING: insert_idle_thread should only ever be called within the</span>
<a name="l01247"></a>01247 <span class="comment"> * context of an iax2_process_thread() thread.</span>
<a name="l01248"></a>01248 <span class="comment"> */</span>
<a name="l01249"></a><a class="code" href="chan__iax2_8c.html#a7c0f4a5b443de37be3a1e777af718541">01249</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a7c0f4a5b443de37be3a1e777af718541">insert_idle_thread</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>)
<a name="l01250"></a>01250 {
<a name="l01251"></a>01251    <span class="keywordflow">if</span> (thread-&gt;type == <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7a0acfd1204de5016e9d076890e96a7d95">IAX_THREAD_TYPE_DYNAMIC</a>) {
<a name="l01252"></a>01252       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l01253"></a>01253       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;dynamic_list, thread, list);
<a name="l01254"></a>01254       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l01255"></a>01255    } <span class="keywordflow">else</span> {
<a name="l01256"></a>01256       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;idle_list);
<a name="l01257"></a>01257       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;idle_list, thread, list);
<a name="l01258"></a>01258       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;idle_list);
<a name="l01259"></a>01259    }
<a name="l01260"></a>01260 
<a name="l01261"></a>01261    <span class="keywordflow">return</span>;
<a name="l01262"></a>01262 }
<a name="l01263"></a>01263 
<a name="l01264"></a><a class="code" href="chan__iax2_8c.html#ad05e85b468e220b0f47d30809476825a">01264</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="chan__iax2_8c.html#ad05e85b468e220b0f47d30809476825a">find_idle_thread</a>(<span class="keywordtype">void</span>)
<a name="l01265"></a>01265 {
<a name="l01266"></a>01266    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = NULL;
<a name="l01267"></a>01267 
<a name="l01268"></a>01268    <span class="comment">/* Pop the head of the idle list off */</span>
<a name="l01269"></a>01269    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;idle_list);
<a name="l01270"></a>01270    thread = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;idle_list, list);
<a name="l01271"></a>01271    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;idle_list);
<a name="l01272"></a>01272 
<a name="l01273"></a>01273    <span class="comment">/* If we popped a thread off the idle list, just return it */</span>
<a name="l01274"></a>01274    <span class="keywordflow">if</span> (thread) {
<a name="l01275"></a>01275       memset(&amp;thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>, 0, <span class="keyword">sizeof</span>(thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>));
<a name="l01276"></a>01276       <span class="keywordflow">return</span> thread;
<a name="l01277"></a>01277    }
<a name="l01278"></a>01278 
<a name="l01279"></a>01279    <span class="comment">/* Pop the head of the dynamic list off */</span>
<a name="l01280"></a>01280    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l01281"></a>01281    thread = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;dynamic_list, list);
<a name="l01282"></a>01282    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l01283"></a>01283 
<a name="l01284"></a>01284    <span class="comment">/* If we popped a thread off the dynamic list, just return it */</span>
<a name="l01285"></a>01285    <span class="keywordflow">if</span> (thread) {
<a name="l01286"></a>01286       memset(&amp;thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>, 0, <span class="keyword">sizeof</span>(thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>));
<a name="l01287"></a>01287       <span class="keywordflow">return</span> thread;
<a name="l01288"></a>01288    }
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    <span class="comment">/* If we can&apos;t create a new dynamic thread for any reason, return no thread at all */</span>
<a name="l01291"></a>01291    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a11480fc9a0f5a2c9cadb7a15a6c9c0e6">iaxdynamicthreadcount</a> &gt;= <a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> || !(thread = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*thread))))
<a name="l01292"></a>01292       <span class="keywordflow">return</span> NULL;
<a name="l01293"></a>01293 
<a name="l01294"></a>01294    <span class="comment">/* Set default values */</span>
<a name="l01295"></a>01295    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;<a class="code" href="chan__iax2_8c.html#a11480fc9a0f5a2c9cadb7a15a6c9c0e6">iaxdynamicthreadcount</a>, 1);
<a name="l01296"></a>01296    thread-&gt;threadnum = <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;<a class="code" href="chan__iax2_8c.html#a6891db50aed418c4c7416789958a7f76">iaxdynamicthreadnum</a>, 1);
<a name="l01297"></a>01297    thread-&gt;type = <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7a0acfd1204de5016e9d076890e96a7d95">IAX_THREAD_TYPE_DYNAMIC</a>;
<a name="l01298"></a>01298 
<a name="l01299"></a>01299    <span class="comment">/* Initialize lock and condition */</span>
<a name="l01300"></a>01300    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;thread-&gt;lock);
<a name="l01301"></a>01301    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;thread-&gt;cond, NULL);
<a name="l01302"></a>01302    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;thread-&gt;init_lock);
<a name="l01303"></a>01303    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;thread-&gt;init_cond, NULL);
<a name="l01304"></a>01304    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;thread-&gt;init_lock);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306    <span class="comment">/* Create thread and send it on it&apos;s way */</span>
<a name="l01307"></a>01307    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;thread-&gt;threadid, NULL, <a class="code" href="chan__iax2_8c.html#a4b01adf25449fb80786fe1af045c3d0c">iax2_process_thread</a>, thread)) {
<a name="l01308"></a>01308       <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;thread-&gt;cond);
<a name="l01309"></a>01309       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;thread-&gt;lock);
<a name="l01310"></a>01310       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(thread);
<a name="l01311"></a>01311       <span class="keywordflow">return</span> NULL;
<a name="l01312"></a>01312    }
<a name="l01313"></a>01313 
<a name="l01314"></a>01314    <span class="comment">/* this thread is not processing a full frame (since it is idle),</span>
<a name="l01315"></a>01315 <span class="comment">      so ensure that the field for the full frame call number is empty */</span>
<a name="l01316"></a>01316    memset(&amp;thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>, 0, <span class="keyword">sizeof</span>(thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>));
<a name="l01317"></a>01317 
<a name="l01318"></a>01318    <span class="comment">/* Wait for the thread to be ready before returning it to the caller */</span>
<a name="l01319"></a>01319    <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;thread-&gt;init_cond, &amp;thread-&gt;init_lock);
<a name="l01320"></a>01320 
<a name="l01321"></a>01321    <span class="comment">/* Done with init_lock */</span>
<a name="l01322"></a>01322    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;init_lock);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324    <span class="keywordflow">return</span> thread;
<a name="l01325"></a>01325 }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l01328"></a><a class="code" href="chan__iax2_8c.html#a228fd7c412897c47fa508a9a389fc670">01328</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a228fd7c412897c47fa508a9a389fc670">__schedule_action</a>(<span class="keywordtype">void</span> (*func)(<span class="keyword">const</span> <span class="keywordtype">void</span> *data), <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname)
<a name="l01329"></a>01329 {
<a name="l01330"></a>01330    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = NULL;
<a name="l01331"></a>01331    <span class="keyword">static</span> time_t lasterror;
<a name="l01332"></a>01332    <span class="keyword">static</span> time_t t;
<a name="l01333"></a>01333 
<a name="l01334"></a>01334    thread = <a class="code" href="chan__iax2_8c.html#ad05e85b468e220b0f47d30809476825a">find_idle_thread</a>();
<a name="l01335"></a>01335 
<a name="l01336"></a>01336    <span class="keywordflow">if</span> (thread != NULL) {
<a name="l01337"></a>01337       thread-&gt;schedfunc = func;
<a name="l01338"></a>01338       thread-&gt;scheddata = data;
<a name="l01339"></a>01339       thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a758a8b5bbba4debe9f4c40ace2526563">IAX_IOSTATE_SCHEDREADY</a>;
<a name="l01340"></a>01340 <span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l01341"></a>01341 <span class="preprocessor"></span>      <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(thread-&gt;curfunc, funcname, <span class="keyword">sizeof</span>(thread-&gt;curfunc));
<a name="l01342"></a>01342 <span class="preprocessor">#endif</span>
<a name="l01343"></a>01343 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(&amp;thread-&gt;lock, &amp;thread-&gt;cond);
<a name="l01344"></a>01344       <span class="keywordflow">return</span> 0;
<a name="l01345"></a>01345    }
<a name="l01346"></a>01346    time(&amp;t);
<a name="l01347"></a>01347    <span class="keywordflow">if</span> (t != lasterror) 
<a name="l01348"></a>01348       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Out of idle IAX2 threads for scheduling!\n&quot;</span>);
<a name="l01349"></a>01349    lasterror = t;
<a name="l01350"></a>01350 
<a name="l01351"></a>01351    <span class="keywordflow">return</span> -1;
<a name="l01352"></a>01352 }
<a name="l01353"></a><a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">01353</a> <span class="preprocessor">#define schedule_action(func, data) __schedule_action(func, data, __PRETTY_FUNCTION__)</span>
<a name="l01354"></a>01354 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l01355"></a>01355 <span class="preprocessor"></span>
<a name="l01356"></a><a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">01356</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>, <span class="keyword">struct</span> <a class="code" href="structast__sched__thread.html">ast_sched_thread</a> *st, <span class="keywordtype">int</span> when, 
<a name="l01357"></a>01357       <a class="code" href="sched_8h.html#a57358d80decb5b8ddde4d2e7f1919b87" title="callback for a cheops scheduler A cheops scheduler callback takes a pointer with...">ast_sched_cb</a> callback, <span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(st, <span class="keywordtype">id</span>);
<a name="l01360"></a>01360 
<a name="l01361"></a>01361    <span class="keywordflow">return</span> <a class="code" href="sched_8h.html#acc6eead923ec328dcee53559dd3b8b60" title="Add a scheduler entry.">ast_sched_thread_add</a>(st, when, callback, data);
<a name="l01362"></a>01362 }
<a name="l01363"></a>01363 
<a name="l01364"></a><a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">01364</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(<span class="keyword">struct</span> <a class="code" href="structast__sched__thread.html">ast_sched_thread</a> *st, <span class="keywordtype">int</span> when, 
<a name="l01365"></a>01365       <a class="code" href="sched_8h.html#a57358d80decb5b8ddde4d2e7f1919b87" title="callback for a cheops scheduler A cheops scheduler callback takes a pointer with...">ast_sched_cb</a> callback, <span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l01366"></a>01366 {
<a name="l01367"></a>01367    <span class="keywordflow">return</span> <a class="code" href="sched_8h.html#acc6eead923ec328dcee53559dd3b8b60" title="Add a scheduler entry.">ast_sched_thread_add</a>(st, when, callback, data);
<a name="l01368"></a>01368 }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a038a10c0c7963f6f551ec9e462391d92">send_ping</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data);
<a name="l01371"></a>01371 
<a name="l01372"></a><a class="code" href="chan__iax2_8c.html#a7a112117716e33543c45381a3bf60d81">01372</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a7a112117716e33543c45381a3bf60d81">__send_ping</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l01373"></a>01373 {
<a name="l01374"></a>01374    <span class="keywordtype">int</span> callno = (long) data;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01377"></a>01377 
<a name="l01378"></a>01378    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l01379"></a>01379       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;peercallno) {
<a name="l01380"></a>01380          <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa6092ebf7be4bb70be5c0f1fdb48017a4">IAX_COMMAND_PING</a>, 0, NULL, 0, -1);
<a name="l01381"></a>01381          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">pingid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, ping_time * 1000, <a class="code" href="chan__iax2_8c.html#a038a10c0c7963f6f551ec9e462391d92">send_ping</a>, data);
<a name="l01382"></a>01382       } <span class="keywordflow">else</span> {
<a name="l01383"></a>01383          <span class="comment">/* I am the schedule, so I&apos;m allowed to do this */</span>
<a name="l01384"></a>01384          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">pingid</a> = -1;
<a name="l01385"></a>01385       }
<a name="l01386"></a>01386    } <span class="keywordflow">else</span> {
<a name="l01387"></a>01387       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I was supposed to send a PING with callno %d, but no such call exists.\n&quot;</span>, callno);
<a name="l01388"></a>01388    }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01391"></a>01391 }
<a name="l01392"></a>01392 
<a name="l01393"></a><a class="code" href="chan__iax2_8c.html#a038a10c0c7963f6f551ec9e462391d92">01393</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a038a10c0c7963f6f551ec9e462391d92">send_ping</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l01394"></a>01394 {
<a name="l01395"></a>01395 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l01396"></a>01396 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a7a112117716e33543c45381a3bf60d81">__send_ping</a>, data))
<a name="l01397"></a>01397 <span class="preprocessor">#endif      </span>
<a name="l01398"></a>01398 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#a7a112117716e33543c45381a3bf60d81">__send_ping</a>(data);
<a name="l01399"></a>01399 
<a name="l01400"></a>01400    <span class="keywordflow">return</span> 0;
<a name="l01401"></a>01401 }
<a name="l01402"></a>01402 
<a name="l01403"></a><a class="code" href="chan__iax2_8c.html#aab0a14f82b40eb534e3b026724636b41">01403</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aab0a14f82b40eb534e3b026724636b41">encmethods_to_str</a>(<span class="keywordtype">int</span> e, <span class="keyword">struct</span> <a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l01404"></a>01404 {
<a name="l01405"></a>01405    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;buf, 0, <span class="stringliteral">&quot;(&quot;</span>);
<a name="l01406"></a>01406    <span class="keywordflow">if</span> (e &amp; <a class="code" href="iax2_8h.html#a8400222929fd0aa369ebf89fbe54ca2f">IAX_ENCRYPT_AES128</a>) {
<a name="l01407"></a>01407       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;buf, 0, <span class="stringliteral">&quot;aes128&quot;</span>);
<a name="l01408"></a>01408    }
<a name="l01409"></a>01409    <span class="keywordflow">if</span> (e &amp; <a class="code" href="iax2_8h.html#abe33a013186fa460de6464f68187c090">IAX_ENCRYPT_KEYROTATE</a>) {
<a name="l01410"></a>01410       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;buf, 0, <span class="stringliteral">&quot;,keyrotate&quot;</span>);
<a name="l01411"></a>01411    }
<a name="l01412"></a>01412    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a99409c17a1d20e1c3dc00039b7925a2d" title="Returns the current length of the string stored within buf.">ast_str_strlen</a>(buf) &gt; 1) {
<a name="l01413"></a>01413       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;buf, 0, <span class="stringliteral">&quot;)&quot;</span>);
<a name="l01414"></a>01414    } <span class="keywordflow">else</span> {
<a name="l01415"></a>01415       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;buf, 0, <span class="stringliteral">&quot;No&quot;</span>);
<a name="l01416"></a>01416    }
<a name="l01417"></a>01417 }
<a name="l01418"></a>01418 
<a name="l01419"></a><a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">01419</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l01420"></a>01420 {
<a name="l01421"></a>01421    <span class="keywordtype">int</span> e;
<a name="l01422"></a>01422    <span class="keywordflow">if</span> (!strcasecmp(s, <span class="stringliteral">&quot;aes128&quot;</span>))
<a name="l01423"></a>01423       e = <a class="code" href="iax2_8h.html#a8400222929fd0aa369ebf89fbe54ca2f">IAX_ENCRYPT_AES128</a> | <a class="code" href="iax2_8h.html#abe33a013186fa460de6464f68187c090">IAX_ENCRYPT_KEYROTATE</a>;
<a name="l01424"></a>01424    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(s))
<a name="l01425"></a>01425       e = <a class="code" href="iax2_8h.html#a8400222929fd0aa369ebf89fbe54ca2f">IAX_ENCRYPT_AES128</a> | <a class="code" href="iax2_8h.html#abe33a013186fa460de6464f68187c090">IAX_ENCRYPT_KEYROTATE</a>;
<a name="l01426"></a>01426    <span class="keywordflow">else</span>
<a name="l01427"></a>01427       e = 0;
<a name="l01428"></a>01428    <span class="keywordflow">return</span> e;
<a name="l01429"></a>01429 }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9773a01290343052959786eb066fd067">send_lagrq</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data);
<a name="l01432"></a>01432 
<a name="l01433"></a><a class="code" href="chan__iax2_8c.html#a9b2f948fc1c327687ed03ddc74b9ff62">01433</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a9b2f948fc1c327687ed03ddc74b9ff62">__send_lagrq</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l01434"></a>01434 {
<a name="l01435"></a>01435    <span class="keywordtype">int</span> callno = (long) data;
<a name="l01436"></a>01436 
<a name="l01437"></a>01437    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01438"></a>01438 
<a name="l01439"></a>01439    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l01440"></a>01440       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;peercallno) {
<a name="l01441"></a>01441          <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4aa1de389272603658d92a449bb6009f">IAX_COMMAND_LAGRQ</a>, 0, NULL, 0, -1);
<a name="l01442"></a>01442          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">lagid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, lagrq_time * 1000, <a class="code" href="chan__iax2_8c.html#a9773a01290343052959786eb066fd067">send_lagrq</a>, data);
<a name="l01443"></a>01443       } <span class="keywordflow">else</span> {
<a name="l01444"></a>01444          <span class="comment">/* I am the schedule, so I&apos;m allowed to do this */</span>
<a name="l01445"></a>01445          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">lagid</a> = -1;
<a name="l01446"></a>01446       }
<a name="l01447"></a>01447    } <span class="keywordflow">else</span> {
<a name="l01448"></a>01448       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I was supposed to send a LAGRQ with callno %d, but no such call exists.\n&quot;</span>, callno);
<a name="l01449"></a>01449    }
<a name="l01450"></a>01450 
<a name="l01451"></a>01451    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01452"></a>01452 }
<a name="l01453"></a>01453 
<a name="l01454"></a><a class="code" href="chan__iax2_8c.html#a9773a01290343052959786eb066fd067">01454</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9773a01290343052959786eb066fd067">send_lagrq</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l01455"></a>01455 {
<a name="l01456"></a>01456 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l01457"></a>01457 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a9b2f948fc1c327687ed03ddc74b9ff62">__send_lagrq</a>, data))
<a name="l01458"></a>01458 <span class="preprocessor">#endif      </span>
<a name="l01459"></a>01459 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#a9b2f948fc1c327687ed03ddc74b9ff62">__send_lagrq</a>(data);
<a name="l01460"></a>01460    
<a name="l01461"></a>01461    <span class="keywordflow">return</span> 0;
<a name="l01462"></a>01462 }
<a name="l01463"></a>01463 
<a name="l01464"></a><a class="code" href="chan__iax2_8c.html#ab063a335efcdf8cf19193fae08c6fcf9">01464</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#ab063a335efcdf8cf19193fae08c6fcf9">compress_subclass</a>(<span class="keywordtype">int</span> subclass)
<a name="l01465"></a>01465 {
<a name="l01466"></a>01466    <span class="keywordtype">int</span> x;
<a name="l01467"></a>01467    <span class="keywordtype">int</span> power=-1;
<a name="l01468"></a>01468    <span class="comment">/* If it&apos;s 128 or smaller, just return it */</span>
<a name="l01469"></a>01469    <span class="keywordflow">if</span> (subclass &lt; <a class="code" href="iax2_8h.html#a1ca612aaf8738a88105bfc1e5ff8aa22">IAX_FLAG_SC_LOG</a>)
<a name="l01470"></a>01470       <span class="keywordflow">return</span> subclass;
<a name="l01471"></a>01471    <span class="comment">/* Otherwise find its power */</span>
<a name="l01472"></a>01472    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="iax2_8h.html#a7eb000e1031920489e284fe172d73ee7">IAX_MAX_SHIFT</a>; x++) {
<a name="l01473"></a>01473       <span class="keywordflow">if</span> (subclass &amp; (1 &lt;&lt; x)) {
<a name="l01474"></a>01474          <span class="keywordflow">if</span> (power &gt; -1) {
<a name="l01475"></a>01475             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t compress subclass %d\n&quot;</span>, subclass);
<a name="l01476"></a>01476             <span class="keywordflow">return</span> 0;
<a name="l01477"></a>01477          } <span class="keywordflow">else</span>
<a name="l01478"></a>01478             power = x;
<a name="l01479"></a>01479       }
<a name="l01480"></a>01480    }
<a name="l01481"></a>01481    <span class="keywordflow">return</span> power | <a class="code" href="iax2_8h.html#a1ca612aaf8738a88105bfc1e5ff8aa22">IAX_FLAG_SC_LOG</a>;
<a name="l01482"></a>01482 }
<a name="l01483"></a>01483 
<a name="l01484"></a><a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">01484</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">uncompress_subclass</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> csub)
<a name="l01485"></a>01485 {
<a name="l01486"></a>01486    <span class="comment">/* If the SC_LOG flag is set, return 2^csub otherwise csub */</span>
<a name="l01487"></a>01487    <span class="keywordflow">if</span> (csub &amp; <a class="code" href="iax2_8h.html#a1ca612aaf8738a88105bfc1e5ff8aa22">IAX_FLAG_SC_LOG</a>) {
<a name="l01488"></a>01488       <span class="comment">/* special case for &apos;compressed&apos; -1 */</span>
<a name="l01489"></a>01489       <span class="keywordflow">if</span> (csub == 0xff)
<a name="l01490"></a>01490          <span class="keywordflow">return</span> -1;
<a name="l01491"></a>01491       <span class="keywordflow">else</span>
<a name="l01492"></a>01492          <span class="keywordflow">return</span> 1 &lt;&lt; (csub &amp; ~IAX_FLAG_SC_LOG &amp; <a class="code" href="iax2_8h.html#a7eb000e1031920489e284fe172d73ee7">IAX_MAX_SHIFT</a>);
<a name="l01493"></a>01493    }
<a name="l01494"></a>01494    <span class="keywordflow">else</span>
<a name="l01495"></a>01495       <span class="keywordflow">return</span> csub;
<a name="l01496"></a>01496 }
<a name="l01497"></a>01497 <span class="comment"></span>
<a name="l01498"></a>01498 <span class="comment">/*!</span>
<a name="l01499"></a>01499 <span class="comment"> * \note The only member of the peer passed here guaranteed to be set is the name field</span>
<a name="l01500"></a>01500 <span class="comment"> */</span>
<a name="l01501"></a><a class="code" href="chan__iax2_8c.html#a154481c76db5a5bc57a83662466323e4">01501</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a154481c76db5a5bc57a83662466323e4">peer_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l01502"></a>01502 {
<a name="l01503"></a>01503    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = obj;
<a name="l01504"></a>01504 
<a name="l01505"></a>01505    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#a33ab7fa091d5513d8507d3bd33ef5b55" title="Compute a hash value on a string.">ast_str_hash</a>(peer-&gt;name);
<a name="l01506"></a>01506 }
<a name="l01507"></a>01507 <span class="comment"></span>
<a name="l01508"></a>01508 <span class="comment">/*!</span>
<a name="l01509"></a>01509 <span class="comment"> * \note The only member of the peer passed here guaranteed to be set is the name field</span>
<a name="l01510"></a>01510 <span class="comment"> */</span>
<a name="l01511"></a><a class="code" href="chan__iax2_8c.html#a29a91cbcaae8787fa5837a9cb455b0e7">01511</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a29a91cbcaae8787fa5837a9cb455b0e7">peer_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01512"></a>01512 {
<a name="l01513"></a>01513    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = obj, *peer2 = arg;
<a name="l01514"></a>01514 
<a name="l01515"></a>01515    <span class="keywordflow">return</span> !strcmp(peer-&gt;name, peer2-&gt;name) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l01516"></a>01516 }
<a name="l01517"></a>01517 <span class="comment"></span>
<a name="l01518"></a>01518 <span class="comment">/*!</span>
<a name="l01519"></a>01519 <span class="comment"> * \note The only member of the user passed here guaranteed to be set is the name field</span>
<a name="l01520"></a>01520 <span class="comment"> */</span>
<a name="l01521"></a><a class="code" href="chan__iax2_8c.html#ab3fcaa495f89153355cbf35be9a49a42">01521</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab3fcaa495f89153355cbf35be9a49a42">user_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01522"></a>01522 {
<a name="l01523"></a>01523    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = obj;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#a33ab7fa091d5513d8507d3bd33ef5b55" title="Compute a hash value on a string.">ast_str_hash</a>(user-&gt;name);
<a name="l01526"></a>01526 }
<a name="l01527"></a>01527 <span class="comment"></span>
<a name="l01528"></a>01528 <span class="comment">/*!</span>
<a name="l01529"></a>01529 <span class="comment"> * \note The only member of the user passed here guaranteed to be set is the name field</span>
<a name="l01530"></a>01530 <span class="comment"> */</span>
<a name="l01531"></a><a class="code" href="chan__iax2_8c.html#a52a9a7c9943bb81e2d89050e953f29a0">01531</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a52a9a7c9943bb81e2d89050e953f29a0">user_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l01532"></a>01532 {
<a name="l01533"></a>01533    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = obj, *user2 = arg;
<a name="l01534"></a>01534 
<a name="l01535"></a>01535    <span class="keywordflow">return</span> !strcmp(user-&gt;name, user2-&gt;name) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l01536"></a>01536 }
<a name="l01537"></a>01537 <span class="comment"></span>
<a name="l01538"></a>01538 <span class="comment">/*!</span>
<a name="l01539"></a>01539 <span class="comment"> * \note This funtion calls realtime_peer -&gt; reg_source_db -&gt; iax2_poke_peer -&gt; find_callno,</span>
<a name="l01540"></a>01540 <span class="comment"> *       so do not call it with a pvt lock held.</span>
<a name="l01541"></a>01541 <span class="comment"> */</span>
<a name="l01542"></a><a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">01542</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keywordtype">int</span> realtime) 
<a name="l01543"></a>01543 {
<a name="l01544"></a>01544    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l01545"></a>01545    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> tmp_peer = {
<a name="l01546"></a>01546       .name = name,
<a name="l01547"></a>01547    };
<a name="l01548"></a>01548 
<a name="l01549"></a>01549    peer = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peers, &amp;tmp_peer, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l01550"></a>01550 
<a name="l01551"></a>01551    <span class="comment">/* Now go for realtime if applicable */</span>
<a name="l01552"></a>01552    <span class="keywordflow">if</span>(!peer &amp;&amp; realtime)
<a name="l01553"></a>01553       peer = <a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">realtime_peer</a>(name, NULL);
<a name="l01554"></a>01554 
<a name="l01555"></a>01555    <span class="keywordflow">return</span> peer;
<a name="l01556"></a>01556 }
<a name="l01557"></a>01557 
<a name="l01558"></a><a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">01558</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer)
<a name="l01559"></a>01559 {
<a name="l01560"></a>01560    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peer, +1);
<a name="l01561"></a>01561    <span class="keywordflow">return</span> peer;
<a name="l01562"></a>01562 }
<a name="l01563"></a>01563 
<a name="l01564"></a><a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">01564</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer)
<a name="l01565"></a>01565 {
<a name="l01566"></a>01566    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peer, -1);
<a name="l01567"></a>01567    <span class="keywordflow">return</span> NULL;
<a name="l01568"></a>01568 }
<a name="l01569"></a>01569 
<a name="l01570"></a><a class="code" href="chan__iax2_8c.html#aa56d736414c9f5f71da37c50f0f57760">01570</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#aa56d736414c9f5f71da37c50f0f57760">find_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l01571"></a>01571 {
<a name="l01572"></a>01572    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> tmp_user = {
<a name="l01573"></a>01573       .name = name,
<a name="l01574"></a>01574    };
<a name="l01575"></a>01575 
<a name="l01576"></a>01576    <span class="keywordflow">return</span> <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(users, &amp;tmp_user, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l01577"></a>01577 }
<a name="l01578"></a><a class="code" href="chan__iax2_8c.html#a5d6fad2173a2924bac472654ec17c654">01578</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#a5d6fad2173a2924bac472654ec17c654">user_ref</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>)
<a name="l01579"></a>01579 {
<a name="l01580"></a>01580    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(user, +1);
<a name="l01581"></a>01581    <span class="keywordflow">return</span> user;
<a name="l01582"></a>01582 }
<a name="l01583"></a>01583 
<a name="l01584"></a><a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">01584</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>)
<a name="l01585"></a>01585 {
<a name="l01586"></a>01586    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(user, -1);
<a name="l01587"></a>01587    <span class="keywordflow">return</span> NULL;
<a name="l01588"></a>01588 }
<a name="l01589"></a>01589 
<a name="l01590"></a><a class="code" href="chan__iax2_8c.html#a29430c5f2ce277cf96f3655b1705da36">01590</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a29430c5f2ce277cf96f3655b1705da36">iax2_getpeername</a>(<span class="keyword">struct</span> sockaddr_in sin, <span class="keywordtype">char</span> *host, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l01591"></a>01591 {
<a name="l01592"></a>01592    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l01593"></a>01593    <span class="keywordtype">int</span> res = 0;
<a name="l01594"></a>01594    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l01595"></a>01595 
<a name="l01596"></a>01596    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l01597"></a>01597    <span class="keywordflow">while</span> ((peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l01598"></a>01598       <span class="keywordflow">if</span> ((peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr == sin.sin_addr.s_addr) &amp;&amp;
<a name="l01599"></a>01599           (peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port == sin.sin_port)) {
<a name="l01600"></a>01600          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(host, peer-&gt;name, len);
<a name="l01601"></a>01601          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l01602"></a>01602          res = 1;
<a name="l01603"></a>01603          <span class="keywordflow">break</span>;
<a name="l01604"></a>01604       }
<a name="l01605"></a>01605       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l01606"></a>01606    }
<a name="l01607"></a>01607    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609    <span class="keywordflow">if</span> (!peer) {
<a name="l01610"></a>01610       peer = <a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">realtime_peer</a>(NULL, &amp;sin);
<a name="l01611"></a>01611       <span class="keywordflow">if</span> (peer) {
<a name="l01612"></a>01612          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(host, peer-&gt;name, len);
<a name="l01613"></a>01613          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l01614"></a>01614          res = 1;
<a name="l01615"></a>01615       }
<a name="l01616"></a>01616    }
<a name="l01617"></a>01617 
<a name="l01618"></a>01618    <span class="keywordflow">return</span> res;
<a name="l01619"></a>01619 }
<a name="l01620"></a>01620 <span class="comment"></span>
<a name="l01621"></a>01621 <span class="comment">/*!\note Assumes the lock on the pvt is already held, when</span>
<a name="l01622"></a>01622 <span class="comment"> * iax2_destroy_helper() is called. */</span>
<a name="l01623"></a><a class="code" href="chan__iax2_8c.html#a0d97140fc0f1c286328c703d1ae66002">01623</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a0d97140fc0f1c286328c703d1ae66002">iax2_destroy_helper</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l01624"></a>01624 {
<a name="l01625"></a>01625    <span class="comment">/* Decrement AUTHREQ count if needed */</span>
<a name="l01626"></a>01626    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a>)) {
<a name="l01627"></a>01627       <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l01628"></a>01628       <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> tmp_user = {
<a name="l01629"></a>01629          .name = pvt-&gt;username,
<a name="l01630"></a>01630       };
<a name="l01631"></a>01631 
<a name="l01632"></a>01632       user = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(users, &amp;tmp_user, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l01633"></a>01633       <span class="keywordflow">if</span> (user) {
<a name="l01634"></a>01634          <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;user-&gt;<a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a>, -1);
<a name="l01635"></a>01635          <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user); 
<a name="l01636"></a>01636       }
<a name="l01637"></a>01637 
<a name="l01638"></a>01638       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a>);
<a name="l01639"></a>01639    }
<a name="l01640"></a>01640    <span class="comment">/* No more pings or lagrq&apos;s */</span>
<a name="l01641"></a>01641    <a class="code" href="sched_8h.html#aa7d804569b31559a8a70baa8f4b69828" title="schedule task to get deleted releasing the lock between attempts">AST_SCHED_DEL_SPINLOCK</a>(<a class="code" href="sched_8h.html#a2574d6d3ccdc66ecbc78501f237b59db" title="Get the scheduler context for a given ast_sched_thread.">ast_sched_thread_get_context</a>(sched), pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">pingid</a>, &amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l01642"></a>01642    <a class="code" href="sched_8h.html#aa7d804569b31559a8a70baa8f4b69828" title="schedule task to get deleted releasing the lock between attempts">AST_SCHED_DEL_SPINLOCK</a>(<a class="code" href="sched_8h.html#a2574d6d3ccdc66ecbc78501f237b59db" title="Get the scheduler context for a given ast_sched_thread.">ast_sched_thread_get_context</a>(sched), pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">lagid</a>, &amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l01643"></a>01643    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bae7aaf2ef69cbcf5ffb6e0b9ba060">autoid</a>);
<a name="l01644"></a>01644    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a94bf6ec5b99ea2a6378669fe6021e2e8">authid</a>);
<a name="l01645"></a>01645    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">initid</a>);
<a name="l01646"></a>01646    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">jbid</a>);
<a name="l01647"></a>01647    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">keyrotateid</a>);
<a name="l01648"></a>01648 }
<a name="l01649"></a>01649 
<a name="l01650"></a><a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">01650</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(<span class="keyword">struct</span> iax_frame *fr)
<a name="l01651"></a>01651 {
<a name="l01652"></a>01652    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, fr-&gt;<a class="code" href="structiax__frame.html#a4ab21dd2375ec54e44ae4da973a3d4ca">retrans</a>);
<a name="l01653"></a>01653    <a class="code" href="iax2-parser_8c.html#a56f011ba4b698f0c5a98920de44926eb">iax_frame_free</a>(fr);
<a name="l01654"></a>01654 }
<a name="l01655"></a>01655 
<a name="l01656"></a><a class="code" href="chan__iax2_8c.html#a54d418013ac58cd364899046574d81b7">01656</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a54d418013ac58cd364899046574d81b7">scheduled_destroy</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *vid)
<a name="l01657"></a>01657 {
<a name="l01658"></a>01658    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(vid);
<a name="l01659"></a>01659    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01660"></a>01660    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l01661"></a>01661       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l01662"></a>01662          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Really destroying %d now...\n&quot;</span>, callno);
<a name="l01663"></a>01663       }
<a name="l01664"></a>01664       <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l01665"></a>01665    }
<a name="l01666"></a>01666    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01667"></a>01667    <span class="keywordflow">return</span> 0;
<a name="l01668"></a>01668 }
<a name="l01669"></a>01669 
<a name="l01670"></a><a class="code" href="chan__iax2_8c.html#a5006d988d2cffc6b45c4f82aaaa6ee2f">01670</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a5006d988d2cffc6b45c4f82aaaa6ee2f">free_signaling_queue_entry</a>(<span class="keyword">struct</span> signaling_queue_entry *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l01671"></a>01671 {
<a name="l01672"></a>01672    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(s-&gt;<a class="code" href="structsignaling__queue__entry.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>);
<a name="l01673"></a>01673    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(s);
<a name="l01674"></a>01674 }
<a name="l01675"></a>01675 <span class="comment"></span>
<a name="l01676"></a>01676 <span class="comment">/*! \brief This function must be called once we are sure the other side has</span>
<a name="l01677"></a>01677 <span class="comment"> *  given us a call number.  All signaling is held here until that point. */</span>
<a name="l01678"></a><a class="code" href="chan__iax2_8c.html#a8508e2643167997d779822916b4d0ab7">01678</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a8508e2643167997d779822916b4d0ab7" title="This function must be called once we are sure the other side has given us a call...">send_signaling</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l01679"></a>01679 {
<a name="l01680"></a>01680    <span class="keyword">struct </span>signaling_queue_entry *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l01681"></a>01681 
<a name="l01682"></a>01682    <span class="keywordflow">while</span> ((s = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;pvt-&gt;signaling_queue, next))) {
<a name="l01683"></a>01683       <a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">iax2_send</a>(pvt, &amp;s-&gt;<a class="code" href="structsignaling__queue__entry.html#a735f764b1095611ace084e7c6c06857d">f</a>, 0, -1, 0, 0, 0);
<a name="l01684"></a>01684       <a class="code" href="chan__iax2_8c.html#a5006d988d2cffc6b45c4f82aaaa6ee2f">free_signaling_queue_entry</a>(s);
<a name="l01685"></a>01685    }
<a name="l01686"></a>01686    pvt-&gt;hold_signaling = 0;
<a name="l01687"></a>01687 }
<a name="l01688"></a>01688 <span class="comment"></span>
<a name="l01689"></a>01689 <span class="comment">/*! \brief All frames other than that of type AST_FRAME_IAX must be held until</span>
<a name="l01690"></a>01690 <span class="comment"> *  we have received a destination call number. */</span>
<a name="l01691"></a><a class="code" href="chan__iax2_8c.html#a21b1f671722ff23a8c61511b42ccd34f">01691</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a21b1f671722ff23a8c61511b42ccd34f" title="All frames other than that of type AST_FRAME_IAX must be held until we have received...">queue_signalling</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l01692"></a>01692 {
<a name="l01693"></a>01693    <span class="keyword">struct </span>signaling_queue_entry *<span class="keyword">new</span>;
<a name="l01694"></a>01694 
<a name="l01695"></a>01695    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a> || !pvt-&gt;hold_signaling) {
<a name="l01696"></a>01696       <span class="keywordflow">return</span> 1; <span class="comment">/* do not queue this frame */</span>
<a name="l01697"></a>01697    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(<span class="keyword">new</span> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> signaling_queue_entry)))) {
<a name="l01698"></a>01698       <span class="keywordflow">return</span> -1;  <span class="comment">/* out of memory */</span>
<a name="l01699"></a>01699    }
<a name="l01700"></a>01700 
<a name="l01701"></a>01701    memcpy(&amp;new-&gt;f, f, <span class="keyword">sizeof</span>(new-&gt;f)); <span class="comment">/* copy ast_frame into our queue entry */</span>
<a name="l01702"></a>01702 
<a name="l01703"></a>01703    <span class="keywordflow">if</span> (new-&gt;f.datalen) { <span class="comment">/* if there is data in this frame copy it over as well */</span>
<a name="l01704"></a>01704       <span class="keywordflow">if</span> (!(new-&gt;f.data.ptr = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, new-&gt;f.datalen))) {
<a name="l01705"></a>01705          <a class="code" href="chan__iax2_8c.html#a5006d988d2cffc6b45c4f82aaaa6ee2f">free_signaling_queue_entry</a>(<span class="keyword">new</span>);
<a name="l01706"></a>01706          <span class="keywordflow">return</span> -1;
<a name="l01707"></a>01707       }
<a name="l01708"></a>01708       memcpy(new-&gt;f.data.ptr, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, <span class="keyword">sizeof</span>(*new-&gt;f.data.ptr));
<a name="l01709"></a>01709    }
<a name="l01710"></a>01710    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;pvt-&gt;signaling_queue, <span class="keyword">new</span>, next);
<a name="l01711"></a>01711 
<a name="l01712"></a>01712    <span class="keywordflow">return</span> 0;
<a name="l01713"></a>01713 }
<a name="l01714"></a>01714 
<a name="l01715"></a><a class="code" href="chan__iax2_8c.html#a47895ec4a3f05979c25af90125a8e4b5">01715</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a47895ec4a3f05979c25af90125a8e4b5">pvt_destructor</a>(<span class="keywordtype">void</span> *obj)
<a name="l01716"></a>01716 {
<a name="l01717"></a>01717    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = obj;
<a name="l01718"></a>01718    <span class="keyword">struct </span>iax_frame *cur = NULL;
<a name="l01719"></a>01719    <span class="keyword">struct </span>signaling_queue_entry *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l01720"></a>01720 
<a name="l01721"></a>01721    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l01722"></a>01722    <a class="code" href="chan__iax2_8c.html#a0d97140fc0f1c286328c703d1ae66002">iax2_destroy_helper</a>(pvt);
<a name="l01723"></a>01723    <a class="code" href="chan__iax2_8c.html#adbf5862b8a073aaa64ca049601eef7ec">sched_delay_remove</a>(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9511e23258e37ebfeadfdb80d55c10f9">callno_entry</a>);
<a name="l01724"></a>01724    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9511e23258e37ebfeadfdb80d55c10f9">callno_entry</a> = NULL;
<a name="l01725"></a>01725    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727    <span class="comment">/* Already gone */</span>
<a name="l01728"></a>01728    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>); 
<a name="l01729"></a>01729 
<a name="l01730"></a>01730    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l01731"></a>01731    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l01732"></a>01732       <span class="comment">/* Cancel any pending transmissions */</span>
<a name="l01733"></a>01733       <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> == pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) { 
<a name="l01734"></a>01734          cur-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l01735"></a>01735       }
<a name="l01736"></a>01736    }
<a name="l01737"></a>01737    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l01738"></a>01738 
<a name="l01739"></a>01739    <span class="keywordflow">while</span> ((s = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;pvt-&gt;signaling_queue, next))) {
<a name="l01740"></a>01740       <a class="code" href="chan__iax2_8c.html#a5006d988d2cffc6b45c4f82aaaa6ee2f">free_signaling_queue_entry</a>(s);
<a name="l01741"></a>01741    }
<a name="l01742"></a>01742 
<a name="l01743"></a>01743    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>) {
<a name="l01744"></a>01744       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a> = 0;
<a name="l01745"></a>01745    }
<a name="l01746"></a>01746 
<a name="l01747"></a>01747    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l01748"></a>01748       <a class="code" href="structjb__frame.html">jb_frame</a> frame;
<a name="l01749"></a>01749       <span class="keywordflow">if</span> (pvt-&gt;vars) {
<a name="l01750"></a>01750           <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(pvt-&gt;vars);
<a name="l01751"></a>01751           pvt-&gt;vars = NULL;
<a name="l01752"></a>01752       }
<a name="l01753"></a>01753 
<a name="l01754"></a>01754       <span class="keywordflow">while</span> (<a class="code" href="jitterbuf_8h.html#aaca01cea1cbcba683ca6d5b0bc009666" title="unconditionally get frames from jitterbuf until empty">jb_getall</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>, &amp;frame) == <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5abcbf2631f2f32ca1af2a49ff82bebaec">JB_OK</a>) {
<a name="l01755"></a>01755          <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(frame.<a class="code" href="structjb__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l01756"></a>01756       }
<a name="l01757"></a>01757 
<a name="l01758"></a>01758       <a class="code" href="jitterbuf_8h.html#a2714537be23d6bb12425ba8542c4b1f7" title="destroy jitterbuf">jb_destroy</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>);
<a name="l01759"></a>01759       <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(pvt);
<a name="l01760"></a>01760    }
<a name="l01761"></a>01761 }
<a name="l01762"></a>01762 
<a name="l01763"></a><a class="code" href="chan__iax2_8c.html#ad12e31747e9dfa53efc09e11a8efc2a7">01763</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *<a class="code" href="chan__iax2_8c.html#ad12e31747e9dfa53efc09e11a8efc2a7">new_iax</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">const</span> <span class="keywordtype">char</span> *host)
<a name="l01764"></a>01764 {
<a name="l01765"></a>01765    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *tmp;
<a name="l01766"></a>01766    <a class="code" href="structjb__conf.html">jb_conf</a> jbconf;
<a name="l01767"></a>01767 
<a name="l01768"></a>01768    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*tmp), <a class="code" href="chan__iax2_8c.html#a47895ec4a3f05979c25af90125a8e4b5">pvt_destructor</a>))) {
<a name="l01769"></a>01769       <span class="keywordflow">return</span> NULL;
<a name="l01770"></a>01770    }
<a name="l01771"></a>01771 
<a name="l01772"></a>01772    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(tmp, 32)) {
<a name="l01773"></a>01773       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(tmp, -1);
<a name="l01774"></a>01774       tmp = NULL;
<a name="l01775"></a>01775       <span class="keywordflow">return</span> NULL;
<a name="l01776"></a>01776    }
<a name="l01777"></a>01777       
<a name="l01778"></a>01778    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a> = <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l01779"></a>01779    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">pingid</a> = -1;
<a name="l01780"></a>01780    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">lagid</a> = -1;
<a name="l01781"></a>01781    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bae7aaf2ef69cbcf5ffb6e0b9ba060">autoid</a> = -1;
<a name="l01782"></a>01782    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#a94bf6ec5b99ea2a6378669fe6021e2e8">authid</a> = -1;
<a name="l01783"></a>01783    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">initid</a> = -1;
<a name="l01784"></a>01784    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">keyrotateid</a> = -1;
<a name="l01785"></a>01785 
<a name="l01786"></a>01786    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp,<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;s&quot;</span>);
<a name="l01787"></a>01787    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp,host, host);
<a name="l01788"></a>01788 
<a name="l01789"></a>01789    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a> = <a class="code" href="jitterbuf_8h.html#a2fd56d2b8a06ad6b89cf67619f790911" title="new jitterbuf">jb_new</a>();
<a name="l01790"></a>01790    tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">jbid</a> = -1;
<a name="l01791"></a>01791    jbconf.<a class="code" href="structjb__conf.html#a560b79d26ead7b640d797181c9c3122c">max_jitterbuf</a> = maxjitterbuffer;
<a name="l01792"></a>01792    jbconf.<a class="code" href="structjb__conf.html#ab5d708c3e3489b6fd1f92b19939c18e8">resync_threshold</a> = resyncthreshold;
<a name="l01793"></a>01793    jbconf.<a class="code" href="structjb__conf.html#af42f40eb2b87dd2147bd66357e99eff4">max_contig_interp</a> = maxjitterinterps;
<a name="l01794"></a>01794    jbconf.<a class="code" href="structjb__conf.html#a322d898485ffd6c3c07391f381903bdd">target_extra</a> = jittertargetextra;
<a name="l01795"></a>01795    <a class="code" href="jitterbuf_8h.html#a8ecded60181a9c1d1dae2fe05bddccf8" title="set jitterbuf conf">jb_setconf</a>(tmp-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>,&amp;jbconf);
<a name="l01796"></a>01796 
<a name="l01797"></a>01797    <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;tmp-&gt;dpentries);
<a name="l01798"></a>01798 
<a name="l01799"></a>01799    tmp-&gt;hold_signaling = 1;
<a name="l01800"></a>01800    <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;tmp-&gt;signaling_queue);
<a name="l01801"></a>01801 
<a name="l01802"></a>01802    <span class="keywordflow">return</span> tmp;
<a name="l01803"></a>01803 }
<a name="l01804"></a>01804 
<a name="l01805"></a><a class="code" href="chan__iax2_8c.html#aa8a32e0915c1d863697804c3702f439b">01805</a> <span class="keyword">static</span> <span class="keyword">struct </span>iax_frame *<a class="code" href="chan__iax2_8c.html#aa8a32e0915c1d863697804c3702f439b">iaxfrdup2</a>(<span class="keyword">struct</span> iax_frame *fr)
<a name="l01806"></a>01806 {
<a name="l01807"></a>01807    <span class="keyword">struct </span>iax_frame *<span class="keyword">new</span> = <a class="code" href="iax2-parser_8c.html#a99aa3f5f21d75970ba8d9f4700d03d38">iax_frame_new</a>(<a class="code" href="iax2-parser_8h.html#ac0a2881003b5f94b330a60f36367ee57">DIRECTION_INGRESS</a>, fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, fr-&gt;<a class="code" href="structiax__frame.html#af80030526d3bbc6bf90c9ab6cdcdba59">cacheable</a>);
<a name="l01808"></a>01808    <span class="keywordflow">if</span> (<span class="keyword">new</span>) {
<a name="l01809"></a>01809       <span class="keywordtype">size_t</span> <a class="code" href="structiax__frame.html#ac6dd018a429627fc0ad8d167c7c46ef4">afdatalen</a> = <span class="keyword">new</span>-&gt;afdatalen;
<a name="l01810"></a>01810       memcpy(<span class="keyword">new</span>, fr, <span class="keyword">sizeof</span>(*<span class="keyword">new</span>));
<a name="l01811"></a>01811       <a class="code" href="iax2-parser_8c.html#ac7172830d863702f96f81d8a09612428">iax_frame_wrap</a>(<span class="keyword">new</span>, &amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>);
<a name="l01812"></a>01812       <span class="keyword">new</span>-&gt;afdatalen = afdatalen;
<a name="l01813"></a>01813       <span class="keyword">new</span>-&gt;data = NULL;
<a name="l01814"></a>01814       <span class="keyword">new</span>-&gt;datalen = 0;
<a name="l01815"></a>01815       <span class="keyword">new</span>-&gt;direction = <a class="code" href="iax2-parser_8h.html#ac0a2881003b5f94b330a60f36367ee57">DIRECTION_INGRESS</a>;
<a name="l01816"></a>01816       <span class="keyword">new</span>-&gt;retrans = -1;
<a name="l01817"></a>01817    }
<a name="l01818"></a>01818    <span class="keywordflow">return</span> <span class="keyword">new</span>;
<a name="l01819"></a>01819 }
<a name="l01820"></a>01820 <span class="comment">/* keep these defined in this order.  They are used in find_callno to</span>
<a name="l01821"></a>01821 <span class="comment"> * determine whether or not a new call number should be allowed. */</span>
<a name="l01822"></a>01822 <span class="keyword">enum</span> {
<a name="l01823"></a>01823    <span class="comment">/* do not allow a new call number, only search ones in use for match */</span>
<a name="l01824"></a><a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a4b271784626bbfd88ad47a67f4bd82bf">01824</a>    <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a4b271784626bbfd88ad47a67f4bd82bf">NEW_PREVENT</a> = 0,
<a name="l01825"></a>01825    <span class="comment">/* search for match first, then allow a new one to be allocated */</span>
<a name="l01826"></a><a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a83c6eb629d0470b1897e3cdb23ee75f4">01826</a>    <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a83c6eb629d0470b1897e3cdb23ee75f4">NEW_ALLOW</a> = 1,
<a name="l01827"></a>01827    <span class="comment">/* do not search for match, force a new call number */</span>
<a name="l01828"></a><a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">01828</a>    <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">NEW_FORCE</a> = 2,
<a name="l01829"></a>01829    <span class="comment">/* do not search for match, force a new call number.  Signifies call number</span>
<a name="l01830"></a>01830 <span class="comment">    * has been calltoken validated */</span>
<a name="l01831"></a><a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a944e9f4cbb821a363743da28175baea5">01831</a>    <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a944e9f4cbb821a363743da28175baea5">NEW_ALLOW_CALLTOKEN_VALIDATED</a> = 3,
<a name="l01832"></a>01832 };
<a name="l01833"></a>01833 
<a name="l01834"></a><a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">01834</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structiax__frame.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *cur, <span class="keywordtype">int</span> check_dcallno)
<a name="l01835"></a>01835 {
<a name="l01836"></a>01836    <span class="keywordflow">if</span> ((cur-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr == sin-&gt;sin_addr.s_addr) &amp;&amp;
<a name="l01837"></a>01837       (cur-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port == sin-&gt;sin_port)) {
<a name="l01838"></a>01838       <span class="comment">/* This is the main host */</span>
<a name="l01839"></a>01839       <span class="keywordflow">if</span> ( (cur-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> == 0 || cur-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> == callno) &amp;&amp;
<a name="l01840"></a>01840           (check_dcallno ? dcallno == cur-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> : 1) ) {
<a name="l01841"></a>01841          <span class="comment">/* That&apos;s us.  Be sure we keep track of the peer call number */</span>
<a name="l01842"></a>01842          <span class="keywordflow">return</span> 1;
<a name="l01843"></a>01843       }
<a name="l01844"></a>01844    }
<a name="l01845"></a>01845    <span class="keywordflow">if</span> ((cur-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>.sin_addr.s_addr == sin-&gt;sin_addr.s_addr) &amp;&amp;
<a name="l01846"></a>01846        (cur-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>.sin_port == sin-&gt;sin_port) &amp;&amp; (cur-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a>)) {
<a name="l01847"></a>01847       <span class="comment">/* We&apos;re transferring */</span>
<a name="l01848"></a>01848       <span class="keywordflow">if</span> ((dcallno == cur-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) || (cur-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a3fe2a477f9e84842066802bb8ad8a2b8">TRANSFER_MEDIAPASS</a> &amp;&amp; cur-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a> == callno))
<a name="l01849"></a>01849          <span class="keywordflow">return</span> 1;
<a name="l01850"></a>01850    }
<a name="l01851"></a>01851    <span class="keywordflow">return</span> 0;
<a name="l01852"></a>01852 }
<a name="l01853"></a>01853 
<a name="l01854"></a><a class="code" href="chan__iax2_8c.html#ae2fc795355e133f36b68cf2f4f8c6638">01854</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ae2fc795355e133f36b68cf2f4f8c6638">update_max_trunk</a>(<span class="keywordtype">void</span>)
<a name="l01855"></a>01855 {
<a name="l01856"></a>01856    <span class="keywordtype">int</span> max = <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>;
<a name="l01857"></a>01857    <span class="keywordtype">int</span> x;
<a name="l01858"></a>01858 
<a name="l01859"></a>01859    <span class="comment">/* XXX Prolly don&apos;t need locks here XXX */</span>
<a name="l01860"></a>01860    <span class="keywordflow">for</span> (x = <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>) - 1; x++) {
<a name="l01861"></a>01861       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l01862"></a>01862          max = x + 1;
<a name="l01863"></a>01863       }
<a name="l01864"></a>01864    }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866    <a class="code" href="chan__iax2_8c.html#a0adf1f10ece8bb420a7538be14aeeb8a">maxtrunkcall</a> = max;
<a name="l01867"></a>01867    <span class="keywordflow">if</span> (iaxdebug)
<a name="l01868"></a>01868       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;New max trunk callno is %d\n&quot;</span>, max);
<a name="l01869"></a>01869 }
<a name="l01870"></a>01870 
<a name="l01871"></a><a class="code" href="chan__iax2_8c.html#afd5c23cfc617fcaa37eb68fa5ef523ac">01871</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#afd5c23cfc617fcaa37eb68fa5ef523ac">update_max_nontrunk</a>(<span class="keywordtype">void</span>)
<a name="l01872"></a>01872 {
<a name="l01873"></a>01873    <span class="keywordtype">int</span> max = 1;
<a name="l01874"></a>01874    <span class="keywordtype">int</span> x;
<a name="l01875"></a>01875    <span class="comment">/* XXX Prolly don&apos;t need locks here XXX */</span>
<a name="l01876"></a>01876    <span class="keywordflow">for</span> (x=1;x&lt;<a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a> - 1; x++) {
<a name="l01877"></a>01877       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x])
<a name="l01878"></a>01878          max = x + 1;
<a name="l01879"></a>01879    }
<a name="l01880"></a>01880    <a class="code" href="chan__iax2_8c.html#ab3fe1bdf89336ce3c36bb6bbc3d085ae">maxnontrunkcall</a> = max;
<a name="l01881"></a>01881    <span class="keywordflow">if</span> (iaxdebug)
<a name="l01882"></a>01882       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;New max nontrunk callno is %d\n&quot;</span>, max);
<a name="l01883"></a>01883 }
<a name="l01884"></a>01884 
<a name="l01885"></a><a class="code" href="chan__iax2_8c.html#afe7b37fe23d6a5abe8a477950a399f1e">01885</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afe7b37fe23d6a5abe8a477950a399f1e">make_trunk</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <span class="keywordtype">int</span> locked)
<a name="l01886"></a>01886 {
<a name="l01887"></a>01887    <span class="keywordtype">int</span> x;
<a name="l01888"></a>01888    <span class="keywordtype">int</span> res= 0;
<a name="l01889"></a>01889    <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a>;
<a name="l01890"></a>01890    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;oseqno) {
<a name="l01891"></a>01891       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t make trunk once a call has started!\n&quot;</span>);
<a name="l01892"></a>01892       <span class="keywordflow">return</span> -1;
<a name="l01893"></a>01893    }
<a name="l01894"></a>01894    <span class="keywordflow">if</span> (callno &amp; <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>) {
<a name="l01895"></a>01895       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Call %d is already a trunk\n&quot;</span>, callno);
<a name="l01896"></a>01896       <span class="keywordflow">return</span> -1;
<a name="l01897"></a>01897    }
<a name="l01898"></a>01898 
<a name="l01899"></a>01899    <span class="keywordflow">if</span> (!(callno_entry = <a class="code" href="chan__iax2_8c.html#a6eb424bb73908133f54e5839926e6a50">get_unused_callno</a>(1, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;callno_entry-&gt;<a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">validated</a>))) {
<a name="l01900"></a>01900       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to trunk call: Insufficient space\n&quot;</span>);
<a name="l01901"></a>01901       <span class="keywordflow">return</span> -1;
<a name="l01902"></a>01902    }
<a name="l01903"></a>01903 
<a name="l01904"></a>01904    x = callno_entry-&gt;<a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>;
<a name="l01905"></a>01905    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l01906"></a>01906 <span class="comment"></span>
<a name="l01907"></a>01907 <span class="comment">   /*!</span>
<a name="l01908"></a>01908 <span class="comment">    * \note We delete these before switching the slot, because if</span>
<a name="l01909"></a>01909 <span class="comment">    * they fire in the meantime, they will generate a warning.</span>
<a name="l01910"></a>01910 <span class="comment">    */</span>
<a name="l01911"></a>01911    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;pingid);
<a name="l01912"></a>01912    <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;lagid);
<a name="l01913"></a>01913    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x] = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l01914"></a>01914    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = x;
<a name="l01915"></a>01915 
<a name="l01916"></a>01916    <span class="comment">/* since we copied over the pvt from a different callno, make sure the old entry is replaced</span>
<a name="l01917"></a>01917 <span class="comment">    * before assigning the new one */</span>
<a name="l01918"></a>01918    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;callno_entry) {
<a name="l01919"></a>01919       <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, <a class="code" href="chan__iax2_8c.html#acf1617df6e6203c6c0d87b5ff53e61dc">MIN_REUSE_TIME</a> * 1000, <a class="code" href="chan__iax2_8c.html#a17a9399beec50b63e368c36d7c0d872d">replace_callno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;callno_entry);
<a name="l01920"></a>01920    }
<a name="l01921"></a>01921    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9511e23258e37ebfeadfdb80d55c10f9">callno_entry</a> = callno_entry;
<a name="l01922"></a>01922 
<a name="l01923"></a>01923    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] = NULL;
<a name="l01924"></a>01924    <span class="comment">/* Update the two timers that should have been started */</span>
<a name="l01925"></a>01925    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">pingid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, 
<a name="l01926"></a>01926       ping_time * 1000, <a class="code" href="chan__iax2_8c.html#a038a10c0c7963f6f551ec9e462391d92">send_ping</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)x);
<a name="l01927"></a>01927    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">lagid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, 
<a name="l01928"></a>01928       lagrq_time * 1000, <a class="code" href="chan__iax2_8c.html#a9773a01290343052959786eb066fd067">send_lagrq</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)x);
<a name="l01929"></a>01929 
<a name="l01930"></a>01930    <span class="keywordflow">if</span> (locked)
<a name="l01931"></a>01931       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l01932"></a>01932    res = x;
<a name="l01933"></a>01933    <span class="keywordflow">if</span> (!locked)
<a name="l01934"></a>01934       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l01935"></a>01935 
<a name="l01936"></a>01936    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Made call %d into trunk call %d\n&quot;</span>, callno, x);
<a name="l01937"></a>01937    <span class="comment">/* We move this call from a non-trunked to a trunked call */</span>
<a name="l01938"></a>01938    <a class="code" href="chan__iax2_8c.html#ae2fc795355e133f36b68cf2f4f8c6638">update_max_trunk</a>();
<a name="l01939"></a>01939    <a class="code" href="chan__iax2_8c.html#afd5c23cfc617fcaa37eb68fa5ef523ac">update_max_nontrunk</a>();
<a name="l01940"></a>01940    <span class="keywordflow">return</span> res;
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 
<a name="l01943"></a><a class="code" href="chan__iax2_8c.html#a134adba13ad8ba211d9eb0c2ea8ea439">01943</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a134adba13ad8ba211d9eb0c2ea8ea439">store_by_transfercallno</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l01944"></a>01944 {
<a name="l01945"></a>01945    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a>) {
<a name="l01946"></a>01946       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;This should not be called without a transfer call number.\n&quot;</span>);
<a name="l01947"></a>01947       <span class="keywordflow">return</span>;
<a name="l01948"></a>01948    }
<a name="l01949"></a>01949 
<a name="l01950"></a>01950    <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>, pvt);
<a name="l01951"></a>01951 }
<a name="l01952"></a>01952 
<a name="l01953"></a><a class="code" href="chan__iax2_8c.html#ad175242682b4fbf0e8c54502bf805225">01953</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ad175242682b4fbf0e8c54502bf805225">remove_by_transfercallno</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l01954"></a>01954 {
<a name="l01955"></a>01955    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a>) {
<a name="l01956"></a>01956       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;This should not be called without a transfer call number.\n&quot;</span>);
<a name="l01957"></a>01957       <span class="keywordflow">return</span>;
<a name="l01958"></a>01958    }
<a name="l01959"></a>01959 
<a name="l01960"></a>01960    <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>, pvt);
<a name="l01961"></a>01961 }
<a name="l01962"></a><a class="code" href="chan__iax2_8c.html#aa7e2b9897bb7bc4e4cb32cf763f37527">01962</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aa7e2b9897bb7bc4e4cb32cf763f37527">store_by_peercallno</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l01963"></a>01963 {
<a name="l01964"></a>01964    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l01965"></a>01965       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;This should not be called without a peer call number.\n&quot;</span>);
<a name="l01966"></a>01966       <span class="keywordflow">return</span>;
<a name="l01967"></a>01967    }
<a name="l01968"></a>01968 
<a name="l01969"></a>01969    <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>, pvt);
<a name="l01970"></a>01970 }
<a name="l01971"></a>01971 
<a name="l01972"></a><a class="code" href="chan__iax2_8c.html#ae48d962bcb33faf6f14966b39668d439">01972</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ae48d962bcb33faf6f14966b39668d439">remove_by_peercallno</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l01973"></a>01973 {
<a name="l01974"></a>01974    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l01975"></a>01975       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;This should not be called without a peer call number.\n&quot;</span>);
<a name="l01976"></a>01976       <span class="keywordflow">return</span>;
<a name="l01977"></a>01977    }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979    <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>, pvt);
<a name="l01980"></a>01980 }
<a name="l01981"></a>01981 
<a name="l01982"></a><a class="code" href="chan__iax2_8c.html#acc5f9a0b1f47c10c3546402833026464">01982</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#acc5f9a0b1f47c10c3546402833026464">addr_range_delme_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l01983"></a>01983 {
<a name="l01984"></a>01984    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *lim = obj;
<a name="l01985"></a>01985    lim-&gt;<a class="code" href="structaddr__range.html#aaf5ee49ffd469534bb3c2e3bf68dc510">delme</a> = 1;
<a name="l01986"></a>01986    <span class="keywordflow">return</span> 0;
<a name="l01987"></a>01987 }
<a name="l01988"></a>01988 
<a name="l01989"></a><a class="code" href="chan__iax2_8c.html#a4800087727fb124e0ec03bc8490608a9">01989</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a4800087727fb124e0ec03bc8490608a9">addr_range_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l01990"></a>01990 {
<a name="l01991"></a>01991    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *lim = obj;
<a name="l01992"></a>01992    <span class="keywordflow">return</span> abs((<span class="keywordtype">int</span>) lim-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>.<a class="code" href="structast__ha.html#a45df45150d4d7ca82a48dfbaa981120e">netaddr</a>.s_addr);
<a name="l01993"></a>01993 }
<a name="l01994"></a>01994 
<a name="l01995"></a><a class="code" href="chan__iax2_8c.html#ac6f1ac1624ba561a9e25817e931fa861">01995</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac6f1ac1624ba561a9e25817e931fa861">addr_range_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l01996"></a>01996 {
<a name="l01997"></a>01997    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *lim1 = obj, *lim2 = arg;
<a name="l01998"></a>01998    <span class="keywordflow">return</span> ((lim1-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>.<a class="code" href="structast__ha.html#a45df45150d4d7ca82a48dfbaa981120e">netaddr</a>.s_addr == lim2-&gt;ha.netaddr.s_addr) &amp;&amp;
<a name="l01999"></a>01999       (lim1-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>.<a class="code" href="structast__ha.html#a7b83baecde62ac17306ac3cc5770c27a">netmask</a>.s_addr == lim2-&gt;ha.netmask.s_addr)) ?
<a name="l02000"></a>02000       <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l02001"></a>02001 }
<a name="l02002"></a>02002 
<a name="l02003"></a><a class="code" href="chan__iax2_8c.html#a1f5894c887d1f13763ad64f70da70d25">02003</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1f5894c887d1f13763ad64f70da70d25">peercnt_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l02004"></a>02004 {
<a name="l02005"></a>02005    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a> = obj;
<a name="l02006"></a>02006    <span class="keywordflow">return</span> abs((<span class="keywordtype">int</span>) peercnt-&gt;<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a>);
<a name="l02007"></a>02007 }
<a name="l02008"></a>02008 
<a name="l02009"></a><a class="code" href="chan__iax2_8c.html#afd4d124738c3198a352618f832ceb53d">02009</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afd4d124738c3198a352618f832ceb53d">peercnt_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l02010"></a>02010 {
<a name="l02011"></a>02011    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *peercnt1 = obj, *peercnt2 = arg;
<a name="l02012"></a>02012    <span class="keywordflow">return</span> (peercnt1-&gt;<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a> == peercnt2-&gt;addr) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l02013"></a>02013 }
<a name="l02014"></a>02014 
<a name="l02015"></a><a class="code" href="chan__iax2_8c.html#a22f896632758e46175d1a20ec132fd97">02015</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a22f896632758e46175d1a20ec132fd97">addr_range_match_address_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l02016"></a>02016 {
<a name="l02017"></a>02017    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *<a class="code" href="structaddr__range.html">addr_range</a> = obj;
<a name="l02018"></a>02018    <span class="keyword">struct </span>sockaddr_in *sin = arg;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020    <span class="keywordflow">if</span> ((sin-&gt;sin_addr.s_addr &amp; addr_range-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>.<a class="code" href="structast__ha.html#a7b83baecde62ac17306ac3cc5770c27a">netmask</a>.s_addr) == addr_range-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>.<a class="code" href="structast__ha.html#a45df45150d4d7ca82a48dfbaa981120e">netaddr</a>.s_addr) {
<a name="l02021"></a>02021       <span class="keywordflow">return</span> <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a>;
<a name="l02022"></a>02022    }
<a name="l02023"></a>02023    <span class="keywordflow">return</span> 0;
<a name="l02024"></a>02024 }
<a name="l02025"></a>02025 <span class="comment"></span>
<a name="l02026"></a>02026 <span class="comment">/*! </span>
<a name="l02027"></a>02027 <span class="comment"> * \internal</span>
<a name="l02028"></a>02028 <span class="comment"> *</span>
<a name="l02029"></a>02029 <span class="comment"> * \brief compares sin to calltoken_ignores table to determine if validation is required.</span>
<a name="l02030"></a>02030 <span class="comment"> */</span>
<a name="l02031"></a><a class="code" href="chan__iax2_8c.html#a340a0725dca7baf10001f3a26de46212">02031</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a340a0725dca7baf10001f3a26de46212">calltoken_required</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keywordtype">int</span> subclass)
<a name="l02032"></a>02032 {
<a name="l02033"></a>02033    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *<a class="code" href="structaddr__range.html">addr_range</a>;
<a name="l02034"></a>02034    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l02035"></a>02035    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l02036"></a>02036    <span class="comment">/* if no username is given, check for guest accounts */</span>
<a name="l02037"></a>02037    <span class="keyword">const</span> <span class="keywordtype">char</span> *find = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(name, <span class="stringliteral">&quot;guest&quot;</span>);
<a name="l02038"></a>02038    <span class="keywordtype">int</span> res = 1;  <span class="comment">/* required by default */</span>
<a name="l02039"></a>02039    <span class="keywordtype">int</span> optional = 0;
<a name="l02040"></a>02040    <span class="keyword">enum</span> <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32" title="Call token validation settings.">calltoken_peer_enum</a> <a class="code" href="chan__iax2_8c.html#a340a0725dca7baf10001f3a26de46212">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a5e7188ffc2bdb50ce90b5f8e0a1d7ac3" title="Default calltoken required unless the ip is in the ignorelist.">CALLTOKEN_DEFAULT</a>;
<a name="l02041"></a>02041    <span class="comment">/* There are only two cases in which calltoken validation is not required.</span>
<a name="l02042"></a>02042 <span class="comment">    * Case 1. sin falls within the list of address ranges specified in the calltoken optional table and</span>
<a name="l02043"></a>02043 <span class="comment">    *         the peer definition has not set the requirecalltoken option.</span>
<a name="l02044"></a>02044 <span class="comment">    * Case 2. Username is a valid peer/user, and that peer has requirecalltoken set either auto or no.</span>
<a name="l02045"></a>02045 <span class="comment">    */</span>
<a name="l02046"></a>02046 
<a name="l02047"></a>02047    <span class="comment">/* ----- Case 1 ----- */</span>
<a name="l02048"></a>02048    <span class="keywordflow">if</span> ((addr_range = <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(calltoken_ignores, 0, <a class="code" href="chan__iax2_8c.html#a22f896632758e46175d1a20ec132fd97">addr_range_match_address_cb</a>, sin))) {
<a name="l02049"></a>02049       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(addr_range, -1);
<a name="l02050"></a>02050       optional = 1;
<a name="l02051"></a>02051    }
<a name="l02052"></a>02052 
<a name="l02053"></a>02053    <span class="comment">/* ----- Case 2 ----- */</span>
<a name="l02054"></a>02054    <span class="keywordflow">if</span> ((subclass == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) &amp;&amp; (user = <a class="code" href="chan__iax2_8c.html#aa56d736414c9f5f71da37c50f0f57760">find_user</a>(find))) {
<a name="l02055"></a>02055       calltoken_required = user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a>;
<a name="l02056"></a>02056    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((subclass == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) &amp;&amp; (user = <a class="code" href="chan__iax2_8c.html#afb25e20b1fe40ed319996fdd9c289085">realtime_user</a>(find, sin))) {
<a name="l02057"></a>02057       calltoken_required = user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a>;
<a name="l02058"></a>02058    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((subclass != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) &amp;&amp; (peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(find, 0))) {
<a name="l02059"></a>02059       calltoken_required = peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a>;
<a name="l02060"></a>02060    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((subclass != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) &amp;&amp; (peer = <a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">realtime_peer</a>(find, sin))) {
<a name="l02061"></a>02061       calltoken_required = peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a>;
<a name="l02062"></a>02062    }
<a name="l02063"></a>02063 
<a name="l02064"></a>02064    <span class="keywordflow">if</span> (peer) {
<a name="l02065"></a>02065       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l02066"></a>02066    }
<a name="l02067"></a>02067    <span class="keywordflow">if</span> (user) {
<a name="l02068"></a>02068       <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l02069"></a>02069    }
<a name="l02070"></a>02070 
<a name="l02071"></a>02071    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Determining if address %s with username %s requires calltoken validation.  Optional = %d  calltoken_required = %d \n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), name, optional, calltoken_required);
<a name="l02072"></a>02072    <span class="keywordflow">if</span> (((calltoken_required == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a7ee00866dc8402f0f253e0f8fff829fd" title="Do not require call token validation.">CALLTOKEN_NO</a>) || (calltoken_required == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a>)) ||
<a name="l02073"></a>02073       (optional &amp;&amp; (calltoken_required == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a5e7188ffc2bdb50ce90b5f8e0a1d7ac3" title="Default calltoken required unless the ip is in the ignorelist.">CALLTOKEN_DEFAULT</a>))) {
<a name="l02074"></a>02074       res = 0;
<a name="l02075"></a>02075    }
<a name="l02076"></a>02076 
<a name="l02077"></a>02077    <span class="keywordflow">return</span> res;
<a name="l02078"></a>02078 }
<a name="l02079"></a>02079 <span class="comment"></span>
<a name="l02080"></a>02080 <span class="comment">/*! </span>
<a name="l02081"></a>02081 <span class="comment"> * \internal</span>
<a name="l02082"></a>02082 <span class="comment"> *</span>
<a name="l02083"></a>02083 <span class="comment"> * \brief set peercnt callno limit.</span>
<a name="l02084"></a>02084 <span class="comment"> *</span>
<a name="l02085"></a>02085 <span class="comment"> * \details </span>
<a name="l02086"></a>02086 <span class="comment"> * First looks in custom definitions. If not found, global limit</span>
<a name="l02087"></a>02087 <span class="comment"> * is used.  Entries marked as reg already have</span>
<a name="l02088"></a>02088 <span class="comment"> * a custom limit set by a registration and are not modified.</span>
<a name="l02089"></a>02089 <span class="comment"> */</span>
<a name="l02090"></a><a class="code" href="chan__iax2_8c.html#a024ed5afd48b8a0b580d3e8fa4266478">02090</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a024ed5afd48b8a0b580d3e8fa4266478">set_peercnt_limit</a>(<span class="keyword">struct</span> <a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>)
<a name="l02091"></a>02091 {
<a name="l02092"></a>02092    uint16_t limit = global_maxcallno;
<a name="l02093"></a>02093    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *<a class="code" href="structaddr__range.html">addr_range</a>;
<a name="l02094"></a>02094    <span class="keyword">struct </span>sockaddr_in sin = {
<a name="l02095"></a>02095       .sin_addr.s_addr = peercnt-&gt;<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a>,
<a name="l02096"></a>02096    };
<a name="l02097"></a>02097 
<a name="l02098"></a>02098 
<a name="l02099"></a>02099    <span class="keywordflow">if</span> (peercnt-&gt;<a class="code" href="structpeercnt.html#a1d7b6d3b02227576b00992aece354e8d">reg</a> &amp;&amp; peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>) {
<a name="l02100"></a>02100       <span class="keywordflow">return</span>; <span class="comment">/* this peercnt has a custom limit set by a registration */</span>
<a name="l02101"></a>02101    }
<a name="l02102"></a>02102 
<a name="l02103"></a>02103    <span class="keywordflow">if</span> ((addr_range = <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(callno_limits, 0, <a class="code" href="chan__iax2_8c.html#a22f896632758e46175d1a20ec132fd97">addr_range_match_address_cb</a>, &amp;sin))) {
<a name="l02104"></a>02104       limit = addr_range-&gt;<a class="code" href="structaddr__range.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>;
<a name="l02105"></a>02105       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;custom addr_range %d found for %s\n&quot;</span>, limit, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr));
<a name="l02106"></a>02106       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(addr_range, -1);
<a name="l02107"></a>02107    }
<a name="l02108"></a>02108 
<a name="l02109"></a>02109    peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a> = limit;
<a name="l02110"></a>02110 }
<a name="l02111"></a>02111 <span class="comment"></span>
<a name="l02112"></a>02112 <span class="comment">/*! </span>
<a name="l02113"></a>02113 <span class="comment"> * \internal</span>
<a name="l02114"></a>02114 <span class="comment"> * \brief sets limits for all peercnts in table. done on reload to reflect changes in conf.</span>
<a name="l02115"></a>02115 <span class="comment"> */</span>
<a name="l02116"></a><a class="code" href="chan__iax2_8c.html#aa897ee9cba0aebf207f562d94cd0b5b8">02116</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa897ee9cba0aebf207f562d94cd0b5b8">set_peercnt_limit_all_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l02117"></a>02117 {
<a name="l02118"></a>02118    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a> = obj;
<a name="l02119"></a>02119 
<a name="l02120"></a>02120    <a class="code" href="chan__iax2_8c.html#a024ed5afd48b8a0b580d3e8fa4266478">set_peercnt_limit</a>(peercnt);
<a name="l02121"></a>02121    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Reset limits for peercnts table\n&quot;</span>);
<a name="l02122"></a>02122 
<a name="l02123"></a>02123    <span class="keywordflow">return</span> 0;
<a name="l02124"></a>02124 }
<a name="l02125"></a>02125 <span class="comment"></span>
<a name="l02126"></a>02126 <span class="comment">/*! </span>
<a name="l02127"></a>02127 <span class="comment"> * \internal</span>
<a name="l02128"></a>02128 <span class="comment"> * \brief returns match if delme is set. </span>
<a name="l02129"></a>02129 <span class="comment"> */</span>
<a name="l02130"></a><a class="code" href="chan__iax2_8c.html#a3d657e16849603ec78eda638d20c878b">02130</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3d657e16849603ec78eda638d20c878b">prune_addr_range_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l02131"></a>02131 {
<a name="l02132"></a>02132    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *<a class="code" href="structaddr__range.html">addr_range</a> = obj;
<a name="l02133"></a>02133 
<a name="l02134"></a>02134    <span class="keywordflow">return</span> addr_range-&gt;<a class="code" href="structaddr__range.html#aaf5ee49ffd469534bb3c2e3bf68dc510">delme</a> ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> : 0;
<a name="l02135"></a>02135 }
<a name="l02136"></a>02136 <span class="comment"></span>
<a name="l02137"></a>02137 <span class="comment">/*! </span>
<a name="l02138"></a>02138 <span class="comment"> * \internal</span>
<a name="l02139"></a>02139 <span class="comment"> * \brief modifies peercnt entry in peercnts table. Used to set custom limit or mark a registered ip</span>
<a name="l02140"></a>02140 <span class="comment"> */</span>
<a name="l02141"></a><a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">02141</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">peercnt_modify</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> reg, uint16_t <a class="code" href="structaddr__range.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>, <span class="keyword">struct</span> sockaddr_in *sin)
<a name="l02142"></a>02142 {
<a name="l02143"></a>02143    <span class="comment">/* this function turns off and on custom callno limits set by peer registration */</span>
<a name="l02144"></a>02144    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>;
<a name="l02145"></a>02145    <span class="keyword">struct </span>peercnt tmp = {
<a name="l02146"></a>02146       .<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a> = sin-&gt;sin_addr.s_addr,
<a name="l02147"></a>02147    };
<a name="l02148"></a>02148 
<a name="l02149"></a>02149    <span class="keywordflow">if</span> ((peercnt = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peercnts, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02150"></a>02150       peercnt-&gt;<a class="code" href="structpeercnt.html#a1d7b6d3b02227576b00992aece354e8d">reg</a> = reg;
<a name="l02151"></a>02151       <span class="keywordflow">if</span> (limit) {
<a name="l02152"></a>02152          peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a> = limit;
<a name="l02153"></a>02153       } <span class="keywordflow">else</span> {
<a name="l02154"></a>02154          <a class="code" href="chan__iax2_8c.html#a024ed5afd48b8a0b580d3e8fa4266478">set_peercnt_limit</a>(peercnt);
<a name="l02155"></a>02155       }
<a name="l02156"></a>02156       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;peercnt entry %s modified limit:%d registered:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>, peercnt-&gt;<a class="code" href="structpeercnt.html#a1d7b6d3b02227576b00992aece354e8d">reg</a>);
<a name="l02157"></a>02157       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnt, -1); <span class="comment">/* decrement ref from find */</span>
<a name="l02158"></a>02158    }
<a name="l02159"></a>02159 }
<a name="l02160"></a>02160 <span class="comment"></span>
<a name="l02161"></a>02161 <span class="comment">/*! </span>
<a name="l02162"></a>02162 <span class="comment"> * \internal</span>
<a name="l02163"></a>02163 <span class="comment"> * \brief adds an ip to the peercnts table, increments connection count if it already exists</span>
<a name="l02164"></a>02164 <span class="comment"> *</span>
<a name="l02165"></a>02165 <span class="comment"> * \details First searches for the address in the peercnts table.  If found</span>
<a name="l02166"></a>02166 <span class="comment"> * the current count is incremented.  If not found a new peercnt is allocated</span>
<a name="l02167"></a>02167 <span class="comment"> * and linked into the peercnts table with a call number count of 1.</span>
<a name="l02168"></a>02168 <span class="comment"> */</span>
<a name="l02169"></a><a class="code" href="chan__iax2_8c.html#a75b0aafb3f20205a7b17c7fbd85e4e44">02169</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a75b0aafb3f20205a7b17c7fbd85e4e44">peercnt_add</a>(<span class="keyword">struct</span> sockaddr_in *sin)
<a name="l02170"></a>02170 {
<a name="l02171"></a>02171    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>;
<a name="l02172"></a>02172    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a> = sin-&gt;sin_addr.s_addr;
<a name="l02173"></a>02173    <span class="keywordtype">int</span> res = 0;
<a name="l02174"></a>02174    <span class="keyword">struct </span>peercnt tmp = {
<a name="l02175"></a>02175       .<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a> = addr,
<a name="l02176"></a>02176    };
<a name="l02177"></a>02177 
<a name="l02178"></a>02178    <span class="comment">/* Reasoning for peercnts container lock:  Two identical ip addresses</span>
<a name="l02179"></a>02179 <span class="comment">    * could be added by different threads at the &quot;same time&quot;. Without the container</span>
<a name="l02180"></a>02180 <span class="comment">    * lock, both threads could alloc space for the same object and attempt</span>
<a name="l02181"></a>02181 <span class="comment">    * to link to table.  With the lock, one would create the object and link</span>
<a name="l02182"></a>02182 <span class="comment">    * to table while the other would find the already created peercnt object</span>
<a name="l02183"></a>02183 <span class="comment">    * rather than creating a new one. */</span>
<a name="l02184"></a>02184    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(peercnts);
<a name="l02185"></a>02185    <span class="keywordflow">if</span> ((peercnt = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peercnts, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02186"></a>02186       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(peercnt);
<a name="l02187"></a>02187    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((peercnt = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*peercnt), NULL))) {
<a name="l02188"></a>02188       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(peercnt);
<a name="l02189"></a>02189       <span class="comment">/* create and set defaults */</span>
<a name="l02190"></a>02190       peercnt-&gt;<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a> = addr;
<a name="l02191"></a>02191       <a class="code" href="chan__iax2_8c.html#a024ed5afd48b8a0b580d3e8fa4266478">set_peercnt_limit</a>(peercnt);
<a name="l02192"></a>02192       <span class="comment">/* guarantees it does not go away after unlocking table</span>
<a name="l02193"></a>02193 <span class="comment">       * ao2_find automatically adds this */</span>
<a name="l02194"></a>02194       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(peercnts, peercnt);
<a name="l02195"></a>02195    } <span class="keywordflow">else</span> {
<a name="l02196"></a>02196       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(peercnts);
<a name="l02197"></a>02197       <span class="keywordflow">return</span> -1;
<a name="l02198"></a>02198    }
<a name="l02199"></a>02199 
<a name="l02200"></a>02200    <span class="comment">/* check to see if the address has hit its callno limit.  If not increment cur. */</span>
<a name="l02201"></a>02201    <span class="keywordflow">if</span> (peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a> &gt; peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>) {
<a name="l02202"></a>02202       peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>++;
<a name="l02203"></a>02203       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ip callno count incremented to %d for %s\n&quot;</span>, peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l02204"></a>02204    } <span class="keywordflow">else</span> { <span class="comment">/* max num call numbers for this peer has been reached! */</span>
<a name="l02205"></a>02205       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;maxcallnumber limit of %d for %s has been reached!\n&quot;</span>, peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l02206"></a>02206       res = -1;
<a name="l02207"></a>02207    }
<a name="l02208"></a>02208 
<a name="l02209"></a>02209    <span class="comment">/* clean up locks and ref count */</span>
<a name="l02210"></a>02210    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(peercnt);
<a name="l02211"></a>02211    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(peercnts);
<a name="l02212"></a>02212    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnt, -1); <span class="comment">/* decrement ref from find/alloc, only the container ref remains. */</span>
<a name="l02213"></a>02213 
<a name="l02214"></a>02214    <span class="keywordflow">return</span> res;
<a name="l02215"></a>02215 }
<a name="l02216"></a>02216 <span class="comment"></span>
<a name="l02217"></a>02217 <span class="comment">/*! </span>
<a name="l02218"></a>02218 <span class="comment"> * \internal</span>
<a name="l02219"></a>02219 <span class="comment"> * \brief decrements a peercnts table entry</span>
<a name="l02220"></a>02220 <span class="comment"> */</span>
<a name="l02221"></a><a class="code" href="chan__iax2_8c.html#af8ad0fe167b5635e97c25790566e1752">02221</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#af8ad0fe167b5635e97c25790566e1752">peercnt_remove</a>(<span class="keyword">struct</span> <a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>)
<a name="l02222"></a>02222 {
<a name="l02223"></a>02223    <span class="keyword">struct </span>sockaddr_in sin = {
<a name="l02224"></a>02224       .sin_addr.s_addr = peercnt-&gt;<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a>,
<a name="l02225"></a>02225    };
<a name="l02226"></a>02226 
<a name="l02227"></a>02227    <span class="keywordflow">if</span> (peercnt) {
<a name="l02228"></a>02228       <span class="comment">/* Container locked here since peercnt may be unlinked from list.  If left unlocked,</span>
<a name="l02229"></a>02229 <span class="comment">       * peercnt_add could try and grab this entry from the table and modify it at the</span>
<a name="l02230"></a>02230 <span class="comment">       * &quot;same time&quot; this thread attemps to unlink it.*/</span>
<a name="l02231"></a>02231       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(peercnts);
<a name="l02232"></a>02232       peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>--;
<a name="l02233"></a>02233       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ip callno count decremented to %d for %s\n&quot;</span>, peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr));
<a name="l02234"></a>02234       <span class="comment">/* if this was the last connection from the peer remove it from table */</span>
<a name="l02235"></a>02235       <span class="keywordflow">if</span> (peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a> == 0) {
<a name="l02236"></a>02236          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(peercnts, peercnt);<span class="comment">/* decrements ref from table, last ref is left to scheduler */</span>
<a name="l02237"></a>02237       }
<a name="l02238"></a>02238       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(peercnts);
<a name="l02239"></a>02239    }
<a name="l02240"></a>02240 }
<a name="l02241"></a>02241 <span class="comment"></span>
<a name="l02242"></a>02242 <span class="comment">/*! </span>
<a name="l02243"></a>02243 <span class="comment"> * \internal</span>
<a name="l02244"></a>02244 <span class="comment"> * \brief called by scheduler to decrement object</span>
<a name="l02245"></a>02245 <span class="comment"> */</span>
<a name="l02246"></a><a class="code" href="chan__iax2_8c.html#a27bae050b070dfd6f43ef89a26673cca">02246</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a27bae050b070dfd6f43ef89a26673cca">peercnt_remove_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj)
<a name="l02247"></a>02247 {
<a name="l02248"></a>02248    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a> = (<span class="keyword">struct </span>peercnt *) obj;
<a name="l02249"></a>02249 
<a name="l02250"></a>02250    <a class="code" href="chan__iax2_8c.html#af8ad0fe167b5635e97c25790566e1752">peercnt_remove</a>(peercnt);
<a name="l02251"></a>02251    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnt, -1); <span class="comment">/* decrement ref from scheduler */</span>
<a name="l02252"></a>02252 
<a name="l02253"></a>02253    <span class="keywordflow">return</span> 0;
<a name="l02254"></a>02254 }
<a name="l02255"></a>02255 <span class="comment"></span>
<a name="l02256"></a>02256 <span class="comment">/*! </span>
<a name="l02257"></a>02257 <span class="comment"> * \internal</span>
<a name="l02258"></a>02258 <span class="comment"> * \brief decrements peercnts connection count, finds by addr</span>
<a name="l02259"></a>02259 <span class="comment"> */</span>
<a name="l02260"></a><a class="code" href="chan__iax2_8c.html#a0145ccaddcb1e5fb2ffd6696b0b679eb">02260</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0145ccaddcb1e5fb2ffd6696b0b679eb">peercnt_remove_by_addr</a>(<span class="keyword">struct</span> sockaddr_in *sin)
<a name="l02261"></a>02261 {
<a name="l02262"></a>02262    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>;
<a name="l02263"></a>02263    <span class="keyword">struct </span>peercnt tmp = {
<a name="l02264"></a>02264       .<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a> = sin-&gt;sin_addr.s_addr,
<a name="l02265"></a>02265    };
<a name="l02266"></a>02266 
<a name="l02267"></a>02267    <span class="keywordflow">if</span> ((peercnt = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peercnts, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02268"></a>02268       <a class="code" href="chan__iax2_8c.html#af8ad0fe167b5635e97c25790566e1752">peercnt_remove</a>(peercnt);
<a name="l02269"></a>02269       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnt, -1); <span class="comment">/* decrement ref from find */</span>
<a name="l02270"></a>02270    }
<a name="l02271"></a>02271    <span class="keywordflow">return</span> 0;
<a name="l02272"></a>02272 }
<a name="l02273"></a>02273 <span class="comment"></span>
<a name="l02274"></a>02274 <span class="comment">/*! </span>
<a name="l02275"></a>02275 <span class="comment"> * \internal</span>
<a name="l02276"></a>02276 <span class="comment"> * \brief Create callno_limit entry based on configuration</span>
<a name="l02277"></a>02277 <span class="comment"> */</span>
<a name="l02278"></a><a class="code" href="chan__iax2_8c.html#af00198db2d521d3eff42da6fb57cfe1b">02278</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#af00198db2d521d3eff42da6fb57cfe1b">build_callno_limits</a>(<span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v)
<a name="l02279"></a>02279 {
<a name="l02280"></a>02280    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *<a class="code" href="structaddr__range.html">addr_range</a> = NULL;
<a name="l02281"></a>02281    <span class="keyword">struct </span>addr_range tmp;
<a name="l02282"></a>02282    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> *ha;
<a name="l02283"></a>02283    <span class="keywordtype">int</span> limit;
<a name="l02284"></a>02284    <span class="keywordtype">int</span> error;
<a name="l02285"></a>02285    <span class="keywordtype">int</span> found;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287    <span class="keywordflow">for</span> (; v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02288"></a>02288       limit = -1;
<a name="l02289"></a>02289       error = 0;
<a name="l02290"></a>02290       found = 0;
<a name="l02291"></a>02291       ha = <a class="code" href="acl_8h.html#ae839a9c2465be4e9a560dda668a65b9b" title="Append ACL entry to host access list.">ast_append_ha</a>(<span class="stringliteral">&quot;permit&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, NULL, &amp;error);
<a name="l02292"></a>02292 
<a name="l02293"></a>02293       <span class="comment">/* check for valid config information */</span>
<a name="l02294"></a>02294       <span class="keywordflow">if</span> (error) {
<a name="l02295"></a>02295          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Call number limit for %s could not be added, Invalid address range\n.&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l02296"></a>02296          <span class="keywordflow">continue</span>;
<a name="l02297"></a>02297       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%d&quot;</span>, &amp;limit) != 1) || (limit &lt; 0)) {
<a name="l02298"></a>02298          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Call number limit for %s could not be added. Invalid limit %s\n.&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02299"></a>02299          <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(ha);
<a name="l02300"></a>02300          <span class="keywordflow">continue</span>;
<a name="l02301"></a>02301       }
<a name="l02302"></a>02302 
<a name="l02303"></a>02303       <a class="code" href="acl_8h.html#a61f6f79316a8f64be7bdac1a41183047" title="Copy ha structure.">ast_copy_ha</a>(ha, &amp;tmp.<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>);
<a name="l02304"></a>02304       <span class="comment">/* find or create the addr_range */</span>
<a name="l02305"></a>02305       <span class="keywordflow">if</span> ((addr_range = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(callno_limits, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02306"></a>02306          <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(addr_range);
<a name="l02307"></a>02307          found = 1;
<a name="l02308"></a>02308       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(addr_range = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*addr_range), NULL))) {
<a name="l02309"></a>02309          <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(ha);
<a name="l02310"></a>02310          <span class="keywordflow">return</span>; <span class="comment">/* out of memory */</span>
<a name="l02311"></a>02311       }
<a name="l02312"></a>02312 
<a name="l02313"></a>02313       <span class="comment">/* copy over config data into addr_range object */</span>
<a name="l02314"></a>02314       <a class="code" href="acl_8h.html#a61f6f79316a8f64be7bdac1a41183047" title="Copy ha structure.">ast_copy_ha</a>(ha, &amp;addr_range-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>); <span class="comment">/* this is safe because only one ha is possible for each limit */</span>
<a name="l02315"></a>02315       <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(ha); <span class="comment">/* cleanup the tmp ha */</span>
<a name="l02316"></a>02316       addr_range-&gt;<a class="code" href="structaddr__range.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a> = limit;
<a name="l02317"></a>02317       addr_range-&gt;<a class="code" href="structaddr__range.html#aaf5ee49ffd469534bb3c2e3bf68dc510">delme</a> = 0;
<a name="l02318"></a>02318 
<a name="l02319"></a>02319       <span class="comment">/* cleanup */</span>
<a name="l02320"></a>02320       <span class="keywordflow">if</span> (found) {
<a name="l02321"></a>02321          <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(addr_range);
<a name="l02322"></a>02322       } <span class="keywordflow">else</span> {
<a name="l02323"></a>02323          <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(callno_limits, addr_range);
<a name="l02324"></a>02324       }
<a name="l02325"></a>02325       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(addr_range, -1); <span class="comment">/* decrement ref from ao2_find and ao2_alloc, only container ref remains */</span>
<a name="l02326"></a>02326    }
<a name="l02327"></a>02327 }
<a name="l02328"></a>02328 <span class="comment"></span>
<a name="l02329"></a>02329 <span class="comment">/*! </span>
<a name="l02330"></a>02330 <span class="comment"> * \internal</span>
<a name="l02331"></a>02331 <span class="comment"> * \brief Create calltoken_ignores entry based on configuration</span>
<a name="l02332"></a>02332 <span class="comment"> */</span>
<a name="l02333"></a><a class="code" href="chan__iax2_8c.html#a5b5143ac7f3977bd944fdcdd1589c372">02333</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5b5143ac7f3977bd944fdcdd1589c372">add_calltoken_ignore</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>)
<a name="l02334"></a>02334 {
<a name="l02335"></a>02335    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> tmp;
<a name="l02336"></a>02336    <span class="keyword">struct </span><a class="code" href="structaddr__range.html">addr_range</a> *<a class="code" href="structaddr__range.html">addr_range</a> = NULL;
<a name="l02337"></a>02337    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> *ha = NULL;
<a name="l02338"></a>02338    <span class="keywordtype">int</span> error = 0;
<a name="l02339"></a>02339 
<a name="l02340"></a>02340    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(addr)) {
<a name="l02341"></a>02341       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;invalid calltokenoptional %s\n&quot;</span>, addr);
<a name="l02342"></a>02342       <span class="keywordflow">return</span> -1;
<a name="l02343"></a>02343    }
<a name="l02344"></a>02344 
<a name="l02345"></a>02345    ha = <a class="code" href="acl_8h.html#ae839a9c2465be4e9a560dda668a65b9b" title="Append ACL entry to host access list.">ast_append_ha</a>(<span class="stringliteral">&quot;permit&quot;</span>, addr, NULL, &amp;error);
<a name="l02346"></a>02346 
<a name="l02347"></a>02347    <span class="comment">/* check for valid config information */</span>
<a name="l02348"></a>02348    <span class="keywordflow">if</span> (error) {
<a name="l02349"></a>02349       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error %d creating calltokenoptional entry %s\n&quot;</span>, error, addr);
<a name="l02350"></a>02350       <span class="keywordflow">return</span> -1;
<a name="l02351"></a>02351    }
<a name="l02352"></a>02352 
<a name="l02353"></a>02353    <a class="code" href="acl_8h.html#a61f6f79316a8f64be7bdac1a41183047" title="Copy ha structure.">ast_copy_ha</a>(ha, &amp;tmp.<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>);
<a name="l02354"></a>02354    <span class="comment">/* find or create the addr_range */</span>
<a name="l02355"></a>02355    <span class="keywordflow">if</span> ((addr_range = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(calltoken_ignores, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02356"></a>02356       <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(addr_range);
<a name="l02357"></a>02357       addr_range-&gt;<a class="code" href="structaddr__range.html#aaf5ee49ffd469534bb3c2e3bf68dc510">delme</a> = 0;
<a name="l02358"></a>02358       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(addr_range);
<a name="l02359"></a>02359    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((addr_range = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*addr_range), NULL))) {
<a name="l02360"></a>02360       <span class="comment">/* copy over config data into addr_range object */</span>
<a name="l02361"></a>02361       <a class="code" href="acl_8h.html#a61f6f79316a8f64be7bdac1a41183047" title="Copy ha structure.">ast_copy_ha</a>(ha, &amp;addr_range-&gt;<a class="code" href="structaddr__range.html#a9b57ac8e643491fac4fbf3b29a5c2a51">ha</a>); <span class="comment">/* this is safe because only one ha is possible */</span>
<a name="l02362"></a>02362       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(calltoken_ignores, addr_range);
<a name="l02363"></a>02363    } <span class="keywordflow">else</span> {
<a name="l02364"></a>02364       <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(ha);
<a name="l02365"></a>02365       <span class="keywordflow">return</span> -1;
<a name="l02366"></a>02366    }
<a name="l02367"></a>02367 
<a name="l02368"></a>02368    <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(ha);
<a name="l02369"></a>02369    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(addr_range, -1); <span class="comment">/* decrement ref from ao2_find and ao2_alloc, only container ref remains */</span>
<a name="l02370"></a>02370 
<a name="l02371"></a>02371    <span class="keywordflow">return</span> 0;
<a name="l02372"></a>02372 }
<a name="l02373"></a>02373 
<a name="l02374"></a><a class="code" href="chan__iax2_8c.html#ad6389d247beb77ba3d24be09af407161">02374</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#ad6389d247beb77ba3d24be09af407161">handle_cli_iax2_show_callno_limits</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02375"></a>02375 {
<a name="l02376"></a>02376    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l02377"></a>02377    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>;
<a name="l02378"></a>02378    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l02379"></a>02379    <span class="keywordtype">int</span> found = 0;
<a name="l02380"></a>02380 
<a name="l02381"></a>02381    <span class="keywordflow">switch</span> (cmd) {
<a name="l02382"></a>02382    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02383"></a>02383       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show callnumber usage&quot;</span>;
<a name="l02384"></a>02384       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02385"></a>02385          <span class="stringliteral">&quot;Usage: iax2 show callnumber usage &lt;ip address (optional)&gt;\n&quot;</span>
<a name="l02386"></a>02386          <span class="stringliteral">&quot;       Shows current ip addresses which are consuming iax2 call numbers\n&quot;</span>;
<a name="l02387"></a>02387       <span class="keywordflow">return</span> NULL;
<a name="l02388"></a>02388    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02389"></a>02389       <span class="keywordflow">return</span> NULL;
<a name="l02390"></a>02390    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea2e4a68503bbadbeacf842a24c7d7f2df">CLI_HANDLER</a>:
<a name="l02391"></a>02391       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 5)
<a name="l02392"></a>02392          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l02393"></a>02393 
<a name="l02394"></a>02394       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-15s %-12s %-12s\n&quot;</span>, <span class="stringliteral">&quot;Address&quot;</span>, <span class="stringliteral">&quot;Callno Usage&quot;</span>, <span class="stringliteral">&quot;Callno Limit&quot;</span>);
<a name="l02395"></a>02395       i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peercnts, 0);
<a name="l02396"></a>02396       <span class="keywordflow">while</span> ((peercnt = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l02397"></a>02397          sin.sin_addr.s_addr = peercnt-&gt;<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a>;
<a name="l02398"></a>02398          <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5 &amp;&amp; (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr)))) {
<a name="l02399"></a>02399                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-15s %-12d %-12d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>, peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>);
<a name="l02400"></a>02400                found = 1;
<a name="l02401"></a>02401                <span class="keywordflow">break</span>;
<a name="l02402"></a>02402          } <span class="keywordflow">else</span> {
<a name="l02403"></a>02403             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-15s %-12d %-12d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), peercnt-&gt;<a class="code" href="structpeercnt.html#aee7e8f6f5f1a4b5b402473cf99d3042a">cur</a>, peercnt-&gt;<a class="code" href="structpeercnt.html#ab28e82ae69032cb4ad3ec3a0be3d7129">limit</a>);
<a name="l02404"></a>02404          }
<a name="l02405"></a>02405          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnt, -1);
<a name="l02406"></a>02406       }
<a name="l02407"></a>02407       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l02408"></a>02408 
<a name="l02409"></a>02409       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4) {
<a name="l02410"></a>02410          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\nNon-CallToken Validation Limit: %d\nNon-CallToken Validated: %d\n&quot;</span>, global_maxcallno_nonval, total_nonval_callno_used);
<a name="l02411"></a>02411       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5 &amp;&amp; !found) {
<a name="l02412"></a>02412          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No callnumber table entries for %s found\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4] );
<a name="l02413"></a>02413       }
<a name="l02414"></a>02414 
<a name="l02415"></a>02415       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02416"></a>02416    <span class="keywordflow">default</span>:
<a name="l02417"></a>02417       <span class="keywordflow">return</span> NULL;
<a name="l02418"></a>02418    }
<a name="l02419"></a>02419 }
<a name="l02420"></a>02420 
<a name="l02421"></a><a class="code" href="chan__iax2_8c.html#a6eb424bb73908133f54e5839926e6a50">02421</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="chan__iax2_8c.html#a6eb424bb73908133f54e5839926e6a50">get_unused_callno</a>(<span class="keywordtype">int</span> trunk, <span class="keywordtype">int</span> <a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">validated</a>)
<a name="l02422"></a>02422 {
<a name="l02423"></a>02423    <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a> = NULL;
<a name="l02424"></a>02424    <span class="keywordflow">if</span> ((!<a class="code" href="astobj2_8h.html#a512cc40ce96c63b3d5c78040baa4c9cd" title="Returns the number of elements in a container.">ao2_container_count</a>(callno_pool) &amp;&amp; !trunk) || (!<a class="code" href="astobj2_8h.html#a512cc40ce96c63b3d5c78040baa4c9cd" title="Returns the number of elements in a container.">ao2_container_count</a>(callno_pool_trunk) &amp;&amp; trunk)) {
<a name="l02425"></a>02425       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of CallNumbers\n&quot;</span>);
<a name="l02426"></a>02426       <span class="comment">/* Minor optimization for the extreme case. */</span>
<a name="l02427"></a>02427       <span class="keywordflow">return</span> NULL;
<a name="l02428"></a>02428    }
<a name="l02429"></a>02429 
<a name="l02430"></a>02430    <span class="comment">/* the callno_pool container is locked here primarily to ensure thread</span>
<a name="l02431"></a>02431 <span class="comment">    * safety of the total_nonval_callno_used check and increment */</span>
<a name="l02432"></a>02432    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(callno_pool);
<a name="l02433"></a>02433 
<a name="l02434"></a>02434    <span class="comment">/* only a certain number of nonvalidated call numbers should be allocated.</span>
<a name="l02435"></a>02435 <span class="comment">    * If there ever is an attack, this separates the calltoken validating</span>
<a name="l02436"></a>02436 <span class="comment">    * users from the non calltoken validating users. */</span>
<a name="l02437"></a>02437    <span class="keywordflow">if</span> (!validated &amp;&amp; (total_nonval_callno_used &gt;= global_maxcallno_nonval)) {
<a name="l02438"></a>02438       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;NON-CallToken callnumber limit is reached. Current:%d Max:%d\n&quot;</span>, total_nonval_callno_used, global_maxcallno_nonval);
<a name="l02439"></a>02439       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(callno_pool);
<a name="l02440"></a>02440       <span class="keywordflow">return</span> NULL;
<a name="l02441"></a>02441    }
<a name="l02442"></a>02442 
<a name="l02443"></a>02443    <span class="comment">/* unlink the object from the container, taking over ownership</span>
<a name="l02444"></a>02444 <span class="comment">    * of the reference the container had to the object */</span>
<a name="l02445"></a>02445    callno_entry = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>((trunk ? callno_pool_trunk : callno_pool), NULL, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca94dc57035c55d676cdbf9762c582b8aa" title="Continue if a match is not found in the hashed out bucket.">OBJ_CONTINUE</a>);
<a name="l02446"></a>02446 
<a name="l02447"></a>02447    <span class="keywordflow">if</span> (callno_entry) {
<a name="l02448"></a>02448       callno_entry-&gt;<a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">validated</a> = validated;
<a name="l02449"></a>02449       <span class="keywordflow">if</span> (!validated) {
<a name="l02450"></a>02450          total_nonval_callno_used++;
<a name="l02451"></a>02451       }
<a name="l02452"></a>02452    }
<a name="l02453"></a>02453 
<a name="l02454"></a>02454    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(callno_pool);
<a name="l02455"></a>02455    <span class="keywordflow">return</span> callno_entry;
<a name="l02456"></a>02456 }
<a name="l02457"></a>02457 
<a name="l02458"></a><a class="code" href="chan__iax2_8c.html#a17a9399beec50b63e368c36d7c0d872d">02458</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a17a9399beec50b63e368c36d7c0d872d">replace_callno</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj)
<a name="l02459"></a>02459 {
<a name="l02460"></a>02460    <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a> = (<span class="keyword">struct </span>callno_entry *) obj;
<a name="l02461"></a>02461 
<a name="l02462"></a>02462    <span class="comment">/* the callno_pool container is locked here primarily to ensure thread</span>
<a name="l02463"></a>02463 <span class="comment">    * safety of the total_nonval_callno_used check and decrement */</span>
<a name="l02464"></a>02464    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(callno_pool);
<a name="l02465"></a>02465 
<a name="l02466"></a>02466    <span class="keywordflow">if</span> (!callno_entry-&gt;<a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">validated</a> &amp;&amp; (total_nonval_callno_used != 0)) {
<a name="l02467"></a>02467       total_nonval_callno_used--;
<a name="l02468"></a>02468    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!callno_entry-&gt;<a class="code" href="structcallno__entry.html#a7c14373c227cdc20005d5e1d10fe5895">validated</a> &amp;&amp; (total_nonval_callno_used == 0)) {
<a name="l02469"></a>02469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Attempted to decrement total non calltoken validated callnumbers below zero... Callno is:%d \n&quot;</span>, callno_entry-&gt;<a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>);
<a name="l02470"></a>02470    }
<a name="l02471"></a>02471 
<a name="l02472"></a>02472    <span class="keywordflow">if</span> (callno_entry-&gt;<a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a> &lt; <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>) {
<a name="l02473"></a>02473       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(callno_pool, callno_entry);
<a name="l02474"></a>02474    } <span class="keywordflow">else</span> {
<a name="l02475"></a>02475       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(callno_pool_trunk, callno_entry);
<a name="l02476"></a>02476    }
<a name="l02477"></a>02477    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_entry, -1); <span class="comment">/* only container ref remains */</span>
<a name="l02478"></a>02478 
<a name="l02479"></a>02479    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(callno_pool);
<a name="l02480"></a>02480    <span class="keywordflow">return</span> 0;
<a name="l02481"></a>02481 }
<a name="l02482"></a>02482 
<a name="l02483"></a><a class="code" href="chan__iax2_8c.html#abf8df71ecba9a435700911b2167d7502">02483</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#abf8df71ecba9a435700911b2167d7502">callno_hash</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l02484"></a>02484 {
<a name="l02485"></a>02485    <span class="keywordflow">return</span> abs(<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l02486"></a>02486 }
<a name="l02487"></a>02487 
<a name="l02488"></a><a class="code" href="chan__iax2_8c.html#a8457400e03924a8e80ee16b943b44cfb">02488</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a8457400e03924a8e80ee16b943b44cfb">create_callno_pools</a>(<span class="keywordtype">void</span>)
<a name="l02489"></a>02489 {
<a name="l02490"></a>02490    uint16_t i;
<a name="l02491"></a>02491 
<a name="l02492"></a>02492    <span class="keywordflow">if</span> (!(callno_pool = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(CALLNO_POOL_BUCKETS, <a class="code" href="chan__iax2_8c.html#abf8df71ecba9a435700911b2167d7502">callno_hash</a>, NULL))) {
<a name="l02493"></a>02493       <span class="keywordflow">return</span> -1;
<a name="l02494"></a>02494    }
<a name="l02495"></a>02495 
<a name="l02496"></a>02496    <span class="keywordflow">if</span> (!(callno_pool_trunk = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(CALLNO_POOL_BUCKETS, <a class="code" href="chan__iax2_8c.html#abf8df71ecba9a435700911b2167d7502">callno_hash</a>, NULL))) {
<a name="l02497"></a>02497       <span class="keywordflow">return</span> -1;
<a name="l02498"></a>02498    }
<a name="l02499"></a>02499 
<a name="l02500"></a>02500    <span class="comment">/* start at 2, 0 and 1 are reserved */</span>
<a name="l02501"></a>02501    <span class="keywordflow">for</span> (i = 2; i &lt;= <a class="code" href="iax2_8h.html#ae9b21f0bc9515b8e4d605437993b5b5f">IAX_MAX_CALLS</a>; i++) {
<a name="l02502"></a>02502       <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a>;
<a name="l02503"></a>02503 
<a name="l02504"></a>02504       <span class="keywordflow">if</span> (!(callno_entry = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*callno_entry), NULL))) {
<a name="l02505"></a>02505          <span class="keywordflow">return</span> -1;
<a name="l02506"></a>02506       }
<a name="l02507"></a>02507 
<a name="l02508"></a>02508       callno_entry-&gt;<a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a> = i;
<a name="l02509"></a>02509 
<a name="l02510"></a>02510       <span class="keywordflow">if</span> (i &lt; <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>) {
<a name="l02511"></a>02511          <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(callno_pool, callno_entry);
<a name="l02512"></a>02512       } <span class="keywordflow">else</span> {
<a name="l02513"></a>02513          <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(callno_pool_trunk, callno_entry);
<a name="l02514"></a>02514       }
<a name="l02515"></a>02515 
<a name="l02516"></a>02516       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_entry, -1);
<a name="l02517"></a>02517    }
<a name="l02518"></a>02518 
<a name="l02519"></a>02519    <span class="keywordflow">return</span> 0;
<a name="l02520"></a>02520 }
<a name="l02521"></a>02521 <span class="comment"></span>
<a name="l02522"></a>02522 <span class="comment">/*!</span>
<a name="l02523"></a>02523 <span class="comment"> * \internal</span>
<a name="l02524"></a>02524 <span class="comment"> * \brief Schedules delayed removal of iax2_pvt call number data</span>
<a name="l02525"></a>02525 <span class="comment"> *</span>
<a name="l02526"></a>02526 <span class="comment"> * \note After MIN_REUSE_TIME has passed for a destroyed iax2_pvt, the callno is</span>
<a name="l02527"></a>02527 <span class="comment"> * avaliable again, and the address from the previous connection must be decremented</span>
<a name="l02528"></a>02528 <span class="comment"> * from the peercnts table.  This function schedules these operations to take place.</span>
<a name="l02529"></a>02529 <span class="comment"> */</span>
<a name="l02530"></a><a class="code" href="chan__iax2_8c.html#adbf5862b8a073aaa64ca049601eef7ec">02530</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#adbf5862b8a073aaa64ca049601eef7ec">sched_delay_remove</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a>)
<a name="l02531"></a>02531 {
<a name="l02532"></a>02532    <span class="keywordtype">int</span> i;
<a name="l02533"></a>02533    <span class="keyword">struct </span><a class="code" href="structpeercnt.html">peercnt</a> *<a class="code" href="structpeercnt.html">peercnt</a>;
<a name="l02534"></a>02534    <span class="keyword">struct </span>peercnt tmp = {
<a name="l02535"></a>02535       .<a class="code" href="structpeercnt.html#afde02ab53128286716345a7e3da30a7e">addr</a> = sin-&gt;sin_addr.s_addr,
<a name="l02536"></a>02536    };
<a name="l02537"></a>02537 
<a name="l02538"></a>02538    <span class="keywordflow">if</span> ((peercnt = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peercnts, &amp;tmp, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02539"></a>02539       <span class="comment">/* refcount is incremented with ao2_find.  keep that ref for the scheduler */</span>
<a name="l02540"></a>02540       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;schedule decrement of callno used for %s in %d seconds\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <a class="code" href="chan__iax2_8c.html#acf1617df6e6203c6c0d87b5ff53e61dc">MIN_REUSE_TIME</a>);
<a name="l02541"></a>02541       i = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, <a class="code" href="chan__iax2_8c.html#acf1617df6e6203c6c0d87b5ff53e61dc">MIN_REUSE_TIME</a> * 1000, <a class="code" href="chan__iax2_8c.html#a27bae050b070dfd6f43ef89a26673cca">peercnt_remove_cb</a>, peercnt);
<a name="l02542"></a>02542       <span class="keywordflow">if</span> (i == -1) {
<a name="l02543"></a>02543          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnt, -1);
<a name="l02544"></a>02544       }
<a name="l02545"></a>02545    }
<a name="l02546"></a>02546 
<a name="l02547"></a>02547    <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, <a class="code" href="chan__iax2_8c.html#acf1617df6e6203c6c0d87b5ff53e61dc">MIN_REUSE_TIME</a> * 1000, <a class="code" href="chan__iax2_8c.html#a17a9399beec50b63e368c36d7c0d872d">replace_callno</a>, callno_entry);
<a name="l02548"></a>02548 }
<a name="l02549"></a>02549 <span class="comment"></span>
<a name="l02550"></a>02550 <span class="comment">/*! </span>
<a name="l02551"></a>02551 <span class="comment"> * \internal</span>
<a name="l02552"></a>02552 <span class="comment"> * \brief returns whether or not a frame is capable of starting a new IAX2 dialog. </span>
<a name="l02553"></a>02553 <span class="comment"> *</span>
<a name="l02554"></a>02554 <span class="comment"> * \note For this implementation, inbound pokes should _NOT_ be capable of allocating</span>
<a name="l02555"></a>02555 <span class="comment"> * a new callno.</span>
<a name="l02556"></a>02556 <span class="comment"> */</span>
<a name="l02557"></a><a class="code" href="chan__iax2_8c.html#aa4d98b10bfe71c49427a18a57b889506">02557</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="compiler_8h.html#a74d759b292a027618339fab3574b9175">attribute_pure</a> <a class="code" href="chan__iax2_8c.html#aa4d98b10bfe71c49427a18a57b889506">iax2_allow_new</a>(<span class="keywordtype">int</span> frametype, <span class="keywordtype">int</span> subclass, <span class="keywordtype">int</span> inbound)
<a name="l02558"></a>02558 {
<a name="l02559"></a>02559    <span class="keywordflow">if</span> (frametype != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) {
<a name="l02560"></a>02560       <span class="keywordflow">return</span> 0;
<a name="l02561"></a>02561    }
<a name="l02562"></a>02562    <span class="keywordflow">switch</span> (subclass) {
<a name="l02563"></a>02563    <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>:
<a name="l02564"></a>02564    <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effab17acacea946abf3ccde08f4f49fbfdb">IAX_COMMAND_REGREQ</a>:
<a name="l02565"></a>02565    <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa08fdcdfce4a4fa82cb861365beb5f9eb">IAX_COMMAND_FWDOWNL</a>:
<a name="l02566"></a>02566    <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9189574bea9c0b4772606120cd74718d">IAX_COMMAND_REGREL</a>:
<a name="l02567"></a>02567       <span class="keywordflow">return</span> 1;
<a name="l02568"></a>02568    <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effaa68c0d056acb361b1117cbad4121d418">IAX_COMMAND_POKE</a>:
<a name="l02569"></a>02569       <span class="keywordflow">if</span> (!inbound) {
<a name="l02570"></a>02570          <span class="keywordflow">return</span> 1;
<a name="l02571"></a>02571       }
<a name="l02572"></a>02572       <span class="keywordflow">break</span>;
<a name="l02573"></a>02573    }
<a name="l02574"></a>02574    <span class="keywordflow">return</span> 0;
<a name="l02575"></a>02575 }
<a name="l02576"></a>02576 
<a name="l02577"></a>02577 <span class="comment">/*</span>
<a name="l02578"></a>02578 <span class="comment"> * \note Calling this function while holding another pvt lock can cause a deadlock.</span>
<a name="l02579"></a>02579 <span class="comment"> */</span>
<a name="l02580"></a><a class="code" href="chan__iax2_8c.html#ac70b8f43ce5d040bed70e0c2a407bc05">02580</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac70b8f43ce5d040bed70e0c2a407bc05">__find_callno</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dcallno, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <span class="keyword">new</span>, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">int</span> return_locked, <span class="keywordtype">int</span> check_dcallno)
<a name="l02581"></a>02581 {
<a name="l02582"></a>02582    <span class="keywordtype">int</span> res = 0;
<a name="l02583"></a>02583    <span class="keywordtype">int</span> x;
<a name="l02584"></a>02584    <span class="comment">/* this call is calltoken validated as long as it is either NEW_FORCE</span>
<a name="l02585"></a>02585 <span class="comment">    * or NEW_ALLOW_CALLTOKEN_VALIDATED */</span>
<a name="l02586"></a>02586    <span class="keywordtype">int</span> validated = (<span class="keyword">new</span> &gt; <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a83c6eb629d0470b1897e3cdb23ee75f4">NEW_ALLOW</a>) ? 1 : 0;
<a name="l02587"></a>02587    <span class="keywordtype">char</span> host[80];
<a name="l02588"></a>02588 
<a name="l02589"></a>02589    <span class="keywordflow">if</span> (<span class="keyword">new</span> &lt;= <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a83c6eb629d0470b1897e3cdb23ee75f4">NEW_ALLOW</a>) {
<a name="l02590"></a>02590       <span class="keywordflow">if</span> (callno) {
<a name="l02591"></a>02591          <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt;
<a name="l02592"></a>02592          <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> tmp_pvt = {
<a name="l02593"></a>02593             .<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = dcallno,
<a name="l02594"></a>02594             .peercallno = callno,
<a name="l02595"></a>02595             .transfercallno = callno,
<a name="l02596"></a>02596             <span class="comment">/* hack!! */</span>
<a name="l02597"></a>02597             .frames_received = check_dcallno,
<a name="l02598"></a>02598          };
<a name="l02599"></a>02599 
<a name="l02600"></a>02600          memcpy(&amp;tmp_pvt.<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin, <span class="keyword">sizeof</span>(tmp_pvt.<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l02601"></a>02601          <span class="comment">/* this works for finding normal call numbers not involving transfering */</span> 
<a name="l02602"></a>02602          <span class="keywordflow">if</span> ((pvt = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>, &amp;tmp_pvt, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02603"></a>02603             <span class="keywordflow">if</span> (return_locked) {
<a name="l02604"></a>02604                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l02605"></a>02605             }
<a name="l02606"></a>02606             res = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l02607"></a>02607             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvt, -1);
<a name="l02608"></a>02608             pvt = NULL;
<a name="l02609"></a>02609             <span class="keywordflow">return</span> res;
<a name="l02610"></a>02610          }
<a name="l02611"></a>02611          <span class="comment">/* this searches for transfer call numbers that might not get caught otherwise */</span>
<a name="l02612"></a>02612          memset(&amp;tmp_pvt.<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, 0, <span class="keyword">sizeof</span>(tmp_pvt.<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l02613"></a>02613          memcpy(&amp;tmp_pvt.<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>, sin, <span class="keyword">sizeof</span>(tmp_pvt.<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>));
<a name="l02614"></a>02614          <span class="keywordflow">if</span> ((pvt = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>, &amp;tmp_pvt, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>))) {
<a name="l02615"></a>02615             <span class="keywordflow">if</span> (return_locked) {
<a name="l02616"></a>02616                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l02617"></a>02617             }
<a name="l02618"></a>02618             res = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l02619"></a>02619             <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvt, -1);
<a name="l02620"></a>02620             pvt = NULL;
<a name="l02621"></a>02621             <span class="keywordflow">return</span> res;
<a name="l02622"></a>02622          }
<a name="l02623"></a>02623       }
<a name="l02624"></a>02624          <span class="comment">/* This will occur on the first response to a message that we initiated,</span>
<a name="l02625"></a>02625 <span class="comment">       * such as a PING. */</span>
<a name="l02626"></a>02626       <span class="keywordflow">if</span> (dcallno) {
<a name="l02627"></a>02627          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[dcallno]);
<a name="l02628"></a>02628       }
<a name="l02629"></a>02629       <span class="keywordflow">if</span> (callno &amp;&amp; dcallno &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[dcallno] &amp;&amp; !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[dcallno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> &amp;&amp; <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>(sin, callno, dcallno, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[dcallno], check_dcallno)) {
<a name="l02630"></a>02630          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[dcallno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> = callno;
<a name="l02631"></a>02631          res = dcallno;
<a name="l02632"></a>02632          <a class="code" href="chan__iax2_8c.html#aa7e2b9897bb7bc4e4cb32cf763f37527">store_by_peercallno</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[dcallno]);
<a name="l02633"></a>02633          <span class="keywordflow">if</span> (!res || !return_locked) {
<a name="l02634"></a>02634             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[dcallno]);
<a name="l02635"></a>02635          }
<a name="l02636"></a>02636          <span class="keywordflow">return</span> res;
<a name="l02637"></a>02637       }
<a name="l02638"></a>02638       <span class="keywordflow">if</span> (dcallno) {
<a name="l02639"></a>02639          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[dcallno]);
<a name="l02640"></a>02640       }
<a name="l02641"></a>02641 <span class="preprocessor">#ifdef IAX_OLD_FIND</span>
<a name="l02642"></a>02642 <span class="preprocessor"></span>      <span class="comment">/* If we get here, we SHOULD NOT find a call structure for this</span>
<a name="l02643"></a>02643 <span class="comment">         callno; if we do, it means that there is a call structure that</span>
<a name="l02644"></a>02644 <span class="comment">         has a peer callno but did NOT get entered into the hash table,</span>
<a name="l02645"></a>02645 <span class="comment">         which is bad.</span>
<a name="l02646"></a>02646 <span class="comment"></span>
<a name="l02647"></a>02647 <span class="comment">         If we find a call structure using this old, slow method, output a log</span>
<a name="l02648"></a>02648 <span class="comment">         message so we&apos;ll know about it. After a few months of leaving this in</span>
<a name="l02649"></a>02649 <span class="comment">         place, if we don&apos;t hear about people seeing these messages, we can</span>
<a name="l02650"></a>02650 <span class="comment">         remove this code for good.</span>
<a name="l02651"></a>02651 <span class="comment">      */</span>
<a name="l02652"></a>02652 
<a name="l02653"></a>02653       <span class="keywordflow">for</span> (x = 1; !res &amp;&amp; x &lt; <a class="code" href="chan__iax2_8c.html#ab3fe1bdf89336ce3c36bb6bbc3d085ae">maxnontrunkcall</a>; x++) {
<a name="l02654"></a>02654          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02655"></a>02655          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l02656"></a>02656             <span class="comment">/* Look for an exact match */</span>
<a name="l02657"></a>02657             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>(sin, callno, dcallno, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], check_dcallno)) {
<a name="l02658"></a>02658                res = x;
<a name="l02659"></a>02659             }
<a name="l02660"></a>02660          }
<a name="l02661"></a>02661          <span class="keywordflow">if</span> (!res || !return_locked)
<a name="l02662"></a>02662             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02663"></a>02663       }
<a name="l02664"></a>02664       <span class="keywordflow">for</span> (x = <a class="code" href="chan__iax2_8c.html#a696a0cb5cfa928e3b3129e2a5eb390aa">TRUNK_CALL_START</a>; !res &amp;&amp; x &lt; <a class="code" href="chan__iax2_8c.html#a0adf1f10ece8bb420a7538be14aeeb8a">maxtrunkcall</a>; x++) {
<a name="l02665"></a>02665          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02666"></a>02666          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l02667"></a>02667             <span class="comment">/* Look for an exact match */</span>
<a name="l02668"></a>02668             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>(sin, callno, dcallno, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], check_dcallno)) {
<a name="l02669"></a>02669                res = x;
<a name="l02670"></a>02670             }
<a name="l02671"></a>02671          }
<a name="l02672"></a>02672          <span class="keywordflow">if</span> (!res || !return_locked)
<a name="l02673"></a>02673             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02674"></a>02674       }
<a name="l02675"></a>02675 <span class="preprocessor">#endif</span>
<a name="l02676"></a>02676 <span class="preprocessor"></span>   }
<a name="l02677"></a>02677    <span class="keywordflow">if</span> (!res &amp;&amp; (<span class="keyword">new</span> &gt;= <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a83c6eb629d0470b1897e3cdb23ee75f4">NEW_ALLOW</a>)) {
<a name="l02678"></a>02678       <span class="keyword">struct </span><a class="code" href="structcallno__entry.html">callno_entry</a> *<a class="code" href="structcallno__entry.html">callno_entry</a>;
<a name="l02679"></a>02679       <span class="comment">/* It may seem odd that we look through the peer list for a name for</span>
<a name="l02680"></a>02680 <span class="comment">       * this *incoming* call.  Well, it is weird.  However, users don&apos;t</span>
<a name="l02681"></a>02681 <span class="comment">       * have an IP address/port number that we can match against.  So,</span>
<a name="l02682"></a>02682 <span class="comment">       * this is just checking for a peer that has that IP/port and</span>
<a name="l02683"></a>02683 <span class="comment">       * assuming that we have a user of the same name.  This isn&apos;t always</span>
<a name="l02684"></a>02684 <span class="comment">       * correct, but it will be changed if needed after authentication. */</span>
<a name="l02685"></a>02685       <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a29430c5f2ce277cf96f3655b1705da36">iax2_getpeername</a>(*sin, host, <span class="keyword">sizeof</span>(host)))
<a name="l02686"></a>02686          snprintf(host, <span class="keyword">sizeof</span>(host), <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port));
<a name="l02687"></a>02687 
<a name="l02688"></a>02688       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a75b0aafb3f20205a7b17c7fbd85e4e44">peercnt_add</a>(sin)) {
<a name="l02689"></a>02689          <span class="comment">/* This address has hit its callnumber limit.  When the limit</span>
<a name="l02690"></a>02690 <span class="comment">          * is reached, the connection is not added to the peercnts table.*/</span>
<a name="l02691"></a>02691          <span class="keywordflow">return</span> 0;
<a name="l02692"></a>02692       }
<a name="l02693"></a>02693 
<a name="l02694"></a>02694       <span class="keywordflow">if</span> (!(callno_entry = <a class="code" href="chan__iax2_8c.html#a6eb424bb73908133f54e5839926e6a50">get_unused_callno</a>(0, validated))) {
<a name="l02695"></a>02695          <span class="comment">/* since we ran out of space, remove the peercnt</span>
<a name="l02696"></a>02696 <span class="comment">          * entry we added earlier */</span>
<a name="l02697"></a>02697          <a class="code" href="chan__iax2_8c.html#a0145ccaddcb1e5fb2ffd6696b0b679eb">peercnt_remove_by_addr</a>(sin);
<a name="l02698"></a>02698          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No more space\n&quot;</span>);
<a name="l02699"></a>02699          <span class="keywordflow">return</span> 0;
<a name="l02700"></a>02700       }
<a name="l02701"></a>02701       x = callno_entry-&gt;<a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>;
<a name="l02702"></a>02702       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02703"></a>02703 
<a name="l02704"></a>02704       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x] = <a class="code" href="chan__iax2_8c.html#ad12e31747e9dfa53efc09e11a8efc2a7">new_iax</a>(sin, host);
<a name="l02705"></a>02705       <a class="code" href="chan__iax2_8c.html#afd5c23cfc617fcaa37eb68fa5ef523ac">update_max_nontrunk</a>();
<a name="l02706"></a>02706       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l02707"></a>02707          <span class="keywordflow">if</span> (iaxdebug)
<a name="l02708"></a>02708             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Creating new call structure %d\n&quot;</span>, x);
<a name="l02709"></a>02709          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9511e23258e37ebfeadfdb80d55c10f9">callno_entry</a> = callno_entry;
<a name="l02710"></a>02710          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = sockfd;
<a name="l02711"></a>02711          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = sin-&gt;sin_port;
<a name="l02712"></a>02712          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_family = sin-&gt;sin_family;
<a name="l02713"></a>02713          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr = sin-&gt;sin_addr.s_addr;
<a name="l02714"></a>02714          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> = callno;
<a name="l02715"></a>02715          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = x;
<a name="l02716"></a>02716          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a> = <a class="code" href="chan__iax2_8c.html#aa3f7ad7d609f71fde68e79f9a7a478f2">DEFAULT_RETRY_TIME</a>;
<a name="l02717"></a>02717          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = min_reg_expire;
<a name="l02718"></a>02718          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a7969b7e7f7b78c64a9b546bc052aa437">pingid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, ping_time * 1000, <a class="code" href="chan__iax2_8c.html#a038a10c0c7963f6f551ec9e462391d92">send_ping</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)x);
<a name="l02719"></a>02719          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#aadb929953676f4a8f783f0c7f68d1b16">lagid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, lagrq_time * 1000, <a class="code" href="chan__iax2_8c.html#a9773a01290343052959786eb066fd067">send_lagrq</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)x);
<a name="l02720"></a>02720          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> = amaflags;
<a name="l02721"></a>02721          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], &amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>); 
<a name="l02722"></a>02722          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], accountcode, accountcode);
<a name="l02723"></a>02723          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], mohinterpret, mohinterpret);
<a name="l02724"></a>02724          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], mohsuggest, mohsuggest);
<a name="l02725"></a>02725          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>, default_parkinglot);
<a name="l02726"></a>02726 
<a name="l02727"></a>02727          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;peercallno) {
<a name="l02728"></a>02728             <a class="code" href="chan__iax2_8c.html#aa7e2b9897bb7bc4e4cb32cf763f37527">store_by_peercallno</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]);
<a name="l02729"></a>02729          }
<a name="l02730"></a>02730       } <span class="keywordflow">else</span> {
<a name="l02731"></a>02731          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of resources\n&quot;</span>);
<a name="l02732"></a>02732          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02733"></a>02733          <a class="code" href="chan__iax2_8c.html#a17a9399beec50b63e368c36d7c0d872d">replace_callno</a>(callno_entry);
<a name="l02734"></a>02734          <span class="keywordflow">return</span> 0;
<a name="l02735"></a>02735       }
<a name="l02736"></a>02736       <span class="keywordflow">if</span> (!return_locked)
<a name="l02737"></a>02737          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l02738"></a>02738       res = x;
<a name="l02739"></a>02739    }
<a name="l02740"></a>02740    <span class="keywordflow">return</span> res;
<a name="l02741"></a>02741 }
<a name="l02742"></a>02742 
<a name="l02743"></a><a class="code" href="chan__iax2_8c.html#a26cef2567af74205496ef576f775ef05">02743</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a26cef2567af74205496ef576f775ef05">find_callno</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dcallno, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <span class="keyword">new</span>, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">int</span> full_frame) {
<a name="l02744"></a>02744 
<a name="l02745"></a>02745    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#ac70b8f43ce5d040bed70e0c2a407bc05">__find_callno</a>(callno, dcallno, sin, <span class="keyword">new</span>, sockfd, 0, full_frame);
<a name="l02746"></a>02746 }
<a name="l02747"></a>02747 
<a name="l02748"></a><a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">02748</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">find_callno_locked</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dcallno, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <span class="keyword">new</span>, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">int</span> full_frame) {
<a name="l02749"></a>02749 
<a name="l02750"></a>02750    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#ac70b8f43ce5d040bed70e0c2a407bc05">__find_callno</a>(callno, dcallno, sin, <span class="keyword">new</span>, sockfd, 1, full_frame);
<a name="l02751"></a>02751 }
<a name="l02752"></a>02752 <span class="comment"></span>
<a name="l02753"></a>02753 <span class="comment">/*!</span>
<a name="l02754"></a>02754 <span class="comment"> * \brief Queue a frame to a call&apos;s owning asterisk channel</span>
<a name="l02755"></a>02755 <span class="comment"> *</span>
<a name="l02756"></a>02756 <span class="comment"> * \pre This function assumes that iaxsl[callno] is locked when called.</span>
<a name="l02757"></a>02757 <span class="comment"> *</span>
<a name="l02758"></a>02758 <span class="comment"> * \note IMPORTANT NOTE!!! Any time this function is used, even if iaxs[callno]</span>
<a name="l02759"></a>02759 <span class="comment"> * was valid before calling it, it may no longer be valid after calling it.</span>
<a name="l02760"></a>02760 <span class="comment"> * This function may unlock and lock the mutex associated with this callno,</span>
<a name="l02761"></a>02761 <span class="comment"> * meaning that another thread may grab it and destroy the call.</span>
<a name="l02762"></a>02762 <span class="comment"> */</span>
<a name="l02763"></a><a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f">02763</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f" title="Queue a frame to a call&amp;#39;s owning asterisk channel.">iax2_queue_frame</a>(<span class="keywordtype">int</span> <a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l02764"></a>02764 {
<a name="l02765"></a>02765    <span class="keywordflow">for</span> (;;) {
<a name="l02766"></a>02766       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner) {
<a name="l02767"></a>02767          <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner)) {
<a name="l02768"></a>02768             <span class="comment">/* Avoid deadlock by pausing and trying again */</span>
<a name="l02769"></a>02769             <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l02770"></a>02770          } <span class="keywordflow">else</span> {
<a name="l02771"></a>02771             <a class="code" href="channel_8h.html#a6cbcba5661d55216968cde8fdf913c89" title="Queue one or more frames to a channel&amp;#39;s frame queue.">ast_queue_frame</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner, f);
<a name="l02772"></a>02772             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner);
<a name="l02773"></a>02773             <span class="keywordflow">break</span>;
<a name="l02774"></a>02774          }
<a name="l02775"></a>02775       } <span class="keywordflow">else</span>
<a name="l02776"></a>02776          <span class="keywordflow">break</span>;
<a name="l02777"></a>02777    }
<a name="l02778"></a>02778    <span class="keywordflow">return</span> 0;
<a name="l02779"></a>02779 }
<a name="l02780"></a>02780 <span class="comment"></span>
<a name="l02781"></a>02781 <span class="comment">/*!</span>
<a name="l02782"></a>02782 <span class="comment"> * \brief Queue a hangup frame on the ast_channel owner</span>
<a name="l02783"></a>02783 <span class="comment"> *</span>
<a name="l02784"></a>02784 <span class="comment"> * This function queues a hangup frame on the owner of the IAX2 pvt struct that</span>
<a name="l02785"></a>02785 <span class="comment"> * is active for the given call number.</span>
<a name="l02786"></a>02786 <span class="comment"> *</span>
<a name="l02787"></a>02787 <span class="comment"> * \pre Assumes lock for callno is already held.</span>
<a name="l02788"></a>02788 <span class="comment"> *</span>
<a name="l02789"></a>02789 <span class="comment"> * \note IMPORTANT NOTE!!! Any time this function is used, even if iaxs[callno]</span>
<a name="l02790"></a>02790 <span class="comment"> * was valid before calling it, it may no longer be valid after calling it.</span>
<a name="l02791"></a>02791 <span class="comment"> * This function may unlock and lock the mutex associated with this callno,</span>
<a name="l02792"></a>02792 <span class="comment"> * meaning that another thread may grab it and destroy the call.</span>
<a name="l02793"></a>02793 <span class="comment"> */</span>
<a name="l02794"></a><a class="code" href="chan__iax2_8c.html#a269447f294bd20e46d4fe128756d4567">02794</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a269447f294bd20e46d4fe128756d4567" title="Queue a hangup frame on the ast_channel owner.">iax2_queue_hangup</a>(<span class="keywordtype">int</span> <a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>)
<a name="l02795"></a>02795 {
<a name="l02796"></a>02796    <span class="keywordflow">for</span> (;;) {
<a name="l02797"></a>02797       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner) {
<a name="l02798"></a>02798          <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner)) {
<a name="l02799"></a>02799             <span class="comment">/* Avoid deadlock by pausing and trying again */</span>
<a name="l02800"></a>02800             <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l02801"></a>02801          } <span class="keywordflow">else</span> {
<a name="l02802"></a>02802             <a class="code" href="channel_8h.html#a30bcf0418189567bc84ff32034f79f28" title="Queue a hangup frame.">ast_queue_hangup</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner);
<a name="l02803"></a>02803             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner);
<a name="l02804"></a>02804             <span class="keywordflow">break</span>;
<a name="l02805"></a>02805          }
<a name="l02806"></a>02806       } <span class="keywordflow">else</span>
<a name="l02807"></a>02807          <span class="keywordflow">break</span>;
<a name="l02808"></a>02808    }
<a name="l02809"></a>02809    <span class="keywordflow">return</span> 0;
<a name="l02810"></a>02810 }
<a name="l02811"></a>02811 <span class="comment"></span>
<a name="l02812"></a>02812 <span class="comment">/*!</span>
<a name="l02813"></a>02813 <span class="comment"> * \brief Queue a control frame on the ast_channel owner</span>
<a name="l02814"></a>02814 <span class="comment"> *</span>
<a name="l02815"></a>02815 <span class="comment"> * This function queues a control frame on the owner of the IAX2 pvt struct that</span>
<a name="l02816"></a>02816 <span class="comment"> * is active for the given call number.</span>
<a name="l02817"></a>02817 <span class="comment"> *</span>
<a name="l02818"></a>02818 <span class="comment"> * \pre Assumes lock for callno is already held.</span>
<a name="l02819"></a>02819 <span class="comment"> *</span>
<a name="l02820"></a>02820 <span class="comment"> * \note IMPORTANT NOTE!!! Any time this function is used, even if iaxs[callno]</span>
<a name="l02821"></a>02821 <span class="comment"> * was valid before calling it, it may no longer be valid after calling it.</span>
<a name="l02822"></a>02822 <span class="comment"> * This function may unlock and lock the mutex associated with this callno,</span>
<a name="l02823"></a>02823 <span class="comment"> * meaning that another thread may grab it and destroy the call.</span>
<a name="l02824"></a>02824 <span class="comment"> */</span>
<a name="l02825"></a><a class="code" href="chan__iax2_8c.html#ac2bc2f43e290218cfc5b2070decba686">02825</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac2bc2f43e290218cfc5b2070decba686" title="Queue a control frame on the ast_channel owner.">iax2_queue_control_data</a>(<span class="keywordtype">int</span> <a class="code" href="structcallno__entry.html#a44f6d66a211ce6f27bf3f79e0255ee91">callno</a>, 
<a name="l02826"></a>02826    <span class="keyword">enum</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390">ast_control_frame_type</a> control, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen)
<a name="l02827"></a>02827 {
<a name="l02828"></a>02828    <span class="keywordflow">for</span> (;;) {
<a name="l02829"></a>02829       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner) {
<a name="l02830"></a>02830          <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner)) {
<a name="l02831"></a>02831             <span class="comment">/* Avoid deadlock by pausing and trying again */</span>
<a name="l02832"></a>02832             <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l02833"></a>02833          } <span class="keywordflow">else</span> {
<a name="l02834"></a>02834             <a class="code" href="channel_8h.html#a7e5e15c22564fd66351d332ad10658b5" title="Queue a control frame with payload.">ast_queue_control_data</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner, control, data, datalen);
<a name="l02835"></a>02835             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner);
<a name="l02836"></a>02836             <span class="keywordflow">break</span>;
<a name="l02837"></a>02837          }
<a name="l02838"></a>02838       } <span class="keywordflow">else</span>
<a name="l02839"></a>02839          <span class="keywordflow">break</span>;
<a name="l02840"></a>02840    }
<a name="l02841"></a>02841    <span class="keywordflow">return</span> 0;
<a name="l02842"></a>02842 }
<a name="l02843"></a><a class="code" href="chan__iax2_8c.html#a7f26d7c2ba86173984ba4394958ed980">02843</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a7f26d7c2ba86173984ba4394958ed980">destroy_firmware</a>(<span class="keyword">struct</span> <a class="code" href="structiax__firmware.html">iax_firmware</a> *cur)
<a name="l02844"></a>02844 {
<a name="l02845"></a>02845    <span class="comment">/* Close firmware */</span>
<a name="l02846"></a>02846    <span class="keywordflow">if</span> (cur-&gt;fwh) {
<a name="l02847"></a>02847       munmap((<span class="keywordtype">void</span>*)cur-&gt;fwh, ntohl(cur-&gt;fwh-&gt;datalen) + <span class="keyword">sizeof</span>(*(cur-&gt;fwh)));
<a name="l02848"></a>02848    }
<a name="l02849"></a>02849    close(cur-&gt;fd);
<a name="l02850"></a>02850    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cur);
<a name="l02851"></a>02851 }
<a name="l02852"></a>02852 
<a name="l02853"></a><a class="code" href="chan__iax2_8c.html#a0562424363b5a6799038f064f7e8876c">02853</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0562424363b5a6799038f064f7e8876c">try_firmware</a>(<span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l02854"></a>02854 {
<a name="l02855"></a>02855    <span class="keyword">struct </span>stat stbuf;
<a name="l02856"></a>02856    <span class="keyword">struct </span><a class="code" href="structiax__firmware.html">iax_firmware</a> *cur = NULL;
<a name="l02857"></a>02857    <span class="keywordtype">int</span> ifd, fd, res, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, chunk;
<a name="l02858"></a>02858    <span class="keyword">struct </span><a class="code" href="structast__iax2__firmware__header.html">ast_iax2_firmware_header</a> *fwh, fwh2;
<a name="l02859"></a>02859    <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l02860"></a>02860    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> sum[16], <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[1024];
<a name="l02861"></a>02861    <span class="keywordtype">char</span> *s2, *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>;
<a name="l02862"></a>02862 
<a name="l02863"></a>02863    <span class="keywordflow">if</span> (!(s2 = alloca(strlen(s) + 100))) {
<a name="l02864"></a>02864       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Alloca failed!\n&quot;</span>);
<a name="l02865"></a>02865       <span class="keywordflow">return</span> -1;
<a name="l02866"></a>02866    }
<a name="l02867"></a>02867 
<a name="l02868"></a>02868    last = strrchr(s, <span class="charliteral">&apos;/&apos;</span>);
<a name="l02869"></a>02869    <span class="keywordflow">if</span> (last)
<a name="l02870"></a>02870       last++;
<a name="l02871"></a>02871    <span class="keywordflow">else</span>
<a name="l02872"></a>02872       last = s;
<a name="l02873"></a>02873 
<a name="l02874"></a>02874    snprintf(s2, strlen(s) + 100, <span class="stringliteral">&quot;/var/tmp/%s-%ld&quot;</span>, last, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>)<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l02875"></a>02875 
<a name="l02876"></a>02876    <span class="keywordflow">if</span> ((res = stat(s, &amp;stbuf) &lt; 0)) {
<a name="l02877"></a>02877       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to stat &apos;%s&apos;: %s\n&quot;</span>, s, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02878"></a>02878       <span class="keywordflow">return</span> -1;
<a name="l02879"></a>02879    }
<a name="l02880"></a>02880 
<a name="l02881"></a>02881    <span class="comment">/* Make sure it&apos;s not a directory */</span>
<a name="l02882"></a>02882    <span class="keywordflow">if</span> (S_ISDIR(stbuf.st_mode))
<a name="l02883"></a>02883       <span class="keywordflow">return</span> -1;
<a name="l02884"></a>02884    ifd = open(s, O_RDONLY);
<a name="l02885"></a>02885    <span class="keywordflow">if</span> (ifd &lt; 0) {
<a name="l02886"></a>02886       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open &apos;%s&apos;: %s\n&quot;</span>, s, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02887"></a>02887       <span class="keywordflow">return</span> -1;
<a name="l02888"></a>02888    }
<a name="l02889"></a>02889    fd = open(s2, O_RDWR | O_CREAT | O_EXCL, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);
<a name="l02890"></a>02890    <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l02891"></a>02891       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open &apos;%s&apos; for writing: %s\n&quot;</span>, s2, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02892"></a>02892       close(ifd);
<a name="l02893"></a>02893       <span class="keywordflow">return</span> -1;
<a name="l02894"></a>02894    }
<a name="l02895"></a>02895    <span class="comment">/* Unlink our newly created file */</span>
<a name="l02896"></a>02896    unlink(s2);
<a name="l02897"></a>02897    
<a name="l02898"></a>02898    <span class="comment">/* Now copy the firmware into it */</span>
<a name="l02899"></a>02899    len = stbuf.st_size;
<a name="l02900"></a>02900    <span class="keywordflow">while</span>(len) {
<a name="l02901"></a>02901       chunk = len;
<a name="l02902"></a>02902       <span class="keywordflow">if</span> (chunk &gt; <span class="keyword">sizeof</span>(buf))
<a name="l02903"></a>02903          chunk = <span class="keyword">sizeof</span>(buf);
<a name="l02904"></a>02904       res = read(ifd, buf, chunk);
<a name="l02905"></a>02905       <span class="keywordflow">if</span> (res != chunk) {
<a name="l02906"></a>02906          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only read %d of %d bytes of data :(: %s\n&quot;</span>, res, chunk, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02907"></a>02907          close(ifd);
<a name="l02908"></a>02908          close(fd);
<a name="l02909"></a>02909          <span class="keywordflow">return</span> -1;
<a name="l02910"></a>02910       }
<a name="l02911"></a>02911       res = write(fd, buf, chunk);
<a name="l02912"></a>02912       <span class="keywordflow">if</span> (res != chunk) {
<a name="l02913"></a>02913          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Only write %d of %d bytes of data :(: %s\n&quot;</span>, res, chunk, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02914"></a>02914          close(ifd);
<a name="l02915"></a>02915          close(fd);
<a name="l02916"></a>02916          <span class="keywordflow">return</span> -1;
<a name="l02917"></a>02917       }
<a name="l02918"></a>02918       len -= chunk;
<a name="l02919"></a>02919    }
<a name="l02920"></a>02920    close(ifd);
<a name="l02921"></a>02921    <span class="comment">/* Return to the beginning */</span>
<a name="l02922"></a>02922    lseek(fd, 0, SEEK_SET);
<a name="l02923"></a>02923    <span class="keywordflow">if</span> ((res = read(fd, &amp;fwh2, <span class="keyword">sizeof</span>(fwh2))) != <span class="keyword">sizeof</span>(fwh2)) {
<a name="l02924"></a>02924       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to read firmware header in &apos;%s&apos;\n&quot;</span>, s);
<a name="l02925"></a>02925       close(fd);
<a name="l02926"></a>02926       <span class="keywordflow">return</span> -1;
<a name="l02927"></a>02927    }
<a name="l02928"></a>02928    <span class="keywordflow">if</span> (ntohl(fwh2.<a class="code" href="structast__iax2__firmware__header.html#a7154179fe070a40c828f7c03f454d4d6">magic</a>) != <a class="code" href="iax2_8h.html#a5b65f73d7f449dd6c36f3ebd077e96c4">IAX_FIRMWARE_MAGIC</a>) {
<a name="l02929"></a>02929       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid firmware file\n&quot;</span>, s);
<a name="l02930"></a>02930       close(fd);
<a name="l02931"></a>02931       <span class="keywordflow">return</span> -1;
<a name="l02932"></a>02932    }
<a name="l02933"></a>02933    <span class="keywordflow">if</span> (ntohl(fwh2.<a class="code" href="structast__iax2__firmware__header.html#aa1717d6454f640fa1520a135ec92f4af">datalen</a>) != (stbuf.st_size - <span class="keyword">sizeof</span>(fwh2))) {
<a name="l02934"></a>02934       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid data length in firmware &apos;%s&apos;\n&quot;</span>, s);
<a name="l02935"></a>02935       close(fd);
<a name="l02936"></a>02936       <span class="keywordflow">return</span> -1;
<a name="l02937"></a>02937    }
<a name="l02938"></a>02938    <span class="keywordflow">if</span> (fwh2.<a class="code" href="structast__iax2__firmware__header.html#a56acb74d8f9dd26ec5551e4b15d7f559">devname</a>[<span class="keyword">sizeof</span>(fwh2.<a class="code" href="structast__iax2__firmware__header.html#a56acb74d8f9dd26ec5551e4b15d7f559">devname</a>) - 1] || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>((<span class="keywordtype">char</span> *)fwh2.<a class="code" href="structast__iax2__firmware__header.html#a56acb74d8f9dd26ec5551e4b15d7f559">devname</a>)) {
<a name="l02939"></a>02939       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No or invalid device type specified for &apos;%s&apos;\n&quot;</span>, s);
<a name="l02940"></a>02940       close(fd);
<a name="l02941"></a>02941       <span class="keywordflow">return</span> -1;
<a name="l02942"></a>02942    }
<a name="l02943"></a>02943    fwh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__firmware__header.html">ast_iax2_firmware_header</a>*)mmap(NULL, stbuf.st_size, PROT_READ, MAP_PRIVATE, fd, 0); 
<a name="l02944"></a>02944    <span class="keywordflow">if</span> (fwh == (<span class="keywordtype">void</span> *) -1) {
<a name="l02945"></a>02945       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;mmap failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02946"></a>02946       close(fd);
<a name="l02947"></a>02947       <span class="keywordflow">return</span> -1;
<a name="l02948"></a>02948    }
<a name="l02949"></a>02949    <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l02950"></a>02950    <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, fwh-&gt;<a class="code" href="structast__iax2__firmware__header.html#aef5b927d15f11382bf5f276630c08287">data</a>, ntohl(fwh-&gt;<a class="code" href="structast__iax2__firmware__header.html#aa1717d6454f640fa1520a135ec92f4af">datalen</a>));
<a name="l02951"></a>02951    <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(sum, &amp;md5);
<a name="l02952"></a>02952    <span class="keywordflow">if</span> (memcmp(sum, fwh-&gt;<a class="code" href="structast__iax2__firmware__header.html#aed93b4801b5b9244de00174771467172">chksum</a>, <span class="keyword">sizeof</span>(sum))) {
<a name="l02953"></a>02953       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Firmware file &apos;%s&apos; fails checksum\n&quot;</span>, s);
<a name="l02954"></a>02954       munmap((<span class="keywordtype">void</span>*)fwh, stbuf.st_size);
<a name="l02955"></a>02955       close(fd);
<a name="l02956"></a>02956       <span class="keywordflow">return</span> -1;
<a name="l02957"></a>02957    }
<a name="l02958"></a>02958 
<a name="l02959"></a>02959    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;firmwares, cur, list) {
<a name="l02960"></a>02960       <span class="keywordflow">if</span> (!strcmp((<span class="keywordtype">char</span> *)cur-&gt;fwh-&gt;devname, (<span class="keywordtype">char</span> *)fwh-&gt;<a class="code" href="structast__iax2__firmware__header.html#a56acb74d8f9dd26ec5551e4b15d7f559">devname</a>)) {
<a name="l02961"></a>02961          <span class="comment">/* Found a candidate */</span>
<a name="l02962"></a>02962          <span class="keywordflow">if</span> (cur-&gt;dead || (ntohs(cur-&gt;fwh-&gt;version) &lt; ntohs(fwh-&gt;<a class="code" href="structast__iax2__firmware__header.html#a48fa24b5d7723dfccbedd98b04a06d82">version</a>)))
<a name="l02963"></a>02963             <span class="comment">/* The version we have on loaded is older, load this one instead */</span>
<a name="l02964"></a>02964             <span class="keywordflow">break</span>;
<a name="l02965"></a>02965          <span class="comment">/* This version is no newer than what we have.  Don&apos;t worry about it.</span>
<a name="l02966"></a>02966 <span class="comment">            We&apos;ll consider it a proper load anyhow though */</span>
<a name="l02967"></a>02967          munmap((<span class="keywordtype">void</span>*)fwh, stbuf.st_size);
<a name="l02968"></a>02968          close(fd);
<a name="l02969"></a>02969          <span class="keywordflow">return</span> 0;
<a name="l02970"></a>02970       }
<a name="l02971"></a>02971    }
<a name="l02972"></a>02972    
<a name="l02973"></a>02973    <span class="keywordflow">if</span> (!cur &amp;&amp; ((cur = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*cur))))) {
<a name="l02974"></a>02974       cur-&gt;fd = -1;
<a name="l02975"></a>02975       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;firmwares, cur, list);
<a name="l02976"></a>02976    }
<a name="l02977"></a>02977    
<a name="l02978"></a>02978    <span class="keywordflow">if</span> (cur) {
<a name="l02979"></a>02979       <span class="keywordflow">if</span> (cur-&gt;fwh)
<a name="l02980"></a>02980          munmap((<span class="keywordtype">void</span>*)cur-&gt;fwh, cur-&gt;mmaplen);
<a name="l02981"></a>02981       <span class="keywordflow">if</span> (cur-&gt;fd &gt; -1)
<a name="l02982"></a>02982          close(cur-&gt;fd);
<a name="l02983"></a>02983       cur-&gt;fwh = fwh;
<a name="l02984"></a>02984       cur-&gt;fd = fd;
<a name="l02985"></a>02985       cur-&gt;mmaplen = stbuf.st_size;
<a name="l02986"></a>02986       cur-&gt;dead = 0;
<a name="l02987"></a>02987    }
<a name="l02988"></a>02988    
<a name="l02989"></a>02989    <span class="keywordflow">return</span> 0;
<a name="l02990"></a>02990 }
<a name="l02991"></a>02991 
<a name="l02992"></a><a class="code" href="chan__iax2_8c.html#a3ed1faf02222974de8507cb9536322a1">02992</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3ed1faf02222974de8507cb9536322a1">iax_check_version</a>(<span class="keywordtype">char</span> *dev)
<a name="l02993"></a>02993 {
<a name="l02994"></a>02994    <span class="keywordtype">int</span> res = 0;
<a name="l02995"></a>02995    <span class="keyword">struct </span><a class="code" href="structiax__firmware.html">iax_firmware</a> *cur = NULL;
<a name="l02996"></a>02996 
<a name="l02997"></a>02997    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(dev))
<a name="l02998"></a>02998       <span class="keywordflow">return</span> 0;
<a name="l02999"></a>02999 
<a name="l03000"></a>03000    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;firmwares);
<a name="l03001"></a>03001    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;firmwares, cur, list) {
<a name="l03002"></a>03002       <span class="keywordflow">if</span> (!strcmp(dev, (<span class="keywordtype">char</span> *)cur-&gt;fwh-&gt;devname)) {
<a name="l03003"></a>03003          res = ntohs(cur-&gt;fwh-&gt;version);
<a name="l03004"></a>03004          <span class="keywordflow">break</span>;
<a name="l03005"></a>03005       }
<a name="l03006"></a>03006    }
<a name="l03007"></a>03007    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;firmwares);
<a name="l03008"></a>03008 
<a name="l03009"></a>03009    <span class="keywordflow">return</span> res;
<a name="l03010"></a>03010 }
<a name="l03011"></a>03011 
<a name="l03012"></a><a class="code" href="chan__iax2_8c.html#a61dd76007fab611f813255f6032039ca">03012</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a61dd76007fab611f813255f6032039ca">iax_firmware_append</a>(<span class="keyword">struct</span> <a class="code" href="structiax__ie__data.html">iax_ie_data</a> *ied, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dev, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)
<a name="l03013"></a>03013 {
<a name="l03014"></a>03014    <span class="keywordtype">int</span> res = -1;
<a name="l03015"></a>03015    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bs = desc &amp; 0xff;
<a name="l03016"></a>03016    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> start = (desc &gt;&gt; 8) &amp; 0xffffff;
<a name="l03017"></a>03017    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> bytes;
<a name="l03018"></a>03018    <span class="keyword">struct </span><a class="code" href="structiax__firmware.html">iax_firmware</a> *cur;
<a name="l03019"></a>03019 
<a name="l03020"></a>03020    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>((<span class="keywordtype">char</span> *)dev) || !bs)
<a name="l03021"></a>03021       <span class="keywordflow">return</span> -1;
<a name="l03022"></a>03022 
<a name="l03023"></a>03023    start *= bs;
<a name="l03024"></a>03024    
<a name="l03025"></a>03025    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;firmwares);
<a name="l03026"></a>03026    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;firmwares, cur, list) {
<a name="l03027"></a>03027       <span class="keywordflow">if</span> (strcmp((<span class="keywordtype">char</span> *)dev, (<span class="keywordtype">char</span> *)cur-&gt;fwh-&gt;devname))
<a name="l03028"></a>03028          <span class="keywordflow">continue</span>;
<a name="l03029"></a>03029       <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(ied, <a class="code" href="iax2_8h.html#ae8bf4fc0764a2125546e77b9c0e5633a">IAX_IE_FWBLOCKDESC</a>, desc);
<a name="l03030"></a>03030       <span class="keywordflow">if</span> (start &lt; ntohl(cur-&gt;fwh-&gt;datalen)) {
<a name="l03031"></a>03031          bytes = ntohl(cur-&gt;fwh-&gt;datalen) - start;
<a name="l03032"></a>03032          <span class="keywordflow">if</span> (bytes &gt; bs)
<a name="l03033"></a>03033             bytes = bs;
<a name="l03034"></a>03034          <a class="code" href="iax2-parser_8c.html#aa54841eb569031c28321281dcd31e4f3">iax_ie_append_raw</a>(ied, <a class="code" href="iax2_8h.html#aa5bb34c412f90c90c90851f9b696ad88">IAX_IE_FWBLOCKDATA</a>, cur-&gt;fwh-&gt;data + start, bytes);
<a name="l03035"></a>03035       } <span class="keywordflow">else</span> {
<a name="l03036"></a>03036          bytes = 0;
<a name="l03037"></a>03037          <a class="code" href="iax2-parser_8c.html#a8cac52b8ffe1019fe3dbd5bb605994d1">iax_ie_append</a>(ied, <a class="code" href="iax2_8h.html#aa5bb34c412f90c90c90851f9b696ad88">IAX_IE_FWBLOCKDATA</a>);
<a name="l03038"></a>03038       }
<a name="l03039"></a>03039       <span class="keywordflow">if</span> (bytes == bs)
<a name="l03040"></a>03040          res = 0;
<a name="l03041"></a>03041       <span class="keywordflow">else</span>
<a name="l03042"></a>03042          res = 1;
<a name="l03043"></a>03043       <span class="keywordflow">break</span>;
<a name="l03044"></a>03044    }
<a name="l03045"></a>03045    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;firmwares);
<a name="l03046"></a>03046 
<a name="l03047"></a>03047    <span class="keywordflow">return</span> res;
<a name="l03048"></a>03048 }
<a name="l03049"></a>03049 
<a name="l03050"></a>03050 
<a name="l03051"></a><a class="code" href="chan__iax2_8c.html#a1474fd7c7eb179434b5be3102652a0f0">03051</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a1474fd7c7eb179434b5be3102652a0f0">reload_firmware</a>(<span class="keywordtype">int</span> unload)
<a name="l03052"></a>03052 {
<a name="l03053"></a>03053    <span class="keyword">struct </span><a class="code" href="structiax__firmware.html">iax_firmware</a> *cur = NULL;
<a name="l03054"></a>03054    DIR *fwd;
<a name="l03055"></a>03055    <span class="keyword">struct </span>dirent *de;
<a name="l03056"></a>03056    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>[256], fn[256];
<a name="l03057"></a>03057 
<a name="l03058"></a>03058    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;firmwares);
<a name="l03059"></a>03059 
<a name="l03060"></a>03060    <span class="comment">/* Mark all as dead */</span>
<a name="l03061"></a>03061    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;firmwares, cur, list)
<a name="l03062"></a>03062       cur-&gt;dead = 1;
<a name="l03063"></a>03063 
<a name="l03064"></a>03064    <span class="comment">/* Now that we have marked them dead... load new ones */</span>
<a name="l03065"></a>03065    <span class="keywordflow">if</span> (!unload) {
<a name="l03066"></a>03066       snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s/firmware/iax&quot;</span>, <a class="code" href="paths_8h.html#a63af4213b5b83f717398d8d62008a50d">ast_config_AST_DATA_DIR</a>);
<a name="l03067"></a>03067       fwd = opendir(dir);
<a name="l03068"></a>03068       <span class="keywordflow">if</span> (fwd) {
<a name="l03069"></a>03069          <span class="keywordflow">while</span>((de = readdir(fwd))) {
<a name="l03070"></a>03070             <span class="keywordflow">if</span> (de-&gt;d_name[0] != <span class="charliteral">&apos;.&apos;</span>) {
<a name="l03071"></a>03071                snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s/%s&quot;</span>, dir, de-&gt;d_name);
<a name="l03072"></a>03072                <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0562424363b5a6799038f064f7e8876c">try_firmware</a>(fn)) {
<a name="l03073"></a>03073                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Loaded firmware &apos;%s&apos;\n&quot;</span>, de-&gt;d_name);
<a name="l03074"></a>03074                }
<a name="l03075"></a>03075             }
<a name="l03076"></a>03076          }
<a name="l03077"></a>03077          closedir(fwd);
<a name="l03078"></a>03078       } <span class="keywordflow">else</span> 
<a name="l03079"></a>03079          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error opening firmware directory &apos;%s&apos;: %s\n&quot;</span>, dir, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03080"></a>03080    }
<a name="l03081"></a>03081 
<a name="l03082"></a>03082    <span class="comment">/* Clean up leftovers */</span>
<a name="l03083"></a>03083    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;firmwares, cur, list) {
<a name="l03084"></a>03084       <span class="keywordflow">if</span> (!cur-&gt;dead)
<a name="l03085"></a>03085          <span class="keywordflow">continue</span>;
<a name="l03086"></a>03086       <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l03087"></a>03087       <a class="code" href="chan__iax2_8c.html#a7f26d7c2ba86173984ba4394958ed980">destroy_firmware</a>(cur);
<a name="l03088"></a>03088    }
<a name="l03089"></a>03089    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l03090"></a>03090 
<a name="l03091"></a>03091    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;firmwares);
<a name="l03092"></a>03092 }
<a name="l03093"></a>03093 <span class="comment"></span>
<a name="l03094"></a>03094 <span class="comment">/*!</span>
<a name="l03095"></a>03095 <span class="comment"> * \note This function assumes that iaxsl[callno] is locked when called.</span>
<a name="l03096"></a>03096 <span class="comment"> *</span>
<a name="l03097"></a>03097 <span class="comment"> * \note IMPORTANT NOTE!!! Any time this function is used, even if iaxs[callno]</span>
<a name="l03098"></a>03098 <span class="comment"> * was valid before calling it, it may no longer be valid after calling it.</span>
<a name="l03099"></a>03099 <span class="comment"> * This function calls iax2_queue_frame(), which may unlock and lock the mutex </span>
<a name="l03100"></a>03100 <span class="comment"> * associated with this callno, meaning that another thread may grab it and destroy the call.</span>
<a name="l03101"></a>03101 <span class="comment"> */</span>
<a name="l03102"></a><a class="code" href="chan__iax2_8c.html#a8bda1d4286cae9030f7d25071627e32d">03102</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a8bda1d4286cae9030f7d25071627e32d">__do_deliver</a>(<span class="keywordtype">void</span> *data)
<a name="l03103"></a>03103 {
<a name="l03104"></a>03104    <span class="comment">/* Just deliver the packet by using queueing.  This is called by</span>
<a name="l03105"></a>03105 <span class="comment">     the IAX thread with the iaxsl lock held. */</span>
<a name="l03106"></a>03106    <span class="keyword">struct </span>iax_frame *fr = data;
<a name="l03107"></a>03107    fr-&gt;<a class="code" href="structiax__frame.html#a4ab21dd2375ec54e44ae4da973a3d4ca">retrans</a> = -1;
<a name="l03108"></a>03108    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>, <a class="code" href="frame_8h.html#a0ae1e3bf78c960c83e2d437efd802058ae8f674e19f6450e2b746c8a52c11649a">AST_FRFLAG_HAS_TIMING_INFO</a>);
<a name="l03109"></a>03109    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>))
<a name="l03110"></a>03110       <a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f" title="Queue a frame to a call&amp;#39;s owning asterisk channel.">iax2_queue_frame</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, &amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>);
<a name="l03111"></a>03111    <span class="comment">/* Free our iax frame */</span>
<a name="l03112"></a>03112    <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(fr);
<a name="l03113"></a>03113    <span class="comment">/* And don&apos;t run again */</span>
<a name="l03114"></a>03114    <span class="keywordflow">return</span> 0;
<a name="l03115"></a>03115 }
<a name="l03116"></a>03116 
<a name="l03117"></a><a class="code" href="chan__iax2_8c.html#a2960735b3981c003fcbea255e52d3096">03117</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2960735b3981c003fcbea255e52d3096">handle_error</a>(<span class="keywordtype">void</span>)
<a name="l03118"></a>03118 {
<a name="l03119"></a>03119    <span class="comment">/* XXX Ideally we should figure out why an error occurred and then abort those</span>
<a name="l03120"></a>03120 <span class="comment">      rather than continuing to try.  Unfortunately, the published interface does</span>
<a name="l03121"></a>03121 <span class="comment">      not seem to work XXX */</span>
<a name="l03122"></a>03122 <span class="preprocessor">#if 0</span>
<a name="l03123"></a>03123 <span class="preprocessor"></span>   <span class="keyword">struct </span>sockaddr_in *sin;
<a name="l03124"></a>03124    <span class="keywordtype">int</span> res;
<a name="l03125"></a>03125    <span class="keyword">struct </span>msghdr m;
<a name="l03126"></a>03126    <span class="keyword">struct </span>sock_extended_err e;
<a name="l03127"></a>03127    m.msg_name = NULL;
<a name="l03128"></a>03128    m.msg_namelen = 0;
<a name="l03129"></a>03129    m.msg_iov = NULL;
<a name="l03130"></a>03130    m.msg_control = &amp;e;
<a name="l03131"></a>03131    m.msg_controllen = <span class="keyword">sizeof</span>(e);
<a name="l03132"></a>03132    m.msg_flags = 0;
<a name="l03133"></a>03133    res = recvmsg(<a class="code" href="pbx__dundi_8c.html#a34d899b0c513443c533f0a04813aed58">netsocket</a>, &amp;m, MSG_ERRQUEUE);
<a name="l03134"></a>03134    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l03135"></a>03135       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error detected, but unable to read error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03136"></a>03136    <span class="keywordflow">else</span> {
<a name="l03137"></a>03137       <span class="keywordflow">if</span> (m.msg_controllen) {
<a name="l03138"></a>03138          sin = (<span class="keyword">struct </span>sockaddr_in *)SO_EE_OFFENDER(&amp;e);
<a name="l03139"></a>03139          <span class="keywordflow">if</span> (sin) 
<a name="l03140"></a>03140             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Receive error from %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l03141"></a>03141          <span class="keywordflow">else</span>
<a name="l03142"></a>03142             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No address detected??\n&quot;</span>);
<a name="l03143"></a>03143       } <span class="keywordflow">else</span> {
<a name="l03144"></a>03144          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Local error: %s\n&quot;</span>, strerror(e.ee_errno));
<a name="l03145"></a>03145       }
<a name="l03146"></a>03146    }
<a name="l03147"></a>03147 <span class="preprocessor">#endif</span>
<a name="l03148"></a>03148 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l03149"></a>03149 }
<a name="l03150"></a>03150 
<a name="l03151"></a><a class="code" href="chan__iax2_8c.html#a2f4ec7512d2d316b0aeb10570cf3b2b4">03151</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2f4ec7512d2d316b0aeb10570cf3b2b4">transmit_trunk</a>(<span class="keyword">struct</span> iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>)
<a name="l03152"></a>03152 {
<a name="l03153"></a>03153    <span class="keywordtype">int</span> res;
<a name="l03154"></a>03154    res = sendto(sockfd, f-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>, f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, 0,(<span class="keyword">struct</span> sockaddr *)sin,
<a name="l03155"></a>03155                <span class="keyword">sizeof</span>(*sin));
<a name="l03156"></a>03156    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03157"></a>03157       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03158"></a>03158       <a class="code" href="chan__iax2_8c.html#a2960735b3981c003fcbea255e52d3096">handle_error</a>();
<a name="l03159"></a>03159    } <span class="keywordflow">else</span>
<a name="l03160"></a>03160       res = 0;
<a name="l03161"></a>03161    <span class="keywordflow">return</span> res;
<a name="l03162"></a>03162 }
<a name="l03163"></a>03163 
<a name="l03164"></a><a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">03164</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(<span class="keyword">struct</span> iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l03165"></a>03165 {
<a name="l03166"></a>03166    <span class="keywordtype">int</span> res;
<a name="l03167"></a>03167    <span class="keywordtype">int</span> callno = f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l03168"></a>03168 
<a name="l03169"></a>03169    <span class="comment">/* Don&apos;t send if there was an error, but return error instead */</span>
<a name="l03170"></a>03170    <span class="keywordflow">if</span> (!callno || !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] || <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;error)
<a name="l03171"></a>03171        <span class="keywordflow">return</span> -1;
<a name="l03172"></a>03172    
<a name="l03173"></a>03173    <span class="comment">/* Called with iaxsl held */</span>
<a name="l03174"></a>03174    <span class="keywordflow">if</span> (iaxdebug)
<a name="l03175"></a>03175       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Sending %d on %d/%d to %s:%d\n&quot;</span>, f-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, callno, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l03176"></a>03176    
<a name="l03177"></a>03177    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a>) {
<a name="l03178"></a>03178       <span class="keywordflow">if</span> (iaxdebug)
<a name="l03179"></a>03179          <a class="code" href="iax2-parser_8c.html#a2865d35dffad22a73ab8f0ef67db8b99">iax_showframe</a>(f, NULL, 0, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>, f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>));
<a name="l03180"></a>03180       res = sendto(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, f-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>, f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, 0,(<span class="keyword">struct</span> sockaddr *)&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>));
<a name="l03181"></a>03181    } <span class="keywordflow">else</span> {
<a name="l03182"></a>03182       <span class="keywordflow">if</span> (iaxdebug)
<a name="l03183"></a>03183          <a class="code" href="iax2-parser_8c.html#a2865d35dffad22a73ab8f0ef67db8b99">iax_showframe</a>(f, NULL, 0, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>));
<a name="l03184"></a>03184       res = sendto(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, f-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>, f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, 0,(<span class="keyword">struct</span> sockaddr *)&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l03185"></a>03185    }
<a name="l03186"></a>03186    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03187"></a>03187       <span class="keywordflow">if</span> (iaxdebug)
<a name="l03188"></a>03188          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03189"></a>03189       <a class="code" href="chan__iax2_8c.html#a2960735b3981c003fcbea255e52d3096">handle_error</a>();
<a name="l03190"></a>03190    } <span class="keywordflow">else</span>
<a name="l03191"></a>03191       res = 0;
<a name="l03192"></a>03192 
<a name="l03193"></a>03193    <span class="keywordflow">return</span> res;
<a name="l03194"></a>03194 }
<a name="l03195"></a>03195 <span class="comment"></span>
<a name="l03196"></a>03196 <span class="comment">/*!</span>
<a name="l03197"></a>03197 <span class="comment"> * \note Since this function calls iax2_queue_hangup(), the pvt struct</span>
<a name="l03198"></a>03198 <span class="comment"> *       for the given call number may disappear during its execution.</span>
<a name="l03199"></a>03199 <span class="comment"> */</span>
<a name="l03200"></a><a class="code" href="chan__iax2_8c.html#a1b9c028e733553f16df68c8af049357a">03200</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1b9c028e733553f16df68c8af049357a">iax2_predestroy</a>(<span class="keywordtype">int</span> callno)
<a name="l03201"></a>03201 {
<a name="l03202"></a>03202    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = NULL;
<a name="l03203"></a>03203    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l03204"></a>03204 
<a name="l03205"></a>03205    <span class="keywordflow">if</span> (!pvt)
<a name="l03206"></a>03206       <span class="keywordflow">return</span> -1;
<a name="l03207"></a>03207 
<a name="l03208"></a>03208    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>)) {
<a name="l03209"></a>03209       <a class="code" href="chan__iax2_8c.html#a0d97140fc0f1c286328c703d1ae66002">iax2_destroy_helper</a>(pvt);
<a name="l03210"></a>03210       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>); 
<a name="l03211"></a>03211    }
<a name="l03212"></a>03212 
<a name="l03213"></a>03213    <span class="keywordflow">if</span> ((c = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l03214"></a>03214       c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l03215"></a>03215       <a class="code" href="chan__iax2_8c.html#a269447f294bd20e46d4fe128756d4567" title="Queue a hangup frame on the ast_channel owner.">iax2_queue_hangup</a>(callno);
<a name="l03216"></a>03216       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l03217"></a>03217       <a class="code" href="module_8h.html#ac65fa15b16dbc563a2424af744ab003d">ast_module_unref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l03218"></a>03218    }
<a name="l03219"></a>03219 
<a name="l03220"></a>03220    <span class="keywordflow">return</span> 0;
<a name="l03221"></a>03221 }
<a name="l03222"></a>03222 
<a name="l03223"></a><a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">03223</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(<span class="keywordtype">int</span> <a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)
<a name="l03224"></a>03224 {
<a name="l03225"></a>03225    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = NULL;
<a name="l03226"></a>03226    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *owner = NULL;
<a name="l03227"></a>03227 
<a name="l03228"></a>03228 retry:
<a name="l03229"></a>03229    <span class="keywordflow">if</span> ((pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])) {
<a name="l03230"></a>03230       <a class="code" href="chan__iax2_8c.html#a0d97140fc0f1c286328c703d1ae66002">iax2_destroy_helper</a>(pvt);
<a name="l03231"></a>03231    }
<a name="l03232"></a>03232 
<a name="l03233"></a>03233    owner = pvt ? pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> : NULL;
<a name="l03234"></a>03234 
<a name="l03235"></a>03235    <span class="keywordflow">if</span> (owner) {
<a name="l03236"></a>03236       <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(owner)) {
<a name="l03237"></a>03237          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Avoiding IAX destroy deadlock\n&quot;</span>);
<a name="l03238"></a>03238          <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l03239"></a>03239          <span class="keywordflow">goto</span> retry;
<a name="l03240"></a>03240       }
<a name="l03241"></a>03241    }
<a name="l03242"></a>03242 
<a name="l03243"></a>03243    <span class="keywordflow">if</span> (!owner) {
<a name="l03244"></a>03244       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] = NULL;
<a name="l03245"></a>03245    }
<a name="l03246"></a>03246 
<a name="l03247"></a>03247    <span class="keywordflow">if</span> (pvt) {
<a name="l03248"></a>03248       <span class="keywordflow">if</span> (!owner) {
<a name="l03249"></a>03249          pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l03250"></a>03250       } <span class="keywordflow">else</span> {
<a name="l03251"></a>03251          <span class="comment">/* If there&apos;s an owner, prod it to give up */</span>
<a name="l03252"></a>03252          <span class="comment">/* It is ok to use ast_queue_hangup() here instead of iax2_queue_hangup()</span>
<a name="l03253"></a>03253 <span class="comment">          * because we already hold the owner channel lock. */</span>
<a name="l03254"></a>03254          <a class="code" href="channel_8h.html#a30bcf0418189567bc84ff32034f79f28" title="Queue a hangup frame.">ast_queue_hangup</a>(owner);
<a name="l03255"></a>03255       }
<a name="l03256"></a>03256 
<a name="l03257"></a>03257       <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l03258"></a>03258          <a class="code" href="chan__iax2_8c.html#ae48d962bcb33faf6f14966b39668d439">remove_by_peercallno</a>(pvt);
<a name="l03259"></a>03259       }
<a name="l03260"></a>03260 
<a name="l03261"></a>03261       <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a>) {
<a name="l03262"></a>03262          <a class="code" href="chan__iax2_8c.html#ad175242682b4fbf0e8c54502bf805225">remove_by_transfercallno</a>(pvt);
<a name="l03263"></a>03263       }
<a name="l03264"></a>03264 
<a name="l03265"></a>03265       <span class="keywordflow">if</span> (!owner) {
<a name="l03266"></a>03266          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(pvt, -1);
<a name="l03267"></a>03267          pvt = NULL;
<a name="l03268"></a>03268       }
<a name="l03269"></a>03269    }
<a name="l03270"></a>03270 
<a name="l03271"></a>03271    <span class="keywordflow">if</span> (owner) {
<a name="l03272"></a>03272       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(owner);
<a name="l03273"></a>03273    }
<a name="l03274"></a>03274 
<a name="l03275"></a>03275    <span class="keywordflow">if</span> (callno &amp; 0x4000) {
<a name="l03276"></a>03276       <a class="code" href="chan__iax2_8c.html#ae2fc795355e133f36b68cf2f4f8c6638">update_max_trunk</a>();
<a name="l03277"></a>03277    }
<a name="l03278"></a>03278 }
<a name="l03279"></a>03279 
<a name="l03280"></a><a class="code" href="chan__iax2_8c.html#a1c5cf31623e4968fe71a3f44ddb234ea">03280</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1c5cf31623e4968fe71a3f44ddb234ea">update_packet</a>(<span class="keyword">struct</span> iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l03281"></a>03281 {
<a name="l03282"></a>03282    <span class="comment">/* Called with iaxsl lock held, and iaxs[callno] non-NULL */</span>
<a name="l03283"></a>03283    <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh = f-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03284"></a>03284    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> af;
<a name="l03285"></a>03285 
<a name="l03286"></a>03286    <span class="comment">/* if frame is encrypted. decrypt before updating it. */</span>
<a name="l03287"></a>03287    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l03288"></a>03288       <a class="code" href="chan__iax2_8c.html#aabb84cc107d8ba6ad24986225778efa4">decode_frame</a>(&amp;f-&gt;<a class="code" href="structiax__frame.html#acb5abb83f0ce114bf0dee2c3217ff466">mydcx</a>, fh, &amp;af, &amp;f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l03289"></a>03289    }
<a name="l03290"></a>03290    <span class="comment">/* Mark this as a retransmission */</span>
<a name="l03291"></a>03291    fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a> = ntohs(<a class="code" href="iax2_8h.html#a9c7b219ff307b8867b301264fd443c62">IAX_FLAG_RETRANS</a> | f-&gt;<a class="code" href="structiax__frame.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>);
<a name="l03292"></a>03292    <span class="comment">/* Update iseqno */</span>
<a name="l03293"></a>03293    f-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>;
<a name="l03294"></a>03294    fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> = f-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>;
<a name="l03295"></a>03295 
<a name="l03296"></a>03296    <span class="comment">/* Now re-encrypt the frame */</span>
<a name="l03297"></a>03297    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l03298"></a>03298    <span class="comment">/* since this is a retransmit frame, create a new random padding</span>
<a name="l03299"></a>03299 <span class="comment">    * before re-encrypting. */</span>
<a name="l03300"></a>03300       <a class="code" href="chan__iax2_8c.html#ab11c1510aa7efdbb6bb4cedcd13390d8">build_rand_pad</a>(f-&gt;<a class="code" href="structiax__frame.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, <span class="keyword">sizeof</span>(f-&gt;<a class="code" href="structiax__frame.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>));
<a name="l03301"></a>03301       <a class="code" href="chan__iax2_8c.html#a6423f55e3c003cc765531b7b1eebaeea">encrypt_frame</a>(&amp;f-&gt;<a class="code" href="structiax__frame.html#ae119b8bbe294cad12c32cd093eb81e4c">ecx</a>, fh, f-&gt;<a class="code" href="structiax__frame.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, &amp;f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l03302"></a>03302    }
<a name="l03303"></a>03303    <span class="keywordflow">return</span> 0;
<a name="l03304"></a>03304 }
<a name="l03305"></a>03305 
<a name="l03306"></a>03306 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a637039d12aabcf9c32a907281e162884">attempt_transmit</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>);
<a name="l03307"></a><a class="code" href="chan__iax2_8c.html#af02ea1a0f8a002a220bedb9a71cff725">03307</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#af02ea1a0f8a002a220bedb9a71cff725">__attempt_transmit</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l03308"></a>03308 {
<a name="l03309"></a>03309    <span class="comment">/* Attempt to transmit the frame to the remote peer...</span>
<a name="l03310"></a>03310 <span class="comment">      Called without iaxsl held. */</span>
<a name="l03311"></a>03311    <span class="keyword">struct </span>iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = (<span class="keyword">struct </span>iax_frame *)data;
<a name="l03312"></a>03312    <span class="keywordtype">int</span> freeme = 0;
<a name="l03313"></a>03313    <span class="keywordtype">int</span> <a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l03314"></a>03314    <span class="comment">/* Make sure this call is still active */</span>
<a name="l03315"></a>03315    <span class="keywordflow">if</span> (callno) 
<a name="l03316"></a>03316       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l03317"></a>03317    <span class="keywordflow">if</span> (callno &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l03318"></a>03318       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &lt; 0) <span class="comment">/* Already ACK&apos;d */</span> ||
<a name="l03319"></a>03319           (f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &gt;= max_retries) <span class="comment">/* Too many attempts */</span>) {
<a name="l03320"></a>03320             <span class="comment">/* Record an error if we&apos;ve transmitted too many times */</span>
<a name="l03321"></a>03321             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &gt;= max_retries) {
<a name="l03322"></a>03322                <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a>) {
<a name="l03323"></a>03323                   <span class="comment">/* Transfer timeout */</span>
<a name="l03324"></a>03324                   <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa865644fc2ba5a8075bfd3f79faa1afe6">IAX_COMMAND_TXREJ</a>, 0, NULL, 0, -1);
<a name="l03325"></a>03325                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a48be625dde1131eceb8209732f83e909">final</a>) {
<a name="l03326"></a>03326                   <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l03327"></a>03327                } <span class="keywordflow">else</span> {
<a name="l03328"></a>03328                   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner)
<a name="l03329"></a>03329                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Max retries exceeded to host %s on %s (type = %d, subclass = %d, ts=%d, seqno=%d)\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr),<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name , f-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>, f-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, f-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, f-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a>);
<a name="l03330"></a>03330                   <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a11614f44ef4d939bdd984953346a7572">error</a> = ETIMEDOUT;
<a name="l03331"></a>03331                   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner) {
<a name="l03332"></a>03332                      <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> fr = { <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>, .data.uint32 = <a class="code" href="causes_8h.html#a51ccdf5c6aa26375323fd14cfef02618">AST_CAUSE_DESTINATION_OUT_OF_ORDER</a> };
<a name="l03333"></a>03333                      <span class="comment">/* Hangup the fd */</span>
<a name="l03334"></a>03334                      <a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f" title="Queue a frame to a call&amp;#39;s owning asterisk channel.">iax2_queue_frame</a>(callno, &amp;fr); <span class="comment">/* XXX */</span>
<a name="l03335"></a>03335                      <span class="comment">/* Remember, owner could disappear */</span>
<a name="l03336"></a>03336                      <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner)
<a name="l03337"></a>03337                         <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = <a class="code" href="causes_8h.html#a51ccdf5c6aa26375323fd14cfef02618">AST_CAUSE_DESTINATION_OUT_OF_ORDER</a>;
<a name="l03338"></a>03338                   } <span class="keywordflow">else</span> {
<a name="l03339"></a>03339                      <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;reg) {
<a name="l03340"></a>03340                         memset(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;reg-&gt;us, 0, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>));
<a name="l03341"></a>03341                         <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a> = <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0ceb5a0d8116282669c98effcffe96e3">REG_STATE_TIMEOUT</a>;
<a name="l03342"></a>03342                         <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> = <a class="code" href="iax2_8h.html#a5fc5c0b246090e6ebf9245897d979e21">IAX_DEFAULT_REG_EXPIRE</a>;
<a name="l03343"></a>03343                      }
<a name="l03344"></a>03344                      <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l03345"></a>03345                   }
<a name="l03346"></a>03346                }
<a name="l03347"></a>03347 
<a name="l03348"></a>03348             }
<a name="l03349"></a>03349             freeme = 1;
<a name="l03350"></a>03350       } <span class="keywordflow">else</span> {
<a name="l03351"></a>03351          <span class="comment">/* Update it if it needs it */</span>
<a name="l03352"></a>03352          <a class="code" href="chan__iax2_8c.html#a1c5cf31623e4968fe71a3f44ddb234ea">update_packet</a>(f);
<a name="l03353"></a>03353          <span class="comment">/* Attempt transmission */</span>
<a name="l03354"></a>03354          <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(f);
<a name="l03355"></a>03355          f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>++;
<a name="l03356"></a>03356          <span class="comment">/* Try again later after 10 times as long */</span>
<a name="l03357"></a>03357          f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> *= 10;
<a name="l03358"></a>03358          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> &gt; <a class="code" href="chan__iax2_8c.html#a67d22005a8e4f7fecdfbfe9856b089e3">MAX_RETRY_TIME</a>)
<a name="l03359"></a>03359             f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = <a class="code" href="chan__iax2_8c.html#a67d22005a8e4f7fecdfbfe9856b089e3">MAX_RETRY_TIME</a>;
<a name="l03360"></a>03360          <span class="comment">/* Transfer messages max out at one second */</span>
<a name="l03361"></a>03361          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a> &amp;&amp; (f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> &gt; 1000))
<a name="l03362"></a>03362             f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = 1000;
<a name="l03363"></a>03363          f-&gt;<a class="code" href="structiax__frame.html#a4ab21dd2375ec54e44ae4da973a3d4ca">retrans</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a>, <a class="code" href="chan__iax2_8c.html#a637039d12aabcf9c32a907281e162884">attempt_transmit</a>, f);
<a name="l03364"></a>03364       }
<a name="l03365"></a>03365    } <span class="keywordflow">else</span> {
<a name="l03366"></a>03366       <span class="comment">/* Make sure it gets freed */</span>
<a name="l03367"></a>03367       f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l03368"></a>03368       freeme = 1;
<a name="l03369"></a>03369    }
<a name="l03370"></a>03370    <span class="keywordflow">if</span> (callno)
<a name="l03371"></a>03371       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l03372"></a>03372    <span class="comment">/* Do not try again */</span>
<a name="l03373"></a>03373    <span class="keywordflow">if</span> (freeme) {
<a name="l03374"></a>03374       <span class="comment">/* Don&apos;t attempt delivery, just remove it from the queue */</span>
<a name="l03375"></a>03375       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l03376"></a>03376       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;frame_queue, f, list);
<a name="l03377"></a>03377       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l03378"></a>03378       f-&gt;<a class="code" href="structiax__frame.html#a4ab21dd2375ec54e44ae4da973a3d4ca">retrans</a> = -1; <span class="comment">/* this is safe because this is the scheduled function */</span>
<a name="l03379"></a>03379       <span class="comment">/* Free the IAX frame */</span>
<a name="l03380"></a>03380       <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(f);
<a name="l03381"></a>03381    }
<a name="l03382"></a>03382 }
<a name="l03383"></a>03383 
<a name="l03384"></a><a class="code" href="chan__iax2_8c.html#a637039d12aabcf9c32a907281e162884">03384</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a637039d12aabcf9c32a907281e162884">attempt_transmit</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l03385"></a>03385 {
<a name="l03386"></a>03386 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l03387"></a>03387 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#af02ea1a0f8a002a220bedb9a71cff725">__attempt_transmit</a>, data))
<a name="l03388"></a>03388 <span class="preprocessor">#endif      </span>
<a name="l03389"></a>03389 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#af02ea1a0f8a002a220bedb9a71cff725">__attempt_transmit</a>(data);
<a name="l03390"></a>03390    <span class="keywordflow">return</span> 0;
<a name="l03391"></a>03391 }
<a name="l03392"></a>03392 
<a name="l03393"></a><a class="code" href="chan__iax2_8c.html#a0a0b0536de61b276f4c872c064476e76">03393</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a0a0b0536de61b276f4c872c064476e76">handle_cli_iax2_prune_realtime</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03394"></a>03394 {
<a name="l03395"></a>03395    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l03396"></a>03396    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l03397"></a>03397    <span class="keyword">static</span> <span class="keywordtype">char</span> *choices[] = { <span class="stringliteral">&quot;all&quot;</span>, NULL };
<a name="l03398"></a>03398    <span class="keywordtype">char</span> *cmplt;
<a name="l03399"></a>03399 
<a name="l03400"></a>03400    <span class="keywordflow">switch</span> (cmd) {
<a name="l03401"></a>03401    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03402"></a>03402       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 prune realtime&quot;</span>;
<a name="l03403"></a>03403       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03404"></a>03404          <span class="stringliteral">&quot;Usage: iax2 prune realtime [&lt;peername&gt;|all]\n&quot;</span>
<a name="l03405"></a>03405          <span class="stringliteral">&quot;       Prunes object(s) from the cache\n&quot;</span>;
<a name="l03406"></a>03406       <span class="keywordflow">return</span> NULL;
<a name="l03407"></a>03407    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03408"></a>03408       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3) {
<a name="l03409"></a>03409          cmplt = <a class="code" href="cli_8h.html#a7d198ac45b2d75bb30eb773582caf89f">ast_cli_complete</a>(a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, choices, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l03410"></a>03410          <span class="keywordflow">if</span> (!cmplt)
<a name="l03411"></a>03411             cmplt = <a class="code" href="chan__iax2_8c.html#a4c1705908c9696e6bd564ca8bd297a4d">complete_iax2_peers</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a> - <span class="keyword">sizeof</span>(choices), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>);
<a name="l03412"></a>03412          <span class="keywordflow">return</span> cmplt;
<a name="l03413"></a>03413       }
<a name="l03414"></a>03414       <span class="keywordflow">return</span> NULL;
<a name="l03415"></a>03415    }
<a name="l03416"></a>03416    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l03417"></a>03417       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03418"></a>03418    <span class="keywordflow">if</span> (!strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;all&quot;</span>)) {
<a name="l03419"></a>03419       <a class="code" href="chan__iax2_8c.html#a64dccf856273fe23ad33955a0a491bc2">prune_users</a>();
<a name="l03420"></a>03420       <a class="code" href="chan__iax2_8c.html#a55c82d81ce37ebe5125d5a017c12b5ac">prune_peers</a>();
<a name="l03421"></a>03421       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Cache flushed successfully.\n&quot;</span>);
<a name="l03422"></a>03422       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03423"></a>03423    }
<a name="l03424"></a>03424    peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], 0);
<a name="l03425"></a>03425    user = <a class="code" href="chan__iax2_8c.html#aa56d736414c9f5f71da37c50f0f57760">find_user</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03426"></a>03426    <span class="keywordflow">if</span> (peer || user) {
<a name="l03427"></a>03427       <span class="keywordflow">if</span> (peer) {
<a name="l03428"></a>03428          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)) {
<a name="l03429"></a>03429             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a>);
<a name="l03430"></a>03430             <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>(<a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l03431"></a>03431             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer %s was removed from the cache.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03432"></a>03432          } <span class="keywordflow">else</span> {
<a name="l03433"></a>03433             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer %s is not eligible for this operation.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03434"></a>03434          }
<a name="l03435"></a>03435          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l03436"></a>03436       }
<a name="l03437"></a>03437       <span class="keywordflow">if</span> (user) {
<a name="l03438"></a>03438          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)) {
<a name="l03439"></a>03439             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a>);
<a name="l03440"></a>03440             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;User %s was removed from the cache.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03441"></a>03441          } <span class="keywordflow">else</span> {
<a name="l03442"></a>03442             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;User %s is not eligible for this operation.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03443"></a>03443          }
<a name="l03444"></a>03444          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(users,user);
<a name="l03445"></a>03445          <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l03446"></a>03446       }
<a name="l03447"></a>03447    } <span class="keywordflow">else</span> {
<a name="l03448"></a>03448       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s was not found in the cache.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03449"></a>03449    }
<a name="l03450"></a>03450 
<a name="l03451"></a>03451    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03452"></a>03452 }
<a name="l03453"></a>03453 
<a name="l03454"></a><a class="code" href="chan__iax2_8c.html#a6b8fc2e4b6f2525c43f97a4bbe69a80d">03454</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a6b8fc2e4b6f2525c43f97a4bbe69a80d">handle_cli_iax2_test_losspct</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03455"></a>03455 {
<a name="l03456"></a>03456    <span class="keywordflow">switch</span> (cmd) {
<a name="l03457"></a>03457    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03458"></a>03458       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 test losspct&quot;</span>;
<a name="l03459"></a>03459       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03460"></a>03460          <span class="stringliteral">&quot;Usage: iax2 test losspct &lt;percentage&gt;\n&quot;</span>
<a name="l03461"></a>03461          <span class="stringliteral">&quot;       For testing, throws away &lt;percentage&gt; percent of incoming packets\n&quot;</span>;
<a name="l03462"></a>03462       <span class="keywordflow">return</span> NULL;
<a name="l03463"></a>03463    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03464"></a>03464       <span class="keywordflow">return</span> NULL;
<a name="l03465"></a>03465    }
<a name="l03466"></a>03466    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l03467"></a>03467       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03468"></a>03468 
<a name="l03469"></a>03469    test_losspct = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03470"></a>03470 
<a name="l03471"></a>03471    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03472"></a>03472 }
<a name="l03473"></a>03473 
<a name="l03474"></a>03474 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l03475"></a>03475 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> *handle_cli_iax2_test_late(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03476"></a>03476 {
<a name="l03477"></a>03477    <span class="keywordflow">switch</span> (cmd) {
<a name="l03478"></a>03478    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03479"></a>03479       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 test late&quot;</span>;
<a name="l03480"></a>03480       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03481"></a>03481          <span class="stringliteral">&quot;Usage: iax2 test late &lt;ms&gt;\n&quot;</span>
<a name="l03482"></a>03482          <span class="stringliteral">&quot;       For testing, count the next frame as &lt;ms&gt; ms late\n&quot;</span>;
<a name="l03483"></a>03483       <span class="keywordflow">return</span> NULL;
<a name="l03484"></a>03484    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03485"></a>03485       <span class="keywordflow">return</span> NULL;
<a name="l03486"></a>03486    }
<a name="l03487"></a>03487 
<a name="l03488"></a>03488    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l03489"></a>03489       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03490"></a>03490 
<a name="l03491"></a>03491    test_late = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03492"></a>03492 
<a name="l03493"></a>03493    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03494"></a>03494 }
<a name="l03495"></a>03495 
<a name="l03496"></a>03496 <span class="keyword">static</span> <span class="keywordtype">char</span> *handle_cli_iax2_test_resync(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03497"></a>03497 {
<a name="l03498"></a>03498    <span class="keywordflow">switch</span> (cmd) {
<a name="l03499"></a>03499    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03500"></a>03500       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 test resync&quot;</span>;
<a name="l03501"></a>03501       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03502"></a>03502          <span class="stringliteral">&quot;Usage: iax2 test resync &lt;ms&gt;\n&quot;</span>
<a name="l03503"></a>03503          <span class="stringliteral">&quot;       For testing, adjust all future frames by &lt;ms&gt; ms\n&quot;</span>;
<a name="l03504"></a>03504       <span class="keywordflow">return</span> NULL;
<a name="l03505"></a>03505    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03506"></a>03506       <span class="keywordflow">return</span> NULL;
<a name="l03507"></a>03507    }
<a name="l03508"></a>03508 
<a name="l03509"></a>03509    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l03510"></a>03510       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03511"></a>03511 
<a name="l03512"></a>03512    test_resync = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03513"></a>03513 
<a name="l03514"></a>03514    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03515"></a>03515 }
<a name="l03516"></a>03516 
<a name="l03517"></a>03517 <span class="keyword">static</span> <span class="keywordtype">char</span> *handle_cli_iax2_test_jitter(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03518"></a>03518 {
<a name="l03519"></a>03519    <span class="keywordflow">switch</span> (cmd) {
<a name="l03520"></a>03520    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03521"></a>03521       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 test jitter&quot;</span>;
<a name="l03522"></a>03522       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03523"></a>03523          <span class="stringliteral">&quot;Usage: iax2 test jitter &lt;ms&gt; &lt;pct&gt;\n&quot;</span>
<a name="l03524"></a>03524          <span class="stringliteral">&quot;       For testing, simulate maximum jitter of +/- &lt;ms&gt; on &lt;pct&gt;\n&quot;</span>
<a name="l03525"></a>03525          <span class="stringliteral">&quot;       percentage of packets. If &lt;pct&gt; is not specified, adds\n&quot;</span>
<a name="l03526"></a>03526          <span class="stringliteral">&quot;       jitter to all packets.\n&quot;</span>;
<a name="l03527"></a>03527       <span class="keywordflow">return</span> NULL;
<a name="l03528"></a>03528    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03529"></a>03529       <span class="keywordflow">return</span> NULL;
<a name="l03530"></a>03530    }
<a name="l03531"></a>03531 
<a name="l03532"></a>03532    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4 || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 5)
<a name="l03533"></a>03533       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03534"></a>03534 
<a name="l03535"></a>03535    test_jit = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03536"></a>03536    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5)
<a name="l03537"></a>03537       test_jitpct = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4]);
<a name="l03538"></a>03538 
<a name="l03539"></a>03539    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03540"></a>03540 }
<a name="l03541"></a>03541 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l03542"></a>03542 <span class="comment"></span>
<a name="l03543"></a>03543 <span class="comment">/*! \brief  peer_status: Report Peer status in character string */</span>
<a name="l03544"></a>03544 <span class="comment">/*    returns 1 if peer is online, -1 if unmonitored */</span>
<a name="l03545"></a><a class="code" href="chan__iax2_8c.html#aa421fc97db5511876bc29d397fd65827">03545</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa421fc97db5511876bc29d397fd65827" title="peer_status: Report Peer status in character string">peer_status</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer, <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, <span class="keywordtype">int</span> statuslen)
<a name="l03546"></a>03546 {
<a name="l03547"></a>03547    <span class="keywordtype">int</span> res = 0;
<a name="l03548"></a>03548    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>) {
<a name="l03549"></a>03549       <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &lt; 0) {
<a name="l03550"></a>03550          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(status, <span class="stringliteral">&quot;UNREACHABLE&quot;</span>, statuslen);
<a name="l03551"></a>03551       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &gt; peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>) {
<a name="l03552"></a>03552          snprintf(status, statuslen, <span class="stringliteral">&quot;LAGGED (%d ms)&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>);
<a name="l03553"></a>03553          res = 1;
<a name="l03554"></a>03554       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>) {
<a name="l03555"></a>03555          snprintf(status, statuslen, <span class="stringliteral">&quot;OK (%d ms)&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>);
<a name="l03556"></a>03556          res = 1;
<a name="l03557"></a>03557       } <span class="keywordflow">else</span> {
<a name="l03558"></a>03558          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(status, <span class="stringliteral">&quot;UNKNOWN&quot;</span>, statuslen);
<a name="l03559"></a>03559       }
<a name="l03560"></a>03560    } <span class="keywordflow">else</span> { 
<a name="l03561"></a>03561       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(status, <span class="stringliteral">&quot;Unmonitored&quot;</span>, statuslen);
<a name="l03562"></a>03562       res = -1;
<a name="l03563"></a>03563    }
<a name="l03564"></a>03564    <span class="keywordflow">return</span> res;
<a name="l03565"></a>03565 }
<a name="l03566"></a>03566 <span class="comment"></span>
<a name="l03567"></a>03567 <span class="comment">/*! \brief Show one peer in detail */</span>
<a name="l03568"></a><a class="code" href="chan__iax2_8c.html#a318a922128d4a2d200263cbaaae6ef38">03568</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a318a922128d4a2d200263cbaaae6ef38" title="Show one peer in detail.">handle_cli_iax2_show_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03569"></a>03569 {
<a name="l03570"></a>03570    <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>[30];
<a name="l03571"></a>03571    <span class="keywordtype">char</span> cbuf[256];
<a name="l03572"></a>03572    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l03573"></a>03573    <span class="keywordtype">char</span> codec_buf[512];
<a name="l03574"></a>03574    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *encmethods = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(256);
<a name="l03575"></a>03575    <span class="keywordtype">int</span> x = 0, codec = 0, load_realtime = 0;
<a name="l03576"></a>03576 
<a name="l03577"></a>03577    <span class="keywordflow">switch</span> (cmd) {
<a name="l03578"></a>03578    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03579"></a>03579       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show peer&quot;</span>;
<a name="l03580"></a>03580       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03581"></a>03581          <span class="stringliteral">&quot;Usage: iax2 show peer &lt;name&gt;\n&quot;</span>
<a name="l03582"></a>03582          <span class="stringliteral">&quot;       Display details on specific IAX peer\n&quot;</span>;
<a name="l03583"></a>03583       <span class="keywordflow">return</span> NULL;
<a name="l03584"></a>03584    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03585"></a>03585       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3)
<a name="l03586"></a>03586          <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a4c1705908c9696e6bd564ca8bd297a4d">complete_iax2_peers</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 0);
<a name="l03587"></a>03587       <span class="keywordflow">return</span> NULL;
<a name="l03588"></a>03588    }
<a name="l03589"></a>03589 
<a name="l03590"></a>03590    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4)
<a name="l03591"></a>03591       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03592"></a>03592 
<a name="l03593"></a>03593    load_realtime = (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5 &amp;&amp; !strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;load&quot;</span>)) ? 1 : 0;
<a name="l03594"></a>03594 
<a name="l03595"></a>03595    peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], load_realtime);
<a name="l03596"></a>03596    <span class="keywordflow">if</span> (peer) {
<a name="l03597"></a>03597       <a class="code" href="chan__iax2_8c.html#aab0a14f82b40eb534e3b026724636b41">encmethods_to_str</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>, encmethods);
<a name="l03598"></a>03598       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n\n&quot;</span>);
<a name="l03599"></a>03599       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  * Name       : %s\n&quot;</span>, peer-&gt;name);
<a name="l03600"></a>03600       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Secret       : %s\n&quot;</span>, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;secret) ? <span class="stringliteral">&quot;&lt;Not set&gt;&quot;</span> : <span class="stringliteral">&quot;&lt;Set&gt;&quot;</span>);
<a name="l03601"></a>03601       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Context      : %s\n&quot;</span>, peer-&gt;context);
<a name="l03602"></a>03602       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Parking lot  : %s\n&quot;</span>, peer-&gt;parkinglot);
<a name="l03603"></a>03603       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Mailbox      : %s\n&quot;</span>, peer-&gt;mailbox);
<a name="l03604"></a>03604       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Dynamic      : %s\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l03605"></a>03605       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Callnum limit: %d\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a>);
<a name="l03606"></a>03606       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Calltoken req: %s\n&quot;</span>, (peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8" title="Require call token validation.">CALLTOKEN_YES</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : ((peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a>) ? <span class="stringliteral">&quot;Auto&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>));
<a name="l03607"></a>03607       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Trunk        : %s\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l03608"></a>03608       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Encryption   : %s\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> ? <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(encmethods) : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l03609"></a>03609       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Callerid     : %s\n&quot;</span>, <a class="code" href="callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(cbuf, <span class="keyword">sizeof</span>(cbuf), peer-&gt;cid_name, peer-&gt;cid_num, <span class="stringliteral">&quot;&lt;unspecified&gt;&quot;</span>));
<a name="l03610"></a>03610       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Expire       : %d\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>);
<a name="l03611"></a>03611       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  ACL          : %s\n&quot;</span>, (peer-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>));
<a name="l03612"></a>03612       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Addr-&gt;IP     : %s Port %d\n&quot;</span>,  peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;(Unspecified)&quot;</span>, ntohs(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l03613"></a>03613       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Defaddr-&gt;IP  : %s Port %d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_addr), ntohs(peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_port));
<a name="l03614"></a>03614       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Username     : %s\n&quot;</span>, peer-&gt;username);
<a name="l03615"></a>03615       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Codecs       : &quot;</span>);
<a name="l03616"></a>03616       <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(codec_buf, <span class="keyword">sizeof</span>(codec_buf) -1, peer-&gt;<a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l03617"></a>03617       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, codec_buf);
<a name="l03618"></a>03618 
<a name="l03619"></a>03619       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Codec Order  : (&quot;</span>);
<a name="l03620"></a>03620       <span class="keywordflow">for</span>(x = 0; x &lt; 32 ; x++) {
<a name="l03621"></a>03621          codec = <a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>,x);
<a name="l03622"></a>03622          <span class="keywordflow">if</span>(!codec)
<a name="l03623"></a>03623             <span class="keywordflow">break</span>;
<a name="l03624"></a>03624          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(codec));
<a name="l03625"></a>03625          <span class="keywordflow">if</span>(x &lt; 31 &amp;&amp; <a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>,x+1))
<a name="l03626"></a>03626             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l03627"></a>03627       }
<a name="l03628"></a>03628 
<a name="l03629"></a>03629       <span class="keywordflow">if</span> (!x)
<a name="l03630"></a>03630          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;none&quot;</span>);
<a name="l03631"></a>03631       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;)\n&quot;</span>);
<a name="l03632"></a>03632 
<a name="l03633"></a>03633       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Status       : &quot;</span>);
<a name="l03634"></a>03634       <a class="code" href="chan__iax2_8c.html#aa421fc97db5511876bc29d397fd65827" title="peer_status: Report Peer status in character string">peer_status</a>(peer, status, <span class="keyword">sizeof</span>(status));   
<a name="l03635"></a>03635       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s\n&quot;</span>,status);
<a name="l03636"></a>03636       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  Qualify      : every %dms when OK, every %dms when UNREACHABLE (sample smoothing %s)\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a0fc1d0f0302835103c4b7c291c2467b1">pokefreqok</a>, peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>, peer-&gt;<a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">smoothing</a> ? <span class="stringliteral">&quot;On&quot;</span> : <span class="stringliteral">&quot;Off&quot;</span>);
<a name="l03637"></a>03637       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03638"></a>03638       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l03639"></a>03639    } <span class="keywordflow">else</span> {
<a name="l03640"></a>03640       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer %s not found.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03641"></a>03641       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l03642"></a>03642    }
<a name="l03643"></a>03643 
<a name="l03644"></a>03644    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03645"></a>03645 }
<a name="l03646"></a>03646 
<a name="l03647"></a><a class="code" href="chan__iax2_8c.html#a4c1705908c9696e6bd564ca8bd297a4d">03647</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a4c1705908c9696e6bd564ca8bd297a4d">complete_iax2_peers</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">int</span> flags)
<a name="l03648"></a>03648 {
<a name="l03649"></a>03649    <span class="keywordtype">int</span> which = 0;
<a name="l03650"></a>03650    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l03651"></a>03651    <span class="keywordtype">char</span> *res = NULL;
<a name="l03652"></a>03652    <span class="keywordtype">int</span> wordlen = strlen(word);
<a name="l03653"></a>03653    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l03654"></a>03654 
<a name="l03655"></a>03655    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l03656"></a>03656    <span class="keywordflow">while</span> ((peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l03657"></a>03657       <span class="keywordflow">if</span> (!strncasecmp(peer-&gt;name, word, wordlen) &amp;&amp; ++which &gt; state
<a name="l03658"></a>03658          &amp;&amp; (!flags || <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, flags))) {
<a name="l03659"></a>03659          res = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(peer-&gt;name);
<a name="l03660"></a>03660          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l03661"></a>03661          <span class="keywordflow">break</span>;
<a name="l03662"></a>03662       }
<a name="l03663"></a>03663       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l03664"></a>03664    }
<a name="l03665"></a>03665    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l03666"></a>03666 
<a name="l03667"></a>03667    <span class="keywordflow">return</span> res;
<a name="l03668"></a>03668 }
<a name="l03669"></a>03669 
<a name="l03670"></a><a class="code" href="chan__iax2_8c.html#aa533b4526f161d72607393aa85531d01">03670</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#aa533b4526f161d72607393aa85531d01">handle_cli_iax2_show_stats</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03671"></a>03671 {
<a name="l03672"></a>03672    <span class="keyword">struct </span>iax_frame *cur;
<a name="l03673"></a>03673    <span class="keywordtype">int</span> cnt = 0, dead = 0, <span class="keyword">final</span> = 0;
<a name="l03674"></a>03674 
<a name="l03675"></a>03675    <span class="keywordflow">switch</span> (cmd) {
<a name="l03676"></a>03676    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03677"></a>03677       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show stats&quot;</span>;
<a name="l03678"></a>03678       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03679"></a>03679          <span class="stringliteral">&quot;Usage: iax2 show stats\n&quot;</span>
<a name="l03680"></a>03680          <span class="stringliteral">&quot;       Display statistics on IAX channel driver.\n&quot;</span>;
<a name="l03681"></a>03681       <span class="keywordflow">return</span> NULL;
<a name="l03682"></a>03682    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03683"></a>03683       <span class="keywordflow">return</span> NULL;
<a name="l03684"></a>03684    }
<a name="l03685"></a>03685 
<a name="l03686"></a>03686    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l03687"></a>03687       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l03688"></a>03688 
<a name="l03689"></a>03689    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l03690"></a>03690    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l03691"></a>03691       <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &lt; 0)
<a name="l03692"></a>03692          dead++;
<a name="l03693"></a>03693       <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structiax__frame.html#a48be625dde1131eceb8209732f83e909">final</a>)
<a name="l03694"></a>03694          <span class="keyword">final</span>++;
<a name="l03695"></a>03695       cnt++;
<a name="l03696"></a>03696    }
<a name="l03697"></a>03697    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l03698"></a>03698 
<a name="l03699"></a>03699    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;    IAX Statistics\n&quot;</span>);
<a name="l03700"></a>03700    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;---------------------\n&quot;</span>);
<a name="l03701"></a>03701    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Outstanding frames: %d (%d ingress, %d egress)\n&quot;</span>, <a class="code" href="iax2-parser_8c.html#af455cee6f84e3172efd275baa2f42181">iax_get_frames</a>(), <a class="code" href="iax2-parser_8c.html#a0718dbbbf3999ce541b0bb41b8668186">iax_get_iframes</a>(), <a class="code" href="iax2-parser_8c.html#abb3748c6e76b50fb32c55e70a12cd056">iax_get_oframes</a>());
<a name="l03702"></a>03702    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d timed and %d untimed transmits; MTU %d/%d/%d\n&quot;</span>, trunk_timed, trunk_untimed,
<a name="l03703"></a>03703       trunk_maxmtu, trunk_nmaxmtu, global_max_trunk_mtu);
<a name="l03704"></a>03704    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Packets in transmit queue: %d dead, %d final, %d total\n\n&quot;</span>, dead, <span class="keyword">final</span>, cnt);
<a name="l03705"></a>03705 
<a name="l03706"></a>03706    trunk_timed = trunk_untimed = 0;
<a name="l03707"></a>03707    <span class="keywordflow">if</span> (trunk_maxmtu &gt; trunk_nmaxmtu)
<a name="l03708"></a>03708       trunk_nmaxmtu = trunk_maxmtu;
<a name="l03709"></a>03709 
<a name="l03710"></a>03710    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03711"></a>03711 }
<a name="l03712"></a>03712 <span class="comment"></span>
<a name="l03713"></a>03713 <span class="comment">/*! \brief Set trunk MTU from CLI */</span>
<a name="l03714"></a><a class="code" href="chan__iax2_8c.html#a772243800fb1a40f2ac2134219fc7183">03714</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a772243800fb1a40f2ac2134219fc7183" title="Set trunk MTU from CLI.">handle_cli_iax2_set_mtu</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03715"></a>03715 {
<a name="l03716"></a>03716    <span class="keywordtype">int</span> mtuv;
<a name="l03717"></a>03717 
<a name="l03718"></a>03718    <span class="keywordflow">switch</span> (cmd) {
<a name="l03719"></a>03719    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03720"></a>03720       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 set mtu&quot;</span>;
<a name="l03721"></a>03721       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03722"></a>03722          <span class="stringliteral">&quot;Usage: iax2 set mtu &lt;value&gt;\n&quot;</span>
<a name="l03723"></a>03723          <span class="stringliteral">&quot;       Set the system-wide IAX IP mtu to &lt;value&gt; bytes net or\n&quot;</span>
<a name="l03724"></a>03724          <span class="stringliteral">&quot;       zero to disable. Disabling means that the operating system\n&quot;</span>
<a name="l03725"></a>03725          <span class="stringliteral">&quot;       must handle fragmentation of UDP packets when the IAX2 trunk\n&quot;</span>
<a name="l03726"></a>03726          <span class="stringliteral">&quot;       packet exceeds the UDP payload size. This is substantially\n&quot;</span>
<a name="l03727"></a>03727          <span class="stringliteral">&quot;       below the IP mtu. Try 1240 on ethernets. Must be 172 or\n&quot;</span>
<a name="l03728"></a>03728          <span class="stringliteral">&quot;       greater for G.711 samples.\n&quot;</span>;
<a name="l03729"></a>03729       <span class="keywordflow">return</span> NULL;
<a name="l03730"></a>03730    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03731"></a>03731       <span class="keywordflow">return</span> NULL;
<a name="l03732"></a>03732    }
<a name="l03733"></a>03733 
<a name="l03734"></a>03734    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l03735"></a>03735       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>; 
<a name="l03736"></a>03736    <span class="keywordflow">if</span> (strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;default&quot;</span>, strlen(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3])) == 0)
<a name="l03737"></a>03737       mtuv = <a class="code" href="chan__iax2_8c.html#a48a4382bfd50a02e75939c5ac05e25eb" title="Maximum transmission unit for the UDP packet in the trunk not to be fragmented. This...">MAX_TRUNK_MTU</a>;
<a name="l03738"></a>03738    <span class="keywordflow">else</span>
<a name="l03739"></a>03739       mtuv = atoi(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l03740"></a>03740 
<a name="l03741"></a>03741    <span class="keywordflow">if</span> (mtuv == 0) {
<a name="l03742"></a>03742       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Trunk MTU control disabled (mtu was %d)\n&quot;</span>, global_max_trunk_mtu); 
<a name="l03743"></a>03743       global_max_trunk_mtu = 0; 
<a name="l03744"></a>03744       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>; 
<a name="l03745"></a>03745    }
<a name="l03746"></a>03746    <span class="keywordflow">if</span> (mtuv &lt; 172 || mtuv &gt; 4000) {
<a name="l03747"></a>03747       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Trunk MTU must be between 172 and 4000\n&quot;</span>); 
<a name="l03748"></a>03748       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>; 
<a name="l03749"></a>03749    }
<a name="l03750"></a>03750    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Trunk MTU changed from %d to %d\n&quot;</span>, global_max_trunk_mtu, mtuv); 
<a name="l03751"></a>03751    global_max_trunk_mtu = mtuv; 
<a name="l03752"></a>03752    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03753"></a>03753 }
<a name="l03754"></a>03754 
<a name="l03755"></a><a class="code" href="chan__iax2_8c.html#ac3ef173addda138f303206465b851614">03755</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#ac3ef173addda138f303206465b851614">handle_cli_iax2_show_cache</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l03756"></a>03756 {
<a name="l03757"></a>03757    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l03758"></a>03758    <span class="keywordtype">char</span> tmp[1024], *pc = NULL;
<a name="l03759"></a>03759    <span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, x, y;
<a name="l03760"></a>03760    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03761"></a>03761 
<a name="l03762"></a>03762    <span class="keywordflow">switch</span> (cmd) {
<a name="l03763"></a>03763    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l03764"></a>03764       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show cache&quot;</span>;
<a name="l03765"></a>03765       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l03766"></a>03766          <span class="stringliteral">&quot;Usage: iax2 show cache\n&quot;</span>
<a name="l03767"></a>03767          <span class="stringliteral">&quot;       Display currently cached IAX Dialplan results.\n&quot;</span>;
<a name="l03768"></a>03768       <span class="keywordflow">return</span> NULL;
<a name="l03769"></a>03769    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l03770"></a>03770       <span class="keywordflow">return</span> NULL;
<a name="l03771"></a>03771    }
<a name="l03772"></a>03772 
<a name="l03773"></a>03773    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l03774"></a>03774 
<a name="l03775"></a>03775    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-20.20s %-12.12s %-9.9s %-8.8s %s\n&quot;</span>, <span class="stringliteral">&quot;Peer/Context&quot;</span>, <span class="stringliteral">&quot;Exten&quot;</span>, <span class="stringliteral">&quot;Exp.&quot;</span>, <span class="stringliteral">&quot;Wait.&quot;</span>, <span class="stringliteral">&quot;Flags&quot;</span>);
<a name="l03776"></a>03776 
<a name="l03777"></a>03777    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;dpcache, dp, cache_list) {
<a name="l03778"></a>03778       s = dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a>.tv_sec - now.tv_sec;
<a name="l03779"></a>03779       tmp[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03780"></a>03780       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a237ba33c07f39880a6da1134630be695">CACHE_FLAG_EXISTS</a>)
<a name="l03781"></a>03781          strncat(tmp, <span class="stringliteral">&quot;EXISTS|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03782"></a>03782       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493adfc168b6cdf09223dad610c65b04c19e">CACHE_FLAG_NONEXISTENT</a>)
<a name="l03783"></a>03783          strncat(tmp, <span class="stringliteral">&quot;NONEXISTENT|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03784"></a>03784       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a9cc184231f4419e681d6de9ca43df81a">CACHE_FLAG_CANEXIST</a>)
<a name="l03785"></a>03785          strncat(tmp, <span class="stringliteral">&quot;CANEXIST|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03786"></a>03786       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>)
<a name="l03787"></a>03787          strncat(tmp, <span class="stringliteral">&quot;PENDING|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03788"></a>03788       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a049a9a889bef0328a9a726036fc45aac">CACHE_FLAG_TIMEOUT</a>)
<a name="l03789"></a>03789          strncat(tmp, <span class="stringliteral">&quot;TIMEOUT|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03790"></a>03790       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493af75a0829e95bf2ea13767b29d505a5ed">CACHE_FLAG_TRANSMITTED</a>)
<a name="l03791"></a>03791          strncat(tmp, <span class="stringliteral">&quot;TRANSMITTED|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03792"></a>03792       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a497c2d7c7e5e120d0f497fac309d65c5">CACHE_FLAG_MATCHMORE</a>)
<a name="l03793"></a>03793          strncat(tmp, <span class="stringliteral">&quot;MATCHMORE|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03794"></a>03794       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a354d01072cc821460370e437dbca151e">CACHE_FLAG_UNKNOWN</a>)
<a name="l03795"></a>03795          strncat(tmp, <span class="stringliteral">&quot;UNKNOWN|&quot;</span>, <span class="keyword">sizeof</span>(tmp) - strlen(tmp) - 1);
<a name="l03796"></a>03796       <span class="comment">/* Trim trailing pipe */</span>
<a name="l03797"></a>03797       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tmp)) {
<a name="l03798"></a>03798          tmp[strlen(tmp) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03799"></a>03799       } <span class="keywordflow">else</span> {
<a name="l03800"></a>03800          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, <span class="stringliteral">&quot;(none)&quot;</span>, <span class="keyword">sizeof</span>(tmp));
<a name="l03801"></a>03801       }
<a name="l03802"></a>03802       y = 0;
<a name="l03803"></a>03803       pc = strchr(dp-&gt;<a class="code" href="structiax2__dpcache.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>, <span class="charliteral">&apos;@&apos;</span>);
<a name="l03804"></a>03804       <span class="keywordflow">if</span> (!pc) {
<a name="l03805"></a>03805          pc = dp-&gt;<a class="code" href="structiax2__dpcache.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>;
<a name="l03806"></a>03806       } <span class="keywordflow">else</span> {
<a name="l03807"></a>03807          pc++;
<a name="l03808"></a>03808       }
<a name="l03809"></a>03809       <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>); x++) {
<a name="l03810"></a>03810          <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] &gt; -1)
<a name="l03811"></a>03811             y++;
<a name="l03812"></a>03812       }
<a name="l03813"></a>03813       <span class="keywordflow">if</span> (s &gt; 0) {
<a name="l03814"></a>03814          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-20.20s %-12.12s %-9d %-8d %s\n&quot;</span>, pc, dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>, s, y, tmp);
<a name="l03815"></a>03815       } <span class="keywordflow">else</span> {
<a name="l03816"></a>03816          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-20.20s %-12.12s %-9.9s %-8d %s\n&quot;</span>, pc, dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;(expired)&quot;</span>, y, tmp);
<a name="l03817"></a>03817       }
<a name="l03818"></a>03818    }
<a name="l03819"></a>03819 
<a name="l03820"></a>03820    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l03821"></a>03821 
<a name="l03822"></a>03822    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l03823"></a>03823 }
<a name="l03824"></a>03824 
<a name="l03825"></a>03825 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ae844f334714a9ec860bf8b532af598a5">calc_rxstamp</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset);
<a name="l03826"></a>03826 
<a name="l03827"></a><a class="code" href="chan__iax2_8c.html#a200c60358d298a333db31d326116184e">03827</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a200c60358d298a333db31d326116184e">unwrap_timestamp</a>(<span class="keyword">struct</span> iax_frame *fr)
<a name="l03828"></a>03828 {
<a name="l03829"></a>03829    <span class="comment">/* Video mini frames only encode the lower 15 bits of the session</span>
<a name="l03830"></a>03830 <span class="comment">    * timestamp, but other frame types (e.g. audio) encode 16 bits. */</span>
<a name="l03831"></a>03831    <span class="keyword">const</span> <span class="keywordtype">int</span> ts_shift = (fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) ? 15 : 16;
<a name="l03832"></a>03832    <span class="keyword">const</span> <span class="keywordtype">int</span> lower_mask = (1 &lt;&lt; ts_shift) - 1;
<a name="l03833"></a>03833    <span class="keyword">const</span> <span class="keywordtype">int</span> upper_mask = ~lower_mask;
<a name="l03834"></a>03834    <span class="keyword">const</span> <span class="keywordtype">int</span> last_upper = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &amp; upper_mask;
<a name="l03835"></a>03835 
<a name="l03836"></a>03836    <span class="keywordflow">if</span> ( (fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> &amp; upper_mask) == last_upper ) {
<a name="l03837"></a>03837       <span class="keyword">const</span> <span class="keywordtype">int</span> x = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> - <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a>;
<a name="l03838"></a>03838       <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abf">threshold</a> = (ts_shift == 15) ? 25000 : 50000;
<a name="l03839"></a>03839 
<a name="l03840"></a>03840       <span class="keywordflow">if</span> (x &lt; -threshold) {
<a name="l03841"></a>03841          <span class="comment">/* Sudden big jump backwards in timestamp:</span>
<a name="l03842"></a>03842 <span class="comment">            What likely happened here is that miniframe timestamp has circled but we haven&apos;t</span>
<a name="l03843"></a>03843 <span class="comment">            gotten the update from the main packet.  We&apos;ll just pretend that we did, and</span>
<a name="l03844"></a>03844 <span class="comment">            update the timestamp appropriately. */</span>
<a name="l03845"></a>03845          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (last_upper + (1 &lt;&lt; ts_shift)) | (fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> &amp; lower_mask);
<a name="l03846"></a>03846          <span class="keywordflow">if</span> (iaxdebug)
<a name="l03847"></a>03847             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;schedule_delivery: pushed forward timestamp\n&quot;</span>);
<a name="l03848"></a>03848       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &gt; threshold) {
<a name="l03849"></a>03849          <span class="comment">/* Sudden apparent big jump forwards in timestamp:</span>
<a name="l03850"></a>03850 <span class="comment">            What&apos;s likely happened is this is an old miniframe belonging to the previous</span>
<a name="l03851"></a>03851 <span class="comment">            top 15 or 16-bit timestamp that has turned up out of order.</span>
<a name="l03852"></a>03852 <span class="comment">            Adjust the timestamp appropriately. */</span>
<a name="l03853"></a>03853          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (last_upper - (1 &lt;&lt; ts_shift)) | (fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> &amp; lower_mask);
<a name="l03854"></a>03854          <span class="keywordflow">if</span> (iaxdebug)
<a name="l03855"></a>03855             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;schedule_delivery: pushed back timestamp\n&quot;</span>);
<a name="l03856"></a>03856       }
<a name="l03857"></a>03857    }
<a name="l03858"></a>03858 }
<a name="l03859"></a>03859 
<a name="l03860"></a>03860 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9ec144aa2609cc2668656d29a43072d0">get_from_jb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *p);
<a name="l03861"></a>03861 
<a name="l03862"></a><a class="code" href="chan__iax2_8c.html#aa7b96752b1bad996fb9b9ffafecd2203">03862</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aa7b96752b1bad996fb9b9ffafecd2203">update_jbsched</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l03863"></a>03863 {
<a name="l03864"></a>03864    <span class="keywordtype">int</span> when;
<a name="l03865"></a>03865    
<a name="l03866"></a>03866    when = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>);
<a name="l03867"></a>03867    
<a name="l03868"></a>03868    when = <a class="code" href="jitterbuf_8h.html#a72883f3dc8328524ab3930122946e0a0" title="when is the next frame due out, in receiver&amp;#39;s time (0=EMPTY) This value may change...">jb_next</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>) - when;
<a name="l03869"></a>03869 
<a name="l03870"></a>03870    <span class="keywordflow">if</span> (when &lt;= 0) {
<a name="l03871"></a>03871       <span class="comment">/* XXX should really just empty until when &gt; 0.. */</span>
<a name="l03872"></a>03872       when = 1;
<a name="l03873"></a>03873    }
<a name="l03874"></a>03874    
<a name="l03875"></a>03875    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">jbid</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">jbid</a>, sched, when, <a class="code" href="chan__iax2_8c.html#a9ec144aa2609cc2668656d29a43072d0">get_from_jb</a>, 
<a name="l03876"></a>03876       <a class="code" href="chan__iax2_8c.html#a7510329b1cbee3d732b54d94586a975c">CALLNO_TO_PTR</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>));
<a name="l03877"></a>03877 }
<a name="l03878"></a>03878 
<a name="l03879"></a><a class="code" href="chan__iax2_8c.html#aaa2db4e3458cf3f7dd8686ee1f74ac1b">03879</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aaa2db4e3458cf3f7dd8686ee1f74ac1b">__get_from_jb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *p) 
<a name="l03880"></a>03880 {
<a name="l03881"></a>03881    <span class="keywordtype">int</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(p);
<a name="l03882"></a>03882    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = NULL;
<a name="l03883"></a>03883    <span class="keyword">struct </span>iax_frame *fr;
<a name="l03884"></a>03884    <a class="code" href="structjb__frame.html">jb_frame</a> frame;
<a name="l03885"></a>03885    <span class="keywordtype">int</span> ret;
<a name="l03886"></a>03886    <span class="keywordtype">long</span> ms;
<a name="l03887"></a>03887    <span class="keywordtype">long</span> next;
<a name="l03888"></a>03888    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03889"></a>03889    
<a name="l03890"></a>03890    <span class="comment">/* Make sure we have a valid private structure before going on */</span>
<a name="l03891"></a>03891    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l03892"></a>03892    pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l03893"></a>03893    <span class="keywordflow">if</span> (!pvt) {
<a name="l03894"></a>03894       <span class="comment">/* No go! */</span>
<a name="l03895"></a>03895       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l03896"></a>03896       <span class="keywordflow">return</span>;
<a name="l03897"></a>03897    }
<a name="l03898"></a>03898 
<a name="l03899"></a>03899    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">jbid</a> = -1;
<a name="l03900"></a>03900    
<a name="l03901"></a>03901    <span class="comment">/* round up a millisecond since ast_sched_runq does; */</span>
<a name="l03902"></a>03902    <span class="comment">/* prevents us from spinning while waiting for our now */</span>
<a name="l03903"></a>03903    <span class="comment">/* to catch up with runq&apos;s now */</span>
<a name="l03904"></a>03904    now.tv_usec += 1000;
<a name="l03905"></a>03905    
<a name="l03906"></a>03906    ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(now, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>);
<a name="l03907"></a>03907    
<a name="l03908"></a>03908    <span class="keywordflow">if</span>(ms &gt;= (next = <a class="code" href="jitterbuf_8h.html#a72883f3dc8328524ab3930122946e0a0" title="when is the next frame due out, in receiver&amp;#39;s time (0=EMPTY) This value may change...">jb_next</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>))) {
<a name="l03909"></a>03909       ret = <a class="code" href="jitterbuf_8h.html#a37158045e8af38a69ab6d15ee51dc08e" title="get a frame for time now (receiver&amp;#39;s time) return value is one of JB_OK: You&amp;#39;ve...">jb_get</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>,&amp;frame,ms,<a class="code" href="frame_8h.html#ab4d67e0c5a553f7796d59ccbbad33510" title="Gets duration in ms of interpolation frame for a format.">ast_codec_interp_len</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a>));
<a name="l03910"></a>03910       <span class="keywordflow">switch</span>(ret) {
<a name="l03911"></a>03911       <span class="keywordflow">case</span> <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5abcbf2631f2f32ca1af2a49ff82bebaec">JB_OK</a>:
<a name="l03912"></a>03912          fr = frame.<a class="code" href="structjb__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l03913"></a>03913          <a class="code" href="chan__iax2_8c.html#a8bda1d4286cae9030f7d25071627e32d">__do_deliver</a>(fr);
<a name="l03914"></a>03914          <span class="comment">/* __do_deliver() can cause the call to disappear */</span>
<a name="l03915"></a>03915          pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l03916"></a>03916          <span class="keywordflow">break</span>;
<a name="l03917"></a>03917       <span class="keywordflow">case</span> <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5abaf74218828771bc4c562a6594dd218e">JB_INTERP</a>:
<a name="l03918"></a>03918       {
<a name="l03919"></a>03919          <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> af = { 0, };
<a name="l03920"></a>03920          
<a name="l03921"></a>03921          <span class="comment">/* create an interpolation frame */</span>
<a name="l03922"></a>03922          af.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l03923"></a>03923          af.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a>;
<a name="l03924"></a>03924          af.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>  = frame.<a class="code" href="structjb__frame.html#a035c5e34bb570292ece2908966467b0f">ms</a> * (<a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a>) / 1000);
<a name="l03925"></a>03925          af.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a>  = <span class="stringliteral">&quot;IAX2 JB interpolation&quot;</span>;
<a name="l03926"></a>03926          af.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(next, 1000));
<a name="l03927"></a>03927          af.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l03928"></a>03928          
<a name="l03929"></a>03929          <span class="comment">/* queue the frame:  For consistency, we would call __do_deliver here, but __do_deliver wants an iax_frame,</span>
<a name="l03930"></a>03930 <span class="comment">          * which we&apos;d need to malloc, and then it would free it.  That seems like a drag */</span>
<a name="l03931"></a>03931          <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>)) {
<a name="l03932"></a>03932             <a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f" title="Queue a frame to a call&amp;#39;s owning asterisk channel.">iax2_queue_frame</a>(callno, &amp;af);
<a name="l03933"></a>03933             <span class="comment">/* iax2_queue_frame() could cause the call to disappear */</span>
<a name="l03934"></a>03934             pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l03935"></a>03935          }
<a name="l03936"></a>03936       }
<a name="l03937"></a>03937          <span class="keywordflow">break</span>;
<a name="l03938"></a>03938       <span class="keywordflow">case</span> <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5a5807660dd8eaef6bea3e3347a91c93a6">JB_DROP</a>:
<a name="l03939"></a>03939          <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(frame.<a class="code" href="structjb__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l03940"></a>03940          <span class="keywordflow">break</span>;
<a name="l03941"></a>03941       <span class="keywordflow">case</span> <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5ab70c5579075588aaade78deb3800c0a9">JB_NOFRAME</a>:
<a name="l03942"></a>03942       <span class="keywordflow">case</span> <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5a0abf1d52696752de6c37e8f57396f4a5">JB_EMPTY</a>:
<a name="l03943"></a>03943          <span class="comment">/* do nothing */</span>
<a name="l03944"></a>03944          <span class="keywordflow">break</span>;
<a name="l03945"></a>03945       <span class="keywordflow">default</span>:
<a name="l03946"></a>03946          <span class="comment">/* shouldn&apos;t happen */</span>
<a name="l03947"></a>03947          <span class="keywordflow">break</span>;
<a name="l03948"></a>03948       }
<a name="l03949"></a>03949    }
<a name="l03950"></a>03950    <span class="keywordflow">if</span> (pvt)
<a name="l03951"></a>03951       <a class="code" href="chan__iax2_8c.html#aa7b96752b1bad996fb9b9ffafecd2203">update_jbsched</a>(pvt);
<a name="l03952"></a>03952    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l03953"></a>03953 }
<a name="l03954"></a>03954 
<a name="l03955"></a><a class="code" href="chan__iax2_8c.html#a9ec144aa2609cc2668656d29a43072d0">03955</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9ec144aa2609cc2668656d29a43072d0">get_from_jb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l03956"></a>03956 {
<a name="l03957"></a>03957 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l03958"></a>03958 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#aaa2db4e3458cf3f7dd8686ee1f74ac1b">__get_from_jb</a>, data))
<a name="l03959"></a>03959 <span class="preprocessor">#endif      </span>
<a name="l03960"></a>03960 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#aaa2db4e3458cf3f7dd8686ee1f74ac1b">__get_from_jb</a>(data);
<a name="l03961"></a>03961    <span class="keywordflow">return</span> 0;
<a name="l03962"></a>03962 }
<a name="l03963"></a>03963 <span class="comment"></span>
<a name="l03964"></a>03964 <span class="comment">/*!</span>
<a name="l03965"></a>03965 <span class="comment"> * \note This function assumes fr-&gt;callno is locked</span>
<a name="l03966"></a>03966 <span class="comment"> *</span>
<a name="l03967"></a>03967 <span class="comment"> * \note IMPORTANT NOTE!!! Any time this function is used, even if iaxs[callno]</span>
<a name="l03968"></a>03968 <span class="comment"> * was valid before calling it, it may no longer be valid after calling it.</span>
<a name="l03969"></a>03969 <span class="comment"> */</span>
<a name="l03970"></a><a class="code" href="chan__iax2_8c.html#a3ec86bd0172f439ef6e7a00cb5f1b699">03970</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3ec86bd0172f439ef6e7a00cb5f1b699">schedule_delivery</a>(<span class="keyword">struct</span> iax_frame *fr, <span class="keywordtype">int</span> updatehistory, <span class="keywordtype">int</span> fromtrunk, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *tsout)
<a name="l03971"></a>03971 {
<a name="l03972"></a>03972    <span class="keywordtype">int</span> type, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l03973"></a>03973    <span class="keywordtype">int</span> ret;
<a name="l03974"></a>03974    <span class="keywordtype">int</span> needfree = 0;
<a name="l03975"></a>03975    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *owner = NULL;
<a name="l03976"></a>03976    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__channel.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a> = NULL;
<a name="l03977"></a>03977    
<a name="l03978"></a>03978    <span class="comment">/* Attempt to recover wrapped timestamps */</span>
<a name="l03979"></a>03979    <a class="code" href="chan__iax2_8c.html#a200c60358d298a333db31d326116184e">unwrap_timestamp</a>(fr);
<a name="l03980"></a>03980 
<a name="l03981"></a>03981    <span class="comment">/* delivery time is sender&apos;s sent timestamp converted back into absolute time according to our clock */</span>
<a name="l03982"></a>03982    <span class="keywordflow">if</span> ( !fromtrunk &amp;&amp; !<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>))
<a name="l03983"></a>03983       fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, 1000));
<a name="l03984"></a>03984    <span class="keywordflow">else</span> {
<a name="l03985"></a>03985 <span class="preprocessor">#if 0</span>
<a name="l03986"></a>03986 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;schedule_delivery: set delivery to 0 as we don&apos;t have an rxcore yet, or frame is from trunk.\n&quot;</span>);
<a name="l03987"></a>03987 <span class="preprocessor">#endif</span>
<a name="l03988"></a>03988 <span class="preprocessor"></span>      fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a> = <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0,0);
<a name="l03989"></a>03989    }
<a name="l03990"></a>03990 
<a name="l03991"></a>03991    type = <a class="code" href="jitterbuf_8h.html#a7e72da000f982634fda8319b82db8de5a50fcc4e23186d417f90aa3f8582c70eb">JB_TYPE_CONTROL</a>;
<a name="l03992"></a>03992    len = 0;
<a name="l03993"></a>03993 
<a name="l03994"></a>03994    <span class="keywordflow">if</span>(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l03995"></a>03995       type = <a class="code" href="jitterbuf_8h.html#a7e72da000f982634fda8319b82db8de5ad5dc59855a16913d9c6bdda89bb8ea31">JB_TYPE_VOICE</a>;
<a name="l03996"></a>03996       len = <a class="code" href="frame_8h.html#aedec72ae8357bb6c334111f93d283713" title="Returns the number of samples contained in the frame.">ast_codec_get_samples</a>(&amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>) / (<a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000);
<a name="l03997"></a>03997    } <span class="keywordflow">else</span> <span class="keywordflow">if</span>(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a8089c2a7198a1063db9e6c3f904482a4">AST_FRAME_CNG</a>) {
<a name="l03998"></a>03998       type = <a class="code" href="jitterbuf_8h.html#a7e72da000f982634fda8319b82db8de5ab7844afd5de9edf071e06de0c65b707b">JB_TYPE_SILENCE</a>;
<a name="l03999"></a>03999    }
<a name="l04000"></a>04000 
<a name="l04001"></a>04001    <span class="keywordflow">if</span> ( (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>)) ) {
<a name="l04002"></a>04002       <span class="keywordflow">if</span> (tsout)
<a name="l04003"></a>04003          *tsout = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l04004"></a>04004       <a class="code" href="chan__iax2_8c.html#a8bda1d4286cae9030f7d25071627e32d">__do_deliver</a>(fr);
<a name="l04005"></a>04005       <span class="keywordflow">return</span> -1;
<a name="l04006"></a>04006    }
<a name="l04007"></a>04007 
<a name="l04008"></a>04008    <span class="keywordflow">if</span> ((owner = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>))
<a name="l04009"></a>04009       bridge = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(owner);
<a name="l04010"></a>04010 
<a name="l04011"></a>04011    <span class="comment">/* if the user hasn&apos;t requested we force the use of the jitterbuffer, and we&apos;re bridged to</span>
<a name="l04012"></a>04012 <span class="comment">    * a channel that can accept jitter, then flush and suspend the jb, and send this frame straight through */</span>
<a name="l04013"></a>04013    <span class="keywordflow">if</span> ( (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>)) &amp;&amp; owner &amp;&amp; bridge &amp;&amp; (bridge-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a5f36febd4b26a025856e994a4e189a20">properties</a> &amp; <a class="code" href="channel_8h.html#a4f126a0a9b1d8c6a8f46a051ef8830bba54130226ec87f80c48ee98aa5cc9168c" title="Channels have this property if they can accept input with jitter; i.e. most VoIP...">AST_CHAN_TP_WANTSJITTER</a>) ) {
<a name="l04014"></a>04014       <a class="code" href="structjb__frame.html">jb_frame</a> frame;
<a name="l04015"></a>04015 
<a name="l04016"></a>04016       <span class="comment">/* deliver any frames in the jb */</span>
<a name="l04017"></a>04017       <span class="keywordflow">while</span> (<a class="code" href="jitterbuf_8h.html#aaca01cea1cbcba683ca6d5b0bc009666" title="unconditionally get frames from jitterbuf until empty">jb_getall</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>, &amp;frame) == <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5abcbf2631f2f32ca1af2a49ff82bebaec">JB_OK</a>) {
<a name="l04018"></a>04018          <a class="code" href="chan__iax2_8c.html#a8bda1d4286cae9030f7d25071627e32d">__do_deliver</a>(frame.<a class="code" href="structjb__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l04019"></a>04019          <span class="comment">/* __do_deliver() can make the call disappear */</span>
<a name="l04020"></a>04020          <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>])
<a name="l04021"></a>04021             <span class="keywordflow">return</span> -1;
<a name="l04022"></a>04022       }
<a name="l04023"></a>04023 
<a name="l04024"></a>04024       <a class="code" href="jitterbuf_8h.html#a2c9efa9222ff9d7324a06c4a21b5ef72" title="reset jitterbuf">jb_reset</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>);
<a name="l04025"></a>04025 
<a name="l04026"></a>04026       <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a78b3fb16c0d1e1de400d92ed7bed66ea">jbid</a>);
<a name="l04027"></a>04027 
<a name="l04028"></a>04028       <span class="comment">/* deliver this frame now */</span>
<a name="l04029"></a>04029       <span class="keywordflow">if</span> (tsout)
<a name="l04030"></a>04030          *tsout = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l04031"></a>04031       <a class="code" href="chan__iax2_8c.html#a8bda1d4286cae9030f7d25071627e32d">__do_deliver</a>(fr);
<a name="l04032"></a>04032       <span class="keywordflow">return</span> -1;
<a name="l04033"></a>04033    }
<a name="l04034"></a>04034 
<a name="l04035"></a>04035    <span class="comment">/* insert into jitterbuffer */</span>
<a name="l04036"></a>04036    <span class="comment">/* TODO: Perhaps we could act immediately if it&apos;s not droppable and late */</span>
<a name="l04037"></a>04037    ret = <a class="code" href="jitterbuf_8h.html#a68bbac088e27e18441bd5b403f7f31d7" title="queue a frame">jb_put</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>, fr, type, len, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>,
<a name="l04038"></a>04038          <a class="code" href="chan__iax2_8c.html#ae844f334714a9ec860bf8b532af598a5">calc_rxstamp</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>],fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>));
<a name="l04039"></a>04039    <span class="keywordflow">if</span> (ret == <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5a5807660dd8eaef6bea3e3347a91c93a6">JB_DROP</a>) {
<a name="l04040"></a>04040       needfree++;
<a name="l04041"></a>04041    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ret == <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5a3ef27a58ff51c815b4c27e94f65cfdd2">JB_SCHED</a>) {
<a name="l04042"></a>04042       <a class="code" href="chan__iax2_8c.html#aa7b96752b1bad996fb9b9ffafecd2203">update_jbsched</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l04043"></a>04043    }
<a name="l04044"></a>04044    <span class="keywordflow">if</span> (tsout)
<a name="l04045"></a>04045       *tsout = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l04046"></a>04046    <span class="keywordflow">if</span> (needfree) {
<a name="l04047"></a>04047       <span class="comment">/* Free our iax frame */</span>
<a name="l04048"></a>04048       <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(fr);
<a name="l04049"></a>04049       <span class="keywordflow">return</span> -1;
<a name="l04050"></a>04050    }
<a name="l04051"></a>04051    <span class="keywordflow">return</span> 0;
<a name="l04052"></a>04052 }
<a name="l04053"></a>04053 
<a name="l04054"></a><a class="code" href="chan__iax2_8c.html#a5e79c2133d1b794a5143e721d162996e">04054</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5e79c2133d1b794a5143e721d162996e">iax2_transmit</a>(<span class="keyword">struct</span> iax_frame *fr)
<a name="l04055"></a>04055 {
<a name="l04056"></a>04056    <span class="comment">/* Lock the queue and place this packet at the end */</span>
<a name="l04057"></a>04057    <span class="comment">/* By setting this to 0, the network thread will send it for us, and</span>
<a name="l04058"></a>04058 <span class="comment">      queue retransmission if necessary */</span>
<a name="l04059"></a>04059    fr-&gt;<a class="code" href="structiax__frame.html#a4915c10b7a168f5c7160d3a3b2ea198d">sentyet</a> = 0;
<a name="l04060"></a>04060    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l04061"></a>04061    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;frame_queue, fr, list);
<a name="l04062"></a>04062    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l04063"></a>04063    <span class="comment">/* Wake up the network and scheduler thread */</span>
<a name="l04064"></a>04064    <span class="keywordflow">if</span> (netthreadid != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l04065"></a>04065       pthread_kill(netthreadid, SIGURG);
<a name="l04066"></a>04066    <a class="code" href="sched_8h.html#ab523defdc0b36cdf629eb81b7b5a20d6" title="Force re-processing of the scheduler context.">ast_sched_thread_poke</a>(sched);
<a name="l04067"></a>04067    <span class="keywordflow">return</span> 0;
<a name="l04068"></a>04068 }
<a name="l04069"></a>04069 
<a name="l04070"></a>04070 
<a name="l04071"></a>04071 
<a name="l04072"></a><a class="code" href="chan__iax2_8c.html#a4ca36cb64d4c1e5e0c424f4bcd32fa5c">04072</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a4ca36cb64d4c1e5e0c424f4bcd32fa5c">iax2_digit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit)
<a name="l04073"></a>04073 {
<a name="l04074"></a>04074    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>), <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>, digit, 0, NULL, 0, -1);
<a name="l04075"></a>04075 }
<a name="l04076"></a>04076 
<a name="l04077"></a><a class="code" href="chan__iax2_8c.html#a34ff90ed6262326696cb6a0921fa6ffc">04077</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a34ff90ed6262326696cb6a0921fa6ffc">iax2_digit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> digit, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration)
<a name="l04078"></a>04078 {
<a name="l04079"></a>04079    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>), <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>, digit, 0, NULL, 0, -1);
<a name="l04080"></a>04080 }
<a name="l04081"></a>04081 
<a name="l04082"></a><a class="code" href="chan__iax2_8c.html#adc1d904d607d6a0bb579921639521f0a">04082</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#adc1d904d607d6a0bb579921639521f0a">iax2_sendtext</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__queue_8c.html#a5633b1433389cec21ade3811bbe9ca5b">text</a>)
<a name="l04083"></a>04083 {
<a name="l04084"></a>04084    
<a name="l04085"></a>04085    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>), <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>,
<a name="l04086"></a>04086       0, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)text, strlen(text) + 1, -1);
<a name="l04087"></a>04087 }
<a name="l04088"></a>04088 
<a name="l04089"></a><a class="code" href="chan__iax2_8c.html#a9ace36259de419f91e09676b34ad307d">04089</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9ace36259de419f91e09676b34ad307d">iax2_sendimage</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *img)
<a name="l04090"></a>04090 {
<a name="l04091"></a>04091    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>), <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a>, img-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, 0, img-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, img-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, -1);
<a name="l04092"></a>04092 }
<a name="l04093"></a>04093 
<a name="l04094"></a><a class="code" href="chan__iax2_8c.html#ac5ef709a0f3f7f07d5ea153393cd0b4f">04094</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac5ef709a0f3f7f07d5ea153393cd0b4f">iax2_sendhtml</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> subclass, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> datalen)
<a name="l04095"></a>04095 {
<a name="l04096"></a>04096    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>), <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a3d91bab33583f560197e21532a02a895">AST_FRAME_HTML</a>, subclass, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)data, datalen, -1);
<a name="l04097"></a>04097 }
<a name="l04098"></a>04098 
<a name="l04099"></a><a class="code" href="chan__iax2_8c.html#a3cd64402c0950d2f09e22986cf109e8c">04099</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3cd64402c0950d2f09e22986cf109e8c">iax2_fixup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *oldchannel, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *newchan)
<a name="l04100"></a>04100 {
<a name="l04101"></a>04101    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(newchan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l04102"></a>04102    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04103"></a>04103    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])
<a name="l04104"></a>04104       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = newchan;
<a name="l04105"></a>04105    <span class="keywordflow">else</span>
<a name="l04106"></a>04106       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Uh, this isn&apos;t a good sign...\n&quot;</span>);
<a name="l04107"></a>04107    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04108"></a>04108    <span class="keywordflow">return</span> 0;
<a name="l04109"></a>04109 }
<a name="l04110"></a>04110 <span class="comment"></span>
<a name="l04111"></a>04111 <span class="comment">/*!</span>
<a name="l04112"></a>04112 <span class="comment"> * \note This function calls reg_source_db -&gt; iax2_poke_peer -&gt; find_callno,</span>
<a name="l04113"></a>04113 <span class="comment"> *       so do not call this with a pvt lock held.</span>
<a name="l04114"></a>04114 <span class="comment"> */</span>
<a name="l04115"></a><a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">04115</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">realtime_peer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *peername, <span class="keyword">struct</span> sockaddr_in *sin)
<a name="l04116"></a>04116 {
<a name="l04117"></a>04117    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l04118"></a>04118    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tmp;
<a name="l04119"></a>04119    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer=NULL;
<a name="l04120"></a>04120    time_t regseconds = 0, nowtime;
<a name="l04121"></a>04121    <span class="keywordtype">int</span> dynamic=0;
<a name="l04122"></a>04122 
<a name="l04123"></a>04123    <span class="keywordflow">if</span> (peername) {
<a name="l04124"></a>04124       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, peername, <span class="stringliteral">&quot;host&quot;</span>, <span class="stringliteral">&quot;dynamic&quot;</span>, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04125"></a>04125       <span class="keywordflow">if</span> (!var &amp;&amp; sin)
<a name="l04126"></a>04126          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, peername, <span class="stringliteral">&quot;host&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04127"></a>04127    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sin) {
<a name="l04128"></a>04128       <span class="keywordtype">char</span> porta[25];
<a name="l04129"></a>04129       sprintf(porta, <span class="stringliteral">&quot;%d&quot;</span>, ntohs(sin-&gt;sin_port));
<a name="l04130"></a>04130       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>, <span class="stringliteral">&quot;ipaddr&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <span class="stringliteral">&quot;port&quot;</span>, porta, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04131"></a>04131       <span class="keywordflow">if</span> (var) {
<a name="l04132"></a>04132          <span class="comment">/* We&apos;ll need the peer name in order to build the structure! */</span>
<a name="l04133"></a>04133          <span class="keywordflow">for</span> (tmp = var; tmp; tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l04134"></a>04134             <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;name&quot;</span>))
<a name="l04135"></a>04135                peername = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l04136"></a>04136          }
<a name="l04137"></a>04137       }
<a name="l04138"></a>04138    }
<a name="l04139"></a>04139    <span class="keywordflow">if</span> (!var &amp;&amp; peername) { <span class="comment">/* Last ditch effort */</span>
<a name="l04140"></a>04140       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, peername, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);<span class="comment"></span>
<a name="l04141"></a>04141 <span class="comment">      /*!\note</span>
<a name="l04142"></a>04142 <span class="comment">       * If this one loaded something, then we need to ensure that the host</span>
<a name="l04143"></a>04143 <span class="comment">       * field matched.  The only reason why we can&apos;t have this as a criteria</span>
<a name="l04144"></a>04144 <span class="comment">       * is because we only have the IP address and the host field might be</span>
<a name="l04145"></a>04145 <span class="comment">       * set as a name (and the reverse PTR might not match).</span>
<a name="l04146"></a>04146 <span class="comment">       */</span>
<a name="l04147"></a>04147       <span class="keywordflow">if</span> (var &amp;&amp; sin) {
<a name="l04148"></a>04148          <span class="keywordflow">for</span> (tmp = var; tmp; tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l04149"></a>04149             <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;host&quot;</span>)) {
<a name="l04150"></a>04150                <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l04151"></a>04151                <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l04152"></a>04152                <span class="keywordflow">if</span> (!(hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;ahp)) || (memcmp(hp-&gt;h_addr, &amp;sin-&gt;sin_addr, <span class="keyword">sizeof</span>(hp-&gt;h_addr)))) {
<a name="l04153"></a>04153                   <span class="comment">/* No match */</span>
<a name="l04154"></a>04154                   <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l04155"></a>04155                   var = NULL;
<a name="l04156"></a>04156                }
<a name="l04157"></a>04157                <span class="keywordflow">break</span>;
<a name="l04158"></a>04158             }
<a name="l04159"></a>04159          }
<a name="l04160"></a>04160       }
<a name="l04161"></a>04161    }
<a name="l04162"></a>04162    <span class="keywordflow">if</span> (!var)
<a name="l04163"></a>04163       <span class="keywordflow">return</span> NULL;
<a name="l04164"></a>04164 
<a name="l04165"></a>04165    peer = <a class="code" href="chan__iax2_8c.html#a49e3974d5f7880c5ec01eb631bb4062b" title="Create peer structure based on configuration.">build_peer</a>(peername, var, NULL, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>) ? 0 : 1);
<a name="l04166"></a>04166    
<a name="l04167"></a>04167    <span class="keywordflow">if</span> (!peer) {
<a name="l04168"></a>04168       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l04169"></a>04169       <span class="keywordflow">return</span> NULL;
<a name="l04170"></a>04170    }
<a name="l04171"></a>04171 
<a name="l04172"></a>04172    <span class="keywordflow">for</span> (tmp = var; tmp; tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l04173"></a>04173       <span class="comment">/* Make sure it&apos;s not a user only... */</span>
<a name="l04174"></a>04174       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;type&quot;</span>)) {
<a name="l04175"></a>04175          <span class="keywordflow">if</span> (strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;friend&quot;</span>) &amp;&amp;
<a name="l04176"></a>04176              strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;peer&quot;</span>)) {
<a name="l04177"></a>04177             <span class="comment">/* Whoops, we weren&apos;t supposed to exist! */</span>
<a name="l04178"></a>04178             peer = <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l04179"></a>04179             <span class="keywordflow">break</span>;
<a name="l04180"></a>04180          } 
<a name="l04181"></a>04181       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;regseconds&quot;</span>)) {
<a name="l04182"></a>04182          <a class="code" href="strings_8h.html#a3b5457e5f5679935093d94b0f788769e" title="get values from config variables.">ast_get_time_t</a>(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;regseconds, 0, NULL);
<a name="l04183"></a>04183       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;ipaddr&quot;</span>)) {
<a name="l04184"></a>04184          inet_aton(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr));
<a name="l04185"></a>04185       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;port&quot;</span>)) {
<a name="l04186"></a>04186          peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = htons(atoi(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));
<a name="l04187"></a>04187       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;host&quot;</span>)) {
<a name="l04188"></a>04188          <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;dynamic&quot;</span>))
<a name="l04189"></a>04189             dynamic = 1;
<a name="l04190"></a>04190       }
<a name="l04191"></a>04191    }
<a name="l04192"></a>04192 
<a name="l04193"></a>04193    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l04194"></a>04194 
<a name="l04195"></a>04195    <span class="keywordflow">if</span> (!peer)
<a name="l04196"></a>04196       <span class="keywordflow">return</span> NULL;
<a name="l04197"></a>04197 
<a name="l04198"></a>04198    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)) {
<a name="l04199"></a>04199       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(peer, &amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>);
<a name="l04200"></a>04200       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a>)) {
<a name="l04201"></a>04201          <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> &gt; -1) {
<a name="l04202"></a>04202             <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>)) {
<a name="l04203"></a>04203                peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l04204"></a>04204                <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l04205"></a>04205             }
<a name="l04206"></a>04206          }
<a name="l04207"></a>04207          peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, (global_rtautoclear) * 1000, <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l04208"></a>04208          <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> == -1)
<a name="l04209"></a>04209             <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l04210"></a>04210       }
<a name="l04211"></a>04211       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(peers, peer);
<a name="l04212"></a>04212       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>))
<a name="l04213"></a>04213          <a class="code" href="chan__iax2_8c.html#a53f291d9224d73701f3a2a097d2457a7">reg_source_db</a>(peer);
<a name="l04214"></a>04214    } <span class="keywordflow">else</span> {
<a name="l04215"></a>04215       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>);   
<a name="l04216"></a>04216    }
<a name="l04217"></a>04217 
<a name="l04218"></a>04218    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab6a1016b2b84bd5d410a1a9d6994deb1">IAX_RTIGNOREREGEXPIRE</a>) &amp;&amp; dynamic) {
<a name="l04219"></a>04219       time(&amp;nowtime);
<a name="l04220"></a>04220       <span class="keywordflow">if</span> ((nowtime - regseconds) &gt; <a class="code" href="iax2_8h.html#a5fc5c0b246090e6ebf9245897d979e21">IAX_DEFAULT_REG_EXPIRE</a>) {
<a name="l04221"></a>04221          memset(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, 0, <span class="keyword">sizeof</span>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l04222"></a>04222          <a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">realtime_update_peer</a>(peer-&gt;name, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, 0);
<a name="l04223"></a>04223          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;realtime_peer: Bah, &apos;%s&apos; is expired (%d/%d/%d)!\n&quot;</span>,
<a name="l04224"></a>04224             peername, (<span class="keywordtype">int</span>)(nowtime - regseconds), (<span class="keywordtype">int</span>)regseconds, (<span class="keywordtype">int</span>)nowtime);
<a name="l04225"></a>04225       }
<a name="l04226"></a>04226       <span class="keywordflow">else</span> {
<a name="l04227"></a>04227          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;realtime_peer: Registration for &apos;%s&apos; still active (%d/%d/%d)!\n&quot;</span>,
<a name="l04228"></a>04228             peername, (<span class="keywordtype">int</span>)(nowtime - regseconds), (<span class="keywordtype">int</span>)regseconds, (<span class="keywordtype">int</span>)nowtime);
<a name="l04229"></a>04229       }
<a name="l04230"></a>04230    }
<a name="l04231"></a>04231 
<a name="l04232"></a>04232    <span class="keywordflow">return</span> peer;
<a name="l04233"></a>04233 }
<a name="l04234"></a>04234 
<a name="l04235"></a><a class="code" href="chan__iax2_8c.html#afb25e20b1fe40ed319996fdd9c289085">04235</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#afb25e20b1fe40ed319996fdd9c289085">realtime_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *username, <span class="keyword">struct</span> sockaddr_in *sin)
<a name="l04236"></a>04236 {
<a name="l04237"></a>04237    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l04238"></a>04238    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tmp;
<a name="l04239"></a>04239    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>=NULL;
<a name="l04240"></a>04240 
<a name="l04241"></a>04241    var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxusers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, username, <span class="stringliteral">&quot;host&quot;</span>, <span class="stringliteral">&quot;dynamic&quot;</span>, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04242"></a>04242    <span class="keywordflow">if</span> (!var)
<a name="l04243"></a>04243       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxusers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, username, <span class="stringliteral">&quot;host&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04244"></a>04244    <span class="keywordflow">if</span> (!var &amp;&amp; sin) {
<a name="l04245"></a>04245       <span class="keywordtype">char</span> porta[6];
<a name="l04246"></a>04246       snprintf(porta, <span class="keyword">sizeof</span>(porta), <span class="stringliteral">&quot;%d&quot;</span>, ntohs(sin-&gt;sin_port));
<a name="l04247"></a>04247       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxusers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, username, <span class="stringliteral">&quot;ipaddr&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <span class="stringliteral">&quot;port&quot;</span>, porta, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04248"></a>04248       <span class="keywordflow">if</span> (!var)
<a name="l04249"></a>04249          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxusers&quot;</span>, <span class="stringliteral">&quot;ipaddr&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <span class="stringliteral">&quot;port&quot;</span>, porta, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04250"></a>04250    }
<a name="l04251"></a>04251    <span class="keywordflow">if</span> (!var) { <span class="comment">/* Last ditch effort */</span>
<a name="l04252"></a>04252       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;iaxusers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, username, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);<span class="comment"></span>
<a name="l04253"></a>04253 <span class="comment">      /*!\note</span>
<a name="l04254"></a>04254 <span class="comment">       * If this one loaded something, then we need to ensure that the host</span>
<a name="l04255"></a>04255 <span class="comment">       * field matched.  The only reason why we can&apos;t have this as a criteria</span>
<a name="l04256"></a>04256 <span class="comment">       * is because we only have the IP address and the host field might be</span>
<a name="l04257"></a>04257 <span class="comment">       * set as a name (and the reverse PTR might not match).</span>
<a name="l04258"></a>04258 <span class="comment">       */</span>
<a name="l04259"></a>04259       <span class="keywordflow">if</span> (var) {
<a name="l04260"></a>04260          <span class="keywordflow">for</span> (tmp = var; tmp; tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l04261"></a>04261             <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;host&quot;</span>)) {
<a name="l04262"></a>04262                <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l04263"></a>04263                <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l04264"></a>04264                <span class="keywordflow">if</span> (!(hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;ahp)) || (memcmp(hp-&gt;h_addr, &amp;sin-&gt;sin_addr, <span class="keyword">sizeof</span>(hp-&gt;h_addr)))) {
<a name="l04265"></a>04265                   <span class="comment">/* No match */</span>
<a name="l04266"></a>04266                   <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l04267"></a>04267                   var = NULL;
<a name="l04268"></a>04268                }
<a name="l04269"></a>04269                <span class="keywordflow">break</span>;
<a name="l04270"></a>04270             }
<a name="l04271"></a>04271          }
<a name="l04272"></a>04272       }
<a name="l04273"></a>04273    }
<a name="l04274"></a>04274    <span class="keywordflow">if</span> (!var)
<a name="l04275"></a>04275       <span class="keywordflow">return</span> NULL;
<a name="l04276"></a>04276 
<a name="l04277"></a>04277    tmp = var;
<a name="l04278"></a>04278    <span class="keywordflow">while</span>(tmp) {
<a name="l04279"></a>04279       <span class="comment">/* Make sure it&apos;s not a peer only... */</span>
<a name="l04280"></a>04280       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;type&quot;</span>)) {
<a name="l04281"></a>04281          <span class="keywordflow">if</span> (strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;friend&quot;</span>) &amp;&amp;
<a name="l04282"></a>04282              strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;user&quot;</span>)) {
<a name="l04283"></a>04283             <span class="keywordflow">return</span> NULL;
<a name="l04284"></a>04284          } 
<a name="l04285"></a>04285       }
<a name="l04286"></a>04286       tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l04287"></a>04287    }
<a name="l04288"></a>04288 
<a name="l04289"></a>04289    user = <a class="code" href="chan__iax2_8c.html#a4ce55a34cd5160db030be4355f7b4386" title="Create in-memory user structure from configuration.">build_user</a>(username, var, NULL, !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>));
<a name="l04290"></a>04290 
<a name="l04291"></a>04291    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l04292"></a>04292 
<a name="l04293"></a>04293    <span class="keywordflow">if</span> (!user)
<a name="l04294"></a>04294       <span class="keywordflow">return</span> NULL;
<a name="l04295"></a>04295 
<a name="l04296"></a>04296    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)) {
<a name="l04297"></a>04297       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>);
<a name="l04298"></a>04298       <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(users, user);
<a name="l04299"></a>04299    } <span class="keywordflow">else</span> {
<a name="l04300"></a>04300       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>);   
<a name="l04301"></a>04301    }
<a name="l04302"></a>04302 
<a name="l04303"></a>04303    <span class="keywordflow">return</span> user;
<a name="l04304"></a>04304 }
<a name="l04305"></a>04305 
<a name="l04306"></a><a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">04306</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">realtime_update_peer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *peername, <span class="keyword">struct</span> sockaddr_in *sin, time_t regtime)
<a name="l04307"></a>04307 {
<a name="l04308"></a>04308    <span class="keywordtype">char</span> port[10];
<a name="l04309"></a>04309    <span class="keywordtype">char</span> regseconds[20];
<a name="l04310"></a>04310    
<a name="l04311"></a>04311    snprintf(regseconds, <span class="keyword">sizeof</span>(regseconds), <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>)regtime);
<a name="l04312"></a>04312    snprintf(port, <span class="keyword">sizeof</span>(port), <span class="stringliteral">&quot;%d&quot;</span>, ntohs(sin-&gt;sin_port));
<a name="l04313"></a>04313    <a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, peername, 
<a name="l04314"></a>04314       <span class="stringliteral">&quot;ipaddr&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <span class="stringliteral">&quot;port&quot;</span>, port, 
<a name="l04315"></a>04315       <span class="stringliteral">&quot;regseconds&quot;</span>, regseconds, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l04316"></a>04316 }
<a name="l04317"></a>04317 
<a name="l04318"></a><a class="code" href="structcreate__addr__info.html">04318</a> <span class="keyword">struct </span><a class="code" href="structcreate__addr__info.html">create_addr_info</a> {
<a name="l04319"></a><a class="code" href="structcreate__addr__info.html#afa05b14ff7f76f303c784c00c4c63fa7">04319</a>    <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l04320"></a><a class="code" href="structcreate__addr__info.html#ac92588540e8c1d014a08cd8a45462b19">04320</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags;
<a name="l04321"></a><a class="code" href="structcreate__addr__info.html#a511d77bac179514b149c432cba8a920a">04321</a>    <span class="keywordtype">int</span> maxtime;
<a name="l04322"></a><a class="code" href="structcreate__addr__info.html#a966563ffc5ca23f7611c17140b9cb8e9">04322</a>    <span class="keywordtype">int</span> encmethods;
<a name="l04323"></a><a class="code" href="structcreate__addr__info.html#ac6c6cd839d50c91230f55ed55d0cd635">04323</a>    <span class="keywordtype">int</span> found;
<a name="l04324"></a><a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">04324</a>    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>;
<a name="l04325"></a><a class="code" href="structcreate__addr__info.html#a61fbadf21e15a109d0703a01e0302535">04325</a>    <span class="keywordtype">int</span> adsi;
<a name="l04326"></a><a class="code" href="structcreate__addr__info.html#a60b121e87a5e71fe64bae70e1721ac3c">04326</a>    <span class="keywordtype">char</span> username[80];
<a name="l04327"></a><a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">04327</a>    <span class="keywordtype">char</span> <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>[80];
<a name="l04328"></a><a class="code" href="structcreate__addr__info.html#a0ac6dcfff533378dbcf9a01b59617d36">04328</a>    <span class="keywordtype">char</span> outkey[80];
<a name="l04329"></a><a class="code" href="structcreate__addr__info.html#aad16c37028f0efbc3cf8c9186b770ab8">04329</a>    <span class="keywordtype">char</span> timezone[80];
<a name="l04330"></a><a class="code" href="structcreate__addr__info.html#a69d5008fc4ec5470304bd1e4f8450e35">04330</a>    <span class="keywordtype">char</span> <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>[32];
<a name="l04331"></a><a class="code" href="structcreate__addr__info.html#ac25ea00ee3f082df06e0cf468cbde240">04331</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];
<a name="l04332"></a><a class="code" href="structcreate__addr__info.html#ac95e38343e3ce6cbca0a07c0d38c093a">04332</a>    <span class="keywordtype">char</span> peercontext[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];
<a name="l04333"></a><a class="code" href="structcreate__addr__info.html#af689da2b77d1265192a78a5b0994a1d5">04333</a>    <span class="keywordtype">char</span> mohinterpret[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>];
<a name="l04334"></a><a class="code" href="structcreate__addr__info.html#aec4e201113703e94cd365aaa6dabd4f0">04334</a>    <span class="keywordtype">char</span> mohsuggest[<a class="code" href="channel_8h.html#afb2ae2e53d6676f3ca44a98aa3f92a2c">MAX_MUSICCLASS</a>];
<a name="l04335"></a>04335 };
<a name="l04336"></a>04336 
<a name="l04337"></a><a class="code" href="chan__iax2_8c.html#a718ce50d45da77b324047f3d9ceb6749">04337</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a718ce50d45da77b324047f3d9ceb6749">create_addr</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *peername, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structcreate__addr__info.html">create_addr_info</a> *cai)
<a name="l04338"></a>04338 {
<a name="l04339"></a>04339    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l04340"></a>04340    <span class="keywordtype">int</span> res = -1;
<a name="l04341"></a>04341    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> ourprefs;
<a name="l04342"></a>04342 
<a name="l04343"></a>04343    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(cai, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">IAX_SENDANI</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);
<a name="l04344"></a>04344    cai-&gt;<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = defaultsockfd;
<a name="l04345"></a>04345    cai-&gt;<a class="code" href="structcreate__addr__info.html#a511d77bac179514b149c432cba8a920a">maxtime</a> = 0;
<a name="l04346"></a>04346    sin-&gt;sin_family = AF_INET;
<a name="l04347"></a>04347 
<a name="l04348"></a>04348    <span class="keywordflow">if</span> (!(peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(peername, 1))) {
<a name="l04349"></a>04349       cai-&gt;<a class="code" href="structcreate__addr__info.html#ac6c6cd839d50c91230f55ed55d0cd635">found</a> = 0;
<a name="l04350"></a>04350       <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#afab7a25fb37c7e1a0dedef9c286a44a1">ast_get_ip_or_srv</a>(sin, peername, srvlookup ? <span class="stringliteral">&quot;_iax._udp&quot;</span> : NULL)) {
<a name="l04351"></a>04351          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such host: %s\n&quot;</span>, peername);
<a name="l04352"></a>04352          <span class="keywordflow">return</span> -1;
<a name="l04353"></a>04353       }
<a name="l04354"></a>04354       sin-&gt;sin_port = htons(<a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>);
<a name="l04355"></a>04355       <span class="comment">/* use global iax prefs for unknown peer/user */</span>
<a name="l04356"></a>04356       <span class="comment">/* But move the calling channel&apos;s native codec to the top of the preference list */</span>
<a name="l04357"></a>04357       memcpy(&amp;ourprefs, &amp;<a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, <span class="keyword">sizeof</span>(ourprefs));
<a name="l04358"></a>04358       <span class="keywordflow">if</span> (c)
<a name="l04359"></a>04359          <a class="code" href="frame_8h.html#a5eb17ccec8892ebe96ab661e749f0399" title="Prepend an audio codec to a preference list, removing it first if it was already...">ast_codec_pref_prepend</a>(&amp;ourprefs, c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, 1);
<a name="l04360"></a>04360       <a class="code" href="frame_8h.html#a42cc334b6773ff33cb3c24ca5a916842" title="Shift an audio codec preference list up or down 65 bytes so that it becomes an ASCII...">ast_codec_pref_convert</a>(&amp;ourprefs, cai-&gt;<a class="code" href="structcreate__addr__info.html#a69d5008fc4ec5470304bd1e4f8450e35">prefs</a>, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#a69d5008fc4ec5470304bd1e4f8450e35">prefs</a>), 1);
<a name="l04361"></a>04361       <span class="keywordflow">return</span> 0;
<a name="l04362"></a>04362    }
<a name="l04363"></a>04363 
<a name="l04364"></a>04364    cai-&gt;<a class="code" href="structcreate__addr__info.html#ac6c6cd839d50c91230f55ed55d0cd635">found</a> = 1;
<a name="l04365"></a>04365    
<a name="l04366"></a>04366    <span class="comment">/* if the peer has no address (current or default), return failure */</span>
<a name="l04367"></a>04367    <span class="keywordflow">if</span> (!(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr || peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_addr.s_addr))
<a name="l04368"></a>04368       <span class="keywordflow">goto</span> return_unref;
<a name="l04369"></a>04369 
<a name="l04370"></a>04370    <span class="comment">/* if the peer is being monitored and is currently unreachable, return failure */</span>
<a name="l04371"></a>04371    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> &amp;&amp; ((peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &gt; peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>) || (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &lt; 0)))
<a name="l04372"></a>04372       <span class="keywordflow">goto</span> return_unref;
<a name="l04373"></a>04373 
<a name="l04374"></a>04374    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(cai, peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">IAX_SENDANI</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l04375"></a>04375    cai-&gt;<a class="code" href="structcreate__addr__info.html#a511d77bac179514b149c432cba8a920a">maxtime</a> = peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>;
<a name="l04376"></a>04376    cai-&gt;<a class="code" href="structcreate__addr__info.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = peer-&gt;<a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l04377"></a>04377    cai-&gt;<a class="code" href="structcreate__addr__info.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>;
<a name="l04378"></a>04378    cai-&gt;<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = peer-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>;
<a name="l04379"></a>04379    cai-&gt;<a class="code" href="structcreate__addr__info.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = peer-&gt;<a class="code" href="structiax2__peer.html#a61fbadf21e15a109d0703a01e0302535">adsi</a>;
<a name="l04380"></a>04380    memcpy(&amp;ourprefs, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, <span class="keyword">sizeof</span>(ourprefs));
<a name="l04381"></a>04381    <span class="comment">/* Move the calling channel&apos;s native codec to the top of the preference list */</span>
<a name="l04382"></a>04382    <span class="keywordflow">if</span> (c) {
<a name="l04383"></a>04383       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;prepending %x to prefs\n&quot;</span>, c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>);
<a name="l04384"></a>04384       <a class="code" href="frame_8h.html#a5eb17ccec8892ebe96ab661e749f0399" title="Prepend an audio codec to a preference list, removing it first if it was already...">ast_codec_pref_prepend</a>(&amp;ourprefs, c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, 1);
<a name="l04385"></a>04385    }
<a name="l04386"></a>04386    <a class="code" href="frame_8h.html#a42cc334b6773ff33cb3c24ca5a916842" title="Shift an audio codec preference list up or down 65 bytes so that it becomes an ASCII...">ast_codec_pref_convert</a>(&amp;ourprefs, cai-&gt;<a class="code" href="structcreate__addr__info.html#a69d5008fc4ec5470304bd1e4f8450e35">prefs</a>, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#a69d5008fc4ec5470304bd1e4f8450e35">prefs</a>), 1);
<a name="l04387"></a>04387    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, peer-&gt;context, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l04388"></a>04388    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>, peer-&gt;peercontext, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>));
<a name="l04389"></a>04389    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, peer-&gt;username, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));
<a name="l04390"></a>04390    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>, peer-&gt;zonetag, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>));
<a name="l04391"></a>04391    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#a0ac6dcfff533378dbcf9a01b59617d36">outkey</a>, peer-&gt;outkey, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#a0ac6dcfff533378dbcf9a01b59617d36">outkey</a>));
<a name="l04392"></a>04392    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>, peer-&gt;mohinterpret, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>));
<a name="l04393"></a>04393    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#aec4e201113703e94cd365aaa6dabd4f0">mohsuggest</a>, peer-&gt;mohsuggest, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#aec4e201113703e94cd365aaa6dabd4f0">mohsuggest</a>));
<a name="l04394"></a>04394    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;dbsecret)) {
<a name="l04395"></a>04395       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>, peer-&gt;secret, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>));
<a name="l04396"></a>04396    } <span class="keywordflow">else</span> {
<a name="l04397"></a>04397       <span class="keywordtype">char</span> *family;
<a name="l04398"></a>04398       <span class="keywordtype">char</span> *key = NULL;
<a name="l04399"></a>04399 
<a name="l04400"></a>04400       family = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(peer-&gt;dbsecret);
<a name="l04401"></a>04401       key = strchr(family, <span class="charliteral">&apos;/&apos;</span>);
<a name="l04402"></a>04402       <span class="keywordflow">if</span> (key)
<a name="l04403"></a>04403          *key++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04404"></a>04404       <span class="keywordflow">if</span> (!key || <a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(family, key, cai-&gt;<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>, <span class="keyword">sizeof</span>(cai-&gt;<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>))) {
<a name="l04405"></a>04405          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to retrieve database password for family/key &apos;%s&apos;!\n&quot;</span>, peer-&gt;dbsecret);
<a name="l04406"></a>04406          <span class="keywordflow">goto</span> return_unref;
<a name="l04407"></a>04407       }
<a name="l04408"></a>04408    }
<a name="l04409"></a>04409 
<a name="l04410"></a>04410    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr) {
<a name="l04411"></a>04411       sin-&gt;sin_addr = peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr;
<a name="l04412"></a>04412       sin-&gt;sin_port = peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port;
<a name="l04413"></a>04413    } <span class="keywordflow">else</span> {
<a name="l04414"></a>04414       sin-&gt;sin_addr = peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_addr;
<a name="l04415"></a>04415       sin-&gt;sin_port = peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_port;
<a name="l04416"></a>04416    }
<a name="l04417"></a>04417 
<a name="l04418"></a>04418    res = 0;
<a name="l04419"></a>04419 
<a name="l04420"></a>04420 return_unref:
<a name="l04421"></a>04421    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l04422"></a>04422 
<a name="l04423"></a>04423    <span class="keywordflow">return</span> res;
<a name="l04424"></a>04424 }
<a name="l04425"></a>04425 
<a name="l04426"></a><a class="code" href="chan__iax2_8c.html#a4ed224735c35c1e4e6bf0e041bc85e76">04426</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a4ed224735c35c1e4e6bf0e041bc85e76">__auto_congest</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *nothing)
<a name="l04427"></a>04427 {
<a name="l04428"></a>04428    <span class="keywordtype">int</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(nothing);
<a name="l04429"></a>04429    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a> };
<a name="l04430"></a>04430    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04431"></a>04431    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l04432"></a>04432       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">initid</a> = -1;
<a name="l04433"></a>04433       <a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f" title="Queue a frame to a call&amp;#39;s owning asterisk channel.">iax2_queue_frame</a>(callno, &amp;f);
<a name="l04434"></a>04434       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Auto-congesting call due to slow response\n&quot;</span>);
<a name="l04435"></a>04435    }
<a name="l04436"></a>04436    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04437"></a>04437 }
<a name="l04438"></a>04438 
<a name="l04439"></a><a class="code" href="chan__iax2_8c.html#a1937eb47124ed594f95faaa1f248e152">04439</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1937eb47124ed594f95faaa1f248e152">auto_congest</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l04440"></a>04440 {
<a name="l04441"></a>04441 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l04442"></a>04442 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a4ed224735c35c1e4e6bf0e041bc85e76">__auto_congest</a>, data))
<a name="l04443"></a>04443 <span class="preprocessor">#endif      </span>
<a name="l04444"></a>04444 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#a4ed224735c35c1e4e6bf0e041bc85e76">__auto_congest</a>(data);
<a name="l04445"></a>04445    <span class="keywordflow">return</span> 0;
<a name="l04446"></a>04446 }
<a name="l04447"></a>04447 
<a name="l04448"></a><a class="code" href="chan__iax2_8c.html#af18b4202de182e398645dee3a08b9e6f">04448</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af18b4202de182e398645dee3a08b9e6f">iax2_datetime</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *tz)
<a name="l04449"></a>04449 {
<a name="l04450"></a>04450    <span class="keyword">struct </span>timeval t = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l04451"></a>04451    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l04452"></a>04452    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> tmp;
<a name="l04453"></a>04453    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;t, &amp;tm, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tz) ? NULL : tz);
<a name="l04454"></a>04454    tmp  = (tm.<a class="code" href="structast__tm.html#a18df301c1a10c8d493da86ce5c2aea78">tm_sec</a> &gt;&gt; 1) &amp; 0x1f;        <span class="comment">/* 5 bits of seconds */</span>
<a name="l04455"></a>04455    tmp |= (tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a> &amp; 0x3f) &lt;&lt; 5;        <span class="comment">/* 6 bits of minutes */</span>
<a name="l04456"></a>04456    tmp |= (tm.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a> &amp; 0x1f) &lt;&lt; 11;      <span class="comment">/* 5 bits of hours */</span>
<a name="l04457"></a>04457    tmp |= (tm.<a class="code" href="structast__tm.html#a02048604d30b880033311cf542d63f92">tm_mday</a> &amp; 0x1f) &lt;&lt; 16;      <span class="comment">/* 5 bits of day of month */</span>
<a name="l04458"></a>04458    tmp |= ((tm.<a class="code" href="structast__tm.html#ada983deda100b604bee5716512453658">tm_mon</a> + 1) &amp; 0xf) &lt;&lt; 21;     <span class="comment">/* 4 bits of month */</span>
<a name="l04459"></a>04459    tmp |= ((tm.<a class="code" href="structast__tm.html#a994c4f4519ba57e186580d21cc86f9e5">tm_year</a> - 100) &amp; 0x7f) &lt;&lt; 25; <span class="comment">/* 7 bits of year */</span>
<a name="l04460"></a>04460    <span class="keywordflow">return</span> tmp;
<a name="l04461"></a>04461 }
<a name="l04462"></a>04462 
<a name="l04463"></a><a class="code" href="structparsed__dial__string.html">04463</a> <span class="keyword">struct </span><a class="code" href="structparsed__dial__string.html">parsed_dial_string</a> {
<a name="l04464"></a><a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">04464</a>    <span class="keywordtype">char</span> *username;
<a name="l04465"></a><a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">04465</a>    <span class="keywordtype">char</span> *password;
<a name="l04466"></a><a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">04466</a>    <span class="keywordtype">char</span> *key;
<a name="l04467"></a><a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">04467</a>    <span class="keywordtype">char</span> *peer;
<a name="l04468"></a><a class="code" href="structparsed__dial__string.html#add99ba4ea70b8f66170823cad9a55fa4">04468</a>    <span class="keywordtype">char</span> *port;
<a name="l04469"></a><a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">04469</a>    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>;
<a name="l04470"></a><a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">04470</a>    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l04471"></a><a class="code" href="structparsed__dial__string.html#ad358cb7ece4fc65136f8d20cf6b12816">04471</a>    <span class="keywordtype">char</span> *options;
<a name="l04472"></a>04472 };
<a name="l04473"></a>04473 
<a name="l04474"></a><a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">04474</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dcallno,
<a name="l04475"></a>04475       <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> command, <span class="keywordtype">int</span> ts, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> seqno,
<a name="l04476"></a>04476       <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keyword">struct</span> <a class="code" href="structiax__ie__data.html">iax_ie_data</a> *ied)
<a name="l04477"></a>04477 {
<a name="l04478"></a>04478    <span class="keyword">struct </span>{
<a name="l04479"></a>04479       <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> f;
<a name="l04480"></a>04480       <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l04481"></a>04481    } data;
<a name="l04482"></a>04482    <span class="keywordtype">size_t</span> size = <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>);
<a name="l04483"></a>04483 
<a name="l04484"></a>04484    <span class="keywordflow">if</span> (ied) {
<a name="l04485"></a>04485       size += ied-&gt;<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>;
<a name="l04486"></a>04486       memcpy(&amp;data.ied, ied-&gt;<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied-&gt;<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l04487"></a>04487    }
<a name="l04488"></a>04488 
<a name="l04489"></a>04489    data.f.scallno = htons(0x8000 | callno);
<a name="l04490"></a>04490    data.f.dcallno = htons(dcallno);
<a name="l04491"></a>04491    data.f.ts = htonl(ts);
<a name="l04492"></a>04492    data.f.iseqno = seqno;
<a name="l04493"></a>04493    data.f.oseqno = 0;
<a name="l04494"></a>04494    data.f.type = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>;
<a name="l04495"></a>04495    data.f.csub = <a class="code" href="chan__iax2_8c.html#ab063a335efcdf8cf19193fae08c6fcf9">compress_subclass</a>(command);
<a name="l04496"></a>04496 
<a name="l04497"></a>04497    <span class="keywordflow">return</span> sendto(sockfd, &amp;data, size, 0, (<span class="keyword">struct</span> sockaddr *)sin, <span class="keyword">sizeof</span>(*sin));
<a name="l04498"></a>04498 }
<a name="l04499"></a>04499 
<a name="l04500"></a><a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">04500</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">add_empty_calltoken_ie</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structiax__ie__data.html">iax_ie_data</a> *ied)
<a name="l04501"></a>04501 {
<a name="l04502"></a>04502    <span class="comment">/* first make sure their are two empty bytes left in ied-&gt;buf */</span>
<a name="l04503"></a>04503    <span class="keywordflow">if</span> (pvt &amp;&amp; ied &amp;&amp; (2 &lt; ((<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(ied-&gt;<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>) - ied-&gt;<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>))) {
<a name="l04504"></a>04504       ied-&gt;<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>[ied-&gt;<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>++] = <a class="code" href="iax2_8h.html#a2e6cad4127d6f7a21d8a8820d5f5bf14">IAX_IE_CALLTOKEN</a>;  <span class="comment">/* type */</span>
<a name="l04505"></a>04505       ied-&gt;<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>[ied-&gt;<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>++] = 0;   <span class="comment">/* data size,  ZERO in this case */</span>
<a name="l04506"></a>04506       pvt-&gt;calltoken_ie_len = 2;
<a name="l04507"></a>04507    }
<a name="l04508"></a>04508 }
<a name="l04509"></a>04509 
<a name="l04510"></a><a class="code" href="chan__iax2_8c.html#a29ca701dbb52c7e0ff3e2caa3025bc1f">04510</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a29ca701dbb52c7e0ff3e2caa3025bc1f">resend_with_token</a>(<span class="keywordtype">int</span> callno, <span class="keyword">struct</span> iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *newtoken)
<a name="l04511"></a>04511 {
<a name="l04512"></a>04512    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l04513"></a>04513    <span class="keywordtype">int</span> frametype = f-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>;
<a name="l04514"></a>04514    <span class="keywordtype">int</span> subclass = f-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l04515"></a>04515    <span class="keyword">struct </span>{
<a name="l04516"></a>04516       <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> fh;
<a name="l04517"></a>04517       <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l04518"></a>04518    } data = {
<a name="l04519"></a>04519       .ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a> = { 0 },
<a name="l04520"></a>04520       .ied.pos = 0,
<a name="l04521"></a>04521    };
<a name="l04522"></a>04522    <span class="comment">/* total len - header len gives us the frame&apos;s IE len */</span>
<a name="l04523"></a>04523    <span class="keywordtype">int</span> ie_data_pos = f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>);
<a name="l04524"></a>04524 
<a name="l04525"></a>04525    <span class="keywordflow">if</span> (!pvt) {
<a name="l04526"></a>04526       <span class="keywordflow">return</span>;  <span class="comment">/* this should not be possible if called from socket_process() */</span>
<a name="l04527"></a>04527    }
<a name="l04528"></a>04528 
<a name="l04529"></a>04529    <span class="comment">/* </span>
<a name="l04530"></a>04530 <span class="comment">    * Check to make sure last frame sent is valid for call token resend</span>
<a name="l04531"></a>04531 <span class="comment">    * 1. Frame should _NOT_ be encrypted since it starts the IAX dialog </span>
<a name="l04532"></a>04532 <span class="comment">    * 2. Frame should _NOT_ already have a destination callno</span>
<a name="l04533"></a>04533 <span class="comment">    * 3. Frame must be a valid iax_frame subclass capable of starting dialog</span>
<a name="l04534"></a>04534 <span class="comment">    * 4. Pvt must have a calltoken_ie_len which represents the number of</span>
<a name="l04535"></a>04535 <span class="comment">    *    bytes at the end of the frame used for the previous calltoken ie.</span>
<a name="l04536"></a>04536 <span class="comment">    * 5. Pvt&apos;s calltoken_ie_len must be _LESS_ than the total IE length</span>
<a name="l04537"></a>04537 <span class="comment">    * 6. Total length of f-&gt;data must be _LESS_ than size of our data struct</span>
<a name="l04538"></a>04538 <span class="comment">    *    because f-&gt;data must be able to fit within data. </span>
<a name="l04539"></a>04539 <span class="comment">    */</span>
<a name="l04540"></a>04540    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> || f-&gt;<a class="code" href="structiax__frame.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a> || !<a class="code" href="chan__iax2_8c.html#aa4d98b10bfe71c49427a18a57b889506">iax2_allow_new</a>(frametype, subclass, 0)
<a name="l04541"></a>04541       || !pvt-&gt;calltoken_ie_len || (pvt-&gt;calltoken_ie_len &gt; ie_data_pos) ||
<a name="l04542"></a>04542       (f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &gt; <span class="keyword">sizeof</span>(data))) {
<a name="l04543"></a>04543 
<a name="l04544"></a>04544       <span class="keywordflow">return</span>;  <span class="comment">/* ignore resend, token was not valid for the dialog */</span>
<a name="l04545"></a>04545    }
<a name="l04546"></a>04546 
<a name="l04547"></a>04547    <span class="comment">/* token is valid</span>
<a name="l04548"></a>04548 <span class="comment">    * 1. Copy frame data over</span>
<a name="l04549"></a>04549 <span class="comment">    * 2. Redo calltoken IE, it will always be the last ie in the frame.</span>
<a name="l04550"></a>04550 <span class="comment">    *    NOTE: Having the ie always be last is not protocol specified,</span>
<a name="l04551"></a>04551 <span class="comment">    *    it is only an implementation choice.  Since we only expect the ie to</span>
<a name="l04552"></a>04552 <span class="comment">    *    be last for frames we have sent, this can no way be affected by</span>
<a name="l04553"></a>04553 <span class="comment">    *    another end point.</span>
<a name="l04554"></a>04554 <span class="comment">    * 3. Remove frame from queue</span>
<a name="l04555"></a>04555 <span class="comment">    * 4. Free old frame</span>
<a name="l04556"></a>04556 <span class="comment">    * 5. Clear previous seqnos</span>
<a name="l04557"></a>04557 <span class="comment">    * 6. Resend with CALLTOKEN ie.</span>
<a name="l04558"></a>04558 <span class="comment">    */</span>
<a name="l04559"></a>04559 
<a name="l04560"></a>04560    <span class="comment">/* ---1.--- */</span>
<a name="l04561"></a>04561    memcpy(&amp;data, f-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>, f-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l04562"></a>04562    data.ied.pos = ie_data_pos;
<a name="l04563"></a>04563 
<a name="l04564"></a>04564    <span class="comment">/* ---2.--- */</span>
<a name="l04565"></a>04565    <span class="comment">/* move to the beginning of the calltoken ie so we can write over it */</span>
<a name="l04566"></a>04566    data.ied.pos -= pvt-&gt;calltoken_ie_len;
<a name="l04567"></a>04567    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;data.ied, <a class="code" href="iax2_8h.html#a2e6cad4127d6f7a21d8a8820d5f5bf14">IAX_IE_CALLTOKEN</a>, newtoken);
<a name="l04568"></a>04568 
<a name="l04569"></a>04569    <span class="comment">/* make sure to update token length incase it ever has to be stripped off again */</span>
<a name="l04570"></a>04570    pvt-&gt;calltoken_ie_len = data.ied.pos - ie_data_pos; <span class="comment">/* new pos minus old pos tells how big token ie is */</span>
<a name="l04571"></a>04571 
<a name="l04572"></a>04572    <span class="comment">/* ---3.--- */</span>
<a name="l04573"></a>04573    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l04574"></a>04574    <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;frame_queue, f, list);
<a name="l04575"></a>04575    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l04576"></a>04576 
<a name="l04577"></a>04577    <span class="comment">/* ---4.--- */</span>
<a name="l04578"></a>04578    <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(f);
<a name="l04579"></a>04579 
<a name="l04580"></a>04580    <span class="comment">/* ---5.--- */</span>
<a name="l04581"></a>04581    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> = 0;
<a name="l04582"></a>04582    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a> = 0;
<a name="l04583"></a>04583    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> = 0;
<a name="l04584"></a>04584    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a994263e05f34cf3e146bd54903b7a053">aseqno</a> = 0;
<a name="l04585"></a>04585    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l04586"></a>04586       <a class="code" href="chan__iax2_8c.html#ae48d962bcb33faf6f14966b39668d439">remove_by_peercallno</a>(pvt);
<a name="l04587"></a>04587       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> = 0;
<a name="l04588"></a>04588    }
<a name="l04589"></a>04589 
<a name="l04590"></a>04590    <span class="comment">/* ---6.--- */</span>
<a name="l04591"></a>04591    <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(pvt, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, subclass, 0, data.ied.buf, data.ied.pos, -1);
<a name="l04592"></a>04592 }
<a name="l04593"></a>04593 
<a name="l04594"></a><a class="code" href="chan__iax2_8c.html#afb672df4b801883186563436c4cb38db">04594</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#afb672df4b801883186563436c4cb38db">requirecalltoken_mark_auto</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keywordtype">int</span> subclass)
<a name="l04595"></a>04595 {
<a name="l04596"></a>04596    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l04597"></a>04597    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l04598"></a>04598 
<a name="l04599"></a>04599    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(name)) {
<a name="l04600"></a>04600       <span class="keywordflow">return</span>; <span class="comment">/* no username given */</span>
<a name="l04601"></a>04601    }
<a name="l04602"></a>04602 
<a name="l04603"></a>04603    <span class="keywordflow">if</span> ((subclass == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) &amp;&amp; (user = <a class="code" href="chan__iax2_8c.html#aa56d736414c9f5f71da37c50f0f57760">find_user</a>(name)) &amp;&amp; (user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a>)) {
<a name="l04604"></a>04604       user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8" title="Require call token validation.">CALLTOKEN_YES</a>;
<a name="l04605"></a>04605    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((subclass != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) &amp;&amp; (peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(name, 1)) &amp;&amp; (peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> == <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a>)) {
<a name="l04606"></a>04606       peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8" title="Require call token validation.">CALLTOKEN_YES</a>;
<a name="l04607"></a>04607    }
<a name="l04608"></a>04608 
<a name="l04609"></a>04609    <span class="keywordflow">if</span> (peer) {
<a name="l04610"></a>04610       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l04611"></a>04611    }
<a name="l04612"></a>04612    <span class="keywordflow">if</span> (user) {
<a name="l04613"></a>04613       <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l04614"></a>04614    }
<a name="l04615"></a>04615 }
<a name="l04616"></a>04616 <span class="comment"></span>
<a name="l04617"></a>04617 <span class="comment">/*!</span>
<a name="l04618"></a>04618 <span class="comment"> * \internal</span>
<a name="l04619"></a>04619 <span class="comment"> *</span>
<a name="l04620"></a>04620 <span class="comment"> * \brief handles calltoken logic for a received iax_frame.</span>
<a name="l04621"></a>04621 <span class="comment"> * </span>
<a name="l04622"></a>04622 <span class="comment"> * \note frametype must be AST_FRAME_IAX.</span>
<a name="l04623"></a>04623 <span class="comment"> * </span>
<a name="l04624"></a>04624 <span class="comment"> * \note</span>
<a name="l04625"></a>04625 <span class="comment"> * Three different cases are possible here.</span>
<a name="l04626"></a>04626 <span class="comment"> * Case 1. An empty calltoken is provided. This means the client supports</span>
<a name="l04627"></a>04627 <span class="comment"> *         calltokens but has not yet received one from us.  In this case</span>
<a name="l04628"></a>04628 <span class="comment"> *         a full calltoken IE is created and sent in a calltoken fullframe.</span>
<a name="l04629"></a>04629 <span class="comment"> * Case 2. A full calltoken is received and must be checked for validity.</span>
<a name="l04630"></a>04630 <span class="comment"> * Case 3. No calltoken is received indicating that the client does not</span>
<a name="l04631"></a>04631 <span class="comment"> *         support calltokens.  In this case it is up to the configuration</span>
<a name="l04632"></a>04632 <span class="comment"> *         to decide how this should be handled (reject or permit without calltoken)</span>
<a name="l04633"></a>04633 <span class="comment"> */</span>
<a name="l04634"></a><a class="code" href="chan__iax2_8c.html#ad0d4ac6467fbad03aa3ba57b4043567e">04634</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad0d4ac6467fbad03aa3ba57b4043567e">handle_call_token</a>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies,
<a name="l04635"></a>04635       <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> fd)
<a name="l04636"></a>04636 {
<a name="l04637"></a>04637 <span class="preprocessor">#define CALLTOKEN_HASH_FORMAT &quot;%s%d%u%d&quot;  </span><span class="comment">/* address + port + ts + randomcalldata */</span>
<a name="l04638"></a>04638 <span class="preprocessor">#define CALLTOKEN_IE_FORMAT   &quot;%u?%s&quot;     </span><span class="comment">/* time + ? + (40 char hash) */</span>
<a name="l04639"></a>04639    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(256);
<a name="l04640"></a>04640    time_t t = time(NULL);
<a name="l04641"></a>04641    <span class="keywordtype">char</span> hash[41]; <span class="comment">/* 40 char sha1 hash */</span>
<a name="l04642"></a>04642    <span class="keywordtype">int</span> subclass = <a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">uncompress_subclass</a>(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a>);
<a name="l04643"></a>04643 
<a name="l04644"></a>04644    <span class="comment">/* ----- Case 1 ----- */</span>
<a name="l04645"></a>04645    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a15e68c5804dbbb3cb4bc693a965426ee">calltoken</a> &amp;&amp; !ies-&gt;<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>) {  <span class="comment">/* empty calltoken is provided, client supports calltokens */</span>
<a name="l04646"></a>04646       <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied = {
<a name="l04647"></a>04647          .<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a> = { 0 },
<a name="l04648"></a>04648          .pos = 0,
<a name="l04649"></a>04649       };
<a name="l04650"></a>04650 
<a name="l04651"></a>04651       <span class="comment">/* create the hash with their address data and our timestamp */</span>
<a name="l04652"></a>04652       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;buf, 0, <a class="code" href="chan__iax2_8c.html#ae5249e0965c56afb83ebf143b6807b19">CALLTOKEN_HASH_FORMAT</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), sin-&gt;sin_port, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) t, randomcalltokendata);
<a name="l04653"></a>04653       <a class="code" href="utils_8h.html#a89565d41a0b343afc57a1c0d9eb85160" title="Produces SHA1 hash based on input string.">ast_sha1_hash</a>(hash, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l04654"></a>04654 
<a name="l04655"></a>04655       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;buf, 0, <a class="code" href="chan__iax2_8c.html#a851ed4b545298e2938c79855719908fc">CALLTOKEN_IE_FORMAT</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) t, hash);
<a name="l04656"></a>04656       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a2e6cad4127d6f7a21d8a8820d5f5bf14">IAX_IE_CALLTOKEN</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l04657"></a>04657       <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(1, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>), sin, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa92c28bf63f730ca1f2836b5a1a26ac38">IAX_COMMAND_CALLTOKEN</a>, ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>), fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> + 1, fd, &amp;ied);
<a name="l04658"></a>04658 
<a name="l04659"></a>04659       <span class="keywordflow">return</span> 1;
<a name="l04660"></a>04660 
<a name="l04661"></a>04661    <span class="comment">/* ----- Case 2 ----- */</span>
<a name="l04662"></a>04662    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a15e68c5804dbbb3cb4bc693a965426ee">calltoken</a> &amp;&amp; ies-&gt;<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>) { <span class="comment">/* calltoken received, check to see if it is valid */</span>
<a name="l04663"></a>04663       <span class="keywordtype">char</span> *rec_hash = NULL;    <span class="comment">/* the received hash, make sure it matches with ours. */</span>
<a name="l04664"></a>04664       <span class="keywordtype">char</span> *rec_ts = NULL;      <span class="comment">/* received timestamp */</span>
<a name="l04665"></a>04665       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rec_time;  <span class="comment">/* received time_t */</span>
<a name="l04666"></a>04666 
<a name="l04667"></a>04667       <span class="comment">/* split the timestamp from the hash data */</span>
<a name="l04668"></a>04668       rec_hash = strchr((<span class="keywordtype">char</span> *) ies-&gt;<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>, <span class="charliteral">&apos;?&apos;</span>);
<a name="l04669"></a>04669       <span class="keywordflow">if</span> (rec_hash) {
<a name="l04670"></a>04670          *rec_hash++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04671"></a>04671          rec_ts = (<span class="keywordtype">char</span> *) ies-&gt;<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>;
<a name="l04672"></a>04672       }
<a name="l04673"></a>04673 
<a name="l04674"></a>04674       <span class="comment">/* check that we have valid data before we do any comparisons */</span>
<a name="l04675"></a>04675       <span class="keywordflow">if</span> (!rec_hash || !rec_ts) {
<a name="l04676"></a>04676          <span class="keywordflow">goto</span> reject;
<a name="l04677"></a>04677       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(rec_ts, <span class="stringliteral">&quot;%u&quot;</span>, &amp;rec_time) != 1) {
<a name="l04678"></a>04678          <span class="keywordflow">goto</span> reject;
<a name="l04679"></a>04679       }
<a name="l04680"></a>04680 
<a name="l04681"></a>04681       <span class="comment">/* create a hash with their address and the _TOKEN&apos;S_ timestamp */</span>
<a name="l04682"></a>04682       <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;buf, 0, <a class="code" href="chan__iax2_8c.html#ae5249e0965c56afb83ebf143b6807b19">CALLTOKEN_HASH_FORMAT</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), sin-&gt;sin_port, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) rec_time, randomcalltokendata);
<a name="l04683"></a>04683       <a class="code" href="utils_8h.html#a89565d41a0b343afc57a1c0d9eb85160" title="Produces SHA1 hash based on input string.">ast_sha1_hash</a>(hash, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(buf));
<a name="l04684"></a>04684 
<a name="l04685"></a>04685       <span class="comment">/* compare hashes and then check timestamp delay */</span>
<a name="l04686"></a>04686       <span class="keywordflow">if</span> (strcmp(hash, rec_hash)) {
<a name="l04687"></a>04687          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Address %s failed CallToken hash inspection\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l04688"></a>04688          <span class="keywordflow">goto</span> reject; <span class="comment">/* received hash does not match ours, reject */</span>
<a name="l04689"></a>04689       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((t &lt; rec_time) || ((t - rec_time) &gt;= MAX_CALLTOKEN_DELAY)) {
<a name="l04690"></a>04690          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Too much delay in IAX2 calltoken timestamp from address %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l04691"></a>04691          <span class="keywordflow">goto</span> reject; <span class="comment">/* too much delay, reject */</span>
<a name="l04692"></a>04692       }
<a name="l04693"></a>04693 
<a name="l04694"></a>04694       <span class="comment">/* at this point the call token is valid, returning 0 </span>
<a name="l04695"></a>04695 <span class="comment">       * will allow socket_process to continue as usual */</span>
<a name="l04696"></a>04696       <a class="code" href="chan__iax2_8c.html#afb672df4b801883186563436c4cb38db">requirecalltoken_mark_auto</a>(ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, subclass);
<a name="l04697"></a>04697       <span class="keywordflow">return</span> 0;
<a name="l04698"></a>04698 
<a name="l04699"></a>04699    <span class="comment">/* ----- Case 3 ----- */</span>
<a name="l04700"></a>04700    } <span class="keywordflow">else</span> { <span class="comment">/* calltokens are not supported for this client, how do we respond? */</span>
<a name="l04701"></a>04701       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a340a0725dca7baf10001f3a26de46212">calltoken_required</a>(sin, ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, subclass)) {
<a name="l04702"></a>04702          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Call rejected, CallToken Support required. If unexpected, resolve by placing address %s in the calltokenoptional list or setting user %s requirecalltoken=no\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, <span class="stringliteral">&quot;guest&quot;</span>));
<a name="l04703"></a>04703          <span class="keywordflow">goto</span> reject;
<a name="l04704"></a>04704       }
<a name="l04705"></a>04705       <span class="keywordflow">return</span> 0; <span class="comment">/* calltoken is not required for this addr, so permit it. */</span>
<a name="l04706"></a>04706    }
<a name="l04707"></a>04707 
<a name="l04708"></a>04708 reject:
<a name="l04709"></a>04709    <span class="comment">/* received frame has failed calltoken inspection, send apathetic reject messages */</span>
<a name="l04710"></a>04710    <span class="keywordflow">if</span> (subclass == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effab17acacea946abf3ccde08f4f49fbfdb">IAX_COMMAND_REGREQ</a> || subclass == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9189574bea9c0b4772606120cd74718d">IAX_COMMAND_REGREL</a>) {
<a name="l04711"></a>04711       <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(1, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>), sin, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa8c1a50616eeef8353b4985462e736419">IAX_COMMAND_REGREJ</a>, ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>), fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> + 1, fd, NULL);
<a name="l04712"></a>04712    } <span class="keywordflow">else</span> {
<a name="l04713"></a>04713       <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(1, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>), sin, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>), fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> + 1, fd, NULL);
<a name="l04714"></a>04714    }
<a name="l04715"></a>04715 
<a name="l04716"></a>04716    <span class="keywordflow">return</span> 1;
<a name="l04717"></a>04717 }
<a name="l04718"></a>04718 <span class="comment"></span>
<a name="l04719"></a>04719 <span class="comment">/*!</span>
<a name="l04720"></a>04720 <span class="comment"> * \brief Parses an IAX dial string into its component parts.</span>
<a name="l04721"></a>04721 <span class="comment"> * \param data the string to be parsed</span>
<a name="l04722"></a>04722 <span class="comment"> * \param pds pointer to a \c struct \c parsed_dial_string to be filled in</span>
<a name="l04723"></a>04723 <span class="comment"> * \return nothing</span>
<a name="l04724"></a>04724 <span class="comment"> *</span>
<a name="l04725"></a>04725 <span class="comment"> * This function parses the string and fills the structure</span>
<a name="l04726"></a>04726 <span class="comment"> * with pointers to its component parts. The input string</span>
<a name="l04727"></a>04727 <span class="comment"> * will be modified.</span>
<a name="l04728"></a>04728 <span class="comment"> *</span>
<a name="l04729"></a>04729 <span class="comment"> * \note This function supports both plaintext passwords and RSA</span>
<a name="l04730"></a>04730 <span class="comment"> * key names; if the password string is formatted as &apos;[keyname]&apos;,</span>
<a name="l04731"></a>04731 <span class="comment"> * then the keyname will be placed into the key field, and the</span>
<a name="l04732"></a>04732 <span class="comment"> * password field will be set to NULL.</span>
<a name="l04733"></a>04733 <span class="comment"> *</span>
<a name="l04734"></a>04734 <span class="comment"> * \note The dial string format is:</span>
<a name="l04735"></a>04735 <span class="comment"> *       [username[:password]@]peer[:port][/exten[@@context]][/options]</span>
<a name="l04736"></a>04736 <span class="comment"> */</span>
<a name="l04737"></a><a class="code" href="chan__iax2_8c.html#a71c8dc9496597f318dad7e03597b945d">04737</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a71c8dc9496597f318dad7e03597b945d" title="Parses an IAX dial string into its component parts.">parse_dial_string</a>(<span class="keywordtype">char</span> *data, <span class="keyword">struct</span> <a class="code" href="structparsed__dial__string.html">parsed_dial_string</a> *pds)
<a name="l04738"></a>04738 {
<a name="l04739"></a>04739    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data))
<a name="l04740"></a>04740       <span class="keywordflow">return</span>;
<a name="l04741"></a>04741 
<a name="l04742"></a>04742    pds-&gt;<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a> = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;data, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l04743"></a>04743    pds-&gt;<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a> = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;data, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l04744"></a>04744    pds-&gt;<a class="code" href="structparsed__dial__string.html#ad358cb7ece4fc65136f8d20cf6b12816">options</a> = data;
<a name="l04745"></a>04745 
<a name="l04746"></a>04746    <span class="keywordflow">if</span> (pds-&gt;<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a>) {
<a name="l04747"></a>04747       data = pds-&gt;<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a>;
<a name="l04748"></a>04748       pds-&gt;<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a> = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;data, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l04749"></a>04749       pds-&gt;<a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">context</a> = data;
<a name="l04750"></a>04750    }
<a name="l04751"></a>04751 
<a name="l04752"></a>04752    <span class="keywordflow">if</span> (strchr(pds-&gt;<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, <span class="charliteral">&apos;@&apos;</span>)) {
<a name="l04753"></a>04753       data = pds-&gt;<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>;
<a name="l04754"></a>04754       pds-&gt;<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a> = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;data, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l04755"></a>04755       pds-&gt;<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a> = data;
<a name="l04756"></a>04756    }
<a name="l04757"></a>04757 
<a name="l04758"></a>04758    <span class="keywordflow">if</span> (pds-&gt;<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>) {
<a name="l04759"></a>04759       data = pds-&gt;<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>;
<a name="l04760"></a>04760       pds-&gt;<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a> = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;data, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l04761"></a>04761       pds-&gt;<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a> = data;
<a name="l04762"></a>04762    }
<a name="l04763"></a>04763 
<a name="l04764"></a>04764    data = pds-&gt;<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>;
<a name="l04765"></a>04765    pds-&gt;<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a> = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;data, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l04766"></a>04766    pds-&gt;<a class="code" href="structparsed__dial__string.html#add99ba4ea70b8f66170823cad9a55fa4">port</a> = data;
<a name="l04767"></a>04767 
<a name="l04768"></a>04768    <span class="comment">/* check for a key name wrapped in [] in the secret position, if found,</span>
<a name="l04769"></a>04769 <span class="comment">      move it to the key field instead</span>
<a name="l04770"></a>04770 <span class="comment">   */</span>
<a name="l04771"></a>04771    <span class="keywordflow">if</span> (pds-&gt;<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a> &amp;&amp; (pds-&gt;<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>[0] == <span class="charliteral">&apos;[&apos;</span>)) {
<a name="l04772"></a>04772       pds-&gt;<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = <a class="code" href="strings_8h.html#aeb597bdc9a1209c2e7dd8af04de43485" title="Strip leading/trailing whitespace and quotes from a string.">ast_strip_quoted</a>(pds-&gt;<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>, <span class="stringliteral">&quot;[&quot;</span>, <span class="stringliteral">&quot;]&quot;</span>);
<a name="l04773"></a>04773       pds-&gt;<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a> = NULL;
<a name="l04774"></a>04774    }
<a name="l04775"></a>04775 }
<a name="l04776"></a>04776 
<a name="l04777"></a><a class="code" href="chan__iax2_8c.html#acfb7625fffb7d724ce068b63af1ef059">04777</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#acfb7625fffb7d724ce068b63af1ef059">iax2_call</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> timeout)
<a name="l04778"></a>04778 {
<a name="l04779"></a>04779    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l04780"></a>04780    <span class="keywordtype">char</span> *l=NULL, *n=NULL, *tmpstr;
<a name="l04781"></a>04781    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l04782"></a>04782    <span class="keywordtype">char</span> *defaultrdest = <span class="stringliteral">&quot;s&quot;</span>;
<a name="l04783"></a>04783    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l04784"></a>04784    <span class="keyword">struct </span><a class="code" href="structparsed__dial__string.html">parsed_dial_string</a> pds;
<a name="l04785"></a>04785    <span class="keyword">struct </span><a class="code" href="structcreate__addr__info.html">create_addr_info</a> cai;
<a name="l04786"></a>04786    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l04787"></a>04787    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(c, &amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l04788"></a>04788    <span class="keyword">const</span> <span class="keywordtype">char</span>* osp_token_ptr;
<a name="l04789"></a>04789    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> osp_token_length;
<a name="l04790"></a>04790    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> osp_block_index;
<a name="l04791"></a>04791    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> osp_block_length;
<a name="l04792"></a>04792    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> osp_buffer[256];
<a name="l04793"></a>04793 
<a name="l04794"></a>04794    <span class="keywordflow">if</span> ((c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>) &amp;&amp; (c-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660addb60fd97b55a4aea24f992e30fe3c84">AST_STATE_RESERVED</a>)) {
<a name="l04795"></a>04795       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel is already in use (%s)?\n&quot;</span>, c-&gt;name);
<a name="l04796"></a>04796       <span class="keywordflow">return</span> -1;
<a name="l04797"></a>04797    }
<a name="l04798"></a>04798 
<a name="l04799"></a>04799    memset(&amp;cai, 0, <span class="keyword">sizeof</span>(cai));
<a name="l04800"></a>04800    cai.<a class="code" href="structcreate__addr__info.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = iax2_encryption;
<a name="l04801"></a>04801 
<a name="l04802"></a>04802    memset(&amp;pds, 0, <span class="keyword">sizeof</span>(pds));
<a name="l04803"></a>04803    tmpstr = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(dest);
<a name="l04804"></a>04804    <a class="code" href="chan__iax2_8c.html#a71c8dc9496597f318dad7e03597b945d" title="Parses an IAX dial string into its component parts.">parse_dial_string</a>(tmpstr, &amp;pds);
<a name="l04805"></a>04805 
<a name="l04806"></a>04806    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>)) {
<a name="l04807"></a>04807       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No peer provided in the IAX2 dial string &apos;%s&apos;\n&quot;</span>, dest);
<a name="l04808"></a>04808       <span class="keywordflow">return</span> -1;
<a name="l04809"></a>04809    }
<a name="l04810"></a>04810    <span class="keywordflow">if</span> (!pds.<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a>) {
<a name="l04811"></a>04811       pds.<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a> = defaultrdest;
<a name="l04812"></a>04812    }
<a name="l04813"></a>04813    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a718ce50d45da77b324047f3d9ceb6749">create_addr</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, c, &amp;sin, &amp;cai)) {
<a name="l04814"></a>04814       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No address associated with &apos;%s&apos;\n&quot;</span>, pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>);
<a name="l04815"></a>04815       <span class="keywordflow">return</span> -1;
<a name="l04816"></a>04816    }
<a name="l04817"></a>04817    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cai.<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>) &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>)) {
<a name="l04818"></a>04818       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Call terminated. No secret given and force encrypt enabled\n&quot;</span>);
<a name="l04819"></a>04819       <span class="keywordflow">return</span> -1;
<a name="l04820"></a>04820    }
<a name="l04821"></a>04821    <span class="keywordflow">if</span> (!pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cai.<a class="code" href="structcreate__addr__info.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>))
<a name="l04822"></a>04822       pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a> = cai.<a class="code" href="structcreate__addr__info.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>;
<a name="l04823"></a>04823    <span class="keywordflow">if</span> (!pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cai.<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>))
<a name="l04824"></a>04824       pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a> = cai.<a class="code" href="structcreate__addr__info.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>;
<a name="l04825"></a>04825    <span class="keywordflow">if</span> (!pds.<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cai.<a class="code" href="structcreate__addr__info.html#a0ac6dcfff533378dbcf9a01b59617d36">outkey</a>))
<a name="l04826"></a>04826       pds.<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a> = cai.<a class="code" href="structcreate__addr__info.html#a0ac6dcfff533378dbcf9a01b59617d36">outkey</a>;
<a name="l04827"></a>04827    <span class="keywordflow">if</span> (!pds.<a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">context</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cai.<a class="code" href="structcreate__addr__info.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>))
<a name="l04828"></a>04828       pds.<a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">context</a> = cai.<a class="code" href="structcreate__addr__info.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>;
<a name="l04829"></a>04829 
<a name="l04830"></a>04830    <span class="comment">/* Keep track of the context for outgoing calls too */</span>
<a name="l04831"></a>04831    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, cai.<a class="code" href="structcreate__addr__info.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l04832"></a>04832 
<a name="l04833"></a>04833    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#add99ba4ea70b8f66170823cad9a55fa4">port</a>)
<a name="l04834"></a>04834       sin.sin_port = htons(atoi(pds.<a class="code" href="structparsed__dial__string.html#add99ba4ea70b8f66170823cad9a55fa4">port</a>));
<a name="l04835"></a>04835 
<a name="l04836"></a>04836    l = c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>;
<a name="l04837"></a>04837    n = c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>;
<a name="l04838"></a>04838 
<a name="l04839"></a>04839    <span class="comment">/* Now build request */</span> 
<a name="l04840"></a>04840    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l04841"></a>04841 
<a name="l04842"></a>04842    <span class="comment">/* On new call, first IE MUST be IAX version of caller */</span>
<a name="l04843"></a>04843    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#aba2ed51c46cc5e0e09ab9da295eafc12">IAX_IE_VERSION</a>, <a class="code" href="iax2_8h.html#ab1d2d15fd95077bc4f93947a5e011a98">IAX_PROTO_VERSION</a>);
<a name="l04844"></a>04844    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#aa0f5d6e9b74df33a17772be8afde5bc7">IAX_IE_CALLED_NUMBER</a>, pds.<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l04845"></a>04845    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#ad358cb7ece4fc65136f8d20cf6b12816">options</a> &amp;&amp; strchr(pds.<a class="code" href="structparsed__dial__string.html#ad358cb7ece4fc65136f8d20cf6b12816">options</a>, <span class="charliteral">&apos;a&apos;</span>)) {
<a name="l04846"></a>04846       <span class="comment">/* Request auto answer */</span>
<a name="l04847"></a>04847       <a class="code" href="iax2-parser_8c.html#a8cac52b8ffe1019fe3dbd5bb605994d1">iax_ie_append</a>(&amp;ied, <a class="code" href="iax2_8h.html#ab3a598f06cede6d1cd658908c4af76d0">IAX_IE_AUTOANSWER</a>);
<a name="l04848"></a>04848    }
<a name="l04849"></a>04849 
<a name="l04850"></a>04850    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a9dd09f4ce469613f783dc92fe36e3ff2">IAX_IE_CODEC_PREFS</a>, cai.<a class="code" href="structcreate__addr__info.html#a69d5008fc4ec5470304bd1e4f8450e35">prefs</a>);
<a name="l04851"></a>04851 
<a name="l04852"></a>04852    <span class="keywordflow">if</span> (l) {
<a name="l04853"></a>04853       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a247e96f38f42f791fdd95a78d614dff5">IAX_IE_CALLING_NUMBER</a>, l);
<a name="l04854"></a>04854       <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad467d714d8713c98eda20b5c036c5c4d">IAX_IE_CALLINGPRES</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a5674af3fa5ce1dd1fe052be1477d4110">cid_pres</a>);
<a name="l04855"></a>04855    } <span class="keywordflow">else</span> {
<a name="l04856"></a>04856       <span class="keywordflow">if</span> (n)
<a name="l04857"></a>04857          <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad467d714d8713c98eda20b5c036c5c4d">IAX_IE_CALLINGPRES</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a5674af3fa5ce1dd1fe052be1477d4110">cid_pres</a>);
<a name="l04858"></a>04858       <span class="keywordflow">else</span>
<a name="l04859"></a>04859          <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad467d714d8713c98eda20b5c036c5c4d">IAX_IE_CALLINGPRES</a>, <a class="code" href="callerid_8h.html#a69574f5c1e9be59b1d2eb727d4209bce">AST_PRES_NUMBER_NOT_AVAILABLE</a>);
<a name="l04860"></a>04860    }
<a name="l04861"></a>04861 
<a name="l04862"></a>04862    <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#af1c412a0c60a9b1fb6aaa6726fba088e">IAX_IE_CALLINGTON</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aff456ca48d31a9813584e799064cf88e">cid_ton</a>);
<a name="l04863"></a>04863    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#a37ecb07d951c76538b9492849d9ef2c6">IAX_IE_CALLINGTNS</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aae7e57d784da2bfe6b85cb36516edca0">cid_tns</a>);
<a name="l04864"></a>04864 
<a name="l04865"></a>04865    <span class="keywordflow">if</span> (n)
<a name="l04866"></a>04866       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a5d435e4bb28522353ca7937e06e2689c">IAX_IE_CALLING_NAME</a>, n);
<a name="l04867"></a>04867    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">IAX_SENDANI</a>) &amp;&amp; c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>)
<a name="l04868"></a>04868       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a349591fc903d8fd2b7081ac0650fa7d8">IAX_IE_CALLING_ANI</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a>);
<a name="l04869"></a>04869 
<a name="l04870"></a>04870    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;language))
<a name="l04871"></a>04871       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a758c277d538d6a8ab6130a606df1ff7a">IAX_IE_LANGUAGE</a>, c-&gt;language);
<a name="l04872"></a>04872    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aa54ab157f47ac529034d524781e2a7e2">cid_dnid</a>))
<a name="l04873"></a>04873       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a15784fe7e4dcbfeed0eeebe293878782">IAX_IE_DNID</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aa54ab157f47ac529034d524781e2a7e2">cid_dnid</a>);
<a name="l04874"></a>04874    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a>))
<a name="l04875"></a>04875       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a782e6d7b50cb8c4966f3c2979a9291df">IAX_IE_RDNIS</a>, c-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a>);
<a name="l04876"></a>04876 
<a name="l04877"></a>04877    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">context</a>)
<a name="l04878"></a>04878       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#af19a0a52d9c678fd55a44e6cda94cd88">IAX_IE_CALLED_CONTEXT</a>, pds.<a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">context</a>);
<a name="l04879"></a>04879 
<a name="l04880"></a>04880    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l04881"></a>04881       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>);
<a name="l04882"></a>04882 
<a name="l04883"></a>04883    <span class="keywordflow">if</span> (cai.<a class="code" href="structcreate__addr__info.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>)
<a name="l04884"></a>04884       <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#a82301ee077d892ac535637a33eeff904">IAX_IE_ENCRYPTION</a>, cai.<a class="code" href="structcreate__addr__info.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>);
<a name="l04885"></a>04885 
<a name="l04886"></a>04886    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04887"></a>04887 
<a name="l04888"></a>04888    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>))
<a name="l04889"></a>04889       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, c-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l04890"></a>04890 
<a name="l04891"></a>04891    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l04892"></a>04892       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], username, pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>);
<a name="l04893"></a>04893 
<a name="l04894"></a>04894    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = cai.<a class="code" href="structcreate__addr__info.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>;
<a name="l04895"></a>04895 
<a name="l04896"></a>04896    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = cai.<a class="code" href="structcreate__addr__info.html#a61fbadf21e15a109d0703a01e0302535">adsi</a>;
<a name="l04897"></a>04897    
<a name="l04898"></a>04898    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], mohinterpret, cai.<a class="code" href="structcreate__addr__info.html#af689da2b77d1265192a78a5b0994a1d5">mohinterpret</a>);
<a name="l04899"></a>04899    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], mohsuggest, cai.<a class="code" href="structcreate__addr__info.html#aec4e201113703e94cd365aaa6dabd4f0">mohsuggest</a>);
<a name="l04900"></a>04900 
<a name="l04901"></a>04901    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>)
<a name="l04902"></a>04902       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], outkey, pds.<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>);
<a name="l04903"></a>04903    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>)
<a name="l04904"></a>04904       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>);
<a name="l04905"></a>04905 
<a name="l04906"></a>04906    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#a81b21fd8bbf4f19527fbb21277687bd5">IAX_IE_FORMAT</a>, c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>);
<a name="l04907"></a>04907    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#aa6bc44b17b9a99b1f91f205b9c2112bf">IAX_IE_CAPABILITY</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__mgcp_8c.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l04908"></a>04908    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#a657e780d9d73b1f270b4434d19ac7a56">IAX_IE_ADSICPE</a>, c-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a>);
<a name="l04909"></a>04909    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#a1d106f79be9f6e388fd852185a62a67f">IAX_IE_DATETIME</a>, <a class="code" href="chan__iax2_8c.html#af18b4202de182e398645dee3a08b9e6f">iax2_datetime</a>(cai.<a class="code" href="structcreate__addr__info.html#aad16c37028f0efbc3cf8c9186b770ab8">timezone</a>));
<a name="l04910"></a>04910 
<a name="l04911"></a>04911    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;maxtime) {
<a name="l04912"></a>04912       <span class="comment">/* Initialize pingtime and auto-congest time */</span>
<a name="l04913"></a>04913       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a511d77bac179514b149c432cba8a920a">maxtime</a> / 2;
<a name="l04914"></a>04914       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">initid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;maxtime * 2, <a class="code" href="chan__iax2_8c.html#a1937eb47124ed594f95faaa1f248e152">auto_congest</a>, <a class="code" href="chan__iax2_8c.html#a7510329b1cbee3d732b54d94586a975c">CALLNO_TO_PTR</a>(callno));
<a name="l04915"></a>04915    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (autokill) {
<a name="l04916"></a>04916       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a> = autokill / 2;
<a name="l04917"></a>04917       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">initid</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, autokill * 2, <a class="code" href="chan__iax2_8c.html#a1937eb47124ed594f95faaa1f248e152">auto_congest</a>, <a class="code" href="chan__iax2_8c.html#a7510329b1cbee3d732b54d94586a975c">CALLNO_TO_PTR</a>(callno));
<a name="l04918"></a>04918    }
<a name="l04919"></a>04919 
<a name="l04920"></a>04920    <span class="comment">/* Check if there is an OSP token */</span>
<a name="l04921"></a>04921    osp_token_ptr = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(c, <span class="stringliteral">&quot;IAX2OSPTOKEN&quot;</span>);
<a name="l04922"></a>04922    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(osp_token_ptr)) {
<a name="l04923"></a>04923       <span class="keywordflow">if</span> ((osp_token_length = strlen(osp_token_ptr)) &lt;= <a class="code" href="iax2_8h.html#a75cf0a80be9e6d4d52c0104959636661">IAX_MAX_OSPTOKEN_SIZE</a>) {
<a name="l04924"></a>04924          osp_block_index = 0;
<a name="l04925"></a>04925          <span class="keywordflow">while</span> (osp_token_length &gt; 0) {
<a name="l04926"></a>04926             osp_block_length = <a class="code" href="iax2_8h.html#a150226e8108553c73b5660f83455a5b8">IAX_MAX_OSPBLOCK_SIZE</a> &lt; osp_token_length ? <a class="code" href="iax2_8h.html#a150226e8108553c73b5660f83455a5b8">IAX_MAX_OSPBLOCK_SIZE</a> : osp_token_length;
<a name="l04927"></a>04927             osp_buffer[0] = osp_block_index;
<a name="l04928"></a>04928             memcpy(osp_buffer + 1, osp_token_ptr, osp_block_length);
<a name="l04929"></a>04929             <a class="code" href="iax2-parser_8c.html#aa54841eb569031c28321281dcd31e4f3">iax_ie_append_raw</a>(&amp;ied, <a class="code" href="iax2_8h.html#a739827413438b153d6fecb939f938771">IAX_IE_OSPTOKEN</a>, osp_buffer, osp_block_length + 1);
<a name="l04930"></a>04930             osp_block_index++;
<a name="l04931"></a>04931             osp_token_ptr += osp_block_length;
<a name="l04932"></a>04932             osp_token_length -= osp_block_length;
<a name="l04933"></a>04933          } 
<a name="l04934"></a>04934       } <span class="keywordflow">else</span>
<a name="l04935"></a>04935          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;OSP token is too long\n&quot;</span>);
<a name="l04936"></a>04936    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iaxdebug)
<a name="l04937"></a>04937       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;OSP token is undefined\n&quot;</span>);
<a name="l04938"></a>04938 
<a name="l04939"></a>04939    <span class="comment">/* send the command using the appropriate socket for this peer */</span>
<a name="l04940"></a>04940    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = cai.<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>;
<a name="l04941"></a>04941 
<a name="l04942"></a>04942    <span class="comment">/* Add remote vars */</span>
<a name="l04943"></a>04943    <span class="keywordflow">if</span> (variablestore) {
<a name="l04944"></a>04944       <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *variablelist = variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l04945"></a>04945       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found an IAX variable store on this channel\n&quot;</span>);
<a name="l04946"></a>04946       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(variablelist);
<a name="l04947"></a>04947       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(variablelist, var, entries) {
<a name="l04948"></a>04948          <span class="keywordtype">char</span> tmp[256];
<a name="l04949"></a>04949          <span class="keywordtype">int</span> i;
<a name="l04950"></a>04950          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found IAXVAR &apos;%s&apos; with value &apos;%s&apos; (to transmit)\n&quot;</span>, <a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(var), <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(var));
<a name="l04951"></a>04951          <span class="comment">/* Automatically divide the value up into sized chunks */</span>
<a name="l04952"></a>04952          <span class="keywordflow">for</span> (i = 0; i &lt; strlen(<a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(var)); i += 255 - (strlen(<a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(var)) + 1)) {
<a name="l04953"></a>04953             snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s=%s&quot;</span>, <a class="code" href="chanvars_8h.html#a356a31cd608ec07d3668dcd589be49d8">ast_var_name</a>(var), <a class="code" href="chanvars_8h.html#a8e0081172db71c5021d20706c50d959c">ast_var_value</a>(var) + i);
<a name="l04954"></a>04954             <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a6ec683aa068fc1d484a7abcca1ef600b">IAX_IE_VARIABLE</a>, tmp);
<a name="l04955"></a>04955          }
<a name="l04956"></a>04956       }
<a name="l04957"></a>04957       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(variablelist);
<a name="l04958"></a>04958    }
<a name="l04959"></a>04959 
<a name="l04960"></a>04960    <span class="comment">/* Transmit the string in a &quot;NEW&quot; request */</span>
<a name="l04961"></a>04961    <a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">add_empty_calltoken_ie</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], &amp;ied); <span class="comment">/* this _MUST_ be the last ie added */</span>
<a name="l04962"></a>04962    <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l04963"></a>04963 
<a name="l04964"></a>04964    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04965"></a>04965    <a class="code" href="channel_8h.html#ad9d8f7d9e228b5af98a7b40db9f06448" title="Change the state of a channel.">ast_setstate</a>(c, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a5bf03bd84f434acaeefdacb0096e1baa">AST_STATE_RINGING</a>);
<a name="l04966"></a>04966 
<a name="l04967"></a>04967    <span class="keywordflow">return</span> 0;
<a name="l04968"></a>04968 }
<a name="l04969"></a>04969 
<a name="l04970"></a><a class="code" href="chan__iax2_8c.html#a21a2f61a4598a0bb8e499cbb119f775c">04970</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a21a2f61a4598a0bb8e499cbb119f775c">iax2_hangup</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c) 
<a name="l04971"></a>04971 {
<a name="l04972"></a>04972    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l04973"></a>04973    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l04974"></a>04974    <span class="keywordtype">int</span> alreadygone;
<a name="l04975"></a>04975    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l04976"></a>04976    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04977"></a>04977    <span class="keywordflow">if</span> (callno &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l04978"></a>04978       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;We&apos;re hanging up %s now...\n&quot;</span>, c-&gt;name);
<a name="l04979"></a>04979       alreadygone = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>);
<a name="l04980"></a>04980       <span class="comment">/* Send the hangup unless we have had a transmission error or are already gone */</span>
<a name="l04981"></a>04981       <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)c-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a>);
<a name="l04982"></a>04982       <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;error &amp;&amp; !alreadygone) {
<a name="l04983"></a>04983          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4b934f8100fc77df870a27d2aa09b9ee">IAX_COMMAND_HANGUP</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1)) {
<a name="l04984"></a>04984             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No final packet could be sent for callno %d\n&quot;</span>, callno);
<a name="l04985"></a>04985          }
<a name="l04986"></a>04986          <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l04987"></a>04987             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l04988"></a>04988             <span class="keywordflow">return</span> 0;
<a name="l04989"></a>04989          }
<a name="l04990"></a>04990       }
<a name="l04991"></a>04991       <span class="comment">/* Explicitly predestroy it */</span>
<a name="l04992"></a>04992       <a class="code" href="chan__iax2_8c.html#a1b9c028e733553f16df68c8af049357a">iax2_predestroy</a>(callno);
<a name="l04993"></a>04993       <span class="comment">/* If we were already gone to begin with, destroy us now */</span>
<a name="l04994"></a>04994       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] &amp;&amp; alreadygone) {
<a name="l04995"></a>04995          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Really destroying %s now...\n&quot;</span>, c-&gt;name);
<a name="l04996"></a>04996          <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l04997"></a>04997       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l04998"></a>04998          <span class="keywordflow">if</span> (<a class="code" href="sched_8h.html#acc6eead923ec328dcee53559dd3b8b60" title="Add a scheduler entry.">ast_sched_thread_add</a>(sched, 10000, <a class="code" href="chan__iax2_8c.html#a54d418013ac58cd364899046574d81b7">scheduled_destroy</a>, <a class="code" href="chan__iax2_8c.html#a7510329b1cbee3d732b54d94586a975c">CALLNO_TO_PTR</a>(callno)) &lt; 0) {
<a name="l04999"></a>04999             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to schedule iax2 callno %d destruction?!!  Destroying immediately.\n&quot;</span>, callno);
<a name="l05000"></a>05000             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l05001"></a>05001          }
<a name="l05002"></a>05002       }
<a name="l05003"></a>05003    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>) {
<a name="l05004"></a>05004       <span class="comment">/* If this call no longer exists, but the channel still</span>
<a name="l05005"></a>05005 <span class="comment">       * references it we need to set the channel&apos;s tech_pvt to null</span>
<a name="l05006"></a>05006 <span class="comment">       * to avoid ast_channel_free() trying to free it.</span>
<a name="l05007"></a>05007 <span class="comment">       */</span>
<a name="l05008"></a>05008       c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = NULL;
<a name="l05009"></a>05009    }
<a name="l05010"></a>05010    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05011"></a>05011    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Hungup &apos;%s&apos;\n&quot;</span>, c-&gt;name);
<a name="l05012"></a>05012    <span class="keywordflow">return</span> 0;
<a name="l05013"></a>05013 }
<a name="l05014"></a>05014 <span class="comment"></span>
<a name="l05015"></a>05015 <span class="comment">/*!</span>
<a name="l05016"></a>05016 <span class="comment"> * \note expects the pvt to be locked</span>
<a name="l05017"></a>05017 <span class="comment"> */</span>
<a name="l05018"></a><a class="code" href="chan__iax2_8c.html#a2062ac1e97e8edfd00b53ed7b10ccde7">05018</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2062ac1e97e8edfd00b53ed7b10ccde7">wait_for_peercallno</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l05019"></a>05019 {
<a name="l05020"></a>05020    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l05021"></a>05021 
<a name="l05022"></a>05022    <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l05023"></a>05023       <span class="comment">/* We don&apos;t know the remote side&apos;s call number, yet.  :( */</span>
<a name="l05024"></a>05024       <span class="keywordtype">int</span> count = 10;
<a name="l05025"></a>05025       <span class="keywordflow">while</span> (count-- &amp;&amp; pvt &amp;&amp; !pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l05026"></a>05026          <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05027"></a>05027          pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l05028"></a>05028       }
<a name="l05029"></a>05029       <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l05030"></a>05030          <span class="keywordflow">return</span> -1;
<a name="l05031"></a>05031       }
<a name="l05032"></a>05032    }
<a name="l05033"></a>05033 
<a name="l05034"></a>05034    <span class="keywordflow">return</span> 0;
<a name="l05035"></a>05035 }
<a name="l05036"></a>05036 
<a name="l05037"></a><a class="code" href="chan__iax2_8c.html#a1fd7477447da4f351cec9185cde8cd8e">05037</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1fd7477447da4f351cec9185cde8cd8e">iax2_setoption</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> option, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> datalen)
<a name="l05038"></a>05038 {
<a name="l05039"></a>05039    <span class="keyword">struct </span><a class="code" href="structast__option__header.html">ast_option_header</a> *h;
<a name="l05040"></a>05040    <span class="keywordtype">int</span> res;
<a name="l05041"></a>05041 
<a name="l05042"></a>05042    <span class="keywordflow">switch</span> (option) {
<a name="l05043"></a>05043    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#abcf55626860f173284cafa474946d9b2">AST_OPTION_TXGAIN</a>:
<a name="l05044"></a>05044    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>:
<a name="l05045"></a>05045       <span class="comment">/* these two cannot be sent, because they require a result */</span>
<a name="l05046"></a>05046       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOSYS;
<a name="l05047"></a>05047       <span class="keywordflow">return</span> -1;
<a name="l05048"></a>05048    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a5cb9d9050e5d0ec07f7c85849aea5b52">AST_OPTION_OPRMODE</a>:
<a name="l05049"></a>05049       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = EINVAL;
<a name="l05050"></a>05050       <span class="keywordflow">return</span> -1;
<a name="l05051"></a>05051    <span class="keywordflow">default</span>:
<a name="l05052"></a>05052    {
<a name="l05053"></a>05053       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l05054"></a>05054       <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt;
<a name="l05055"></a>05055 
<a name="l05056"></a>05056       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05057"></a>05057       pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l05058"></a>05058 
<a name="l05059"></a>05059       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2062ac1e97e8edfd00b53ed7b10ccde7">wait_for_peercallno</a>(pvt)) {
<a name="l05060"></a>05060          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05061"></a>05061          <span class="keywordflow">return</span> -1;
<a name="l05062"></a>05062       }
<a name="l05063"></a>05063 
<a name="l05064"></a>05064       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05065"></a>05065 
<a name="l05066"></a>05066       <span class="keywordflow">if</span> (!(h = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(datalen + <span class="keyword">sizeof</span>(*h)))) {
<a name="l05067"></a>05067          <span class="keywordflow">return</span> -1;
<a name="l05068"></a>05068       }
<a name="l05069"></a>05069 
<a name="l05070"></a>05070       h-&gt;flag = <a class="code" href="frame_8h.html#aaec646e296938635ffb97c5c7d6b05c8">AST_OPTION_FLAG_REQUEST</a>;
<a name="l05071"></a>05071       h-&gt;option = htons(option);
<a name="l05072"></a>05072       memcpy(h-&gt;<a class="code" href="structast__option__header.html#ac3c027f9a365f5741871df5ace13943f">data</a>, data, datalen);
<a name="l05073"></a>05073       res = <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>), <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>,
<a name="l05074"></a>05074                  <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ac4106406e269667ff84ee49e0a634f94">AST_CONTROL_OPTION</a>, 0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) h,
<a name="l05075"></a>05075                  datalen + <span class="keyword">sizeof</span>(*h), -1);
<a name="l05076"></a>05076       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(h);
<a name="l05077"></a>05077       <span class="keywordflow">return</span> res;
<a name="l05078"></a>05078    }
<a name="l05079"></a>05079    }
<a name="l05080"></a>05080 }
<a name="l05081"></a>05081 
<a name="l05082"></a><a class="code" href="chan__iax2_8c.html#a58daa5f05740960810f983135b4e1ee4">05082</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="chan__iax2_8c.html#a58daa5f05740960810f983135b4e1ee4">iax2_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c) 
<a name="l05083"></a>05083 {
<a name="l05084"></a>05084    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;I should never be called!\n&quot;</span>);
<a name="l05085"></a>05085    <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l05086"></a>05086 }
<a name="l05087"></a>05087 
<a name="l05088"></a><a class="code" href="chan__iax2_8c.html#a50fba0ffe0bf2ecf5b6ae9d056ceb15e">05088</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a50fba0ffe0bf2ecf5b6ae9d056ceb15e">iax2_key_rotate</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *vpvt)
<a name="l05089"></a>05089 {
<a name="l05090"></a>05090    <span class="keywordtype">int</span> res = 0;
<a name="l05091"></a>05091    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = (<span class="keywordtype">void</span> *) vpvt;
<a name="l05092"></a>05092    <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l05093"></a>05093    <span class="keywordtype">char</span> key[17] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05094"></a>05094    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied = {
<a name="l05095"></a>05095       .<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a> = 0,   
<a name="l05096"></a>05096    };
<a name="l05097"></a>05097    
<a name="l05098"></a>05098    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l05099"></a>05099    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">keyrotateid</a> = 
<a name="l05100"></a>05100       <a class="code" href="sched_8h.html#acc6eead923ec328dcee53559dd3b8b60" title="Add a scheduler entry.">ast_sched_thread_add</a>(sched, 120000 + (<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % 180001), <a class="code" href="chan__iax2_8c.html#a50fba0ffe0bf2ecf5b6ae9d056ceb15e">iax2_key_rotate</a>, vpvt);
<a name="l05101"></a>05101 
<a name="l05102"></a>05102    snprintf(key, <span class="keyword">sizeof</span>(key), <span class="stringliteral">&quot;%lX&quot;</span>, <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l05103"></a>05103 
<a name="l05104"></a>05104    <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l05105"></a>05105    <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) key, strlen(key));
<a name="l05106"></a>05106    <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) key, &amp;md5);
<a name="l05107"></a>05107 
<a name="l05108"></a>05108    <a class="code" href="chan__iax2_8c.html#a70f36235709ab44d3a046577cb5dc40e">IAX_DEBUGDIGEST</a>(<span class="stringliteral">&quot;Sending&quot;</span>, key);
<a name="l05109"></a>05109 
<a name="l05110"></a>05110    <a class="code" href="iax2-parser_8c.html#aa54841eb569031c28321281dcd31e4f3">iax_ie_append_raw</a>(&amp;ied, <a class="code" href="iax2_8h.html#afdfe925c29c3385317252633f5cf74d1">IAX_IE_CHALLENGE</a>, key, 16);
<a name="l05111"></a>05111 
<a name="l05112"></a>05112    res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(pvt, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae414fa2006b58341d7f3679d131d3327">IAX_COMMAND_RTKEY</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l05113"></a>05113 
<a name="l05114"></a>05114    <a class="code" href="chan__iax2_8c.html#a623a7a7afa10106e5dff18a2540ba34e">build_ecx_key</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) key, pvt);
<a name="l05115"></a>05115 
<a name="l05116"></a>05116    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l05117"></a>05117 
<a name="l05118"></a>05118    <span class="keywordflow">return</span> res;
<a name="l05119"></a>05119 }
<a name="l05120"></a>05120 
<a name="l05121"></a><a class="code" href="chan__iax2_8c.html#a38cd6523d8ff4bdab9191bf5ef686f7c">05121</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a38cd6523d8ff4bdab9191bf5ef686f7c">iax2_start_transfer</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno0, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno1, <span class="keywordtype">int</span> mediaonly)
<a name="l05122"></a>05122 {
<a name="l05123"></a>05123    <span class="keywordtype">int</span> res;
<a name="l05124"></a>05124    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied0;
<a name="l05125"></a>05125    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied1;
<a name="l05126"></a>05126    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> transferid = (<span class="keywordtype">unsigned</span> int)<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>();
<a name="l05127"></a>05127 
<a name="l05128"></a>05128    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a3d9496bb3807918ec2fef65f1d25f6e5">IAX_CALLENCRYPTED</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]) || <a class="code" href="chan__iax2_8c.html#a3d9496bb3807918ec2fef65f1d25f6e5">IAX_CALLENCRYPTED</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1])) {
<a name="l05129"></a>05129       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;transfers are not supported for encrypted calls at this time&quot;</span>);
<a name="l05130"></a>05130       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>);
<a name="l05131"></a>05131       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>);
<a name="l05132"></a>05132       <span class="keywordflow">return</span> 0;
<a name="l05133"></a>05133    }
<a name="l05134"></a>05134 
<a name="l05135"></a>05135    memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l05136"></a>05136    <a class="code" href="iax2-parser_8c.html#a3f0c77bd0c7403e0ca0340006e1260d7">iax_ie_append_addr</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ac0ffc43863d8212c5ddfe5ee71bbac9a">IAX_IE_APPARENT_ADDR</a>, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l05137"></a>05137    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;peercallno);
<a name="l05138"></a>05138    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a26484916834eef30492cc1548209c863">IAX_IE_TRANSFERID</a>, transferid);
<a name="l05139"></a>05139 
<a name="l05140"></a>05140    memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l05141"></a>05141    <a class="code" href="iax2-parser_8c.html#a3f0c77bd0c7403e0ca0340006e1260d7">iax_ie_append_addr</a>(&amp;ied1, <a class="code" href="iax2_8h.html#ac0ffc43863d8212c5ddfe5ee71bbac9a">IAX_IE_APPARENT_ADDR</a>, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l05142"></a>05142    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied1, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;peercallno);
<a name="l05143"></a>05143    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied1, <a class="code" href="iax2_8h.html#a26484916834eef30492cc1548209c863">IAX_IE_TRANSFERID</a>, transferid);
<a name="l05144"></a>05144    
<a name="l05145"></a>05145    res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae3c92188ac1dca64149abbf8c89326c7">IAX_COMMAND_TXREQ</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l05146"></a>05146    <span class="keywordflow">if</span> (res)
<a name="l05147"></a>05147       <span class="keywordflow">return</span> -1;
<a name="l05148"></a>05148    res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae3c92188ac1dca64149abbf8c89326c7">IAX_COMMAND_TXREQ</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l05149"></a>05149    <span class="keywordflow">if</span> (res)
<a name="l05150"></a>05150       <span class="keywordflow">return</span> -1;
<a name="l05151"></a>05151    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> = mediaonly ? <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6aaba79bebe929b7016a3cad879cd6ddfa">TRANSFER_MBEGIN</a> : <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">TRANSFER_BEGIN</a>;
<a name="l05152"></a>05152    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> = mediaonly ? <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6aaba79bebe929b7016a3cad879cd6ddfa">TRANSFER_MBEGIN</a> : <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">TRANSFER_BEGIN</a>;
<a name="l05153"></a>05153    <span class="keywordflow">return</span> 0;
<a name="l05154"></a>05154 }
<a name="l05155"></a>05155 
<a name="l05156"></a><a class="code" href="chan__iax2_8c.html#a61458eeb138a42e03c475ddf0a024011">05156</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a61458eeb138a42e03c475ddf0a024011">lock_both</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno0, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno1)
<a name="l05157"></a>05157 {
<a name="l05158"></a>05158    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno0]);
<a name="l05159"></a>05159    <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#a036ccafa2339f674a46bc269bbd48c5f">ast_mutex_trylock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno1])) {
<a name="l05160"></a>05160       <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno0]);
<a name="l05161"></a>05161    }
<a name="l05162"></a>05162 }
<a name="l05163"></a>05163 
<a name="l05164"></a><a class="code" href="chan__iax2_8c.html#ad1f1b9674e33da262e20227093ee408d">05164</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ad1f1b9674e33da262e20227093ee408d">unlock_both</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno0, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno1)
<a name="l05165"></a>05165 {
<a name="l05166"></a>05166    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno1]);
<a name="l05167"></a>05167    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno0]);
<a name="l05168"></a>05168 }
<a name="l05169"></a>05169 
<a name="l05170"></a><a class="code" href="chan__iax2_8c.html#a2ac728e203e330d25beb144f2ccbac7f">05170</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> <a class="code" href="chan__iax2_8c.html#a2ac728e203e330d25beb144f2ccbac7f">iax2_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c1, <span class="keywordtype">int</span> flags, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> **fo, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **rc, <span class="keywordtype">int</span> timeoutms)
<a name="l05171"></a>05171 {
<a name="l05172"></a>05172    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *cs[3];
<a name="l05173"></a>05173    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *who, *other;
<a name="l05174"></a>05174    <span class="keywordtype">int</span> to = -1;
<a name="l05175"></a>05175    <span class="keywordtype">int</span> res = -1;
<a name="l05176"></a>05176    <span class="keywordtype">int</span> transferstarted=0;
<a name="l05177"></a>05177    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l05178"></a>05178    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno0 = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l05179"></a>05179    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno1 = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l05180"></a>05180    <span class="keyword">struct </span>timeval waittimer = {0, 0};
<a name="l05181"></a>05181 
<a name="l05182"></a>05182    <span class="comment">/* We currently do not support native bridging if a timeoutms value has been provided */</span>
<a name="l05183"></a>05183    <span class="keywordflow">if</span> (timeoutms &gt; 0) {
<a name="l05184"></a>05184       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l05185"></a>05185    }
<a name="l05186"></a>05186 
<a name="l05187"></a>05187    timeoutms = -1;
<a name="l05188"></a>05188 
<a name="l05189"></a>05189    <a class="code" href="chan__iax2_8c.html#a61458eeb138a42e03c475ddf0a024011">lock_both</a>(callno0, callno1);
<a name="l05190"></a>05190    <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0] || !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]) {
<a name="l05191"></a>05191       <a class="code" href="chan__iax2_8c.html#ad1f1b9674e33da262e20227093ee408d">unlock_both</a>(callno0, callno1);
<a name="l05192"></a>05192       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l05193"></a>05193    }
<a name="l05194"></a>05194    <span class="comment">/* Put them in native bridge mode */</span>
<a name="l05195"></a>05195    <span class="keywordflow">if</span> (!(flags &amp; (<a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a> | <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>))) {
<a name="l05196"></a>05196       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = callno1;
<a name="l05197"></a>05197       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = callno0;
<a name="l05198"></a>05198    }
<a name="l05199"></a>05199    <a class="code" href="chan__iax2_8c.html#ad1f1b9674e33da262e20227093ee408d">unlock_both</a>(callno0, callno1);
<a name="l05200"></a>05200 
<a name="l05201"></a>05201    <span class="comment">/* If not, try to bridge until we can execute a transfer, if we can */</span>
<a name="l05202"></a>05202    cs[0] = c0;
<a name="l05203"></a>05203    cs[1] = c1;
<a name="l05204"></a>05204    <span class="keywordflow">for</span> (<span class="comment">/* ever */</span>;;) {
<a name="l05205"></a>05205       <span class="comment">/* Check in case we got masqueraded into */</span>
<a name="l05206"></a>05206       <span class="keywordflow">if</span> ((c0-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> != &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>) || (c1-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> != &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>)) {
<a name="l05207"></a>05207          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Can&apos;t masquerade, we&apos;re different...\n&quot;</span>);
<a name="l05208"></a>05208          <span class="comment">/* Remove from native mode */</span>
<a name="l05209"></a>05209          <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> == &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>) {
<a name="l05210"></a>05210             <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno0]);
<a name="l05211"></a>05211             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = 0;
<a name="l05212"></a>05212             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno0]);
<a name="l05213"></a>05213          }
<a name="l05214"></a>05214          <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> == &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>) {
<a name="l05215"></a>05215             <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno1]);
<a name="l05216"></a>05216             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = 0;
<a name="l05217"></a>05217             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno1]);
<a name="l05218"></a>05218          }
<a name="l05219"></a>05219          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l05220"></a>05220       }
<a name="l05221"></a>05221       <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> != c1-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>) {
<a name="l05222"></a>05222             <span class="keywordtype">char</span> buf0[255];
<a name="l05223"></a>05223             <span class="keywordtype">char</span> buf1[255];
<a name="l05224"></a>05224             <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(buf0, <span class="keyword">sizeof</span>(buf0) -1, c0-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>);
<a name="l05225"></a>05225             <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(buf1, <span class="keyword">sizeof</span>(buf1) -1, c1-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>);
<a name="l05226"></a>05226          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Operating with different codecs %d[%s] %d[%s] , can&apos;t native bridge...\n&quot;</span>, c0-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, buf0, c1-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>, buf1);
<a name="l05227"></a>05227          <span class="comment">/* Remove from native mode */</span>
<a name="l05228"></a>05228          <a class="code" href="chan__iax2_8c.html#a61458eeb138a42e03c475ddf0a024011">lock_both</a>(callno0, callno1);
<a name="l05229"></a>05229          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0])
<a name="l05230"></a>05230             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = 0;
<a name="l05231"></a>05231          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1])
<a name="l05232"></a>05232             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = 0;
<a name="l05233"></a>05233          <a class="code" href="chan__iax2_8c.html#ad1f1b9674e33da262e20227093ee408d">unlock_both</a>(callno0, callno1);
<a name="l05234"></a>05234          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l05235"></a>05235       }
<a name="l05236"></a>05236       <span class="comment">/* check if transfered and if we really want native bridging */</span>
<a name="l05237"></a>05237       <span class="keywordflow">if</span> (!transferstarted &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>) &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>)) {
<a name="l05238"></a>05238          <span class="comment">/* Try the transfer */</span>
<a name="l05239"></a>05239          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a38cd6523d8ff4bdab9191bf5ef686f7c">iax2_start_transfer</a>(callno0, callno1, (flags &amp; (<a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a> | <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>)) ||
<a name="l05240"></a>05240                      <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>) | <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>)))
<a name="l05241"></a>05241             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start the transfer\n&quot;</span>);
<a name="l05242"></a>05242          transferstarted = 1;
<a name="l05243"></a>05243       }
<a name="l05244"></a>05244       <span class="keywordflow">if</span> ((<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6acbf3b44134a197e4b10c6493a809b2bc">TRANSFER_RELEASED</a>) &amp;&amp; (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6acbf3b44134a197e4b10c6493a809b2bc">TRANSFER_RELEASED</a>)) {
<a name="l05245"></a>05245          <span class="comment">/* Call has been transferred.  We&apos;re no longer involved */</span>
<a name="l05246"></a>05246          <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05247"></a>05247          <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(waittimer)) {
<a name="l05248"></a>05248             waittimer = now;
<a name="l05249"></a>05249          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (now.tv_sec - waittimer.tv_sec &gt; <a class="code" href="iax2_8h.html#a078bf9a90761328aa7a5034fe7c1f5a2">IAX_LINGER_TIMEOUT</a>) {
<a name="l05250"></a>05250             c0-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> |= <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2e185ce313026e13ed90ae3a319c9cb7">AST_SOFTHANGUP_DEV</a>;
<a name="l05251"></a>05251             c1-&gt;<a class="code" href="structast__channel.html#a7386ba9cc89b0b446f553a4d0f36576a">_softhangup</a> |= <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2e185ce313026e13ed90ae3a319c9cb7">AST_SOFTHANGUP_DEV</a>;
<a name="l05252"></a>05252             *fo = NULL;
<a name="l05253"></a>05253             *rc = c0;
<a name="l05254"></a>05254             res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l05255"></a>05255             <span class="keywordflow">break</span>;
<a name="l05256"></a>05256          }
<a name="l05257"></a>05257       }
<a name="l05258"></a>05258       to = 1000;
<a name="l05259"></a>05259       who = <a class="code" href="channel_8h.html#aec8ce59b78afbd3651f3de011f13290a" title="Waits for input on a group of channels Wait for input on an array of channels for...">ast_waitfor_n</a>(cs, 2, &amp;to);
<a name="l05260"></a>05260       <span class="keywordflow">if</span> (timeoutms &gt; -1) {
<a name="l05261"></a>05261          timeoutms -= (1000 - to);
<a name="l05262"></a>05262          <span class="keywordflow">if</span> (timeoutms &lt; 0)
<a name="l05263"></a>05263             timeoutms = 0;
<a name="l05264"></a>05264       }
<a name="l05265"></a>05265       <span class="keywordflow">if</span> (!who) {
<a name="l05266"></a>05266          <span class="keywordflow">if</span> (!timeoutms) {
<a name="l05267"></a>05267             res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ac83c1441a620f7bdae5ef84692f8e7a5">AST_BRIDGE_RETRY</a>;
<a name="l05268"></a>05268             <span class="keywordflow">break</span>;
<a name="l05269"></a>05269          }
<a name="l05270"></a>05270          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c0) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c1)) {
<a name="l05271"></a>05271             res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l05272"></a>05272             <span class="keywordflow">break</span>;
<a name="l05273"></a>05273          }
<a name="l05274"></a>05274          <span class="keywordflow">continue</span>;
<a name="l05275"></a>05275       }
<a name="l05276"></a>05276       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(who);
<a name="l05277"></a>05277       <span class="keywordflow">if</span> (!f) {
<a name="l05278"></a>05278          *fo = NULL;
<a name="l05279"></a>05279          *rc = who;
<a name="l05280"></a>05280          res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l05281"></a>05281          <span class="keywordflow">break</span>;
<a name="l05282"></a>05282       }
<a name="l05283"></a>05283       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) &amp;&amp; !(flags &amp; <a class="code" href="channel_8h.html#aed24107184d7fd2cfb1ad32cba4d6bfd" title="Ignore all signal frames except NULL.">AST_BRIDGE_IGNORE_SIGS</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a009e81151b19671f42b5e84ab6a619f4">AST_CONTROL_SRCUPDATE</a>)) {
<a name="l05284"></a>05284          *fo = f;
<a name="l05285"></a>05285          *rc = who;
<a name="l05286"></a>05286          res =  <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l05287"></a>05287          <span class="keywordflow">break</span>;
<a name="l05288"></a>05288       }
<a name="l05289"></a>05289       other = (who == c0) ? c1 : c0;  <span class="comment">/* the &apos;other&apos; channel */</span>
<a name="l05290"></a>05290       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) ||
<a name="l05291"></a>05291          (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>) ||
<a name="l05292"></a>05292          (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) || 
<a name="l05293"></a>05293          (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a>) ||
<a name="l05294"></a>05294          (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) ||
<a name="l05295"></a>05295          (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>)) {
<a name="l05296"></a>05296          <span class="comment">/* monitored dtmf take out of the bridge.</span>
<a name="l05297"></a>05297 <span class="comment">          * check if we monitor the specific source.</span>
<a name="l05298"></a>05298 <span class="comment">          */</span>
<a name="l05299"></a>05299          <span class="keywordtype">int</span> monitored_source = (who == c0) ? <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a> : <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>;
<a name="l05300"></a>05300          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a> &amp;&amp; (flags &amp; monitored_source)) {
<a name="l05301"></a>05301             *rc = who;
<a name="l05302"></a>05302             *fo = f;
<a name="l05303"></a>05303             res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l05304"></a>05304             <span class="comment">/* Remove from native mode */</span>
<a name="l05305"></a>05305             <span class="keywordflow">break</span>;
<a name="l05306"></a>05306          }
<a name="l05307"></a>05307          <span class="comment">/* everything else goes to the other side */</span>
<a name="l05308"></a>05308          <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(other, f);
<a name="l05309"></a>05309       }
<a name="l05310"></a>05310       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l05311"></a>05311       <span class="comment">/* Swap who gets priority */</span>
<a name="l05312"></a>05312       cs[2] = cs[0];
<a name="l05313"></a>05313       cs[0] = cs[1];
<a name="l05314"></a>05314       cs[1] = cs[2];
<a name="l05315"></a>05315    }
<a name="l05316"></a>05316    <a class="code" href="chan__iax2_8c.html#a61458eeb138a42e03c475ddf0a024011">lock_both</a>(callno0, callno1);
<a name="l05317"></a>05317    <span class="keywordflow">if</span>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0])
<a name="l05318"></a>05318       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno0]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = 0;
<a name="l05319"></a>05319    <span class="keywordflow">if</span>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1])
<a name="l05320"></a>05320       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno1]-&gt;<a class="code" href="structchan__iax2__pvt.html#a516382e6c7513af7c7e7db9dc197ab6c">bridgecallno</a> = 0;
<a name="l05321"></a>05321    <a class="code" href="chan__iax2_8c.html#ad1f1b9674e33da262e20227093ee408d">unlock_both</a>(callno0, callno1);
<a name="l05322"></a>05322    <span class="keywordflow">return</span> res;
<a name="l05323"></a>05323 }
<a name="l05324"></a>05324 
<a name="l05325"></a><a class="code" href="chan__iax2_8c.html#a76f9db3943af0e0cf07ded5f2f6640c3">05325</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a76f9db3943af0e0cf07ded5f2f6640c3">iax2_answer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c)
<a name="l05326"></a>05326 {
<a name="l05327"></a>05327    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l05328"></a>05328    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Answering IAX2 call\n&quot;</span>);
<a name="l05329"></a>05329    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05330"></a>05330    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])
<a name="l05331"></a>05331       <a class="code" href="chan__iax2_8c.html#a5c6ae109c64e40ee02e813f6dc1e01b7" title="Send manager event at call setup to link between Asterisk channel name and IAX2 call...">iax2_ami_channelupdate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]);
<a name="l05332"></a>05332    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05333"></a>05333    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(callno, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a9e3135920bd5bdbfd8c57fdaaa6b1dbe">AST_CONTROL_ANSWER</a>, 0, NULL, 0, -1);
<a name="l05334"></a>05334 }
<a name="l05335"></a>05335 
<a name="l05336"></a><a class="code" href="chan__iax2_8c.html#a01c296968962704d146fb5d092dae41d">05336</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a01c296968962704d146fb5d092dae41d">iax2_indicate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keywordtype">int</span> condition, <span class="keyword">const</span> <span class="keywordtype">void</span> *data, <span class="keywordtype">size_t</span> datalen)
<a name="l05337"></a>05337 {
<a name="l05338"></a>05338    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l05339"></a>05339    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt;
<a name="l05340"></a>05340    <span class="keywordtype">int</span> res = 0;
<a name="l05341"></a>05341 
<a name="l05342"></a>05342    <span class="keywordflow">if</span> (iaxdebug)
<a name="l05343"></a>05343       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Indicating condition %d\n&quot;</span>, condition);
<a name="l05344"></a>05344 
<a name="l05345"></a>05345    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05346"></a>05346    pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l05347"></a>05347 
<a name="l05348"></a>05348    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a2062ac1e97e8edfd00b53ed7b10ccde7">wait_for_peercallno</a>(pvt)) {
<a name="l05349"></a>05349       res = -1;
<a name="l05350"></a>05350       <span class="keywordflow">goto</span> done;
<a name="l05351"></a>05351    }
<a name="l05352"></a>05352 
<a name="l05353"></a>05353    <span class="keywordflow">switch</span> (condition) {
<a name="l05354"></a>05354    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l05355"></a>05355       <span class="keywordflow">if</span> (strcasecmp(pvt-&gt;mohinterpret, <span class="stringliteral">&quot;passthrough&quot;</span>)) {
<a name="l05356"></a>05356          <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(c, data, pvt-&gt;mohinterpret);
<a name="l05357"></a>05357          <span class="keywordflow">goto</span> done;
<a name="l05358"></a>05358       }
<a name="l05359"></a>05359       <span class="keywordflow">break</span>;
<a name="l05360"></a>05360    <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>:
<a name="l05361"></a>05361       <span class="keywordflow">if</span> (strcasecmp(pvt-&gt;mohinterpret, <span class="stringliteral">&quot;passthrough&quot;</span>)) {
<a name="l05362"></a>05362          <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(c);
<a name="l05363"></a>05363          <span class="keywordflow">goto</span> done;
<a name="l05364"></a>05364       }
<a name="l05365"></a>05365    }
<a name="l05366"></a>05366 
<a name="l05367"></a>05367    res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(pvt, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, condition, 0, data, datalen, -1);
<a name="l05368"></a>05368 
<a name="l05369"></a>05369 done:
<a name="l05370"></a>05370    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05371"></a>05371 
<a name="l05372"></a>05372    <span class="keywordflow">return</span> res;
<a name="l05373"></a>05373 }
<a name="l05374"></a>05374    
<a name="l05375"></a><a class="code" href="chan__iax2_8c.html#a5ce66d44a2d37c60cb143d6a0335a708">05375</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5ce66d44a2d37c60cb143d6a0335a708">iax2_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">const</span> <span class="keywordtype">char</span> *dest)
<a name="l05376"></a>05376 {
<a name="l05377"></a>05377    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l05378"></a>05378    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied = { <span class="stringliteral">&quot;&quot;</span>, };
<a name="l05379"></a>05379    <span class="keywordtype">char</span> tmp[256], *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l05380"></a>05380    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, dest, <span class="keyword">sizeof</span>(tmp));
<a name="l05381"></a>05381    context = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>);
<a name="l05382"></a>05382    <span class="keywordflow">if</span> (context) {
<a name="l05383"></a>05383       *context = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05384"></a>05384       context++;
<a name="l05385"></a>05385    }
<a name="l05386"></a>05386    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#aa0f5d6e9b74df33a17772be8afde5bc7">IAX_IE_CALLED_NUMBER</a>, tmp);
<a name="l05387"></a>05387    <span class="keywordflow">if</span> (context)
<a name="l05388"></a>05388       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#af19a0a52d9c678fd55a44e6cda94cd88">IAX_IE_CALLED_CONTEXT</a>, context);
<a name="l05389"></a>05389    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Transferring &apos;%s&apos; to &apos;%s&apos;\n&quot;</span>, c-&gt;name, dest);
<a name="l05390"></a>05390    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(callno, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa6e92b95649c6f900a7bc462c9d7e9a5d">IAX_COMMAND_TRANSFER</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l05391"></a>05391 }
<a name="l05392"></a>05392    
<a name="l05393"></a><a class="code" href="chan__iax2_8c.html#a7a94cd46cfec615b4cdd51a3be450d19">05393</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a7a94cd46cfec615b4cdd51a3be450d19">iax2_getpeertrunk</a>(<span class="keyword">struct</span> sockaddr_in sin)
<a name="l05394"></a>05394 {
<a name="l05395"></a>05395    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l05396"></a>05396    <span class="keywordtype">int</span> res = 0;
<a name="l05397"></a>05397    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l05398"></a>05398 
<a name="l05399"></a>05399    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l05400"></a>05400    <span class="keywordflow">while</span> ((peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l05401"></a>05401       <span class="keywordflow">if</span> ((peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr == sin.sin_addr.s_addr) &amp;&amp;
<a name="l05402"></a>05402           (peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port == sin.sin_port)) {
<a name="l05403"></a>05403          res = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);
<a name="l05404"></a>05404          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l05405"></a>05405          <span class="keywordflow">break</span>;
<a name="l05406"></a>05406       }
<a name="l05407"></a>05407       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l05408"></a>05408    }
<a name="l05409"></a>05409    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l05410"></a>05410 
<a name="l05411"></a>05411    <span class="keywordflow">return</span> res;
<a name="l05412"></a>05412 }
<a name="l05413"></a>05413 <span class="comment"></span>
<a name="l05414"></a>05414 <span class="comment">/*! \brief  Create new call, interface with the PBX core */</span>
<a name="l05415"></a><a class="code" href="chan__iax2_8c.html#ab8c22a71161e0538ccb120e3ca5abdd2">05415</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__iax2_8c.html#ab8c22a71161e0538ccb120e3ca5abdd2" title="Create new call, interface with the PBX core.">ast_iax2_new</a>(<span class="keywordtype">int</span> callno, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>, <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>)
<a name="l05416"></a>05416 {
<a name="l05417"></a>05417    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *tmp;
<a name="l05418"></a>05418    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *i;
<a name="l05419"></a>05419    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v = NULL;
<a name="l05420"></a>05420 
<a name="l05421"></a>05421    <span class="keywordflow">if</span> (!(i = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])) {
<a name="l05422"></a>05422       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No IAX2 pvt found for callno &apos;%d&apos; !\n&quot;</span>, callno);
<a name="l05423"></a>05423       <span class="keywordflow">return</span> NULL;
<a name="l05424"></a>05424    }
<a name="l05425"></a>05425 
<a name="l05426"></a>05426    <span class="comment">/* Don&apos;t hold call lock */</span>
<a name="l05427"></a>05427    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05428"></a>05428    tmp = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(1, state, i-&gt;cid_num, i-&gt;cid_name, i-&gt;accountcode, i-&gt;exten, i-&gt;context, i-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>, <span class="stringliteral">&quot;IAX2/%s-%d&quot;</span>, i-&gt;host, i-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l05429"></a>05429    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05430"></a>05430    <span class="keywordflow">if</span> (i != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l05431"></a>05431       <span class="keywordflow">if</span> (tmp) {
<a name="l05432"></a>05432          <span class="comment">/* unlock and relock iaxsl[callno] to preserve locking order */</span>
<a name="l05433"></a>05433          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05434"></a>05434          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(tmp);
<a name="l05435"></a>05435          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l05436"></a>05436       }
<a name="l05437"></a>05437       <span class="keywordflow">return</span> NULL;
<a name="l05438"></a>05438    }
<a name="l05439"></a>05439    <a class="code" href="chan__iax2_8c.html#a5c6ae109c64e40ee02e813f6dc1e01b7" title="Send manager event at call setup to link between Asterisk channel name and IAX2 call...">iax2_ami_channelupdate</a>(i);
<a name="l05440"></a>05440    <span class="keywordflow">if</span> (!tmp)
<a name="l05441"></a>05441       <span class="keywordflow">return</span> NULL;
<a name="l05442"></a>05442    tmp-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> = &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>;
<a name="l05443"></a>05443    <span class="comment">/* We can support any format by default, until we get restricted */</span>
<a name="l05444"></a>05444    tmp-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = capability;
<a name="l05445"></a>05445    tmp-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = tmp-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(capability);
<a name="l05446"></a>05446    tmp-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = tmp-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a> = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(capability);
<a name="l05447"></a>05447    tmp-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> = <a class="code" href="chan__iax2_8c.html#a7510329b1cbee3d732b54d94586a975c">CALLNO_TO_PTR</a>(i-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l05448"></a>05448 
<a name="l05449"></a>05449    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;parkinglot))
<a name="l05450"></a>05450       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>, i-&gt;parkinglot);
<a name="l05451"></a>05451    <span class="comment">/* Don&apos;t use ast_set_callerid() here because it will</span>
<a name="l05452"></a>05452 <span class="comment">    * generate a NewCallerID event before the NewChannel event */</span>
<a name="l05453"></a>05453    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;ani))
<a name="l05454"></a>05454       tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;ani);
<a name="l05455"></a>05455    <span class="keywordflow">else</span>
<a name="l05456"></a>05456       tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a7bb8ad258e687da69d6933ab48320df7">cid_ani</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;cid_num);
<a name="l05457"></a>05457    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aa54ab157f47ac529034d524781e2a7e2">cid_dnid</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;dnid);
<a name="l05458"></a>05458    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a4791c5f3aedc8782678867a1741f4131">cid_rdnis</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(i-&gt;rdnis);
<a name="l05459"></a>05459    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#a5674af3fa5ce1dd1fe052be1477d4110">cid_pres</a> = i-&gt;<a class="code" href="structchan__iax2__pvt.html#aa16fb44247d3656e98d82796a24c0ec6">calling_pres</a>;
<a name="l05460"></a>05460    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aff456ca48d31a9813584e799064cf88e">cid_ton</a> = i-&gt;<a class="code" href="structchan__iax2__pvt.html#a57eabf92fe7c9f440fe38fb529c57f91">calling_ton</a>;
<a name="l05461"></a>05461    tmp-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#aae7e57d784da2bfe6b85cb36516edca0">cid_tns</a> = i-&gt;<a class="code" href="structchan__iax2__pvt.html#a7ab4a847c94ceca414d76c2abe5587aa">calling_tns</a>;
<a name="l05462"></a>05462    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;language))
<a name="l05463"></a>05463       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, language, i-&gt;language);
<a name="l05464"></a>05464    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(i-&gt;accountcode))
<a name="l05465"></a>05465       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(tmp, accountcode, i-&gt;accountcode);
<a name="l05466"></a>05466    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>)
<a name="l05467"></a>05467       tmp-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> = i-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>;
<a name="l05468"></a>05468    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, i-&gt;context, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l05469"></a>05469    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, i-&gt;exten, <span class="keyword">sizeof</span>(tmp-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l05470"></a>05470    <span class="keywordflow">if</span> (i-&gt;<a class="code" href="structchan__iax2__pvt.html#a61fbadf21e15a109d0703a01e0302535">adsi</a>)
<a name="l05471"></a>05471       tmp-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = i-&gt;<a class="code" href="structchan__iax2__pvt.html#a078ad1b9bbd2dab166a844bdb0d89b5c">peeradsicpe</a>;
<a name="l05472"></a>05472    <span class="keywordflow">else</span>
<a name="l05473"></a>05473       tmp-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda5f0673b46cfdba3094393b3fbce084ff">AST_ADSI_UNAVAILABLE</a>;
<a name="l05474"></a>05474    i-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = tmp;
<a name="l05475"></a>05475    i-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = capability;
<a name="l05476"></a>05476 
<a name="l05477"></a>05477    <span class="comment">/* Set inherited variables */</span>
<a name="l05478"></a>05478    <span class="keywordflow">if</span> (i-&gt;vars) {
<a name="l05479"></a>05479       <span class="keywordflow">for</span> (v = i-&gt;vars ; v ; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>)
<a name="l05480"></a>05480          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(tmp, v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l05481"></a>05481    }
<a name="l05482"></a>05482    <span class="keywordflow">if</span> (i-&gt;iaxvars) {
<a name="l05483"></a>05483       <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore;
<a name="l05484"></a>05484       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *prev = NULL;
<a name="l05485"></a>05485       <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l05486"></a>05486       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Loading up the channel with IAXVARs\n&quot;</span>);
<a name="l05487"></a>05487       varlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*varlist));
<a name="l05488"></a>05488       variablestore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l05489"></a>05489       <span class="keywordflow">if</span> (variablestore &amp;&amp; varlist) {
<a name="l05490"></a>05490          variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = varlist;
<a name="l05491"></a>05491          variablestore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l05492"></a>05492          <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(varlist);
<a name="l05493"></a>05493          <span class="keywordflow">for</span> (var = i-&gt;iaxvars; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l05494"></a>05494             <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvar = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l05495"></a>05495             <span class="keywordflow">if</span> (prev)
<a name="l05496"></a>05496                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l05497"></a>05497             prev = var;
<a name="l05498"></a>05498             <span class="keywordflow">if</span> (!newvar) {
<a name="l05499"></a>05499                <span class="comment">/* Don&apos;t abort list traversal, as this would leave i-&gt;iaxvars in an inconsistent state. */</span>
<a name="l05500"></a>05500                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l05501"></a>05501             } <span class="keywordflow">else</span> {
<a name="l05502"></a>05502                <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(varlist, newvar, entries);
<a name="l05503"></a>05503             }
<a name="l05504"></a>05504          }
<a name="l05505"></a>05505          <span class="keywordflow">if</span> (prev)
<a name="l05506"></a>05506             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l05507"></a>05507          i-&gt;iaxvars = NULL;
<a name="l05508"></a>05508          <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(i-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, variablestore);
<a name="l05509"></a>05509       } <span class="keywordflow">else</span> {
<a name="l05510"></a>05510          <span class="keywordflow">if</span> (variablestore) {
<a name="l05511"></a>05511             <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(variablestore);
<a name="l05512"></a>05512          }
<a name="l05513"></a>05513          <span class="keywordflow">if</span> (varlist) {
<a name="l05514"></a>05514             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(varlist);
<a name="l05515"></a>05515          }
<a name="l05516"></a>05516       }
<a name="l05517"></a>05517    }
<a name="l05518"></a>05518 
<a name="l05519"></a>05519    <span class="keywordflow">if</span> (state != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>) {
<a name="l05520"></a>05520       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a9a937fbb3b5f4e68880a9c5714a29ce5" title="Create a new thread and start the PBX.">ast_pbx_start</a>(tmp)) {
<a name="l05521"></a>05521          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start PBX on %s\n&quot;</span>, tmp-&gt;name);
<a name="l05522"></a>05522          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(tmp);
<a name="l05523"></a>05523          i-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> = NULL;
<a name="l05524"></a>05524          <span class="keywordflow">return</span> NULL;
<a name="l05525"></a>05525       }
<a name="l05526"></a>05526    }
<a name="l05527"></a>05527 
<a name="l05528"></a>05528    <a class="code" href="module_8h.html#aa08fcee0b390e15532dd03803c8728c4">ast_module_ref</a>(<a class="code" href="structast__module__info.html">ast_module_info</a>-&gt;self);
<a name="l05529"></a>05529    <span class="keywordflow">return</span> tmp;
<a name="l05530"></a>05530 }
<a name="l05531"></a>05531 
<a name="l05532"></a><a class="code" href="chan__iax2_8c.html#a19e4c62d70e1ac30132e25bc553d1b91">05532</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a19e4c62d70e1ac30132e25bc553d1b91">calc_txpeerstamp</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer, <span class="keywordtype">int</span> sampms, <span class="keyword">struct</span> timeval *now)
<a name="l05533"></a>05533 {
<a name="l05534"></a>05534    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">int</span> mssincetx; <span class="comment">/* unsigned to handle overflows */</span>
<a name="l05535"></a>05535    <span class="keywordtype">long</span> <span class="keywordtype">int</span> ms, pred;
<a name="l05536"></a>05536 
<a name="l05537"></a>05537    tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">trunkact</a> = *now;
<a name="l05538"></a>05538    mssincetx = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(*now, tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a2147e507686c1caa0cb9e43f7e629b10">lasttxtime</a>);
<a name="l05539"></a>05539    <span class="keywordflow">if</span> (mssincetx &gt; 5000 || <a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#af0592c858aeacabf8566786c1bbd3f1f">txtrunktime</a>)) {
<a name="l05540"></a>05540       <span class="comment">/* If it&apos;s been at least 5 seconds since the last time we transmitted on this trunk, reset our timers */</span>
<a name="l05541"></a>05541       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#af0592c858aeacabf8566786c1bbd3f1f">txtrunktime</a> = *now;
<a name="l05542"></a>05542       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> = 999999;
<a name="l05543"></a>05543    }
<a name="l05544"></a>05544    <span class="comment">/* Update last transmit time now */</span>
<a name="l05545"></a>05545    tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a2147e507686c1caa0cb9e43f7e629b10">lasttxtime</a> = *now;
<a name="l05546"></a>05546    
<a name="l05547"></a>05547    <span class="comment">/* Calculate ms offset */</span>
<a name="l05548"></a>05548    ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(*now, tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#af0592c858aeacabf8566786c1bbd3f1f">txtrunktime</a>);
<a name="l05549"></a>05549    <span class="comment">/* Predict from last value */</span>
<a name="l05550"></a>05550    pred = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> + sampms;
<a name="l05551"></a>05551    <span class="keywordflow">if</span> (abs(ms - pred) &lt; <a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">MAX_TIMESTAMP_SKEW</a>)
<a name="l05552"></a>05552       ms = pred;
<a name="l05553"></a>05553    
<a name="l05554"></a>05554    <span class="comment">/* We never send the same timestamp twice, so fudge a little if we must */</span>
<a name="l05555"></a>05555    <span class="keywordflow">if</span> (ms == tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>)
<a name="l05556"></a>05556       ms = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> + 1;
<a name="l05557"></a>05557    tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> = ms;
<a name="l05558"></a>05558    <span class="keywordflow">return</span> ms;
<a name="l05559"></a>05559 }
<a name="l05560"></a>05560 
<a name="l05561"></a><a class="code" href="chan__iax2_8c.html#a27f837b22eb6b818a14725cc095cd72d">05561</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a27f837b22eb6b818a14725cc095cd72d">fix_peerts</a>(<span class="keyword">struct</span> timeval *<a class="code" href="structiax2__trunk__peer.html#a29f80e536bea489aed0b8ae715a60622">rxtrunktime</a>, <span class="keywordtype">int</span> callno, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts)
<a name="l05562"></a>05562 {
<a name="l05563"></a>05563    <span class="keywordtype">long</span> ms; <span class="comment">/* NOT unsigned */</span>
<a name="l05564"></a>05564    <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;rxcore)) {
<a name="l05565"></a>05565       <span class="comment">/* Initialize rxcore time if appropriate */</span>
<a name="l05566"></a>05566       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05567"></a>05567       <span class="comment">/* Round to nearest 20ms so traces look pretty */</span>
<a name="l05568"></a>05568       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec -= <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec % 20000;
<a name="l05569"></a>05569    }
<a name="l05570"></a>05570    <span class="comment">/* Calculate difference between trunk and channel */</span>
<a name="l05571"></a>05571    ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(*rxtrunktime, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;rxcore);
<a name="l05572"></a>05572    <span class="comment">/* Return as the sum of trunk time and the difference between trunk and real time */</span>
<a name="l05573"></a>05573    <span class="keywordflow">return</span> ms + ts;
<a name="l05574"></a>05574 }
<a name="l05575"></a>05575 
<a name="l05576"></a><a class="code" href="chan__iax2_8c.html#a9fd242af6fb851f79a5e184beb40933c">05576</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9fd242af6fb851f79a5e184beb40933c">calc_timestamp</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l05577"></a>05577 {
<a name="l05578"></a>05578    <span class="keywordtype">int</span> ms;
<a name="l05579"></a>05579    <span class="keywordtype">int</span> voice = 0;
<a name="l05580"></a>05580    <span class="keywordtype">int</span> genuine = 0;
<a name="l05581"></a>05581    <span class="keywordtype">int</span> adjust;
<a name="l05582"></a>05582    <span class="keywordtype">int</span> rate = <a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000;
<a name="l05583"></a>05583    <span class="keyword">struct </span>timeval *delivery = NULL;
<a name="l05584"></a>05584 
<a name="l05585"></a>05585 
<a name="l05586"></a>05586    <span class="comment">/* What sort of frame do we have?: voice is self-explanatory</span>
<a name="l05587"></a>05587 <span class="comment">      &quot;genuine&quot; means an IAX frame - things like LAGRQ/RP, PING/PONG, ACK</span>
<a name="l05588"></a>05588 <span class="comment">      non-genuine frames are CONTROL frames [ringing etc], DTMF</span>
<a name="l05589"></a>05589 <span class="comment">      The &quot;genuine&quot; distinction is needed because genuine frames must get a clock-based timestamp,</span>
<a name="l05590"></a>05590 <span class="comment">      the others need a timestamp slaved to the voice frames so that they go in sequence</span>
<a name="l05591"></a>05591 <span class="comment">   */</span>
<a name="l05592"></a>05592    <span class="keywordflow">if</span> (f) {
<a name="l05593"></a>05593       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l05594"></a>05594          voice = 1;
<a name="l05595"></a>05595          delivery = &amp;f-&gt;<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>;
<a name="l05596"></a>05596       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) {
<a name="l05597"></a>05597          genuine = 1;
<a name="l05598"></a>05598       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a8089c2a7198a1063db9e6c3f904482a4">AST_FRAME_CNG</a>) {
<a name="l05599"></a>05599          p-&gt;<a class="code" href="structchan__iax2__pvt.html#a5ae15e9f658a6de2719dc28dc735ed7f">notsilenttx</a> = 0;  
<a name="l05600"></a>05600       }
<a name="l05601"></a>05601    }
<a name="l05602"></a>05602    <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>)) {
<a name="l05603"></a>05603       p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05604"></a>05604       <span class="comment">/* Round to nearest 20ms for nice looking traces */</span>
<a name="l05605"></a>05605       p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>.tv_usec -= p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>.tv_usec % 20000;
<a name="l05606"></a>05606    }
<a name="l05607"></a>05607    <span class="comment">/* If the timestamp is specified, just send it as is */</span>
<a name="l05608"></a>05608    <span class="keywordflow">if</span> (ts)
<a name="l05609"></a>05609       <span class="keywordflow">return</span> ts;
<a name="l05610"></a>05610    <span class="comment">/* If we have a time that the frame arrived, always use it to make our timestamp */</span>
<a name="l05611"></a>05611    <span class="keywordflow">if</span> (delivery &amp;&amp; !<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(*delivery)) {
<a name="l05612"></a>05612       ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(*delivery, p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>);
<a name="l05613"></a>05613       <span class="keywordflow">if</span> (ms &lt; 0) {
<a name="l05614"></a>05614          ms = 0;
<a name="l05615"></a>05615       }
<a name="l05616"></a>05616       <span class="keywordflow">if</span> (iaxdebug)
<a name="l05617"></a>05617          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;calc_timestamp: call %d/%d: Timestamp slaved to delivery time\n&quot;</span>, p-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[p-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>);
<a name="l05618"></a>05618    } <span class="keywordflow">else</span> {
<a name="l05619"></a>05619       ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>);
<a name="l05620"></a>05620       <span class="keywordflow">if</span> (ms &lt; 0)
<a name="l05621"></a>05621          ms = 0;
<a name="l05622"></a>05622       <span class="keywordflow">if</span> (voice) {
<a name="l05623"></a>05623          <span class="comment">/* On a voice frame, use predicted values if appropriate */</span>
<a name="l05624"></a>05624          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a5ae15e9f658a6de2719dc28dc735ed7f">notsilenttx</a> &amp;&amp; abs(ms - p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a>) &lt;= <a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">MAX_TIMESTAMP_SKEW</a>) {
<a name="l05625"></a>05625             <span class="comment">/* Adjust our txcore, keeping voice and non-voice synchronized */</span>
<a name="l05626"></a>05626             <span class="comment">/* AN EXPLANATION:</span>
<a name="l05627"></a>05627 <span class="comment">               When we send voice, we usually send &quot;calculated&quot; timestamps worked out</span>
<a name="l05628"></a>05628 <span class="comment">               on the basis of the number of samples sent. When we send other frames,</span>
<a name="l05629"></a>05629 <span class="comment">               we usually send timestamps worked out from the real clock.</span>
<a name="l05630"></a>05630 <span class="comment">               The problem is that they can tend to drift out of step because the </span>
<a name="l05631"></a>05631 <span class="comment">                  source channel&apos;s clock and our clock may not be exactly at the same rate.</span>
<a name="l05632"></a>05632 <span class="comment">               We fix this by continuously &quot;tweaking&quot; p-&gt;offset.  p-&gt;offset is &quot;time zero&quot;</span>
<a name="l05633"></a>05633 <span class="comment">               for this call.  Moving it adjusts timestamps for non-voice frames.</span>
<a name="l05634"></a>05634 <span class="comment">               We make the adjustment in the style of a moving average.  Each time we</span>
<a name="l05635"></a>05635 <span class="comment">               adjust p-&gt;offset by 10% of the difference between our clock-derived</span>
<a name="l05636"></a>05636 <span class="comment">               timestamp and the predicted timestamp.  That&apos;s why you see &quot;10000&quot;</span>
<a name="l05637"></a>05637 <span class="comment">               below even though IAX2 timestamps are in milliseconds.</span>
<a name="l05638"></a>05638 <span class="comment">               The use of a moving average avoids offset moving too radically.</span>
<a name="l05639"></a>05639 <span class="comment">               Generally, &quot;adjust&quot; roams back and forth around 0, with offset hardly</span>
<a name="l05640"></a>05640 <span class="comment">               changing at all.  But if a consistent different starts to develop it</span>
<a name="l05641"></a>05641 <span class="comment">               will be eliminated over the course of 10 frames (200-300msecs) </span>
<a name="l05642"></a>05642 <span class="comment">            */</span>
<a name="l05643"></a>05643             adjust = (ms - p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a>);
<a name="l05644"></a>05644             <span class="keywordflow">if</span> (adjust &lt; 0)
<a name="l05645"></a>05645                p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a> = <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(abs(adjust), 10000));
<a name="l05646"></a>05646             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (adjust &gt; 0)
<a name="l05647"></a>05647                p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(adjust, 10000));
<a name="l05648"></a>05648 
<a name="l05649"></a>05649             <span class="keywordflow">if</span> (!p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a>) {
<a name="l05650"></a>05650                p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> = ms; <span class="comment">/*f-&gt;samples / rate;*/</span>
<a name="l05651"></a>05651                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> &lt;= p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>)
<a name="l05652"></a>05652                   p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> + 3;
<a name="l05653"></a>05653             }
<a name="l05654"></a>05654             ms = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a>;
<a name="l05655"></a>05655          } <span class="keywordflow">else</span> {
<a name="l05656"></a>05656                 <span class="comment">/* in this case, just use the actual</span>
<a name="l05657"></a>05657 <span class="comment">            * time, since we&apos;re either way off</span>
<a name="l05658"></a>05658 <span class="comment">            * (shouldn&apos;t happen), or we&apos;re  ending a</span>
<a name="l05659"></a>05659 <span class="comment">            * silent period -- and seed the next</span>
<a name="l05660"></a>05660 <span class="comment">            * predicted time.  Also, round ms to the</span>
<a name="l05661"></a>05661 <span class="comment">            * next multiple of frame size (so our</span>
<a name="l05662"></a>05662 <span class="comment">            * silent periods are multiples of</span>
<a name="l05663"></a>05663 <span class="comment">            * frame size too) */</span>
<a name="l05664"></a>05664 
<a name="l05665"></a>05665             <span class="keywordflow">if</span> (iaxdebug &amp;&amp; abs(ms - p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a>) &gt; <a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">MAX_TIMESTAMP_SKEW</a> )
<a name="l05666"></a>05666                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;predicted timestamp skew (%u) &gt; max (%u), using real ts instead.\n&quot;</span>,
<a name="l05667"></a>05667                   abs(ms - p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a>), <a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">MAX_TIMESTAMP_SKEW</a>);
<a name="l05668"></a>05668 
<a name="l05669"></a>05669             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> &gt;= rate) <span class="comment">/* check to make sure we dont core dump */</span>
<a name="l05670"></a>05670             {
<a name="l05671"></a>05671                <span class="keywordtype">int</span> diff = ms % (f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> / rate);
<a name="l05672"></a>05672                <span class="keywordflow">if</span> (diff)
<a name="l05673"></a>05673                    ms += f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>/rate - diff;
<a name="l05674"></a>05674             }
<a name="l05675"></a>05675 
<a name="l05676"></a>05676             p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> = ms;
<a name="l05677"></a>05677             p-&gt;<a class="code" href="structchan__iax2__pvt.html#a5ae15e9f658a6de2719dc28dc735ed7f">notsilenttx</a> = 1;
<a name="l05678"></a>05678          }
<a name="l05679"></a>05679       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a> ) {
<a name="l05680"></a>05680          <span class="comment">/*</span>
<a name="l05681"></a>05681 <span class="comment">         * IAX2 draft 03 says that timestamps MUST be in order.</span>
<a name="l05682"></a>05682 <span class="comment">         * It does not say anything about several frames having the same timestamp</span>
<a name="l05683"></a>05683 <span class="comment">         * When transporting video, we can have a frame that spans multiple iax packets</span>
<a name="l05684"></a>05684 <span class="comment">         * (so called slices), so it would make sense to use the same timestamp for all of</span>
<a name="l05685"></a>05685 <span class="comment">         * them</span>
<a name="l05686"></a>05686 <span class="comment">         * We do want to make sure that frames don&apos;t go backwards though</span>
<a name="l05687"></a>05687 <span class="comment">         */</span>
<a name="l05688"></a>05688          <span class="keywordflow">if</span> ( (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)ms &lt; p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> )
<a name="l05689"></a>05689             ms = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>;
<a name="l05690"></a>05690       } <span class="keywordflow">else</span> {
<a name="l05691"></a>05691          <span class="comment">/* On a dataframe, use last value + 3 (to accomodate jitter buffer shrinking) if appropriate unless</span>
<a name="l05692"></a>05692 <span class="comment">            it&apos;s a genuine frame */</span>
<a name="l05693"></a>05693          <span class="keywordflow">if</span> (genuine) {
<a name="l05694"></a>05694             <span class="comment">/* genuine (IAX LAGRQ etc) must keep their clock-based stamps */</span>
<a name="l05695"></a>05695             <span class="keywordflow">if</span> (ms &lt;= p-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>)
<a name="l05696"></a>05696                ms = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> + 3;
<a name="l05697"></a>05697          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (abs(ms - p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>) &lt;= <a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">MAX_TIMESTAMP_SKEW</a>) {
<a name="l05698"></a>05698             <span class="comment">/* non-genuine frames (!?) (DTMF, CONTROL) should be pulled into the predicted stream stamps */</span>
<a name="l05699"></a>05699             ms = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> + 3;
<a name="l05700"></a>05700          }
<a name="l05701"></a>05701       }
<a name="l05702"></a>05702    }
<a name="l05703"></a>05703    p-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> = ms;
<a name="l05704"></a>05704    <span class="keywordflow">if</span> (voice)
<a name="l05705"></a>05705       p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> + f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> / rate;
<a name="l05706"></a>05706    <span class="keywordflow">return</span> ms;
<a name="l05707"></a>05707 }
<a name="l05708"></a>05708 
<a name="l05709"></a><a class="code" href="chan__iax2_8c.html#ae844f334714a9ec860bf8b532af598a5">05709</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ae844f334714a9ec860bf8b532af598a5">calc_rxstamp</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> offset)
<a name="l05710"></a>05710 {
<a name="l05711"></a>05711    <span class="comment">/* Returns where in &quot;receive time&quot; we are.  That is, how many ms</span>
<a name="l05712"></a>05712 <span class="comment">      since we received (or would have received) the frame with timestamp 0 */</span>
<a name="l05713"></a>05713    <span class="keywordtype">int</span> ms;
<a name="l05714"></a>05714 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l05715"></a>05715 <span class="preprocessor"></span>   <span class="keywordtype">int</span> jit;
<a name="l05716"></a>05716 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l05717"></a>05717    <span class="comment">/* Setup rxcore if necessary */</span>
<a name="l05718"></a>05718    <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>)) {
<a name="l05719"></a>05719       p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05720"></a>05720       <span class="keywordflow">if</span> (iaxdebug)
<a name="l05721"></a>05721          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;calc_rxstamp: call=%d: rxcore set to %d.%6.6d - %dms\n&quot;</span>,
<a name="l05722"></a>05722                p-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, (<span class="keywordtype">int</span>)(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_sec), (<span class="keywordtype">int</span>)(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec), offset);
<a name="l05723"></a>05723       p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a> = <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(offset, 1000));
<a name="l05724"></a>05724 <span class="preprocessor">#if 1</span>
<a name="l05725"></a>05725 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (iaxdebug)
<a name="l05726"></a>05726          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;calc_rxstamp: call=%d: works out as %d.%6.6d\n&quot;</span>,
<a name="l05727"></a>05727                p-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, (<span class="keywordtype">int</span>)(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_sec),(<span class="keywordtype">int</span>)( p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec));
<a name="l05728"></a>05728 <span class="preprocessor">#endif</span>
<a name="l05729"></a>05729 <span class="preprocessor"></span>   }
<a name="l05730"></a>05730 
<a name="l05731"></a>05731    ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), p-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>);
<a name="l05732"></a>05732 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l05733"></a>05733 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (test_jit) {
<a name="l05734"></a>05734       <span class="keywordflow">if</span> (!test_jitpct || ((100.0 * <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() / (RAND_MAX + 1.0)) &lt; test_jitpct)) {
<a name="l05735"></a>05735          jit = (int)((<span class="keywordtype">float</span>)test_jit * <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() / (RAND_MAX + 1.0));
<a name="l05736"></a>05736          <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)(2.0 * <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() / (RAND_MAX + 1.0)))
<a name="l05737"></a>05737             jit = -jit;
<a name="l05738"></a>05738          ms += jit;
<a name="l05739"></a>05739       }
<a name="l05740"></a>05740    }
<a name="l05741"></a>05741    <span class="keywordflow">if</span> (test_late) {
<a name="l05742"></a>05742       ms += test_late;
<a name="l05743"></a>05743       test_late = 0;
<a name="l05744"></a>05744    }
<a name="l05745"></a>05745 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l05746"></a>05746    <span class="keywordflow">return</span> ms;
<a name="l05747"></a>05747 }
<a name="l05748"></a>05748 
<a name="l05749"></a><a class="code" href="chan__iax2_8c.html#a3a65a4f4c03f106210da983a7eb7d9e6">05749</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *<a class="code" href="chan__iax2_8c.html#a3a65a4f4c03f106210da983a7eb7d9e6">find_tpeer</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> fd)
<a name="l05750"></a>05750 {
<a name="l05751"></a>05751    <span class="keyword">struct </span><a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer = NULL;
<a name="l05752"></a>05752    
<a name="l05753"></a>05753    <span class="comment">/* Finds and locks trunk peer */</span>
<a name="l05754"></a>05754    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;tpeers);
<a name="l05755"></a>05755 
<a name="l05756"></a>05756    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;tpeers, tpeer, list) {
<a name="l05757"></a>05757       <span class="keywordflow">if</span> (!<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin)) {
<a name="l05758"></a>05758          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l05759"></a>05759          <span class="keywordflow">break</span>;
<a name="l05760"></a>05760       }
<a name="l05761"></a>05761    }
<a name="l05762"></a>05762 
<a name="l05763"></a>05763    <span class="keywordflow">if</span> (!tpeer) {
<a name="l05764"></a>05764       <span class="keywordflow">if</span> ((tpeer = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tpeer)))) {
<a name="l05765"></a>05765          <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l05766"></a>05766          tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> = 9999;
<a name="l05767"></a>05767          memcpy(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin, <span class="keyword">sizeof</span>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l05768"></a>05768          tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">trunkact</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05769"></a>05769          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l05770"></a>05770          tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = fd;
<a name="l05771"></a>05771 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l05772"></a>05772 <span class="preprocessor"></span>         setsockopt(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, SOL_SOCKET, SO_NO_CHECK, &amp;nochecksums, <span class="keyword">sizeof</span>(nochecksums));
<a name="l05773"></a>05773 <span class="preprocessor">#endif</span>
<a name="l05774"></a>05774 <span class="preprocessor"></span>         <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Created trunk peer for &apos;%s:%d&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l05775"></a>05775          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;tpeers, tpeer, list);
<a name="l05776"></a>05776       }
<a name="l05777"></a>05777    }
<a name="l05778"></a>05778 
<a name="l05779"></a>05779    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;tpeers);
<a name="l05780"></a>05780 
<a name="l05781"></a>05781    <span class="keywordflow">return</span> tpeer;
<a name="l05782"></a>05782 }
<a name="l05783"></a>05783 
<a name="l05784"></a><a class="code" href="chan__iax2_8c.html#a1ec41018ea899d7651c58905031a92f7">05784</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1ec41018ea899d7651c58905031a92f7">iax2_trunk_queue</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> iax_frame *fr)
<a name="l05785"></a>05785 {
<a name="l05786"></a>05786    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l05787"></a>05787    <span class="keyword">struct </span><a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer;
<a name="l05788"></a>05788    <span class="keywordtype">void</span> *tmp, *ptr;
<a name="l05789"></a>05789    <span class="keyword">struct </span>timeval now;
<a name="l05790"></a>05790    <span class="keywordtype">int</span> res; 
<a name="l05791"></a>05791    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__entry.html">ast_iax2_meta_trunk_entry</a> *met;
<a name="l05792"></a>05792    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__mini.html">ast_iax2_meta_trunk_mini</a> *mtm;
<a name="l05793"></a>05793 
<a name="l05794"></a>05794    f = &amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>;
<a name="l05795"></a>05795    tpeer = <a class="code" href="chan__iax2_8c.html#a3a65a4f4c03f106210da983a7eb7d9e6">find_tpeer</a>(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>);
<a name="l05796"></a>05796    <span class="keywordflow">if</span> (tpeer) {
<a name="l05797"></a>05797       <span class="keywordflow">if</span> (tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> + f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + 4 &gt;= tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a>) {
<a name="l05798"></a>05798          <span class="comment">/* Need to reallocate space */</span>
<a name="l05799"></a>05799          <span class="keywordflow">if</span> (tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a> &lt; trunkmaxsize) {
<a name="l05800"></a>05800             <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9d7d795e75eb67c3d19f9b86d326c588">trunkdata</a>, tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a> + <a class="code" href="chan__iax2_8c.html#ac39ac2b74f9ef87c0eea085a1fde05e1">DEFAULT_TRUNKDATA</a> + <a class="code" href="chan__iax2_8c.html#ac1d06616566c06c92ea23cbe8f210e43">IAX2_TRUNK_PREFACE</a>))) {
<a name="l05801"></a>05801                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l05802"></a>05802                <span class="keywordflow">return</span> -1;
<a name="l05803"></a>05803             }
<a name="l05804"></a>05804             
<a name="l05805"></a>05805             tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a> += <a class="code" href="chan__iax2_8c.html#ac39ac2b74f9ef87c0eea085a1fde05e1">DEFAULT_TRUNKDATA</a>;
<a name="l05806"></a>05806             tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9d7d795e75eb67c3d19f9b86d326c588">trunkdata</a> = tmp;
<a name="l05807"></a>05807             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Expanded trunk &apos;%s:%d&apos; to %d bytes\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port), tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a>);
<a name="l05808"></a>05808          } <span class="keywordflow">else</span> {
<a name="l05809"></a>05809             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum trunk data space exceeded to %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l05810"></a>05810             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l05811"></a>05811             <span class="keywordflow">return</span> -1;
<a name="l05812"></a>05812          }
<a name="l05813"></a>05813       }
<a name="l05814"></a>05814 
<a name="l05815"></a>05815       <span class="comment">/* Append to meta frame */</span>
<a name="l05816"></a>05816       ptr = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9d7d795e75eb67c3d19f9b86d326c588">trunkdata</a> + <a class="code" href="chan__iax2_8c.html#ac1d06616566c06c92ea23cbe8f210e43">IAX2_TRUNK_PREFACE</a> + tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a>;
<a name="l05817"></a>05817       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba0af69b242af8f9f71d7c94452ce86088">IAX_TRUNKTIMESTAMPS</a>)) {
<a name="l05818"></a>05818          mtm = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__mini.html">ast_iax2_meta_trunk_mini</a> *)ptr;
<a name="l05819"></a>05819          mtm-&gt;<a class="code" href="structast__iax2__meta__trunk__mini.html#ad4c01009aad5a218ea64c329ebfe653d">len</a> = htons(f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l05820"></a>05820          mtm-&gt;<a class="code" href="structast__iax2__meta__trunk__mini.html#ae8e551054064c8226650232d25994252">mini</a>.<a class="code" href="structast__iax2__mini__hdr.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = htons(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l05821"></a>05821          mtm-&gt;<a class="code" href="structast__iax2__meta__trunk__mini.html#ae8e551054064c8226650232d25994252">mini</a>.<a class="code" href="structast__iax2__mini__hdr.html#a84074dc9c4d9c2bdd3fbad69e032e9f7">ts</a> = htons(0xffff &amp; fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l05822"></a>05822          ptr += <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__mini.html">ast_iax2_meta_trunk_mini</a>);
<a name="l05823"></a>05823          tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> += <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__mini.html">ast_iax2_meta_trunk_mini</a>);
<a name="l05824"></a>05824       } <span class="keywordflow">else</span> {
<a name="l05825"></a>05825          met = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__entry.html">ast_iax2_meta_trunk_entry</a> *)ptr;
<a name="l05826"></a>05826          <span class="comment">/* Store call number and length in meta header */</span>
<a name="l05827"></a>05827          met-&gt;<a class="code" href="structast__iax2__meta__trunk__entry.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = htons(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l05828"></a>05828          met-&gt;<a class="code" href="structast__iax2__meta__trunk__entry.html#ad4c01009aad5a218ea64c329ebfe653d">len</a> = htons(f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l05829"></a>05829          <span class="comment">/* Advance pointers/decrease length past trunk entry header */</span>
<a name="l05830"></a>05830          ptr += <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__entry.html">ast_iax2_meta_trunk_entry</a>);
<a name="l05831"></a>05831          tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> += <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__entry.html">ast_iax2_meta_trunk_entry</a>);
<a name="l05832"></a>05832       }
<a name="l05833"></a>05833       <span class="comment">/* Copy actual trunk data */</span>
<a name="l05834"></a>05834       memcpy(ptr, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l05835"></a>05835       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> += f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;
<a name="l05836"></a>05836 
<a name="l05837"></a>05837       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>++;
<a name="l05838"></a>05838 
<a name="l05839"></a>05839       <span class="comment">/* track the largest mtu we actually have sent */</span>
<a name="l05840"></a>05840       <span class="keywordflow">if</span> (tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> + f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + 4 &gt; trunk_maxmtu) 
<a name="l05841"></a>05841          trunk_maxmtu = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> + f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + 4 ; 
<a name="l05842"></a>05842 
<a name="l05843"></a>05843       <span class="comment">/* if we have enough for a full MTU, ship it now without waiting */</span>
<a name="l05844"></a>05844       <span class="keywordflow">if</span> (global_max_trunk_mtu &gt; 0 &amp;&amp; tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> + f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + 4 &gt;= global_max_trunk_mtu) {
<a name="l05845"></a>05845          now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05846"></a>05846          res = <a class="code" href="chan__iax2_8c.html#ad598b8e9746a49f7a86a1c29d87b5dba">send_trunk</a>(tpeer, &amp;now); 
<a name="l05847"></a>05847          trunk_untimed ++; 
<a name="l05848"></a>05848       }
<a name="l05849"></a>05849 
<a name="l05850"></a>05850       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l05851"></a>05851    }
<a name="l05852"></a>05852    <span class="keywordflow">return</span> 0;
<a name="l05853"></a>05853 }
<a name="l05854"></a>05854 
<a name="l05855"></a>05855 <span class="comment">/* IAX2 encryption requires 16 to 32 bytes of random padding to be present</span>
<a name="l05856"></a>05856 <span class="comment"> * before the encryption data.  This function randomizes that data. */</span>
<a name="l05857"></a><a class="code" href="chan__iax2_8c.html#ab11c1510aa7efdbb6bb4cedcd13390d8">05857</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ab11c1510aa7efdbb6bb4cedcd13390d8">build_rand_pad</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, ssize_t <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l05858"></a>05858 {
<a name="l05859"></a>05859    <span class="keywordtype">long</span> tmp;
<a name="l05860"></a>05860    <span class="keywordflow">for</span> (tmp = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(); len &gt; 0; tmp = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>()) {
<a name="l05861"></a>05861       memcpy(buf, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) &amp;tmp, (len &gt; <span class="keyword">sizeof</span>(tmp)) ? <span class="keyword">sizeof</span>(tmp) : len);
<a name="l05862"></a>05862       buf += <span class="keyword">sizeof</span>(tmp);
<a name="l05863"></a>05863       len -= <span class="keyword">sizeof</span>(tmp);
<a name="l05864"></a>05864    }
<a name="l05865"></a>05865 }
<a name="l05866"></a>05866 
<a name="l05867"></a><a class="code" href="chan__iax2_8c.html#aeee0c3a783f20bf1d8bf66888e89238d">05867</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aeee0c3a783f20bf1d8bf66888e89238d">build_encryption_keys</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *digest, <span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l05868"></a>05868 {
<a name="l05869"></a>05869    <a class="code" href="chan__iax2_8c.html#a623a7a7afa10106e5dff18a2540ba34e">build_ecx_key</a>(digest, pvt);
<a name="l05870"></a>05870    <a class="code" href="aes_8h.html#a4b2e708ba2ce55ca2b9f866f7e805170">ast_aes_decrypt_key</a>(digest, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0073ccb3c8600726f37b28438094bd8">dcx</a>);
<a name="l05871"></a>05871 }
<a name="l05872"></a>05872 
<a name="l05873"></a><a class="code" href="chan__iax2_8c.html#a623a7a7afa10106e5dff18a2540ba34e">05873</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a623a7a7afa10106e5dff18a2540ba34e">build_ecx_key</a>(<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *digest, <span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l05874"></a>05874 {
<a name="l05875"></a>05875    <span class="comment">/* it is required to hold the corresponding decrypt key to our encrypt key</span>
<a name="l05876"></a>05876 <span class="comment">    * in the pvt struct because queued frames occasionally need to be decrypted and</span>
<a name="l05877"></a>05877 <span class="comment">    * re-encrypted when updated for a retransmission */</span>
<a name="l05878"></a>05878    <a class="code" href="chan__iax2_8c.html#ab11c1510aa7efdbb6bb4cedcd13390d8">build_rand_pad</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, <span class="keyword">sizeof</span>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>));
<a name="l05879"></a>05879    <a class="code" href="aes_8h.html#a28ec7116f0068e7efbe6de58f109c34a">ast_aes_encrypt_key</a>(digest, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ae119b8bbe294cad12c32cd093eb81e4c">ecx</a>);
<a name="l05880"></a>05880    <a class="code" href="aes_8h.html#a4b2e708ba2ce55ca2b9f866f7e805170">ast_aes_decrypt_key</a>(digest, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#acb5abb83f0ce114bf0dee2c3217ff466">mydcx</a>);
<a name="l05881"></a>05881 }
<a name="l05882"></a>05882 
<a name="l05883"></a><a class="code" href="chan__iax2_8c.html#ae0aa6d91496c124715526cb5c5dbbb60">05883</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ae0aa6d91496c124715526cb5c5dbbb60">memcpy_decrypt</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <a class="code" href="structaes__decrypt__ctx.html">ast_aes_decrypt_key</a> *dcx)
<a name="l05884"></a>05884 {
<a name="l05885"></a>05885 <span class="preprocessor">#if 0</span>
<a name="l05886"></a>05886 <span class="preprocessor"></span>   <span class="comment">/* Debug with &quot;fake encryption&quot; */</span>
<a name="l05887"></a>05887    <span class="keywordtype">int</span> x;
<a name="l05888"></a>05888    <span class="keywordflow">if</span> (len % 16)
<a name="l05889"></a>05889       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;len should be multiple of 16, not %d!\n&quot;</span>, len);
<a name="l05890"></a>05890    <span class="keywordflow">for</span> (x=0;x&lt;len;x++)
<a name="l05891"></a>05891       dst[x] = src[x] ^ 0xff;
<a name="l05892"></a>05892 <span class="preprocessor">#else </span>
<a name="l05893"></a>05893 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> lastblock[16] = { 0 };
<a name="l05894"></a>05894    <span class="keywordtype">int</span> x;
<a name="l05895"></a>05895    <span class="keywordflow">while</span>(len &gt; 0) {
<a name="l05896"></a>05896       <a class="code" href="aes_8h.html#a8eebbda3f1917530e307fdab02e2c383">ast_aes_decrypt</a>(src, dst, dcx);
<a name="l05897"></a>05897       <span class="keywordflow">for</span> (x=0;x&lt;16;x++)
<a name="l05898"></a>05898          dst[x] ^= lastblock[x];
<a name="l05899"></a>05899       memcpy(lastblock, src, <span class="keyword">sizeof</span>(lastblock));
<a name="l05900"></a>05900       dst += 16;
<a name="l05901"></a>05901       src += 16;
<a name="l05902"></a>05902       len -= 16;
<a name="l05903"></a>05903    }
<a name="l05904"></a>05904 <span class="preprocessor">#endif</span>
<a name="l05905"></a>05905 <span class="preprocessor"></span>}
<a name="l05906"></a>05906 
<a name="l05907"></a><a class="code" href="chan__iax2_8c.html#afad57cf28ad65f2cb8b3cb86c7da784b">05907</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#afad57cf28ad65f2cb8b3cb86c7da784b">memcpy_encrypt</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <a class="code" href="structaes__encrypt__ctx.html">ast_aes_encrypt_key</a> *ecx)
<a name="l05908"></a>05908 {
<a name="l05909"></a>05909 <span class="preprocessor">#if 0</span>
<a name="l05910"></a>05910 <span class="preprocessor"></span>   <span class="comment">/* Debug with &quot;fake encryption&quot; */</span>
<a name="l05911"></a>05911    <span class="keywordtype">int</span> x;
<a name="l05912"></a>05912    <span class="keywordflow">if</span> (len % 16)
<a name="l05913"></a>05913       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;len should be multiple of 16, not %d!\n&quot;</span>, len);
<a name="l05914"></a>05914    <span class="keywordflow">for</span> (x=0;x&lt;len;x++)
<a name="l05915"></a>05915       dst[x] = src[x] ^ 0xff;
<a name="l05916"></a>05916 <span class="preprocessor">#else</span>
<a name="l05917"></a>05917 <span class="preprocessor"></span>   <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> curblock[16] = { 0 };
<a name="l05918"></a>05918    <span class="keywordtype">int</span> x;
<a name="l05919"></a>05919    <span class="keywordflow">while</span>(len &gt; 0) {
<a name="l05920"></a>05920       <span class="keywordflow">for</span> (x=0;x&lt;16;x++)
<a name="l05921"></a>05921          curblock[x] ^= src[x];
<a name="l05922"></a>05922       <a class="code" href="aes_8h.html#a1c8d68dbd3509c1d019385465fb5cce3">ast_aes_encrypt</a>(curblock, dst, ecx);
<a name="l05923"></a>05923       memcpy(curblock, dst, <span class="keyword">sizeof</span>(curblock)); 
<a name="l05924"></a>05924       dst += 16;
<a name="l05925"></a>05925       src += 16;
<a name="l05926"></a>05926       len -= 16;
<a name="l05927"></a>05927    }
<a name="l05928"></a>05928 <span class="preprocessor">#endif</span>
<a name="l05929"></a>05929 <span class="preprocessor"></span>}
<a name="l05930"></a>05930 
<a name="l05931"></a><a class="code" href="chan__iax2_8c.html#aabb84cc107d8ba6ad24986225778efa4">05931</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aabb84cc107d8ba6ad24986225778efa4">decode_frame</a>(<a class="code" href="structaes__decrypt__ctx.html">ast_aes_decrypt_key</a> *dcx, <span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keywordtype">int</span> *datalen)
<a name="l05932"></a>05932 {
<a name="l05933"></a>05933    <span class="keywordtype">int</span> padding;
<a name="l05934"></a>05934    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *workspace;
<a name="l05935"></a>05935 
<a name="l05936"></a>05936    workspace = alloca(*datalen);
<a name="l05937"></a>05937    memset(f, 0, <span class="keyword">sizeof</span>(*f));
<a name="l05938"></a>05938    <span class="keywordflow">if</span> (ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) {
<a name="l05939"></a>05939       <span class="keyword">struct </span><a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a> *efh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a> *)fh;
<a name="l05940"></a>05940       <span class="keywordflow">if</span> (*datalen &lt; 16 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>))
<a name="l05941"></a>05941          <span class="keywordflow">return</span> -1;
<a name="l05942"></a>05942       <span class="comment">/* Decrypt */</span>
<a name="l05943"></a>05943       <a class="code" href="chan__iax2_8c.html#ae0aa6d91496c124715526cb5c5dbbb60">memcpy_decrypt</a>(workspace, efh-&gt;<a class="code" href="structast__iax2__full__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a>), dcx);
<a name="l05944"></a>05944 
<a name="l05945"></a>05945       padding = 16 + (workspace[15] &amp; 0x0f);
<a name="l05946"></a>05946       <span class="keywordflow">if</span> (iaxdebug)
<a name="l05947"></a>05947          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Decoding full frame with length %d (padding = %d) (15=%02x)\n&quot;</span>, *datalen, padding, workspace[15]);
<a name="l05948"></a>05948       <span class="keywordflow">if</span> (*datalen &lt; padding + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>))
<a name="l05949"></a>05949          <span class="keywordflow">return</span> -1;
<a name="l05950"></a>05950 
<a name="l05951"></a>05951       *datalen -= padding;
<a name="l05952"></a>05952       memcpy(efh-&gt;<a class="code" href="structast__iax2__full__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, workspace + padding, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a>));
<a name="l05953"></a>05953       f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a>;
<a name="l05954"></a>05954       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l05955"></a>05955          f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">uncompress_subclass</a>(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> &amp; ~0x40) | ((fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> &gt;&gt; 6) &amp; 0x1);
<a name="l05956"></a>05956       } <span class="keywordflow">else</span> {
<a name="l05957"></a>05957          f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">uncompress_subclass</a>(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a>);
<a name="l05958"></a>05958       }
<a name="l05959"></a>05959    } <span class="keywordflow">else</span> {
<a name="l05960"></a>05960       <span class="keyword">struct </span><a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a> *efh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a> *)fh;
<a name="l05961"></a>05961       <span class="keywordflow">if</span> (iaxdebug)
<a name="l05962"></a>05962          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Decoding mini with length %d\n&quot;</span>, *datalen);
<a name="l05963"></a>05963       <span class="keywordflow">if</span> (*datalen &lt; 16 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a>))
<a name="l05964"></a>05964          <span class="keywordflow">return</span> -1;
<a name="l05965"></a>05965       <span class="comment">/* Decrypt */</span>
<a name="l05966"></a>05966       <a class="code" href="chan__iax2_8c.html#ae0aa6d91496c124715526cb5c5dbbb60">memcpy_decrypt</a>(workspace, efh-&gt;<a class="code" href="structast__iax2__mini__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a>), dcx);
<a name="l05967"></a>05967       padding = 16 + (workspace[15] &amp; 0x0f);
<a name="l05968"></a>05968       <span class="keywordflow">if</span> (*datalen &lt; padding + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a>))
<a name="l05969"></a>05969          <span class="keywordflow">return</span> -1;
<a name="l05970"></a>05970       *datalen -= padding;
<a name="l05971"></a>05971       memcpy(efh-&gt;<a class="code" href="structast__iax2__mini__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, workspace + padding, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a>));
<a name="l05972"></a>05972    }
<a name="l05973"></a>05973    <span class="keywordflow">return</span> 0;
<a name="l05974"></a>05974 }
<a name="l05975"></a>05975 
<a name="l05976"></a><a class="code" href="chan__iax2_8c.html#a6423f55e3c003cc765531b7b1eebaeea">05976</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a6423f55e3c003cc765531b7b1eebaeea">encrypt_frame</a>(<a class="code" href="structaes__encrypt__ctx.html">ast_aes_encrypt_key</a> *ecx, <span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *poo, <span class="keywordtype">int</span> *datalen)
<a name="l05977"></a>05977 {
<a name="l05978"></a>05978    <span class="keywordtype">int</span> padding;
<a name="l05979"></a>05979    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *workspace;
<a name="l05980"></a>05980    workspace = alloca(*datalen + 32);
<a name="l05981"></a>05981    <span class="keywordflow">if</span> (!workspace)
<a name="l05982"></a>05982       <span class="keywordflow">return</span> -1;
<a name="l05983"></a>05983    <span class="keywordflow">if</span> (ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) {
<a name="l05984"></a>05984       <span class="keyword">struct </span><a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a> *efh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a> *)fh;
<a name="l05985"></a>05985       <span class="keywordflow">if</span> (iaxdebug)
<a name="l05986"></a>05986          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Encoding full frame %d/%d with length %d\n&quot;</span>, fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a>, fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a>, *datalen);
<a name="l05987"></a>05987       padding = 16 - ((*datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a>)) % 16);
<a name="l05988"></a>05988       padding = 16 + (padding &amp; 0xf);
<a name="l05989"></a>05989       memcpy(workspace, poo, padding);
<a name="l05990"></a>05990       memcpy(workspace + padding, efh-&gt;<a class="code" href="structast__iax2__full__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a>));
<a name="l05991"></a>05991       workspace[15] &amp;= 0xf0;
<a name="l05992"></a>05992       workspace[15] |= (padding &amp; 0xf);
<a name="l05993"></a>05993       <span class="keywordflow">if</span> (iaxdebug)
<a name="l05994"></a>05994          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Encoding full frame %d/%d with length %d + %d padding (15=%02x)\n&quot;</span>, fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a>, fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a>, *datalen, padding, workspace[15]);
<a name="l05995"></a>05995       *datalen += padding;
<a name="l05996"></a>05996       <a class="code" href="chan__iax2_8c.html#afad57cf28ad65f2cb8b3cb86c7da784b">memcpy_encrypt</a>(efh-&gt;<a class="code" href="structast__iax2__full__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, workspace, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a>), ecx);
<a name="l05997"></a>05997       <span class="keywordflow">if</span> (*datalen &gt;= 32 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__enc__hdr.html">ast_iax2_full_enc_hdr</a>))
<a name="l05998"></a>05998          memcpy(poo, workspace + *datalen - 32, 32);
<a name="l05999"></a>05999    } <span class="keywordflow">else</span> {
<a name="l06000"></a>06000       <span class="keyword">struct </span><a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a> *efh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a> *)fh;
<a name="l06001"></a>06001       <span class="keywordflow">if</span> (iaxdebug)
<a name="l06002"></a>06002          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Encoding mini frame with length %d\n&quot;</span>, *datalen);
<a name="l06003"></a>06003       padding = 16 - ((*datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a>)) % 16);
<a name="l06004"></a>06004       padding = 16 + (padding &amp; 0xf);
<a name="l06005"></a>06005       memcpy(workspace, poo, padding);
<a name="l06006"></a>06006       memcpy(workspace + padding, efh-&gt;<a class="code" href="structast__iax2__mini__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a>));
<a name="l06007"></a>06007       workspace[15] &amp;= 0xf0;
<a name="l06008"></a>06008       workspace[15] |= (padding &amp; 0x0f);
<a name="l06009"></a>06009       *datalen += padding;
<a name="l06010"></a>06010       <a class="code" href="chan__iax2_8c.html#afad57cf28ad65f2cb8b3cb86c7da784b">memcpy_encrypt</a>(efh-&gt;<a class="code" href="structast__iax2__mini__enc__hdr.html#ad9ab7eeac3aa2f817d0a4829c2adc5b5">encdata</a>, workspace, *datalen - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a>), ecx);
<a name="l06011"></a>06011       <span class="keywordflow">if</span> (*datalen &gt;= 32 + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__enc__hdr.html">ast_iax2_mini_enc_hdr</a>))
<a name="l06012"></a>06012          memcpy(poo, workspace + *datalen - 32, 32);
<a name="l06013"></a>06013    }
<a name="l06014"></a>06014    <span class="keywordflow">return</span> 0;
<a name="l06015"></a>06015 }
<a name="l06016"></a>06016 
<a name="l06017"></a><a class="code" href="chan__iax2_8c.html#aa99b47192edc30f24177358dd1d5038a">06017</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa99b47192edc30f24177358dd1d5038a">decrypt_frame</a>(<span class="keywordtype">int</span> <a class="code" href="structast__iax2__mini__enc__hdr.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keywordtype">int</span> *datalen)
<a name="l06018"></a>06018 {
<a name="l06019"></a>06019    <span class="keywordtype">int</span> res=-1;
<a name="l06020"></a>06020    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">IAX_KEYPOPULATED</a>)) {
<a name="l06021"></a>06021       <span class="comment">/* Search for possible keys, given secrets */</span>
<a name="l06022"></a>06022       <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l06023"></a>06023       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
<a name="l06024"></a>06024       <span class="keywordtype">char</span> *tmppw, *stringp;
<a name="l06025"></a>06025       
<a name="l06026"></a>06026       tmppw = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>);
<a name="l06027"></a>06027       stringp = tmppw;
<a name="l06028"></a>06028       <span class="keywordflow">while</span> ((tmppw = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;;&quot;</span>))) {
<a name="l06029"></a>06029          <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l06030"></a>06030          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge, strlen(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge));
<a name="l06031"></a>06031          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)tmppw, strlen(tmppw));
<a name="l06032"></a>06032          <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(digest, &amp;md5);
<a name="l06033"></a>06033          <a class="code" href="chan__iax2_8c.html#aeee0c3a783f20bf1d8bf66888e89238d">build_encryption_keys</a>(digest, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]);
<a name="l06034"></a>06034          res = <a class="code" href="chan__iax2_8c.html#aabb84cc107d8ba6ad24986225778efa4">decode_frame</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;dcx, fh, f, datalen);
<a name="l06035"></a>06035          <span class="keywordflow">if</span> (!res) {
<a name="l06036"></a>06036             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">IAX_KEYPOPULATED</a>);
<a name="l06037"></a>06037             <span class="keywordflow">break</span>;
<a name="l06038"></a>06038          }
<a name="l06039"></a>06039       }
<a name="l06040"></a>06040    } <span class="keywordflow">else</span> 
<a name="l06041"></a>06041       res = <a class="code" href="chan__iax2_8c.html#aabb84cc107d8ba6ad24986225778efa4">decode_frame</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;dcx, fh, f, datalen);
<a name="l06042"></a>06042    <span class="keywordflow">return</span> res;
<a name="l06043"></a>06043 }
<a name="l06044"></a>06044 
<a name="l06045"></a><a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">06045</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">iax2_send</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts, <span class="keywordtype">int</span> seqno, <span class="keywordtype">int</span> now, <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>, <span class="keywordtype">int</span> <span class="keyword">final</span>)
<a name="l06046"></a>06046 {
<a name="l06047"></a>06047    <span class="comment">/* Queue a packet for delivery on a given private structure.  Use &quot;ts&quot; for</span>
<a name="l06048"></a>06048 <span class="comment">      timestamp, or calculate if ts is 0.  Send immediately without retransmission</span>
<a name="l06049"></a>06049 <span class="comment">      or delayed, with retransmission */</span>
<a name="l06050"></a>06050    <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh;
<a name="l06051"></a>06051    <span class="keyword">struct </span><a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a> *mh;
<a name="l06052"></a>06052    <span class="keyword">struct </span><a class="code" href="structast__iax2__video__hdr.html">ast_iax2_video_hdr</a> *vh;
<a name="l06053"></a>06053    <span class="keyword">struct </span>{
<a name="l06054"></a>06054       <span class="keyword">struct </span>iax_frame fr2;
<a name="l06055"></a>06055       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buffer[4096];
<a name="l06056"></a>06056    } frb;
<a name="l06057"></a>06057    <span class="keyword">struct </span>iax_frame *fr;
<a name="l06058"></a>06058    <span class="keywordtype">int</span> res;
<a name="l06059"></a>06059    <span class="keywordtype">int</span> sendmini=0;
<a name="l06060"></a>06060    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>;
<a name="l06061"></a>06061    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> fts;
<a name="l06062"></a>06062 
<a name="l06063"></a>06063    frb.fr2.afdatalen = <span class="keyword">sizeof</span>(frb.buffer);
<a name="l06064"></a>06064 
<a name="l06065"></a>06065    <span class="keywordflow">if</span> (!pvt) {
<a name="l06066"></a>06066       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No private structure for packet?\n&quot;</span>);
<a name="l06067"></a>06067       <span class="keywordflow">return</span> -1;
<a name="l06068"></a>06068    }
<a name="l06069"></a>06069    
<a name="l06070"></a>06070    lastsent = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a>;
<a name="l06071"></a>06071 
<a name="l06072"></a>06072    <span class="comment">/* Calculate actual timestamp */</span>
<a name="l06073"></a>06073    fts = <a class="code" href="chan__iax2_8c.html#a9fd242af6fb851f79a5e184beb40933c">calc_timestamp</a>(pvt, ts, f);
<a name="l06074"></a>06074 
<a name="l06075"></a>06075    <span class="comment">/* Bail here if this is an &quot;interp&quot; frame; we don&apos;t want or need to send these placeholders out</span>
<a name="l06076"></a>06076 <span class="comment">    * (the endpoint should detect the lost packet itself).  But, we want to do this here, so that we</span>
<a name="l06077"></a>06077 <span class="comment">    * increment the &quot;predicted timestamps&quot; for voice, if we&apos;re predicting */</span>
<a name="l06078"></a>06078    <span class="keywordflow">if</span>(f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> == 0)
<a name="l06079"></a>06079       <span class="keywordflow">return</span> 0;
<a name="l06080"></a>06080 <span class="preprocessor">#if 0</span>
<a name="l06081"></a>06081 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, 
<a name="l06082"></a>06082       <span class="stringliteral">&quot;f-&gt;frametype %c= AST_FRAME_VOICE, %sencrypted, %srotation scheduled...\n&quot;</span>,
<a name="l06083"></a>06083       *(<span class="stringliteral">&quot;=!&quot;</span> + (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)),
<a name="l06084"></a>06084       <a class="code" href="chan__iax2_8c.html#a3d9496bb3807918ec2fef65f1d25f6e5">IAX_CALLENCRYPTED</a>(pvt) ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;not &quot;</span>,
<a name="l06085"></a>06085       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">keyrotateid</a> != -1 ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;no &quot;</span>
<a name="l06086"></a>06086    );
<a name="l06087"></a>06087 <span class="preprocessor">#endif</span>
<a name="l06088"></a>06088 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">keyrotateid</a> == -1 &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> &amp;&amp; <a class="code" href="chan__iax2_8c.html#a3d9496bb3807918ec2fef65f1d25f6e5">IAX_CALLENCRYPTED</a>(pvt)) {
<a name="l06089"></a>06089       <a class="code" href="chan__iax2_8c.html#a50fba0ffe0bf2ecf5b6ae9d056ceb15e">iax2_key_rotate</a>(pvt);
<a name="l06090"></a>06090    }
<a name="l06091"></a>06091 
<a name="l06092"></a>06092    <span class="keywordflow">if</span> ((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) || 
<a name="l06093"></a>06093          (((fts &amp; 0xFFFF0000L) == (lastsent &amp; 0xFFFF0000L)) ||
<a name="l06094"></a>06094          ((fts &amp; 0xFFFF0000L) == ((lastsent + 0x10000) &amp; 0xFFFF0000L))))
<a name="l06095"></a>06095       <span class="comment">/* High two bytes are the same on timestamp, or sending on a trunk */</span> &amp;&amp;
<a name="l06096"></a>06096        (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) 
<a name="l06097"></a>06097       <span class="comment">/* is a voice frame */</span> &amp;&amp;
<a name="l06098"></a>06098       (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a651f52e68c435d2cd74e0a6ee9f018f0">svoiceformat</a>) 
<a name="l06099"></a>06099       <span class="comment">/* is the same type */</span> ) {
<a name="l06100"></a>06100          <span class="comment">/* Force immediate rather than delayed transmission */</span>
<a name="l06101"></a>06101          now = 1;
<a name="l06102"></a>06102          <span class="comment">/* Mark that mini-style frame is appropriate */</span>
<a name="l06103"></a>06103          sendmini = 1;
<a name="l06104"></a>06104    }
<a name="l06105"></a>06105    <span class="keywordflow">if</span> ( f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a> ) {
<a name="l06106"></a>06106       <span class="comment">/*</span>
<a name="l06107"></a>06107 <span class="comment">       * If the lower 15 bits of the timestamp roll over, or if</span>
<a name="l06108"></a>06108 <span class="comment">       * the video format changed then send a full frame.</span>
<a name="l06109"></a>06109 <span class="comment">       * Otherwise send a mini video frame</span>
<a name="l06110"></a>06110 <span class="comment">       */</span>
<a name="l06111"></a>06111       <span class="keywordflow">if</span> (((fts &amp; 0xFFFF8000L) == (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a62a00cfbf5b85ad8006fb563a8d3acdd">lastvsent</a> &amp; 0xFFFF8000L)) &amp;&amp;
<a name="l06112"></a>06112           ((f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ~0x1) == pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2cd6784c5cdb13e5ff845fab09d51593">svideoformat</a>)
<a name="l06113"></a>06113          ) {
<a name="l06114"></a>06114          now = 1;
<a name="l06115"></a>06115          sendmini = 1;
<a name="l06116"></a>06116       } <span class="keywordflow">else</span> {
<a name="l06117"></a>06117          now = 0;
<a name="l06118"></a>06118          sendmini = 0;
<a name="l06119"></a>06119       }
<a name="l06120"></a>06120       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a62a00cfbf5b85ad8006fb563a8d3acdd">lastvsent</a> = fts;
<a name="l06121"></a>06121    }
<a name="l06122"></a>06122    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) {
<a name="l06123"></a>06123       <span class="comment">/* 0x8000 marks this message as TX:, this bit will be stripped later */</span>
<a name="l06124"></a>06124       pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ad236fe8543f05839d5978753bd7068a3">last_iax_message</a> = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> | <a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>;
<a name="l06125"></a>06125       <span class="keywordflow">if</span> (!pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">first_iax_message</a>) {
<a name="l06126"></a>06126          pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">first_iax_message</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ad236fe8543f05839d5978753bd7068a3">last_iax_message</a>;
<a name="l06127"></a>06127       }
<a name="l06128"></a>06128    }
<a name="l06129"></a>06129    <span class="comment">/* Allocate an iax_frame */</span>
<a name="l06130"></a>06130    <span class="keywordflow">if</span> (now) {
<a name="l06131"></a>06131       fr = &amp;frb.fr2;
<a name="l06132"></a>06132    } <span class="keywordflow">else</span>
<a name="l06133"></a>06133       fr = <a class="code" href="iax2-parser_8c.html#a99aa3f5f21d75970ba8d9f4700d03d38">iax_frame_new</a>(<a class="code" href="iax2-parser_8h.html#a1de532894b7fc3607e6f16281fbfc07f">DIRECTION_OUTGRESS</a>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a>) ? f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + 32 : f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) || (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>));
<a name="l06134"></a>06134    <span class="keywordflow">if</span> (!fr) {
<a name="l06135"></a>06135       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l06136"></a>06136       <span class="keywordflow">return</span> -1;
<a name="l06137"></a>06137    }
<a name="l06138"></a>06138    <span class="comment">/* Copy our prospective frame into our immediate or retransmitted wrapper */</span>
<a name="l06139"></a>06139    <a class="code" href="iax2-parser_8c.html#ac7172830d863702f96f81d8a09612428">iax_frame_wrap</a>(fr, f);
<a name="l06140"></a>06140 
<a name="l06141"></a>06141    fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = fts;
<a name="l06142"></a>06142    fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l06143"></a>06143    fr-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a> = transfer;
<a name="l06144"></a>06144    fr-&gt;<a class="code" href="structiax__frame.html#a48be625dde1131eceb8209732f83e909">final</a> = <span class="keyword">final</span>;
<a name="l06145"></a>06145    fr-&gt;<a class="code" href="structiax__frame.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = 0;
<a name="l06146"></a>06146    <span class="keywordflow">if</span> (!sendmini) {
<a name="l06147"></a>06147       <span class="comment">/* We need a full frame */</span>
<a name="l06148"></a>06148       <span class="keywordflow">if</span> (seqno &gt; -1)
<a name="l06149"></a>06149          fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a> = seqno;
<a name="l06150"></a>06150       <span class="keywordflow">else</span>
<a name="l06151"></a>06151          fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>++;
<a name="l06152"></a>06152       fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>;
<a name="l06153"></a>06153       fh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *)(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>));
<a name="l06154"></a>06154       fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a> = htons(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> | <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>);
<a name="l06155"></a>06155       fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = htonl(fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l06156"></a>06156       fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> = fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a>;
<a name="l06157"></a>06157       <span class="keywordflow">if</span> (transfer) {
<a name="l06158"></a>06158          fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> = 0;
<a name="l06159"></a>06159       } <span class="keywordflow">else</span>
<a name="l06160"></a>06160          fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> = fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>;
<a name="l06161"></a>06161       <span class="comment">/* Keep track of the last thing we&apos;ve acknowledged */</span>
<a name="l06162"></a>06162       <span class="keywordflow">if</span> (!transfer)
<a name="l06163"></a>06163          pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a994263e05f34cf3e146bd54903b7a053">aseqno</a> = fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>;
<a name="l06164"></a>06164       fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a> = fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> &amp; 0xFF;
<a name="l06165"></a>06165       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>)
<a name="l06166"></a>06166          fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> = <a class="code" href="chan__iax2_8c.html#ab063a335efcdf8cf19193fae08c6fcf9">compress_subclass</a>(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ~0x1) | ((fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; 0x1) &lt;&lt; 6);
<a name="l06167"></a>06167       <span class="keywordflow">else</span>
<a name="l06168"></a>06168          fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> = <a class="code" href="chan__iax2_8c.html#ab063a335efcdf8cf19193fae08c6fcf9">compress_subclass</a>(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l06169"></a>06169       <span class="keywordflow">if</span> (transfer) {
<a name="l06170"></a>06170          fr-&gt;<a class="code" href="structiax__frame.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a>;
<a name="l06171"></a>06171       } <span class="keywordflow">else</span>
<a name="l06172"></a>06172          fr-&gt;<a class="code" href="structiax__frame.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>;
<a name="l06173"></a>06173       fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a> = htons(fr-&gt;<a class="code" href="structiax__frame.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>);
<a name="l06174"></a>06174       fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>);
<a name="l06175"></a>06175       fr-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a> = fh;
<a name="l06176"></a>06176       fr-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = 0;
<a name="l06177"></a>06177       <span class="comment">/* Retry after 2x the ping time has passed */</span>
<a name="l06178"></a>06178       fr-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a> * 2;
<a name="l06179"></a>06179       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> &lt; <a class="code" href="chan__iax2_8c.html#a7a91ecc2d6181c0e5f804a4d517c3e4f">MIN_RETRY_TIME</a>)
<a name="l06180"></a>06180          fr-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = <a class="code" href="chan__iax2_8c.html#a7a91ecc2d6181c0e5f804a4d517c3e4f">MIN_RETRY_TIME</a>;
<a name="l06181"></a>06181       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> &gt; <a class="code" href="chan__iax2_8c.html#a67d22005a8e4f7fecdfbfe9856b089e3">MAX_RETRY_TIME</a>)
<a name="l06182"></a>06182          fr-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a> = <a class="code" href="chan__iax2_8c.html#a67d22005a8e4f7fecdfbfe9856b089e3">MAX_RETRY_TIME</a>;
<a name="l06183"></a>06183       <span class="comment">/* Acks&apos; don&apos;t get retried */</span>
<a name="l06184"></a>06184       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>))
<a name="l06185"></a>06185          fr-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l06186"></a>06186       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)
<a name="l06187"></a>06187          pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a651f52e68c435d2cd74e0a6ee9f018f0">svoiceformat</a> = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l06188"></a>06188       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>)
<a name="l06189"></a>06189          pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2cd6784c5cdb13e5ff845fab09d51593">svideoformat</a> = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ~0x1;
<a name="l06190"></a>06190       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a>)) {
<a name="l06191"></a>06191          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">IAX_KEYPOPULATED</a>)) {
<a name="l06192"></a>06192             <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a>)
<a name="l06193"></a>06193                <a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">iax_outputframe</a>(fr, NULL, 2, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>, fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>));
<a name="l06194"></a>06194             <span class="keywordflow">else</span>
<a name="l06195"></a>06195                <a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">iax_outputframe</a>(fr, NULL, 2, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>));
<a name="l06196"></a>06196             <a class="code" href="chan__iax2_8c.html#a6423f55e3c003cc765531b7b1eebaeea">encrypt_frame</a>(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ae119b8bbe294cad12c32cd093eb81e4c">ecx</a>, fh, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, &amp;fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l06197"></a>06197             fr-&gt;<a class="code" href="structiax__frame.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>;
<a name="l06198"></a>06198             fr-&gt;<a class="code" href="structiax__frame.html#ae119b8bbe294cad12c32cd093eb81e4c">ecx</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ae119b8bbe294cad12c32cd093eb81e4c">ecx</a>;
<a name="l06199"></a>06199             fr-&gt;<a class="code" href="structiax__frame.html#acb5abb83f0ce114bf0dee2c3217ff466">mydcx</a> = pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#acb5abb83f0ce114bf0dee2c3217ff466">mydcx</a>;
<a name="l06200"></a>06200             memcpy(fr-&gt;<a class="code" href="structiax__frame.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, <span class="keyword">sizeof</span>(fr-&gt;<a class="code" href="structiax__frame.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>));
<a name="l06201"></a>06201          } <span class="keywordflow">else</span>
<a name="l06202"></a>06202             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Supposed to send packet encrypted, but no key?\n&quot;</span>);
<a name="l06203"></a>06203       }
<a name="l06204"></a>06204 
<a name="l06205"></a>06205       <span class="keywordflow">if</span> (now) {
<a name="l06206"></a>06206          res = <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(fr);
<a name="l06207"></a>06207       } <span class="keywordflow">else</span>
<a name="l06208"></a>06208          res = <a class="code" href="chan__iax2_8c.html#a5e79c2133d1b794a5143e721d162996e">iax2_transmit</a>(fr);
<a name="l06209"></a>06209    } <span class="keywordflow">else</span> {
<a name="l06210"></a>06210       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>)) {
<a name="l06211"></a>06211          <a class="code" href="chan__iax2_8c.html#a1ec41018ea899d7651c58905031a92f7">iax2_trunk_queue</a>(pvt, fr);
<a name="l06212"></a>06212          res = 0;
<a name="l06213"></a>06213       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l06214"></a>06214          <span class="comment">/* Video frame have no sequence number */</span>
<a name="l06215"></a>06215          fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a> = -1;
<a name="l06216"></a>06216          fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> = -1;
<a name="l06217"></a>06217          vh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__video__hdr.html">ast_iax2_video_hdr</a> *)(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__video__hdr.html">ast_iax2_video_hdr</a>));
<a name="l06218"></a>06218          vh-&gt;<a class="code" href="structast__iax2__video__hdr.html#a536adab2c572868ca3f967c9d370e5b3">zeros</a> = 0;
<a name="l06219"></a>06219          vh-&gt;<a class="code" href="structast__iax2__video__hdr.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = htons(0x8000 | fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l06220"></a>06220          vh-&gt;<a class="code" href="structast__iax2__video__hdr.html#a84074dc9c4d9c2bdd3fbad69e032e9f7">ts</a> = htons((fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> &amp; 0x7FFF) | (fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; 0x1 ? 0x8000 : 0));
<a name="l06221"></a>06221          fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__video__hdr.html">ast_iax2_video_hdr</a>);
<a name="l06222"></a>06222          fr-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a> = vh;
<a name="l06223"></a>06223          fr-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l06224"></a>06224          res = <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(fr);        
<a name="l06225"></a>06225       } <span class="keywordflow">else</span> {
<a name="l06226"></a>06226          <span class="comment">/* Mini-frames have no sequence number */</span>
<a name="l06227"></a>06227          fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a> = -1;
<a name="l06228"></a>06228          fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> = -1;
<a name="l06229"></a>06229          <span class="comment">/* Mini frame will do */</span>
<a name="l06230"></a>06230          mh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a> *)(fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a>));
<a name="l06231"></a>06231          mh-&gt;<a class="code" href="structast__iax2__mini__hdr.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = htons(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l06232"></a>06232          mh-&gt;<a class="code" href="structast__iax2__mini__hdr.html#a84074dc9c4d9c2bdd3fbad69e032e9f7">ts</a> = htons(fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> &amp; 0xFFFF);
<a name="l06233"></a>06233          fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a>);
<a name="l06234"></a>06234          fr-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a> = mh;
<a name="l06235"></a>06235          fr-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l06236"></a>06236          <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a3fe2a477f9e84842066802bb8ad8a2b8">TRANSFER_MEDIAPASS</a>)
<a name="l06237"></a>06237             fr-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a> = 1;
<a name="l06238"></a>06238          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a>)) {
<a name="l06239"></a>06239             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(pvt, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">IAX_KEYPOPULATED</a>)) {
<a name="l06240"></a>06240                <a class="code" href="chan__iax2_8c.html#a6423f55e3c003cc765531b7b1eebaeea">encrypt_frame</a>(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ae119b8bbe294cad12c32cd093eb81e4c">ecx</a>, (<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *)mh, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a00f102e8d935ee4cfecea51855c146a9">semirand</a>, &amp;fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l06241"></a>06241             } <span class="keywordflow">else</span>
<a name="l06242"></a>06242                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Supposed to send packet encrypted, but no key?\n&quot;</span>);
<a name="l06243"></a>06243          }
<a name="l06244"></a>06244          res = <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(fr);
<a name="l06245"></a>06245       }
<a name="l06246"></a>06246    }
<a name="l06247"></a>06247    <span class="keywordflow">return</span> res;
<a name="l06248"></a>06248 }
<a name="l06249"></a>06249 
<a name="l06250"></a><a class="code" href="chan__iax2_8c.html#ac03f459dcfd393ca782d40817ce11f15">06250</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#ac03f459dcfd393ca782d40817ce11f15">handle_cli_iax2_show_users</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06251"></a>06251 {
<a name="l06252"></a>06252    regex_t regexbuf;
<a name="l06253"></a>06253    <span class="keywordtype">int</span> havepattern = 0;
<a name="l06254"></a>06254 
<a name="l06255"></a>06255 <span class="preprocessor">#define FORMAT &quot;%-15.15s  %-20.20s  %-15.15s  %-15.15s  %-5.5s  %-5.10s\n&quot;</span>
<a name="l06256"></a>06256 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT2 &quot;%-15.15s  %-20.20s  %-15.15d  %-15.15s  %-5.5s  %-5.10s\n&quot;</span>
<a name="l06257"></a>06257 <span class="preprocessor"></span>
<a name="l06258"></a>06258    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l06259"></a>06259    <span class="keywordtype">char</span> auth[90];
<a name="l06260"></a>06260    <span class="keywordtype">char</span> *pstr = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06261"></a>06261    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l06262"></a>06262 
<a name="l06263"></a>06263    <span class="keywordflow">switch</span> (cmd) {
<a name="l06264"></a>06264    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06265"></a>06265       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show users [like]&quot;</span>;
<a name="l06266"></a>06266       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06267"></a>06267          <span class="stringliteral">&quot;Usage: iax2 show users [like &lt;pattern&gt;]\n&quot;</span>
<a name="l06268"></a>06268          <span class="stringliteral">&quot;       Lists all known IAX2 users.\n&quot;</span>
<a name="l06269"></a>06269          <span class="stringliteral">&quot;       Optional regular expression pattern is used to filter the user list.\n&quot;</span>;
<a name="l06270"></a>06270       <span class="keywordflow">return</span> NULL;
<a name="l06271"></a>06271    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06272"></a>06272       <span class="keywordflow">return</span> NULL;
<a name="l06273"></a>06273    }
<a name="l06274"></a>06274 
<a name="l06275"></a>06275    <span class="keywordflow">switch</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>) {
<a name="l06276"></a>06276    <span class="keywordflow">case</span> 5:
<a name="l06277"></a>06277       <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;like&quot;</span>)) {
<a name="l06278"></a>06278          <span class="keywordflow">if</span> (regcomp(&amp;regexbuf, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], REG_EXTENDED | REG_NOSUB))
<a name="l06279"></a>06279             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06280"></a>06280          havepattern = 1;
<a name="l06281"></a>06281       } <span class="keywordflow">else</span>
<a name="l06282"></a>06282          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06283"></a>06283    <span class="keywordflow">case</span> 3:
<a name="l06284"></a>06284       <span class="keywordflow">break</span>;
<a name="l06285"></a>06285    <span class="keywordflow">default</span>:
<a name="l06286"></a>06286       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06287"></a>06287    }
<a name="l06288"></a>06288 
<a name="l06289"></a>06289    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;Username&quot;</span>, <span class="stringliteral">&quot;Secret&quot;</span>, <span class="stringliteral">&quot;Authen&quot;</span>, <span class="stringliteral">&quot;Def.Context&quot;</span>, <span class="stringliteral">&quot;A/C&quot;</span>,<span class="stringliteral">&quot;Codec Pref&quot;</span>);
<a name="l06290"></a>06290    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(users, 0);
<a name="l06291"></a>06291    <span class="keywordflow">for</span> (user = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i); user; 
<a name="l06292"></a>06292       <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user), user = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i)) {
<a name="l06293"></a>06293       <span class="keywordflow">if</span> (havepattern &amp;&amp; regexec(&amp;regexbuf, user-&gt;name, 0, NULL, 0))
<a name="l06294"></a>06294          <span class="keywordflow">continue</span>;
<a name="l06295"></a>06295       
<a name="l06296"></a>06296       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;secret)) {
<a name="l06297"></a>06297          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(auth,user-&gt;secret, <span class="keyword">sizeof</span>(auth));
<a name="l06298"></a>06298       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;inkeys)) {
<a name="l06299"></a>06299          snprintf(auth, <span class="keyword">sizeof</span>(auth), <span class="stringliteral">&quot;Key: %-15.15s &quot;</span>, user-&gt;inkeys);
<a name="l06300"></a>06300       } <span class="keywordflow">else</span>
<a name="l06301"></a>06301          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(auth, <span class="stringliteral">&quot;-no secret-&quot;</span>, <span class="keyword">sizeof</span>(auth));
<a name="l06302"></a>06302       
<a name="l06303"></a>06303       <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user,<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>))
<a name="l06304"></a>06304          pstr = <span class="stringliteral">&quot;REQ Only&quot;</span>;
<a name="l06305"></a>06305       <span class="keywordflow">else</span> <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user,<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>))
<a name="l06306"></a>06306          pstr = <span class="stringliteral">&quot;Disabled&quot;</span>;
<a name="l06307"></a>06307       <span class="keywordflow">else</span>
<a name="l06308"></a>06308          pstr = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user,<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>) ? <span class="stringliteral">&quot;Caller&quot;</span> : <span class="stringliteral">&quot;Host&quot;</span>;
<a name="l06309"></a>06309       
<a name="l06310"></a>06310       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#acfd58ce0ec836919236d7a1908494970">FORMAT2</a>, user-&gt;name, auth, user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>, 
<a name="l06311"></a>06311          user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a> ? user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>-&gt;<a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> : <a class="code" href="chan__iax2_8c.html#a65482022daa21b4f2424677e9f3c2f65">DEFAULT_CONTEXT</a>,
<a name="l06312"></a>06312          user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>, pstr);
<a name="l06313"></a>06313    }
<a name="l06314"></a>06314    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l06315"></a>06315 
<a name="l06316"></a>06316    <span class="keywordflow">if</span> (havepattern)
<a name="l06317"></a>06317       regfree(&amp;regexbuf);
<a name="l06318"></a>06318 
<a name="l06319"></a>06319    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06320"></a>06320 <span class="preprocessor">#undef FORMAT</span>
<a name="l06321"></a>06321 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT2</span>
<a name="l06322"></a>06322 <span class="preprocessor"></span>}
<a name="l06323"></a>06323 
<a name="l06324"></a><a class="code" href="chan__iax2_8c.html#a574ad155b4f3030f35fa3f1e8115df78">06324</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a574ad155b4f3030f35fa3f1e8115df78">__iax2_show_peers</a>(<span class="keywordtype">int</span> manager, <span class="keywordtype">int</span> fd, <span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> *argv[])
<a name="l06325"></a>06325 {
<a name="l06326"></a>06326    regex_t regexbuf;
<a name="l06327"></a>06327    <span class="keywordtype">int</span> havepattern = 0;
<a name="l06328"></a>06328    <span class="keywordtype">int</span> total_peers = 0;
<a name="l06329"></a>06329    <span class="keywordtype">int</span> online_peers = 0;
<a name="l06330"></a>06330    <span class="keywordtype">int</span> offline_peers = 0;
<a name="l06331"></a>06331    <span class="keywordtype">int</span> unmonitored_peers = 0;
<a name="l06332"></a>06332    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l06333"></a>06333 
<a name="l06334"></a>06334 <span class="preprocessor">#define FORMAT2 &quot;%-15.15s  %-15.15s %s  %-15.15s  %-8s  %s %-10s%s&quot;</span>
<a name="l06335"></a>06335 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT &quot;%-15.15s  %-15.15s %s  %-15.15s  %-5d%s  %s %-10s%s&quot;</span>
<a name="l06336"></a>06336 <span class="preprocessor"></span>
<a name="l06337"></a>06337    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l06338"></a>06338    <span class="keywordtype">char</span> <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>[256];
<a name="l06339"></a>06339    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *encmethods = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(256);
<a name="l06340"></a>06340    <span class="keywordtype">int</span> registeredonly=0;
<a name="l06341"></a>06341    <span class="keywordtype">char</span> *term = manager ? <span class="stringliteral">&quot;\r\n&quot;</span> : <span class="stringliteral">&quot;\n&quot;</span>;
<a name="l06342"></a>06342    <span class="keywordtype">char</span> idtext[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06343"></a>06343    <span class="keywordflow">switch</span> (argc) {
<a name="l06344"></a>06344    <span class="keywordflow">case</span> 6:
<a name="l06345"></a>06345       <span class="keywordflow">if</span> (!strcasecmp(argv[3], <span class="stringliteral">&quot;registered&quot;</span>))
<a name="l06346"></a>06346          registeredonly = 1;
<a name="l06347"></a>06347       <span class="keywordflow">else</span>
<a name="l06348"></a>06348          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06349"></a>06349       <span class="keywordflow">if</span> (!strcasecmp(argv[4], <span class="stringliteral">&quot;like&quot;</span>)) {
<a name="l06350"></a>06350          <span class="keywordflow">if</span> (regcomp(&amp;regexbuf, argv[5], REG_EXTENDED | REG_NOSUB))
<a name="l06351"></a>06351             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06352"></a>06352          havepattern = 1;
<a name="l06353"></a>06353       } <span class="keywordflow">else</span>
<a name="l06354"></a>06354          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06355"></a>06355       <span class="keywordflow">break</span>;
<a name="l06356"></a>06356    <span class="keywordflow">case</span> 5:
<a name="l06357"></a>06357       <span class="keywordflow">if</span> (!strcasecmp(argv[3], <span class="stringliteral">&quot;like&quot;</span>)) {
<a name="l06358"></a>06358          <span class="keywordflow">if</span> (regcomp(&amp;regexbuf, argv[4], REG_EXTENDED | REG_NOSUB))
<a name="l06359"></a>06359             <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06360"></a>06360          havepattern = 1;
<a name="l06361"></a>06361       } <span class="keywordflow">else</span>
<a name="l06362"></a>06362          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06363"></a>06363       <span class="keywordflow">break</span>;
<a name="l06364"></a>06364    <span class="keywordflow">case</span> 4:
<a name="l06365"></a>06365       <span class="keywordflow">if</span> (!strcasecmp(argv[3], <span class="stringliteral">&quot;registered&quot;</span>))
<a name="l06366"></a>06366          registeredonly = 1;
<a name="l06367"></a>06367       <span class="keywordflow">else</span>
<a name="l06368"></a>06368          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06369"></a>06369       <span class="keywordflow">break</span>;
<a name="l06370"></a>06370    <span class="keywordflow">case</span> 3:
<a name="l06371"></a>06371       <span class="keywordflow">break</span>;
<a name="l06372"></a>06372    <span class="keywordflow">default</span>:
<a name="l06373"></a>06373       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>;
<a name="l06374"></a>06374    }
<a name="l06375"></a>06375 
<a name="l06376"></a>06376 
<a name="l06377"></a>06377    <span class="keywordflow">if</span> (!s)
<a name="l06378"></a>06378       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="chan__dahdi_8c.html#acfd58ce0ec836919236d7a1908494970">FORMAT2</a>, <span class="stringliteral">&quot;Name/Username&quot;</span>, <span class="stringliteral">&quot;Host&quot;</span>, <span class="stringliteral">&quot;   &quot;</span>, <span class="stringliteral">&quot;Mask&quot;</span>, <span class="stringliteral">&quot;Port&quot;</span>, <span class="stringliteral">&quot;   &quot;</span>, <span class="stringliteral">&quot;Status&quot;</span>, term);
<a name="l06379"></a>06379 
<a name="l06380"></a>06380    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l06381"></a>06381    <span class="keywordflow">for</span> (peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i); peer; 
<a name="l06382"></a>06382       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer), peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i)) {
<a name="l06383"></a>06383       <span class="keywordtype">char</span> nm[20];
<a name="l06384"></a>06384       <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>[20];
<a name="l06385"></a>06385       <span class="keywordtype">int</span> retstatus;
<a name="l06386"></a>06386 
<a name="l06387"></a>06387       <span class="keywordflow">if</span> (registeredonly &amp;&amp; !peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr)
<a name="l06388"></a>06388          <span class="keywordflow">continue</span>;
<a name="l06389"></a>06389       <span class="keywordflow">if</span> (havepattern &amp;&amp; regexec(&amp;regexbuf, peer-&gt;name, 0, NULL, 0))
<a name="l06390"></a>06390          <span class="keywordflow">continue</span>;
<a name="l06391"></a>06391 
<a name="l06392"></a>06392       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;username))
<a name="l06393"></a>06393          snprintf(name, <span class="keyword">sizeof</span>(name), <span class="stringliteral">&quot;%s/%s&quot;</span>, peer-&gt;name, peer-&gt;username);
<a name="l06394"></a>06394       <span class="keywordflow">else</span>
<a name="l06395"></a>06395          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(name, peer-&gt;name, <span class="keyword">sizeof</span>(name));
<a name="l06396"></a>06396 
<a name="l06397"></a>06397       <a class="code" href="chan__iax2_8c.html#aab0a14f82b40eb534e3b026724636b41">encmethods_to_str</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>, encmethods);
<a name="l06398"></a>06398       retstatus = <a class="code" href="chan__iax2_8c.html#aa421fc97db5511876bc29d397fd65827" title="peer_status: Report Peer status in character string">peer_status</a>(peer, status, <span class="keyword">sizeof</span>(status));
<a name="l06399"></a>06399       <span class="keywordflow">if</span> (retstatus &gt; 0)
<a name="l06400"></a>06400          online_peers++;
<a name="l06401"></a>06401       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!retstatus)
<a name="l06402"></a>06402          offline_peers++;
<a name="l06403"></a>06403       <span class="keywordflow">else</span>
<a name="l06404"></a>06404          unmonitored_peers++;
<a name="l06405"></a>06405 
<a name="l06406"></a>06406       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(nm, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>), <span class="keyword">sizeof</span>(nm));
<a name="l06407"></a>06407 
<a name="l06408"></a>06408       <span class="keywordflow">if</span> (s) {
<a name="l06409"></a>06409          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l06410"></a>06410             <span class="stringliteral">&quot;Event: PeerEntry\r\n%s&quot;</span>
<a name="l06411"></a>06411             <span class="stringliteral">&quot;Channeltype: IAX2\r\n&quot;</span>
<a name="l06412"></a>06412             <span class="stringliteral">&quot;ChanObjectType: peer\r\n&quot;</span>
<a name="l06413"></a>06413             <span class="stringliteral">&quot;ObjectName: %s\r\n&quot;</span>
<a name="l06414"></a>06414             <span class="stringliteral">&quot;IPaddress: %s\r\n&quot;</span>
<a name="l06415"></a>06415             <span class="stringliteral">&quot;IPport: %d\r\n&quot;</span>
<a name="l06416"></a>06416             <span class="stringliteral">&quot;Dynamic: %s\r\n&quot;</span>
<a name="l06417"></a>06417             <span class="stringliteral">&quot;Trunk: %s\r\n&quot;</span>
<a name="l06418"></a>06418             <span class="stringliteral">&quot;Encryption: %s\r\n&quot;</span>
<a name="l06419"></a>06419             <span class="stringliteral">&quot;Status: %s\r\n\r\n&quot;</span>,
<a name="l06420"></a>06420             idtext,
<a name="l06421"></a>06421             name,
<a name="l06422"></a>06422             peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;-none-&quot;</span>,
<a name="l06423"></a>06423             ntohs(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port),
<a name="l06424"></a>06424             <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>) ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l06425"></a>06425             <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l06426"></a>06426             peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> ? <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(encmethods) : <span class="stringliteral">&quot;no&quot;</span>,
<a name="l06427"></a>06427             status);
<a name="l06428"></a>06428       } <span class="keywordflow">else</span> {
<a name="l06429"></a>06429          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, name,
<a name="l06430"></a>06430             peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;(Unspecified)&quot;</span>,
<a name="l06431"></a>06431             <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>) ? <span class="stringliteral">&quot;(D)&quot;</span> : <span class="stringliteral">&quot;(S)&quot;</span>,
<a name="l06432"></a>06432             nm,
<a name="l06433"></a>06433             ntohs(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port),
<a name="l06434"></a>06434             <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) ? <span class="stringliteral">&quot;(T)&quot;</span> : <span class="stringliteral">&quot;   &quot;</span>,
<a name="l06435"></a>06435             peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> ? <span class="stringliteral">&quot;(E)&quot;</span> : <span class="stringliteral">&quot;   &quot;</span>,
<a name="l06436"></a>06436             status,
<a name="l06437"></a>06437             term);
<a name="l06438"></a>06438       }
<a name="l06439"></a>06439       total_peers++;
<a name="l06440"></a>06440    }
<a name="l06441"></a>06441    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l06442"></a>06442 
<a name="l06443"></a>06443    <span class="keywordflow">if</span> (!s)
<a name="l06444"></a>06444       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,<span class="stringliteral">&quot;%d iax2 peers [%d online, %d offline, %d unmonitored]%s&quot;</span>, total_peers, online_peers, offline_peers, unmonitored_peers, term);
<a name="l06445"></a>06445 
<a name="l06446"></a>06446    <span class="keywordflow">if</span> (havepattern)
<a name="l06447"></a>06447       regfree(&amp;regexbuf);
<a name="l06448"></a>06448 
<a name="l06449"></a>06449    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06450"></a>06450 <span class="preprocessor">#undef FORMAT</span>
<a name="l06451"></a>06451 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT2</span>
<a name="l06452"></a>06452 <span class="preprocessor"></span>}
<a name="l06453"></a>06453 
<a name="l06454"></a><a class="code" href="chan__iax2_8c.html#ae96aabd3e9adc0f216e6a089d95064c8">06454</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#ae96aabd3e9adc0f216e6a089d95064c8">handle_cli_iax2_show_threads</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06455"></a>06455 {
<a name="l06456"></a>06456    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = NULL;
<a name="l06457"></a>06457    time_t t;
<a name="l06458"></a>06458    <span class="keywordtype">int</span> threadcount = 0, dynamiccount = 0;
<a name="l06459"></a>06459    <span class="keywordtype">char</span> type;
<a name="l06460"></a>06460 
<a name="l06461"></a>06461    <span class="keywordflow">switch</span> (cmd) {
<a name="l06462"></a>06462    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06463"></a>06463       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show threads&quot;</span>;
<a name="l06464"></a>06464       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06465"></a>06465          <span class="stringliteral">&quot;Usage: iax2 show threads\n&quot;</span>
<a name="l06466"></a>06466          <span class="stringliteral">&quot;       Lists status of IAX helper threads\n&quot;</span>;
<a name="l06467"></a>06467       <span class="keywordflow">return</span> NULL;
<a name="l06468"></a>06468    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06469"></a>06469       <span class="keywordflow">return</span> NULL;
<a name="l06470"></a>06470    }
<a name="l06471"></a>06471    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l06472"></a>06472       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06473"></a>06473       
<a name="l06474"></a>06474    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Thread Information\n&quot;</span>);
<a name="l06475"></a>06475    time(&amp;t);
<a name="l06476"></a>06476    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Idle Threads:\n&quot;</span>);
<a name="l06477"></a>06477    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;idle_list);
<a name="l06478"></a>06478    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;idle_list, thread, list) {
<a name="l06479"></a>06479 <span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l06480"></a>06480 <span class="preprocessor"></span>      <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Thread %d: state=%d, update=%d, actions=%d, func=&apos;%s&apos;\n&quot;</span>, 
<a name="l06481"></a>06481          thread-&gt;threadnum, thread-&gt;iostate, (<span class="keywordtype">int</span>)(t - thread-&gt;checktime), thread-&gt;actions, thread-&gt;curfunc);
<a name="l06482"></a>06482 <span class="preprocessor">#else</span>
<a name="l06483"></a>06483 <span class="preprocessor"></span>      <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Thread %d: state=%d, update=%d, actions=%d\n&quot;</span>, 
<a name="l06484"></a>06484          thread-&gt;threadnum, thread-&gt;iostate, (<span class="keywordtype">int</span>)(t - thread-&gt;checktime), thread-&gt;actions);
<a name="l06485"></a>06485 <span class="preprocessor">#endif</span>
<a name="l06486"></a>06486 <span class="preprocessor"></span>      threadcount++;
<a name="l06487"></a>06487    }
<a name="l06488"></a>06488    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;idle_list);
<a name="l06489"></a>06489    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Active Threads:\n&quot;</span>);
<a name="l06490"></a>06490    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;active_list);
<a name="l06491"></a>06491    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;active_list, thread, list) {
<a name="l06492"></a>06492       <span class="keywordflow">if</span> (thread-&gt;type == <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7a0acfd1204de5016e9d076890e96a7d95">IAX_THREAD_TYPE_DYNAMIC</a>)
<a name="l06493"></a>06493          type = <span class="charliteral">&apos;D&apos;</span>;
<a name="l06494"></a>06494       <span class="keywordflow">else</span>
<a name="l06495"></a>06495          type = <span class="charliteral">&apos;P&apos;</span>;
<a name="l06496"></a>06496 <span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l06497"></a>06497 <span class="preprocessor"></span>      <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Thread %c%d: state=%d, update=%d, actions=%d, func=&apos;%s&apos;\n&quot;</span>, 
<a name="l06498"></a>06498          type, thread-&gt;threadnum, thread-&gt;iostate, (<span class="keywordtype">int</span>)(t - thread-&gt;checktime), thread-&gt;actions, thread-&gt;curfunc);
<a name="l06499"></a>06499 <span class="preprocessor">#else</span>
<a name="l06500"></a>06500 <span class="preprocessor"></span>      <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Thread %c%d: state=%d, update=%d, actions=%d\n&quot;</span>, 
<a name="l06501"></a>06501          type, thread-&gt;threadnum, thread-&gt;iostate, (<span class="keywordtype">int</span>)(t - thread-&gt;checktime), thread-&gt;actions);
<a name="l06502"></a>06502 <span class="preprocessor">#endif</span>
<a name="l06503"></a>06503 <span class="preprocessor"></span>      threadcount++;
<a name="l06504"></a>06504    }
<a name="l06505"></a>06505    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;active_list);
<a name="l06506"></a>06506    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Dynamic Threads:\n&quot;</span>);
<a name="l06507"></a>06507    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l06508"></a>06508    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;dynamic_list, thread, list) {
<a name="l06509"></a>06509 <span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l06510"></a>06510 <span class="preprocessor"></span>      <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Thread %d: state=%d, update=%d, actions=%d, func=&apos;%s&apos;\n&quot;</span>,
<a name="l06511"></a>06511          thread-&gt;threadnum, thread-&gt;iostate, (<span class="keywordtype">int</span>)(t - thread-&gt;checktime), thread-&gt;actions, thread-&gt;curfunc);
<a name="l06512"></a>06512 <span class="preprocessor">#else</span>
<a name="l06513"></a>06513 <span class="preprocessor"></span>      <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Thread %d: state=%d, update=%d, actions=%d\n&quot;</span>,
<a name="l06514"></a>06514          thread-&gt;threadnum, thread-&gt;iostate, (<span class="keywordtype">int</span>)(t - thread-&gt;checktime), thread-&gt;actions);
<a name="l06515"></a>06515 <span class="preprocessor">#endif</span>
<a name="l06516"></a>06516 <span class="preprocessor"></span>      dynamiccount++;
<a name="l06517"></a>06517    }
<a name="l06518"></a>06518    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l06519"></a>06519    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d of %d threads accounted for with %d dynamic threads\n&quot;</span>, threadcount, <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a>, dynamiccount);
<a name="l06520"></a>06520    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06521"></a>06521 }
<a name="l06522"></a>06522 
<a name="l06523"></a><a class="code" href="chan__iax2_8c.html#a965752556c82e93521ee4c2a4edc1fd3">06523</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a965752556c82e93521ee4c2a4edc1fd3">handle_cli_iax2_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06524"></a>06524 {
<a name="l06525"></a>06525    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *p;
<a name="l06526"></a>06526 
<a name="l06527"></a>06527    <span class="keywordflow">switch</span> (cmd) {
<a name="l06528"></a>06528    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06529"></a>06529       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 unregister&quot;</span>;
<a name="l06530"></a>06530       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06531"></a>06531          <span class="stringliteral">&quot;Usage: iax2 unregister &lt;peername&gt;\n&quot;</span>
<a name="l06532"></a>06532          <span class="stringliteral">&quot;       Unregister (force expiration) an IAX2 peer from the registry.\n&quot;</span>;
<a name="l06533"></a>06533       <span class="keywordflow">return</span> NULL;
<a name="l06534"></a>06534    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06535"></a>06535       <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#abe7189ac2109339aabccb7a46b915110">complete_iax2_unregister</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l06536"></a>06536    }
<a name="l06537"></a>06537 
<a name="l06538"></a>06538    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l06539"></a>06539       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06540"></a>06540 
<a name="l06541"></a>06541    p = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], 1);
<a name="l06542"></a>06542    <span class="keywordflow">if</span> (p) {
<a name="l06543"></a>06543       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> &gt; 0) {
<a name="l06544"></a>06544          <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> tmp_peer = {
<a name="l06545"></a>06545             .name = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2],
<a name="l06546"></a>06546          };
<a name="l06547"></a>06547          <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l06548"></a>06548 
<a name="l06549"></a>06549          peer = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peers, &amp;tmp_peer, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l06550"></a>06550          <span class="keywordflow">if</span> (peer) {
<a name="l06551"></a>06551             <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>(<a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer)); <span class="comment">/* will release its own reference when done */</span>
<a name="l06552"></a>06552             <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer); <span class="comment">/* ref from ao2_find() */</span>
<a name="l06553"></a>06553             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer %s unregistered\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l06554"></a>06554          } <span class="keywordflow">else</span> {
<a name="l06555"></a>06555             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer %s not found\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l06556"></a>06556          }
<a name="l06557"></a>06557       } <span class="keywordflow">else</span> {
<a name="l06558"></a>06558          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer %s not registered\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l06559"></a>06559       }
<a name="l06560"></a>06560    } <span class="keywordflow">else</span> {
<a name="l06561"></a>06561       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Peer unknown: %s. Not unregistered\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l06562"></a>06562    }
<a name="l06563"></a>06563    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06564"></a>06564 }
<a name="l06565"></a>06565 
<a name="l06566"></a><a class="code" href="chan__iax2_8c.html#abe7189ac2109339aabccb7a46b915110">06566</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#abe7189ac2109339aabccb7a46b915110">complete_iax2_unregister</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l06567"></a>06567 {
<a name="l06568"></a>06568    <span class="keywordtype">int</span> which = 0;
<a name="l06569"></a>06569    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *p = NULL;
<a name="l06570"></a>06570    <span class="keywordtype">char</span> *res = NULL;
<a name="l06571"></a>06571    <span class="keywordtype">int</span> wordlen = strlen(word);
<a name="l06572"></a>06572 
<a name="l06573"></a>06573    <span class="comment">/* 0 - iax2; 1 - unregister; 2 - &lt;peername&gt; */</span>
<a name="l06574"></a>06574    <span class="keywordflow">if</span> (pos == 2) {
<a name="l06575"></a>06575       <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l06576"></a>06576       <span class="keywordflow">while</span> ((p = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l06577"></a>06577          <span class="keywordflow">if</span> (!strncasecmp(p-&gt;name, word, wordlen) &amp;&amp; 
<a name="l06578"></a>06578             ++which &gt; state &amp;&amp; p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> &gt; 0) {
<a name="l06579"></a>06579             res = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(p-&gt;name);
<a name="l06580"></a>06580             <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l06581"></a>06581             <span class="keywordflow">break</span>;
<a name="l06582"></a>06582          }
<a name="l06583"></a>06583          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l06584"></a>06584       }
<a name="l06585"></a>06585       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l06586"></a>06586    }
<a name="l06587"></a>06587 
<a name="l06588"></a>06588    <span class="keywordflow">return</span> res;
<a name="l06589"></a>06589 }
<a name="l06590"></a>06590 
<a name="l06591"></a><a class="code" href="chan__iax2_8c.html#ac7775dacce1a57ea4f4d57dfd952737a">06591</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#ac7775dacce1a57ea4f4d57dfd952737a">handle_cli_iax2_show_peers</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06592"></a>06592 {
<a name="l06593"></a>06593    <span class="keywordflow">switch</span> (cmd) {
<a name="l06594"></a>06594    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06595"></a>06595       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show peers&quot;</span>;
<a name="l06596"></a>06596       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06597"></a>06597          <span class="stringliteral">&quot;Usage: iax2 show peers [registered] [like &lt;pattern&gt;]\n&quot;</span>
<a name="l06598"></a>06598          <span class="stringliteral">&quot;       Lists all known IAX2 peers.\n&quot;</span>
<a name="l06599"></a>06599          <span class="stringliteral">&quot;       Optional &apos;registered&apos; argument lists only peers with known addresses.\n&quot;</span>
<a name="l06600"></a>06600          <span class="stringliteral">&quot;       Optional regular expression pattern is used to filter the peer list.\n&quot;</span>;
<a name="l06601"></a>06601       <span class="keywordflow">return</span> NULL;
<a name="l06602"></a>06602    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06603"></a>06603       <span class="keywordflow">return</span> NULL;
<a name="l06604"></a>06604    }
<a name="l06605"></a>06605 
<a name="l06606"></a>06606    <span class="keywordflow">switch</span> (<a class="code" href="chan__iax2_8c.html#a574ad155b4f3030f35fa3f1e8115df78">__iax2_show_peers</a>(0, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, NULL, a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>)) {
<a name="l06607"></a>06607    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a76ed22cec1f42c93a5b4eed8d967338f">RESULT_SHOWUSAGE</a>:
<a name="l06608"></a>06608       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06609"></a>06609    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#aea87ce97f86effb2c4df6274d4aac567">RESULT_FAILURE</a>:
<a name="l06610"></a>06610       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l06611"></a>06611    <span class="keywordflow">default</span>:
<a name="l06612"></a>06612       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06613"></a>06613    }
<a name="l06614"></a>06614 }
<a name="l06615"></a>06615 
<a name="l06616"></a><a class="code" href="chan__iax2_8c.html#a72b0fcb17d98c9319451b7377d73cb8b">06616</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a72b0fcb17d98c9319451b7377d73cb8b">manager_iax2_show_netstats</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06617"></a>06617 {
<a name="l06618"></a>06618    <a class="code" href="chan__iax2_8c.html#aa97568aae0bbccb48217b5bd8e96bf3a">ast_cli_netstats</a>(s, -1, 0);
<a name="l06619"></a>06619    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l06620"></a>06620    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06621"></a>06621 }
<a name="l06622"></a>06622 
<a name="l06623"></a><a class="code" href="chan__iax2_8c.html#a8d9a0db02bc32783280bb07e4477275a">06623</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a8d9a0db02bc32783280bb07e4477275a">handle_cli_iax2_show_firmware</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06624"></a>06624 {
<a name="l06625"></a>06625    <span class="keyword">struct </span><a class="code" href="structiax__firmware.html">iax_firmware</a> *cur = NULL;
<a name="l06626"></a>06626 
<a name="l06627"></a>06627    <span class="keywordflow">switch</span> (cmd) {
<a name="l06628"></a>06628    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06629"></a>06629       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show firmware&quot;</span>;
<a name="l06630"></a>06630       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06631"></a>06631          <span class="stringliteral">&quot;Usage: iax2 show firmware\n&quot;</span>
<a name="l06632"></a>06632          <span class="stringliteral">&quot;       Lists all known IAX firmware images.\n&quot;</span>;
<a name="l06633"></a>06633       <span class="keywordflow">return</span> NULL;
<a name="l06634"></a>06634    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06635"></a>06635       <span class="keywordflow">return</span> NULL;
<a name="l06636"></a>06636    }
<a name="l06637"></a>06637 
<a name="l06638"></a>06638    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3 &amp;&amp; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 4)
<a name="l06639"></a>06639       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06640"></a>06640 
<a name="l06641"></a>06641    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-15.15s  %-15.15s %-15.15s\n&quot;</span>, <span class="stringliteral">&quot;Device&quot;</span>, <span class="stringliteral">&quot;Version&quot;</span>, <span class="stringliteral">&quot;Size&quot;</span>);
<a name="l06642"></a>06642    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;firmwares);
<a name="l06643"></a>06643    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;firmwares, cur, list) {
<a name="l06644"></a>06644       <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) || (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], (<span class="keywordtype">char</span> *) cur-&gt;fwh-&gt;devname)))  {
<a name="l06645"></a>06645          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%-15.15s  %-15d %-15d\n&quot;</span>, cur-&gt;fwh-&gt;devname, 
<a name="l06646"></a>06646             ntohs(cur-&gt;fwh-&gt;version), (<span class="keywordtype">int</span>)ntohl(cur-&gt;fwh-&gt;datalen));
<a name="l06647"></a>06647       }
<a name="l06648"></a>06648    }
<a name="l06649"></a>06649    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;firmwares);
<a name="l06650"></a>06650 
<a name="l06651"></a>06651    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06652"></a>06652 }
<a name="l06653"></a>06653 <span class="comment"></span>
<a name="l06654"></a>06654 <span class="comment">/*! \brief callback to display iax peers in manager */</span>
<a name="l06655"></a><a class="code" href="chan__iax2_8c.html#a04a8d61a72c9c2c5b046b5b18c18f1f4">06655</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a04a8d61a72c9c2c5b046b5b18c18f1f4" title="callback to display iax peers in manager">manager_iax2_show_peers</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06656"></a>06656 {
<a name="l06657"></a>06657    <span class="keywordtype">char</span> *a[] = { <span class="stringliteral">&quot;iax2&quot;</span>, <span class="stringliteral">&quot;show&quot;</span>, <span class="stringliteral">&quot;users&quot;</span> };
<a name="l06658"></a>06658    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l06659"></a>06659    <span class="keywordtype">char</span> idtext[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06660"></a>06660 
<a name="l06661"></a>06661    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l06662"></a>06662       snprintf(idtext, <span class="keyword">sizeof</span>(idtext), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l06663"></a>06663    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Peer status list will follow&quot;</span>);
<a name="l06664"></a>06664    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a574ad155b4f3030f35fa3f1e8115df78">__iax2_show_peers</a>(1, -1, s, 3, a );
<a name="l06665"></a>06665 } 
<a name="l06666"></a>06666 <span class="comment"></span>
<a name="l06667"></a>06667 <span class="comment">/*! \brief callback to display iax peers in manager format */</span>
<a name="l06668"></a><a class="code" href="chan__iax2_8c.html#ad94a22fbc017b75cb057a4f925dfa4d0">06668</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad94a22fbc017b75cb057a4f925dfa4d0" title="callback to display iax peers in manager format">manager_iax2_show_peer_list</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06669"></a>06669 {
<a name="l06670"></a>06670    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l06671"></a>06671    <span class="keywordtype">int</span> peer_count = 0;
<a name="l06672"></a>06672    <span class="keywordtype">char</span> nm[20];
<a name="l06673"></a>06673    <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>[20];
<a name="l06674"></a>06674    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l06675"></a>06675    <span class="keywordtype">char</span> idtext[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06676"></a>06676    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *encmethods = <a class="code" href="strings_8h.html#a7fc844c12b769ccded05e7514036e241">ast_str_alloca</a>(256);
<a name="l06677"></a>06677    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l06678"></a>06678 
<a name="l06679"></a>06679    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l06680"></a>06680       snprintf(idtext, <span class="keyword">sizeof</span>(idtext), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l06681"></a>06681 
<a name="l06682"></a>06682    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Response: Success\r\n%sMessage: IAX Peer status list will follow\r\n\r\n&quot;</span>, idtext);
<a name="l06683"></a>06683 
<a name="l06684"></a>06684 
<a name="l06685"></a>06685    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l06686"></a>06686    <span class="keywordflow">for</span> (peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i); peer; <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer), peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i)) {
<a name="l06687"></a>06687       <a class="code" href="chan__iax2_8c.html#aab0a14f82b40eb534e3b026724636b41">encmethods_to_str</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>, encmethods);
<a name="l06688"></a>06688       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: PeerEntry\r\n%sChanneltype: IAX\r\n&quot;</span>, idtext);
<a name="l06689"></a>06689       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;username)) {
<a name="l06690"></a>06690          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;ObjectName: %s\r\nObjectUsername: %s\r\n&quot;</span>, peer-&gt;name, peer-&gt;username);
<a name="l06691"></a>06691       } <span class="keywordflow">else</span> {
<a name="l06692"></a>06692          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;ObjectName: %s\r\n&quot;</span>, peer-&gt;name);
<a name="l06693"></a>06693       }
<a name="l06694"></a>06694       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;ChanObjectType: peer\r\n&quot;</span>);
<a name="l06695"></a>06695       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;IPaddress: %s\r\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;-none-&quot;</span>);
<a name="l06696"></a>06696       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(nm, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>), <span class="keyword">sizeof</span>(nm));
<a name="l06697"></a>06697       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Mask: %s\r\n&quot;</span>, nm);
<a name="l06698"></a>06698       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Port: %d\r\n&quot;</span>, ntohs(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l06699"></a>06699       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Dynamic: %s\r\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l06700"></a>06700       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Trunk: %s\r\n&quot;</span>, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l06701"></a>06701       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Encryption: %s\r\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> ? <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(encmethods) : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l06702"></a>06702       <a class="code" href="chan__iax2_8c.html#aa421fc97db5511876bc29d397fd65827" title="peer_status: Report Peer status in character string">peer_status</a>(peer, status, <span class="keyword">sizeof</span>(status));
<a name="l06703"></a>06703       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Status: %s\r\n\r\n&quot;</span>, status);
<a name="l06704"></a>06704       peer_count++;
<a name="l06705"></a>06705    }
<a name="l06706"></a>06706    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l06707"></a>06707 
<a name="l06708"></a>06708    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: PeerlistComplete\r\n%sListItems: %d\r\n\r\n&quot;</span>, idtext, peer_count);
<a name="l06709"></a>06709    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l06710"></a>06710 }
<a name="l06711"></a>06711 
<a name="l06712"></a>06712 
<a name="l06713"></a><a class="code" href="chan__iax2_8c.html#a4c2ac3125749dac444bfa31ce63ec0cb">06713</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a4c2ac3125749dac444bfa31ce63ec0cb">regstate2str</a>(<span class="keywordtype">int</span> regstate)
<a name="l06714"></a>06714 {
<a name="l06715"></a>06715    <span class="keywordflow">switch</span>(regstate) {
<a name="l06716"></a>06716    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329afa6b79a3ca077d41b22de448c7ab34fb">REG_STATE_UNREGISTERED</a>:
<a name="l06717"></a>06717       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unregistered&quot;</span>;
<a name="l06718"></a>06718    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a024ddf2de7a878eb4da843c844dfd2e3">REG_STATE_REGSENT</a>:
<a name="l06719"></a>06719       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Request Sent&quot;</span>;
<a name="l06720"></a>06720    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0fc848e483149fa4f30c05562591db11">REG_STATE_AUTHSENT</a>:
<a name="l06721"></a>06721       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Auth. Sent&quot;</span>;
<a name="l06722"></a>06722    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a5cb994f5165979d5e32dff13aaff9c53">REG_STATE_REGISTERED</a>:
<a name="l06723"></a>06723       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Registered&quot;</span>;
<a name="l06724"></a>06724    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a769d5aec3f52823efc8cea5b24794d8d">REG_STATE_REJECTED</a>:
<a name="l06725"></a>06725       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Rejected&quot;</span>;
<a name="l06726"></a>06726    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0ceb5a0d8116282669c98effcffe96e3">REG_STATE_TIMEOUT</a>:
<a name="l06727"></a>06727       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Timeout&quot;</span>;
<a name="l06728"></a>06728    <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a4fd8866724976c0a65ddded1c5ca952b">REG_STATE_NOAUTH</a>:
<a name="l06729"></a>06729       <span class="keywordflow">return</span> <span class="stringliteral">&quot;No Authentication&quot;</span>;
<a name="l06730"></a>06730    <span class="keywordflow">default</span>:
<a name="l06731"></a>06731       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l06732"></a>06732    }
<a name="l06733"></a>06733 }
<a name="l06734"></a>06734 
<a name="l06735"></a><a class="code" href="chan__iax2_8c.html#a698aa48a1fdd30e3767c395d499e0357">06735</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a698aa48a1fdd30e3767c395d499e0357">handle_cli_iax2_show_registry</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06736"></a>06736 {
<a name="l06737"></a>06737 <span class="preprocessor">#define FORMAT2 &quot;%-20.20s  %-6.6s  %-10.10s  %-20.20s %8.8s  %s\n&quot;</span>
<a name="l06738"></a>06738 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT  &quot;%-20.20s  %-6.6s  %-10.10s  %-20.20s %8d  %s\n&quot;</span>
<a name="l06739"></a>06739 <span class="preprocessor"></span>   <span class="keyword">struct </span>iax2_registry *reg = NULL;
<a name="l06740"></a>06740    <span class="keywordtype">char</span> host[80];
<a name="l06741"></a>06741    <span class="keywordtype">char</span> perceived[80];
<a name="l06742"></a>06742    <span class="keywordtype">int</span> counter = 0;
<a name="l06743"></a>06743 
<a name="l06744"></a>06744    <span class="keywordflow">switch</span> (cmd) {
<a name="l06745"></a>06745    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06746"></a>06746       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show registry&quot;</span>;
<a name="l06747"></a>06747       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06748"></a>06748          <span class="stringliteral">&quot;Usage: iax2 show registry\n&quot;</span>
<a name="l06749"></a>06749          <span class="stringliteral">&quot;       Lists all registration requests and status.\n&quot;</span>;
<a name="l06750"></a>06750       <span class="keywordflow">return</span> NULL;
<a name="l06751"></a>06751    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06752"></a>06752       <span class="keywordflow">return</span> NULL;
<a name="l06753"></a>06753    }
<a name="l06754"></a>06754    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l06755"></a>06755       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06756"></a>06756    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#acfd58ce0ec836919236d7a1908494970">FORMAT2</a>, <span class="stringliteral">&quot;Host&quot;</span>, <span class="stringliteral">&quot;dnsmgr&quot;</span>, <span class="stringliteral">&quot;Username&quot;</span>, <span class="stringliteral">&quot;Perceived&quot;</span>, <span class="stringliteral">&quot;Refresh&quot;</span>, <span class="stringliteral">&quot;State&quot;</span>);
<a name="l06757"></a>06757    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;registrations);
<a name="l06758"></a>06758    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;registrations, reg, entry) {
<a name="l06759"></a>06759       snprintf(host, <span class="keyword">sizeof</span>(host), <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l06760"></a>06760       <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr.s_addr) 
<a name="l06761"></a>06761          snprintf(perceived, <span class="keyword">sizeof</span>(perceived), <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr), ntohs(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_port));
<a name="l06762"></a>06762       <span class="keywordflow">else</span>
<a name="l06763"></a>06763          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(perceived, <span class="stringliteral">&quot;&lt;Unregistered&gt;&quot;</span>, <span class="keyword">sizeof</span>(perceived));
<a name="l06764"></a>06764       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, host, 
<a name="l06765"></a>06765                (reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>) ? <span class="stringliteral">&quot;Y&quot;</span> : <span class="stringliteral">&quot;N&quot;</span>, 
<a name="l06766"></a>06766                reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, perceived, reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a>, <a class="code" href="chan__iax2_8c.html#a4c2ac3125749dac444bfa31ce63ec0cb">regstate2str</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a>));
<a name="l06767"></a>06767       counter++;
<a name="l06768"></a>06768    }
<a name="l06769"></a>06769    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;registrations);
<a name="l06770"></a>06770    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d IAX2 registrations.\n&quot;</span>, counter);
<a name="l06771"></a>06771    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06772"></a>06772 <span class="preprocessor">#undef FORMAT</span>
<a name="l06773"></a>06773 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT2</span>
<a name="l06774"></a>06774 <span class="preprocessor"></span>}
<a name="l06775"></a>06775 
<a name="l06776"></a><a class="code" href="chan__iax2_8c.html#a8ffe5b5e485072b501d24739bbf24be0">06776</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a8ffe5b5e485072b501d24739bbf24be0">manager_iax2_show_registry</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l06777"></a>06777 {
<a name="l06778"></a>06778    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l06779"></a>06779    <span class="keyword">struct </span>iax2_registry *reg = NULL;
<a name="l06780"></a>06780    <span class="keywordtype">char</span> idtext[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06781"></a>06781    <span class="keywordtype">char</span> host[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06782"></a>06782    <span class="keywordtype">char</span> perceived[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06783"></a>06783    <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> = 0;
<a name="l06784"></a>06784 
<a name="l06785"></a>06785    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l06786"></a>06786       snprintf(idtext, <span class="keyword">sizeof</span>(idtext), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l06787"></a>06787 
<a name="l06788"></a>06788    <a class="code" href="group__Group__AMI.html#ga0ee6ee1f4d200f711e2983bffe770a72" title="Send ack in manager list transaction.">astman_send_listack</a>(s, m, <span class="stringliteral">&quot;Registrations will follow&quot;</span>, <span class="stringliteral">&quot;start&quot;</span>);
<a name="l06789"></a>06789 
<a name="l06790"></a>06790    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;registrations);
<a name="l06791"></a>06791    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;registrations, reg, entry) {
<a name="l06792"></a>06792       snprintf(host, <span class="keyword">sizeof</span>(host), <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port));
<a name="l06793"></a>06793       
<a name="l06794"></a>06794       <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr.s_addr) {
<a name="l06795"></a>06795          snprintf(perceived, <span class="keyword">sizeof</span>(perceived), <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr), ntohs(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_port));
<a name="l06796"></a>06796       } <span class="keywordflow">else</span> {
<a name="l06797"></a>06797          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(perceived, <span class="stringliteral">&quot;&lt;Unregistered&gt;&quot;</span>, <span class="keyword">sizeof</span>(perceived));
<a name="l06798"></a>06798       }
<a name="l06799"></a>06799       
<a name="l06800"></a>06800       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l06801"></a>06801          <span class="stringliteral">&quot;Event: RegistryEntry\r\n&quot;</span>
<a name="l06802"></a>06802          <span class="stringliteral">&quot;Host: %s\r\n&quot;</span>
<a name="l06803"></a>06803          <span class="stringliteral">&quot;DNSmanager: %s\r\n&quot;</span>
<a name="l06804"></a>06804          <span class="stringliteral">&quot;Username: %s\r\n&quot;</span>
<a name="l06805"></a>06805          <span class="stringliteral">&quot;Perceived: %s\r\n&quot;</span>
<a name="l06806"></a>06806          <span class="stringliteral">&quot;Refresh: %d\r\n&quot;</span>
<a name="l06807"></a>06807          <span class="stringliteral">&quot;State: %s\r\n&quot;</span>
<a name="l06808"></a>06808          <span class="stringliteral">&quot;\r\n&quot;</span>, host, (reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>) ? <span class="stringliteral">&quot;Y&quot;</span> : <span class="stringliteral">&quot;N&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, perceived, 
<a name="l06809"></a>06809          reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a>, <a class="code" href="chan__iax2_8c.html#a4c2ac3125749dac444bfa31ce63ec0cb">regstate2str</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a>));
<a name="l06810"></a>06810 
<a name="l06811"></a>06811       total++;
<a name="l06812"></a>06812    }
<a name="l06813"></a>06813    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;registrations);
<a name="l06814"></a>06814 
<a name="l06815"></a>06815    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l06816"></a>06816       <span class="stringliteral">&quot;Event: RegistrationsComplete\r\n&quot;</span>
<a name="l06817"></a>06817       <span class="stringliteral">&quot;EventList: Complete\r\n&quot;</span>
<a name="l06818"></a>06818       <span class="stringliteral">&quot;ListItems: %d\r\n&quot;</span>
<a name="l06819"></a>06819       <span class="stringliteral">&quot;%s&quot;</span>
<a name="l06820"></a>06820       <span class="stringliteral">&quot;\r\n&quot;</span>, total, idtext);
<a name="l06821"></a>06821    
<a name="l06822"></a>06822    <span class="keywordflow">return</span> 0;
<a name="l06823"></a>06823 }
<a name="l06824"></a>06824 
<a name="l06825"></a><a class="code" href="chan__iax2_8c.html#a68c1693aae3f48bf874584ca36db89c4">06825</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a68c1693aae3f48bf874584ca36db89c4">handle_cli_iax2_show_channels</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06826"></a>06826 {
<a name="l06827"></a>06827 <span class="preprocessor">#define FORMAT2 &quot;%-20.20s  %-15.15s  %-10.10s  %-11.11s  %-11.11s  %-7.7s  %-6.6s  %-6.6s  %s  %s  %9s\n&quot;</span>
<a name="l06828"></a>06828 <span class="preprocessor"></span><span class="preprocessor">#define FORMAT  &quot;%-20.20s  %-15.15s  %-10.10s  %5.5d/%5.5d  %5.5d/%5.5d  %-5.5dms  %-4.4dms  %-4.4dms  %-6.6s  %s%s  %3s%s\n&quot;</span>
<a name="l06829"></a>06829 <span class="preprocessor"></span><span class="preprocessor">#define FORMATB &quot;%-20.20s  %-15.15s  %-10.10s  %5.5d/%5.5d  %5.5d/%5.5d  [Native Bridged to ID=%5.5d]\n&quot;</span>
<a name="l06830"></a>06830 <span class="preprocessor"></span>   <span class="keywordtype">int</span> x;
<a name="l06831"></a>06831    <span class="keywordtype">int</span> numchans = 0;
<a name="l06832"></a>06832    <span class="keywordtype">char</span> first_message[10] = { 0, };
<a name="l06833"></a>06833    <span class="keywordtype">char</span> last_message[10] = { 0, };
<a name="l06834"></a>06834 
<a name="l06835"></a>06835    <span class="keywordflow">switch</span> (cmd) {
<a name="l06836"></a>06836    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06837"></a>06837       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show channels&quot;</span>;
<a name="l06838"></a>06838       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06839"></a>06839          <span class="stringliteral">&quot;Usage: iax2 show channels\n&quot;</span>
<a name="l06840"></a>06840          <span class="stringliteral">&quot;       Lists all currently active IAX channels.\n&quot;</span>;
<a name="l06841"></a>06841       <span class="keywordflow">return</span> NULL;
<a name="l06842"></a>06842    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06843"></a>06843       <span class="keywordflow">return</span> NULL;
<a name="l06844"></a>06844    }
<a name="l06845"></a>06845 
<a name="l06846"></a>06846    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l06847"></a>06847       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06848"></a>06848    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#acfd58ce0ec836919236d7a1908494970">FORMAT2</a>, <span class="stringliteral">&quot;Channel&quot;</span>, <span class="stringliteral">&quot;Peer&quot;</span>, <span class="stringliteral">&quot;Username&quot;</span>, <span class="stringliteral">&quot;ID (Lo/Rem)&quot;</span>, <span class="stringliteral">&quot;Seq (Tx/Rx)&quot;</span>, <span class="stringliteral">&quot;Lag&quot;</span>, <span class="stringliteral">&quot;Jitter&quot;</span>, <span class="stringliteral">&quot;JitBuf&quot;</span>, <span class="stringliteral">&quot;Format&quot;</span>, <span class="stringliteral">&quot;FirstMsg&quot;</span>, <span class="stringliteral">&quot;LastMsg&quot;</span>);
<a name="l06849"></a>06849    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>); x++) {
<a name="l06850"></a>06850       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l06851"></a>06851       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l06852"></a>06852          <span class="keywordtype">int</span> lag, jitter, localdelay;
<a name="l06853"></a>06853          <a class="code" href="structjb__info.html">jb_info</a> jbinfo;
<a name="l06854"></a>06854          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>)) {
<a name="l06855"></a>06855             <a class="code" href="jitterbuf_8h.html#aed5937e57dcecf58443eb130f9f02d31" title="get jitterbuf info: only &amp;quot;statistics&amp;quot; may be valid">jb_getinfo</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;jb, &amp;jbinfo);
<a name="l06856"></a>06856             jitter = jbinfo.<a class="code" href="structjb__info.html#af22a222c07f645ad8b7eab0d4e7c4e9d">jitter</a>;
<a name="l06857"></a>06857             localdelay = jbinfo.<a class="code" href="structjb__info.html#a67fec00dfad51ea05ccda5e0141a5169">current</a> - jbinfo.<a class="code" href="structjb__info.html#a619cfe5e6bc1ed5a8c4d5601f9e159df">min</a>;
<a name="l06858"></a>06858          } <span class="keywordflow">else</span> {
<a name="l06859"></a>06859             jitter = -1;
<a name="l06860"></a>06860             localdelay = 0;
<a name="l06861"></a>06861          }
<a name="l06862"></a>06862 
<a name="l06863"></a>06863          <a class="code" href="iax2-parser_8c.html#a28158f904f6769628409254d45a266a1">iax_frame_subclass2str</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;first_iax_message &amp; ~<a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>, first_message, <span class="keyword">sizeof</span>(first_message));
<a name="l06864"></a>06864          <a class="code" href="iax2-parser_8c.html#a28158f904f6769628409254d45a266a1">iax_frame_subclass2str</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;last_iax_message &amp; ~<a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>, last_message, <span class="keyword">sizeof</span>(last_message));
<a name="l06865"></a>06865          lag = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.delay;
<a name="l06866"></a>06866          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>,
<a name="l06867"></a>06867             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> ? <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name : <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l06868"></a>06868             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr),
<a name="l06869"></a>06869             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;username, <span class="stringliteral">&quot;(None)&quot;</span>),
<a name="l06870"></a>06870             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;peercallno,
<a name="l06871"></a>06871             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;oseqno, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;iseqno,
<a name="l06872"></a>06872             lag,
<a name="l06873"></a>06873             jitter,
<a name="l06874"></a>06874             localdelay,
<a name="l06875"></a>06875             <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;voiceformat),
<a name="l06876"></a>06876             (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;first_iax_message &amp; <a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>) ? <span class="stringliteral">&quot;Tx:&quot;</span> : <span class="stringliteral">&quot;Rx:&quot;</span>,
<a name="l06877"></a>06877             first_message,
<a name="l06878"></a>06878             (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;last_iax_message &amp; MARK_IAX_SUBCLASS_TX) ? <span class="stringliteral">&quot;Tx:&quot;</span> : <span class="stringliteral">&quot;Rx:&quot;</span>,
<a name="l06879"></a>06879             last_message);
<a name="l06880"></a>06880          numchans++;
<a name="l06881"></a>06881       }
<a name="l06882"></a>06882       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l06883"></a>06883    }
<a name="l06884"></a>06884    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d active IAX channel%s\n&quot;</span>, numchans, (numchans != 1) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l06885"></a>06885    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06886"></a>06886 <span class="preprocessor">#undef FORMAT</span>
<a name="l06887"></a>06887 <span class="preprocessor"></span><span class="preprocessor">#undef FORMAT2</span>
<a name="l06888"></a>06888 <span class="preprocessor"></span><span class="preprocessor">#undef FORMATB</span>
<a name="l06889"></a>06889 <span class="preprocessor"></span>}
<a name="l06890"></a>06890 
<a name="l06891"></a><a class="code" href="chan__iax2_8c.html#aa97568aae0bbccb48217b5bd8e96bf3a">06891</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa97568aae0bbccb48217b5bd8e96bf3a">ast_cli_netstats</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> fd, <span class="keywordtype">int</span> limit_fmt)
<a name="l06892"></a>06892 {
<a name="l06893"></a>06893    <span class="keywordtype">int</span> x;
<a name="l06894"></a>06894    <span class="keywordtype">int</span> numchans = 0;
<a name="l06895"></a>06895    <span class="keywordtype">char</span> first_message[10] = { 0, };
<a name="l06896"></a>06896    <span class="keywordtype">char</span> last_message[10] = { 0, };
<a name="l06897"></a>06897 <span class="preprocessor">#define ACN_FORMAT1 &quot;%-20.25s %4d %4d %4d %5d %3d %5d %4d %6d %4d %4d %5d %3d %5d %4d %6d %s%s %4s%s\n&quot;</span>
<a name="l06898"></a>06898 <span class="preprocessor"></span><span class="preprocessor">#define ACN_FORMAT2 &quot;%s %d %d %d %d %d %d %d %d %d %d %d %d %d %d %d %s%s %s%s\n&quot;</span>
<a name="l06899"></a>06899 <span class="preprocessor"></span>   <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>); x++) {
<a name="l06900"></a>06900       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l06901"></a>06901       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l06902"></a>06902          <span class="keywordtype">int</span> localjitter, localdelay, locallost, locallosspct, localdropped, localooo;
<a name="l06903"></a>06903          <a class="code" href="structjb__info.html">jb_info</a> jbinfo;
<a name="l06904"></a>06904          <a class="code" href="iax2-parser_8c.html#a28158f904f6769628409254d45a266a1">iax_frame_subclass2str</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;first_iax_message &amp; ~<a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>, first_message, <span class="keyword">sizeof</span>(first_message));
<a name="l06905"></a>06905          <a class="code" href="iax2-parser_8c.html#a28158f904f6769628409254d45a266a1">iax_frame_subclass2str</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;last_iax_message &amp; ~<a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>, last_message, <span class="keyword">sizeof</span>(last_message));
<a name="l06906"></a>06906 
<a name="l06907"></a>06907          <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>)) {
<a name="l06908"></a>06908             <a class="code" href="jitterbuf_8h.html#aed5937e57dcecf58443eb130f9f02d31" title="get jitterbuf info: only &amp;quot;statistics&amp;quot; may be valid">jb_getinfo</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;jb, &amp;jbinfo);
<a name="l06909"></a>06909             localjitter = jbinfo.<a class="code" href="structjb__info.html#af22a222c07f645ad8b7eab0d4e7c4e9d">jitter</a>;
<a name="l06910"></a>06910             localdelay = jbinfo.<a class="code" href="structjb__info.html#a67fec00dfad51ea05ccda5e0141a5169">current</a> - jbinfo.<a class="code" href="structjb__info.html#a619cfe5e6bc1ed5a8c4d5601f9e159df">min</a>;
<a name="l06911"></a>06911             locallost = jbinfo.<a class="code" href="structjb__info.html#aad59f039b77a1f7998a401966b6ec58d">frames_lost</a>;
<a name="l06912"></a>06912             locallosspct = jbinfo.<a class="code" href="structjb__info.html#a6dfda2a3ff35f2859488b5639d88715e">losspct</a>/1000;
<a name="l06913"></a>06913             localdropped = jbinfo.<a class="code" href="structjb__info.html#ad46c17494e36cde0dda69873d2246614">frames_dropped</a>;
<a name="l06914"></a>06914             localooo = jbinfo.<a class="code" href="structjb__info.html#ac437d83ff5b3b72934f71acb20f608ca">frames_ooo</a>;
<a name="l06915"></a>06915          } <span class="keywordflow">else</span> {
<a name="l06916"></a>06916             localjitter = -1;
<a name="l06917"></a>06917             localdelay = 0;
<a name="l06918"></a>06918             locallost = -1;
<a name="l06919"></a>06919             locallosspct = -1;
<a name="l06920"></a>06920             localdropped = 0;
<a name="l06921"></a>06921             localooo = -1;
<a name="l06922"></a>06922          }
<a name="l06923"></a>06923          <span class="keywordflow">if</span> (s)
<a name="l06924"></a>06924             <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, limit_fmt ? <a class="code" href="chan__iax2_8c.html#aa18266ac998f0a69590360819aba583c">ACN_FORMAT1</a> : <a class="code" href="chan__iax2_8c.html#a5bfec9f4076cf28b766fb4adfe809463">ACN_FORMAT2</a>,
<a name="l06925"></a>06925                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;owner ? <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;owner-&gt;name : <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l06926"></a>06926                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a>,
<a name="l06927"></a>06927                localjitter,
<a name="l06928"></a>06928                localdelay,
<a name="l06929"></a>06929                locallost,
<a name="l06930"></a>06930                locallosspct,
<a name="l06931"></a>06931                localdropped,
<a name="l06932"></a>06932                localooo,
<a name="l06933"></a>06933                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;frames_received/1000,
<a name="l06934"></a>06934                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.jitter,
<a name="l06935"></a>06935                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.delay,
<a name="l06936"></a>06936                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.losscnt,
<a name="l06937"></a>06937                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.losspct,
<a name="l06938"></a>06938                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.dropped,
<a name="l06939"></a>06939                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.ooo,
<a name="l06940"></a>06940                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.packets/1000,
<a name="l06941"></a>06941                (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">first_iax_message</a> &amp; <a class="code" href="chan__iax2_8c.html#a50e3ac05112300e82632cef6d50200a6">MARK_IAX_SUBCLASS_TX</a>) ? <span class="stringliteral">&quot;Tx:&quot;</span> : <span class="stringliteral">&quot;Rx:&quot;</span>,
<a name="l06942"></a>06942                first_message,
<a name="l06943"></a>06943                (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad236fe8543f05839d5978753bd7068a3">last_iax_message</a> &amp; MARK_IAX_SUBCLASS_TX) ? <span class="stringliteral">&quot;Tx:&quot;</span> : <span class="stringliteral">&quot;Rx:&quot;</span>,
<a name="l06944"></a>06944                last_message);
<a name="l06945"></a>06945          <span class="keywordflow">else</span>
<a name="l06946"></a>06946             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, limit_fmt ? <a class="code" href="chan__iax2_8c.html#aa18266ac998f0a69590360819aba583c">ACN_FORMAT1</a> : ACN_FORMAT2,
<a name="l06947"></a>06947                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;owner ? <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;owner-&gt;name : <span class="stringliteral">&quot;(None)&quot;</span>,
<a name="l06948"></a>06948                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a>,
<a name="l06949"></a>06949                localjitter,
<a name="l06950"></a>06950                localdelay,
<a name="l06951"></a>06951                locallost,
<a name="l06952"></a>06952                locallosspct,
<a name="l06953"></a>06953                localdropped,
<a name="l06954"></a>06954                localooo,
<a name="l06955"></a>06955                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;frames_received/1000,
<a name="l06956"></a>06956                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.jitter,
<a name="l06957"></a>06957                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.delay,
<a name="l06958"></a>06958                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.losscnt,
<a name="l06959"></a>06959                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.losspct,
<a name="l06960"></a>06960                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.dropped,
<a name="l06961"></a>06961                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.ooo,
<a name="l06962"></a>06962                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;remote_rr.packets/1000,
<a name="l06963"></a>06963                (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">first_iax_message</a> &amp; MARK_IAX_SUBCLASS_TX) ? <span class="stringliteral">&quot;Tx:&quot;</span> : <span class="stringliteral">&quot;Rx:&quot;</span>,
<a name="l06964"></a>06964                first_message,
<a name="l06965"></a>06965                (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad236fe8543f05839d5978753bd7068a3">last_iax_message</a> &amp; MARK_IAX_SUBCLASS_TX) ? <span class="stringliteral">&quot;Tx:&quot;</span> : <span class="stringliteral">&quot;Rx:&quot;</span>,
<a name="l06966"></a>06966                last_message);
<a name="l06967"></a>06967          numchans++;
<a name="l06968"></a>06968       }
<a name="l06969"></a>06969       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l06970"></a>06970    }
<a name="l06971"></a>06971 
<a name="l06972"></a>06972    <span class="keywordflow">return</span> numchans;
<a name="l06973"></a>06973 }
<a name="l06974"></a>06974 
<a name="l06975"></a><a class="code" href="chan__iax2_8c.html#a9eb2265a744bce420184954f86ba3fdc">06975</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a9eb2265a744bce420184954f86ba3fdc">handle_cli_iax2_show_netstats</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06976"></a>06976 {
<a name="l06977"></a>06977    <span class="keywordtype">int</span> numchans = 0;
<a name="l06978"></a>06978 
<a name="l06979"></a>06979    <span class="keywordflow">switch</span> (cmd) {
<a name="l06980"></a>06980    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l06981"></a>06981       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 show netstats&quot;</span>;
<a name="l06982"></a>06982       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l06983"></a>06983          <span class="stringliteral">&quot;Usage: iax2 show netstats\n&quot;</span>
<a name="l06984"></a>06984          <span class="stringliteral">&quot;       Lists network status for all currently active IAX channels.\n&quot;</span>;
<a name="l06985"></a>06985       <span class="keywordflow">return</span> NULL;
<a name="l06986"></a>06986    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l06987"></a>06987       <span class="keywordflow">return</span> NULL;
<a name="l06988"></a>06988    }
<a name="l06989"></a>06989    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l06990"></a>06990       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l06991"></a>06991    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;                           -------- LOCAL ---------------------  -------- REMOTE --------------------\n&quot;</span>);
<a name="l06992"></a>06992    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Channel               RTT  Jit  Del  Lost   %%  Drop  OOO  Kpkts  Jit  Del  Lost   %%  Drop  OOO  Kpkts FirstMsg    LastMsg\n&quot;</span>);
<a name="l06993"></a>06993    numchans = <a class="code" href="chan__iax2_8c.html#aa97568aae0bbccb48217b5bd8e96bf3a">ast_cli_netstats</a>(NULL, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, 1);
<a name="l06994"></a>06994    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d active IAX channel%s\n&quot;</span>, numchans, (numchans != 1) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l06995"></a>06995    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l06996"></a>06996 }
<a name="l06997"></a>06997 
<a name="l06998"></a><a class="code" href="chan__iax2_8c.html#a2e52a0e0ea3114f71e2408fc3c6084db">06998</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a2e52a0e0ea3114f71e2408fc3c6084db">handle_cli_iax2_set_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l06999"></a>06999 {
<a name="l07000"></a>07000    <span class="keywordflow">switch</span> (cmd) {
<a name="l07001"></a>07001    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l07002"></a>07002       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 set debug {on|off|peer}&quot;</span>;
<a name="l07003"></a>07003       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l07004"></a>07004          <span class="stringliteral">&quot;Usage: iax2 set debug {on|off|peer peername}\n&quot;</span>
<a name="l07005"></a>07005          <span class="stringliteral">&quot;       Enables/Disables dumping of IAX packets for debugging purposes.\n&quot;</span>;
<a name="l07006"></a>07006       <span class="keywordflow">return</span> NULL;
<a name="l07007"></a>07007    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l07008"></a>07008       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 4 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;peer&quot;</span>))
<a name="l07009"></a>07009          <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a4c1705908c9696e6bd564ca8bd297a4d">complete_iax2_peers</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>, 0);
<a name="l07010"></a>07010       <span class="keywordflow">return</span> NULL;
<a name="l07011"></a>07011    }
<a name="l07012"></a>07012 
<a name="l07013"></a>07013    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>  || a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l07014"></a>07014       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07015"></a>07015 
<a name="l07016"></a>07016    <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;peer&quot;</span>)) {
<a name="l07017"></a>07017       <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l07018"></a>07018 
<a name="l07019"></a>07019       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> + 1)
<a name="l07020"></a>07020          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07021"></a>07021 
<a name="l07022"></a>07022       peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], 1);
<a name="l07023"></a>07023 
<a name="l07024"></a>07024       <span class="keywordflow">if</span> (!peer) {
<a name="l07025"></a>07025          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 peer &apos;%s&apos; does not exist\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1]);
<a name="l07026"></a>07026          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l07027"></a>07027       }
<a name="l07028"></a>07028 
<a name="l07029"></a>07029       <a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_addr = peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr;
<a name="l07030"></a>07030       <a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_port = peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port;
<a name="l07031"></a>07031 
<a name="l07032"></a>07032       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Debugging Enabled for IP: %s:%d\n&quot;</span>,
<a name="l07033"></a>07033          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_addr), ntohs(<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>.sin_port));
<a name="l07034"></a>07034 
<a name="l07035"></a>07035       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peer, -1);
<a name="l07036"></a>07036    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l07037"></a>07037       iaxdebug = 1;
<a name="l07038"></a>07038       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Debugging Enabled\n&quot;</span>);
<a name="l07039"></a>07039    } <span class="keywordflow">else</span> {
<a name="l07040"></a>07040       iaxdebug = 0;
<a name="l07041"></a>07041       memset(&amp;<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>));
<a name="l07042"></a>07042       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Debugging Disabled\n&quot;</span>);
<a name="l07043"></a>07043    }
<a name="l07044"></a>07044    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07045"></a>07045 }
<a name="l07046"></a>07046 
<a name="l07047"></a><a class="code" href="chan__iax2_8c.html#a0c477468f7f3577ccebd391a62b1816c">07047</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a0c477468f7f3577ccebd391a62b1816c">handle_cli_iax2_set_debug_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l07048"></a>07048 {
<a name="l07049"></a>07049    <span class="keywordflow">switch</span> (cmd) {
<a name="l07050"></a>07050    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l07051"></a>07051       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 set debug trunk {on|off}&quot;</span>;
<a name="l07052"></a>07052       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l07053"></a>07053          <span class="stringliteral">&quot;Usage: iax2 set debug trunk {on|off}\n&quot;</span>
<a name="l07054"></a>07054          <span class="stringliteral">&quot;       Enables/Disables debugging of IAX trunking\n&quot;</span>;
<a name="l07055"></a>07055       <span class="keywordflow">return</span> NULL;
<a name="l07056"></a>07056    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l07057"></a>07057       <span class="keywordflow">return</span> NULL;
<a name="l07058"></a>07058    }
<a name="l07059"></a>07059 
<a name="l07060"></a>07060    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l07061"></a>07061       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07062"></a>07062 
<a name="l07063"></a>07063    <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l07064"></a>07064       iaxtrunkdebug = 1;
<a name="l07065"></a>07065       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Trunk Debugging Enabled\n&quot;</span>);
<a name="l07066"></a>07066    } <span class="keywordflow">else</span> {
<a name="l07067"></a>07067       iaxtrunkdebug = 0;
<a name="l07068"></a>07068       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Trunk Debugging Disabled\n&quot;</span>);
<a name="l07069"></a>07069    }
<a name="l07070"></a>07070    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07071"></a>07071 }
<a name="l07072"></a>07072 
<a name="l07073"></a><a class="code" href="chan__iax2_8c.html#a76e93829bebf411da745d683a63e02c6">07073</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a76e93829bebf411da745d683a63e02c6">handle_cli_iax2_set_debug_jb</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l07074"></a>07074 {
<a name="l07075"></a>07075    <span class="keywordflow">switch</span> (cmd) {
<a name="l07076"></a>07076    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l07077"></a>07077       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 set debug jb {on|off}&quot;</span>;
<a name="l07078"></a>07078       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l07079"></a>07079          <span class="stringliteral">&quot;Usage: iax2 set debug jb {on|off}\n&quot;</span>
<a name="l07080"></a>07080          <span class="stringliteral">&quot;       Enables/Disables jitterbuffer debugging information\n&quot;</span>;
<a name="l07081"></a>07081       <span class="keywordflow">return</span> NULL;
<a name="l07082"></a>07082    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l07083"></a>07083       <span class="keywordflow">return</span> NULL;
<a name="l07084"></a>07084    }
<a name="l07085"></a>07085 
<a name="l07086"></a>07086    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l07087"></a>07087       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l07088"></a>07088    
<a name="l07089"></a>07089    <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> -1], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l07090"></a>07090       <a class="code" href="jitterbuf_8h.html#a5198ca5f2885b8b4a2579ba58e6f196f">jb_setoutput</a>(<a class="code" href="chan__iax2_8c.html#a151931af9817e64f2785ab62a97fee11">jb_error_output</a>, <a class="code" href="chan__iax2_8c.html#ab56f48224a51b039df6eee8168cc6e96">jb_warning_output</a>, <a class="code" href="chan__iax2_8c.html#a40ecc93fa72cd6980c5ea3cba315d11d">jb_debug_output</a>);
<a name="l07091"></a>07091       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Jitterbuffer Debugging Enabled\n&quot;</span>);
<a name="l07092"></a>07092    } <span class="keywordflow">else</span> {
<a name="l07093"></a>07093       <a class="code" href="jitterbuf_8h.html#a5198ca5f2885b8b4a2579ba58e6f196f">jb_setoutput</a>(<a class="code" href="chan__iax2_8c.html#a151931af9817e64f2785ab62a97fee11">jb_error_output</a>, <a class="code" href="chan__iax2_8c.html#ab56f48224a51b039df6eee8168cc6e96">jb_warning_output</a>, NULL);
<a name="l07094"></a>07094       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;IAX2 Jitterbuffer Debugging Disabled\n&quot;</span>);
<a name="l07095"></a>07095    }
<a name="l07096"></a>07096    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l07097"></a>07097 }
<a name="l07098"></a>07098 
<a name="l07099"></a><a class="code" href="chan__iax2_8c.html#a07ac61089c4cf36df9f6cfed49197b2a">07099</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a07ac61089c4cf36df9f6cfed49197b2a">iax2_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l07100"></a>07100 {
<a name="l07101"></a>07101    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(c-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l07102"></a>07102    <span class="keywordtype">int</span> res = -1;
<a name="l07103"></a>07103    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07104"></a>07104    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l07105"></a>07105    <span class="comment">/* If there&apos;s an outstanding error, return failure now */</span>
<a name="l07106"></a>07106       <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;error) {
<a name="l07107"></a>07107          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>))
<a name="l07108"></a>07108             res = 0;
<a name="l07109"></a>07109             <span class="comment">/* Don&apos;t waste bandwidth sending null frames */</span>
<a name="l07110"></a>07110          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a29ff71f9d5c7927906ebd437fe372056">AST_FRAME_NULL</a>)
<a name="l07111"></a>07111             res = 0;
<a name="l07112"></a>07112          <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba5c0041238c2195bc988f0b77ce0972d6">IAX_QUELCH</a>))
<a name="l07113"></a>07113             res = 0;
<a name="l07114"></a>07114          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>))
<a name="l07115"></a>07115             res = 0;
<a name="l07116"></a>07116          <span class="keywordflow">else</span>
<a name="l07117"></a>07117          <span class="comment">/* Simple, just queue for transmission */</span>
<a name="l07118"></a>07118             res = <a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">iax2_send</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], f, 0, -1, 0, 0, 0);
<a name="l07119"></a>07119       } <span class="keywordflow">else</span> {
<a name="l07120"></a>07120          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Write error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l07121"></a>07121       }
<a name="l07122"></a>07122    }
<a name="l07123"></a>07123    <span class="comment">/* If it&apos;s already gone, just return */</span>
<a name="l07124"></a>07124    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07125"></a>07125    <span class="keywordflow">return</span> res;
<a name="l07126"></a>07126 }
<a name="l07127"></a>07127 
<a name="l07128"></a><a class="code" href="chan__iax2_8c.html#a5091e5547aded7e1da37cd7822a355b3">07128</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5091e5547aded7e1da37cd7822a355b3">__send_command</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *i, <span class="keywordtype">char</span> type, <span class="keywordtype">int</span> command, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> datalen, <span class="keywordtype">int</span> seqno, 
<a name="l07129"></a>07129       <span class="keywordtype">int</span> now, <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>, <span class="keywordtype">int</span> <span class="keyword">final</span>)
<a name="l07130"></a>07130 {
<a name="l07131"></a>07131    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { 0, };
<a name="l07132"></a>07132    <span class="keywordtype">int</span> res = 0;
<a name="l07133"></a>07133 
<a name="l07134"></a>07134    f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = type;
<a name="l07135"></a>07135    f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = command;
<a name="l07136"></a>07136    f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = datalen;
<a name="l07137"></a>07137    f.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = __FUNCTION__;
<a name="l07138"></a>07138    f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = (<span class="keywordtype">void</span> *) data;
<a name="l07139"></a>07139 
<a name="l07140"></a>07140    <span class="keywordflow">if</span> ((res = <a class="code" href="chan__iax2_8c.html#a21b1f671722ff23a8c61511b42ccd34f" title="All frames other than that of type AST_FRAME_IAX must be held until we have received...">queue_signalling</a>(i, &amp;f)) &lt;= 0) {
<a name="l07141"></a>07141       <span class="keywordflow">return</span> res;
<a name="l07142"></a>07142    }
<a name="l07143"></a>07143 
<a name="l07144"></a>07144    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">iax2_send</a>(i, &amp;f, ts, seqno, now, transfer, <span class="keyword">final</span>);
<a name="l07145"></a>07145 }
<a name="l07146"></a>07146 
<a name="l07147"></a><a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">07147</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *i, <span class="keywordtype">char</span> type, <span class="keywordtype">int</span> command, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ab793262012344621455faf9266acbac2">seqno</a>)
<a name="l07148"></a>07148 {
<a name="l07149"></a>07149    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a5091e5547aded7e1da37cd7822a355b3">__send_command</a>(i, type, command, ts, data, datalen, seqno, 0, 0, 0);
<a name="l07150"></a>07150 }
<a name="l07151"></a>07151 
<a name="l07152"></a><a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">07152</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afe3b8b2f5ed663441fb3e4b4099942f1">send_command_locked</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno, <span class="keywordtype">char</span> type, <span class="keywordtype">int</span> command, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ab793262012344621455faf9266acbac2">seqno</a>)
<a name="l07153"></a>07153 {
<a name="l07154"></a>07154    <span class="keywordtype">int</span> res;
<a name="l07155"></a>07155    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07156"></a>07156    res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], type, command, ts, data, datalen, seqno);
<a name="l07157"></a>07157    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07158"></a>07158    <span class="keywordflow">return</span> res;
<a name="l07159"></a>07159 }
<a name="l07160"></a>07160 <span class="comment"></span>
<a name="l07161"></a>07161 <span class="comment">/*!</span>
<a name="l07162"></a>07162 <span class="comment"> * \note Since this function calls iax2_predestroy() -&gt; iax2_queue_hangup(),</span>
<a name="l07163"></a>07163 <span class="comment"> *       the pvt struct for the given call number may disappear during its </span>
<a name="l07164"></a>07164 <span class="comment"> *       execution.</span>
<a name="l07165"></a>07165 <span class="comment"> */</span>
<a name="l07166"></a><a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">07166</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *i, <span class="keywordtype">char</span> type, <span class="keywordtype">int</span> command, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ab793262012344621455faf9266acbac2">seqno</a>)
<a name="l07167"></a>07167 {
<a name="l07168"></a>07168    <span class="keywordtype">int</span> call_num = i-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l07169"></a>07169    <span class="comment">/* It is assumed that the callno has already been locked */</span>
<a name="l07170"></a>07170    <a class="code" href="chan__iax2_8c.html#a1b9c028e733553f16df68c8af049357a">iax2_predestroy</a>(i-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l07171"></a>07171    <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[call_num])
<a name="l07172"></a>07172       <span class="keywordflow">return</span> -1;
<a name="l07173"></a>07173    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a5091e5547aded7e1da37cd7822a355b3">__send_command</a>(i, type, command, ts, data, datalen, seqno, 0, 0, 1);
<a name="l07174"></a>07174 }
<a name="l07175"></a>07175 
<a name="l07176"></a><a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">07176</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *i, <span class="keywordtype">char</span> type, <span class="keywordtype">int</span> command, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ab793262012344621455faf9266acbac2">seqno</a>)
<a name="l07177"></a>07177 {
<a name="l07178"></a>07178    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a5091e5547aded7e1da37cd7822a355b3">__send_command</a>(i, type, command, ts, data, datalen, seqno, 1, 0, 0);
<a name="l07179"></a>07179 }
<a name="l07180"></a>07180 
<a name="l07181"></a><a class="code" href="chan__iax2_8c.html#a1ff700fbef2b011689770294a3f1bec9">07181</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a1ff700fbef2b011689770294a3f1bec9">send_command_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *i, <span class="keywordtype">char</span> type, <span class="keywordtype">int</span> command, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l07182"></a>07182 {
<a name="l07183"></a>07183    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a5091e5547aded7e1da37cd7822a355b3">__send_command</a>(i, type, command, ts, data, datalen, 0, 0, 1, 0);
<a name="l07184"></a>07184 }
<a name="l07185"></a>07185 
<a name="l07186"></a><a class="code" href="chan__iax2_8c.html#a0a986795c773063ee8a070febf2616f4">07186</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0a986795c773063ee8a070febf2616f4">apply_context</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__context.html">iax2_context</a> *con, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)
<a name="l07187"></a>07187 {
<a name="l07188"></a>07188    <span class="keywordflow">while</span>(con) {
<a name="l07189"></a>07189       <span class="keywordflow">if</span> (!strcmp(con-&gt;<a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context) || !strcmp(con-&gt;<a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;*&quot;</span>))
<a name="l07190"></a>07190          <span class="keywordflow">return</span> -1;
<a name="l07191"></a>07191       con = con-&gt;<a class="code" href="structiax2__context.html#adda68386bebcd983920d3f129230f277">next</a>;
<a name="l07192"></a>07192    }
<a name="l07193"></a>07193    <span class="keywordflow">return</span> 0;
<a name="l07194"></a>07194 }
<a name="l07195"></a>07195 
<a name="l07196"></a>07196 
<a name="l07197"></a><a class="code" href="chan__iax2_8c.html#a61046b083970a3afb9320d675cd3fee9">07197</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a61046b083970a3afb9320d675cd3fee9">check_access</a>(<span class="keywordtype">int</span> callno, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies)
<a name="l07198"></a>07198 {
<a name="l07199"></a>07199    <span class="comment">/* Start pessimistic */</span>
<a name="l07200"></a>07200    <span class="keywordtype">int</span> res = -1;
<a name="l07201"></a>07201    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> = 2;
<a name="l07202"></a>07202    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL, *best = NULL;
<a name="l07203"></a>07203    <span class="keywordtype">int</span> bestscore = 0;
<a name="l07204"></a>07204    <span class="keywordtype">int</span> gotcapability = 0;
<a name="l07205"></a>07205    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v = NULL, *tmpvar = NULL;
<a name="l07206"></a>07206    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l07207"></a>07207 
<a name="l07208"></a>07208    <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])
<a name="l07209"></a>07209       <span class="keywordflow">return</span> res;
<a name="l07210"></a>07210    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>)
<a name="l07211"></a>07211       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, ies-&gt;<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>);
<a name="l07212"></a>07212    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a503b1570b953edc1cbff315709acf943">calling_number</a>) {
<a name="l07213"></a>07213       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae22e2b945ef6ffda9b550fbb2a6787ce">IAX_SHRINKCALLERID</a>)) { 
<a name="l07214"></a>07214          <a class="code" href="callerid_8h.html#a6a61669b28d0f994e44db5e3baab6ef2" title="Shrink a phone number in place to just digits (more accurately it just removes ()&amp;#39;s...">ast_shrink_phone_number</a>(ies-&gt;<a class="code" href="structiax__ies.html#a503b1570b953edc1cbff315709acf943">calling_number</a>);
<a name="l07215"></a>07215       }
<a name="l07216"></a>07216       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, ies-&gt;<a class="code" href="structiax__ies.html#a503b1570b953edc1cbff315709acf943">calling_number</a>);
<a name="l07217"></a>07217    }
<a name="l07218"></a>07218    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a38b197bb85bb9735b9ff9bed4bf196db">calling_name</a>)
<a name="l07219"></a>07219       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, ies-&gt;<a class="code" href="structiax__ies.html#a38b197bb85bb9735b9ff9bed4bf196db">calling_name</a>);
<a name="l07220"></a>07220    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a5350a6c582e732ca4bc0dedf3def8c26">calling_ani</a>)
<a name="l07221"></a>07221       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], ani, ies-&gt;<a class="code" href="structiax__ies.html#a5350a6c582e732ca4bc0dedf3def8c26">calling_ani</a>);
<a name="l07222"></a>07222    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a2a6880647fbfdf5fc8a74248d645589c">dnid</a>)
<a name="l07223"></a>07223       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], dnid, ies-&gt;<a class="code" href="structiax__ies.html#a2a6880647fbfdf5fc8a74248d645589c">dnid</a>);
<a name="l07224"></a>07224    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#ae161ae5c75aa3dced11bcb9d2c7db674">rdnis</a>)
<a name="l07225"></a>07225       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], rdnis, ies-&gt;<a class="code" href="structiax__ies.html#ae161ae5c75aa3dced11bcb9d2c7db674">rdnis</a>);
<a name="l07226"></a>07226    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a3da3c62d7c7467fda1c782c92a44987c">called_context</a>)
<a name="l07227"></a>07227       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ies-&gt;<a class="code" href="structiax__ies.html#a3da3c62d7c7467fda1c782c92a44987c">called_context</a>);
<a name="l07228"></a>07228    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a8ae4b47621b125e915cee8ccdaa2095c">language</a>)
<a name="l07229"></a>07229       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], language, ies-&gt;<a class="code" href="structiax__ies.html#a8ae4b47621b125e915cee8ccdaa2095c">language</a>);
<a name="l07230"></a>07230    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l07231"></a>07231       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], username, ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>);
<a name="l07232"></a>07232    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a57eabf92fe7c9f440fe38fb529c57f91">calling_ton</a> &gt; -1)
<a name="l07233"></a>07233       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a57eabf92fe7c9f440fe38fb529c57f91">calling_ton</a> = ies-&gt;<a class="code" href="structiax__ies.html#a57eabf92fe7c9f440fe38fb529c57f91">calling_ton</a>;
<a name="l07234"></a>07234    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a7ab4a847c94ceca414d76c2abe5587aa">calling_tns</a> &gt; -1)
<a name="l07235"></a>07235       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a7ab4a847c94ceca414d76c2abe5587aa">calling_tns</a> = ies-&gt;<a class="code" href="structiax__ies.html#a7ab4a847c94ceca414d76c2abe5587aa">calling_tns</a>;
<a name="l07236"></a>07236    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#aa16fb44247d3656e98d82796a24c0ec6">calling_pres</a> &gt; -1)
<a name="l07237"></a>07237       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#aa16fb44247d3656e98d82796a24c0ec6">calling_pres</a> = ies-&gt;<a class="code" href="structiax__ies.html#aa16fb44247d3656e98d82796a24c0ec6">calling_pres</a>;
<a name="l07238"></a>07238    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a6fea735e1b12f87689267ca76a7f4037">format</a>)
<a name="l07239"></a>07239       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> = ies-&gt;<a class="code" href="structiax__ies.html#a6fea735e1b12f87689267ca76a7f4037">format</a>;
<a name="l07240"></a>07240    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a07ca21361341fda1fca2d2fa67ea6bf4">adsicpe</a>)
<a name="l07241"></a>07241       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a078ad1b9bbd2dab166a844bdb0d89b5c">peeradsicpe</a> = ies-&gt;<a class="code" href="structiax__ies.html#a07ca21361341fda1fca2d2fa67ea6bf4">adsicpe</a>;
<a name="l07242"></a>07242    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#abc53d773b98b94081314ce6de8d61b04">capability</a>) {
<a name="l07243"></a>07243       gotcapability = 1;
<a name="l07244"></a>07244       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> = ies-&gt;<a class="code" href="structiax__ies.html#abc53d773b98b94081314ce6de8d61b04">capability</a>;
<a name="l07245"></a>07245    } 
<a name="l07246"></a>07246    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#aad880fc4455c253781e8968f2239d56f">version</a>)
<a name="l07247"></a>07247       version = ies-&gt;<a class="code" href="structiax__ies.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l07248"></a>07248 
<a name="l07249"></a>07249    <span class="comment">/* Use provided preferences until told otherwise for actual preferences */</span>
<a name="l07250"></a>07250    <span class="keywordflow">if</span>(ies-&gt;<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>) {
<a name="l07251"></a>07251       <a class="code" href="frame_8h.html#a42cc334b6773ff33cb3c24ca5a916842" title="Shift an audio codec preference list up or down 65 bytes so that it becomes an ASCII...">ast_codec_pref_convert</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;rprefs, ies-&gt;<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>, 32, 0);
<a name="l07252"></a>07252       <a class="code" href="frame_8h.html#a42cc334b6773ff33cb3c24ca5a916842" title="Shift an audio codec preference list up or down 65 bytes so that it becomes an ASCII...">ast_codec_pref_convert</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, ies-&gt;<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>, 32, 0);
<a name="l07253"></a>07253    }
<a name="l07254"></a>07254 
<a name="l07255"></a>07255    <span class="keywordflow">if</span> (!gotcapability) 
<a name="l07256"></a>07256       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a>;
<a name="l07257"></a>07257    <span class="keywordflow">if</span> (version &gt; <a class="code" href="iax2_8h.html#ab1d2d15fd95077bc4f93947a5e011a98">IAX_PROTO_VERSION</a>) {
<a name="l07258"></a>07258       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Peer &apos;%s&apos; has too new a protocol version (%d) for me\n&quot;</span>, 
<a name="l07259"></a>07259          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), version);
<a name="l07260"></a>07260       <span class="keywordflow">return</span> res;
<a name="l07261"></a>07261    }
<a name="l07262"></a>07262    <span class="comment">/* Search the userlist for a compatible entry, and fill in the rest */</span>
<a name="l07263"></a>07263    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(users, 0);
<a name="l07264"></a>07264    <span class="keywordflow">while</span> ((user = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l07265"></a>07265       <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username) ||          <span class="comment">/* No username specified */</span>
<a name="l07266"></a>07266          !strcmp(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username, user-&gt;name)) <span class="comment">/* Or this username specified */</span>
<a name="l07267"></a>07267          &amp;&amp; <a class="code" href="acl_8h.html#aac0540803fb28e105697e917bd0f252b" title="Check IP address with host access list.">ast_apply_ha</a>(user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>, sin)   <span class="comment">/* Access is permitted from this IP */</span>
<a name="l07268"></a>07268          &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) ||         <span class="comment">/* No context specified */</span>
<a name="l07269"></a>07269               <a class="code" href="chan__iax2_8c.html#a0a986795c773063ee8a070febf2616f4">apply_context</a>(user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;context))) {        <span class="comment">/* Context is permitted */</span>
<a name="l07270"></a>07270          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username)) {
<a name="l07271"></a>07271             <span class="comment">/* Exact match, stop right now. */</span>
<a name="l07272"></a>07272             <span class="keywordflow">if</span> (best)
<a name="l07273"></a>07273                <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(best);
<a name="l07274"></a>07274             best = user;
<a name="l07275"></a>07275             <span class="keywordflow">break</span>;
<a name="l07276"></a>07276          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;secret) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;dbsecret) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;inkeys)) {
<a name="l07277"></a>07277             <span class="comment">/* No required authentication */</span>
<a name="l07278"></a>07278             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>) {
<a name="l07279"></a>07279                <span class="comment">/* There was host authentication and we passed, bonus! */</span>
<a name="l07280"></a>07280                <span class="keywordflow">if</span> (bestscore &lt; 4) {
<a name="l07281"></a>07281                   bestscore = 4;
<a name="l07282"></a>07282                   <span class="keywordflow">if</span> (best)
<a name="l07283"></a>07283                      <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(best);
<a name="l07284"></a>07284                   best = user;
<a name="l07285"></a>07285                   <span class="keywordflow">continue</span>;
<a name="l07286"></a>07286                }
<a name="l07287"></a>07287             } <span class="keywordflow">else</span> {
<a name="l07288"></a>07288                <span class="comment">/* No host access, but no secret, either, not bad */</span>
<a name="l07289"></a>07289                <span class="keywordflow">if</span> (bestscore &lt; 3) {
<a name="l07290"></a>07290                   bestscore = 3;
<a name="l07291"></a>07291                   <span class="keywordflow">if</span> (best)
<a name="l07292"></a>07292                      <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(best);
<a name="l07293"></a>07293                   best = user;
<a name="l07294"></a>07294                   <span class="keywordflow">continue</span>;
<a name="l07295"></a>07295                }
<a name="l07296"></a>07296             }
<a name="l07297"></a>07297          } <span class="keywordflow">else</span> {
<a name="l07298"></a>07298             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>) {
<a name="l07299"></a>07299                <span class="comment">/* Authentication, but host access too, eh, it&apos;s something.. */</span>
<a name="l07300"></a>07300                <span class="keywordflow">if</span> (bestscore &lt; 2) {
<a name="l07301"></a>07301                   bestscore = 2;
<a name="l07302"></a>07302                   <span class="keywordflow">if</span> (best)
<a name="l07303"></a>07303                      <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(best);
<a name="l07304"></a>07304                   best = user;
<a name="l07305"></a>07305                   <span class="keywordflow">continue</span>;
<a name="l07306"></a>07306                }
<a name="l07307"></a>07307             } <span class="keywordflow">else</span> {
<a name="l07308"></a>07308                <span class="comment">/* Authentication and no host access...  This is our baseline */</span>
<a name="l07309"></a>07309                <span class="keywordflow">if</span> (bestscore &lt; 1) {
<a name="l07310"></a>07310                   bestscore = 1;
<a name="l07311"></a>07311                   <span class="keywordflow">if</span> (best)
<a name="l07312"></a>07312                      <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(best);
<a name="l07313"></a>07313                   best = user;
<a name="l07314"></a>07314                   <span class="keywordflow">continue</span>;
<a name="l07315"></a>07315                }
<a name="l07316"></a>07316             }
<a name="l07317"></a>07317          }
<a name="l07318"></a>07318       }
<a name="l07319"></a>07319       <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l07320"></a>07320    }
<a name="l07321"></a>07321    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l07322"></a>07322    user = best;
<a name="l07323"></a>07323    <span class="keywordflow">if</span> (!user &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username)) {
<a name="l07324"></a>07324       user = <a class="code" href="chan__iax2_8c.html#afb25e20b1fe40ed319996fdd9c289085">realtime_user</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username, sin);
<a name="l07325"></a>07325       <span class="keywordflow">if</span> (user &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) &amp;&amp;         <span class="comment">/* No context specified */</span>
<a name="l07326"></a>07326           !<a class="code" href="chan__iax2_8c.html#a0a986795c773063ee8a070febf2616f4">apply_context</a>(user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;context)) {      <span class="comment">/* Context is permitted */</span>
<a name="l07327"></a>07327          user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l07328"></a>07328       }
<a name="l07329"></a>07329    }
<a name="l07330"></a>07330    <span class="keywordflow">if</span> (user) {
<a name="l07331"></a>07331       <span class="comment">/* We found our match (use the first) */</span>
<a name="l07332"></a>07332       <span class="comment">/* copy vars */</span>
<a name="l07333"></a>07333       <span class="keywordflow">for</span> (v = user-&gt;<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> ; v ; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l07334"></a>07334          <span class="keywordflow">if</span>((tmpvar = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#adf16cd437526a5c5e0e0af87745acbb8">file</a>))) {
<a name="l07335"></a>07335             tmpvar-&gt;next = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;vars; 
<a name="l07336"></a>07336             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;vars = tmpvar;
<a name="l07337"></a>07337          }
<a name="l07338"></a>07338       }
<a name="l07339"></a>07339       <span class="comment">/* If a max AUTHREQ restriction is in place, activate it */</span>
<a name="l07340"></a>07340       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a> &gt; 0)
<a name="l07341"></a>07341          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a>);
<a name="l07342"></a>07342       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a> = user-&gt;<a class="code" href="structiax2__user.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l07343"></a>07343       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae233a3edc609990a3402d03d4ddd5f1e">IAX_IMMEDIATE</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l07344"></a>07344       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = user-&gt;<a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>;
<a name="l07345"></a>07345       <span class="comment">/* Store the requested username if not specified */</span>
<a name="l07346"></a>07346       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username))
<a name="l07347"></a>07347          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], username, user-&gt;name);
<a name="l07348"></a>07348       <span class="comment">/* Store whether this is a trunked call, too, of course, and move if appropriate */</span>
<a name="l07349"></a>07349       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);
<a name="l07350"></a>07350       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = user-&gt;<a class="code" href="structiax2__user.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l07351"></a>07351       <span class="comment">/* And use the default context */</span>
<a name="l07352"></a>07352       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)) {
<a name="l07353"></a>07353          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>)
<a name="l07354"></a>07354             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>-&gt;<a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l07355"></a>07355          <span class="keywordflow">else</span>
<a name="l07356"></a>07356             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__iax2_8c.html#a65482022daa21b4f2424677e9f3c2f65">DEFAULT_CONTEXT</a>);
<a name="l07357"></a>07357       }
<a name="l07358"></a>07358       <span class="comment">/* And any input keys */</span>
<a name="l07359"></a>07359       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], inkeys, user-&gt;inkeys);
<a name="l07360"></a>07360       <span class="comment">/* And the permitted authentication methods */</span>
<a name="l07361"></a>07361       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>;
<a name="l07362"></a>07362       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = user-&gt;<a class="code" href="structiax2__user.html#a61fbadf21e15a109d0703a01e0302535">adsi</a>;
<a name="l07363"></a>07363       <span class="comment">/* If the user has callerid, override the remote caller id. */</span>
<a name="l07364"></a>07364       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>)) {
<a name="l07365"></a>07365          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a7ab4a847c94ceca414d76c2abe5587aa">calling_tns</a> = 0;
<a name="l07366"></a>07366          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a57eabf92fe7c9f440fe38fb529c57f91">calling_ton</a> = 0;
<a name="l07367"></a>07367          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, user-&gt;cid_num);
<a name="l07368"></a>07368          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, user-&gt;cid_name);
<a name="l07369"></a>07369          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], ani, user-&gt;cid_num);
<a name="l07370"></a>07370          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#aa16fb44247d3656e98d82796a24c0ec6">calling_pres</a> = <a class="code" href="callerid_8h.html#a043ef1598e8e11e95bb7279950399171">AST_PRES_ALLOWED_USER_NUMBER_PASSED_SCREEN</a>;
<a name="l07371"></a>07371       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>)) {
<a name="l07372"></a>07372          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#aa16fb44247d3656e98d82796a24c0ec6">calling_pres</a> = <a class="code" href="callerid_8h.html#a69574f5c1e9be59b1d2eb727d4209bce">AST_PRES_NUMBER_NOT_AVAILABLE</a>;
<a name="l07373"></a>07373       } <span class="comment">/* else user is allowed to set their own CID settings */</span>
<a name="l07374"></a>07374       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;accountcode))
<a name="l07375"></a>07375          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], accountcode, user-&gt;accountcode);
<a name="l07376"></a>07376       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;mohinterpret))
<a name="l07377"></a>07377          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], mohinterpret, user-&gt;mohinterpret);
<a name="l07378"></a>07378       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;mohsuggest))
<a name="l07379"></a>07379          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], mohsuggest, user-&gt;mohsuggest);
<a name="l07380"></a>07380       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;parkinglot))
<a name="l07381"></a>07381          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>, user-&gt;parkinglot);
<a name="l07382"></a>07382       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>)
<a name="l07383"></a>07383          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> = user-&gt;<a class="code" href="structiax2__user.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>;
<a name="l07384"></a>07384       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;language))
<a name="l07385"></a>07385          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], language, user-&gt;language);
<a name="l07386"></a>07386       <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);   
<a name="l07387"></a>07387       <span class="comment">/* Keep this check last */</span>
<a name="l07388"></a>07388       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;dbsecret)) {
<a name="l07389"></a>07389          <span class="keywordtype">char</span> *family, *key=NULL;
<a name="l07390"></a>07390          <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[80];
<a name="l07391"></a>07391          family = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(user-&gt;dbsecret);
<a name="l07392"></a>07392          key = strchr(family, <span class="charliteral">&apos;/&apos;</span>);
<a name="l07393"></a>07393          <span class="keywordflow">if</span> (key) {
<a name="l07394"></a>07394             *key = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l07395"></a>07395             key++;
<a name="l07396"></a>07396          }
<a name="l07397"></a>07397          <span class="keywordflow">if</span> (!key || <a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(family, key, buf, <span class="keyword">sizeof</span>(buf)))
<a name="l07398"></a>07398             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to retrieve database password for family/key &apos;%s&apos;!\n&quot;</span>, user-&gt;dbsecret);
<a name="l07399"></a>07399          <span class="keywordflow">else</span>
<a name="l07400"></a>07400             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, buf);
<a name="l07401"></a>07401       } <span class="keywordflow">else</span>
<a name="l07402"></a>07402          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, user-&gt;secret);
<a name="l07403"></a>07403       res = 0;
<a name="l07404"></a>07404       user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l07405"></a>07405    } <span class="keywordflow">else</span> {
<a name="l07406"></a>07406        <span class="comment">/* user was not found, but we should still fake an AUTHREQ.</span>
<a name="l07407"></a>07407 <span class="comment">        * Set authmethods to the last known authmethod used by the system</span>
<a name="l07408"></a>07408 <span class="comment">        * Set a fake secret, it&apos;s not looked at, just required to attempt authentication.</span>
<a name="l07409"></a>07409 <span class="comment">        * Set authrej so the AUTHREP is rejected without even looking at its contents */</span>
<a name="l07410"></a>07410       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = last_authmethod ? last_authmethod : (<a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a> | <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>);
<a name="l07411"></a>07411       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, <span class="stringliteral">&quot;badsecret&quot;</span>);
<a name="l07412"></a>07412       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a8be922ac9e9631df65118757da989390">authrej</a> = 1;
<a name="l07413"></a>07413       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;username)) {
<a name="l07414"></a>07414          <span class="comment">/* only send the AUTHREQ if a username was specified. */</span>
<a name="l07415"></a>07415          res = 0;
<a name="l07416"></a>07416       }
<a name="l07417"></a>07417    }
<a name="l07418"></a>07418    <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a7a94cd46cfec615b4cdd51a3be450d19">iax2_getpeertrunk</a>(*sin), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);  
<a name="l07419"></a>07419    <span class="keywordflow">return</span> res;
<a name="l07420"></a>07420 }
<a name="l07421"></a>07421 
<a name="l07422"></a><a class="code" href="chan__iax2_8c.html#a352d072f2a27781e2c523b7d34471e2f">07422</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a352d072f2a27781e2c523b7d34471e2f">raw_hangup</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> src, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dst, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>)
<a name="l07423"></a>07423 {
<a name="l07424"></a>07424    <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> fh;
<a name="l07425"></a>07425    fh.<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a> = htons(src | <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>);
<a name="l07426"></a>07426    fh.<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a> = htons(dst);
<a name="l07427"></a>07427    fh.<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = 0;
<a name="l07428"></a>07428    fh.<a class="code" href="structast__iax2__full__hdr.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> = 0;
<a name="l07429"></a>07429    fh.<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> = 0;
<a name="l07430"></a>07430    fh.<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>;
<a name="l07431"></a>07431    fh.<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> = <a class="code" href="chan__iax2_8c.html#ab063a335efcdf8cf19193fae08c6fcf9">compress_subclass</a>(<a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>);
<a name="l07432"></a>07432    <a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">iax_outputframe</a>(NULL, &amp;fh, 0, sin, 0);
<a name="l07433"></a>07433 <span class="preprocessor">#if 0</span>
<a name="l07434"></a>07434 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l07435"></a>07435 <span class="preprocessor">#endif   </span>
<a name="l07436"></a>07436 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Raw Hangup %s:%d, src=%d, dst=%d\n&quot;</span>,
<a name="l07437"></a>07437          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port), src, dst);
<a name="l07438"></a>07438    <span class="keywordflow">return</span> sendto(sockfd, &amp;fh, <span class="keyword">sizeof</span>(fh), 0, (<span class="keyword">struct</span> sockaddr *)sin, <span class="keyword">sizeof</span>(*sin));
<a name="l07439"></a>07439 }
<a name="l07440"></a>07440 
<a name="l07441"></a><a class="code" href="chan__iax2_8c.html#ae04cb63aa7cb2e9869c473d46c4998a3">07441</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ae04cb63aa7cb2e9869c473d46c4998a3">merge_encryption</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> enc)
<a name="l07442"></a>07442 {
<a name="l07443"></a>07443    <span class="comment">/* Select exactly one common encryption if there are any */</span>
<a name="l07444"></a>07444    p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> &amp;= enc;
<a name="l07445"></a>07445    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l07446"></a>07446       <span class="keywordflow">if</span> (!(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> &amp; <a class="code" href="iax2_8h.html#abe33a013186fa460de6464f68187c090">IAX_ENCRYPT_KEYROTATE</a>)){ <span class="comment">/* if key rotation is not supported, turn off keyrotation. */</span>
<a name="l07447"></a>07447          p-&gt;<a class="code" href="structchan__iax2__pvt.html#a2c6d41a747fb84525cb4049b8bf78b4d">keyrotateid</a> = -2;
<a name="l07448"></a>07448       }
<a name="l07449"></a>07449       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> &amp; <a class="code" href="iax2_8h.html#a8400222929fd0aa369ebf89fbe54ca2f">IAX_ENCRYPT_AES128</a>)
<a name="l07450"></a>07450          p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = <a class="code" href="iax2_8h.html#a8400222929fd0aa369ebf89fbe54ca2f">IAX_ENCRYPT_AES128</a>;
<a name="l07451"></a>07451       <span class="keywordflow">else</span>
<a name="l07452"></a>07452          p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = 0;
<a name="l07453"></a>07453    }
<a name="l07454"></a>07454 }
<a name="l07455"></a>07455 <span class="comment"></span>
<a name="l07456"></a>07456 <span class="comment">/*!</span>
<a name="l07457"></a>07457 <span class="comment"> * \pre iaxsl[call_num] is locked</span>
<a name="l07458"></a>07458 <span class="comment"> *</span>
<a name="l07459"></a>07459 <span class="comment"> * \note Since this function calls send_command_final(), the pvt struct for the given</span>
<a name="l07460"></a>07460 <span class="comment"> *       call number may disappear while executing this function.</span>
<a name="l07461"></a>07461 <span class="comment"> */</span>
<a name="l07462"></a><a class="code" href="chan__iax2_8c.html#a9cd137f417ee18b77860630386e5e3c4">07462</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9cd137f417ee18b77860630386e5e3c4">authenticate_request</a>(<span class="keywordtype">int</span> call_num)
<a name="l07463"></a>07463 {
<a name="l07464"></a>07464    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l07465"></a>07465    <span class="keywordtype">int</span> res = -1, authreq_restrict = 0;
<a name="l07466"></a>07466    <span class="keywordtype">char</span> challenge[10];
<a name="l07467"></a>07467    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[call_num];
<a name="l07468"></a>07468 
<a name="l07469"></a>07469    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l07470"></a>07470 
<a name="l07471"></a>07471    <span class="comment">/* If an AUTHREQ restriction is in place, make sure we can send an AUTHREQ back */</span>
<a name="l07472"></a>07472    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a>)) {
<a name="l07473"></a>07473       <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, tmp_user = {
<a name="l07474"></a>07474          .name = p-&gt;username, 
<a name="l07475"></a>07475       };
<a name="l07476"></a>07476 
<a name="l07477"></a>07477       user = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(users, &amp;tmp_user, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l07478"></a>07478       <span class="keywordflow">if</span> (user) {
<a name="l07479"></a>07479          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a> == user-&gt;<a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a>)
<a name="l07480"></a>07480             authreq_restrict = 1;
<a name="l07481"></a>07481          <span class="keywordflow">else</span>
<a name="l07482"></a>07482             user-&gt;<a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a>++;
<a name="l07483"></a>07483          user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l07484"></a>07484       }
<a name="l07485"></a>07485    }
<a name="l07486"></a>07486 
<a name="l07487"></a>07487    <span class="comment">/* If the AUTHREQ limit test failed, send back an error */</span>
<a name="l07488"></a>07488    <span class="keywordflow">if</span> (authreq_restrict) {
<a name="l07489"></a>07489       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Unauthenticated call limit reached&quot;</span>);
<a name="l07490"></a>07490       <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a9900b24b261c275bb54631f16d4d38cc">AST_CAUSE_CALL_REJECTED</a>);
<a name="l07491"></a>07491       <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(p, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l07492"></a>07492       <span class="keywordflow">return</span> 0;
<a name="l07493"></a>07493    }
<a name="l07494"></a>07494 
<a name="l07495"></a>07495    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#addd02aa42471088b1d38a0915b69c506">IAX_IE_AUTHMETHODS</a>, p-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>);
<a name="l07496"></a>07496    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; (<a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a> | <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>)) {
<a name="l07497"></a>07497       snprintf(challenge, <span class="keyword">sizeof</span>(challenge), <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>)<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l07498"></a>07498       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(p, challenge, challenge);
<a name="l07499"></a>07499       <span class="comment">/* snprintf(p-&gt;challenge, sizeof(p-&gt;challenge), &quot;%d&quot;, (int)ast_random()); */</span>
<a name="l07500"></a>07500       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afdfe925c29c3385317252633f5cf74d1">IAX_IE_CHALLENGE</a>, p-&gt;challenge);
<a name="l07501"></a>07501    }
<a name="l07502"></a>07502    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>)
<a name="l07503"></a>07503       <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#a82301ee077d892ac535637a33eeff904">IAX_IE_ENCRYPTION</a>, p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>);
<a name="l07504"></a>07504 
<a name="l07505"></a>07505    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied,<a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, p-&gt;username);
<a name="l07506"></a>07506 
<a name="l07507"></a>07507    res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(p, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa85a01799deb4255dd6bd5fc06cd719f3">IAX_COMMAND_AUTHREQ</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l07508"></a>07508 
<a name="l07509"></a>07509    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>)
<a name="l07510"></a>07510       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a>);
<a name="l07511"></a>07511 
<a name="l07512"></a>07512    <span class="keywordflow">return</span> res;
<a name="l07513"></a>07513 }
<a name="l07514"></a>07514 
<a name="l07515"></a><a class="code" href="chan__iax2_8c.html#ada169c41e135b07cc8360269b98c30ba">07515</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ada169c41e135b07cc8360269b98c30ba">authenticate_verify</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies)
<a name="l07516"></a>07516 {
<a name="l07517"></a>07517    <span class="keywordtype">char</span> requeststr[256];
<a name="l07518"></a>07518    <span class="keywordtype">char</span> md5secret[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07519"></a>07519    <span class="keywordtype">char</span> <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07520"></a>07520    <span class="keywordtype">char</span> rsasecret[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07521"></a>07521    <span class="keywordtype">int</span> res = -1; 
<a name="l07522"></a>07522    <span class="keywordtype">int</span> x;
<a name="l07523"></a>07523    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, tmp_user = {
<a name="l07524"></a>07524       .name = p-&gt;username, 
<a name="l07525"></a>07525    };
<a name="l07526"></a>07526 
<a name="l07527"></a>07527    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a8be922ac9e9631df65118757da989390">authrej</a>) {
<a name="l07528"></a>07528       <span class="keywordflow">return</span> res;
<a name="l07529"></a>07529    }
<a name="l07530"></a>07530    user = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(users, &amp;tmp_user, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l07531"></a>07531    <span class="keywordflow">if</span> (user) {
<a name="l07532"></a>07532       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a>)) {
<a name="l07533"></a>07533          <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;user-&gt;<a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a>, -1);
<a name="l07534"></a>07534          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba88422cac4d4e50a6eb80dac1f0155588">IAX_MAXAUTHREQ</a>);
<a name="l07535"></a>07535       }
<a name="l07536"></a>07536       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(p, host, user-&gt;name);
<a name="l07537"></a>07537       user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l07538"></a>07538    }
<a name="l07539"></a>07539    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>) &amp;&amp; !p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) { 
<a name="l07540"></a>07540       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Call Terminated, Incomming call is unencrypted while force encrypt is enabled.&quot;</span>);
<a name="l07541"></a>07541       <span class="keywordflow">return</span> res;
<a name="l07542"></a>07542    }
<a name="l07543"></a>07543    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;p-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>))
<a name="l07544"></a>07544       <span class="keywordflow">return</span> res;
<a name="l07545"></a>07545    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>)
<a name="l07546"></a>07546       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(secret, ies-&gt;<a class="code" href="structiax__ies.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>, <span class="keyword">sizeof</span>(secret));
<a name="l07547"></a>07547    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a8312d1962ec7c4e621bc54d1a1604423">md5_result</a>)
<a name="l07548"></a>07548       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(md5secret, ies-&gt;<a class="code" href="structiax__ies.html#a8312d1962ec7c4e621bc54d1a1604423">md5_result</a>, <span class="keyword">sizeof</span>(md5secret));
<a name="l07549"></a>07549    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9f6e740e9f8b0cd5f02ccbcca34fcdfe">rsa_result</a>)
<a name="l07550"></a>07550       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(rsasecret, ies-&gt;<a class="code" href="structiax__ies.html#a9f6e740e9f8b0cd5f02ccbcca34fcdfe">rsa_result</a>, <span class="keyword">sizeof</span>(rsasecret));
<a name="l07551"></a>07551    <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rsasecret) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;inkeys)) {
<a name="l07552"></a>07552       <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l07553"></a>07553       <span class="keywordtype">char</span> *keyn;
<a name="l07554"></a>07554       <span class="keywordtype">char</span> tmpkey[256];
<a name="l07555"></a>07555       <span class="keywordtype">char</span> *stringp=NULL;
<a name="l07556"></a>07556       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpkey, p-&gt;inkeys, <span class="keyword">sizeof</span>(tmpkey));
<a name="l07557"></a>07557       stringp=tmpkey;
<a name="l07558"></a>07558       keyn = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l07559"></a>07559       <span class="keywordflow">while</span>(keyn) {
<a name="l07560"></a>07560          key = <a class="code" href="crypto_8h.html#ae616a3ae122fcb33a6f5937dc1295718" title="Retrieve a key.">ast_key_get</a>(keyn, <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>);
<a name="l07561"></a>07561          <span class="keywordflow">if</span> (key &amp;&amp; !<a class="code" href="crypto_8h.html#a50332dc613df6416ba467b5bde4934e2" title="Check the authenticity of a message signature using a given public key.">ast_check_signature</a>(key, p-&gt;challenge, rsasecret)) {
<a name="l07562"></a>07562             res = 0;
<a name="l07563"></a>07563             <span class="keywordflow">break</span>;
<a name="l07564"></a>07564          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!key)
<a name="l07565"></a>07565             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;requested inkey &apos;%s&apos; for RSA authentication does not exist\n&quot;</span>, keyn);
<a name="l07566"></a>07566          keyn = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l07567"></a>07567       }
<a name="l07568"></a>07568    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>) {
<a name="l07569"></a>07569       <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l07570"></a>07570       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
<a name="l07571"></a>07571       <span class="keywordtype">char</span> *tmppw, *stringp;
<a name="l07572"></a>07572       
<a name="l07573"></a>07573       tmppw = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(p-&gt;secret);
<a name="l07574"></a>07574       stringp = tmppw;
<a name="l07575"></a>07575       <span class="keywordflow">while</span>((tmppw = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;;&quot;</span>))) {
<a name="l07576"></a>07576          <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l07577"></a>07577          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)p-&gt;challenge, strlen(p-&gt;challenge));
<a name="l07578"></a>07578          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)tmppw, strlen(tmppw));
<a name="l07579"></a>07579          <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(digest, &amp;md5);
<a name="l07580"></a>07580          <span class="comment">/* If they support md5, authenticate with it.  */</span>
<a name="l07581"></a>07581          <span class="keywordflow">for</span> (x=0;x&lt;16;x++)
<a name="l07582"></a>07582             sprintf(requeststr + (x &lt;&lt; 1), <span class="stringliteral">&quot;%2.2x&quot;</span>, digest[x]); <span class="comment">/* safe */</span>
<a name="l07583"></a>07583          <span class="keywordflow">if</span> (!strcasecmp(requeststr, md5secret)) {
<a name="l07584"></a>07584             res = 0;
<a name="l07585"></a>07585             <span class="keywordflow">break</span>;
<a name="l07586"></a>07586          }
<a name="l07587"></a>07587       }
<a name="l07588"></a>07588    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>) {
<a name="l07589"></a>07589       <span class="keywordflow">if</span> (!strcmp(secret, p-&gt;secret))
<a name="l07590"></a>07590          res = 0;
<a name="l07591"></a>07591    }
<a name="l07592"></a>07592    <span class="keywordflow">return</span> res;
<a name="l07593"></a>07593 }
<a name="l07594"></a>07594 <span class="comment"></span>
<a name="l07595"></a>07595 <span class="comment">/*! \brief Verify inbound registration */</span>
<a name="l07596"></a><a class="code" href="chan__iax2_8c.html#aedc9b7d0d68dbbefe21019ed00ecfc57">07596</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aedc9b7d0d68dbbefe21019ed00ecfc57" title="Verify inbound registration.">register_verify</a>(<span class="keywordtype">int</span> callno, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies)
<a name="l07597"></a>07597 {
<a name="l07598"></a>07598    <span class="keywordtype">char</span> requeststr[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07599"></a>07599    <span class="keywordtype">char</span> peer[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07600"></a>07600    <span class="keywordtype">char</span> md5secret[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07601"></a>07601    <span class="keywordtype">char</span> rsasecret[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07602"></a>07602    <span class="keywordtype">char</span> <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07603"></a>07603    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *p = NULL;
<a name="l07604"></a>07604    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l07605"></a>07605    <span class="keywordtype">char</span> *keyn;
<a name="l07606"></a>07606    <span class="keywordtype">int</span> x;
<a name="l07607"></a>07607    <span class="keywordtype">int</span> expire = 0;
<a name="l07608"></a>07608    <span class="keywordtype">int</span> res = -1;
<a name="l07609"></a>07609 
<a name="l07610"></a>07610    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>);
<a name="l07611"></a>07611    <span class="comment">/* iaxs[callno]-&gt;peer[0] = &apos;\0&apos;; not necc. any more-- stringfield is pre-inited to null string */</span>
<a name="l07612"></a>07612    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l07613"></a>07613       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(peer, ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, <span class="keyword">sizeof</span>(peer));
<a name="l07614"></a>07614    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>)
<a name="l07615"></a>07615       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(secret, ies-&gt;<a class="code" href="structiax__ies.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>, <span class="keyword">sizeof</span>(secret));
<a name="l07616"></a>07616    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a8312d1962ec7c4e621bc54d1a1604423">md5_result</a>)
<a name="l07617"></a>07617       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(md5secret, ies-&gt;<a class="code" href="structiax__ies.html#a8312d1962ec7c4e621bc54d1a1604423">md5_result</a>, <span class="keyword">sizeof</span>(md5secret));
<a name="l07618"></a>07618    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9f6e740e9f8b0cd5f02ccbcca34fcdfe">rsa_result</a>)
<a name="l07619"></a>07619       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(rsasecret, ies-&gt;<a class="code" href="structiax__ies.html#a9f6e740e9f8b0cd5f02ccbcca34fcdfe">rsa_result</a>, <span class="keyword">sizeof</span>(rsasecret));
<a name="l07620"></a>07620    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>)
<a name="l07621"></a>07621       expire = ies-&gt;<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>;
<a name="l07622"></a>07622 
<a name="l07623"></a>07623    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer)) {
<a name="l07624"></a>07624       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Empty registration from %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l07625"></a>07625       <span class="keywordflow">return</span> -1;
<a name="l07626"></a>07626    }
<a name="l07627"></a>07627 
<a name="l07628"></a>07628    <span class="comment">/* SLD: first call to lookup peer during registration */</span>
<a name="l07629"></a>07629    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07630"></a>07630    p = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(peer, 1);
<a name="l07631"></a>07631    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07632"></a>07632    <span class="keywordflow">if</span> (!p || !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l07633"></a>07633       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l07634"></a>07634          <span class="keywordtype">int</span> plaintext = ((last_authmethod &amp; <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>) | (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;authmethods &amp; <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>));
<a name="l07635"></a>07635          <span class="comment">/* Anything, as long as it&apos;s non-blank */</span>
<a name="l07636"></a>07636          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], secret, <span class="stringliteral">&quot;badsecret&quot;</span>);
<a name="l07637"></a>07637          <span class="comment">/* An AUTHREQ must be sent in response to a REGREQ of an invalid peer unless</span>
<a name="l07638"></a>07638 <span class="comment">          * 1. A challenge already exists indicating a AUTHREQ was already sent out.</span>
<a name="l07639"></a>07639 <span class="comment">          * 2. A plaintext secret is present in ie as result of a previous AUTHREQ requesting it.</span>
<a name="l07640"></a>07640 <span class="comment">          * 3. A plaintext secret is present in the ie and the last_authmethod used by a peer happened</span>
<a name="l07641"></a>07641 <span class="comment">          *    to be plaintext, indicating it is an authmethod used by other peers on the system. </span>
<a name="l07642"></a>07642 <span class="comment">          *</span>
<a name="l07643"></a>07643 <span class="comment">          * If none of these cases exist, res will be returned as 0 without authentication indicating</span>
<a name="l07644"></a>07644 <span class="comment">          * an AUTHREQ needs to be sent out. */</span>
<a name="l07645"></a>07645 
<a name="l07646"></a>07646          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge) &amp;&amp;
<a name="l07647"></a>07647             !(!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(secret) &amp;&amp; plaintext)) {
<a name="l07648"></a>07648             <span class="comment">/* by setting res to 0, an REGAUTH will be sent */</span>
<a name="l07649"></a>07649             res = 0;
<a name="l07650"></a>07650          }
<a name="l07651"></a>07651       }
<a name="l07652"></a>07652       <span class="keywordflow">if</span> (authdebug &amp;&amp; !p)
<a name="l07653"></a>07653          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No registration for peer &apos;%s&apos; (from %s)\n&quot;</span>, peer, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l07654"></a>07654       <span class="keywordflow">goto</span> return_unref;
<a name="l07655"></a>07655    }
<a name="l07656"></a>07656 
<a name="l07657"></a>07657    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>)) {
<a name="l07658"></a>07658       <span class="keywordflow">if</span> (authdebug)
<a name="l07659"></a>07659          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Peer &apos;%s&apos; is not dynamic (from %s)\n&quot;</span>, peer, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l07660"></a>07660       <span class="keywordflow">goto</span> return_unref;
<a name="l07661"></a>07661    }
<a name="l07662"></a>07662 
<a name="l07663"></a>07663    <span class="keywordflow">if</span> (!<a class="code" href="acl_8h.html#aac0540803fb28e105697e917bd0f252b" title="Check IP address with host access list.">ast_apply_ha</a>(p-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>, sin)) {
<a name="l07664"></a>07664       <span class="keywordflow">if</span> (authdebug)
<a name="l07665"></a>07665          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Host %s denied access to register peer &apos;%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), p-&gt;name);
<a name="l07666"></a>07666       <span class="keywordflow">goto</span> return_unref;
<a name="l07667"></a>07667    }
<a name="l07668"></a>07668    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], secret, p-&gt;secret);
<a name="l07669"></a>07669    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], inkeys, p-&gt;inkeys);
<a name="l07670"></a>07670    <span class="comment">/* Check secret against what we have on file */</span>
<a name="l07671"></a>07671    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rsasecret) &amp;&amp; (p-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge)) {
<a name="l07672"></a>07672       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;inkeys)) {
<a name="l07673"></a>07673          <span class="keywordtype">char</span> tmpkeys[256];
<a name="l07674"></a>07674          <span class="keywordtype">char</span> *stringp=NULL;
<a name="l07675"></a>07675          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpkeys, p-&gt;inkeys, <span class="keyword">sizeof</span>(tmpkeys));
<a name="l07676"></a>07676          stringp=tmpkeys;
<a name="l07677"></a>07677          keyn = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l07678"></a>07678          <span class="keywordflow">while</span>(keyn) {
<a name="l07679"></a>07679             key = <a class="code" href="crypto_8h.html#ae616a3ae122fcb33a6f5937dc1295718" title="Retrieve a key.">ast_key_get</a>(keyn, <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>);
<a name="l07680"></a>07680             <span class="keywordflow">if</span> (key &amp;&amp; !<a class="code" href="crypto_8h.html#a50332dc613df6416ba467b5bde4934e2" title="Check the authenticity of a message signature using a given public key.">ast_check_signature</a>(key, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge, rsasecret)) {
<a name="l07681"></a>07681                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>);
<a name="l07682"></a>07682                <span class="keywordflow">break</span>;
<a name="l07683"></a>07683             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!key)
<a name="l07684"></a>07684                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;requested inkey &apos;%s&apos; does not exist\n&quot;</span>, keyn);
<a name="l07685"></a>07685             keyn = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l07686"></a>07686          }
<a name="l07687"></a>07687          <span class="keywordflow">if</span> (!keyn) {
<a name="l07688"></a>07688             <span class="keywordflow">if</span> (authdebug)
<a name="l07689"></a>07689                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Host %s failed RSA authentication with inkeys &apos;%s&apos;\n&quot;</span>, peer, p-&gt;inkeys);
<a name="l07690"></a>07690             <span class="keywordflow">goto</span> return_unref;
<a name="l07691"></a>07691          }
<a name="l07692"></a>07692       } <span class="keywordflow">else</span> {
<a name="l07693"></a>07693          <span class="keywordflow">if</span> (authdebug)
<a name="l07694"></a>07694             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Host &apos;%s&apos; trying to do RSA authentication, but we have no inkeys\n&quot;</span>, peer);
<a name="l07695"></a>07695          <span class="keywordflow">goto</span> return_unref;
<a name="l07696"></a>07696       }
<a name="l07697"></a>07697    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(md5secret) &amp;&amp; (p-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge)) {
<a name="l07698"></a>07698       <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l07699"></a>07699       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
<a name="l07700"></a>07700       <span class="keywordtype">char</span> *tmppw, *stringp;
<a name="l07701"></a>07701 
<a name="l07702"></a>07702       tmppw = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(p-&gt;secret);
<a name="l07703"></a>07703       stringp = tmppw;
<a name="l07704"></a>07704       <span class="keywordflow">while</span>((tmppw = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;;&quot;</span>))) {
<a name="l07705"></a>07705          <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l07706"></a>07706          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge, strlen(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge));
<a name="l07707"></a>07707          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)tmppw, strlen(tmppw));
<a name="l07708"></a>07708          <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(digest, &amp;md5);
<a name="l07709"></a>07709          <span class="keywordflow">for</span> (x=0;x&lt;16;x++)
<a name="l07710"></a>07710             sprintf(requeststr + (x &lt;&lt; 1), <span class="stringliteral">&quot;%2.2x&quot;</span>, digest[x]); <span class="comment">/* safe */</span>
<a name="l07711"></a>07711          <span class="keywordflow">if</span> (!strcasecmp(requeststr, md5secret))
<a name="l07712"></a>07712             <span class="keywordflow">break</span>;
<a name="l07713"></a>07713       }
<a name="l07714"></a>07714       <span class="keywordflow">if</span> (tmppw) {
<a name="l07715"></a>07715          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>);
<a name="l07716"></a>07716       } <span class="keywordflow">else</span> {
<a name="l07717"></a>07717          <span class="keywordflow">if</span> (authdebug)
<a name="l07718"></a>07718             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Host %s failed MD5 authentication for &apos;%s&apos; (%s != %s)\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), p-&gt;name, requeststr, md5secret);
<a name="l07719"></a>07719          <span class="keywordflow">goto</span> return_unref;
<a name="l07720"></a>07720       }
<a name="l07721"></a>07721    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(secret) &amp;&amp; (p-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>)) {
<a name="l07722"></a>07722       <span class="comment">/* They&apos;ve provided a plain text password and we support that */</span>
<a name="l07723"></a>07723       <span class="keywordflow">if</span> (strcmp(secret, p-&gt;secret)) {
<a name="l07724"></a>07724          <span class="keywordflow">if</span> (authdebug)
<a name="l07725"></a>07725             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Host %s did not provide proper plaintext password for &apos;%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), p-&gt;name);
<a name="l07726"></a>07726          <span class="keywordflow">goto</span> return_unref;
<a name="l07727"></a>07727       } <span class="keywordflow">else</span>
<a name="l07728"></a>07728          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>);
<a name="l07729"></a>07729    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(md5secret) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(rsasecret)) {
<a name="l07730"></a>07730       <span class="comment">/* if challenge has been sent, but no challenge response if given, reject. */</span>
<a name="l07731"></a>07731       <span class="keywordflow">goto</span> return_unref;
<a name="l07732"></a>07732    }
<a name="l07733"></a>07733    <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, p-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l07734"></a>07734 
<a name="l07735"></a>07735    <span class="comment">/* either Authentication has taken place, or a REGAUTH must be sent before verifying registration */</span>
<a name="l07736"></a>07736    res = 0;
<a name="l07737"></a>07737 
<a name="l07738"></a>07738 return_unref:
<a name="l07739"></a>07739    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l07740"></a>07740       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], peer, peer);
<a name="l07741"></a>07741 
<a name="l07742"></a>07742       <span class="comment">/* Choose lowest expiry number */</span>
<a name="l07743"></a>07743       <span class="keywordflow">if</span> (expire &amp;&amp; (expire &lt; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;expiry)) {
<a name="l07744"></a>07744          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = expire;
<a name="l07745"></a>07745       }
<a name="l07746"></a>07746    }
<a name="l07747"></a>07747 
<a name="l07748"></a>07748    <span class="keywordflow">if</span> (p) {
<a name="l07749"></a>07749       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l07750"></a>07750    }
<a name="l07751"></a>07751    <span class="keywordflow">return</span> res;
<a name="l07752"></a>07752 }
<a name="l07753"></a>07753 
<a name="l07754"></a><a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">07754</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">authenticate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *challenge, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *keyn, <span class="keywordtype">int</span> authmethods, <span class="keyword">struct</span> <a class="code" href="structiax__ie__data.html">iax_ie_data</a> *ied, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt)
<a name="l07755"></a>07755 {
<a name="l07756"></a>07756    <span class="keywordtype">int</span> res = -1;
<a name="l07757"></a>07757    <span class="keywordtype">int</span> x;
<a name="l07758"></a>07758    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(keyn)) {
<a name="l07759"></a>07759       <span class="keywordflow">if</span> (!(authmethods &amp; <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>)) {
<a name="l07760"></a>07760          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(secret)) 
<a name="l07761"></a>07761             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Asked to authenticate to %s with an RSA key, but they don&apos;t allow RSA authentication\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l07762"></a>07762       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(challenge)) {
<a name="l07763"></a>07763          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No challenge provided for RSA authentication to %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l07764"></a>07764       } <span class="keywordflow">else</span> {
<a name="l07765"></a>07765          <span class="keywordtype">char</span> sig[256];
<a name="l07766"></a>07766          <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l07767"></a>07767          key = <a class="code" href="crypto_8h.html#ae616a3ae122fcb33a6f5937dc1295718" title="Retrieve a key.">ast_key_get</a>(keyn, <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>);
<a name="l07768"></a>07768          <span class="keywordflow">if</span> (!key) {
<a name="l07769"></a>07769             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to find private key &apos;%s&apos;\n&quot;</span>, keyn);
<a name="l07770"></a>07770          } <span class="keywordflow">else</span> {
<a name="l07771"></a>07771             <span class="keywordflow">if</span> (<a class="code" href="crypto_8h.html#ac38f2d4ddec17857aaf5bc0dd13dab38" title="Sign a message signature using a given private key.">ast_sign</a>(key, (<span class="keywordtype">char</span>*)challenge, sig)) {
<a name="l07772"></a>07772                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to sign challenge with key\n&quot;</span>);
<a name="l07773"></a>07773                res = -1;
<a name="l07774"></a>07774             } <span class="keywordflow">else</span> {
<a name="l07775"></a>07775                <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(ied, <a class="code" href="iax2_8h.html#a3987a24c3026cd822133ae678ae0d924">IAX_IE_RSA_RESULT</a>, sig);
<a name="l07776"></a>07776                res = 0;
<a name="l07777"></a>07777             }
<a name="l07778"></a>07778          }
<a name="l07779"></a>07779       }
<a name="l07780"></a>07780    } 
<a name="l07781"></a>07781    <span class="comment">/* Fall back */</span>
<a name="l07782"></a>07782    <span class="keywordflow">if</span> (res &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(secret)) {
<a name="l07783"></a>07783       <span class="keywordflow">if</span> ((authmethods &amp; <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(challenge)) {
<a name="l07784"></a>07784          <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l07785"></a>07785          <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> digest[16];
<a name="l07786"></a>07786          <span class="keywordtype">char</span> digres[128];
<a name="l07787"></a>07787          <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l07788"></a>07788          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)challenge, strlen(challenge));
<a name="l07789"></a>07789          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)secret, strlen(secret));
<a name="l07790"></a>07790          <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(digest, &amp;md5);
<a name="l07791"></a>07791          <span class="comment">/* If they support md5, authenticate with it.  */</span>
<a name="l07792"></a>07792          <span class="keywordflow">for</span> (x=0;x&lt;16;x++)
<a name="l07793"></a>07793             sprintf(digres + (x &lt;&lt; 1),  <span class="stringliteral">&quot;%2.2x&quot;</span>, digest[x]); <span class="comment">/* safe */</span>
<a name="l07794"></a>07794          <span class="keywordflow">if</span> (pvt) {
<a name="l07795"></a>07795             <a class="code" href="chan__iax2_8c.html#aeee0c3a783f20bf1d8bf66888e89238d">build_encryption_keys</a>(digest, pvt);
<a name="l07796"></a>07796          }
<a name="l07797"></a>07797          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(ied, <a class="code" href="iax2_8h.html#ab019e7b283ca9d475618bab90e6ed8b7">IAX_IE_MD5_RESULT</a>, digres);
<a name="l07798"></a>07798          res = 0;
<a name="l07799"></a>07799       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (authmethods &amp; <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>) {
<a name="l07800"></a>07800          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(ied, <a class="code" href="iax2_8h.html#a0068830a768cd96da372f33082f718c7">IAX_IE_PASSWORD</a>, secret);
<a name="l07801"></a>07801          res = 0;
<a name="l07802"></a>07802       } <span class="keywordflow">else</span>
<a name="l07803"></a>07803          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No way to send secret to peer &apos;%s&apos; (their methods: %d)\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), authmethods);
<a name="l07804"></a>07804    }
<a name="l07805"></a>07805    <span class="keywordflow">return</span> res;
<a name="l07806"></a>07806 }
<a name="l07807"></a>07807 <span class="comment"></span>
<a name="l07808"></a>07808 <span class="comment">/*!</span>
<a name="l07809"></a>07809 <span class="comment"> * \note This function calls realtime_peer -&gt; reg_source_db -&gt; iax2_poke_peer -&gt; find_callno,</span>
<a name="l07810"></a>07810 <span class="comment"> *       so do not call this function with a pvt lock held.</span>
<a name="l07811"></a>07811 <span class="comment"> */</span>
<a name="l07812"></a><a class="code" href="chan__iax2_8c.html#a0bbca4bef81d9f18a98cc50b5d0e9eac">07812</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0bbca4bef81d9f18a98cc50b5d0e9eac">authenticate_reply</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *p, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">override</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *okey)
<a name="l07813"></a>07813 {
<a name="l07814"></a>07814    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l07815"></a>07815    <span class="comment">/* Start pessimistic */</span>
<a name="l07816"></a>07816    <span class="keywordtype">int</span> res = -1;
<a name="l07817"></a>07817    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = 0;
<a name="l07818"></a>07818    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l07819"></a>07819    uint16_t callno = p-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l07820"></a>07820 
<a name="l07821"></a>07821    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l07822"></a>07822    
<a name="l07823"></a>07823    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l07824"></a>07824       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(p, username, ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>);
<a name="l07825"></a>07825    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a2929a7d62f294309a5126ccb738f6060">challenge</a>)
<a name="l07826"></a>07826       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(p, challenge, ies-&gt;<a class="code" href="structiax__ies.html#a2929a7d62f294309a5126ccb738f6060">challenge</a>);
<a name="l07827"></a>07827    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a23e4b8fa5e973ab5ee519df548401897">authmethods</a>)
<a name="l07828"></a>07828       authmethods = ies-&gt;<a class="code" href="structiax__ies.html#a23e4b8fa5e973ab5ee519df548401897">authmethods</a>;
<a name="l07829"></a>07829    <span class="keywordflow">if</span> (authmethods &amp; <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>)
<a name="l07830"></a>07830       <a class="code" href="chan__iax2_8c.html#ae04cb63aa7cb2e9869c473d46c4998a3">merge_encryption</a>(p, ies-&gt;<a class="code" href="structiax__ies.html#a91fce818393dd09b9565b16568e991db">encmethods</a>);
<a name="l07831"></a>07831    <span class="keywordflow">else</span>
<a name="l07832"></a>07832       p-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = 0;
<a name="l07833"></a>07833 
<a name="l07834"></a>07834    <span class="comment">/* Check for override RSA authentication first */</span>
<a name="l07835"></a>07835    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keyword">override</span>) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(okey)) {
<a name="l07836"></a>07836       <span class="comment">/* Normal password authentication */</span>
<a name="l07837"></a>07837       res = <a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">authenticate</a>(p-&gt;challenge, <span class="keyword">override</span>, okey, authmethods, &amp;ied, sin, p);
<a name="l07838"></a>07838    } <span class="keywordflow">else</span> {
<a name="l07839"></a>07839       <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l07840"></a>07840       <span class="keywordflow">while</span> ((peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l07841"></a>07841          <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;peer) || !strcmp(p-&gt;peer, peer-&gt;name)) 
<a name="l07842"></a>07842              <span class="comment">/* No peer specified at our end, or this is the peer */</span>
<a name="l07843"></a>07843              &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;username) || (!strcmp(peer-&gt;username, p-&gt;username)))
<a name="l07844"></a>07844              <span class="comment">/* No username specified in peer rule, or this is the right username */</span>
<a name="l07845"></a>07845              &amp;&amp; (!peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr || ((sin-&gt;sin_addr.s_addr &amp; peer-&gt;<a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>.s_addr) == (peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr &amp; peer-&gt;<a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>.s_addr)))
<a name="l07846"></a>07846              <span class="comment">/* No specified host, or this is our host */</span>
<a name="l07847"></a>07847             ) {
<a name="l07848"></a>07848             res = <a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">authenticate</a>(p-&gt;challenge, peer-&gt;secret, peer-&gt;outkey, authmethods, &amp;ied, sin, p);
<a name="l07849"></a>07849             <span class="keywordflow">if</span> (!res) {
<a name="l07850"></a>07850                <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l07851"></a>07851                <span class="keywordflow">break</span>;
<a name="l07852"></a>07852             }
<a name="l07853"></a>07853          }
<a name="l07854"></a>07854          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l07855"></a>07855       }
<a name="l07856"></a>07856       <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l07857"></a>07857       <span class="keywordflow">if</span> (!peer) {
<a name="l07858"></a>07858          <span class="comment">/* We checked our list and didn&apos;t find one.  It&apos;s unlikely, but possible, </span>
<a name="l07859"></a>07859 <span class="comment">            that we&apos;re trying to authenticate *to* a realtime peer */</span>
<a name="l07860"></a>07860          <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(p-&gt;peer);
<a name="l07861"></a>07861          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07862"></a>07862          <span class="keywordflow">if</span> ((peer = <a class="code" href="chan__iax2_8c.html#a5e40e5b414518805c29727452fcf3868">realtime_peer</a>(peer_name, NULL))) {
<a name="l07863"></a>07863             <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07864"></a>07864             <span class="keywordflow">if</span> (!(p = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])) {
<a name="l07865"></a>07865                <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l07866"></a>07866                <span class="keywordflow">return</span> -1;
<a name="l07867"></a>07867             }
<a name="l07868"></a>07868             res = <a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">authenticate</a>(p-&gt;challenge, peer-&gt;secret,peer-&gt;outkey, authmethods, &amp;ied, sin, p);
<a name="l07869"></a>07869             <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l07870"></a>07870          }
<a name="l07871"></a>07871          <span class="keywordflow">if</span> (!peer) {
<a name="l07872"></a>07872             <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l07873"></a>07873             <span class="keywordflow">if</span> (!(p = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]))
<a name="l07874"></a>07874                <span class="keywordflow">return</span> -1;
<a name="l07875"></a>07875          }
<a name="l07876"></a>07876       }
<a name="l07877"></a>07877    }
<a name="l07878"></a>07878 
<a name="l07879"></a>07879    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a91fce818393dd09b9565b16568e991db">encmethods</a>) {
<a name="l07880"></a>07880       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8bec3f8a2a6ad2df2290be8483a0496c">IAX_KEYPOPULATED</a>);
<a name="l07881"></a>07881    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>)) {
<a name="l07882"></a>07882       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Call initiated without encryption while forceencryption=yes option is set&quot;</span>);
<a name="l07883"></a>07883       <span class="keywordflow">return</span> -1;             <span class="comment">/* if force encryption is yes, and no encryption methods, then return -1 to hangup */</span>
<a name="l07884"></a>07884    }
<a name="l07885"></a>07885    <span class="keywordflow">if</span> (!res) {
<a name="l07886"></a>07886       <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore;
<a name="l07887"></a>07887       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *prev = NULL;
<a name="l07888"></a>07888       <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l07889"></a>07889       varlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*varlist));
<a name="l07890"></a>07890       variablestore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l07891"></a>07891       <span class="keywordflow">if</span> (variablestore &amp;&amp; varlist &amp;&amp; p-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l07892"></a>07892          variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = varlist;
<a name="l07893"></a>07893          variablestore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l07894"></a>07894          <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(varlist);
<a name="l07895"></a>07895          <span class="keywordflow">for</span> (var = ies-&gt;<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l07896"></a>07896             <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvar = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l07897"></a>07897             <span class="keywordflow">if</span> (prev)
<a name="l07898"></a>07898                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l07899"></a>07899             prev = var;
<a name="l07900"></a>07900             <span class="keywordflow">if</span> (!newvar) {
<a name="l07901"></a>07901                <span class="comment">/* Don&apos;t abort list traversal, as this would leave ies-&gt;vars in an inconsistent state. */</span>
<a name="l07902"></a>07902                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l07903"></a>07903             } <span class="keywordflow">else</span> {
<a name="l07904"></a>07904                <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(varlist, newvar, entries);
<a name="l07905"></a>07905             }
<a name="l07906"></a>07906          }
<a name="l07907"></a>07907          <span class="keywordflow">if</span> (prev)
<a name="l07908"></a>07908             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l07909"></a>07909          ies-&gt;<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l07910"></a>07910          <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(p-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, variablestore);
<a name="l07911"></a>07911       } <span class="keywordflow">else</span> {
<a name="l07912"></a>07912          <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l07913"></a>07913             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l07914"></a>07914          <span class="keywordflow">if</span> (variablestore)
<a name="l07915"></a>07915             <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(variablestore);
<a name="l07916"></a>07916          <span class="keywordflow">if</span> (varlist)
<a name="l07917"></a>07917             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(varlist);
<a name="l07918"></a>07918       }
<a name="l07919"></a>07919    }
<a name="l07920"></a>07920 
<a name="l07921"></a>07921    <span class="keywordflow">if</span> (!res)
<a name="l07922"></a>07922       res = <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(p, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa1408b2e0afffb3e8b241b059b5ffdc29">IAX_COMMAND_AUTHREP</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l07923"></a>07923    <span class="keywordflow">return</span> res;
<a name="l07924"></a>07924 }
<a name="l07925"></a>07925 
<a name="l07926"></a>07926 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">iax2_do_register</a>(<span class="keyword">struct</span> iax2_registry *reg);
<a name="l07927"></a>07927 
<a name="l07928"></a><a class="code" href="chan__iax2_8c.html#ab474d49644ede1182b1fc463b3ed1ac3">07928</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ab474d49644ede1182b1fc463b3ed1ac3">__iax2_do_register_s</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l07929"></a>07929 {
<a name="l07930"></a>07930    <span class="keyword">struct </span>iax2_registry *reg = (<span class="keyword">struct </span>iax2_registry *)data;
<a name="l07931"></a>07931    reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l07932"></a>07932    <a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">iax2_do_register</a>(reg);
<a name="l07933"></a>07933 }
<a name="l07934"></a>07934 
<a name="l07935"></a><a class="code" href="chan__iax2_8c.html#af7b172cae2a4b98c38859794fae4f94b">07935</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af7b172cae2a4b98c38859794fae4f94b">iax2_do_register_s</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l07936"></a>07936 {
<a name="l07937"></a>07937 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l07938"></a>07938 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#ab474d49644ede1182b1fc463b3ed1ac3">__iax2_do_register_s</a>, data))
<a name="l07939"></a>07939 <span class="preprocessor">#endif      </span>
<a name="l07940"></a>07940 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#ab474d49644ede1182b1fc463b3ed1ac3">__iax2_do_register_s</a>(data);
<a name="l07941"></a>07941    <span class="keywordflow">return</span> 0;
<a name="l07942"></a>07942 }
<a name="l07943"></a>07943 
<a name="l07944"></a><a class="code" href="chan__iax2_8c.html#a4e8e372ddf3f4493875c92c3a0d53697">07944</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a4e8e372ddf3f4493875c92c3a0d53697">try_transfer</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies)
<a name="l07945"></a>07945 {
<a name="l07946"></a>07946    <span class="keywordtype">int</span> newcall = 0;
<a name="l07947"></a>07947    <span class="keywordtype">char</span> newip[256];
<a name="l07948"></a>07948    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l07949"></a>07949    <span class="keyword">struct </span>sockaddr_in new;
<a name="l07950"></a>07950    
<a name="l07951"></a>07951    
<a name="l07952"></a>07952    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l07953"></a>07953    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#ae853c4fd16ea01a56ca46a7a6e83cd52">apparent_addr</a>)
<a name="l07954"></a>07954       memmove(&amp;<span class="keyword">new</span>, ies-&gt;<a class="code" href="structiax__ies.html#ae853c4fd16ea01a56ca46a7a6e83cd52">apparent_addr</a>, <span class="keyword">sizeof</span>(<span class="keyword">new</span>));
<a name="l07955"></a>07955    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)
<a name="l07956"></a>07956       newcall = ies-&gt;<a class="code" href="structiax__ies.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l07957"></a>07957    <span class="keywordflow">if</span> (!newcall || !<span class="keyword">new</span>.sin_addr.s_addr || !<span class="keyword">new</span>.sin_port) {
<a name="l07958"></a>07958       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid transfer request\n&quot;</span>);
<a name="l07959"></a>07959       <span class="keywordflow">return</span> -1;
<a name="l07960"></a>07960    }
<a name="l07961"></a>07961    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a> = newcall;
<a name="l07962"></a>07962    memcpy(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>, &amp;<span class="keyword">new</span>, <span class="keyword">sizeof</span>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>));
<a name="l07963"></a>07963    inet_aton(newip, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>.sin_addr);
<a name="l07964"></a>07964    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>.sin_family = AF_INET;
<a name="l07965"></a>07965    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#af2f1a1a9f5f5ef89eda74ce4b17a7889">transferid</a> = ies-&gt;<a class="code" href="structiax__ies.html#a5b080a99616f700383dff816ef563ae2">transferid</a>;
<a name="l07966"></a>07966    <span class="comment">/* only store by transfercallno if this is a new transfer,</span>
<a name="l07967"></a>07967 <span class="comment">    * just in case we get a duplicate TXREQ */</span>
<a name="l07968"></a>07968    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a049e8add4a22f1065570f0b66067b22f">TRANSFER_NONE</a>) {
<a name="l07969"></a>07969       <a class="code" href="chan__iax2_8c.html#a134adba13ad8ba211d9eb0c2ea8ea439">store_by_transfercallno</a>(pvt);
<a name="l07970"></a>07970    }
<a name="l07971"></a>07971    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">TRANSFER_BEGIN</a>;
<a name="l07972"></a>07972 
<a name="l07973"></a>07973    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a5b080a99616f700383dff816ef563ae2">transferid</a>)
<a name="l07974"></a>07974       <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#a26484916834eef30492cc1548209c863">IAX_IE_TRANSFERID</a>, ies-&gt;<a class="code" href="structiax__ies.html#a5b080a99616f700383dff816ef563ae2">transferid</a>);
<a name="l07975"></a>07975    <a class="code" href="chan__iax2_8c.html#a1ff700fbef2b011689770294a3f1bec9">send_command_transfer</a>(pvt, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l07976"></a>07976    <span class="keywordflow">return</span> 0;
<a name="l07977"></a>07977 }
<a name="l07978"></a>07978 
<a name="l07979"></a><a class="code" href="chan__iax2_8c.html#a70f2c7bd7b8feb13adf2cb6f23e7a137">07979</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a70f2c7bd7b8feb13adf2cb6f23e7a137">complete_dpreply</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies)
<a name="l07980"></a>07980 {
<a name="l07981"></a>07981    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l07982"></a>07982    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a354d01072cc821460370e437dbca151e">CACHE_FLAG_UNKNOWN</a>, expiry = iaxdefaultdpcache, x, <a class="code" href="pbx__lua_8c.html#a01d4c61c8065333033ddb5325bfd2032">matchmore</a> = 0;
<a name="l07983"></a>07983    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l07984"></a>07984    
<a name="l07985"></a>07985    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>)
<a name="l07986"></a>07986       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exten, ies-&gt;<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, <span class="keyword">sizeof</span>(exten));
<a name="l07987"></a>07987    
<a name="l07988"></a>07988    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a99983189eaa20f95b80f8aa3a53879b1">dpstatus</a> &amp; <a class="code" href="iax2_8h.html#af7ede4eff590f377b386f3232ab3f144">IAX_DPSTATUS_EXISTS</a>)
<a name="l07989"></a>07989       status = <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a237ba33c07f39880a6da1134630be695">CACHE_FLAG_EXISTS</a>;
<a name="l07990"></a>07990    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a99983189eaa20f95b80f8aa3a53879b1">dpstatus</a> &amp; <a class="code" href="iax2_8h.html#a0daa7f414b8d8032c47ddb031ac45850">IAX_DPSTATUS_CANEXIST</a>)
<a name="l07991"></a>07991       status = <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a9cc184231f4419e681d6de9ca43df81a">CACHE_FLAG_CANEXIST</a>;
<a name="l07992"></a>07992    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a99983189eaa20f95b80f8aa3a53879b1">dpstatus</a> &amp; <a class="code" href="iax2_8h.html#a4cd8441d7cf40a0250c819a032ad4b30">IAX_DPSTATUS_NONEXISTENT</a>)
<a name="l07993"></a>07993       status = <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493adfc168b6cdf09223dad610c65b04c19e">CACHE_FLAG_NONEXISTENT</a>;
<a name="l07994"></a>07994 
<a name="l07995"></a>07995    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>)
<a name="l07996"></a>07996       expiry = ies-&gt;<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>;
<a name="l07997"></a>07997    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a99983189eaa20f95b80f8aa3a53879b1">dpstatus</a> &amp; <a class="code" href="iax2_8h.html#aab7cd9d75d476323e0131c17687065d9">IAX_DPSTATUS_MATCHMORE</a>)
<a name="l07998"></a>07998       matchmore = <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a497c2d7c7e5e120d0f497fac309d65c5">CACHE_FLAG_MATCHMORE</a>;
<a name="l07999"></a>07999    
<a name="l08000"></a>08000    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l08001"></a>08001    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;dpcache, dp, peer_list) {
<a name="l08002"></a>08002       <span class="keywordflow">if</span> (strcmp(dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>, exten))
<a name="l08003"></a>08003          <span class="keywordflow">continue</span>;
<a name="l08004"></a>08004       <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(peer_list);
<a name="l08005"></a>08005       dp-&gt;<a class="code" href="structiax2__dpcache.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = 0;
<a name="l08006"></a>08006       dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a>.tv_sec = dp-&gt;<a class="code" href="structiax2__dpcache.html#a9192c26844abf50c80ad5803b710a904">orig</a>.tv_sec + expiry;
<a name="l08007"></a>08007       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>) {
<a name="l08008"></a>08008          dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp;= ~<a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>;
<a name="l08009"></a>08009          dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> |= status;
<a name="l08010"></a>08010          dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> |= matchmore;
<a name="l08011"></a>08011       }
<a name="l08012"></a>08012       <span class="comment">/* Wake up waiters */</span>
<a name="l08013"></a>08013       <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>); x++) {
<a name="l08014"></a>08014          <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] &gt; -1) {
<a name="l08015"></a>08015             <span class="keywordflow">if</span> (write(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x], <span class="stringliteral">&quot;asdf&quot;</span>, 4) &lt; 0) {
<a name="l08016"></a>08016             }
<a name="l08017"></a>08017          }
<a name="l08018"></a>08018       }
<a name="l08019"></a>08019    }
<a name="l08020"></a>08020    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l08021"></a>08021    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l08022"></a>08022 
<a name="l08023"></a>08023    <span class="keywordflow">return</span> 0;
<a name="l08024"></a>08024 }
<a name="l08025"></a>08025 
<a name="l08026"></a><a class="code" href="chan__iax2_8c.html#a3c65d589a044ac487e309ee555f93759">08026</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3c65d589a044ac487e309ee555f93759">complete_transfer</a>(<span class="keywordtype">int</span> <a class="code" href="structiax2__dpcache.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies)
<a name="l08027"></a>08027 {
<a name="l08028"></a>08028    <span class="keywordtype">int</span> peercallno = 0;
<a name="l08029"></a>08029    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno];
<a name="l08030"></a>08030    <span class="keyword">struct </span>iax_frame *cur;
<a name="l08031"></a>08031    <a class="code" href="structjb__frame.html">jb_frame</a> frame;
<a name="l08032"></a>08032 
<a name="l08033"></a>08033    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)
<a name="l08034"></a>08034       peercallno = ies-&gt;<a class="code" href="structiax__ies.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l08035"></a>08035 
<a name="l08036"></a>08036    <span class="keywordflow">if</span> (peercallno &lt; 1) {
<a name="l08037"></a>08037       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid transfer request\n&quot;</span>);
<a name="l08038"></a>08038       <span class="keywordflow">return</span> -1;
<a name="l08039"></a>08039    }
<a name="l08040"></a>08040    <a class="code" href="chan__iax2_8c.html#ad175242682b4fbf0e8c54502bf805225">remove_by_transfercallno</a>(pvt);
<a name="l08041"></a>08041    <span class="comment">/* since a transfer has taken place, the address will change.</span>
<a name="l08042"></a>08042 <span class="comment">    * This must be accounted for in the peercnts table.  Remove</span>
<a name="l08043"></a>08043 <span class="comment">    * the old address and add the new one */</span>
<a name="l08044"></a>08044    <a class="code" href="chan__iax2_8c.html#a0145ccaddcb1e5fb2ffd6696b0b679eb">peercnt_remove_by_addr</a>(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l08045"></a>08045    <a class="code" href="chan__iax2_8c.html#a75b0aafb3f20205a7b17c7fbd85e4e44">peercnt_add</a>(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>);
<a name="l08046"></a>08046    <span class="comment">/* now copy over the new address */</span>
<a name="l08047"></a>08047    memcpy(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, &amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>, <span class="keyword">sizeof</span>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l08048"></a>08048    memset(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>, 0, <span class="keyword">sizeof</span>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac4b741da99fae4347378f7fc7bf2c478">transfer</a>));
<a name="l08049"></a>08049    <span class="comment">/* Reset sequence numbers */</span>
<a name="l08050"></a>08050    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> = 0;
<a name="l08051"></a>08051    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a> = 0;
<a name="l08052"></a>08052    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> = 0;
<a name="l08053"></a>08053    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a994263e05f34cf3e146bd54903b7a053">aseqno</a> = 0;
<a name="l08054"></a>08054 
<a name="l08055"></a>08055    <span class="keywordflow">if</span> (pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l08056"></a>08056       <a class="code" href="chan__iax2_8c.html#ae48d962bcb33faf6f14966b39668d439">remove_by_peercallno</a>(pvt);
<a name="l08057"></a>08057    }
<a name="l08058"></a>08058    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> = peercallno;
<a name="l08059"></a>08059    <span class="comment">/*this is where the transfering call swiches hash tables */</span>
<a name="l08060"></a>08060    <a class="code" href="chan__iax2_8c.html#aa7e2b9897bb7bc4e4cb32cf763f37527">store_by_peercallno</a>(pvt);
<a name="l08061"></a>08061    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a049e8add4a22f1065570f0b66067b22f">TRANSFER_NONE</a>;
<a name="l08062"></a>08062    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a651f52e68c435d2cd74e0a6ee9f018f0">svoiceformat</a> = -1;
<a name="l08063"></a>08063    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a> = 0;
<a name="l08064"></a>08064    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a2cd6784c5cdb13e5ff845fab09d51593">svideoformat</a> = -1;
<a name="l08065"></a>08065    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a3592e144b79a8ac41ec04e9d7fd4423d">videoformat</a> = 0;
<a name="l08066"></a>08066    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a> = 0;
<a name="l08067"></a>08067    memset(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, 0, <span class="keyword">sizeof</span>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>));
<a name="l08068"></a>08068    memset(&amp;pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>, 0, <span class="keyword">sizeof</span>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a993a1cd0d0dc032977af27750c15ef07">offset</a>));
<a name="l08069"></a>08069    <span class="comment">/* reset jitterbuffer */</span>
<a name="l08070"></a>08070    <span class="keywordflow">while</span>(<a class="code" href="jitterbuf_8h.html#aaca01cea1cbcba683ca6d5b0bc009666" title="unconditionally get frames from jitterbuf until empty">jb_getall</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>,&amp;frame) == <a class="code" href="jitterbuf_8h.html#ad8d0ce8a0ebfabfe77a56b17b2d154f5abcbf2631f2f32ca1af2a49ff82bebaec">JB_OK</a>)
<a name="l08071"></a>08071       <a class="code" href="chan__iax2_8c.html#af96f33cbb9ac6fafee981c452a99bb39">iax2_frame_free</a>(frame.<a class="code" href="structjb__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l08072"></a>08072    <a class="code" href="jitterbuf_8h.html#a2c9efa9222ff9d7324a06c4a21b5ef72" title="reset jitterbuf">jb_reset</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>);
<a name="l08073"></a>08073    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ad8e99943b4e40b52e9ecde280a212b37">lag</a> = 0;
<a name="l08074"></a>08074    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> = 0;
<a name="l08075"></a>08075    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a24176fd6a7fbbe8cd57ef8e86f7d4446">lastsent</a> = 0;
<a name="l08076"></a>08076    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a38ee9486d8a0835d85dcc803119504b7">nextpred</a> = 0;
<a name="l08077"></a>08077    pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a> = <a class="code" href="chan__iax2_8c.html#aa3f7ad7d609f71fde68e79f9a7a478f2">DEFAULT_RETRY_TIME</a>;
<a name="l08078"></a>08078    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l08079"></a>08079    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l08080"></a>08080       <span class="comment">/* We must cancel any packets that would have been transmitted</span>
<a name="l08081"></a>08081 <span class="comment">         because now we&apos;re talking to someone new.  It&apos;s okay, they</span>
<a name="l08082"></a>08082 <span class="comment">         were transmitted to someone that didn&apos;t care anyway. */</span>
<a name="l08083"></a>08083       <span class="keywordflow">if</span> (callno == cur-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) 
<a name="l08084"></a>08084          cur-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l08085"></a>08085    }
<a name="l08086"></a>08086    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l08087"></a>08087    <span class="keywordflow">return</span> 0; 
<a name="l08088"></a>08088 }
<a name="l08089"></a>08089 <span class="comment"></span>
<a name="l08090"></a>08090 <span class="comment">/*! \brief Acknowledgment received for OUR registration */</span>
<a name="l08091"></a><a class="code" href="chan__iax2_8c.html#a514d9067b96525fee83cb845f5bf79e9">08091</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a514d9067b96525fee83cb845f5bf79e9" title="Acknowledgment received for OUR registration.">iax2_ack_registry</a>(<span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)
<a name="l08092"></a>08092 {
<a name="l08093"></a>08093    <span class="keyword">struct </span>iax2_registry *reg;
<a name="l08094"></a>08094    <span class="comment">/* Start pessimistic */</span>
<a name="l08095"></a>08095    <span class="keywordtype">char</span> peer[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08096"></a>08096    <span class="keywordtype">char</span> msgstatus[60];
<a name="l08097"></a>08097    <span class="keywordtype">int</span> <a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> = 60;
<a name="l08098"></a>08098    <span class="keywordtype">char</span> ourip[256] = <span class="stringliteral">&quot;&lt;Unspecified&gt;&quot;</span>;
<a name="l08099"></a>08099    <span class="keyword">struct </span>sockaddr_in oldus;
<a name="l08100"></a>08100    <span class="keyword">struct </span>sockaddr_in us;
<a name="l08101"></a>08101    <span class="keywordtype">int</span> oldmsgs;
<a name="l08102"></a>08102 
<a name="l08103"></a>08103    memset(&amp;us, 0, <span class="keyword">sizeof</span>(us));
<a name="l08104"></a>08104    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#ae853c4fd16ea01a56ca46a7a6e83cd52">apparent_addr</a>)
<a name="l08105"></a>08105       memmove(&amp;us, ies-&gt;<a class="code" href="structiax__ies.html#ae853c4fd16ea01a56ca46a7a6e83cd52">apparent_addr</a>, <span class="keyword">sizeof</span>(us));
<a name="l08106"></a>08106    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l08107"></a>08107       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(peer, ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, <span class="keyword">sizeof</span>(peer));
<a name="l08108"></a>08108    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>)
<a name="l08109"></a>08109       refresh = ies-&gt;<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>;
<a name="l08110"></a>08110    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a503b1570b953edc1cbff315709acf943">calling_number</a>) {
<a name="l08111"></a>08111       <span class="comment">/* We don&apos;t do anything with it really, but maybe we should */</span>
<a name="l08112"></a>08112    }
<a name="l08113"></a>08113    reg = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>;
<a name="l08114"></a>08114    <span class="keywordflow">if</span> (!reg) {
<a name="l08115"></a>08115       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Registry acknowledge on unknown registry &apos;%s&apos;\n&quot;</span>, peer);
<a name="l08116"></a>08116       <span class="keywordflow">return</span> -1;
<a name="l08117"></a>08117    }
<a name="l08118"></a>08118    memcpy(&amp;oldus, &amp;reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>, <span class="keyword">sizeof</span>(oldus));
<a name="l08119"></a>08119    oldmsgs = reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a>;
<a name="l08120"></a>08120    <span class="keywordflow">if</span> (<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin)) {
<a name="l08121"></a>08121       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Received unsolicited registry ack from &apos;%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l08122"></a>08122       <span class="keywordflow">return</span> -1;
<a name="l08123"></a>08123    }
<a name="l08124"></a>08124    memcpy(&amp;reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>, &amp;us, <span class="keyword">sizeof</span>(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>));
<a name="l08125"></a>08125    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a7060b2731bf71abb7fd8b9b1ebbb01c9">msgcount</a> &gt;= 0)
<a name="l08126"></a>08126       reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> = ies-&gt;<a class="code" href="structiax__ies.html#a7060b2731bf71abb7fd8b9b1ebbb01c9">msgcount</a> &amp; 0xffff;      <span class="comment">/* only low 16 bits are used in the transmission of the IE */</span>
<a name="l08127"></a>08127    <span class="comment">/* always refresh the registration at the interval requested by the server</span>
<a name="l08128"></a>08128 <span class="comment">      we are registering to</span>
<a name="l08129"></a>08129 <span class="comment">   */</span>
<a name="l08130"></a>08130    reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> = refresh;
<a name="l08131"></a>08131    reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a>, sched, 
<a name="l08132"></a>08132       (5 * reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> / 6) * 1000, <a class="code" href="chan__iax2_8c.html#af7b172cae2a4b98c38859794fae4f94b">iax2_do_register_s</a>, reg);
<a name="l08133"></a>08133    <span class="keywordflow">if</span> (<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;oldus, &amp;reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>) || (reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> != oldmsgs)) {
<a name="l08134"></a>08134          <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> &gt; 255)
<a name="l08135"></a>08135             snprintf(msgstatus, <span class="keyword">sizeof</span>(msgstatus), <span class="stringliteral">&quot; with %d new and %d old messages waiting&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> &amp; 0xff, reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> &gt;&gt; 8);
<a name="l08136"></a>08136          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> &gt; 1)
<a name="l08137"></a>08137             snprintf(msgstatus, <span class="keyword">sizeof</span>(msgstatus), <span class="stringliteral">&quot; with %d new messages waiting\n&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a>);
<a name="l08138"></a>08138          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#ab06945018d791b0afb27dfe69ea0663e">messages</a> &gt; 0)
<a name="l08139"></a>08139             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(msgstatus, <span class="stringliteral">&quot; with 1 new message waiting\n&quot;</span>, <span class="keyword">sizeof</span>(msgstatus));
<a name="l08140"></a>08140          <span class="keywordflow">else</span>
<a name="l08141"></a>08141             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(msgstatus, <span class="stringliteral">&quot; with no messages waiting\n&quot;</span>, <span class="keyword">sizeof</span>(msgstatus));
<a name="l08142"></a>08142          snprintf(ourip, <span class="keyword">sizeof</span>(ourip), <span class="stringliteral">&quot;%s:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr), ntohs(reg-&gt;<a class="code" href="structiax2__registry.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_port));
<a name="l08143"></a>08143       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Registered IAX2 to &apos;%s&apos;, who sees us as %s%s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ourip, msgstatus);
<a name="l08144"></a>08144       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;Registry&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nDomain: %s\r\nStatus: Registered\r\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l08145"></a>08145    }
<a name="l08146"></a>08146    reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a> = <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a5cb994f5165979d5e32dff13aaff9c53">REG_STATE_REGISTERED</a>;
<a name="l08147"></a>08147    <span class="keywordflow">return</span> 0;
<a name="l08148"></a>08148 }
<a name="l08149"></a>08149 
<a name="l08150"></a><a class="code" href="chan__iax2_8c.html#a9d8c52316b46ea87913cc893cd2fc390">08150</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9d8c52316b46ea87913cc893cd2fc390">iax2_append_register</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *username,
<a name="l08151"></a>08151    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *porta)
<a name="l08152"></a>08152 {
<a name="l08153"></a>08153    <span class="keyword">struct </span>iax2_registry *reg;
<a name="l08154"></a>08154 
<a name="l08155"></a>08155    <span class="keywordflow">if</span> (!(reg = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*reg))))
<a name="l08156"></a>08156       <span class="keywordflow">return</span> -1;
<a name="l08157"></a>08157 
<a name="l08158"></a>08158    <span class="keywordflow">if</span> (<a class="code" href="dnsmgr_8h.html#a281a512e7dbfb3ca5875c1a4d08ac0d6" title="Allocate and initialize a DNS manager entry.">ast_dnsmgr_lookup</a>(hostname, &amp;reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, &amp;reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>, srvlookup ? <span class="stringliteral">&quot;_iax._udp&quot;</span> : NULL) &lt; 0) {
<a name="l08159"></a>08159       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(reg);
<a name="l08160"></a>08160       <span class="keywordflow">return</span> -1;
<a name="l08161"></a>08161    }
<a name="l08162"></a>08162 
<a name="l08163"></a>08163    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, username, <span class="keyword">sizeof</span>(reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));
<a name="l08164"></a>08164 
<a name="l08165"></a>08165    <span class="keywordflow">if</span> (secret)
<a name="l08166"></a>08166       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(reg-&gt;<a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>, secret, <span class="keyword">sizeof</span>(reg-&gt;<a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>));
<a name="l08167"></a>08167 
<a name="l08168"></a>08168    reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l08169"></a>08169    reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> = <a class="code" href="iax2_8h.html#a5fc5c0b246090e6ebf9245897d979e21">IAX_DEFAULT_REG_EXPIRE</a>;
<a name="l08170"></a>08170    reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_family = AF_INET;
<a name="l08171"></a>08171    reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = porta ? htons(atoi(porta)) : htons(<a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>);
<a name="l08172"></a>08172 
<a name="l08173"></a>08173    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;registrations);
<a name="l08174"></a>08174    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;registrations, reg, entry);
<a name="l08175"></a>08175    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;registrations);
<a name="l08176"></a>08176    
<a name="l08177"></a>08177    <span class="keywordflow">return</span> 0;
<a name="l08178"></a>08178 }
<a name="l08179"></a>08179 
<a name="l08180"></a><a class="code" href="chan__iax2_8c.html#a9a7339b1691a326f37bad5fd3ffe5698">08180</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a9a7339b1691a326f37bad5fd3ffe5698">iax2_register</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *value, <span class="keywordtype">int</span> lineno)
<a name="l08181"></a>08181 {
<a name="l08182"></a>08182    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a>[256];
<a name="l08183"></a>08183    <span class="keywordtype">char</span> *username, *<a class="code" href="logger_8c.html#af31254e3111773fe1dc68e8dc13df2fe">hostname</a>, *<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>;
<a name="l08184"></a>08184    <span class="keywordtype">char</span> *porta;
<a name="l08185"></a>08185    <span class="keywordtype">char</span> *stringp=NULL;
<a name="l08186"></a>08186    
<a name="l08187"></a>08187    <span class="keywordflow">if</span> (!value)
<a name="l08188"></a>08188       <span class="keywordflow">return</span> -1;
<a name="l08189"></a>08189 
<a name="l08190"></a>08190    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(copy, value, <span class="keyword">sizeof</span>(copy));
<a name="l08191"></a>08191    stringp = copy;
<a name="l08192"></a>08192    username = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l08193"></a>08193    hostname = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l08194"></a>08194 
<a name="l08195"></a>08195    <span class="keywordflow">if</span> (!hostname) {
<a name="l08196"></a>08196       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Format for registration is user[:secret]@host[:port] at line %d\n&quot;</span>, lineno);
<a name="l08197"></a>08197       <span class="keywordflow">return</span> -1;
<a name="l08198"></a>08198    }
<a name="l08199"></a>08199 
<a name="l08200"></a>08200    stringp = username;
<a name="l08201"></a>08201    username = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l08202"></a>08202    secret = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l08203"></a>08203    stringp = hostname;
<a name="l08204"></a>08204    hostname = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l08205"></a>08205    porta = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l08206"></a>08206    
<a name="l08207"></a>08207    <span class="keywordflow">if</span> (porta &amp;&amp; !atoi(porta)) {
<a name="l08208"></a>08208       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s is not a valid port number at line %d\n&quot;</span>, porta, lineno);
<a name="l08209"></a>08209       <span class="keywordflow">return</span> -1;
<a name="l08210"></a>08210    }
<a name="l08211"></a>08211 
<a name="l08212"></a>08212    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a9d8c52316b46ea87913cc893cd2fc390">iax2_append_register</a>(hostname, username, secret, porta);
<a name="l08213"></a>08213 }
<a name="l08214"></a>08214 
<a name="l08215"></a>08215 
<a name="l08216"></a><a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">08216</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">register_peer_exten</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer, <span class="keywordtype">int</span> onoff)
<a name="l08217"></a>08217 {
<a name="l08218"></a>08218    <span class="keywordtype">char</span> multi[256];
<a name="l08219"></a>08219    <span class="keywordtype">char</span> *stringp, *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>;
<a name="l08220"></a>08220    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(regcontext)) {
<a name="l08221"></a>08221       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(multi, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(peer-&gt;regexten, peer-&gt;name), <span class="keyword">sizeof</span>(multi));
<a name="l08222"></a>08222       stringp = multi;
<a name="l08223"></a>08223       <span class="keywordflow">while</span>((ext = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l08224"></a>08224          <span class="keywordflow">if</span> (onoff) {
<a name="l08225"></a>08225             <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, regcontext, ext, 1, NULL))
<a name="l08226"></a>08226                <a class="code" href="pbx_8h.html#a07176e8d314eb68b3b50279fafa11390" title="Add and extension to an extension context.">ast_add_extension</a>(regcontext, 1, ext, 1, NULL, NULL,
<a name="l08227"></a>08227                        <span class="stringliteral">&quot;Noop&quot;</span>, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(peer-&gt;name), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <span class="stringliteral">&quot;IAX2&quot;</span>);
<a name="l08228"></a>08228          } <span class="keywordflow">else</span>
<a name="l08229"></a>08229             <a class="code" href="pbx_8h.html#a721c6ba091102f155a586e09b2a526bf" title="Simply remove extension from context.">ast_context_remove_extension</a>(regcontext, ext, 1, NULL);
<a name="l08230"></a>08230       }
<a name="l08231"></a>08231    }
<a name="l08232"></a>08232 }
<a name="l08233"></a>08233 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a55c82d81ce37ebe5125d5a017c12b5ac">prune_peers</a>(<span class="keywordtype">void</span>);
<a name="l08234"></a>08234 
<a name="l08235"></a><a class="code" href="chan__iax2_8c.html#a9bc5565f824594fb78b237f40e83d2de">08235</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a9bc5565f824594fb78b237f40e83d2de">unlink_peer</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer)
<a name="l08236"></a>08236 {
<a name="l08237"></a>08237    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> &gt; -1) {
<a name="l08238"></a>08238       <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>)) {
<a name="l08239"></a>08239          peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l08240"></a>08240          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l08241"></a>08241       }
<a name="l08242"></a>08242    }
<a name="l08243"></a>08243 
<a name="l08244"></a>08244    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> &gt; -1) {
<a name="l08245"></a>08245       <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a>)) {
<a name="l08246"></a>08246          peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l08247"></a>08247          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l08248"></a>08248       }
<a name="l08249"></a>08249    }
<a name="l08250"></a>08250 
<a name="l08251"></a>08251    <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(peers, peer);
<a name="l08252"></a>08252 }
<a name="l08253"></a>08253 
<a name="l08254"></a><a class="code" href="chan__iax2_8c.html#a53a0ea95e2fb968aa842951bf225506c">08254</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a53a0ea95e2fb968aa842951bf225506c">__expire_registry</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l08255"></a>08255 {
<a name="l08256"></a>08256    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = (<span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *) data;
<a name="l08257"></a>08257 
<a name="l08258"></a>08258    <span class="keywordflow">if</span> (!peer)
<a name="l08259"></a>08259       <span class="keywordflow">return</span>;
<a name="l08260"></a>08260 
<a name="l08261"></a>08261    peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l08262"></a>08262 
<a name="l08263"></a>08263    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Expiring registration for peer &apos;%s&apos;\n&quot;</span>, peer-&gt;name);
<a name="l08264"></a>08264    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba3b832a927807f0e518e9e18fee76d3a6">IAX_RTUPDATE</a>) &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)))
<a name="l08265"></a>08265       <a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">realtime_update_peer</a>(peer-&gt;name, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, 0);
<a name="l08266"></a>08266    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;PeerStatus&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nPeer: IAX2/%s\r\nPeerStatus: Unregistered\r\nCause: Expired\r\n&quot;</span>, peer-&gt;name);
<a name="l08267"></a>08267    <span class="comment">/* modify entry in peercnts table as _not_ registered */</span>
<a name="l08268"></a>08268    <a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">peercnt_modify</a>(0, 0, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l08269"></a>08269    <span class="comment">/* Reset the address */</span>
<a name="l08270"></a>08270    memset(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, 0, <span class="keyword">sizeof</span>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l08271"></a>08271    <span class="comment">/* Reset expiry value */</span>
<a name="l08272"></a>08272    peer-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = min_reg_expire;
<a name="l08273"></a>08273    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>))
<a name="l08274"></a>08274       <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(<span class="stringliteral">&quot;IAX/Registry&quot;</span>, peer-&gt;name);
<a name="l08275"></a>08275    <a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">register_peer_exten</a>(peer, 0);
<a name="l08276"></a>08276    <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, peer-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l08277"></a>08277    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>)
<a name="l08278"></a>08278       <a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>(peer-&gt;name, 0);
<a name="l08279"></a>08279 
<a name="l08280"></a>08280    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a>))
<a name="l08281"></a>08281       <a class="code" href="chan__iax2_8c.html#a9bc5565f824594fb78b237f40e83d2de">unlink_peer</a>(peer);
<a name="l08282"></a>08282 
<a name="l08283"></a>08283    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l08284"></a>08284 }
<a name="l08285"></a>08285 
<a name="l08286"></a><a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">08286</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l08287"></a>08287 {
<a name="l08288"></a>08288 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l08289"></a>08289 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a53a0ea95e2fb968aa842951bf225506c">__expire_registry</a>, data))
<a name="l08290"></a>08290 <span class="preprocessor">#endif      </span>
<a name="l08291"></a>08291 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#a53a0ea95e2fb968aa842951bf225506c">__expire_registry</a>(data);
<a name="l08292"></a>08292    <span class="keywordflow">return</span> 0;
<a name="l08293"></a>08293 }
<a name="l08294"></a>08294 
<a name="l08295"></a>08295 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer, <span class="keywordtype">int</span> heldcall);
<a name="l08296"></a>08296 
<a name="l08297"></a><a class="code" href="chan__iax2_8c.html#a53f291d9224d73701f3a2a097d2457a7">08297</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a53f291d9224d73701f3a2a097d2457a7">reg_source_db</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *p)
<a name="l08298"></a>08298 {
<a name="l08299"></a>08299    <span class="keywordtype">char</span> data[80];
<a name="l08300"></a>08300    <span class="keyword">struct </span>in_addr in;
<a name="l08301"></a>08301    <span class="keywordtype">char</span> *c, *d;
<a name="l08302"></a>08302    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>) &amp;&amp; (!<a class="code" href="astdb_8h.html#a48033762bf6ab77f15dd72277a1fe7fa" title="Get key value specified by family/key.">ast_db_get</a>(<span class="stringliteral">&quot;IAX/Registry&quot;</span>, p-&gt;name, data, <span class="keyword">sizeof</span>(data)))) {
<a name="l08303"></a>08303       c = strchr(data, <span class="charliteral">&apos;:&apos;</span>);
<a name="l08304"></a>08304       <span class="keywordflow">if</span> (c) {
<a name="l08305"></a>08305          *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08306"></a>08306          c++;
<a name="l08307"></a>08307          <span class="keywordflow">if</span> (inet_aton(data, &amp;in)) {
<a name="l08308"></a>08308             d = strchr(c, <span class="charliteral">&apos;:&apos;</span>);
<a name="l08309"></a>08309             <span class="keywordflow">if</span> (d) {
<a name="l08310"></a>08310                *d = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08311"></a>08311                d++;
<a name="l08312"></a>08312                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Seeding &apos;%s&apos; at %s:%d for %d\n&quot;</span>, p-&gt;name,
<a name="l08313"></a>08313                   <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(in), atoi(c), atoi(d));
<a name="l08314"></a>08314                <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(p, 0);
<a name="l08315"></a>08315                p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = atoi(d);
<a name="l08316"></a>08316                memset(&amp;p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, 0, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l08317"></a>08317                p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_family = AF_INET;
<a name="l08318"></a>08318                p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr = in;
<a name="l08319"></a>08319                p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = htons(atoi(c));
<a name="l08320"></a>08320                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> &gt; -1) {
<a name="l08321"></a>08321                   <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>)) {
<a name="l08322"></a>08322                      p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l08323"></a>08323                      <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l08324"></a>08324                   }
<a name="l08325"></a>08325                }
<a name="l08326"></a>08326                <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, p-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l08327"></a>08327                p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, (p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> + 10) * 1000, <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(p));
<a name="l08328"></a>08328                <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> == -1)
<a name="l08329"></a>08329                   <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l08330"></a>08330                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>)
<a name="l08331"></a>08331                   <a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>(p-&gt;name, 1);
<a name="l08332"></a>08332                <a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">register_peer_exten</a>(p, 1);
<a name="l08333"></a>08333             }              
<a name="l08334"></a>08334                
<a name="l08335"></a>08335          }
<a name="l08336"></a>08336       }
<a name="l08337"></a>08337    }
<a name="l08338"></a>08338 }
<a name="l08339"></a>08339 <span class="comment"></span>
<a name="l08340"></a>08340 <span class="comment">/*!</span>
<a name="l08341"></a>08341 <span class="comment"> * \pre iaxsl[callno] is locked</span>
<a name="l08342"></a>08342 <span class="comment"> *</span>
<a name="l08343"></a>08343 <span class="comment"> * \note Since this function calls send_command_final(), the pvt struct for</span>
<a name="l08344"></a>08344 <span class="comment"> *       the given call number may disappear while executing this function.</span>
<a name="l08345"></a>08345 <span class="comment"> */</span>
<a name="l08346"></a><a class="code" href="chan__iax2_8c.html#a0a6e49e6347fca24e527889dca24d78a">08346</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0a6e49e6347fca24e527889dca24d78a">update_registry</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> callno, <span class="keywordtype">char</span> *devtype, <span class="keywordtype">int</span> fd, <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> refresh)
<a name="l08347"></a>08347 {
<a name="l08348"></a>08348    <span class="comment">/* Called from IAX thread only, with proper iaxsl lock */</span>
<a name="l08349"></a>08349    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l08350"></a>08350    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *p;
<a name="l08351"></a>08351    <span class="keywordtype">int</span> msgcount;
<a name="l08352"></a>08352    <span class="keywordtype">char</span> data[80];
<a name="l08353"></a>08353    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l08354"></a>08354    <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_name;
<a name="l08355"></a>08355    <span class="keywordtype">int</span> res = -1;
<a name="l08356"></a>08356 
<a name="l08357"></a>08357    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l08358"></a>08358 
<a name="l08359"></a>08359    peer_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;peer);
<a name="l08360"></a>08360 
<a name="l08361"></a>08361    <span class="comment">/* SLD: Another find_peer call during registration - this time when we are really updating our registration */</span>
<a name="l08362"></a>08362    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08363"></a>08363    <span class="keywordflow">if</span> (!(p = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(peer_name, 1))) {
<a name="l08364"></a>08364       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08365"></a>08365       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such peer &apos;%s&apos;\n&quot;</span>, peer_name);
<a name="l08366"></a>08366       <span class="keywordflow">return</span> -1;
<a name="l08367"></a>08367    }
<a name="l08368"></a>08368    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08369"></a>08369    <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])
<a name="l08370"></a>08370       <span class="keywordflow">goto</span> return_unref;
<a name="l08371"></a>08371 
<a name="l08372"></a>08372    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba3b832a927807f0e518e9e18fee76d3a6">IAX_RTUPDATE</a>) &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>))) {
<a name="l08373"></a>08373       <span class="keywordflow">if</span> (sin-&gt;sin_addr.s_addr) {
<a name="l08374"></a>08374          time_t nowtime;
<a name="l08375"></a>08375          time(&amp;nowtime);
<a name="l08376"></a>08376          <a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">realtime_update_peer</a>(peer_name, sin, nowtime);
<a name="l08377"></a>08377       } <span class="keywordflow">else</span> {
<a name="l08378"></a>08378          <a class="code" href="chan__iax2_8c.html#a76678eae3ee4ffffb43acc4f688e8222">realtime_update_peer</a>(peer_name, sin, 0);
<a name="l08379"></a>08379       }
<a name="l08380"></a>08380    }
<a name="l08381"></a>08381    <span class="keywordflow">if</span> (<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin)) {
<a name="l08382"></a>08382       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>)
<a name="l08383"></a>08383          <a class="code" href="chan__iax2_8c.html#a16b8efc4d645b1094ff5b5b0de98a3c4">iax2_regfunk</a>(p-&gt;name, 1);
<a name="l08384"></a>08384 
<a name="l08385"></a>08385       <span class="comment">/* modify entry in peercnts table as _not_ registered */</span>
<a name="l08386"></a>08386       <a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">peercnt_modify</a>(0, 0, &amp;p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l08387"></a>08387 
<a name="l08388"></a>08388       <span class="comment">/* Stash the IP address from which they registered */</span>
<a name="l08389"></a>08389       memcpy(&amp;p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin, <span class="keyword">sizeof</span>(p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>));
<a name="l08390"></a>08390 
<a name="l08391"></a>08391       snprintf(data, <span class="keyword">sizeof</span>(data), <span class="stringliteral">&quot;%s:%d:%d&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port), p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a>);
<a name="l08392"></a>08392       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>) &amp;&amp; sin-&gt;sin_addr.s_addr) {
<a name="l08393"></a>08393          <a class="code" href="astdb_8h.html#a0f14f6bff4f412c88b50aba34d3a5e35" title="Store value addressed by family/key.">ast_db_put</a>(<span class="stringliteral">&quot;IAX/Registry&quot;</span>, p-&gt;name, data);
<a name="l08394"></a>08394          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Registered IAX2 &apos;%s&apos; (%s) at %s:%d\n&quot;</span>, p-&gt;name,
<a name="l08395"></a>08395                    <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>) ? <span class="stringliteral">&quot;AUTHENTICATED&quot;</span> : <span class="stringliteral">&quot;UNAUTHENTICATED&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port));
<a name="l08396"></a>08396          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;PeerStatus&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nPeer: IAX2/%s\r\nPeerStatus: Registered\r\n&quot;</span>, p-&gt;name);
<a name="l08397"></a>08397          <a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">register_peer_exten</a>(p, 1);
<a name="l08398"></a>08398          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, p-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l08399"></a>08399       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba4d90091b89475ab4a0124bb6fed30594">IAX_TEMPONLY</a>)) {
<a name="l08400"></a>08400          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Unregistered IAX2 &apos;%s&apos; (%s)\n&quot;</span>, p-&gt;name,
<a name="l08401"></a>08401                    <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>) ? <span class="stringliteral">&quot;AUTHENTICATED&quot;</span> : <span class="stringliteral">&quot;UNAUTHENTICATED&quot;</span>);
<a name="l08402"></a>08402          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;PeerStatus&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nPeer: IAX2/%s\r\nPeerStatus: Unregistered\r\n&quot;</span>, p-&gt;name);
<a name="l08403"></a>08403          <a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">register_peer_exten</a>(p, 0);
<a name="l08404"></a>08404          <a class="code" href="astdb_8h.html#a71e8d5ab1757b184683a99125d1c8160" title="Delete entry in astdb.">ast_db_del</a>(<span class="stringliteral">&quot;IAX/Registry&quot;</span>, p-&gt;name);
<a name="l08405"></a>08405          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, p-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l08406"></a>08406       }
<a name="l08407"></a>08407       <span class="comment">/* Update the host */</span>
<a name="l08408"></a>08408       <span class="comment">/* Verify that the host is really there */</span>
<a name="l08409"></a>08409       <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(p, callno);
<a name="l08410"></a>08410    }
<a name="l08411"></a>08411 
<a name="l08412"></a>08412    <span class="comment">/* modify entry in peercnts table as registered */</span>
<a name="l08413"></a>08413    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a>) {
<a name="l08414"></a>08414       <a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">peercnt_modify</a>(1, p-&gt;<a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a>, &amp;p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l08415"></a>08415    }
<a name="l08416"></a>08416 
<a name="l08417"></a>08417    <span class="comment">/* Make sure our call still exists, an INVAL at the right point may make it go away */</span>
<a name="l08418"></a>08418    <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l08419"></a>08419       res = -1;
<a name="l08420"></a>08420       <span class="keywordflow">goto</span> return_unref;
<a name="l08421"></a>08421    }
<a name="l08422"></a>08422 
<a name="l08423"></a>08423    <span class="comment">/* Store socket fd */</span>
<a name="l08424"></a>08424    p-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = fd;
<a name="l08425"></a>08425    <span class="comment">/* Setup the expiry */</span>
<a name="l08426"></a>08426    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> &gt; -1) {
<a name="l08427"></a>08427       <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>)) {
<a name="l08428"></a>08428          p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l08429"></a>08429          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l08430"></a>08430       }
<a name="l08431"></a>08431    }
<a name="l08432"></a>08432    <span class="comment">/* treat an unspecified refresh interval as the minimum */</span>
<a name="l08433"></a>08433    <span class="keywordflow">if</span> (!refresh)
<a name="l08434"></a>08434       refresh = min_reg_expire;
<a name="l08435"></a>08435    <span class="keywordflow">if</span> (refresh &gt; max_reg_expire) {
<a name="l08436"></a>08436       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Restricting registration for peer &apos;%s&apos; to %d seconds (requested %d)\n&quot;</span>,
<a name="l08437"></a>08437          p-&gt;name, max_reg_expire, refresh);
<a name="l08438"></a>08438       p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = max_reg_expire;
<a name="l08439"></a>08439    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (refresh &lt; min_reg_expire) {
<a name="l08440"></a>08440       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Restricting registration for peer &apos;%s&apos; to %d seconds (requested %d)\n&quot;</span>,
<a name="l08441"></a>08441          p-&gt;name, min_reg_expire, refresh);
<a name="l08442"></a>08442       p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = min_reg_expire;
<a name="l08443"></a>08443    } <span class="keywordflow">else</span> {
<a name="l08444"></a>08444       p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = refresh;
<a name="l08445"></a>08445    }
<a name="l08446"></a>08446    <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> &amp;&amp; sin-&gt;sin_addr.s_addr) {
<a name="l08447"></a>08447       p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, (p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> + 10) * 1000, <a class="code" href="chan__iax2_8c.html#af90604ef409fc788465990b714a113b7">expire_registry</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(p));
<a name="l08448"></a>08448       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> == -1)
<a name="l08449"></a>08449          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l08450"></a>08450    }
<a name="l08451"></a>08451    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, p-&gt;name);
<a name="l08452"></a>08452    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#a1d106f79be9f6e388fd852185a62a67f">IAX_IE_DATETIME</a>, <a class="code" href="chan__iax2_8c.html#af18b4202de182e398645dee3a08b9e6f">iax2_datetime</a>(p-&gt;zonetag));
<a name="l08453"></a>08453    <span class="keywordflow">if</span> (sin-&gt;sin_addr.s_addr) {
<a name="l08454"></a>08454       <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#ac3c0ea95efa7bab2684e56443fc94d0a">IAX_IE_REFRESH</a>, p-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a>);
<a name="l08455"></a>08455       <a class="code" href="iax2-parser_8c.html#a3f0c77bd0c7403e0ca0340006e1260d7">iax_ie_append_addr</a>(&amp;ied, <a class="code" href="iax2_8h.html#ac0ffc43863d8212c5ddfe5ee71bbac9a">IAX_IE_APPARENT_ADDR</a>, &amp;p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l08456"></a>08456       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;mailbox)) {
<a name="l08457"></a>08457          <span class="keyword">struct </span><a class="code" href="structast__event.html" title="An event.">ast_event</a> *event;
<a name="l08458"></a>08458          <span class="keywordtype">int</span> <span class="keyword">new</span>, old;
<a name="l08459"></a>08459          <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l08460"></a>08460 
<a name="l08461"></a>08461          context = mailbox = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(p-&gt;mailbox);
<a name="l08462"></a>08462          <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l08463"></a>08463          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l08464"></a>08464             context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l08465"></a>08465 
<a name="l08466"></a>08466          <span class="keyword">event</span> = <a class="code" href="event_8h.html#a419385710c135873656b047df8f72e7e" title="Retrieve an event from the cache.">ast_event_get_cached</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>,
<a name="l08467"></a>08467             <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aae6c80d8f4c6ab3cee006ed57d874710" title="Mailbox name.">AST_EVENT_IE_MAILBOX</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, mailbox,
<a name="l08468"></a>08468             <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a25764e2fb734ccb3ee1f6f41caba5318" title="Context IE Used by AST_EVENT_MWI Payload type: str.">AST_EVENT_IE_CONTEXT</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, context,
<a name="l08469"></a>08469             <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l08470"></a>08470          <span class="keywordflow">if</span> (event) {
<a name="l08471"></a>08471             <span class="keyword">new</span> = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aff40847f0450f17c96e94e721aee38f2" title="Number of new messages Used by: AST_EVENT_MWI Payload type: UINT.">AST_EVENT_IE_NEWMSGS</a>);
<a name="l08472"></a>08472             old = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aeda30786b0dfece37a9a06b84a653fd9" title="Number of Used by: AST_EVENT_MWI Payload type: UINT.">AST_EVENT_IE_OLDMSGS</a>);
<a name="l08473"></a>08473             <a class="code" href="event_8h.html#a50b34e0161630dbbc0880a06eb78ad7a" title="Destroy an event.">ast_event_destroy</a>(event);
<a name="l08474"></a>08474          } <span class="keywordflow">else</span> { <span class="comment">/* Fall back on checking the mailbox directly */</span>
<a name="l08475"></a>08475             <a class="code" href="app_8h.html#a318582ad072d31085d4623e634edf46c" title="Determine number of new/old messages in a mailbox.">ast_app_inboxcount</a>(p-&gt;mailbox, &amp;<span class="keyword">new</span>, &amp;old);
<a name="l08476"></a>08476          }
<a name="l08477"></a>08477 
<a name="l08478"></a>08478          <span class="keywordflow">if</span> (<span class="keyword">new</span> &gt; 255) {
<a name="l08479"></a>08479             <span class="keyword">new</span> = 255;
<a name="l08480"></a>08480          }
<a name="l08481"></a>08481          <span class="keywordflow">if</span> (old &gt; 255) {
<a name="l08482"></a>08482             old = 255;
<a name="l08483"></a>08483          }
<a name="l08484"></a>08484          msgcount = (old &lt;&lt; 8) | <span class="keyword">new</span>;
<a name="l08485"></a>08485 
<a name="l08486"></a>08486          <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#a3a1aee00db812d30993975c0d5ab3728">IAX_IE_MSGCOUNT</a>, msgcount);
<a name="l08487"></a>08487       }
<a name="l08488"></a>08488       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>)) {
<a name="l08489"></a>08489          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a247e96f38f42f791fdd95a78d614dff5">IAX_IE_CALLING_NUMBER</a>, p-&gt;cid_num);
<a name="l08490"></a>08490          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a5d435e4bb28522353ca7937e06e2689c">IAX_IE_CALLING_NAME</a>, p-&gt;cid_name);
<a name="l08491"></a>08491       }
<a name="l08492"></a>08492    }
<a name="l08493"></a>08493    version = <a class="code" href="chan__iax2_8c.html#a3ed1faf02222974de8507cb9536322a1">iax_check_version</a>(devtype);
<a name="l08494"></a>08494    <span class="keywordflow">if</span> (version) 
<a name="l08495"></a>08495       <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#a8bfd7218b8db56daaa02741a45579bcb">IAX_IE_FIRMWAREVER</a>, version);
<a name="l08496"></a>08496 
<a name="l08497"></a>08497    res = 0;
<a name="l08498"></a>08498 
<a name="l08499"></a>08499 return_unref:
<a name="l08500"></a>08500    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l08501"></a>08501 
<a name="l08502"></a>08502    <span class="keywordflow">return</span> res ? res : <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7f307f817f7c28c8f6351d7dfe355c53">IAX_COMMAND_REGACK</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l08503"></a>08503 }
<a name="l08504"></a>08504 
<a name="l08505"></a><a class="code" href="chan__iax2_8c.html#ac7fdb53a5f7683e75dd58703bed9350b">08505</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac7fdb53a5f7683e75dd58703bed9350b">registry_authrequest</a>(<span class="keywordtype">int</span> callno)
<a name="l08506"></a>08506 {
<a name="l08507"></a>08507    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l08508"></a>08508    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *p;
<a name="l08509"></a>08509    <span class="keywordtype">char</span> challenge[10];
<a name="l08510"></a>08510    <span class="keyword">const</span> <span class="keywordtype">char</span> *peer_name;
<a name="l08511"></a>08511    <span class="keywordtype">int</span> sentauthmethod;
<a name="l08512"></a>08512 
<a name="l08513"></a>08513    peer_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;peer);
<a name="l08514"></a>08514 
<a name="l08515"></a>08515    <span class="comment">/* SLD: third call to find_peer in registration */</span>
<a name="l08516"></a>08516    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08517"></a>08517    <span class="keywordflow">if</span> ((p = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(peer_name, 1))) {
<a name="l08518"></a>08518       last_authmethod = p-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>;
<a name="l08519"></a>08519    }
<a name="l08520"></a>08520 
<a name="l08521"></a>08521    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08522"></a>08522    <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])
<a name="l08523"></a>08523       <span class="keywordflow">goto</span> return_unref;
<a name="l08524"></a>08524 
<a name="l08525"></a>08525    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l08526"></a>08526    <span class="comment">/* The selection of which delayed reject is sent may leak information,</span>
<a name="l08527"></a>08527 <span class="comment">    * if it sets a static response.  For example, if a host is known to only</span>
<a name="l08528"></a>08528 <span class="comment">    * use MD5 authentication, then an RSA response would indicate that the</span>
<a name="l08529"></a>08529 <span class="comment">    * peer does not exist, and vice-versa.</span>
<a name="l08530"></a>08530 <span class="comment">    * Therefore, we use whatever the last peer used (which may vary over the</span>
<a name="l08531"></a>08531 <span class="comment">    * course of a server, which should leak minimal information). */</span>
<a name="l08532"></a>08532    sentauthmethod = p ? p-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> : last_authmethod ? last_authmethod : (<a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a> | <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>);
<a name="l08533"></a>08533    <span class="keywordflow">if</span> (!p) {
<a name="l08534"></a>08534       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = sentauthmethod;
<a name="l08535"></a>08535    }
<a name="l08536"></a>08536    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#addd02aa42471088b1d38a0915b69c506">IAX_IE_AUTHMETHODS</a>, sentauthmethod);
<a name="l08537"></a>08537    <span class="keywordflow">if</span> (sentauthmethod &amp; (<a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a> | <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>)) {
<a name="l08538"></a>08538       <span class="comment">/* Build the challenge */</span>
<a name="l08539"></a>08539       snprintf(challenge, <span class="keyword">sizeof</span>(challenge), <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>)<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l08540"></a>08540       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], challenge, challenge);
<a name="l08541"></a>08541       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afdfe925c29c3385317252633f5cf74d1">IAX_IE_CHALLENGE</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;challenge);
<a name="l08542"></a>08542    }
<a name="l08543"></a>08543    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, peer_name);
<a name="l08544"></a>08544 
<a name="l08545"></a>08545 return_unref:
<a name="l08546"></a>08546    <span class="keywordflow">if</span> (p) {
<a name="l08547"></a>08547       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l08548"></a>08548    }
<a name="l08549"></a>08549 
<a name="l08550"></a>08550    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] ? <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2c4ec8dabaa27f540b64c4a586e7ba95">IAX_COMMAND_REGAUTH</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1) : -1;
<a name="l08551"></a>08551 }
<a name="l08552"></a>08552 
<a name="l08553"></a><a class="code" href="chan__iax2_8c.html#ab48db2c2958875909fad81c794d8741b">08553</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab48db2c2958875909fad81c794d8741b">registry_rerequest</a>(<span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies, <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>, <span class="keyword">struct</span> sockaddr_in *sin)
<a name="l08554"></a>08554 {
<a name="l08555"></a>08555    <span class="keyword">struct </span>iax2_registry *reg;
<a name="l08556"></a>08556    <span class="comment">/* Start pessimistic */</span>
<a name="l08557"></a>08557    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l08558"></a>08558    <span class="keywordtype">char</span> peer[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08559"></a>08559    <span class="keywordtype">char</span> challenge[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08560"></a>08560    <span class="keywordtype">int</span> res;
<a name="l08561"></a>08561    <span class="keywordtype">int</span> authmethods = 0;
<a name="l08562"></a>08562    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a23e4b8fa5e973ab5ee519df548401897">authmethods</a>)
<a name="l08563"></a>08563       authmethods = ies-&gt;<a class="code" href="structiax__ies.html#a23e4b8fa5e973ab5ee519df548401897">authmethods</a>;
<a name="l08564"></a>08564    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l08565"></a>08565       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(peer, ies-&gt;<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, <span class="keyword">sizeof</span>(peer));
<a name="l08566"></a>08566    <span class="keywordflow">if</span> (ies-&gt;<a class="code" href="structiax__ies.html#a2929a7d62f294309a5126ccb738f6060">challenge</a>)
<a name="l08567"></a>08567       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(challenge, ies-&gt;<a class="code" href="structiax__ies.html#a2929a7d62f294309a5126ccb738f6060">challenge</a>, <span class="keyword">sizeof</span>(challenge));
<a name="l08568"></a>08568    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l08569"></a>08569    reg = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a>;
<a name="l08570"></a>08570    <span class="keywordflow">if</span> (reg) {
<a name="l08571"></a>08571          <span class="keywordflow">if</span> (<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, sin)) {
<a name="l08572"></a>08572             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Received unsolicited registry authenticate request from &apos;%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr));
<a name="l08573"></a>08573             <span class="keywordflow">return</span> -1;
<a name="l08574"></a>08574          }
<a name="l08575"></a>08575          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(reg-&gt;<a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>)) {
<a name="l08576"></a>08576             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No secret associated with peer &apos;%s&apos;\n&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08577"></a>08577             reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a> = <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a4fd8866724976c0a65ddded1c5ca952b">REG_STATE_NOAUTH</a>;
<a name="l08578"></a>08578             <span class="keywordflow">return</span> -1;
<a name="l08579"></a>08579          }
<a name="l08580"></a>08580          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08581"></a>08581          <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#ac3c0ea95efa7bab2684e56443fc94d0a">IAX_IE_REFRESH</a>, reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a>);
<a name="l08582"></a>08582          <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>[0] == <span class="charliteral">&apos;[&apos;</span>) {
<a name="l08583"></a>08583             <span class="keywordtype">char</span> tmpkey[256];
<a name="l08584"></a>08584             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmpkey, reg-&gt;<a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a> + 1, <span class="keyword">sizeof</span>(tmpkey));
<a name="l08585"></a>08585             tmpkey[strlen(tmpkey) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08586"></a>08586             res = <a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">authenticate</a>(challenge, NULL, tmpkey, authmethods, &amp;ied, sin, NULL);
<a name="l08587"></a>08587          } <span class="keywordflow">else</span>
<a name="l08588"></a>08588             res = <a class="code" href="chan__iax2_8c.html#a94f5bdc1490f38593ca7ef443668c50b">authenticate</a>(challenge, reg-&gt;<a class="code" href="structiax2__registry.html#ab52c1650b53df1fd28bf4b158d3cf79d">secret</a>, NULL, authmethods, &amp;ied, sin, NULL);
<a name="l08589"></a>08589          <span class="keywordflow">if</span> (!res) {
<a name="l08590"></a>08590             reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a> = <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0fc848e483149fa4f30c05562591db11">REG_STATE_AUTHSENT</a>;
<a name="l08591"></a>08591             <a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">add_empty_calltoken_ie</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], &amp;ied); <span class="comment">/* this _MUST_ be the last ie added */</span>
<a name="l08592"></a>08592             <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effab17acacea946abf3ccde08f4f49fbfdb">IAX_COMMAND_REGREQ</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l08593"></a>08593          } <span class="keywordflow">else</span>
<a name="l08594"></a>08594             <span class="keywordflow">return</span> -1;
<a name="l08595"></a>08595          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Registry acknowledge on unknown registery &apos;%s&apos;\n&quot;</span>, peer);
<a name="l08596"></a>08596    } <span class="keywordflow">else</span>   
<a name="l08597"></a>08597       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Can&apos;t reregister without a reg\n&quot;</span>);
<a name="l08598"></a>08598    <span class="keywordflow">return</span> -1;
<a name="l08599"></a>08599 }
<a name="l08600"></a>08600 
<a name="l08601"></a><a class="code" href="chan__iax2_8c.html#ad44551511b38dc48242ecb6ad57f4227">08601</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ad44551511b38dc48242ecb6ad57f4227">stop_stuff</a>(<span class="keywordtype">int</span> callno)
<a name="l08602"></a>08602 {
<a name="l08603"></a>08603    <a class="code" href="chan__iax2_8c.html#a0d97140fc0f1c286328c703d1ae66002">iax2_destroy_helper</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]);
<a name="l08604"></a>08604 }
<a name="l08605"></a>08605 
<a name="l08606"></a><a class="code" href="chan__iax2_8c.html#a606fa4309b66de5f5d86054baaae9f8e">08606</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a606fa4309b66de5f5d86054baaae9f8e">__auth_reject</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *nothing)
<a name="l08607"></a>08607 {
<a name="l08608"></a>08608    <span class="comment">/* Called from IAX thread only, without iaxs lock */</span>
<a name="l08609"></a>08609    <span class="keywordtype">int</span> callno = (int)(<span class="keywordtype">long</span>)(nothing);
<a name="l08610"></a>08610    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l08611"></a>08611    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08612"></a>08612    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l08613"></a>08613       memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l08614"></a>08614       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;authfail == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa8c1a50616eeef8353b4985462e736419">IAX_COMMAND_REGREJ</a>) {
<a name="l08615"></a>08615          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Registration Refused&quot;</span>);
<a name="l08616"></a>08616          <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#aa49742b6e084d7a25a0994beba1fa9ea">AST_CAUSE_FACILITY_REJECTED</a>);
<a name="l08617"></a>08617       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;authfail == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>) {
<a name="l08618"></a>08618          <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;No authority found&quot;</span>);
<a name="l08619"></a>08619          <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a66e303e9085c143381179b613490fa58">AST_CAUSE_FACILITY_NOT_SUBSCRIBED</a>);
<a name="l08620"></a>08620       }
<a name="l08621"></a>08621       <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;authfail, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l08622"></a>08622    }
<a name="l08623"></a>08623    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08624"></a>08624 }
<a name="l08625"></a>08625 
<a name="l08626"></a><a class="code" href="chan__iax2_8c.html#a83eb6a25ef569a86dd08240dad4ea5dd">08626</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a83eb6a25ef569a86dd08240dad4ea5dd">auth_reject</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l08627"></a>08627 {
<a name="l08628"></a>08628    <span class="keywordtype">int</span> callno = (int)(<span class="keywordtype">long</span>)(data);
<a name="l08629"></a>08629    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08630"></a>08630    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])
<a name="l08631"></a>08631       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a94bf6ec5b99ea2a6378669fe6021e2e8">authid</a> = -1;
<a name="l08632"></a>08632    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08633"></a>08633 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l08634"></a>08634 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a606fa4309b66de5f5d86054baaae9f8e">__auth_reject</a>, data))
<a name="l08635"></a>08635 <span class="preprocessor">#endif      </span>
<a name="l08636"></a>08636 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#a606fa4309b66de5f5d86054baaae9f8e">__auth_reject</a>(data);
<a name="l08637"></a>08637    <span class="keywordflow">return</span> 0;
<a name="l08638"></a>08638 }
<a name="l08639"></a>08639 
<a name="l08640"></a><a class="code" href="chan__iax2_8c.html#a239b18f98846d5c7426ae7ee4ba97028">08640</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a239b18f98846d5c7426ae7ee4ba97028">auth_fail</a>(<span class="keywordtype">int</span> callno, <span class="keywordtype">int</span> failcode)
<a name="l08641"></a>08641 {
<a name="l08642"></a>08642    <span class="comment">/* Schedule sending the authentication failure in one second, to prevent</span>
<a name="l08643"></a>08643 <span class="comment">      guessing */</span>
<a name="l08644"></a>08644    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l08645"></a>08645       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a2768911893070f3536acd19c6cb62819">authfail</a> = failcode;
<a name="l08646"></a>08646       <span class="keywordflow">if</span> (delayreject) {
<a name="l08647"></a>08647          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a94bf6ec5b99ea2a6378669fe6021e2e8">authid</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;authid, 
<a name="l08648"></a>08648             sched, 1000, <a class="code" href="chan__iax2_8c.html#a83eb6a25ef569a86dd08240dad4ea5dd">auth_reject</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)callno);
<a name="l08649"></a>08649       } <span class="keywordflow">else</span>
<a name="l08650"></a>08650          <a class="code" href="chan__iax2_8c.html#a83eb6a25ef569a86dd08240dad4ea5dd">auth_reject</a>((<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)callno);
<a name="l08651"></a>08651    }
<a name="l08652"></a>08652    <span class="keywordflow">return</span> 0;
<a name="l08653"></a>08653 }
<a name="l08654"></a>08654 
<a name="l08655"></a><a class="code" href="chan__iax2_8c.html#a0c61d596e12080158865cd5e41f0e620">08655</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a0c61d596e12080158865cd5e41f0e620">__auto_hangup</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *nothing)
<a name="l08656"></a>08656 {
<a name="l08657"></a>08657    <span class="comment">/* Called from IAX thread only, without iaxs lock */</span>
<a name="l08658"></a>08658    <span class="keywordtype">int</span> callno = (int)(<span class="keywordtype">long</span>)(nothing);
<a name="l08659"></a>08659    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l08660"></a>08660    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08661"></a>08661    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l08662"></a>08662       memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l08663"></a>08663       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Timeout&quot;</span>);
<a name="l08664"></a>08664       <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a5310fd2a65b78fb6840b0e3e883a2470">AST_CAUSE_NO_USER_RESPONSE</a>);
<a name="l08665"></a>08665       <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4b934f8100fc77df870a27d2aa09b9ee">IAX_COMMAND_HANGUP</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l08666"></a>08666    }
<a name="l08667"></a>08667    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08668"></a>08668 }
<a name="l08669"></a>08669 
<a name="l08670"></a><a class="code" href="chan__iax2_8c.html#af2f256e202e0549ed7b0df7592782365">08670</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af2f256e202e0549ed7b0df7592782365">auto_hangup</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l08671"></a>08671 {
<a name="l08672"></a>08672    <span class="keywordtype">int</span> callno = (int)(<span class="keywordtype">long</span>)(data);
<a name="l08673"></a>08673    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08674"></a>08674    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l08675"></a>08675       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bae7aaf2ef69cbcf5ffb6e0b9ba060">autoid</a> = -1;
<a name="l08676"></a>08676    }
<a name="l08677"></a>08677    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08678"></a>08678 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l08679"></a>08679 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a0c61d596e12080158865cd5e41f0e620">__auto_hangup</a>, data))
<a name="l08680"></a>08680 <span class="preprocessor">#endif      </span>
<a name="l08681"></a>08681 <span class="preprocessor"></span>      <a class="code" href="chan__iax2_8c.html#a0c61d596e12080158865cd5e41f0e620">__auto_hangup</a>(data);
<a name="l08682"></a>08682    <span class="keywordflow">return</span> 0;
<a name="l08683"></a>08683 }
<a name="l08684"></a>08684 
<a name="l08685"></a><a class="code" href="chan__iax2_8c.html#affb728aed260a44a6c7e8d18327766cb">08685</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#affb728aed260a44a6c7e8d18327766cb">iax2_dprequest</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp, <span class="keywordtype">int</span> callno)
<a name="l08686"></a>08686 {
<a name="l08687"></a>08687    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l08688"></a>08688    <span class="comment">/* Auto-hangup with 30 seconds of inactivity */</span>
<a name="l08689"></a>08689    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bae7aaf2ef69cbcf5ffb6e0b9ba060">autoid</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;autoid, 
<a name="l08690"></a>08690       sched, 30000, <a class="code" href="chan__iax2_8c.html#af2f256e202e0549ed7b0df7592782365">auto_hangup</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)callno);
<a name="l08691"></a>08691    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l08692"></a>08692    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#aa0f5d6e9b74df33a17772be8afde5bc7">IAX_IE_CALLED_NUMBER</a>, dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l08693"></a>08693    <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae89a0a9be99682834a3f7fc9434e7625">IAX_COMMAND_DPREQ</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l08694"></a>08694    dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> |= <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493af75a0829e95bf2ea13767b29d505a5ed">CACHE_FLAG_TRANSMITTED</a>;
<a name="l08695"></a>08695 }
<a name="l08696"></a>08696 
<a name="l08697"></a><a class="code" href="chan__iax2_8c.html#ac36e579cc52653790930d8bb00e05493">08697</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac36e579cc52653790930d8bb00e05493">iax2_vnak</a>(<span class="keywordtype">int</span> callno)
<a name="l08698"></a>08698 {
<a name="l08699"></a>08699    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effabc19cf9ba5ac0470de593a7132027fca">IAX_COMMAND_VNAK</a>, 0, NULL, 0, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;iseqno);
<a name="l08700"></a>08700 }
<a name="l08701"></a>08701 
<a name="l08702"></a><a class="code" href="chan__iax2_8c.html#a2b955d256cb77a10588b658b959f2df6">08702</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a2b955d256cb77a10588b658b959f2df6">vnak_retransmit</a>(<span class="keywordtype">int</span> callno, <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>)
<a name="l08703"></a>08703 {
<a name="l08704"></a>08704    <span class="keyword">struct </span>iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l08705"></a>08705 
<a name="l08706"></a>08706    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l08707"></a>08707    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, f, list) {
<a name="l08708"></a>08708       <span class="comment">/* Send a copy immediately */</span>
<a name="l08709"></a>08709       <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> == callno) &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp;
<a name="l08710"></a>08710          ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ) (f-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a> - last) &lt; 128) &amp;&amp;
<a name="l08711"></a>08711          (f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &gt;= 0)) {
<a name="l08712"></a>08712          <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(f);
<a name="l08713"></a>08713       }
<a name="l08714"></a>08714    }
<a name="l08715"></a>08715    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l08716"></a>08716 }
<a name="l08717"></a>08717 
<a name="l08718"></a><a class="code" href="chan__iax2_8c.html#ac288503520b00314d4cefdb2ab4e9308">08718</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ac288503520b00314d4cefdb2ab4e9308">__iax2_poke_peer_s</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>)
<a name="l08719"></a>08719 {
<a name="l08720"></a>08720    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = (<span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *)data;
<a name="l08721"></a>08721    <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(peer, 0);
<a name="l08722"></a>08722    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l08723"></a>08723 }
<a name="l08724"></a>08724 
<a name="l08725"></a><a class="code" href="chan__iax2_8c.html#acc5f5c09967027708bf5b6e6374f5935">08725</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#acc5f5c09967027708bf5b6e6374f5935">iax2_poke_peer_s</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l08726"></a>08726 {
<a name="l08727"></a>08727    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = (<span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *)data;
<a name="l08728"></a>08728    peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l08729"></a>08729 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l08730"></a>08730 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#ac288503520b00314d4cefdb2ab4e9308">__iax2_poke_peer_s</a>, data))
<a name="l08731"></a>08731 #endif      
<a name="l08732"></a>08732       <a class="code" href="chan__iax2_8c.html#ac288503520b00314d4cefdb2ab4e9308">__iax2_poke_peer_s</a>(data);
<a name="l08733"></a>08733    <span class="keywordflow">return</span> 0;
<a name="l08734"></a>08734 }
<a name="l08735"></a>08735 
<a name="l08736"></a><a class="code" href="chan__iax2_8c.html#ad598b8e9746a49f7a86a1c29d87b5dba">08736</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad598b8e9746a49f7a86a1c29d87b5dba">send_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer, <span class="keyword">struct</span> timeval *now)
<a name="l08737"></a>08737 {
<a name="l08738"></a>08738    <span class="keywordtype">int</span> res = 0;
<a name="l08739"></a>08739    <span class="keyword">struct </span>iax_frame *fr;
<a name="l08740"></a>08740    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__hdr.html">ast_iax2_meta_hdr</a> *meta;
<a name="l08741"></a>08741    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__hdr.html">ast_iax2_meta_trunk_hdr</a> *mth;
<a name="l08742"></a>08742    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a> = 0;
<a name="l08743"></a>08743    
<a name="l08744"></a>08744    <span class="comment">/* Point to frame */</span>
<a name="l08745"></a>08745    fr = (<span class="keyword">struct </span>iax_frame *)tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9d7d795e75eb67c3d19f9b86d326c588">trunkdata</a>;
<a name="l08746"></a>08746    <span class="comment">/* Point to meta data */</span>
<a name="l08747"></a>08747    meta = (<span class="keyword">struct</span> <a class="code" href="structast__iax2__meta__hdr.html">ast_iax2_meta_hdr</a> *)fr-&gt;<a class="code" href="structiax__frame.html#a6caa911aa752e04eba40c71e08843888">afdata</a>;
<a name="l08748"></a>08748    mth = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__hdr.html">ast_iax2_meta_trunk_hdr</a> *)meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#aef5b927d15f11382bf5f276630c08287">data</a>;
<a name="l08749"></a>08749    if (tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a>) {
<a name="l08750"></a>08750       <span class="comment">/* We&apos;re actually sending a frame, so fill the meta trunk header and meta header */</span>
<a name="l08751"></a>08751       meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#a536adab2c572868ca3f967c9d370e5b3">zeros</a> = 0;
<a name="l08752"></a>08752       meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#ac778073eb75dbcc51a045b8b423cda15">metacmd</a> = <a class="code" href="iax2_8h.html#aca93bd4918b00346d63b4c3d3dd25ddf">IAX_META_TRUNK</a>;
<a name="l08753"></a>08753       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba0af69b242af8f9f71d7c94452ce86088">IAX_TRUNKTIMESTAMPS</a>))
<a name="l08754"></a>08754          meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#ac5e01aa10e4be943d73207e55ff03668">cmddata</a> = <a class="code" href="iax2_8h.html#accf935c9f6078e9873ab26b692247326">IAX_META_TRUNK_MINI</a>;
<a name="l08755"></a>08755       <span class="keywordflow">else</span>
<a name="l08756"></a>08756          meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#ac5e01aa10e4be943d73207e55ff03668">cmddata</a> = <a class="code" href="iax2_8h.html#a3ddeeaffe7804b8f58dceed45c8f5419">IAX_META_TRUNK_SUPERMINI</a>;
<a name="l08757"></a>08757       mth-&gt;<a class="code" href="structast__iax2__meta__trunk__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = htonl(<a class="code" href="chan__iax2_8c.html#a19e4c62d70e1ac30132e25bc553d1b91">calc_txpeerstamp</a>(tpeer, trunkfreq, now));
<a name="l08758"></a>08758       <span class="comment">/* And the rest of the ast_iax2 header */</span>
<a name="l08759"></a>08759       fr-&gt;<a class="code" href="structiax__frame.html#ac7e977c3f00d50b1cd332813fa428b4d">direction</a> = <a class="code" href="iax2-parser_8h.html#a1de532894b7fc3607e6f16281fbfc07f">DIRECTION_OUTGRESS</a>;
<a name="l08760"></a>08760       fr-&gt;<a class="code" href="structiax__frame.html#a4ab21dd2375ec54e44ae4da973a3d4ca">retrans</a> = -1;
<a name="l08761"></a>08761       fr-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a> = 0;
<a name="l08762"></a>08762       <span class="comment">/* Any appropriate call will do */</span>
<a name="l08763"></a>08763       fr-&gt;<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a> = fr-&gt;<a class="code" href="structiax__frame.html#a6caa911aa752e04eba40c71e08843888">afdata</a>;
<a name="l08764"></a>08764       fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__hdr.html">ast_iax2_meta_hdr</a>) + sizeof(struct ast_iax2_meta_trunk_hdr);
<a name="l08765"></a>08765       res = <a class="code" href="chan__iax2_8c.html#a2f4ec7512d2d316b0aeb10570cf3b2b4">transmit_trunk</a>(fr, &amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>);
<a name="l08766"></a>08766       calls = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a>;
<a name="l08767"></a>08767 <span class="preprocessor">#if 0</span>
<a name="l08768"></a>08768 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Trunking %d call chunks in %d bytes to %s:%d, ts=%d\n&quot;</span>, calls, fr-&gt;<a class="code" href="structiax__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port), ntohl(mth-&gt;<a class="code" href="structast__iax2__meta__trunk__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>));
<a name="l08769"></a>08769 <span class="preprocessor">#endif      </span>
<a name="l08770"></a>08770 <span class="preprocessor"></span>      <span class="comment">/* Reset transmit trunk side data */</span>
<a name="l08771"></a>08771       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a> = 0;
<a name="l08772"></a>08772       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a5f1c773ac1d2f42241d25d73373885ab">calls</a> = 0;
<a name="l08773"></a>08773    }
<a name="l08774"></a>08774    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l08775"></a>08775       <span class="keywordflow">return</span> res;
<a name="l08776"></a>08776    <span class="keywordflow">return</span> calls;
<a name="l08777"></a>08777 }
<a name="l08778"></a>08778 
<a name="l08779"></a><a class="code" href="chan__iax2_8c.html#a04230c378319cc018247896f3ba9d24a">08779</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a04230c378319cc018247896f3ba9d24a">iax2_trunk_expired</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer, <span class="keyword">struct</span> timeval *now)
<a name="l08780"></a>08780 {
<a name="l08781"></a>08781    <span class="comment">/* Drop when trunk is about 5 seconds idle */</span>
<a name="l08782"></a>08782    <span class="keywordflow">if</span> (now-&gt;tv_sec &gt; tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">trunkact</a>.tv_sec + 5) 
<a name="l08783"></a>08783       <span class="keywordflow">return</span> 1;
<a name="l08784"></a>08784    <span class="keywordflow">return</span> 0;
<a name="l08785"></a>08785 }
<a name="l08786"></a>08786 
<a name="l08787"></a><a class="code" href="chan__iax2_8c.html#a012d6b64700a636f121bfce123ecfa4a">08787</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a012d6b64700a636f121bfce123ecfa4a">timing_read</a>(<span class="keywordtype">int</span> *<span class="keywordtype">id</span>, <span class="keywordtype">int</span> fd, <span class="keywordtype">short</span> <a class="code" href="app__adsiprog_8c.html#a31547b3fbfe860fc4518ce2332297f9b">events</a>, <span class="keywordtype">void</span> *cbdata)
<a name="l08788"></a>08788 {
<a name="l08789"></a>08789    <span class="keywordtype">int</span> res, processed = 0, <a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">totalcalls</a> = 0;
<a name="l08790"></a>08790    <span class="keyword">struct </span><a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer = NULL, *drop = NULL;
<a name="l08791"></a>08791    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l08792"></a>08792 
<a name="l08793"></a>08793    <span class="keywordflow">if</span> (iaxtrunkdebug)
<a name="l08794"></a>08794       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Beginning trunk processing. Trunk queue ceiling is %d bytes per host\n&quot;</span>, trunkmaxsize);
<a name="l08795"></a>08795 
<a name="l08796"></a>08796    <span class="keywordflow">if</span> (timer) { 
<a name="l08797"></a>08797       <a class="code" href="timing_8h.html#a510afb686dee576be589ba47a27c9c40" title="Acknowledge a timer event.">ast_timer_ack</a>(timer, 1);
<a name="l08798"></a>08798    }
<a name="l08799"></a>08799 
<a name="l08800"></a>08800    <span class="comment">/* For each peer that supports trunking... */</span>
<a name="l08801"></a>08801    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;tpeers);
<a name="l08802"></a>08802    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;tpeers, tpeer, list) {
<a name="l08803"></a>08803       processed++;
<a name="l08804"></a>08804       res = 0;
<a name="l08805"></a>08805       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l08806"></a>08806       <span class="comment">/* We can drop a single tpeer per pass.  That makes all this logic</span>
<a name="l08807"></a>08807 <span class="comment">         substantially easier */</span>
<a name="l08808"></a>08808       <span class="keywordflow">if</span> (!drop &amp;&amp; <a class="code" href="chan__iax2_8c.html#a04230c378319cc018247896f3ba9d24a">iax2_trunk_expired</a>(tpeer, &amp;now)) {
<a name="l08809"></a>08809          <span class="comment">/* Take it out of the list, but don&apos;t free it yet, because it</span>
<a name="l08810"></a>08810 <span class="comment">            could be in use */</span>
<a name="l08811"></a>08811          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l08812"></a>08812          drop = tpeer;
<a name="l08813"></a>08813       } <span class="keywordflow">else</span> {
<a name="l08814"></a>08814          res = <a class="code" href="chan__iax2_8c.html#ad598b8e9746a49f7a86a1c29d87b5dba">send_trunk</a>(tpeer, &amp;now);
<a name="l08815"></a>08815          trunk_timed++; 
<a name="l08816"></a>08816          <span class="keywordflow">if</span> (iaxtrunkdebug)
<a name="l08817"></a>08817             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot; - Trunk peer (%s:%d) has %d call chunk%s in transit, %d bytes backloged and has hit a high water mark of %d bytes\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), ntohs(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port), res, (res != 1) ? <span class="stringliteral">&quot;s&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a9ca078ce1cc422f884f4fe499048cdeb">trunkdatalen</a>, tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a94daa2cd598dc3dd3585049b874799f7">trunkdataalloc</a>);
<a name="l08818"></a>08818       }     
<a name="l08819"></a>08819       <a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">totalcalls</a> += res;   
<a name="l08820"></a>08820       res = 0;
<a name="l08821"></a>08821       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l08822"></a>08822    }
<a name="l08823"></a>08823    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l08824"></a>08824    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;tpeers);
<a name="l08825"></a>08825 
<a name="l08826"></a>08826    <span class="keywordflow">if</span> (drop) {
<a name="l08827"></a>08827       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;drop-&gt;lock);
<a name="l08828"></a>08828       <span class="comment">/* Once we have this lock, we&apos;re sure nobody else is using it or could use it once we release it, </span>
<a name="l08829"></a>08829 <span class="comment">         because by the time they could get tpeerlock, we&apos;ve already grabbed it */</span>
<a name="l08830"></a>08830       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Dropping unused iax2 trunk peer &apos;%s:%d&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(drop-&gt;addr.sin_addr), ntohs(drop-&gt;addr.sin_port));
<a name="l08831"></a>08831       <span class="keywordflow">if</span> (drop-&gt;trunkdata) {
<a name="l08832"></a>08832          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(drop-&gt;trunkdata);
<a name="l08833"></a>08833          drop-&gt;trunkdata = NULL;
<a name="l08834"></a>08834       }
<a name="l08835"></a>08835       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;drop-&gt;lock);
<a name="l08836"></a>08836       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;drop-&gt;lock);
<a name="l08837"></a>08837       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(drop);
<a name="l08838"></a>08838       
<a name="l08839"></a>08839    }
<a name="l08840"></a>08840 
<a name="l08841"></a>08841    <span class="keywordflow">if</span> (iaxtrunkdebug)
<a name="l08842"></a>08842       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Ending trunk processing with %d peers and %d call chunks processed\n&quot;</span>, processed, <a class="code" href="pbx_8c.html#a078330b9a32065ec6a0c0731c06719cd">totalcalls</a>);
<a name="l08843"></a>08843    iaxtrunkdebug = 0;
<a name="l08844"></a>08844 
<a name="l08845"></a>08845    <span class="keywordflow">return</span> 1;
<a name="l08846"></a>08846 }
<a name="l08847"></a>08847 
<a name="l08848"></a><a class="code" href="structdpreq__data.html">08848</a> <span class="keyword">struct </span><a class="code" href="structdpreq__data.html">dpreq_data</a> {
<a name="l08849"></a><a class="code" href="structdpreq__data.html#a12650384da62fe82303630ca19410f2b">08849</a>    <span class="keywordtype">int</span> callno;
<a name="l08850"></a><a class="code" href="structdpreq__data.html#a579ca8125bbf48d9ce8691d522f99933">08850</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l08851"></a><a class="code" href="structdpreq__data.html#ab4fc44d931bcf3283a61d0d732ea85be">08851</a>    <span class="keywordtype">char</span> callednum[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l08852"></a><a class="code" href="structdpreq__data.html#af2ba83a4cf748f09428d0e166fcd113f">08852</a>    <span class="keywordtype">char</span> *callerid;
<a name="l08853"></a>08853 };
<a name="l08854"></a>08854 
<a name="l08855"></a><a class="code" href="chan__iax2_8c.html#a903295362112b299b8857614ba887aa9">08855</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a903295362112b299b8857614ba887aa9">dp_lookup</a>(<span class="keywordtype">int</span> callno, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *callednum, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keywordtype">int</span> skiplock)
<a name="l08856"></a>08856 {
<a name="l08857"></a>08857    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> dpstatus = 0;
<a name="l08858"></a>08858    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied1;
<a name="l08859"></a>08859    <span class="keywordtype">int</span> mm;
<a name="l08860"></a>08860 
<a name="l08861"></a>08861    memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l08862"></a>08862    mm = <a class="code" href="pbx_8h.html#ac359af75b9494f50904583d2168a7577" title="Looks to see if adding anything to this extension might match something. (exists...">ast_matchmore_extension</a>(NULL, context, callednum, 1, callerid);
<a name="l08863"></a>08863    <span class="comment">/* Must be started */</span>
<a name="l08864"></a>08864    <span class="keywordflow">if</span> (!strcmp(callednum, <a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>()) || <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, context, callednum, 1, callerid)) {
<a name="l08865"></a>08865       dpstatus = <a class="code" href="iax2_8h.html#af7ede4eff590f377b386f3232ab3f144">IAX_DPSTATUS_EXISTS</a>;
<a name="l08866"></a>08866    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(NULL, context, callednum, 1, callerid)) {
<a name="l08867"></a>08867       dpstatus = <a class="code" href="iax2_8h.html#a0daa7f414b8d8032c47ddb031ac45850">IAX_DPSTATUS_CANEXIST</a>;
<a name="l08868"></a>08868    } <span class="keywordflow">else</span> {
<a name="l08869"></a>08869       dpstatus = <a class="code" href="iax2_8h.html#a4cd8441d7cf40a0250c819a032ad4b30">IAX_DPSTATUS_NONEXISTENT</a>;
<a name="l08870"></a>08870    }
<a name="l08871"></a>08871    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa73d176ed4f1ce51e5db6beafba45fe3" title="Checks to see if a number should be ignored.">ast_ignore_pattern</a>(context, callednum))
<a name="l08872"></a>08872       dpstatus |= <a class="code" href="iax2_8h.html#a59da00ade31ff6e1e7db6854855eab24">IAX_DPSTATUS_IGNOREPAT</a>;
<a name="l08873"></a>08873    <span class="keywordflow">if</span> (mm)
<a name="l08874"></a>08874       dpstatus |= <a class="code" href="iax2_8h.html#aab7cd9d75d476323e0131c17687065d9">IAX_DPSTATUS_MATCHMORE</a>;
<a name="l08875"></a>08875    <span class="keywordflow">if</span> (!skiplock)
<a name="l08876"></a>08876       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08877"></a>08877    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l08878"></a>08878       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied1, <a class="code" href="iax2_8h.html#aa0f5d6e9b74df33a17772be8afde5bc7">IAX_IE_CALLED_NUMBER</a>, callednum);
<a name="l08879"></a>08879       <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied1, <a class="code" href="iax2_8h.html#a1f823cae4105f55cb634b2ae4d6fd61a">IAX_IE_DPSTATUS</a>, dpstatus);
<a name="l08880"></a>08880       <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied1, <a class="code" href="iax2_8h.html#ac3c0ea95efa7bab2684e56443fc94d0a">IAX_IE_REFRESH</a>, iaxdefaultdpcache);
<a name="l08881"></a>08881       <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2bf840cb539605d405a6bbd7d2c87b23">IAX_COMMAND_DPREP</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l08882"></a>08882    }
<a name="l08883"></a>08883    <span class="keywordflow">if</span> (!skiplock)
<a name="l08884"></a>08884       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l08885"></a>08885 }
<a name="l08886"></a>08886 
<a name="l08887"></a><a class="code" href="chan__iax2_8c.html#ad6a3e91b8ba550cec2d83afbeec2b5b0">08887</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#ad6a3e91b8ba550cec2d83afbeec2b5b0">dp_lookup_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l08888"></a>08888 {
<a name="l08889"></a>08889    <span class="comment">/* Look up for dpreq */</span>
<a name="l08890"></a>08890    <span class="keyword">struct </span><a class="code" href="structdpreq__data.html">dpreq_data</a> *dpr = data;
<a name="l08891"></a>08891    <a class="code" href="chan__iax2_8c.html#a903295362112b299b8857614ba887aa9">dp_lookup</a>(dpr-&gt;<a class="code" href="structdpreq__data.html#a12650384da62fe82303630ca19410f2b">callno</a>, dpr-&gt;<a class="code" href="structdpreq__data.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, dpr-&gt;<a class="code" href="structdpreq__data.html#ab4fc44d931bcf3283a61d0d732ea85be">callednum</a>, dpr-&gt;<a class="code" href="structdpreq__data.html#af2ba83a4cf748f09428d0e166fcd113f">callerid</a>, 0);
<a name="l08892"></a>08892    <span class="keywordflow">if</span> (dpr-&gt;<a class="code" href="structdpreq__data.html#af2ba83a4cf748f09428d0e166fcd113f">callerid</a>)
<a name="l08893"></a>08893       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(dpr-&gt;<a class="code" href="structdpreq__data.html#af2ba83a4cf748f09428d0e166fcd113f">callerid</a>);
<a name="l08894"></a>08894    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(dpr);
<a name="l08895"></a>08895    <span class="keywordflow">return</span> NULL;
<a name="l08896"></a>08896 }
<a name="l08897"></a>08897 
<a name="l08898"></a><a class="code" href="chan__iax2_8c.html#a72d6ae9fc1eb756f98d848568f44de4e">08898</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a72d6ae9fc1eb756f98d848568f44de4e">spawn_dp_lookup</a>(<span class="keywordtype">int</span> <a class="code" href="structdpreq__data.html#a12650384da62fe82303630ca19410f2b">callno</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structdpreq__data.html#ab4fc44d931bcf3283a61d0d732ea85be">callednum</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structdpreq__data.html#af2ba83a4cf748f09428d0e166fcd113f">callerid</a>)
<a name="l08899"></a>08899 {
<a name="l08900"></a>08900    pthread_t newthread;
<a name="l08901"></a>08901    <span class="keyword">struct </span><a class="code" href="structdpreq__data.html">dpreq_data</a> *dpr;
<a name="l08902"></a>08902    
<a name="l08903"></a>08903    <span class="keywordflow">if</span> (!(dpr = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*dpr))))
<a name="l08904"></a>08904       <span class="keywordflow">return</span>;
<a name="l08905"></a>08905 
<a name="l08906"></a>08906    dpr-&gt;<a class="code" href="structdpreq__data.html#a12650384da62fe82303630ca19410f2b">callno</a> = callno;
<a name="l08907"></a>08907    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dpr-&gt;<a class="code" href="structdpreq__data.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, context, <span class="keyword">sizeof</span>(dpr-&gt;<a class="code" href="structdpreq__data.html#a579ca8125bbf48d9ce8691d522f99933">context</a>));
<a name="l08908"></a>08908    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dpr-&gt;<a class="code" href="structdpreq__data.html#ab4fc44d931bcf3283a61d0d732ea85be">callednum</a>, callednum, <span class="keyword">sizeof</span>(dpr-&gt;<a class="code" href="structdpreq__data.html#ab4fc44d931bcf3283a61d0d732ea85be">callednum</a>));
<a name="l08909"></a>08909    <span class="keywordflow">if</span> (callerid)
<a name="l08910"></a>08910       dpr-&gt;<a class="code" href="structdpreq__data.html#af2ba83a4cf748f09428d0e166fcd113f">callerid</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(callerid);
<a name="l08911"></a>08911    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;newthread, NULL, <a class="code" href="chan__iax2_8c.html#ad6a3e91b8ba550cec2d83afbeec2b5b0">dp_lookup_thread</a>, dpr)) {
<a name="l08912"></a>08912       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to start lookup thread!\n&quot;</span>);
<a name="l08913"></a>08913    }
<a name="l08914"></a>08914 }
<a name="l08915"></a>08915 
<a name="l08916"></a><a class="code" href="structiax__dual.html">08916</a> <span class="keyword">struct </span><a class="code" href="structiax__dual.html">iax_dual</a> {
<a name="l08917"></a><a class="code" href="structiax__dual.html#aa1ca1dcb04435f92bb21e0a9ec5ffa03">08917</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan1;
<a name="l08918"></a><a class="code" href="structiax__dual.html#ac6286f8b21f8877479c3599f7d1c529f">08918</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan2;
<a name="l08919"></a>08919 };
<a name="l08920"></a>08920 
<a name="l08921"></a><a class="code" href="chan__iax2_8c.html#a17a27768232c638bc7a78d5995f5ddfc">08921</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#a17a27768232c638bc7a78d5995f5ddfc">iax_park_thread</a>(<span class="keywordtype">void</span> *stuff)
<a name="l08922"></a>08922 {
<a name="l08923"></a>08923    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan1, *chan2;
<a name="l08924"></a>08924    <span class="keyword">struct </span><a class="code" href="structiax__dual.html">iax_dual</a> *d;
<a name="l08925"></a>08925    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l08926"></a>08926    <span class="keywordtype">int</span> <a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>;
<a name="l08927"></a>08927    <span class="keywordtype">int</span> res;
<a name="l08928"></a>08928    d = stuff;
<a name="l08929"></a>08929    chan1 = d-&gt;<a class="code" href="structiax__dual.html#aa1ca1dcb04435f92bb21e0a9ec5ffa03">chan1</a>;
<a name="l08930"></a>08930    chan2 = d-&gt;<a class="code" href="structiax__dual.html#ac6286f8b21f8877479c3599f7d1c529f">chan2</a>;
<a name="l08931"></a>08931    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(d);
<a name="l08932"></a>08932    f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan1);
<a name="l08933"></a>08933    <span class="keywordflow">if</span> (f)
<a name="l08934"></a>08934       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l08935"></a>08935    res = <a class="code" href="features_8h.html#a502948a22446cb0c97d19fc4783b2b5a" title="Park a call and read back parked location.">ast_park_call</a>(chan1, chan2, 0, &amp;ext);
<a name="l08936"></a>08936    <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan2);
<a name="l08937"></a>08937    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Parked on extension &apos;%d&apos;\n&quot;</span>, ext);
<a name="l08938"></a>08938    <span class="keywordflow">return</span> NULL;
<a name="l08939"></a>08939 }
<a name="l08940"></a>08940 
<a name="l08941"></a><a class="code" href="chan__iax2_8c.html#af1b3f7b40e38811796b85df549034f7a">08941</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af1b3f7b40e38811796b85df549034f7a">iax_park</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan1, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan2)
<a name="l08942"></a>08942 {
<a name="l08943"></a>08943    <span class="keyword">struct </span><a class="code" href="structiax__dual.html">iax_dual</a> *d;
<a name="l08944"></a>08944    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan1m, *chan2m;
<a name="l08945"></a>08945    pthread_t th;
<a name="l08946"></a>08946    chan1m = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, chan2-&gt;accountcode, chan1-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan1-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan1-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>, <span class="stringliteral">&quot;Parking/%s&quot;</span>, chan1-&gt;name);
<a name="l08947"></a>08947    chan2m = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, chan2-&gt;accountcode, chan2-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan2-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan2-&gt;<a class="code" href="structast__channel.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a>, <span class="stringliteral">&quot;IAXPeer/%s&quot;</span>,chan2-&gt;name);
<a name="l08948"></a>08948    <span class="keywordflow">if</span> (chan2m &amp;&amp; chan1m) {
<a name="l08949"></a>08949       <span class="comment">/* Make formats okay */</span>
<a name="l08950"></a>08950       chan1m-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = chan1-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l08951"></a>08951       chan1m-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = chan1-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l08952"></a>08952       <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(chan1m, chan1);
<a name="l08953"></a>08953       <span class="comment">/* Setup the extensions and such */</span>
<a name="l08954"></a>08954       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan1m-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan1-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(chan1m-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l08955"></a>08955       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan1m-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan1-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(chan1m-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l08956"></a>08956       chan1m-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = chan1-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l08957"></a>08957       
<a name="l08958"></a>08958       <span class="comment">/* We make a clone of the peer channel too, so we can play</span>
<a name="l08959"></a>08959 <span class="comment">         back the announcement */</span>
<a name="l08960"></a>08960       <span class="comment">/* Make formats okay */</span>
<a name="l08961"></a>08961       chan2m-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = chan2-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l08962"></a>08962       chan2m-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = chan2-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l08963"></a>08963       <a class="code" href="channel_8h.html#a84fa04f019436467dc17f9bdd5341dce" title="Weird function made for call transfers.">ast_channel_masquerade</a>(chan2m, chan2);
<a name="l08964"></a>08964       <span class="comment">/* Setup the extensions and such */</span>
<a name="l08965"></a>08965       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan2m-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan2-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(chan2m-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l08966"></a>08966       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan2m-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, chan2-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(chan2m-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l08967"></a>08967       chan2m-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = chan2-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l08968"></a>08968       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ab26f03fb10f1b2e8e52bfbbb1ee02f78" title="Start masquerading a channel XXX This is a seriously whacked out operation. We&amp;#39;re...">ast_do_masquerade</a>(chan2m)) {
<a name="l08969"></a>08969          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Masquerade failed :(\n&quot;</span>);
<a name="l08970"></a>08970          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan2m);
<a name="l08971"></a>08971          <span class="keywordflow">return</span> -1;
<a name="l08972"></a>08972       }
<a name="l08973"></a>08973    } <span class="keywordflow">else</span> {
<a name="l08974"></a>08974       <span class="keywordflow">if</span> (chan1m)
<a name="l08975"></a>08975          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan1m);
<a name="l08976"></a>08976       <span class="keywordflow">if</span> (chan2m)
<a name="l08977"></a>08977          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(chan2m);
<a name="l08978"></a>08978       <span class="keywordflow">return</span> -1;
<a name="l08979"></a>08979    }
<a name="l08980"></a>08980    <span class="keywordflow">if</span> ((d = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*d)))) {
<a name="l08981"></a>08981       d-&gt;<a class="code" href="structiax__dual.html#aa1ca1dcb04435f92bb21e0a9ec5ffa03">chan1</a> = chan1m;
<a name="l08982"></a>08982       d-&gt;<a class="code" href="structiax__dual.html#ac6286f8b21f8877479c3599f7d1c529f">chan2</a> = chan2m;
<a name="l08983"></a>08983       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;th, NULL, <a class="code" href="chan__iax2_8c.html#a17a27768232c638bc7a78d5995f5ddfc">iax_park_thread</a>, d)) {
<a name="l08984"></a>08984          <span class="keywordflow">return</span> 0;
<a name="l08985"></a>08985       }
<a name="l08986"></a>08986       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(d);
<a name="l08987"></a>08987    }
<a name="l08988"></a>08988    <span class="keywordflow">return</span> -1;
<a name="l08989"></a>08989 }
<a name="l08990"></a>08990 
<a name="l08991"></a>08991 
<a name="l08992"></a>08992 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">iax2_provision</a>(<span class="keyword">struct</span> sockaddr_in *end, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">char</span> *dest, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>, <span class="keywordtype">int</span> force);
<a name="l08993"></a>08993 
<a name="l08994"></a><a class="code" href="chan__iax2_8c.html#a25a386bc9b168cd30b3cee08e50d2c97">08994</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a25a386bc9b168cd30b3cee08e50d2c97">check_provisioning</a>(<span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">char</span> *si, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a4408245b2edc5f227220ea4f24ea0fab">ver</a>)
<a name="l08995"></a>08995 {
<a name="l08996"></a>08996    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ourver;
<a name="l08997"></a>08997    <span class="keywordtype">char</span> rsi[80];
<a name="l08998"></a>08998    snprintf(rsi, <span class="keyword">sizeof</span>(rsi), <span class="stringliteral">&quot;si-%s&quot;</span>, si);
<a name="l08999"></a>08999    <span class="keywordflow">if</span> (<a class="code" href="iax2-provision_8c.html#aa808516db326964a8a66f353cb7345f8">iax_provision_version</a>(&amp;ourver, rsi, 1))
<a name="l09000"></a>09000       <span class="keywordflow">return</span> 0;
<a name="l09001"></a>09001    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Service identifier &apos;%s&apos;, we think &apos;%08x&apos;, they think &apos;%08x&apos;\n&quot;</span>, si, ourver, ver);
<a name="l09002"></a>09002    <span class="keywordflow">if</span> (ourver != ver) 
<a name="l09003"></a>09003       <a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">iax2_provision</a>(sin, sockfd, NULL, rsi, 1);
<a name="l09004"></a>09004    <span class="keywordflow">return</span> 0;
<a name="l09005"></a>09005 }
<a name="l09006"></a>09006 
<a name="l09007"></a><a class="code" href="chan__iax2_8c.html#a3aee65d76c2b8a93f9dc595672a66a64">09007</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a3aee65d76c2b8a93f9dc595672a66a64">construct_rr</a>(<span class="keyword">struct</span> <a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt, <span class="keyword">struct</span> <a class="code" href="structiax__ie__data.html">iax_ie_data</a> *iep) 
<a name="l09008"></a>09008 {
<a name="l09009"></a>09009    <a class="code" href="structjb__info.html">jb_info</a> stats;
<a name="l09010"></a>09010    <a class="code" href="jitterbuf_8h.html#aed5937e57dcecf58443eb130f9f02d31" title="get jitterbuf info: only &amp;quot;statistics&amp;quot; may be valid">jb_getinfo</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#ac8dc7c4f19e394485de3d2ad0447df9f">jb</a>, &amp;stats);
<a name="l09011"></a>09011    
<a name="l09012"></a>09012    memset(iep, 0, <span class="keyword">sizeof</span>(*iep));
<a name="l09013"></a>09013 
<a name="l09014"></a>09014    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(iep,<a class="code" href="iax2_8h.html#a100faac82e7a555b80800464d51552f3">IAX_IE_RR_JITTER</a>, stats.<a class="code" href="structjb__info.html#af22a222c07f645ad8b7eab0d4e7c4e9d">jitter</a>);
<a name="l09015"></a>09015    <span class="keywordflow">if</span>(stats.<a class="code" href="structjb__info.html#a6b4cf44c3596e1c177e012e0a139b992">frames_in</a> == 0) stats.<a class="code" href="structjb__info.html#a6b4cf44c3596e1c177e012e0a139b992">frames_in</a> = 1;
<a name="l09016"></a>09016    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(iep,<a class="code" href="iax2_8h.html#ae75f46f96732b97c840acf7fcad50ccb">IAX_IE_RR_LOSS</a>, ((0xff &amp; (stats.<a class="code" href="structjb__info.html#a6dfda2a3ff35f2859488b5639d88715e">losspct</a>/1000)) &lt;&lt; 24 | (stats.<a class="code" href="structjb__info.html#aad59f039b77a1f7998a401966b6ec58d">frames_lost</a> &amp; 0x00ffffff)));
<a name="l09017"></a>09017    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(iep,<a class="code" href="iax2_8h.html#a08a91f2b8fdd4126433d23fb4b740a3c">IAX_IE_RR_PKTS</a>, stats.<a class="code" href="structjb__info.html#a6b4cf44c3596e1c177e012e0a139b992">frames_in</a>);
<a name="l09018"></a>09018    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(iep,<a class="code" href="iax2_8h.html#afff7da2dbd90c2c0a92ae1dbfdfaee46">IAX_IE_RR_DELAY</a>, stats.<a class="code" href="structjb__info.html#a67fec00dfad51ea05ccda5e0141a5169">current</a> - stats.<a class="code" href="structjb__info.html#a619cfe5e6bc1ed5a8c4d5601f9e159df">min</a>);
<a name="l09019"></a>09019    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(iep,<a class="code" href="iax2_8h.html#a7d903c665bc2b4ffcf30491cd1c3bf44">IAX_IE_RR_DROPPED</a>, stats.<a class="code" href="structjb__info.html#ad46c17494e36cde0dda69873d2246614">frames_dropped</a>);
<a name="l09020"></a>09020    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(iep,<a class="code" href="iax2_8h.html#abe860b9fd18425323db7b4b42b4fb563">IAX_IE_RR_OOO</a>, stats.<a class="code" href="structjb__info.html#ac437d83ff5b3b72934f71acb20f608ca">frames_ooo</a>);
<a name="l09021"></a>09021 }
<a name="l09022"></a>09022 
<a name="l09023"></a><a class="code" href="chan__iax2_8c.html#a055b632f6f93dea3d40d6cac70c907fa">09023</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a055b632f6f93dea3d40d6cac70c907fa">save_rr</a>(<span class="keyword">struct</span> iax_frame *fr, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies) 
<a name="l09024"></a>09024 {
<a name="l09025"></a>09025    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.jitter = ies-&gt;<a class="code" href="structiax__ies.html#a080276071d3f1453a3ff09eb12dc7be5">rr_jitter</a>;
<a name="l09026"></a>09026    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.losspct = ies-&gt;<a class="code" href="structiax__ies.html#a1ead91972465bf96d2e22e175f0451e6">rr_loss</a> &gt;&gt; 24;
<a name="l09027"></a>09027    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.losscnt = ies-&gt;<a class="code" href="structiax__ies.html#a1ead91972465bf96d2e22e175f0451e6">rr_loss</a> &amp; 0xffffff;
<a name="l09028"></a>09028    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.packets = ies-&gt;<a class="code" href="structiax__ies.html#a12dbd4506d9440630fbc064c7eaac5d7">rr_pkts</a>;
<a name="l09029"></a>09029    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.delay = ies-&gt;<a class="code" href="structiax__ies.html#ae1c0ba6c72f9ff39b2a31183bfe8f63c">rr_delay</a>;
<a name="l09030"></a>09030    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.dropped = ies-&gt;<a class="code" href="structiax__ies.html#a603c4be1ba3662978da1ef517995af10">rr_dropped</a>;
<a name="l09031"></a>09031    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;remote_rr.ooo = ies-&gt;<a class="code" href="structiax__ies.html#accda334a94b4f129ecdd0b9ad87bc423">rr_ooo</a>;
<a name="l09032"></a>09032 }
<a name="l09033"></a>09033 
<a name="l09034"></a><a class="code" href="chan__iax2_8c.html#a9efd9db6b7c50e9f56168269de1d6797">09034</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a9efd9db6b7c50e9f56168269de1d6797">save_osptoken</a>(<span class="keyword">struct</span> iax_frame *fr, <span class="keyword">struct</span> <a class="code" href="structiax__ies.html">iax_ies</a> *ies) 
<a name="l09035"></a>09035 {
<a name="l09036"></a>09036    <span class="keywordtype">int</span> i;
<a name="l09037"></a>09037    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length, offset = 0;
<a name="l09038"></a>09038    <span class="keywordtype">char</span> full_osptoken[<a class="code" href="iax2_8h.html#a898ff14effc5de094a96f4ed0ae75b6b">IAX_MAX_OSPBUFF_SIZE</a>];
<a name="l09039"></a>09039 
<a name="l09040"></a>09040    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="iax2_8h.html#ac5ec2eb1824053498ea1d9aaf6d85793">IAX_MAX_OSPBLOCK_NUM</a>; i++) {
<a name="l09041"></a>09041       length = ies-&gt;<a class="code" href="structiax__ies.html#a6f573c32d646cf725e7fc1709c49d5d4">ospblocklength</a>[i];
<a name="l09042"></a>09042       <span class="keywordflow">if</span> (length != 0) {
<a name="l09043"></a>09043          <span class="keywordflow">if</span> (length &gt; <a class="code" href="iax2_8h.html#a150226e8108553c73b5660f83455a5b8">IAX_MAX_OSPBLOCK_SIZE</a>) {
<a name="l09044"></a>09044             <span class="comment">/* OSP token block length wrong, clear buffer */</span>
<a name="l09045"></a>09045             offset = 0;
<a name="l09046"></a>09046             <span class="keywordflow">break</span>;
<a name="l09047"></a>09047          } <span class="keywordflow">else</span> {
<a name="l09048"></a>09048             memcpy(full_osptoken + offset, ies-&gt;<a class="code" href="structiax__ies.html#af5b31290a66339ea3d76c1a8735f4f5a">osptokenblock</a>[i], length);
<a name="l09049"></a>09049             offset += length;
<a name="l09050"></a>09050          }
<a name="l09051"></a>09051       } <span class="keywordflow">else</span> {
<a name="l09052"></a>09052          <span class="keywordflow">break</span>;
<a name="l09053"></a>09053       }
<a name="l09054"></a>09054    }
<a name="l09055"></a>09055    *(full_osptoken + offset) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09056"></a>09056    <span class="keywordflow">if</span> (strlen(full_osptoken) != offset) {
<a name="l09057"></a>09057       <span class="comment">/* OSP token length wrong, clear buffer */</span>
<a name="l09058"></a>09058       *full_osptoken = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09059"></a>09059    }
<a name="l09060"></a>09060 
<a name="l09061"></a>09061    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], osptoken, full_osptoken);
<a name="l09062"></a>09062 }
<a name="l09063"></a>09063 
<a name="l09064"></a><a class="code" href="chan__iax2_8c.html#ad5c5256eceb83cbf57a2c8a84b0b000c">09064</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ad5c5256eceb83cbf57a2c8a84b0b000c">log_jitterstats</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno)
<a name="l09065"></a>09065 {
<a name="l09066"></a>09066    <span class="keywordtype">int</span> localjitter = -1, localdelay = 0, locallost = -1, locallosspct = -1, localdropped = 0, localooo = -1, localpackets = -1;
<a name="l09067"></a>09067    <a class="code" href="structjb__info.html">jb_info</a> jbinfo;
<a name="l09068"></a>09068 
<a name="l09069"></a>09069    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l09070"></a>09070    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner-&gt;name) {
<a name="l09071"></a>09071       <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>)) {
<a name="l09072"></a>09072          <a class="code" href="jitterbuf_8h.html#aed5937e57dcecf58443eb130f9f02d31" title="get jitterbuf info: only &amp;quot;statistics&amp;quot; may be valid">jb_getinfo</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structast__channel.html#ac9cb7d989f739f5a082bcffd4262d4af">jb</a>, &amp;jbinfo);
<a name="l09073"></a>09073          localjitter = jbinfo.<a class="code" href="structjb__info.html#af22a222c07f645ad8b7eab0d4e7c4e9d">jitter</a>;
<a name="l09074"></a>09074          localdelay = jbinfo.<a class="code" href="structjb__info.html#a67fec00dfad51ea05ccda5e0141a5169">current</a> - jbinfo.<a class="code" href="structjb__info.html#a619cfe5e6bc1ed5a8c4d5601f9e159df">min</a>;
<a name="l09075"></a>09075          locallost = jbinfo.<a class="code" href="structjb__info.html#aad59f039b77a1f7998a401966b6ec58d">frames_lost</a>;
<a name="l09076"></a>09076          locallosspct = jbinfo.<a class="code" href="structjb__info.html#a6dfda2a3ff35f2859488b5639d88715e">losspct</a>/1000;
<a name="l09077"></a>09077          localdropped = jbinfo.<a class="code" href="structjb__info.html#ad46c17494e36cde0dda69873d2246614">frames_dropped</a>;
<a name="l09078"></a>09078          localooo = jbinfo.<a class="code" href="structjb__info.html#ac437d83ff5b3b72934f71acb20f608ca">frames_ooo</a>;
<a name="l09079"></a>09079          localpackets = jbinfo.<a class="code" href="structjb__info.html#a6b4cf44c3596e1c177e012e0a139b992">frames_in</a>;
<a name="l09080"></a>09080       }
<a name="l09081"></a>09081       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JB STATS:%s ping=%d ljitterms=%d ljbdelayms=%d ltotlost=%d lrecentlosspct=%d ldropped=%d looo=%d lrecvd=%d rjitterms=%d rjbdelayms=%d rtotlost=%d rrecentlosspct=%d rdropped=%d rooo=%d rrecvd=%d\n&quot;</span>,
<a name="l09082"></a>09082          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner-&gt;name,
<a name="l09083"></a>09083          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a>,
<a name="l09084"></a>09084          localjitter,
<a name="l09085"></a>09085          localdelay,
<a name="l09086"></a>09086          locallost,
<a name="l09087"></a>09087          locallosspct,
<a name="l09088"></a>09088          localdropped,
<a name="l09089"></a>09089          localooo,
<a name="l09090"></a>09090          localpackets,
<a name="l09091"></a>09091          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.jitter,
<a name="l09092"></a>09092          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.delay,
<a name="l09093"></a>09093          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.losscnt,
<a name="l09094"></a>09094          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.losspct/1000,
<a name="l09095"></a>09095          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.dropped,
<a name="l09096"></a>09096          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.ooo,
<a name="l09097"></a>09097          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.packets);
<a name="l09098"></a>09098       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <span class="stringliteral">&quot;JitterBufStats&quot;</span>, <span class="stringliteral">&quot;Owner: %s\r\nPing: %d\r\nLocalJitter: %d\r\nLocalJBDelay: %d\r\nLocalTotalLost: %d\r\nLocalLossPercent: %d\r\nLocalDropped: %d\r\nLocalooo: %d\r\nLocalReceived: %d\r\nRemoteJitter: %d\r\nRemoteJBDelay: %d\r\nRemoteTotalLost: %d\r\nRemoteLossPercent: %d\r\nRemoteDropped: %d\r\nRemoteooo: %d\r\nRemoteReceived: %d\r\n&quot;</span>,
<a name="l09099"></a>09099          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;owner-&gt;name,
<a name="l09100"></a>09100          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a>,
<a name="l09101"></a>09101          localjitter,
<a name="l09102"></a>09102          localdelay,
<a name="l09103"></a>09103          locallost,
<a name="l09104"></a>09104          locallosspct,
<a name="l09105"></a>09105          localdropped,
<a name="l09106"></a>09106          localooo,
<a name="l09107"></a>09107          localpackets,
<a name="l09108"></a>09108          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.jitter,
<a name="l09109"></a>09109          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.delay,
<a name="l09110"></a>09110          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.losscnt,
<a name="l09111"></a>09111          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.losspct/1000,
<a name="l09112"></a>09112          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.dropped,
<a name="l09113"></a>09113          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.ooo,
<a name="l09114"></a>09114          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;remote_rr.packets);
<a name="l09115"></a>09115    }
<a name="l09116"></a>09116    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l09117"></a>09117 }
<a name="l09118"></a>09118 
<a name="l09119"></a>09119 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a8f25a14008c8bf17bd1dc8da5617d176">socket_process</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>);
<a name="l09120"></a>09120 <span class="comment"></span>
<a name="l09121"></a>09121 <span class="comment">/*!</span>
<a name="l09122"></a>09122 <span class="comment"> * \brief Handle any deferred full frames for this thread</span>
<a name="l09123"></a>09123 <span class="comment"> */</span>
<a name="l09124"></a><a class="code" href="chan__iax2_8c.html#aa94f7fc0f211001b9f4792a2d8c7fdee">09124</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aa94f7fc0f211001b9f4792a2d8c7fdee" title="Handle any deferred full frames for this thread.">handle_deferred_full_frames</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>)
<a name="l09125"></a>09125 {
<a name="l09126"></a>09126    <span class="keyword">struct </span><a class="code" href="structiax2__pkt__buf.html">iax2_pkt_buf</a> *pkt_buf;
<a name="l09127"></a>09127 
<a name="l09128"></a>09128    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;thread-&gt;lock);
<a name="l09129"></a>09129 
<a name="l09130"></a>09130    <span class="keywordflow">while</span> ((pkt_buf = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;thread-&gt;full_frames, entry))) {
<a name="l09131"></a>09131       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;lock);
<a name="l09132"></a>09132 
<a name="l09133"></a>09133       thread-&gt;buf = pkt_buf-&gt;buf;
<a name="l09134"></a>09134       thread-&gt;buf_len = pkt_buf-&gt;len;
<a name="l09135"></a>09135       thread-&gt;buf_size = pkt_buf-&gt;len + 1;
<a name="l09136"></a>09136       
<a name="l09137"></a>09137       <a class="code" href="chan__iax2_8c.html#a8f25a14008c8bf17bd1dc8da5617d176">socket_process</a>(thread);
<a name="l09138"></a>09138 
<a name="l09139"></a>09139       thread-&gt;buf = NULL;
<a name="l09140"></a>09140       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(pkt_buf);
<a name="l09141"></a>09141 
<a name="l09142"></a>09142       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;thread-&gt;lock);
<a name="l09143"></a>09143    }
<a name="l09144"></a>09144 
<a name="l09145"></a>09145    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;lock);
<a name="l09146"></a>09146 }
<a name="l09147"></a>09147 <span class="comment"></span>
<a name="l09148"></a>09148 <span class="comment">/*!</span>
<a name="l09149"></a>09149 <span class="comment"> * \brief Queue the last read full frame for processing by a certain thread</span>
<a name="l09150"></a>09150 <span class="comment"> *</span>
<a name="l09151"></a>09151 <span class="comment"> * If there are already any full frames queued, they are sorted</span>
<a name="l09152"></a>09152 <span class="comment"> * by sequence number.</span>
<a name="l09153"></a>09153 <span class="comment"> */</span>
<a name="l09154"></a><a class="code" href="chan__iax2_8c.html#a2efd486657e7053cd762d301e7413a16">09154</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a2efd486657e7053cd762d301e7413a16" title="Queue the last read full frame for processing by a certain thread.">defer_full_frame</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__thread.html">iax2_thread</a> *from_here, <span class="keyword">struct</span> <a class="code" href="structiax2__thread.html">iax2_thread</a> *to_here)
<a name="l09155"></a>09155 {
<a name="l09156"></a>09156    <span class="keyword">struct </span><a class="code" href="structiax2__pkt__buf.html">iax2_pkt_buf</a> *pkt_buf, *cur_pkt_buf;
<a name="l09157"></a>09157    <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh, *cur_fh;
<a name="l09158"></a>09158 
<a name="l09159"></a>09159    <span class="keywordflow">if</span> (!(pkt_buf = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*pkt_buf) + from_here-&gt;buf_len)))
<a name="l09160"></a>09160       <span class="keywordflow">return</span>;
<a name="l09161"></a>09161 
<a name="l09162"></a>09162    pkt_buf-&gt;len = from_here-&gt;buf_len;
<a name="l09163"></a>09163    memcpy(pkt_buf-&gt;buf, from_here-&gt;buf, pkt_buf-&gt;len);
<a name="l09164"></a>09164 
<a name="l09165"></a>09165    fh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *) pkt_buf-&gt;buf;
<a name="l09166"></a>09166    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;to_here-&gt;lock);
<a name="l09167"></a>09167    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;to_here-&gt;full_frames, cur_pkt_buf, entry) {
<a name="l09168"></a>09168       cur_fh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *) cur_pkt_buf-&gt;buf;
<a name="l09169"></a>09169       if (fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> &lt; cur_fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>) {
<a name="l09170"></a>09170          <a class="code" href="linkedlists_8h.html#a83227c4f8c836f0452b607507c55752f" title="Inserts a list entry before the current entry during a traversal.">AST_LIST_INSERT_BEFORE_CURRENT</a>(pkt_buf, entry);
<a name="l09171"></a>09171          <span class="keywordflow">break</span>;
<a name="l09172"></a>09172       }
<a name="l09173"></a>09173    }
<a name="l09174"></a>09174    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l09175"></a>09175 
<a name="l09176"></a>09176    <span class="keywordflow">if</span> (!cur_pkt_buf)
<a name="l09177"></a>09177       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;to_here-&gt;full_frames, pkt_buf, entry);
<a name="l09178"></a>09178    
<a name="l09179"></a>09179    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;to_here-&gt;lock);
<a name="l09180"></a>09180 }
<a name="l09181"></a>09181 
<a name="l09182"></a><a class="code" href="chan__iax2_8c.html#ab30ccbd9565b8d995633142a78e63956">09182</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab30ccbd9565b8d995633142a78e63956">socket_read</a>(<span class="keywordtype">int</span> *<span class="keywordtype">id</span>, <span class="keywordtype">int</span> fd, <span class="keywordtype">short</span> <a class="code" href="app__adsiprog_8c.html#a31547b3fbfe860fc4518ce2332297f9b">events</a>, <span class="keywordtype">void</span> *cbdata)
<a name="l09183"></a>09183 {
<a name="l09184"></a>09184    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l09185"></a>09185    socklen_t <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l09186"></a>09186    time_t t;
<a name="l09187"></a>09187    <span class="keyword">static</span> time_t last_errtime = 0;
<a name="l09188"></a>09188    <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh;
<a name="l09189"></a>09189 
<a name="l09190"></a>09190    <span class="keywordflow">if</span> (!(thread = <a class="code" href="chan__iax2_8c.html#ad05e85b468e220b0f47d30809476825a">find_idle_thread</a>())) {
<a name="l09191"></a>09191       time(&amp;t);
<a name="l09192"></a>09192       <span class="keywordflow">if</span> (t != last_errtime)
<a name="l09193"></a>09193          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Out of idle IAX2 threads for I/O, pausing!\n&quot;</span>);
<a name="l09194"></a>09194       last_errtime = t;
<a name="l09195"></a>09195       usleep(1);
<a name="l09196"></a>09196       <span class="keywordflow">return</span> 1;
<a name="l09197"></a>09197    }
<a name="l09198"></a>09198 
<a name="l09199"></a>09199    len = <span class="keyword">sizeof</span>(thread-&gt;iosin);
<a name="l09200"></a>09200    thread-&gt;iofd = fd;
<a name="l09201"></a>09201    thread-&gt;buf_len = recvfrom(fd, thread-&gt;readbuf, <span class="keyword">sizeof</span>(thread-&gt;readbuf), 0, (<span class="keyword">struct</span> sockaddr *) &amp;thread-&gt;iosin, &amp;len);
<a name="l09202"></a>09202    thread-&gt;buf_size = <span class="keyword">sizeof</span>(thread-&gt;readbuf);
<a name="l09203"></a>09203    thread-&gt;buf = thread-&gt;readbuf;
<a name="l09204"></a>09204    <span class="keywordflow">if</span> (thread-&gt;buf_len &lt; 0) {
<a name="l09205"></a>09205       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != ECONNREFUSED &amp;&amp; <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EAGAIN)
<a name="l09206"></a>09206          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l09207"></a>09207       <a class="code" href="chan__iax2_8c.html#a2960735b3981c003fcbea255e52d3096">handle_error</a>();
<a name="l09208"></a>09208       thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">IAX_IOSTATE_IDLE</a>;
<a name="l09209"></a>09209       <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(&amp;thread-&gt;lock, &amp;thread-&gt;cond);
<a name="l09210"></a>09210       <span class="keywordflow">return</span> 1;
<a name="l09211"></a>09211    }
<a name="l09212"></a>09212    <span class="keywordflow">if</span> (test_losspct &amp;&amp; ((100.0 * <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() / (RAND_MAX + 1.0)) &lt; test_losspct)) { <span class="comment">/* simulate random loss condition */</span>
<a name="l09213"></a>09213       thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">IAX_IOSTATE_IDLE</a>;
<a name="l09214"></a>09214       <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(&amp;thread-&gt;lock, &amp;thread-&gt;cond);
<a name="l09215"></a>09215       <span class="keywordflow">return</span> 1;
<a name="l09216"></a>09216    }
<a name="l09217"></a>09217    
<a name="l09218"></a>09218    <span class="comment">/* Determine if this frame is a full frame; if so, and any thread is currently</span>
<a name="l09219"></a>09219 <span class="comment">      processing a full frame for the same callno from this peer, then drop this</span>
<a name="l09220"></a>09220 <span class="comment">      frame (and the peer will retransmit it) */</span>
<a name="l09221"></a>09221    fh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *) thread-&gt;buf;
<a name="l09222"></a>09222    if (ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) {
<a name="l09223"></a>09223       <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *cur = NULL;
<a name="l09224"></a>09224       uint16_t callno = ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>) &amp; ~<a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>;
<a name="l09225"></a>09225       
<a name="l09226"></a>09226       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;active_list);
<a name="l09227"></a>09227       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;active_list, cur, list) {
<a name="l09228"></a>09228          <span class="keywordflow">if</span> ((cur-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.callno == callno) &amp;&amp;
<a name="l09229"></a>09229              !<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;cur-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.sin, &amp;thread-&gt;iosin))
<a name="l09230"></a>09230             <span class="keywordflow">break</span>;
<a name="l09231"></a>09231       }
<a name="l09232"></a>09232       <span class="keywordflow">if</span> (cur) {
<a name="l09233"></a>09233          <span class="comment">/* we found another thread processing a full frame for this call,</span>
<a name="l09234"></a>09234 <span class="comment">            so queue it up for processing later. */</span>
<a name="l09235"></a>09235          <a class="code" href="chan__iax2_8c.html#a2efd486657e7053cd762d301e7413a16" title="Queue the last read full frame for processing by a certain thread.">defer_full_frame</a>(thread, cur);
<a name="l09236"></a>09236          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;active_list);
<a name="l09237"></a>09237          thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">IAX_IOSTATE_IDLE</a>;
<a name="l09238"></a>09238          <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(&amp;thread-&gt;lock, &amp;thread-&gt;cond);
<a name="l09239"></a>09239          <span class="keywordflow">return</span> 1;
<a name="l09240"></a>09240       } <span class="keywordflow">else</span> {
<a name="l09241"></a>09241          <span class="comment">/* this thread is going to process this frame, so mark it */</span>
<a name="l09242"></a>09242          thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.callno = callno;
<a name="l09243"></a>09243          memcpy(&amp;thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.sin, &amp;thread-&gt;iosin, <span class="keyword">sizeof</span>(thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.sin));
<a name="l09244"></a>09244          thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.type = fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a>;
<a name="l09245"></a>09245          thread-&gt;<a class="code" href="structiax2__thread.html#a792f50026b0582bcc5f3cdbfa053fb93">ffinfo</a>.csub = fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a>;
<a name="l09246"></a>09246       }
<a name="l09247"></a>09247       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;active_list);
<a name="l09248"></a>09248    }
<a name="l09249"></a>09249    
<a name="l09250"></a>09250    <span class="comment">/* Mark as ready and send on its way */</span>
<a name="l09251"></a>09251    thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3ac99d54ed94b3fffa9269fc588e37122d">IAX_IOSTATE_READY</a>;
<a name="l09252"></a>09252 <span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l09253"></a>09253 <span class="preprocessor"></span>   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(thread-&gt;curfunc, <span class="stringliteral">&quot;socket_process&quot;</span>, <span class="keyword">sizeof</span>(thread-&gt;curfunc));
<a name="l09254"></a>09254 <span class="preprocessor">#endif</span>
<a name="l09255"></a>09255 <span class="preprocessor"></span>   <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(&amp;thread-&gt;lock, &amp;thread-&gt;cond);
<a name="l09256"></a>09256 
<a name="l09257"></a>09257    <span class="keywordflow">return</span> 1;
<a name="l09258"></a>09258 }
<a name="l09259"></a>09259 
<a name="l09260"></a><a class="code" href="chan__iax2_8c.html#af042d0d3beceab2475e84d4c711b3cd4">09260</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#af042d0d3beceab2475e84d4c711b3cd4">socket_process_meta</a>(<span class="keywordtype">int</span> packet_len, <span class="keyword">struct</span> <a class="code" href="structast__iax2__meta__hdr.html">ast_iax2_meta_hdr</a> *meta, <span class="keyword">struct</span> sockaddr_in *sin, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>,
<a name="l09261"></a>09261    <span class="keyword">struct</span> iax_frame *fr)
<a name="l09262"></a>09262 {
<a name="l09263"></a>09263    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> metatype;
<a name="l09264"></a>09264    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__mini.html">ast_iax2_meta_trunk_mini</a> *mtm;
<a name="l09265"></a>09265    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__hdr.html">ast_iax2_meta_trunk_hdr</a> *mth;
<a name="l09266"></a>09266    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__entry.html">ast_iax2_meta_trunk_entry</a> *mte;
<a name="l09267"></a>09267    <span class="keyword">struct </span><a class="code" href="structiax2__trunk__peer.html">iax2_trunk_peer</a> *tpeer;
<a name="l09268"></a>09268    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts;
<a name="l09269"></a>09269    <span class="keywordtype">void</span> *ptr;
<a name="l09270"></a>09270    <span class="keyword">struct </span>timeval rxtrunktime;
<a name="l09271"></a>09271    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { 0, };
<a name="l09272"></a>09272 
<a name="l09273"></a>09273    <span class="keywordflow">if</span> (packet_len &lt; <span class="keyword">sizeof</span>(*meta)) {
<a name="l09274"></a>09274       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Rejecting packet from &apos;%s.%d&apos; that is flagged as a meta frame but is too short\n&quot;</span>, 
<a name="l09275"></a>09275          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port));
<a name="l09276"></a>09276       <span class="keywordflow">return</span> 1;
<a name="l09277"></a>09277    }
<a name="l09278"></a>09278 
<a name="l09279"></a>09279    <span class="keywordflow">if</span> (meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#ac778073eb75dbcc51a045b8b423cda15">metacmd</a> != <a class="code" href="iax2_8h.html#aca93bd4918b00346d63b4c3d3dd25ddf">IAX_META_TRUNK</a>)
<a name="l09280"></a>09280       <span class="keywordflow">return</span> 1;
<a name="l09281"></a>09281 
<a name="l09282"></a>09282    <span class="keywordflow">if</span> (packet_len &lt; (<span class="keyword">sizeof</span>(*meta) + <span class="keyword">sizeof</span>(*mth))) {
<a name="l09283"></a>09283       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;midget meta trunk packet received (%d of %d min)\n&quot;</span>, packet_len,
<a name="l09284"></a>09284          (<span class="keywordtype">int</span>) (<span class="keyword">sizeof</span>(*meta) + <span class="keyword">sizeof</span>(*mth)));
<a name="l09285"></a>09285       <span class="keywordflow">return</span> 1;
<a name="l09286"></a>09286    }
<a name="l09287"></a>09287    mth = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__hdr.html">ast_iax2_meta_trunk_hdr</a> *)(meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#aef5b927d15f11382bf5f276630c08287">data</a>);
<a name="l09288"></a>09288    ts = ntohl(mth-&gt;<a class="code" href="structast__iax2__meta__trunk__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l09289"></a>09289    metatype = meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#ac5e01aa10e4be943d73207e55ff03668">cmddata</a>;
<a name="l09290"></a>09290    packet_len -= (<span class="keyword">sizeof</span>(*meta) + <span class="keyword">sizeof</span>(*mth));
<a name="l09291"></a>09291    ptr = mth-&gt;<a class="code" href="structast__iax2__meta__trunk__hdr.html#aef5b927d15f11382bf5f276630c08287">data</a>;
<a name="l09292"></a>09292    tpeer = <a class="code" href="chan__iax2_8c.html#a3a65a4f4c03f106210da983a7eb7d9e6">find_tpeer</a>(sin, sockfd);
<a name="l09293"></a>09293    <span class="keywordflow">if</span> (!tpeer) {
<a name="l09294"></a>09294       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to accept trunked packet from &apos;%s:%d&apos;: No matching peer\n&quot;</span>, 
<a name="l09295"></a>09295          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port));
<a name="l09296"></a>09296       <span class="keywordflow">return</span> 1;
<a name="l09297"></a>09297    }
<a name="l09298"></a>09298    tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">trunkact</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l09299"></a>09299    <span class="keywordflow">if</span> (!ts || <a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a29f80e536bea489aed0b8ae715a60622">rxtrunktime</a>))
<a name="l09300"></a>09300       tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a29f80e536bea489aed0b8ae715a60622">rxtrunktime</a> = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#aa1265874a74a762ed8ea43d82292a74e">trunkact</a>;
<a name="l09301"></a>09301    rxtrunktime = tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#a29f80e536bea489aed0b8ae715a60622">rxtrunktime</a>;
<a name="l09302"></a>09302    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;tpeer-&gt;<a class="code" href="structiax2__trunk__peer.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l09303"></a>09303    <span class="keywordflow">while</span> (packet_len &gt;= <span class="keyword">sizeof</span>(*mte)) {
<a name="l09304"></a>09304       <span class="comment">/* Process channels */</span>
<a name="l09305"></a>09305       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno, trunked_ts, <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l09306"></a>09306 
<a name="l09307"></a>09307       <span class="keywordflow">if</span> (metatype == <a class="code" href="iax2_8h.html#accf935c9f6078e9873ab26b692247326">IAX_META_TRUNK_MINI</a>) {
<a name="l09308"></a>09308          mtm = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__mini.html">ast_iax2_meta_trunk_mini</a> *) ptr;
<a name="l09309"></a>09309          ptr += <span class="keyword">sizeof</span>(*mtm);
<a name="l09310"></a>09310          packet_len -= <span class="keyword">sizeof</span>(*mtm);
<a name="l09311"></a>09311          len = ntohs(mtm-&gt;<a class="code" href="structast__iax2__meta__trunk__mini.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>);
<a name="l09312"></a>09312          callno = ntohs(mtm-&gt;<a class="code" href="structast__iax2__meta__trunk__mini.html#ae8e551054064c8226650232d25994252">mini</a>.<a class="code" href="structast__iax2__mini__hdr.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l09313"></a>09313          trunked_ts = ntohs(mtm-&gt;<a class="code" href="structast__iax2__meta__trunk__mini.html#ae8e551054064c8226650232d25994252">mini</a>.<a class="code" href="structast__iax2__mini__hdr.html#a84074dc9c4d9c2bdd3fbad69e032e9f7">ts</a>);
<a name="l09314"></a>09314       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (metatype == <a class="code" href="iax2_8h.html#a3ddeeaffe7804b8f58dceed45c8f5419">IAX_META_TRUNK_SUPERMINI</a>) {
<a name="l09315"></a>09315          mte = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__trunk__entry.html">ast_iax2_meta_trunk_entry</a> *)ptr;
<a name="l09316"></a>09316          ptr += <span class="keyword">sizeof</span>(*mte);
<a name="l09317"></a>09317          packet_len -= <span class="keyword">sizeof</span>(*mte);
<a name="l09318"></a>09318          len = ntohs(mte-&gt;<a class="code" href="structast__iax2__meta__trunk__entry.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>);
<a name="l09319"></a>09319          callno = ntohs(mte-&gt;<a class="code" href="structast__iax2__meta__trunk__entry.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l09320"></a>09320          trunked_ts = 0;
<a name="l09321"></a>09321       } <span class="keywordflow">else</span> {
<a name="l09322"></a>09322          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown meta trunk cmd from &apos;%s:%d&apos;: dropping\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin-&gt;sin_addr), ntohs(sin-&gt;sin_port));
<a name="l09323"></a>09323          <span class="keywordflow">break</span>;
<a name="l09324"></a>09324       }
<a name="l09325"></a>09325       <span class="comment">/* Stop if we don&apos;t have enough data */</span>
<a name="l09326"></a>09326       <span class="keywordflow">if</span> (len &gt; packet_len)
<a name="l09327"></a>09327          <span class="keywordflow">break</span>;
<a name="l09328"></a>09328       fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = <a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">find_callno_locked</a>(callno &amp; ~<a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>, 0, sin, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a4b271784626bbfd88ad47a67f4bd82bf">NEW_PREVENT</a>, sockfd, 0);
<a name="l09329"></a>09329       <span class="keywordflow">if</span> (!fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)
<a name="l09330"></a>09330          <span class="keywordflow">continue</span>;
<a name="l09331"></a>09331 
<a name="l09332"></a>09332       <span class="comment">/* If it&apos;s a valid call, deliver the contents.  If not, we</span>
<a name="l09333"></a>09333 <span class="comment">         drop it, since we don&apos;t have a scallno to use for an INVAL */</span>
<a name="l09334"></a>09334       <span class="comment">/* Process as a mini frame */</span>
<a name="l09335"></a>09335       memset(&amp;f, 0, <span class="keyword">sizeof</span>(f));
<a name="l09336"></a>09336       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l09337"></a>09337       <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l09338"></a>09338          <span class="comment">/* drop it */</span>
<a name="l09339"></a>09339       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a> == 0) {
<a name="l09340"></a>09340          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Received trunked frame before first full voice frame\n&quot;</span>);
<a name="l09341"></a>09341          <a class="code" href="chan__iax2_8c.html#ac36e579cc52653790930d8bb00e05493">iax2_vnak</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l09342"></a>09342       } <span class="keywordflow">else</span> {
<a name="l09343"></a>09343          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a>;
<a name="l09344"></a>09344          f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = len;
<a name="l09345"></a>09345          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &gt;= 0) {
<a name="l09346"></a>09346             <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l09347"></a>09347                f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = ptr;
<a name="l09348"></a>09348             <span class="keywordflow">else</span>
<a name="l09349"></a>09349                f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = NULL;
<a name="l09350"></a>09350             <span class="keywordflow">if</span> (trunked_ts)
<a name="l09351"></a>09351                fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &amp; 0xFFFF0000L) | (trunked_ts &amp; 0xffff);
<a name="l09352"></a>09352             <span class="keywordflow">else</span>
<a name="l09353"></a>09353                fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = <a class="code" href="chan__iax2_8c.html#a27f837b22eb6b818a14725cc095cd72d">fix_peerts</a>(&amp;rxtrunktime, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, ts);
<a name="l09354"></a>09354             <span class="comment">/* Don&apos;t pass any packets until we&apos;re started */</span>
<a name="l09355"></a>09355             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>)) {
<a name="l09356"></a>09356                <span class="keyword">struct </span>iax_frame *duped_fr;
<a name="l09357"></a>09357 
<a name="l09358"></a>09358                <span class="comment">/* Common things */</span>
<a name="l09359"></a>09359                f.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;IAX2&quot;</span>;
<a name="l09360"></a>09360                f.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l09361"></a>09361                f.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0;
<a name="l09362"></a>09362                <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &amp;&amp; (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)) 
<a name="l09363"></a>09363                   f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="frame_8h.html#aedec72ae8357bb6c334111f93d283713" title="Returns the number of samples contained in the frame.">ast_codec_get_samples</a>(&amp;f);
<a name="l09364"></a>09364                <span class="keywordflow">else</span>
<a name="l09365"></a>09365                   f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l09366"></a>09366                fr-&gt;<a class="code" href="structiax__frame.html#a6e7821d1104da8531b94a618524f8d9b">outoforder</a> = 0;
<a name="l09367"></a>09367                <a class="code" href="iax2-parser_8c.html#ac7172830d863702f96f81d8a09612428">iax_frame_wrap</a>(fr, &amp;f);
<a name="l09368"></a>09368                duped_fr = <a class="code" href="chan__iax2_8c.html#aa8a32e0915c1d863697804c3702f439b">iaxfrdup2</a>(fr);
<a name="l09369"></a>09369                <span class="keywordflow">if</span> (duped_fr)
<a name="l09370"></a>09370                   <a class="code" href="chan__iax2_8c.html#a3ec86bd0172f439ef6e7a00cb5f1b699">schedule_delivery</a>(duped_fr, 1, 1, &amp;fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l09371"></a>09371                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &lt; fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>)
<a name="l09372"></a>09372                   <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l09373"></a>09373             }
<a name="l09374"></a>09374          } <span class="keywordflow">else</span> {
<a name="l09375"></a>09375             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Datalen &lt; 0?\n&quot;</span>);
<a name="l09376"></a>09376          }
<a name="l09377"></a>09377       }
<a name="l09378"></a>09378       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09379"></a>09379       ptr += len;
<a name="l09380"></a>09380       packet_len -= len;
<a name="l09381"></a>09381    }
<a name="l09382"></a>09382 
<a name="l09383"></a>09383    <span class="keywordflow">return</span> 1;
<a name="l09384"></a>09384 }
<a name="l09385"></a>09385 
<a name="l09386"></a><a class="code" href="chan__iax2_8c.html#aca64fee93c59ab92caa7712d52c74d8b">09386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aca64fee93c59ab92caa7712d52c74d8b">acf_iaxvar_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *<a class="code" href="structiax__frame.html#a735984d41155bc1032e09bece8f8d66d">data</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l09387"></a>09387 {
<a name="l09388"></a>09388    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l09389"></a>09389    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l09390"></a>09390    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l09391"></a>09391 
<a name="l09392"></a>09392    <span class="keywordflow">if</span> (!variablestore) {
<a name="l09393"></a>09393       *buf = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09394"></a>09394       <span class="keywordflow">return</span> 0;
<a name="l09395"></a>09395    }
<a name="l09396"></a>09396    varlist = variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l09397"></a>09397 
<a name="l09398"></a>09398    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(varlist);
<a name="l09399"></a>09399    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(varlist, var, entries) {
<a name="l09400"></a>09400       <span class="keywordflow">if</span> (strcmp(var-&gt;<a class="code" href="structast__var__t.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, data) == 0) {
<a name="l09401"></a>09401          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, var-&gt;<a class="code" href="structast__var__t.html#a4e9aec275e566b978a3ccb4e043d8c61">value</a>, len);
<a name="l09402"></a>09402          <span class="keywordflow">break</span>;
<a name="l09403"></a>09403       }
<a name="l09404"></a>09404    }
<a name="l09405"></a>09405    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(varlist);
<a name="l09406"></a>09406    <span class="keywordflow">return</span> 0;
<a name="l09407"></a>09407 }
<a name="l09408"></a>09408 
<a name="l09409"></a><a class="code" href="chan__iax2_8c.html#a76e564a9cb7810b9ae64c4bb69293bad">09409</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a76e564a9cb7810b9ae64c4bb69293bad">acf_iaxvar_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__var__t.html#a4e9aec275e566b978a3ccb4e043d8c61">value</a>)
<a name="l09410"></a>09410 {
<a name="l09411"></a>09411    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l09412"></a>09412    <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l09413"></a>09413    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l09414"></a>09414 
<a name="l09415"></a>09415    <span class="keywordflow">if</span> (!variablestore) {
<a name="l09416"></a>09416       variablestore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l09417"></a>09417       <span class="keywordflow">if</span> (!variablestore) {
<a name="l09418"></a>09418          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error\n&quot;</span>);
<a name="l09419"></a>09419          <span class="keywordflow">return</span> -1;
<a name="l09420"></a>09420       }
<a name="l09421"></a>09421       varlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*varlist));
<a name="l09422"></a>09422       <span class="keywordflow">if</span> (!varlist) {
<a name="l09423"></a>09423          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to assign new variable &apos;%s&apos;\n&quot;</span>, data);
<a name="l09424"></a>09424          <span class="keywordflow">return</span> -1;
<a name="l09425"></a>09425       }
<a name="l09426"></a>09426 
<a name="l09427"></a>09427       <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(varlist);
<a name="l09428"></a>09428       variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = varlist;
<a name="l09429"></a>09429       variablestore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l09430"></a>09430       <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, variablestore);
<a name="l09431"></a>09431    } <span class="keywordflow">else</span>
<a name="l09432"></a>09432       varlist = variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l09433"></a>09433 
<a name="l09434"></a>09434    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(varlist);
<a name="l09435"></a>09435    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(varlist, var, entries) {
<a name="l09436"></a>09436       <span class="keywordflow">if</span> (strcmp(var-&gt;<a class="code" href="structast__var__t.html#afd3f693e384b1ee0a0c44d58351eb87d">name</a>, data) == 0) {
<a name="l09437"></a>09437          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entries);
<a name="l09438"></a>09438          <a class="code" href="chanvars_8h.html#a52aaa758ed30031250c2d356b993c6d9">ast_var_delete</a>(var);
<a name="l09439"></a>09439          <span class="keywordflow">break</span>;
<a name="l09440"></a>09440       }
<a name="l09441"></a>09441    }
<a name="l09442"></a>09442    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l09443"></a>09443    var = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(data, value);
<a name="l09444"></a>09444    <span class="keywordflow">if</span> (var)
<a name="l09445"></a>09445       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(varlist, var, entries);
<a name="l09446"></a>09446    <span class="keywordflow">else</span>
<a name="l09447"></a>09447       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to assign new variable &apos;%s&apos;\n&quot;</span>, data);
<a name="l09448"></a>09448    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(varlist);
<a name="l09449"></a>09449    <span class="keywordflow">return</span> 0;
<a name="l09450"></a>09450 }
<a name="l09451"></a>09451 
<a name="l09452"></a><a class="code" href="chan__iax2_8c.html#a2d5637f32186301ce90427bd34116958">09452</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="chan__iax2_8c.html#a2d5637f32186301ce90427bd34116958">iaxvar_function</a> = {
<a name="l09453"></a>09453    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;IAXVAR&quot;</span>,
<a name="l09454"></a>09454    .read = <a class="code" href="chan__iax2_8c.html#aca64fee93c59ab92caa7712d52c74d8b">acf_iaxvar_read</a>,
<a name="l09455"></a>09455    .write = <a class="code" href="chan__iax2_8c.html#a76e564a9cb7810b9ae64c4bb69293bad">acf_iaxvar_write</a>,
<a name="l09456"></a>09456 };
<a name="l09457"></a>09457 
<a name="l09458"></a><a class="code" href="chan__iax2_8c.html#a8f25a14008c8bf17bd1dc8da5617d176">09458</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a8f25a14008c8bf17bd1dc8da5617d176">socket_process</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>)
<a name="l09459"></a>09459 {
<a name="l09460"></a>09460    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l09461"></a>09461    <span class="keywordtype">int</span> res;
<a name="l09462"></a>09462    <span class="keywordtype">int</span> updatehistory=1;
<a name="l09463"></a>09463    <span class="keywordtype">int</span> <span class="keyword">new</span> = <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a4b271784626bbfd88ad47a67f4bd82bf">NEW_PREVENT</a>;
<a name="l09464"></a>09464    <span class="keywordtype">int</span> dcallno = 0;
<a name="l09465"></a>09465    <span class="keywordtype">char</span> decrypted = 0;
<a name="l09466"></a>09466    <span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *fh = (<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a> *)thread-&gt;buf;
<a name="l09467"></a>09467    <span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a> *mh = (<span class="keyword">struct</span> <a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a> *)thread-&gt;buf;
<a name="l09468"></a>09468    <span class="keyword">struct </span><a class="code" href="structast__iax2__meta__hdr.html">ast_iax2_meta_hdr</a> *meta = (<span class="keyword">struct </span><a class="code" href="structast__iax2__meta__hdr.html">ast_iax2_meta_hdr</a> *)thread-&gt;buf;
<a name="l09469"></a>09469    <span class="keyword">struct</span> <a class="code" href="structast__iax2__video__hdr.html">ast_iax2_video_hdr</a> *vh = (<span class="keyword">struct</span> <a class="code" href="structast__iax2__video__hdr.html">ast_iax2_video_hdr</a> *)thread-&gt;buf;
<a name="l09470"></a>09470    <span class="keyword">struct </span>iax_frame *fr;
<a name="l09471"></a>09471    <span class="keyword">struct </span>iax_frame *cur;
<a name="l09472"></a>09472    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> f = { 0, };
<a name="l09473"></a>09473    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = NULL;
<a name="l09474"></a>09474    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp;
<a name="l09475"></a>09475    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l09476"></a>09476    <span class="keyword">struct </span><a class="code" href="structiax__ies.html">iax_ies</a> ies;
<a name="l09477"></a>09477    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied0, ied1;
<a name="l09478"></a>09478    <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>;
<a name="l09479"></a>09479    <span class="keywordtype">int</span> fd;
<a name="l09480"></a>09480    <span class="keywordtype">int</span> <a class="code" href="func__logic_8c.html#ad6f8d00a94914824d3b6048722c42332">exists</a>;
<a name="l09481"></a>09481    <span class="keywordtype">int</span> minivid = 0;
<a name="l09482"></a>09482    <span class="keywordtype">char</span> empty[32]=<span class="stringliteral">&quot;&quot;</span>;      <span class="comment">/* Safety measure */</span>
<a name="l09483"></a>09483    <span class="keyword">struct </span>iax_frame *duped_fr;
<a name="l09484"></a>09484    <span class="keywordtype">char</span> host_pref_buf[128];
<a name="l09485"></a>09485    <span class="keywordtype">char</span> caller_pref_buf[128];
<a name="l09486"></a>09486    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> pref;
<a name="l09487"></a>09487    <span class="keywordtype">char</span> *using_prefs = <span class="stringliteral">&quot;mine&quot;</span>;
<a name="l09488"></a>09488 
<a name="l09489"></a>09489    <span class="comment">/* allocate an iax_frame with 4096 bytes of data buffer */</span>
<a name="l09490"></a>09490    fr = alloca(<span class="keyword">sizeof</span>(*fr) + 4096);
<a name="l09491"></a>09491    memset(fr, 0, <span class="keyword">sizeof</span>(*fr));
<a name="l09492"></a>09492    fr-&gt;<a class="code" href="structiax__frame.html#ac6dd018a429627fc0ad8d167c7c46ef4">afdatalen</a> = 4096; <span class="comment">/* From alloca() above */</span>
<a name="l09493"></a>09493 
<a name="l09494"></a>09494    <span class="comment">/* Copy frequently used parameters to the stack */</span>
<a name="l09495"></a>09495    res = thread-&gt;buf_len;
<a name="l09496"></a>09496    fd = thread-&gt;iofd;
<a name="l09497"></a>09497    memcpy(&amp;sin, &amp;thread-&gt;iosin, <span class="keyword">sizeof</span>(sin));
<a name="l09498"></a>09498 
<a name="l09499"></a>09499    <span class="keywordflow">if</span> (res &lt; <span class="keyword">sizeof</span>(*mh)) {
<a name="l09500"></a>09500       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;midget packet received (%d of %d min)\n&quot;</span>, res, (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(*mh));
<a name="l09501"></a>09501       <span class="keywordflow">return</span> 1;
<a name="l09502"></a>09502    }
<a name="l09503"></a>09503    <span class="keywordflow">if</span> ((vh-&gt;zeros == 0) &amp;&amp; (ntohs(vh-&gt;callno) &amp; 0x8000)) {
<a name="l09504"></a>09504       <span class="keywordflow">if</span> (res &lt; <span class="keyword">sizeof</span>(*vh)) {
<a name="l09505"></a>09505          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Rejecting packet from &apos;%s.%d&apos; that is flagged as a video frame but is too short\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), ntohs(sin.sin_port));
<a name="l09506"></a>09506          <span class="keywordflow">return</span> 1;
<a name="l09507"></a>09507       }
<a name="l09508"></a>09508 
<a name="l09509"></a>09509       <span class="comment">/* This is a video frame, get call number */</span>
<a name="l09510"></a>09510       fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = <a class="code" href="chan__iax2_8c.html#a26cef2567af74205496ef576f775ef05">find_callno</a>(ntohs(vh-&gt;callno) &amp; ~0x8000, dcallno, &amp;sin, <span class="keyword">new</span>, fd, 0);
<a name="l09511"></a>09511       minivid = 1;
<a name="l09512"></a>09512    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#a536adab2c572868ca3f967c9d370e5b3">zeros</a> == 0) &amp;&amp; !(ntohs(meta-&gt;<a class="code" href="structast__iax2__meta__hdr.html#ac778073eb75dbcc51a045b8b423cda15">metacmd</a>) &amp; 0x8000))
<a name="l09513"></a>09513       <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#af042d0d3beceab2475e84d4c711b3cd4">socket_process_meta</a>(res, meta, &amp;sin, fd, fr);
<a name="l09514"></a>09514 
<a name="l09515"></a>09515 <span class="preprocessor">#ifdef DEBUG_SUPPORT</span>
<a name="l09516"></a>09516 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (res &gt;= <span class="keyword">sizeof</span>(*fh))
<a name="l09517"></a>09517       <a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">iax_outputframe</a>(NULL, fh, 1, &amp;sin, res - <span class="keyword">sizeof</span>(*fh));
<a name="l09518"></a>09518 <span class="preprocessor">#endif</span>
<a name="l09519"></a>09519 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (ntohs(mh-&gt;callno) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) {
<a name="l09520"></a>09520       <span class="keywordflow">if</span> (res &lt; <span class="keyword">sizeof</span>(*fh)) {
<a name="l09521"></a>09521          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Rejecting packet from &apos;%s.%d&apos; that is flagged as a full frame but is too short\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), ntohs(sin.sin_port));
<a name="l09522"></a>09522          <span class="keywordflow">return</span> 1;
<a name="l09523"></a>09523       }
<a name="l09524"></a>09524 
<a name="l09525"></a>09525       <span class="comment">/* Get the destination call number */</span>
<a name="l09526"></a>09526       dcallno = ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>) &amp; ~<a class="code" href="iax2_8h.html#a9c7b219ff307b8867b301264fd443c62">IAX_FLAG_RETRANS</a>;
<a name="l09527"></a>09527 
<a name="l09528"></a>09528 
<a name="l09529"></a>09529       <span class="comment">/* check to make sure this full frame isn&apos;t encrypted before we attempt</span>
<a name="l09530"></a>09530 <span class="comment">       * to look inside of it. If it is encrypted, decrypt it first. Its ok if the</span>
<a name="l09531"></a>09531 <span class="comment">       * callno is not found here, that just means one hasn&apos;t been allocated for</span>
<a name="l09532"></a>09532 <span class="comment">       * this connection yet. */</span>
<a name="l09533"></a>09533       <span class="keywordflow">if</span> ((dcallno != 1) &amp;&amp; (fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = <a class="code" href="chan__iax2_8c.html#a26cef2567af74205496ef576f775ef05">find_callno</a>(ntohs(mh-&gt;callno) &amp; ~<a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>, dcallno, &amp;sin, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a4b271784626bbfd88ad47a67f4bd82bf">NEW_PREVENT</a>, fd, 1))) {
<a name="l09534"></a>09534          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09535"></a>09535          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a>)) {
<a name="l09536"></a>09536             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#aa99b47192edc30f24177358dd1d5038a">decrypt_frame</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, fh, &amp;f, &amp;res)) {
<a name="l09537"></a>09537                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Packet Decrypt Failed!\n&quot;</span>);
<a name="l09538"></a>09538                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09539"></a>09539                <span class="keywordflow">return</span> 1;
<a name="l09540"></a>09540             }
<a name="l09541"></a>09541             decrypted = 1;
<a name="l09542"></a>09542          }
<a name="l09543"></a>09543          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09544"></a>09544       }
<a name="l09545"></a>09545 
<a name="l09546"></a>09546       <span class="comment">/* Retrieve the type and subclass */</span>
<a name="l09547"></a>09547       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#aa5044999f3339d2ba3b1bf22fa6cfe95">type</a>;
<a name="l09548"></a>09548       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l09549"></a>09549          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">uncompress_subclass</a>(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> &amp; ~0x40) | ((fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a> &gt;&gt; 6) &amp; 0x1);
<a name="l09550"></a>09550       } <span class="keywordflow">else</span> {
<a name="l09551"></a>09551          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#aa7d0a9031dde791cdd5c2da2892c10fb">uncompress_subclass</a>(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a73182c303ad7f5aab20b65f13efa2582">csub</a>);
<a name="l09552"></a>09552       }
<a name="l09553"></a>09553 
<a name="l09554"></a>09554       <span class="comment">/* Deal with POKE/PONG without allocating a callno */</span>
<a name="l09555"></a>09555       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a> &amp;&amp; f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effaa68c0d056acb361b1117cbad4121d418">IAX_COMMAND_POKE</a>) {
<a name="l09556"></a>09556          <span class="comment">/* Reply back with a PONG, but don&apos;t care about the result. */</span>
<a name="l09557"></a>09557          <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(1, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>), &amp;sin, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa499c741ada032d5c451e6f45580a6444">IAX_COMMAND_PONG</a>, ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>), fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> + 1, fd, NULL);
<a name="l09558"></a>09558          <span class="keywordflow">return</span> 1;
<a name="l09559"></a>09559       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a> &amp;&amp; f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a> &amp;&amp; dcallno == 1) {
<a name="l09560"></a>09560          <span class="comment">/* Ignore */</span>
<a name="l09561"></a>09561          <span class="keywordflow">return</span> 1;
<a name="l09562"></a>09562       }
<a name="l09563"></a>09563 
<a name="l09564"></a>09564       f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res - <span class="keyword">sizeof</span>(*fh);
<a name="l09565"></a>09565       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>) {
<a name="l09566"></a>09566          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) {
<a name="l09567"></a>09567             <span class="keywordflow">if</span> (<a class="code" href="iax2-parser_8c.html#a008130bffa0c54d95782e1bb14bb24fd">iax_parse_ies</a>(&amp;ies, thread-&gt;buf + <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>), f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)) {
<a name="l09568"></a>09568                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Undecodable frame received from &apos;%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr));
<a name="l09569"></a>09569                <span class="keywordflow">return</span> 1;
<a name="l09570"></a>09570             }
<a name="l09571"></a>09571             f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = NULL;
<a name="l09572"></a>09572             f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l09573"></a>09573          } <span class="keywordflow">else</span> {
<a name="l09574"></a>09574             f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = thread-&gt;buf + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__full__hdr.html">ast_iax2_full_hdr</a>);
<a name="l09575"></a>09575             memset(&amp;ies, 0, <span class="keyword">sizeof</span>(ies));
<a name="l09576"></a>09576          }
<a name="l09577"></a>09577       } <span class="keywordflow">else</span> {
<a name="l09578"></a>09578          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>)
<a name="l09579"></a>09579             f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = NULL;
<a name="l09580"></a>09580          <span class="keywordflow">else</span>
<a name="l09581"></a>09581             f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = empty;
<a name="l09582"></a>09582          memset(&amp;ies, 0, <span class="keyword">sizeof</span>(ies));
<a name="l09583"></a>09583       }
<a name="l09584"></a>09584 
<a name="l09585"></a>09585       <span class="keywordflow">if</span> (!dcallno &amp;&amp; <a class="code" href="chan__iax2_8c.html#aa4d98b10bfe71c49427a18a57b889506">iax2_allow_new</a>(f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, 1)) {
<a name="l09586"></a>09586          <span class="comment">/* only set NEW_ALLOW if calltoken checks out */</span>
<a name="l09587"></a>09587          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#ad0d4ac6467fbad03aa3ba57b4043567e">handle_call_token</a>(fh, &amp;ies, &amp;sin, fd)) {
<a name="l09588"></a>09588             <span class="keywordflow">return</span> 1;
<a name="l09589"></a>09589          }
<a name="l09590"></a>09590 
<a name="l09591"></a>09591          <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a15e68c5804dbbb3cb4bc693a965426ee">calltoken</a> &amp;&amp; ies.<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>) {
<a name="l09592"></a>09592             <span class="comment">/* if we&apos;ve gotten this far, and the calltoken ie data exists,</span>
<a name="l09593"></a>09593 <span class="comment">             * then calltoken validation _MUST_ have taken place.  If calltoken</span>
<a name="l09594"></a>09594 <span class="comment">             * data is provided, it is always validated reguardless of any</span>
<a name="l09595"></a>09595 <span class="comment">             * calltokenoptional or requirecalltoken options */</span>
<a name="l09596"></a>09596             <span class="keyword">new</span> = <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a944e9f4cbb821a363743da28175baea5">NEW_ALLOW_CALLTOKEN_VALIDATED</a>;
<a name="l09597"></a>09597          } <span class="keywordflow">else</span> {
<a name="l09598"></a>09598             <span class="keyword">new</span> = <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a83c6eb629d0470b1897e3cdb23ee75f4">NEW_ALLOW</a>;
<a name="l09599"></a>09599          }
<a name="l09600"></a>09600       }
<a name="l09601"></a>09601    } <span class="keywordflow">else</span> {
<a name="l09602"></a>09602       <span class="comment">/* Don&apos;t know anything about it yet */</span>
<a name="l09603"></a>09603       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a29ff71f9d5c7927906ebd437fe372056">AST_FRAME_NULL</a>;
<a name="l09604"></a>09604       f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = 0;
<a name="l09605"></a>09605    }
<a name="l09606"></a>09606 
<a name="l09607"></a>09607    <span class="keywordflow">if</span> (!fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) {
<a name="l09608"></a>09608       <span class="keywordtype">int</span> check_dcallno = 0;
<a name="l09609"></a>09609 
<a name="l09610"></a>09610       <span class="comment">/*</span>
<a name="l09611"></a>09611 <span class="comment">       * We enforce accurate destination call numbers for ACKs.  This forces the other</span>
<a name="l09612"></a>09612 <span class="comment">       * end to know the destination call number before call setup can complete.</span>
<a name="l09613"></a>09613 <span class="comment">       *</span>
<a name="l09614"></a>09614 <span class="comment">       * Discussed in the following thread:</span>
<a name="l09615"></a>09615 <span class="comment">       *    http://lists.digium.com/pipermail/asterisk-dev/2008-May/033217.html </span>
<a name="l09616"></a>09616 <span class="comment">       */</span>
<a name="l09617"></a>09617 
<a name="l09618"></a>09618       <span class="keywordflow">if</span> ((ntohs(mh-&gt;callno) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) &amp;&amp; ((f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) &amp;&amp; (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>))) {
<a name="l09619"></a>09619          check_dcallno = 1;
<a name="l09620"></a>09620       }
<a name="l09621"></a>09621 
<a name="l09622"></a>09622       <span class="keywordflow">if</span> (!(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = <a class="code" href="chan__iax2_8c.html#a26cef2567af74205496ef576f775ef05">find_callno</a>(ntohs(mh-&gt;callno) &amp; ~<a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>, dcallno, &amp;sin, <span class="keyword">new</span>, fd, check_dcallno))) {
<a name="l09623"></a>09623          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a> &amp;&amp; f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>) {
<a name="l09624"></a>09624             <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(1, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>), &amp;sin, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>), fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> + 1, fd, NULL);
<a name="l09625"></a>09625          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a> &amp;&amp; (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effab17acacea946abf3ccde08f4f49fbfdb">IAX_COMMAND_REGREQ</a> || f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9189574bea9c0b4772606120cd74718d">IAX_COMMAND_REGREL</a>)) {
<a name="l09626"></a>09626             <a class="code" href="chan__iax2_8c.html#abbd2997cafe8fba72e3b9d852ae5e1ee">send_apathetic_reply</a>(1, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a2640b46953901875b712fd2416abca6b">scallno</a>), &amp;sin, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa8c1a50616eeef8353b4985462e736419">IAX_COMMAND_REGREJ</a>, ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>), fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> + 1, fd, NULL);
<a name="l09627"></a>09627          }
<a name="l09628"></a>09628          <span class="keywordflow">return</span> 1;
<a name="l09629"></a>09629       }
<a name="l09630"></a>09630    }
<a name="l09631"></a>09631 
<a name="l09632"></a>09632    <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> &gt; 0)
<a name="l09633"></a>09633       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09634"></a>09634 
<a name="l09635"></a>09635    <span class="keywordflow">if</span> (!fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> || !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l09636"></a>09636       <span class="comment">/* A call arrived for a nonexistent destination.  Unless it&apos;s an &quot;inval&quot;</span>
<a name="l09637"></a>09637 <span class="comment">         frame, reply with an inval */</span>
<a name="l09638"></a>09638       <span class="keywordflow">if</span> (ntohs(mh-&gt;callno) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) {
<a name="l09639"></a>09639          <span class="comment">/* We can only raw hangup control frames */</span>
<a name="l09640"></a>09640          <span class="keywordflow">if</span> (((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>) &amp;&amp;
<a name="l09641"></a>09641              (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>) &amp;&amp;
<a name="l09642"></a>09642              (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>) &amp;&amp;
<a name="l09643"></a>09643              (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa08fdcdfce4a4fa82cb861365beb5f9eb">IAX_COMMAND_FWDOWNL</a>))||
<a name="l09644"></a>09644              (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>))
<a name="l09645"></a>09645             <a class="code" href="chan__iax2_8c.html#a352d072f2a27781e2c523b7d34471e2f">raw_hangup</a>(&amp;sin, ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>) &amp; ~<a class="code" href="iax2_8h.html#a9c7b219ff307b8867b301264fd443c62">IAX_FLAG_RETRANS</a>, ntohs(mh-&gt;callno) &amp; ~<a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>,
<a name="l09646"></a>09646             fd);
<a name="l09647"></a>09647       }
<a name="l09648"></a>09648       <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> &gt; 0) 
<a name="l09649"></a>09649          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09650"></a>09650       <span class="keywordflow">return</span> 1;
<a name="l09651"></a>09651    }
<a name="l09652"></a>09652    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba694ec5395980d8413b711c3a92c23a5d">IAX_ENCRYPTED</a>) &amp;&amp; !decrypted) {
<a name="l09653"></a>09653       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#aa99b47192edc30f24177358dd1d5038a">decrypt_frame</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, fh, &amp;f, &amp;res)) {
<a name="l09654"></a>09654          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Packet Decrypt Failed!\n&quot;</span>);
<a name="l09655"></a>09655          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09656"></a>09656          <span class="keywordflow">return</span> 1;
<a name="l09657"></a>09657       }
<a name="l09658"></a>09658       decrypted = 1;
<a name="l09659"></a>09659    }
<a name="l09660"></a>09660 <span class="preprocessor">#ifdef DEBUG_SUPPORT</span>
<a name="l09661"></a>09661 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (decrypted) {
<a name="l09662"></a>09662       <a class="code" href="chan__iax2_8c.html#a6321f53cc4f8174953330ccb907afbff">iax_outputframe</a>(NULL, fh, 3, &amp;sin, res - <span class="keyword">sizeof</span>(*fh));
<a name="l09663"></a>09663    }
<a name="l09664"></a>09664 <span class="preprocessor">#endif</span>
<a name="l09665"></a>09665 <span class="preprocessor"></span>
<a name="l09666"></a>09666    <span class="comment">/* count this frame */</span>
<a name="l09667"></a>09667    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;frames_received++;
<a name="l09668"></a>09668 
<a name="l09669"></a>09669    <span class="keywordflow">if</span> (!<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;sin, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>) &amp;&amp; !minivid &amp;&amp;
<a name="l09670"></a>09670       f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a> &amp;&amp;     <span class="comment">/* for attended transfer */</span>
<a name="l09671"></a>09671       f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>) {     <span class="comment">/* for attended transfer */</span>
<a name="l09672"></a>09672       <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> new_peercallno;
<a name="l09673"></a>09673       
<a name="l09674"></a>09674       new_peercallno = (<span class="keywordtype">unsigned</span> short) (ntohs(mh-&gt;callno) &amp; ~<a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>);
<a name="l09675"></a>09675       <span class="keywordflow">if</span> (new_peercallno &amp;&amp; new_peercallno != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l09676"></a>09676          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>) {
<a name="l09677"></a>09677             <a class="code" href="chan__iax2_8c.html#ae48d962bcb33faf6f14966b39668d439">remove_by_peercallno</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09678"></a>09678          }
<a name="l09679"></a>09679          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a> = new_peercallno;
<a name="l09680"></a>09680          <a class="code" href="chan__iax2_8c.html#aa7e2b9897bb7bc4e4cb32cf763f37527">store_by_peercallno</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09681"></a>09681       }
<a name="l09682"></a>09682    }
<a name="l09683"></a>09683    <span class="keywordflow">if</span> (ntohs(mh-&gt;callno) &amp; <a class="code" href="iax2_8h.html#a7968f5206ddf50157fd5a89cc8243594">IAX_FLAG_FULL</a>) {
<a name="l09684"></a>09684       <span class="keywordflow">if</span> (iaxdebug)
<a name="l09685"></a>09685          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received packet %d, (%d, %d)\n&quot;</span>, fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>, f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l09686"></a>09686       <span class="comment">/* Check if it&apos;s out of order (and not an ACK or INVAL) */</span>
<a name="l09687"></a>09687       fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a> = fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>;
<a name="l09688"></a>09688       fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> = fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>;
<a name="l09689"></a>09689       fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = ntohl(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l09690"></a>09690 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l09691"></a>09691 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (test_resync) {
<a name="l09692"></a>09692          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Simulating frame ts resync, was %u now %u\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> + test_resync);
<a name="l09693"></a>09693          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> += test_resync;
<a name="l09694"></a>09694       }
<a name="l09695"></a>09695 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l09696"></a>09696 <span class="preprocessor">#if 0</span>
<a name="l09697"></a>09697 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ( (ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>) &amp; <a class="code" href="iax2_8h.html#a9c7b219ff307b8867b301264fd443c62">IAX_FLAG_RETRANS</a>) ||
<a name="l09698"></a>09698            ( (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) &amp;&amp; ! (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a> &amp;&amp;
<a name="l09699"></a>09699                         (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a> ||
<a name="l09700"></a>09700                          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa85a01799deb4255dd6bd5fc06cd719f3">IAX_COMMAND_AUTHREQ</a> ||
<a name="l09701"></a>09701                          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa932a80e68f2fe87e57820e76c25caedb">IAX_COMMAND_ACCEPT</a> ||
<a name="l09702"></a>09702                          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>))      ) )
<a name="l09703"></a>09703 <span class="preprocessor">#endif</span>
<a name="l09704"></a>09704 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ((ntohs(fh-&gt;<a class="code" href="structast__iax2__full__hdr.html#a1af9c60d2317000d8de8f5a746900015">dcallno</a>) &amp; <a class="code" href="iax2_8h.html#a9c7b219ff307b8867b301264fd443c62">IAX_FLAG_RETRANS</a>) || (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>))
<a name="l09705"></a>09705          updatehistory = 0;
<a name="l09706"></a>09706       <span class="keywordflow">if</span> ((<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> != fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a>) &amp;&amp;
<a name="l09707"></a>09707          (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> ||
<a name="l09708"></a>09708             ((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>) &amp;&amp;
<a name="l09709"></a>09709             (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4f91d0a7331e8c4fd90a40f8994e5398">IAX_COMMAND_TXREADY</a>) &amp;&amp;    <span class="comment">/* for attended transfer */</span>
<a name="l09710"></a>09710             (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa0bc169da2923ae3cbda0e73e4881b95c">IAX_COMMAND_TXREL</a>) &amp;&amp;      <span class="comment">/* for attended transfer */</span>
<a name="l09711"></a>09711             (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae115542d0e74987e1dc7bfd0fa29f591">IAX_COMMAND_UNQUELCH</a> ) &amp;&amp;  <span class="comment">/* for attended transfer */</span>
<a name="l09712"></a>09712             (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>)) ||
<a name="l09713"></a>09713             (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>))) {
<a name="l09714"></a>09714          <span class="keywordflow">if</span> (
<a name="l09715"></a>09715           ((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>) &amp;&amp;
<a name="l09716"></a>09716            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>) &amp;&amp;
<a name="l09717"></a>09717            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>) &amp;&amp;
<a name="l09718"></a>09718            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4f91d0a7331e8c4fd90a40f8994e5398">IAX_COMMAND_TXREADY</a>) &amp;&amp;     <span class="comment">/* for attended transfer */</span>
<a name="l09719"></a>09719            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa0bc169da2923ae3cbda0e73e4881b95c">IAX_COMMAND_TXREL</a>) &amp;&amp;    <span class="comment">/* for attended transfer */</span>
<a name="l09720"></a>09720            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae115542d0e74987e1dc7bfd0fa29f591">IAX_COMMAND_UNQUELCH</a> ) &amp;&amp;   <span class="comment">/* for attended transfer */</span>
<a name="l09721"></a>09721            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>) &amp;&amp;
<a name="l09722"></a>09722            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effabc19cf9ba5ac0470de593a7132027fca">IAX_COMMAND_VNAK</a>)) ||
<a name="l09723"></a>09723            (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>)) {
<a name="l09724"></a>09724             <span class="comment">/* If it&apos;s not an ACK packet, it&apos;s out of order. */</span>
<a name="l09725"></a>09725             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Packet arrived out of order (expecting %d, got %d) (frametype = %d, subclass = %d)\n&quot;</span>, 
<a name="l09726"></a>09726                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>, fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a>, f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l09727"></a>09727             <span class="comment">/* Check to see if we need to request retransmission,</span>
<a name="l09728"></a>09728 <span class="comment">             * and take sequence number wraparound into account */</span>
<a name="l09729"></a>09729             <span class="keywordflow">if</span> ((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>) (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a> - fr-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a>) &lt; 128) {
<a name="l09730"></a>09730                <span class="comment">/* If we&apos;ve already seen it, ack it XXX There&apos;s a border condition here XXX */</span>
<a name="l09731"></a>09731                <span class="keywordflow">if</span> ((f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) || 
<a name="l09732"></a>09732                      ((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>) &amp;&amp; (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>))) {
<a name="l09733"></a>09733                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Acking anyway\n&quot;</span>);
<a name="l09734"></a>09734                   <span class="comment">/* XXX Maybe we should handle its ack to us, but then again, it&apos;s probably outdated anyway, and if</span>
<a name="l09735"></a>09735 <span class="comment">                     we have anything to send, we&apos;ll retransmit and get an ACK back anyway XXX */</span>
<a name="l09736"></a>09736                   <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l09737"></a>09737                }
<a name="l09738"></a>09738             } <span class="keywordflow">else</span> {
<a name="l09739"></a>09739                <span class="comment">/* Send a VNAK requesting retransmission */</span>
<a name="l09740"></a>09740                <a class="code" href="chan__iax2_8c.html#ac36e579cc52653790930d8bb00e05493">iax2_vnak</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l09741"></a>09741             }
<a name="l09742"></a>09742             <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09743"></a>09743             <span class="keywordflow">return</span> 1;
<a name="l09744"></a>09744          }
<a name="l09745"></a>09745       } <span class="keywordflow">else</span> {
<a name="l09746"></a>09746          <span class="comment">/* Increment unless it&apos;s an ACK or VNAK */</span>
<a name="l09747"></a>09747          <span class="keywordflow">if</span> (((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>) &amp;&amp;
<a name="l09748"></a>09748              (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>) &amp;&amp;
<a name="l09749"></a>09749              (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>) &amp;&amp;
<a name="l09750"></a>09750              (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>) &amp;&amp;
<a name="l09751"></a>09751             (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effabc19cf9ba5ac0470de593a7132027fca">IAX_COMMAND_VNAK</a>)) ||
<a name="l09752"></a>09752              (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>))
<a name="l09753"></a>09753             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>++;
<a name="l09754"></a>09754       }
<a name="l09755"></a>09755       <span class="comment">/* Ensure text frames are NULL-terminated */</span>
<a name="l09756"></a>09756       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a> &amp;&amp; thread-&gt;buf[res - 1] != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l09757"></a>09757          <span class="keywordflow">if</span> (res &lt; thread-&gt;buf_size)
<a name="l09758"></a>09758             thread-&gt;buf[res++] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09759"></a>09759          <span class="keywordflow">else</span> <span class="comment">/* Trims one character from the text message, but that&apos;s better than overwriting the end of the buffer. */</span>
<a name="l09760"></a>09760             thread-&gt;buf[res - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09761"></a>09761       }
<a name="l09762"></a>09762 
<a name="l09763"></a>09763       <span class="comment">/* Handle implicit ACKing unless this is an INVAL, and only if this is </span>
<a name="l09764"></a>09764 <span class="comment">         from the real peer, not the transfer peer */</span>
<a name="l09765"></a>09765       <span class="keywordflow">if</span> (!<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;sin, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>) &amp;&amp; 
<a name="l09766"></a>09766           ((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>) ||
<a name="l09767"></a>09767            (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>))) {
<a name="l09768"></a>09768          <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> x;
<a name="l09769"></a>09769          <span class="keywordtype">int</span> call_to_destroy;
<a name="l09770"></a>09770          <span class="comment">/* First we have to qualify that the ACKed value is within our window */</span>
<a name="l09771"></a>09771          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a> &gt;= <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> || (fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> &gt;= <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a> &amp;&amp; fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a> &lt; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>))
<a name="l09772"></a>09772             x = fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>;
<a name="l09773"></a>09773          <span class="keywordflow">else</span> 
<a name="l09774"></a>09774             x = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>;
<a name="l09775"></a>09775          <span class="keywordflow">if</span> ((x != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>) || (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a> == fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>)) {
<a name="l09776"></a>09776             <span class="comment">/* The acknowledgement is within our window.  Time to acknowledge everything</span>
<a name="l09777"></a>09777 <span class="comment">               that it says to */</span>
<a name="l09778"></a>09778             <span class="keywordflow">for</span> (x=<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a>; x != fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>; x++) {
<a name="l09779"></a>09779                <span class="comment">/* Ack the packet with the given timestamp */</span>
<a name="l09780"></a>09780                <span class="keywordflow">if</span> (iaxdebug)
<a name="l09781"></a>09781                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Cancelling transmission of packet %d\n&quot;</span>, x);
<a name="l09782"></a>09782                call_to_destroy = 0;
<a name="l09783"></a>09783                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l09784"></a>09784                <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l09785"></a>09785                   <span class="comment">/* If it&apos;s our call, and our timestamp, mark -1 retries */</span>
<a name="l09786"></a>09786                   <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> == cur-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) &amp;&amp; (x == cur-&gt;<a class="code" href="structiax__frame.html#af985c324b705a5cb0563377ce5863764">oseqno</a>)) {
<a name="l09787"></a>09787                      cur-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l09788"></a>09788                      <span class="comment">/* Destroy call if this is the end */</span>
<a name="l09789"></a>09789                      <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structiax__frame.html#a48be625dde1131eceb8209732f83e909">final</a>)
<a name="l09790"></a>09790                         call_to_destroy = fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l09791"></a>09791                   }
<a name="l09792"></a>09792                }
<a name="l09793"></a>09793                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l09794"></a>09794                <span class="keywordflow">if</span> (call_to_destroy) {
<a name="l09795"></a>09795                   <span class="keywordflow">if</span> (iaxdebug)
<a name="l09796"></a>09796                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Really destroying %d, having been acked on final message\n&quot;</span>, call_to_destroy);
<a name="l09797"></a>09797                   <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[call_to_destroy]);
<a name="l09798"></a>09798                   <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(call_to_destroy);
<a name="l09799"></a>09799                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[call_to_destroy]);
<a name="l09800"></a>09800                }
<a name="l09801"></a>09801             }
<a name="l09802"></a>09802             <span class="comment">/* Note how much we&apos;ve received acknowledgement for */</span>
<a name="l09803"></a>09803             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>])
<a name="l09804"></a>09804                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a> = fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>;
<a name="l09805"></a>09805             <span class="keywordflow">else</span> {
<a name="l09806"></a>09806                <span class="comment">/* Stop processing now */</span>
<a name="l09807"></a>09807                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09808"></a>09808                <span class="keywordflow">return</span> 1;
<a name="l09809"></a>09809             }
<a name="l09810"></a>09810          } <span class="keywordflow">else</span> {
<a name="l09811"></a>09811             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received iseqno %d not within window %d-&gt;%d\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a880c419f7d339d07072c471e8cdd701e">rseqno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9887965bdbba3acab90015e43cde575a">oseqno</a>);
<a name="l09812"></a>09812          }
<a name="l09813"></a>09813       }
<a name="l09814"></a>09814       <span class="keywordflow">if</span> (<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;sin, &amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>) &amp;&amp; 
<a name="l09815"></a>09815          ((f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) || 
<a name="l09816"></a>09816           ((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>) &amp;&amp;
<a name="l09817"></a>09817            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>)))) {
<a name="l09818"></a>09818          <span class="comment">/* Only messages we accept from a transfer host are TXACC and TXCNT */</span>
<a name="l09819"></a>09819          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09820"></a>09820          <span class="keywordflow">return</span> 1;
<a name="l09821"></a>09821       }
<a name="l09822"></a>09822 
<a name="l09823"></a>09823       <span class="comment">/* when we receive the first full frame for a new incoming channel,</span>
<a name="l09824"></a>09824 <span class="comment">         it is safe to start the PBX on the channel because we have now</span>
<a name="l09825"></a>09825 <span class="comment">         completed a 3-way handshake with the peer */</span>
<a name="l09826"></a>09826       <span class="keywordflow">if</span> ((f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) ||
<a name="l09827"></a>09827           (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) ||
<a name="l09828"></a>09828           (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>)) {
<a name="l09829"></a>09829          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8182bed8f54e0fb3cc0575d24519b1ef">IAX_DELAYPBXSTART</a>)) {
<a name="l09830"></a>09830             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8182bed8f54e0fb3cc0575d24519b1ef">IAX_DELAYPBXSTART</a>);
<a name="l09831"></a>09831             <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#ab8c22a71161e0538ccb120e3ca5abdd2" title="Create new call, interface with the PBX core.">ast_iax2_new</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a118e127ad054dd53da114de1a0cb8522">chosenformat</a>)) {
<a name="l09832"></a>09832                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09833"></a>09833                <span class="keywordflow">return</span> 1;
<a name="l09834"></a>09834             }
<a name="l09835"></a>09835          }
<a name="l09836"></a>09836 
<a name="l09837"></a>09837          <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l09838"></a>09838             <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore = NULL;
<a name="l09839"></a>09839             <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *prev = NULL;
<a name="l09840"></a>09840             <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l09841"></a>09841             <span class="keywordflow">if</span> ((c = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l09842"></a>09842                varlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*varlist));
<a name="l09843"></a>09843                variablestore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l09844"></a>09844 
<a name="l09845"></a>09845                <span class="keywordflow">if</span> (variablestore &amp;&amp; varlist) {
<a name="l09846"></a>09846                   variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = varlist;
<a name="l09847"></a>09847                   variablestore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l09848"></a>09848                   <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(varlist);
<a name="l09849"></a>09849                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I can haz IAX vars?\n&quot;</span>);
<a name="l09850"></a>09850                   <span class="keywordflow">for</span> (var = ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l09851"></a>09851                      <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvar = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l09852"></a>09852                      <span class="keywordflow">if</span> (prev) {
<a name="l09853"></a>09853                         <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l09854"></a>09854                      }
<a name="l09855"></a>09855                      prev = var;
<a name="l09856"></a>09856                      <span class="keywordflow">if</span> (!newvar) {
<a name="l09857"></a>09857                         <span class="comment">/* Don&apos;t abort list traversal, as this would leave ies.vars in an inconsistent state. */</span>
<a name="l09858"></a>09858                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l09859"></a>09859                      } <span class="keywordflow">else</span> {
<a name="l09860"></a>09860                         <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(varlist, newvar, entries);
<a name="l09861"></a>09861                      }
<a name="l09862"></a>09862                   }
<a name="l09863"></a>09863                   <span class="keywordflow">if</span> (prev) {
<a name="l09864"></a>09864                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l09865"></a>09865                   }
<a name="l09866"></a>09866                   ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l09867"></a>09867                   <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(c, variablestore);
<a name="l09868"></a>09868                } <span class="keywordflow">else</span> {
<a name="l09869"></a>09869                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l09870"></a>09870                   <span class="keywordflow">if</span> (variablestore) {
<a name="l09871"></a>09871                      <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(variablestore);
<a name="l09872"></a>09872                   }
<a name="l09873"></a>09873                   <span class="keywordflow">if</span> (varlist) {
<a name="l09874"></a>09874                      <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(varlist);
<a name="l09875"></a>09875                   }
<a name="l09876"></a>09876                }
<a name="l09877"></a>09877             } <span class="keywordflow">else</span> {
<a name="l09878"></a>09878                <span class="comment">/* No channel yet, so transfer the variables directly over to the pvt,</span>
<a name="l09879"></a>09879 <span class="comment">                * for later inheritance. */</span>
<a name="l09880"></a>09880                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No channel, so populating IAXVARs to the pvt, as an intermediate step.\n&quot;</span>);
<a name="l09881"></a>09881                <span class="keywordflow">for</span> (var = ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>; var &amp;&amp; var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>);
<a name="l09882"></a>09882                <span class="keywordflow">if</span> (var) {
<a name="l09883"></a>09883                   var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;iaxvars;
<a name="l09884"></a>09884                   <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;iaxvars = ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>;
<a name="l09885"></a>09885                   ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l09886"></a>09886                }
<a name="l09887"></a>09887             }
<a name="l09888"></a>09888          }
<a name="l09889"></a>09889 
<a name="l09890"></a>09890          <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l09891"></a>09891             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I have IAX variables, but they were not processed\n&quot;</span>);
<a name="l09892"></a>09892          }
<a name="l09893"></a>09893       }
<a name="l09894"></a>09894 
<a name="l09895"></a>09895       <span class="comment">/* once we receive our first IAX Full Frame that is not CallToken related, send all</span>
<a name="l09896"></a>09896 <span class="comment">       * queued signaling frames that were being held. */</span>
<a name="l09897"></a>09897       <span class="keywordflow">if</span> ((f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) &amp;&amp; (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa92c28bf63f730ca1f2836b5a1a26ac38">IAX_COMMAND_CALLTOKEN</a>) &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;hold_signaling) {
<a name="l09898"></a>09898          <a class="code" href="chan__iax2_8c.html#a8508e2643167997d779822916b4d0ab7" title="This function must be called once we are sure the other side has given us a call...">send_signaling</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09899"></a>09899       }
<a name="l09900"></a>09900 
<a name="l09901"></a>09901       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l09902"></a>09902          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a>) {
<a name="l09903"></a>09903                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a> = f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l09904"></a>09904                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, voice format changed to %d\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l09905"></a>09905                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l09906"></a>09906                   <span class="keywordtype">int</span> orignative;
<a name="l09907"></a>09907 retryowner:
<a name="l09908"></a>09908                   <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l09909"></a>09909                      <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09910"></a>09910                      <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) <span class="keywordflow">goto</span> retryowner;
<a name="l09911"></a>09911                   }
<a name="l09912"></a>09912                   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l09913"></a>09913                      <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l09914"></a>09914                         orignative = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>;
<a name="l09915"></a>09915                         <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l09916"></a>09916                         <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>)
<a name="l09917"></a>09917                            <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>);
<a name="l09918"></a>09918                         <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = orignative;
<a name="l09919"></a>09919                         <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>);
<a name="l09920"></a>09920                      }
<a name="l09921"></a>09921                   } <span class="keywordflow">else</span> {
<a name="l09922"></a>09922                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Neat, somebody took away the channel at a magical time but i found it!\n&quot;</span>);
<a name="l09923"></a>09923                      <span class="comment">/* Free remote variables (if any) */</span>
<a name="l09924"></a>09924                      <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l09925"></a>09925                         <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>);
<a name="l09926"></a>09926                         <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I can haz iaxvars, but they is no good.  :-(\n&quot;</span>);
<a name="l09927"></a>09927                         ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l09928"></a>09928                      }
<a name="l09929"></a>09929                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09930"></a>09930                      <span class="keywordflow">return</span> 1;
<a name="l09931"></a>09931                   }
<a name="l09932"></a>09932                }
<a name="l09933"></a>09933          }
<a name="l09934"></a>09934       }
<a name="l09935"></a>09935       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l09936"></a>09936          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a3592e144b79a8ac41ec04e9d7fd4423d">videoformat</a>) {
<a name="l09937"></a>09937             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, video format changed to %d\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ~0x1);
<a name="l09938"></a>09938             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a3592e144b79a8ac41ec04e9d7fd4423d">videoformat</a> = f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; ~0x1;
<a name="l09939"></a>09939          }
<a name="l09940"></a>09940       }
<a name="l09941"></a>09941       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a> &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l09942"></a>09942          <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a387635982df3d2edb669a1eece92c875">AST_CONTROL_BUSY</a>) {
<a name="l09943"></a>09943             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = <a class="code" href="causes_8h.html#ae009c193522491f7de7ea28b23f20868">AST_CAUSE_BUSY</a>;
<a name="l09944"></a>09944          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a850bb06a1702741c93a3fd67cc9637ab">AST_CONTROL_CONGESTION</a>) {
<a name="l09945"></a>09945             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = <a class="code" href="causes_8h.html#a0a35518d7b448a53da368cf57f354fba">AST_CAUSE_CONGESTION</a>;
<a name="l09946"></a>09946          }
<a name="l09947"></a>09947       }
<a name="l09948"></a>09948       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>) {
<a name="l09949"></a>09949          <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afddd3d0f9decedb8c1310fce148713b8">initid</a>);
<a name="l09950"></a>09950          <span class="comment">/* Handle the IAX pseudo frame itself */</span>
<a name="l09951"></a>09951          <span class="keywordflow">if</span> (iaxdebug)
<a name="l09952"></a>09952             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;IAX subclass %d received\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l09953"></a>09953 
<a name="l09954"></a>09954                         <span class="comment">/* Update last ts unless the frame&apos;s timestamp originated with us. */</span>
<a name="l09955"></a>09955          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &lt; fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> &amp;&amp;
<a name="l09956"></a>09956                             f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a> &amp;&amp;
<a name="l09957"></a>09957                             f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa499c741ada032d5c451e6f45580a6444">IAX_COMMAND_PONG</a> &amp;&amp;
<a name="l09958"></a>09958                             f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7651116cd23210a0c999063a6c1d6b64">IAX_COMMAND_LAGRP</a>) {
<a name="l09959"></a>09959             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l09960"></a>09960             <span class="keywordflow">if</span> (iaxdebug)
<a name="l09961"></a>09961                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;For call=%d, set last=%d\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l09962"></a>09962          }
<a name="l09963"></a>09963          <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ad236fe8543f05839d5978753bd7068a3">last_iax_message</a> = f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l09964"></a>09964          <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">first_iax_message</a>) {
<a name="l09965"></a>09965             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a04814429e6095f2965e356eaf5fccefd">first_iax_message</a> = f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l09966"></a>09966          }
<a name="l09967"></a>09967          <span class="keywordflow">switch</span>(f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l09968"></a>09968          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>:
<a name="l09969"></a>09969             <span class="comment">/* Do nothing */</span>
<a name="l09970"></a>09970             <span class="keywordflow">break</span>;
<a name="l09971"></a>09971          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa59245c77d40ee22cf6a2188ae0adc606">IAX_COMMAND_QUELCH</a>:
<a name="l09972"></a>09972             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>)) {
<a name="l09973"></a>09973                     <span class="comment">/* Generate Manager Hold event, if necessary*/</span>
<a name="l09974"></a>09974                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>) {
<a name="l09975"></a>09975                   <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;Hold&quot;</span>,
<a name="l09976"></a>09976                      <span class="stringliteral">&quot;Status: On\r\n&quot;</span>
<a name="l09977"></a>09977                      <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l09978"></a>09978                      <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l09979"></a>09979                      <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name, 
<a name="l09980"></a>09980                      <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;uniqueid);
<a name="l09981"></a>09981                }
<a name="l09982"></a>09982 
<a name="l09983"></a>09983                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba5c0041238c2195bc988f0b77ce0972d6">IAX_QUELCH</a>);
<a name="l09984"></a>09984                <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#ab220afb42ba31a5068247ff52b8ff56e">musiconhold</a>) {
<a name="l09985"></a>09985                   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l09986"></a>09986                      <span class="keyword">const</span> <span class="keywordtype">char</span> *moh_suggest = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;mohsuggest;
<a name="l09987"></a>09987                      <a class="code" href="chan__iax2_8c.html#ac2bc2f43e290218cfc5b2070decba686" title="Queue a control frame on the ast_channel owner.">iax2_queue_control_data</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>, 
<a name="l09988"></a>09988                         <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(moh_suggest, NULL),
<a name="l09989"></a>09989                         !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(moh_suggest) ? strlen(moh_suggest) + 1 : 0);
<a name="l09990"></a>09990                      <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l09991"></a>09991                         <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l09992"></a>09992                         <span class="keywordflow">return</span> 1;
<a name="l09993"></a>09993                      }
<a name="l09994"></a>09994                   }
<a name="l09995"></a>09995                }
<a name="l09996"></a>09996             }
<a name="l09997"></a>09997             <span class="keywordflow">break</span>;
<a name="l09998"></a>09998          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae115542d0e74987e1dc7bfd0fa29f591">IAX_COMMAND_UNQUELCH</a>:
<a name="l09999"></a>09999             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>)) {
<a name="l10000"></a>10000                     <span class="comment">/* Generate Manager Unhold event, if necessary*/</span>
<a name="l10001"></a>10001                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba5c0041238c2195bc988f0b77ce0972d6">IAX_QUELCH</a>)) {
<a name="l10002"></a>10002                   <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;Hold&quot;</span>,
<a name="l10003"></a>10003                      <span class="stringliteral">&quot;Status: Off\r\n&quot;</span>
<a name="l10004"></a>10004                      <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l10005"></a>10005                      <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l10006"></a>10006                      <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name, 
<a name="l10007"></a>10007                      <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;uniqueid);
<a name="l10008"></a>10008                }
<a name="l10009"></a>10009 
<a name="l10010"></a>10010                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba5c0041238c2195bc988f0b77ce0972d6">IAX_QUELCH</a>);
<a name="l10011"></a>10011                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) {
<a name="l10012"></a>10012                   <a class="code" href="chan__iax2_8c.html#ac2bc2f43e290218cfc5b2070decba686" title="Queue a control frame on the ast_channel owner.">iax2_queue_control_data</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>, NULL, 0);
<a name="l10013"></a>10013                   <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10014"></a>10014                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10015"></a>10015                      <span class="keywordflow">return</span> 1;
<a name="l10016"></a>10016                   }
<a name="l10017"></a>10017                }
<a name="l10018"></a>10018             }
<a name="l10019"></a>10019             <span class="keywordflow">break</span>;
<a name="l10020"></a>10020          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>:
<a name="l10021"></a>10021             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">TRANSFER_BEGIN</a>) {
<a name="l10022"></a>10022                <span class="comment">/* Ack the packet with the given timestamp */</span>
<a name="l10023"></a>10023                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l10024"></a>10024                <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l10025"></a>10025                   <span class="comment">/* Cancel any outstanding txcnt&apos;s */</span>
<a name="l10026"></a>10026                   <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> == cur-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) &amp;&amp; (cur-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a>))
<a name="l10027"></a>10027                      cur-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l10028"></a>10028                }
<a name="l10029"></a>10029                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l10030"></a>10030                memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l10031"></a>10031                <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied1, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10032"></a>10032                <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4f91d0a7331e8c4fd90a40f8994e5398">IAX_COMMAND_TXREADY</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10033"></a>10033                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#acf0b21e9dee9a1e9233191952caa6d5f">transferring</a> = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a960c983f99e76d8c1d8ba1bce27a1dab">TRANSFER_READY</a>;
<a name="l10034"></a>10034             }
<a name="l10035"></a>10035             <span class="keywordflow">break</span>;
<a name="l10036"></a>10036          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>:
<a name="l10037"></a>10037             <span class="comment">/* Ignore if it&apos;s already up */</span>
<a name="l10038"></a>10038             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a> | <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>))
<a name="l10039"></a>10039                <span class="keywordflow">break</span>;
<a name="l10040"></a>10040             <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a86275d095709be06b32c7447d7bbabb9">provverpres</a> &amp;&amp; ies.<a class="code" href="structiax__ies.html#ac21dd7ebf66d8aa74c1f1b9be3883484">serviceident</a> &amp;&amp; sin.sin_addr.s_addr) {
<a name="l10041"></a>10041                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10042"></a>10042                <a class="code" href="chan__iax2_8c.html#a25a386bc9b168cd30b3cee08e50d2c97">check_provisioning</a>(&amp;sin, fd, ies.<a class="code" href="structiax__ies.html#ac21dd7ebf66d8aa74c1f1b9be3883484">serviceident</a>, ies.<a class="code" href="structiax__ies.html#a0eaa250f80df1e07e6613ed6814af9a9">provver</a>);
<a name="l10043"></a>10043                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10044"></a>10044                <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10045"></a>10045                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10046"></a>10046                   <span class="keywordflow">return</span> 1;
<a name="l10047"></a>10047                }
<a name="l10048"></a>10048             }
<a name="l10049"></a>10049             <span class="comment">/* If we&apos;re in trunk mode, do it now, and update the trunk number in our frame before continuing */</span>
<a name="l10050"></a>10050             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>)) {
<a name="l10051"></a>10051                <span class="keywordtype">int</span> new_callno;
<a name="l10052"></a>10052                <span class="keywordflow">if</span> ((new_callno = <a class="code" href="chan__iax2_8c.html#afe7b37fe23d6a5abe8a477950a399f1e">make_trunk</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, 1)) != -1)
<a name="l10053"></a>10053                   fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> = new_callno;
<a name="l10054"></a>10054             }
<a name="l10055"></a>10055             <span class="comment">/* For security, always ack immediately */</span>
<a name="l10056"></a>10056             <span class="keywordflow">if</span> (delayreject)
<a name="l10057"></a>10057                <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10058"></a>10058             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a61046b083970a3afb9320d675cd3fee9">check_access</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, &amp;sin, &amp;ies)) {
<a name="l10059"></a>10059                <span class="comment">/* They&apos;re not allowed on */</span>
<a name="l10060"></a>10060                <a class="code" href="chan__iax2_8c.html#a239b18f98846d5c7426ae7ee4ba97028">auth_fail</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>);
<a name="l10061"></a>10061                <span class="keywordflow">if</span> (authdebug)
<a name="l10062"></a>10062                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, who was trying to reach &apos;%s@%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10063"></a>10063                <span class="keywordflow">break</span>;
<a name="l10064"></a>10064             }
<a name="l10065"></a>10065             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;secret) &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>)) {
<a name="l10066"></a>10066                <a class="code" href="chan__iax2_8c.html#a239b18f98846d5c7426ae7ee4ba97028">auth_fail</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>);
<a name="l10067"></a>10067                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Rejected connect attempt.  No secret present while force encrypt enabled.\n&quot;</span>);
<a name="l10068"></a>10068                <span class="keywordflow">break</span>;
<a name="l10069"></a>10069             }
<a name="l10070"></a>10070             <span class="keywordflow">if</span> (strcasecmp(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <span class="stringliteral">&quot;TBD&quot;</span>)) {
<a name="l10071"></a>10071                <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, *<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>;
<a name="l10072"></a>10072 
<a name="l10073"></a>10073                context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10074"></a>10074                exten = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten);
<a name="l10075"></a>10075                cid_num = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;cid_num);
<a name="l10076"></a>10076 
<a name="l10077"></a>10077                <span class="comment">/* This might re-enter the IAX code and need the lock */</span>
<a name="l10078"></a>10078                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10079"></a>10079                exists = <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, context, exten, 1, cid_num);
<a name="l10080"></a>10080                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10081"></a>10081 
<a name="l10082"></a>10082                <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10083"></a>10083                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10084"></a>10084                   <span class="keywordflow">return</span> 1;
<a name="l10085"></a>10085                }
<a name="l10086"></a>10086             } <span class="keywordflow">else</span>
<a name="l10087"></a>10087                exists = 0;
<a name="l10088"></a>10088             <span class="comment">/* Get OSP token if it does exist */</span>
<a name="l10089"></a>10089             <a class="code" href="chan__iax2_8c.html#a9efd9db6b7c50e9f56168269de1d6797">save_osptoken</a>(fr, &amp;ies);
<a name="l10090"></a>10090             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;secret) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;inkeys)) {
<a name="l10091"></a>10091                <span class="keywordflow">if</span> (strcmp(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <span class="stringliteral">&quot;TBD&quot;</span>) &amp;&amp; !exists) {
<a name="l10092"></a>10092                   memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10093"></a>10093                   <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;No such context/extension&quot;</span>);
<a name="l10094"></a>10094                   <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#ace4ceec464072bb9e269b6a52e7a6631">AST_CAUSE_NO_ROUTE_DESTINATION</a>);
<a name="l10095"></a>10095                   <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10096"></a>10096                   <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10097"></a>10097                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10098"></a>10098                      <span class="keywordflow">return</span> 1;
<a name="l10099"></a>10099                   }
<a name="l10100"></a>10100                   <span class="keywordflow">if</span> (authdebug)
<a name="l10101"></a>10101                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, request &apos;%s@%s&apos; does not exist\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10102"></a>10102                } <span class="keywordflow">else</span> {
<a name="l10103"></a>10103                   <span class="comment">/* Select an appropriate format */</span>
<a name="l10104"></a>10104 
<a name="l10105"></a>10105                   <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>)) {
<a name="l10106"></a>10106                      <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>)) {
<a name="l10107"></a>10107                         using_prefs = <span class="stringliteral">&quot;reqonly&quot;</span>;
<a name="l10108"></a>10108                      } <span class="keywordflow">else</span> {
<a name="l10109"></a>10109                         using_prefs = <span class="stringliteral">&quot;disabled&quot;</span>;
<a name="l10110"></a>10110                      }
<a name="l10111"></a>10111                      format = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l10112"></a>10112                      memset(&amp;pref, 0, <span class="keyword">sizeof</span>(pref));
<a name="l10113"></a>10113                      strcpy(caller_pref_buf, <span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10114"></a>10114                      strcpy(host_pref_buf, <span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10115"></a>10115                   } <span class="keywordflow">else</span> {
<a name="l10116"></a>10116                      using_prefs = <span class="stringliteral">&quot;mine&quot;</span>;
<a name="l10117"></a>10117                      <span class="comment">/* If the information elements are in here... use them */</span>
<a name="l10118"></a>10118                      <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>)
<a name="l10119"></a>10119                         <a class="code" href="frame_8h.html#a42cc334b6773ff33cb3c24ca5a916842" title="Shift an audio codec preference list up or down 65 bytes so that it becomes an ASCII...">ast_codec_pref_convert</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6b3f8d1d57c047529c48b59da2ccbced">rprefs</a>, ies.<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>, 32, 0);
<a name="l10120"></a>10120                      <span class="keywordflow">if</span> (<a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6b3f8d1d57c047529c48b59da2ccbced">rprefs</a>, 0)) {
<a name="l10121"></a>10121                         <span class="comment">/* If we are codec_first_choice we let the caller have the 1st shot at picking the codec.*/</span>
<a name="l10122"></a>10122                         <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>)) {
<a name="l10123"></a>10123                            pref = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6b3f8d1d57c047529c48b59da2ccbced">rprefs</a>;
<a name="l10124"></a>10124                            using_prefs = <span class="stringliteral">&quot;caller&quot;</span>;
<a name="l10125"></a>10125                         } <span class="keywordflow">else</span> {
<a name="l10126"></a>10126                            pref = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l10127"></a>10127                         }
<a name="l10128"></a>10128                      } <span class="keywordflow">else</span>
<a name="l10129"></a>10129                         pref = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l10130"></a>10130                      
<a name="l10131"></a>10131                      format = <a class="code" href="frame_8h.html#a123ec7e6e90e279b75bc6447eab5d3b2" title="Select the best audio format according to preference list from supplied options....">ast_codec_choose</a>(&amp;pref, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a>, 0);
<a name="l10132"></a>10132                      <a class="code" href="frame_8h.html#a784e4f7371cbfce0b3e9f957f7ce54e3" title="Dump audio codec preference list into a string.">ast_codec_pref_string</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs, caller_pref_buf, <span class="keyword">sizeof</span>(caller_pref_buf) - 1);
<a name="l10133"></a>10133                      <a class="code" href="frame_8h.html#a784e4f7371cbfce0b3e9f957f7ce54e3" title="Dump audio codec preference list into a string.">ast_codec_pref_string</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;prefs, host_pref_buf, <span class="keyword">sizeof</span>(host_pref_buf) - 1);
<a name="l10134"></a>10134                   }
<a name="l10135"></a>10135                   <span class="keywordflow">if</span> (!format) {
<a name="l10136"></a>10136                      <span class="keywordflow">if</span>(!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>))
<a name="l10137"></a>10137                         format = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l10138"></a>10138                      <span class="keywordflow">if</span> (!format) {
<a name="l10139"></a>10139                         memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10140"></a>10140                         <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Unable to negotiate codec&quot;</span>);
<a name="l10141"></a>10141                         <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a208e4fc34932b91fc9e90d9008329e87">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>);
<a name="l10142"></a>10142                         <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10143"></a>10143                         <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10144"></a>10144                            <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10145"></a>10145                            <span class="keywordflow">return</span> 1;
<a name="l10146"></a>10146                         }
<a name="l10147"></a>10147                         <span class="keywordflow">if</span> (authdebug) {
<a name="l10148"></a>10148                            <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>))
<a name="l10149"></a>10149                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested 0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l10150"></a>10150                            <span class="keywordflow">else</span> 
<a name="l10151"></a>10151                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested/capability 0x%x/0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l10152"></a>10152                         }
<a name="l10153"></a>10153                      } <span class="keywordflow">else</span> {
<a name="l10154"></a>10154                         <span class="comment">/* Pick one... */</span>
<a name="l10155"></a>10155                         <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>)) {
<a name="l10156"></a>10156                            <span class="keywordflow">if</span>(!(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>))
<a name="l10157"></a>10157                               format = 0;
<a name="l10158"></a>10158                         } <span class="keywordflow">else</span> {
<a name="l10159"></a>10159                            <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>)) {
<a name="l10160"></a>10160                               using_prefs = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>) ? <span class="stringliteral">&quot;reqonly&quot;</span> : <span class="stringliteral">&quot;disabled&quot;</span>;
<a name="l10161"></a>10161                               memset(&amp;pref, 0, <span class="keyword">sizeof</span>(pref));
<a name="l10162"></a>10162                               format = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l10163"></a>10163                               strcpy(caller_pref_buf,<span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10164"></a>10164                               strcpy(host_pref_buf,<span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10165"></a>10165                            } <span class="keywordflow">else</span> {
<a name="l10166"></a>10166                               using_prefs = <span class="stringliteral">&quot;mine&quot;</span>;
<a name="l10167"></a>10167                               <span class="keywordflow">if</span> (<a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6b3f8d1d57c047529c48b59da2ccbced">rprefs</a>, 0)) {
<a name="l10168"></a>10168                                  <span class="comment">/* Do the opposite of what we tried above. */</span>
<a name="l10169"></a>10169                                  <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>)) {
<a name="l10170"></a>10170                                     pref = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;                       
<a name="l10171"></a>10171                                  } <span class="keywordflow">else</span> {
<a name="l10172"></a>10172                                     pref = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a6b3f8d1d57c047529c48b59da2ccbced">rprefs</a>;
<a name="l10173"></a>10173                                     using_prefs = <span class="stringliteral">&quot;caller&quot;</span>;
<a name="l10174"></a>10174                                  }
<a name="l10175"></a>10175                                  format = <a class="code" href="frame_8h.html#a123ec7e6e90e279b75bc6447eab5d3b2" title="Select the best audio format according to preference list from supplied options....">ast_codec_choose</a>(&amp;pref, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>, 1);
<a name="l10176"></a>10176                            
<a name="l10177"></a>10177                               } <span class="keywordflow">else</span> <span class="comment">/* if no codec_prefs IE do it the old way */</span>
<a name="l10178"></a>10178                                  format = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>); 
<a name="l10179"></a>10179                            }
<a name="l10180"></a>10180                         }
<a name="l10181"></a>10181 
<a name="l10182"></a>10182                         <span class="keywordflow">if</span> (!format) {
<a name="l10183"></a>10183                            memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10184"></a>10184                            <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Unable to negotiate codec&quot;</span>);
<a name="l10185"></a>10185                            <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a208e4fc34932b91fc9e90d9008329e87">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>);
<a name="l10186"></a>10186                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No best format in 0x%x???\n&quot;</span>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a64c43413589d9d63d2ef5db58ed1a7c2">peercapability</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l10187"></a>10187                            <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10188"></a>10188                            <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10189"></a>10189                               <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10190"></a>10190                               <span class="keywordflow">return</span> 1;
<a name="l10191"></a>10191                            }
<a name="l10192"></a>10192                            <span class="keywordflow">if</span> (authdebug)
<a name="l10193"></a>10193                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested/capability 0x%x/0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10194"></a>10194                            <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>);   
<a name="l10195"></a>10195                            <span class="keywordflow">break</span>;
<a name="l10196"></a>10196                         }
<a name="l10197"></a>10197                      }
<a name="l10198"></a>10198                   }
<a name="l10199"></a>10199                   <span class="keywordflow">if</span> (format) {
<a name="l10200"></a>10200                      <span class="comment">/* No authentication required, let them in */</span>
<a name="l10201"></a>10201                      memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l10202"></a>10202                      <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied1, <a class="code" href="iax2_8h.html#a81b21fd8bbf4f19527fbb21277687bd5">IAX_IE_FORMAT</a>, format);
<a name="l10203"></a>10203                      <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa932a80e68f2fe87e57820e76c25caedb">IAX_COMMAND_ACCEPT</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10204"></a>10204                      <span class="keywordflow">if</span> (strcmp(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <span class="stringliteral">&quot;TBD&quot;</span>)) {
<a name="l10205"></a>10205                         <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>);
<a name="l10206"></a>10206                         <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Accepting UNAUTHENTICATED call from %s:\n&quot;</span>
<a name="l10207"></a>10207                                     <span class="stringliteral">&quot;%srequested format = %s,\n&quot;</span>
<a name="l10208"></a>10208                                     <span class="stringliteral">&quot;%srequested prefs = %s,\n&quot;</span>
<a name="l10209"></a>10209                                     <span class="stringliteral">&quot;%sactual format = %s,\n&quot;</span>
<a name="l10210"></a>10210                                     <span class="stringliteral">&quot;%shost prefs = %s,\n&quot;</span>
<a name="l10211"></a>10211                                     <span class="stringliteral">&quot;%spriority = %s\n&quot;</span>,
<a name="l10212"></a>10212                                     <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), 
<a name="l10213"></a>10213                                     <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10214"></a>10214                                     <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a>), 
<a name="l10215"></a>10215                                     <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10216"></a>10216                                     caller_pref_buf,
<a name="l10217"></a>10217                                     <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10218"></a>10218                                     <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(format), 
<a name="l10219"></a>10219                                     <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10220"></a>10220                                     host_pref_buf, 
<a name="l10221"></a>10221                                     <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10222"></a>10222                                     using_prefs);
<a name="l10223"></a>10223                         
<a name="l10224"></a>10224                         <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a118e127ad054dd53da114de1a0cb8522">chosenformat</a> = format;
<a name="l10225"></a>10225                         <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8182bed8f54e0fb3cc0575d24519b1ef">IAX_DELAYPBXSTART</a>);
<a name="l10226"></a>10226                      } <span class="keywordflow">else</span> {
<a name="l10227"></a>10227                         <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>);
<a name="l10228"></a>10228                         <span class="comment">/* If this is a TBD call, we&apos;re ready but now what...  */</span>
<a name="l10229"></a>10229                         <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Accepted unauthenticated TBD call from %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr));
<a name="l10230"></a>10230                      }
<a name="l10231"></a>10231                   }
<a name="l10232"></a>10232                }
<a name="l10233"></a>10233                <span class="keywordflow">break</span>;
<a name="l10234"></a>10234             }
<a name="l10235"></a>10235             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> &amp; <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>)
<a name="l10236"></a>10236                <a class="code" href="chan__iax2_8c.html#ae04cb63aa7cb2e9869c473d46c4998a3">merge_encryption</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>],ies.<a class="code" href="structiax__ies.html#a91fce818393dd09b9565b16568e991db">encmethods</a>);
<a name="l10237"></a>10237             <span class="keywordflow">else</span>
<a name="l10238"></a>10238                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = 0;
<a name="l10239"></a>10239             <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a9cd137f417ee18b77860630386e5e3c4">authenticate_request</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>])
<a name="l10240"></a>10240                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>);
<a name="l10241"></a>10241             <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10242"></a>10242                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10243"></a>10243                <span class="keywordflow">return</span> 1;
<a name="l10244"></a>10244             }
<a name="l10245"></a>10245             <span class="keywordflow">break</span>;
<a name="l10246"></a>10246          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae89a0a9be99682834a3f7fc9434e7625">IAX_COMMAND_DPREQ</a>:
<a name="l10247"></a>10247             <span class="comment">/* Request status in the dialplan */</span>
<a name="l10248"></a>10248             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>) &amp;&amp;
<a name="l10249"></a>10249                !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>) &amp;&amp; ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>) {
<a name="l10250"></a>10250                <span class="keywordflow">if</span> (iaxcompat) {
<a name="l10251"></a>10251                   <span class="comment">/* Spawn a thread for the lookup */</span>
<a name="l10252"></a>10252                   <a class="code" href="chan__iax2_8c.html#a72d6ae9fc1eb756f98d848568f44de4e">spawn_dp_lookup</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context, ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;cid_num);
<a name="l10253"></a>10253                } <span class="keywordflow">else</span> {
<a name="l10254"></a>10254                   <span class="comment">/* Just look it up */</span>
<a name="l10255"></a>10255                   <a class="code" href="chan__iax2_8c.html#a903295362112b299b8857614ba887aa9">dp_lookup</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context, ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;cid_num, 1);
<a name="l10256"></a>10256                }
<a name="l10257"></a>10257             }
<a name="l10258"></a>10258             <span class="keywordflow">break</span>;
<a name="l10259"></a>10259          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4b934f8100fc77df870a27d2aa09b9ee">IAX_COMMAND_HANGUP</a>:
<a name="l10260"></a>10260             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>);
<a name="l10261"></a>10261             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Immediately destroying %d, having received hangup\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10262"></a>10262             <span class="comment">/* Set hangup cause according to remote */</span>
<a name="l10263"></a>10263             <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a63efaaaa95c2ebe89b8533ecc499656b">causecode</a> &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l10264"></a>10264                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = ies.<a class="code" href="structiax__ies.html#a63efaaaa95c2ebe89b8533ecc499656b">causecode</a>;
<a name="l10265"></a>10265             <span class="comment">/* Send ack immediately, before we destroy */</span>
<a name="l10266"></a>10266             <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10267"></a>10267             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10268"></a>10268             <span class="keywordflow">break</span>;
<a name="l10269"></a>10269          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>:
<a name="l10270"></a>10270             <span class="comment">/* Set hangup cause according to remote */</span>
<a name="l10271"></a>10271             <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a63efaaaa95c2ebe89b8533ecc499656b">causecode</a> &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l10272"></a>10272                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#aa4261b664d6712ba8551bde24ad17382">hangupcause</a> = ies.<a class="code" href="structiax__ies.html#a63efaaaa95c2ebe89b8533ecc499656b">causecode</a>;
<a name="l10273"></a>10273 
<a name="l10274"></a>10274             <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaaeca8376f09c96f96ffd39107da8aefd">IAX_PROVISION</a>)) {
<a name="l10275"></a>10275                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; authdebug)
<a name="l10276"></a>10276                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Call rejected by %s: %s\n&quot;</span>,
<a name="l10277"></a>10277                      <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr),
<a name="l10278"></a>10278                      ies.<a class="code" href="structiax__ies.html#aafb1a6fb6b61eddeaa9d3aa635858acc">cause</a> ? ies.<a class="code" href="structiax__ies.html#aafb1a6fb6b61eddeaa9d3aa635858acc">cause</a> : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10279"></a>10279                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Immediately destroying %d, having received reject\n&quot;</span>,
<a name="l10280"></a>10280                   fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10281"></a>10281             }
<a name="l10282"></a>10282             <span class="comment">/* Send ack immediately, before we destroy */</span>
<a name="l10283"></a>10283             <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>,
<a name="l10284"></a>10284                          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0, fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10285"></a>10285             <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaaeca8376f09c96f96ffd39107da8aefd">IAX_PROVISION</a>))
<a name="l10286"></a>10286                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a11614f44ef4d939bdd984953346a7572">error</a> = EPERM;
<a name="l10287"></a>10287             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10288"></a>10288             <span class="keywordflow">break</span>;
<a name="l10289"></a>10289          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa6e92b95649c6f900a7bc462c9d7e9a5d">IAX_COMMAND_TRANSFER</a>:
<a name="l10290"></a>10290          {
<a name="l10291"></a>10291             <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *bridged_chan;
<a name="l10292"></a>10292 
<a name="l10293"></a>10293             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a> &amp;&amp; (bridged_chan = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)) &amp;&amp; ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>) {
<a name="l10294"></a>10294                <span class="comment">/* Set BLINDTRANSFER channel variables */</span>
<a name="l10295"></a>10295 
<a name="l10296"></a>10296                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10297"></a>10297                <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>, <span class="stringliteral">&quot;BLINDTRANSFER&quot;</span>, bridged_chan-&gt;name);
<a name="l10298"></a>10298                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10299"></a>10299                <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10300"></a>10300                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10301"></a>10301                   <span class="keywordflow">return</span> 1;
<a name="l10302"></a>10302                }
<a name="l10303"></a>10303 
<a name="l10304"></a>10304                <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(bridged_chan, <span class="stringliteral">&quot;BLINDTRANSFER&quot;</span>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;name);
<a name="l10305"></a>10305                <span class="keywordflow">if</span> (!strcmp(ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, <a class="code" href="features_8h.html#a716860609c92cd4b7fb8f6eb724ac700" title="Determine system parking extension.">ast_parking_ext</a>())) {
<a name="l10306"></a>10306                   <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *saved_channel = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>;
<a name="l10307"></a>10307                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10308"></a>10308                   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#af1b3f7b40e38811796b85df549034f7a">iax_park</a>(bridged_chan, saved_channel)) {
<a name="l10309"></a>10309                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to park call on &apos;%s&apos;\n&quot;</span>, bridged_chan-&gt;name);
<a name="l10310"></a>10310                   } <span class="keywordflow">else</span> {
<a name="l10311"></a>10311                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Parked call on &apos;%s&apos;\n&quot;</span>, <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)-&gt;name);
<a name="l10312"></a>10312                   }
<a name="l10313"></a>10313                   <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10314"></a>10314                } <span class="keywordflow">else</span> {
<a name="l10315"></a>10315                   <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#ae0ba2eb966a9e3376de61d30513f7302" title="Set the channel to next execute the specified dialplan location.">ast_async_goto</a>(bridged_chan, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context, ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, 1))
<a name="l10316"></a>10316                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Async goto of &apos;%s&apos; to &apos;%s@%s&apos; failed\n&quot;</span>, bridged_chan-&gt;name, 
<a name="l10317"></a>10317                         ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10318"></a>10318                   <span class="keywordflow">else</span> {
<a name="l10319"></a>10319                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Async goto of &apos;%s&apos; to &apos;%s@%s&apos; started\n&quot;</span>, bridged_chan-&gt;name, 
<a name="l10320"></a>10320                         ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10321"></a>10321                   }
<a name="l10322"></a>10322                }
<a name="l10323"></a>10323             } <span class="keywordflow">else</span> {
<a name="l10324"></a>10324                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Async goto not applicable on call %d\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10325"></a>10325             }
<a name="l10326"></a>10326 
<a name="l10327"></a>10327             <span class="keywordflow">break</span>;
<a name="l10328"></a>10328          }
<a name="l10329"></a>10329          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa932a80e68f2fe87e57820e76c25caedb">IAX_COMMAND_ACCEPT</a>:
<a name="l10330"></a>10330             <span class="comment">/* Ignore if call is already up or needs authentication or is a TBD */</span>
<a name="l10331"></a>10331             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a> | <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a> | <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>))
<a name="l10332"></a>10332                <span class="keywordflow">break</span>;
<a name="l10333"></a>10333             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaaeca8376f09c96f96ffd39107da8aefd">IAX_PROVISION</a>)) {
<a name="l10334"></a>10334                <span class="comment">/* Send ack immediately, before we destroy */</span>
<a name="l10335"></a>10335                <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10336"></a>10336                <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10337"></a>10337                <span class="keywordflow">break</span>;
<a name="l10338"></a>10338             }
<a name="l10339"></a>10339             <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a6fea735e1b12f87689267ca76a7f4037">format</a>) {
<a name="l10340"></a>10340                <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> = ies.<a class="code" href="structiax__ies.html#a6fea735e1b12f87689267ca76a7f4037">format</a>;
<a name="l10341"></a>10341             } <span class="keywordflow">else</span> {
<a name="l10342"></a>10342                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>)
<a name="l10343"></a>10343                   <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a9241175b397dfd032c4cadbc8c9c2d05">owner</a>-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>;
<a name="l10344"></a>10344                <span class="keywordflow">else</span>
<a name="l10345"></a>10345                   <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>;
<a name="l10346"></a>10346             }
<a name="l10347"></a>10347             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Call accepted by %s (format %s)\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr), <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a>));
<a name="l10348"></a>10348             <span class="keywordflow">if</span> (!(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a1342c28dc947c9339a8188c595061222">peerformat</a> &amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>)) {
<a name="l10349"></a>10349                memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10350"></a>10350                <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Unable to negotiate codec&quot;</span>);
<a name="l10351"></a>10351                <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a208e4fc34932b91fc9e90d9008329e87">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>);
<a name="l10352"></a>10352                <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10353"></a>10353                <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10354"></a>10354                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10355"></a>10355                   <span class="keywordflow">return</span> 1;
<a name="l10356"></a>10356                }
<a name="l10357"></a>10357                <span class="keywordflow">if</span> (authdebug)
<a name="l10358"></a>10358                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected call to %s, format 0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10359"></a>10359             } <span class="keywordflow">else</span> {
<a name="l10360"></a>10360                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>);
<a name="l10361"></a>10361                <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner) {
<a name="l10362"></a>10362                   <span class="comment">/* Switch us to use a compatible format */</span>
<a name="l10363"></a>10363                   iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;nativeformats = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat;
<a name="l10364"></a>10364                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Format for call is %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;nativeformats));
<a name="l10365"></a>10365 retryowner2:
<a name="l10366"></a>10366                   <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner)) {
<a name="l10367"></a>10367                      <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10368"></a>10368                      <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner) <span class="keywordflow">goto</span> retryowner2;
<a name="l10369"></a>10369                   }
<a name="l10370"></a>10370                   
<a name="l10371"></a>10371                   <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner) {
<a name="l10372"></a>10372                      <span class="comment">/* Setup read/write formats properly. */</span>
<a name="l10373"></a>10373                      <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;writeformat)
<a name="l10374"></a>10374                         <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;writeformat);   
<a name="l10375"></a>10375                      <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;readformat)
<a name="l10376"></a>10376                         <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;readformat);  
<a name="l10377"></a>10377                      <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner);
<a name="l10378"></a>10378                   }
<a name="l10379"></a>10379                }
<a name="l10380"></a>10380             }
<a name="l10381"></a>10381             <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10382"></a>10382                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l10383"></a>10383                <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;dpentries, dp, peer_list)
<a name="l10384"></a>10384                   <span class="keywordflow">if</span> (!(dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493af75a0829e95bf2ea13767b29d505a5ed">CACHE_FLAG_TRANSMITTED</a>))
<a name="l10385"></a>10385                      <a class="code" href="chan__iax2_8c.html#affb728aed260a44a6c7e8d18327766cb">iax2_dprequest</a>(dp, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10386"></a>10386                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l10387"></a>10387             }
<a name="l10388"></a>10388             <span class="keywordflow">break</span>;
<a name="l10389"></a>10389          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effaa68c0d056acb361b1117cbad4121d418">IAX_COMMAND_POKE</a>:
<a name="l10390"></a>10390             <span class="comment">/* Send back a pong packet with the original timestamp */</span>
<a name="l10391"></a>10391             <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa499c741ada032d5c451e6f45580a6444">IAX_COMMAND_PONG</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0, -1);
<a name="l10392"></a>10392             <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10393"></a>10393                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10394"></a>10394                <span class="keywordflow">return</span> 1;
<a name="l10395"></a>10395             }
<a name="l10396"></a>10396             <span class="keywordflow">break</span>;
<a name="l10397"></a>10397          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa6092ebf7be4bb70be5c0f1fdb48017a4">IAX_COMMAND_PING</a>:
<a name="l10398"></a>10398          {
<a name="l10399"></a>10399             <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> pingied;
<a name="l10400"></a>10400             <a class="code" href="chan__iax2_8c.html#a3aee65d76c2b8a93f9dc595672a66a64">construct_rr</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], &amp;pingied);
<a name="l10401"></a>10401             <span class="comment">/* Send back a pong packet with the original timestamp */</span>
<a name="l10402"></a>10402             <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa499c741ada032d5c451e6f45580a6444">IAX_COMMAND_PONG</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, pingied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, pingied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10403"></a>10403          }
<a name="l10404"></a>10404             <span class="keywordflow">break</span>;
<a name="l10405"></a>10405          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa499c741ada032d5c451e6f45580a6444">IAX_COMMAND_PONG</a>:
<a name="l10406"></a>10406             <span class="comment">/* Calculate ping time */</span>
<a name="l10407"></a>10407             iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime =  <a class="code" href="chan__iax2_8c.html#a9fd242af6fb851f79a5e184beb40933c">calc_timestamp</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], 0, &amp;f) - fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l10408"></a>10408             <span class="comment">/* save RR info */</span>
<a name="l10409"></a>10409             <a class="code" href="chan__iax2_8c.html#a055b632f6f93dea3d40d6cac70c907fa">save_rr</a>(fr, &amp;ies);
<a name="l10410"></a>10410 
<a name="l10411"></a>10411             <span class="comment">/* Good time to write jb stats for this call */</span>
<a name="l10412"></a>10412             <a class="code" href="chan__iax2_8c.html#ad5c5256eceb83cbf57a2c8a84b0b000c">log_jitterstats</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10413"></a>10413 
<a name="l10414"></a>10414             <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerpoke) {
<a name="l10415"></a>10415                peer = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerpoke;
<a name="l10416"></a>10416                <span class="keywordflow">if</span> ((peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &lt; 0)  || (peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> &gt; peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>)) {
<a name="l10417"></a>10417                   <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime &lt;= peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>) {
<a name="l10418"></a>10418                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Peer &apos;%s&apos; is now REACHABLE! Time: %d\n&quot;</span>, peer-&gt;name, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime);
<a name="l10419"></a>10419                      <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;PeerStatus&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nPeer: IAX2/%s\r\nPeerStatus: Reachable\r\nTime: %d\r\n&quot;</span>, peer-&gt;name, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime); 
<a name="l10420"></a>10420                      <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, peer-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l10421"></a>10421                   }
<a name="l10422"></a>10422                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> &gt; 0) &amp;&amp; (peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> &lt;= peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>)) {
<a name="l10423"></a>10423                   <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime &gt; peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>) {
<a name="l10424"></a>10424                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Peer &apos;%s&apos; is now TOO LAGGED (%d ms)!\n&quot;</span>, peer-&gt;name, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime);
<a name="l10425"></a>10425                      <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;PeerStatus&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nPeer: IAX2/%s\r\nPeerStatus: Lagged\r\nTime: %d\r\n&quot;</span>, peer-&gt;name, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime); 
<a name="l10426"></a>10426                      <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, peer-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l10427"></a>10427                   }
<a name="l10428"></a>10428                }
<a name="l10429"></a>10429                peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime;
<a name="l10430"></a>10430                <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">smoothing</a> &amp;&amp; (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &gt; -1))
<a name="l10431"></a>10431                   peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> = (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime + peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a>) / 2;
<a name="l10432"></a>10432                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">smoothing</a> &amp;&amp; peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &lt; 0)
<a name="l10433"></a>10433                   peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> = (0 + peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a>) / 2;
<a name="l10434"></a>10434                <span class="keywordflow">else</span>              
<a name="l10435"></a>10435                   peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;pingtime;
<a name="l10436"></a>10436 
<a name="l10437"></a>10437                <span class="comment">/* Remove scheduled iax2_poke_noanswer */</span>
<a name="l10438"></a>10438                <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> &gt; -1) {
<a name="l10439"></a>10439                   <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a>)) {
<a name="l10440"></a>10440                      <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l10441"></a>10441                      peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l10442"></a>10442                   }
<a name="l10443"></a>10443                }
<a name="l10444"></a>10444                <span class="comment">/* Schedule the next cycle */</span>
<a name="l10445"></a>10445                <span class="keywordflow">if</span> ((peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &lt; 0)  || (peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> &gt; peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>)) 
<a name="l10446"></a>10446                   peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>, <a class="code" href="chan__iax2_8c.html#acc5f5c09967027708bf5b6e6374f5935">iax2_poke_peer_s</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l10447"></a>10447                <span class="keywordflow">else</span>
<a name="l10448"></a>10448                   peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a0fc1d0f0302835103c4b7c291c2467b1">pokefreqok</a>, <a class="code" href="chan__iax2_8c.html#acc5f5c09967027708bf5b6e6374f5935">iax2_poke_peer_s</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l10449"></a>10449                <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> == -1)
<a name="l10450"></a>10450                   <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l10451"></a>10451                <span class="comment">/* and finally send the ack */</span>
<a name="l10452"></a>10452                <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10453"></a>10453                <span class="comment">/* And wrap up the qualify call */</span>
<a name="l10454"></a>10454                <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10455"></a>10455                peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> = 0;
<a name="l10456"></a>10456                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Peer %s: got pong, lastms %d, historicms %d, maxms %d\n&quot;</span>, peer-&gt;name, peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>, peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a>, peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>);
<a name="l10457"></a>10457             }
<a name="l10458"></a>10458             <span class="keywordflow">break</span>;
<a name="l10459"></a>10459          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4aa1de389272603658d92a449bb6009f">IAX_COMMAND_LAGRQ</a>:
<a name="l10460"></a>10460          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7651116cd23210a0c999063a6c1d6b64">IAX_COMMAND_LAGRP</a>:
<a name="l10461"></a>10461             f.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;LAGRQ&quot;</span>;
<a name="l10462"></a>10462             f.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l10463"></a>10463             f.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0;
<a name="l10464"></a>10464             f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l10465"></a>10465             <a class="code" href="iax2-parser_8c.html#ac7172830d863702f96f81d8a09612428">iax_frame_wrap</a>(fr, &amp;f);
<a name="l10466"></a>10466             <span class="keywordflow">if</span>(f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4aa1de389272603658d92a449bb6009f">IAX_COMMAND_LAGRQ</a>) {
<a name="l10467"></a>10467                <span class="comment">/* Received a LAGRQ - echo back a LAGRP */</span>
<a name="l10468"></a>10468                fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7651116cd23210a0c999063a6c1d6b64">IAX_COMMAND_LAGRP</a>;
<a name="l10469"></a>10469                <a class="code" href="chan__iax2_8c.html#af1bf0e6593f0a4440821d3486ca45b76">iax2_send</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], &amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, -1, 0, 0, 0);
<a name="l10470"></a>10470             } <span class="keywordflow">else</span> {
<a name="l10471"></a>10471                <span class="comment">/* Received LAGRP in response to our LAGRQ */</span>
<a name="l10472"></a>10472                <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ts;
<a name="l10473"></a>10473                <span class="comment">/* This is a reply we&apos;ve been given, actually measure the difference */</span>
<a name="l10474"></a>10474                ts = <a class="code" href="chan__iax2_8c.html#a9fd242af6fb851f79a5e184beb40933c">calc_timestamp</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], 0, &amp;fr-&gt;<a class="code" href="structiax__frame.html#aed3d7ad666c6711b52855819a1e49612">af</a>);
<a name="l10475"></a>10475                iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;lag = ts - fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l10476"></a>10476                <span class="keywordflow">if</span> (iaxdebug)
<a name="l10477"></a>10477                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Peer %s lag measured as %dms\n&quot;</span>,
<a name="l10478"></a>10478                      <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;addr.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;lag);
<a name="l10479"></a>10479             }
<a name="l10480"></a>10480             <span class="keywordflow">break</span>;
<a name="l10481"></a>10481          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa85a01799deb4255dd6bd5fc06cd719f3">IAX_COMMAND_AUTHREQ</a>:
<a name="l10482"></a>10482             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a> | <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>)) {
<a name="l10483"></a>10483                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Call on %s is already up, can&apos;t start on it\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner ? iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10484"></a>10484                <span class="keywordflow">break</span>;
<a name="l10485"></a>10485             }
<a name="l10486"></a>10486             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0bbca4bef81d9f18a98cc50b5d0e9eac">authenticate_reply</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], &amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;addr, &amp;ies, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;secret, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;outkey)) {
<a name="l10487"></a>10487                <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> hangup_fr = { .<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>,
<a name="l10488"></a>10488                         .subclass = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa7dac1c1896ab418c2ff351aae707fba">AST_CONTROL_HANGUP</a>,
<a name="l10489"></a>10489                };
<a name="l10490"></a>10490                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, 
<a name="l10491"></a>10491                   <span class="stringliteral">&quot;I don&apos;t know how to authenticate %s to %s\n&quot;</span>, 
<a name="l10492"></a>10492                   ies.<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a> ? ies.<a class="code" href="structiax__ies.html#a9b20c006bd90a09e1465fb668700e81d">username</a> : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;addr.sin_addr));
<a name="l10493"></a>10493                <a class="code" href="chan__iax2_8c.html#ad984fc5dad303088b72be66c61a1e99f" title="Queue a frame to a call&amp;#39;s owning asterisk channel.">iax2_queue_frame</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, &amp;hangup_fr);
<a name="l10494"></a>10494             }
<a name="l10495"></a>10495             <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10496"></a>10496                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10497"></a>10497                <span class="keywordflow">return</span> 1;
<a name="l10498"></a>10498             }
<a name="l10499"></a>10499             <span class="keywordflow">break</span>;
<a name="l10500"></a>10500          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa1408b2e0afffb3e8b241b059b5ffdc29">IAX_COMMAND_AUTHREP</a>:
<a name="l10501"></a>10501             <span class="comment">/* For security, always ack immediately */</span>
<a name="l10502"></a>10502             <span class="keywordflow">if</span> (delayreject)
<a name="l10503"></a>10503                <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10504"></a>10504             <span class="comment">/* Ignore once we&apos;ve started */</span>
<a name="l10505"></a>10505             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a> | <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>)) {
<a name="l10506"></a>10506                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Call on %s is already up, can&apos;t start on it\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner ? iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10507"></a>10507                <span class="keywordflow">break</span>;
<a name="l10508"></a>10508             }
<a name="l10509"></a>10509             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#ada169c41e135b07cc8360269b98c30ba">authenticate_verify</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], &amp;ies)) {
<a name="l10510"></a>10510                <span class="keywordflow">if</span> (authdebug)
<a name="l10511"></a>10511                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Host %s failed to authenticate as %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;addr.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;username);
<a name="l10512"></a>10512                memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10513"></a>10513                <a class="code" href="chan__iax2_8c.html#a239b18f98846d5c7426ae7ee4ba97028">auth_fail</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>);
<a name="l10514"></a>10514                <span class="keywordflow">break</span>;
<a name="l10515"></a>10515             }
<a name="l10516"></a>10516             <span class="keywordflow">if</span> (strcasecmp(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <span class="stringliteral">&quot;TBD&quot;</span>)) {
<a name="l10517"></a>10517                <span class="comment">/* This might re-enter the IAX code and need the lock */</span>
<a name="l10518"></a>10518                exists = <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, 1, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;cid_num);
<a name="l10519"></a>10519             } <span class="keywordflow">else</span>
<a name="l10520"></a>10520                exists = 0;
<a name="l10521"></a>10521             <span class="keywordflow">if</span> (strcmp(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <span class="stringliteral">&quot;TBD&quot;</span>) &amp;&amp; !exists) {
<a name="l10522"></a>10522                <span class="keywordflow">if</span> (authdebug)
<a name="l10523"></a>10523                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, request &apos;%s@%s&apos; does not exist\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10524"></a>10524                memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10525"></a>10525                <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;No such context/extension&quot;</span>);
<a name="l10526"></a>10526                <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#ace4ceec464072bb9e269b6a52e7a6631">AST_CAUSE_NO_ROUTE_DESTINATION</a>);
<a name="l10527"></a>10527                <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10528"></a>10528                <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10529"></a>10529                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10530"></a>10530                   <span class="keywordflow">return</span> 1;
<a name="l10531"></a>10531                }
<a name="l10532"></a>10532             } <span class="keywordflow">else</span> {
<a name="l10533"></a>10533                <span class="comment">/* Select an appropriate format */</span>
<a name="l10534"></a>10534                <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>)) {
<a name="l10535"></a>10535                   <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>)) {
<a name="l10536"></a>10536                      using_prefs = <span class="stringliteral">&quot;reqonly&quot;</span>;
<a name="l10537"></a>10537                   } <span class="keywordflow">else</span> {
<a name="l10538"></a>10538                      using_prefs = <span class="stringliteral">&quot;disabled&quot;</span>;
<a name="l10539"></a>10539                   }
<a name="l10540"></a>10540                   format = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability;
<a name="l10541"></a>10541                   memset(&amp;pref, 0, <span class="keyword">sizeof</span>(pref));
<a name="l10542"></a>10542                   strcpy(caller_pref_buf, <span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10543"></a>10543                   strcpy(host_pref_buf, <span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10544"></a>10544                } <span class="keywordflow">else</span> {
<a name="l10545"></a>10545                   using_prefs = <span class="stringliteral">&quot;mine&quot;</span>;
<a name="l10546"></a>10546                   <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>)
<a name="l10547"></a>10547                      <a class="code" href="frame_8h.html#a42cc334b6773ff33cb3c24ca5a916842" title="Shift an audio codec preference list up or down 65 bytes so that it becomes an ASCII...">ast_codec_pref_convert</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs, ies.<a class="code" href="structiax__ies.html#a8b5755e8142680babf7044c7e2642e29">codec_prefs</a>, 32, 0);
<a name="l10548"></a>10548                   <span class="keywordflow">if</span> (<a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs, 0)) {
<a name="l10549"></a>10549                      <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>)) {
<a name="l10550"></a>10550                         pref = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs;
<a name="l10551"></a>10551                         using_prefs = <span class="stringliteral">&quot;caller&quot;</span>;
<a name="l10552"></a>10552                      } <span class="keywordflow">else</span> {
<a name="l10553"></a>10553                         pref = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;prefs;
<a name="l10554"></a>10554                      }
<a name="l10555"></a>10555                   } <span class="keywordflow">else</span> <span class="comment">/* if no codec_prefs IE do it the old way */</span>
<a name="l10556"></a>10556                      pref = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;prefs;
<a name="l10557"></a>10557                
<a name="l10558"></a>10558                   format = <a class="code" href="frame_8h.html#a123ec7e6e90e279b75bc6447eab5d3b2" title="Select the best audio format according to preference list from supplied options....">ast_codec_choose</a>(&amp;pref, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability, 0);
<a name="l10559"></a>10559                   <a class="code" href="frame_8h.html#a784e4f7371cbfce0b3e9f957f7ce54e3" title="Dump audio codec preference list into a string.">ast_codec_pref_string</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs, caller_pref_buf, <span class="keyword">sizeof</span>(caller_pref_buf) - 1);
<a name="l10560"></a>10560                   <a class="code" href="frame_8h.html#a784e4f7371cbfce0b3e9f957f7ce54e3" title="Dump audio codec preference list into a string.">ast_codec_pref_string</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;prefs, host_pref_buf, <span class="keyword">sizeof</span>(host_pref_buf) - 1);
<a name="l10561"></a>10561                }
<a name="l10562"></a>10562                <span class="keywordflow">if</span> (!format) {
<a name="l10563"></a>10563                   <span class="keywordflow">if</span>(!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>)) {
<a name="l10564"></a>10564                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;We don&apos;t do requested format %s, falling back to peer capability %d\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability);
<a name="l10565"></a>10565                      format = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability;
<a name="l10566"></a>10566                   }
<a name="l10567"></a>10567                   <span class="keywordflow">if</span> (!format) {
<a name="l10568"></a>10568                      <span class="keywordflow">if</span> (authdebug) {
<a name="l10569"></a>10569                         <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>)) 
<a name="l10570"></a>10570                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested 0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10571"></a>10571                         <span class="keywordflow">else</span>
<a name="l10572"></a>10572                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested/capability 0x%x/0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10573"></a>10573                      }
<a name="l10574"></a>10574                      memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10575"></a>10575                      <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Unable to negotiate codec&quot;</span>);
<a name="l10576"></a>10576                      <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a208e4fc34932b91fc9e90d9008329e87">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>);
<a name="l10577"></a>10577                      <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10578"></a>10578                      <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10579"></a>10579                         <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10580"></a>10580                         <span class="keywordflow">return</span> 1;
<a name="l10581"></a>10581                      }
<a name="l10582"></a>10582                   } <span class="keywordflow">else</span> {
<a name="l10583"></a>10583                      <span class="comment">/* Pick one... */</span>
<a name="l10584"></a>10584                      <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>)) {
<a name="l10585"></a>10585                         <span class="keywordflow">if</span>(!(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability))
<a name="l10586"></a>10586                            format = 0;
<a name="l10587"></a>10587                      } <span class="keywordflow">else</span> {
<a name="l10588"></a>10588                         <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>)) {
<a name="l10589"></a>10589                            using_prefs = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>) ? <span class="stringliteral">&quot;reqonly&quot;</span> : <span class="stringliteral">&quot;disabled&quot;</span>;
<a name="l10590"></a>10590                            memset(&amp;pref, 0, <span class="keyword">sizeof</span>(pref));
<a name="l10591"></a>10591                            format = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>) ?
<a name="l10592"></a>10592                               iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat : <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10593"></a>10593                            strcpy(caller_pref_buf,<span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10594"></a>10594                            strcpy(host_pref_buf,<span class="stringliteral">&quot;disabled&quot;</span>);
<a name="l10595"></a>10595                         } <span class="keywordflow">else</span> {
<a name="l10596"></a>10596                            using_prefs = <span class="stringliteral">&quot;mine&quot;</span>;
<a name="l10597"></a>10597                            <span class="keywordflow">if</span> (<a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs, 0)) {
<a name="l10598"></a>10598                               <span class="comment">/* Do the opposite of what we tried above. */</span>
<a name="l10599"></a>10599                               <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>)) {
<a name="l10600"></a>10600                                  pref = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;prefs;                 
<a name="l10601"></a>10601                               } <span class="keywordflow">else</span> {
<a name="l10602"></a>10602                                  pref = iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;rprefs;
<a name="l10603"></a>10603                                  using_prefs = <span class="stringliteral">&quot;caller&quot;</span>;
<a name="l10604"></a>10604                               }
<a name="l10605"></a>10605                               format = <a class="code" href="frame_8h.html#a123ec7e6e90e279b75bc6447eab5d3b2" title="Select the best audio format according to preference list from supplied options....">ast_codec_choose</a>(&amp;pref, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability, 1);
<a name="l10606"></a>10606                            } <span class="keywordflow">else</span> <span class="comment">/* if no codec_prefs IE do it the old way */</span>
<a name="l10607"></a>10607                               format = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability); 
<a name="l10608"></a>10608                         }
<a name="l10609"></a>10609                      }
<a name="l10610"></a>10610                      <span class="keywordflow">if</span> (!format) {
<a name="l10611"></a>10611                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No best format in 0x%x???\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability &amp; iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10612"></a>10612                         <span class="keywordflow">if</span> (authdebug) {
<a name="l10613"></a>10613                            <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>))
<a name="l10614"></a>10614                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested 0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10615"></a>10615                            <span class="keywordflow">else</span>
<a name="l10616"></a>10616                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected connect attempt from %s, requested/capability 0x%x/0x%x incompatible with our capability 0x%x.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercapability, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;capability);
<a name="l10617"></a>10617                         }
<a name="l10618"></a>10618                         memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10619"></a>10619                         <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;Unable to negotiate codec&quot;</span>);
<a name="l10620"></a>10620                         <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a208e4fc34932b91fc9e90d9008329e87">AST_CAUSE_BEARERCAPABILITY_NOTAVAIL</a>);
<a name="l10621"></a>10621                         <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10622"></a>10622                         <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10623"></a>10623                            <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10624"></a>10624                            <span class="keywordflow">return</span> 1;
<a name="l10625"></a>10625                         }
<a name="l10626"></a>10626                      }
<a name="l10627"></a>10627                   }
<a name="l10628"></a>10628                }
<a name="l10629"></a>10629                <span class="keywordflow">if</span> (format) {
<a name="l10630"></a>10630                   <span class="comment">/* Authentication received */</span>
<a name="l10631"></a>10631                   memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l10632"></a>10632                   <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied1, <a class="code" href="iax2_8h.html#a81b21fd8bbf4f19527fbb21277687bd5">IAX_IE_FORMAT</a>, format);
<a name="l10633"></a>10633                   <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa932a80e68f2fe87e57820e76c25caedb">IAX_COMMAND_ACCEPT</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10634"></a>10634                   <span class="keywordflow">if</span> (strcmp(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, <span class="stringliteral">&quot;TBD&quot;</span>)) {
<a name="l10635"></a>10635                      <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>);
<a name="l10636"></a>10636                      <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Accepting AUTHENTICATED call from %s:\n&quot;</span>
<a name="l10637"></a>10637                                  <span class="stringliteral">&quot;%srequested format = %s,\n&quot;</span>
<a name="l10638"></a>10638                                  <span class="stringliteral">&quot;%srequested prefs = %s,\n&quot;</span>
<a name="l10639"></a>10639                                  <span class="stringliteral">&quot;%sactual format = %s,\n&quot;</span>
<a name="l10640"></a>10640                                  <span class="stringliteral">&quot;%shost prefs = %s,\n&quot;</span>
<a name="l10641"></a>10641                                  <span class="stringliteral">&quot;%spriority = %s\n&quot;</span>, 
<a name="l10642"></a>10642                                  <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), 
<a name="l10643"></a>10643                                  <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10644"></a>10644                                  <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat),
<a name="l10645"></a>10645                                  <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10646"></a>10646                                  caller_pref_buf,
<a name="l10647"></a>10647                                  <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10648"></a>10648                                  <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(format),
<a name="l10649"></a>10649                                  <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10650"></a>10650                                  host_pref_buf,
<a name="l10651"></a>10651                                  <a class="code" href="logger_8h.html#a9aaf93f121b63d51444d573673d4b791">VERBOSE_PREFIX_4</a>,
<a name="l10652"></a>10652                                  using_prefs);
<a name="l10653"></a>10653 
<a name="l10654"></a>10654                      <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>);
<a name="l10655"></a>10655                      <span class="keywordflow">if</span> (!(c = <a class="code" href="chan__iax2_8c.html#ab8c22a71161e0538ccb120e3ca5abdd2" title="Create new call, interface with the PBX core.">ast_iax2_new</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, format)))
<a name="l10656"></a>10656                         <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10657"></a>10657                      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l10658"></a>10658                         <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore;
<a name="l10659"></a>10659                         <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *prev = NULL;
<a name="l10660"></a>10660                         <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l10661"></a>10661                         varlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*varlist));
<a name="l10662"></a>10662                         variablestore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l10663"></a>10663                         <span class="keywordflow">if</span> (variablestore &amp;&amp; varlist) {
<a name="l10664"></a>10664                            variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = varlist;
<a name="l10665"></a>10665                            variablestore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l10666"></a>10666                            <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(varlist);
<a name="l10667"></a>10667                            <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I can haz IAX vars? w00t\n&quot;</span>);
<a name="l10668"></a>10668                            <span class="keywordflow">for</span> (var = ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l10669"></a>10669                               <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvar = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l10670"></a>10670                               <span class="keywordflow">if</span> (prev)
<a name="l10671"></a>10671                                  <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l10672"></a>10672                               prev = var;
<a name="l10673"></a>10673                               <span class="keywordflow">if</span> (!newvar) {
<a name="l10674"></a>10674                                  <span class="comment">/* Don&apos;t abort list traversal, as this would leave ies.vars in an inconsistent state. */</span>
<a name="l10675"></a>10675                                  <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l10676"></a>10676                               } <span class="keywordflow">else</span> {
<a name="l10677"></a>10677                                  <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(varlist, newvar, entries);
<a name="l10678"></a>10678                               }
<a name="l10679"></a>10679                            }
<a name="l10680"></a>10680                            <span class="keywordflow">if</span> (prev)
<a name="l10681"></a>10681                               <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l10682"></a>10682                            ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l10683"></a>10683                            <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(c, variablestore);
<a name="l10684"></a>10684                         } <span class="keywordflow">else</span> {
<a name="l10685"></a>10685                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l10686"></a>10686                            <span class="keywordflow">if</span> (variablestore)
<a name="l10687"></a>10687                               <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(variablestore);
<a name="l10688"></a>10688                            <span class="keywordflow">if</span> (varlist)
<a name="l10689"></a>10689                               <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(varlist);
<a name="l10690"></a>10690                         }
<a name="l10691"></a>10691                      }
<a name="l10692"></a>10692                   } <span class="keywordflow">else</span> {
<a name="l10693"></a>10693                      <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>);
<a name="l10694"></a>10694                      <span class="comment">/* If this is a TBD call, we&apos;re ready but now what...  */</span>
<a name="l10695"></a>10695                      <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Accepted AUTHENTICATED TBD call from %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr));
<a name="l10696"></a>10696                      <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae233a3edc609990a3402d03d4ddd5f1e">IAX_IMMEDIATE</a>)) {
<a name="l10697"></a>10697                         <span class="keywordflow">goto</span> immediatedial;
<a name="l10698"></a>10698                      }
<a name="l10699"></a>10699                   }
<a name="l10700"></a>10700                }
<a name="l10701"></a>10701             }
<a name="l10702"></a>10702             <span class="keywordflow">break</span>;
<a name="l10703"></a>10703          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa93040da167cdb2a8b51aa0510a079496">IAX_COMMAND_DIAL</a>:
<a name="l10704"></a>10704 immediatedial:
<a name="l10705"></a>10705             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>)) {
<a name="l10706"></a>10706                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a02edc7cb1490744afdb3ae873dd198d4">IAX_STATE_TBD</a>);
<a name="l10707"></a>10707                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a> ? ies.<a class="code" href="structiax__ies.html#a7fcf5cf7f21e8f71a3e50c431fa18800">called_number</a> : <span class="stringliteral">&quot;s&quot;</span>);
<a name="l10708"></a>10708                <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(NULL, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, 1, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;cid_num)) {
<a name="l10709"></a>10709                   <span class="keywordflow">if</span> (authdebug)
<a name="l10710"></a>10710                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Rejected dial attempt from %s, request &apos;%s@%s&apos; does not exist\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;exten, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;context);
<a name="l10711"></a>10711                   memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10712"></a>10712                   <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;No such context/extension&quot;</span>);
<a name="l10713"></a>10713                   <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#ace4ceec464072bb9e269b6a52e7a6631">AST_CAUSE_NO_ROUTE_DESTINATION</a>);
<a name="l10714"></a>10714                   <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10715"></a>10715                   <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10716"></a>10716                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10717"></a>10717                      <span class="keywordflow">return</span> 1;
<a name="l10718"></a>10718                   }
<a name="l10719"></a>10719                } <span class="keywordflow">else</span> {
<a name="l10720"></a>10720                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>);
<a name="l10721"></a>10721                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Accepting DIAL from %s, formats = 0x%x\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr), iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat);
<a name="l10722"></a>10722                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>);
<a name="l10723"></a>10723                   <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a1a461c5e737ed6ed7c8cb0f78557a6fd">AST_CONTROL_PROGRESS</a>, 0, NULL, 0, -1);
<a name="l10724"></a>10724                   <span class="keywordflow">if</span> (!(c = <a class="code" href="chan__iax2_8c.html#ab8c22a71161e0538ccb120e3ca5abdd2" title="Create new call, interface with the PBX core.">ast_iax2_new</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a10482c2bc6340e09ed02b00bc0e3f433">AST_STATE_RING</a>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peerformat)))
<a name="l10725"></a>10725                      <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10726"></a>10726                   <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l10727"></a>10727                      <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *variablestore;
<a name="l10728"></a>10728                      <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *prev = NULL;
<a name="l10729"></a>10729                      <a class="code" href="linkedlists_8h.html#acdb4f56da6b3071d02dcce20072852b0" title="Defines a structure to be used to hold a list of specified type.">AST_LIST_HEAD</a>(, <a class="code" href="structast__var__t.html">ast_var_t</a>) *varlist;
<a name="l10730"></a>10730                      varlist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*varlist));
<a name="l10731"></a>10731                      variablestore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0c54af608776bc36881f57d8769fc083">iax2_variable_datastore_info</a>, NULL);
<a name="l10732"></a>10732                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I can haz IAX vars? w00t\n&quot;</span>);
<a name="l10733"></a>10733                      <span class="keywordflow">if</span> (variablestore &amp;&amp; varlist) {
<a name="l10734"></a>10734                         variablestore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = varlist;
<a name="l10735"></a>10735                         variablestore-&gt;<a class="code" href="structast__datastore.html#a79d869daa2e63a92b3e5f542446031bb">inheritance</a> = <a class="code" href="channel_8h.html#a3a32e3014998d0066281c4dd8e278ae9">DATASTORE_INHERIT_FOREVER</a>;
<a name="l10736"></a>10736                         <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(varlist);
<a name="l10737"></a>10737                         <span class="keywordflow">for</span> (var = ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l10738"></a>10738                            <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *newvar = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l10739"></a>10739                            <span class="keywordflow">if</span> (prev)
<a name="l10740"></a>10740                               <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l10741"></a>10741                            prev = var;
<a name="l10742"></a>10742                            <span class="keywordflow">if</span> (!newvar) {
<a name="l10743"></a>10743                               <span class="comment">/* Don&apos;t abort list traversal, as this would leave ies.vars in an inconsistent state. */</span>
<a name="l10744"></a>10744                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l10745"></a>10745                            } <span class="keywordflow">else</span> {
<a name="l10746"></a>10746                               <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(varlist, newvar, entries);
<a name="l10747"></a>10747                            }
<a name="l10748"></a>10748                         }
<a name="l10749"></a>10749                         <span class="keywordflow">if</span> (prev)
<a name="l10750"></a>10750                            <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(prev);
<a name="l10751"></a>10751                         ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l10752"></a>10752                         <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(c, variablestore);
<a name="l10753"></a>10753                      } <span class="keywordflow">else</span> {
<a name="l10754"></a>10754                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error while processing IAX2 variables\n&quot;</span>);
<a name="l10755"></a>10755                         <span class="keywordflow">if</span> (variablestore)
<a name="l10756"></a>10756                            <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(variablestore);
<a name="l10757"></a>10757                         <span class="keywordflow">if</span> (varlist)
<a name="l10758"></a>10758                            <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(varlist);
<a name="l10759"></a>10759                      }
<a name="l10760"></a>10760                   }
<a name="l10761"></a>10761                }
<a name="l10762"></a>10762             }
<a name="l10763"></a>10763             <span class="keywordflow">break</span>;
<a name="l10764"></a>10764          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>:
<a name="l10765"></a>10765             iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;error = ENOTCONN;
<a name="l10766"></a>10766             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Immediately destroying %d, having received INVAL\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10767"></a>10767             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10768"></a>10768             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Destroying call %d\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10769"></a>10769             <span class="keywordflow">break</span>;
<a name="l10770"></a>10770          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effabc19cf9ba5ac0470de593a7132027fca">IAX_COMMAND_VNAK</a>:
<a name="l10771"></a>10771             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received VNAK: resending outstanding frames\n&quot;</span>);
<a name="l10772"></a>10772             <span class="comment">/* Force retransmission */</span>
<a name="l10773"></a>10773             <a class="code" href="chan__iax2_8c.html#a2b955d256cb77a10588b658b959f2df6">vnak_retransmit</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10774"></a>10774             <span class="keywordflow">break</span>;
<a name="l10775"></a>10775          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effab17acacea946abf3ccde08f4f49fbfdb">IAX_COMMAND_REGREQ</a>:
<a name="l10776"></a>10776          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9189574bea9c0b4772606120cd74718d">IAX_COMMAND_REGREL</a>:
<a name="l10777"></a>10777             <span class="comment">/* For security, always ack immediately */</span>
<a name="l10778"></a>10778             <span class="keywordflow">if</span> (delayreject)
<a name="l10779"></a>10779                <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10780"></a>10780             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#aedc9b7d0d68dbbefe21019ed00ecfc57" title="Verify inbound registration.">register_verify</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, &amp;sin, &amp;ies)) {
<a name="l10781"></a>10781                <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10782"></a>10782                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10783"></a>10783                   <span class="keywordflow">return</span> 1;
<a name="l10784"></a>10784                }
<a name="l10785"></a>10785                <span class="comment">/* Send delayed failure */</span>
<a name="l10786"></a>10786                <a class="code" href="chan__iax2_8c.html#a239b18f98846d5c7426ae7ee4ba97028">auth_fail</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa8c1a50616eeef8353b4985462e736419">IAX_COMMAND_REGREJ</a>);
<a name="l10787"></a>10787                <span class="keywordflow">break</span>;
<a name="l10788"></a>10788             }
<a name="l10789"></a>10789             <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10790"></a>10790                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10791"></a>10791                <span class="keywordflow">return</span> 1;
<a name="l10792"></a>10792             }
<a name="l10793"></a>10793             <span class="keywordflow">if</span> ((<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;secret) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;inkeys)) ||
<a name="l10794"></a>10794                   <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;state, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773a8729a61803ab666d702f61dec4c0a91f">IAX_STATE_AUTHENTICATED</a>)) {
<a name="l10795"></a>10795 
<a name="l10796"></a>10796                <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9189574bea9c0b4772606120cd74718d">IAX_COMMAND_REGREL</a>)
<a name="l10797"></a>10797                   memset(&amp;sin, 0, <span class="keyword">sizeof</span>(sin));
<a name="l10798"></a>10798                <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0a6e49e6347fca24e527889dca24d78a">update_registry</a>(&amp;sin, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, ies.<a class="code" href="structiax__ies.html#ad5fcf043f3db7ed14e6180f743d95b27">devicetype</a>, fd, ies.<a class="code" href="structiax__ies.html#ab28395d53189be3496131ad9cf9a0a10">refresh</a>))
<a name="l10799"></a>10799                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Registry error\n&quot;</span>);
<a name="l10800"></a>10800                <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10801"></a>10801                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10802"></a>10802                   <span class="keywordflow">return</span> 1;
<a name="l10803"></a>10803                }
<a name="l10804"></a>10804                <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a86275d095709be06b32c7447d7bbabb9">provverpres</a> &amp;&amp; ies.<a class="code" href="structiax__ies.html#ac21dd7ebf66d8aa74c1f1b9be3883484">serviceident</a> &amp;&amp; sin.sin_addr.s_addr) {
<a name="l10805"></a>10805                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10806"></a>10806                   <a class="code" href="chan__iax2_8c.html#a25a386bc9b168cd30b3cee08e50d2c97">check_provisioning</a>(&amp;sin, fd, ies.<a class="code" href="structiax__ies.html#ac21dd7ebf66d8aa74c1f1b9be3883484">serviceident</a>, ies.<a class="code" href="structiax__ies.html#a0eaa250f80df1e07e6613ed6814af9a9">provver</a>);
<a name="l10807"></a>10807                   <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10808"></a>10808                   <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10809"></a>10809                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10810"></a>10810                      <span class="keywordflow">return</span> 1;
<a name="l10811"></a>10811                   }
<a name="l10812"></a>10812                }
<a name="l10813"></a>10813                <span class="keywordflow">break</span>;
<a name="l10814"></a>10814             }
<a name="l10815"></a>10815             <a class="code" href="chan__iax2_8c.html#ac7fdb53a5f7683e75dd58703bed9350b">registry_authrequest</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10816"></a>10816             <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10817"></a>10817                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10818"></a>10818                <span class="keywordflow">return</span> 1;
<a name="l10819"></a>10819             }
<a name="l10820"></a>10820             <span class="keywordflow">break</span>;
<a name="l10821"></a>10821          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7f307f817f7c28c8f6351d7dfe355c53">IAX_COMMAND_REGACK</a>:
<a name="l10822"></a>10822             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a514d9067b96525fee83cb845f5bf79e9" title="Acknowledgment received for OUR registration.">iax2_ack_registry</a>(&amp;ies, &amp;sin, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)) 
<a name="l10823"></a>10823                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Registration failure\n&quot;</span>);
<a name="l10824"></a>10824             <span class="comment">/* Send ack immediately, before we destroy */</span>
<a name="l10825"></a>10825             <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10826"></a>10826             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10827"></a>10827             <span class="keywordflow">break</span>;
<a name="l10828"></a>10828          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa8c1a50616eeef8353b4985462e736419">IAX_COMMAND_REGREJ</a>:
<a name="l10829"></a>10829             <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;reg) {
<a name="l10830"></a>10830                <span class="keywordflow">if</span> (authdebug) {
<a name="l10831"></a>10831                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Registration of &apos;%s&apos; rejected: &apos;%s&apos; from: &apos;%s&apos;\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;reg-&gt;username, ies.<a class="code" href="structiax__ies.html#aafb1a6fb6b61eddeaa9d3aa635858acc">cause</a> ? ies.<a class="code" href="structiax__ies.html#aafb1a6fb6b61eddeaa9d3aa635858acc">cause</a> : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sin.sin_addr));
<a name="l10832"></a>10832                   <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;Registry&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nUsername: %s\r\nStatus: Rejected\r\nCause: %s\r\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;reg-&gt;username, ies.<a class="code" href="structiax__ies.html#aafb1a6fb6b61eddeaa9d3aa635858acc">cause</a> ? ies.<a class="code" href="structiax__ies.html#aafb1a6fb6b61eddeaa9d3aa635858acc">cause</a> : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>);
<a name="l10833"></a>10833                }
<a name="l10834"></a>10834                iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;reg-&gt;regstate = <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a769d5aec3f52823efc8cea5b24794d8d">REG_STATE_REJECTED</a>;
<a name="l10835"></a>10835             }
<a name="l10836"></a>10836             <span class="comment">/* Send ack immediately, before we destroy */</span>
<a name="l10837"></a>10837             <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10838"></a>10838             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10839"></a>10839             <span class="keywordflow">break</span>;
<a name="l10840"></a>10840          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2c4ec8dabaa27f540b64c4a586e7ba95">IAX_COMMAND_REGAUTH</a>:
<a name="l10841"></a>10841             <span class="comment">/* Authentication request */</span>
<a name="l10842"></a>10842             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#ab48db2c2958875909fad81c794d8741b">registry_rerequest</a>(&amp;ies, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, &amp;sin)) {
<a name="l10843"></a>10843                memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10844"></a>10844                <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a1e7246fa61f5cf1f9e4c6e85edc6f5b6">IAX_IE_CAUSE</a>, <span class="stringliteral">&quot;No authority found&quot;</span>);
<a name="l10845"></a>10845                <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ad59b2c2e074c261ca2bd7978343fb322">IAX_IE_CAUSECODE</a>, <a class="code" href="causes_8h.html#a66e303e9085c143381179b613490fa58">AST_CAUSE_FACILITY_NOT_SUBSCRIBED</a>);
<a name="l10846"></a>10846                <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10847"></a>10847                <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10848"></a>10848                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10849"></a>10849                   <span class="keywordflow">return</span> 1;
<a name="l10850"></a>10850                }
<a name="l10851"></a>10851             }
<a name="l10852"></a>10852             <span class="keywordflow">break</span>;
<a name="l10853"></a>10853          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa865644fc2ba5a8075bfd3f79faa1afe6">IAX_COMMAND_TXREJ</a>:
<a name="l10854"></a>10854             iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring = 0;
<a name="l10855"></a>10855             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Channel &apos;%s&apos; unable to transfer\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner ? iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10856"></a>10856             memset(&amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transfer, 0, <span class="keyword">sizeof</span>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transfer));
<a name="l10857"></a>10857             <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno) {
<a name="l10858"></a>10858                <span class="keywordflow">if</span> (iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;transferring) {
<a name="l10859"></a>10859                   iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;transferring = 0;
<a name="l10860"></a>10860                   <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa865644fc2ba5a8075bfd3f79faa1afe6">IAX_COMMAND_TXREJ</a>, 0, NULL, 0, -1);
<a name="l10861"></a>10861                }
<a name="l10862"></a>10862             }
<a name="l10863"></a>10863             <span class="keywordflow">break</span>;
<a name="l10864"></a>10864          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa4f91d0a7331e8c4fd90a40f8994e5398">IAX_COMMAND_TXREADY</a>:
<a name="l10865"></a>10865             <span class="keywordflow">if</span> ((iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a85c905ff44633c2ab9fad3251a612788">TRANSFER_BEGIN</a>) ||
<a name="l10866"></a>10866                 (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6aaba79bebe929b7016a3cad879cd6ddfa">TRANSFER_MBEGIN</a>)) {
<a name="l10867"></a>10867                <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6aaba79bebe929b7016a3cad879cd6ddfa">TRANSFER_MBEGIN</a>)
<a name="l10868"></a>10868                   iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a936f20a7113740dedb28cbb5db075bd3">TRANSFER_MREADY</a>;
<a name="l10869"></a>10869                <span class="keywordflow">else</span>
<a name="l10870"></a>10870                   iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a960c983f99e76d8c1d8ba1bce27a1dab">TRANSFER_READY</a>;
<a name="l10871"></a>10871                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Channel &apos;%s&apos; ready to transfer\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner ? iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10872"></a>10872                <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno) {
<a name="l10873"></a>10873                   <span class="keywordflow">if</span> ((iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a960c983f99e76d8c1d8ba1bce27a1dab">TRANSFER_READY</a>) ||
<a name="l10874"></a>10874                       (iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a936f20a7113740dedb28cbb5db075bd3">TRANSFER_MREADY</a>)) {
<a name="l10875"></a>10875                      <span class="comment">/* They&apos;re both ready, now release them. */</span>
<a name="l10876"></a>10876                      <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a936f20a7113740dedb28cbb5db075bd3">TRANSFER_MREADY</a>) {
<a name="l10877"></a>10877                         <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Attempting media bridge of %s and %s\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner ? iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>,
<a name="l10878"></a>10878                               iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;owner ? iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10879"></a>10879 
<a name="l10880"></a>10880                         iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a0370a7bf15bf0986fdf65ec0eb0441f3">TRANSFER_MEDIA</a>;
<a name="l10881"></a>10881                         iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a0370a7bf15bf0986fdf65ec0eb0441f3">TRANSFER_MEDIA</a>;
<a name="l10882"></a>10882 
<a name="l10883"></a>10883                         memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10884"></a>10884                         memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l10885"></a>10885                         <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;peercallno);
<a name="l10886"></a>10886                         <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied1, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercallno);
<a name="l10887"></a>10887                         <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa12c553d53876a263016d12a0d87ab22a">IAX_COMMAND_TXMEDIA</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10888"></a>10888                         <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa12c553d53876a263016d12a0d87ab22a">IAX_COMMAND_TXMEDIA</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10889"></a>10889                      } <span class="keywordflow">else</span> {
<a name="l10890"></a>10890                         <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Releasing %s and %s\n&quot;</span>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner ? iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>,
<a name="l10891"></a>10891                               iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;owner ? iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;owner-&gt;name : <span class="stringliteral">&quot;&lt;Unknown&gt;&quot;</span>);
<a name="l10892"></a>10892 
<a name="l10893"></a>10893                         iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6acbf3b44134a197e4b10c6493a809b2bc">TRANSFER_RELEASED</a>;
<a name="l10894"></a>10894                         iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6acbf3b44134a197e4b10c6493a809b2bc">TRANSFER_RELEASED</a>;
<a name="l10895"></a>10895                         <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>);
<a name="l10896"></a>10896                         <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba432a74c30907e9fd8c30d967dac60e01">IAX_ALREADYGONE</a>);
<a name="l10897"></a>10897 
<a name="l10898"></a>10898                         <span class="comment">/* Stop doing lag &amp; ping requests */</span>
<a name="l10899"></a>10899                         <a class="code" href="chan__iax2_8c.html#ad44551511b38dc48242ecb6ad57f4227">stop_stuff</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l10900"></a>10900                         <a class="code" href="chan__iax2_8c.html#ad44551511b38dc48242ecb6ad57f4227">stop_stuff</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno);
<a name="l10901"></a>10901 
<a name="l10902"></a>10902                         memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10903"></a>10903                         memset(&amp;ied1, 0, <span class="keyword">sizeof</span>(ied1));
<a name="l10904"></a>10904                         <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied0, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno]-&gt;peercallno);
<a name="l10905"></a>10905                         <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied1, <a class="code" href="iax2_8h.html#ac0828e81d9d2d2cc0524ea44a8c654e2">IAX_IE_CALLNO</a>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercallno);
<a name="l10906"></a>10906                         <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa0bc169da2923ae3cbda0e73e4881b95c">IAX_COMMAND_TXREL</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10907"></a>10907                         <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;bridgecallno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa0bc169da2923ae3cbda0e73e4881b95c">IAX_COMMAND_TXREL</a>, 0, ied1.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied1.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10908"></a>10908                      }
<a name="l10909"></a>10909 
<a name="l10910"></a>10910                   }
<a name="l10911"></a>10911                }
<a name="l10912"></a>10912             }
<a name="l10913"></a>10913             <span class="keywordflow">break</span>;
<a name="l10914"></a>10914          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae3c92188ac1dca64149abbf8c89326c7">IAX_COMMAND_TXREQ</a>:
<a name="l10915"></a>10915             <a class="code" href="chan__iax2_8c.html#a4e8e372ddf3f4493875c92c3a0d53697">try_transfer</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], &amp;ies);
<a name="l10916"></a>10916             <span class="keywordflow">break</span>;
<a name="l10917"></a>10917          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>:
<a name="l10918"></a>10918             <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring)
<a name="l10919"></a>10919                <a class="code" href="chan__iax2_8c.html#a1ff700fbef2b011689770294a3f1bec9">send_command_transfer</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>, 0, NULL, 0);
<a name="l10920"></a>10920             <span class="keywordflow">break</span>;
<a name="l10921"></a>10921          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa0bc169da2923ae3cbda0e73e4881b95c">IAX_COMMAND_TXREL</a>:
<a name="l10922"></a>10922             <span class="comment">/* Send ack immediately, rather than waiting until we&apos;ve changed addresses */</span>
<a name="l10923"></a>10923             <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l10924"></a>10924             <a class="code" href="chan__iax2_8c.html#a3c65d589a044ac487e309ee555f93759">complete_transfer</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, &amp;ies);
<a name="l10925"></a>10925             <a class="code" href="chan__iax2_8c.html#ad44551511b38dc48242ecb6ad57f4227">stop_stuff</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>); <span class="comment">/* for attended transfer to work with libiax */</span>
<a name="l10926"></a>10926             <span class="keywordflow">break</span>;   
<a name="l10927"></a>10927          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa12c553d53876a263016d12a0d87ab22a">IAX_COMMAND_TXMEDIA</a>:
<a name="l10928"></a>10928             <span class="keywordflow">if</span> (iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring == <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a960c983f99e76d8c1d8ba1bce27a1dab">TRANSFER_READY</a>) {
<a name="l10929"></a>10929                <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l10930"></a>10930                <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l10931"></a>10931                   <span class="comment">/* Cancel any outstanding frames and start anew */</span>
<a name="l10932"></a>10932                   <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> == cur-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) &amp;&amp; (cur-&gt;<a class="code" href="structiax__frame.html#ad9e41a9a2b63c1e9bad00df4c2bfc92e">transfer</a>))
<a name="l10933"></a>10933                      cur-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> = -1;
<a name="l10934"></a>10934                }
<a name="l10935"></a>10935                <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l10936"></a>10936                <span class="comment">/* Start sending our media to the transfer address, but otherwise leave the call as-is */</span>
<a name="l10937"></a>10937                iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;transferring = <a class="code" href="chan__iax2_8c.html#a88c671d805898079105c49bb0bcc8ab6a3fe2a477f9e84842066802bb8ad8a2b8">TRANSFER_MEDIAPASS</a>;
<a name="l10938"></a>10938             }
<a name="l10939"></a>10939             <span class="keywordflow">break</span>;
<a name="l10940"></a>10940          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effae414fa2006b58341d7f3679d131d3327">IAX_COMMAND_RTKEY</a>:
<a name="l10941"></a>10941             <span class="keywordflow">if</span> (!<a class="code" href="chan__iax2_8c.html#a3d9496bb3807918ec2fef65f1d25f6e5">IAX_CALLENCRYPTED</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>])) {
<a name="l10942"></a>10942                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, 
<a name="l10943"></a>10943                   <span class="stringliteral">&quot;we&apos;ve been told to rotate our encryption key, &quot;</span>
<a name="l10944"></a>10944                   <span class="stringliteral">&quot;but this isn&apos;t an encrypted call. bad things will happen.\n&quot;</span>
<a name="l10945"></a>10945                );
<a name="l10946"></a>10946                <span class="keywordflow">break</span>;
<a name="l10947"></a>10947             }
<a name="l10948"></a>10948 
<a name="l10949"></a>10949             <a class="code" href="chan__iax2_8c.html#a70f36235709ab44d3a046577cb5dc40e">IAX_DEBUGDIGEST</a>(<span class="stringliteral">&quot;Receiving&quot;</span>, ies.<a class="code" href="structiax__ies.html#a2929a7d62f294309a5126ccb738f6060">challenge</a>);
<a name="l10950"></a>10950 
<a name="l10951"></a>10951             <a class="code" href="aes_8h.html#a4b2e708ba2ce55ca2b9f866f7e805170">ast_aes_decrypt_key</a>((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) ies.<a class="code" href="structiax__ies.html#a2929a7d62f294309a5126ccb738f6060">challenge</a>, &amp;iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;dcx);
<a name="l10952"></a>10952             <span class="keywordflow">break</span>;
<a name="l10953"></a>10953          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2bf840cb539605d405a6bbd7d2c87b23">IAX_COMMAND_DPREP</a>:
<a name="l10954"></a>10954             <a class="code" href="chan__iax2_8c.html#a70f2c7bd7b8feb13adf2cb6f23e7a137">complete_dpreply</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], &amp;ies);
<a name="l10955"></a>10955             <span class="keywordflow">break</span>;
<a name="l10956"></a>10956          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa99c917cc159a60dec921b9ed9b9ad856">IAX_COMMAND_UNSUPPORT</a>:
<a name="l10957"></a>10957             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Peer did not understand our iax command &apos;%d&apos;\n&quot;</span>, ies.<a class="code" href="structiax__ies.html#a1b99a0cc0f25036bed643dac2c1abff5">iax_unknown</a>);
<a name="l10958"></a>10958             <span class="keywordflow">break</span>;
<a name="l10959"></a>10959          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa08fdcdfce4a4fa82cb861365beb5f9eb">IAX_COMMAND_FWDOWNL</a>:
<a name="l10960"></a>10960             <span class="comment">/* Firmware download */</span>
<a name="l10961"></a>10961             <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba481a383cdd29d94527853f60bf6516cd">IAX_ALLOWFWDOWNLOAD</a>)) {
<a name="l10962"></a>10962                <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa99c917cc159a60dec921b9ed9b9ad856">IAX_COMMAND_UNSUPPORT</a>, 0, NULL, 0, -1);
<a name="l10963"></a>10963                <span class="keywordflow">break</span>;
<a name="l10964"></a>10964             }
<a name="l10965"></a>10965             memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l10966"></a>10966             res = <a class="code" href="chan__iax2_8c.html#a61dd76007fab611f813255f6032039ca">iax_firmware_append</a>(&amp;ied0, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ies.<a class="code" href="structiax__ies.html#ad5fcf043f3db7ed14e6180f743d95b27">devicetype</a>, ies.<a class="code" href="structiax__ies.html#a5332d70b47d044215dd8376a27d38080">fwdesc</a>);
<a name="l10967"></a>10967             <span class="keywordflow">if</span> (res &lt; 0)
<a name="l10968"></a>10968                <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa325e3e45e9f3b7c45800e4fbce7dae09">IAX_COMMAND_REJECT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10969"></a>10969             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0)
<a name="l10970"></a>10970                <a class="code" href="chan__iax2_8c.html#a69b39652261f3c421964ed308b5fa91b">send_command_final</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa32a7a195c53bf249c707e6473096bf9e">IAX_COMMAND_FWDATA</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10971"></a>10971             <span class="keywordflow">else</span>
<a name="l10972"></a>10972                <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa32a7a195c53bf249c707e6473096bf9e">IAX_COMMAND_FWDATA</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l10973"></a>10973             <span class="keywordflow">if</span> (!iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l10974"></a>10974                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l10975"></a>10975                <span class="keywordflow">return</span> 1;
<a name="l10976"></a>10976             }
<a name="l10977"></a>10977             <span class="keywordflow">break</span>;
<a name="l10978"></a>10978          <span class="keywordflow">case</span> <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa92c28bf63f730ca1f2836b5a1a26ac38">IAX_COMMAND_CALLTOKEN</a>:
<a name="l10979"></a>10979          {
<a name="l10980"></a>10980             <span class="keyword">struct </span>iax_frame *cur;
<a name="l10981"></a>10981             <span class="keywordtype">int</span> found = 0;
<a name="l10982"></a>10982             <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l10983"></a>10983             <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;frame_queue, cur, list) {
<a name="l10984"></a>10984                <span class="comment">/* find the last sent frame in our frame queue for this callno.</span>
<a name="l10985"></a>10985 <span class="comment">                * There are many things to take into account before resending this frame.</span>
<a name="l10986"></a>10986 <span class="comment">                * All of these are taken care of in resend_with_token() */</span>
<a name="l10987"></a>10987                <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a> == fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>) {
<a name="l10988"></a>10988                   found = 1;
<a name="l10989"></a>10989                   <span class="keywordflow">break</span>;
<a name="l10990"></a>10990                }
<a name="l10991"></a>10991             }
<a name="l10992"></a>10992             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l10993"></a>10993 
<a name="l10994"></a>10994             <span class="comment">/* find last sent frame */</span>
<a name="l10995"></a>10995             <span class="keywordflow">if</span> (cur &amp;&amp; found &amp;&amp; ies.<a class="code" href="structiax__ies.html#a15e68c5804dbbb3cb4bc693a965426ee">calltoken</a> &amp;&amp; ies.<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>) {
<a name="l10996"></a>10996                <a class="code" href="chan__iax2_8c.html#a29ca701dbb52c7e0ff3e2caa3025bc1f">resend_with_token</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, cur, (<span class="keywordtype">char</span> *) ies.<a class="code" href="structiax__ies.html#a119ad7b93a7881e4bf3a15272e509b8e">calltokendata</a>);
<a name="l10997"></a>10997             }
<a name="l10998"></a>10998             <span class="keywordflow">break</span>;
<a name="l10999"></a>10999          }
<a name="l11000"></a>11000          <span class="keywordflow">default</span>:
<a name="l11001"></a>11001             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unknown IAX command %d on %d/%d\n&quot;</span>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;peercallno);
<a name="l11002"></a>11002             memset(&amp;ied0, 0, <span class="keyword">sizeof</span>(ied0));
<a name="l11003"></a>11003             <a class="code" href="iax2-parser_8c.html#a4543258d0eaca83fe806bfae857f65d8">iax_ie_append_byte</a>(&amp;ied0, <a class="code" href="iax2_8h.html#a4066d5e4a23fa85bcda90cf516a26ae5">IAX_IE_IAX_UNKNOWN</a>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l11004"></a>11004             <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(iaxs[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa99c917cc159a60dec921b9ed9b9ad856">IAX_COMMAND_UNSUPPORT</a>, 0, ied0.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied0.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l11005"></a>11005          }
<a name="l11006"></a>11006          <span class="comment">/* Free remote variables (if any) */</span>
<a name="l11007"></a>11007          <span class="keywordflow">if</span> (ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l11008"></a>11008             <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>);
<a name="l11009"></a>11009             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;I can haz IAX vars, but they is no good :-(\n&quot;</span>);
<a name="l11010"></a>11010             ies.<a class="code" href="structiax__ies.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l11011"></a>11011          }
<a name="l11012"></a>11012 
<a name="l11013"></a>11013          <span class="comment">/* Don&apos;t actually pass these frames along */</span>
<a name="l11014"></a>11014          <span class="keywordflow">if</span> ((f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>) &amp;&amp; 
<a name="l11015"></a>11015            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa7ca0f1c9bff1cc0247c00886923689ae">IAX_COMMAND_TXCNT</a>) &amp;&amp; 
<a name="l11016"></a>11016            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa55974a2898c20aa393530d70cc8c6bc5">IAX_COMMAND_TXACC</a>) &amp;&amp; 
<a name="l11017"></a>11017            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa2f3a575dc003c6d3456b534e47640b67">IAX_COMMAND_INVAL</a>) &amp;&amp;
<a name="l11018"></a>11018            (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effabc19cf9ba5ac0470de593a7132027fca">IAX_COMMAND_VNAK</a>)) { 
<a name="l11019"></a>11019             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a994263e05f34cf3e146bd54903b7a053">aseqno</a> != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>)
<a name="l11020"></a>11020                <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l11021"></a>11021          }
<a name="l11022"></a>11022          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11023"></a>11023          <span class="keywordflow">return</span> 1;
<a name="l11024"></a>11024       }
<a name="l11025"></a>11025       <span class="comment">/* Unless this is an ACK or INVAL frame, ack it */</span>
<a name="l11026"></a>11026       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a994263e05f34cf3e146bd54903b7a053">aseqno</a> != <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a69fdde8d8d12a358d2a608b2c821454b">iseqno</a>)
<a name="l11027"></a>11027          <a class="code" href="chan__iax2_8c.html#a2bf4b407189ee04d2d9a5630422f45df">send_command_immediate</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa3d4ce8b7180dff4ce0087b6dd262fedc">IAX_COMMAND_ACK</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, NULL, 0,fr-&gt;<a class="code" href="structiax__frame.html#ab007339c003f06af5b3785966da64976">iseqno</a>);
<a name="l11028"></a>11028    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (minivid) {
<a name="l11029"></a>11029       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>;
<a name="l11030"></a>11030       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a3592e144b79a8ac41ec04e9d7fd4423d">videoformat</a> &gt; 0) 
<a name="l11031"></a>11031          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a3592e144b79a8ac41ec04e9d7fd4423d">videoformat</a> | (ntohs(vh-&gt;ts) &amp; 0x8000 ? 1 : 0);
<a name="l11032"></a>11032       <span class="keywordflow">else</span> {
<a name="l11033"></a>11033          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Received mini frame before first full video frame\n&quot;</span>);
<a name="l11034"></a>11034          <a class="code" href="chan__iax2_8c.html#ac36e579cc52653790930d8bb00e05493">iax2_vnak</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l11035"></a>11035          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11036"></a>11036          <span class="keywordflow">return</span> 1;
<a name="l11037"></a>11037       }
<a name="l11038"></a>11038       f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res - <span class="keyword">sizeof</span>(*vh);
<a name="l11039"></a>11039       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l11040"></a>11040          f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = thread-&gt;buf + <span class="keyword">sizeof</span>(*vh);
<a name="l11041"></a>11041       <span class="keywordflow">else</span>
<a name="l11042"></a>11042          f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = NULL;
<a name="l11043"></a>11043 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l11044"></a>11044 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (test_resync) {
<a name="l11045"></a>11045          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &amp; 0xFFFF8000L) | ((ntohs(vh-&gt;ts) + test_resync) &amp; 0x7fff);
<a name="l11046"></a>11046       } <span class="keywordflow">else</span>
<a name="l11047"></a>11047 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l11048"></a>11048          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &amp; 0xFFFF8000L) | (ntohs(vh-&gt;ts) &amp; 0x7fff);
<a name="l11049"></a>11049    } <span class="keywordflow">else</span> {
<a name="l11050"></a>11050       <span class="comment">/* A mini frame */</span>
<a name="l11051"></a>11051       f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l11052"></a>11052       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a> &gt; 0)
<a name="l11053"></a>11053          f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a39f73bd6a209030769fcf5f8fd15edeb">voiceformat</a>;
<a name="l11054"></a>11054       <span class="keywordflow">else</span> {
<a name="l11055"></a>11055          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received mini frame before first full voice frame\n&quot;</span>);
<a name="l11056"></a>11056          <a class="code" href="chan__iax2_8c.html#ac36e579cc52653790930d8bb00e05493">iax2_vnak</a>(fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l11057"></a>11057          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11058"></a>11058          <span class="keywordflow">return</span> 1;
<a name="l11059"></a>11059       }
<a name="l11060"></a>11060       f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res - <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__iax2__mini__hdr.html">ast_iax2_mini_hdr</a>);
<a name="l11061"></a>11061       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &lt; 0) {
<a name="l11062"></a>11062          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Datalen &lt; 0?\n&quot;</span>);
<a name="l11063"></a>11063          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11064"></a>11064          <span class="keywordflow">return</span> 1;
<a name="l11065"></a>11065       }
<a name="l11066"></a>11066       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l11067"></a>11067          f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = thread-&gt;buf + <span class="keyword">sizeof</span>(*mh);
<a name="l11068"></a>11068       <span class="keywordflow">else</span>
<a name="l11069"></a>11069          f.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = NULL;
<a name="l11070"></a>11070 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l11071"></a>11071 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (test_resync) {
<a name="l11072"></a>11072          fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &amp; 0xFFFF0000L) | ((ntohs(mh-&gt;ts) + test_resync) &amp; 0xffff);
<a name="l11073"></a>11073       } <span class="keywordflow">else</span>
<a name="l11074"></a>11074 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l11075"></a>11075       fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a> = (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &amp; 0xFFFF0000L) | ntohs(mh-&gt;ts);
<a name="l11076"></a>11076       <span class="comment">/* FIXME? Surely right here would be the right place to undo timestamp wraparound? */</span>
<a name="l11077"></a>11077    }
<a name="l11078"></a>11078    <span class="comment">/* Don&apos;t pass any packets until we&apos;re started */</span>
<a name="l11079"></a>11079    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bb096f468eaca9cd4d0bbd3a3252eb">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>)) {
<a name="l11080"></a>11080       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11081"></a>11081       <span class="keywordflow">return</span> 1;
<a name="l11082"></a>11082    }
<a name="l11083"></a>11083    <span class="comment">/* Common things */</span>
<a name="l11084"></a>11084    f.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;IAX2&quot;</span>;
<a name="l11085"></a>11085    f.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l11086"></a>11086    f.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0;
<a name="l11087"></a>11087    f.<a class="code" href="structast__frame.html#aaccba9d5adc3f6c39aad767db95ba484">len</a> = 0;
<a name="l11088"></a>11088    <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &amp;&amp; (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)) {
<a name="l11089"></a>11089       f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="frame_8h.html#aedec72ae8357bb6c334111f93d283713" title="Returns the number of samples contained in the frame.">ast_codec_get_samples</a>(&amp;f);
<a name="l11090"></a>11090       <span class="comment">/* We need to byteswap incoming slinear samples from network byte order */</span>
<a name="l11091"></a>11091       <span class="keywordflow">if</span> (f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)
<a name="l11092"></a>11092          <a class="code" href="frame_8h.html#a0eb09df2bca453c21ced51b12b52a88b">ast_frame_byteswap_be</a>(&amp;f);
<a name="l11093"></a>11093    } <span class="keywordflow">else</span>
<a name="l11094"></a>11094       f.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l11095"></a>11095    <a class="code" href="iax2-parser_8c.html#ac7172830d863702f96f81d8a09612428">iax_frame_wrap</a>(fr, &amp;f);
<a name="l11096"></a>11096 
<a name="l11097"></a>11097    <span class="comment">/* If this is our most recent packet, use it as our basis for timestamping */</span>
<a name="l11098"></a>11098    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &lt; fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>) {
<a name="l11099"></a>11099       <span class="comment">/*iaxs[fr-&gt;callno]-&gt;last = fr-&gt;ts; (do it afterwards cos schedule/forward_delivery needs the last ts too)*/</span>
<a name="l11100"></a>11100       fr-&gt;<a class="code" href="structiax__frame.html#a6e7821d1104da8531b94a618524f8d9b">outoforder</a> = 0;
<a name="l11101"></a>11101    } <span class="keywordflow">else</span> {
<a name="l11102"></a>11102       <span class="keywordflow">if</span> (iaxdebug &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>])
<a name="l11103"></a>11103          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received out of order packet... (type=%d, subclass %d, ts = %d, last = %d)\n&quot;</span>, f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>, f.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a>);
<a name="l11104"></a>11104       fr-&gt;<a class="code" href="structiax__frame.html#a6e7821d1104da8531b94a618524f8d9b">outoforder</a> = -1;
<a name="l11105"></a>11105    }
<a name="l11106"></a>11106    fr-&gt;<a class="code" href="structiax__frame.html#af80030526d3bbc6bf90c9ab6cdcdba59">cacheable</a> = ((f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) || (f.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>));
<a name="l11107"></a>11107    duped_fr = <a class="code" href="chan__iax2_8c.html#aa8a32e0915c1d863697804c3702f439b">iaxfrdup2</a>(fr);
<a name="l11108"></a>11108    <span class="keywordflow">if</span> (duped_fr) {
<a name="l11109"></a>11109       <a class="code" href="chan__iax2_8c.html#a3ec86bd0172f439ef6e7a00cb5f1b699">schedule_delivery</a>(duped_fr, updatehistory, 0, &amp;fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l11110"></a>11110    }
<a name="l11111"></a>11111    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>] &amp;&amp; <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> &lt; fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>) {
<a name="l11112"></a>11112       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ab0b853bc4e4e9658036bf7e604f398ad">last</a> = fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>;
<a name="l11113"></a>11113 <span class="preprocessor">#if 1</span>
<a name="l11114"></a>11114 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (iaxdebug)
<a name="l11115"></a>11115          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;For call=%d, set last=%d\n&quot;</span>, fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>, fr-&gt;<a class="code" href="structiax__frame.html#a5b83e949350cb6c2cdf2bcc8871d5d18">ts</a>);
<a name="l11116"></a>11116 <span class="preprocessor">#endif</span>
<a name="l11117"></a>11117 <span class="preprocessor"></span>   }
<a name="l11118"></a>11118 
<a name="l11119"></a>11119    <span class="comment">/* Always run again */</span>
<a name="l11120"></a>11120    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[fr-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11121"></a>11121    <span class="keywordflow">return</span> 1;
<a name="l11122"></a>11122 }
<a name="l11123"></a>11123 
<a name="l11124"></a>11124 <span class="comment">/* Function to clean up process thread if it is cancelled */</span>
<a name="l11125"></a><a class="code" href="chan__iax2_8c.html#ac570d19d1a97b676b37f71ef2f8027ac">11125</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ac570d19d1a97b676b37f71ef2f8027ac">iax2_process_thread_cleanup</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__iax2__mini__hdr.html#aef5b927d15f11382bf5f276630c08287">data</a>)
<a name="l11126"></a>11126 {
<a name="l11127"></a>11127    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = data;
<a name="l11128"></a>11128    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;thread-&gt;lock);
<a name="l11129"></a>11129    <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;thread-&gt;cond);
<a name="l11130"></a>11130    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;thread-&gt;init_lock);
<a name="l11131"></a>11131    <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;thread-&gt;init_cond);
<a name="l11132"></a>11132    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(thread);
<a name="l11133"></a>11133    <a class="code" href="lock_8h.html#ac0907a45f05d85848a4f7d5990a4d244" title="decrement *p by 1 and return true if the variable has reached 0. Useful e.g. to check...">ast_atomic_dec_and_test</a>(&amp;<a class="code" href="chan__iax2_8c.html#a7b6613353aee0a0b41a8f18ffcc7268f">iaxactivethreadcount</a>);
<a name="l11134"></a>11134 }
<a name="l11135"></a>11135 
<a name="l11136"></a><a class="code" href="chan__iax2_8c.html#a4b01adf25449fb80786fe1af045c3d0c">11136</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#a4b01adf25449fb80786fe1af045c3d0c">iax2_process_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l11137"></a>11137 {
<a name="l11138"></a>11138    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = data;
<a name="l11139"></a>11139    <span class="keyword">struct </span>timeval wait;
<a name="l11140"></a>11140    <span class="keyword">struct </span>timespec ts;
<a name="l11141"></a>11141    <span class="keywordtype">int</span> put_into_idle = 0;
<a name="l11142"></a>11142    <span class="keywordtype">int</span> first_time = 1;
<a name="l11143"></a>11143 
<a name="l11144"></a>11144    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;<a class="code" href="chan__iax2_8c.html#a7b6613353aee0a0b41a8f18ffcc7268f">iaxactivethreadcount</a>,1);
<a name="l11145"></a>11145    pthread_cleanup_push(<a class="code" href="chan__iax2_8c.html#ac570d19d1a97b676b37f71ef2f8027ac">iax2_process_thread_cleanup</a>, data);
<a name="l11146"></a>11146    <span class="keywordflow">for</span>(;;) {
<a name="l11147"></a>11147       <span class="comment">/* Wait for something to signal us to be awake */</span>
<a name="l11148"></a>11148       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;thread-&gt;lock);
<a name="l11149"></a>11149 
<a name="l11150"></a>11150       <span class="comment">/* Flag that we&apos;re ready to accept signals */</span>
<a name="l11151"></a>11151       <span class="keywordflow">if</span> (first_time) {
<a name="l11152"></a>11152          <a class="code" href="chan__iax2_8c.html#ab142019e7c67d33044fdee70fe198e4d">signal_condition</a>(&amp;thread-&gt;init_lock, &amp;thread-&gt;init_cond);
<a name="l11153"></a>11153          first_time = 0;
<a name="l11154"></a>11154       }
<a name="l11155"></a>11155 
<a name="l11156"></a>11156       <span class="comment">/* Put into idle list if applicable */</span>
<a name="l11157"></a>11157       <span class="keywordflow">if</span> (put_into_idle)
<a name="l11158"></a>11158          <a class="code" href="chan__iax2_8c.html#a7c0f4a5b443de37be3a1e777af718541">insert_idle_thread</a>(thread);
<a name="l11159"></a>11159 
<a name="l11160"></a>11160       <span class="keywordflow">if</span> (thread-&gt;type == <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7a0acfd1204de5016e9d076890e96a7d95">IAX_THREAD_TYPE_DYNAMIC</a>) {
<a name="l11161"></a>11161          <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *t = NULL;
<a name="l11162"></a>11162          <span class="comment">/* Wait to be signalled or time out */</span>
<a name="l11163"></a>11163          wait = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(30000, 1000));
<a name="l11164"></a>11164          ts.tv_sec = wait.tv_sec;
<a name="l11165"></a>11165          ts.tv_nsec = wait.tv_usec * 1000;
<a name="l11166"></a>11166          <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(&amp;thread-&gt;cond, &amp;thread-&gt;lock, &amp;ts) == ETIMEDOUT) {
<a name="l11167"></a>11167             <span class="comment">/* This thread was never put back into the available dynamic</span>
<a name="l11168"></a>11168 <span class="comment">             * thread list, so just go away. */</span>
<a name="l11169"></a>11169             <span class="keywordflow">if</span> (!put_into_idle) {
<a name="l11170"></a>11170                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;lock);
<a name="l11171"></a>11171                <span class="keywordflow">break</span>;
<a name="l11172"></a>11172             }
<a name="l11173"></a>11173             <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l11174"></a>11174             <span class="comment">/* Account for the case where this thread is acquired *right* after a timeout */</span>
<a name="l11175"></a>11175             <span class="keywordflow">if</span> ((t = <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;dynamic_list, thread, list)))
<a name="l11176"></a>11176                <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;<a class="code" href="chan__iax2_8c.html#a11480fc9a0f5a2c9cadb7a15a6c9c0e6">iaxdynamicthreadcount</a>, -1);
<a name="l11177"></a>11177             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l11178"></a>11178             <span class="keywordflow">if</span> (t) {
<a name="l11179"></a>11179                <span class="comment">/* This dynamic thread timed out waiting for a task and was</span>
<a name="l11180"></a>11180 <span class="comment">                * not acquired immediately after the timeout, </span>
<a name="l11181"></a>11181 <span class="comment">                * so it&apos;s time to go away. */</span>
<a name="l11182"></a>11182                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;lock);
<a name="l11183"></a>11183                <span class="keywordflow">break</span>;
<a name="l11184"></a>11184             }
<a name="l11185"></a>11185             <span class="comment">/* Someone grabbed our thread *right* after we timed out.</span>
<a name="l11186"></a>11186 <span class="comment">             * Wait for them to set us up with something to do and signal</span>
<a name="l11187"></a>11187 <span class="comment">             * us to continue. */</span>
<a name="l11188"></a>11188             wait = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(30000, 1000));
<a name="l11189"></a>11189             ts.tv_sec = wait.tv_sec;
<a name="l11190"></a>11190             ts.tv_nsec = wait.tv_usec * 1000;
<a name="l11191"></a>11191             <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(&amp;thread-&gt;cond, &amp;thread-&gt;lock, &amp;ts) == ETIMEDOUT)
<a name="l11192"></a>11192             {
<a name="l11193"></a>11193                <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;lock);
<a name="l11194"></a>11194                <span class="keywordflow">break</span>;
<a name="l11195"></a>11195             }
<a name="l11196"></a>11196          }
<a name="l11197"></a>11197       } <span class="keywordflow">else</span> {
<a name="l11198"></a>11198          <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;thread-&gt;cond, &amp;thread-&gt;lock);
<a name="l11199"></a>11199       }
<a name="l11200"></a>11200 
<a name="l11201"></a>11201       <span class="comment">/* Go back into our respective list */</span>
<a name="l11202"></a>11202       put_into_idle = 1;
<a name="l11203"></a>11203 
<a name="l11204"></a>11204       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;thread-&gt;lock);
<a name="l11205"></a>11205 
<a name="l11206"></a>11206       <span class="keywordflow">if</span> (thread-&gt;iostate == <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">IAX_IOSTATE_IDLE</a>)
<a name="l11207"></a>11207          <span class="keywordflow">continue</span>;
<a name="l11208"></a>11208 
<a name="l11209"></a>11209       <span class="comment">/* Add ourselves to the active list now */</span>
<a name="l11210"></a>11210       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;active_list);
<a name="l11211"></a>11211       <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;active_list, thread, list);
<a name="l11212"></a>11212       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;active_list);
<a name="l11213"></a>11213 
<a name="l11214"></a>11214       <span class="comment">/* See what we need to do */</span>
<a name="l11215"></a>11215       <span class="keywordflow">switch</span>(thread-&gt;iostate) {
<a name="l11216"></a>11216       <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3ac99d54ed94b3fffa9269fc588e37122d">IAX_IOSTATE_READY</a>:
<a name="l11217"></a>11217          thread-&gt;actions++;
<a name="l11218"></a>11218          thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a20ef1b3afb82bc33e11a43687b95c0cc">IAX_IOSTATE_PROCESSING</a>;
<a name="l11219"></a>11219          <a class="code" href="chan__iax2_8c.html#a8f25a14008c8bf17bd1dc8da5617d176">socket_process</a>(thread);
<a name="l11220"></a>11220          <a class="code" href="chan__iax2_8c.html#aa94f7fc0f211001b9f4792a2d8c7fdee" title="Handle any deferred full frames for this thread.">handle_deferred_full_frames</a>(thread);
<a name="l11221"></a>11221          <span class="keywordflow">break</span>;
<a name="l11222"></a>11222       <span class="keywordflow">case</span> <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a758a8b5bbba4debe9f4c40ace2526563">IAX_IOSTATE_SCHEDREADY</a>:
<a name="l11223"></a>11223          thread-&gt;actions++;
<a name="l11224"></a>11224          thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3a20ef1b3afb82bc33e11a43687b95c0cc">IAX_IOSTATE_PROCESSING</a>;
<a name="l11225"></a>11225 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l11226"></a>11226 <span class="preprocessor"></span>         thread-&gt;schedfunc(thread-&gt;scheddata);
<a name="l11227"></a>11227 <span class="preprocessor">#endif      </span>
<a name="l11228"></a>11228 <span class="preprocessor"></span>      <span class="keywordflow">default</span>:
<a name="l11229"></a>11229          <span class="keywordflow">break</span>;
<a name="l11230"></a>11230       }
<a name="l11231"></a>11231       time(&amp;thread-&gt;checktime);
<a name="l11232"></a>11232       thread-&gt;iostate = <a class="code" href="chan__iax2_8c.html#a0493fc9a3fb381a527b513e4328222b3aa76b5372d3728f923eb62ed084c5b073">IAX_IOSTATE_IDLE</a>;
<a name="l11233"></a>11233 <span class="preprocessor">#ifdef DEBUG_SCHED_MULTITHREAD</span>
<a name="l11234"></a>11234 <span class="preprocessor"></span>      thread-&gt;curfunc[0]=<span class="charliteral">&apos;\0&apos;</span>;
<a name="l11235"></a>11235 <span class="preprocessor">#endif      </span>
<a name="l11236"></a>11236 <span class="preprocessor"></span>
<a name="l11237"></a>11237       <span class="comment">/* Now... remove ourselves from the active list, and return to the idle list */</span>
<a name="l11238"></a>11238       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;active_list);
<a name="l11239"></a>11239       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;active_list, thread, list);
<a name="l11240"></a>11240       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;active_list);
<a name="l11241"></a>11241 
<a name="l11242"></a>11242       <span class="comment">/* Make sure another frame didn&apos;t sneak in there after we thought we were done. */</span>
<a name="l11243"></a>11243       <a class="code" href="chan__iax2_8c.html#aa94f7fc0f211001b9f4792a2d8c7fdee" title="Handle any deferred full frames for this thread.">handle_deferred_full_frames</a>(thread);
<a name="l11244"></a>11244    }
<a name="l11245"></a>11245 <span class="comment"></span>
<a name="l11246"></a>11246 <span class="comment">   /*!\note For some reason, idle threads are exiting without being removed</span>
<a name="l11247"></a>11247 <span class="comment">    * from an idle list, which is causing memory corruption.  Forcibly remove</span>
<a name="l11248"></a>11248 <span class="comment">    * it from the list, if it&apos;s there.</span>
<a name="l11249"></a>11249 <span class="comment">    */</span>
<a name="l11250"></a>11250    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;idle_list);
<a name="l11251"></a>11251    <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;idle_list, thread, list);
<a name="l11252"></a>11252    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;idle_list);
<a name="l11253"></a>11253 
<a name="l11254"></a>11254    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l11255"></a>11255    <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;dynamic_list, thread, list);
<a name="l11256"></a>11256    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l11257"></a>11257 
<a name="l11258"></a>11258    <span class="comment">/* I am exiting here on my own volition, I need to clean up my own data structures</span>
<a name="l11259"></a>11259 <span class="comment">   * Assume that I am no longer in any of the lists (idle, active, or dynamic)</span>
<a name="l11260"></a>11260 <span class="comment">   */</span>
<a name="l11261"></a>11261    pthread_cleanup_pop(1);
<a name="l11262"></a>11262    <span class="keywordflow">return</span> NULL;
<a name="l11263"></a>11263 }
<a name="l11264"></a>11264 
<a name="l11265"></a><a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">11265</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">iax2_do_register</a>(<span class="keyword">struct</span> iax2_registry *reg)
<a name="l11266"></a>11266 {
<a name="l11267"></a>11267    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l11268"></a>11268    <span class="keywordflow">if</span> (iaxdebug)
<a name="l11269"></a>11269       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sending registration request for &apos;%s&apos;\n&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l11270"></a>11270 
<a name="l11271"></a>11271    <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a> &amp;&amp; 
<a name="l11272"></a>11272        ((reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a> == <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a0ceb5a0d8116282669c98effcffe96e3">REG_STATE_TIMEOUT</a>) || !reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr)) {
<a name="l11273"></a>11273       <span class="comment">/* Maybe the IP has changed, force DNS refresh */</span>
<a name="l11274"></a>11274       <a class="code" href="dnsmgr_8h.html#add74c87320b8447b69e776931520e994" title="Force a refresh of a dnsmgr entry.">ast_dnsmgr_refresh</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>);
<a name="l11275"></a>11275    }
<a name="l11276"></a>11276    
<a name="l11277"></a>11277    <span class="comment">/*</span>
<a name="l11278"></a>11278 <span class="comment">    * if IP has Changed, free allocated call to create a new one with new IP</span>
<a name="l11279"></a>11279 <span class="comment">    * call has the pointer to IP and must be updated to the new one</span>
<a name="l11280"></a>11280 <span class="comment">    */</span>
<a name="l11281"></a>11281    <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a> &amp;&amp; <a class="code" href="dnsmgr_8h.html#ad43ae5f58db3498b5b1830bd98677117" title="Check is see if a dnsmgr entry has changed.">ast_dnsmgr_changed</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>) &amp;&amp; (reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a> &gt; 0)) {
<a name="l11282"></a>11282       <span class="keywordtype">int</span> callno = reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>;
<a name="l11283"></a>11283       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11284"></a>11284       <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l11285"></a>11285       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11286"></a>11286       reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a> = 0;
<a name="l11287"></a>11287    }
<a name="l11288"></a>11288    <span class="keywordflow">if</span> (!reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr) {
<a name="l11289"></a>11289       <span class="keywordflow">if</span> (iaxdebug)
<a name="l11290"></a>11290          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unable to send registration request for &apos;%s&apos; without IP address\n&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l11291"></a>11291       <span class="comment">/* Setup the next registration attempt */</span>
<a name="l11292"></a>11292       reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a>, sched, 
<a name="l11293"></a>11293          (5 * reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> / 6) * 1000, <a class="code" href="chan__iax2_8c.html#af7b172cae2a4b98c38859794fae4f94b">iax2_do_register_s</a>, reg);
<a name="l11294"></a>11294       <span class="keywordflow">return</span> -1;
<a name="l11295"></a>11295    }
<a name="l11296"></a>11296 
<a name="l11297"></a>11297    <span class="keywordflow">if</span> (!reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>) {
<a name="l11298"></a>11298       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Allocate call number\n&quot;</span>);
<a name="l11299"></a>11299       reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a> = <a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">find_callno_locked</a>(0, 0, &amp;reg-&gt;<a class="code" href="structiax2__registry.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">NEW_FORCE</a>, defaultsockfd, 0);
<a name="l11300"></a>11300       <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a> &lt; 1) {
<a name="l11301"></a>11301          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create call for registration\n&quot;</span>);
<a name="l11302"></a>11302          <span class="keywordflow">return</span> -1;
<a name="l11303"></a>11303       } <span class="keywordflow">else</span>
<a name="l11304"></a>11304          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Registration created on call %d\n&quot;</span>, reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>);
<a name="l11305"></a>11305       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a> = reg;
<a name="l11306"></a>11306       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>]);
<a name="l11307"></a>11307    }
<a name="l11308"></a>11308    <span class="comment">/* Setup the next registration a little early */</span>
<a name="l11309"></a>11309    reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a>, sched, 
<a name="l11310"></a>11310       (5 * reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a> / 6) * 1000, <a class="code" href="chan__iax2_8c.html#af7b172cae2a4b98c38859794fae4f94b">iax2_do_register_s</a>, reg);
<a name="l11311"></a>11311    <span class="comment">/* Send the request */</span>
<a name="l11312"></a>11312    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l11313"></a>11313    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, reg-&gt;<a class="code" href="structiax2__registry.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l11314"></a>11314    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#ac3c0ea95efa7bab2684e56443fc94d0a">IAX_IE_REFRESH</a>, reg-&gt;<a class="code" href="structiax2__registry.html#a1b89d9ee01e33efd8e2634eb2ee2e6d7">refresh</a>);
<a name="l11315"></a>11315    <a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">add_empty_calltoken_ie</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>], &amp;ied); <span class="comment">/* this _MUST_ be the last ie added */</span>
<a name="l11316"></a>11316    <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>],<a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effab17acacea946abf3ccde08f4f49fbfdb">IAX_COMMAND_REGREQ</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l11317"></a>11317    reg-&gt;<a class="code" href="structiax2__registry.html#a1f701e5ca93675587a6ca7c8ef597cc1">regstate</a> = <a class="code" href="chan__iax2_8c.html#a9f4410c26af4cf9def54796fd6b3f329a024ddf2de7a878eb4da843c844dfd2e3">REG_STATE_REGSENT</a>;
<a name="l11318"></a>11318    <span class="keywordflow">return</span> 0;
<a name="l11319"></a>11319 }
<a name="l11320"></a>11320 
<a name="l11321"></a><a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">11321</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">iax2_provision</a>(<span class="keyword">struct</span> sockaddr_in *end, <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, <span class="keywordtype">char</span> *dest, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keyword">template</span>, <span class="keywordtype">int</span> force)
<a name="l11322"></a>11322 {
<a name="l11323"></a>11323    <span class="comment">/* Returns 1 if provisioned, -1 if not able to find destination, or 0 if no provisioning</span>
<a name="l11324"></a>11324 <span class="comment">      is found for template */</span>
<a name="l11325"></a>11325    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> provdata;
<a name="l11326"></a>11326    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l11327"></a>11327    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sig;
<a name="l11328"></a>11328    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l11329"></a>11329    <span class="keywordtype">int</span> callno;
<a name="l11330"></a>11330    <span class="keyword">struct </span><a class="code" href="structcreate__addr__info.html">create_addr_info</a> cai;
<a name="l11331"></a>11331 
<a name="l11332"></a>11332    memset(&amp;cai, 0, <span class="keyword">sizeof</span>(cai));
<a name="l11333"></a>11333 
<a name="l11334"></a>11334    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Provisioning &apos;%s&apos; from template &apos;%s&apos;\n&quot;</span>, dest, <span class="keyword">template</span>);
<a name="l11335"></a>11335 
<a name="l11336"></a>11336    <span class="keywordflow">if</span> (<a class="code" href="iax2-provision_8c.html#a7287d78c6f1063fabd563fa0a325bc14">iax_provision_build</a>(&amp;provdata, &amp;sig, <span class="keyword">template</span>, force)) {
<a name="l11337"></a>11337       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No provisioning found for template &apos;%s&apos;\n&quot;</span>, <span class="keyword">template</span>);
<a name="l11338"></a>11338       <span class="keywordflow">return</span> 0;
<a name="l11339"></a>11339    }
<a name="l11340"></a>11340 
<a name="l11341"></a>11341    <span class="keywordflow">if</span> (end) {
<a name="l11342"></a>11342       memcpy(&amp;sin, end, <span class="keyword">sizeof</span>(sin));
<a name="l11343"></a>11343       cai.<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = sockfd;
<a name="l11344"></a>11344    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a718ce50d45da77b324047f3d9ceb6749">create_addr</a>(dest, NULL, &amp;sin, &amp;cai))
<a name="l11345"></a>11345       <span class="keywordflow">return</span> -1;
<a name="l11346"></a>11346 
<a name="l11347"></a>11347    <span class="comment">/* Build the rest of the message */</span>
<a name="l11348"></a>11348    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l11349"></a>11349    <a class="code" href="iax2-parser_8c.html#aa54841eb569031c28321281dcd31e4f3">iax_ie_append_raw</a>(&amp;ied, <a class="code" href="iax2_8h.html#aad38873d8d1c4f029fd68d3889527816">IAX_IE_PROVISIONING</a>, provdata.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, provdata.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>);
<a name="l11350"></a>11350 
<a name="l11351"></a>11351    callno = <a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">find_callno_locked</a>(0, 0, &amp;sin, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">NEW_FORCE</a>, cai.<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, 0);
<a name="l11352"></a>11352    <span class="keywordflow">if</span> (!callno)
<a name="l11353"></a>11353       <span class="keywordflow">return</span> -1;
<a name="l11354"></a>11354 
<a name="l11355"></a>11355    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l11356"></a>11356       <span class="comment">/* Schedule autodestruct in case they don&apos;t ever give us anything back */</span>
<a name="l11357"></a>11357       <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a59bae7aaf2ef69cbcf5ffb6e0b9ba060">autoid</a> = <a class="code" href="chan__iax2_8c.html#aba1531db96615d1613709649519b5611">iax2_sched_replace</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;autoid, 
<a name="l11358"></a>11358          sched, 15000, <a class="code" href="chan__iax2_8c.html#af2f256e202e0549ed7b0df7592782365">auto_hangup</a>, (<span class="keywordtype">void</span> *)(<span class="keywordtype">long</span>)callno);
<a name="l11359"></a>11359       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaaeca8376f09c96f96ffd39107da8aefd">IAX_PROVISION</a>);
<a name="l11360"></a>11360       <span class="comment">/* Got a call number now, so go ahead and send the provisioning information */</span>
<a name="l11361"></a>11361       <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa25b3d114235e7e41d8043944e82e0666">IAX_COMMAND_PROVISION</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l11362"></a>11362    }
<a name="l11363"></a>11363    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11364"></a>11364 
<a name="l11365"></a>11365    <span class="keywordflow">return</span> 1;
<a name="l11366"></a>11366 }
<a name="l11367"></a>11367 
<a name="l11368"></a><a class="code" href="chan__iax2_8c.html#a8e3f0b704ce531247d450cabfb44b503">11368</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a8e3f0b704ce531247d450cabfb44b503">papp</a> = <span class="stringliteral">&quot;IAX2Provision&quot;</span>;
<a name="l11369"></a>11369 <span class="comment"></span>
<a name="l11370"></a>11370 <span class="comment">/*! iax2provision</span>
<a name="l11371"></a>11371 <span class="comment">\ingroup applications</span>
<a name="l11372"></a>11372 <span class="comment">*/</span>
<a name="l11373"></a><a class="code" href="group__applications.html#gad2402d98af3b54a22d8f5421b7e0d814">11373</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="group__applications.html#gad2402d98af3b54a22d8f5421b7e0d814">iax2_prov_app</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l11374"></a>11374 {
<a name="l11375"></a>11375    <span class="keywordtype">int</span> res;
<a name="l11376"></a>11376    <span class="keywordtype">char</span> *sdata;
<a name="l11377"></a>11377    <span class="keywordtype">char</span> *opts;
<a name="l11378"></a>11378    <span class="keywordtype">int</span> force =0;
<a name="l11379"></a>11379    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l11380"></a>11380    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data))
<a name="l11381"></a>11381       data = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l11382"></a>11382    sdata = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l11383"></a>11383    opts = strchr(sdata, <span class="charliteral">&apos;|&apos;</span>);
<a name="l11384"></a>11384    <span class="keywordflow">if</span> (opts)
<a name="l11385"></a>11385       *opts=<span class="charliteral">&apos;\0&apos;</span>;
<a name="l11386"></a>11386 
<a name="l11387"></a>11387    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> != &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>) {
<a name="l11388"></a>11388       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Can&apos;t provision a non-IAX device!\n&quot;</span>);
<a name="l11389"></a>11389       <span class="keywordflow">return</span> -1;
<a name="l11390"></a>11390    } 
<a name="l11391"></a>11391    <span class="keywordflow">if</span> (!callno || !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno] || !<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr) {
<a name="l11392"></a>11392       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Can&apos;t provision something with no IP?\n&quot;</span>);
<a name="l11393"></a>11393       <span class="keywordflow">return</span> -1;
<a name="l11394"></a>11394    }
<a name="l11395"></a>11395    res = <a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">iax2_provision</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, NULL, sdata, force);
<a name="l11396"></a>11396    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Provisioned IAXY at &apos;%s&apos; with &apos;%s&apos;= %d\n&quot;</span>,
<a name="l11397"></a>11397       <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr),
<a name="l11398"></a>11398       sdata, res);
<a name="l11399"></a>11399    <span class="keywordflow">return</span> res;
<a name="l11400"></a>11400 }
<a name="l11401"></a>11401 
<a name="l11402"></a><a class="code" href="chan__iax2_8c.html#a1cd767c02642a7d22ab73562d91dfbb3">11402</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a1cd767c02642a7d22ab73562d91dfbb3">handle_cli_iax2_provision</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l11403"></a>11403 {
<a name="l11404"></a>11404    <span class="keywordtype">int</span> force = 0;
<a name="l11405"></a>11405    <span class="keywordtype">int</span> res;
<a name="l11406"></a>11406 
<a name="l11407"></a>11407    <span class="keywordflow">switch</span> (cmd) {
<a name="l11408"></a>11408    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l11409"></a>11409       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 provision&quot;</span>;
<a name="l11410"></a>11410       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l11411"></a>11411          <span class="stringliteral">&quot;Usage: iax2 provision &lt;host&gt; &lt;template&gt; [forced]\n&quot;</span>
<a name="l11412"></a>11412          <span class="stringliteral">&quot;       Provisions the given peer or IP address using a template\n&quot;</span>
<a name="l11413"></a>11413          <span class="stringliteral">&quot;       matching either &apos;template&apos; or &apos;*&apos; if the template is not\n&quot;</span>
<a name="l11414"></a>11414          <span class="stringliteral">&quot;       found.  If &apos;forced&apos; is specified, even empty provisioning\n&quot;</span>
<a name="l11415"></a>11415          <span class="stringliteral">&quot;       fields will be provisioned as empty fields.\n&quot;</span>;
<a name="l11416"></a>11416       <span class="keywordflow">return</span> NULL;
<a name="l11417"></a>11417    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l11418"></a>11418       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a> == 3)
<a name="l11419"></a>11419          <span class="keywordflow">return</span> <a class="code" href="iax2-provision_8c.html#a37fe1c9461e11b52a9349aa79d90dcf6">iax_prov_complete_template</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l11420"></a>11420       <span class="keywordflow">return</span> NULL;
<a name="l11421"></a>11421    }
<a name="l11422"></a>11422 
<a name="l11423"></a>11423    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4)
<a name="l11424"></a>11424       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l11425"></a>11425    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 4) {
<a name="l11426"></a>11426       <span class="keywordflow">if</span> (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4], <span class="stringliteral">&quot;forced&quot;</span>))
<a name="l11427"></a>11427          force = 1;
<a name="l11428"></a>11428       <span class="keywordflow">else</span>
<a name="l11429"></a>11429          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l11430"></a>11430    }
<a name="l11431"></a>11431    res = <a class="code" href="chan__iax2_8c.html#afb50b8462a8f5ed65a4df220ab27e293">iax2_provision</a>(NULL, -1, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], force);
<a name="l11432"></a>11432    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l11433"></a>11433       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to find peer/address &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l11434"></a>11434    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt; 1)
<a name="l11435"></a>11435       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No template (including wildcard) matching &apos;%s&apos;\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l11436"></a>11436    <span class="keywordflow">else</span>
<a name="l11437"></a>11437       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Provisioning &apos;%s&apos; with template &apos;%s&apos;%s\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], force ? <span class="stringliteral">&quot;, forced&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l11438"></a>11438    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l11439"></a>11439 }
<a name="l11440"></a>11440 
<a name="l11441"></a><a class="code" href="chan__iax2_8c.html#a1a75c9755a17b1d422942faacb3a9974">11441</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a1a75c9755a17b1d422942faacb3a9974">__iax2_poke_noanswer</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l11442"></a>11442 {
<a name="l11443"></a>11443    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = (<span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *)data;
<a name="l11444"></a>11444    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>;
<a name="l11445"></a>11445 
<a name="l11446"></a>11446    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &gt; -1) {
<a name="l11447"></a>11447       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Peer &apos;%s&apos; is now UNREACHABLE! Time: %d\n&quot;</span>, peer-&gt;name, peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>);
<a name="l11448"></a>11448       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <span class="stringliteral">&quot;PeerStatus&quot;</span>, <span class="stringliteral">&quot;ChannelType: IAX2\r\nPeer: IAX2/%s\r\nPeerStatus: Unreachable\r\nTime: %d\r\n&quot;</span>, peer-&gt;name, peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>);
<a name="l11449"></a>11449       <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>, <span class="stringliteral">&quot;IAX2/%s&quot;</span>, peer-&gt;name); <span class="comment">/* Activate notification */</span>
<a name="l11450"></a>11450    }
<a name="l11451"></a>11451    <span class="keywordflow">if</span> ((callno = peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>) &gt; 0) {
<a name="l11452"></a>11452       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11453"></a>11453       <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l11454"></a>11454       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11455"></a>11455    }
<a name="l11456"></a>11456    peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> = 0;
<a name="l11457"></a>11457    peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> = -1;
<a name="l11458"></a>11458    <span class="comment">/* Try again quickly */</span>
<a name="l11459"></a>11459    peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>, <a class="code" href="chan__iax2_8c.html#acc5f5c09967027708bf5b6e6374f5935">iax2_poke_peer_s</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l11460"></a>11460    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> == -1)
<a name="l11461"></a>11461       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l11462"></a>11462 }
<a name="l11463"></a>11463 
<a name="l11464"></a><a class="code" href="chan__iax2_8c.html#a906b9a95cc7b83ef8cc23bf4e2deae07">11464</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a906b9a95cc7b83ef8cc23bf4e2deae07">iax2_poke_noanswer</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l11465"></a>11465 {
<a name="l11466"></a>11466    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = (<span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *)data;
<a name="l11467"></a>11467    peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l11468"></a>11468 <span class="preprocessor">#ifdef SCHED_MULTITHREADED</span>
<a name="l11469"></a>11469 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a51710585cae3868bdd76ab8a5b793ca2">schedule_action</a>(<a class="code" href="chan__iax2_8c.html#a1a75c9755a17b1d422942faacb3a9974">__iax2_poke_noanswer</a>, data))
<a name="l11470"></a>11470 #endif      
<a name="l11471"></a>11471       <a class="code" href="chan__iax2_8c.html#a1a75c9755a17b1d422942faacb3a9974">__iax2_poke_noanswer</a>(data);
<a name="l11472"></a>11472    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l11473"></a>11473    <span class="keywordflow">return</span> 0;
<a name="l11474"></a>11474 }
<a name="l11475"></a>11475 
<a name="l11476"></a><a class="code" href="chan__iax2_8c.html#a0cf3427f2d30b79547505abab2950d10">11476</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a0cf3427f2d30b79547505abab2950d10">iax2_poke_peer_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l11477"></a>11477 {
<a name="l11478"></a>11478    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = obj;
<a name="l11479"></a>11479 
<a name="l11480"></a>11480    <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(peer, 0);
<a name="l11481"></a>11481 
<a name="l11482"></a>11482    <span class="keywordflow">return</span> 0;
<a name="l11483"></a>11483 }
<a name="l11484"></a>11484 
<a name="l11485"></a><a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">11485</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer, <span class="keywordtype">int</span> heldcall)
<a name="l11486"></a>11486 {
<a name="l11487"></a>11487    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>;
<a name="l11488"></a>11488    <span class="keywordflow">if</span> (!peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> || (!peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr &amp;&amp; !peer-&gt;<a class="code" href="structiax2__peer.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>)) {
<a name="l11489"></a>11489       <span class="comment">/* IF we have no IP without dnsmgr, or this isn&apos;t to be monitored, return</span>
<a name="l11490"></a>11490 <span class="comment">        immediately after clearing things out */</span>
<a name="l11491"></a>11491       peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> = 0;
<a name="l11492"></a>11492       peer-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> = 0;
<a name="l11493"></a>11493       peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l11494"></a>11494       peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> = 0;
<a name="l11495"></a>11495       <span class="keywordflow">return</span> 0;
<a name="l11496"></a>11496    }
<a name="l11497"></a>11497 
<a name="l11498"></a>11498    <span class="comment">/* The peer could change the callno inside iax2_destroy, since we do deadlock avoidance */</span>
<a name="l11499"></a>11499    <span class="keywordflow">if</span> ((callno = peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>) &gt; 0) {
<a name="l11500"></a>11500       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Still have a callno...\n&quot;</span>);
<a name="l11501"></a>11501       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11502"></a>11502       <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l11503"></a>11503       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11504"></a>11504    }
<a name="l11505"></a>11505    <span class="keywordflow">if</span> (heldcall)
<a name="l11506"></a>11506       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[heldcall]);
<a name="l11507"></a>11507    callno = peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> = <a class="code" href="chan__iax2_8c.html#a26cef2567af74205496ef576f775ef05">find_callno</a>(0, 0, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">NEW_FORCE</a>, peer-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, 0);
<a name="l11508"></a>11508    <span class="keywordflow">if</span> (heldcall)
<a name="l11509"></a>11509       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[heldcall]);
<a name="l11510"></a>11510    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> &lt; 1) {
<a name="l11511"></a>11511       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate call for poking peer &apos;%s&apos;\n&quot;</span>, peer-&gt;name);
<a name="l11512"></a>11512       <span class="keywordflow">return</span> -1;
<a name="l11513"></a>11513    }
<a name="l11514"></a>11514 
<a name="l11515"></a>11515    <span class="comment">/* Speed up retransmission times for this qualify call */</span>
<a name="l11516"></a>11516    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#a434247ddc3fa7f834ce9ae8f7ef1c5b5">pingtime</a> = peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> / 4 + 1;
<a name="l11517"></a>11517    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>]-&gt;<a class="code" href="structchan__iax2__pvt.html#aee64b401a3bf4b7712eb81846d140df6">peerpoke</a> = peer;
<a name="l11518"></a>11518 
<a name="l11519"></a>11519    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> &gt; -1) {
<a name="l11520"></a>11520       <span class="keywordflow">if</span> (!<a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a>)) {
<a name="l11521"></a>11521          peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l11522"></a>11522          <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l11523"></a>11523       }
<a name="l11524"></a>11524    }
<a name="l11525"></a>11525  
<a name="l11526"></a>11526    <span class="comment">/* Queue up a new task to handle no reply */</span>
<a name="l11527"></a>11527    <span class="comment">/* If the host is already unreachable then use the unreachable interval instead */</span>
<a name="l11528"></a>11528    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &lt; 0)
<a name="l11529"></a>11529       peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>, <a class="code" href="chan__iax2_8c.html#a906b9a95cc7b83ef8cc23bf4e2deae07">iax2_poke_noanswer</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l11530"></a>11530    <span class="keywordflow">else</span>
<a name="l11531"></a>11531       peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, <a class="code" href="chan__iax2_8c.html#a960e3be6d1f16d936afd3d6fba7f31b0">DEFAULT_MAXMS</a> * 2, <a class="code" href="chan__iax2_8c.html#a906b9a95cc7b83ef8cc23bf4e2deae07">iax2_poke_noanswer</a>, <a class="code" href="chan__iax2_8c.html#aec4834ef5c22c687dea2cd4fea0fa5f7">peer_ref</a>(peer));
<a name="l11532"></a>11532 
<a name="l11533"></a>11533    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> == -1)
<a name="l11534"></a>11534       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l11535"></a>11535 
<a name="l11536"></a>11536    <span class="comment">/* And send the poke */</span>
<a name="l11537"></a>11537    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11538"></a>11538    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l11539"></a>11539       <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied = {
<a name="l11540"></a>11540          .<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a> = { 0 },
<a name="l11541"></a>11541          .pos = 0,
<a name="l11542"></a>11542       };
<a name="l11543"></a>11543       <a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">add_empty_calltoken_ie</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], &amp;ied); <span class="comment">/* this _MUST_ be the last ie added */</span>
<a name="l11544"></a>11544       <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effaa68c0d056acb361b1117cbad4121d418">IAX_COMMAND_POKE</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l11545"></a>11545    }
<a name="l11546"></a>11546    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11547"></a>11547 
<a name="l11548"></a>11548    <span class="keywordflow">return</span> 0;
<a name="l11549"></a>11549 }
<a name="l11550"></a>11550 
<a name="l11551"></a><a class="code" href="chan__iax2_8c.html#a6c9d0d86254e4846c77b5b83054bf7d6">11551</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a6c9d0d86254e4846c77b5b83054bf7d6">free_context</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__context.html">iax2_context</a> *con)
<a name="l11552"></a>11552 {
<a name="l11553"></a>11553    <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *conl;
<a name="l11554"></a>11554    <span class="keywordflow">while</span>(con) {
<a name="l11555"></a>11555       conl = con;
<a name="l11556"></a>11556       con = con-&gt;<a class="code" href="structiax2__context.html#adda68386bebcd983920d3f129230f277">next</a>;
<a name="l11557"></a>11557       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(conl);
<a name="l11558"></a>11558    }
<a name="l11559"></a>11559 }
<a name="l11560"></a>11560 
<a name="l11561"></a><a class="code" href="chan__iax2_8c.html#a550f1c4da789484cff80ee170bb13f08">11561</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="chan__iax2_8c.html#a550f1c4da789484cff80ee170bb13f08">iax2_request</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *type, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>, <span class="keywordtype">int</span> *<a class="code" href="channel_8c.html#aa4d0ccb9d0904892652f2f258c5ad225">cause</a>)
<a name="l11562"></a>11562 {
<a name="l11563"></a>11563    <span class="keywordtype">int</span> callno;
<a name="l11564"></a>11564    <span class="keywordtype">int</span> res;
<a name="l11565"></a>11565    <span class="keywordtype">int</span> fmt, native;
<a name="l11566"></a>11566    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l11567"></a>11567    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c;
<a name="l11568"></a>11568    <span class="keyword">struct </span><a class="code" href="structparsed__dial__string.html">parsed_dial_string</a> pds;
<a name="l11569"></a>11569    <span class="keyword">struct </span><a class="code" href="structcreate__addr__info.html">create_addr_info</a> cai;
<a name="l11570"></a>11570    <span class="keywordtype">char</span> *tmpstr;
<a name="l11571"></a>11571 
<a name="l11572"></a>11572    memset(&amp;pds, 0, <span class="keyword">sizeof</span>(pds));
<a name="l11573"></a>11573    tmpstr = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l11574"></a>11574    <a class="code" href="chan__iax2_8c.html#a71c8dc9496597f318dad7e03597b945d" title="Parses an IAX dial string into its component parts.">parse_dial_string</a>(tmpstr, &amp;pds);
<a name="l11575"></a>11575 
<a name="l11576"></a>11576    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>)) {
<a name="l11577"></a>11577       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No peer provided in the IAX2 dial string &apos;%s&apos;\n&quot;</span>, (<span class="keywordtype">char</span> *) data);
<a name="l11578"></a>11578       <span class="keywordflow">return</span> NULL;
<a name="l11579"></a>11579    }
<a name="l11580"></a>11580           
<a name="l11581"></a>11581    memset(&amp;cai, 0, <span class="keyword">sizeof</span>(cai));
<a name="l11582"></a>11582    cai.<a class="code" href="structcreate__addr__info.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = iax2_capability;
<a name="l11583"></a>11583 
<a name="l11584"></a>11584    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;cai, &amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);
<a name="l11585"></a>11585    
<a name="l11586"></a>11586    <span class="comment">/* Populate our address from the given */</span>
<a name="l11587"></a>11587    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a718ce50d45da77b324047f3d9ceb6749">create_addr</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, NULL, &amp;sin, &amp;cai)) {
<a name="l11588"></a>11588       *cause = <a class="code" href="causes_8h.html#acfea62de81ffbf78fd4856ad9ded150b">AST_CAUSE_UNREGISTERED</a>;
<a name="l11589"></a>11589       <span class="keywordflow">return</span> NULL;
<a name="l11590"></a>11590    }
<a name="l11591"></a>11591 
<a name="l11592"></a>11592    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#add99ba4ea70b8f66170823cad9a55fa4">port</a>)
<a name="l11593"></a>11593       sin.sin_port = htons(atoi(pds.<a class="code" href="structparsed__dial__string.html#add99ba4ea70b8f66170823cad9a55fa4">port</a>));
<a name="l11594"></a>11594 
<a name="l11595"></a>11595    callno = <a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">find_callno_locked</a>(0, 0, &amp;sin, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">NEW_FORCE</a>, cai.<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, 0);
<a name="l11596"></a>11596    <span class="keywordflow">if</span> (callno &lt; 1) {
<a name="l11597"></a>11597       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create call\n&quot;</span>);
<a name="l11598"></a>11598       *cause = <a class="code" href="causes_8h.html#a0a35518d7b448a53da368cf57f354fba">AST_CAUSE_CONGESTION</a>;
<a name="l11599"></a>11599       <span class="keywordflow">return</span> NULL;
<a name="l11600"></a>11600    }
<a name="l11601"></a>11601 
<a name="l11602"></a>11602    <span class="comment">/* If this is a trunk, update it now */</span>
<a name="l11603"></a>11603    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], &amp;cai, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">IAX_SENDANI</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);
<a name="l11604"></a>11604    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;cai, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>)) {
<a name="l11605"></a>11605       <span class="keywordtype">int</span> new_callno;
<a name="l11606"></a>11606       <span class="keywordflow">if</span> ((new_callno = <a class="code" href="chan__iax2_8c.html#afe7b37fe23d6a5abe8a477950a399f1e">make_trunk</a>(callno, 1)) != -1)
<a name="l11607"></a>11607          callno = new_callno;
<a name="l11608"></a>11608    }
<a name="l11609"></a>11609    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#a511d77bac179514b149c432cba8a920a">maxtime</a> = cai.<a class="code" href="structcreate__addr__info.html#a511d77bac179514b149c432cba8a920a">maxtime</a>;
<a name="l11610"></a>11610    <span class="keywordflow">if</span> (cai.<a class="code" href="structcreate__addr__info.html#ac6c6cd839d50c91230f55ed55d0cd635">found</a>)
<a name="l11611"></a>11611       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], host, pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>);
<a name="l11612"></a>11612 
<a name="l11613"></a>11613    c = <a class="code" href="chan__iax2_8c.html#ab8c22a71161e0538ccb120e3ca5abdd2" title="Create new call, interface with the PBX core.">ast_iax2_new</a>(callno, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, cai.<a class="code" href="structcreate__addr__info.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l11614"></a>11614 
<a name="l11615"></a>11615    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11616"></a>11616 
<a name="l11617"></a>11617    <span class="keywordflow">if</span> (c) {
<a name="l11618"></a>11618       <span class="comment">/* Choose a format we can live with */</span>
<a name="l11619"></a>11619       <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> &amp; format) 
<a name="l11620"></a>11620          c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> &amp;= format;
<a name="l11621"></a>11621       <span class="keywordflow">else</span> {
<a name="l11622"></a>11622          native = c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>;
<a name="l11623"></a>11623          fmt = format;
<a name="l11624"></a>11624          res = <a class="code" href="translate_8h.html#a09ac24ad5b3c1e1cee3d294556458e36" title="Chooses the best translation path.">ast_translator_best_choice</a>(&amp;fmt, &amp;native);
<a name="l11625"></a>11625          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l11626"></a>11626             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create translator path for %s to %s on %s\n&quot;</span>,
<a name="l11627"></a>11627                <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>), <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(fmt), c-&gt;name);
<a name="l11628"></a>11628             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(c);
<a name="l11629"></a>11629             <span class="keywordflow">return</span> NULL;
<a name="l11630"></a>11630          }
<a name="l11631"></a>11631          c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a> = native;
<a name="l11632"></a>11632       }
<a name="l11633"></a>11633       c-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a> = <a class="code" href="channel_8h.html#a4d78194779a26341c3ec7298b450b9ed" title="Pick the best audio codec.">ast_best_codec</a>(c-&gt;<a class="code" href="structast__channel.html#a7be3e8823c2f7e6fe3fc48847ba9bdac">nativeformats</a>);
<a name="l11634"></a>11634       c-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a> = c-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>;
<a name="l11635"></a>11635    }
<a name="l11636"></a>11636 
<a name="l11637"></a>11637    <span class="keywordflow">return</span> c;
<a name="l11638"></a>11638 }
<a name="l11639"></a>11639 
<a name="l11640"></a><a class="code" href="chan__iax2_8c.html#a49128caa5ade5fbd7f9a42f39a23476a">11640</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="chan__iax2_8c.html#a49128caa5ade5fbd7f9a42f39a23476a">network_thread</a>(<span class="keywordtype">void</span> *ignore)
<a name="l11641"></a>11641 {
<a name="l11642"></a>11642    <span class="comment">/* Our job is simple: Send queued messages, retrying if necessary.  Read frames </span>
<a name="l11643"></a>11643 <span class="comment">      from the network, and queue them for delivery to the channels */</span>
<a name="l11644"></a>11644    <span class="keywordtype">int</span> res, count, wakeup;
<a name="l11645"></a>11645    <span class="keyword">struct </span>iax_frame *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l11646"></a>11646 
<a name="l11647"></a>11647    <span class="keywordflow">if</span> (timer)
<a name="l11648"></a>11648       <a class="code" href="io_8h.html#aa250c3f6541dc5734deb966d6821da7a" title="Adds an IO context.">ast_io_add</a>(io, <a class="code" href="timing_8h.html#aa3aa7580d76e1d3f7927b3f34764dec2" title="Get a poll()-able file descriptor for a timer.">ast_timer_fd</a>(timer), <a class="code" href="chan__iax2_8c.html#a012d6b64700a636f121bfce123ecfa4a">timing_read</a>, <a class="code" href="io_8h.html#a0d9e01f215782a343a1b71b5be362080">AST_IO_IN</a> | <a class="code" href="io_8h.html#a533349037b889e2ecd44296e74af929a">AST_IO_PRI</a>, NULL);
<a name="l11649"></a>11649    
<a name="l11650"></a>11650    <span class="keywordflow">for</span>(;;) {
<a name="l11651"></a>11651       pthread_testcancel();
<a name="l11652"></a>11652 
<a name="l11653"></a>11653       <span class="comment">/* Go through the queue, sending messages which have not yet been</span>
<a name="l11654"></a>11654 <span class="comment">         sent, and scheduling retransmissions if appropriate */</span>
<a name="l11655"></a>11655       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l11656"></a>11656       count = 0;
<a name="l11657"></a>11657       wakeup = -1;
<a name="l11658"></a>11658       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;frame_queue, f, list) {
<a name="l11659"></a>11659          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a4915c10b7a168f5c7160d3a3b2ea198d">sentyet</a>)
<a name="l11660"></a>11660             <span class="keywordflow">continue</span>;
<a name="l11661"></a>11661          
<a name="l11662"></a>11662          <span class="comment">/* Try to lock the pvt, if we can&apos;t... don&apos;t fret - defer it till later */</span>
<a name="l11663"></a>11663          <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a036ccafa2339f674a46bc269bbd48c5f">ast_mutex_trylock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>])) {
<a name="l11664"></a>11664             wakeup = 1;
<a name="l11665"></a>11665             <span class="keywordflow">continue</span>;
<a name="l11666"></a>11666          }
<a name="l11667"></a>11667 
<a name="l11668"></a>11668          f-&gt;<a class="code" href="structiax__frame.html#a4915c10b7a168f5c7160d3a3b2ea198d">sentyet</a> = 1;
<a name="l11669"></a>11669 
<a name="l11670"></a>11670          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]) {
<a name="l11671"></a>11671             <a class="code" href="chan__iax2_8c.html#adee4a2b64e5bb326743b5801fd474e51">send_packet</a>(f);
<a name="l11672"></a>11672             count++;
<a name="l11673"></a>11673          } 
<a name="l11674"></a>11674 
<a name="l11675"></a>11675          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[f-&gt;<a class="code" href="structiax__frame.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>]);
<a name="l11676"></a>11676 
<a name="l11677"></a>11677          <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a> &lt; 0) {
<a name="l11678"></a>11678             <span class="comment">/* This is not supposed to be retransmitted */</span>
<a name="l11679"></a>11679             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l11680"></a>11680             <span class="comment">/* Free the iax frame */</span>
<a name="l11681"></a>11681             <a class="code" href="iax2-parser_8c.html#a56f011ba4b698f0c5a98920de44926eb">iax_frame_free</a>(f);
<a name="l11682"></a>11682          } <span class="keywordflow">else</span> {
<a name="l11683"></a>11683             <span class="comment">/* We need reliable delivery.  Schedule a retransmission */</span>
<a name="l11684"></a>11684             f-&gt;<a class="code" href="structiax__frame.html#a8ba735ab56b2afeb844916994c86f3f5">retries</a>++;
<a name="l11685"></a>11685             f-&gt;<a class="code" href="structiax__frame.html#a4ab21dd2375ec54e44ae4da973a3d4ca">retrans</a> = <a class="code" href="chan__iax2_8c.html#a2049076e060e953fae7384d009cfcebe">iax2_sched_add</a>(sched, f-&gt;<a class="code" href="structiax__frame.html#ad8e6afe89e3ec022b30cdda570dcb1d3">retrytime</a>, <a class="code" href="chan__iax2_8c.html#a637039d12aabcf9c32a907281e162884">attempt_transmit</a>, f);
<a name="l11686"></a>11686          }
<a name="l11687"></a>11687       }
<a name="l11688"></a>11688       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l11689"></a>11689       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l11690"></a>11690 
<a name="l11691"></a>11691       pthread_testcancel();
<a name="l11692"></a>11692       <span class="keywordflow">if</span> (count &gt;= 20)
<a name="l11693"></a>11693          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;chan_iax2: Sent %d queued outbound frames all at once\n&quot;</span>, count);
<a name="l11694"></a>11694 
<a name="l11695"></a>11695       <span class="comment">/* Now do the IO, and run scheduled tasks */</span>
<a name="l11696"></a>11696       res = <a class="code" href="io_8h.html#a6f1abe730a5606b88c8f415f53b784bc" title="Waits for IO.">ast_io_wait</a>(io, wakeup);
<a name="l11697"></a>11697       <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l11698"></a>11698          <span class="keywordflow">if</span> (res &gt;= 20)
<a name="l11699"></a>11699             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;chan_iax2: ast_io_wait ran %d I/Os all at once\n&quot;</span>, res);
<a name="l11700"></a>11700       }
<a name="l11701"></a>11701    }
<a name="l11702"></a>11702    <span class="keywordflow">return</span> NULL;
<a name="l11703"></a>11703 }
<a name="l11704"></a>11704 
<a name="l11705"></a><a class="code" href="chan__iax2_8c.html#ae6509f01db3676a8f6cd3485afe7b94d">11705</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ae6509f01db3676a8f6cd3485afe7b94d">start_network_thread</a>(<span class="keywordtype">void</span>)
<a name="l11706"></a>11706 {
<a name="l11707"></a>11707    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l11708"></a>11708    <span class="keywordtype">int</span> threadcount = 0;
<a name="l11709"></a>11709    <span class="keywordtype">int</span> x;
<a name="l11710"></a>11710    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a>; x++) {
<a name="l11711"></a>11711       thread = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*thread));
<a name="l11712"></a>11712       <span class="keywordflow">if</span> (thread) {
<a name="l11713"></a>11713          thread-&gt;type = <a class="code" href="chan__iax2_8c.html#a6282227cd5b0a7cd9b3c764f30ca8cd7ac270aa278d19d5394cdfd5dd3552b5d7">IAX_THREAD_TYPE_POOL</a>;
<a name="l11714"></a>11714          thread-&gt;threadnum = ++threadcount;
<a name="l11715"></a>11715          <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;thread-&gt;lock);
<a name="l11716"></a>11716          <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;thread-&gt;cond, NULL);
<a name="l11717"></a>11717          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a832647380b1f97e7ac1b4492f8816d46">ast_pthread_create_detached</a>(&amp;thread-&gt;threadid, NULL, <a class="code" href="chan__iax2_8c.html#a4b01adf25449fb80786fe1af045c3d0c">iax2_process_thread</a>, thread)) {
<a name="l11718"></a>11718             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to create new thread!\n&quot;</span>);
<a name="l11719"></a>11719             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(thread);
<a name="l11720"></a>11720             thread = NULL;
<a name="l11721"></a>11721          }
<a name="l11722"></a>11722          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;idle_list);
<a name="l11723"></a>11723          <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;idle_list, thread, list);
<a name="l11724"></a>11724          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;idle_list);
<a name="l11725"></a>11725       }
<a name="l11726"></a>11726    }
<a name="l11727"></a>11727    <a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;netthreadid, NULL, <a class="code" href="chan__iax2_8c.html#a49128caa5ade5fbd7f9a42f39a23476a">network_thread</a>, NULL);
<a name="l11728"></a>11728    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;%d helper threads started\n&quot;</span>, threadcount);
<a name="l11729"></a>11729    <span class="keywordflow">return</span> 0;
<a name="l11730"></a>11730 }
<a name="l11731"></a>11731 
<a name="l11732"></a><a class="code" href="chan__iax2_8c.html#a5f71bedc7fa0a3a74ffbfdb1cffd1bcd">11732</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *<a class="code" href="chan__iax2_8c.html#a5f71bedc7fa0a3a74ffbfdb1cffd1bcd">build_context</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)
<a name="l11733"></a>11733 {
<a name="l11734"></a>11734    <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *con;
<a name="l11735"></a>11735 
<a name="l11736"></a>11736    <span class="keywordflow">if</span> ((con = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*con))))
<a name="l11737"></a>11737       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(con-&gt;<a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context, <span class="keyword">sizeof</span>(con-&gt;<a class="code" href="structiax2__context.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l11738"></a>11738    
<a name="l11739"></a>11739    <span class="keywordflow">return</span> con;
<a name="l11740"></a>11740 }
<a name="l11741"></a>11741 
<a name="l11742"></a><a class="code" href="chan__iax2_8c.html#a29d895f1002e91b13e1b0ad307e8dd48">11742</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a29d895f1002e91b13e1b0ad307e8dd48">get_auth_methods</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l11743"></a>11743 {
<a name="l11744"></a>11744    <span class="keywordtype">int</span> methods = 0;
<a name="l11745"></a>11745    <span class="keywordflow">if</span> (strstr(value, <span class="stringliteral">&quot;rsa&quot;</span>))
<a name="l11746"></a>11746       methods |= <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>;
<a name="l11747"></a>11747    <span class="keywordflow">if</span> (strstr(value, <span class="stringliteral">&quot;md5&quot;</span>))
<a name="l11748"></a>11748       methods |= <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a>;
<a name="l11749"></a>11749    <span class="keywordflow">if</span> (strstr(value, <span class="stringliteral">&quot;plaintext&quot;</span>))
<a name="l11750"></a>11750       methods |= <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>;
<a name="l11751"></a>11751    <span class="keywordflow">return</span> methods;
<a name="l11752"></a>11752 }
<a name="l11753"></a>11753 
<a name="l11754"></a>11754 <span class="comment"></span>
<a name="l11755"></a>11755 <span class="comment">/*! \brief Check if address can be used as packet source.</span>
<a name="l11756"></a>11756 <span class="comment"> \return 0  address available, 1  address unavailable, -1  error</span>
<a name="l11757"></a>11757 <span class="comment">*/</span>
<a name="l11758"></a><a class="code" href="chan__iax2_8c.html#a5459520d77bc9ad2f0b70bd6b9365c3b">11758</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a5459520d77bc9ad2f0b70bd6b9365c3b" title="Check if address can be used as packet source.">check_srcaddr</a>(<span class="keyword">struct</span> sockaddr *sa, socklen_t salen)
<a name="l11759"></a>11759 {
<a name="l11760"></a>11760    <span class="keywordtype">int</span> sd;
<a name="l11761"></a>11761    <span class="keywordtype">int</span> res;
<a name="l11762"></a>11762    
<a name="l11763"></a>11763    sd = socket(AF_INET, SOCK_DGRAM, 0);
<a name="l11764"></a>11764    <span class="keywordflow">if</span> (sd &lt; 0) {
<a name="l11765"></a>11765       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Socket: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l11766"></a>11766       <span class="keywordflow">return</span> -1;
<a name="l11767"></a>11767    }
<a name="l11768"></a>11768 
<a name="l11769"></a>11769    res = bind(sd, sa, salen);
<a name="l11770"></a>11770    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l11771"></a>11771       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Can&apos;t bind: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l11772"></a>11772       close(sd);
<a name="l11773"></a>11773       <span class="keywordflow">return</span> 1;
<a name="l11774"></a>11774    }
<a name="l11775"></a>11775 
<a name="l11776"></a>11776    close(sd);
<a name="l11777"></a>11777    <span class="keywordflow">return</span> 0;
<a name="l11778"></a>11778 }
<a name="l11779"></a>11779 <span class="comment"></span>
<a name="l11780"></a>11780 <span class="comment">/*! \brief Parse the &quot;sourceaddress&quot; value,</span>
<a name="l11781"></a>11781 <span class="comment">  lookup in netsock list and set peer&apos;s sockfd. Defaults to defaultsockfd if</span>
<a name="l11782"></a>11782 <span class="comment">  not found. */</span>
<a name="l11783"></a><a class="code" href="chan__iax2_8c.html#a97ddf145df2a3a2a43e69555806b7152">11783</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a97ddf145df2a3a2a43e69555806b7152" title="Parse the &amp;quot;sourceaddress&amp;quot; value, lookup in netsock list and set peer&amp;#39;s...">peer_set_srcaddr</a>(<span class="keyword">struct</span> <a class="code" href="structiax2__peer.html">iax2_peer</a> *peer, <span class="keyword">const</span> <span class="keywordtype">char</span> *srcaddr)
<a name="l11784"></a>11784 {
<a name="l11785"></a>11785    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l11786"></a>11786    <span class="keywordtype">int</span> nonlocal = 1;
<a name="l11787"></a>11787    <span class="keywordtype">int</span> port = <a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>;
<a name="l11788"></a>11788    <span class="keywordtype">int</span> <a class="code" href="structiax2__trunk__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = defaultsockfd;
<a name="l11789"></a>11789    <span class="keywordtype">char</span> *tmp;
<a name="l11790"></a>11790    <span class="keywordtype">char</span> *<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>;
<a name="l11791"></a>11791    <span class="keywordtype">char</span> *portstr;
<a name="l11792"></a>11792 
<a name="l11793"></a>11793    <span class="keywordflow">if</span> (!(tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(srcaddr)))
<a name="l11794"></a>11794       <span class="keywordflow">return</span> -1;
<a name="l11795"></a>11795 
<a name="l11796"></a>11796    addr = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l11797"></a>11797    portstr = tmp;
<a name="l11798"></a>11798 
<a name="l11799"></a>11799    <span class="keywordflow">if</span> (portstr) {
<a name="l11800"></a>11800       port = atoi(portstr);
<a name="l11801"></a>11801       <span class="keywordflow">if</span> (port &lt; 1)
<a name="l11802"></a>11802          port = <a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>;
<a name="l11803"></a>11803    }
<a name="l11804"></a>11804    
<a name="l11805"></a>11805    <span class="keywordflow">if</span> (!<a class="code" href="acl_8h.html#af04bd435c082da93aec0cb6e0782788a">ast_get_ip</a>(&amp;sin, addr)) {
<a name="l11806"></a>11806       <span class="keyword">struct </span><a class="code" href="structast__netsock.html">ast_netsock</a> *sock;
<a name="l11807"></a>11807       <span class="keywordtype">int</span> res;
<a name="l11808"></a>11808 
<a name="l11809"></a>11809       sin.sin_port = 0;
<a name="l11810"></a>11810       sin.sin_family = AF_INET;
<a name="l11811"></a>11811       res = <a class="code" href="chan__iax2_8c.html#a5459520d77bc9ad2f0b70bd6b9365c3b" title="Check if address can be used as packet source.">check_srcaddr</a>((<span class="keyword">struct</span> sockaddr *) &amp;sin, <span class="keyword">sizeof</span>(sin));
<a name="l11812"></a>11812       <span class="keywordflow">if</span> (res == 0) {
<a name="l11813"></a>11813          <span class="comment">/* ip address valid. */</span>
<a name="l11814"></a>11814          sin.sin_port = htons(port);
<a name="l11815"></a>11815          <span class="keywordflow">if</span> (!(sock = <a class="code" href="netsock_8h.html#aea3734568fc9cfc320d200a11d0ad6ab">ast_netsock_find</a>(netsock, &amp;sin)))
<a name="l11816"></a>11816             sock = <a class="code" href="netsock_8h.html#aea3734568fc9cfc320d200a11d0ad6ab">ast_netsock_find</a>(outsock, &amp;sin);
<a name="l11817"></a>11817          <span class="keywordflow">if</span> (sock) {
<a name="l11818"></a>11818             sockfd = <a class="code" href="netsock_8h.html#a9bd7ad8830fd7017a855f852341f0266">ast_netsock_sockfd</a>(sock);
<a name="l11819"></a>11819             nonlocal = 0;
<a name="l11820"></a>11820          } <span class="keywordflow">else</span> {
<a name="l11821"></a>11821             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> orig_saddr = sin.sin_addr.s_addr;
<a name="l11822"></a>11822             <span class="comment">/* INADDR_ANY matches anyway! */</span>
<a name="l11823"></a>11823             sin.sin_addr.s_addr = INADDR_ANY;
<a name="l11824"></a>11824             <span class="keywordflow">if</span> (<a class="code" href="netsock_8h.html#aea3734568fc9cfc320d200a11d0ad6ab">ast_netsock_find</a>(netsock, &amp;sin)) {
<a name="l11825"></a>11825                sin.sin_addr.s_addr = orig_saddr;
<a name="l11826"></a>11826                sock = <a class="code" href="netsock_8h.html#aec80b0539f9de617c6d5cf08d4c6b5d7">ast_netsock_bind</a>(outsock, io, srcaddr, port, <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.tos, <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.cos, <a class="code" href="chan__iax2_8c.html#ab30ccbd9565b8d995633142a78e63956">socket_read</a>, NULL);
<a name="l11827"></a>11827                <span class="keywordflow">if</span> (sock) {
<a name="l11828"></a>11828                   sockfd = <a class="code" href="netsock_8h.html#a9bd7ad8830fd7017a855f852341f0266">ast_netsock_sockfd</a>(sock);
<a name="l11829"></a>11829                   <a class="code" href="netsock_8h.html#a8a8cd7e2d5d9e1b67353fe28e45324ec">ast_netsock_unref</a>(sock);
<a name="l11830"></a>11830                   nonlocal = 0;
<a name="l11831"></a>11831                } <span class="keywordflow">else</span> {
<a name="l11832"></a>11832                   nonlocal = 2;
<a name="l11833"></a>11833                }
<a name="l11834"></a>11834             }
<a name="l11835"></a>11835          }
<a name="l11836"></a>11836       }
<a name="l11837"></a>11837    }
<a name="l11838"></a>11838       
<a name="l11839"></a>11839    peer-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = sockfd;
<a name="l11840"></a>11840 
<a name="l11841"></a>11841    <span class="keywordflow">if</span> (nonlocal == 1) {
<a name="l11842"></a>11842       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Non-local or unbound address specified (%s) in sourceaddress for &apos;%s&apos;, reverting to default\n&quot;</span>,
<a name="l11843"></a>11843          srcaddr, peer-&gt;name);
<a name="l11844"></a>11844       <span class="keywordflow">return</span> -1;
<a name="l11845"></a>11845         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (nonlocal == 2) {
<a name="l11846"></a>11846       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to bind to sourceaddress &apos;%s&apos; for &apos;%s&apos;, reverting to default\n&quot;</span>,
<a name="l11847"></a>11847          srcaddr, peer-&gt;name);
<a name="l11848"></a>11848          <span class="keywordflow">return</span> -1;
<a name="l11849"></a>11849    } <span class="keywordflow">else</span> {
<a name="l11850"></a>11850       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Using sourceaddress %s for &apos;%s&apos;\n&quot;</span>, srcaddr, peer-&gt;name);
<a name="l11851"></a>11851       <span class="keywordflow">return</span> 0;
<a name="l11852"></a>11852    }
<a name="l11853"></a>11853 }
<a name="l11854"></a>11854 
<a name="l11855"></a><a class="code" href="chan__iax2_8c.html#ab40bc5aa39e2a2ce64c434e7fe0eec68">11855</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ab40bc5aa39e2a2ce64c434e7fe0eec68">peer_destructor</a>(<span class="keywordtype">void</span> *obj)
<a name="l11856"></a>11856 {
<a name="l11857"></a>11857    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = obj;
<a name="l11858"></a>11858    <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a> = peer-&gt;<a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>;
<a name="l11859"></a>11859 
<a name="l11860"></a>11860    <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>);
<a name="l11861"></a>11861 
<a name="l11862"></a>11862    <span class="keywordflow">if</span> (callno &gt; 0) {
<a name="l11863"></a>11863       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11864"></a>11864       <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l11865"></a>11865       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l11866"></a>11866    }
<a name="l11867"></a>11867 
<a name="l11868"></a>11868    <a class="code" href="chan__iax2_8c.html#a672ae61189f4cc30f750c658138ef3b7">register_peer_exten</a>(peer, 0);
<a name="l11869"></a>11869 
<a name="l11870"></a>11870    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>)
<a name="l11871"></a>11871       <a class="code" href="dnsmgr_8h.html#a0255399a507b71ae563fc2caf94d749c" title="Free a DNS manager entry.">ast_dnsmgr_release</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>);
<a name="l11872"></a>11872 
<a name="l11873"></a>11873    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a7dec0df43032d5c53d9a125030385a30">mwi_event_sub</a>)
<a name="l11874"></a>11874       <a class="code" href="event_8h.html#a71eb177cf8553883be773f1534e8a09a" title="Un-subscribe from events.">ast_event_unsubscribe</a>(peer-&gt;<a class="code" href="structiax2__peer.html#a7dec0df43032d5c53d9a125030385a30">mwi_event_sub</a>);
<a name="l11875"></a>11875 
<a name="l11876"></a>11876    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(peer);
<a name="l11877"></a>11877 }
<a name="l11878"></a>11878 <span class="comment"></span>
<a name="l11879"></a>11879 <span class="comment">/*! \brief Create peer structure based on configuration */</span>
<a name="l11880"></a><a class="code" href="chan__iax2_8c.html#a49e3974d5f7880c5ec01eb631bb4062b">11880</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *<a class="code" href="chan__iax2_8c.html#a49e3974d5f7880c5ec01eb631bb4062b" title="Create peer structure based on configuration.">build_peer</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *alt, <span class="keywordtype">int</span> temponly)
<a name="l11881"></a>11881 {
<a name="l11882"></a>11882    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = NULL;
<a name="l11883"></a>11883    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> *oldha = NULL;
<a name="l11884"></a>11884    <span class="keywordtype">int</span> maskfound = 0;
<a name="l11885"></a>11885    <span class="keywordtype">int</span> found = 0;
<a name="l11886"></a>11886    <span class="keywordtype">int</span> firstpass = 1;
<a name="l11887"></a>11887    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> tmp_peer = {
<a name="l11888"></a>11888       .name = name,
<a name="l11889"></a>11889    };
<a name="l11890"></a>11890 
<a name="l11891"></a>11891    <span class="keywordflow">if</span> (!temponly) {
<a name="l11892"></a>11892       peer = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(peers, &amp;tmp_peer, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l11893"></a>11893       <span class="keywordflow">if</span> (peer &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>))
<a name="l11894"></a>11894          firstpass = 0;
<a name="l11895"></a>11895    }
<a name="l11896"></a>11896 
<a name="l11897"></a>11897    <span class="keywordflow">if</span> (peer) {
<a name="l11898"></a>11898       found++;
<a name="l11899"></a>11899       <span class="keywordflow">if</span> (firstpass) {
<a name="l11900"></a>11900          oldha = peer-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>;
<a name="l11901"></a>11901          peer-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a> = NULL;
<a name="l11902"></a>11902       }
<a name="l11903"></a>11903       <a class="code" href="chan__iax2_8c.html#a9bc5565f824594fb78b237f40e83d2de">unlink_peer</a>(peer);
<a name="l11904"></a>11904    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((peer = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*peer), <a class="code" href="chan__iax2_8c.html#ab40bc5aa39e2a2ce64c434e7fe0eec68">peer_destructor</a>))) {
<a name="l11905"></a>11905       peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a> = -1;
<a name="l11906"></a>11906       peer-&gt;<a class="code" href="structiax2__peer.html#ab31d029e7243629a184f64a537586b91">pokeexpire</a> = -1;
<a name="l11907"></a>11907       peer-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = defaultsockfd;
<a name="l11908"></a>11908       <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(peer, 32))
<a name="l11909"></a>11909          peer = <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l11910"></a>11910    }
<a name="l11911"></a>11911 
<a name="l11912"></a>11912    <span class="keywordflow">if</span> (peer) {
<a name="l11913"></a>11913       <span class="keywordflow">if</span> (firstpass) {
<a name="l11914"></a>11914          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(peer, &amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l11915"></a>11915          peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = iax2_encryption;
<a name="l11916"></a>11916          peer-&gt;<a class="code" href="structiax2__peer.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = adsi;
<a name="l11917"></a>11917          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer,<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l11918"></a>11918          <span class="keywordflow">if</span> (!found) {
<a name="l11919"></a>11919             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, name, name);
<a name="l11920"></a>11920             peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = htons(<a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>);
<a name="l11921"></a>11921             peer-&gt;<a class="code" href="structiax2__peer.html#ace78f8a8d8e97294b2c81eece4bb8b4f">expiry</a> = min_reg_expire;
<a name="l11922"></a>11922          }
<a name="l11923"></a>11923          peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a> = <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l11924"></a>11924          peer-&gt;<a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = iax2_capability;
<a name="l11925"></a>11925          peer-&gt;<a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">smoothing</a> = 0;
<a name="l11926"></a>11926          peer-&gt;<a class="code" href="structiax2__peer.html#a0fc1d0f0302835103c4b7c291c2467b1">pokefreqok</a> = <a class="code" href="chan__iax2_8c.html#a6c7e84078c9453a91a17644b02a40f31">DEFAULT_FREQ_OK</a>;
<a name="l11927"></a>11927          peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a> = <a class="code" href="chan__iax2_8c.html#aa73619a83d0834665edbf86a7bde0d91">DEFAULT_FREQ_NOTOK</a>;
<a name="l11928"></a>11928          peer-&gt;<a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a> = 0;
<a name="l11929"></a>11929          <a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">peercnt_modify</a>(0, 0, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l11930"></a>11930          peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a5e7188ffc2bdb50ce90b5f8e0a1d7ac3" title="Default calltoken required unless the ip is in the ignorelist.">CALLTOKEN_DEFAULT</a>;
<a name="l11931"></a>11931          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer,<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>,<span class="stringliteral">&quot;&quot;</span>);
<a name="l11932"></a>11932          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer,peercontext,<span class="stringliteral">&quot;&quot;</span>);
<a name="l11933"></a>11933          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l11934"></a>11934          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l11935"></a>11935          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l11936"></a>11936          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, mohinterpret, mohinterpret);
<a name="l11937"></a>11937          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, mohsuggest, mohsuggest);
<a name="l11938"></a>11938       }
<a name="l11939"></a>11939 
<a name="l11940"></a>11940       <span class="keywordflow">if</span> (!v) {
<a name="l11941"></a>11941          v = alt;
<a name="l11942"></a>11942          alt = NULL;
<a name="l11943"></a>11943       }
<a name="l11944"></a>11944       <span class="keywordflow">while</span>(v) {
<a name="l11945"></a>11945          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;secret&quot;</span>)) {
<a name="l11946"></a>11946             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11947"></a>11947          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mailbox&quot;</span>)) {
<a name="l11948"></a>11948             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11949"></a>11949          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;hasvoicemail&quot;</span>)) {
<a name="l11950"></a>11950             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;mailbox)) {
<a name="l11951"></a>11951                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, name);
<a name="l11952"></a>11952             }
<a name="l11953"></a>11953          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mohinterpret&quot;</span>)) {
<a name="l11954"></a>11954             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, mohinterpret, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11955"></a>11955          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mohsuggest&quot;</span>)) {
<a name="l11956"></a>11956             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, mohsuggest, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11957"></a>11957          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;dbsecret&quot;</span>)) {
<a name="l11958"></a>11958             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, dbsecret, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11959"></a>11959          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunk&quot;</span>)) {
<a name="l11960"></a>11960             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(peer, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);   
<a name="l11961"></a>11961             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) &amp;&amp; !timer) {
<a name="l11962"></a>11962                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to support trunking on peer &apos;%s&apos; without a timing interface\n&quot;</span>, peer-&gt;name);
<a name="l11963"></a>11963                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);
<a name="l11964"></a>11964             }
<a name="l11965"></a>11965          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;auth&quot;</span>)) {
<a name="l11966"></a>11966             peer-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = <a class="code" href="chan__iax2_8c.html#a29d895f1002e91b13e1b0ad307e8dd48">get_auth_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11967"></a>11967          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;encryption&quot;</span>)) {
<a name="l11968"></a>11968             peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> |= <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11969"></a>11969             <span class="keywordflow">if</span> (!peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l11970"></a>11970                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l11971"></a>11971             }
<a name="l11972"></a>11972          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forceencryption&quot;</span>)) {
<a name="l11973"></a>11973             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l11974"></a>11974                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l11975"></a>11975             } <span class="keywordflow">else</span> {
<a name="l11976"></a>11976                peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> |= <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11977"></a>11977                <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l11978"></a>11978                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l11979"></a>11979                }
<a name="l11980"></a>11980             }
<a name="l11981"></a>11981          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transfer&quot;</span>)) {
<a name="l11982"></a>11982             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;mediaonly&quot;</span>)) {
<a name="l11983"></a>11983                <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>);  
<a name="l11984"></a>11984             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l11985"></a>11985                <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, 0);
<a name="l11986"></a>11986             } <span class="keywordflow">else</span> 
<a name="l11987"></a>11987                <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>);
<a name="l11988"></a>11988          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;jitterbuffer&quot;</span>)) {
<a name="l11989"></a>11989             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(peer, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>);  
<a name="l11990"></a>11990          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forcejitterbuffer&quot;</span>)) {
<a name="l11991"></a>11991             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(peer, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);   
<a name="l11992"></a>11992          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;host&quot;</span>)) {
<a name="l11993"></a>11993             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;dynamic&quot;</span>)) {
<a name="l11994"></a>11994                <span class="comment">/* They&apos;ll register with us */</span>
<a name="l11995"></a>11995                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>); 
<a name="l11996"></a>11996                <span class="keywordflow">if</span> (!found) {
<a name="l11997"></a>11997                   <span class="comment">/* Initialize stuff iff we&apos;re not found, otherwise</span>
<a name="l11998"></a>11998 <span class="comment">                     we keep going with what we had */</span>
<a name="l11999"></a>11999                   memset(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr, 0, 4);
<a name="l12000"></a>12000                   <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port) {
<a name="l12001"></a>12001                      <span class="comment">/* If we&apos;ve already got a port, make it the default rather than absolute */</span>
<a name="l12002"></a>12002                      peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_port = peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port;
<a name="l12003"></a>12003                      peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = 0;
<a name="l12004"></a>12004                   }
<a name="l12005"></a>12005                }
<a name="l12006"></a>12006             } <span class="keywordflow">else</span> {
<a name="l12007"></a>12007                <span class="comment">/* Non-dynamic.  Make sure we become that way if we&apos;re not */</span>
<a name="l12008"></a>12008                <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>);
<a name="l12009"></a>12009                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>);
<a name="l12010"></a>12010                <span class="keywordflow">if</span> (<a class="code" href="dnsmgr_8h.html#a281a512e7dbfb3ca5875c1a4d08ac0d6" title="Allocate and initialize a DNS manager entry.">ast_dnsmgr_lookup</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>, srvlookup ? <span class="stringliteral">&quot;_iax._udp&quot;</span> : NULL))
<a name="l12011"></a>12011                   <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l12012"></a>12012                <span class="keywordflow">if</span> (!peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port)
<a name="l12013"></a>12013                   peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = htons(<a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>);
<a name="l12014"></a>12014             }
<a name="l12015"></a>12015             <span class="keywordflow">if</span> (!maskfound)
<a name="l12016"></a>12016                inet_aton(<span class="stringliteral">&quot;255.255.255.255&quot;</span>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>);
<a name="l12017"></a>12017          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;defaultip&quot;</span>)) {
<a name="l12018"></a>12018             <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#af04bd435c082da93aec0cb6e0782788a">ast_get_ip</a>(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l12019"></a>12019                <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l12020"></a>12020          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sourceaddress&quot;</span>)) {
<a name="l12021"></a>12021             <a class="code" href="chan__iax2_8c.html#a97ddf145df2a3a2a43e69555806b7152" title="Parse the &amp;quot;sourceaddress&amp;quot; value, lookup in netsock list and set peer&amp;#39;s...">peer_set_srcaddr</a>(peer, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12022"></a>12022          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;permit&quot;</span>) ||
<a name="l12023"></a>12023                   !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;deny&quot;</span>)) {
<a name="l12024"></a>12024             peer-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a> = <a class="code" href="acl_8h.html#ae839a9c2465be4e9a560dda668a65b9b" title="Append ACL entry to host access list.">ast_append_ha</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, peer-&gt;<a class="code" href="structiax2__peer.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>, NULL);
<a name="l12025"></a>12025          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mask&quot;</span>)) {
<a name="l12026"></a>12026             maskfound++;
<a name="l12027"></a>12027             inet_aton(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#ac79cdb94f02359558770ac28abe77d55">mask</a>);
<a name="l12028"></a>12028          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l12029"></a>12029             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12030"></a>12030          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;regexten&quot;</span>)) {
<a name="l12031"></a>12031             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, regexten, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12032"></a>12032          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;peercontext&quot;</span>)) {
<a name="l12033"></a>12033             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, peercontext, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12034"></a>12034          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;port&quot;</span>)) {
<a name="l12035"></a>12035             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>))
<a name="l12036"></a>12036                peer-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_port = htons(atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));
<a name="l12037"></a>12037             <span class="keywordflow">else</span>
<a name="l12038"></a>12038                peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_port = htons(atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>));
<a name="l12039"></a>12039          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;username&quot;</span>)) {
<a name="l12040"></a>12040             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, username, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12041"></a>12041          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allow&quot;</span>)) {
<a name="l12042"></a>12042             <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 1);
<a name="l12043"></a>12043          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;disallow&quot;</span>)) {
<a name="l12044"></a>12044             <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l12045"></a>12045          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerid&quot;</span>)) {
<a name="l12046"></a>12046             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12047"></a>12047                <span class="keywordtype">char</span> name2[80];
<a name="l12048"></a>12048                <span class="keywordtype">char</span> num2[80];
<a name="l12049"></a>12049                <a class="code" href="callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, name2, <span class="keyword">sizeof</span>(name2), num2, <span class="keyword">sizeof</span>(num2));
<a name="l12050"></a>12050                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, name2);
<a name="l12051"></a>12051                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, num2);
<a name="l12052"></a>12052             } <span class="keywordflow">else</span> {
<a name="l12053"></a>12053                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12054"></a>12054                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12055"></a>12055             }
<a name="l12056"></a>12056             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12057"></a>12057          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;fullname&quot;</span>)) {
<a name="l12058"></a>12058             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l12059"></a>12059             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12060"></a>12060          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cid_number&quot;</span>)) {
<a name="l12061"></a>12061             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;&quot;</span>));
<a name="l12062"></a>12062             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12063"></a>12063          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;sendani&quot;</span>)) {
<a name="l12064"></a>12064             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(peer, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba188c3dfe69efb92c198ec6cbccd05fe7">IAX_SENDANI</a>); 
<a name="l12065"></a>12065          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;inkeys&quot;</span>)) {
<a name="l12066"></a>12066             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, inkeys, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12067"></a>12067          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;outkey&quot;</span>)) {
<a name="l12068"></a>12068             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, outkey, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12069"></a>12069          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;qualify&quot;</span>)) {
<a name="l12070"></a>12070             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;no&quot;</span>)) {
<a name="l12071"></a>12071                peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> = 0;
<a name="l12072"></a>12072             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;yes&quot;</span>)) {
<a name="l12073"></a>12073                peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> = <a class="code" href="chan__iax2_8c.html#a960e3be6d1f16d936afd3d6fba7f31b0">DEFAULT_MAXMS</a>;
<a name="l12074"></a>12074             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>) != 1) {
<a name="l12075"></a>12075                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Qualification of peer &apos;%s&apos; should be &apos;yes&apos;, &apos;no&apos;, or a number of milliseconds at line %d of iax.conf\n&quot;</span>, peer-&gt;name, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12076"></a>12076                peer-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> = 0;
<a name="l12077"></a>12077             }
<a name="l12078"></a>12078          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;qualifysmoothing&quot;</span>)) {
<a name="l12079"></a>12079             peer-&gt;<a class="code" href="structiax2__peer.html#ad9a8a08a84944e0d740fb89a5ac4b76b">smoothing</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12080"></a>12080          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;qualifyfreqok&quot;</span>)) {
<a name="l12081"></a>12081             <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#a0fc1d0f0302835103c4b7c291c2467b1">pokefreqok</a>) != 1) {
<a name="l12082"></a>12082                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Qualification testing frequency of peer &apos;%s&apos; when OK should a number of milliseconds at line %d of iax.conf\n&quot;</span>, peer-&gt;name, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12083"></a>12083             }
<a name="l12084"></a>12084          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;qualifyfreqnotok&quot;</span>)) {
<a name="l12085"></a>12085             <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>) != 1) {
<a name="l12086"></a>12086                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Qualification testing frequency of peer &apos;%s&apos; when NOT OK should be a number of milliseconds at line %d of iax.conf\n&quot;</span>, peer-&gt;name, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12087"></a>12087             } <span class="keywordflow">else</span> <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Set peer-&gt;pokefreqnotok to %d\n&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a4097ae0074b035de97175540f2b14523">pokefreqnotok</a>);
<a name="l12088"></a>12088          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;timezone&quot;</span>)) {
<a name="l12089"></a>12089             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(peer, <a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12090"></a>12090          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;adsi&quot;</span>)) {
<a name="l12091"></a>12091             peer-&gt;<a class="code" href="structiax2__peer.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12092"></a>12092          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxcallnumbers&quot;</span>)) {
<a name="l12093"></a>12093             <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%10hu&quot;</span>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a>) != 1) {
<a name="l12094"></a>12094                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;maxcallnumbers must be set to a valid number. %s is not valid at line %d.\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12095"></a>12095             } <span class="keywordflow">else</span> {
<a name="l12096"></a>12096                <a class="code" href="chan__iax2_8c.html#a1f38d2d249cda6ca7978e1636ef71189">peercnt_modify</a>(1, peer-&gt;<a class="code" href="structiax2__peer.html#a763bfbaab9c6e533ccdc18f1790ce91c">maxcallno</a>, &amp;peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>);
<a name="l12097"></a>12097             }
<a name="l12098"></a>12098          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;requirecalltoken&quot;</span>)) {
<a name="l12099"></a>12099             <span class="comment">/* default is required unless in optional ip list */</span>
<a name="l12100"></a>12100             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12101"></a>12101                peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a7ee00866dc8402f0f253e0f8fff829fd" title="Do not require call token validation.">CALLTOKEN_NO</a>;
<a name="l12102"></a>12102             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;auto&quot;</span>)) {
<a name="l12103"></a>12103                peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a>;
<a name="l12104"></a>12104             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12105"></a>12105                peer-&gt;<a class="code" href="structiax2__peer.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8" title="Require call token validation.">CALLTOKEN_YES</a>;
<a name="l12106"></a>12106             } <span class="keywordflow">else</span> {
<a name="l12107"></a>12107                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;requirecalltoken must be set to a valid value. at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12108"></a>12108             }
<a name="l12109"></a>12109          } <span class="comment">/* else if (strcasecmp(v-&gt;name,&quot;type&quot;)) */</span>
<a name="l12110"></a>12110          <span class="comment">/* ast_log(LOG_WARNING, &quot;Ignoring %s\n&quot;, v-&gt;name); */</span>
<a name="l12111"></a>12111          v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l12112"></a>12112          <span class="keywordflow">if</span> (!v) {
<a name="l12113"></a>12113             v = alt;
<a name="l12114"></a>12114             alt = NULL;
<a name="l12115"></a>12115          }
<a name="l12116"></a>12116       }
<a name="l12117"></a>12117       <span class="keywordflow">if</span> (!peer-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>)
<a name="l12118"></a>12118          peer-&gt;<a class="code" href="structiax2__peer.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a> | <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>;
<a name="l12119"></a>12119       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>); 
<a name="l12120"></a>12120       <span class="comment">/* Make sure these are IPv4 addresses */</span>
<a name="l12121"></a>12121       peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_family = AF_INET;
<a name="l12122"></a>12122    }
<a name="l12123"></a>12123 
<a name="l12124"></a>12124    <span class="keywordflow">if</span> (oldha)
<a name="l12125"></a>12125       <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(oldha);
<a name="l12126"></a>12126 
<a name="l12127"></a>12127    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(peer-&gt;mailbox)) {
<a name="l12128"></a>12128       <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l12129"></a>12129       context = mailbox = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(peer-&gt;mailbox);
<a name="l12130"></a>12130       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l12131"></a>12131       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l12132"></a>12132          context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l12133"></a>12133       peer-&gt;<a class="code" href="structiax2__peer.html#a7dec0df43032d5c53d9a125030385a30">mwi_event_sub</a> = <a class="code" href="event_8h.html#a517ac17630e7658463b66b309a6ce78f" title="Subscribe to events.">ast_event_subscribe</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>, <a class="code" href="chan__iax2_8c.html#a46e4523f99409c6696dc775ed6a5e5ed">mwi_event_cb</a>, NULL,
<a name="l12134"></a>12134          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aae6c80d8f4c6ab3cee006ed57d874710" title="Mailbox name.">AST_EVENT_IE_MAILBOX</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, mailbox,
<a name="l12135"></a>12135          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a25764e2fb734ccb3ee1f6f41caba5318" title="Context IE Used by AST_EVENT_MWI Payload type: str.">AST_EVENT_IE_CONTEXT</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, context,
<a name="l12136"></a>12136          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l12137"></a>12137    }
<a name="l12138"></a>12138 
<a name="l12139"></a>12139    <span class="keywordflow">return</span> peer;
<a name="l12140"></a>12140 }
<a name="l12141"></a>12141 
<a name="l12142"></a><a class="code" href="chan__iax2_8c.html#a6581f3b0ba4bf46395cc66968f9c4ff8">12142</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a6581f3b0ba4bf46395cc66968f9c4ff8">user_destructor</a>(<span class="keywordtype">void</span> *obj)
<a name="l12143"></a>12143 {
<a name="l12144"></a>12144    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = obj;
<a name="l12145"></a>12145 
<a name="l12146"></a>12146    <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>);
<a name="l12147"></a>12147    <a class="code" href="chan__iax2_8c.html#a6c9d0d86254e4846c77b5b83054bf7d6">free_context</a>(user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>);
<a name="l12148"></a>12148    <span class="keywordflow">if</span>(user-&gt;<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>) {
<a name="l12149"></a>12149       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(user-&gt;<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>);
<a name="l12150"></a>12150       user-&gt;<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = NULL;
<a name="l12151"></a>12151    }
<a name="l12152"></a>12152    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(user);
<a name="l12153"></a>12153 }
<a name="l12154"></a>12154 <span class="comment"></span>
<a name="l12155"></a>12155 <span class="comment">/*! \brief Create in-memory user structure from configuration */</span>
<a name="l12156"></a><a class="code" href="chan__iax2_8c.html#a4ce55a34cd5160db030be4355f7b4386">12156</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="chan__iax2_8c.html#a4ce55a34cd5160db030be4355f7b4386" title="Create in-memory user structure from configuration.">build_user</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *alt, <span class="keywordtype">int</span> temponly)
<a name="l12157"></a>12157 {
<a name="l12158"></a>12158    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l12159"></a>12159    <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *con, *conl = NULL;
<a name="l12160"></a>12160    <span class="keyword">struct </span><a class="code" href="structast__ha.html" title="internal representation of acl entries In principle user applications would have...">ast_ha</a> *oldha = NULL;
<a name="l12161"></a>12161    <span class="keyword">struct </span><a class="code" href="structiax2__context.html">iax2_context</a> *oldcon = NULL;
<a name="l12162"></a>12162    <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>;
<a name="l12163"></a>12163    <span class="keywordtype">int</span> firstpass=1;
<a name="l12164"></a>12164    <span class="keywordtype">int</span> oldcurauthreq = 0;
<a name="l12165"></a>12165    <span class="keywordtype">char</span> *varname = NULL, *varval = NULL;
<a name="l12166"></a>12166    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tmpvar = NULL;
<a name="l12167"></a>12167    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> tmp_user = {
<a name="l12168"></a>12168       .name = name,
<a name="l12169"></a>12169    };
<a name="l12170"></a>12170 
<a name="l12171"></a>12171    <span class="keywordflow">if</span> (!temponly) {
<a name="l12172"></a>12172       user = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(users, &amp;tmp_user, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca32d49976aaebc093266f0b080f9c9a73">OBJ_POINTER</a>);
<a name="l12173"></a>12173       <span class="keywordflow">if</span> (user &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>))
<a name="l12174"></a>12174          firstpass = 0;
<a name="l12175"></a>12175    }
<a name="l12176"></a>12176 
<a name="l12177"></a>12177    <span class="keywordflow">if</span> (user) {
<a name="l12178"></a>12178       <span class="keywordflow">if</span> (firstpass) {
<a name="l12179"></a>12179          oldcurauthreq = user-&gt;<a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a>;
<a name="l12180"></a>12180          oldha = user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>;
<a name="l12181"></a>12181          oldcon = user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a>;
<a name="l12182"></a>12182          user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a> = NULL;
<a name="l12183"></a>12183          user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a> = NULL;
<a name="l12184"></a>12184       }
<a name="l12185"></a>12185       <span class="comment">/* Already in the list, remove it and it will be added back (or FREE&apos;d) */</span>
<a name="l12186"></a>12186       <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(users, user);
<a name="l12187"></a>12187    } <span class="keywordflow">else</span> {
<a name="l12188"></a>12188       user = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*user), <a class="code" href="chan__iax2_8c.html#a6581f3b0ba4bf46395cc66968f9c4ff8">user_destructor</a>);
<a name="l12189"></a>12189    }
<a name="l12190"></a>12190    
<a name="l12191"></a>12191    <span class="keywordflow">if</span> (user) {
<a name="l12192"></a>12192       <span class="keywordflow">if</span> (firstpass) {
<a name="l12193"></a>12193          <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(user);
<a name="l12194"></a>12194          memset(user, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structiax2__user.html">iax2_user</a>));
<a name="l12195"></a>12195          <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(user, 32)) {
<a name="l12196"></a>12196             user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l12197"></a>12197             <span class="keywordflow">goto</span> <a class="code" href="pbx__gtkconsole_8c.html#ae553432d9c2050cb69863126759710e4">cleanup</a>;
<a name="l12198"></a>12198          }
<a name="l12199"></a>12199          user-&gt;<a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a> = maxauthreq;
<a name="l12200"></a>12200          user-&gt;<a class="code" href="structiax2__user.html#aab6208efa18da27732941aa86dda2434">curauthreq</a> = oldcurauthreq;
<a name="l12201"></a>12201          user-&gt;<a class="code" href="structiax2__user.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a> = <a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>;
<a name="l12202"></a>12202          user-&gt;<a class="code" href="structiax2__user.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = iax2_capability;
<a name="l12203"></a>12203          user-&gt;<a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> = iax2_encryption;
<a name="l12204"></a>12204          user-&gt;<a class="code" href="structiax2__user.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = adsi;
<a name="l12205"></a>12205          user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a5e7188ffc2bdb50ce90b5f8e0a1d7ac3" title="Default calltoken required unless the ip is in the ignorelist.">CALLTOKEN_DEFAULT</a>;
<a name="l12206"></a>12206          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, name, name);
<a name="l12207"></a>12207          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, language, language);
<a name="l12208"></a>12208          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(user, &amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a> | <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>); 
<a name="l12209"></a>12209          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12210"></a>12210          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12211"></a>12211          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12212"></a>12212          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, accountcode, accountcode);
<a name="l12213"></a>12213          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, mohinterpret, mohinterpret);
<a name="l12214"></a>12214          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, mohsuggest, mohsuggest);
<a name="l12215"></a>12215       }
<a name="l12216"></a>12216       <span class="keywordflow">if</span> (!v) {
<a name="l12217"></a>12217          v = alt;
<a name="l12218"></a>12218          alt = NULL;
<a name="l12219"></a>12219       }
<a name="l12220"></a>12220       <span class="keywordflow">while</span>(v) {
<a name="l12221"></a>12221          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l12222"></a>12222             con = <a class="code" href="chan__iax2_8c.html#a5f71bedc7fa0a3a74ffbfdb1cffd1bcd">build_context</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12223"></a>12223             <span class="keywordflow">if</span> (con) {
<a name="l12224"></a>12224                <span class="keywordflow">if</span> (conl)
<a name="l12225"></a>12225                   conl-&gt;<a class="code" href="structiax2__context.html#adda68386bebcd983920d3f129230f277">next</a> = con;
<a name="l12226"></a>12226                <span class="keywordflow">else</span>
<a name="l12227"></a>12227                   user-&gt;<a class="code" href="structiax2__user.html#a289cf2b6bad2123c77caf67586b4db19">contexts</a> = con;
<a name="l12228"></a>12228                conl = con;
<a name="l12229"></a>12229             }
<a name="l12230"></a>12230          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;permit&quot;</span>) ||
<a name="l12231"></a>12231                   !strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;deny&quot;</span>)) {
<a name="l12232"></a>12232             user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a> = <a class="code" href="acl_8h.html#ae839a9c2465be4e9a560dda668a65b9b" title="Append ACL entry to host access list.">ast_append_ha</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, user-&gt;<a class="code" href="structiax2__user.html#a6c6c2b6adbe74acc944bc0c55b16c8f4">ha</a>, NULL);
<a name="l12233"></a>12233          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;setvar&quot;</span>)) {
<a name="l12234"></a>12234             varname = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12235"></a>12235             <span class="keywordflow">if</span> (varname &amp;&amp; (varval = strchr(varname,<span class="charliteral">&apos;=&apos;</span>))) {
<a name="l12236"></a>12236                *varval = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l12237"></a>12237                varval++;
<a name="l12238"></a>12238                <span class="keywordflow">if</span>((tmpvar = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(varname, varval, <span class="stringliteral">&quot;&quot;</span>))) {
<a name="l12239"></a>12239                   tmpvar-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a> = user-&gt;<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a>; 
<a name="l12240"></a>12240                   user-&gt;<a class="code" href="structiax2__user.html#a134fe67053d035e763d6cf99916c1bf8">vars</a> = tmpvar;
<a name="l12241"></a>12241                }
<a name="l12242"></a>12242             }
<a name="l12243"></a>12243          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allow&quot;</span>)) {
<a name="l12244"></a>12244             <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;user-&gt;<a class="code" href="structiax2__user.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;user-&gt;<a class="code" href="structiax2__user.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 1);
<a name="l12245"></a>12245          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;disallow&quot;</span>)) {
<a name="l12246"></a>12246             <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;user-&gt;<a class="code" href="structiax2__user.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;user-&gt;<a class="code" href="structiax2__user.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>,v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l12247"></a>12247          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunk&quot;</span>)) {
<a name="l12248"></a>12248             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(user, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);   
<a name="l12249"></a>12249             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>) &amp;&amp; !timer) {
<a name="l12250"></a>12250                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to support trunking on user &apos;%s&apos; without a timing interface\n&quot;</span>, user-&gt;name);
<a name="l12251"></a>12251                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebac2bbb0576d0d79be56aadccbd8e32111">IAX_TRUNK</a>);
<a name="l12252"></a>12252             }
<a name="l12253"></a>12253          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;auth&quot;</span>)) {
<a name="l12254"></a>12254             user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = <a class="code" href="chan__iax2_8c.html#a29d895f1002e91b13e1b0ad307e8dd48">get_auth_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12255"></a>12255          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;encryption&quot;</span>)) {
<a name="l12256"></a>12256             user-&gt;<a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> |= <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12257"></a>12257             <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l12258"></a>12258                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l12259"></a>12259             }
<a name="l12260"></a>12260          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forceencryption&quot;</span>)) {
<a name="l12261"></a>12261             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12262"></a>12262                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l12263"></a>12263             } <span class="keywordflow">else</span> {
<a name="l12264"></a>12264                user-&gt;<a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a> |= <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12265"></a>12265                <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#a966563ffc5ca23f7611c17140b9cb8e9">encmethods</a>) {
<a name="l12266"></a>12266                   <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l12267"></a>12267                }
<a name="l12268"></a>12268             }
<a name="l12269"></a>12269          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transfer&quot;</span>)) {
<a name="l12270"></a>12270             <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;mediaonly&quot;</span>)) {
<a name="l12271"></a>12271                <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>);  
<a name="l12272"></a>12272             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12273"></a>12273                <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, 0);
<a name="l12274"></a>12274             } <span class="keywordflow">else</span> 
<a name="l12275"></a>12275                <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>);
<a name="l12276"></a>12276          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;codecpriority&quot;</span>)) {
<a name="l12277"></a>12277             <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l12278"></a>12278                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>);
<a name="l12279"></a>12279             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;disabled&quot;</span>))
<a name="l12280"></a>12280                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>);
<a name="l12281"></a>12281             <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;reqonly&quot;</span>)) {
<a name="l12282"></a>12282                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>);
<a name="l12283"></a>12283                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>);
<a name="l12284"></a>12284             }
<a name="l12285"></a>12285          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;immediate&quot;</span>)) {
<a name="l12286"></a>12286             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(user, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae233a3edc609990a3402d03d4ddd5f1e">IAX_IMMEDIATE</a>);
<a name="l12287"></a>12287          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;jitterbuffer&quot;</span>)) {
<a name="l12288"></a>12288             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(user, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>);
<a name="l12289"></a>12289          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forcejitterbuffer&quot;</span>)) {
<a name="l12290"></a>12290             <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(user, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);
<a name="l12291"></a>12291          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;dbsecret&quot;</span>)) {
<a name="l12292"></a>12292             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, dbsecret, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12293"></a>12293          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;secret&quot;</span>)) {
<a name="l12294"></a>12294             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;secret)) {
<a name="l12295"></a>12295                <span class="keywordtype">char</span> *old = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(user-&gt;secret);
<a name="l12296"></a>12296 
<a name="l12297"></a>12297                <a class="code" href="stringfields_8h.html#a8b9f4347fc72720cc5cead952b54abe9" title="Set a field to a complex (built) value.">ast_string_field_build</a>(user, <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, <span class="stringliteral">&quot;%s;%s&quot;</span>, old, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12298"></a>12298             } <span class="keywordflow">else</span>
<a name="l12299"></a>12299                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12300"></a>12300          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerid&quot;</span>)) {
<a name="l12301"></a>12301             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) &amp;&amp; strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;asreceived&quot;</span>)) {
<a name="l12302"></a>12302                <span class="keywordtype">char</span> name2[80];
<a name="l12303"></a>12303                <span class="keywordtype">char</span> num2[80];
<a name="l12304"></a>12304                <a class="code" href="callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, name2, <span class="keyword">sizeof</span>(name2), num2, <span class="keyword">sizeof</span>(num2));
<a name="l12305"></a>12305                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, name2);
<a name="l12306"></a>12306                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, num2);
<a name="l12307"></a>12307                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12308"></a>12308             } <span class="keywordflow">else</span> {
<a name="l12309"></a>12309                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12310"></a>12310                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12311"></a>12311                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12312"></a>12312             }
<a name="l12313"></a>12313          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;fullname&quot;</span>)) {
<a name="l12314"></a>12314             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12315"></a>12315                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12316"></a>12316                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12317"></a>12317             } <span class="keywordflow">else</span> {
<a name="l12318"></a>12318                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12319"></a>12319                <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;cid_num))
<a name="l12320"></a>12320                   <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12321"></a>12321             }
<a name="l12322"></a>12322          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cid_number&quot;</span>)) {
<a name="l12323"></a>12323             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12324"></a>12324                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12325"></a>12325                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12326"></a>12326             } <span class="keywordflow">else</span> {
<a name="l12327"></a>12327                <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12328"></a>12328                <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;cid_name))
<a name="l12329"></a>12329                   <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab828fb2726323e2664dda14a68097513">IAX_HASCALLERID</a>);
<a name="l12330"></a>12330             }
<a name="l12331"></a>12331          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;accountcode&quot;</span>)) {
<a name="l12332"></a>12332             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, accountcode, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12333"></a>12333          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mohinterpret&quot;</span>)) {
<a name="l12334"></a>12334             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, mohinterpret, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12335"></a>12335          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mohsuggest&quot;</span>)) {
<a name="l12336"></a>12336             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, mohsuggest, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12337"></a>12337          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkinglot&quot;</span>)) {
<a name="l12338"></a>12338             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, <a class="code" href="chan__dahdi_8c.html#ac59e01fcfbc9801f87f28f6b60957a24">parkinglot</a>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12339"></a>12339          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;language&quot;</span>)) {
<a name="l12340"></a>12340             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, language, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12341"></a>12341          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;amaflags&quot;</span>)) {
<a name="l12342"></a>12342             format = <a class="code" href="cdr_8h.html#a5c2d2dee484a1ad9dbef128c11a2b693" title="Convert a string to a detail record AMA flag.">ast_cdr_amaflags2int</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12343"></a>12343             <span class="keywordflow">if</span> (format &lt; 0) {
<a name="l12344"></a>12344                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid AMA Flags: %s at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12345"></a>12345             } <span class="keywordflow">else</span> {
<a name="l12346"></a>12346                user-&gt;<a class="code" href="structiax2__user.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> = format;
<a name="l12347"></a>12347             }
<a name="l12348"></a>12348          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;inkeys&quot;</span>)) {
<a name="l12349"></a>12349             <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(user, inkeys, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12350"></a>12350          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxauthreq&quot;</span>)) {
<a name="l12351"></a>12351             user-&gt;<a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a> = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12352"></a>12352             <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a> &lt; 0)
<a name="l12353"></a>12353                user-&gt;<a class="code" href="structiax2__user.html#a9eba23c66306b7c3c996716efa20e54c">maxauthreq</a> = 0;
<a name="l12354"></a>12354          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;adsi&quot;</span>)) {
<a name="l12355"></a>12355             user-&gt;<a class="code" href="structiax2__user.html#a61fbadf21e15a109d0703a01e0302535">adsi</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12356"></a>12356          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;requirecalltoken&quot;</span>)) {
<a name="l12357"></a>12357             <span class="comment">/* default is required unless in optional ip list */</span>
<a name="l12358"></a>12358             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12359"></a>12359                user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a7ee00866dc8402f0f253e0f8fff829fd" title="Do not require call token validation.">CALLTOKEN_NO</a>;
<a name="l12360"></a>12360             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;auto&quot;</span>)) {
<a name="l12361"></a>12361                user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32a6d0ae3176fe25376095ae209ba14f9c8" title="Require call token validation after a successful registration using call token validation...">CALLTOKEN_AUTO</a>;
<a name="l12362"></a>12362             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12363"></a>12363                user-&gt;<a class="code" href="structiax2__user.html#a380f24fa930eb8dcec416f88a1f4c1d5">calltoken_required</a> = <a class="code" href="chan__iax2_8c.html#ab64897115d348e74e800003dc6179b32ac43f1bb50e850299e42dfdf5740a16b8" title="Require call token validation.">CALLTOKEN_YES</a>;
<a name="l12364"></a>12364             } <span class="keywordflow">else</span> {
<a name="l12365"></a>12365                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;requirecalltoken must be set to a valid value. at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12366"></a>12366             }
<a name="l12367"></a>12367          } <span class="comment">/* else if (strcasecmp(v-&gt;name,&quot;type&quot;)) */</span>
<a name="l12368"></a>12368          <span class="comment">/* ast_log(LOG_WARNING, &quot;Ignoring %s\n&quot;, v-&gt;name); */</span>
<a name="l12369"></a>12369          v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l12370"></a>12370          <span class="keywordflow">if</span> (!v) {
<a name="l12371"></a>12371             v = alt;
<a name="l12372"></a>12372             alt = NULL;
<a name="l12373"></a>12373          }
<a name="l12374"></a>12374       }
<a name="l12375"></a>12375       <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a>) {
<a name="l12376"></a>12376          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;secret)) {
<a name="l12377"></a>12377             user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a> | <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>;
<a name="l12378"></a>12378             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;inkeys))
<a name="l12379"></a>12379                user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> |= <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>;
<a name="l12380"></a>12380          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user-&gt;inkeys)) {
<a name="l12381"></a>12381             user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = <a class="code" href="iax2_8h.html#a70c580688cfaedc045d55a4845960606">IAX_AUTH_RSA</a>;
<a name="l12382"></a>12382          } <span class="keywordflow">else</span> {
<a name="l12383"></a>12383             user-&gt;<a class="code" href="structiax2__user.html#a44e1af79710bde3faee0bd22a14d5b68">authmethods</a> = <a class="code" href="iax2_8h.html#a85bed6158b274000027aa4f65a938b60">IAX_AUTH_MD5</a> | <a class="code" href="iax2_8h.html#ac32a1f34009aaf828bd9da838618fa82">IAX_AUTH_PLAINTEXT</a>;
<a name="l12384"></a>12384          }
<a name="l12385"></a>12385       }
<a name="l12386"></a>12386       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>);
<a name="l12387"></a>12387    }
<a name="l12388"></a>12388 <a class="code" href="pbx__gtkconsole_8c.html#ae553432d9c2050cb69863126759710e4">cleanup</a>:
<a name="l12389"></a>12389    <span class="keywordflow">if</span> (oldha)
<a name="l12390"></a>12390       <a class="code" href="acl_8h.html#a45dc427430b544afc0ef8e898b2c57bf" title="Free host access list.">ast_free_ha</a>(oldha);
<a name="l12391"></a>12391    <span class="keywordflow">if</span> (oldcon)
<a name="l12392"></a>12392       <a class="code" href="chan__iax2_8c.html#a6c9d0d86254e4846c77b5b83054bf7d6">free_context</a>(oldcon);
<a name="l12393"></a>12393    <span class="keywordflow">return</span> user;
<a name="l12394"></a>12394 }
<a name="l12395"></a>12395 
<a name="l12396"></a><a class="code" href="chan__iax2_8c.html#ab33f5681ca3f41ce8c86202749dd1834">12396</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab33f5681ca3f41ce8c86202749dd1834">peer_delme_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structiax2__user.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l12397"></a>12397 {
<a name="l12398"></a>12398    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = obj;
<a name="l12399"></a>12399 
<a name="l12400"></a>12400    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>);
<a name="l12401"></a>12401 
<a name="l12402"></a>12402    <span class="keywordflow">return</span> 0;
<a name="l12403"></a>12403 }
<a name="l12404"></a>12404 
<a name="l12405"></a><a class="code" href="chan__iax2_8c.html#a2bab0ba77f6ee8335bc6a3258f384444">12405</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2bab0ba77f6ee8335bc6a3258f384444">user_delme_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l12406"></a>12406 {
<a name="l12407"></a>12407    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = obj;
<a name="l12408"></a>12408 
<a name="l12409"></a>12409    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>);
<a name="l12410"></a>12410 
<a name="l12411"></a>12411    <span class="keywordflow">return</span> 0;
<a name="l12412"></a>12412 }
<a name="l12413"></a>12413 
<a name="l12414"></a><a class="code" href="chan__iax2_8c.html#ace322a3e8008af8b872b72770e97fa85">12414</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#ace322a3e8008af8b872b72770e97fa85">delete_users</a>(<span class="keywordtype">void</span>)
<a name="l12415"></a>12415 {
<a name="l12416"></a>12416    <span class="keyword">struct </span>iax2_registry *reg;
<a name="l12417"></a>12417 
<a name="l12418"></a>12418    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(users, 0, <a class="code" href="chan__iax2_8c.html#a2bab0ba77f6ee8335bc6a3258f384444">user_delme_cb</a>, NULL);
<a name="l12419"></a>12419 
<a name="l12420"></a>12420    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;registrations);
<a name="l12421"></a>12421    <span class="keywordflow">while</span> ((reg = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;registrations, entry))) {
<a name="l12422"></a>12422       <span class="keywordflow">if</span> (sched) {
<a name="l12423"></a>12423          <a class="code" href="sched_8h.html#a9b0b3840f944b8ac512d88f1f0f44a12" title="Delete a scheduler entry.">ast_sched_thread_del</a>(sched, reg-&gt;<a class="code" href="structiax2__registry.html#a2f16194304829daa3f050ba49f218b5f">expire</a>);
<a name="l12424"></a>12424       }
<a name="l12425"></a>12425       <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>) {
<a name="l12426"></a>12426          <span class="keywordtype">int</span> <a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a> = reg-&gt;<a class="code" href="structiax2__registry.html#a12650384da62fe82303630ca19410f2b">callno</a>;
<a name="l12427"></a>12427          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l12428"></a>12428          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]) {
<a name="l12429"></a>12429             <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#ac9677ae320c8bee8dcaf05d9a457eb19">reg</a> = NULL;
<a name="l12430"></a>12430             <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(callno);
<a name="l12431"></a>12431          }
<a name="l12432"></a>12432          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l12433"></a>12433       }
<a name="l12434"></a>12434       <span class="keywordflow">if</span> (reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>)
<a name="l12435"></a>12435          <a class="code" href="dnsmgr_8h.html#a0255399a507b71ae563fc2caf94d749c" title="Free a DNS manager entry.">ast_dnsmgr_release</a>(reg-&gt;<a class="code" href="structiax2__registry.html#a1d619f88ef3c4da09a9a6cc4b0d271f1">dnsmgr</a>);
<a name="l12436"></a>12436       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(reg);
<a name="l12437"></a>12437    }
<a name="l12438"></a>12438    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;registrations);
<a name="l12439"></a>12439 
<a name="l12440"></a>12440    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(peers, 0, <a class="code" href="chan__iax2_8c.html#ab33f5681ca3f41ce8c86202749dd1834">peer_delme_cb</a>, NULL);
<a name="l12441"></a>12441 }
<a name="l12442"></a>12442 
<a name="l12443"></a><a class="code" href="chan__iax2_8c.html#a64dccf856273fe23ad33955a0a491bc2">12443</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a64dccf856273fe23ad33955a0a491bc2">prune_users</a>(<span class="keywordtype">void</span>)
<a name="l12444"></a>12444 {
<a name="l12445"></a>12445    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l12446"></a>12446    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l12447"></a>12447 
<a name="l12448"></a>12448    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(users, 0);
<a name="l12449"></a>12449    <span class="keywordflow">while</span> ((user = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l12450"></a>12450       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>) || <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(user, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)) {
<a name="l12451"></a>12451          <a class="code" href="astobj2_8h.html#a1bd301bcff8b41c07adbecf93eb7dce7">ao2_unlink</a>(users, user);
<a name="l12452"></a>12452       }
<a name="l12453"></a>12453       <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l12454"></a>12454    }
<a name="l12455"></a>12455    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l12456"></a>12456 }
<a name="l12457"></a>12457 
<a name="l12458"></a>12458 <span class="comment">/* Prune peers who still are supposed to be deleted */</span>
<a name="l12459"></a><a class="code" href="chan__iax2_8c.html#a55c82d81ce37ebe5125d5a017c12b5ac">12459</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a55c82d81ce37ebe5125d5a017c12b5ac">prune_peers</a>(<span class="keywordtype">void</span>)
<a name="l12460"></a>12460 {
<a name="l12461"></a>12461    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l12462"></a>12462    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l12463"></a>12463 
<a name="l12464"></a>12464    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l12465"></a>12465    <span class="keywordflow">while</span> ((peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l12466"></a>12466       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae9a929f7e28b5f7006038c1789351586">IAX_DELME</a>) || <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>)) {
<a name="l12467"></a>12467          <a class="code" href="chan__iax2_8c.html#a9bc5565f824594fb78b237f40e83d2de">unlink_peer</a>(peer);
<a name="l12468"></a>12468       }
<a name="l12469"></a>12469       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l12470"></a>12470    }
<a name="l12471"></a>12471    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l12472"></a>12472 }
<a name="l12473"></a>12473 
<a name="l12474"></a><a class="code" href="chan__iax2_8c.html#aa470820922e204a3784dabb6c16fa6b1">12474</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#aa470820922e204a3784dabb6c16fa6b1">set_config_destroy</a>(<span class="keywordtype">void</span>)
<a name="l12475"></a>12475 {
<a name="l12476"></a>12476    strcpy(accountcode, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12477"></a>12477    strcpy(language, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12478"></a>12478    strcpy(mohinterpret, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l12479"></a>12479    strcpy(mohsuggest, <span class="stringliteral">&quot;&quot;</span>);
<a name="l12480"></a>12480    trunkmaxsize = <a class="code" href="chan__iax2_8c.html#a69dd6fc2ce3f24790dffff13d25173c5">MAX_TRUNKDATA</a>;
<a name="l12481"></a>12481    amaflags = 0;
<a name="l12482"></a>12482    delayreject = 0;
<a name="l12483"></a>12483    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>); 
<a name="l12484"></a>12484    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>); 
<a name="l12485"></a>12485    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>);  
<a name="l12486"></a>12486    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);   
<a name="l12487"></a>12487    <a class="code" href="chan__iax2_8c.html#ace322a3e8008af8b872b72770e97fa85">delete_users</a>();
<a name="l12488"></a>12488    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(callno_limits, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="chan__iax2_8c.html#acc5f9a0b1f47c10c3546402833026464">addr_range_delme_cb</a>, NULL);
<a name="l12489"></a>12489    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(calltoken_ignores, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="chan__iax2_8c.html#acc5f9a0b1f47c10c3546402833026464">addr_range_delme_cb</a>, NULL);
<a name="l12490"></a>12490 }
<a name="l12491"></a>12491 <span class="comment"></span>
<a name="l12492"></a>12492 <span class="comment">/*! \brief Load configuration */</span>
<a name="l12493"></a><a class="code" href="chan__iax2_8c.html#a588a54300638eba856f40104139c3986">12493</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a588a54300638eba856f40104139c3986" title="Load configuration.">set_config</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#ac269be8b91ae4b24df48de5d8ad7e7a7">config_file</a>, <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l12494"></a>12494 {
<a name="l12495"></a>12495    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg, *ucfg;
<a name="l12496"></a>12496    <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>=iax2_capability;
<a name="l12497"></a>12497    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l12498"></a>12498    <span class="keywordtype">char</span> *cat;
<a name="l12499"></a>12499    <span class="keyword">const</span> <span class="keywordtype">char</span> *utype;
<a name="l12500"></a>12500    <span class="keyword">const</span> <span class="keywordtype">char</span> *tosval;
<a name="l12501"></a>12501    <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>;
<a name="l12502"></a>12502    <span class="keywordtype">int</span> portno = <a class="code" href="iax2_8h.html#a365c31cb55cacdeec11d6d4a7e24edc4">IAX_DEFAULT_PORTNO</a>;
<a name="l12503"></a>12503    <span class="keywordtype">int</span>  x;
<a name="l12504"></a>12504    <span class="keywordtype">int</span> mtuv; 
<a name="l12505"></a>12505    <span class="keyword">struct </span><a class="code" href="structiax2__user.html">iax2_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l12506"></a>12506    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l12507"></a>12507    <span class="keyword">struct </span><a class="code" href="structast__netsock.html">ast_netsock</a> *ns;
<a name="l12508"></a>12508    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l12509"></a>12509 <span class="preprocessor">#if 0</span>
<a name="l12510"></a>12510 <span class="preprocessor"></span>   <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <span class="keywordtype">int</span> last_port=0;
<a name="l12511"></a>12511 <span class="preprocessor">#endif</span>
<a name="l12512"></a>12512 <span class="preprocessor"></span>
<a name="l12513"></a>12513    cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config_file, config_flags);
<a name="l12514"></a>12514 
<a name="l12515"></a>12515    <span class="keywordflow">if</span> (!cfg) {
<a name="l12516"></a>12516       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to load config %s\n&quot;</span>, config_file);
<a name="l12517"></a>12517       <span class="keywordflow">return</span> -1;
<a name="l12518"></a>12518    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l12519"></a>12519       ucfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags);
<a name="l12520"></a>12520       <span class="keywordflow">if</span> (ucfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>)
<a name="l12521"></a>12521          <span class="keywordflow">return</span> 0;
<a name="l12522"></a>12522       <span class="comment">/* Otherwise we need to reread both files */</span>
<a name="l12523"></a>12523       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;config_flags, <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a>);
<a name="l12524"></a>12524       <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(config_file, config_flags)) == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l12525"></a>12525          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file %s is in an invalid format.  Aborting.\n&quot;</span>, config_file);
<a name="l12526"></a>12526          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(ucfg);
<a name="l12527"></a>12527          <span class="keywordflow">return</span> 0;
<a name="l12528"></a>12528       }
<a name="l12529"></a>12529    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l12530"></a>12530       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file %s is in an invalid format.  Aborting.\n&quot;</span>, config_file);
<a name="l12531"></a>12531       <span class="keywordflow">return</span> 0;
<a name="l12532"></a>12532    } <span class="keywordflow">else</span> { <span class="comment">/* iax.conf changed, gotta reread users.conf, too */</span>
<a name="l12533"></a>12533       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;config_flags, <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a>);
<a name="l12534"></a>12534       <span class="keywordflow">if</span> ((ucfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l12535"></a>12535          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file users.conf is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l12536"></a>12536          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l12537"></a>12537          <span class="keywordflow">return</span> 0;
<a name="l12538"></a>12538       }
<a name="l12539"></a>12539    }
<a name="l12540"></a>12540 
<a name="l12541"></a>12541    <span class="keywordflow">if</span> (reload) {
<a name="l12542"></a>12542       <a class="code" href="chan__iax2_8c.html#aa470820922e204a3784dabb6c16fa6b1">set_config_destroy</a>();
<a name="l12543"></a>12543    }
<a name="l12544"></a>12544 
<a name="l12545"></a>12545    <span class="comment">/* Reset global codec prefs */</span>   
<a name="l12546"></a>12546    memset(&amp;<a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, 0 , <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a>));
<a name="l12547"></a>12547    
<a name="l12548"></a>12548    <span class="comment">/* Reset Global Flags */</span>
<a name="l12549"></a>12549    memset(&amp;globalflags, 0, <span class="keyword">sizeof</span>(globalflags));
<a name="l12550"></a>12550    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba3b832a927807f0e518e9e18fee76d3a6">IAX_RTUPDATE</a>);
<a name="l12551"></a>12551    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;globalflags, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae22e2b945ef6ffda9b550fbb2a6787ce">IAX_SHRINKCALLERID</a>);
<a name="l12552"></a>12552 
<a name="l12553"></a>12553 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l12554"></a>12554 <span class="preprocessor"></span>   nochecksums = 0;
<a name="l12555"></a>12555 <span class="preprocessor">#endif</span>
<a name="l12556"></a>12556 <span class="preprocessor"></span>   <span class="comment">/* Reset default parking lot */</span>
<a name="l12557"></a>12557    default_parkinglot[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l12558"></a>12558 
<a name="l12559"></a>12559    min_reg_expire = <a class="code" href="iax2_8h.html#a5fc5c0b246090e6ebf9245897d979e21">IAX_DEFAULT_REG_EXPIRE</a>;
<a name="l12560"></a>12560    max_reg_expire = <a class="code" href="iax2_8h.html#a5fc5c0b246090e6ebf9245897d979e21">IAX_DEFAULT_REG_EXPIRE</a>;
<a name="l12561"></a>12561    global_max_trunk_mtu = <a class="code" href="chan__iax2_8c.html#a48a4382bfd50a02e75939c5ac05e25eb" title="Maximum transmission unit for the UDP packet in the trunk not to be fragmented. This...">MAX_TRUNK_MTU</a>;
<a name="l12562"></a>12562    global_maxcallno = DEFAULT_MAXCALLNO_LIMIT;
<a name="l12563"></a>12563    global_maxcallno_nonval = DEFAULT_MAXCALLNO_LIMIT_NONVAL;
<a name="l12564"></a>12564 
<a name="l12565"></a>12565    maxauthreq = 3;
<a name="l12566"></a>12566 
<a name="l12567"></a>12567    srvlookup = 0;
<a name="l12568"></a>12568 
<a name="l12569"></a>12569    v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>);
<a name="l12570"></a>12570 
<a name="l12571"></a>12571    <span class="comment">/* Seed initial tos value */</span>
<a name="l12572"></a>12572    tosval = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tos&quot;</span>);
<a name="l12573"></a>12573    <span class="keywordflow">if</span> (tosval) {
<a name="l12574"></a>12574       <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#a49d1eefe77636e2a63ad013afa0fc3b5">ast_str2tos</a>(tosval, &amp;<a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.tos))
<a name="l12575"></a>12575          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid tos value, refer to QoS documentation\n&quot;</span>);
<a name="l12576"></a>12576    }
<a name="l12577"></a>12577    <span class="comment">/* Seed initial cos value */</span>
<a name="l12578"></a>12578    tosval = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;cos&quot;</span>);
<a name="l12579"></a>12579    <span class="keywordflow">if</span> (tosval) {
<a name="l12580"></a>12580       <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#ad364a9241e15fc0dbec0ffcb88f64671">ast_str2cos</a>(tosval, &amp;<a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.cos))
<a name="l12581"></a>12581          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid cos value, refer to QoS documentation\n&quot;</span>);
<a name="l12582"></a>12582    }
<a name="l12583"></a>12583    <span class="keywordflow">while</span>(v) {
<a name="l12584"></a>12584       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bindport&quot;</span>)){ 
<a name="l12585"></a>12585          <span class="keywordflow">if</span> (reload)
<a name="l12586"></a>12586             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Ignoring bindport on reload\n&quot;</span>);
<a name="l12587"></a>12587          <span class="keywordflow">else</span>
<a name="l12588"></a>12588             portno = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12589"></a>12589       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pingtime&quot;</span>)) 
<a name="l12590"></a>12590          ping_time = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12591"></a>12591       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;iaxthreadcount&quot;</span>)) {
<a name="l12592"></a>12592          <span class="keywordflow">if</span> (reload) {
<a name="l12593"></a>12593             <span class="keywordflow">if</span> (atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) != <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a>)
<a name="l12594"></a>12594                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Ignoring any changes to iaxthreadcount during reload\n&quot;</span>);
<a name="l12595"></a>12595          } <span class="keywordflow">else</span> {
<a name="l12596"></a>12596             <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a> = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12597"></a>12597             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a> &lt; 1) {
<a name="l12598"></a>12598                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;iaxthreadcount must be at least 1.\n&quot;</span>);
<a name="l12599"></a>12599                <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a> = 1;
<a name="l12600"></a>12600             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a> &gt; 256) {
<a name="l12601"></a>12601                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;limiting iaxthreadcount to 256\n&quot;</span>);
<a name="l12602"></a>12602                <a class="code" href="chan__iax2_8c.html#a0340d1fbb87d73ec0b84e0da7c2efb7f">iaxthreadcount</a> = 256;
<a name="l12603"></a>12603             }
<a name="l12604"></a>12604          }
<a name="l12605"></a>12605       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;iaxmaxthreadcount&quot;</span>)) {
<a name="l12606"></a>12606          <span class="keywordflow">if</span> (reload) {
<a name="l12607"></a>12607             <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l12608"></a>12608             <a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12609"></a>12609             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l12610"></a>12610          } <span class="keywordflow">else</span> {
<a name="l12611"></a>12611             <a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12612"></a>12612             <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> &lt; 0) {
<a name="l12613"></a>12613                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;iaxmaxthreadcount must be at least 0.\n&quot;</span>);
<a name="l12614"></a>12614                <a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> = 0;
<a name="l12615"></a>12615             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> &gt; 256) {
<a name="l12616"></a>12616                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Limiting iaxmaxthreadcount to 256\n&quot;</span>);
<a name="l12617"></a>12617                <a class="code" href="chan__iax2_8c.html#afcd79d8ab168fee3f2d1d1b50672a952">iaxmaxthreadcount</a> = 256;
<a name="l12618"></a>12618             }
<a name="l12619"></a>12619          }
<a name="l12620"></a>12620       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;nochecksums&quot;</span>)) {
<a name="l12621"></a>12621 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l12622"></a>12622 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l12623"></a>12623             nochecksums = 1;
<a name="l12624"></a>12624          <span class="keywordflow">else</span>
<a name="l12625"></a>12625             nochecksums = 0;
<a name="l12626"></a>12626 <span class="preprocessor">#else</span>
<a name="l12627"></a>12627 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>))
<a name="l12628"></a>12628             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Disabling RTP checksums is not supported on this operating system!\n&quot;</span>);
<a name="l12629"></a>12629 <span class="preprocessor">#endif</span>
<a name="l12630"></a>12630 <span class="preprocessor"></span>      }
<a name="l12631"></a>12631       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxjitterbuffer&quot;</span>)) 
<a name="l12632"></a>12632          maxjitterbuffer = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12633"></a>12633       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;resyncthreshold&quot;</span>)) 
<a name="l12634"></a>12634          resyncthreshold = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12635"></a>12635       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxjitterinterps&quot;</span>)) 
<a name="l12636"></a>12636          maxjitterinterps = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12637"></a>12637       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;jittertargetextra&quot;</span>))
<a name="l12638"></a>12638          jittertargetextra = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12639"></a>12639       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;lagrqtime&quot;</span>)) 
<a name="l12640"></a>12640          lagrq_time = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12641"></a>12641       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxregexpire&quot;</span>)) 
<a name="l12642"></a>12642          max_reg_expire = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12643"></a>12643       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;minregexpire&quot;</span>)) 
<a name="l12644"></a>12644          min_reg_expire = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12645"></a>12645       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bindaddr&quot;</span>)) {
<a name="l12646"></a>12646          <span class="keywordflow">if</span> (reload) {
<a name="l12647"></a>12647             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Ignoring bindaddr on reload\n&quot;</span>);
<a name="l12648"></a>12648          } <span class="keywordflow">else</span> {
<a name="l12649"></a>12649             <span class="keywordflow">if</span> (!(ns = <a class="code" href="netsock_8h.html#aec80b0539f9de617c6d5cf08d4c6b5d7">ast_netsock_bind</a>(netsock, io, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, portno, <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.tos, <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.cos, <a class="code" href="chan__iax2_8c.html#ab30ccbd9565b8d995633142a78e63956">socket_read</a>, NULL))) {
<a name="l12650"></a>12650                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable apply binding to &apos;%s&apos; at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12651"></a>12651             } <span class="keywordflow">else</span> {
<a name="l12652"></a>12652                   <span class="keywordflow">if</span> (strchr(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="charliteral">&apos;:&apos;</span>))
<a name="l12653"></a>12653                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Binding IAX2 to &apos;%s&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12654"></a>12654                   <span class="keywordflow">else</span>
<a name="l12655"></a>12655                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Binding IAX2 to &apos;%s:%d&apos;\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, portno);
<a name="l12656"></a>12656                <span class="keywordflow">if</span> (defaultsockfd &lt; 0) 
<a name="l12657"></a>12657                   defaultsockfd = <a class="code" href="netsock_8h.html#a9bd7ad8830fd7017a855f852341f0266">ast_netsock_sockfd</a>(ns);
<a name="l12658"></a>12658                <a class="code" href="netsock_8h.html#a8a8cd7e2d5d9e1b67353fe28e45324ec">ast_netsock_unref</a>(ns);
<a name="l12659"></a>12659             }
<a name="l12660"></a>12660          }
<a name="l12661"></a>12661       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;authdebug&quot;</span>)) {
<a name="l12662"></a>12662          authdebug = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12663"></a>12663       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;encryption&quot;</span>)) {
<a name="l12664"></a>12664             iax2_encryption |= <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12665"></a>12665             <span class="keywordflow">if</span> (!iax2_encryption) {
<a name="l12666"></a>12666                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l12667"></a>12667             }
<a name="l12668"></a>12668       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forceencryption&quot;</span>)) {
<a name="l12669"></a>12669          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12670"></a>12670             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l12671"></a>12671          } <span class="keywordflow">else</span> {
<a name="l12672"></a>12672             iax2_encryption |= <a class="code" href="chan__iax2_8c.html#ab6fb11229481f17355002ad11993ccd6">get_encrypt_methods</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12673"></a>12673             <span class="keywordflow">if</span> (iax2_encryption) {
<a name="l12674"></a>12674                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8d4ab42b55612b072249e0570e94fbef">IAX_FORCE_ENCRYPT</a>);
<a name="l12675"></a>12675             }
<a name="l12676"></a>12676          }
<a name="l12677"></a>12677       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;transfer&quot;</span>)) {
<a name="l12678"></a>12678          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;mediaonly&quot;</span>)) {
<a name="l12679"></a>12679             <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>); 
<a name="l12680"></a>12680          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12681"></a>12681             <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, 0);
<a name="l12682"></a>12682          } <span class="keywordflow">else</span> 
<a name="l12683"></a>12683             <a class="code" href="utils_8h.html#af369c4577c71400e8bf7924d8b12ad3f">ast_set_flags_to</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>|<a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba2c9e498de7b6d391e5c2e2148f618a84">IAX_TRANSFERMEDIA</a>, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba1bf4965433f48b4151c8a99f89ac3dd2">IAX_NOTRANSFER</a>);
<a name="l12684"></a>12684       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;codecpriority&quot;</span>)) {
<a name="l12685"></a>12685          <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;caller&quot;</span>))
<a name="l12686"></a>12686             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebad9c203eb75ed6e4901e3008e514eedc8">IAX_CODEC_USER_FIRST</a>);
<a name="l12687"></a>12687          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;disabled&quot;</span>))
<a name="l12688"></a>12688             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>);
<a name="l12689"></a>12689          <span class="keywordflow">else</span> <span class="keywordflow">if</span>(!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;reqonly&quot;</span>)) {
<a name="l12690"></a>12690             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba35e8dfbd9ac80796f2f86fc1fe7f03f5">IAX_CODEC_NOCAP</a>);
<a name="l12691"></a>12691             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba699c61fe9eb6ffe30e51f1b3084222a5">IAX_CODEC_NOPREFS</a>);
<a name="l12692"></a>12692          }
<a name="l12693"></a>12693       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;jitterbuffer&quot;</span>))
<a name="l12694"></a>12694          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba701365757eb1c46f2ff605ab7006c642">IAX_USEJITTERBUF</a>); 
<a name="l12695"></a>12695       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forcejitterbuffer&quot;</span>))
<a name="l12696"></a>12696          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba23e88b6392c3e4bb36d636d28909355b">IAX_FORCEJITTERBUF</a>);  
<a name="l12697"></a>12697       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;delayreject&quot;</span>))
<a name="l12698"></a>12698          delayreject = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12699"></a>12699       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allowfwdownload&quot;</span>))
<a name="l12700"></a>12700          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba481a383cdd29d94527853f60bf6516cd">IAX_ALLOWFWDOWNLOAD</a>);
<a name="l12701"></a>12701       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;rtcachefriends&quot;</span>))
<a name="l12702"></a>12702          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebabc9d06cf0be3fed64427ea1355d3d588">IAX_RTCACHEFRIENDS</a>);  
<a name="l12703"></a>12703       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;rtignoreregexpire&quot;</span>))
<a name="l12704"></a>12704          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebab6a1016b2b84bd5d410a1a9d6994deb1">IAX_RTIGNOREREGEXPIRE</a>);  
<a name="l12705"></a>12705       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;rtupdate&quot;</span>))
<a name="l12706"></a>12706          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba3b832a927807f0e518e9e18fee76d3a6">IAX_RTUPDATE</a>);
<a name="l12707"></a>12707       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunktimestamps&quot;</span>))
<a name="l12708"></a>12708          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;globalflags, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba0af69b242af8f9f71d7c94452ce86088">IAX_TRUNKTIMESTAMPS</a>);
<a name="l12709"></a>12709       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;rtautoclear&quot;</span>)) {
<a name="l12710"></a>12710          <span class="keywordtype">int</span> i = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12711"></a>12711          <span class="keywordflow">if</span>(i &gt; 0)
<a name="l12712"></a>12712             global_rtautoclear = i;
<a name="l12713"></a>12713          <span class="keywordflow">else</span>
<a name="l12714"></a>12714             i = 0;
<a name="l12715"></a>12715          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;globalflags), i || <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebaa0df0270f5a528a175ba099e7e1f4826">IAX_RTAUTOCLEAR</a>);   
<a name="l12716"></a>12716       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunkfreq&quot;</span>)) {
<a name="l12717"></a>12717          trunkfreq = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12718"></a>12718          <span class="keywordflow">if</span> (trunkfreq &lt; 10)
<a name="l12719"></a>12719             trunkfreq = 10;
<a name="l12720"></a>12720       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunkmtu&quot;</span>)) {
<a name="l12721"></a>12721          mtuv = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12722"></a>12722          <span class="keywordflow">if</span> (mtuv  == 0 )  
<a name="l12723"></a>12723             global_max_trunk_mtu = 0; 
<a name="l12724"></a>12724          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (mtuv &gt;= 172 &amp;&amp; mtuv &lt; 4000) 
<a name="l12725"></a>12725             global_max_trunk_mtu = mtuv; 
<a name="l12726"></a>12726          <span class="keywordflow">else</span> 
<a name="l12727"></a>12727             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;trunkmtu value out of bounds (%d) at line %d\n&quot;</span>,
<a name="l12728"></a>12728                mtuv, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12729"></a>12729       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunkmaxsize&quot;</span>)) {
<a name="l12730"></a>12730          trunkmaxsize = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12731"></a>12731          <span class="keywordflow">if</span> (trunkmaxsize == 0)
<a name="l12732"></a>12732             trunkmaxsize = <a class="code" href="chan__iax2_8c.html#a69dd6fc2ce3f24790dffff13d25173c5">MAX_TRUNKDATA</a>;
<a name="l12733"></a>12733       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autokill&quot;</span>)) {
<a name="l12734"></a>12734          <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l12735"></a>12735             <span class="keywordflow">if</span> (x &gt;= 0)
<a name="l12736"></a>12736                autokill = x;
<a name="l12737"></a>12737             <span class="keywordflow">else</span>
<a name="l12738"></a>12738                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Nice try, but autokill has to be &gt;0 or &apos;yes&apos; or &apos;no&apos; at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12739"></a>12739          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12740"></a>12740             autokill = <a class="code" href="chan__iax2_8c.html#a960e3be6d1f16d936afd3d6fba7f31b0">DEFAULT_MAXMS</a>;
<a name="l12741"></a>12741          } <span class="keywordflow">else</span> {
<a name="l12742"></a>12742             autokill = 0;
<a name="l12743"></a>12743          }
<a name="l12744"></a>12744       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bandwidth&quot;</span>)) {
<a name="l12745"></a>12745          <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;low&quot;</span>)) {
<a name="l12746"></a>12746             capability = <a class="code" href="chan__iax2_8c.html#ad73ac99e59386b240b2ce221f5647a01">IAX_CAPABILITY_LOWBANDWIDTH</a>;
<a name="l12747"></a>12747          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;medium&quot;</span>)) {
<a name="l12748"></a>12748             capability = <a class="code" href="chan__iax2_8c.html#ac37936cf32e98fb7a03973cfacb39214">IAX_CAPABILITY_MEDBANDWIDTH</a>;
<a name="l12749"></a>12749          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;high&quot;</span>)) {
<a name="l12750"></a>12750             capability = <a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">IAX_CAPABILITY_FULLBANDWIDTH</a>;
<a name="l12751"></a>12751          } <span class="keywordflow">else</span>
<a name="l12752"></a>12752             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;bandwidth must be either low, medium, or high\n&quot;</span>);
<a name="l12753"></a>12753       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;allow&quot;</span>)) {
<a name="l12754"></a>12754          <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;<a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;capability, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 1);
<a name="l12755"></a>12755       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;disallow&quot;</span>)) {
<a name="l12756"></a>12756          <a class="code" href="frame_8h.html#a35aa1fb72e1993a14156a6b912034ef9" title="Parse an &amp;quot;allow&amp;quot; or &amp;quot;deny&amp;quot; line in a channel or device configuration...">ast_parse_allow_disallow</a>(&amp;<a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, &amp;capability, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, 0);
<a name="l12757"></a>12757       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;register&quot;</span>)) {
<a name="l12758"></a>12758          <a class="code" href="chan__iax2_8c.html#a9a7339b1691a326f37bad5fd3ffe5698">iax2_register</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12759"></a>12759       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;iaxcompat&quot;</span>)) {
<a name="l12760"></a>12760          iaxcompat = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12761"></a>12761       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;regcontext&quot;</span>)) {
<a name="l12762"></a>12762          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(regcontext, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(regcontext));
<a name="l12763"></a>12763          <span class="comment">/* Create context if it doesn&apos;t exist already */</span>
<a name="l12764"></a>12764          <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, regcontext, <span class="stringliteral">&quot;IAX2&quot;</span>);
<a name="l12765"></a>12765       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;tos&quot;</span>)) {
<a name="l12766"></a>12766          <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#a49d1eefe77636e2a63ad013afa0fc3b5">ast_str2tos</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;<a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.tos))
<a name="l12767"></a>12767             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid tos value at line %d, refer to QoS documentation\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12768"></a>12768       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cos&quot;</span>)) {
<a name="l12769"></a>12769          <span class="keywordflow">if</span> (<a class="code" href="acl_8h.html#ad364a9241e15fc0dbec0ffcb88f64671">ast_str2cos</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, &amp;<a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.cos))
<a name="l12770"></a>12770             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid cos value at line %d, refer to QoS documentation\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12771"></a>12771       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;parkinglot&quot;</span>)) {
<a name="l12772"></a>12772          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(default_parkinglot, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(default_parkinglot));
<a name="l12773"></a>12773       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;accountcode&quot;</span>)) {
<a name="l12774"></a>12774          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(accountcode, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(accountcode));
<a name="l12775"></a>12775       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mohinterpret&quot;</span>)) {
<a name="l12776"></a>12776          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mohinterpret, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(mohinterpret));
<a name="l12777"></a>12777       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mohsuggest&quot;</span>)) {
<a name="l12778"></a>12778          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mohsuggest, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(mohsuggest));
<a name="l12779"></a>12779       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;amaflags&quot;</span>)) {
<a name="l12780"></a>12780          format = <a class="code" href="cdr_8h.html#a5c2d2dee484a1ad9dbef128c11a2b693" title="Convert a string to a detail record AMA flag.">ast_cdr_amaflags2int</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12781"></a>12781          <span class="keywordflow">if</span> (format &lt; 0) {
<a name="l12782"></a>12782             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid AMA Flags: %s at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12783"></a>12783          } <span class="keywordflow">else</span> {
<a name="l12784"></a>12784             amaflags = format;
<a name="l12785"></a>12785          }
<a name="l12786"></a>12786       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;language&quot;</span>)) {
<a name="l12787"></a>12787          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(language, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(language));
<a name="l12788"></a>12788       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxauthreq&quot;</span>)) {
<a name="l12789"></a>12789          maxauthreq = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12790"></a>12790          <span class="keywordflow">if</span> (maxauthreq &lt; 0)
<a name="l12791"></a>12791             maxauthreq = 0;
<a name="l12792"></a>12792       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;adsi&quot;</span>)) {
<a name="l12793"></a>12793          adsi = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12794"></a>12794       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;srvlookup&quot;</span>)) {
<a name="l12795"></a>12795          srvlookup = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l12796"></a>12796       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxcallnumbers&quot;</span>)) {
<a name="l12797"></a>12797          <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%10hu&quot;</span>, &amp;global_maxcallno) != 1) {
<a name="l12798"></a>12798             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;maxcallnumbers must be set to a valid number.  %s is not valid at line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12799"></a>12799          }
<a name="l12800"></a>12800       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxcallnumbers_nonvalidated&quot;</span>)) {
<a name="l12801"></a>12801          <span class="keywordflow">if</span> (sscanf(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%10hu&quot;</span>, &amp;global_maxcallno_nonval) != 1) {
<a name="l12802"></a>12802             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;maxcallnumbers_nonvalidated must be set to a valid number.  %s is not valid at line %d.\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12803"></a>12803          }
<a name="l12804"></a>12804       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;calltokenoptional&quot;</span>)) {
<a name="l12805"></a>12805          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a5b5143ac7f3977bd944fdcdd1589c372">add_calltoken_ignore</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12806"></a>12806             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid calltokenoptional address range - &apos;%s&apos; line %d\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12807"></a>12807          }
<a name="l12808"></a>12808       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;shrinkcallerid&quot;</span>)) {
<a name="l12809"></a>12809          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12810"></a>12810             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae22e2b945ef6ffda9b550fbb2a6787ce">IAX_SHRINKCALLERID</a>);
<a name="l12811"></a>12811          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) {
<a name="l12812"></a>12812             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;globalflags), <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feebae22e2b945ef6ffda9b550fbb2a6787ce">IAX_SHRINKCALLERID</a>);
<a name="l12813"></a>12813          } <span class="keywordflow">else</span> {
<a name="l12814"></a>12814             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;shrinkcallerid value %s is not valid at line %d.\n&quot;</span>, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, v-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l12815"></a>12815          }
<a name="l12816"></a>12816       }<span class="comment">/*else if (strcasecmp(v-&gt;name,&quot;type&quot;)) */</span>
<a name="l12817"></a>12817       <span class="comment">/* ast_log(LOG_WARNING, &quot;Ignoring %s\n&quot;, v-&gt;name); */</span>
<a name="l12818"></a>12818       v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l12819"></a>12819    }
<a name="l12820"></a>12820    
<a name="l12821"></a>12821    <span class="keywordflow">if</span> (defaultsockfd &lt; 0) {
<a name="l12822"></a>12822       <span class="keywordflow">if</span> (!(ns = <a class="code" href="netsock_8h.html#aec80b0539f9de617c6d5cf08d4c6b5d7">ast_netsock_bind</a>(netsock, io, <span class="stringliteral">&quot;0.0.0.0&quot;</span>, portno, <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.tos, <a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>.cos, <a class="code" href="chan__iax2_8c.html#ab30ccbd9565b8d995633142a78e63956">socket_read</a>, NULL))) {
<a name="l12823"></a>12823          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create network socket: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l12824"></a>12824       } <span class="keywordflow">else</span> {
<a name="l12825"></a>12825          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Binding IAX2 to default address 0.0.0.0:%d\n&quot;</span>, portno);
<a name="l12826"></a>12826          defaultsockfd = <a class="code" href="netsock_8h.html#a9bd7ad8830fd7017a855f852341f0266">ast_netsock_sockfd</a>(ns);
<a name="l12827"></a>12827          <a class="code" href="netsock_8h.html#a8a8cd7e2d5d9e1b67353fe28e45324ec">ast_netsock_unref</a>(ns);
<a name="l12828"></a>12828       }
<a name="l12829"></a>12829    }
<a name="l12830"></a>12830    <span class="keywordflow">if</span> (reload) {
<a name="l12831"></a>12831       <a class="code" href="netsock_8h.html#a13b5f6a10c9ed23a3734adca3cc4b27f">ast_netsock_release</a>(outsock);
<a name="l12832"></a>12832       outsock = <a class="code" href="netsock_8h.html#acba2bd674fc0056db3c26ee438f1b396">ast_netsock_list_alloc</a>();
<a name="l12833"></a>12833       <span class="keywordflow">if</span> (!outsock) {
<a name="l12834"></a>12834          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not allocate outsock list.\n&quot;</span>);
<a name="l12835"></a>12835          <span class="keywordflow">return</span> -1;
<a name="l12836"></a>12836       }
<a name="l12837"></a>12837       <a class="code" href="netsock_8h.html#af937c8ae665f601a3bd9802c643b6599">ast_netsock_init</a>(outsock);
<a name="l12838"></a>12838    }
<a name="l12839"></a>12839 
<a name="l12840"></a>12840    <span class="keywordflow">if</span> (min_reg_expire &gt; max_reg_expire) {
<a name="l12841"></a>12841       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Minimum registration interval of %d is more than maximum of %d, resetting minimum to %d\n&quot;</span>,
<a name="l12842"></a>12842          min_reg_expire, max_reg_expire, max_reg_expire);
<a name="l12843"></a>12843       min_reg_expire = max_reg_expire;
<a name="l12844"></a>12844    }
<a name="l12845"></a>12845    iax2_capability = capability;
<a name="l12846"></a>12846    
<a name="l12847"></a>12847    <span class="keywordflow">if</span> (ucfg) {
<a name="l12848"></a>12848       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="app__externalivr_8c.html#abe143f1bae4445e9b3798e1dec3bda60">gen</a>;
<a name="l12849"></a>12849       <span class="keywordtype">int</span> genhasiax;
<a name="l12850"></a>12850       <span class="keywordtype">int</span> genregisteriax;
<a name="l12851"></a>12851       <span class="keyword">const</span> <span class="keywordtype">char</span> *hasiax, *registeriax;
<a name="l12852"></a>12852       
<a name="l12853"></a>12853       genhasiax = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;hasiax&quot;</span>));
<a name="l12854"></a>12854       genregisteriax = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;registeriax&quot;</span>));
<a name="l12855"></a>12855       gen = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>);
<a name="l12856"></a>12856       cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(ucfg, NULL);
<a name="l12857"></a>12857       <span class="keywordflow">while</span> (cat) {
<a name="l12858"></a>12858          <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l12859"></a>12859             hasiax = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, cat, <span class="stringliteral">&quot;hasiax&quot;</span>);
<a name="l12860"></a>12860             registeriax = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, cat, <span class="stringliteral">&quot;registeriax&quot;</span>);
<a name="l12861"></a>12861             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(hasiax) || (!hasiax &amp;&amp; genhasiax)) {
<a name="l12862"></a>12862                <span class="comment">/* Start with general parameters, then specific parameters, user and peer */</span>
<a name="l12863"></a>12863                user = <a class="code" href="chan__iax2_8c.html#a4ce55a34cd5160db030be4355f7b4386" title="Create in-memory user structure from configuration.">build_user</a>(cat, gen, <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(ucfg, cat), 0);
<a name="l12864"></a>12864                <span class="keywordflow">if</span> (user) {
<a name="l12865"></a>12865                   <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(users, user);
<a name="l12866"></a>12866                   user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l12867"></a>12867                }
<a name="l12868"></a>12868                peer = <a class="code" href="chan__iax2_8c.html#a49e3974d5f7880c5ec01eb631bb4062b" title="Create peer structure based on configuration.">build_peer</a>(cat, gen, <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(ucfg, cat), 0);
<a name="l12869"></a>12869                <span class="keywordflow">if</span> (peer) {
<a name="l12870"></a>12870                   <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>))
<a name="l12871"></a>12871                      <a class="code" href="chan__iax2_8c.html#a53f291d9224d73701f3a2a097d2457a7">reg_source_db</a>(peer);
<a name="l12872"></a>12872                   <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(peers, peer);
<a name="l12873"></a>12873                   peer = <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l12874"></a>12874                }
<a name="l12875"></a>12875             }
<a name="l12876"></a>12876             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(registeriax) || (!registeriax &amp;&amp; genregisteriax)) {
<a name="l12877"></a>12877                <span class="keywordtype">char</span> tmp[256];
<a name="l12878"></a>12878                <span class="keyword">const</span> <span class="keywordtype">char</span> *host = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, cat, <span class="stringliteral">&quot;host&quot;</span>);
<a name="l12879"></a>12879                <span class="keyword">const</span> <span class="keywordtype">char</span> *username = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, cat, <span class="stringliteral">&quot;username&quot;</span>);
<a name="l12880"></a>12880                <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a> = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, cat, <span class="stringliteral">&quot;secret&quot;</span>);
<a name="l12881"></a>12881                <span class="keywordflow">if</span> (!host)
<a name="l12882"></a>12882                   host = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;host&quot;</span>);
<a name="l12883"></a>12883                <span class="keywordflow">if</span> (!username)
<a name="l12884"></a>12884                   username = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;username&quot;</span>);
<a name="l12885"></a>12885                <span class="keywordflow">if</span> (!secret)
<a name="l12886"></a>12886                   secret = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(ucfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;secret&quot;</span>);
<a name="l12887"></a>12887                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(username) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(host)) {
<a name="l12888"></a>12888                   <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(secret))
<a name="l12889"></a>12889                      snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s:%s@%s&quot;</span>, username, secret, host);
<a name="l12890"></a>12890                   <span class="keywordflow">else</span>
<a name="l12891"></a>12891                      snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s@%s&quot;</span>, username, host);
<a name="l12892"></a>12892                   <a class="code" href="chan__iax2_8c.html#a9a7339b1691a326f37bad5fd3ffe5698">iax2_register</a>(tmp, 0);
<a name="l12893"></a>12893                }
<a name="l12894"></a>12894             }
<a name="l12895"></a>12895          }
<a name="l12896"></a>12896          cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(ucfg, cat);
<a name="l12897"></a>12897       }
<a name="l12898"></a>12898       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(ucfg);
<a name="l12899"></a>12899    }
<a name="l12900"></a>12900    
<a name="l12901"></a>12901    cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l12902"></a>12902    <span class="keywordflow">while</span>(cat) {
<a name="l12903"></a>12903       <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l12904"></a>12904          utype = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l12905"></a>12905          <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;callnumberlimits&quot;</span>)) {
<a name="l12906"></a>12906             <a class="code" href="chan__iax2_8c.html#af00198db2d521d3eff42da6fb57cfe1b">build_callno_limits</a>(<a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat));
<a name="l12907"></a>12907          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (utype) {
<a name="l12908"></a>12908             <span class="keywordflow">if</span> (!strcasecmp(utype, <span class="stringliteral">&quot;user&quot;</span>) || !strcasecmp(utype, <span class="stringliteral">&quot;friend&quot;</span>)) {
<a name="l12909"></a>12909                user = <a class="code" href="chan__iax2_8c.html#a4ce55a34cd5160db030be4355f7b4386" title="Create in-memory user structure from configuration.">build_user</a>(cat, <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat), NULL, 0);
<a name="l12910"></a>12910                <span class="keywordflow">if</span> (user) {
<a name="l12911"></a>12911                   <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(users, user);
<a name="l12912"></a>12912                   user = <a class="code" href="chan__iax2_8c.html#a0b21347c15192c80b4d10d0792c42163">user_unref</a>(user);
<a name="l12913"></a>12913                }
<a name="l12914"></a>12914             }
<a name="l12915"></a>12915             <span class="keywordflow">if</span> (!strcasecmp(utype, <span class="stringliteral">&quot;peer&quot;</span>) || !strcasecmp(utype, <span class="stringliteral">&quot;friend&quot;</span>)) {
<a name="l12916"></a>12916                peer = <a class="code" href="chan__iax2_8c.html#a49e3974d5f7880c5ec01eb631bb4062b" title="Create peer structure based on configuration.">build_peer</a>(cat, <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat), NULL, 0);
<a name="l12917"></a>12917                <span class="keywordflow">if</span> (peer) {
<a name="l12918"></a>12918                   <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>))
<a name="l12919"></a>12919                      <a class="code" href="chan__iax2_8c.html#a53f291d9224d73701f3a2a097d2457a7">reg_source_db</a>(peer);
<a name="l12920"></a>12920                   <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(peers, peer);
<a name="l12921"></a>12921                   peer = <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l12922"></a>12922                }
<a name="l12923"></a>12923             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(utype, <span class="stringliteral">&quot;user&quot;</span>)) {
<a name="l12924"></a>12924                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown type &apos;%s&apos; for &apos;%s&apos; in %s\n&quot;</span>, utype, cat, config_file);
<a name="l12925"></a>12925             }
<a name="l12926"></a>12926          } <span class="keywordflow">else</span>
<a name="l12927"></a>12927             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Section &apos;%s&apos; lacks type\n&quot;</span>, cat);
<a name="l12928"></a>12928       }
<a name="l12929"></a>12929       cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat);
<a name="l12930"></a>12930    }
<a name="l12931"></a>12931    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l12932"></a>12932    <span class="keywordflow">return</span> 1;
<a name="l12933"></a>12933 }
<a name="l12934"></a>12934 
<a name="l12935"></a><a class="code" href="chan__iax2_8c.html#a8903c1f7d2c178e3dedcb3257d6e03ef">12935</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="chan__iax2_8c.html#a8903c1f7d2c178e3dedcb3257d6e03ef">poke_all_peers</a>(<span class="keywordtype">void</span>)
<a name="l12936"></a>12936 {
<a name="l12937"></a>12937    <span class="keyword">struct </span><a class="code" href="structao2__iterator.html" title="When we need to walk through a container, we use an ao2_iterator to keep track of...">ao2_iterator</a> i;
<a name="l12938"></a>12938    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l12939"></a>12939 
<a name="l12940"></a>12940    i = <a class="code" href="astobj2_8h.html#a288075de687152d297308ea1ea963edb" title="Create an iterator for a container.">ao2_iterator_init</a>(peers, 0);
<a name="l12941"></a>12941    <span class="keywordflow">while</span> ((peer = <a class="code" href="astobj2_8h.html#a1cf2fe1aafd3cb9e613eb48535a37ad5">ao2_iterator_next</a>(&amp;i))) {
<a name="l12942"></a>12942       <a class="code" href="chan__iax2_8c.html#a33743770740a408f1810916b77143819">iax2_poke_peer</a>(peer, 0);
<a name="l12943"></a>12943       <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l12944"></a>12944    }
<a name="l12945"></a>12945    <a class="code" href="astobj2_8h.html#a62d5d9e9d0fa281168e6a08ef4a52450" title="Destroy a container iterator.">ao2_iterator_destroy</a>(&amp;i);
<a name="l12946"></a>12946 }
<a name="l12947"></a><a class="code" href="chan__iax2_8c.html#ab0a267a38c194073f7bf6dc1c5b97011">12947</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab0a267a38c194073f7bf6dc1c5b97011">reload_config</a>(<span class="keywordtype">void</span>)
<a name="l12948"></a>12948 {
<a name="l12949"></a>12949    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>[] = <span class="stringliteral">&quot;iax.conf&quot;</span>;
<a name="l12950"></a>12950    <span class="keyword">struct </span>iax2_registry *reg;
<a name="l12951"></a>12951 
<a name="l12952"></a>12952    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a588a54300638eba856f40104139c3986" title="Load configuration.">set_config</a>(config, 1) &gt; 0) {
<a name="l12953"></a>12953       <a class="code" href="chan__iax2_8c.html#a55c82d81ce37ebe5125d5a017c12b5ac">prune_peers</a>();
<a name="l12954"></a>12954       <a class="code" href="chan__iax2_8c.html#a64dccf856273fe23ad33955a0a491bc2">prune_users</a>();
<a name="l12955"></a>12955       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(callno_limits, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>, <a class="code" href="chan__iax2_8c.html#a3d657e16849603ec78eda638d20c878b">prune_addr_range_cb</a>, NULL);
<a name="l12956"></a>12956       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(calltoken_ignores, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca71f42ec6460e60eb6e10956c53329e45">OBJ_UNLINK</a> | <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca614744a4d36b3189d4ab5b02c8645d47">OBJ_MULTIPLE</a>, <a class="code" href="chan__iax2_8c.html#a3d657e16849603ec78eda638d20c878b">prune_addr_range_cb</a>, NULL);
<a name="l12957"></a>12957       <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(peercnts, <a class="code" href="astobj2_8h.html#ad9d009e87e737af900825b36db55a35ca5fc59b193d86a0a8ddfe866304be829d">OBJ_NODATA</a>, <a class="code" href="chan__iax2_8c.html#aa897ee9cba0aebf207f562d94cd0b5b8">set_peercnt_limit_all_cb</a>, NULL);
<a name="l12958"></a>12958       trunk_timed = trunk_untimed = 0; 
<a name="l12959"></a>12959       trunk_nmaxmtu = trunk_maxmtu = 0;
<a name="l12960"></a>12960       memset(&amp;<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>, <span class="charliteral">&apos;\0&apos;</span>, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a6e0eab3e17f8123ab993fec6b90590e5">debugaddr</a>));
<a name="l12961"></a>12961 
<a name="l12962"></a>12962       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;registrations);
<a name="l12963"></a>12963       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;registrations, reg, entry)
<a name="l12964"></a>12964          <a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">iax2_do_register</a>(reg);
<a name="l12965"></a>12965       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;registrations);
<a name="l12966"></a>12966 
<a name="l12967"></a>12967       <span class="comment">/* Qualify hosts, too */</span>
<a name="l12968"></a>12968       <a class="code" href="chan__iax2_8c.html#a8903c1f7d2c178e3dedcb3257d6e03ef">poke_all_peers</a>();
<a name="l12969"></a>12969    }
<a name="l12970"></a>12970    
<a name="l12971"></a>12971    <a class="code" href="chan__iax2_8c.html#a1474fd7c7eb179434b5be3102652a0f0">reload_firmware</a>(0);
<a name="l12972"></a>12972    <a class="code" href="iax2-provision_8c.html#a051a4fcc9414603f37de057900261c13">iax_provision_reload</a>(1);
<a name="l12973"></a>12973    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>);
<a name="l12974"></a>12974 
<a name="l12975"></a>12975    <span class="keywordflow">return</span> 0;
<a name="l12976"></a>12976 }
<a name="l12977"></a>12977 
<a name="l12978"></a><a class="code" href="chan__iax2_8c.html#ad6dec5f1a4157f14c5f769da1f24272b">12978</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#ad6dec5f1a4157f14c5f769da1f24272b">handle_cli_iax2_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l12979"></a>12979 {
<a name="l12980"></a>12980    <span class="keywordflow">switch</span> (cmd) {
<a name="l12981"></a>12981    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l12982"></a>12982       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;iax2 reload&quot;</span>;
<a name="l12983"></a>12983       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l12984"></a>12984          <span class="stringliteral">&quot;Usage: iax2 reload\n&quot;</span>
<a name="l12985"></a>12985          <span class="stringliteral">&quot;       Reloads IAX configuration from iax.conf\n&quot;</span>;
<a name="l12986"></a>12986       <span class="keywordflow">return</span> NULL;
<a name="l12987"></a>12987    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l12988"></a>12988       <span class="keywordflow">return</span> NULL;
<a name="l12989"></a>12989    }
<a name="l12990"></a>12990 
<a name="l12991"></a>12991    <a class="code" href="chan__iax2_8c.html#ab0a267a38c194073f7bf6dc1c5b97011">reload_config</a>();
<a name="l12992"></a>12992 
<a name="l12993"></a>12993    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l12994"></a>12994 }
<a name="l12995"></a>12995 
<a name="l12996"></a><a class="code" href="chan__iax2_8c.html#ad1982509765f4870f1f63412a53ea668">12996</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l12997"></a>12997 {
<a name="l12998"></a>12998    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#ab0a267a38c194073f7bf6dc1c5b97011">reload_config</a>();
<a name="l12999"></a>12999 }
<a name="l13000"></a>13000 
<a name="l13001"></a><a class="code" href="chan__iax2_8c.html#ad071dd1867c8e98f81a96735a7e40f0e">13001</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad071dd1867c8e98f81a96735a7e40f0e">cache_get_callno_locked</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l13002"></a>13002 {
<a name="l13003"></a>13003    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l13004"></a>13004    <span class="keywordtype">int</span> x;
<a name="l13005"></a>13005    <span class="keywordtype">int</span> callno;
<a name="l13006"></a>13006    <span class="keyword">struct </span><a class="code" href="structiax__ie__data.html">iax_ie_data</a> ied;
<a name="l13007"></a>13007    <span class="keyword">struct </span><a class="code" href="structcreate__addr__info.html">create_addr_info</a> cai;
<a name="l13008"></a>13008    <span class="keyword">struct </span><a class="code" href="structparsed__dial__string.html">parsed_dial_string</a> pds;
<a name="l13009"></a>13009    <span class="keywordtype">char</span> *tmpstr;
<a name="l13010"></a>13010 
<a name="l13011"></a>13011    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>); x++) {
<a name="l13012"></a>13012       <span class="comment">/* Look for an *exact match* call.  Once a call is negotiated, it can only</span>
<a name="l13013"></a>13013 <span class="comment">         look up entries for a single context */</span>
<a name="l13014"></a>13014       <span class="keywordflow">if</span> (!<a class="code" href="lock_8h.html#a036ccafa2339f674a46bc269bbd48c5f">ast_mutex_trylock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x])) {
<a name="l13015"></a>13015          <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x] &amp;&amp; !strcasecmp(data, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]-&gt;dproot))
<a name="l13016"></a>13016             <span class="keywordflow">return</span> x;
<a name="l13017"></a>13017          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l13018"></a>13018       }
<a name="l13019"></a>13019    }
<a name="l13020"></a>13020 
<a name="l13021"></a>13021    <span class="comment">/* No match found, we need to create a new one */</span>
<a name="l13022"></a>13022 
<a name="l13023"></a>13023    memset(&amp;cai, 0, <span class="keyword">sizeof</span>(cai));
<a name="l13024"></a>13024    memset(&amp;ied, 0, <span class="keyword">sizeof</span>(ied));
<a name="l13025"></a>13025    memset(&amp;pds, 0, <span class="keyword">sizeof</span>(pds));
<a name="l13026"></a>13026 
<a name="l13027"></a>13027    tmpstr = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l13028"></a>13028    <a class="code" href="chan__iax2_8c.html#a71c8dc9496597f318dad7e03597b945d" title="Parses an IAX dial string into its component parts.">parse_dial_string</a>(tmpstr, &amp;pds);
<a name="l13029"></a>13029 
<a name="l13030"></a>13030    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>)) {
<a name="l13031"></a>13031       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No peer provided in the IAX2 dial string &apos;%s&apos;\n&quot;</span>, data);
<a name="l13032"></a>13032       <span class="keywordflow">return</span> -1;
<a name="l13033"></a>13033    }
<a name="l13034"></a>13034 
<a name="l13035"></a>13035    <span class="comment">/* Populate our address from the given */</span>
<a name="l13036"></a>13036    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a718ce50d45da77b324047f3d9ceb6749">create_addr</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, NULL, &amp;sin, &amp;cai))
<a name="l13037"></a>13037       <span class="keywordflow">return</span> -1;
<a name="l13038"></a>13038 
<a name="l13039"></a>13039    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;peer: %s, username: %s, password: %s, context: %s\n&quot;</span>,
<a name="l13040"></a>13040       pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>, pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>, pds.<a class="code" href="structparsed__dial__string.html#a1f27749679e8054ef014a38569492895">context</a>);
<a name="l13041"></a>13041 
<a name="l13042"></a>13042    callno = <a class="code" href="chan__iax2_8c.html#a5bd68493647fff8ef4864f390b5a4034">find_callno_locked</a>(0, 0, &amp;sin, <a class="code" href="chan__iax2_8c.html#a9334a5b9057f32da96db9b5c6a045d67a8c4a27a0766c189094b1b9d8eff240c3">NEW_FORCE</a>, cai.<a class="code" href="structcreate__addr__info.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a>, 0);
<a name="l13043"></a>13043    <span class="keywordflow">if</span> (callno &lt; 1) {
<a name="l13044"></a>13044       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create call\n&quot;</span>);
<a name="l13045"></a>13045       <span class="keywordflow">return</span> -1;
<a name="l13046"></a>13046    }
<a name="l13047"></a>13047 
<a name="l13048"></a>13048    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], dproot, data);
<a name="l13049"></a>13049    <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structchan__iax2__pvt.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a> = <a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">IAX_CAPABILITY_FULLBANDWIDTH</a>;
<a name="l13050"></a>13050 
<a name="l13051"></a>13051    <a class="code" href="iax2-parser_8c.html#ad08e1debfa7325dfa3f22a8cc09f4945">iax_ie_append_short</a>(&amp;ied, <a class="code" href="iax2_8h.html#aba2ed51c46cc5e0e09ab9da295eafc12">IAX_IE_VERSION</a>, <a class="code" href="iax2_8h.html#ab1d2d15fd95077bc4f93947a5e011a98">IAX_PROTO_VERSION</a>);
<a name="l13052"></a>13052    <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#aa0f5d6e9b74df33a17772be8afde5bc7">IAX_IE_CALLED_NUMBER</a>, <span class="stringliteral">&quot;TBD&quot;</span>);
<a name="l13053"></a>13053    <span class="comment">/* the string format is slightly different from a standard dial string,</span>
<a name="l13054"></a>13054 <span class="comment">      because the context appears in the &apos;exten&apos; position</span>
<a name="l13055"></a>13055 <span class="comment">   */</span>
<a name="l13056"></a>13056    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a>)
<a name="l13057"></a>13057       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#af19a0a52d9c678fd55a44e6cda94cd88">IAX_IE_CALLED_CONTEXT</a>, pds.<a class="code" href="structparsed__dial__string.html#a9c2cb8c1611452928af0def998e36335">exten</a>);
<a name="l13058"></a>13058    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>)
<a name="l13059"></a>13059       <a class="code" href="iax2-parser_8c.html#ad94f0fdb4e50d38876577242d132709f">iax_ie_append_str</a>(&amp;ied, <a class="code" href="iax2_8h.html#afd193c12d8825d240b437532f7fa7990">IAX_IE_USERNAME</a>, pds.<a class="code" href="structparsed__dial__string.html#a9b20c006bd90a09e1465fb668700e81d">username</a>);
<a name="l13060"></a>13060    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#a81b21fd8bbf4f19527fbb21277687bd5">IAX_IE_FORMAT</a>, <a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">IAX_CAPABILITY_FULLBANDWIDTH</a>);
<a name="l13061"></a>13061    <a class="code" href="iax2-parser_8c.html#aa67b90e85b844cfc53a539813aca05ca">iax_ie_append_int</a>(&amp;ied, <a class="code" href="iax2_8h.html#aa6bc44b17b9a99b1f91f205b9c2112bf">IAX_IE_CAPABILITY</a>, <a class="code" href="chan__iax2_8c.html#a4d8b61a17f0174ff136e245022e1eced">IAX_CAPABILITY_FULLBANDWIDTH</a>);
<a name="l13062"></a>13062    <span class="comment">/* Keep password handy */</span>
<a name="l13063"></a>13063    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>)
<a name="l13064"></a>13064       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>, pds.<a class="code" href="structparsed__dial__string.html#a59460a3ff2c12443d1022e5cc0fba85c">password</a>);
<a name="l13065"></a>13065    <span class="keywordflow">if</span> (pds.<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>)
<a name="l13066"></a>13066       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], outkey, pds.<a class="code" href="structparsed__dial__string.html#a5892a9181e6a332f84d27aecd41dcd12">key</a>);
<a name="l13067"></a>13067    <span class="comment">/* Start the call going */</span>
<a name="l13068"></a>13068    <a class="code" href="chan__iax2_8c.html#acdd0cc2f8a7b7fdd781a7c3f92da5836">add_empty_calltoken_ie</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], &amp;ied); <span class="comment">/* this _MUST_ be the last ie added */</span>
<a name="l13069"></a>13069    <a class="code" href="chan__iax2_8c.html#a3a2ae6ccb9adcc3ed850255af7698ea9">send_command</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno], <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a7f7e5bdc9f8a8ef45c4d078f96b52624">AST_FRAME_IAX</a>, <a class="code" href="iax2_8h.html#a0f43e8c7dccbe27d9017497e83466effa9c6e063c4579ed81af4f9115ab023919">IAX_COMMAND_NEW</a>, 0, ied.<a class="code" href="structiax__ie__data.html#a8d0196caa4b00a1c9678508b882b33ee">buf</a>, ied.<a class="code" href="structiax__ie__data.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, -1);
<a name="l13070"></a>13070 
<a name="l13071"></a>13071    <span class="keywordflow">return</span> callno;
<a name="l13072"></a>13072 }
<a name="l13073"></a>13073 
<a name="l13074"></a><a class="code" href="chan__iax2_8c.html#a3b5f2254f642d4a92df833ed2a235210">13074</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *<a class="code" href="chan__iax2_8c.html#a3b5f2254f642d4a92df833ed2a235210">find_cache</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">int</span> priority)
<a name="l13075"></a>13075 {
<a name="l13076"></a>13076    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l13077"></a>13077    <span class="keyword">struct </span>timeval now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l13078"></a>13078    <span class="keywordtype">int</span> x, com[2], timeout, old = 0, outfd, doabort, callno;
<a name="l13079"></a>13079    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c = NULL;
<a name="l13080"></a>13080    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l13081"></a>13081 
<a name="l13082"></a>13082    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;dpcache, dp, cache_list) {
<a name="l13083"></a>13083       <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#acc9e13e54ed18f92956c748a38f82430" title="Compres two struct timeval instances returning -1, 0, 1 if the first arg is smaller...">ast_tvcmp</a>(now, dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a>) &gt; 0) {
<a name="l13084"></a>13084          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(cache_list);
<a name="l13085"></a>13085          <span class="keywordflow">if</span> ((dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>) || dp-&gt;<a class="code" href="structiax2__dpcache.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>)
<a name="l13086"></a>13086             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;DP still has peer field or pending or callno (flags = %d, peer = blah, callno = %d)\n&quot;</span>, dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a>, dp-&gt;<a class="code" href="structiax2__dpcache.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>);
<a name="l13087"></a>13087          <span class="keywordflow">else</span>
<a name="l13088"></a>13088             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(dp);
<a name="l13089"></a>13089          <span class="keywordflow">continue</span>;
<a name="l13090"></a>13090       }
<a name="l13091"></a>13091       <span class="keywordflow">if</span> (!strcmp(dp-&gt;<a class="code" href="structiax2__dpcache.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>, data) &amp;&amp; !strcmp(dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>, exten))
<a name="l13092"></a>13092          <span class="keywordflow">break</span>;
<a name="l13093"></a>13093    }
<a name="l13094"></a>13094    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l13095"></a>13095 
<a name="l13096"></a>13096    <span class="keywordflow">if</span> (!dp) {
<a name="l13097"></a>13097       <span class="comment">/* No matching entry.  Create a new one. */</span>
<a name="l13098"></a>13098       <span class="comment">/* First, can we make a callno? */</span>
<a name="l13099"></a>13099       <span class="keywordflow">if</span> ((callno = <a class="code" href="chan__iax2_8c.html#ad071dd1867c8e98f81a96735a7e40f0e">cache_get_callno_locked</a>(data)) &lt; 0) {
<a name="l13100"></a>13100          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to generate call for &apos;%s&apos;\n&quot;</span>, data);
<a name="l13101"></a>13101          <span class="keywordflow">return</span> NULL;
<a name="l13102"></a>13102       }
<a name="l13103"></a>13103       <span class="keywordflow">if</span> (!(dp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*dp)))) {
<a name="l13104"></a>13104          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l13105"></a>13105          <span class="keywordflow">return</span> NULL;
<a name="l13106"></a>13106       }
<a name="l13107"></a>13107       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>, data, <span class="keyword">sizeof</span>(dp-&gt;<a class="code" href="structiax2__dpcache.html#ac95e38343e3ce6cbca0a07c0d38c093a">peercontext</a>));
<a name="l13108"></a>13108       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>, exten, <span class="keyword">sizeof</span>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l13109"></a>13109       dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l13110"></a>13110       dp-&gt;<a class="code" href="structiax2__dpcache.html#a9192c26844abf50c80ad5803b710a904">orig</a> = dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a>;
<a name="l13111"></a>13111       <span class="comment">/* Expires in 30 mins by default */</span>
<a name="l13112"></a>13112       dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a>.tv_sec += iaxdefaultdpcache;
<a name="l13113"></a>13113       dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> = <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>;
<a name="l13114"></a>13114       <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>); x++)
<a name="l13115"></a>13115          dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] = -1;
<a name="l13116"></a>13116       <span class="comment">/* Insert into the lists */</span>
<a name="l13117"></a>13117       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;dpcache, dp, cache_list);
<a name="l13118"></a>13118       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;dpentries, dp, peer_list);
<a name="l13119"></a>13119       <span class="comment">/* Send the request if we&apos;re already up */</span>
<a name="l13120"></a>13120       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structstate.html">state</a>, <a class="code" href="chan__iax2_8c.html#abfe5755ee7de6e40b45ebf17b6cf7773ab2e060808ac4a1fe568e11a8fb23e109">IAX_STATE_STARTED</a>))
<a name="l13121"></a>13121          <a class="code" href="chan__iax2_8c.html#affb728aed260a44a6c7e8d18327766cb">iax2_dprequest</a>(dp, callno);
<a name="l13122"></a>13122       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l13123"></a>13123    }
<a name="l13124"></a>13124 
<a name="l13125"></a>13125    <span class="comment">/* By here we must have a dp */</span>
<a name="l13126"></a>13126    <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>) {
<a name="l13127"></a>13127       <span class="comment">/* Okay, here it starts to get nasty.  We need a pipe now to wait</span>
<a name="l13128"></a>13128 <span class="comment">         for a reply to come back so long as it&apos;s pending */</span>
<a name="l13129"></a>13129       <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>); x++) {
<a name="l13130"></a>13130          <span class="comment">/* Find an empty slot */</span>
<a name="l13131"></a>13131          <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] &lt; 0)
<a name="l13132"></a>13132             <span class="keywordflow">break</span>;
<a name="l13133"></a>13133       }
<a name="l13134"></a>13134       <span class="keywordflow">if</span> (x &gt;= <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>)) {
<a name="l13135"></a>13135          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No more waiter positions available\n&quot;</span>);
<a name="l13136"></a>13136          <span class="keywordflow">return</span> NULL;
<a name="l13137"></a>13137       }
<a name="l13138"></a>13138       <span class="keywordflow">if</span> (pipe(com)) {
<a name="l13139"></a>13139          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create pipe for comm\n&quot;</span>);
<a name="l13140"></a>13140          <span class="keywordflow">return</span> NULL;
<a name="l13141"></a>13141       }
<a name="l13142"></a>13142       dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] = com[1];
<a name="l13143"></a>13143       <span class="comment">/* Okay, now we wait */</span>
<a name="l13144"></a>13144       timeout = iaxdefaulttimeout * 1000;
<a name="l13145"></a>13145       <span class="comment">/* Temporarily unlock */</span>
<a name="l13146"></a>13146       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l13147"></a>13147       <span class="comment">/* Defer any dtmf */</span>
<a name="l13148"></a>13148       <span class="keywordflow">if</span> (chan)
<a name="l13149"></a>13149          old = <a class="code" href="channel_8h.html#aeaeb784665c384163aefb975ddf8bbe8" title="Set defer DTMF flag on channel.">ast_channel_defer_dtmf</a>(chan);
<a name="l13150"></a>13150       doabort = 0;
<a name="l13151"></a>13151       <span class="keywordflow">while</span>(timeout) {
<a name="l13152"></a>13152          c = <a class="code" href="channel_8h.html#a5e62602ca9e229304f60ab5c2b32e13b" title="Waits for activity on a group of channels.">ast_waitfor_nandfds</a>(&amp;chan, chan ? 1 : 0, &amp;com[0], 1, NULL, &amp;outfd, &amp;timeout);
<a name="l13153"></a>13153          <span class="keywordflow">if</span> (outfd &gt; -1)
<a name="l13154"></a>13154             <span class="keywordflow">break</span>;
<a name="l13155"></a>13155          <span class="keywordflow">if</span> (!c)
<a name="l13156"></a>13156             <span class="keywordflow">continue</span>;
<a name="l13157"></a>13157          <span class="keywordflow">if</span> (!(f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(c))) {
<a name="l13158"></a>13158             doabort = 1;
<a name="l13159"></a>13159             <span class="keywordflow">break</span>;
<a name="l13160"></a>13160          }
<a name="l13161"></a>13161          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l13162"></a>13162       }
<a name="l13163"></a>13163       <span class="keywordflow">if</span> (!timeout) {
<a name="l13164"></a>13164          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Timeout waiting for %s exten %s\n&quot;</span>, data, exten);
<a name="l13165"></a>13165       }
<a name="l13166"></a>13166       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l13167"></a>13167       dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] = -1;
<a name="l13168"></a>13168       close(com[1]);
<a name="l13169"></a>13169       close(com[0]);
<a name="l13170"></a>13170       <span class="keywordflow">if</span> (doabort) {
<a name="l13171"></a>13171          <span class="comment">/* Don&apos;t interpret anything, just abort.  Not sure what th epoint</span>
<a name="l13172"></a>13172 <span class="comment">           of undeferring dtmf on a hung up channel is but hey whatever */</span>
<a name="l13173"></a>13173          <span class="keywordflow">if</span> (!old &amp;&amp; chan)
<a name="l13174"></a>13174             <a class="code" href="channel_8h.html#a6e558e6f257935744c3c7f9cd79b169a" title="Unset defer DTMF flag on channel.">ast_channel_undefer_dtmf</a>(chan);
<a name="l13175"></a>13175          <span class="keywordflow">return</span> NULL;
<a name="l13176"></a>13176       }
<a name="l13177"></a>13177       <span class="keywordflow">if</span> (!(dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a049a9a889bef0328a9a726036fc45aac">CACHE_FLAG_TIMEOUT</a>)) {
<a name="l13178"></a>13178          <span class="comment">/* Now to do non-independent analysis the results of our wait */</span>
<a name="l13179"></a>13179          <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>) {
<a name="l13180"></a>13180             <span class="comment">/* Still pending... It&apos;s a timeout.  Wake everybody up.  Consider it no longer</span>
<a name="l13181"></a>13181 <span class="comment">               pending.  Don&apos;t let it take as long to timeout. */</span>
<a name="l13182"></a>13182             dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp;= ~<a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493ac17eee861e227e4ecdd2bb558c8c9b61">CACHE_FLAG_PENDING</a>;
<a name="l13183"></a>13183             dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> |= <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a049a9a889bef0328a9a726036fc45aac">CACHE_FLAG_TIMEOUT</a>;
<a name="l13184"></a>13184             <span class="comment">/* Expire after only 60 seconds now.  This is designed to help reduce backlog in heavily loaded</span>
<a name="l13185"></a>13185 <span class="comment">               systems without leaving it unavailable once the server comes back online */</span>
<a name="l13186"></a>13186             dp-&gt;<a class="code" href="structiax2__dpcache.html#a4c1ce1d5e15f770edcc31ebacb54f9d0">expiry</a>.tv_sec = dp-&gt;<a class="code" href="structiax2__dpcache.html#a9192c26844abf50c80ad5803b710a904">orig</a>.tv_sec + 60;
<a name="l13187"></a>13187             <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>); x++) {
<a name="l13188"></a>13188                <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x] &gt; -1) {
<a name="l13189"></a>13189                   <span class="keywordflow">if</span> (write(dp-&gt;<a class="code" href="structiax2__dpcache.html#a1af17eef7952bdba69bd8c1cd85e882b">waiters</a>[x], <span class="stringliteral">&quot;asdf&quot;</span>, 4) &lt; 0) {
<a name="l13190"></a>13190                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l13191"></a>13191                   }
<a name="l13192"></a>13192                }
<a name="l13193"></a>13193             }
<a name="l13194"></a>13194          }
<a name="l13195"></a>13195       }
<a name="l13196"></a>13196       <span class="comment">/* Our caller will obtain the rest */</span>
<a name="l13197"></a>13197       <span class="keywordflow">if</span> (!old &amp;&amp; chan)
<a name="l13198"></a>13198          <a class="code" href="channel_8h.html#a6e558e6f257935744c3c7f9cd79b169a" title="Unset defer DTMF flag on channel.">ast_channel_undefer_dtmf</a>(chan);
<a name="l13199"></a>13199    }
<a name="l13200"></a>13200    <span class="keywordflow">return</span> dp;  
<a name="l13201"></a>13201 }
<a name="l13202"></a>13202 <span class="comment"></span>
<a name="l13203"></a>13203 <span class="comment">/*! \brief Part of the IAX2 switch interface */</span>
<a name="l13204"></a><a class="code" href="chan__iax2_8c.html#ab5aafea9ac8439d5493d4fbe6cb5a534">13204</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab5aafea9ac8439d5493d4fbe6cb5a534" title="Part of the IAX2 switch interface.">iax2_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l13205"></a>13205 {
<a name="l13206"></a>13206    <span class="keywordtype">int</span> res = 0;
<a name="l13207"></a>13207    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l13208"></a>13208 <span class="preprocessor">#if 0</span>
<a name="l13209"></a>13209 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;iax2_exists: con: %s, exten: %s, pri: %d, cid: %s, data: %s\n&quot;</span>, context, exten, priority, callerid ? callerid : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>, data);
<a name="l13210"></a>13210 <span class="preprocessor">#endif</span>
<a name="l13211"></a>13211 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((priority != 1) &amp;&amp; (priority != 2))
<a name="l13212"></a>13212       <span class="keywordflow">return</span> 0;
<a name="l13213"></a>13213 
<a name="l13214"></a>13214    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l13215"></a>13215    <span class="keywordflow">if</span> ((dp = <a class="code" href="chan__iax2_8c.html#a3b5f2254f642d4a92df833ed2a235210">find_cache</a>(chan, data, context, exten, priority))) {
<a name="l13216"></a>13216       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a237ba33c07f39880a6da1134630be695">CACHE_FLAG_EXISTS</a>)
<a name="l13217"></a>13217          res = 1;
<a name="l13218"></a>13218    } <span class="keywordflow">else</span> {
<a name="l13219"></a>13219       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to make DP cache\n&quot;</span>);
<a name="l13220"></a>13220    }
<a name="l13221"></a>13221    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l13222"></a>13222 
<a name="l13223"></a>13223    <span class="keywordflow">return</span> res;
<a name="l13224"></a>13224 }
<a name="l13225"></a>13225 <span class="comment"></span>
<a name="l13226"></a>13226 <span class="comment">/*! \brief part of the IAX2 dial plan switch interface */</span>
<a name="l13227"></a><a class="code" href="chan__iax2_8c.html#a79696b2587a6ac66114367d3e5feb5bc">13227</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a79696b2587a6ac66114367d3e5feb5bc" title="part of the IAX2 dial plan switch interface">iax2_canmatch</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l13228"></a>13228 {
<a name="l13229"></a>13229    <span class="keywordtype">int</span> res = 0;
<a name="l13230"></a>13230    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l13231"></a>13231 <span class="preprocessor">#if 0</span>
<a name="l13232"></a>13232 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;iax2_canmatch: con: %s, exten: %s, pri: %d, cid: %s, data: %s\n&quot;</span>, context, exten, priority, callerid ? callerid : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>, data);
<a name="l13233"></a>13233 <span class="preprocessor">#endif</span>
<a name="l13234"></a>13234 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((priority != 1) &amp;&amp; (priority != 2))
<a name="l13235"></a>13235       <span class="keywordflow">return</span> 0;
<a name="l13236"></a>13236 
<a name="l13237"></a>13237    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l13238"></a>13238    <span class="keywordflow">if</span> ((dp = <a class="code" href="chan__iax2_8c.html#a3b5f2254f642d4a92df833ed2a235210">find_cache</a>(chan, data, context, exten, priority))) {
<a name="l13239"></a>13239       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a9cc184231f4419e681d6de9ca43df81a">CACHE_FLAG_CANEXIST</a>)
<a name="l13240"></a>13240          res = 1;
<a name="l13241"></a>13241    } <span class="keywordflow">else</span> {
<a name="l13242"></a>13242       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to make DP cache\n&quot;</span>);
<a name="l13243"></a>13243    }
<a name="l13244"></a>13244    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l13245"></a>13245 
<a name="l13246"></a>13246    <span class="keywordflow">return</span> res;
<a name="l13247"></a>13247 }
<a name="l13248"></a>13248 <span class="comment"></span>
<a name="l13249"></a>13249 <span class="comment">/*! \brief Part of the IAX2 Switch interface */</span>
<a name="l13250"></a><a class="code" href="chan__iax2_8c.html#ab765026768bdd9aa90b05e9b4452b72c">13250</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ab765026768bdd9aa90b05e9b4452b72c" title="Part of the IAX2 Switch interface.">iax2_matchmore</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l13251"></a>13251 {
<a name="l13252"></a>13252    <span class="keywordtype">int</span> res = 0;
<a name="l13253"></a>13253    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l13254"></a>13254 <span class="preprocessor">#if 0</span>
<a name="l13255"></a>13255 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;iax2_matchmore: con: %s, exten: %s, pri: %d, cid: %s, data: %s\n&quot;</span>, context, exten, priority, callerid ? callerid : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>, data);
<a name="l13256"></a>13256 <span class="preprocessor">#endif</span>
<a name="l13257"></a>13257 <span class="preprocessor"></span>   <span class="keywordflow">if</span> ((priority != 1) &amp;&amp; (priority != 2))
<a name="l13258"></a>13258       <span class="keywordflow">return</span> 0;
<a name="l13259"></a>13259 
<a name="l13260"></a>13260    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l13261"></a>13261    <span class="keywordflow">if</span> ((dp = <a class="code" href="chan__iax2_8c.html#a3b5f2254f642d4a92df833ed2a235210">find_cache</a>(chan, data, context, exten, priority))) {
<a name="l13262"></a>13262       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a497c2d7c7e5e120d0f497fac309d65c5">CACHE_FLAG_MATCHMORE</a>)
<a name="l13263"></a>13263          res = 1;
<a name="l13264"></a>13264    } <span class="keywordflow">else</span> {
<a name="l13265"></a>13265       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to make DP cache\n&quot;</span>);
<a name="l13266"></a>13266    }
<a name="l13267"></a>13267    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l13268"></a>13268 
<a name="l13269"></a>13269    <span class="keywordflow">return</span> res;
<a name="l13270"></a>13270 }
<a name="l13271"></a>13271 <span class="comment"></span>
<a name="l13272"></a>13272 <span class="comment">/*! \brief Execute IAX2 dialplan switch */</span>
<a name="l13273"></a><a class="code" href="chan__iax2_8c.html#a2eff32e791ee9c74d23abc685cea0b4e">13273</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2eff32e791ee9c74d23abc685cea0b4e" title="Execute IAX2 dialplan switch.">iax2_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keywordtype">int</span> priority, <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l13274"></a>13274 {
<a name="l13275"></a>13275    <span class="keywordtype">char</span> odata[256];
<a name="l13276"></a>13276    <span class="keywordtype">char</span> req[256];
<a name="l13277"></a>13277    <span class="keywordtype">char</span> *ncontext;
<a name="l13278"></a>13278    <span class="keyword">struct </span><a class="code" href="structiax2__dpcache.html">iax2_dpcache</a> *dp = NULL;
<a name="l13279"></a>13279    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *dial = NULL;
<a name="l13280"></a>13280 <span class="preprocessor">#if 0</span>
<a name="l13281"></a>13281 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;iax2_exec: con: %s, exten: %s, pri: %d, cid: %s, data: %s, newstack: %d\n&quot;</span>, context, exten, priority, callerid ? callerid : <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>, data, newstack);
<a name="l13282"></a>13282 <span class="preprocessor">#endif</span>
<a name="l13283"></a>13283 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (priority == 2) {
<a name="l13284"></a>13284       <span class="comment">/* Indicate status, can be overridden in dialplan */</span>
<a name="l13285"></a>13285       <span class="keyword">const</span> <span class="keywordtype">char</span> *dialstatus = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;DIALSTATUS&quot;</span>);
<a name="l13286"></a>13286       <span class="keywordflow">if</span> (dialstatus) {
<a name="l13287"></a>13287          dial = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(dialstatus);
<a name="l13288"></a>13288          <span class="keywordflow">if</span> (dial) 
<a name="l13289"></a>13289             <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, dial, <span class="stringliteral">&quot;&quot;</span>);
<a name="l13290"></a>13290       }
<a name="l13291"></a>13291       <span class="keywordflow">return</span> -1;
<a name="l13292"></a>13292    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (priority != 1)
<a name="l13293"></a>13293       <span class="keywordflow">return</span> -1;
<a name="l13294"></a>13294 
<a name="l13295"></a>13295    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dpcache);
<a name="l13296"></a>13296    <span class="keywordflow">if</span> ((dp = <a class="code" href="chan__iax2_8c.html#a3b5f2254f642d4a92df833ed2a235210">find_cache</a>(chan, data, context, exten, priority))) {
<a name="l13297"></a>13297       <span class="keywordflow">if</span> (dp-&gt;<a class="code" href="structiax2__dpcache.html#ac8bf36fe0577cba66bccda3a6f7e80a4">flags</a> &amp; <a class="code" href="chan__iax2_8c.html#a531c35e38ede3ea4e5ba5afb24b29493a237ba33c07f39880a6da1134630be695">CACHE_FLAG_EXISTS</a>) {
<a name="l13298"></a>13298          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(odata, data, <span class="keyword">sizeof</span>(odata));
<a name="l13299"></a>13299          ncontext = strchr(odata, <span class="charliteral">&apos;/&apos;</span>);
<a name="l13300"></a>13300          <span class="keywordflow">if</span> (ncontext) {
<a name="l13301"></a>13301             *ncontext = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l13302"></a>13302             ncontext++;
<a name="l13303"></a>13303             snprintf(req, <span class="keyword">sizeof</span>(req), <span class="stringliteral">&quot;IAX2/%s/%s@%s&quot;</span>, odata, exten, ncontext);
<a name="l13304"></a>13304          } <span class="keywordflow">else</span> {
<a name="l13305"></a>13305             snprintf(req, <span class="keyword">sizeof</span>(req), <span class="stringliteral">&quot;IAX2/%s/%s&quot;</span>, odata, exten);
<a name="l13306"></a>13306          }
<a name="l13307"></a>13307          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Executing Dial(&apos;%s&apos;)\n&quot;</span>, req);
<a name="l13308"></a>13308       } <span class="keywordflow">else</span> {
<a name="l13309"></a>13309          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l13310"></a>13310          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t execute nonexistent extension &apos;%s[@%s]&apos; in data &apos;%s&apos;\n&quot;</span>, exten, context, data);
<a name="l13311"></a>13311          <span class="keywordflow">return</span> -1;
<a name="l13312"></a>13312       }
<a name="l13313"></a>13313    }
<a name="l13314"></a>13314    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dpcache);
<a name="l13315"></a>13315 
<a name="l13316"></a>13316    <span class="keywordflow">if</span> ((dial = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;Dial&quot;</span>)))
<a name="l13317"></a>13317       <span class="keywordflow">return</span> <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, dial, req);
<a name="l13318"></a>13318    <span class="keywordflow">else</span>
<a name="l13319"></a>13319       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No dial application registered\n&quot;</span>);
<a name="l13320"></a>13320 
<a name="l13321"></a>13321    <span class="keywordflow">return</span> -1;
<a name="l13322"></a>13322 }
<a name="l13323"></a>13323 
<a name="l13324"></a><a class="code" href="chan__iax2_8c.html#a95ac2a21437f09b8dbe1319597a33cb9">13324</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a95ac2a21437f09b8dbe1319597a33cb9">function_iaxpeer</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l13325"></a>13325 {
<a name="l13326"></a>13326    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer;
<a name="l13327"></a>13327    <span class="keywordtype">char</span> *peername, *colname;
<a name="l13328"></a>13328 
<a name="l13329"></a>13329    peername = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l13330"></a>13330 
<a name="l13331"></a>13331    <span class="comment">/* if our channel, return the IP address of the endpoint of current channel */</span>
<a name="l13332"></a>13332    <span class="keywordflow">if</span> (!strcmp(peername,<span class="stringliteral">&quot;CURRENTCHANNEL&quot;</span>)) {
<a name="l13333"></a>13333            <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structiax2__peer.html#a12650384da62fe82303630ca19410f2b">callno</a>;
<a name="l13334"></a>13334       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> != &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>)
<a name="l13335"></a>13335          <span class="keywordflow">return</span> -1;
<a name="l13336"></a>13336       callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);   
<a name="l13337"></a>13337       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno]-&gt;<a class="code" href="structiax2__trunk__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;&quot;</span>, len);
<a name="l13338"></a>13338       <span class="keywordflow">return</span> 0;
<a name="l13339"></a>13339    }
<a name="l13340"></a>13340 
<a name="l13341"></a>13341    <span class="keywordflow">if</span> ((colname = strchr(peername, <span class="charliteral">&apos;,&apos;</span>)))
<a name="l13342"></a>13342       *colname++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l13343"></a>13343    <span class="keywordflow">else</span>
<a name="l13344"></a>13344       colname = <span class="stringliteral">&quot;ip&quot;</span>;
<a name="l13345"></a>13345 
<a name="l13346"></a>13346    <span class="keywordflow">if</span> (!(peer = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(peername, 1)))
<a name="l13347"></a>13347       <span class="keywordflow">return</span> -1;
<a name="l13348"></a>13348 
<a name="l13349"></a>13349    <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;ip&quot;</span>)) {
<a name="l13350"></a>13350       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(peer-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;&quot;</span>, len);
<a name="l13351"></a>13351    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;status&quot;</span>)) {
<a name="l13352"></a>13352       <a class="code" href="chan__iax2_8c.html#aa421fc97db5511876bc29d397fd65827" title="peer_status: Report Peer status in character string">peer_status</a>(peer, buf, len); 
<a name="l13353"></a>13353    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;mailbox&quot;</span>)) {
<a name="l13354"></a>13354       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, peer-&gt;mailbox, len);
<a name="l13355"></a>13355    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l13356"></a>13356       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, peer-&gt;context, len);
<a name="l13357"></a>13357    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;expire&quot;</span>)) {
<a name="l13358"></a>13358       snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, peer-&gt;<a class="code" href="structiax2__peer.html#a2f16194304829daa3f050ba49f218b5f">expire</a>);
<a name="l13359"></a>13359    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;dynamic&quot;</span>)) {
<a name="l13360"></a>13360       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="chan__iax2_8c.html#a4e223e9dfd9ad4a6a6455098ffe4feeba8ecf6f4497b2bca482ad0a94f3cffe12">IAX_DYNAMIC</a>) ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>), len);
<a name="l13361"></a>13361    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;callerid_name&quot;</span>)) {
<a name="l13362"></a>13362       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, peer-&gt;cid_name, len);
<a name="l13363"></a>13363    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;callerid_num&quot;</span>)) {
<a name="l13364"></a>13364       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, peer-&gt;cid_num, len);
<a name="l13365"></a>13365    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strcasecmp(colname, <span class="stringliteral">&quot;codecs&quot;</span>)) {
<a name="l13366"></a>13366       <a class="code" href="frame_8h.html#a37cdc7e78686b0bfa4e47e645f782b30" title="Get the names of a set of formats.">ast_getformatname_multiple</a>(buf, len -1, peer-&gt;<a class="code" href="structiax2__peer.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>);
<a name="l13367"></a>13367    } <span class="keywordflow">else</span>  <span class="keywordflow">if</span> (!strncasecmp(colname, <span class="stringliteral">&quot;codec[&quot;</span>, 6)) {
<a name="l13368"></a>13368       <span class="keywordtype">char</span> *codecnum, *ptr;
<a name="l13369"></a>13369       <span class="keywordtype">int</span> codec = 0;
<a name="l13370"></a>13370       
<a name="l13371"></a>13371       codecnum = strchr(colname, <span class="charliteral">&apos;[&apos;</span>);
<a name="l13372"></a>13372       *codecnum = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l13373"></a>13373       codecnum++;
<a name="l13374"></a>13374       <span class="keywordflow">if</span> ((ptr = strchr(codecnum, <span class="charliteral">&apos;]&apos;</span>))) {
<a name="l13375"></a>13375          *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l13376"></a>13376       }
<a name="l13377"></a>13377       <span class="keywordflow">if</span>((codec = <a class="code" href="frame_8h.html#af9dd4cbc4b715644df1afe4964169c9b" title="Codec located at a particular place in the preference index.">ast_codec_pref_index</a>(&amp;peer-&gt;<a class="code" href="structiax2__peer.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>, atoi(codecnum)))) {
<a name="l13378"></a>13378          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(codec), len);
<a name="l13379"></a>13379       } <span class="keywordflow">else</span> {
<a name="l13380"></a>13380          buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l13381"></a>13381       }
<a name="l13382"></a>13382    } <span class="keywordflow">else</span> {
<a name="l13383"></a>13383       buf[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l13384"></a>13384    }
<a name="l13385"></a>13385 
<a name="l13386"></a>13386    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(peer);
<a name="l13387"></a>13387 
<a name="l13388"></a>13388    <span class="keywordflow">return</span> 0;
<a name="l13389"></a>13389 }
<a name="l13390"></a>13390 
<a name="l13391"></a><a class="code" href="chan__iax2_8c.html#a3b156a89a2aa9ce1b8bae58bc8d3a5e6">13391</a> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="chan__iax2_8c.html#a3b156a89a2aa9ce1b8bae58bc8d3a5e6">iaxpeer_function</a> = {
<a name="l13392"></a>13392    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;IAXPEER&quot;</span>,
<a name="l13393"></a>13393    .read = <a class="code" href="chan__iax2_8c.html#a95ac2a21437f09b8dbe1319597a33cb9">function_iaxpeer</a>,
<a name="l13394"></a>13394 };
<a name="l13395"></a>13395 
<a name="l13396"></a><a class="code" href="chan__iax2_8c.html#a2c2f15da97a2869766f6f68baa644705">13396</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2c2f15da97a2869766f6f68baa644705">acf_channel_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *funcname, <span class="keywordtype">char</span> *args, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> buflen)
<a name="l13397"></a>13397 {
<a name="l13398"></a>13398    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt;
<a name="l13399"></a>13399    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structchan__iax2__pvt.html#a80cb2705f540fcd4a6d6276addb98819">callno</a>;
<a name="l13400"></a>13400    <span class="keywordtype">int</span> res = 0;
<a name="l13401"></a>13401 
<a name="l13402"></a>13402    <span class="keywordflow">if</span> (!chan || chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a> != &amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>) {
<a name="l13403"></a>13403       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;This function requires a valid IAX2 channel\n&quot;</span>);
<a name="l13404"></a>13404       <span class="keywordflow">return</span> -1;
<a name="l13405"></a>13405    }
<a name="l13406"></a>13406 
<a name="l13407"></a>13407    callno = <a class="code" href="chan__iax2_8c.html#a253fef13f324ad1569d580e47e080ca9">PTR_TO_CALLNO</a>(chan-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>);
<a name="l13408"></a>13408    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l13409"></a>13409    <span class="keywordflow">if</span> (!(pvt = <a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[callno])) {
<a name="l13410"></a>13410       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l13411"></a>13411       <span class="keywordflow">return</span> -1;
<a name="l13412"></a>13412    }
<a name="l13413"></a>13413 
<a name="l13414"></a>13414    <span class="keywordflow">if</span> (!strcasecmp(args, <span class="stringliteral">&quot;osptoken&quot;</span>)) {
<a name="l13415"></a>13415       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, pvt-&gt;osptoken, buflen);
<a name="l13416"></a>13416    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args, <span class="stringliteral">&quot;peerip&quot;</span>)) {
<a name="l13417"></a>13417       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr ? <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr) : <span class="stringliteral">&quot;&quot;</span>, buflen);
<a name="l13418"></a>13418    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(args, <span class="stringliteral">&quot;peername&quot;</span>)) {
<a name="l13419"></a>13419       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, pvt-&gt;username, buflen);
<a name="l13420"></a>13420    } <span class="keywordflow">else</span> {
<a name="l13421"></a>13421       res = -1;
<a name="l13422"></a>13422    }
<a name="l13423"></a>13423 
<a name="l13424"></a>13424    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[callno]);
<a name="l13425"></a>13425 
<a name="l13426"></a>13426    <span class="keywordflow">return</span> res;
<a name="l13427"></a>13427 }
<a name="l13428"></a>13428 <span class="comment"></span>
<a name="l13429"></a>13429 <span class="comment">/*! \brief Part of the device state notification system ---*/</span>
<a name="l13430"></a><a class="code" href="chan__iax2_8c.html#a515bccac6d7dd9eb618205747a40bdad">13430</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a515bccac6d7dd9eb618205747a40bdad" title="Part of the device state notification system ---.">iax2_devicestate</a>(<span class="keywordtype">void</span> *data) 
<a name="l13431"></a>13431 {
<a name="l13432"></a>13432    <span class="keyword">struct </span><a class="code" href="structparsed__dial__string.html">parsed_dial_string</a> pds;
<a name="l13433"></a>13433    <span class="keywordtype">char</span> *tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l13434"></a>13434    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *p;
<a name="l13435"></a>13435    <span class="keywordtype">int</span> res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l13436"></a>13436 
<a name="l13437"></a>13437    memset(&amp;pds, 0, <span class="keyword">sizeof</span>(pds));
<a name="l13438"></a>13438    <a class="code" href="chan__iax2_8c.html#a71c8dc9496597f318dad7e03597b945d" title="Parses an IAX dial string into its component parts.">parse_dial_string</a>(tmp, &amp;pds);
<a name="l13439"></a>13439 
<a name="l13440"></a>13440    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>)) {
<a name="l13441"></a>13441       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No peer provided in the IAX2 dial string &apos;%s&apos;\n&quot;</span>, (<span class="keywordtype">char</span> *) data);
<a name="l13442"></a>13442       <span class="keywordflow">return</span> res;
<a name="l13443"></a>13443    }
<a name="l13444"></a>13444    
<a name="l13445"></a>13445    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Checking device state for device %s\n&quot;</span>, pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>);
<a name="l13446"></a>13446 
<a name="l13447"></a>13447    <span class="comment">/* SLD: FIXME: second call to find_peer during registration */</span>
<a name="l13448"></a>13448    <span class="keywordflow">if</span> (!(p = <a class="code" href="chan__iax2_8c.html#acabf79aa63360ba97fe7285babb006ce">find_peer</a>(pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, 1)))
<a name="l13449"></a>13449       <span class="keywordflow">return</span> res;
<a name="l13450"></a>13450 
<a name="l13451"></a>13451    res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeafac147cbabf3ccb80e50e86027710549">AST_DEVICE_UNAVAILABLE</a>;
<a name="l13452"></a>13452    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;iax2_devicestate: Found peer. What&apos;s device state of %s? addr=%d, defaddr=%d maxms=%d, lastms=%d\n&quot;</span>,
<a name="l13453"></a>13453       pds.<a class="code" href="structparsed__dial__string.html#a86ecf1c67849da9176922543233b7d21">peer</a>, p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr, p-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_addr.s_addr, p-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>, p-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a>);
<a name="l13454"></a>13454    
<a name="l13455"></a>13455    <span class="keywordflow">if</span> ((p-&gt;<a class="code" href="structiax2__peer.html#afdf3b1ca80400cc6bd5bfe2bb1cb7e65">addr</a>.sin_addr.s_addr || p-&gt;<a class="code" href="structiax2__peer.html#a467dd38f909f199e3d85b1805c163088">defaddr</a>.sin_addr.s_addr) &amp;&amp;
<a name="l13456"></a>13456        (!p-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a> || ((p-&gt;<a class="code" href="structiax2__peer.html#a5ca312c87ed6ac5b29d4dca646f69e29">lastms</a> &gt; -1) &amp;&amp; (p-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> &lt;= p-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>)))) {
<a name="l13457"></a>13457       <span class="comment">/* Peer is registered, or have default IP address</span>
<a name="l13458"></a>13458 <span class="comment">         and a valid registration */</span>
<a name="l13459"></a>13459       <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> == 0 || p-&gt;<a class="code" href="structiax2__peer.html#a44dade90a7a56165a549c24c14f035ea">historicms</a> &lt;= p-&gt;<a class="code" href="structiax2__peer.html#ad19f7ae6e6ba6ccbffacb5d88861e8e5">maxms</a>)
<a name="l13460"></a>13460          <span class="comment">/* let the core figure out whether it is in use or not */</span>
<a name="l13461"></a>13461          res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;  
<a name="l13462"></a>13462    }
<a name="l13463"></a>13463 
<a name="l13464"></a>13464    <a class="code" href="chan__iax2_8c.html#a9d9aea968e0ffe088076ec4cce486d3a">peer_unref</a>(p);
<a name="l13465"></a>13465 
<a name="l13466"></a>13466    <span class="keywordflow">return</span> res;
<a name="l13467"></a>13467 }
<a name="l13468"></a>13468 
<a name="l13469"></a><a class="code" href="chan__iax2_8c.html#a87b682391daa991ea04ed53e09bdf279">13469</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__switch.html">ast_switch</a> <a class="code" href="chan__iax2_8c.html#a87b682391daa991ea04ed53e09bdf279">iax2_switch</a> = 
<a name="l13470"></a>13470 {
<a name="l13471"></a>13471    <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>:        <span class="stringliteral">&quot;IAX2&quot;</span>,
<a name="l13472"></a>13472    <a class="code" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a>: <span class="stringliteral">&quot;IAX Remote Dialplan Switch&quot;</span>,
<a name="l13473"></a>13473    <a class="code" href="func__logic_8c.html#ad6f8d00a94914824d3b6048722c42332">exists</a>:      <a class="code" href="chan__iax2_8c.html#ab5aafea9ac8439d5493d4fbe6cb5a534" title="Part of the IAX2 switch interface.">iax2_exists</a>,
<a name="l13474"></a>13474    <a class="code" href="pbx__lua_8c.html#a161611b39a822c50ab75c350a69eedd2">canmatch</a>:    <a class="code" href="chan__iax2_8c.html#a79696b2587a6ac66114367d3e5feb5bc" title="part of the IAX2 dial plan switch interface">iax2_canmatch</a>,
<a name="l13475"></a>13475    <a class="code" href="pbx__lua_8c.html#a0ea9753b753253d4c74b215c6d290e52">exec</a>:        <a class="code" href="chan__iax2_8c.html#a2eff32e791ee9c74d23abc685cea0b4e" title="Execute IAX2 dialplan switch.">iax2_exec</a>,
<a name="l13476"></a>13476    <a class="code" href="pbx__lua_8c.html#a01d4c61c8065333033ddb5325bfd2032">matchmore</a>:   <a class="code" href="chan__iax2_8c.html#ab765026768bdd9aa90b05e9b4452b72c" title="Part of the IAX2 Switch interface.">iax2_matchmore</a>,
<a name="l13477"></a>13477 };
<a name="l13478"></a>13478 
<a name="l13479"></a>13479 <span class="comment">/*</span>
<a name="l13480"></a>13480 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;cache&quot;, NULL },</span>
<a name="l13481"></a>13481 <span class="comment">   iax2_show_cache, &quot;Display IAX cached dialplan&quot;,</span>
<a name="l13482"></a>13482 <span class="comment">   show_cache_usage },</span>
<a name="l13483"></a>13483 <span class="comment"></span>
<a name="l13484"></a>13484 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;channels&quot;, NULL },</span>
<a name="l13485"></a>13485 <span class="comment">   iax2_show_channels, &quot;List active IAX channels&quot;,</span>
<a name="l13486"></a>13486 <span class="comment">   show_channels_usage },</span>
<a name="l13487"></a>13487 <span class="comment"></span>
<a name="l13488"></a>13488 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;firmware&quot;, NULL },</span>
<a name="l13489"></a>13489 <span class="comment">   iax2_show_firmware, &quot;List available IAX firmwares&quot;,</span>
<a name="l13490"></a>13490 <span class="comment">   show_firmware_usage },</span>
<a name="l13491"></a>13491 <span class="comment"></span>
<a name="l13492"></a>13492 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;netstats&quot;, NULL },</span>
<a name="l13493"></a>13493 <span class="comment">   iax2_show_netstats, &quot;List active IAX channel netstats&quot;,</span>
<a name="l13494"></a>13494 <span class="comment">   show_netstats_usage },</span>
<a name="l13495"></a>13495 <span class="comment"></span>
<a name="l13496"></a>13496 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;peers&quot;, NULL },</span>
<a name="l13497"></a>13497 <span class="comment">   iax2_show_peers, &quot;List defined IAX peers&quot;,</span>
<a name="l13498"></a>13498 <span class="comment">   show_peers_usage },</span>
<a name="l13499"></a>13499 <span class="comment"></span>
<a name="l13500"></a>13500 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;registry&quot;, NULL },</span>
<a name="l13501"></a>13501 <span class="comment">   iax2_show_registry, &quot;Display IAX registration status&quot;,</span>
<a name="l13502"></a>13502 <span class="comment">   show_reg_usage },</span>
<a name="l13503"></a>13503 <span class="comment"></span>
<a name="l13504"></a>13504 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;stats&quot;, NULL },</span>
<a name="l13505"></a>13505 <span class="comment">   iax2_show_stats, &quot;Display IAX statistics&quot;,</span>
<a name="l13506"></a>13506 <span class="comment">   show_stats_usage },</span>
<a name="l13507"></a>13507 <span class="comment"></span>
<a name="l13508"></a>13508 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;threads&quot;, NULL },</span>
<a name="l13509"></a>13509 <span class="comment">   iax2_show_threads, &quot;Display IAX helper thread info&quot;,</span>
<a name="l13510"></a>13510 <span class="comment">   show_threads_usage },</span>
<a name="l13511"></a>13511 <span class="comment"></span>
<a name="l13512"></a>13512 <span class="comment">   { { &quot;iax2&quot;, &quot;unregister&quot;, NULL },</span>
<a name="l13513"></a>13513 <span class="comment">   iax2_unregister, &quot;Unregister (force expiration) an IAX2 peer from the registry&quot;,</span>
<a name="l13514"></a>13514 <span class="comment">   unregister_usage, complete_iax2_unregister },</span>
<a name="l13515"></a>13515 <span class="comment"></span>
<a name="l13516"></a>13516 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;mtu&quot;, NULL },</span>
<a name="l13517"></a>13517 <span class="comment">   iax2_set_mtu, &quot;Set the IAX systemwide trunking MTU&quot;,</span>
<a name="l13518"></a>13518 <span class="comment">   set_mtu_usage, NULL, NULL },</span>
<a name="l13519"></a>13519 <span class="comment"></span>
<a name="l13520"></a>13520 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;users&quot;, NULL },</span>
<a name="l13521"></a>13521 <span class="comment">   iax2_show_users, &quot;List defined IAX users&quot;,</span>
<a name="l13522"></a>13522 <span class="comment">   show_users_usage },</span>
<a name="l13523"></a>13523 <span class="comment"></span>
<a name="l13524"></a>13524 <span class="comment">   { { &quot;iax2&quot;, &quot;prune&quot;, &quot;realtime&quot;, NULL },</span>
<a name="l13525"></a>13525 <span class="comment">   iax2_prune_realtime, &quot;Prune a cached realtime lookup&quot;,</span>
<a name="l13526"></a>13526 <span class="comment">   prune_realtime_usage, complete_iax2_show_peer },</span>
<a name="l13527"></a>13527 <span class="comment"></span>
<a name="l13528"></a>13528 <span class="comment">   { { &quot;iax2&quot;, &quot;reload&quot;, NULL },</span>
<a name="l13529"></a>13529 <span class="comment">   iax2_reload, &quot;Reload IAX configuration&quot;,</span>
<a name="l13530"></a>13530 <span class="comment">   iax2_reload_usage },</span>
<a name="l13531"></a>13531 <span class="comment"></span>
<a name="l13532"></a>13532 <span class="comment">   { { &quot;iax2&quot;, &quot;show&quot;, &quot;peer&quot;, NULL },</span>
<a name="l13533"></a>13533 <span class="comment">   iax2_show_peer, &quot;Show details on specific IAX peer&quot;,</span>
<a name="l13534"></a>13534 <span class="comment">   show_peer_usage, complete_iax2_show_peer },</span>
<a name="l13535"></a>13535 <span class="comment"></span>
<a name="l13536"></a>13536 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;debug&quot;, NULL },</span>
<a name="l13537"></a>13537 <span class="comment">   iax2_do_debug, &quot;Enable IAX debugging&quot;,</span>
<a name="l13538"></a>13538 <span class="comment">   debug_usage },</span>
<a name="l13539"></a>13539 <span class="comment"></span>
<a name="l13540"></a>13540 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;debug&quot;, &quot;trunk&quot;, NULL },</span>
<a name="l13541"></a>13541 <span class="comment">   iax2_do_trunk_debug, &quot;Enable IAX trunk debugging&quot;,</span>
<a name="l13542"></a>13542 <span class="comment">   debug_trunk_usage },</span>
<a name="l13543"></a>13543 <span class="comment"></span>
<a name="l13544"></a>13544 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;debug&quot;, &quot;jb&quot;, NULL },</span>
<a name="l13545"></a>13545 <span class="comment">   iax2_do_jb_debug, &quot;Enable IAX jitterbuffer debugging&quot;,</span>
<a name="l13546"></a>13546 <span class="comment">   debug_jb_usage },</span>
<a name="l13547"></a>13547 <span class="comment"></span>
<a name="l13548"></a>13548 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;debug&quot;, &quot;off&quot;, NULL },</span>
<a name="l13549"></a>13549 <span class="comment">   iax2_no_debug, &quot;Disable IAX debugging&quot;,</span>
<a name="l13550"></a>13550 <span class="comment">   no_debug_usage },</span>
<a name="l13551"></a>13551 <span class="comment"></span>
<a name="l13552"></a>13552 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;debug&quot;, &quot;trunk&quot;, &quot;off&quot;, NULL },</span>
<a name="l13553"></a>13553 <span class="comment">   iax2_no_trunk_debug, &quot;Disable IAX trunk debugging&quot;,</span>
<a name="l13554"></a>13554 <span class="comment">   no_debug_trunk_usage },</span>
<a name="l13555"></a>13555 <span class="comment"></span>
<a name="l13556"></a>13556 <span class="comment">   { { &quot;iax2&quot;, &quot;set&quot;, &quot;debug&quot;, &quot;jb&quot;, &quot;off&quot;, NULL },</span>
<a name="l13557"></a>13557 <span class="comment">   iax2_no_jb_debug, &quot;Disable IAX jitterbuffer debugging&quot;,</span>
<a name="l13558"></a>13558 <span class="comment">   no_debug_jb_usage },</span>
<a name="l13559"></a>13559 <span class="comment"></span>
<a name="l13560"></a>13560 <span class="comment">   { { &quot;iax2&quot;, &quot;test&quot;, &quot;losspct&quot;, NULL },</span>
<a name="l13561"></a>13561 <span class="comment">   iax2_test_losspct, &quot;Set IAX2 incoming frame loss percentage&quot;,</span>
<a name="l13562"></a>13562 <span class="comment">   iax2_test_losspct_usage },</span>
<a name="l13563"></a>13563 <span class="comment"></span>
<a name="l13564"></a>13564 <span class="comment">   { { &quot;iax2&quot;, &quot;provision&quot;, NULL },</span>
<a name="l13565"></a>13565 <span class="comment">   iax2_prov_cmd, &quot;Provision an IAX device&quot;,</span>
<a name="l13566"></a>13566 <span class="comment">   show_prov_usage, iax2_prov_complete_template_3rd },</span>
<a name="l13567"></a>13567 <span class="comment"></span>
<a name="l13568"></a>13568 <span class="comment">#ifdef IAXTESTS</span>
<a name="l13569"></a>13569 <span class="comment">   { { &quot;iax2&quot;, &quot;test&quot;, &quot;late&quot;, NULL },</span>
<a name="l13570"></a>13570 <span class="comment">   iax2_test_late, &quot;Test the receipt of a late frame&quot;,</span>
<a name="l13571"></a>13571 <span class="comment">   iax2_test_late_usage },</span>
<a name="l13572"></a>13572 <span class="comment"></span>
<a name="l13573"></a>13573 <span class="comment">   { { &quot;iax2&quot;, &quot;test&quot;, &quot;resync&quot;, NULL },</span>
<a name="l13574"></a>13574 <span class="comment">   iax2_test_resync, &quot;Test a resync in received timestamps&quot;,</span>
<a name="l13575"></a>13575 <span class="comment">   iax2_test_resync_usage },</span>
<a name="l13576"></a>13576 <span class="comment"></span>
<a name="l13577"></a>13577 <span class="comment">   { { &quot;iax2&quot;, &quot;test&quot;, &quot;jitter&quot;, NULL },</span>
<a name="l13578"></a>13578 <span class="comment">   iax2_test_jitter, &quot;Simulates jitter for testing&quot;,</span>
<a name="l13579"></a>13579 <span class="comment">   iax2_test_jitter_usage },</span>
<a name="l13580"></a>13580 <span class="comment">#endif</span>
<a name="l13581"></a>13581 <span class="comment">*/</span>
<a name="l13582"></a>13582 
<a name="l13583"></a><a class="code" href="chan__iax2_8c.html#af087011e4300f79eea242a041f7fdb17">13583</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="chan__iax2_8c.html#af087011e4300f79eea242a041f7fdb17">cli_iax2</a>[] = {
<a name="l13584"></a>13584    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a1cd767c02642a7d22ab73562d91dfbb3">handle_cli_iax2_provision</a>,           <span class="stringliteral">&quot;Provision an IAX device&quot;</span>),
<a name="l13585"></a>13585    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a0a0b0536de61b276f4c872c064476e76">handle_cli_iax2_prune_realtime</a>,      <span class="stringliteral">&quot;Prune a cached realtime lookup&quot;</span>),
<a name="l13586"></a>13586    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#ad6dec5f1a4157f14c5f769da1f24272b">handle_cli_iax2_reload</a>,              <span class="stringliteral">&quot;Reload IAX configuration&quot;</span>),
<a name="l13587"></a>13587    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a772243800fb1a40f2ac2134219fc7183" title="Set trunk MTU from CLI.">handle_cli_iax2_set_mtu</a>,             <span class="stringliteral">&quot;Set the IAX systemwide trunking MTU&quot;</span>),
<a name="l13588"></a>13588    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a2e52a0e0ea3114f71e2408fc3c6084db">handle_cli_iax2_set_debug</a>,           <span class="stringliteral">&quot;Enable/Disable IAX debugging&quot;</span>),
<a name="l13589"></a>13589    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a0c477468f7f3577ccebd391a62b1816c">handle_cli_iax2_set_debug_trunk</a>,     <span class="stringliteral">&quot;Enable/Disable IAX trunk debugging&quot;</span>),
<a name="l13590"></a>13590    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a76e93829bebf411da745d683a63e02c6">handle_cli_iax2_set_debug_jb</a>,        <span class="stringliteral">&quot;Enable/Disable IAX jitterbuffer debugging&quot;</span>),
<a name="l13591"></a>13591    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#ac3ef173addda138f303206465b851614">handle_cli_iax2_show_cache</a>,          <span class="stringliteral">&quot;Display IAX cached dialplan&quot;</span>),
<a name="l13592"></a>13592    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a68c1693aae3f48bf874584ca36db89c4">handle_cli_iax2_show_channels</a>,       <span class="stringliteral">&quot;List active IAX channels&quot;</span>),
<a name="l13593"></a>13593    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a8d9a0db02bc32783280bb07e4477275a">handle_cli_iax2_show_firmware</a>,       <span class="stringliteral">&quot;List available IAX firmware&quot;</span>),
<a name="l13594"></a>13594    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a9eb2265a744bce420184954f86ba3fdc">handle_cli_iax2_show_netstats</a>,       <span class="stringliteral">&quot;List active IAX channel netstats&quot;</span>),
<a name="l13595"></a>13595    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a318a922128d4a2d200263cbaaae6ef38" title="Show one peer in detail.">handle_cli_iax2_show_peer</a>,           <span class="stringliteral">&quot;Show details on specific IAX peer&quot;</span>),
<a name="l13596"></a>13596    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#ac7775dacce1a57ea4f4d57dfd952737a">handle_cli_iax2_show_peers</a>,          <span class="stringliteral">&quot;List defined IAX peers&quot;</span>),
<a name="l13597"></a>13597    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a698aa48a1fdd30e3767c395d499e0357">handle_cli_iax2_show_registry</a>,       <span class="stringliteral">&quot;Display IAX registration status&quot;</span>),
<a name="l13598"></a>13598    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#aa533b4526f161d72607393aa85531d01">handle_cli_iax2_show_stats</a>,          <span class="stringliteral">&quot;Display IAX statistics&quot;</span>),
<a name="l13599"></a>13599    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#ae96aabd3e9adc0f216e6a089d95064c8">handle_cli_iax2_show_threads</a>,        <span class="stringliteral">&quot;Display IAX helper thread info&quot;</span>),
<a name="l13600"></a>13600    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#ac03f459dcfd393ca782d40817ce11f15">handle_cli_iax2_show_users</a>,          <span class="stringliteral">&quot;List defined IAX users&quot;</span>),
<a name="l13601"></a>13601    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a6b8fc2e4b6f2525c43f97a4bbe69a80d">handle_cli_iax2_test_losspct</a>,        <span class="stringliteral">&quot;Set IAX2 incoming frame loss percentage&quot;</span>),
<a name="l13602"></a>13602    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#a965752556c82e93521ee4c2a4edc1fd3">handle_cli_iax2_unregister</a>,          <span class="stringliteral">&quot;Unregister (force expiration) an IAX2 peer from the registry&quot;</span>),
<a name="l13603"></a>13603    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="chan__iax2_8c.html#ad6389d247beb77ba3d24be09af407161">handle_cli_iax2_show_callno_limits</a>,  <span class="stringliteral">&quot;Show current entries in IP call number limit table&quot;</span>),
<a name="l13604"></a>13604 <span class="preprocessor">#ifdef IAXTESTS</span>
<a name="l13605"></a>13605 <span class="preprocessor"></span>   <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(handle_cli_iax2_test_jitter,         <span class="stringliteral">&quot;Simulates jitter for testing&quot;</span>),
<a name="l13606"></a>13606    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(handle_cli_iax2_test_late,           <span class="stringliteral">&quot;Test the receipt of a late frame&quot;</span>),
<a name="l13607"></a>13607    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(handle_cli_iax2_test_resync,         <span class="stringliteral">&quot;Test a resync in received timestamps&quot;</span>),
<a name="l13608"></a>13608 <span class="preprocessor">#endif </span><span class="comment">/* IAXTESTS */</span>
<a name="l13609"></a>13609 };
<a name="l13610"></a>13610 
<a name="l13611"></a><a class="code" href="chan__iax2_8c.html#a2fd806029fe936c297e52d2236092fc0">13611</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>(<span class="keywordtype">void</span>)
<a name="l13612"></a>13612 {
<a name="l13613"></a>13613    <span class="keyword">struct </span><a class="code" href="structiax2__thread.html">iax2_thread</a> *<a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a> = NULL;
<a name="l13614"></a>13614    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con;
<a name="l13615"></a>13615    <span class="keywordtype">int</span> x;
<a name="l13616"></a>13616 
<a name="l13617"></a>13617    <span class="comment">/* Make sure threads do not hold shared resources when they are canceled */</span>
<a name="l13618"></a>13618    
<a name="l13619"></a>13619    <span class="comment">/* Grab the sched lock resource to keep it away from threads about to die */</span>
<a name="l13620"></a>13620    <span class="comment">/* Cancel the network thread, close the net socket */</span>
<a name="l13621"></a>13621    <span class="keywordflow">if</span> (netthreadid != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l13622"></a>13622       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;frame_queue);
<a name="l13623"></a>13623       pthread_cancel(netthreadid);
<a name="l13624"></a>13624       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;frame_queue);
<a name="l13625"></a>13625       pthread_join(netthreadid, NULL);
<a name="l13626"></a>13626    }
<a name="l13627"></a>13627 
<a name="l13628"></a>13628    sched = <a class="code" href="sched_8h.html#a999272a0a148dae5131da23d78050797" title="Destroy a scheduler and its thread.">ast_sched_thread_destroy</a>(sched);
<a name="l13629"></a>13629    
<a name="l13630"></a>13630    <span class="comment">/* Call for all threads to halt */</span>
<a name="l13631"></a>13631    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;idle_list);
<a name="l13632"></a>13632    <span class="keywordflow">while</span> ((thread = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;idle_list, list)))
<a name="l13633"></a>13633       pthread_cancel(thread-&gt;threadid);
<a name="l13634"></a>13634    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;idle_list);
<a name="l13635"></a>13635 
<a name="l13636"></a>13636    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;active_list);
<a name="l13637"></a>13637    <span class="keywordflow">while</span> ((thread = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;active_list, list)))
<a name="l13638"></a>13638       pthread_cancel(thread-&gt;threadid);
<a name="l13639"></a>13639    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;active_list);
<a name="l13640"></a>13640 
<a name="l13641"></a>13641    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;dynamic_list);
<a name="l13642"></a>13642    <span class="keywordflow">while</span> ((thread = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;dynamic_list, list)))
<a name="l13643"></a>13643       pthread_cancel(thread-&gt;threadid);
<a name="l13644"></a>13644    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;dynamic_list);
<a name="l13645"></a>13645    
<a name="l13646"></a>13646    <span class="comment">/* Wait for threads to exit */</span>
<a name="l13647"></a>13647    <span class="keywordflow">while</span>(0 &lt; <a class="code" href="chan__iax2_8c.html#a7b6613353aee0a0b41a8f18ffcc7268f">iaxactivethreadcount</a>)
<a name="l13648"></a>13648       usleep(10000);
<a name="l13649"></a>13649    
<a name="l13650"></a>13650    <a class="code" href="netsock_8h.html#a13b5f6a10c9ed23a3734adca3cc4b27f">ast_netsock_release</a>(netsock);
<a name="l13651"></a>13651    <a class="code" href="netsock_8h.html#a13b5f6a10c9ed23a3734adca3cc4b27f">ast_netsock_release</a>(outsock);
<a name="l13652"></a>13652    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>); x++) {
<a name="l13653"></a>13653       <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>[x]) {
<a name="l13654"></a>13654          <a class="code" href="chan__iax2_8c.html#a72642cd9d80c72258c2e17abf7905eeb">iax2_destroy</a>(x);
<a name="l13655"></a>13655       }
<a name="l13656"></a>13656    }
<a name="l13657"></a>13657    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>( <span class="stringliteral">&quot;IAXpeers&quot;</span> );
<a name="l13658"></a>13658    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>( <span class="stringliteral">&quot;IAXpeerlist&quot;</span> );
<a name="l13659"></a>13659    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>( <span class="stringliteral">&quot;IAXnetstats&quot;</span> );
<a name="l13660"></a>13660    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>( <span class="stringliteral">&quot;IAXregistry&quot;</span> );
<a name="l13661"></a>13661    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="chan__iax2_8c.html#a8e3f0b704ce531247d450cabfb44b503">papp</a>);
<a name="l13662"></a>13662    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<a class="code" href="chan__iax2_8c.html#af087011e4300f79eea242a041f7fdb17">cli_iax2</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#af087011e4300f79eea242a041f7fdb17">cli_iax2</a>));
<a name="l13663"></a>13663    <a class="code" href="pbx_8h.html#a4b11d763a689cb0df33a4a16c9d89ef3" title="Unregister an alternative switch.">ast_unregister_switch</a>(&amp;<a class="code" href="chan__iax2_8c.html#a87b682391daa991ea04ed53e09bdf279">iax2_switch</a>);
<a name="l13664"></a>13664    <a class="code" href="channel_8h.html#a53b708b7fc71dcbcd33acae0ad4d7ef8" title="Unregister a channel technology.">ast_channel_unregister</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>);
<a name="l13665"></a>13665    <a class="code" href="chan__iax2_8c.html#ace322a3e8008af8b872b72770e97fa85">delete_users</a>();
<a name="l13666"></a>13666    <a class="code" href="iax2-provision_8c.html#a91a2d80b234f3c818eb02b6d24aea4ce">iax_provision_unload</a>();
<a name="l13667"></a>13667    <a class="code" href="chan__iax2_8c.html#a1474fd7c7eb179434b5be3102652a0f0">reload_firmware</a>(1);
<a name="l13668"></a>13668 
<a name="l13669"></a>13669    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>); x++) {
<a name="l13670"></a>13670       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l13671"></a>13671    }
<a name="l13672"></a>13672 
<a name="l13673"></a>13673    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peers, -1);
<a name="l13674"></a>13674    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(users, -1);
<a name="l13675"></a>13675    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>, -1);
<a name="l13676"></a>13676    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>, -1);
<a name="l13677"></a>13677    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnts, -1);
<a name="l13678"></a>13678    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_limits, -1);
<a name="l13679"></a>13679    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(calltoken_ignores, -1);
<a name="l13680"></a>13680    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_pool, -1);
<a name="l13681"></a>13681    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_pool_trunk, -1);
<a name="l13682"></a>13682    <span class="keywordflow">if</span> (timer) {
<a name="l13683"></a>13683       <a class="code" href="timing_8h.html#a2a5968baf9962dedeeda855fd5ed9c75" title="Close an opened timing handle.">ast_timer_close</a>(timer);
<a name="l13684"></a>13684    }
<a name="l13685"></a>13685 
<a name="l13686"></a>13686    con = <a class="code" href="pbx_8h.html#a2af2d2771e5347b18454a05dbc98e35f" title="Find a context.">ast_context_find</a>(regcontext);
<a name="l13687"></a>13687    <span class="keywordflow">if</span> (con)
<a name="l13688"></a>13688       <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(con, <span class="stringliteral">&quot;IAX2&quot;</span>);
<a name="l13689"></a>13689    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>);
<a name="l13690"></a>13690    <span class="keywordflow">return</span> 0;
<a name="l13691"></a>13691 }
<a name="l13692"></a>13692 
<a name="l13693"></a><a class="code" href="chan__iax2_8c.html#ad09fa931f468002152a3cc2d5ce25eae">13693</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l13694"></a>13694 {
<a name="l13695"></a>13695    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="chan__iax2_8c.html#a3b156a89a2aa9ce1b8bae58bc8d3a5e6">iaxpeer_function</a>);
<a name="l13696"></a>13696    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="chan__iax2_8c.html#a2d5637f32186301ce90427bd34116958">iaxvar_function</a>);
<a name="l13697"></a>13697    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>();
<a name="l13698"></a>13698 }
<a name="l13699"></a>13699 
<a name="l13700"></a><a class="code" href="chan__iax2_8c.html#ad29a32b95cbb78706b9c9d7d35bf5d0a">13700</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ad29a32b95cbb78706b9c9d7d35bf5d0a">peer_set_sock_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l13701"></a>13701 {
<a name="l13702"></a>13702    <span class="keyword">struct </span><a class="code" href="structiax2__peer.html">iax2_peer</a> *peer = obj;
<a name="l13703"></a>13703 
<a name="l13704"></a>13704    <span class="keywordflow">if</span> (peer-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> &lt; 0)
<a name="l13705"></a>13705       peer-&gt;<a class="code" href="structiax2__peer.html#ad2c8fb3df3a737e0685e902870a611d2">sockfd</a> = defaultsockfd;
<a name="l13706"></a>13706 
<a name="l13707"></a>13707    <span class="keywordflow">return</span> 0;
<a name="l13708"></a>13708 }
<a name="l13709"></a>13709 
<a name="l13710"></a><a class="code" href="chan__iax2_8c.html#a4877104d2177d77b958bd056e18c045d">13710</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a4877104d2177d77b958bd056e18c045d">pvt_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structiax2__peer.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l13711"></a>13711 {
<a name="l13712"></a>13712    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = obj;
<a name="l13713"></a>13713 
<a name="l13714"></a>13714    <span class="keywordflow">return</span> pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a802fa92be72c3bb327070aa6c0faa93f">peercallno</a>;
<a name="l13715"></a>13715 }
<a name="l13716"></a>13716 
<a name="l13717"></a><a class="code" href="chan__iax2_8c.html#a7e4ef107c232c0ea8aa3d22d442535df">13717</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a7e4ef107c232c0ea8aa3d22d442535df">pvt_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structchan__iax2__pvt.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l13718"></a>13718 {
<a name="l13719"></a>13719    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = obj, *pvt2 = arg;
<a name="l13720"></a>13720 
<a name="l13721"></a>13721    <span class="comment">/* The frames_received field is used to hold whether we&apos;re matching</span>
<a name="l13722"></a>13722 <span class="comment">    * against a full frame or not ... */</span>
<a name="l13723"></a>13723 
<a name="l13724"></a>13724    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>(&amp;pvt2-&gt;addr, pvt2-&gt;peercallno, pvt2-&gt;callno, pvt, 
<a name="l13725"></a>13725       pvt2-&gt;frames_received) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l13726"></a>13726 }
<a name="l13727"></a>13727 
<a name="l13728"></a><a class="code" href="chan__iax2_8c.html#aa97c9a3922e7a1855b553d2601a6fd24">13728</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#aa97c9a3922e7a1855b553d2601a6fd24">transfercallno_pvt_hash_cb</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structchan__iax2__pvt.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l13729"></a>13729 {
<a name="l13730"></a>13730    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = obj;
<a name="l13731"></a>13731 
<a name="l13732"></a>13732    <span class="keywordflow">return</span> pvt-&gt;<a class="code" href="structchan__iax2__pvt.html#a8c332e66993818cb74184200cd4b02cc">transfercallno</a>;
<a name="l13733"></a>13733 }
<a name="l13734"></a>13734 
<a name="l13735"></a><a class="code" href="chan__iax2_8c.html#a678c3af48aa73067f847d2645aee9b06">13735</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a678c3af48aa73067f847d2645aee9b06">transfercallno_pvt_cmp_cb</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> <a class="code" href="structchan__iax2__pvt.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l13736"></a>13736 {
<a name="l13737"></a>13737    <span class="keyword">struct </span><a class="code" href="structchan__iax2__pvt.html">chan_iax2_pvt</a> *pvt = obj, *pvt2 = arg;
<a name="l13738"></a>13738 
<a name="l13739"></a>13739    <span class="comment">/* The frames_received field is used to hold whether we&apos;re matching</span>
<a name="l13740"></a>13740 <span class="comment">    * against a full frame or not ... */</span>
<a name="l13741"></a>13741 
<a name="l13742"></a>13742    <span class="keywordflow">return</span> <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a>(&amp;pvt2-&gt;transfer, pvt2-&gt;transfercallno, pvt2-&gt;callno, pvt,
<a name="l13743"></a>13743       pvt2-&gt;frames_received) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> | <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a75382dc9117cc118719edf6c3d2b71df">CMP_STOP</a> : 0;
<a name="l13744"></a>13744 }
<a name="l13745"></a>13745 
<a name="l13746"></a><a class="code" href="chan__iax2_8c.html#a3bf48dd3a7077ec7143da417ec47b47d">13746</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#a3bf48dd3a7077ec7143da417ec47b47d">load_objects</a>(<span class="keywordtype">void</span>)
<a name="l13747"></a>13747 {
<a name="l13748"></a>13748    peers = users = <a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a> = <a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a> = NULL;
<a name="l13749"></a>13749    peercnts = callno_limits = calltoken_ignores = callno_pool = callno_pool_trunk = NULL;
<a name="l13750"></a>13750 
<a name="l13751"></a>13751    <span class="keywordflow">if</span> (!(peers = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="chan__iax2_8c.html#af951e872e0ade75ce2faa6b5660ab78a">MAX_PEER_BUCKETS</a>, <a class="code" href="chan__iax2_8c.html#a154481c76db5a5bc57a83662466323e4">peer_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#a29a91cbcaae8787fa5837a9cb455b0e7">peer_cmp_cb</a>))) {
<a name="l13752"></a>13752       <span class="keywordflow">goto</span> container_fail;
<a name="l13753"></a>13753    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(users = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="chan__iax2_8c.html#a0093d2299b135a3be5d1e7775f2af02d">MAX_USER_BUCKETS</a>, <a class="code" href="chan__iax2_8c.html#ab3fcaa495f89153355cbf35be9a49a42">user_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#a52a9a7c9943bb81e2d89050e953f29a0">user_cmp_cb</a>))) {
<a name="l13754"></a>13754       <span class="keywordflow">goto</span> container_fail;
<a name="l13755"></a>13755    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="iax2_8h.html#ae9b21f0bc9515b8e4d605437993b5b5f">IAX_MAX_CALLS</a>, <a class="code" href="chan__iax2_8c.html#a4877104d2177d77b958bd056e18c045d">pvt_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#a7e4ef107c232c0ea8aa3d22d442535df">pvt_cmp_cb</a>))) {
<a name="l13756"></a>13756       <span class="keywordflow">goto</span> container_fail;
<a name="l13757"></a>13757    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="iax2_8h.html#ae9b21f0bc9515b8e4d605437993b5b5f">IAX_MAX_CALLS</a>, <a class="code" href="chan__iax2_8c.html#aa97c9a3922e7a1855b553d2601a6fd24">transfercallno_pvt_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#a678c3af48aa73067f847d2645aee9b06">transfercallno_pvt_cmp_cb</a>))) {
<a name="l13758"></a>13758       <span class="keywordflow">goto</span> container_fail;
<a name="l13759"></a>13759    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(peercnts = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="chan__iax2_8c.html#af951e872e0ade75ce2faa6b5660ab78a">MAX_PEER_BUCKETS</a>, <a class="code" href="chan__iax2_8c.html#a1f5894c887d1f13763ad64f70da70d25">peercnt_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#afd4d124738c3198a352618f832ceb53d">peercnt_cmp_cb</a>))) {
<a name="l13760"></a>13760       <span class="keywordflow">goto</span> container_fail;
<a name="l13761"></a>13761    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(callno_limits = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="chan__iax2_8c.html#af951e872e0ade75ce2faa6b5660ab78a">MAX_PEER_BUCKETS</a>, <a class="code" href="chan__iax2_8c.html#a4800087727fb124e0ec03bc8490608a9">addr_range_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#ac6f1ac1624ba561a9e25817e931fa861">addr_range_cmp_cb</a>))) {
<a name="l13762"></a>13762       <span class="keywordflow">goto</span> container_fail;
<a name="l13763"></a>13763    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(calltoken_ignores = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(<a class="code" href="chan__iax2_8c.html#af951e872e0ade75ce2faa6b5660ab78a">MAX_PEER_BUCKETS</a>, <a class="code" href="chan__iax2_8c.html#a4800087727fb124e0ec03bc8490608a9">addr_range_hash_cb</a>, <a class="code" href="chan__iax2_8c.html#ac6f1ac1624ba561a9e25817e931fa861">addr_range_cmp_cb</a>))) {
<a name="l13764"></a>13764       <span class="keywordflow">goto</span> container_fail;
<a name="l13765"></a>13765    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a8457400e03924a8e80ee16b943b44cfb">create_callno_pools</a>()) {
<a name="l13766"></a>13766       <span class="keywordflow">goto</span> container_fail;
<a name="l13767"></a>13767    }
<a name="l13768"></a>13768 
<a name="l13769"></a>13769    <span class="keywordflow">return</span> 0;
<a name="l13770"></a>13770 
<a name="l13771"></a>13771 container_fail:
<a name="l13772"></a>13772    <span class="keywordflow">if</span> (peers) {
<a name="l13773"></a>13773       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peers, -1);
<a name="l13774"></a>13774    }
<a name="l13775"></a>13775    <span class="keywordflow">if</span> (users) {
<a name="l13776"></a>13776       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(users, -1);
<a name="l13777"></a>13777    }
<a name="l13778"></a>13778    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>) {
<a name="l13779"></a>13779       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="chan__iax2_8c.html#afd9184ba37aa220a4b38b776fbe046de" title="Another container of iax2_pvt structures.">iax_peercallno_pvts</a>, -1);
<a name="l13780"></a>13780    }
<a name="l13781"></a>13781    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>) {
<a name="l13782"></a>13782       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="chan__iax2_8c.html#a65eb6bffa9c922d0c0ff963f8f955474" title="Another container of iax2_pvt structures.">iax_transfercallno_pvts</a>, -1);
<a name="l13783"></a>13783    }
<a name="l13784"></a>13784    <span class="keywordflow">if</span> (peercnts) {
<a name="l13785"></a>13785       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(peercnts, -1);
<a name="l13786"></a>13786    }
<a name="l13787"></a>13787    <span class="keywordflow">if</span> (callno_limits) {
<a name="l13788"></a>13788       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_limits, -1);
<a name="l13789"></a>13789    }
<a name="l13790"></a>13790    <span class="keywordflow">if</span> (calltoken_ignores) {
<a name="l13791"></a>13791       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(calltoken_ignores, -1);
<a name="l13792"></a>13792    }
<a name="l13793"></a>13793    <span class="keywordflow">if</span> (callno_pool) {
<a name="l13794"></a>13794       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_pool, -1);
<a name="l13795"></a>13795    }
<a name="l13796"></a>13796    <span class="keywordflow">if</span> (callno_pool_trunk) {
<a name="l13797"></a>13797       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(callno_pool_trunk, -1);
<a name="l13798"></a>13798    }
<a name="l13799"></a>13799    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13800"></a>13800 }
<a name="l13801"></a>13801 
<a name="l13802"></a>13802 
<a name="l13803"></a>13803 <span class="comment"></span>
<a name="l13804"></a>13804 <span class="comment">/*! \brief Load IAX2 module, load configuraiton ---*/</span>
<a name="l13805"></a><a class="code" href="chan__iax2_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">13805</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="chan__iax2_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Load IAX2 module, load configuraiton ---.">load_module</a>(<span class="keywordtype">void</span>)
<a name="l13806"></a>13806 {
<a name="l13807"></a>13807 
<a name="l13808"></a>13808    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>[] = <span class="stringliteral">&quot;iax.conf&quot;</span>;
<a name="l13809"></a>13809    <span class="keywordtype">int</span> x = 0;
<a name="l13810"></a>13810    <span class="keyword">struct </span>iax2_registry *reg = NULL;
<a name="l13811"></a>13811 
<a name="l13812"></a>13812    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a3bf48dd3a7077ec7143da417ec47b47d">load_objects</a>()) {
<a name="l13813"></a>13813       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13814"></a>13814    }
<a name="l13815"></a>13815 
<a name="l13816"></a>13816    randomcalltokendata = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>();
<a name="l13817"></a>13817    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="chan__iax2_8c.html#a3b156a89a2aa9ce1b8bae58bc8d3a5e6">iaxpeer_function</a>);
<a name="l13818"></a>13818    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="chan__iax2_8c.html#a2d5637f32186301ce90427bd34116958">iaxvar_function</a>);
<a name="l13819"></a>13819 
<a name="l13820"></a>13820    <a class="code" href="iax2-parser_8c.html#a7dfa14e449512cc3937a0d8dd596aee5">iax_set_output</a>(<a class="code" href="chan__iax2_8c.html#a3d74c6e06cab9e36d323b36c830052f4">iax_debug_output</a>);
<a name="l13821"></a>13821    <a class="code" href="iax2-parser_8c.html#a6b6a249db189867d6e8c66f88c035097">iax_set_error</a>(<a class="code" href="chan__iax2_8c.html#a2b63a2e2db657cf7f745228ea6f573b4">iax_error_output</a>);
<a name="l13822"></a>13822    <a class="code" href="jitterbuf_8h.html#a5198ca5f2885b8b4a2579ba58e6f196f">jb_setoutput</a>(<a class="code" href="chan__iax2_8c.html#a151931af9817e64f2785ab62a97fee11">jb_error_output</a>, <a class="code" href="chan__iax2_8c.html#ab56f48224a51b039df6eee8168cc6e96">jb_warning_output</a>, NULL);
<a name="l13823"></a>13823 
<a name="l13824"></a>13824    memset(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="chan__iax2_8c.html#a0cb402a1e272ec52f1ccd7409e55f7f7" title="an array of iax2 pvt structures">iaxs</a>));
<a name="l13825"></a>13825 
<a name="l13826"></a>13826    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>); x++) {
<a name="l13827"></a>13827       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;<a class="code" href="chan__iax2_8c.html#a34fc30a857a2c47f0258de2d31202376" title="chan_iax2_pvt structure locks">iaxsl</a>[x]);
<a name="l13828"></a>13828    }
<a name="l13829"></a>13829 
<a name="l13830"></a>13830    <span class="keywordflow">if</span> (!(sched = <a class="code" href="sched_8h.html#a9bab503a0557af0b8a4fe04d06b69fb3" title="Create a scheduler with a dedicated thread.">ast_sched_thread_create</a>())) {
<a name="l13831"></a>13831       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create scheduler thread\n&quot;</span>);
<a name="l13832"></a>13832       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13833"></a>13833    }
<a name="l13834"></a>13834 
<a name="l13835"></a>13835    <span class="keywordflow">if</span> (!(io = <a class="code" href="io_8h.html#a7d66d121ef63109c2f55188a38b8240f" title="Creates a context Create a context for I/O operations Basically mallocs an IO structure...">io_context_create</a>())) {
<a name="l13836"></a>13836       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create I/O context\n&quot;</span>);
<a name="l13837"></a>13837       sched = <a class="code" href="sched_8h.html#a999272a0a148dae5131da23d78050797" title="Destroy a scheduler and its thread.">ast_sched_thread_destroy</a>(sched);
<a name="l13838"></a>13838       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13839"></a>13839    }
<a name="l13840"></a>13840 
<a name="l13841"></a>13841    <span class="keywordflow">if</span> (!(netsock = <a class="code" href="netsock_8h.html#acba2bd674fc0056db3c26ee438f1b396">ast_netsock_list_alloc</a>())) {
<a name="l13842"></a>13842       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create netsock list\n&quot;</span>);
<a name="l13843"></a>13843       <a class="code" href="io_8h.html#a5409251fbead35b5e59fe322e14446b9" title="Destroys a context.">io_context_destroy</a>(io);
<a name="l13844"></a>13844       sched = <a class="code" href="sched_8h.html#a999272a0a148dae5131da23d78050797" title="Destroy a scheduler and its thread.">ast_sched_thread_destroy</a>(sched);
<a name="l13845"></a>13845       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13846"></a>13846    }
<a name="l13847"></a>13847    <a class="code" href="netsock_8h.html#af937c8ae665f601a3bd9802c643b6599">ast_netsock_init</a>(netsock);
<a name="l13848"></a>13848    
<a name="l13849"></a>13849    outsock = <a class="code" href="netsock_8h.html#acba2bd674fc0056db3c26ee438f1b396">ast_netsock_list_alloc</a>();
<a name="l13850"></a>13850    <span class="keywordflow">if</span> (!outsock) {
<a name="l13851"></a>13851       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not allocate outsock list.\n&quot;</span>);
<a name="l13852"></a>13852       <a class="code" href="io_8h.html#a5409251fbead35b5e59fe322e14446b9" title="Destroys a context.">io_context_destroy</a>(io);
<a name="l13853"></a>13853       sched = <a class="code" href="sched_8h.html#a999272a0a148dae5131da23d78050797" title="Destroy a scheduler and its thread.">ast_sched_thread_destroy</a>(sched);
<a name="l13854"></a>13854       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13855"></a>13855    }
<a name="l13856"></a>13856    <a class="code" href="netsock_8h.html#af937c8ae665f601a3bd9802c643b6599">ast_netsock_init</a>(outsock);
<a name="l13857"></a>13857 
<a name="l13858"></a>13858    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="chan__iax2_8c.html#af087011e4300f79eea242a041f7fdb17">cli_iax2</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="chan__iax2_8c.html#af087011e4300f79eea242a041f7fdb17">cli_iax2</a>));
<a name="l13859"></a>13859 
<a name="l13860"></a>13860    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="chan__iax2_8c.html#a8e3f0b704ce531247d450cabfb44b503">papp</a>, <a class="code" href="group__applications.html#gad2402d98af3b54a22d8f5421b7e0d814">iax2_prov_app</a>);
<a name="l13861"></a>13861    
<a name="l13862"></a>13862    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>( <span class="stringliteral">&quot;IAXpeers&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="chan__iax2_8c.html#a04a8d61a72c9c2c5b046b5b18c18f1f4" title="callback to display iax peers in manager">manager_iax2_show_peers</a>, <span class="stringliteral">&quot;List IAX Peers&quot;</span> );
<a name="l13863"></a>13863    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>( <span class="stringliteral">&quot;IAXpeerlist&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="chan__iax2_8c.html#ad94a22fbc017b75cb057a4f925dfa4d0" title="callback to display iax peers in manager format">manager_iax2_show_peer_list</a>, <span class="stringliteral">&quot;List IAX Peers&quot;</span> );
<a name="l13864"></a>13864    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>( <span class="stringliteral">&quot;IAXnetstats&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="chan__iax2_8c.html#a72b0fcb17d98c9319451b7377d73cb8b">manager_iax2_show_netstats</a>, <span class="stringliteral">&quot;Show IAX Netstats&quot;</span> );
<a name="l13865"></a>13865    <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>( <span class="stringliteral">&quot;IAXregistry&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="chan__iax2_8c.html#a8ffe5b5e485072b501d24739bbf24be0">manager_iax2_show_registry</a>, <span class="stringliteral">&quot;Show IAX registrations&quot;</span>);
<a name="l13866"></a>13866 
<a name="l13867"></a>13867    <span class="keywordflow">if</span> ((timer = <a class="code" href="timing_8h.html#aacc341f127efc0dc0d62f6415694174a" title="Open a timer.">ast_timer_open</a>())) {
<a name="l13868"></a>13868       <a class="code" href="timing_8h.html#a4dae39fb5fb680a48a05d7567053eb03" title="Set the timing tick rate.">ast_timer_set_rate</a>(timer, trunkfreq);
<a name="l13869"></a>13869    }
<a name="l13870"></a>13870 
<a name="l13871"></a>13871    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#a588a54300638eba856f40104139c3986" title="Load configuration.">set_config</a>(config, 0) == -1) {
<a name="l13872"></a>13872       <span class="keywordflow">if</span> (timer) {
<a name="l13873"></a>13873          <a class="code" href="timing_8h.html#a2a5968baf9962dedeeda855fd5ed9c75" title="Close an opened timing handle.">ast_timer_close</a>(timer);
<a name="l13874"></a>13874       }
<a name="l13875"></a>13875       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l13876"></a>13876    }
<a name="l13877"></a>13877 
<a name="l13878"></a>13878    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ab5f3776fda943e52820ceeee5835c1b4" title="Register a channel technology (a new channel driver) Called by a channel module to...">ast_channel_register</a>(&amp;<a class="code" href="chan__iax2_8c.html#a0af0245e4ac84fd0d4c5fd5a61829ac5">iax2_tech</a>)) {
<a name="l13879"></a>13879       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register channel class %s\n&quot;</span>, <span class="stringliteral">&quot;IAX2&quot;</span>);
<a name="l13880"></a>13880       <a class="code" href="chan__iax2_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>();
<a name="l13881"></a>13881       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13882"></a>13882    }
<a name="l13883"></a>13883 
<a name="l13884"></a>13884    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a5297fa9c52ff50da5b08c7217d9251b4" title="Register an alternative dialplan switch.">ast_register_switch</a>(&amp;<a class="code" href="chan__iax2_8c.html#a87b682391daa991ea04ed53e09bdf279">iax2_switch</a>)) 
<a name="l13885"></a>13885       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register IAX switch\n&quot;</span>);
<a name="l13886"></a>13886 
<a name="l13887"></a>13887    <span class="keywordflow">if</span> (<a class="code" href="chan__iax2_8c.html#ae6509f01db3676a8f6cd3485afe7b94d">start_network_thread</a>()) {
<a name="l13888"></a>13888       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to start network thread\n&quot;</span>);
<a name="l13889"></a>13889       <a class="code" href="chan__iax2_8c.html#a2fd806029fe936c297e52d2236092fc0">__unload_module</a>();
<a name="l13890"></a>13890       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa8724da3ad620df86524280e760add388">AST_MODULE_LOAD_FAILURE</a>;
<a name="l13891"></a>13891    } <span class="keywordflow">else</span>
<a name="l13892"></a>13892       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;IAX Ready and Listening\n&quot;</span>);
<a name="l13893"></a>13893 
<a name="l13894"></a>13894    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;registrations);
<a name="l13895"></a>13895    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;registrations, reg, entry)
<a name="l13896"></a>13896       <a class="code" href="chan__iax2_8c.html#a99d37f49278a638351587cc76f129f80">iax2_do_register</a>(reg);
<a name="l13897"></a>13897    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;registrations); 
<a name="l13898"></a>13898    
<a name="l13899"></a>13899    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(peers, 0, <a class="code" href="chan__iax2_8c.html#ad29a32b95cbb78706b9c9d7d35bf5d0a">peer_set_sock_cb</a>, NULL);
<a name="l13900"></a>13900    <a class="code" href="astobj2_8h.html#a47857055118a703ae87ea5ebaf4842ed">ao2_callback</a>(peers, 0, <a class="code" href="chan__iax2_8c.html#a0cf3427f2d30b79547505abab2950d10">iax2_poke_peer_cb</a>, NULL);
<a name="l13901"></a>13901 
<a name="l13902"></a>13902 
<a name="l13903"></a>13903    <a class="code" href="chan__iax2_8c.html#a1474fd7c7eb179434b5be3102652a0f0">reload_firmware</a>(0);
<a name="l13904"></a>13904    <a class="code" href="iax2-provision_8c.html#a051a4fcc9414603f37de057900261c13">iax_provision_reload</a>(0);
<a name="l13905"></a>13905 
<a name="l13906"></a>13906    <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;iaxpeers&quot;</span>, <span class="stringliteral">&quot;name&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, 10, <span class="stringliteral">&quot;ipaddr&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, 15, <span class="stringliteral">&quot;port&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>, 5, <span class="stringliteral">&quot;regseconds&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>, 6, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l13907"></a>13907 
<a name="l13908"></a>13908    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l13909"></a>13909 }
<a name="l13910"></a>13910 
<a name="l13911"></a>13911 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Inter Asterisk eXchange (Ver 2)&quot;</span>,
<a name="l13912"></a>13912       .load = <a class="code" href="chan__iax2_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Load IAX2 module, load configuraiton ---.">load_module</a>,
<a name="l13913"></a>13913       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l13914"></a>13914       .<a class="code" href="chan__iax2_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="chan__iax2_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l13915"></a>13915       );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:33 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
