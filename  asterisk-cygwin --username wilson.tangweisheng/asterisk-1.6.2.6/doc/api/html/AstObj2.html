<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:23:35 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="AstObj2">Object Model implementing objects and containers. </a></h1><p>This module implements an abstraction for objects (with locks and reference counts), and containers for these user-defined objects, also supporting locking, reference counting and callbacks.</p>
<p>The internal implementation of objects and containers is opaque to the <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a>, so we can use different data structures as needs arise.</p>
<h2><a class="anchor" id="AstObj2_UsageObjects">
USAGE - OBJECTS</a></h2>
<p>An ao2 object is a block of memory that the <a class="el" href="structuser.html" title="structure to hold users read from users.conf">user</a> code can access, and for which the system keeps track (with a bit of help from the programmer) of the <a class="el" href="structnumber.html" title="Number structure.">number</a> of references around. When an object has no more references (refcount == 0), it is destroyed, by first invoking whatever 'destructor' function the programmer specifies (it can be NULL if none is necessary), and then freeing the memory. This way objects can be shared without worrying who is in charge of freeing them. As an additional feature, ao2 objects are associated to individual locks.</p>
<p>Creating an object requires the size of the object and and a pointer to the destructor function:</p>
<p>struct foo *o;</p>
<p>o = ao2_alloc(sizeof(struct foo), my_destructor_fn);</p>
<p>The value returned points to the user-visible portion of the objects (user-data), but is also used as an identifier for all object-related operations such as refcount and lock manipulations.</p>
<p>On return from <a class="el" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc()</a>:</p>
<ul>
<li>the object has a refcount = 1;</li>
<li>the memory for the object is allocated dynamically and zeroed;</li>
<li>we cannot <a class="el" href="astmm_8h.html#a40bca1270eac14ea5da81c924c02c3b7">realloc()</a> the object itself;</li>
<li>we cannot call <a class="el" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free(o)</a> to dispose of the object. Rather, we tell the system that we do not need the reference anymore:</li>
</ul>
<p>ao2_ref(o, -1)</p>
<p>causing the destructor to be called (and then memory freed) when the refcount goes to 0.</p>
<ul>
<li>ao2_ref(o, +1) can be used to modify the refcount on the object in case we want to pass it around.</li>
</ul>
<ul>
<li>ao2_lock(obj), ao2_unlock(obj), ao2_trylock(obj) can be used to manipulate the lock associated with the object.</li>
</ul>
<h2><a class="anchor" id="AstObj2_UsageContainers">
USAGE - CONTAINERS</a></h2>
<p>An ao2 container is an abstract data structure where we can store ao2 objects, search them (hopefully in an efficient way), and iterate or apply a callback function to them. A container is just an ao2 object itself.</p>
<p>A container must first be allocated, specifying the initial parameters. At the moment, this is done as follows:</p>
<p><b>Sample Usage:</b> </p>
<div class="fragment"><pre class="fragment">    <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *c;

    c = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(MAX_BUCKETS, my_hash_fn, my_cmp_fn);
</pre></div><p>where</p>
<ul>
<li>MAX_BUCKETS is the <a class="el" href="structnumber.html" title="Number structure.">number</a> of buckets in the hash table,</li>
<li>my_hash_fn() is the (user-supplied) function that returns a hash key for the object (further reduced modulo MAX_BUCKETS by the container's code);</li>
<li>my_cmp_fn() is the default comparison function used when doing searches on the container,</li>
</ul>
<p>A container knows little or nothing about the objects it stores, other than the fact that they have been created by <a class="el" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc()</a>. All knowledge of the (user-defined) internals of the objects is left to the (user-supplied) functions passed as arguments to <a class="el" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc()</a>.</p>
<p>If we want to insert an object in a container, we should initialize its fields -- especially, those used by my_hash_fn() -- to compute the <a class="el" href="structbucket.html">bucket</a> to use. Once done, we can link an object to a container with</p>
<p><a class="el" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link(c, o)</a>;</p>
<p>The function returns NULL in case of errors (and the object is not inserted in the container). Other <a class="el" href="structvalues.html">values</a> mean success (we are not supposed to use the value as a pointer to anything). Linking an object to a container increases its refcount by 1 automatically.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>While an object o is in a container, we expect that my_hash_fn(o) will always return the same value. The function does not lock the object to be computed, so modifications of those fields that affect the computation of the hash should be done by extracting the object from the container, and reinserting it after the change (this is not terribly expensive).</dd>
<dd>
A container with a single buckets is effectively a linked list. However there is no ordering among elements.</dd></dl>
<ul>
<li><a class="el" href="AstObj2_Containers.html">AstObj2 Containers</a></li>
<li><a class="el" href="astobj2_8h.html">astobj2.h</a> All documentation for functions and data structures </li>
</ul>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:23:35 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
