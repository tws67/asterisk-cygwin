<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:46 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_crypto.c</h1><a href="res__crypto_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Provide Cryptographic Signature capability</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \extref Uses the OpenSSL library, available at</span>
<a name="l00026"></a>00026 <span class="comment"> * http://www.openssl.org/</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="comment">/*** MODULEINFO</span>
<a name="l00030"></a>00030 <span class="comment">   &lt;depend&gt;openssl&lt;/depend&gt;</span>
<a name="l00031"></a>00031 <span class="comment"> ***/</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 205148 $&quot;</span>)
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;asterisk/paths.h&quot;   </span><span class="comment">/* use ast_config_AST_KEY_DIR */</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;openssl/ssl.h&gt;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &lt;openssl/err.h&gt;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="crypto_8h.html" title="Provide cryptographic signature routines.">asterisk/crypto.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="md5_8h.html" title="MD5 digest functions.">asterisk/md5.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="io_8h.html" title="I/O Management (derived from Cheops-NG).">asterisk/io.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a>00050 <span class="comment">/*</span>
<a name="l00051"></a>00051 <span class="comment"> * Asterisk uses RSA keys with SHA-1 message digests for its</span>
<a name="l00052"></a>00052 <span class="comment"> * digital signatures.  The choice of RSA is due to its higher</span>
<a name="l00053"></a>00053 <span class="comment"> * throughput on verification, and the choice of SHA-1 based</span>
<a name="l00054"></a>00054 <span class="comment"> * on the recently discovered collisions in MD5&apos;s compression </span>
<a name="l00055"></a>00055 <span class="comment"> * algorithm and recommendations of avoiding MD5 in new schemes</span>
<a name="l00056"></a>00056 <span class="comment"> * from various industry experts.</span>
<a name="l00057"></a>00057 <span class="comment"> *</span>
<a name="l00058"></a>00058 <span class="comment"> * We use OpenSSL to provide our crypto routines, although we never</span>
<a name="l00059"></a>00059 <span class="comment"> * actually use full-up SSL</span>
<a name="l00060"></a>00060 <span class="comment"> *</span>
<a name="l00061"></a>00061 <span class="comment"> */</span>
<a name="l00062"></a>00062 
<a name="l00063"></a><a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">00063</a> <span class="preprocessor">#define KEY_NEEDS_PASSCODE (1 &lt;&lt; 16)</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>
<a name="l00065"></a><a class="code" href="structast__key.html">00065</a> <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> {<span class="comment"></span>
<a name="l00066"></a>00066 <span class="comment">   /*! Name of entity */</span>
<a name="l00067"></a><a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">00067</a>    <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>[80];<span class="comment"></span>
<a name="l00068"></a>00068 <span class="comment">   /*! File name */</span>
<a name="l00069"></a><a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">00069</a>    <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>[256];<span class="comment"></span>
<a name="l00070"></a>00070 <span class="comment">   /*! Key type (AST_KEY_PUB or AST_KEY_PRIV, along with flags from above) */</span>
<a name="l00071"></a><a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">00071</a>    <span class="keywordtype">int</span> <a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>;<span class="comment"></span>
<a name="l00072"></a>00072 <span class="comment">   /*! RSA structure (if successfully loaded) */</span>
<a name="l00073"></a><a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">00073</a>    RSA *<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>;<span class="comment"></span>
<a name="l00074"></a>00074 <span class="comment">   /*! Whether we should be deleted */</span>
<a name="l00075"></a><a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">00075</a>    <span class="keywordtype">int</span> <a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a>;<span class="comment"></span>
<a name="l00076"></a>00076 <span class="comment">   /*! FD for input (or -1 if no input allowed, or -2 if we needed input) */</span>
<a name="l00077"></a><a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">00077</a>    <span class="keywordtype">int</span> <a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>;<span class="comment"></span>
<a name="l00078"></a>00078 <span class="comment">   /*! FD for output */</span>
<a name="l00079"></a><a class="code" href="structast__key.html#abc4dff7fa063d9a7b5f56d0273d40f7a">00079</a>    <span class="keywordtype">int</span> <a class="code" href="structast__key.html#abc4dff7fa063d9a7b5f56d0273d40f7a">outfd</a>;<span class="comment"></span>
<a name="l00080"></a>00080 <span class="comment">   /*! Last MD5 Digest */</span>
<a name="l00081"></a><a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">00081</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>[16];
<a name="l00082"></a><a class="code" href="structast__key.html#afc242f7bc494d6836e43f198e4e71cf3">00082</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structast__key.html">ast_key</a>) <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>;
<a name="l00083"></a>00083 };
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="structkeys.html#ace4e0066a5b24f84b90536e9906619f6">00085</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structkeys.html">keys</a>, <a class="code" href="structast__key.html">ast_key</a>);
<a name="l00086"></a>00086 <span class="comment"></span>
<a name="l00087"></a>00087 <span class="comment">/*!</span>
<a name="l00088"></a>00088 <span class="comment"> * \brief setting of priv key</span>
<a name="l00089"></a>00089 <span class="comment"> * \param buf</span>
<a name="l00090"></a>00090 <span class="comment"> * \param size</span>
<a name="l00091"></a>00091 <span class="comment"> * \param rwflag</span>
<a name="l00092"></a>00092 <span class="comment"> * \param userdata</span>
<a name="l00093"></a>00093 <span class="comment"> * \return length of string,-1 on failure</span>
<a name="l00094"></a>00094 <span class="comment">*/</span>
<a name="l00095"></a><a class="code" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218">00095</a> static <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218" title="setting of priv key">pw_cb</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> size, <span class="keywordtype">int</span> rwflag, <span class="keywordtype">void</span> *userdata)
<a name="l00096"></a>00096 {
<a name="l00097"></a>00097    <span class="keyword">struct </span>ast_key *key = (<span class="keyword">struct </span>ast_key *)userdata;
<a name="l00098"></a>00098    <span class="keywordtype">char</span> <a class="code" href="asterisk_8c.html#a299365a3d8977a6c410c6cd924e33136">prompt</a>[256];
<a name="l00099"></a>00099    <span class="keywordtype">int</span> res, tmp;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> &lt; 0) {
<a name="l00102"></a>00102       <span class="comment">/* Note that we were at least called */</span>
<a name="l00103"></a>00103       key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> = -2;
<a name="l00104"></a>00104       <span class="keywordflow">return</span> -1;
<a name="l00105"></a>00105    }
<a name="l00106"></a>00106    
<a name="l00107"></a>00107    snprintf(prompt, <span class="keyword">sizeof</span>(prompt), <span class="stringliteral">&quot;&gt;&gt;&gt;&gt; passcode for %s key &apos;%s&apos;: &quot;</span>,
<a name="l00108"></a>00108        key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a> ? <span class="stringliteral">&quot;PRIVATE&quot;</span> : <span class="stringliteral">&quot;PUBLIC&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00109"></a>00109    <span class="keywordflow">if</span> (write(key-&gt;<a class="code" href="structast__key.html#abc4dff7fa063d9a7b5f56d0273d40f7a">outfd</a>, prompt, strlen(prompt)) &lt; 0) {
<a name="l00110"></a>00110       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00111"></a>00111       key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> = -2;
<a name="l00112"></a>00112       <span class="keywordflow">return</span> -1;
<a name="l00113"></a>00113    }
<a name="l00114"></a>00114    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l00115"></a>00115    tmp = <a class="code" href="io_8h.html#a30c650d779bfadbb34c52d7de2c616a9">ast_hide_password</a>(key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>);
<a name="l00116"></a>00116    memset(buf, 0, size);
<a name="l00117"></a>00117    res = read(key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>, buf, size);
<a name="l00118"></a>00118    <a class="code" href="io_8h.html#aa77b49897e9d1ca9640a8fdc8bc5c69b" title="Restores TTY mode. Call with result from previous ast_hide_password.">ast_restore_tty</a>(key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a>, tmp);
<a name="l00119"></a>00119    <span class="keywordflow">if</span> (buf[strlen(buf) -1] == <span class="charliteral">&apos;\n&apos;</span>)
<a name="l00120"></a>00120       buf[strlen(buf) - 1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00121"></a>00121    <span class="keywordflow">return</span> strlen(buf);
<a name="l00122"></a>00122 }
<a name="l00123"></a>00123 <span class="comment"></span>
<a name="l00124"></a>00124 <span class="comment">/*!</span>
<a name="l00125"></a>00125 <span class="comment"> * \brief return the ast_key structure for name</span>
<a name="l00126"></a>00126 <span class="comment"> * \see ast_key_get</span>
<a name="l00127"></a>00127 <span class="comment">*/</span>
<a name="l00128"></a><a class="code" href="res__crypto_8c.html#a30abfec91d1a3e0fd585675d9fd8f297">00128</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *<a class="code" href="res__crypto_8c.html#a30abfec91d1a3e0fd585675d9fd8f297" title="return the ast_key structure for name">__ast_key_get</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *kname, <span class="keywordtype">int</span> <a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>)
<a name="l00129"></a>00129 {
<a name="l00130"></a>00130    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00131"></a>00131 
<a name="l00132"></a>00132    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00133"></a>00133    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00134"></a>00134       <span class="keywordflow">if</span> (!strcmp(kname, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>) &amp;&amp;
<a name="l00135"></a>00135           (ktype == key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>))
<a name="l00136"></a>00136          <span class="keywordflow">break</span>;
<a name="l00137"></a>00137    }
<a name="l00138"></a>00138    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    <span class="keywordflow">return</span> key;
<a name="l00141"></a>00141 }
<a name="l00142"></a>00142 <span class="comment"></span>
<a name="l00143"></a>00143 <span class="comment">/*!</span>
<a name="l00144"></a>00144 <span class="comment"> * \brief load RSA key from file</span>
<a name="l00145"></a>00145 <span class="comment"> * \param dir directory string</span>
<a name="l00146"></a>00146 <span class="comment"> * \param fname name of file</span>
<a name="l00147"></a>00147 <span class="comment"> * \param ifd incoming file descriptor</span>
<a name="l00148"></a>00148 <span class="comment"> * \param ofd outgoing file descriptor</span>
<a name="l00149"></a>00149 <span class="comment"> * \param not2</span>
<a name="l00150"></a>00150 <span class="comment"> * \retval key on success.</span>
<a name="l00151"></a>00151 <span class="comment"> * \retval NULL on failure.</span>
<a name="l00152"></a>00152 <span class="comment">*/</span>
<a name="l00153"></a><a class="code" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731">00153</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *<a class="code" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731" title="load RSA key from file">try_load_key</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *fname, <span class="keywordtype">int</span> ifd, <span class="keywordtype">int</span> ofd, <span class="keywordtype">int</span> *not2)
<a name="l00154"></a>00154 {
<a name="l00155"></a>00155    <span class="keywordtype">int</span> <a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> = 0, found = 0;
<a name="l00156"></a>00156    <span class="keywordtype">char</span> *c = NULL, ffname[256];
<a name="l00157"></a>00157    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>[16];
<a name="l00158"></a>00158    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00159"></a>00159    <span class="keyword">struct </span><a class="code" href="structMD5Context.html">MD5Context</a> md5;
<a name="l00160"></a>00160    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00161"></a>00161    <span class="keyword">static</span> <span class="keywordtype">int</span> notice = 0;
<a name="l00162"></a>00162 
<a name="l00163"></a>00163    <span class="comment">/* Make sure its name is a public or private key */</span>
<a name="l00164"></a>00164    <span class="keywordflow">if</span> ((c = strstr(fname, <span class="stringliteral">&quot;.pub&quot;</span>)) &amp;&amp; !strcmp(c, <span class="stringliteral">&quot;.pub&quot;</span>))
<a name="l00165"></a>00165       ktype = <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>;
<a name="l00166"></a>00166    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((c = strstr(fname, <span class="stringliteral">&quot;.key&quot;</span>)) &amp;&amp; !strcmp(c, <span class="stringliteral">&quot;.key&quot;</span>))
<a name="l00167"></a>00167       ktype = <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>;
<a name="l00168"></a>00168    <span class="keywordflow">else</span>
<a name="l00169"></a>00169       <span class="keywordflow">return</span> NULL;
<a name="l00170"></a>00170 
<a name="l00171"></a>00171    <span class="comment">/* Get actual filename */</span>
<a name="l00172"></a>00172    snprintf(ffname, <span class="keyword">sizeof</span>(ffname), <span class="stringliteral">&quot;%s/%s&quot;</span>, dir, fname);
<a name="l00173"></a>00173 
<a name="l00174"></a>00174    <span class="comment">/* Open file */</span>
<a name="l00175"></a>00175    <span class="keywordflow">if</span> (!(f = fopen(ffname, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l00176"></a>00176       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open key file %s: %s\n&quot;</span>, ffname, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00177"></a>00177       <span class="keywordflow">return</span> NULL;
<a name="l00178"></a>00178    }
<a name="l00179"></a>00179 
<a name="l00180"></a>00180    <a class="code" href="md5_8h.html#a6bdca55813077d1c652a1f63608dac30">MD5Init</a>(&amp;md5);
<a name="l00181"></a>00181    <span class="keywordflow">while</span>(!feof(f)) {
<a name="l00182"></a>00182       <span class="comment">/* Calculate a &quot;whatever&quot; quality md5sum of the key */</span>
<a name="l00183"></a>00183       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00184"></a>00184       <span class="keywordflow">if</span> (!fgets(buf, <span class="keyword">sizeof</span>(buf), f)) {
<a name="l00185"></a>00185          <span class="keywordflow">continue</span>;
<a name="l00186"></a>00186       }
<a name="l00187"></a>00187       <span class="keywordflow">if</span> (!feof(f))
<a name="l00188"></a>00188          <a class="code" href="md5_8h.html#a2a146d25ee54b589dd79d776522ef742">MD5Update</a>(&amp;md5, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) buf, strlen(buf));
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190    <a class="code" href="md5_8h.html#a7132b90c03637ae151c1a8befd7989f2">MD5Final</a>(digest, &amp;md5);
<a name="l00191"></a>00191 
<a name="l00192"></a>00192    <span class="comment">/* Look for an existing key */</span>
<a name="l00193"></a>00193    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00194"></a>00194       <span class="keywordflow">if</span> (!strcasecmp(key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>, ffname))
<a name="l00195"></a>00195          <span class="keywordflow">break</span>;
<a name="l00196"></a>00196    }
<a name="l00197"></a>00197 
<a name="l00198"></a>00198    <span class="keywordflow">if</span> (key) {
<a name="l00199"></a>00199       <span class="comment">/* If the MD5 sum is the same, and it isn&apos;t awaiting a passcode </span>
<a name="l00200"></a>00200 <span class="comment">         then this is far enough */</span>
<a name="l00201"></a>00201       <span class="keywordflow">if</span> (!memcmp(digest, key-&gt;<a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>, 16) &amp;&amp;
<a name="l00202"></a>00202           !(key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>)) {
<a name="l00203"></a>00203          fclose(f);
<a name="l00204"></a>00204          key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 0;
<a name="l00205"></a>00205          <span class="keywordflow">return</span> NULL;
<a name="l00206"></a>00206       } <span class="keywordflow">else</span> {
<a name="l00207"></a>00207          <span class="comment">/* Preserve keytype */</span>
<a name="l00208"></a>00208          ktype = key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>;
<a name="l00209"></a>00209          <span class="comment">/* Recycle the same structure */</span>
<a name="l00210"></a>00210          found++;
<a name="l00211"></a>00211       }
<a name="l00212"></a>00212    }
<a name="l00213"></a>00213 
<a name="l00214"></a>00214    <span class="comment">/* Make fname just be the normal name now */</span>
<a name="l00215"></a>00215    *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00216"></a>00216    <span class="keywordflow">if</span> (!key) {
<a name="l00217"></a>00217       <span class="keywordflow">if</span> (!(key = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*key)))) {
<a name="l00218"></a>00218          fclose(f);
<a name="l00219"></a>00219          <span class="keywordflow">return</span> NULL;
<a name="l00220"></a>00220       }
<a name="l00221"></a>00221    }
<a name="l00222"></a>00222    <span class="comment">/* First the filename */</span>
<a name="l00223"></a>00223    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>, ffname, <span class="keyword">sizeof</span>(key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a>));
<a name="l00224"></a>00224    <span class="comment">/* Then the name */</span>
<a name="l00225"></a>00225    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>, fname, <span class="keyword">sizeof</span>(key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l00226"></a>00226    key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> = ktype;
<a name="l00227"></a>00227    <span class="comment">/* Yes, assume we&apos;re going to be deleted */</span>
<a name="l00228"></a>00228    key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 1;
<a name="l00229"></a>00229    <span class="comment">/* Keep the key type */</span>
<a name="l00230"></a>00230    memcpy(key-&gt;<a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>, digest, 16);
<a name="l00231"></a>00231    <span class="comment">/* Can I/O takes the FD we&apos;re given */</span>
<a name="l00232"></a>00232    key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> = ifd;
<a name="l00233"></a>00233    key-&gt;<a class="code" href="structast__key.html#abc4dff7fa063d9a7b5f56d0273d40f7a">outfd</a> = ofd;
<a name="l00234"></a>00234    <span class="comment">/* Reset the file back to the beginning */</span>
<a name="l00235"></a>00235    rewind(f);
<a name="l00236"></a>00236    <span class="comment">/* Now load the key with the right method */</span>
<a name="l00237"></a>00237    <span class="keywordflow">if</span> (ktype == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>)
<a name="l00238"></a>00238       key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a> = PEM_read_RSA_PUBKEY(f, NULL, <a class="code" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218" title="setting of priv key">pw_cb</a>, key);
<a name="l00239"></a>00239    <span class="keywordflow">else</span>
<a name="l00240"></a>00240       key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a> = PEM_read_RSAPrivateKey(f, NULL, <a class="code" href="res__crypto_8c.html#ad29e293470b893d5d245c8f801c40218" title="setting of priv key">pw_cb</a>, key);
<a name="l00241"></a>00241    fclose(f);
<a name="l00242"></a>00242    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>) {
<a name="l00243"></a>00243       <span class="keywordflow">if</span> (RSA_size(key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>) == 128) {
<a name="l00244"></a>00244          <span class="comment">/* Key loaded okay */</span>
<a name="l00245"></a>00245          key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp;= ~<a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>;
<a name="l00246"></a>00246          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Loaded %s key &apos;%s&apos;\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a> ? <span class="stringliteral">&quot;PUBLIC&quot;</span> : <span class="stringliteral">&quot;PRIVATE&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00247"></a>00247          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Key &apos;%s&apos; loaded OK\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00248"></a>00248          key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 0;
<a name="l00249"></a>00249       } <span class="keywordflow">else</span>
<a name="l00250"></a>00250          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Key &apos;%s&apos; is not expected size.\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00251"></a>00251    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a13138ffb921b572151af5d7862a086ea">infd</a> != -2) {
<a name="l00252"></a>00252       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Key load %s &apos;%s&apos; failed\n&quot;</span>,key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a> ? <span class="stringliteral">&quot;PUBLIC&quot;</span> : <span class="stringliteral">&quot;PRIVATE&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00253"></a>00253       <span class="keywordflow">if</span> (ofd &gt; -1)
<a name="l00254"></a>00254          ERR_print_errors_fp(stderr);
<a name="l00255"></a>00255       <span class="keywordflow">else</span>
<a name="l00256"></a>00256          ERR_print_errors_fp(stderr);
<a name="l00257"></a>00257    } <span class="keywordflow">else</span> {
<a name="l00258"></a>00258       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Key &apos;%s&apos; needs passcode.\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00259"></a>00259       key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> |= <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>;
<a name="l00260"></a>00260       <span class="keywordflow">if</span> (!notice) {
<a name="l00261"></a>00261          <span class="keywordflow">if</span> (!<a class="code" href="options_8h.html#aaf18f1b7244aa93f796cae9a2a531008">ast_opt_init_keys</a>) 
<a name="l00262"></a>00262             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Add the &apos;-i&apos; flag to the asterisk command line if you want to automatically initialize passcodes at launch.\n&quot;</span>);
<a name="l00263"></a>00263          notice++;
<a name="l00264"></a>00264       }
<a name="l00265"></a>00265       <span class="comment">/* Keep it anyway */</span>
<a name="l00266"></a>00266       key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 0;
<a name="l00267"></a>00267       <span class="comment">/* Print final notice about &quot;init keys&quot; when done */</span>
<a name="l00268"></a>00268       *not2 = 1;
<a name="l00269"></a>00269    }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271    <span class="comment">/* If this is a new key add it to the list */</span>
<a name="l00272"></a>00272    <span class="keywordflow">if</span> (!found)
<a name="l00273"></a>00273       <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>);
<a name="l00274"></a>00274 
<a name="l00275"></a>00275    <span class="keywordflow">return</span> key;
<a name="l00276"></a>00276 }
<a name="l00277"></a>00277 <span class="comment"></span>
<a name="l00278"></a>00278 <span class="comment">/*!</span>
<a name="l00279"></a>00279 <span class="comment"> * \brief signs outgoing message with public key</span>
<a name="l00280"></a>00280 <span class="comment"> * \see ast_sign_bin</span>
<a name="l00281"></a>00281 <span class="comment">*/</span>
<a name="l00282"></a><a class="code" href="res__crypto_8c.html#aeff97278c4bc6d860ae743b9fd9e95f7">00282</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#aeff97278c4bc6d860ae743b9fd9e95f7" title="signs outgoing message with public key">__ast_sign_bin</a>(<span class="keyword">struct</span> <a class="code" href="structast__key.html">ast_key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dsig)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>[20];
<a name="l00285"></a>00285    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> siglen = 128;
<a name="l00286"></a>00286    <span class="keywordtype">int</span> res;
<a name="l00287"></a>00287 
<a name="l00288"></a>00288    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>) {
<a name="l00289"></a>00289       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot sign with a public key\n&quot;</span>);
<a name="l00290"></a>00290       <span class="keywordflow">return</span> -1;
<a name="l00291"></a>00291    }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293    <span class="comment">/* Calculate digest of message */</span>
<a name="l00294"></a>00294    SHA1((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)msg, msglen, digest);
<a name="l00295"></a>00295 
<a name="l00296"></a>00296    <span class="comment">/* Verify signature */</span>
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (!(res = RSA_sign(NID_sha1, digest, <span class="keyword">sizeof</span>(digest), dsig, &amp;siglen, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>))) {
<a name="l00298"></a>00298       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RSA Signature (key %s) failed\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00299"></a>00299       <span class="keywordflow">return</span> -1;
<a name="l00300"></a>00300    }
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    <span class="keywordflow">if</span> (siglen != 128) {
<a name="l00303"></a>00303       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unexpected signature length %d, expecting %d\n&quot;</span>, (<span class="keywordtype">int</span>)siglen, (<span class="keywordtype">int</span>)128);
<a name="l00304"></a>00304       <span class="keywordflow">return</span> -1;
<a name="l00305"></a>00305    }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307    <span class="keywordflow">return</span> 0;
<a name="l00308"></a>00308    
<a name="l00309"></a>00309 }
<a name="l00310"></a>00310 <span class="comment"></span>
<a name="l00311"></a>00311 <span class="comment">/*!</span>
<a name="l00312"></a>00312 <span class="comment"> * \brief decrypt a message</span>
<a name="l00313"></a>00313 <span class="comment"> * \see ast_decrypt_bin</span>
<a name="l00314"></a>00314 <span class="comment">*/</span>
<a name="l00315"></a><a class="code" href="res__crypto_8c.html#a2356e21f17002e32926bd8735e7111b2">00315</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#a2356e21f17002e32926bd8735e7111b2" title="decrypt a message">__ast_decrypt_bin</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> srclen, <span class="keyword">struct</span> <a class="code" href="structast__key.html">ast_key</a> *key)
<a name="l00316"></a>00316 {
<a name="l00317"></a>00317    <span class="keywordtype">int</span> res, pos = 0;
<a name="l00318"></a>00318 
<a name="l00319"></a>00319    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a68b39a796b4ca2c1ad95ba075be38284">AST_KEY_PRIVATE</a>) {
<a name="l00320"></a>00320       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot decrypt with a public key\n&quot;</span>);
<a name="l00321"></a>00321       <span class="keywordflow">return</span> -1;
<a name="l00322"></a>00322    }
<a name="l00323"></a>00323 
<a name="l00324"></a>00324    <span class="keywordflow">if</span> (srclen % 128) {
<a name="l00325"></a>00325       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Tried to decrypt something not a multiple of 128 bytes\n&quot;</span>);
<a name="l00326"></a>00326       <span class="keywordflow">return</span> -1;
<a name="l00327"></a>00327    }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329    <span class="keywordflow">while</span>(srclen) {
<a name="l00330"></a>00330       <span class="comment">/* Process chunks 128 bytes at a time */</span>
<a name="l00331"></a>00331       <span class="keywordflow">if</span> ((res = RSA_private_decrypt(128, src, dst, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>, RSA_PKCS1_OAEP_PADDING)) &lt; 0)
<a name="l00332"></a>00332          <span class="keywordflow">return</span> -1;
<a name="l00333"></a>00333       pos += res;
<a name="l00334"></a>00334       src += 128;
<a name="l00335"></a>00335       srclen -= 128;
<a name="l00336"></a>00336       dst += res;
<a name="l00337"></a>00337    }
<a name="l00338"></a>00338 
<a name="l00339"></a>00339    <span class="keywordflow">return</span> pos;
<a name="l00340"></a>00340 }
<a name="l00341"></a>00341 <span class="comment"></span>
<a name="l00342"></a>00342 <span class="comment">/*!</span>
<a name="l00343"></a>00343 <span class="comment"> * \brief encrypt a message</span>
<a name="l00344"></a>00344 <span class="comment"> * \see ast_encrypt_bin</span>
<a name="l00345"></a>00345 <span class="comment">*/</span>
<a name="l00346"></a><a class="code" href="res__crypto_8c.html#a7eaf0b18e766300c6f5f6a5d97ac409e">00346</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#a7eaf0b18e766300c6f5f6a5d97ac409e" title="encrypt a message">__ast_encrypt_bin</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *src, <span class="keywordtype">int</span> srclen, <span class="keyword">struct</span> <a class="code" href="structast__key.html">ast_key</a> *key)
<a name="l00347"></a>00347 {
<a name="l00348"></a>00348    <span class="keywordtype">int</span> res, bytes, pos = 0;
<a name="l00349"></a>00349 
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>) {
<a name="l00351"></a>00351       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot encrypt with a private key\n&quot;</span>);
<a name="l00352"></a>00352       <span class="keywordflow">return</span> -1;
<a name="l00353"></a>00353    }
<a name="l00354"></a>00354    
<a name="l00355"></a>00355    <span class="keywordflow">while</span>(srclen) {
<a name="l00356"></a>00356       bytes = srclen;
<a name="l00357"></a>00357       <span class="keywordflow">if</span> (bytes &gt; 128 - 41)
<a name="l00358"></a>00358          bytes = 128 - 41;
<a name="l00359"></a>00359       <span class="comment">/* Process chunks 128-41 bytes at a time */</span>
<a name="l00360"></a>00360       <span class="keywordflow">if</span> ((res = RSA_public_encrypt(bytes, src, dst, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>, RSA_PKCS1_OAEP_PADDING)) != 128) {
<a name="l00361"></a>00361          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;How odd, encrypted size is %d\n&quot;</span>, res);
<a name="l00362"></a>00362          <span class="keywordflow">return</span> -1;
<a name="l00363"></a>00363       }
<a name="l00364"></a>00364       src += bytes;
<a name="l00365"></a>00365       srclen -= bytes;
<a name="l00366"></a>00366       pos += res;
<a name="l00367"></a>00367       dst += res;
<a name="l00368"></a>00368    }
<a name="l00369"></a>00369    <span class="keywordflow">return</span> pos;
<a name="l00370"></a>00370 }
<a name="l00371"></a>00371 <span class="comment"></span>
<a name="l00372"></a>00372 <span class="comment">/*!</span>
<a name="l00373"></a>00373 <span class="comment"> * \brief wrapper for __ast_sign_bin then base64 encode it</span>
<a name="l00374"></a>00374 <span class="comment"> * \see ast_sign</span>
<a name="l00375"></a>00375 <span class="comment">*/</span>
<a name="l00376"></a><a class="code" href="res__crypto_8c.html#aa72f25fe6809be13ce00022d2148c68e">00376</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#aa72f25fe6809be13ce00022d2148c68e" title="wrapper for __ast_sign_bin then base64 encode it">__ast_sign</a>(<span class="keyword">struct</span> <a class="code" href="structast__key.html">ast_key</a> *key, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">char</span> *sig)
<a name="l00377"></a>00377 {
<a name="l00378"></a>00378    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsig[128];
<a name="l00379"></a>00379    <span class="keywordtype">int</span> siglen = <span class="keyword">sizeof</span>(dsig), res;
<a name="l00380"></a>00380 
<a name="l00381"></a>00381    <span class="keywordflow">if</span> (!(res = <a class="code" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3" title="Sign a message signature using a given private key.">ast_sign_bin</a>(key, msg, strlen(msg), dsig)))
<a name="l00382"></a>00382       <span class="comment">/* Success -- encode (256 bytes max as documented) */</span>
<a name="l00383"></a>00383       <a class="code" href="utils_8h.html#a555dad1bd5b23acf01cf08f1affab879" title="Encode data in base64.">ast_base64encode</a>(sig, dsig, siglen, 256);
<a name="l00384"></a>00384 
<a name="l00385"></a>00385    <span class="keywordflow">return</span> res;
<a name="l00386"></a>00386 }
<a name="l00387"></a>00387 <span class="comment"></span>
<a name="l00388"></a>00388 <span class="comment">/*!</span>
<a name="l00389"></a>00389 <span class="comment"> * \brief check signature of a message</span>
<a name="l00390"></a>00390 <span class="comment"> * \see ast_check_signature_bin</span>
<a name="l00391"></a>00391 <span class="comment">*/</span>
<a name="l00392"></a><a class="code" href="res__crypto_8c.html#af09836a36dc290e9b9ac8ea1d5769975">00392</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#af09836a36dc290e9b9ac8ea1d5769975" title="check signature of a message">__ast_check_signature_bin</a>(<span class="keyword">struct</span> <a class="code" href="structast__key.html">ast_key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dsig)
<a name="l00393"></a>00393 {
<a name="l00394"></a>00394    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>[20];
<a name="l00395"></a>00395    <span class="keywordtype">int</span> res;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> != <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a>) {
<a name="l00398"></a>00398       <span class="comment">/* Okay, so of course you really *can* but for our purposes</span>
<a name="l00399"></a>00399 <span class="comment">         we&apos;re going to say you can&apos;t */</span>
<a name="l00400"></a>00400       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot check message signature with a private key\n&quot;</span>);
<a name="l00401"></a>00401       <span class="keywordflow">return</span> -1;
<a name="l00402"></a>00402    }
<a name="l00403"></a>00403 
<a name="l00404"></a>00404    <span class="comment">/* Calculate digest of message */</span>
<a name="l00405"></a>00405    SHA1((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)msg, msglen, digest);
<a name="l00406"></a>00406 
<a name="l00407"></a>00407    <span class="comment">/* Verify signature */</span>
<a name="l00408"></a>00408    <span class="keywordflow">if</span> (!(res = RSA_verify(NID_sha1, digest, <span class="keyword">sizeof</span>(digest), (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)dsig, 128, key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>))) {
<a name="l00409"></a>00409       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Key failed verification: %s\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l00410"></a>00410       <span class="keywordflow">return</span> -1;
<a name="l00411"></a>00411    }
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    <span class="comment">/* Pass */</span>
<a name="l00414"></a>00414    <span class="keywordflow">return</span> 0;
<a name="l00415"></a>00415 }
<a name="l00416"></a>00416 <span class="comment"></span>
<a name="l00417"></a>00417 <span class="comment">/*!</span>
<a name="l00418"></a>00418 <span class="comment"> * \brief base64 decode then sent to __ast_check_signature_bin</span>
<a name="l00419"></a>00419 <span class="comment"> * \see ast_check_signature</span>
<a name="l00420"></a>00420 <span class="comment">*/</span>
<a name="l00421"></a><a class="code" href="res__crypto_8c.html#a47ea0a07bdecf6e564a85c53f8bf678a">00421</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#a47ea0a07bdecf6e564a85c53f8bf678a" title="base64 decode then sent to __ast_check_signature_bin">__ast_check_signature</a>(<span class="keyword">struct</span> <a class="code" href="structast__key.html">ast_key</a> *key, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *sig)
<a name="l00422"></a>00422 {
<a name="l00423"></a>00423    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsig[128];
<a name="l00424"></a>00424    <span class="keywordtype">int</span> res;
<a name="l00425"></a>00425 
<a name="l00426"></a>00426    <span class="comment">/* Decode signature */</span>
<a name="l00427"></a>00427    <span class="keywordflow">if</span> ((res = <a class="code" href="utils_8h.html#a1e7e06bd20719ecfd58b67f230780ffa" title="Decode data from base64.">ast_base64decode</a>(dsig, sig, <span class="keyword">sizeof</span>(dsig))) != <span class="keyword">sizeof</span>(dsig)) {
<a name="l00428"></a>00428       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Signature improper length (expect %d, got %d)\n&quot;</span>, (<span class="keywordtype">int</span>)<span class="keyword">sizeof</span>(dsig), (<span class="keywordtype">int</span>)res);
<a name="l00429"></a>00429       <span class="keywordflow">return</span> -1;
<a name="l00430"></a>00430    }
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    res = <a class="code" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9" title="Check the authenticity of a message signature using a given public key.">ast_check_signature_bin</a>(key, msg, strlen(msg), dsig);
<a name="l00433"></a>00433 
<a name="l00434"></a>00434    <span class="keywordflow">return</span> res;
<a name="l00435"></a>00435 }
<a name="l00436"></a>00436 <span class="comment"></span>
<a name="l00437"></a>00437 <span class="comment">/*!</span>
<a name="l00438"></a>00438 <span class="comment"> * \brief refresh RSA keys from file</span>
<a name="l00439"></a>00439 <span class="comment"> * \param ifd file descriptor</span>
<a name="l00440"></a>00440 <span class="comment"> * \param ofd file descriptor</span>
<a name="l00441"></a>00441 <span class="comment"> * \return void</span>
<a name="l00442"></a>00442 <span class="comment">*/</span>
<a name="l00443"></a><a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853">00443</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(<span class="keywordtype">int</span> ifd, <span class="keywordtype">int</span> ofd)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00446"></a>00446    DIR *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a> = NULL;
<a name="l00447"></a>00447    <span class="keyword">struct </span>dirent *ent;
<a name="l00448"></a>00448    <span class="keywordtype">int</span> note = 0;
<a name="l00449"></a>00449 
<a name="l00450"></a>00450    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452    <span class="comment">/* Mark all keys for deletion */</span>
<a name="l00453"></a>00453    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00454"></a>00454       key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a> = 1;
<a name="l00455"></a>00455    }
<a name="l00456"></a>00456 
<a name="l00457"></a>00457    <span class="comment">/* Load new keys */</span>
<a name="l00458"></a>00458    <span class="keywordflow">if</span> ((dir = opendir(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>))) {
<a name="l00459"></a>00459       <span class="keywordflow">while</span>((ent = readdir(dir))) {
<a name="l00460"></a>00460          <a class="code" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731" title="load RSA key from file">try_load_key</a>(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>, ent-&gt;d_name, ifd, ofd, &amp;note);
<a name="l00461"></a>00461       }
<a name="l00462"></a>00462       closedir(dir);
<a name="l00463"></a>00463    } <span class="keywordflow">else</span>
<a name="l00464"></a>00464       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open key directory &apos;%s&apos;\n&quot;</span>, <a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>);
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <span class="keywordflow">if</span> (note)
<a name="l00467"></a>00467       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Please run the command &apos;init keys&apos; to enter the passcodes for the keys\n&quot;</span>);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <span class="comment">/* Delete any keys that are no longer present */</span>
<a name="l00470"></a>00470    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00471"></a>00471       <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#aa53dad096a6e07c1fc9800d31a3742bf">delme</a>) {
<a name="l00472"></a>00472          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Deleting key %s type %d\n&quot;</span>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>, key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a>);
<a name="l00473"></a>00473          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(<a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>);
<a name="l00474"></a>00474          <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>)
<a name="l00475"></a>00475             RSA_free(key-&gt;<a class="code" href="structast__key.html#abe5e4dd8049eff80d7e599d751f143f8">rsa</a>);
<a name="l00476"></a>00476          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(key);
<a name="l00477"></a>00477       }
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>;
<a name="l00480"></a>00480 
<a name="l00481"></a>00481    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00482"></a>00482 }
<a name="l00483"></a>00483 
<a name="l00484"></a><a class="code" href="res__crypto_8c.html#a72c787a063d771439dadf924d51018f1">00484</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__crypto_8c.html#a72c787a063d771439dadf924d51018f1">md52sum</a>(<span class="keywordtype">char</span> *sum, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="func__md5_8c.html#a058fc1589da2b9b0d8e404ba0482c3af">md5</a>)
<a name="l00485"></a>00485 {
<a name="l00486"></a>00486    <span class="keywordtype">int</span> x;
<a name="l00487"></a>00487    <span class="keywordflow">for</span> (x = 0; x &lt; 16; x++) 
<a name="l00488"></a>00488       sum += sprintf(sum, <span class="stringliteral">&quot;%02x&quot;</span>, *(md5++));
<a name="l00489"></a>00489 }
<a name="l00490"></a>00490 <span class="comment"></span>
<a name="l00491"></a>00491 <span class="comment">/*! </span>
<a name="l00492"></a>00492 <span class="comment"> * \brief show the list of RSA keys </span>
<a name="l00493"></a>00493 <span class="comment"> * \param e CLI command</span>
<a name="l00494"></a>00494 <span class="comment"> * \param cmd</span>
<a name="l00495"></a>00495 <span class="comment"> * \param a list of CLI arguments</span>
<a name="l00496"></a>00496 <span class="comment"> * \return CLI_SUCCESS</span>
<a name="l00497"></a>00497 <span class="comment">*/</span>
<a name="l00498"></a><a class="code" href="res__crypto_8c.html#a849125df8a0e30d08efe31e86729fffe">00498</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__crypto_8c.html#a849125df8a0e30d08efe31e86729fffe" title="show the list of RSA keys">handle_cli_keys_show</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00499"></a>00499 {
<a name="l00500"></a>00500 <span class="preprocessor">#define FORMAT &quot;%-18s %-8s %-16s %-33s\n&quot;</span>
<a name="l00501"></a>00501 <span class="preprocessor"></span>
<a name="l00502"></a>00502    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00503"></a>00503    <span class="keywordtype">char</span> sum[16 * 2 + 1];
<a name="l00504"></a>00504    <span class="keywordtype">int</span> count_keys = 0;
<a name="l00505"></a>00505 
<a name="l00506"></a>00506    <span class="keywordflow">switch</span> (cmd) {
<a name="l00507"></a>00507    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00508"></a>00508       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;keys show&quot;</span>;
<a name="l00509"></a>00509       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00510"></a>00510          <span class="stringliteral">&quot;Usage: keys show\n&quot;</span>
<a name="l00511"></a>00511          <span class="stringliteral">&quot;       Displays information about RSA keys known by Asterisk\n&quot;</span>;
<a name="l00512"></a>00512       <span class="keywordflow">return</span> NULL;
<a name="l00513"></a>00513    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00514"></a>00514       <span class="keywordflow">return</span> NULL;
<a name="l00515"></a>00515    }
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;Key Name&quot;</span>, <span class="stringliteral">&quot;Type&quot;</span>, <span class="stringliteral">&quot;Status&quot;</span>, <span class="stringliteral">&quot;Sum&quot;</span>);
<a name="l00518"></a>00518    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, <span class="stringliteral">&quot;------------------&quot;</span>, <span class="stringliteral">&quot;--------&quot;</span>, <span class="stringliteral">&quot;----------------&quot;</span>, <span class="stringliteral">&quot;--------------------------------&quot;</span>);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00521"></a>00521    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00522"></a>00522       <a class="code" href="res__crypto_8c.html#a72c787a063d771439dadf924d51018f1">md52sum</a>(sum, key-&gt;<a class="code" href="structast__key.html#a9c185c9970b81e602c4374ffe2c117e8">digest</a>);
<a name="l00523"></a>00523       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="chan__dahdi_8c.html#ac8dc47e3b39c930caed4bfd05b4ba805">FORMAT</a>, key-&gt;<a class="code" href="structast__key.html#a3777dbae63a15da001b2baa317a25149">name</a>, 
<a name="l00524"></a>00524          (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; 0xf) == <a class="code" href="crypto_8h.html#a5a80fcd381628f496f8b70d60c0386a9">AST_KEY_PUBLIC</a> ? <span class="stringliteral">&quot;PUBLIC&quot;</span> : <span class="stringliteral">&quot;PRIVATE&quot;</span>,
<a name="l00525"></a>00525          key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a> ? <span class="stringliteral">&quot;[Needs Passcode]&quot;</span> : <span class="stringliteral">&quot;[Loaded]&quot;</span>, sum);
<a name="l00526"></a>00526       count_keys++;
<a name="l00527"></a>00527    }
<a name="l00528"></a>00528    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00529"></a>00529 
<a name="l00530"></a>00530    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n%d known RSA keys.\n&quot;</span>, count_keys);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00533"></a>00533 
<a name="l00534"></a>00534 <span class="preprocessor">#undef FORMAT</span>
<a name="l00535"></a>00535 <span class="preprocessor"></span>}
<a name="l00536"></a>00536 <span class="comment"></span>
<a name="l00537"></a>00537 <span class="comment">/*! </span>
<a name="l00538"></a>00538 <span class="comment"> * \brief initialize all RSA keys  </span>
<a name="l00539"></a>00539 <span class="comment"> * \param e CLI command</span>
<a name="l00540"></a>00540 <span class="comment"> * \param cmd </span>
<a name="l00541"></a>00541 <span class="comment"> * \param a list of CLI arguments</span>
<a name="l00542"></a>00542 <span class="comment"> * \return CLI_SUCCESS</span>
<a name="l00543"></a>00543 <span class="comment">*/</span>
<a name="l00544"></a><a class="code" href="res__crypto_8c.html#a4483abe7b118418ecf2e559f5367313b">00544</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__crypto_8c.html#a4483abe7b118418ecf2e559f5367313b" title="initialize all RSA keys">handle_cli_keys_init</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00545"></a>00545 {
<a name="l00546"></a>00546    <span class="keyword">struct </span><a class="code" href="structast__key.html">ast_key</a> *key;
<a name="l00547"></a>00547    <span class="keywordtype">int</span> ign;
<a name="l00548"></a>00548    <span class="keywordtype">char</span> *kn, tmp[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00549"></a>00549 
<a name="l00550"></a>00550    <span class="keywordflow">switch</span> (cmd) {
<a name="l00551"></a>00551    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00552"></a>00552       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;keys init&quot;</span>;
<a name="l00553"></a>00553       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l00554"></a>00554          <span class="stringliteral">&quot;Usage: keys init\n&quot;</span>
<a name="l00555"></a>00555          <span class="stringliteral">&quot;       Initializes private keys (by reading in pass code from\n&quot;</span>
<a name="l00556"></a>00556          <span class="stringliteral">&quot;       the user)\n&quot;</span>;
<a name="l00557"></a>00557       <span class="keywordflow">return</span> NULL;
<a name="l00558"></a>00558    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00559"></a>00559       <span class="keywordflow">return</span> NULL;
<a name="l00560"></a>00560    }
<a name="l00561"></a>00561 
<a name="l00562"></a>00562    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2)
<a name="l00563"></a>00563       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00564"></a>00564 
<a name="l00565"></a>00565    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00566"></a>00566    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="structkeys.html">keys</a>, key, <a class="code" href="structast__key.html#a96ae25dd39e474b6047229a2cecdb431">list</a>) {
<a name="l00567"></a>00567       <span class="comment">/* Reload keys that need pass codes now */</span>
<a name="l00568"></a>00568       <span class="keywordflow">if</span> (key-&gt;<a class="code" href="structast__key.html#a982eec3ea14769d02276ea2ad99341b8">ktype</a> &amp; <a class="code" href="res__crypto_8c.html#a01d6bf8d0a54c0a8c00396ad239e1952">KEY_NEEDS_PASSCODE</a>) {
<a name="l00569"></a>00569          kn = key-&gt;<a class="code" href="structast__key.html#a5f182d9137cbde62c4a1b7af98815148">fn</a> + strlen(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>) + 1;
<a name="l00570"></a>00570          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, kn, <span class="keyword">sizeof</span>(tmp));
<a name="l00571"></a>00571          <a class="code" href="res__crypto_8c.html#adeba9b20c20b7b76c7deb63af67f5731" title="load RSA key from file">try_load_key</a>(<a class="code" href="paths_8h.html#a0334adace37c0e8de8ea89c8651336a2">ast_config_AST_KEY_DIR</a>, tmp, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, &amp;ign);
<a name="l00572"></a>00572       }
<a name="l00573"></a>00573    }
<a name="l00574"></a>00574    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l00575"></a>00575    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structkeys.html">keys</a>);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00578"></a>00578 }
<a name="l00579"></a>00579 
<a name="l00580"></a><a class="code" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">00580</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a>[] = {
<a name="l00581"></a>00581    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__crypto_8c.html#a849125df8a0e30d08efe31e86729fffe" title="show the list of RSA keys">handle_cli_keys_show</a>, <span class="stringliteral">&quot;Displays RSA key information&quot;</span>),
<a name="l00582"></a>00582    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__crypto_8c.html#a4483abe7b118418ecf2e559f5367313b" title="initialize all RSA keys">handle_cli_keys_init</a>, <span class="stringliteral">&quot;Initialize RSA key passcodes&quot;</span>)
<a name="l00583"></a>00583 };
<a name="l00584"></a>00584 <span class="comment"></span>
<a name="l00585"></a>00585 <span class="comment">/*! \brief initialise the res_crypto module */</span>
<a name="l00586"></a><a class="code" href="res__crypto_8c.html#afe66c89b5695ee92f3f6125397c7573b">00586</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#afe66c89b5695ee92f3f6125397c7573b" title="initialise the res_crypto module">crypto_init</a>(<span class="keywordtype">void</span>)
<a name="l00587"></a>00587 {
<a name="l00588"></a>00588    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="res__crypto_8c.html#ad8ebfa3eee117aca9365da1ceec6dbd3">cli_crypto</a>));
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <span class="comment">/* Install ourselves into stubs */</span>
<a name="l00591"></a>00591    <a class="code" href="crypto_8h.html#ae616a3ae122fcb33a6f5937dc1295718" title="Retrieve a key.">ast_key_get</a> = <a class="code" href="res__crypto_8c.html#a30abfec91d1a3e0fd585675d9fd8f297" title="return the ast_key structure for name">__ast_key_get</a>;
<a name="l00592"></a>00592    <a class="code" href="crypto_8h.html#a50332dc613df6416ba467b5bde4934e2" title="Check the authenticity of a message signature using a given public key.">ast_check_signature</a> = <a class="code" href="res__crypto_8c.html#a47ea0a07bdecf6e564a85c53f8bf678a" title="base64 decode then sent to __ast_check_signature_bin">__ast_check_signature</a>;
<a name="l00593"></a>00593    <a class="code" href="crypto_8h.html#aaf24a642c039fc90be63beb718b922e9" title="Check the authenticity of a message signature using a given public key.">ast_check_signature_bin</a> = <a class="code" href="res__crypto_8c.html#af09836a36dc290e9b9ac8ea1d5769975" title="check signature of a message">__ast_check_signature_bin</a>;
<a name="l00594"></a>00594    <a class="code" href="crypto_8h.html#ac38f2d4ddec17857aaf5bc0dd13dab38" title="Sign a message signature using a given private key.">ast_sign</a> = <a class="code" href="res__crypto_8c.html#aa72f25fe6809be13ce00022d2148c68e" title="wrapper for __ast_sign_bin then base64 encode it">__ast_sign</a>;
<a name="l00595"></a>00595    <a class="code" href="crypto_8h.html#a69826cedf18ea52992a8870cfa3fc6a3" title="Sign a message signature using a given private key.">ast_sign_bin</a> = <a class="code" href="res__crypto_8c.html#aeff97278c4bc6d860ae743b9fd9e95f7" title="signs outgoing message with public key">__ast_sign_bin</a>;
<a name="l00596"></a>00596    <a class="code" href="crypto_8h.html#aacb22f7c29907031152630b4628014fc" title="Encrypt a message using a given private key.">ast_encrypt_bin</a> = <a class="code" href="res__crypto_8c.html#a7eaf0b18e766300c6f5f6a5d97ac409e" title="encrypt a message">__ast_encrypt_bin</a>;
<a name="l00597"></a>00597    <a class="code" href="crypto_8h.html#ac28ff1b7a9621b7542f4f120b23c16ec" title="Decrypt a message using a given private key.">ast_decrypt_bin</a> = <a class="code" href="res__crypto_8c.html#a2356e21f17002e32926bd8735e7111b2" title="decrypt a message">__ast_decrypt_bin</a>;
<a name="l00598"></a>00598    <span class="keywordflow">return</span> 0;
<a name="l00599"></a>00599 }
<a name="l00600"></a>00600 
<a name="l00601"></a><a class="code" href="res__crypto_8c.html#ad1982509765f4870f1f63412a53ea668">00601</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l00602"></a>00602 {
<a name="l00603"></a>00603    <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(-1, -1);
<a name="l00604"></a>00604    <span class="keywordflow">return</span> 0;
<a name="l00605"></a>00605 }
<a name="l00606"></a>00606 
<a name="l00607"></a><a class="code" href="res__crypto_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">00607</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__crypto_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l00608"></a>00608 {
<a name="l00609"></a>00609    <a class="code" href="res__crypto_8c.html#afe66c89b5695ee92f3f6125397c7573b" title="initialise the res_crypto module">crypto_init</a>();
<a name="l00610"></a>00610    <span class="keywordflow">if</span> (<a class="code" href="options_8h.html#aaf18f1b7244aa93f796cae9a2a531008">ast_opt_init_keys</a>)
<a name="l00611"></a>00611       <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(STDIN_FILENO, STDOUT_FILENO);
<a name="l00612"></a>00612    <span class="keywordflow">else</span>
<a name="l00613"></a>00613       <a class="code" href="res__crypto_8c.html#a94ec58f8f5d3c47fa527da2eab8a4853" title="refresh RSA keys from file">crypto_load</a>(-1, -1);
<a name="l00614"></a>00614    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l00615"></a>00615 }
<a name="l00616"></a>00616 
<a name="l00617"></a><a class="code" href="res__crypto_8c.html#ad09fa931f468002152a3cc2d5ce25eae">00617</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619    <span class="comment">/* Can&apos;t unload this once we&apos;re loaded */</span>
<a name="l00620"></a>00620    <span class="keywordflow">return</span> -1;
<a name="l00621"></a>00621 }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623 <span class="comment">/* needs usecount semantics defined */</span>
<a name="l00624"></a>00624 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Cryptographic Digital Signatures&quot;</span>,
<a name="l00625"></a>00625       .load = <a class="code" href="res__crypto_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l00626"></a>00626       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l00627"></a>00627       .<a class="code" href="res__crypto_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="res__crypto_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>
<a name="l00628"></a><a class="code" href="res__crypto_8c.html#ae25b9f3970870610911f8850897e8ead">00628</a>    );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:46 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
