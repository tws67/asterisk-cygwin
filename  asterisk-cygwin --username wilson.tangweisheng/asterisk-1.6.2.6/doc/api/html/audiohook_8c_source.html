<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:29 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>audiohook.c</h1><a href="audiohook_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2007, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Joshua Colp &lt;jcolp@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Audiohooks Architecture</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Joshua &apos;file&apos; Colp &lt;jcolp@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> */</span>
<a name="l00025"></a>00025 
<a name="l00026"></a>00026 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00027"></a>00027 
<a name="l00028"></a>00028 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 238637 $&quot;</span>)
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor"></span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="audiohook_8h.html" title="Audiohooks Architecture.">asterisk/audiohook.h</a>&quot;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &quot;<a class="code" href="slinfactory_8h.html" title="A machine to gather up arbitrary frames and convert them to raw slinear on demand...">asterisk/slinfactory.h</a>&quot;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="frame_8h.html" title="Asterisk internal frame definitions.">asterisk/frame.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00041"></a><a class="code" href="structast__audiohook__translate.html">00041</a> <span class="keyword">struct </span><a class="code" href="structast__audiohook__translate.html">ast_audiohook_translate</a> {
<a name="l00042"></a><a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">00042</a>    <span class="keyword">struct </span><a class="code" href="structast__trans__pvt.html" title="Default structure for translators, with the basic fields and buffers, all allocated...">ast_trans_pvt</a> *<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>;
<a name="l00043"></a><a class="code" href="structast__audiohook__translate.html#a317afff57d87a89158c2b038d37b2b08">00043</a>    <span class="keywordtype">int</span> <a class="code" href="structast__audiohook__translate.html#a317afff57d87a89158c2b038d37b2b08">format</a>;
<a name="l00044"></a>00044 };
<a name="l00045"></a>00045 
<a name="l00046"></a><a class="code" href="structast__audiohook__list.html">00046</a> <span class="keyword">struct </span><a class="code" href="structast__audiohook__list.html">ast_audiohook_list</a> {
<a name="l00047"></a><a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">00047</a>    <span class="keyword">struct </span><a class="code" href="structast__audiohook__translate.html">ast_audiohook_translate</a> <a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">in_translate</a>[2];
<a name="l00048"></a><a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">00048</a>    <span class="keyword">struct </span><a class="code" href="structast__audiohook__translate.html">ast_audiohook_translate</a> <a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">out_translate</a>[2];
<a name="l00049"></a><a class="code" href="structast__audiohook__list.html#a0889348b15fce6eefeeab55584f39dcd">00049</a>    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__audiohook.html">ast_audiohook</a>) <a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>;
<a name="l00050"></a>00050    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__audiohook.html">ast_audiohook</a>) <a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>;
<a name="l00051"></a>00051    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__audiohook.html">ast_audiohook</a>) <a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>;
<a name="l00052"></a>00052 };
<a name="l00053"></a>00053 <span class="comment"></span>
<a name="l00054"></a>00054 <span class="comment">/*! \brief Initialize an audiohook structure</span>
<a name="l00055"></a>00055 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00056"></a>00056 <span class="comment"> * \param type</span>
<a name="l00057"></a>00057 <span class="comment"> * \param source</span>
<a name="l00058"></a>00058 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00059"></a>00059 <span class="comment"> */</span>
<a name="l00060"></a><a class="code" href="audiohook_8c.html#a94bd83e9f3444f406174971481b862c2">00060</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a94bd83e9f3444f406174971481b862c2" title="Initialize an audiohook structure.">ast_audiohook_init</a>(struct <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, enum <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0">ast_audiohook_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, const <span class="keywordtype">char</span> *source)
<a name="l00061"></a>00061 {
<a name="l00062"></a>00062    <span class="comment">/* Need to keep the type and source */</span>
<a name="l00063"></a>00063    audiohook-&gt;type = type;
<a name="l00064"></a>00064    audiohook-&gt;source = source;
<a name="l00065"></a>00065 
<a name="l00066"></a>00066    <span class="comment">/* Initialize lock that protects our audiohook */</span>
<a name="l00067"></a>00067    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;audiohook-&gt;lock);
<a name="l00068"></a>00068    <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;audiohook-&gt;trigger, NULL);
<a name="l00069"></a>00069 
<a name="l00070"></a>00070    <span class="comment">/* Setup the factories that are needed for this audiohook type */</span>
<a name="l00071"></a>00071    <span class="keywordflow">switch</span> (type) {
<a name="l00072"></a>00072    <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>:
<a name="l00073"></a>00073       <a class="code" href="slinfactory_8h.html#a213f392fc2df73230ec61af35072c1b2" title="Initialize a slinfactory.">ast_slinfactory_init</a>(&amp;audiohook-&gt;read_factory);
<a name="l00074"></a>00074    <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>:
<a name="l00075"></a>00075       <a class="code" href="slinfactory_8h.html#a213f392fc2df73230ec61af35072c1b2" title="Initialize a slinfactory.">ast_slinfactory_init</a>(&amp;audiohook-&gt;write_factory);
<a name="l00076"></a>00076       <span class="keywordflow">break</span>;
<a name="l00077"></a>00077    <span class="keywordflow">default</span>:
<a name="l00078"></a>00078       <span class="keywordflow">break</span>;
<a name="l00079"></a>00079    }
<a name="l00080"></a>00080 
<a name="l00081"></a>00081    <span class="comment">/* Since we are just starting out... this audiohook is new */</span>
<a name="l00082"></a>00082    <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adab303a4f550e2d8232d9803bf2d95f480">AST_AUDIOHOOK_STATUS_NEW</a>);
<a name="l00083"></a>00083 
<a name="l00084"></a>00084    <span class="keywordflow">return</span> 0;
<a name="l00085"></a>00085 }
<a name="l00086"></a>00086 <span class="comment"></span>
<a name="l00087"></a>00087 <span class="comment">/*! \brief Destroys an audiohook structure</span>
<a name="l00088"></a>00088 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00089"></a>00089 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00090"></a>00090 <span class="comment"> */</span>
<a name="l00091"></a><a class="code" href="audiohook_8c.html#a9fa661730d6fa6b9b12e410d66a3437b">00091</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a9fa661730d6fa6b9b12e410d66a3437b" title="Destroys an audiohook structure.">ast_audiohook_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook)
<a name="l00092"></a>00092 {
<a name="l00093"></a>00093    <span class="comment">/* Drop the factories used by this audiohook type */</span>
<a name="l00094"></a>00094    <span class="keywordflow">switch</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a>) {
<a name="l00095"></a>00095    <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>:
<a name="l00096"></a>00096       <a class="code" href="slinfactory_8h.html#ab5361491bac02fb60732df5671879652" title="Destroy the contents of a slinfactory.">ast_slinfactory_destroy</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>);
<a name="l00097"></a>00097    <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>:
<a name="l00098"></a>00098       <a class="code" href="slinfactory_8h.html#ab5361491bac02fb60732df5671879652" title="Destroy the contents of a slinfactory.">ast_slinfactory_destroy</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>);
<a name="l00099"></a>00099       <span class="keywordflow">break</span>;
<a name="l00100"></a>00100    <span class="keywordflow">default</span>:
<a name="l00101"></a>00101       <span class="keywordflow">break</span>;
<a name="l00102"></a>00102    }
<a name="l00103"></a>00103 
<a name="l00104"></a>00104    <span class="comment">/* Destroy translation path if present */</span>
<a name="l00105"></a>00105    <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>)
<a name="l00106"></a>00106       <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>);
<a name="l00107"></a>00107 
<a name="l00108"></a>00108    <span class="comment">/* Lock and trigger be gone! */</span>
<a name="l00109"></a>00109    <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1730983172cdc5373cf60e0e40294fb0">trigger</a>);
<a name="l00110"></a>00110    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00111"></a>00111 
<a name="l00112"></a>00112    <span class="keywordflow">return</span> 0;
<a name="l00113"></a>00113 }
<a name="l00114"></a>00114 <span class="comment"></span>
<a name="l00115"></a>00115 <span class="comment">/*! \brief Writes a frame into the audiohook structure</span>
<a name="l00116"></a>00116 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00117"></a>00117 <span class="comment"> * \param direction Direction the audio frame came from</span>
<a name="l00118"></a>00118 <span class="comment"> * \param frame Frame to write in</span>
<a name="l00119"></a>00119 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00120"></a>00120 <span class="comment"> */</span>
<a name="l00121"></a><a class="code" href="audiohook_8c.html#a3391dbd95c95f041cf14fa30e0f5c73d">00121</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a3391dbd95c95f041cf14fa30e0f5c73d" title="Writes a frame into the audiohook structure.">ast_audiohook_write_frame</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame)
<a name="l00122"></a>00122 {
<a name="l00123"></a>00123    <span class="keyword">struct </span><a class="code" href="structast__slinfactory.html">ast_slinfactory</a> *factory = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a> : &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>);
<a name="l00124"></a>00124    <span class="keyword">struct </span><a class="code" href="structast__slinfactory.html">ast_slinfactory</a> *other_factory = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a> : &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>);
<a name="l00125"></a>00125    <span class="keyword">struct </span>timeval *rwtime = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a384631601a0f954752c9dc823974e2ce">read_time</a> : &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1d0413130ca2d50bf809f74d6e4bfa21">write_time</a>), previous_time = *rwtime;
<a name="l00126"></a>00126    <span class="keywordtype">int</span> our_factory_samples;
<a name="l00127"></a>00127    <span class="keywordtype">int</span> our_factory_ms;
<a name="l00128"></a>00128    <span class="keywordtype">int</span> other_factory_samples;
<a name="l00129"></a>00129    <span class="keywordtype">int</span> other_factory_ms;
<a name="l00130"></a>00130 
<a name="l00131"></a>00131    <span class="comment">/* Update last feeding time to be current */</span>
<a name="l00132"></a>00132    *rwtime = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l00133"></a>00133 
<a name="l00134"></a>00134    our_factory_samples = <a class="code" href="slinfactory_8h.html#a6c48d283b3d2bce6af0a09c3b8b7fd0e" title="Retrieve number of samples currently in a slinfactory.">ast_slinfactory_available</a>(factory);
<a name="l00135"></a>00135    our_factory_ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(*rwtime, previous_time) + (our_factory_samples / 8);
<a name="l00136"></a>00136    other_factory_samples = <a class="code" href="slinfactory_8h.html#a6c48d283b3d2bce6af0a09c3b8b7fd0e" title="Retrieve number of samples currently in a slinfactory.">ast_slinfactory_available</a>(other_factory);
<a name="l00137"></a>00137    other_factory_ms = other_factory_samples / 8;
<a name="l00138"></a>00138 
<a name="l00139"></a>00139    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951afe01f1fbfa9f1096386a2c7905f2630e">AST_AUDIOHOOK_TRIGGER_SYNC</a>) &amp;&amp; other_factory_samples &amp;&amp; (our_factory_ms - other_factory_ms &gt; <a class="code" href="audiohook_8h.html#a4f988050ac148e5a281fc86313999be6">AST_AUDIOHOOK_SYNC_TOLERANCE</a>)) {
<a name="l00140"></a>00140       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00141"></a>00141          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Flushing audiohook %p so it remains in sync\n&quot;</span>, audiohook);
<a name="l00142"></a>00142       <a class="code" href="slinfactory_8h.html#a808da481a1c8673571179c51a97fb009" title="Flush the contents of a slinfactory.">ast_slinfactory_flush</a>(factory);
<a name="l00143"></a>00143       <a class="code" href="slinfactory_8h.html#a808da481a1c8673571179c51a97fb009" title="Flush the contents of a slinfactory.">ast_slinfactory_flush</a>(other_factory);
<a name="l00144"></a>00144    }
<a name="l00145"></a>00145 
<a name="l00146"></a>00146    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951abffa78ee38fcba6555775cd6b5f46622">AST_AUDIOHOOK_SMALL_QUEUE</a>) &amp;&amp; (our_factory_samples &gt; 640 || other_factory_samples &gt; 640)) {
<a name="l00147"></a>00147       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l00148"></a>00148          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Audiohook %p has stale audio in its factories. Flushing them both\n&quot;</span>, audiohook);
<a name="l00149"></a>00149       }
<a name="l00150"></a>00150       <a class="code" href="slinfactory_8h.html#a808da481a1c8673571179c51a97fb009" title="Flush the contents of a slinfactory.">ast_slinfactory_flush</a>(factory);
<a name="l00151"></a>00151       <a class="code" href="slinfactory_8h.html#a808da481a1c8673571179c51a97fb009" title="Flush the contents of a slinfactory.">ast_slinfactory_flush</a>(other_factory);
<a name="l00152"></a>00152    }
<a name="l00153"></a>00153 
<a name="l00154"></a>00154    <span class="comment">/* Write frame out to respective factory */</span>
<a name="l00155"></a>00155    <a class="code" href="slinfactory_8h.html#a83e5056051013853a0d80fc5862a9fe8" title="Feed audio into a slinfactory.">ast_slinfactory_feed</a>(factory, frame);
<a name="l00156"></a>00156 
<a name="l00157"></a>00157    <span class="comment">/* If we need to notify the respective handler of this audiohook, do so */</span>
<a name="l00158"></a>00158    <span class="keywordflow">if</span> ((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951a9114a8e97375acbc3a3202c2d75a9226">AST_AUDIOHOOK_TRIGGER_MODE</a>) == <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951ae6f7d2c4b49d2585445408f917be7e6e">AST_AUDIOHOOK_TRIGGER_READ</a>) &amp;&amp; (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>)) {
<a name="l00159"></a>00159       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1730983172cdc5373cf60e0e40294fb0">trigger</a>);
<a name="l00160"></a>00160    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951a9114a8e97375acbc3a3202c2d75a9226">AST_AUDIOHOOK_TRIGGER_MODE</a>) == <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951af3c73a99c0171f1121551b38cee3d6c6">AST_AUDIOHOOK_TRIGGER_WRITE</a>) &amp;&amp; (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>)) {
<a name="l00161"></a>00161       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1730983172cdc5373cf60e0e40294fb0">trigger</a>);
<a name="l00162"></a>00162    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951afe01f1fbfa9f1096386a2c7905f2630e">AST_AUDIOHOOK_TRIGGER_SYNC</a>)) {
<a name="l00163"></a>00163       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1730983172cdc5373cf60e0e40294fb0">trigger</a>);
<a name="l00164"></a>00164    }
<a name="l00165"></a>00165 
<a name="l00166"></a>00166    <span class="keywordflow">return</span> 0;
<a name="l00167"></a>00167 }
<a name="l00168"></a>00168 
<a name="l00169"></a><a class="code" href="audiohook_8c.html#aa8a53e1c05b3e841adf5435fc19a10f2">00169</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="audiohook_8c.html#aa8a53e1c05b3e841adf5435fc19a10f2">audiohook_read_frame_single</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, <span class="keywordtype">size_t</span> <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction)
<a name="l00170"></a>00170 {
<a name="l00171"></a>00171    <span class="keyword">struct </span><a class="code" href="structast__slinfactory.html">ast_slinfactory</a> *factory = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a> : &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>);
<a name="l00172"></a>00172    <span class="keywordtype">int</span> vol = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a> : audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a>);
<a name="l00173"></a>00173    <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[samples];
<a name="l00174"></a>00174    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> frame = {
<a name="l00175"></a>00175       .<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>,
<a name="l00176"></a>00176       .subclass = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>,
<a name="l00177"></a>00177       .data.ptr = buf,
<a name="l00178"></a>00178       .datalen = <span class="keyword">sizeof</span>(buf),
<a name="l00179"></a>00179       .samples = samples,
<a name="l00180"></a>00180    };
<a name="l00181"></a>00181 
<a name="l00182"></a>00182    <span class="comment">/* Ensure the factory is able to give us the samples we want */</span>
<a name="l00183"></a>00183    <span class="keywordflow">if</span> (samples &gt; <a class="code" href="slinfactory_8h.html#a6c48d283b3d2bce6af0a09c3b8b7fd0e" title="Retrieve number of samples currently in a slinfactory.">ast_slinfactory_available</a>(factory))
<a name="l00184"></a>00184       <span class="keywordflow">return</span> NULL;
<a name="l00185"></a>00185    
<a name="l00186"></a>00186    <span class="comment">/* Read data in from factory */</span>
<a name="l00187"></a>00187    <span class="keywordflow">if</span> (!<a class="code" href="slinfactory_8h.html#a75052c0e654e356675b26afbebe93097" title="Read samples from a slinfactory.">ast_slinfactory_read</a>(factory, buf, samples))
<a name="l00188"></a>00188       <span class="keywordflow">return</span> NULL;
<a name="l00189"></a>00189 
<a name="l00190"></a>00190    <span class="comment">/* If a volume adjustment needs to be applied apply it */</span>
<a name="l00191"></a>00191    <span class="keywordflow">if</span> (vol)
<a name="l00192"></a>00192       <a class="code" href="frame_8h.html#a59b72ee1caa9e8349ca017df01e8ac55" title="Adjusts the volume of the audio samples contained in a frame.">ast_frame_adjust_volume</a>(&amp;frame, vol);
<a name="l00193"></a>00193 
<a name="l00194"></a>00194    <span class="keywordflow">return</span> <a class="code" href="frame_8h.html#a4b23720d208128250a765490b1a4f145" title="Copies a frame.">ast_frdup</a>(&amp;frame);
<a name="l00195"></a>00195 }
<a name="l00196"></a>00196 
<a name="l00197"></a><a class="code" href="audiohook_8c.html#a6b731ffecc7e0cbd1cfa81d1a4903c82">00197</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="audiohook_8c.html#a6b731ffecc7e0cbd1cfa81d1a4903c82">audiohook_read_frame_both</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, <span class="keywordtype">size_t</span> samples)
<a name="l00198"></a>00198 {
<a name="l00199"></a>00199    <span class="keywordtype">int</span> i = 0, usable_read, usable_write;
<a name="l00200"></a>00200    <span class="keywordtype">short</span> buf1[samples], buf2[samples], *read_buf = NULL, *write_buf = NULL, *final_buf = NULL, *data1 = NULL, *data2 = NULL;
<a name="l00201"></a>00201    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> frame = {
<a name="l00202"></a>00202       .<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>,
<a name="l00203"></a>00203       .subclass = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>,
<a name="l00204"></a>00204       .data.ptr = NULL,
<a name="l00205"></a>00205       .datalen = <span class="keyword">sizeof</span>(buf1),
<a name="l00206"></a>00206       .samples = samples,
<a name="l00207"></a>00207    };
<a name="l00208"></a>00208 
<a name="l00209"></a>00209    <span class="comment">/* Make sure both factories have the required samples */</span>
<a name="l00210"></a>00210    usable_read = (<a class="code" href="slinfactory_8h.html#a6c48d283b3d2bce6af0a09c3b8b7fd0e" title="Retrieve number of samples currently in a slinfactory.">ast_slinfactory_available</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>) &gt;= samples ? 1 : 0);
<a name="l00211"></a>00211    usable_write = (<a class="code" href="slinfactory_8h.html#a6c48d283b3d2bce6af0a09c3b8b7fd0e" title="Retrieve number of samples currently in a slinfactory.">ast_slinfactory_available</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>) &gt;= samples ? 1 : 0);
<a name="l00212"></a>00212 
<a name="l00213"></a>00213    <span class="keywordflow">if</span> (!usable_read &amp;&amp; !usable_write) {
<a name="l00214"></a>00214       <span class="comment">/* If both factories are unusable bail out */</span>
<a name="l00215"></a>00215       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Read factory %p and write factory %p both fail to provide %zd samples\n&quot;</span>, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>, samples);
<a name="l00216"></a>00216       <span class="keywordflow">return</span> NULL;
<a name="l00217"></a>00217    }
<a name="l00218"></a>00218 
<a name="l00219"></a>00219    <span class="comment">/* If we want to provide only a read factory make sure we aren&apos;t waiting for other audio */</span>
<a name="l00220"></a>00220    <span class="keywordflow">if</span> (usable_read &amp;&amp; !usable_write &amp;&amp; (<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), audiohook-&gt;<a class="code" href="structast__audiohook.html#a1d0413130ca2d50bf809f74d6e4bfa21">write_time</a>) &lt; (samples/8)*2)) {
<a name="l00221"></a>00221       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Write factory %p was pretty quick last time, waiting for them.\n&quot;</span>, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>);
<a name="l00222"></a>00222       <span class="keywordflow">return</span> NULL;
<a name="l00223"></a>00223    }
<a name="l00224"></a>00224 
<a name="l00225"></a>00225    <span class="comment">/* If we want to provide only a write factory make sure we aren&apos;t waiting for other audio */</span>
<a name="l00226"></a>00226    <span class="keywordflow">if</span> (usable_write &amp;&amp; !usable_read &amp;&amp; (<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), audiohook-&gt;<a class="code" href="structast__audiohook.html#a384631601a0f954752c9dc823974e2ce">read_time</a>) &lt; (samples/8)*2)) {
<a name="l00227"></a>00227       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Read factory %p was pretty quick last time, waiting for them.\n&quot;</span>, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>);
<a name="l00228"></a>00228       <span class="keywordflow">return</span> NULL;
<a name="l00229"></a>00229    }
<a name="l00230"></a>00230 
<a name="l00231"></a>00231    <span class="comment">/* Start with the read factory... if there are enough samples, read them in */</span>
<a name="l00232"></a>00232    <span class="keywordflow">if</span> (usable_read) {
<a name="l00233"></a>00233       <span class="keywordflow">if</span> (<a class="code" href="slinfactory_8h.html#a75052c0e654e356675b26afbebe93097" title="Read samples from a slinfactory.">ast_slinfactory_read</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>, buf1, samples)) {
<a name="l00234"></a>00234          read_buf = buf1;
<a name="l00235"></a>00235          <span class="comment">/* Adjust read volume if need be */</span>
<a name="l00236"></a>00236          <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a>) {
<a name="l00237"></a>00237             <span class="keywordtype">int</span> count = 0;
<a name="l00238"></a>00238             <span class="keywordtype">short</span> adjust_value = abs(audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a>);
<a name="l00239"></a>00239             <span class="keywordflow">for</span> (count = 0; count &lt; samples; count++) {
<a name="l00240"></a>00240                <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a> &gt; 0)
<a name="l00241"></a>00241                   <a class="code" href="utils_8h.html#a5b2919c84591a13feb6b750b54c57520">ast_slinear_saturated_multiply</a>(&amp;buf1[count], &amp;adjust_value);
<a name="l00242"></a>00242                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a> &lt; 0)
<a name="l00243"></a>00243                   <a class="code" href="utils_8h.html#af5e55a87e9741a1bbea1e2ec2f99a1e1">ast_slinear_saturated_divide</a>(&amp;buf1[count], &amp;adjust_value);
<a name="l00244"></a>00244             }
<a name="l00245"></a>00245          }
<a name="l00246"></a>00246       }
<a name="l00247"></a>00247    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00248"></a>00248       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Failed to get %d samples from read factory %p\n&quot;</span>, (<span class="keywordtype">int</span>)samples, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a72d12418b888e36b3d47a7703d2edced">read_factory</a>);
<a name="l00249"></a>00249 
<a name="l00250"></a>00250    <span class="comment">/* Move on to the write factory... if there are enough samples, read them in */</span>
<a name="l00251"></a>00251    <span class="keywordflow">if</span> (usable_write) {
<a name="l00252"></a>00252       <span class="keywordflow">if</span> (<a class="code" href="slinfactory_8h.html#a75052c0e654e356675b26afbebe93097" title="Read samples from a slinfactory.">ast_slinfactory_read</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>, buf2, samples)) {
<a name="l00253"></a>00253          write_buf = buf2;
<a name="l00254"></a>00254          <span class="comment">/* Adjust write volume if need be */</span>
<a name="l00255"></a>00255          <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a>) {
<a name="l00256"></a>00256             <span class="keywordtype">int</span> count = 0;
<a name="l00257"></a>00257             <span class="keywordtype">short</span> adjust_value = abs(audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a>);
<a name="l00258"></a>00258             <span class="keywordflow">for</span> (count = 0; count &lt; samples; count++) {
<a name="l00259"></a>00259                <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a> &gt; 0)
<a name="l00260"></a>00260                   <a class="code" href="utils_8h.html#a5b2919c84591a13feb6b750b54c57520">ast_slinear_saturated_multiply</a>(&amp;buf2[count], &amp;adjust_value);
<a name="l00261"></a>00261                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a> &lt; 0)
<a name="l00262"></a>00262                   <a class="code" href="utils_8h.html#af5e55a87e9741a1bbea1e2ec2f99a1e1">ast_slinear_saturated_divide</a>(&amp;buf2[count], &amp;adjust_value);
<a name="l00263"></a>00263             }
<a name="l00264"></a>00264          }
<a name="l00265"></a>00265       }
<a name="l00266"></a>00266    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l00267"></a>00267       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Failed to get %d samples from write factory %p\n&quot;</span>, (<span class="keywordtype">int</span>)samples, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>);
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <span class="comment">/* Basically we figure out which buffer to use... and if mixing can be done here */</span>
<a name="l00270"></a>00270    <span class="keywordflow">if</span> (!read_buf &amp;&amp; !write_buf)
<a name="l00271"></a>00271       <span class="keywordflow">return</span> NULL;
<a name="l00272"></a>00272    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (read_buf &amp;&amp; write_buf) {
<a name="l00273"></a>00273       <span class="keywordflow">for</span> (i = 0, data1 = read_buf, data2 = write_buf; i &lt; samples; i++, data1++, data2++)
<a name="l00274"></a>00274          <a class="code" href="utils_8h.html#a8761597fec2f8a17d105a82c20d0b728">ast_slinear_saturated_add</a>(data1, data2);
<a name="l00275"></a>00275       final_buf = buf1;
<a name="l00276"></a>00276    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (read_buf)
<a name="l00277"></a>00277       final_buf = buf1;
<a name="l00278"></a>00278    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (write_buf)
<a name="l00279"></a>00279       final_buf = buf2;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281    <span class="comment">/* Make the final buffer part of the frame, so it gets duplicated fine */</span>
<a name="l00282"></a>00282    frame.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = final_buf;
<a name="l00283"></a>00283 
<a name="l00284"></a>00284    <span class="comment">/* Yahoo, a combined copy of the audio! */</span>
<a name="l00285"></a>00285    <span class="keywordflow">return</span> <a class="code" href="frame_8h.html#a4b23720d208128250a765490b1a4f145" title="Copies a frame.">ast_frdup</a>(&amp;frame);
<a name="l00286"></a>00286 }
<a name="l00287"></a>00287 <span class="comment"></span>
<a name="l00288"></a>00288 <span class="comment">/*! \brief Reads a frame in from the audiohook structure</span>
<a name="l00289"></a>00289 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00290"></a>00290 <span class="comment"> * \param samples Number of samples wanted</span>
<a name="l00291"></a>00291 <span class="comment"> * \param direction Direction the audio frame came from</span>
<a name="l00292"></a>00292 <span class="comment"> * \param format Format of frame remote side wants back</span>
<a name="l00293"></a>00293 <span class="comment"> * \return Returns frame on success, NULL on failure</span>
<a name="l00294"></a>00294 <span class="comment"> */</span>
<a name="l00295"></a><a class="code" href="audiohook_8c.html#a0e5d69771f8bd48682ca3d40bc2111c2">00295</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="audiohook_8h.html#a0e5d69771f8bd48682ca3d40bc2111c2" title="Reads a frame in from the audiohook structure.">ast_audiohook_read_frame</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, <span class="keywordtype">size_t</span> samples, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>)
<a name="l00296"></a>00296 {
<a name="l00297"></a>00297    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="file_8c.html#a3d11f27997994d366d52d54a084ec944">read_frame</a> = NULL, *final_frame = NULL;
<a name="l00298"></a>00298 
<a name="l00299"></a>00299    <span class="keywordflow">if</span> (!(read_frame = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899af84e1c36b65319be79e79b03c8f4a360">AST_AUDIOHOOK_DIRECTION_BOTH</a> ? <a class="code" href="audiohook_8c.html#a6b731ffecc7e0cbd1cfa81d1a4903c82">audiohook_read_frame_both</a>(audiohook, samples) : <a class="code" href="audiohook_8c.html#aa8a53e1c05b3e841adf5435fc19a10f2">audiohook_read_frame_single</a>(audiohook, samples, direction))))
<a name="l00300"></a>00300       <span class="keywordflow">return</span> NULL;
<a name="l00301"></a>00301 
<a name="l00302"></a>00302    <span class="comment">/* If they don&apos;t want signed linear back out, we&apos;ll have to send it through the translation path */</span>
<a name="l00303"></a>00303    <span class="keywordflow">if</span> (format != <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) {
<a name="l00304"></a>00304       <span class="comment">/* Rebuild translation path if different format then previously */</span>
<a name="l00305"></a>00305       <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a317afff57d87a89158c2b038d37b2b08">format</a> != format) {
<a name="l00306"></a>00306          <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>) {
<a name="l00307"></a>00307             <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>);
<a name="l00308"></a>00308             audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a> = NULL;
<a name="l00309"></a>00309          }
<a name="l00310"></a>00310          <span class="comment">/* Setup new translation path for this format... if we fail we can&apos;t very well return signed linear so free the frame and return nothing */</span>
<a name="l00311"></a>00311          <span class="keywordflow">if</span> (!(audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a> = <a class="code" href="translate_8h.html#ae53a058fb0d55f3f0b3264813b50232a" title="Builds a translator path Build a path (possibly NULL) from source to dest.">ast_translator_build_path</a>(format, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>))) {
<a name="l00312"></a>00312             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(read_frame);
<a name="l00313"></a>00313             <span class="keywordflow">return</span> NULL;
<a name="l00314"></a>00314          }
<a name="l00315"></a>00315       }
<a name="l00316"></a>00316       <span class="comment">/* Convert to requested format, and allow the read in frame to be freed */</span>
<a name="l00317"></a>00317       final_frame = <a class="code" href="translate_8h.html#ab09d3ccb95d1f828d2871530226f9456" title="translates one or more frames Apply an input frame into the translator and receive...">ast_translate</a>(audiohook-&gt;<a class="code" href="structast__audiohook.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>, read_frame, 1);
<a name="l00318"></a>00318    } <span class="keywordflow">else</span> {
<a name="l00319"></a>00319       final_frame = read_frame;
<a name="l00320"></a>00320    }
<a name="l00321"></a>00321 
<a name="l00322"></a>00322    <span class="keywordflow">return</span> final_frame;
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 <span class="comment"></span>
<a name="l00325"></a>00325 <span class="comment">/*! \brief Attach audiohook to channel</span>
<a name="l00326"></a>00326 <span class="comment"> * \param chan Channel</span>
<a name="l00327"></a>00327 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00328"></a>00328 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00329"></a>00329 <span class="comment"> */</span>
<a name="l00330"></a><a class="code" href="audiohook_8c.html#a94abfad20db137f9d6a33f641d37ac31">00330</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a94abfad20db137f9d6a33f641d37ac31" title="Attach audiohook to channel.">ast_audiohook_attach</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook)
<a name="l00331"></a>00331 {
<a name="l00332"></a>00332    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00333"></a>00333 
<a name="l00334"></a>00334    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>) {
<a name="l00335"></a>00335       <span class="comment">/* Whoops... allocate a new structure */</span>
<a name="l00336"></a>00336       <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>)))) {
<a name="l00337"></a>00337          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00338"></a>00338          <span class="keywordflow">return</span> -1;
<a name="l00339"></a>00339       }
<a name="l00340"></a>00340       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>);
<a name="l00341"></a>00341       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>);
<a name="l00342"></a>00342       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>);
<a name="l00343"></a>00343    }
<a name="l00344"></a>00344 
<a name="l00345"></a>00345    <span class="comment">/* Drop into respective list */</span>
<a name="l00346"></a>00346    <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a> == <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>)
<a name="l00347"></a>00347       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, audiohook, list);
<a name="l00348"></a>00348    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a> == <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>)
<a name="l00349"></a>00349       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, audiohook, list);
<a name="l00350"></a>00350    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a> == <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a20dda44508f42e63dc8ed45760affe08">AST_AUDIOHOOK_TYPE_MANIPULATE</a>)
<a name="l00351"></a>00351       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, audiohook, list);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    <span class="comment">/* Change status over to running since it is now attached */</span>
<a name="l00354"></a>00354    <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00357"></a>00357 
<a name="l00358"></a>00358    <span class="keywordflow">return</span> 0;
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 <span class="comment"></span>
<a name="l00361"></a>00361 <span class="comment">/*! \brief Update audiohook&apos;s status</span>
<a name="l00362"></a>00362 <span class="comment"> * \param audiohook status enum</span>
<a name="l00363"></a>00363 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00364"></a>00364 <span class="comment"> *</span>
<a name="l00365"></a>00365 <span class="comment"> * \note once status is updated to DONE, this function can not be used to set the</span>
<a name="l00366"></a>00366 <span class="comment"> * status back to any other setting.  Setting DONE effectively locks the status as such.</span>
<a name="l00367"></a>00367 <span class="comment"> */</span>
<a name="l00368"></a>00368 
<a name="l00369"></a><a class="code" href="audiohook_8c.html#a5f263b2006fa3bd3e9a96d4580d0125c">00369</a> <span class="keywordtype">void</span> <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ad">ast_audiohook_status</a> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371    <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(audiohook);
<a name="l00372"></a>00372    <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>) {
<a name="l00373"></a>00373       audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> = status;
<a name="l00374"></a>00374       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1730983172cdc5373cf60e0e40294fb0">trigger</a>);
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376    <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00377"></a>00377 }
<a name="l00378"></a>00378 <span class="comment"></span>
<a name="l00379"></a>00379 <span class="comment">/*! \brief Detach audiohook from channel</span>
<a name="l00380"></a>00380 <span class="comment"> * \param audiohook Audiohook structure</span>
<a name="l00381"></a>00381 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00382"></a>00382 <span class="comment"> */</span>
<a name="l00383"></a><a class="code" href="audiohook_8c.html#a88b9ad3730e7adbc3b396bef4e85b12a">00383</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a88b9ad3730e7adbc3b396bef4e85b12a" title="Detach audiohook from channel.">ast_audiohook_detach</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook)
<a name="l00384"></a>00384 {
<a name="l00385"></a>00385    <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adab303a4f550e2d8232d9803bf2d95f480">AST_AUDIOHOOK_STATUS_NEW</a> || audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>)
<a name="l00386"></a>00386       <span class="keywordflow">return</span> 0;
<a name="l00387"></a>00387 
<a name="l00388"></a>00388    <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adac1d3e44970c0af0ebd25b95f59b5cf57">AST_AUDIOHOOK_STATUS_SHUTDOWN</a>);
<a name="l00389"></a>00389 
<a name="l00390"></a>00390    <span class="keywordflow">while</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>)
<a name="l00391"></a>00391       <a class="code" href="audiohook_8h.html#a47bb160cbe5e534c0fca6560015ffe59" title="Wait for audiohook trigger to be triggered.">ast_audiohook_trigger_wait</a>(audiohook);
<a name="l00392"></a>00392 
<a name="l00393"></a>00393    <span class="keywordflow">return</span> 0;
<a name="l00394"></a>00394 }
<a name="l00395"></a>00395 <span class="comment"></span>
<a name="l00396"></a>00396 <span class="comment">/*! \brief Detach audiohooks from list and destroy said list</span>
<a name="l00397"></a>00397 <span class="comment"> * \param audiohook_list List of audiohooks</span>
<a name="l00398"></a>00398 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00399"></a>00399 <span class="comment"> */</span>
<a name="l00400"></a><a class="code" href="audiohook_8c.html#a97fef5ce6c1baffe0051c8f8b70ad2f8">00400</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a97fef5ce6c1baffe0051c8f8b70ad2f8" title="Detach audiohooks from list and destroy said list.">ast_audiohook_detach_list</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook__list.html">ast_audiohook_list</a> *audiohook_list)
<a name="l00401"></a>00401 {
<a name="l00402"></a>00402    <span class="keywordtype">int</span> i = 0;
<a name="l00403"></a>00403    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook = NULL;
<a name="l00404"></a>00404 
<a name="l00405"></a>00405    <span class="comment">/* Drop any spies */</span>
<a name="l00406"></a>00406    <span class="keywordflow">while</span> ((audiohook = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, list))) {
<a name="l00407"></a>00407       <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00408"></a>00408    }
<a name="l00409"></a>00409 
<a name="l00410"></a>00410    <span class="comment">/* Drop any whispering sources */</span>
<a name="l00411"></a>00411    <span class="keywordflow">while</span> ((audiohook = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, list))) {
<a name="l00412"></a>00412       <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00413"></a>00413    }
<a name="l00414"></a>00414 
<a name="l00415"></a>00415    <span class="comment">/* Drop any manipulaters */</span>
<a name="l00416"></a>00416    <span class="keywordflow">while</span> ((audiohook = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, list))) {
<a name="l00417"></a>00417       <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00418"></a>00418       audiohook-&gt;<a class="code" href="structast__audiohook.html#a4592709f9cf7b13798a0afcafbd96893">manipulate_callback</a>(audiohook, NULL, NULL, 0);
<a name="l00419"></a>00419    }
<a name="l00420"></a>00420 
<a name="l00421"></a>00421    <span class="comment">/* Drop translation paths if present */</span>
<a name="l00422"></a>00422    <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l00423"></a>00423       <span class="keywordflow">if</span> (audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">in_translate</a>[i].<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>)
<a name="l00424"></a>00424          <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">in_translate</a>[i].<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>);
<a name="l00425"></a>00425       <span class="keywordflow">if</span> (audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">out_translate</a>[i].<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>)
<a name="l00426"></a>00426          <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">out_translate</a>[i].<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>);
<a name="l00427"></a>00427    }
<a name="l00428"></a>00428    
<a name="l00429"></a>00429    <span class="comment">/* Free ourselves */</span>
<a name="l00430"></a>00430    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(audiohook_list);
<a name="l00431"></a>00431 
<a name="l00432"></a>00432    <span class="keywordflow">return</span> 0;
<a name="l00433"></a>00433 }
<a name="l00434"></a>00434 <span class="comment"></span>
<a name="l00435"></a>00435 <span class="comment">/*! \brief find an audiohook based on its source</span>
<a name="l00436"></a>00436 <span class="comment"> * \param audiohook_list The list of audiohooks to search in</span>
<a name="l00437"></a>00437 <span class="comment"> * \param source The source of the audiohook we wish to find</span>
<a name="l00438"></a>00438 <span class="comment"> * \return Return the corresponding audiohook or NULL if it cannot be found.</span>
<a name="l00439"></a>00439 <span class="comment"> */</span>
<a name="l00440"></a><a class="code" href="audiohook_8c.html#a1e0a923b8b1fa6d4be9060b3ece13b3b">00440</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *<a class="code" href="audiohook_8c.html#a1e0a923b8b1fa6d4be9060b3ece13b3b" title="find an audiohook based on its source">find_audiohook_by_source</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook__list.html">ast_audiohook_list</a> *audiohook_list, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>)
<a name="l00441"></a>00441 {
<a name="l00442"></a>00442    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook = NULL;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, audiohook, list) {
<a name="l00445"></a>00445       <span class="keywordflow">if</span> (!strcasecmp(audiohook-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source))
<a name="l00446"></a>00446          <span class="keywordflow">return</span> audiohook;
<a name="l00447"></a>00447    }
<a name="l00448"></a>00448 
<a name="l00449"></a>00449    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, audiohook, list) {
<a name="l00450"></a>00450       <span class="keywordflow">if</span> (!strcasecmp(audiohook-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source))
<a name="l00451"></a>00451          <span class="keywordflow">return</span> audiohook;
<a name="l00452"></a>00452    }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, audiohook, list) {
<a name="l00455"></a>00455       <span class="keywordflow">if</span> (!strcasecmp(audiohook-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source))
<a name="l00456"></a>00456          <span class="keywordflow">return</span> audiohook;
<a name="l00457"></a>00457    }
<a name="l00458"></a>00458 
<a name="l00459"></a>00459    <span class="keywordflow">return</span> NULL;
<a name="l00460"></a>00460 }
<a name="l00461"></a>00461 
<a name="l00462"></a><a class="code" href="audiohook_8c.html#ae09727634eabe798d8abc95d46fa7b1e">00462</a> <span class="keywordtype">void</span> <a class="code" href="audiohook_8h.html#ae09727634eabe798d8abc95d46fa7b1e" title="Move an audiohook from one channel to a new one.">ast_audiohook_move_by_source</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old_chan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *new_chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>)
<a name="l00463"></a>00463 {
<a name="l00464"></a>00464    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook;
<a name="l00465"></a>00465    <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ad">ast_audiohook_status</a> oldstatus;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    <span class="keywordflow">if</span> (!old_chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> || !(audiohook = <a class="code" href="audiohook_8c.html#a1e0a923b8b1fa6d4be9060b3ece13b3b" title="find an audiohook based on its source">find_audiohook_by_source</a>(old_chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>, source))) {
<a name="l00468"></a>00468       <span class="keywordflow">return</span>;
<a name="l00469"></a>00469    }
<a name="l00470"></a>00470 
<a name="l00471"></a>00471    <span class="comment">/* By locking both channels and the audiohook, we can assure that</span>
<a name="l00472"></a>00472 <span class="comment">    * another thread will not have a chance to read the audiohook&apos;s status</span>
<a name="l00473"></a>00473 <span class="comment">    * as done, even though ast_audiohook_remove signals the trigger</span>
<a name="l00474"></a>00474 <span class="comment">    * condition.</span>
<a name="l00475"></a>00475 <span class="comment">    */</span>
<a name="l00476"></a>00476    <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(audiohook);
<a name="l00477"></a>00477    oldstatus = audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a>;
<a name="l00478"></a>00478 
<a name="l00479"></a>00479    <a class="code" href="audiohook_8h.html#a34c80f85a6c8c76a4138323837c116d4" title="Remove an audiohook from a specified channel.">ast_audiohook_remove</a>(old_chan, audiohook);
<a name="l00480"></a>00480    <a class="code" href="audiohook_8h.html#a94abfad20db137f9d6a33f641d37ac31" title="Attach audiohook to channel.">ast_audiohook_attach</a>(new_chan, audiohook);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> = oldstatus;
<a name="l00483"></a>00483    <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 <span class="comment"></span>
<a name="l00486"></a>00486 <span class="comment">/*! \brief Detach specified source audiohook from channel</span>
<a name="l00487"></a>00487 <span class="comment"> * \param chan Channel to detach from</span>
<a name="l00488"></a>00488 <span class="comment"> * \param source Name of source to detach</span>
<a name="l00489"></a>00489 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00490"></a>00490 <span class="comment"> */</span>
<a name="l00491"></a><a class="code" href="audiohook_8c.html#a34ed9fa0751083523ea90d1ad7c81fbf">00491</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a34ed9fa0751083523ea90d1ad7c81fbf" title="Detach specified source audiohook from channel.">ast_audiohook_detach_source</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>)
<a name="l00492"></a>00492 {
<a name="l00493"></a>00493    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook = NULL;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00496"></a>00496 
<a name="l00497"></a>00497    <span class="comment">/* Ensure the channel has audiohooks on it */</span>
<a name="l00498"></a>00498    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>) {
<a name="l00499"></a>00499       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00500"></a>00500       <span class="keywordflow">return</span> -1;
<a name="l00501"></a>00501    }
<a name="l00502"></a>00502 
<a name="l00503"></a>00503    audiohook = <a class="code" href="audiohook_8c.html#a1e0a923b8b1fa6d4be9060b3ece13b3b" title="find an audiohook based on its source">find_audiohook_by_source</a>(chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>, source);
<a name="l00504"></a>00504 
<a name="l00505"></a>00505    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00506"></a>00506 
<a name="l00507"></a>00507    <span class="keywordflow">if</span> (audiohook &amp;&amp; audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>)
<a name="l00508"></a>00508       <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adac1d3e44970c0af0ebd25b95f59b5cf57">AST_AUDIOHOOK_STATUS_SHUTDOWN</a>);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    <span class="keywordflow">return</span> (audiohook ? 0 : -1);
<a name="l00511"></a>00511 }
<a name="l00512"></a>00512 <span class="comment"></span>
<a name="l00513"></a>00513 <span class="comment">/*!</span>
<a name="l00514"></a>00514 <span class="comment"> * \brief Remove an audiohook from a specified channel</span>
<a name="l00515"></a>00515 <span class="comment"> *</span>
<a name="l00516"></a>00516 <span class="comment"> * \param chan Channel to remove from</span>
<a name="l00517"></a>00517 <span class="comment"> * \param audiohook Audiohook to remove</span>
<a name="l00518"></a>00518 <span class="comment"> *</span>
<a name="l00519"></a>00519 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00520"></a>00520 <span class="comment"> *</span>
<a name="l00521"></a>00521 <span class="comment"> * \note The channel does not need to be locked before calling this function</span>
<a name="l00522"></a>00522 <span class="comment"> */</span>
<a name="l00523"></a><a class="code" href="audiohook_8c.html#a34c80f85a6c8c76a4138323837c116d4">00523</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a34c80f85a6c8c76a4138323837c116d4" title="Remove an audiohook from a specified channel.">ast_audiohook_remove</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook)
<a name="l00524"></a>00524 {
<a name="l00525"></a>00525    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>) {
<a name="l00528"></a>00528       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00529"></a>00529       <span class="keywordflow">return</span> -1;
<a name="l00530"></a>00530    }
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a> == <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>)
<a name="l00533"></a>00533       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, audiohook, list);
<a name="l00534"></a>00534    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a> == <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>)
<a name="l00535"></a>00535       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, audiohook, list);
<a name="l00536"></a>00536    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a2ad9abd9447a1c58bfe6b03e05f98335">type</a> == <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a20dda44508f42e63dc8ed45760affe08">AST_AUDIOHOOK_TYPE_MANIPULATE</a>)
<a name="l00537"></a>00537       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, audiohook, list);
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00540"></a>00540 
<a name="l00541"></a>00541    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00542"></a>00542 
<a name="l00543"></a>00543    <span class="keywordflow">return</span> 0;
<a name="l00544"></a>00544 }
<a name="l00545"></a>00545 <span class="comment"></span>
<a name="l00546"></a>00546 <span class="comment">/*! \brief Pass a DTMF frame off to be handled by the audiohook core</span>
<a name="l00547"></a>00547 <span class="comment"> * \param chan Channel that the list is coming off of</span>
<a name="l00548"></a>00548 <span class="comment"> * \param audiohook_list List of audiohooks</span>
<a name="l00549"></a>00549 <span class="comment"> * \param direction Direction frame is coming in from</span>
<a name="l00550"></a>00550 <span class="comment"> * \param frame The frame itself</span>
<a name="l00551"></a>00551 <span class="comment"> * \return Return frame on success, NULL on failure</span>
<a name="l00552"></a>00552 <span class="comment"> */</span>
<a name="l00553"></a><a class="code" href="audiohook_8c.html#a24cd014c45720f22b594db9cda49ee12">00553</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="audiohook_8c.html#a24cd014c45720f22b594db9cda49ee12" title="Pass a DTMF frame off to be handled by the audiohook core.">dtmf_audiohook_write_list</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__audiohook__list.html">ast_audiohook_list</a> *audiohook_list, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame)
<a name="l00554"></a>00554 {
<a name="l00555"></a>00555    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook = NULL;
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, audiohook, list) {
<a name="l00558"></a>00558       <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(audiohook);
<a name="l00559"></a>00559       <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>) {
<a name="l00560"></a>00560          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l00561"></a>00561          <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00562"></a>00562          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00563"></a>00563          audiohook-&gt;<a class="code" href="structast__audiohook.html#a4592709f9cf7b13798a0afcafbd96893">manipulate_callback</a>(audiohook, NULL, NULL, 0);
<a name="l00564"></a>00564          <span class="keywordflow">continue</span>;
<a name="l00565"></a>00565       }
<a name="l00566"></a>00566       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951a76af7a6555f4582850cfaef9d5391e32">AST_AUDIOHOOK_WANTS_DTMF</a>))
<a name="l00567"></a>00567          audiohook-&gt;<a class="code" href="structast__audiohook.html#a4592709f9cf7b13798a0afcafbd96893">manipulate_callback</a>(audiohook, chan, frame, direction);
<a name="l00568"></a>00568       <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00569"></a>00569    }
<a name="l00570"></a>00570    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00571"></a>00571 
<a name="l00572"></a>00572    <span class="keywordflow">return</span> frame;
<a name="l00573"></a>00573 }
<a name="l00574"></a>00574 <span class="comment"></span>
<a name="l00575"></a>00575 <span class="comment">/*! \brief Pass an AUDIO frame off to be handled by the audiohook core</span>
<a name="l00576"></a>00576 <span class="comment"> * \param chan Channel that the list is coming off of</span>
<a name="l00577"></a>00577 <span class="comment"> * \param audiohook_list List of audiohooks</span>
<a name="l00578"></a>00578 <span class="comment"> * \param direction Direction frame is coming in from</span>
<a name="l00579"></a>00579 <span class="comment"> * \param frame The frame itself</span>
<a name="l00580"></a>00580 <span class="comment"> * \return Return frame on success, NULL on failure</span>
<a name="l00581"></a>00581 <span class="comment"> */</span>
<a name="l00582"></a><a class="code" href="audiohook_8c.html#aa670562cb376cb726a122412d173127c">00582</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="audiohook_8c.html#aa670562cb376cb726a122412d173127c" title="Pass an AUDIO frame off to be handled by the audiohook core.">audio_audiohook_write_list</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__audiohook__list.html">ast_audiohook_list</a> *audiohook_list, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame)
<a name="l00583"></a>00583 {
<a name="l00584"></a>00584    <span class="keyword">struct </span><a class="code" href="structast__audiohook__translate.html">ast_audiohook_translate</a> *<a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">in_translate</a> = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? &amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">in_translate</a>[0] : &amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#afe31074fcddab60b8fb0019b1f16e67d">in_translate</a>[1]);
<a name="l00585"></a>00585    <span class="keyword">struct </span><a class="code" href="structast__audiohook__translate.html">ast_audiohook_translate</a> *<a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">out_translate</a> = (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> ? &amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">out_translate</a>[0] : &amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a0ef356831a74b5632d5223819b992069">out_translate</a>[1]);
<a name="l00586"></a>00586    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *start_frame = frame, *middle_frame = frame, *end_frame = frame;
<a name="l00587"></a>00587    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook = NULL;
<a name="l00588"></a>00588    <span class="keywordtype">int</span> samples = frame-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00589"></a>00589 
<a name="l00590"></a>00590    <span class="comment">/* If the frame coming in is not signed linear we have to send it through the in_translate path */</span>
<a name="l00591"></a>00591    <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) {
<a name="l00592"></a>00592       <span class="keywordflow">if</span> (in_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a317afff57d87a89158c2b038d37b2b08">format</a> != frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l00593"></a>00593          <span class="keywordflow">if</span> (in_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>)
<a name="l00594"></a>00594             <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(in_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>);
<a name="l00595"></a>00595          <span class="keywordflow">if</span> (!(in_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a> = <a class="code" href="translate_8h.html#ae53a058fb0d55f3f0b3264813b50232a" title="Builds a translator path Build a path (possibly NULL) from source to dest.">ast_translator_build_path</a>(<a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>, frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)))
<a name="l00596"></a>00596             <span class="keywordflow">return</span> frame;
<a name="l00597"></a>00597          in_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a317afff57d87a89158c2b038d37b2b08">format</a> = frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00598"></a>00598       }
<a name="l00599"></a>00599       <span class="keywordflow">if</span> (!(middle_frame = <a class="code" href="translate_8h.html#ab09d3ccb95d1f828d2871530226f9456" title="translates one or more frames Apply an input frame into the translator and receive...">ast_translate</a>(in_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>, frame, 0)))
<a name="l00600"></a>00600          <span class="keywordflow">return</span> frame;
<a name="l00601"></a>00601       samples = middle_frame-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l00602"></a>00602    }
<a name="l00603"></a>00603 
<a name="l00604"></a>00604    <span class="comment">/* Queue up signed linear frame to each spy */</span>
<a name="l00605"></a>00605    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, audiohook, list) {
<a name="l00606"></a>00606       <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(audiohook);
<a name="l00607"></a>00607       <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>) {
<a name="l00608"></a>00608          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l00609"></a>00609          <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00610"></a>00610          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00611"></a>00611          <span class="keywordflow">continue</span>;
<a name="l00612"></a>00612       }
<a name="l00613"></a>00613       <a class="code" href="audiohook_8h.html#a3391dbd95c95f041cf14fa30e0f5c73d" title="Writes a frame into the audiohook structure.">ast_audiohook_write_frame</a>(audiohook, direction, middle_frame);
<a name="l00614"></a>00614       <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00615"></a>00615    }
<a name="l00616"></a>00616    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00617"></a>00617 
<a name="l00618"></a>00618    <span class="comment">/* If this frame is being written out to the channel then we need to use whisper sources */</span>
<a name="l00619"></a>00619    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a> &amp;&amp; !<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>)) {
<a name="l00620"></a>00620       <span class="keywordtype">int</span> i = 0;
<a name="l00621"></a>00621       <span class="keywordtype">short</span> read_buf[samples], combine_buf[samples], *data1 = NULL, *data2 = NULL;
<a name="l00622"></a>00622       memset(&amp;combine_buf, 0, <span class="keyword">sizeof</span>(combine_buf));
<a name="l00623"></a>00623       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, audiohook, list) {
<a name="l00624"></a>00624          <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(audiohook);
<a name="l00625"></a>00625          <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>) {
<a name="l00626"></a>00626             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l00627"></a>00627             <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00628"></a>00628             <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00629"></a>00629             <span class="keywordflow">continue</span>;
<a name="l00630"></a>00630          }
<a name="l00631"></a>00631          <span class="keywordflow">if</span> (<a class="code" href="slinfactory_8h.html#a6c48d283b3d2bce6af0a09c3b8b7fd0e" title="Retrieve number of samples currently in a slinfactory.">ast_slinfactory_available</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>) &gt;= samples &amp;&amp; <a class="code" href="slinfactory_8h.html#a75052c0e654e356675b26afbebe93097" title="Read samples from a slinfactory.">ast_slinfactory_read</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#aecd1ea17a6f1a4cc3bf683296792b262">write_factory</a>, read_buf, samples)) {
<a name="l00632"></a>00632             <span class="comment">/* Take audio from this whisper source and combine it into our main buffer */</span>
<a name="l00633"></a>00633             <span class="keywordflow">for</span> (i = 0, data1 = combine_buf, data2 = read_buf; i &lt; samples; i++, data1++, data2++)
<a name="l00634"></a>00634                <a class="code" href="utils_8h.html#a8761597fec2f8a17d105a82c20d0b728">ast_slinear_saturated_add</a>(data1, data2);
<a name="l00635"></a>00635          }
<a name="l00636"></a>00636          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00637"></a>00637       }
<a name="l00638"></a>00638       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00639"></a>00639       <span class="comment">/* We take all of the combined whisper sources and combine them into the audio being written out */</span>
<a name="l00640"></a>00640       <span class="keywordflow">for</span> (i = 0, data1 = middle_frame-&gt;data.ptr, data2 = combine_buf; i &lt; samples; i++, data1++, data2++)
<a name="l00641"></a>00641          <a class="code" href="utils_8h.html#a8761597fec2f8a17d105a82c20d0b728">ast_slinear_saturated_add</a>(data1, data2);
<a name="l00642"></a>00642       end_frame = middle_frame;
<a name="l00643"></a>00643    }
<a name="l00644"></a>00644 
<a name="l00645"></a>00645    <span class="comment">/* Pass off frame to manipulate audiohooks */</span>
<a name="l00646"></a>00646    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>)) {
<a name="l00647"></a>00647       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;audiohook_list-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, audiohook, list) {
<a name="l00648"></a>00648          <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(audiohook);
<a name="l00649"></a>00649          <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>) {
<a name="l00650"></a>00650             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l00651"></a>00651             <a class="code" href="audiohook_8h.html#a5f263b2006fa3bd3e9a96d4580d0125c" title="Update audiohook&amp;#39;s status.">ast_audiohook_update_status</a>(audiohook, <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>);
<a name="l00652"></a>00652             <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00653"></a>00653             <span class="comment">/* We basically drop all of our links to the manipulate audiohook and prod it to do it&apos;s own destructive things */</span>
<a name="l00654"></a>00654             audiohook-&gt;<a class="code" href="structast__audiohook.html#a4592709f9cf7b13798a0afcafbd96893">manipulate_callback</a>(audiohook, chan, NULL, direction);
<a name="l00655"></a>00655             <span class="keywordflow">continue</span>;
<a name="l00656"></a>00656          }
<a name="l00657"></a>00657          <span class="comment">/* Feed in frame to manipulation */</span>
<a name="l00658"></a>00658          <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a4592709f9cf7b13798a0afcafbd96893">manipulate_callback</a>(audiohook, chan, middle_frame, direction)) {
<a name="l00659"></a>00659             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(middle_frame);
<a name="l00660"></a>00660             middle_frame = NULL;
<a name="l00661"></a>00661          }
<a name="l00662"></a>00662          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(audiohook);
<a name="l00663"></a>00663       }
<a name="l00664"></a>00664       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00665"></a>00665       <span class="keywordflow">if</span> (middle_frame) {
<a name="l00666"></a>00666          end_frame = middle_frame;
<a name="l00667"></a>00667       }
<a name="l00668"></a>00668    }
<a name="l00669"></a>00669 
<a name="l00670"></a>00670    <span class="comment">/* Now we figure out what to do with our end frame (whether to transcode or not) */</span>
<a name="l00671"></a>00671    <span class="keywordflow">if</span> (middle_frame == end_frame) {
<a name="l00672"></a>00672       <span class="comment">/* Middle frame was modified and became the end frame... let&apos;s see if we need to transcode */</span>
<a name="l00673"></a>00673       <span class="keywordflow">if</span> (end_frame-&gt;subclass != start_frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l00674"></a>00674          <span class="keywordflow">if</span> (out_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a317afff57d87a89158c2b038d37b2b08">format</a> != start_frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l00675"></a>00675             <span class="keywordflow">if</span> (out_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>)
<a name="l00676"></a>00676                <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(out_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>);
<a name="l00677"></a>00677             <span class="keywordflow">if</span> (!(out_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a> = <a class="code" href="translate_8h.html#ae53a058fb0d55f3f0b3264813b50232a" title="Builds a translator path Build a path (possibly NULL) from source to dest.">ast_translator_build_path</a>(start_frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>))) {
<a name="l00678"></a>00678                <span class="comment">/* We can&apos;t transcode this... drop our middle frame and return the original */</span>
<a name="l00679"></a>00679                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(middle_frame);
<a name="l00680"></a>00680                <span class="keywordflow">return</span> start_frame;
<a name="l00681"></a>00681             }
<a name="l00682"></a>00682             out_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a317afff57d87a89158c2b038d37b2b08">format</a> = start_frame-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l00683"></a>00683          }
<a name="l00684"></a>00684          <span class="comment">/* Transcode from our middle (signed linear) frame to new format of the frame that came in */</span>
<a name="l00685"></a>00685          <span class="keywordflow">if</span> (!(end_frame = <a class="code" href="translate_8h.html#ab09d3ccb95d1f828d2871530226f9456" title="translates one or more frames Apply an input frame into the translator and receive...">ast_translate</a>(out_translate-&gt;<a class="code" href="structast__audiohook__translate.html#a747ca6507654d33f73cf289e8172a5dd">trans_pvt</a>, middle_frame, 0))) {
<a name="l00686"></a>00686             <span class="comment">/* Failed to transcode the frame... drop it and return the original */</span>
<a name="l00687"></a>00687             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(middle_frame);
<a name="l00688"></a>00688             <span class="keywordflow">return</span> start_frame;
<a name="l00689"></a>00689          }
<a name="l00690"></a>00690          <span class="comment">/* Here&apos;s the scoop... middle frame is no longer of use to us */</span>
<a name="l00691"></a>00691          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(middle_frame);
<a name="l00692"></a>00692       }
<a name="l00693"></a>00693    } <span class="keywordflow">else</span> {
<a name="l00694"></a>00694       <span class="comment">/* No frame was modified, we can just drop our middle frame and pass the frame we got in out */</span>
<a name="l00695"></a>00695       <span class="keywordflow">if</span> (middle_frame) {
<a name="l00696"></a>00696          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(middle_frame);
<a name="l00697"></a>00697       }
<a name="l00698"></a>00698    }
<a name="l00699"></a>00699 
<a name="l00700"></a>00700    <span class="keywordflow">return</span> end_frame;
<a name="l00701"></a>00701 }
<a name="l00702"></a>00702 <span class="comment"></span>
<a name="l00703"></a>00703 <span class="comment">/*! \brief Pass a frame off to be handled by the audiohook core</span>
<a name="l00704"></a>00704 <span class="comment"> * \param chan Channel that the list is coming off of</span>
<a name="l00705"></a>00705 <span class="comment"> * \param audiohook_list List of audiohooks</span>
<a name="l00706"></a>00706 <span class="comment"> * \param direction Direction frame is coming in from</span>
<a name="l00707"></a>00707 <span class="comment"> * \param frame The frame itself</span>
<a name="l00708"></a>00708 <span class="comment"> * \return Return frame on success, NULL on failure</span>
<a name="l00709"></a>00709 <span class="comment"> */</span>
<a name="l00710"></a><a class="code" href="audiohook_8c.html#a6351c89eb98b1832e85fa9c0fca7383f">00710</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="audiohook_8h.html#a6351c89eb98b1832e85fa9c0fca7383f" title="Pass a frame off to be handled by the audiohook core.">ast_audiohook_write_list</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__audiohook__list.html">ast_audiohook_list</a> *audiohook_list, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame)
<a name="l00711"></a>00711 {
<a name="l00712"></a>00712    <span class="comment">/* Pass off frame to it&apos;s respective list write function */</span>
<a name="l00713"></a>00713    <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>)
<a name="l00714"></a>00714       <span class="keywordflow">return</span> <a class="code" href="audiohook_8c.html#aa670562cb376cb726a122412d173127c" title="Pass an AUDIO frame off to be handled by the audiohook core.">audio_audiohook_write_list</a>(chan, audiohook_list, direction, frame);
<a name="l00715"></a>00715    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (frame-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>)
<a name="l00716"></a>00716       <span class="keywordflow">return</span> <a class="code" href="audiohook_8c.html#a24cd014c45720f22b594db9cda49ee12" title="Pass a DTMF frame off to be handled by the audiohook core.">dtmf_audiohook_write_list</a>(chan, audiohook_list, direction, frame);
<a name="l00717"></a>00717    <span class="keywordflow">else</span>
<a name="l00718"></a>00718       <span class="keywordflow">return</span> frame;
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720          
<a name="l00721"></a>00721 <span class="comment"></span>
<a name="l00722"></a>00722 <span class="comment">/*! \brief Wait for audiohook trigger to be triggered</span>
<a name="l00723"></a>00723 <span class="comment"> * \param audiohook Audiohook to wait on</span>
<a name="l00724"></a>00724 <span class="comment"> */</span>
<a name="l00725"></a><a class="code" href="audiohook_8c.html#a47bb160cbe5e534c0fca6560015ffe59">00725</a> <span class="keywordtype">void</span> <a class="code" href="audiohook_8h.html#a47bb160cbe5e534c0fca6560015ffe59" title="Wait for audiohook trigger to be triggered.">ast_audiohook_trigger_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook)
<a name="l00726"></a>00726 {
<a name="l00727"></a>00727    <span class="keyword">struct </span>timeval wait;
<a name="l00728"></a>00728    <span class="keyword">struct </span>timespec ts;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    wait = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(50000, 1000));
<a name="l00731"></a>00731    ts.tv_sec = wait.tv_sec;
<a name="l00732"></a>00732    ts.tv_nsec = wait.tv_usec * 1000;
<a name="l00733"></a>00733    
<a name="l00734"></a>00734    <a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(&amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#a1730983172cdc5373cf60e0e40294fb0">trigger</a>, &amp;audiohook-&gt;<a class="code" href="structast__audiohook.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>, &amp;ts);
<a name="l00735"></a>00735    
<a name="l00736"></a>00736    <span class="keywordflow">return</span>;
<a name="l00737"></a>00737 }
<a name="l00738"></a>00738 
<a name="l00739"></a>00739 <span class="comment">/* Count number of channel audiohooks by type, regardless of type */</span>
<a name="l00740"></a><a class="code" href="audiohook_8c.html#a86f07afe75e6c2405d124d98faaf9800">00740</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a86f07afe75e6c2405d124d98faaf9800" title="Find out how many audiohooks from a certain source exist on a given channel, regardless...">ast_channel_audiohook_count_by_source</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *source, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0">ast_audiohook_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l00741"></a>00741 {
<a name="l00742"></a>00742    <span class="keywordtype">int</span> count = 0;
<a name="l00743"></a>00743    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *ah = NULL;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>)
<a name="l00746"></a>00746       <span class="keywordflow">return</span> -1;
<a name="l00747"></a>00747 
<a name="l00748"></a>00748    <span class="keywordflow">switch</span> (type) {
<a name="l00749"></a>00749       <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>:
<a name="l00750"></a>00750          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, ah, list) {
<a name="l00751"></a>00751             <span class="keywordflow">if</span> (!strcmp(ah-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source)) {
<a name="l00752"></a>00752                count++;
<a name="l00753"></a>00753             }
<a name="l00754"></a>00754          }
<a name="l00755"></a>00755          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00756"></a>00756          <span class="keywordflow">break</span>;
<a name="l00757"></a>00757       <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>:
<a name="l00758"></a>00758          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, ah, list) {
<a name="l00759"></a>00759             <span class="keywordflow">if</span> (!strcmp(ah-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source)) {
<a name="l00760"></a>00760                count++;
<a name="l00761"></a>00761             }
<a name="l00762"></a>00762          }
<a name="l00763"></a>00763          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00764"></a>00764          <span class="keywordflow">break</span>;
<a name="l00765"></a>00765       <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a20dda44508f42e63dc8ed45760affe08">AST_AUDIOHOOK_TYPE_MANIPULATE</a>:
<a name="l00766"></a>00766          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, ah, list) {
<a name="l00767"></a>00767             <span class="keywordflow">if</span> (!strcmp(ah-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source)) {
<a name="l00768"></a>00768                count++;
<a name="l00769"></a>00769             }
<a name="l00770"></a>00770          }
<a name="l00771"></a>00771          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00772"></a>00772          <span class="keywordflow">break</span>;
<a name="l00773"></a>00773       <span class="keywordflow">default</span>:
<a name="l00774"></a>00774          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Invalid audiohook type supplied, (%d)\n&quot;</span>, type);
<a name="l00775"></a>00775          <span class="keywordflow">return</span> -1;
<a name="l00776"></a>00776    }
<a name="l00777"></a>00777 
<a name="l00778"></a>00778    <span class="keywordflow">return</span> count;
<a name="l00779"></a>00779 }
<a name="l00780"></a>00780 
<a name="l00781"></a>00781 <span class="comment">/* Count number of channel audiohooks by type that are running */</span>
<a name="l00782"></a><a class="code" href="audiohook_8c.html#a9c85bb250bc65d74fecce3a388ef30bd">00782</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a9c85bb250bc65d74fecce3a388ef30bd" title="Find out how many spies of a certain type exist on a given channel, and are in state...">ast_channel_audiohook_count_by_source_running</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0">ast_audiohook_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l00783"></a>00783 {
<a name="l00784"></a>00784    <span class="keywordtype">int</span> count = 0;
<a name="l00785"></a>00785    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> *ah = NULL;
<a name="l00786"></a>00786    <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>)
<a name="l00787"></a>00787       <span class="keywordflow">return</span> -1;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789    <span class="keywordflow">switch</span> (type) {
<a name="l00790"></a>00790       <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>:
<a name="l00791"></a>00791          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#ab1b7108d32768b87015db450e753302c">spy_list</a>, ah, list) {
<a name="l00792"></a>00792             <span class="keywordflow">if</span> ((!strcmp(ah-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source)) &amp;&amp; (ah-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>))
<a name="l00793"></a>00793                count++;
<a name="l00794"></a>00794          }
<a name="l00795"></a>00795          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00796"></a>00796          <span class="keywordflow">break</span>;
<a name="l00797"></a>00797       <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>:
<a name="l00798"></a>00798          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#a463b768292e522f67f80733d5dc1c5e0">whisper_list</a>, ah, list) {
<a name="l00799"></a>00799             <span class="keywordflow">if</span> ((!strcmp(ah-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source)) &amp;&amp; (ah-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>))
<a name="l00800"></a>00800                count++;
<a name="l00801"></a>00801          }
<a name="l00802"></a>00802          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00803"></a>00803          <span class="keywordflow">break</span>;
<a name="l00804"></a>00804       <span class="keywordflow">case</span> <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a20dda44508f42e63dc8ed45760affe08">AST_AUDIOHOOK_TYPE_MANIPULATE</a>:
<a name="l00805"></a>00805          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>-&gt;<a class="code" href="structast__audiohook__list.html#acdea2991ba0b3828e72ba3d936aa33dd">manipulate_list</a>, ah, list) {
<a name="l00806"></a>00806             <span class="keywordflow">if</span> ((!strcmp(ah-&gt;<a class="code" href="structast__audiohook.html#af2ed45b90afa2ef4ec6e09625335a082">source</a>, source)) &amp;&amp; (ah-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>))
<a name="l00807"></a>00807                count++;
<a name="l00808"></a>00808          }
<a name="l00809"></a>00809          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l00810"></a>00810          <span class="keywordflow">break</span>;
<a name="l00811"></a>00811       <span class="keywordflow">default</span>:
<a name="l00812"></a>00812          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Invalid audiohook type supplied, (%d)\n&quot;</span>, type);
<a name="l00813"></a>00813          <span class="keywordflow">return</span> -1;
<a name="l00814"></a>00814    }
<a name="l00815"></a>00815    <span class="keywordflow">return</span> count;
<a name="l00816"></a>00816 }
<a name="l00817"></a>00817 <span class="comment"></span>
<a name="l00818"></a>00818 <span class="comment">/*! \brief Audiohook volume adjustment structure */</span>
<a name="l00819"></a><a class="code" href="structaudiohook__volume.html">00819</a> <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> {
<a name="l00820"></a><a class="code" href="structaudiohook__volume.html#aaf5379c0defdcacdae37add0d0c8af1d">00820</a>    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> audiohook; <span class="comment">/*!&lt; Audiohook attached to the channel */</span>
<a name="l00821"></a><a class="code" href="structaudiohook__volume.html#a0a766b2643ed747312a40990b7792a07">00821</a>    <span class="keywordtype">int</span> read_adjustment;            <span class="comment">/*!&lt; Value to adjust frames read from the channel by */</span>
<a name="l00822"></a><a class="code" href="structaudiohook__volume.html#ac97a76d6712af0af6937fe394d4c8432">00822</a>    <span class="keywordtype">int</span> write_adjustment;           <span class="comment">/*!&lt; Value to adjust frames written to the channel by */</span>
<a name="l00823"></a>00823 };
<a name="l00824"></a>00824 <span class="comment"></span>
<a name="l00825"></a>00825 <span class="comment">/*! \brief Callback used to destroy the audiohook volume datastore</span>
<a name="l00826"></a>00826 <span class="comment"> * \param data Volume information structure</span>
<a name="l00827"></a>00827 <span class="comment"> * \return Returns nothing</span>
<a name="l00828"></a>00828 <span class="comment"> */</span>
<a name="l00829"></a><a class="code" href="audiohook_8c.html#af83018dd9d2d3bee8129613c4d671d48">00829</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="audiohook_8c.html#af83018dd9d2d3bee8129613c4d671d48" title="Callback used to destroy the audiohook volume datastore.">audiohook_volume_destroy</a>(<span class="keywordtype">void</span> *data)
<a name="l00830"></a>00830 {
<a name="l00831"></a>00831    <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> = data;
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <span class="comment">/* Destroy the audiohook as it is no longer in use */</span>
<a name="l00834"></a>00834    <a class="code" href="audiohook_8h.html#a9fa661730d6fa6b9b12e410d66a3437b" title="Destroys an audiohook structure.">ast_audiohook_destroy</a>(&amp;audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#aaf5379c0defdcacdae37add0d0c8af1d">audiohook</a>);
<a name="l00835"></a>00835 
<a name="l00836"></a>00836    <span class="comment">/* Finally free ourselves, we are of no more use */</span>
<a name="l00837"></a>00837    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(audiohook_volume);
<a name="l00838"></a>00838 
<a name="l00839"></a>00839    <span class="keywordflow">return</span>;
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 <span class="comment"></span>
<a name="l00842"></a>00842 <span class="comment">/*! \brief Datastore used to store audiohook volume information */</span>
<a name="l00843"></a><a class="code" href="audiohook_8c.html#a954060bd5c9d100e9e5afb1acc044237">00843</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__datastore__info.html" title="Structure for a data store type.">ast_datastore_info</a> <a class="code" href="audiohook_8c.html#a954060bd5c9d100e9e5afb1acc044237" title="Datastore used to store audiohook volume information.">audiohook_volume_datastore</a> = {
<a name="l00844"></a>00844    .<a class="code" href="structast__datastore__info.html#a763fd8db6bba8fbbbc113ca0d61c47c2">type</a> = <span class="stringliteral">&quot;Volume&quot;</span>,
<a name="l00845"></a>00845    .destroy = <a class="code" href="audiohook_8c.html#af83018dd9d2d3bee8129613c4d671d48" title="Callback used to destroy the audiohook volume datastore.">audiohook_volume_destroy</a>,
<a name="l00846"></a>00846 };
<a name="l00847"></a>00847 <span class="comment"></span>
<a name="l00848"></a>00848 <span class="comment">/*! \brief Helper function which actually gets called by audiohooks to perform the adjustment</span>
<a name="l00849"></a>00849 <span class="comment"> * \param audiohook Audiohook attached to the channel</span>
<a name="l00850"></a>00850 <span class="comment"> * \param chan Channel we are attached to</span>
<a name="l00851"></a>00851 <span class="comment"> * \param frame Frame of audio we want to manipulate</span>
<a name="l00852"></a>00852 <span class="comment"> * \param direction Direction the audio came in from</span>
<a name="l00853"></a>00853 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00854"></a>00854 <span class="comment"> */</span>
<a name="l00855"></a><a class="code" href="audiohook_8c.html#a02837b2b05c81c63eaccc31450953712">00855</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="audiohook_8c.html#a02837b2b05c81c63eaccc31450953712" title="Helper function which actually gets called by audiohooks to perform the adjustment...">audiohook_volume_callback</a>(<span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *frame, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction)
<a name="l00856"></a>00856 {
<a name="l00857"></a>00857    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore = NULL;
<a name="l00858"></a>00858    <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> = NULL;
<a name="l00859"></a>00859    <span class="keywordtype">int</span> *gain = NULL;
<a name="l00860"></a>00860 
<a name="l00861"></a>00861    <span class="comment">/* If the audiohook is shutting down don&apos;t even bother */</span>
<a name="l00862"></a>00862    <span class="keywordflow">if</span> (audiohook-&gt;<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55ada82b3db86f4b5d34ca212dfb6fec2db14">AST_AUDIOHOOK_STATUS_DONE</a>) {
<a name="l00863"></a>00863       <span class="keywordflow">return</span> 0;
<a name="l00864"></a>00864    }
<a name="l00865"></a>00865 
<a name="l00866"></a>00866    <span class="comment">/* Try to find the datastore containg adjustment information, if we can&apos;t just bail out */</span>
<a name="l00867"></a>00867    <span class="keywordflow">if</span> (!(datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;audiohook_volume_datastore, NULL))) {
<a name="l00868"></a>00868       <span class="keywordflow">return</span> 0;
<a name="l00869"></a>00869    }
<a name="l00870"></a>00870 
<a name="l00871"></a>00871    audiohook_volume = datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00872"></a>00872 
<a name="l00873"></a>00873    <span class="comment">/* Based on direction grab the appropriate adjustment value */</span>
<a name="l00874"></a>00874    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>) {
<a name="l00875"></a>00875       gain = &amp;audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#a0a766b2643ed747312a40990b7792a07">read_adjustment</a>;
<a name="l00876"></a>00876    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>) {
<a name="l00877"></a>00877       gain = &amp;audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#ac97a76d6712af0af6937fe394d4c8432">write_adjustment</a>;
<a name="l00878"></a>00878    }
<a name="l00879"></a>00879 
<a name="l00880"></a>00880    <span class="comment">/* If an adjustment value is present modify the frame */</span>
<a name="l00881"></a>00881    <span class="keywordflow">if</span> (gain &amp;&amp; *gain) {
<a name="l00882"></a>00882       <a class="code" href="frame_8h.html#a59b72ee1caa9e8349ca017df01e8ac55" title="Adjusts the volume of the audio samples contained in a frame.">ast_frame_adjust_volume</a>(frame, *gain);
<a name="l00883"></a>00883    }
<a name="l00884"></a>00884 
<a name="l00885"></a>00885    <span class="keywordflow">return</span> 0;
<a name="l00886"></a>00886 }
<a name="l00887"></a>00887 <span class="comment"></span>
<a name="l00888"></a>00888 <span class="comment">/*! \brief Helper function which finds and optionally creates an audiohook_volume_datastore datastore on a channel</span>
<a name="l00889"></a>00889 <span class="comment"> * \param chan Channel to look on</span>
<a name="l00890"></a>00890 <span class="comment"> * \param create Whether to create the datastore if not found</span>
<a name="l00891"></a>00891 <span class="comment"> * \return Returns audiohook_volume structure on success, NULL on failure</span>
<a name="l00892"></a>00892 <span class="comment"> */</span>
<a name="l00893"></a><a class="code" href="audiohook_8c.html#afe3e6285c5a976be492b202f870f6845">00893</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="audiohook_8c.html#afe3e6285c5a976be492b202f870f6845" title="Helper function which finds and optionally creates an audiohook_volume_datastore...">audiohook_volume_get</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> create)
<a name="l00894"></a>00894 {
<a name="l00895"></a>00895    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore = NULL;
<a name="l00896"></a>00896    <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> = NULL;
<a name="l00897"></a>00897 
<a name="l00898"></a>00898    <span class="comment">/* If we are able to find the datastore return the contents (which is actually an audiohook_volume structure) */</span>
<a name="l00899"></a>00899    <span class="keywordflow">if</span> ((datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;audiohook_volume_datastore, NULL))) {
<a name="l00900"></a>00900       <span class="keywordflow">return</span> datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00901"></a>00901    }
<a name="l00902"></a>00902 
<a name="l00903"></a>00903    <span class="comment">/* If we are not allowed to create a datastore or if we fail to create a datastore, bail out now as we have nothing for them */</span>
<a name="l00904"></a>00904    <span class="keywordflow">if</span> (!create || !(datastore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;audiohook_volume_datastore, NULL))) {
<a name="l00905"></a>00905       <span class="keywordflow">return</span> NULL;
<a name="l00906"></a>00906    }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908    <span class="comment">/* Create a new audiohook_volume structure to contain our adjustments and audiohook */</span>
<a name="l00909"></a>00909    <span class="keywordflow">if</span> (!(audiohook_volume = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*audiohook_volume)))) {
<a name="l00910"></a>00910       <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(datastore);
<a name="l00911"></a>00911       <span class="keywordflow">return</span> NULL;
<a name="l00912"></a>00912    }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914    <span class="comment">/* Setup our audiohook structure so we can manipulate the audio */</span>
<a name="l00915"></a>00915    <a class="code" href="audiohook_8h.html#a94bd83e9f3444f406174971481b862c2" title="Initialize an audiohook structure.">ast_audiohook_init</a>(&amp;audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#aaf5379c0defdcacdae37add0d0c8af1d">audiohook</a>, <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a20dda44508f42e63dc8ed45760affe08">AST_AUDIOHOOK_TYPE_MANIPULATE</a>, <span class="stringliteral">&quot;Volume&quot;</span>);
<a name="l00916"></a>00916    audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#aaf5379c0defdcacdae37add0d0c8af1d">audiohook</a>.<a class="code" href="structast__audiohook.html#a4592709f9cf7b13798a0afcafbd96893">manipulate_callback</a> = <a class="code" href="audiohook_8c.html#a02837b2b05c81c63eaccc31450953712" title="Helper function which actually gets called by audiohooks to perform the adjustment...">audiohook_volume_callback</a>;
<a name="l00917"></a>00917 
<a name="l00918"></a>00918    <span class="comment">/* Attach the audiohook_volume blob to the datastore and attach to the channel */</span>
<a name="l00919"></a>00919    datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = audiohook_volume;
<a name="l00920"></a>00920    <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, datastore);
<a name="l00921"></a>00921 
<a name="l00922"></a>00922    <span class="comment">/* All is well... put the audiohook into motion */</span>
<a name="l00923"></a>00923    <a class="code" href="audiohook_8h.html#a94abfad20db137f9d6a33f641d37ac31" title="Attach audiohook to channel.">ast_audiohook_attach</a>(chan, &amp;audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#aaf5379c0defdcacdae37add0d0c8af1d">audiohook</a>);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925    <span class="keywordflow">return</span> audiohook_volume;
<a name="l00926"></a>00926 }
<a name="l00927"></a>00927 <span class="comment"></span>
<a name="l00928"></a>00928 <span class="comment">/*! \brief Adjust the volume on frames read from or written to a channel</span>
<a name="l00929"></a>00929 <span class="comment"> * \param chan Channel to muck with</span>
<a name="l00930"></a>00930 <span class="comment"> * \param direction Direction to set on</span>
<a name="l00931"></a>00931 <span class="comment"> * \param volume Value to adjust the volume by</span>
<a name="l00932"></a>00932 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00933"></a>00933 <span class="comment"> */</span>
<a name="l00934"></a><a class="code" href="audiohook_8c.html#ae042519f3d210ea48604952be74044a2">00934</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#ae042519f3d210ea48604952be74044a2" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_set</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keywordtype">int</span> <a class="code" href="structvolume.html">volume</a>)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936    <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> = NULL;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938    <span class="comment">/* Attempt to find the audiohook volume information, but only create it if we are not setting the adjustment value to zero */</span>
<a name="l00939"></a>00939    <span class="keywordflow">if</span> (!(audiohook_volume = <a class="code" href="audiohook_8c.html#afe3e6285c5a976be492b202f870f6845" title="Helper function which finds and optionally creates an audiohook_volume_datastore...">audiohook_volume_get</a>(chan, (volume ? 1 : 0)))) {
<a name="l00940"></a>00940       <span class="keywordflow">return</span> -1;
<a name="l00941"></a>00941    }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943    <span class="comment">/* Now based on the direction set the proper value */</span>
<a name="l00944"></a>00944    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> || direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899af84e1c36b65319be79e79b03c8f4a360">AST_AUDIOHOOK_DIRECTION_BOTH</a>) {
<a name="l00945"></a>00945       audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#a0a766b2643ed747312a40990b7792a07">read_adjustment</a> = volume;
<a name="l00946"></a>00946    }
<a name="l00947"></a>00947    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a> || direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899af84e1c36b65319be79e79b03c8f4a360">AST_AUDIOHOOK_DIRECTION_BOTH</a>) {
<a name="l00948"></a>00948       audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#ac97a76d6712af0af6937fe394d4c8432">write_adjustment</a> = volume;
<a name="l00949"></a>00949    }
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="keywordflow">return</span> 0;
<a name="l00952"></a>00952 }
<a name="l00953"></a>00953 <span class="comment"></span>
<a name="l00954"></a>00954 <span class="comment">/*! \brief Retrieve the volume adjustment value on frames read from or written to a channel</span>
<a name="l00955"></a>00955 <span class="comment"> * \param chan Channel to retrieve volume adjustment from</span>
<a name="l00956"></a>00956 <span class="comment"> * \param direction Direction to retrieve</span>
<a name="l00957"></a>00957 <span class="comment"> * \return Returns adjustment value</span>
<a name="l00958"></a>00958 <span class="comment"> */</span>
<a name="l00959"></a><a class="code" href="audiohook_8c.html#a39f5dbdf5ef7a979d4ba48f9ee71a422">00959</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#a39f5dbdf5ef7a979d4ba48f9ee71a422" title="Retrieve the volume adjustment value on frames read from or written to a channel...">ast_audiohook_volume_get</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction)
<a name="l00960"></a>00960 {
<a name="l00961"></a>00961    <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> = NULL;
<a name="l00962"></a>00962    <span class="keywordtype">int</span> adjustment = 0;
<a name="l00963"></a>00963 
<a name="l00964"></a>00964    <span class="comment">/* Attempt to find the audiohook volume information, but do not create it as we only want to look at the values */</span>
<a name="l00965"></a>00965    <span class="keywordflow">if</span> (!(audiohook_volume = <a class="code" href="audiohook_8c.html#afe3e6285c5a976be492b202f870f6845" title="Helper function which finds and optionally creates an audiohook_volume_datastore...">audiohook_volume_get</a>(chan, 0))) {
<a name="l00966"></a>00966       <span class="keywordflow">return</span> 0;
<a name="l00967"></a>00967    }
<a name="l00968"></a>00968 
<a name="l00969"></a>00969    <span class="comment">/* Grab the adjustment value based on direction given */</span>
<a name="l00970"></a>00970    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>) {
<a name="l00971"></a>00971       adjustment = audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#a0a766b2643ed747312a40990b7792a07">read_adjustment</a>;
<a name="l00972"></a>00972    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>) {
<a name="l00973"></a>00973       adjustment = audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#ac97a76d6712af0af6937fe394d4c8432">write_adjustment</a>;
<a name="l00974"></a>00974    }
<a name="l00975"></a>00975 
<a name="l00976"></a>00976    <span class="keywordflow">return</span> adjustment;
<a name="l00977"></a>00977 }
<a name="l00978"></a>00978 <span class="comment"></span>
<a name="l00979"></a>00979 <span class="comment">/*! \brief Adjust the volume on frames read from or written to a channel</span>
<a name="l00980"></a>00980 <span class="comment"> * \param chan Channel to muck with</span>
<a name="l00981"></a>00981 <span class="comment"> * \param direction Direction to increase</span>
<a name="l00982"></a>00982 <span class="comment"> * \param volume Value to adjust the adjustment by</span>
<a name="l00983"></a>00983 <span class="comment"> * \return Returns 0 on success, -1 on failure</span>
<a name="l00984"></a>00984 <span class="comment"> */</span>
<a name="l00985"></a><a class="code" href="audiohook_8c.html#acf8f4fc0dfd6a5f54e301ac66c5bc434">00985</a> <span class="keywordtype">int</span> <a class="code" href="audiohook_8h.html#acf8f4fc0dfd6a5f54e301ac66c5bc434" title="Adjust the volume on frames read from or written to a channel.">ast_audiohook_volume_adjust</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">enum</span> <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899">ast_audiohook_direction</a> direction, <span class="keywordtype">int</span> <a class="code" href="structvolume.html">volume</a>)
<a name="l00986"></a>00986 {
<a name="l00987"></a>00987    <span class="keyword">struct </span><a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> *<a class="code" href="structaudiohook__volume.html" title="Audiohook volume adjustment structure.">audiohook_volume</a> = NULL;
<a name="l00988"></a>00988 
<a name="l00989"></a>00989    <span class="comment">/* Attempt to find the audiohook volume information, and create an audiohook if none exists */</span>
<a name="l00990"></a>00990    <span class="keywordflow">if</span> (!(audiohook_volume = <a class="code" href="audiohook_8c.html#afe3e6285c5a976be492b202f870f6845" title="Helper function which finds and optionally creates an audiohook_volume_datastore...">audiohook_volume_get</a>(chan, 1))) {
<a name="l00991"></a>00991       <span class="keywordflow">return</span> -1;
<a name="l00992"></a>00992    }
<a name="l00993"></a>00993 
<a name="l00994"></a>00994    <span class="comment">/* Based on the direction change the specific adjustment value */</span>
<a name="l00995"></a>00995    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a> || direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899af84e1c36b65319be79e79b03c8f4a360">AST_AUDIOHOOK_DIRECTION_BOTH</a>) {
<a name="l00996"></a>00996       audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#a0a766b2643ed747312a40990b7792a07">read_adjustment</a> += volume;
<a name="l00997"></a>00997    }
<a name="l00998"></a>00998    <span class="keywordflow">if</span> (direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a> || direction == <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899af84e1c36b65319be79e79b03c8f4a360">AST_AUDIOHOOK_DIRECTION_BOTH</a>) {
<a name="l00999"></a>00999       audiohook_volume-&gt;<a class="code" href="structaudiohook__volume.html#ac97a76d6712af0af6937fe394d4c8432">write_adjustment</a> += volume;
<a name="l01000"></a>01000    }
<a name="l01001"></a>01001 
<a name="l01002"></a>01002    <span class="keywordflow">return</span> 0;
<a name="l01003"></a>01003 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:29 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
