<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:46 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_jabber.c</h1><a href="res__jabber_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Matt O&apos;Gorman &lt;mogorman@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> * \brief A resource for interfacing Asterisk directly as a client</span>
<a name="l00021"></a>00021 <span class="comment"> * or a component to a XMPP/Jabber compliant server.</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * References:</span>
<a name="l00024"></a>00024 <span class="comment"> * - http://www.xmpp.org - The XMPP standards foundation</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * \extref Iksemel http://code.google.com/p/iksemel/</span>
<a name="l00027"></a>00027 <span class="comment"> *</span>
<a name="l00028"></a>00028 <span class="comment"> * \todo If you unload this module, chan_gtalk/jingle will be dead. How do we handle that?</span>
<a name="l00029"></a>00029 <span class="comment"> * \todo Dialplan applications need RETURN variable, like JABBERSENDSTATUS</span>
<a name="l00030"></a>00030 <span class="comment"> *</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="comment">/*** MODULEINFO</span>
<a name="l00034"></a>00034 <span class="comment">   &lt;depend&gt;iksemel&lt;/depend&gt;</span>
<a name="l00035"></a>00035 <span class="comment">   &lt;use&gt;openssl&lt;/use&gt;</span>
<a name="l00036"></a>00036 <span class="comment"> ***/</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 209234 $&quot;</span>)
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00043"></a>00043 <span class="preprocessor"></span><span class="preprocessor">#include &lt;iksemel.h&gt;</span>
<a name="l00044"></a>00044 
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="jabber_8h.html" title="AJI - The Asterisk Jabber Interface.">asterisk/jabber.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="md5_8h.html" title="MD5 digest functions.">asterisk/md5.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="acl_8h.html" title="Access Control of various sorts.">asterisk/acl.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="astobj_8h.html" title="A set of macros implementing objects and containers. Macros are used for maximum...">asterisk/astobj.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="astdb_8h.html" title="Persistant data storage (akin to *doze registry).">asterisk/astdb.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00061"></a>00061 
<a name="l00062"></a>00062 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00063"></a>00063 <span class="comment">   &lt;application name=&quot;JabberSend&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00064"></a>00064 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00065"></a>00065 <span class="comment">         Send a Jabber Message</span>
<a name="l00066"></a>00066 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00067"></a>00067 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00068"></a>00068 <span class="comment">         &lt;parameter name=&quot;Jabber&quot; required=&quot;true&quot;&gt;</span>
<a name="l00069"></a>00069 <span class="comment">            &lt;para&gt;Client or transport Asterisk uses to connect to Jabber.&lt;/para&gt;</span>
<a name="l00070"></a>00070 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00071"></a>00071 <span class="comment">         &lt;parameter name=&quot;JID&quot; required=&quot;true&quot;&gt;</span>
<a name="l00072"></a>00072 <span class="comment">            &lt;para&gt;XMPP/Jabber JID (Name) of recipient.&lt;/para&gt;</span>
<a name="l00073"></a>00073 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00074"></a>00074 <span class="comment">         &lt;parameter name=&quot;Message&quot; required=&quot;true&quot;&gt;</span>
<a name="l00075"></a>00075 <span class="comment">            &lt;para&gt;Message to be sent to the buddy.&lt;/para&gt;</span>
<a name="l00076"></a>00076 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00077"></a>00077 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00078"></a>00078 <span class="comment">      &lt;description&gt;</span>
<a name="l00079"></a>00079 <span class="comment">         &lt;para&gt;Allows user to send a message to a receipent via XMPP.&lt;/para&gt;</span>
<a name="l00080"></a>00080 <span class="comment">      &lt;/description&gt;</span>
<a name="l00081"></a>00081 <span class="comment">   &lt;/application&gt;</span>
<a name="l00082"></a>00082 <span class="comment">   &lt;application name=&quot;JabberStatus&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00083"></a>00083 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00084"></a>00084 <span class="comment">         Retrieve the status of a jabber list member</span>
<a name="l00085"></a>00085 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00086"></a>00086 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00087"></a>00087 <span class="comment">         &lt;parameter name=&quot;Jabber&quot; required=&quot;true&quot;&gt;</span>
<a name="l00088"></a>00088 <span class="comment">            &lt;para&gt;Client or transport Asterisk users to connect to Jabber.&lt;/para&gt;</span>
<a name="l00089"></a>00089 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00090"></a>00090 <span class="comment">         &lt;parameter name=&quot;JID&quot; required=&quot;true&quot;&gt;</span>
<a name="l00091"></a>00091 <span class="comment">            &lt;para&gt;XMPP/Jabber JID (Name) of recipient.&lt;/para&gt;</span>
<a name="l00092"></a>00092 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00093"></a>00093 <span class="comment">         &lt;parameter name=&quot;Variable&quot; required=&quot;true&quot;&gt;</span>
<a name="l00094"></a>00094 <span class="comment">            &lt;para&gt;Variable to store the status of requested user.&lt;/para&gt;</span>
<a name="l00095"></a>00095 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00096"></a>00096 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00097"></a>00097 <span class="comment">      &lt;description&gt;</span>
<a name="l00098"></a>00098 <span class="comment">         &lt;para&gt;This application is deprecated. Please use the JABBER_STATUS() function instead.&lt;/para&gt;</span>
<a name="l00099"></a>00099 <span class="comment">         &lt;para&gt;Retrieves the numeric status associated with the specified buddy &lt;replaceable&gt;JID&lt;/replaceable&gt;.</span>
<a name="l00100"></a>00100 <span class="comment">         The return value in the &lt;replaceable&gt;Variable&lt;/replaceable&gt;will be one of the following.&lt;/para&gt;</span>
<a name="l00101"></a>00101 <span class="comment">         &lt;enumlist&gt;</span>
<a name="l00102"></a>00102 <span class="comment">            &lt;enum name=&quot;1&quot;&gt;</span>
<a name="l00103"></a>00103 <span class="comment">               &lt;para&gt;Online.&lt;/para&gt;</span>
<a name="l00104"></a>00104 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00105"></a>00105 <span class="comment">            &lt;enum name=&quot;2&quot;&gt;</span>
<a name="l00106"></a>00106 <span class="comment">               &lt;para&gt;Chatty.&lt;/para&gt;</span>
<a name="l00107"></a>00107 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00108"></a>00108 <span class="comment">            &lt;enum name=&quot;3&quot;&gt;</span>
<a name="l00109"></a>00109 <span class="comment">               &lt;para&gt;Away.&lt;/para&gt;</span>
<a name="l00110"></a>00110 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00111"></a>00111 <span class="comment">            &lt;enum name=&quot;4&quot;&gt;</span>
<a name="l00112"></a>00112 <span class="comment">               &lt;para&gt;Extended Away.&lt;/para&gt;</span>
<a name="l00113"></a>00113 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00114"></a>00114 <span class="comment">            &lt;enum name=&quot;5&quot;&gt;</span>
<a name="l00115"></a>00115 <span class="comment">               &lt;para&gt;Do Not Disturb.&lt;/para&gt;</span>
<a name="l00116"></a>00116 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00117"></a>00117 <span class="comment">            &lt;enum name=&quot;6&quot;&gt;</span>
<a name="l00118"></a>00118 <span class="comment">               &lt;para&gt;Offline.&lt;/para&gt;</span>
<a name="l00119"></a>00119 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00120"></a>00120 <span class="comment">            &lt;enum name=&quot;7&quot;&gt;</span>
<a name="l00121"></a>00121 <span class="comment">               &lt;para&gt;Not In Roster.&lt;/para&gt;</span>
<a name="l00122"></a>00122 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00123"></a>00123 <span class="comment">         &lt;/enumlist&gt;</span>
<a name="l00124"></a>00124 <span class="comment">      &lt;/description&gt;</span>
<a name="l00125"></a>00125 <span class="comment">   &lt;/application&gt;</span>
<a name="l00126"></a>00126 <span class="comment">   &lt;function name=&quot;JABBER_STATUS&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00127"></a>00127 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00128"></a>00128 <span class="comment">         Retrieve the status of a jabber list member</span>
<a name="l00129"></a>00129 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00130"></a>00130 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00131"></a>00131 <span class="comment">         &lt;parameter name=&quot;sender&quot; required=&quot;true&quot;&gt;</span>
<a name="l00132"></a>00132 <span class="comment">            &lt;para&gt;XMPP/Jabber ID (Name) of sender.&lt;/para&gt;</span>
<a name="l00133"></a>00133 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00134"></a>00134 <span class="comment">         &lt;parameter name=&quot;buddy&quot; required=&quot;true&quot;&gt;</span>
<a name="l00135"></a>00135 <span class="comment">            &lt;para&gt;XMPP/Jabber JID (Name) of recipient.&lt;/para&gt;</span>
<a name="l00136"></a>00136 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00137"></a>00137 <span class="comment">         &lt;parameter name=&quot;resource&quot;&gt;</span>
<a name="l00138"></a>00138 <span class="comment">            &lt;para&gt;Client or transport Asterisk users to connect to Jabber.&lt;/para&gt;</span>
<a name="l00139"></a>00139 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00140"></a>00140 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00141"></a>00141 <span class="comment">      &lt;description&gt;</span>
<a name="l00142"></a>00142 <span class="comment">         &lt;para&gt;Retrieves the numeric status associated with the specified buddy &lt;replaceable&gt;JID&lt;/replaceable&gt;.</span>
<a name="l00143"></a>00143 <span class="comment">         The return value will be one of the following.&lt;/para&gt;</span>
<a name="l00144"></a>00144 <span class="comment">         &lt;enumlist&gt;</span>
<a name="l00145"></a>00145 <span class="comment">            &lt;enum name=&quot;1&quot;&gt;</span>
<a name="l00146"></a>00146 <span class="comment">               &lt;para&gt;Online.&lt;/para&gt;</span>
<a name="l00147"></a>00147 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00148"></a>00148 <span class="comment">            &lt;enum name=&quot;2&quot;&gt;</span>
<a name="l00149"></a>00149 <span class="comment">               &lt;para&gt;Chatty.&lt;/para&gt;</span>
<a name="l00150"></a>00150 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00151"></a>00151 <span class="comment">            &lt;enum name=&quot;3&quot;&gt;</span>
<a name="l00152"></a>00152 <span class="comment">               &lt;para&gt;Away.&lt;/para&gt;</span>
<a name="l00153"></a>00153 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00154"></a>00154 <span class="comment">            &lt;enum name=&quot;4&quot;&gt;</span>
<a name="l00155"></a>00155 <span class="comment">               &lt;para&gt;Extended Away.&lt;/para&gt;</span>
<a name="l00156"></a>00156 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00157"></a>00157 <span class="comment">            &lt;enum name=&quot;5&quot;&gt;</span>
<a name="l00158"></a>00158 <span class="comment">               &lt;para&gt;Do Not Disturb.&lt;/para&gt;</span>
<a name="l00159"></a>00159 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00160"></a>00160 <span class="comment">            &lt;enum name=&quot;6&quot;&gt;</span>
<a name="l00161"></a>00161 <span class="comment">               &lt;para&gt;Offline.&lt;/para&gt;</span>
<a name="l00162"></a>00162 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00163"></a>00163 <span class="comment">            &lt;enum name=&quot;7&quot;&gt;</span>
<a name="l00164"></a>00164 <span class="comment">               &lt;para&gt;Not In Roster.&lt;/para&gt;</span>
<a name="l00165"></a>00165 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00166"></a>00166 <span class="comment">         &lt;/enumlist&gt;</span>
<a name="l00167"></a>00167 <span class="comment">      &lt;/description&gt;</span>
<a name="l00168"></a>00168 <span class="comment">   &lt;/function&gt;</span>
<a name="l00169"></a>00169 <span class="comment"> ***/</span>
<a name="l00170"></a>00170 <span class="comment"></span>
<a name="l00171"></a>00171 <span class="comment">/*! \todo This should really be renamed to xmpp.conf. For backwards compatibility, we</span>
<a name="l00172"></a>00172 <span class="comment">   need to read both files */</span>
<a name="l00173"></a><a class="code" href="res__jabber_8c.html#ae61bb5ae111d446dd928959847812526">00173</a> <span class="preprocessor">#define JABBER_CONFIG &quot;jabber.conf&quot;</span>
<a name="l00174"></a>00174 <span class="preprocessor"></span>
<a name="l00175"></a>00175 <span class="preprocessor">#ifndef FALSE</span>
<a name="l00176"></a>00176 <span class="preprocessor"></span><span class="preprocessor">#define FALSE 0</span>
<a name="l00177"></a>00177 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00178"></a>00178 <span class="preprocessor"></span>
<a name="l00179"></a>00179 <span class="preprocessor">#ifndef TRUE</span>
<a name="l00180"></a>00180 <span class="preprocessor"></span><span class="preprocessor">#define TRUE 1</span>
<a name="l00181"></a>00181 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00182"></a>00182 <span class="preprocessor"></span>
<a name="l00183"></a>00183 <span class="comment">/*-- Forward declarations */</span>
<a name="l00184"></a>00184 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structaji__buddy.html">aji_buddy</a> *obj);
<a name="l00185"></a>00185 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *obj);
<a name="l00186"></a>00186 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a26515ff8bd0588f1181bb6a3abc56f90" title="Dial plan function to send a message.">aji_send_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data);
<a name="l00187"></a>00187 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#af34ff341cd5689c2c1355daf38e38682" title="Dial plan function status(). puts the status of watched user into a channel variable...">aji_status_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data);
<a name="l00188"></a>00188 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00189"></a>00189 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00190"></a>00190 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad7bb4a25ad47122d109b34c3e8552f96" title="Starts the TLS procedure.">aji_start_tls</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00191"></a>00191 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a626fb8236724be309a0d3ee3a2e979ed" title="TLS handshake, OpenSSL initialization.">aji_tls_handshake</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00192"></a>00192 <span class="preprocessor">#endif</span>
<a name="l00193"></a>00193 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a7487004afc39b2fbdd92ab9faaff8231" title="Secured or unsecured IO socket receiving function.">aji_io_recv</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> buf_len, <span class="keywordtype">int</span> timeout);
<a name="l00194"></a>00194 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741" title="Tries to receive data from the Jabber server.">aji_recv</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">int</span> timeout);
<a name="l00195"></a>00195 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c" title="Sends XMPP header to the server.">aji_send_header</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *to);
<a name="l00196"></a>00196 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *xmlstr);
<a name="l00197"></a>00197 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>(<span class="keywordtype">void</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *xmpp, <span class="keywordtype">size_t</span> size, <span class="keywordtype">int</span> is_incoming);
<a name="l00198"></a>00198 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1b15523e274d7f26568ef5521a73e7ce" title="A wrapper function for iks_start_sasl.">aji_start_sasl</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">enum</span> ikssasltype <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">char</span> *username, <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>);
<a name="l00199"></a>00199 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad0e9114c8ba0981e4a4f3f7d93f5ef3c" title="The action hook parses the inbound packets, constantly running.">aji_act_hook</a>(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, iks *node);
<a name="l00200"></a>00200 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#ab9777927f36394dc186f89a30b222135" title="Handles.">aji_handle_iq</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, iks *node);
<a name="l00201"></a>00201 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a7a01af36e4db2dfe018982d63fda2fb2" title="Handles presence packets.">aji_handle_message</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, ikspak *pak);
<a name="l00202"></a>00202 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a163e096310bad60196f9b09b4d5169af" title="Check the presence info.">aji_handle_presence</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, ikspak *pak);
<a name="l00203"></a>00203 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#ae9cccc06634afa62ab69827e3a07efb2" title="handles subscription requests.">aji_handle_subscribe</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, ikspak *pak);
<a name="l00204"></a>00204 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__jabber_8c.html#a29f749367c5d39d4eb02841f70a07006" title="receive message loop.">aji_recv_loop</a>(<span class="keywordtype">void</span> *data);
<a name="l00205"></a>00205 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a34f1590817ad7108962f22772caa9bb1" title="prepares client for connect.">aji_initialize</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00206"></a>00206 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00207"></a>00207 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *to, <span class="keywordtype">char</span> *from, <span class="keywordtype">int</span> level, <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>);
<a name="l00208"></a>00208 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#af61d5277d284f24cf7e83867342ed724" title="Turn on/off console debugging.">aji_do_set_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00209"></a>00209 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#a0a89c3ed58b2a5083948fb2fa980eb88" title="Reload jabber module.">aji_do_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00210"></a>00210 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#ab098aeaf9f3ec6b05f4360ab16113afc" title="Show client status.">aji_show_clients</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00211"></a>00211 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#a3eedb3c8124c4a01ac80f62b7bab047f" title="Show buddy lists.">aji_show_buddies</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00212"></a>00212 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#af86ff7c316e29a5c6a914b4a9c2bc330" title="Send test message for debugging.">aji_test</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00213"></a>00213 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a6381553337670894fe004c0536752062" title="creates aji_client structure.">aji_create_client</a>(<span class="keywordtype">char</span> *label, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>);
<a name="l00214"></a>00214 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(<span class="keywordtype">char</span> *label, <span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00215"></a>00215 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(<span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>);
<a name="l00216"></a>00216 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ae5802ee540d5ced70ff5a0b32d20bb70">aji_load_config</a>(<span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>);
<a name="l00217"></a>00217 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a023bfb1346d00de355930f4224b94699" title="goes through roster and prunes users not needed in list, or adds them accordingly...">aji_pruneregister</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00218"></a>00218 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ab465ef5fd9bb14b30208091d039f1100" title="filters the roster packet we get back from server.">aji_filter_roster</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00219"></a>00219 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771" title="Get the roster of jabber users.">aji_get_roster</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00220"></a>00220 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1d851da5bdfbfdd92ab5a8e80229b5d3" title="Handle add extra info.">aji_client_info_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00221"></a>00221 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a08475a2aad43ee4b4dc1f10453547daf" title="Handler of the return info packet.">aji_dinfo_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00222"></a>00222 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1fa5630459ae90c51157f306d589a96c" title="Handles stuff.">aji_ditems_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00223"></a>00223 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a82642d571c9e2cc5476d1b25c99d51cc" title="register handler for incoming querys (IQ&amp;#39;s)">aji_register_query_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00224"></a>00224 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ae086e18b972394df16015895af3b0e84" title="Unknown.">aji_register_approve_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak);
<a name="l00225"></a>00225 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250" title="reconnect to jabber server">aji_reconnect</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client);
<a name="l00226"></a>00226 <span class="keyword">static</span> iks *<a class="code" href="res__jabber_8c.html#a09cc645b12759b721001a5245f64165a" title="Setup the authentication struct.">jabber_make_auth</a>(iksid * <span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *sid);
<a name="l00227"></a>00227 <span class="comment">/* No transports in this version */</span>
<a name="l00228"></a>00228 <span class="comment">/*</span>
<a name="l00229"></a>00229 <span class="comment">static int aji_create_transport(char *label, struct aji_client *client);</span>
<a name="l00230"></a>00230 <span class="comment">static int aji_register_transport(void *data, ikspak *pak);</span>
<a name="l00231"></a>00231 <span class="comment">static int aji_register_transport2(void *data, ikspak *pak);</span>
<a name="l00232"></a>00232 <span class="comment">*/</span>
<a name="l00233"></a>00233 
<a name="l00234"></a><a class="code" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">00234</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="res__jabber_8c.html#a40ba67b6a93d32c6cf9f58ec7ef0980c">aji_cli</a>[] = {
<a name="l00235"></a>00235    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__jabber_8c.html#af61d5277d284f24cf7e83867342ed724" title="Turn on/off console debugging.">aji_do_set_debug</a>, <span class="stringliteral">&quot;Enable/Disable Jabber debug&quot;</span>),
<a name="l00236"></a>00236    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__jabber_8c.html#a0a89c3ed58b2a5083948fb2fa980eb88" title="Reload jabber module.">aji_do_reload</a>, <span class="stringliteral">&quot;Reload Jabber configuration&quot;</span>),
<a name="l00237"></a>00237    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__jabber_8c.html#ab098aeaf9f3ec6b05f4360ab16113afc" title="Show client status.">aji_show_clients</a>, <span class="stringliteral">&quot;Show state of clients and components&quot;</span>),
<a name="l00238"></a>00238    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__jabber_8c.html#a3eedb3c8124c4a01ac80f62b7bab047f" title="Show buddy lists.">aji_show_buddies</a>, <span class="stringliteral">&quot;Show buddy lists of our clients&quot;</span>),
<a name="l00239"></a>00239    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__jabber_8c.html#af86ff7c316e29a5c6a914b4a9c2bc330" title="Send test message for debugging.">aji_test</a>, <span class="stringliteral">&quot;Shows roster, but is generally used for mog&apos;s debugging.&quot;</span>),
<a name="l00240"></a>00240 };
<a name="l00241"></a>00241 
<a name="l00242"></a><a class="code" href="res__jabber_8c.html#a8e769b687824e8e46d6977f708f0d061">00242</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#a8e769b687824e8e46d6977f708f0d061">app_ajisend</a> = <span class="stringliteral">&quot;JabberSend&quot;</span>;
<a name="l00243"></a>00243 
<a name="l00244"></a><a class="code" href="res__jabber_8c.html#aac8db588d5c711d05e12d78bb8a28dcb">00244</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#aac8db588d5c711d05e12d78bb8a28dcb">app_ajistatus</a> = <span class="stringliteral">&quot;JabberStatus&quot;</span>;
<a name="l00245"></a>00245 
<a name="l00246"></a><a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">00246</a> <span class="keyword">struct </span><a class="code" href="structaji__client__container.html">aji_client_container</a> <a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>;
<a name="l00247"></a><a class="code" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">00247</a> <span class="keyword">struct </span><a class="code" href="structaji__capabilities.html">aji_capabilities</a> *<a class="code" href="res__jabber_8c.html#aa7afd7ba4814dbf49b1867019891fd14">capabilities</a> = NULL;
<a name="l00248"></a>00248 <span class="comment"></span>
<a name="l00249"></a>00249 <span class="comment">/*! \brief Global flags, initialized to default values */</span>
<a name="l00250"></a><a class="code" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86">00250</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="res__jabber_8c.html#a3888fe259904a2eb18b173cbf56bfa86" title="Global flags, initialized to default values.">globalflags</a> = { <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a> };
<a name="l00251"></a>00251 <span class="comment"></span>
<a name="l00252"></a>00252 <span class="comment">/*!</span>
<a name="l00253"></a>00253 <span class="comment"> * \brief Deletes the aji_client data structure.</span>
<a name="l00254"></a>00254 <span class="comment"> * \param obj aji_client The structure we will delete.</span>
<a name="l00255"></a>00255 <span class="comment"> * \return void.</span>
<a name="l00256"></a>00256 <span class="comment"> */</span>
<a name="l00257"></a><a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207">00257</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *obj)
<a name="l00258"></a>00258 {
<a name="l00259"></a>00259    <span class="keyword">struct </span><a class="code" href="structaji__message.html">aji_message</a> *tmp;
<a name="l00260"></a>00260    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;obj-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l00261"></a>00261    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;obj-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>);
<a name="l00262"></a>00262    iks_filter_delete(obj-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>);
<a name="l00263"></a>00263    iks_parser_delete(obj-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l00264"></a>00264    iks_stack_delete(obj-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>);
<a name="l00265"></a>00265    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;obj-&gt;messages);
<a name="l00266"></a>00266    <span class="keywordflow">while</span> ((tmp = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;obj-&gt;messages, list))) {
<a name="l00267"></a>00267       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>)
<a name="l00268"></a>00268          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>);
<a name="l00269"></a>00269       <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>)
<a name="l00270"></a>00270          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);
<a name="l00271"></a>00271    }
<a name="l00272"></a>00272    <a class="code" href="linkedlists_8h.html#a47bafe663a14b91827082787d7654d7c" title="Destroys a list head structure.">AST_LIST_HEAD_DESTROY</a>(&amp;obj-&gt;messages);
<a name="l00273"></a>00273    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj);
<a name="l00274"></a>00274 }
<a name="l00275"></a>00275 <span class="comment"></span>
<a name="l00276"></a>00276 <span class="comment">/*!</span>
<a name="l00277"></a>00277 <span class="comment"> * \brief Deletes the aji_buddy data structure.</span>
<a name="l00278"></a>00278 <span class="comment"> * \param obj aji_buddy The structure we will delete.</span>
<a name="l00279"></a>00279 <span class="comment"> * \return void.</span>
<a name="l00280"></a>00280 <span class="comment"> */</span>
<a name="l00281"></a><a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561">00281</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structaji__buddy.html">aji_buddy</a> *obj)
<a name="l00282"></a>00282 {
<a name="l00283"></a>00283    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *tmp;
<a name="l00284"></a>00284 
<a name="l00285"></a>00285    <span class="keywordflow">while</span> ((tmp = obj-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>)) {
<a name="l00286"></a>00286       obj-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = obj-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l00287"></a>00287       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>);
<a name="l00288"></a>00288       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l00289"></a>00289    }
<a name="l00290"></a>00290 
<a name="l00291"></a>00291    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(obj);
<a name="l00292"></a>00292 }
<a name="l00293"></a>00293 <span class="comment"></span>
<a name="l00294"></a>00294 <span class="comment">/*!</span>
<a name="l00295"></a>00295 <span class="comment"> * \brief Find version in XML stream and populate our capabilities list</span>
<a name="l00296"></a>00296 <span class="comment"> * \param node the node attribute in the caps element we&apos;ll look for or add to </span>
<a name="l00297"></a>00297 <span class="comment"> * our list</span>
<a name="l00298"></a>00298 <span class="comment"> * \param version the version attribute in the caps element we&apos;ll look for or </span>
<a name="l00299"></a>00299 <span class="comment"> * add to our list</span>
<a name="l00300"></a>00300 <span class="comment"> * \param pak struct The XML stanza we&apos;re processing</span>
<a name="l00301"></a>00301 <span class="comment"> * \return a pointer to the added or found aji_version structure</span>
<a name="l00302"></a>00302 <span class="comment"> */</span> 
<a name="l00303"></a><a class="code" href="res__jabber_8c.html#a26b7d6d55f963dbca6e3694d053273d5">00303</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaji__version.html">aji_version</a> *<a class="code" href="res__jabber_8c.html#a26b7d6d55f963dbca6e3694d053273d5" title="Find version in XML stream and populate our capabilities list.">aji_find_version</a>(<span class="keywordtype">char</span> *node, <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>, ikspak *pak)
<a name="l00304"></a>00304 {
<a name="l00305"></a>00305    <span class="keyword">struct </span><a class="code" href="structaji__capabilities.html">aji_capabilities</a> *list = NULL;
<a name="l00306"></a>00306    <span class="keyword">struct </span><a class="code" href="structaji__version.html">aji_version</a> *res = NULL;
<a name="l00307"></a>00307 
<a name="l00308"></a>00308    list = capabilities;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <span class="keywordflow">if</span>(!node)
<a name="l00311"></a>00311       node = pak-&gt;from-&gt;full;
<a name="l00312"></a>00312    <span class="keywordflow">if</span>(!version)
<a name="l00313"></a>00313       version = <span class="stringliteral">&quot;none supplied.&quot;</span>;
<a name="l00314"></a>00314    <span class="keywordflow">while</span>(list) {
<a name="l00315"></a>00315       <span class="keywordflow">if</span>(!strcasecmp(list-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>, node)) {
<a name="l00316"></a>00316          res = list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a>;
<a name="l00317"></a>00317          <span class="keywordflow">while</span>(res) {
<a name="l00318"></a>00318              <span class="keywordflow">if</span>(!strcasecmp(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>, version))
<a name="l00319"></a>00319                 <span class="keywordflow">return</span> res;
<a name="l00320"></a>00320              res = res-&gt;<a class="code" href="structaji__version.html#a44b6483c4f7906a4da3ef6381c5b24f7">next</a>;
<a name="l00321"></a>00321          }
<a name="l00322"></a>00322          <span class="comment">/* Specified version not found. Let&apos;s add it to </span>
<a name="l00323"></a>00323 <span class="comment">            this node in our capabilities list */</span>
<a name="l00324"></a>00324          <span class="keywordflow">if</span>(!res) {
<a name="l00325"></a>00325             res = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*res));
<a name="l00326"></a>00326             <span class="keywordflow">if</span>(!res) {
<a name="l00327"></a>00327                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l00328"></a>00328                <span class="keywordflow">return</span> NULL;
<a name="l00329"></a>00329             }
<a name="l00330"></a>00330             res-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l00331"></a>00331             res-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a> = list;
<a name="l00332"></a>00332             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>, version, <span class="keyword">sizeof</span>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>));
<a name="l00333"></a>00333             res-&gt;<a class="code" href="structaji__version.html#a44b6483c4f7906a4da3ef6381c5b24f7">next</a> = list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a>;
<a name="l00334"></a>00334             list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a> = res;
<a name="l00335"></a>00335             <span class="keywordflow">return</span> res;
<a name="l00336"></a>00336          }
<a name="l00337"></a>00337       }
<a name="l00338"></a>00338       list = list-&gt;<a class="code" href="structaji__capabilities.html#a121b3d8dfc41b0b80678fb8de4e4f109">next</a>;
<a name="l00339"></a>00339    }
<a name="l00340"></a>00340    <span class="comment">/* Specified node not found. Let&apos;s add it our capabilities list */</span>
<a name="l00341"></a>00341    <span class="keywordflow">if</span>(!list) {
<a name="l00342"></a>00342       list = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*list));
<a name="l00343"></a>00343       <span class="keywordflow">if</span>(!list) {
<a name="l00344"></a>00344          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l00345"></a>00345          <span class="keywordflow">return</span> NULL;
<a name="l00346"></a>00346       }
<a name="l00347"></a>00347       res = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*res));
<a name="l00348"></a>00348       <span class="keywordflow">if</span>(!res) {
<a name="l00349"></a>00349          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l00350"></a>00350          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(list);
<a name="l00351"></a>00351          <span class="keywordflow">return</span> NULL;
<a name="l00352"></a>00352       }
<a name="l00353"></a>00353       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(list-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>, node, <span class="keyword">sizeof</span>(list-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>));
<a name="l00354"></a>00354       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>, version, <span class="keyword">sizeof</span>(res-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>));
<a name="l00355"></a>00355       res-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l00356"></a>00356       res-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a> = list;
<a name="l00357"></a>00357       res-&gt;<a class="code" href="structaji__version.html#a44b6483c4f7906a4da3ef6381c5b24f7">next</a> = NULL;
<a name="l00358"></a>00358       list-&gt;<a class="code" href="structaji__capabilities.html#abfcf4ae8635bc0465422997f97b656c8">versions</a> = res;
<a name="l00359"></a>00359       list-&gt;<a class="code" href="structaji__capabilities.html#a121b3d8dfc41b0b80678fb8de4e4f109">next</a> = capabilities;
<a name="l00360"></a>00360       capabilities = list;
<a name="l00361"></a>00361    }
<a name="l00362"></a>00362    <span class="keywordflow">return</span> res;
<a name="l00363"></a>00363 }<span class="comment"></span>
<a name="l00364"></a>00364 <span class="comment">/*!</span>
<a name="l00365"></a>00365 <span class="comment"> * \brief Find the aji_resource we want</span>
<a name="l00366"></a>00366 <span class="comment"> * \param buddy aji_buddy A buddy</span>
<a name="l00367"></a>00367 <span class="comment"> * \param name </span>
<a name="l00368"></a>00368 <span class="comment"> * \return aji_resource object</span>
<a name="l00369"></a>00369 <span class="comment">*/</span>
<a name="l00370"></a><a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67">00370</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(<span class="keyword">struct</span> <a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy, <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l00371"></a>00371 {
<a name="l00372"></a>00372    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *res = NULL;
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (!buddy || !name)
<a name="l00374"></a>00374       <span class="keywordflow">return</span> res;
<a name="l00375"></a>00375    res = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00376"></a>00376    <span class="keywordflow">while</span> (res) {
<a name="l00377"></a>00377       <span class="keywordflow">if</span> (!strcasecmp(res-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>, name)) {
<a name="l00378"></a>00378          <span class="keywordflow">break</span>;
<a name="l00379"></a>00379       }
<a name="l00380"></a>00380       res = res-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l00381"></a>00381    }
<a name="l00382"></a>00382    <span class="keywordflow">return</span> res;
<a name="l00383"></a>00383 }
<a name="l00384"></a>00384 <span class="comment"></span>
<a name="l00385"></a>00385 <span class="comment">/*!</span>
<a name="l00386"></a>00386 <span class="comment"> * \brief Jabber GTalk function</span>
<a name="l00387"></a>00387 <span class="comment"> * \param node iks</span>
<a name="l00388"></a>00388 <span class="comment"> * \return 1 on success, 0 on failure.</span>
<a name="l00389"></a>00389 <span class="comment">*/</span>
<a name="l00390"></a><a class="code" href="res__jabber_8c.html#ad006b2b4ce6bbe60f32b13b3e430affb">00390</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad006b2b4ce6bbe60f32b13b3e430affb" title="Jabber GTalk function.">gtalk_yuck</a>(iks *node)
<a name="l00391"></a>00391 {
<a name="l00392"></a>00392    <span class="keywordflow">if</span> (iks_find_with_attrib(node, <span class="stringliteral">&quot;c&quot;</span>, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/client/caps&quot;</span>))
<a name="l00393"></a>00393       <span class="keywordflow">return</span> 1;
<a name="l00394"></a>00394    <span class="keywordflow">return</span> 0;
<a name="l00395"></a>00395 }
<a name="l00396"></a>00396 <span class="comment"></span>
<a name="l00397"></a>00397 <span class="comment">/*!</span>
<a name="l00398"></a>00398 <span class="comment"> * \brief Setup the authentication struct</span>
<a name="l00399"></a>00399 <span class="comment"> * \param id iksid </span>
<a name="l00400"></a>00400 <span class="comment"> * \param pass password</span>
<a name="l00401"></a>00401 <span class="comment"> * \param sid</span>
<a name="l00402"></a>00402 <span class="comment"> * \return x iks</span>
<a name="l00403"></a>00403 <span class="comment">*/</span>
<a name="l00404"></a><a class="code" href="res__jabber_8c.html#a09cc645b12759b721001a5245f64165a">00404</a> <span class="keyword">static</span> iks *<a class="code" href="res__jabber_8c.html#a09cc645b12759b721001a5245f64165a" title="Setup the authentication struct.">jabber_make_auth</a>(iksid * <span class="keywordtype">id</span>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *sid)
<a name="l00405"></a>00405 {
<a name="l00406"></a>00406    iks *x, *y;
<a name="l00407"></a>00407    x = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l00408"></a>00408    iks_insert_attrib(x, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l00409"></a>00409    y = iks_insert(x, <span class="stringliteral">&quot;query&quot;</span>);
<a name="l00410"></a>00410    iks_insert_attrib(y, <span class="stringliteral">&quot;xmlns&quot;</span>, IKS_NS_AUTH);
<a name="l00411"></a>00411    iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;username&quot;</span>), id-&gt;user, 0);
<a name="l00412"></a>00412    iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;resource&quot;</span>), id-&gt;resource, 0);
<a name="l00413"></a>00413    <span class="keywordflow">if</span> (sid) {
<a name="l00414"></a>00414       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[41];
<a name="l00415"></a>00415       <span class="keywordtype">char</span> sidpass[100];
<a name="l00416"></a>00416       snprintf(sidpass, <span class="keyword">sizeof</span>(sidpass), <span class="stringliteral">&quot;%s%s&quot;</span>, sid, pass);
<a name="l00417"></a>00417       <a class="code" href="utils_8h.html#a89565d41a0b343afc57a1c0d9eb85160" title="Produces SHA1 hash based on input string.">ast_sha1_hash</a>(buf, sidpass);
<a name="l00418"></a>00418       iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;digest&quot;</span>), buf, 0);
<a name="l00419"></a>00419    } <span class="keywordflow">else</span> {
<a name="l00420"></a>00420       iks_insert_cdata(iks_insert(y, <span class="stringliteral">&quot;password&quot;</span>), pass, 0);
<a name="l00421"></a>00421    }
<a name="l00422"></a>00422    <span class="keywordflow">return</span> x;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 <span class="comment"></span>
<a name="l00425"></a>00425 <span class="comment">/*!</span>
<a name="l00426"></a>00426 <span class="comment"> * \brief Dial plan function status(). puts the status of watched user </span>
<a name="l00427"></a>00427 <span class="comment">   into a channel variable.</span>
<a name="l00428"></a>00428 <span class="comment"> * \param chan ast_channel</span>
<a name="l00429"></a>00429 <span class="comment"> * \param data</span>
<a name="l00430"></a>00430 <span class="comment"> * \return 0 on success, -1 on error</span>
<a name="l00431"></a>00431 <span class="comment"> */</span>
<a name="l00432"></a><a class="code" href="res__jabber_8c.html#af34ff341cd5689c2c1355daf38e38682">00432</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#af34ff341cd5689c2c1355daf38e38682" title="Dial plan function status(). puts the status of watched user into a channel variable...">aji_status_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00433"></a>00433 {
<a name="l00434"></a>00434    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l00435"></a>00435    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l00436"></a>00436    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *r = NULL;
<a name="l00437"></a>00437    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l00438"></a>00438    <span class="keywordtype">int</span> stat = 7;
<a name="l00439"></a>00439    <span class="keywordtype">char</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>[2];
<a name="l00440"></a>00440    <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;
<a name="l00441"></a>00441    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00442"></a>00442       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(sender);
<a name="l00443"></a>00443       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(jid);
<a name="l00444"></a>00444       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(variable);
<a name="l00445"></a>00445    );
<a name="l00446"></a>00446    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(jid,
<a name="l00447"></a>00447       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(screenname);
<a name="l00448"></a>00448       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l00449"></a>00449    );
<a name="l00450"></a>00450 
<a name="l00451"></a>00451    <span class="keywordflow">if</span> (deprecation_warning++ % 10 == 0)
<a name="l00452"></a>00452       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JabberStatus is deprecated.  Please use the JABBER_STATUS dialplan function in the future.\n&quot;</span>);
<a name="l00453"></a>00453 
<a name="l00454"></a>00454    <span class="keywordflow">if</span> (!data) {
<a name="l00455"></a>00455       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Usage: JabberStatus(&lt;sender&gt;,&lt;jid&gt;[/&lt;resource&gt;],&lt;varname&gt;\n&quot;</span>);
<a name="l00456"></a>00456       <span class="keywordflow">return</span> 0;
<a name="l00457"></a>00457    }
<a name="l00458"></a>00458    s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00459"></a>00459    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, s);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    <span class="keywordflow">if</span> (args.argc != 3) {
<a name="l00462"></a>00462       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JabberStatus() requires 3 arguments.\n&quot;</span>);
<a name="l00463"></a>00463       <span class="keywordflow">return</span> -1;
<a name="l00464"></a>00464    }
<a name="l00465"></a>00465 
<a name="l00466"></a>00466    <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(jid, args.jid, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00467"></a>00467 
<a name="l00468"></a>00468    <span class="keywordflow">if</span> (!(client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(args.sender))) {
<a name="l00469"></a>00469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find sender connection: &apos;%s&apos;\n&quot;</span>, args.sender);
<a name="l00470"></a>00470       <span class="keywordflow">return</span> -1;
<a name="l00471"></a>00471    }
<a name="l00472"></a>00472    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, jid.screenname);
<a name="l00473"></a>00473    <span class="keywordflow">if</span> (!buddy) {
<a name="l00474"></a>00474       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find buddy in list: &apos;%s&apos;\n&quot;</span>, jid.screenname);
<a name="l00475"></a>00475       <span class="keywordflow">return</span> -1;
<a name="l00476"></a>00476    }
<a name="l00477"></a>00477    r = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, jid.resource);
<a name="l00478"></a>00478    <span class="keywordflow">if</span> (!r &amp;&amp; buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>) 
<a name="l00479"></a>00479       r = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00480"></a>00480    <span class="keywordflow">if</span> (!r)
<a name="l00481"></a>00481       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Resource &apos;%s&apos; of buddy &apos;%s&apos; was not found\n&quot;</span>, jid.resource, jid.screenname);
<a name="l00482"></a>00482    <span class="keywordflow">else</span>
<a name="l00483"></a>00483       stat = r-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>;
<a name="l00484"></a>00484    snprintf(status, <span class="keyword">sizeof</span>(status), <span class="stringliteral">&quot;%d&quot;</span>, stat);
<a name="l00485"></a>00485    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, args.variable, status);
<a name="l00486"></a>00486    <span class="keywordflow">return</span> 0;
<a name="l00487"></a>00487 }
<a name="l00488"></a>00488 
<a name="l00489"></a><a class="code" href="res__jabber_8c.html#ac5044645216f6146c0bed265a2f8367c">00489</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ac5044645216f6146c0bed265a2f8367c">acf_jabberstatus_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> buflen)
<a name="l00490"></a>00490 {
<a name="l00491"></a>00491    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l00492"></a>00492    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l00493"></a>00493    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *r = NULL;
<a name="l00494"></a>00494    <span class="keywordtype">int</span> stat = 7;
<a name="l00495"></a>00495    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00496"></a>00496       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(sender);
<a name="l00497"></a>00497       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(jid);
<a name="l00498"></a>00498    );
<a name="l00499"></a>00499    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(jid,
<a name="l00500"></a>00500       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(screenname);
<a name="l00501"></a>00501       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l00502"></a>00502    );
<a name="l00503"></a>00503 
<a name="l00504"></a>00504    <span class="keywordflow">if</span> (!data) {
<a name="l00505"></a>00505       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Usage: JABBER_STATUS(&lt;sender&gt;,&lt;jid&gt;[/&lt;resource&gt;])\n&quot;</span>);
<a name="l00506"></a>00506       <span class="keywordflow">return</span> 0;
<a name="l00507"></a>00507    }
<a name="l00508"></a>00508    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l00509"></a>00509 
<a name="l00510"></a>00510    <span class="keywordflow">if</span> (args.argc != 2) {
<a name="l00511"></a>00511       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER_STATUS requires 2 arguments: sender and jid.\n&quot;</span>);
<a name="l00512"></a>00512       <span class="keywordflow">return</span> -1;
<a name="l00513"></a>00513    }
<a name="l00514"></a>00514 
<a name="l00515"></a>00515    <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(jid, args.jid, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517    <span class="keywordflow">if</span> (!(client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(args.sender))) {
<a name="l00518"></a>00518       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find sender connection: &apos;%s&apos;\n&quot;</span>, args.sender);
<a name="l00519"></a>00519       <span class="keywordflow">return</span> -1;
<a name="l00520"></a>00520    }
<a name="l00521"></a>00521    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, jid.screenname);
<a name="l00522"></a>00522    <span class="keywordflow">if</span> (!buddy) {
<a name="l00523"></a>00523       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find buddy in list: &apos;%s&apos;\n&quot;</span>, jid.screenname);
<a name="l00524"></a>00524       <span class="keywordflow">return</span> -1;
<a name="l00525"></a>00525    }
<a name="l00526"></a>00526    r = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, jid.resource);
<a name="l00527"></a>00527    <span class="keywordflow">if</span> (!r &amp;&amp; buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>) 
<a name="l00528"></a>00528       r = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l00529"></a>00529    <span class="keywordflow">if</span> (!r)
<a name="l00530"></a>00530       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Resource %s of buddy %s was not found.\n&quot;</span>, jid.resource, jid.screenname);
<a name="l00531"></a>00531    <span class="keywordflow">else</span>
<a name="l00532"></a>00532       stat = r-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>;
<a name="l00533"></a>00533    snprintf(buf, buflen, <span class="stringliteral">&quot;%d&quot;</span>, stat);
<a name="l00534"></a>00534    <span class="keywordflow">return</span> 0;
<a name="l00535"></a>00535 }
<a name="l00536"></a>00536 
<a name="l00537"></a><a class="code" href="res__jabber_8c.html#a12ea81a7f47eca38c7c4ac9a07bddd40">00537</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="res__jabber_8c.html#a12ea81a7f47eca38c7c4ac9a07bddd40">jabberstatus_function</a> = {
<a name="l00538"></a>00538    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;JABBER_STATUS&quot;</span>,
<a name="l00539"></a>00539    .read = <a class="code" href="res__jabber_8c.html#ac5044645216f6146c0bed265a2f8367c">acf_jabberstatus_read</a>,
<a name="l00540"></a>00540 };
<a name="l00541"></a>00541 <span class="comment"></span>
<a name="l00542"></a>00542 <span class="comment">/*!</span>
<a name="l00543"></a>00543 <span class="comment"> * \brief Dial plan function to send a message.</span>
<a name="l00544"></a>00544 <span class="comment"> * \param chan ast_channel</span>
<a name="l00545"></a>00545 <span class="comment"> * \param data  Data is sender|receiver|message.</span>
<a name="l00546"></a>00546 <span class="comment"> * \return 0 on success,-1 on error.</span>
<a name="l00547"></a>00547 <span class="comment"> */</span>
<a name="l00548"></a><a class="code" href="res__jabber_8c.html#a26515ff8bd0588f1181bb6a3abc56f90">00548</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a26515ff8bd0588f1181bb6a3abc56f90" title="Dial plan function to send a message.">aji_send_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00549"></a>00549 {
<a name="l00550"></a>00550    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l00551"></a>00551    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00552"></a>00552    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l00553"></a>00553       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(sender);
<a name="l00554"></a>00554       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(recipient);
<a name="l00555"></a>00555       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structmessage.html">message</a>);
<a name="l00556"></a>00556    );
<a name="l00557"></a>00557 
<a name="l00558"></a>00558    <span class="keywordflow">if</span> (!data) {
<a name="l00559"></a>00559       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Usage:  JabberSend(&lt;sender&gt;,&lt;recipient&gt;,&lt;message&gt;)\n&quot;</span>);
<a name="l00560"></a>00560       <span class="keywordflow">return</span> 0;
<a name="l00561"></a>00561    }
<a name="l00562"></a>00562    s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00563"></a>00563 
<a name="l00564"></a>00564    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, s);
<a name="l00565"></a>00565    <span class="keywordflow">if</span> (args.argc &lt; 3) {
<a name="l00566"></a>00566       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JabberSend requires 3 arguments: &apos;%s&apos;\n&quot;</span>, (<span class="keywordtype">char</span> *) data);
<a name="l00567"></a>00567       <span class="keywordflow">return</span> -1;
<a name="l00568"></a>00568    }
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    <span class="keywordflow">if</span> (!(client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(args.sender))) {
<a name="l00571"></a>00571       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find sender connection: &apos;%s&apos;\n&quot;</span>, args.sender);
<a name="l00572"></a>00572       <span class="keywordflow">return</span> -1;
<a name="l00573"></a>00573    }
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (strchr(args.recipient, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.message))
<a name="l00575"></a>00575       <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(client, args.recipient, args.message);
<a name="l00576"></a>00576    <span class="keywordflow">return</span> 0;
<a name="l00577"></a>00577 }
<a name="l00578"></a>00578 <span class="comment"></span>
<a name="l00579"></a>00579 <span class="comment">/*! </span>
<a name="l00580"></a>00580 <span class="comment"> * \brief Tests whether the connection is secured or not</span>
<a name="l00581"></a>00581 <span class="comment"> * \return 0 if the connection is not secured</span>
<a name="l00582"></a>00582 <span class="comment"> */</span>
<a name="l00583"></a><a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14">00583</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l00584"></a>00584 {
<a name="l00585"></a>00585 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00586"></a>00586 <span class="preprocessor"></span>   <span class="keywordflow">return</span> client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp; <a class="code" href="jabber_8h.html#aff0ca0337402eb888baf747ce2469641">SECURE</a>;
<a name="l00587"></a>00587 <span class="preprocessor">#else</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l00589"></a>00589 <span class="preprocessor">#endif</span>
<a name="l00590"></a>00590 <span class="preprocessor"></span>}
<a name="l00591"></a>00591 
<a name="l00592"></a>00592 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00593"></a>00593 <span class="preprocessor"></span><span class="comment">/*!</span>
<a name="l00594"></a>00594 <span class="comment"> * \brief Starts the TLS procedure</span>
<a name="l00595"></a>00595 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00596"></a>00596 <span class="comment"> * \return IKS_OK on success, an error code if sending failed, IKS_NET_TLSFAIL</span>
<a name="l00597"></a>00597 <span class="comment"> * if OpenSSL is not installed</span>
<a name="l00598"></a>00598 <span class="comment"> */</span>
<a name="l00599"></a><a class="code" href="res__jabber_8c.html#ad7bb4a25ad47122d109b34c3e8552f96">00599</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad7bb4a25ad47122d109b34c3e8552f96" title="Starts the TLS procedure.">aji_start_tls</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l00600"></a>00600 {
<a name="l00601"></a>00601    <span class="keywordtype">int</span> ret;
<a name="l00602"></a>00602 
<a name="l00603"></a>00603    <span class="comment">/* This is sent not encrypted */</span>
<a name="l00604"></a>00604    ret = iks_send_raw(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, <span class="stringliteral">&quot;&lt;starttls xmlns=&apos;urn:ietf:params:xml:ns:xmpp-tls&apos;/&gt;&quot;</span>);
<a name="l00605"></a>00605    <span class="keywordflow">if</span> (ret)
<a name="l00606"></a>00606       <span class="keywordflow">return</span> ret;
<a name="l00607"></a>00607 
<a name="l00608"></a>00608    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> |= <a class="code" href="jabber_8h.html#ab432cc1c9f5228a80e1fe12e301a2f0f">TRY_SECURE</a>;
<a name="l00609"></a>00609    <span class="keywordflow">return</span> IKS_OK;
<a name="l00610"></a>00610 }
<a name="l00611"></a>00611 <span class="comment"></span>
<a name="l00612"></a>00612 <span class="comment">/*! </span>
<a name="l00613"></a>00613 <span class="comment"> * \brief TLS handshake, OpenSSL initialization</span>
<a name="l00614"></a>00614 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00615"></a>00615 <span class="comment"> * \return IKS_OK on success, IKS_NET_TLSFAIL on failure </span>
<a name="l00616"></a>00616 <span class="comment"> */</span>
<a name="l00617"></a><a class="code" href="res__jabber_8c.html#a626fb8236724be309a0d3ee3a2e979ed">00617</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a626fb8236724be309a0d3ee3a2e979ed" title="TLS handshake, OpenSSL initialization.">aji_tls_handshake</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l00618"></a>00618 {
<a name="l00619"></a>00619    <span class="keywordtype">int</span> ret;
<a name="l00620"></a>00620    <span class="keywordtype">int</span> sock;
<a name="l00621"></a>00621    
<a name="l00622"></a>00622    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Starting TLS handshake\n&quot;</span>); 
<a name="l00623"></a>00623 
<a name="l00624"></a>00624    <span class="comment">/* Choose an SSL/TLS protocol version, create SSL_CTX */</span>
<a name="l00625"></a>00625    client-&gt;<a class="code" href="structaji__client.html#ae7d8930ee375c24f1dc8769888441e55">ssl_method</a> = SSLv3_method();
<a name="l00626"></a>00626    client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a> = SSL_CTX_new(client-&gt;<a class="code" href="structaji__client.html#ae7d8930ee375c24f1dc8769888441e55">ssl_method</a>);                
<a name="l00627"></a>00627    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a>)
<a name="l00628"></a>00628       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00629"></a>00629 
<a name="l00630"></a>00630    <span class="comment">/* Create new SSL session */</span>
<a name="l00631"></a>00631    client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a> = SSL_new(client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a>);
<a name="l00632"></a>00632    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>)
<a name="l00633"></a>00633       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00634"></a>00634 
<a name="l00635"></a>00635    <span class="comment">/* Enforce TLS on our XMPP connection */</span>
<a name="l00636"></a>00636    sock = iks_fd(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l00637"></a>00637    ret = SSL_set_fd(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>, sock);
<a name="l00638"></a>00638    <span class="keywordflow">if</span> (!ret)
<a name="l00639"></a>00639       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00640"></a>00640 
<a name="l00641"></a>00641    <span class="comment">/* Perform SSL handshake */</span>
<a name="l00642"></a>00642    ret = SSL_connect(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l00643"></a>00643    <span class="keywordflow">if</span> (!ret)
<a name="l00644"></a>00644       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00645"></a>00645 
<a name="l00646"></a>00646    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp;= (~<a class="code" href="jabber_8h.html#ab432cc1c9f5228a80e1fe12e301a2f0f">TRY_SECURE</a>);
<a name="l00647"></a>00647    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> |= <a class="code" href="jabber_8h.html#aff0ca0337402eb888baf747ce2469641">SECURE</a>;
<a name="l00648"></a>00648 
<a name="l00649"></a>00649    <span class="comment">/* Sent over the established TLS connection */</span>
<a name="l00650"></a>00650    ret = <a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c" title="Sends XMPP header to the server.">aji_send_header</a>(client, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l00651"></a>00651    <span class="keywordflow">if</span> (ret != IKS_OK)
<a name="l00652"></a>00652       <span class="keywordflow">return</span> IKS_NET_TLSFAIL;
<a name="l00653"></a>00653 
<a name="l00654"></a>00654    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;TLS started with server\n&quot;</span>); 
<a name="l00655"></a>00655 
<a name="l00656"></a>00656    <span class="keywordflow">return</span> IKS_OK;
<a name="l00657"></a>00657 }
<a name="l00658"></a>00658 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_OPENSSL */</span>
<a name="l00659"></a>00659 <span class="comment"></span>
<a name="l00660"></a>00660 <span class="comment">/*! </span>
<a name="l00661"></a>00661 <span class="comment"> * \brief Secured or unsecured IO socket receiving function</span>
<a name="l00662"></a>00662 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00663"></a>00663 <span class="comment"> * \param buffer the reception buffer</span>
<a name="l00664"></a>00664 <span class="comment"> * \param buf_len the size of the buffer</span>
<a name="l00665"></a>00665 <span class="comment"> * \param timeout the select timer</span>
<a name="l00666"></a>00666 <span class="comment"> * \return the number of read bytes on success, 0 on timeout expiration, </span>
<a name="l00667"></a>00667 <span class="comment"> * -1 on  error</span>
<a name="l00668"></a>00668 <span class="comment"> */</span>
<a name="l00669"></a><a class="code" href="res__jabber_8c.html#a7487004afc39b2fbdd92ab9faaff8231">00669</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a7487004afc39b2fbdd92ab9faaff8231" title="Secured or unsecured IO socket receiving function.">aji_io_recv</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> buf_len, <span class="keywordtype">int</span> <a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>)
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671    <span class="keywordtype">int</span> sock;
<a name="l00672"></a>00672    fd_set fds;
<a name="l00673"></a>00673    <span class="keyword">struct </span>timeval tv, *tvptr = NULL;
<a name="l00674"></a>00674    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, res;
<a name="l00675"></a>00675 
<a name="l00676"></a>00676 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00678"></a>00678       sock = SSL_get_fd(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l00679"></a>00679       <span class="keywordflow">if</span> (sock &lt; 0)
<a name="l00680"></a>00680          <span class="keywordflow">return</span> -1;     
<a name="l00681"></a>00681    } <span class="keywordflow">else</span>
<a name="l00682"></a>00682 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_OPENSSL */</span>
<a name="l00683"></a>00683       sock = iks_fd(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);  
<a name="l00684"></a>00684 
<a name="l00685"></a>00685    memset(&amp;tv, 0, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> timeval));
<a name="l00686"></a>00686    FD_ZERO(&amp;fds);
<a name="l00687"></a>00687    FD_SET(sock, &amp;fds);
<a name="l00688"></a>00688    tv.tv_sec = timeout;
<a name="l00689"></a>00689 
<a name="l00690"></a>00690    <span class="comment">/* NULL value for tvptr makes ast_select wait indefinitely */</span>
<a name="l00691"></a>00691    tvptr = (timeout != -1) ? &amp;tv : NULL;
<a name="l00692"></a>00692 
<a name="l00693"></a>00693    <span class="comment">/* ast_select emulates linux behaviour in terms of timeout handling */</span>
<a name="l00694"></a>00694    res = <a class="code" href="channel_8h.html#a056ed4f99440f01c251b2e8ca4501a56" title="Waits for activity on a group of channels.">ast_select</a>(sock + 1, &amp;fds, NULL, NULL, tvptr);
<a name="l00695"></a>00695    <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l00696"></a>00696 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00698"></a>00698          len = SSL_read(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>, buffer, buf_len);
<a name="l00699"></a>00699       } <span class="keywordflow">else</span>
<a name="l00700"></a>00700 <span class="preprocessor">#endif </span><span class="comment">/* HAVE_OPENSSL */</span>
<a name="l00701"></a>00701          len = recv(sock, buffer, buf_len, 0);
<a name="l00702"></a>00702 
<a name="l00703"></a>00703       <span class="keywordflow">if</span> (len &gt; 0) {
<a name="l00704"></a>00704          <span class="keywordflow">return</span> len;
<a name="l00705"></a>00705       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (len &lt;= 0) {
<a name="l00706"></a>00706          <span class="keywordflow">return</span> -1;
<a name="l00707"></a>00707       }
<a name="l00708"></a>00708    }
<a name="l00709"></a>00709    <span class="keywordflow">return</span> res;
<a name="l00710"></a>00710 }
<a name="l00711"></a>00711 <span class="comment"></span>
<a name="l00712"></a>00712 <span class="comment">/*! </span>
<a name="l00713"></a>00713 <span class="comment"> * \brief Tries to receive data from the Jabber server</span>
<a name="l00714"></a>00714 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00715"></a>00715 <span class="comment"> * \param timeout the timeout value</span>
<a name="l00716"></a>00716 <span class="comment"> * This function receives (encrypted or unencrypted) data from the XMPP server,</span>
<a name="l00717"></a>00717 <span class="comment"> * and passes it to the parser.</span>
<a name="l00718"></a>00718 <span class="comment"> * \return IKS_OK on success, IKS_NET_RWERR on IO error, IKS_NET_NOCONN, if no</span>
<a name="l00719"></a>00719 <span class="comment"> * connection available, IKS_NET_EXPIRED on timeout expiration</span>
<a name="l00720"></a>00720 <span class="comment"> */</span>
<a name="l00721"></a><a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741">00721</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741" title="Tries to receive data from the Jabber server.">aji_recv</a> (<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">int</span> timeout)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, ret;
<a name="l00724"></a>00724    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[<a class="code" href="jabber_8h.html#a88194d0f499931c26ef4df0738f26ec1">NET_IO_BUF_SIZE</a> - 1];
<a name="l00725"></a>00725    <span class="keywordtype">char</span> newbuf[<a class="code" href="jabber_8h.html#a88194d0f499931c26ef4df0738f26ec1">NET_IO_BUF_SIZE</a> - 1];
<a name="l00726"></a>00726    <span class="keywordtype">int</span> pos = 0;
<a name="l00727"></a>00727    <span class="keywordtype">int</span> newbufpos = 0;
<a name="l00728"></a>00728    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> c;
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l00731"></a>00731    memset(newbuf, 0, <span class="keyword">sizeof</span>(newbuf));
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    <span class="keywordflow">while</span> (1) {
<a name="l00734"></a>00734       len = <a class="code" href="res__jabber_8c.html#a7487004afc39b2fbdd92ab9faaff8231" title="Secured or unsecured IO socket receiving function.">aji_io_recv</a>(client, buf, <a class="code" href="jabber_8h.html#a88194d0f499931c26ef4df0738f26ec1">NET_IO_BUF_SIZE</a> - 2, timeout);
<a name="l00735"></a>00735       <span class="keywordflow">if</span> (len &lt; 0) <span class="keywordflow">return</span> IKS_NET_RWERR;
<a name="l00736"></a>00736       <span class="keywordflow">if</span> (len == 0) <span class="keywordflow">return</span> <a class="code" href="jabber_8h.html#a99fa4c2cecd405f4430c8d137af93db9">IKS_NET_EXPIRED</a>;
<a name="l00737"></a>00737       buf[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00738"></a>00738 
<a name="l00739"></a>00739       <span class="comment">/* our iksemel parser won&apos;t work as expected if we feed</span>
<a name="l00740"></a>00740 <span class="comment">         it with XML packets that contain multiple whitespace </span>
<a name="l00741"></a>00741 <span class="comment">         characters between tags */</span>
<a name="l00742"></a>00742       <span class="keywordflow">while</span> (pos &lt; len) {
<a name="l00743"></a>00743          c = buf[pos];
<a name="l00744"></a>00744          <span class="comment">/* if we stumble on the ending tag character,</span>
<a name="l00745"></a>00745 <span class="comment">            we skip any whitespace that follows it*/</span>
<a name="l00746"></a>00746          <span class="keywordflow">if</span> (c == <span class="charliteral">&apos;&gt;&apos;</span>) {
<a name="l00747"></a>00747             <span class="keywordflow">while</span> (isspace(buf[pos+1])) {
<a name="l00748"></a>00748                pos++;
<a name="l00749"></a>00749             }
<a name="l00750"></a>00750          }
<a name="l00751"></a>00751          newbuf[newbufpos] = c;
<a name="l00752"></a>00752          newbufpos ++;
<a name="l00753"></a>00753          pos++;
<a name="l00754"></a>00754       }
<a name="l00755"></a>00755       pos = 0;
<a name="l00756"></a>00756       newbufpos = 0;
<a name="l00757"></a>00757 
<a name="l00758"></a>00758       <span class="comment">/* Log the message here, because iksemel&apos;s logHook is </span>
<a name="l00759"></a>00759 <span class="comment">         unaccessible */</span>
<a name="l00760"></a>00760       <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>(client, buf, len, 1);
<a name="l00761"></a>00761 
<a name="l00762"></a>00762       <span class="comment">/* let iksemel deal with the string length, </span>
<a name="l00763"></a>00763 <span class="comment">         and reset our buffer */</span>
<a name="l00764"></a>00764       ret = iks_parse(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, newbuf, 0, 0);
<a name="l00765"></a>00765       memset(newbuf, 0, <span class="keyword">sizeof</span>(newbuf));
<a name="l00766"></a>00766 
<a name="l00767"></a>00767       <span class="keywordflow">switch</span> (ret) {
<a name="l00768"></a>00768       <span class="keywordflow">case</span> IKS_NOMEM:
<a name="l00769"></a>00769          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parsing failure: Out of memory.\n&quot;</span>);
<a name="l00770"></a>00770          <span class="keywordflow">break</span>;
<a name="l00771"></a>00771       <span class="keywordflow">case</span> IKS_BADXML:
<a name="l00772"></a>00772          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parsing failure: Invalid XML.\n&quot;</span>);
<a name="l00773"></a>00773          <span class="keywordflow">break</span>;
<a name="l00774"></a>00774       <span class="keywordflow">case</span> IKS_HOOK:
<a name="l00775"></a>00775          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Parsing failure: Hook returned an error.\n&quot;</span>);
<a name="l00776"></a>00776          <span class="keywordflow">break</span>;
<a name="l00777"></a>00777       }
<a name="l00778"></a>00778       <span class="keywordflow">if</span> (ret != IKS_OK) {
<a name="l00779"></a>00779          <span class="keywordflow">return</span> ret;
<a name="l00780"></a>00780       }
<a name="l00781"></a>00781       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;XML parsing successful\n&quot;</span>); 
<a name="l00782"></a>00782    }
<a name="l00783"></a>00783    <span class="keywordflow">return</span> IKS_OK;
<a name="l00784"></a>00784 }
<a name="l00785"></a>00785 <span class="comment"></span>
<a name="l00786"></a>00786 <span class="comment">/*! </span>
<a name="l00787"></a>00787 <span class="comment"> * \brief Sends XMPP header to the server</span>
<a name="l00788"></a>00788 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00789"></a>00789 <span class="comment"> * \param to the target XMPP server</span>
<a name="l00790"></a>00790 <span class="comment"> * \return IKS_OK on success, any other value on failure</span>
<a name="l00791"></a>00791 <span class="comment"> */</span>
<a name="l00792"></a><a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c">00792</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c" title="Sends XMPP header to the server.">aji_send_header</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *to)
<a name="l00793"></a>00793 {
<a name="l00794"></a>00794    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>;
<a name="l00795"></a>00795    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, err;
<a name="l00796"></a>00796 
<a name="l00797"></a>00797    len = 91 + strlen(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>) + 6 + strlen(to) + 16 + 1;
<a name="l00798"></a>00798    msg = iks_malloc(len);
<a name="l00799"></a>00799    <span class="keywordflow">if</span> (!msg)
<a name="l00800"></a>00800       <span class="keywordflow">return</span> IKS_NOMEM;
<a name="l00801"></a>00801    sprintf(msg, <span class="stringliteral">&quot;&lt;?xml version=&apos;1.0&apos;?&gt;&quot;</span>
<a name="l00802"></a>00802       <span class="stringliteral">&quot;&lt;stream:stream xmlns:stream=&apos;http://etherx.jabber.org/streams&apos; xmlns=&apos;&quot;</span>
<a name="l00803"></a>00803       <span class="stringliteral">&quot;%s&apos; to=&apos;%s&apos; version=&apos;1.0&apos;&gt;&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>, to);
<a name="l00804"></a>00804    err = <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, msg);
<a name="l00805"></a>00805    iks_free(msg);
<a name="l00806"></a>00806    <span class="keywordflow">if</span> (err != IKS_OK)
<a name="l00807"></a>00807       <span class="keywordflow">return</span> err;
<a name="l00808"></a>00808 
<a name="l00809"></a>00809    <span class="keywordflow">return</span> IKS_OK;
<a name="l00810"></a>00810 }
<a name="l00811"></a>00811 <span class="comment"></span>
<a name="l00812"></a>00812 <span class="comment">/*! </span>
<a name="l00813"></a>00813 <span class="comment"> * \brief Wraps raw sending</span>
<a name="l00814"></a>00814 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00815"></a>00815 <span class="comment"> * \param x the XMPP packet to send</span>
<a name="l00816"></a>00816 <span class="comment"> * \return IKS_OK on success, any other value on failure</span>
<a name="l00817"></a>00817 <span class="comment"> */</span>
<a name="l00818"></a><a class="code" href="res__jabber_8c.html#a3c77ceecc909619207e971421fc3e9ef">00818</a> <span class="keywordtype">int</span> <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, iks *x)
<a name="l00819"></a>00819 {
<a name="l00820"></a>00820    <span class="keywordflow">return</span> <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, iks_string(iks_stack(x), x));
<a name="l00821"></a>00821 }
<a name="l00822"></a>00822 <span class="comment"></span>
<a name="l00823"></a>00823 <span class="comment">/*! </span>
<a name="l00824"></a>00824 <span class="comment"> * \brief Sends an XML string over an XMPP connection</span>
<a name="l00825"></a>00825 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00826"></a>00826 <span class="comment"> * \param xmlstr the XML string to send</span>
<a name="l00827"></a>00827 <span class="comment"> * The XML data is sent whether the connection is secured or not. In the </span>
<a name="l00828"></a>00828 <span class="comment"> * latter case, we just call iks_send_raw().</span>
<a name="l00829"></a>00829 <span class="comment"> * \return IKS_OK on success, any other value on failure</span>
<a name="l00830"></a>00830 <span class="comment"> */</span>
<a name="l00831"></a><a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6">00831</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *xmlstr)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833    <span class="keywordtype">int</span> ret;
<a name="l00834"></a>00834 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00835"></a>00835 <span class="preprocessor"></span>   <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(xmlstr);
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00838"></a>00838       ret = SSL_write(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>, xmlstr, len);
<a name="l00839"></a>00839       <span class="keywordflow">if</span> (ret) {
<a name="l00840"></a>00840          <span class="comment">/* Log the message here, because iksemel&apos;s logHook is </span>
<a name="l00841"></a>00841 <span class="comment">            unaccessible */</span>
<a name="l00842"></a>00842          <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>(client, xmlstr, len, 0);
<a name="l00843"></a>00843          <span class="keywordflow">return</span> IKS_OK;
<a name="l00844"></a>00844       }
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846 <span class="preprocessor">#endif</span>
<a name="l00847"></a>00847 <span class="preprocessor"></span>   <span class="comment">/* If needed, data will be sent unencrypted, and logHook will </span>
<a name="l00848"></a>00848 <span class="comment">      be called inside iks_send_raw */</span>
<a name="l00849"></a>00849    ret = iks_send_raw(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, xmlstr);
<a name="l00850"></a>00850    <span class="keywordflow">if</span> (ret != IKS_OK)
<a name="l00851"></a>00851       <span class="keywordflow">return</span> ret; 
<a name="l00852"></a>00852 
<a name="l00853"></a>00853    <span class="keywordflow">return</span> IKS_OK;
<a name="l00854"></a>00854 }
<a name="l00855"></a>00855 <span class="comment"></span>
<a name="l00856"></a>00856 <span class="comment">/*!</span>
<a name="l00857"></a>00857 <span class="comment"> * \brief the debug loop.</span>
<a name="l00858"></a>00858 <span class="comment"> * \param data void</span>
<a name="l00859"></a>00859 <span class="comment"> * \param xmpp xml data as string</span>
<a name="l00860"></a>00860 <span class="comment"> * \param size size of string</span>
<a name="l00861"></a>00861 <span class="comment"> * \param is_incoming direction of packet 1 for inbound 0 for outbound.</span>
<a name="l00862"></a>00862 <span class="comment"> */</span>
<a name="l00863"></a><a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c">00863</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>(<span class="keywordtype">void</span> *data, <span class="keyword">const</span> <span class="keywordtype">char</span> *xmpp, <span class="keywordtype">size_t</span> size, <span class="keywordtype">int</span> is_incoming)
<a name="l00864"></a>00864 {
<a name="l00865"></a>00865    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l00866"></a>00866 
<a name="l00867"></a>00867    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(xmpp))
<a name="l00868"></a>00868       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#acc12c2bc03dce67ddd1590d67ab11f4d">EVENT_FLAG_USER</a>, <span class="stringliteral">&quot;JabberEvent&quot;</span>, <span class="stringliteral">&quot;Account: %s\r\nPacket: %s\r\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, xmpp);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>) {
<a name="l00871"></a>00871       <span class="keywordflow">if</span> (is_incoming)
<a name="l00872"></a>00872          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nJABBER: %s INCOMING: %s\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, xmpp);
<a name="l00873"></a>00873       <span class="keywordflow">else</span> {
<a name="l00874"></a>00874          <span class="keywordflow">if</span>( strlen(xmpp) == 1) {
<a name="l00875"></a>00875             <span class="keywordflow">if</span>(<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2  &amp;&amp; xmpp[0] == <span class="charliteral">&apos; &apos;</span>) {
<a name="l00876"></a>00876                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nJABBER: Keep alive packet\n&quot;</span>);
<a name="l00877"></a>00877             }
<a name="l00878"></a>00878          } <span class="keywordflow">else</span>
<a name="l00879"></a>00879             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nJABBER: %s OUTGOING: %s\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, xmpp);
<a name="l00880"></a>00880       }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882    }
<a name="l00883"></a>00883    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00884"></a>00884 }
<a name="l00885"></a>00885 <span class="comment"></span>
<a name="l00886"></a>00886 <span class="comment">/*!</span>
<a name="l00887"></a>00887 <span class="comment"> * \brief A wrapper function for iks_start_sasl</span>
<a name="l00888"></a>00888 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l00889"></a>00889 <span class="comment"> * \param type the SASL authentication type. Supported types are PLAIN and MD5</span>
<a name="l00890"></a>00890 <span class="comment"> * \param username</span>
<a name="l00891"></a>00891 <span class="comment"> * \param pass password.</span>
<a name="l00892"></a>00892 <span class="comment"> *</span>
<a name="l00893"></a>00893 <span class="comment"> * \return IKS_OK on success, IKSNET_NOTSUPP on failure.</span>
<a name="l00894"></a>00894 <span class="comment"> */</span>
<a name="l00895"></a><a class="code" href="res__jabber_8c.html#a1b15523e274d7f26568ef5521a73e7ce">00895</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1b15523e274d7f26568ef5521a73e7ce" title="A wrapper function for iks_start_sasl.">aji_start_sasl</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">enum</span> ikssasltype <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keywordtype">char</span> *username, <span class="keywordtype">char</span> *<a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a>)
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897    iks *x = NULL;
<a name="l00898"></a>00898    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l00899"></a>00899    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00900"></a>00900    <span class="keywordtype">char</span> *<a class="code" href="utils_8c.html#a094cd85754f67592588ab5a0636cf0ea">base64</a>;
<a name="l00901"></a>00901 
<a name="l00902"></a>00902    <span class="comment">/* trigger SASL DIGEST-MD5 only over an unsecured connection.</span>
<a name="l00903"></a>00903 <span class="comment">      iks_start_sasl is an iksemel API function and relies on GnuTLS,</span>
<a name="l00904"></a>00904 <span class="comment">      whereas we use OpenSSL */</span>
<a name="l00905"></a>00905    <span class="keywordflow">if</span> ((type &amp; IKS_STREAM_SASL_MD5) &amp;&amp; !<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client))
<a name="l00906"></a>00906       <span class="keywordflow">return</span> iks_start_sasl(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, IKS_SASL_DIGEST_MD5, username, pass); 
<a name="l00907"></a>00907    <span class="keywordflow">if</span> (!(type &amp; IKS_STREAM_SASL_PLAIN)) {
<a name="l00908"></a>00908       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Server does not support SASL PLAIN authentication\n&quot;</span>);
<a name="l00909"></a>00909       <span class="keywordflow">return</span> IKS_NET_NOTSUPP;
<a name="l00910"></a>00910    }
<a name="l00911"></a>00911 
<a name="l00912"></a>00912    x = iks_new(<span class="stringliteral">&quot;auth&quot;</span>); 
<a name="l00913"></a>00913    <span class="keywordflow">if</span> (!x) {
<a name="l00914"></a>00914       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l00915"></a>00915       <span class="keywordflow">return</span> IKS_NET_NOTSUPP;
<a name="l00916"></a>00916    }
<a name="l00917"></a>00917 
<a name="l00918"></a>00918    iks_insert_attrib(x, <span class="stringliteral">&quot;xmlns&quot;</span>, IKS_NS_XMPP_SASL);
<a name="l00919"></a>00919    len = strlen(username) + strlen(pass) + 3;
<a name="l00920"></a>00920    s = alloca(len);
<a name="l00921"></a>00921    base64 = alloca((len + 2) * 4 / 3);
<a name="l00922"></a>00922    iks_insert_attrib(x, <span class="stringliteral">&quot;mechanism&quot;</span>, <span class="stringliteral">&quot;PLAIN&quot;</span>);
<a name="l00923"></a>00923    snprintf(s, len, <span class="stringliteral">&quot;%c%s%c%s&quot;</span>, 0, username, 0, pass);
<a name="l00924"></a>00924 
<a name="l00925"></a>00925    <span class="comment">/* exclude the NULL training byte from the base64 encoding operation</span>
<a name="l00926"></a>00926 <span class="comment">      as some XMPP servers will refuse it.</span>
<a name="l00927"></a>00927 <span class="comment">      The format for authentication is [authzid]\0authcid\0password</span>
<a name="l00928"></a>00928 <span class="comment">      not [authzid]\0authcid\0password\0 */</span>
<a name="l00929"></a>00929    <a class="code" href="utils_8h.html#a555dad1bd5b23acf01cf08f1affab879" title="Encode data in base64.">ast_base64encode</a>(base64, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *) s, len - 1, (len + 2) * 4 / 3);
<a name="l00930"></a>00930    iks_insert_cdata(x, base64, 0);
<a name="l00931"></a>00931    <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, x);
<a name="l00932"></a>00932    iks_delete(x);
<a name="l00933"></a>00933 
<a name="l00934"></a>00934    <span class="keywordflow">return</span> IKS_OK;
<a name="l00935"></a>00935 }
<a name="l00936"></a>00936 <span class="comment"></span>
<a name="l00937"></a>00937 <span class="comment">/*!</span>
<a name="l00938"></a>00938 <span class="comment"> * \brief The action hook parses the inbound packets, constantly running.</span>
<a name="l00939"></a>00939 <span class="comment"> * \param data aji client structure </span>
<a name="l00940"></a>00940 <span class="comment"> * \param type type of packet </span>
<a name="l00941"></a>00941 <span class="comment"> * \param node the actual packet.</span>
<a name="l00942"></a>00942 <span class="comment"> * \return IKS_OK or IKS_HOOK .</span>
<a name="l00943"></a>00943 <span class="comment"> */</span>
<a name="l00944"></a><a class="code" href="res__jabber_8c.html#ad0e9114c8ba0981e4a4f3f7d93f5ef3c">00944</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad0e9114c8ba0981e4a4f3f7d93f5ef3c" title="The action hook parses the inbound packets, constantly running.">aji_act_hook</a>(<span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, iks *node)
<a name="l00945"></a>00945 {
<a name="l00946"></a>00946    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l00947"></a>00947    ikspak *pak = NULL;
<a name="l00948"></a>00948    iks *auth = NULL;
<a name="l00949"></a>00949    <span class="keywordtype">int</span> features = 0;
<a name="l00950"></a>00950 
<a name="l00951"></a>00951    <span class="keywordflow">if</span>(!node) {
<a name="l00952"></a>00952       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;aji_act_hook was called with out a packet\n&quot;</span>); <span class="comment">/* most likely cause type is IKS_NODE_ERROR lost connection */</span>
<a name="l00953"></a>00953       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00954"></a>00954       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l00955"></a>00955    }
<a name="l00956"></a>00956 
<a name="l00957"></a>00957    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a9f2e9be855a781b74badbe0c1bda278e">AJI_DISCONNECTING</a>) {
<a name="l00958"></a>00958       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00959"></a>00959       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l00960"></a>00960    }
<a name="l00961"></a>00961 
<a name="l00962"></a>00962    pak = iks_packet(node);
<a name="l00963"></a>00963 
<a name="l00964"></a>00964    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) { <span class="comment">/*client */</span>
<a name="l00965"></a>00965       <span class="keywordflow">switch</span> (type) {
<a name="l00966"></a>00966       <span class="keywordflow">case</span> IKS_NODE_START:
<a name="l00967"></a>00967          <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> &amp;&amp; !<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client)) {
<a name="l00968"></a>00968 <span class="preprocessor">#ifndef HAVE_OPENSSL</span>
<a name="l00969"></a>00969 <span class="preprocessor"></span>            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;OpenSSL not installed. You need to install OpenSSL on this system, or disable the TLS option in your configuration file\n&quot;</span>);
<a name="l00970"></a>00970             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00971"></a>00971             <span class="keywordflow">return</span> IKS_HOOK;
<a name="l00972"></a>00972 <span class="preprocessor">#else</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (<a class="code" href="res__jabber_8c.html#ad7bb4a25ad47122d109b34c3e8552f96" title="Starts the TLS procedure.">aji_start_tls</a>(client) == IKS_NET_TLSFAIL) {
<a name="l00974"></a>00974                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not start TLS\n&quot;</span>);
<a name="l00975"></a>00975                <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l00976"></a>00976                <span class="keywordflow">return</span> IKS_HOOK;     
<a name="l00977"></a>00977             }
<a name="l00978"></a>00978 <span class="preprocessor">#endif</span>
<a name="l00979"></a>00979 <span class="preprocessor"></span>            <span class="keywordflow">break</span>;
<a name="l00980"></a>00980          }
<a name="l00981"></a>00981          <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a>) {
<a name="l00982"></a>00982             iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_ID, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>, IKS_RULE_DONE);
<a name="l00983"></a>00983             auth = <a class="code" href="res__jabber_8c.html#a09cc645b12759b721001a5245f64165a" title="Setup the authentication struct.">jabber_make_auth</a>(client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>, client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>, iks_find_attrib(node, <span class="stringliteral">&quot;id&quot;</span>));
<a name="l00984"></a>00984             <span class="keywordflow">if</span> (auth) {
<a name="l00985"></a>00985                iks_insert_attrib(auth, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00986"></a>00986                iks_insert_attrib(auth, <span class="stringliteral">&quot;to&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l00987"></a>00987                <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l00988"></a>00988                <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, auth);
<a name="l00989"></a>00989                iks_delete(auth);
<a name="l00990"></a>00990             } <span class="keywordflow">else</span>
<a name="l00991"></a>00991                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l00992"></a>00992          }
<a name="l00993"></a>00993          <span class="keywordflow">break</span>;
<a name="l00994"></a>00994 
<a name="l00995"></a>00995       <span class="keywordflow">case</span> IKS_NODE_NORMAL:
<a name="l00996"></a>00996 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l00997"></a>00997 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp; <a class="code" href="jabber_8h.html#ab432cc1c9f5228a80e1fe12e301a2f0f">TRY_SECURE</a>) {
<a name="l00998"></a>00998             <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;proceed&quot;</span>, iks_name(node))) {
<a name="l00999"></a>00999                <span class="keywordflow">return</span> <a class="code" href="res__jabber_8c.html#a626fb8236724be309a0d3ee3a2e979ed" title="TLS handshake, OpenSSL initialization.">aji_tls_handshake</a>(client);
<a name="l01000"></a>01000             }
<a name="l01001"></a>01001          }
<a name="l01002"></a>01002 <span class="preprocessor">#endif</span>
<a name="l01003"></a>01003 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;stream:features&quot;</span>, iks_name(node))) {
<a name="l01004"></a>01004             features = iks_stream_features(node);
<a name="l01005"></a>01005             <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a>) {
<a name="l01006"></a>01006                <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> &amp;&amp; !<a class="code" href="res__jabber_8c.html#ab521080cf1f1741b1e3fdd0ee39f5b14" title="Tests whether the connection is secured or not.">aji_is_secure</a>(client))
<a name="l01007"></a>01007                   <span class="keywordflow">break</span>;
<a name="l01008"></a>01008                <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a>) {
<a name="l01009"></a>01009                   <span class="keywordflow">if</span> (features &amp; IKS_STREAM_BIND) {
<a name="l01010"></a>01010                      iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_DONE);
<a name="l01011"></a>01011                      auth = iks_make_resource_bind(client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>);
<a name="l01012"></a>01012                      <span class="keywordflow">if</span> (auth) {
<a name="l01013"></a>01013                         iks_insert_attrib(auth, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01014"></a>01014                         <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01015"></a>01015                         <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, auth);
<a name="l01016"></a>01016                         iks_delete(auth);
<a name="l01017"></a>01017                      } <span class="keywordflow">else</span> {
<a name="l01018"></a>01018                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01019"></a>01019                         <span class="keywordflow">break</span>;
<a name="l01020"></a>01020                      }
<a name="l01021"></a>01021                   }
<a name="l01022"></a>01022                   <span class="keywordflow">if</span> (features &amp; IKS_STREAM_SESSION) {
<a name="l01023"></a>01023                      iks_filter_add_rule (client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_ID, <span class="stringliteral">&quot;auth&quot;</span>, IKS_RULE_DONE);
<a name="l01024"></a>01024                      auth = iks_make_session();
<a name="l01025"></a>01025                      <span class="keywordflow">if</span> (auth) {
<a name="l01026"></a>01026                         iks_insert_attrib(auth, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;auth&quot;</span>);
<a name="l01027"></a>01027                         <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01028"></a>01028                         <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, auth);
<a name="l01029"></a>01029                         iks_delete(auth);
<a name="l01030"></a>01030                      } <span class="keywordflow">else</span> {
<a name="l01031"></a>01031                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01032"></a>01032                      }
<a name="l01033"></a>01033                   }
<a name="l01034"></a>01034                } <span class="keywordflow">else</span> {
<a name="l01035"></a>01035                   <span class="keywordtype">int</span> ret;
<a name="l01036"></a>01036                   <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;user) {
<a name="l01037"></a>01037                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Malformed Jabber ID : %s (domain missing?)\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01038"></a>01038                      <span class="keywordflow">break</span>;
<a name="l01039"></a>01039                   }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                   ret = <a class="code" href="res__jabber_8c.html#a1b15523e274d7f26568ef5521a73e7ce" title="A wrapper function for iks_start_sasl.">aji_start_sasl</a>(client, features, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;user, client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>);
<a name="l01042"></a>01042                   <span class="keywordflow">if</span> (ret != IKS_OK) {
<a name="l01043"></a>01043                      <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01044"></a>01044                      <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01045"></a>01045                   }
<a name="l01046"></a>01046                   <span class="keywordflow">break</span>;
<a name="l01047"></a>01047                }
<a name="l01048"></a>01048             }
<a name="l01049"></a>01049          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;failure&quot;</span>, iks_name(node))) {
<a name="l01050"></a>01050             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: encryption failure. possible bad password.\n&quot;</span>);
<a name="l01051"></a>01051          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(<span class="stringliteral">&quot;success&quot;</span>, iks_name(node))) {
<a name="l01052"></a>01052             client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a> = 1;
<a name="l01053"></a>01053             <a class="code" href="res__jabber_8c.html#a21ae37866a3ab62cb29456b23c423a9c" title="Sends XMPP header to the server.">aji_send_header</a>(client, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l01054"></a>01054          }
<a name="l01055"></a>01055          <span class="keywordflow">break</span>;
<a name="l01056"></a>01056       <span class="keywordflow">case</span> IKS_NODE_ERROR: 
<a name="l01057"></a>01057             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: Node Error\n&quot;</span>);
<a name="l01058"></a>01058             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01059"></a>01059             <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01060"></a>01060             <span class="keywordflow">break</span>;
<a name="l01061"></a>01061       <span class="keywordflow">case</span> IKS_NODE_STOP: 
<a name="l01062"></a>01062             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Disconnected\n&quot;</span>);
<a name="l01063"></a>01063             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01064"></a>01064             <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01065"></a>01065             <span class="keywordflow">break</span>;
<a name="l01066"></a>01066       }
<a name="l01067"></a>01067    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> != <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a> &amp;&amp; client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) {
<a name="l01068"></a>01068       <span class="keywordflow">switch</span> (type) {
<a name="l01069"></a>01069       <span class="keywordflow">case</span> IKS_NODE_START:
<a name="l01070"></a>01070          <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>) {
<a name="l01071"></a>01071             <span class="keywordtype">char</span> <a class="code" href="chan__h323_8c.html#a67fefea55602b6c8d1e29902f600e249">secret</a>[160], shasum[320], *handshake;
<a name="l01072"></a>01072 
<a name="l01073"></a>01073             sprintf(secret, <span class="stringliteral">&quot;%s%s&quot;</span>, pak-&gt;id, client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>);
<a name="l01074"></a>01074             <a class="code" href="utils_8h.html#a89565d41a0b343afc57a1c0d9eb85160" title="Produces SHA1 hash based on input string.">ast_sha1_hash</a>(shasum, secret);
<a name="l01075"></a>01075             handshake = NULL;
<a name="l01076"></a>01076             <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;handshake, <span class="stringliteral">&quot;&lt;handshake&gt;%s&lt;/handshake&gt;&quot;</span>, shasum) &gt;= 0) {
<a name="l01077"></a>01077                <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, handshake);
<a name="l01078"></a>01078                <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(handshake);
<a name="l01079"></a>01079                handshake = NULL;
<a name="l01080"></a>01080             }
<a name="l01081"></a>01081             client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>;
<a name="l01082"></a>01082             <span class="keywordflow">if</span>(<a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741" title="Tries to receive data from the Jabber server.">aji_recv</a>(client, 1) == 2) <span class="comment">/*XXX proper result for iksemel library on iks_recv of &lt;handshake/&gt; XXX*/</span>
<a name="l01083"></a>01083                client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>;
<a name="l01084"></a>01084             <span class="keywordflow">else</span>
<a name="l01085"></a>01085                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Jabber didn&apos;t seem to handshake, failed to authenticate.\n&quot;</span>);
<a name="l01086"></a>01086             <span class="keywordflow">break</span>;
<a name="l01087"></a>01087          }
<a name="l01088"></a>01088          <span class="keywordflow">break</span>;
<a name="l01089"></a>01089 
<a name="l01090"></a>01090       <span class="keywordflow">case</span> IKS_NODE_NORMAL:
<a name="l01091"></a>01091          <span class="keywordflow">break</span>;
<a name="l01092"></a>01092 
<a name="l01093"></a>01093       <span class="keywordflow">case</span> IKS_NODE_ERROR:
<a name="l01094"></a>01094          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: Node Error\n&quot;</span>);
<a name="l01095"></a>01095          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01096"></a>01096          <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01097"></a>01097 
<a name="l01098"></a>01098       <span class="keywordflow">case</span> IKS_NODE_STOP:
<a name="l01099"></a>01099          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Disconnected\n&quot;</span>);
<a name="l01100"></a>01100          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01101"></a>01101          <span class="keywordflow">return</span> IKS_HOOK;
<a name="l01102"></a>01102       }
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    <span class="keywordflow">switch</span> (pak-&gt;type) {
<a name="l01106"></a>01106    <span class="keywordflow">case</span> IKS_PAK_NONE:
<a name="l01107"></a>01107       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: I don&apos;t know what to do with paktype NONE.\n&quot;</span>);
<a name="l01108"></a>01108       <span class="keywordflow">break</span>;
<a name="l01109"></a>01109    <span class="keywordflow">case</span> IKS_PAK_MESSAGE:
<a name="l01110"></a>01110       <a class="code" href="res__jabber_8c.html#a7a01af36e4db2dfe018982d63fda2fb2" title="Handles presence packets.">aji_handle_message</a>(client, pak);
<a name="l01111"></a>01111       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype MESSAGE.\n&quot;</span>);
<a name="l01112"></a>01112       <span class="keywordflow">break</span>;
<a name="l01113"></a>01113    <span class="keywordflow">case</span> IKS_PAK_PRESENCE:
<a name="l01114"></a>01114       <a class="code" href="res__jabber_8c.html#a163e096310bad60196f9b09b4d5169af" title="Check the presence info.">aji_handle_presence</a>(client, pak);
<a name="l01115"></a>01115       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype PRESENCE\n&quot;</span>);
<a name="l01116"></a>01116       <span class="keywordflow">break</span>;
<a name="l01117"></a>01117    <span class="keywordflow">case</span> IKS_PAK_S10N:
<a name="l01118"></a>01118       <a class="code" href="res__jabber_8c.html#ae9cccc06634afa62ab69827e3a07efb2" title="handles subscription requests.">aji_handle_subscribe</a>(client, pak);
<a name="l01119"></a>01119       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype S10N\n&quot;</span>);
<a name="l01120"></a>01120       <span class="keywordflow">break</span>;
<a name="l01121"></a>01121    <span class="keywordflow">case</span> IKS_PAK_IQ:
<a name="l01122"></a>01122       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: Handling paktype IQ\n&quot;</span>);
<a name="l01123"></a>01123       <a class="code" href="res__jabber_8c.html#ab9777927f36394dc186f89a30b222135" title="Handles.">aji_handle_iq</a>(client, node);
<a name="l01124"></a>01124       <span class="keywordflow">break</span>;
<a name="l01125"></a>01125    <span class="keywordflow">default</span>:
<a name="l01126"></a>01126       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;JABBER: I don&apos;t know anything about paktype &apos;%d&apos;\n&quot;</span>, pak-&gt;type);
<a name="l01127"></a>01127       <span class="keywordflow">break</span>;
<a name="l01128"></a>01128    }
<a name="l01129"></a>01129    
<a name="l01130"></a>01130    iks_filter_packet(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, pak);
<a name="l01131"></a>01131 
<a name="l01132"></a>01132    <span class="keywordflow">if</span> (node)
<a name="l01133"></a>01133       iks_delete(node);
<a name="l01134"></a>01134 
<a name="l01135"></a>01135    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01136"></a>01136    <span class="keywordflow">return</span> IKS_OK;
<a name="l01137"></a>01137 }<span class="comment"></span>
<a name="l01138"></a>01138 <span class="comment">/*!</span>
<a name="l01139"></a>01139 <span class="comment"> * \brief Unknown</span>
<a name="l01140"></a>01140 <span class="comment"> * \param data void</span>
<a name="l01141"></a>01141 <span class="comment"> * \param pak ikspak</span>
<a name="l01142"></a>01142 <span class="comment"> * \return IKS_FILTER_EAT.</span>
<a name="l01143"></a>01143 <span class="comment">*/</span>
<a name="l01144"></a><a class="code" href="res__jabber_8c.html#ae086e18b972394df16015895af3b0e84">01144</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ae086e18b972394df16015895af3b0e84" title="Unknown.">aji_register_approve_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l01145"></a>01145 {
<a name="l01146"></a>01146    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01147"></a>01147    iks *iq = NULL, *presence = NULL, *x = NULL;
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01150"></a>01150    presence = iks_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l01151"></a>01151    x = iks_new(<span class="stringliteral">&quot;x&quot;</span>);
<a name="l01152"></a>01152    <span class="keywordflow">if</span> (client &amp;&amp; iq &amp;&amp; presence &amp;&amp; x) {
<a name="l01153"></a>01153       <span class="keywordflow">if</span> (!iks_find(pak-&gt;query, <span class="stringliteral">&quot;remove&quot;</span>)) {
<a name="l01154"></a>01154          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01155"></a>01155          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01156"></a>01156          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01157"></a>01157          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01158"></a>01158          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01159"></a>01159 
<a name="l01160"></a>01160          iks_insert_attrib(presence, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01161"></a>01161          iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;partial);
<a name="l01162"></a>01162          iks_insert_attrib(presence, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01163"></a>01163          <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01164"></a>01164          iks_insert_attrib(presence, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;subscribe&quot;</span>);
<a name="l01165"></a>01165          iks_insert_attrib(x, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;vcard-temp:x:update&quot;</span>);
<a name="l01166"></a>01166          iks_insert_node(presence, x);
<a name="l01167"></a>01167          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence); 
<a name="l01168"></a>01168       }
<a name="l01169"></a>01169    } <span class="keywordflow">else</span> {
<a name="l01170"></a>01170       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01171"></a>01171    }
<a name="l01172"></a>01172 
<a name="l01173"></a>01173 
<a name="l01174"></a>01174    iks_delete(iq);
<a name="l01175"></a>01175    iks_delete(presence);
<a name="l01176"></a>01176    iks_delete(x);
<a name="l01177"></a>01177    
<a name="l01178"></a>01178    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01179"></a>01179    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01180"></a>01180 }<span class="comment"></span>
<a name="l01181"></a>01181 <span class="comment">/*!</span>
<a name="l01182"></a>01182 <span class="comment"> * \brief register handler for incoming querys (IQ&apos;s)</span>
<a name="l01183"></a>01183 <span class="comment"> * \param data incoming aji_client request</span>
<a name="l01184"></a>01184 <span class="comment"> * \param pak ikspak</span>
<a name="l01185"></a>01185 <span class="comment"> * \return IKS_FILTER_EAT.</span>
<a name="l01186"></a>01186 <span class="comment">*/</span>
<a name="l01187"></a><a class="code" href="res__jabber_8c.html#a82642d571c9e2cc5476d1b25c99d51cc">01187</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a82642d571c9e2cc5476d1b25c99d51cc" title="register handler for incoming querys (IQ&amp;#39;s)">aji_register_query_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l01188"></a>01188 {
<a name="l01189"></a>01189    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01190"></a>01190    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL; 
<a name="l01191"></a>01191    <span class="keywordtype">char</span> *node = NULL;
<a name="l01192"></a>01192    iks *iq = NULL, *query = NULL;
<a name="l01193"></a>01193 
<a name="l01194"></a>01194    client = (<span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *) data;
<a name="l01195"></a>01195 
<a name="l01196"></a>01196    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01197"></a>01197    <span class="keywordflow">if</span> (!buddy) {
<a name="l01198"></a>01198       iks  *error = NULL, *notacceptable = NULL;
<a name="l01199"></a>01199 
<a name="l01200"></a>01200       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Someone.... %s tried to register but they aren&apos;t allowed\n&quot;</span>, pak-&gt;from-&gt;partial);
<a name="l01201"></a>01201       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01202"></a>01202       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01203"></a>01203       error = iks_new(<span class="stringliteral">&quot;error&quot;</span>);
<a name="l01204"></a>01204       notacceptable = iks_new(<span class="stringliteral">&quot;not-acceptable&quot;</span>);
<a name="l01205"></a>01205       <span class="keywordflow">if</span>(iq &amp;&amp; query &amp;&amp; error &amp;&amp; notacceptable) {
<a name="l01206"></a>01206          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;error&quot;</span>);
<a name="l01207"></a>01207          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01208"></a>01208          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01209"></a>01209          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01210"></a>01210          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l01211"></a>01211          iks_insert_attrib(error, <span class="stringliteral">&quot;code&quot;</span> , <span class="stringliteral">&quot;406&quot;</span>);
<a name="l01212"></a>01212          iks_insert_attrib(error, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;modify&quot;</span>);
<a name="l01213"></a>01213          iks_insert_attrib(notacceptable, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;urn:ietf:params:xml:ns:xmpp-stanzas&quot;</span>);
<a name="l01214"></a>01214          iks_insert_node(iq, query);
<a name="l01215"></a>01215          iks_insert_node(iq, error);
<a name="l01216"></a>01216          iks_insert_node(error, notacceptable);
<a name="l01217"></a>01217          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01218"></a>01218       } <span class="keywordflow">else</span> {
<a name="l01219"></a>01219          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01220"></a>01220       }
<a name="l01221"></a>01221 
<a name="l01222"></a>01222       iks_delete(error);
<a name="l01223"></a>01223       iks_delete(notacceptable);
<a name="l01224"></a>01224    } <span class="keywordflow">else</span>   <span class="keywordflow">if</span> (!(node = iks_find_attrib(pak-&gt;query, <span class="stringliteral">&quot;node&quot;</span>))) {
<a name="l01225"></a>01225       iks *instructions = NULL;
<a name="l01226"></a>01226       <span class="keywordtype">char</span> *explain = <span class="stringliteral">&quot;Welcome to Asterisk - the Open Source PBX.\n&quot;</span>;
<a name="l01227"></a>01227       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01228"></a>01228       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01229"></a>01229       instructions = iks_new(<span class="stringliteral">&quot;instructions&quot;</span>);
<a name="l01230"></a>01230       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; instructions &amp;&amp; client) {
<a name="l01231"></a>01231          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01232"></a>01232          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01233"></a>01233          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01234"></a>01234          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01235"></a>01235          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l01236"></a>01236          iks_insert_cdata(instructions, explain, 0);
<a name="l01237"></a>01237          iks_insert_node(iq, query);
<a name="l01238"></a>01238          iks_insert_node(query, instructions);
<a name="l01239"></a>01239          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01240"></a>01240       } <span class="keywordflow">else</span> {
<a name="l01241"></a>01241          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244       iks_delete(instructions);
<a name="l01245"></a>01245    }
<a name="l01246"></a>01246    iks_delete(iq);
<a name="l01247"></a>01247    iks_delete(query);
<a name="l01248"></a>01248    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01249"></a>01249    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01250"></a>01250 }
<a name="l01251"></a>01251 <span class="comment"></span>
<a name="l01252"></a>01252 <span class="comment">/*!</span>
<a name="l01253"></a>01253 <span class="comment"> * \brief Handles stuff</span>
<a name="l01254"></a>01254 <span class="comment"> * \param data void</span>
<a name="l01255"></a>01255 <span class="comment"> * \param pak ikspak </span>
<a name="l01256"></a>01256 <span class="comment"> * \return IKS_FILTER_EAT.</span>
<a name="l01257"></a>01257 <span class="comment">*/</span>
<a name="l01258"></a><a class="code" href="res__jabber_8c.html#a1fa5630459ae90c51157f306d589a96c">01258</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1fa5630459ae90c51157f306d589a96c" title="Handles stuff.">aji_ditems_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l01259"></a>01259 {
<a name="l01260"></a>01260    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01261"></a>01261    <span class="keywordtype">char</span> *node = NULL;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263    <span class="keywordflow">if</span> (!(node = iks_find_attrib(pak-&gt;query, <span class="stringliteral">&quot;node&quot;</span>))) {
<a name="l01264"></a>01264       iks *iq = NULL, *query = NULL, *item = NULL;
<a name="l01265"></a>01265       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01266"></a>01266       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01267"></a>01267       item = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l01268"></a>01268 
<a name="l01269"></a>01269       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; item) {
<a name="l01270"></a>01270          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01271"></a>01271          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01272"></a>01272          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01273"></a>01273          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01274"></a>01274          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01275"></a>01275          iks_insert_attrib(item, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01276"></a>01276          iks_insert_attrib(item, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Million Dollar Asterisk Commands&quot;</span>);
<a name="l01277"></a>01277          iks_insert_attrib(item, <span class="stringliteral">&quot;jid&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01278"></a>01278 
<a name="l01279"></a>01279          iks_insert_node(iq, query);
<a name="l01280"></a>01280          iks_insert_node(query, item);
<a name="l01281"></a>01281          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01282"></a>01282       } <span class="keywordflow">else</span> {
<a name="l01283"></a>01283          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01284"></a>01284       }
<a name="l01285"></a>01285 
<a name="l01286"></a>01286       iks_delete(iq);
<a name="l01287"></a>01287       iks_delete(query);
<a name="l01288"></a>01288       iks_delete(item);
<a name="l01289"></a>01289 
<a name="l01290"></a>01290    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(node, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>)) {
<a name="l01291"></a>01291       iks *iq, *query, *confirm;
<a name="l01292"></a>01292       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01293"></a>01293       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01294"></a>01294       confirm = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l01295"></a>01295       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; confirm &amp;&amp; client) {
<a name="l01296"></a>01296          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01297"></a>01297          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01298"></a>01298          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01299"></a>01299          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01300"></a>01300          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01301"></a>01301          iks_insert_attrib(query, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01302"></a>01302          iks_insert_attrib(confirm, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;confirmaccount&quot;</span>);
<a name="l01303"></a>01303          iks_insert_attrib(confirm, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Confirm AIM account&quot;</span>);
<a name="l01304"></a>01304          iks_insert_attrib(confirm, <span class="stringliteral">&quot;jid&quot;</span>, <span class="stringliteral">&quot;blog.astjab.org&quot;</span>);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306          iks_insert_node(iq, query);
<a name="l01307"></a>01307          iks_insert_node(query, confirm);
<a name="l01308"></a>01308          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01309"></a>01309       } <span class="keywordflow">else</span> {
<a name="l01310"></a>01310          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01311"></a>01311       }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313       iks_delete(iq);
<a name="l01314"></a>01314       iks_delete(query);
<a name="l01315"></a>01315       iks_delete(confirm);
<a name="l01316"></a>01316 
<a name="l01317"></a>01317    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(node, <span class="stringliteral">&quot;confirmaccount&quot;</span>)) {
<a name="l01318"></a>01318       iks *iq = NULL, *query = NULL, *feature = NULL;
<a name="l01319"></a>01319 
<a name="l01320"></a>01320       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01321"></a>01321       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01322"></a>01322       feature = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01323"></a>01323 
<a name="l01324"></a>01324       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; feature &amp;&amp; client) {
<a name="l01325"></a>01325          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01326"></a>01326          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01327"></a>01327          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01328"></a>01328          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01329"></a>01329          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01330"></a>01330          iks_insert_attrib(feature, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01331"></a>01331          iks_insert_node(iq, query);
<a name="l01332"></a>01332          iks_insert_node(query, feature);
<a name="l01333"></a>01333          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01334"></a>01334       } <span class="keywordflow">else</span> {
<a name="l01335"></a>01335          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01336"></a>01336       }
<a name="l01337"></a>01337 
<a name="l01338"></a>01338       iks_delete(iq);
<a name="l01339"></a>01339       iks_delete(query);
<a name="l01340"></a>01340       iks_delete(feature);
<a name="l01341"></a>01341    }
<a name="l01342"></a>01342 
<a name="l01343"></a>01343    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01344"></a>01344    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01345"></a>01345 
<a name="l01346"></a>01346 }<span class="comment"></span>
<a name="l01347"></a>01347 <span class="comment">/*!</span>
<a name="l01348"></a>01348 <span class="comment"> * \brief Handle add extra info</span>
<a name="l01349"></a>01349 <span class="comment"> * \param data void</span>
<a name="l01350"></a>01350 <span class="comment"> * \param pak ikspak</span>
<a name="l01351"></a>01351 <span class="comment"> * \return IKS_FILTER_EAT</span>
<a name="l01352"></a>01352 <span class="comment">*/</span>
<a name="l01353"></a><a class="code" href="res__jabber_8c.html#a1d851da5bdfbfdd92ab5a8e80229b5d3">01353</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1d851da5bdfbfdd92ab5a8e80229b5d3" title="Handle add extra info.">aji_client_info_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l01354"></a>01354 {
<a name="l01355"></a>01355    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01356"></a>01356    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a> = NULL;
<a name="l01357"></a>01357    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    resource = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, pak-&gt;from-&gt;resource);
<a name="l01360"></a>01360    <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_RESULT) {
<a name="l01361"></a>01361       <span class="keywordflow">if</span> (!resource) {
<a name="l01362"></a>01362          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;JABBER: Received client info from %s when not requested.\n&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01363"></a>01363          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01364"></a>01364          <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01365"></a>01365       }
<a name="l01366"></a>01366       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;query, <span class="stringliteral">&quot;feature&quot;</span>, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/protocol/voice/v1&quot;</span>)) {
<a name="l01367"></a>01367          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 1;
<a name="l01368"></a>01368       } <span class="keywordflow">else</span>
<a name="l01369"></a>01369          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l01370"></a>01370    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET) {
<a name="l01371"></a>01371       iks *iq, *disco, *ident, *google, *query;
<a name="l01372"></a>01372       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01373"></a>01373       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01374"></a>01374       ident = iks_new(<span class="stringliteral">&quot;identity&quot;</span>);
<a name="l01375"></a>01375       disco = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01376"></a>01376       google = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01377"></a>01377       <span class="keywordflow">if</span> (iq &amp;&amp; ident &amp;&amp; disco &amp;&amp; google) {
<a name="l01378"></a>01378          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01379"></a>01379          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01380"></a>01380          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01381"></a>01381          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01382"></a>01382          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01383"></a>01383          iks_insert_attrib(ident, <span class="stringliteral">&quot;category&quot;</span>, <span class="stringliteral">&quot;client&quot;</span>);
<a name="l01384"></a>01384          iks_insert_attrib(ident, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;pc&quot;</span>);
<a name="l01385"></a>01385          iks_insert_attrib(ident, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;asterisk&quot;</span>);
<a name="l01386"></a>01386          iks_insert_attrib(disco, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01387"></a>01387          iks_insert_attrib(google, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/protocol/voice/v1&quot;</span>);
<a name="l01388"></a>01388          iks_insert_node(iq, query);
<a name="l01389"></a>01389          iks_insert_node(query, ident);
<a name="l01390"></a>01390          iks_insert_node(query, google);
<a name="l01391"></a>01391          iks_insert_node(query, disco);
<a name="l01392"></a>01392          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01393"></a>01393       } <span class="keywordflow">else</span>
<a name="l01394"></a>01394          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of Memory.\n&quot;</span>);
<a name="l01395"></a>01395 
<a name="l01396"></a>01396       iks_delete(iq);
<a name="l01397"></a>01397       iks_delete(query);
<a name="l01398"></a>01398       iks_delete(ident);
<a name="l01399"></a>01399       iks_delete(google);
<a name="l01400"></a>01400       iks_delete(disco);
<a name="l01401"></a>01401    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_ERROR) {
<a name="l01402"></a>01402       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;User %s does not support discovery.\n&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01403"></a>01403    }
<a name="l01404"></a>01404    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01405"></a>01405    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01406"></a>01406 }<span class="comment"></span>
<a name="l01407"></a>01407 <span class="comment">/*!</span>
<a name="l01408"></a>01408 <span class="comment"> * \brief Handler of the return info packet</span>
<a name="l01409"></a>01409 <span class="comment"> * \param data aji_client</span>
<a name="l01410"></a>01410 <span class="comment"> * \param pak ikspak</span>
<a name="l01411"></a>01411 <span class="comment"> * \return IKS_FILTER_EAT</span>
<a name="l01412"></a>01412 <span class="comment">*/</span>
<a name="l01413"></a><a class="code" href="res__jabber_8c.html#a08475a2aad43ee4b4dc1f10453547daf">01413</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a08475a2aad43ee4b4dc1f10453547daf" title="Handler of the return info packet.">aji_dinfo_handler</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l01414"></a>01414 {
<a name="l01415"></a>01415    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01416"></a>01416    <span class="keywordtype">char</span> *node = NULL;
<a name="l01417"></a>01417    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a> = NULL;
<a name="l01418"></a>01418    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01419"></a>01419 
<a name="l01420"></a>01420    resource = <a class="code" href="res__jabber_8c.html#a6628a57705b502b2c15c5c66bdc4bd67" title="Find the aji_resource we want.">aji_find_resource</a>(buddy, pak-&gt;from-&gt;resource);
<a name="l01421"></a>01421    <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_ERROR) {
<a name="l01422"></a>01422       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Received error from a client, turn on jabber debug!\n&quot;</span>);
<a name="l01423"></a>01423       <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01424"></a>01424    }
<a name="l01425"></a>01425    <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_RESULT) {
<a name="l01426"></a>01426       <span class="keywordflow">if</span> (!resource) {
<a name="l01427"></a>01427          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>,<span class="stringliteral">&quot;JABBER: Received client info from %s when not requested.\n&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01428"></a>01428          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01429"></a>01429          <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01430"></a>01430       }
<a name="l01431"></a>01431       <span class="keywordflow">if</span> (iks_find_with_attrib(pak-&gt;query, <span class="stringliteral">&quot;feature&quot;</span>, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://www.google.com/xmpp/protocol/voice/v1&quot;</span>)) {
<a name="l01432"></a>01432          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 1;
<a name="l01433"></a>01433       } <span class="keywordflow">else</span>
<a name="l01434"></a>01434          resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> = 0;
<a name="l01435"></a>01435    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET &amp;&amp; !(node = iks_find_attrib(pak-&gt;query, <span class="stringliteral">&quot;node&quot;</span>))) {
<a name="l01436"></a>01436       iks *iq, *query, *identity, *disco, *reg, *<a class="code" href="res__agi_8c.html#aaaa94f6da87a703160a7acb2fd67422d" title="AGI commands list.">commands</a>, *gateway, *<a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>, *vcard, *search;
<a name="l01437"></a>01437 
<a name="l01438"></a>01438       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01439"></a>01439       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01440"></a>01440       identity = iks_new(<span class="stringliteral">&quot;identity&quot;</span>);
<a name="l01441"></a>01441       disco = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01442"></a>01442       reg = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01443"></a>01443       commands = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01444"></a>01444       gateway = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01445"></a>01445       version = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01446"></a>01446       vcard = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01447"></a>01447       search = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; identity &amp;&amp; disco &amp;&amp; reg &amp;&amp; commands &amp;&amp; gateway &amp;&amp; version &amp;&amp; vcard &amp;&amp; search &amp;&amp; client) {
<a name="l01450"></a>01450          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01451"></a>01451          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01452"></a>01452          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01453"></a>01453          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01454"></a>01454          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01455"></a>01455          iks_insert_attrib(identity, <span class="stringliteral">&quot;category&quot;</span>, <span class="stringliteral">&quot;gateway&quot;</span>);
<a name="l01456"></a>01456          iks_insert_attrib(identity, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;pstn&quot;</span>);
<a name="l01457"></a>01457          iks_insert_attrib(identity, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Asterisk The Open Source PBX&quot;</span>);
<a name="l01458"></a>01458          iks_insert_attrib(disco, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco&quot;</span>);
<a name="l01459"></a>01459          iks_insert_attrib(reg, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l01460"></a>01460          iks_insert_attrib(commands, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01461"></a>01461          iks_insert_attrib(gateway, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:gateway&quot;</span>);
<a name="l01462"></a>01462          iks_insert_attrib(version, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:version&quot;</span>);
<a name="l01463"></a>01463          iks_insert_attrib(vcard, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;vcard-temp&quot;</span>);
<a name="l01464"></a>01464          iks_insert_attrib(search, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;jabber:iq:search&quot;</span>);
<a name="l01465"></a>01465 
<a name="l01466"></a>01466          iks_insert_node(iq, query);
<a name="l01467"></a>01467          iks_insert_node(query, identity);
<a name="l01468"></a>01468          iks_insert_node(query, disco);
<a name="l01469"></a>01469          iks_insert_node(query, reg);
<a name="l01470"></a>01470          iks_insert_node(query, commands);
<a name="l01471"></a>01471          iks_insert_node(query, gateway);
<a name="l01472"></a>01472          iks_insert_node(query, version);
<a name="l01473"></a>01473          iks_insert_node(query, vcard);
<a name="l01474"></a>01474          iks_insert_node(query, search);
<a name="l01475"></a>01475          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01476"></a>01476       } <span class="keywordflow">else</span> {
<a name="l01477"></a>01477          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01478"></a>01478       }
<a name="l01479"></a>01479 
<a name="l01480"></a>01480       iks_delete(iq);
<a name="l01481"></a>01481       iks_delete(query);
<a name="l01482"></a>01482       iks_delete(identity);
<a name="l01483"></a>01483       iks_delete(disco);
<a name="l01484"></a>01484       iks_delete(reg);
<a name="l01485"></a>01485       iks_delete(commands);
<a name="l01486"></a>01486       iks_delete(gateway);
<a name="l01487"></a>01487       iks_delete(version);
<a name="l01488"></a>01488       iks_delete(vcard);
<a name="l01489"></a>01489       iks_delete(search);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET &amp;&amp; !strcasecmp(node, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>)) {
<a name="l01492"></a>01492       iks *iq, *query, *confirm;
<a name="l01493"></a>01493       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01494"></a>01494       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01495"></a>01495       confirm = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l01496"></a>01496 
<a name="l01497"></a>01497       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; confirm &amp;&amp; client) {
<a name="l01498"></a>01498          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01499"></a>01499          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01500"></a>01500          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01501"></a>01501          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01502"></a>01502          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l01503"></a>01503          iks_insert_attrib(query, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01504"></a>01504          iks_insert_attrib(confirm, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;confirmaccount&quot;</span>);
<a name="l01505"></a>01505          iks_insert_attrib(confirm, <span class="stringliteral">&quot;name&quot;</span>, <span class="stringliteral">&quot;Confirm AIM account&quot;</span>);
<a name="l01506"></a>01506          iks_insert_attrib(confirm, <span class="stringliteral">&quot;jid&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01507"></a>01507          iks_insert_node(iq, query);
<a name="l01508"></a>01508          iks_insert_node(query, confirm);
<a name="l01509"></a>01509          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01510"></a>01510       } <span class="keywordflow">else</span> {
<a name="l01511"></a>01511          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01512"></a>01512       }
<a name="l01513"></a>01513 
<a name="l01514"></a>01514       iks_delete(iq);
<a name="l01515"></a>01515       iks_delete(query);
<a name="l01516"></a>01516       iks_delete(confirm);
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pak-&gt;subtype == IKS_TYPE_GET &amp;&amp; !strcasecmp(node, <span class="stringliteral">&quot;confirmaccount&quot;</span>)) {
<a name="l01519"></a>01519       iks *iq, *query, *feature;
<a name="l01520"></a>01520 
<a name="l01521"></a>01521       iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01522"></a>01522       query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01523"></a>01523       feature = iks_new(<span class="stringliteral">&quot;feature&quot;</span>);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525       <span class="keywordflow">if</span> (iq &amp;&amp; query &amp;&amp; feature &amp;&amp; client) {
<a name="l01526"></a>01526          iks_insert_attrib(iq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l01527"></a>01527          iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01528"></a>01528          iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01529"></a>01529          iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;result&quot;</span>);
<a name="l01530"></a>01530          iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01531"></a>01531          iks_insert_attrib(feature, <span class="stringliteral">&quot;var&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/commands&quot;</span>);
<a name="l01532"></a>01532          iks_insert_node(iq, query);
<a name="l01533"></a>01533          iks_insert_node(query, feature);
<a name="l01534"></a>01534          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01535"></a>01535       } <span class="keywordflow">else</span> {
<a name="l01536"></a>01536          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01537"></a>01537       }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539       iks_delete(iq);
<a name="l01540"></a>01540       iks_delete(query);
<a name="l01541"></a>01541       iks_delete(feature);
<a name="l01542"></a>01542    }
<a name="l01543"></a>01543 
<a name="l01544"></a>01544    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l01545"></a>01545    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l01546"></a>01546 }
<a name="l01547"></a>01547 <span class="comment"></span>
<a name="l01548"></a>01548 <span class="comment">/*!</span>
<a name="l01549"></a>01549 <span class="comment"> * \brief Handles \verbatim &lt;iq&gt; \endverbatim tags.</span>
<a name="l01550"></a>01550 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01551"></a>01551 <span class="comment"> * \param node iks </span>
<a name="l01552"></a>01552 <span class="comment"> * \return void.</span>
<a name="l01553"></a>01553 <span class="comment"> */</span>
<a name="l01554"></a><a class="code" href="res__jabber_8c.html#ab9777927f36394dc186f89a30b222135">01554</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#ab9777927f36394dc186f89a30b222135" title="Handles.">aji_handle_iq</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, iks *node)
<a name="l01555"></a>01555 {
<a name="l01556"></a>01556    <span class="comment">/*Nothing to see here */</span>
<a name="l01557"></a>01557 }
<a name="l01558"></a>01558 <span class="comment"></span>
<a name="l01559"></a>01559 <span class="comment">/*!</span>
<a name="l01560"></a>01560 <span class="comment"> * \brief Handles presence packets.</span>
<a name="l01561"></a>01561 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01562"></a>01562 <span class="comment"> * \param pak ikspak the node</span>
<a name="l01563"></a>01563 <span class="comment"> */</span>
<a name="l01564"></a><a class="code" href="res__jabber_8c.html#a7a01af36e4db2dfe018982d63fda2fb2">01564</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a7a01af36e4db2dfe018982d63fda2fb2" title="Handles presence packets.">aji_handle_message</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, ikspak *pak)
<a name="l01565"></a>01565 {
<a name="l01566"></a>01566    <span class="keyword">struct </span><a class="code" href="structaji__message.html">aji_message</a> *insert, *tmp;
<a name="l01567"></a>01567    <span class="keywordtype">int</span> flag = 0;
<a name="l01568"></a>01568    
<a name="l01569"></a>01569    <span class="keywordflow">if</span> (!(insert = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*insert))))
<a name="l01570"></a>01570       <span class="keywordflow">return</span>;
<a name="l01571"></a>01571    time(&amp;insert-&gt;<a class="code" href="structaji__message.html#aec3ba7effb2fee6e19a3a258b1749394">arrived</a>);
<a name="l01572"></a>01572    <span class="keywordflow">if</span> (iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;body&quot;</span>))
<a name="l01573"></a>01573       insert-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;body&quot;</span>));
<a name="l01574"></a>01574    <span class="keywordflow">if</span> (pak-&gt;id)
<a name="l01575"></a>01575       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(insert-&gt;<a class="code" href="structaji__message.html#a51d291314bf1da3f9ac4479963a4fadd">id</a>, pak-&gt;id, <span class="keyword">sizeof</span>(insert-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>));
<a name="l01576"></a>01576    <span class="keywordflow">if</span> (pak-&gt;from)
<a name="l01577"></a>01577       insert-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(pak-&gt;from-&gt;full);
<a name="l01578"></a>01578    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;client-&gt;messages);
<a name="l01579"></a>01579    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;client-&gt;messages, tmp, list) {
<a name="l01580"></a>01580       <span class="keywordflow">if</span> (flag) {
<a name="l01581"></a>01581          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l01582"></a>01582          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>)
<a name="l01583"></a>01583             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>);
<a name="l01584"></a>01584          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>)
<a name="l01585"></a>01585             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);
<a name="l01586"></a>01586       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (difftime(time(NULL), tmp-&gt;<a class="code" href="structaji__message.html#aec3ba7effb2fee6e19a3a258b1749394">arrived</a>) &gt;= client-&gt;<a class="code" href="structaji__client.html#afcb76ae4daf94120b9c6e8e3a8926e36">message_timeout</a>) {
<a name="l01587"></a>01587          flag = 1;
<a name="l01588"></a>01588          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l01589"></a>01589          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>)
<a name="l01590"></a>01590             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a765533dfc643627999c751f7e1514664">from</a>);
<a name="l01591"></a>01591          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>)
<a name="l01592"></a>01592             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__message.html#a0b2e8c7f76df48129f994ecc46d5c66c">message</a>);
<a name="l01593"></a>01593       }
<a name="l01594"></a>01594    }
<a name="l01595"></a>01595    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l01596"></a>01596    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;client-&gt;messages, insert, list);
<a name="l01597"></a>01597    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;client-&gt;messages);
<a name="l01598"></a>01598 }<span class="comment"></span>
<a name="l01599"></a>01599 <span class="comment">/*!</span>
<a name="l01600"></a>01600 <span class="comment"> * \brief Check the presence info</span>
<a name="l01601"></a>01601 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01602"></a>01602 <span class="comment"> * \param pak ikspak</span>
<a name="l01603"></a>01603 <span class="comment">*/</span>
<a name="l01604"></a><a class="code" href="res__jabber_8c.html#a163e096310bad60196f9b09b4d5169af">01604</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a163e096310bad60196f9b09b4d5169af" title="Check the presence info.">aji_handle_presence</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, ikspak *pak)
<a name="l01605"></a>01605 {
<a name="l01606"></a>01606    <span class="keywordtype">int</span> <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>, priority;
<a name="l01607"></a>01607    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy;
<a name="l01608"></a>01608    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *tmp = NULL, *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a> = NULL, *found = NULL;
<a name="l01609"></a>01609    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a4408245b2edc5f227220ea4f24ea0fab">ver</a>, *node, *<a class="code" href="app__externalivr_8c.html#a39aaf66c43ce14a3febf2c17aa7738d2">descrip</a>, *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>;
<a name="l01610"></a>01610    
<a name="l01611"></a>01611    <span class="keywordflow">if</span>(client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> != <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>)
<a name="l01612"></a>01612       <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(pak-&gt;from-&gt;partial, client);
<a name="l01613"></a>01613 
<a name="l01614"></a>01614    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01615"></a>01615    <span class="keywordflow">if</span> (!buddy &amp;&amp; pak-&gt;from-&gt;partial) {
<a name="l01616"></a>01616       <span class="comment">/* allow our jid to be used to log in with another resource */</span>
<a name="l01617"></a>01617       <span class="keywordflow">if</span> (!strcmp((<span class="keyword">const</span> <span class="keywordtype">char</span> *)pak-&gt;from-&gt;partial, (<span class="keyword">const</span> <span class="keywordtype">char</span> *)client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;partial))
<a name="l01618"></a>01618          <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(pak-&gt;from-&gt;partial, client);
<a name="l01619"></a>01619       <span class="keywordflow">else</span>
<a name="l01620"></a>01620          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Got presence packet from %s, someone not in our roster!!!!\n&quot;</span>, pak-&gt;from-&gt;partial);
<a name="l01621"></a>01621       <span class="keywordflow">return</span>;
<a name="l01622"></a>01622    }
<a name="l01623"></a>01623    type = iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;type&quot;</span>);
<a name="l01624"></a>01624    <span class="keywordflow">if</span>(client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> &amp;&amp; type &amp;&amp;!strcasecmp(<span class="stringliteral">&quot;probe&quot;</span>, type)) {
<a name="l01625"></a>01625       <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(client, pak-&gt;from-&gt;full, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;to&quot;</span>), client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a>, client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>);
<a name="l01626"></a>01626       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;what i was looking for \n&quot;</span>);
<a name="l01627"></a>01627    }
<a name="l01628"></a>01628    <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(buddy);
<a name="l01629"></a>01629    status = (pak-&gt;show) ? pak-&gt;show : 6;
<a name="l01630"></a>01630    priority = atoi((iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;priority&quot;</span>)) ? iks_find_cdata(pak-&gt;x, <span class="stringliteral">&quot;priority&quot;</span>) : <span class="stringliteral">&quot;0&quot;</span>);
<a name="l01631"></a>01631    tmp = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l01632"></a>01632    descrip = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(iks_find_cdata(pak-&gt;x,<span class="stringliteral">&quot;status&quot;</span>));
<a name="l01633"></a>01633 
<a name="l01634"></a>01634    <span class="keywordflow">while</span> (tmp &amp;&amp; pak-&gt;from-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>) {
<a name="l01635"></a>01635       <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>, pak-&gt;from-&gt;resource)) {
<a name="l01636"></a>01636          tmp-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a> = status;
<a name="l01637"></a>01637          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>) <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>);
<a name="l01638"></a>01638          tmp-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a> = descrip;
<a name="l01639"></a>01639          found = tmp;
<a name="l01640"></a>01640          <span class="keywordflow">if</span> (status == 6) {   <span class="comment">/* Sign off Destroy resource */</span>
<a name="l01641"></a>01641             <span class="keywordflow">if</span> (last &amp;&amp; found-&gt;next) {
<a name="l01642"></a>01642                last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01643"></a>01643             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!last) {
<a name="l01644"></a>01644                <span class="keywordflow">if</span> (found-&gt;next)
<a name="l01645"></a>01645                   buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01646"></a>01646                <span class="keywordflow">else</span>
<a name="l01647"></a>01647                   buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = NULL;
<a name="l01648"></a>01648             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!found-&gt;next) {
<a name="l01649"></a>01649                <span class="keywordflow">if</span> (last)
<a name="l01650"></a>01650                   last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = NULL;
<a name="l01651"></a>01651                <span class="keywordflow">else</span>
<a name="l01652"></a>01652                   buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = NULL;
<a name="l01653"></a>01653             }
<a name="l01654"></a>01654             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(found);
<a name="l01655"></a>01655             found = NULL;
<a name="l01656"></a>01656             <span class="keywordflow">break</span>;
<a name="l01657"></a>01657          }
<a name="l01658"></a>01658          <span class="comment">/* resource list is sorted by descending priority */</span>
<a name="l01659"></a>01659          <span class="keywordflow">if</span> (tmp-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> != priority) {
<a name="l01660"></a>01660             found-&gt;priority = priority;
<a name="l01661"></a>01661             <span class="keywordflow">if</span> (!last &amp;&amp; !found-&gt;next)
<a name="l01662"></a>01662                <span class="comment">/* resource was found to be unique,</span>
<a name="l01663"></a>01663 <span class="comment">                  leave loop */</span>
<a name="l01664"></a>01664                <span class="keywordflow">break</span>;
<a name="l01665"></a>01665             <span class="comment">/* search for resource in our list</span>
<a name="l01666"></a>01666 <span class="comment">               and take it out for the moment */</span>
<a name="l01667"></a>01667             <span class="keywordflow">if</span> (last)
<a name="l01668"></a>01668                last-&gt;next = found-&gt;next;
<a name="l01669"></a>01669             <span class="keywordflow">else</span>
<a name="l01670"></a>01670                buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01671"></a>01671 
<a name="l01672"></a>01672             last = NULL;
<a name="l01673"></a>01673             tmp = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l01674"></a>01674             <span class="keywordflow">if</span> (!buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>)
<a name="l01675"></a>01675                buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01676"></a>01676             <span class="comment">/* priority processing */</span>
<a name="l01677"></a>01677             <span class="keywordflow">while</span> (tmp) {
<a name="l01678"></a>01678                <span class="comment">/* insert resource back according to </span>
<a name="l01679"></a>01679 <span class="comment">                  its priority value */</span>
<a name="l01680"></a>01680                <span class="keywordflow">if</span> (found-&gt;priority &gt; tmp-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) {
<a name="l01681"></a>01681                   <span class="keywordflow">if</span> (last)
<a name="l01682"></a>01682                      <span class="comment">/* insert within list */</span>
<a name="l01683"></a>01683                      last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01684"></a>01684                   found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = tmp;
<a name="l01685"></a>01685                   <span class="keywordflow">if</span> (!last)
<a name="l01686"></a>01686                      <span class="comment">/* insert on top */</span>
<a name="l01687"></a>01687                      buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01688"></a>01688                   <span class="keywordflow">break</span>;
<a name="l01689"></a>01689                }
<a name="l01690"></a>01690                <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l01691"></a>01691                   <span class="comment">/* insert at the end of the list */</span>
<a name="l01692"></a>01692                   tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01693"></a>01693                   found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = NULL;
<a name="l01694"></a>01694                   <span class="keywordflow">break</span>;
<a name="l01695"></a>01695                }
<a name="l01696"></a>01696                last = tmp;
<a name="l01697"></a>01697                tmp = tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01698"></a>01698             }
<a name="l01699"></a>01699          }
<a name="l01700"></a>01700          <span class="keywordflow">break</span>;
<a name="l01701"></a>01701       }
<a name="l01702"></a>01702       last = tmp;
<a name="l01703"></a>01703       tmp = tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01704"></a>01704    }
<a name="l01705"></a>01705 
<a name="l01706"></a>01706    <span class="comment">/* resource not found in our list, create it */</span>
<a name="l01707"></a>01707    <span class="keywordflow">if</span> (!found &amp;&amp; status != 6 &amp;&amp; pak-&gt;from-&gt;resource) {
<a name="l01708"></a>01708       found = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*found));
<a name="l01709"></a>01709 
<a name="l01710"></a>01710       <span class="keywordflow">if</span> (!found) {
<a name="l01711"></a>01711          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l01712"></a>01712          <span class="keywordflow">return</span>;
<a name="l01713"></a>01713       }
<a name="l01714"></a>01714       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(found-&gt;resource, pak-&gt;from-&gt;resource, <span class="keyword">sizeof</span>(found-&gt;resource));
<a name="l01715"></a>01715       found-&gt;status = status;
<a name="l01716"></a>01716       found-&gt;description = descrip;
<a name="l01717"></a>01717       found-&gt;priority = priority;
<a name="l01718"></a>01718       found-&gt;next = NULL;
<a name="l01719"></a>01719       last = NULL;
<a name="l01720"></a>01720       tmp = buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a>;
<a name="l01721"></a>01721       <span class="keywordflow">while</span> (tmp) {
<a name="l01722"></a>01722          <span class="keywordflow">if</span> (found-&gt;priority &gt; tmp-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>) {
<a name="l01723"></a>01723             <span class="keywordflow">if</span> (last)
<a name="l01724"></a>01724                last-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01725"></a>01725             found-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = tmp;
<a name="l01726"></a>01726             <span class="keywordflow">if</span> (!last)
<a name="l01727"></a>01727                buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01728"></a>01728             <span class="keywordflow">break</span>;
<a name="l01729"></a>01729          }
<a name="l01730"></a>01730          <span class="keywordflow">if</span> (!tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l01731"></a>01731             tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a> = found;
<a name="l01732"></a>01732             <span class="keywordflow">break</span>;
<a name="l01733"></a>01733          }
<a name="l01734"></a>01734          last = tmp;
<a name="l01735"></a>01735          tmp = tmp-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>;
<a name="l01736"></a>01736       }
<a name="l01737"></a>01737       <span class="keywordflow">if</span> (!tmp)
<a name="l01738"></a>01738          buddy-&gt;<a class="code" href="structaji__buddy.html#aae15cbeb57008429de5584b554e98940">resources</a> = found;
<a name="l01739"></a>01739    }
<a name="l01740"></a>01740    
<a name="l01741"></a>01741    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(buddy);
<a name="l01742"></a>01742    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(buddy, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l01743"></a>01743 
<a name="l01744"></a>01744    node = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;c&quot;</span>), <span class="stringliteral">&quot;node&quot;</span>);
<a name="l01745"></a>01745    ver = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;c&quot;</span>), <span class="stringliteral">&quot;ver&quot;</span>);
<a name="l01746"></a>01746 
<a name="l01747"></a>01747    <span class="comment">/* handle gmail client&apos;s special caps:c tag */</span>
<a name="l01748"></a>01748    <span class="keywordflow">if</span> (!node &amp;&amp; !ver) {
<a name="l01749"></a>01749       node = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;caps:c&quot;</span>), <span class="stringliteral">&quot;node&quot;</span>);
<a name="l01750"></a>01750       ver = iks_find_attrib(iks_find(pak-&gt;x, <span class="stringliteral">&quot;caps:c&quot;</span>), <span class="stringliteral">&quot;ver&quot;</span>);
<a name="l01751"></a>01751    }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753    <span class="comment">/* retrieve capabilites of the new resource */</span>
<a name="l01754"></a>01754    <span class="keywordflow">if</span>(status !=6 &amp;&amp; found &amp;&amp; !found-&gt;cap) {
<a name="l01755"></a>01755       found-&gt;cap = <a class="code" href="res__jabber_8c.html#a26b7d6d55f963dbca6e3694d053273d5" title="Find version in XML stream and populate our capabilities list.">aji_find_version</a>(node, ver, pak);
<a name="l01756"></a>01756       <span class="keywordflow">if</span>(<a class="code" href="res__jabber_8c.html#ad006b2b4ce6bbe60f32b13b3e430affb" title="Jabber GTalk function.">gtalk_yuck</a>(pak-&gt;x)) <span class="comment">/* gtalk should do discover */</span>
<a name="l01757"></a>01757          found-&gt;cap-&gt;jingle = 1;
<a name="l01758"></a>01758       <span class="keywordflow">if</span>(found-&gt;cap-&gt;jingle &amp;&amp; <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 4) {
<a name="l01759"></a>01759          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Special case for google till they support discover.\n&quot;</span>);
<a name="l01760"></a>01760       }
<a name="l01761"></a>01761       <span class="keywordflow">else</span> {
<a name="l01762"></a>01762          iks *iq, *query;
<a name="l01763"></a>01763          iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01764"></a>01764          query = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l01765"></a>01765          <span class="keywordflow">if</span>(query &amp;&amp; iq)  {
<a name="l01766"></a>01766             iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;get&quot;</span>);
<a name="l01767"></a>01767             iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01768"></a>01768             iks_insert_attrib(iq,<span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01769"></a>01769             iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01770"></a>01770             <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01771"></a>01771             iks_insert_attrib(query, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>);
<a name="l01772"></a>01772             iks_insert_node(iq, query);
<a name="l01773"></a>01773             <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01774"></a>01774             
<a name="l01775"></a>01775          } <span class="keywordflow">else</span>
<a name="l01776"></a>01776             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01777"></a>01777          
<a name="l01778"></a>01778          iks_delete(query);
<a name="l01779"></a>01779          iks_delete(iq);
<a name="l01780"></a>01780       }
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782    <span class="keywordflow">switch</span> (pak-&gt;subtype) {
<a name="l01783"></a>01783    <span class="keywordflow">case</span> IKS_TYPE_AVAILABLE:
<a name="l01784"></a>01784       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: I am available ^_* %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01785"></a>01785       <span class="keywordflow">break</span>;
<a name="l01786"></a>01786    <span class="keywordflow">case</span> IKS_TYPE_UNAVAILABLE:
<a name="l01787"></a>01787       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: I am unavailable ^_* %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01788"></a>01788       <span class="keywordflow">break</span>;
<a name="l01789"></a>01789    <span class="keywordflow">default</span>:
<a name="l01790"></a>01790       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Ohh sexy and the wrong type: %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01791"></a>01791    }
<a name="l01792"></a>01792    <span class="keywordflow">switch</span> (pak-&gt;show) {
<a name="l01793"></a>01793    <span class="keywordflow">case</span> IKS_SHOW_UNAVAILABLE:
<a name="l01794"></a>01794       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01795"></a>01795       <span class="keywordflow">break</span>;
<a name="l01796"></a>01796    <span class="keywordflow">case</span> IKS_SHOW_AVAILABLE:
<a name="l01797"></a>01797       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type is available\n&quot;</span>);
<a name="l01798"></a>01798       <span class="keywordflow">break</span>;
<a name="l01799"></a>01799    <span class="keywordflow">case</span> IKS_SHOW_CHAT:
<a name="l01800"></a>01800       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01801"></a>01801       <span class="keywordflow">break</span>;
<a name="l01802"></a>01802    <span class="keywordflow">case</span> IKS_SHOW_AWAY:
<a name="l01803"></a>01803       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type is away\n&quot;</span>);
<a name="l01804"></a>01804       <span class="keywordflow">break</span>;
<a name="l01805"></a>01805    <span class="keywordflow">case</span> IKS_SHOW_XA:
<a name="l01806"></a>01806       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01807"></a>01807       <span class="keywordflow">break</span>;
<a name="l01808"></a>01808    <span class="keywordflow">case</span> IKS_SHOW_DND:
<a name="l01809"></a>01809       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: type: %i subtype %i\n&quot;</span>, pak-&gt;subtype, pak-&gt;show);
<a name="l01810"></a>01810       <span class="keywordflow">break</span>;
<a name="l01811"></a>01811    <span class="keywordflow">default</span>:
<a name="l01812"></a>01812       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Kinky! how did that happen %i\n&quot;</span>, pak-&gt;show);
<a name="l01813"></a>01813    }
<a name="l01814"></a>01814 }
<a name="l01815"></a>01815 <span class="comment"></span>
<a name="l01816"></a>01816 <span class="comment">/*!</span>
<a name="l01817"></a>01817 <span class="comment"> * \brief handles subscription requests.</span>
<a name="l01818"></a>01818 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01819"></a>01819 <span class="comment"> * \param pak ikspak iksemel packet.</span>
<a name="l01820"></a>01820 <span class="comment"> * \return void.</span>
<a name="l01821"></a>01821 <span class="comment"> */</span>
<a name="l01822"></a><a class="code" href="res__jabber_8c.html#ae9cccc06634afa62ab69827e3a07efb2">01822</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#ae9cccc06634afa62ab69827e3a07efb2" title="handles subscription requests.">aji_handle_subscribe</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, ikspak *pak)
<a name="l01823"></a>01823 {
<a name="l01824"></a>01824    iks *presence = NULL, *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a> = NULL;
<a name="l01825"></a>01825    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a>* buddy = NULL;
<a name="l01826"></a>01826 
<a name="l01827"></a>01827    <span class="keywordflow">switch</span> (pak-&gt;subtype) { 
<a name="l01828"></a>01828    <span class="keywordflow">case</span> IKS_TYPE_SUBSCRIBE:
<a name="l01829"></a>01829       presence = iks_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l01830"></a>01830       status = iks_new(<span class="stringliteral">&quot;status&quot;</span>);
<a name="l01831"></a>01831       <span class="keywordflow">if</span> (presence &amp;&amp; status) {
<a name="l01832"></a>01832          iks_insert_attrib(presence, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;subscribed&quot;</span>);
<a name="l01833"></a>01833          iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, pak-&gt;from-&gt;full);
<a name="l01834"></a>01834          iks_insert_attrib(presence, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01835"></a>01835          <span class="keywordflow">if</span> (pak-&gt;id)
<a name="l01836"></a>01836             iks_insert_attrib(presence, <span class="stringliteral">&quot;id&quot;</span>, pak-&gt;id);
<a name="l01837"></a>01837          iks_insert_cdata(status, <span class="stringliteral">&quot;Asterisk has approved subscription&quot;</span>, 0);
<a name="l01838"></a>01838          iks_insert_node(presence, status);
<a name="l01839"></a>01839          <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l01840"></a>01840       } <span class="keywordflow">else</span>
<a name="l01841"></a>01841          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate nodes\n&quot;</span>);
<a name="l01842"></a>01842 
<a name="l01843"></a>01843       iks_delete(presence);
<a name="l01844"></a>01844       iks_delete(status);
<a name="l01845"></a>01845 
<a name="l01846"></a>01846       <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>)
<a name="l01847"></a>01847          <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(client, pak-&gt;from-&gt;full, iks_find_attrib(pak-&gt;x, <span class="stringliteral">&quot;to&quot;</span>), client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a>, client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>);
<a name="l01848"></a>01848    <span class="keywordflow">case</span> IKS_TYPE_SUBSCRIBED:
<a name="l01849"></a>01849       buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, pak-&gt;from-&gt;partial);
<a name="l01850"></a>01850       <span class="keywordflow">if</span> (!buddy &amp;&amp; pak-&gt;from-&gt;partial) {
<a name="l01851"></a>01851          <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(pak-&gt;from-&gt;partial, client);
<a name="l01852"></a>01852       }
<a name="l01853"></a>01853    <span class="keywordflow">default</span>:
<a name="l01854"></a>01854       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 4) {
<a name="l01855"></a>01855          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;JABBER: This is a subcription of type %i\n&quot;</span>, pak-&gt;subtype);
<a name="l01856"></a>01856       }
<a name="l01857"></a>01857    }
<a name="l01858"></a>01858 }
<a name="l01859"></a>01859 <span class="comment"></span>
<a name="l01860"></a>01860 <span class="comment">/*!</span>
<a name="l01861"></a>01861 <span class="comment"> * \brief sends messages.</span>
<a name="l01862"></a>01862 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01863"></a>01863 <span class="comment"> * \param address</span>
<a name="l01864"></a>01864 <span class="comment"> * \param message</span>
<a name="l01865"></a>01865 <span class="comment"> * \return 1.</span>
<a name="l01866"></a>01866 <span class="comment"> */</span>
<a name="l01867"></a><a class="code" href="res__jabber_8c.html#af2b674ed94b89a5798fe22714a44f046">01867</a> <span class="keywordtype">int</span> <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keyword">const</span> <span class="keywordtype">char</span> *address, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmessage.html">message</a>)
<a name="l01868"></a>01868 {
<a name="l01869"></a>01869    <span class="keywordtype">int</span> res = 0;
<a name="l01870"></a>01870    iks *message_packet = NULL;
<a name="l01871"></a>01871    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>) {
<a name="l01872"></a>01872       message_packet = iks_make_msg(IKS_TYPE_CHAT, address, message);
<a name="l01873"></a>01873       <span class="keywordflow">if</span> (message_packet) {
<a name="l01874"></a>01874          iks_insert_attrib(message_packet, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full);
<a name="l01875"></a>01875          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, message_packet);
<a name="l01876"></a>01876       } <span class="keywordflow">else</span> {
<a name="l01877"></a>01877          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01878"></a>01878       }
<a name="l01879"></a>01879 
<a name="l01880"></a>01880       iks_delete(message_packet);
<a name="l01881"></a>01881    } <span class="keywordflow">else</span>
<a name="l01882"></a>01882       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Not connected can&apos;t send\n&quot;</span>);
<a name="l01883"></a>01883    <span class="keywordflow">return</span> 1;
<a name="l01884"></a>01884 }
<a name="l01885"></a>01885 <span class="comment"></span>
<a name="l01886"></a>01886 <span class="comment">/*!</span>
<a name="l01887"></a>01887 <span class="comment"> * \brief create a chatroom.</span>
<a name="l01888"></a>01888 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01889"></a>01889 <span class="comment"> * \param room name of room</span>
<a name="l01890"></a>01890 <span class="comment"> * \param server name of server</span>
<a name="l01891"></a>01891 <span class="comment"> * \param topic topic for the room.</span>
<a name="l01892"></a>01892 <span class="comment"> * \return 0.</span>
<a name="l01893"></a>01893 <span class="comment"> */</span>
<a name="l01894"></a><a class="code" href="res__jabber_8c.html#a8ce87df2b2878a7384640e3720ba1c2c">01894</a> <span class="keywordtype">int</span> <a class="code" href="jabber_8h.html#a8ce87df2b2878a7384640e3720ba1c2c" title="create a chatroom.">ast_aji_create_chat</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *room, <span class="keywordtype">char</span> *server, <span class="keywordtype">char</span> *topic)
<a name="l01895"></a>01895 {
<a name="l01896"></a>01896    <span class="keywordtype">int</span> res = 0;
<a name="l01897"></a>01897    iks *iq = NULL;
<a name="l01898"></a>01898    iq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l01899"></a>01899 
<a name="l01900"></a>01900    <span class="keywordflow">if</span> (iq &amp;&amp; client) {
<a name="l01901"></a>01901       iks_insert_attrib(iq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;get&quot;</span>);
<a name="l01902"></a>01902       iks_insert_attrib(iq, <span class="stringliteral">&quot;to&quot;</span>, server);
<a name="l01903"></a>01903       iks_insert_attrib(iq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01904"></a>01904       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01905"></a>01905       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iq);
<a name="l01906"></a>01906    } <span class="keywordflow">else</span> 
<a name="l01907"></a>01907       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01908"></a>01908 
<a name="l01909"></a>01909    iks_delete(iq);
<a name="l01910"></a>01910 
<a name="l01911"></a>01911    <span class="keywordflow">return</span> res;
<a name="l01912"></a>01912 }
<a name="l01913"></a>01913 <span class="comment"></span>
<a name="l01914"></a>01914 <span class="comment">/*!</span>
<a name="l01915"></a>01915 <span class="comment"> * \brief join a chatroom.</span>
<a name="l01916"></a>01916 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01917"></a>01917 <span class="comment"> * \param room room to join</span>
<a name="l01918"></a>01918 <span class="comment"> * \return res.</span>
<a name="l01919"></a>01919 <span class="comment"> */</span>
<a name="l01920"></a><a class="code" href="res__jabber_8c.html#aad4fd8a9604fb1d017882c76511c36f7">01920</a> <span class="keywordtype">int</span> <a class="code" href="jabber_8h.html#aad4fd8a9604fb1d017882c76511c36f7" title="join a chatroom.">ast_aji_join_chat</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *room)
<a name="l01921"></a>01921 {
<a name="l01922"></a>01922    <span class="keywordtype">int</span> res = 0;
<a name="l01923"></a>01923    iks *presence = NULL, *priority = NULL;
<a name="l01924"></a>01924    presence = iks_new(<span class="stringliteral">&quot;presence&quot;</span>);
<a name="l01925"></a>01925    priority = iks_new(<span class="stringliteral">&quot;priority&quot;</span>);
<a name="l01926"></a>01926    <span class="keywordflow">if</span> (presence &amp;&amp; priority &amp;&amp; client) {
<a name="l01927"></a>01927       iks_insert_cdata(priority, <span class="stringliteral">&quot;0&quot;</span>, 1);
<a name="l01928"></a>01928       iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, room);
<a name="l01929"></a>01929       iks_insert_node(presence, priority);
<a name="l01930"></a>01930       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l01931"></a>01931       iks_insert_cdata(priority, <span class="stringliteral">&quot;5&quot;</span>, 1);
<a name="l01932"></a>01932       iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, room);
<a name="l01933"></a>01933       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l01934"></a>01934    } <span class="keywordflow">else</span> 
<a name="l01935"></a>01935       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01936"></a>01936    
<a name="l01937"></a>01937    iks_delete(presence);
<a name="l01938"></a>01938    iks_delete(priority);
<a name="l01939"></a>01939    
<a name="l01940"></a>01940    <span class="keywordflow">return</span> res;
<a name="l01941"></a>01941 }
<a name="l01942"></a>01942 <span class="comment"></span>
<a name="l01943"></a>01943 <span class="comment">/*!</span>
<a name="l01944"></a>01944 <span class="comment"> * \brief invite to a chatroom.</span>
<a name="l01945"></a>01945 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l01946"></a>01946 <span class="comment"> * \param user </span>
<a name="l01947"></a>01947 <span class="comment"> * \param room</span>
<a name="l01948"></a>01948 <span class="comment"> * \param message</span>
<a name="l01949"></a>01949 <span class="comment"> * \return res.</span>
<a name="l01950"></a>01950 <span class="comment"> */</span>
<a name="l01951"></a><a class="code" href="res__jabber_8c.html#a0fe274254c01bee899843b9057929abe">01951</a> <span class="keywordtype">int</span> <a class="code" href="jabber_8h.html#a0fe274254c01bee899843b9057929abe" title="invite to a chatroom.">ast_aji_invite_chat</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">char</span> *room, <span class="keywordtype">char</span> *<a class="code" href="structmessage.html">message</a>)
<a name="l01952"></a>01952 {
<a name="l01953"></a>01953    <span class="keywordtype">int</span> res = 0;
<a name="l01954"></a>01954    iks *invite, *body, *<span class="keyword">namespace</span>;
<a name="l01955"></a>01955 
<a name="l01956"></a>01956    invite = iks_new(<span class="stringliteral">&quot;message&quot;</span>);
<a name="l01957"></a>01957    body = iks_new(<span class="stringliteral">&quot;body&quot;</span>);
<a name="l01958"></a>01958    <span class="keyword">namespace </span>= iks_new(&quot;x&quot;);
<a name="l01959"></a>01959    <span class="keywordflow">if</span> (client &amp;&amp; invite &amp;&amp; body &amp;&amp; <span class="keyword">namespace</span>) {
<a name="l01960"></a>01960       iks_insert_attrib(invite, <span class="stringliteral">&quot;to&quot;</span>, user);
<a name="l01961"></a>01961       iks_insert_attrib(invite, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01962"></a>01962       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l01963"></a>01963       iks_insert_cdata(body, message, 0);
<a name="l01964"></a>01964       iks_insert_attrib(<span class="keyword">namespace</span>, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:x:conference&quot;</span>);
<a name="l01965"></a>01965       iks_insert_attrib(<span class="keyword">namespace</span>, <span class="stringliteral">&quot;jid&quot;</span>, room);
<a name="l01966"></a>01966       iks_insert_node(invite, body);
<a name="l01967"></a>01967       iks_insert_node(invite, <span class="keyword">namespace</span>);
<a name="l01968"></a>01968       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, invite);
<a name="l01969"></a>01969    } <span class="keywordflow">else</span> 
<a name="l01970"></a>01970       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l01971"></a>01971 
<a name="l01972"></a>01972    iks_delete(body);
<a name="l01973"></a>01973    iks_delete(<span class="keyword">namespace</span>);
<a name="l01974"></a>01974    iks_delete(invite);
<a name="l01975"></a>01975    
<a name="l01976"></a>01976    <span class="keywordflow">return</span> res;
<a name="l01977"></a>01977 }
<a name="l01978"></a>01978 
<a name="l01979"></a>01979 <span class="comment"></span>
<a name="l01980"></a>01980 <span class="comment">/*!</span>
<a name="l01981"></a>01981 <span class="comment"> * \brief receive message loop.</span>
<a name="l01982"></a>01982 <span class="comment"> * \param data void</span>
<a name="l01983"></a>01983 <span class="comment"> * \return void.</span>
<a name="l01984"></a>01984 <span class="comment"> */</span>
<a name="l01985"></a><a class="code" href="res__jabber_8c.html#a29f749367c5d39d4eb02841f70a07006">01985</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="res__jabber_8c.html#a29f749367c5d39d4eb02841f70a07006" title="receive message loop.">aji_recv_loop</a>(<span class="keywordtype">void</span> *data)
<a name="l01986"></a>01986 {
<a name="l01987"></a>01987    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l01988"></a>01988    <span class="keywordtype">int</span> res = IKS_HOOK;
<a name="l01989"></a>01989 
<a name="l01990"></a>01990    <span class="keywordflow">while</span>(res != IKS_OK) {
<a name="l01991"></a>01991       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Connecting.\n&quot;</span>);
<a name="l01992"></a>01992       res = <a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250" title="reconnect to jabber server">aji_reconnect</a>(client);
<a name="l01993"></a>01993       sleep(4);
<a name="l01994"></a>01994    }
<a name="l01995"></a>01995 
<a name="l01996"></a>01996    <span class="keywordflow">do</span> {
<a name="l01997"></a>01997       <span class="keywordflow">if</span> (res == IKS_NET_RWERR || client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> == 0) {
<a name="l01998"></a>01998          <span class="keywordflow">while</span>(res != IKS_OK) {
<a name="l01999"></a>01999             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: reconnecting.\n&quot;</span>);
<a name="l02000"></a>02000             res = <a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250" title="reconnect to jabber server">aji_reconnect</a>(client);
<a name="l02001"></a>02001             sleep(4);
<a name="l02002"></a>02002          }
<a name="l02003"></a>02003       }
<a name="l02004"></a>02004 
<a name="l02005"></a>02005       res = <a class="code" href="res__jabber_8c.html#a94ce06e757ee266951a03520fa126741" title="Tries to receive data from the Jabber server.">aji_recv</a>(client, 1);
<a name="l02006"></a>02006       
<a name="l02007"></a>02007       <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a9f2e9be855a781b74badbe0c1bda278e">AJI_DISCONNECTING</a>) {
<a name="l02008"></a>02008          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Ending our Jabber client&apos;s thread due to a disconnect\n&quot;</span>);
<a name="l02009"></a>02009          pthread_exit(NULL);
<a name="l02010"></a>02010       }
<a name="l02011"></a>02011 
<a name="l02012"></a>02012       <span class="comment">/* Decrease timeout if no data received */</span>
<a name="l02013"></a>02013       <span class="keywordflow">if</span> (res == <a class="code" href="jabber_8h.html#a99fa4c2cecd405f4430c8d137af93db9">IKS_NET_EXPIRED</a>)
<a name="l02014"></a>02014          client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>--;
<a name="l02015"></a>02015 
<a name="l02016"></a>02016       <span class="keywordflow">if</span> (res == IKS_HOOK) 
<a name="l02017"></a>02017          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: Got hook event.\n&quot;</span>);
<a name="l02018"></a>02018       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == IKS_NET_TLSFAIL)
<a name="l02019"></a>02019          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER:  Failure in TLS.\n&quot;</span>);
<a name="l02020"></a>02020       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> == 0 &amp;&amp; client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>) {
<a name="l02021"></a>02021          res = client-&gt;<a class="code" href="structaji__client.html#ae314c4b48027be9feab52906b6313b73">keepalive</a> ? <a class="code" href="res__jabber_8c.html#a265a12987d4ab3483e7cd733f03ca1d6" title="Sends an XML string over an XMPP connection.">aji_send_raw</a>(client, <span class="stringliteral">&quot; &quot;</span>) : IKS_OK;
<a name="l02022"></a>02022          <span class="keywordflow">if</span>(res == IKS_OK)
<a name="l02023"></a>02023             client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = 50;
<a name="l02024"></a>02024          <span class="keywordflow">else</span>
<a name="l02025"></a>02025             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER:  Network Timeout\n&quot;</span>);
<a name="l02026"></a>02026       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == IKS_NET_RWERR)
<a name="l02027"></a>02027          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;JABBER: socket read error\n&quot;</span>);
<a name="l02028"></a>02028    } <span class="keywordflow">while</span> (client);
<a name="l02029"></a>02029    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02030"></a>02030    <span class="keywordflow">return</span> 0;
<a name="l02031"></a>02031 }
<a name="l02032"></a>02032 <span class="comment"></span>
<a name="l02033"></a>02033 <span class="comment">/*!</span>
<a name="l02034"></a>02034 <span class="comment"> * \brief increments the mid field for messages and other events.</span>
<a name="l02035"></a>02035 <span class="comment"> * \param mid char.</span>
<a name="l02036"></a>02036 <span class="comment"> * \return void.</span>
<a name="l02037"></a>02037 <span class="comment"> */</span>
<a name="l02038"></a><a class="code" href="res__jabber_8c.html#a6e4ae95e74b73933aa6e6d6817df9023">02038</a> <span class="keywordtype">void</span> <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(<span class="keywordtype">char</span> *<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>)
<a name="l02039"></a>02039 {
<a name="l02040"></a>02040    <span class="keywordtype">int</span> i = 0;
<a name="l02041"></a>02041 
<a name="l02042"></a>02042    <span class="keywordflow">for</span> (i = strlen(mid) - 1; i &gt;= 0; i--) {
<a name="l02043"></a>02043       <span class="keywordflow">if</span> (mid[i] != <span class="charliteral">&apos;z&apos;</span>) {
<a name="l02044"></a>02044          mid[i] = mid[i] + 1;
<a name="l02045"></a>02045          i = 0;
<a name="l02046"></a>02046       } <span class="keywordflow">else</span>
<a name="l02047"></a>02047          mid[i] = <span class="charliteral">&apos;a&apos;</span>;
<a name="l02048"></a>02048    }
<a name="l02049"></a>02049 }
<a name="l02050"></a>02050 
<a name="l02051"></a>02051 <span class="preprocessor">#if 0</span>
<a name="l02052"></a>02052 <span class="preprocessor"></span><span class="comment">/*!</span>
<a name="l02053"></a>02053 <span class="comment"> * \brief attempts to register to a transport.</span>
<a name="l02054"></a>02054 <span class="comment"> * \param aji_client struct, and xml packet.</span>
<a name="l02055"></a>02055 <span class="comment"> * \return IKS_FILTER_EAT.</span>
<a name="l02056"></a>02056 <span class="comment"> */</span>
<a name="l02057"></a>02057 <span class="comment">/*allows for registering to transport , was too sketch and is out for now. */</span>
<a name="l02058"></a>02058 <span class="keyword">static</span> <span class="keywordtype">int</span> aji_register_transport(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l02059"></a>02059 {
<a name="l02060"></a>02060    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l02061"></a>02061    <span class="keywordtype">int</span> res = 0;
<a name="l02062"></a>02062    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l02063"></a>02063    iks *send = iks_make_iq(IKS_TYPE_GET, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l02064"></a>02064 
<a name="l02065"></a>02065    <span class="keywordflow">if</span> (client &amp;&amp; send) {
<a name="l02066"></a>02066       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02067"></a>02067          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator); 
<a name="l02068"></a>02068          <span class="keywordflow">if</span> (iterator-&gt;btype == <a class="code" href="jabber_8h.html#a43544c485b6512baca1e632939f8d573a6575b0c35092c8561693bf083674147a">AJI_TRANS</a>) {
<a name="l02069"></a>02069               buddy = iterator;
<a name="l02070"></a>02070          }
<a name="l02071"></a>02071          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02072"></a>02072       });
<a name="l02073"></a>02073       iks_filter_remove_hook(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, aji_register_transport);
<a name="l02074"></a>02074       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, aji_register_transport2, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_NS, IKS_NS_REGISTER, IKS_RULE_DONE);
<a name="l02075"></a>02075       iks_insert_attrib(send, <span class="stringliteral">&quot;to&quot;</span>, buddy-&gt;host);
<a name="l02076"></a>02076       iks_insert_attrib(send, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l02077"></a>02077       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l02078"></a>02078       iks_insert_attrib(send, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l02079"></a>02079       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, send);
<a name="l02080"></a>02080    } <span class="keywordflow">else</span> 
<a name="l02081"></a>02081       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02082"></a>02082 
<a name="l02083"></a>02083    <span class="keywordflow">if</span> (send)
<a name="l02084"></a>02084       iks_delete(send);
<a name="l02085"></a>02085    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02086"></a>02086    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l02087"></a>02087 
<a name="l02088"></a>02088 }<span class="comment"></span>
<a name="l02089"></a>02089 <span class="comment">/*!</span>
<a name="l02090"></a>02090 <span class="comment"> * \brief attempts to register to a transport step 2.</span>
<a name="l02091"></a>02091 <span class="comment"> * \param aji_client struct, and xml packet.</span>
<a name="l02092"></a>02092 <span class="comment"> * \return IKS_FILTER_EAT.</span>
<a name="l02093"></a>02093 <span class="comment"> */</span>
<a name="l02094"></a>02094 <span class="comment">/* more of the same blob of code, too wonky for now*/</span>
<a name="l02095"></a>02095 <span class="keyword">static</span> <span class="keywordtype">int</span> aji_register_transport2(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l02096"></a>02096 {
<a name="l02097"></a>02097    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l02098"></a>02098    <span class="keywordtype">int</span> res = 0;
<a name="l02099"></a>02099    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l02100"></a>02100 
<a name="l02101"></a>02101    iks *regiq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l02102"></a>02102    iks *regquery = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l02103"></a>02103    iks *reguser = iks_new(<span class="stringliteral">&quot;username&quot;</span>);
<a name="l02104"></a>02104    iks *regpass = iks_new(<span class="stringliteral">&quot;password&quot;</span>);
<a name="l02105"></a>02105 
<a name="l02106"></a>02106    <span class="keywordflow">if</span> (client &amp;&amp; regquery &amp;&amp; reguser &amp;&amp; regpass &amp;&amp; regiq) {
<a name="l02107"></a>02107       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02108"></a>02108          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02109"></a>02109          <span class="keywordflow">if</span> (iterator-&gt;btype == <a class="code" href="jabber_8h.html#a43544c485b6512baca1e632939f8d573a6575b0c35092c8561693bf083674147a">AJI_TRANS</a>)
<a name="l02110"></a>02110             buddy = iterator; <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02111"></a>02111       });
<a name="l02112"></a>02112       iks_filter_remove_hook(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, aji_register_transport2);
<a name="l02113"></a>02113       iks_insert_attrib(regiq, <span class="stringliteral">&quot;to&quot;</span>, buddy-&gt;host);
<a name="l02114"></a>02114       iks_insert_attrib(regiq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l02115"></a>02115       iks_insert_attrib(regiq, <span class="stringliteral">&quot;id&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l02116"></a>02116       <a class="code" href="jabber_8h.html#a6e4ae95e74b73933aa6e6d6817df9023" title="increments the mid field for messages and other events.">ast_aji_increment_mid</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>);
<a name="l02117"></a>02117       iks_insert_attrib(regiq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l02118"></a>02118       iks_insert_attrib(regquery, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>);
<a name="l02119"></a>02119       iks_insert_cdata(reguser, buddy-&gt;user, 0);
<a name="l02120"></a>02120       iks_insert_cdata(regpass, buddy-&gt;pass, 0);
<a name="l02121"></a>02121       iks_insert_node(regiq, regquery);
<a name="l02122"></a>02122       iks_insert_node(regquery, reguser);
<a name="l02123"></a>02123       iks_insert_node(regquery, regpass);
<a name="l02124"></a>02124       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, regiq);
<a name="l02125"></a>02125    } <span class="keywordflow">else</span>
<a name="l02126"></a>02126       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02127"></a>02127    <span class="keywordflow">if</span> (regiq)
<a name="l02128"></a>02128       iks_delete(regiq);
<a name="l02129"></a>02129    <span class="keywordflow">if</span> (regquery)
<a name="l02130"></a>02130       iks_delete(regquery);
<a name="l02131"></a>02131    <span class="keywordflow">if</span> (reguser)
<a name="l02132"></a>02132       iks_delete(reguser);
<a name="l02133"></a>02133    <span class="keywordflow">if</span> (regpass)
<a name="l02134"></a>02134       iks_delete(regpass);
<a name="l02135"></a>02135    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02136"></a>02136    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l02137"></a>02137 }
<a name="l02138"></a>02138 <span class="preprocessor">#endif</span>
<a name="l02139"></a>02139 <span class="preprocessor"></span><span class="comment"></span>
<a name="l02140"></a>02140 <span class="comment">/*!</span>
<a name="l02141"></a>02141 <span class="comment"> * \brief goes through roster and prunes users not needed in list, or adds them accordingly.</span>
<a name="l02142"></a>02142 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l02143"></a>02143 <span class="comment"> * \return void.</span>
<a name="l02144"></a>02144 <span class="comment"> * \note The messages here should be configurable.</span>
<a name="l02145"></a>02145 <span class="comment"> */</span>
<a name="l02146"></a><a class="code" href="res__jabber_8c.html#a023bfb1346d00de355930f4224b94699">02146</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a023bfb1346d00de355930f4224b94699" title="goes through roster and prunes users not needed in list, or adds them accordingly...">aji_pruneregister</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02147"></a>02147 {
<a name="l02148"></a>02148    <span class="keywordtype">int</span> res = 0;
<a name="l02149"></a>02149    iks *removeiq = iks_new(<span class="stringliteral">&quot;iq&quot;</span>);
<a name="l02150"></a>02150    iks *removequery = iks_new(<span class="stringliteral">&quot;query&quot;</span>);
<a name="l02151"></a>02151    iks *removeitem = iks_new(<span class="stringliteral">&quot;item&quot;</span>);
<a name="l02152"></a>02152    iks *send = iks_make_iq(IKS_TYPE_GET, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>);
<a name="l02153"></a>02153    <span class="keywordflow">if</span> (!client || !removeiq || !removequery || !removeitem || !send) {
<a name="l02154"></a>02154       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02155"></a>02155       <span class="keywordflow">goto</span> safeout;
<a name="l02156"></a>02156    }
<a name="l02157"></a>02157 
<a name="l02158"></a>02158    iks_insert_node(removeiq, removequery);
<a name="l02159"></a>02159    iks_insert_node(removequery, removeitem);
<a name="l02160"></a>02160    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02161"></a>02161       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02162"></a>02162       <span class="comment">/* For an aji_buddy, both AUTOPRUNE and AUTOREGISTER will never</span>
<a name="l02163"></a>02163 <span class="comment">       * be called at the same time */</span>
<a name="l02164"></a>02164       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>)) { <span class="comment">/* If autoprune is set on jabber.conf */</span>
<a name="l02165"></a>02165          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iks_make_s10n(IKS_TYPE_UNSUBSCRIBE, iterator-&gt;name,
<a name="l02166"></a>02166                          <span class="stringliteral">&quot;GoodBye. Your status is no longer needed by Asterisk the Open Source PBX&quot;</span>
<a name="l02167"></a>02167                          <span class="stringliteral">&quot; so I am no longer subscribing to your presence.\n&quot;</span>));
<a name="l02168"></a>02168          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iks_make_s10n(IKS_TYPE_UNSUBSCRIBED, iterator-&gt;name,
<a name="l02169"></a>02169                          <span class="stringliteral">&quot;GoodBye.  You are no longer in the Asterisk config file so I am removing&quot;</span>
<a name="l02170"></a>02170                          <span class="stringliteral">&quot; your access to my presence.\n&quot;</span>));
<a name="l02171"></a>02171          iks_insert_attrib(removeiq, <span class="stringliteral">&quot;from&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full); 
<a name="l02172"></a>02172          iks_insert_attrib(removeiq, <span class="stringliteral">&quot;type&quot;</span>, <span class="stringliteral">&quot;set&quot;</span>); 
<a name="l02173"></a>02173          iks_insert_attrib(removequery, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;jabber:iq:roster&quot;</span>);
<a name="l02174"></a>02174          iks_insert_attrib(removeitem, <span class="stringliteral">&quot;jid&quot;</span>, iterator-&gt;name);
<a name="l02175"></a>02175          iks_insert_attrib(removeitem, <span class="stringliteral">&quot;subscription&quot;</span>, <span class="stringliteral">&quot;remove&quot;</span>);
<a name="l02176"></a>02176          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, removeiq);
<a name="l02177"></a>02177       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>)) {
<a name="l02178"></a>02178          res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, iks_make_s10n(IKS_TYPE_SUBSCRIBE, iterator-&gt;name, 
<a name="l02179"></a>02179                          <span class="stringliteral">&quot;Greetings! I am the Asterisk Open Source PBX and I want to subscribe to your presence\n&quot;</span>));
<a name="l02180"></a>02180          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02181"></a>02181       }
<a name="l02182"></a>02182       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02183"></a>02183    });
<a name="l02184"></a>02184 
<a name="l02185"></a>02185  safeout:
<a name="l02186"></a>02186    iks_delete(removeiq);
<a name="l02187"></a>02187    iks_delete(removequery);
<a name="l02188"></a>02188    iks_delete(removeitem);
<a name="l02189"></a>02189    iks_delete(send);
<a name="l02190"></a>02190    
<a name="l02191"></a>02191    <a class="code" href="astobj_8h.html#a794727ca4ef71982250ff9f36a9668d7" title="Prune marked objects from a container.">ASTOBJ_CONTAINER_PRUNE_MARKED</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l02192"></a>02192 }
<a name="l02193"></a>02193 <span class="comment"></span>
<a name="l02194"></a>02194 <span class="comment">/*!</span>
<a name="l02195"></a>02195 <span class="comment"> * \brief filters the roster packet we get back from server.</span>
<a name="l02196"></a>02196 <span class="comment"> * \param data void</span>
<a name="l02197"></a>02197 <span class="comment"> * \param pak ikspak iksemel packet.</span>
<a name="l02198"></a>02198 <span class="comment"> * \return IKS_FILTER_EAT.</span>
<a name="l02199"></a>02199 <span class="comment"> */</span>
<a name="l02200"></a><a class="code" href="res__jabber_8c.html#ab465ef5fd9bb14b30208091d039f1100">02200</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ab465ef5fd9bb14b30208091d039f1100" title="filters the roster packet we get back from server.">aji_filter_roster</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l02201"></a>02201 {
<a name="l02202"></a>02202    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l02203"></a>02203    <span class="keywordtype">int</span> flag = 0;
<a name="l02204"></a>02204    iks *x = NULL;
<a name="l02205"></a>02205    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy;
<a name="l02206"></a>02206    
<a name="l02207"></a>02207    client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>;
<a name="l02208"></a>02208    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02209"></a>02209       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02210"></a>02210       x = iks_child(pak-&gt;query);
<a name="l02211"></a>02211       flag = 0;
<a name="l02212"></a>02212       <span class="keywordflow">while</span> (x) {
<a name="l02213"></a>02213          <span class="keywordflow">if</span> (!iks_strcmp(iks_name(x), <span class="stringliteral">&quot;item&quot;</span>)) {
<a name="l02214"></a>02214             <span class="keywordflow">if</span> (!strcasecmp(iterator-&gt;name, iks_find_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>))) {
<a name="l02215"></a>02215                flag = 1;
<a name="l02216"></a>02216                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;iterator-&gt;flags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a> | <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02217"></a>02217             }
<a name="l02218"></a>02218          }
<a name="l02219"></a>02219          x = iks_next(x);
<a name="l02220"></a>02220       }
<a name="l02221"></a>02221       <span class="keywordflow">if</span> (!flag)
<a name="l02222"></a>02222          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;iterator-&gt;flags, &amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02223"></a>02223       iks_delete(x);
<a name="l02224"></a>02224       
<a name="l02225"></a>02225       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02226"></a>02226    });
<a name="l02227"></a>02227 
<a name="l02228"></a>02228    x = iks_child(pak-&gt;query);
<a name="l02229"></a>02229    <span class="keywordflow">while</span> (x) {
<a name="l02230"></a>02230       flag = 0;
<a name="l02231"></a>02231       <span class="keywordflow">if</span> (iks_strcmp(iks_name(x), <span class="stringliteral">&quot;item&quot;</span>) == 0) {
<a name="l02232"></a>02232          <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02233"></a>02233             <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02234"></a>02234             <span class="keywordflow">if</span> (!strcasecmp(iterator-&gt;name, iks_find_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>)))
<a name="l02235"></a>02235                flag = 1;
<a name="l02236"></a>02236             <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02237"></a>02237          });
<a name="l02238"></a>02238 
<a name="l02239"></a>02239          <span class="keywordflow">if</span> (flag) {
<a name="l02240"></a>02240             <span class="comment">/* found buddy, don&apos;t create a new one */</span>
<a name="l02241"></a>02241             x = iks_next(x);
<a name="l02242"></a>02242             <span class="keywordflow">continue</span>;
<a name="l02243"></a>02243          }
<a name="l02244"></a>02244          
<a name="l02245"></a>02245          buddy = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*buddy));
<a name="l02246"></a>02246          <span class="keywordflow">if</span> (!buddy) {
<a name="l02247"></a>02247             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l02248"></a>02248             <span class="keywordflow">return</span> 0;
<a name="l02249"></a>02249          }
<a name="l02250"></a>02250          <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(buddy);
<a name="l02251"></a>02251          <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(buddy);
<a name="l02252"></a>02252          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>, iks_find_attrib(x, <span class="stringliteral">&quot;jid&quot;</span>), <span class="keyword">sizeof</span>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>));
<a name="l02253"></a>02253          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;buddy-&gt;<a class="code" href="structaji__buddy.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02254"></a>02254          <span class="keywordflow">if</span>(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>)) {
<a name="l02255"></a>02255             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;buddy-&gt;<a class="code" href="structaji__buddy.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>);
<a name="l02256"></a>02256             <a class="code" href="astobj_8h.html#ad51464686c5c2948bd337f8bb2c483b7" title="Mark an ASTOBJ by adding the ASTOBJ_FLAG_MARKED flag to its objflags mask.">ASTOBJ_MARK</a>(buddy);
<a name="l02257"></a>02257          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!iks_strcmp(iks_find_attrib(x, <span class="stringliteral">&quot;subscription&quot;</span>), <span class="stringliteral">&quot;none&quot;</span>) || !iks_strcmp(iks_find_attrib(x, <span class="stringliteral">&quot;subscription&quot;</span>), <span class="stringliteral">&quot;from&quot;</span>)) {
<a name="l02258"></a>02258             <span class="comment">/* subscribe to buddy&apos;s presence only </span>
<a name="l02259"></a>02259 <span class="comment">               if we really need to */</span>
<a name="l02260"></a>02260             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;buddy-&gt;<a class="code" href="structaji__buddy.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02261"></a>02261          }
<a name="l02262"></a>02262          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(buddy);
<a name="l02263"></a>02263          <span class="keywordflow">if</span> (buddy) {
<a name="l02264"></a>02264             <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, buddy);
<a name="l02265"></a>02265             <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(buddy, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l02266"></a>02266          }
<a name="l02267"></a>02267       }
<a name="l02268"></a>02268       x = iks_next(x);
<a name="l02269"></a>02269    }
<a name="l02270"></a>02270 
<a name="l02271"></a>02271    iks_delete(x);
<a name="l02272"></a>02272    <a class="code" href="res__jabber_8c.html#a023bfb1346d00de355930f4224b94699" title="goes through roster and prunes users not needed in list, or adds them accordingly...">aji_pruneregister</a>(client);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02275"></a>02275    <span class="keywordflow">return</span> IKS_FILTER_EAT;
<a name="l02276"></a>02276 }
<a name="l02277"></a>02277 <span class="comment"></span>
<a name="l02278"></a>02278 <span class="comment">/*!</span>
<a name="l02279"></a>02279 <span class="comment"> * \brief reconnect to jabber server</span>
<a name="l02280"></a>02280 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l02281"></a>02281 <span class="comment"> * \return res.</span>
<a name="l02282"></a>02282 <span class="comment">*/</span>
<a name="l02283"></a><a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250">02283</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ae14793d1d8300f1c377fccb8e5773250" title="reconnect to jabber server">aji_reconnect</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02284"></a>02284 {
<a name="l02285"></a>02285    <span class="keywordtype">int</span> res = 0;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a>)
<a name="l02288"></a>02288       client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>;
<a name="l02289"></a>02289    client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a>=50;
<a name="l02290"></a>02290    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>)
<a name="l02291"></a>02291       iks_parser_reset(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l02292"></a>02292    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a>)
<a name="l02293"></a>02293       client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a> = 0;
<a name="l02294"></a>02294 
<a name="l02295"></a>02295    res = <a class="code" href="res__jabber_8c.html#a34f1590817ad7108962f22772caa9bb1" title="prepares client for connect.">aji_initialize</a>(client);
<a name="l02296"></a>02296 
<a name="l02297"></a>02297    <span class="keywordflow">return</span> res;
<a name="l02298"></a>02298 }
<a name="l02299"></a>02299 <span class="comment"></span>
<a name="l02300"></a>02300 <span class="comment">/*!</span>
<a name="l02301"></a>02301 <span class="comment"> * \brief Get the roster of jabber users</span>
<a name="l02302"></a>02302 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l02303"></a>02303 <span class="comment"> * \return 1.</span>
<a name="l02304"></a>02304 <span class="comment">*/</span>
<a name="l02305"></a><a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771">02305</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771" title="Get the roster of jabber users.">aji_get_roster</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02306"></a>02306 {
<a name="l02307"></a>02307    iks *roster = NULL;
<a name="l02308"></a>02308    roster = iks_make_iq(IKS_TYPE_GET, IKS_NS_ROSTER);
<a name="l02309"></a>02309 
<a name="l02310"></a>02310    <span class="keywordflow">if</span>(roster) {
<a name="l02311"></a>02311       iks_insert_attrib(roster, <span class="stringliteral">&quot;id&quot;</span>, <span class="stringliteral">&quot;roster&quot;</span>);
<a name="l02312"></a>02312       <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(client, NULL, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;full, client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a>, client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>);
<a name="l02313"></a>02313       <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, roster);
<a name="l02314"></a>02314    }
<a name="l02315"></a>02315 
<a name="l02316"></a>02316    iks_delete(roster);
<a name="l02317"></a>02317    
<a name="l02318"></a>02318    <span class="keywordflow">return</span> 1;
<a name="l02319"></a>02319 }
<a name="l02320"></a>02320 <span class="comment"></span>
<a name="l02321"></a>02321 <span class="comment">/*!</span>
<a name="l02322"></a>02322 <span class="comment"> * \brief connects as a client to jabber server.</span>
<a name="l02323"></a>02323 <span class="comment"> * \param data void</span>
<a name="l02324"></a>02324 <span class="comment"> * \param pak ikspak iksemel packet</span>
<a name="l02325"></a>02325 <span class="comment"> * \return res.</span>
<a name="l02326"></a>02326 <span class="comment"> */</span>
<a name="l02327"></a><a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5">02327</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>(<span class="keywordtype">void</span> *data, ikspak *pak)
<a name="l02328"></a>02328 {
<a name="l02329"></a>02329    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = <a class="code" href="astobj_8h.html#ab9c2c3dae8dc0cd67210b5e03b3b7d6e" title="Increment an object reference count.">ASTOBJ_REF</a>((<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *) data);
<a name="l02330"></a>02330    <span class="keywordtype">int</span> res = 0;
<a name="l02331"></a>02331 
<a name="l02332"></a>02332    <span class="keywordflow">if</span> (client) {
<a name="l02333"></a>02333       <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>) {
<a name="l02334"></a>02334          iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#ab465ef5fd9bb14b30208091d039f1100" title="filters the roster packet we get back from server.">aji_filter_roster</a>, client, IKS_RULE_TYPE, IKS_PAK_IQ, IKS_RULE_SUBTYPE, IKS_TYPE_RESULT, IKS_RULE_ID, <span class="stringliteral">&quot;roster&quot;</span>, IKS_RULE_DONE);
<a name="l02335"></a>02335          client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>;
<a name="l02336"></a>02336          client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a> = (iks_find_cdata(pak-&gt;query, <span class="stringliteral">&quot;jid&quot;</span>)) ? iks_id_new(client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>, iks_find_cdata(pak-&gt;query, <span class="stringliteral">&quot;jid&quot;</span>)) : client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>;
<a name="l02337"></a>02337          iks_filter_remove_hook(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1343493e50b3f08e612a65f0b73625b5" title="connects as a client to jabber server.">aji_client_connect</a>);
<a name="l02338"></a>02338          <span class="keywordflow">if</span>(!client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) <span class="comment">/*client*/</span>
<a name="l02339"></a>02339             <a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771" title="Get the roster of jabber users.">aji_get_roster</a>(client);
<a name="l02340"></a>02340       }
<a name="l02341"></a>02341    } <span class="keywordflow">else</span>
<a name="l02342"></a>02342       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02343"></a>02343 
<a name="l02344"></a>02344    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02345"></a>02345    <span class="keywordflow">return</span> res;
<a name="l02346"></a>02346 }
<a name="l02347"></a>02347 <span class="comment"></span>
<a name="l02348"></a>02348 <span class="comment">/*!</span>
<a name="l02349"></a>02349 <span class="comment"> * \brief prepares client for connect.</span>
<a name="l02350"></a>02350 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l02351"></a>02351 <span class="comment"> * \return 1.</span>
<a name="l02352"></a>02352 <span class="comment"> */</span>
<a name="l02353"></a><a class="code" href="res__jabber_8c.html#a34f1590817ad7108962f22772caa9bb1">02353</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a34f1590817ad7108962f22772caa9bb1" title="prepares client for connect.">aji_initialize</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02354"></a>02354 {
<a name="l02355"></a>02355    <span class="keywordtype">int</span> <a class="code" href="cdr__pgsql_8c.html#a9709aefe4930807392898aecb0cb8a79">connected</a> = IKS_NET_NOCONN;
<a name="l02356"></a>02356 
<a name="l02357"></a>02357 <span class="preprocessor">#ifdef HAVE_OPENSSL  </span>
<a name="l02358"></a>02358 <span class="preprocessor"></span>   <span class="comment">/* reset stream flags */</span>
<a name="l02359"></a>02359    client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> = 0;
<a name="l02360"></a>02360 <span class="preprocessor">#endif</span>
<a name="l02361"></a>02361 <span class="preprocessor"></span>   <span class="comment">/* If it&apos;s a component, connect to user, otherwise, connect to server */</span>
<a name="l02362"></a>02362    connected = iks_connect_via(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server), client-&gt;<a class="code" href="structaji__client.html#a63c89c04d1feae07ca35558055155ffb">port</a>, client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> ? client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a> : client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server);
<a name="l02363"></a>02363 
<a name="l02364"></a>02364    <span class="keywordflow">if</span> (connected == IKS_NET_NOCONN) {
<a name="l02365"></a>02365       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER ERROR: No Connection\n&quot;</span>);
<a name="l02366"></a>02366       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l02367"></a>02367    } <span class="keywordflow">else</span>   <span class="keywordflow">if</span> (connected == IKS_NET_NODNS) {
<a name="l02368"></a>02368       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER ERROR: No DNS %s for client to  %s\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>, client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a>-&gt;server));
<a name="l02369"></a>02369       <span class="keywordflow">return</span> IKS_HOOK;
<a name="l02370"></a>02370    }
<a name="l02371"></a>02371 
<a name="l02372"></a>02372    <span class="keywordflow">return</span> IKS_OK;
<a name="l02373"></a>02373 }
<a name="l02374"></a>02374 <span class="comment"></span>
<a name="l02375"></a>02375 <span class="comment">/*!</span>
<a name="l02376"></a>02376 <span class="comment"> * \brief disconnect from jabber server.</span>
<a name="l02377"></a>02377 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l02378"></a>02378 <span class="comment"> * \return 1.</span>
<a name="l02379"></a>02379 <span class="comment"> */</span>
<a name="l02380"></a><a class="code" href="res__jabber_8c.html#a06f01ad5dc78d9300fed1415b54be04a">02380</a> <span class="keywordtype">int</span> <a class="code" href="jabber_8h.html#a06f01ad5dc78d9300fed1415b54be04a" title="disconnect from jabber server.">ast_aji_disconnect</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02381"></a>02381 {
<a name="l02382"></a>02382    <span class="keywordflow">if</span> (client) {
<a name="l02383"></a>02383       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;JABBER: Disconnecting\n&quot;</span>);
<a name="l02384"></a>02384 <span class="preprocessor">#ifdef HAVE_OPENSSL</span>
<a name="l02385"></a>02385 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#aa663ff5d560561c647a50b58adce4e7a">stream_flags</a> &amp; <a class="code" href="jabber_8h.html#aff0ca0337402eb888baf747ce2469641">SECURE</a>) {
<a name="l02386"></a>02386          SSL_shutdown(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l02387"></a>02387          SSL_CTX_free(client-&gt;<a class="code" href="structaji__client.html#a8c5d83fcb87f22326009954a4652d92e">ssl_context</a>);
<a name="l02388"></a>02388          SSL_free(client-&gt;<a class="code" href="structaji__client.html#a28e9fca20ae2d65b0b00c4c4b16ee59b">ssl_session</a>);
<a name="l02389"></a>02389       }
<a name="l02390"></a>02390 <span class="preprocessor">#endif</span>
<a name="l02391"></a>02391 <span class="preprocessor"></span>      iks_disconnect(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l02392"></a>02392       iks_parser_delete(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>);
<a name="l02393"></a>02393       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02394"></a>02394    }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396    <span class="keywordflow">return</span> 1;
<a name="l02397"></a>02397 }
<a name="l02398"></a>02398 <span class="comment"></span>
<a name="l02399"></a>02399 <span class="comment">/*!</span>
<a name="l02400"></a>02400 <span class="comment"> * \brief set presence of client.</span>
<a name="l02401"></a>02401 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server</span>
<a name="l02402"></a>02402 <span class="comment"> * \param to user send it to</span>
<a name="l02403"></a>02403 <span class="comment"> * \param from user it came from</span>
<a name="l02404"></a>02404 <span class="comment"> * \param level</span>
<a name="l02405"></a>02405 <span class="comment"> * \param desc</span>
<a name="l02406"></a>02406 <span class="comment"> * \return void.</span>
<a name="l02407"></a>02407 <span class="comment"> */</span>
<a name="l02408"></a><a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c">02408</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__jabber_8c.html#a889348ddb7c785a009c26acb81ed232c" title="set presence of client.">aji_set_presence</a>(<span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client, <span class="keywordtype">char</span> *to, <span class="keywordtype">char</span> *from, <span class="keywordtype">int</span> level, <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)
<a name="l02409"></a>02409 {
<a name="l02410"></a>02410    <span class="keywordtype">int</span> res = 0;
<a name="l02411"></a>02411    iks *presence = iks_make_pres(level, desc);
<a name="l02412"></a>02412    iks *cnode = iks_new(<span class="stringliteral">&quot;c&quot;</span>);
<a name="l02413"></a>02413    iks *<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = iks_new(<span class="stringliteral">&quot;priority&quot;</span>);
<a name="l02414"></a>02414    <span class="keywordtype">char</span> priorityS[10];
<a name="l02415"></a>02415 
<a name="l02416"></a>02416    <span class="keywordflow">if</span> (presence &amp;&amp; cnode &amp;&amp; client &amp;&amp; priority) {
<a name="l02417"></a>02417       <span class="keywordflow">if</span>(to)
<a name="l02418"></a>02418          iks_insert_attrib(presence, <span class="stringliteral">&quot;to&quot;</span>, to);
<a name="l02419"></a>02419       <span class="keywordflow">if</span>(from)
<a name="l02420"></a>02420          iks_insert_attrib(presence, <span class="stringliteral">&quot;from&quot;</span>, from);
<a name="l02421"></a>02421       snprintf(priorityS, <span class="keyword">sizeof</span>(priorityS), <span class="stringliteral">&quot;%d&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02422"></a>02422       iks_insert_cdata(priority, priorityS, strlen(priorityS));
<a name="l02423"></a>02423       iks_insert_node(presence, priority);
<a name="l02424"></a>02424       iks_insert_attrib(cnode, <span class="stringliteral">&quot;node&quot;</span>, <span class="stringliteral">&quot;http://www.asterisk.org/xmpp/client/caps&quot;</span>);
<a name="l02425"></a>02425       iks_insert_attrib(cnode, <span class="stringliteral">&quot;ver&quot;</span>, <span class="stringliteral">&quot;asterisk-xmpp&quot;</span>);
<a name="l02426"></a>02426       iks_insert_attrib(cnode, <span class="stringliteral">&quot;ext&quot;</span>, <span class="stringliteral">&quot;voice-v1&quot;</span>);
<a name="l02427"></a>02427       iks_insert_attrib(cnode, <span class="stringliteral">&quot;xmlns&quot;</span>, <span class="stringliteral">&quot;http://jabber.org/protocol/caps&quot;</span>);
<a name="l02428"></a>02428       iks_insert_node(presence, cnode);
<a name="l02429"></a>02429       res = <a class="code" href="jabber_8h.html#a3c77ceecc909619207e971421fc3e9ef" title="Wraps raw sending.">ast_aji_send</a>(client, presence);
<a name="l02430"></a>02430    } <span class="keywordflow">else</span>
<a name="l02431"></a>02431       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory.\n&quot;</span>);
<a name="l02432"></a>02432 
<a name="l02433"></a>02433    iks_delete(cnode);
<a name="l02434"></a>02434    iks_delete(presence);
<a name="l02435"></a>02435    iks_delete(priority);
<a name="l02436"></a>02436 }
<a name="l02437"></a>02437 <span class="comment"></span>
<a name="l02438"></a>02438 <span class="comment">/*!</span>
<a name="l02439"></a>02439 <span class="comment"> * \brief Turn on/off console debugging.</span>
<a name="l02440"></a>02440 <span class="comment"> * \return CLI_SUCCESS.</span>
<a name="l02441"></a>02441 <span class="comment"> */</span>
<a name="l02442"></a><a class="code" href="res__jabber_8c.html#af61d5277d284f24cf7e83867342ed724">02442</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#af61d5277d284f24cf7e83867342ed724" title="Turn on/off console debugging.">aji_do_set_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02443"></a>02443 {
<a name="l02444"></a>02444    <span class="keywordflow">switch</span> (cmd) {
<a name="l02445"></a>02445    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02446"></a>02446       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber set debug {on|off}&quot;</span>;
<a name="l02447"></a>02447       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02448"></a>02448          <span class="stringliteral">&quot;Usage: jabber set debug {on|off}\n&quot;</span>
<a name="l02449"></a>02449          <span class="stringliteral">&quot;       Enables/disables dumping of XMPP/Jabber packets for debugging purposes.\n&quot;</span>;
<a name="l02450"></a>02450       <span class="keywordflow">return</span> NULL;
<a name="l02451"></a>02451    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02452"></a>02452       <span class="keywordflow">return</span> NULL;
<a name="l02453"></a>02453    }
<a name="l02454"></a>02454 
<a name="l02455"></a>02455    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l02456"></a>02456       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l02457"></a>02457 
<a name="l02458"></a>02458    <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l02459"></a>02459       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02460"></a>02460          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator); 
<a name="l02461"></a>02461          iterator-&gt;debug = 1;
<a name="l02462"></a>02462          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02463"></a>02463       });
<a name="l02464"></a>02464       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Debugging Enabled.\n&quot;</span>);
<a name="l02465"></a>02465       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02466"></a>02466    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> - 1], <span class="stringliteral">&quot;off&quot;</span>, 3)) {
<a name="l02467"></a>02467       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02468"></a>02468          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator); 
<a name="l02469"></a>02469          iterator-&gt;debug = 0;
<a name="l02470"></a>02470          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02471"></a>02471       });
<a name="l02472"></a>02472       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Debugging Disabled.\n&quot;</span>);
<a name="l02473"></a>02473       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02474"></a>02474    }
<a name="l02475"></a>02475    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>; <span class="comment">/* defaults to invalid */</span>
<a name="l02476"></a>02476 }
<a name="l02477"></a>02477 <span class="comment"></span>
<a name="l02478"></a>02478 <span class="comment">/*!</span>
<a name="l02479"></a>02479 <span class="comment"> * \brief Reload jabber module.</span>
<a name="l02480"></a>02480 <span class="comment"> * \return CLI_SUCCESS.</span>
<a name="l02481"></a>02481 <span class="comment"> */</span>
<a name="l02482"></a><a class="code" href="res__jabber_8c.html#a0a89c3ed58b2a5083948fb2fa980eb88">02482</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#a0a89c3ed58b2a5083948fb2fa980eb88" title="Reload jabber module.">aji_do_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02483"></a>02483 {
<a name="l02484"></a>02484    <span class="keywordflow">switch</span> (cmd) {
<a name="l02485"></a>02485    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02486"></a>02486       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber reload&quot;</span>;
<a name="l02487"></a>02487       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02488"></a>02488          <span class="stringliteral">&quot;Usage: jabber reload\n&quot;</span>
<a name="l02489"></a>02489          <span class="stringliteral">&quot;       Reloads the Jabber module.\n&quot;</span>;
<a name="l02490"></a>02490       <span class="keywordflow">return</span> NULL;
<a name="l02491"></a>02491    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02492"></a>02492       <span class="keywordflow">return</span> NULL;
<a name="l02493"></a>02493    }
<a name="l02494"></a>02494 
<a name="l02495"></a>02495    <a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(1);
<a name="l02496"></a>02496    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Reloaded.\n&quot;</span>);
<a name="l02497"></a>02497    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02498"></a>02498 }
<a name="l02499"></a>02499 <span class="comment"></span>
<a name="l02500"></a>02500 <span class="comment">/*!</span>
<a name="l02501"></a>02501 <span class="comment"> * \brief Show client status.</span>
<a name="l02502"></a>02502 <span class="comment"> * \return CLI_SUCCESS.</span>
<a name="l02503"></a>02503 <span class="comment"> */</span>
<a name="l02504"></a><a class="code" href="res__jabber_8c.html#ab098aeaf9f3ec6b05f4360ab16113afc">02504</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#ab098aeaf9f3ec6b05f4360ab16113afc" title="Show client status.">aji_show_clients</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02505"></a>02505 {
<a name="l02506"></a>02506    <span class="keywordtype">char</span> *<a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>;
<a name="l02507"></a>02507    <span class="keywordtype">int</span> count = 0;
<a name="l02508"></a>02508    
<a name="l02509"></a>02509    <span class="keywordflow">switch</span> (cmd) {
<a name="l02510"></a>02510    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02511"></a>02511       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber show connected&quot;</span>;
<a name="l02512"></a>02512       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02513"></a>02513          <span class="stringliteral">&quot;Usage: jabber show connected\n&quot;</span>
<a name="l02514"></a>02514          <span class="stringliteral">&quot;       Shows state of clients and components\n&quot;</span>;
<a name="l02515"></a>02515       <span class="keywordflow">return</span> NULL;
<a name="l02516"></a>02516    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02517"></a>02517       <span class="keywordflow">return</span> NULL;
<a name="l02518"></a>02518    }
<a name="l02519"></a>02519 
<a name="l02520"></a>02520    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber Users and their status:\n&quot;</span>);
<a name="l02521"></a>02521    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02522"></a>02522       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02523"></a>02523       count++;
<a name="l02524"></a>02524       <span class="keywordflow">switch</span> (iterator-&gt;state) {
<a name="l02525"></a>02525       <span class="keywordflow">case</span> <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>:
<a name="l02526"></a>02526          status = <span class="stringliteral">&quot;Disconnected&quot;</span>;
<a name="l02527"></a>02527          <span class="keywordflow">break</span>;
<a name="l02528"></a>02528       <span class="keywordflow">case</span> <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>:
<a name="l02529"></a>02529          status = <span class="stringliteral">&quot;Connecting&quot;</span>;
<a name="l02530"></a>02530          <span class="keywordflow">break</span>;
<a name="l02531"></a>02531       <span class="keywordflow">case</span> <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ae1921cd67cd09004d94dbbd8473f47d9">AJI_CONNECTED</a>:
<a name="l02532"></a>02532          status = <span class="stringliteral">&quot;Connected&quot;</span>;
<a name="l02533"></a>02533          <span class="keywordflow">break</span>;
<a name="l02534"></a>02534       <span class="keywordflow">default</span>:
<a name="l02535"></a>02535          status = <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l02536"></a>02536       }
<a name="l02537"></a>02537       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;       User: %s     - %s\n&quot;</span>, iterator-&gt;user, status);
<a name="l02538"></a>02538       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02539"></a>02539    });
<a name="l02540"></a>02540    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;----\n&quot;</span>);
<a name="l02541"></a>02541    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;   Number of users: %d\n&quot;</span>, count);
<a name="l02542"></a>02542    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02543"></a>02543 }
<a name="l02544"></a>02544 <span class="comment"></span>
<a name="l02545"></a>02545 <span class="comment">/*!</span>
<a name="l02546"></a>02546 <span class="comment"> * \brief Show buddy lists</span>
<a name="l02547"></a>02547 <span class="comment"> * \return CLI_SUCCESS.</span>
<a name="l02548"></a>02548 <span class="comment"> */</span>
<a name="l02549"></a><a class="code" href="res__jabber_8c.html#a3eedb3c8124c4a01ac80f62b7bab047f">02549</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#a3eedb3c8124c4a01ac80f62b7bab047f" title="Show buddy lists.">aji_show_buddies</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02550"></a>02550 {
<a name="l02551"></a>02551    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>;
<a name="l02552"></a>02552    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client;
<a name="l02553"></a>02553 
<a name="l02554"></a>02554    <span class="keywordflow">switch</span> (cmd) {
<a name="l02555"></a>02555    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02556"></a>02556       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber show buddies&quot;</span>;
<a name="l02557"></a>02557       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02558"></a>02558          <span class="stringliteral">&quot;Usage: jabber show buddies\n&quot;</span>
<a name="l02559"></a>02559          <span class="stringliteral">&quot;       Shows buddy lists of our clients\n&quot;</span>;
<a name="l02560"></a>02560       <span class="keywordflow">return</span> NULL;
<a name="l02561"></a>02561    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02562"></a>02562       <span class="keywordflow">return</span> NULL;
<a name="l02563"></a>02563    }
<a name="l02564"></a>02564 
<a name="l02565"></a>02565    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Jabber buddy lists\n&quot;</span>);
<a name="l02566"></a>02566    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02567"></a>02567       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;Client: %s\n&quot;</span>, iterator-&gt;user);
<a name="l02568"></a>02568       client = iterator;
<a name="l02569"></a>02569       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02570"></a>02570          <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02571"></a>02571          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\tBuddy:\t%s\n&quot;</span>, iterator-&gt;name);
<a name="l02572"></a>02572          <span class="keywordflow">if</span> (!iterator-&gt;resources)
<a name="l02573"></a>02573             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tResource: None\n&quot;</span>); 
<a name="l02574"></a>02574          <span class="keywordflow">for</span> (resource = iterator-&gt;resources; resource; resource = resource-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l02575"></a>02575             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tResource: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l02576"></a>02576             <span class="keywordflow">if</span>(resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>) {
<a name="l02577"></a>02577                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\t\tnode: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a>-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>);
<a name="l02578"></a>02578                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\t\tversion: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>);
<a name="l02579"></a>02579                <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\t\tJingle capable: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a> ? <span class="stringliteral">&quot;yes&quot;</span> : <span class="stringliteral">&quot;no&quot;</span>);
<a name="l02580"></a>02580             }
<a name="l02581"></a>02581             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tStatus: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>);
<a name="l02582"></a>02582             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>,<span class="stringliteral">&quot;\t\tPriority: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02583"></a>02583          }
<a name="l02584"></a>02584          <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02585"></a>02585       });
<a name="l02586"></a>02586       iterator = client;
<a name="l02587"></a>02587    });
<a name="l02588"></a>02588    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02589"></a>02589 }
<a name="l02590"></a>02590 <span class="comment"></span>
<a name="l02591"></a>02591 <span class="comment">/*!</span>
<a name="l02592"></a>02592 <span class="comment"> * \brief Send test message for debugging.</span>
<a name="l02593"></a>02593 <span class="comment"> * \return CLI_SUCCESS,CLI_FAILURE.</span>
<a name="l02594"></a>02594 <span class="comment"> */</span>
<a name="l02595"></a><a class="code" href="res__jabber_8c.html#af86ff7c316e29a5c6a914b4a9c2bc330">02595</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__jabber_8c.html#af86ff7c316e29a5c6a914b4a9c2bc330" title="Send test message for debugging.">aji_test</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l02596"></a>02596 {
<a name="l02597"></a>02597    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client;
<a name="l02598"></a>02598    <span class="keyword">struct </span><a class="code" href="structaji__resource.html">aji_resource</a> *<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>;
<a name="l02599"></a>02599    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = <span class="stringliteral">&quot;asterisk&quot;</span>;
<a name="l02600"></a>02600    <span class="keyword">struct </span><a class="code" href="structaji__message.html">aji_message</a> *tmp;
<a name="l02601"></a>02601 
<a name="l02602"></a>02602    <span class="keywordflow">switch</span> (cmd) {
<a name="l02603"></a>02603    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l02604"></a>02604       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;jabber test&quot;</span>;
<a name="l02605"></a>02605       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l02606"></a>02606          <span class="stringliteral">&quot;Usage: jabber test [client]\n&quot;</span>
<a name="l02607"></a>02607          <span class="stringliteral">&quot;       Sends test message for debugging purposes.  A specific client\n&quot;</span>
<a name="l02608"></a>02608          <span class="stringliteral">&quot;       as configured in jabber.conf can be optionally specified.\n&quot;</span>;
<a name="l02609"></a>02609       <span class="keywordflow">return</span> NULL;
<a name="l02610"></a>02610    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l02611"></a>02611       <span class="keywordflow">return</span> NULL;
<a name="l02612"></a>02612    }
<a name="l02613"></a>02613 
<a name="l02614"></a>02614    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 3)
<a name="l02615"></a>02615       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l02616"></a>02616    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3)
<a name="l02617"></a>02617       name = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2];
<a name="l02618"></a>02618 
<a name="l02619"></a>02619    <span class="keywordflow">if</span> (!(client = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, name))) {
<a name="l02620"></a>02620       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Unable to find client &apos;%s&apos;!\n&quot;</span>, name);
<a name="l02621"></a>02621       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l02622"></a>02622    }
<a name="l02623"></a>02623 
<a name="l02624"></a>02624    <span class="comment">/* XXX Does Matt really want everyone to use his personal address for tests? */</span> <span class="comment">/* XXX yes he does */</span>
<a name="l02625"></a>02625    <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(client, <span class="stringliteral">&quot;mogorman@astjab.org&quot;</span>, <span class="stringliteral">&quot;blahblah&quot;</span>);
<a name="l02626"></a>02626    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, 1, {
<a name="l02627"></a>02627       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l02628"></a>02628       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;User: %s\n&quot;</span>, iterator-&gt;name);
<a name="l02629"></a>02629       <span class="keywordflow">for</span> (resource = iterator-&gt;resources; resource; resource = resource-&gt;<a class="code" href="structaji__resource.html#a96df1b44c7b5636af9508acea4f6120b">next</a>) {
<a name="l02630"></a>02630          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Resource: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a1242b14224ca75fd8d9ecd5514880049">resource</a>);
<a name="l02631"></a>02631          <span class="keywordflow">if</span>(resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>) {
<a name="l02632"></a>02632             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;   client: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a99020efc7f580df36182fc3be139f1b9">parent</a>-&gt;<a class="code" href="structaji__capabilities.html#a987239273bb4a074ad22c76c6486d5b1">node</a>);
<a name="l02633"></a>02633             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;   version: %s\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a039f1dc229c7bd812108a7e8f54249e5">version</a>);
<a name="l02634"></a>02634             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;   Jingle Capable: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a3a3d467a2f83feeb330fabb44031c72f">cap</a>-&gt;<a class="code" href="structaji__version.html#a221bb2c9b97010417157c4ac47625367">jingle</a>);
<a name="l02635"></a>02635          }
<a name="l02636"></a>02636          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Priority: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l02637"></a>02637          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Status: %d\n&quot;</span>, resource-&gt;<a class="code" href="structaji__resource.html#a6e27f49150e9a14580fb313cc2777e00">status</a>); 
<a name="l02638"></a>02638          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Message: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(resource-&gt;<a class="code" href="structaji__resource.html#a8444d6e0dfe2bbab0b5e7b24308f1559">description</a>,<span class="stringliteral">&quot;&quot;</span>)); 
<a name="l02639"></a>02639       }
<a name="l02640"></a>02640       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l02641"></a>02641    });
<a name="l02642"></a>02642    <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\nOooh a working message stack!\n&quot;</span>);
<a name="l02643"></a>02643    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;client-&gt;messages);
<a name="l02644"></a>02644    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;client-&gt;messages, tmp, list) {
<a name="l02645"></a>02645       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Message from: %s with id %s @ %s %s\n&quot;</span>,tmp-&gt;from, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(tmp-&gt;id,<span class="stringliteral">&quot;&quot;</span>), ctime(&amp;tmp-&gt;arrived), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(tmp-&gt;message, <span class="stringliteral">&quot;&quot;</span>));
<a name="l02646"></a>02646    }
<a name="l02647"></a>02647    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;client-&gt;messages);
<a name="l02648"></a>02648    <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02649"></a>02649 
<a name="l02650"></a>02650    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l02651"></a>02651 }
<a name="l02652"></a>02652 <span class="comment"></span>
<a name="l02653"></a>02653 <span class="comment">/*!</span>
<a name="l02654"></a>02654 <span class="comment"> * \brief creates aji_client structure.</span>
<a name="l02655"></a>02655 <span class="comment"> * \param label</span>
<a name="l02656"></a>02656 <span class="comment"> * \param var ast_variable</span>
<a name="l02657"></a>02657 <span class="comment"> * \param debug </span>
<a name="l02658"></a>02658 <span class="comment"> * \return 0.</span>
<a name="l02659"></a>02659 <span class="comment"> */</span>
<a name="l02660"></a><a class="code" href="res__jabber_8c.html#a6381553337670894fe004c0536752062">02660</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a6381553337670894fe004c0536752062" title="creates aji_client structure.">aji_create_client</a>(<span class="keywordtype">char</span> *label, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>)
<a name="l02661"></a>02661 {
<a name="l02662"></a>02662    <span class="keywordtype">char</span> *resource;
<a name="l02663"></a>02663    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l02664"></a>02664    <span class="keywordtype">int</span> flag = 0;
<a name="l02665"></a>02665 
<a name="l02666"></a>02666    client = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>,label);
<a name="l02667"></a>02667    <span class="keywordflow">if</span> (!client) {
<a name="l02668"></a>02668       flag = 1;
<a name="l02669"></a>02669       client = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*client));
<a name="l02670"></a>02670       <span class="keywordflow">if</span> (!client) {
<a name="l02671"></a>02671          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Out of memory!\n&quot;</span>);
<a name="l02672"></a>02672          <span class="keywordflow">return</span> 0;
<a name="l02673"></a>02673       }
<a name="l02674"></a>02674       <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(client);
<a name="l02675"></a>02675       <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(client);
<a name="l02676"></a>02676       <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>);
<a name="l02677"></a>02677    } <span class="keywordflow">else</span> {
<a name="l02678"></a>02678       <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(client);
<a name="l02679"></a>02679       <a class="code" href="astobj_8h.html#a789fc1432f54cb615e839f0db9decad5" title="Unmark an ASTOBJ by subtracting the ASTOBJ_FLAG_MARKED flag from its objflags mask...">ASTOBJ_UNMARK</a>(client);
<a name="l02680"></a>02680    }
<a name="l02681"></a>02681    <a class="code" href="astobj_8h.html#a5e865869ca1acadd652b42810fec2ec9" title="Mark all the objects in a container.">ASTOBJ_CONTAINER_MARKALL</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>);
<a name="l02682"></a>02682    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>, label, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>));
<a name="l02683"></a>02683    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>, <span class="stringliteral">&quot;aaaaa&quot;</span>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#abee5661fa88af477fe47bbbd21136301">mid</a>));
<a name="l02684"></a>02684 
<a name="l02685"></a>02685    <span class="comment">/* Set default values for the client object */</span>
<a name="l02686"></a>02686    client-&gt;<a class="code" href="structaji__client.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = debug;
<a name="l02687"></a>02687    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, &amp;globalflags, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l02688"></a>02688    client-&gt;<a class="code" href="structaji__client.html#a63c89c04d1feae07ca35558055155ffb">port</a> = 5222;
<a name="l02689"></a>02689    client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> = 1;
<a name="l02690"></a>02690    client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a> = 1;
<a name="l02691"></a>02691    client-&gt;<a class="code" href="structaji__client.html#aed71bc56a369c9f2e0faae6a0c713e20">forcessl</a> = 0;
<a name="l02692"></a>02692    client-&gt;<a class="code" href="structaji__client.html#ae314c4b48027be9feab52906b6313b73">keepalive</a> = 1;
<a name="l02693"></a>02693    client-&gt;<a class="code" href="structaji__client.html#a493b57f443cc38b3d3df9c1e584d9d82">timeout</a> = 50;
<a name="l02694"></a>02694    client-&gt;<a class="code" href="structaji__client.html#afcb76ae4daf94120b9c6e8e3a8926e36">message_timeout</a> = 100;
<a name="l02695"></a>02695    <a class="code" href="linkedlists_8h.html#a6f42d3bf45cc9af6f794d9d1cf8c45ca" title="Initializes a list head structure.">AST_LIST_HEAD_INIT</a>(&amp;client-&gt;messages);
<a name="l02696"></a>02696    client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> = 0;
<a name="l02697"></a>02697    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>, <span class="stringliteral">&quot;Online and Available&quot;</span>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>));
<a name="l02698"></a>02698    client-&gt;<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l02699"></a>02699    client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_AVAILABLE;
<a name="l02700"></a>02700 
<a name="l02701"></a>02701    <span class="keywordflow">if</span> (flag) {
<a name="l02702"></a>02702       client-&gt;<a class="code" href="structaji__client.html#af8817598c239b6e65a000760866a5cde">authorized</a> = 0;
<a name="l02703"></a>02703       client-&gt;<a class="code" href="structaji__client.html#ab27a750579a23ed7fd9b24c1bf49bf12">state</a> = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>;
<a name="l02704"></a>02704    }
<a name="l02705"></a>02705    <span class="keywordflow">while</span> (var) {
<a name="l02706"></a>02706       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;username&quot;</span>))
<a name="l02707"></a>02707          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>));
<a name="l02708"></a>02708       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;serverhost&quot;</span>))
<a name="l02709"></a>02709          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#ae6f9b37fdd3bec79fe5bb6f71242f9f5">serverhost</a>));
<a name="l02710"></a>02710       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;secret&quot;</span>))
<a name="l02711"></a>02711          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a0d6c13cf4ff6b4c5b3f049bc7955c8b6">password</a>));
<a name="l02712"></a>02712       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;statusmessage&quot;</span>))
<a name="l02713"></a>02713          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#a1332700b9473d83673c6f305e5d64358">statusmessage</a>));
<a name="l02714"></a>02714       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;port&quot;</span>))
<a name="l02715"></a>02715          client-&gt;<a class="code" href="structaji__client.html#a63c89c04d1feae07ca35558055155ffb">port</a> = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02716"></a>02716       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;timeout&quot;</span>))
<a name="l02717"></a>02717          client-&gt;<a class="code" href="structaji__client.html#afcb76ae4daf94120b9c6e8e3a8926e36">message_timeout</a> = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02718"></a>02718       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;debug&quot;</span>))
<a name="l02719"></a>02719          client-&gt;<a class="code" href="structaji__client.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02720"></a>02720       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;type&quot;</span>)) {
<a name="l02721"></a>02721          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;component&quot;</span>))
<a name="l02722"></a>02722             client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a> = 1;
<a name="l02723"></a>02723       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;usetls&quot;</span>)) {
<a name="l02724"></a>02724          client-&gt;<a class="code" href="structaji__client.html#a411370ea698a05d61798dffbc10eba17">usetls</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02725"></a>02725       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;usesasl&quot;</span>)) {
<a name="l02726"></a>02726          client-&gt;<a class="code" href="structaji__client.html#af88c655607efe917c3030f7ea0c00397">usesasl</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02727"></a>02727       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;forceoldssl&quot;</span>))
<a name="l02728"></a>02728          client-&gt;<a class="code" href="structaji__client.html#aed71bc56a369c9f2e0faae6a0c713e20">forcessl</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02729"></a>02729       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;keepalive&quot;</span>))
<a name="l02730"></a>02730          client-&gt;<a class="code" href="structaji__client.html#ae314c4b48027be9feab52906b6313b73">keepalive</a> = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>)) ? 0 : 1;
<a name="l02731"></a>02731       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoprune&quot;</span>))
<a name="l02732"></a>02732          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>);
<a name="l02733"></a>02733       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoregister&quot;</span>))
<a name="l02734"></a>02734          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02735"></a>02735       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;buddy&quot;</span>))
<a name="l02736"></a>02736          <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>((<span class="keywordtype">char</span> *)var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, client);
<a name="l02737"></a>02737       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;priority&quot;</span>))
<a name="l02738"></a>02738          client-&gt;<a class="code" href="structaji__client.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02739"></a>02739       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;status&quot;</span>)) {
<a name="l02740"></a>02740          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;unavailable&quot;</span>))
<a name="l02741"></a>02741             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_UNAVAILABLE;
<a name="l02742"></a>02742          <span class="keywordflow">else</span>
<a name="l02743"></a>02743          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;available&quot;</span>)
<a name="l02744"></a>02744           || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;online&quot;</span>))
<a name="l02745"></a>02745             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_AVAILABLE;
<a name="l02746"></a>02746          <span class="keywordflow">else</span>
<a name="l02747"></a>02747          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;chat&quot;</span>)
<a name="l02748"></a>02748           || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;chatty&quot;</span>))
<a name="l02749"></a>02749             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_CHAT;
<a name="l02750"></a>02750          <span class="keywordflow">else</span>
<a name="l02751"></a>02751          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;away&quot;</span>))
<a name="l02752"></a>02752             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_AWAY;
<a name="l02753"></a>02753          <span class="keywordflow">else</span>
<a name="l02754"></a>02754          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;xa&quot;</span>)
<a name="l02755"></a>02755           || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;xaway&quot;</span>))
<a name="l02756"></a>02756             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_XA;
<a name="l02757"></a>02757          <span class="keywordflow">else</span>
<a name="l02758"></a>02758          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;dnd&quot;</span>))
<a name="l02759"></a>02759             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_DND;
<a name="l02760"></a>02760          <span class="keywordflow">else</span>
<a name="l02761"></a>02761          if (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;invisible&quot;</span>))
<a name="l02762"></a>02762          #ifdef IKS_SHOW_INVISIBLE
<a name="l02763"></a>02763             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_INVISIBLE;
<a name="l02764"></a>02764          #<span class="keywordflow">else</span>
<a name="l02765"></a>02765          {
<a name="l02766"></a>02766             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Your iksemel doesn&apos;t support invisible status: falling back to DND\n&quot;</span>);
<a name="l02767"></a>02767             client-&gt;<a class="code" href="structaji__client.html#a522b409a211fd313b8a02f071aea6751">status</a> = IKS_SHOW_DND;
<a name="l02768"></a>02768          }
<a name="l02769"></a>02769 <span class="preprocessor">         #endif</span>
<a name="l02770"></a>02770 <span class="preprocessor"></span>         <span class="keywordflow">else</span>
<a name="l02771"></a>02771             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown presence status: %s\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l02772"></a>02772       }
<a name="l02773"></a>02773    <span class="comment">/* no transport support in this version */</span>
<a name="l02774"></a>02774    <span class="comment">/* else if (!strcasecmp(var-&gt;name, &quot;transport&quot;))</span>
<a name="l02775"></a>02775 <span class="comment">            aji_create_transport(var-&gt;value, client);</span>
<a name="l02776"></a>02776 <span class="comment">   */</span>
<a name="l02777"></a>02777       var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l02778"></a>02778    }
<a name="l02779"></a>02779    <span class="keywordflow">if</span> (!flag) {
<a name="l02780"></a>02780       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(client);
<a name="l02781"></a>02781       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(client, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l02782"></a>02782       <span class="keywordflow">return</span> 1;
<a name="l02783"></a>02783    }
<a name="l02784"></a>02784 
<a name="l02785"></a>02785    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>, (client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) ? <span class="stringliteral">&quot;jabber:component:accept&quot;</span> : <span class="stringliteral">&quot;jabber:client&quot;</span>, <span class="keyword">sizeof</span>(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>));
<a name="l02786"></a>02786    client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a> = iks_stream_new(client-&gt;<a class="code" href="structaji__client.html#af15d57ddbee9fc1081f785f111f52b46">name_space</a>, client, <a class="code" href="res__jabber_8c.html#ad0e9114c8ba0981e4a4f3f7d93f5ef3c" title="The action hook parses the inbound packets, constantly running.">aji_act_hook</a>);
<a name="l02787"></a>02787    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>) {
<a name="l02788"></a>02788       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create stream for client &apos;%s&apos;!\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l02789"></a>02789       <span class="keywordflow">return</span> 0;
<a name="l02790"></a>02790    }
<a name="l02791"></a>02791    client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a> = iks_stack_new(8192, 8192);
<a name="l02792"></a>02792    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>) {
<a name="l02793"></a>02793       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to allocate stack for client &apos;%s&apos;\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l02794"></a>02794       <span class="keywordflow">return</span> 0;
<a name="l02795"></a>02795    }
<a name="l02796"></a>02796    client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a> = iks_filter_new();
<a name="l02797"></a>02797    <span class="keywordflow">if</span> (!client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>) {
<a name="l02798"></a>02798       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to create filter for client &apos;%s&apos;\n&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a3777dbae63a15da001b2baa317a25149">name</a>);
<a name="l02799"></a>02799       <span class="keywordflow">return</span> 0;
<a name="l02800"></a>02800    }
<a name="l02801"></a>02801    <span class="keywordflow">if</span> (!strchr(client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>, <span class="charliteral">&apos;/&apos;</span>) &amp;&amp; !client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) { <span class="comment">/*client */</span>
<a name="l02802"></a>02802       resource = NULL;
<a name="l02803"></a>02803       <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;resource, <span class="stringliteral">&quot;%s/asterisk&quot;</span>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>) &gt;= 0) {
<a name="l02804"></a>02804          client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a> = iks_id_new(client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>, resource);
<a name="l02805"></a>02805          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(resource);
<a name="l02806"></a>02806       }
<a name="l02807"></a>02807    } <span class="keywordflow">else</span>
<a name="l02808"></a>02808       client-&gt;<a class="code" href="structaji__client.html#af738439b96e613a471505eb1222ac406">jid</a> = iks_id_new(client-&gt;<a class="code" href="structaji__client.html#ae0c738f7612f5fd8ef0f227f8033324f">stack</a>, client-&gt;<a class="code" href="structaji__client.html#a7932bef941e6643d2487880116d9990f">user</a>);
<a name="l02809"></a>02809    <span class="keywordflow">if</span> (client-&gt;<a class="code" href="structaji__client.html#a3c56304946202b57877d2c12f3ad491a">component</a>) {
<a name="l02810"></a>02810       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a08475a2aad43ee4b4dc1f10453547daf" title="Handler of the return info packet.">aji_dinfo_handler</a>, client, IKS_RULE_NS, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>, IKS_RULE_DONE);
<a name="l02811"></a>02811       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1fa5630459ae90c51157f306d589a96c" title="Handles stuff.">aji_ditems_handler</a>, client, IKS_RULE_NS, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#items&quot;</span>, IKS_RULE_DONE);
<a name="l02812"></a>02812       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a82642d571c9e2cc5476d1b25c99d51cc" title="register handler for incoming querys (IQ&amp;#39;s)">aji_register_query_handler</a>, client, IKS_RULE_SUBTYPE, IKS_TYPE_GET, IKS_RULE_NS, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>, IKS_RULE_DONE);
<a name="l02813"></a>02813       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#ae086e18b972394df16015895af3b0e84" title="Unknown.">aji_register_approve_handler</a>, client, IKS_RULE_SUBTYPE, IKS_TYPE_SET, IKS_RULE_NS, <span class="stringliteral">&quot;jabber:iq:register&quot;</span>, IKS_RULE_DONE);
<a name="l02814"></a>02814    } <span class="keywordflow">else</span> {
<a name="l02815"></a>02815       iks_filter_add_rule(client-&gt;<a class="code" href="structaji__client.html#afc6fdfd9b3ea85d062020bb1aea416b3">f</a>, <a class="code" href="res__jabber_8c.html#a1d851da5bdfbfdd92ab5a8e80229b5d3" title="Handle add extra info.">aji_client_info_handler</a>, client, IKS_RULE_NS, <span class="stringliteral">&quot;http://jabber.org/protocol/disco#info&quot;</span>, IKS_RULE_DONE);
<a name="l02816"></a>02816    }
<a name="l02817"></a>02817    iks_set_log_hook(client-&gt;<a class="code" href="structaji__client.html#a04186cc042ab3ec9a3ad454891f7ea72">p</a>, <a class="code" href="res__jabber_8c.html#a0c0224cfe2418f3e1779239f44d0266c" title="the debug loop.">aji_log_hook</a>);
<a name="l02818"></a>02818    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(client);
<a name="l02819"></a>02819    <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>,client);
<a name="l02820"></a>02820    <span class="keywordflow">return</span> 1;
<a name="l02821"></a>02821 }
<a name="l02822"></a>02822 
<a name="l02823"></a>02823 <span class="preprocessor">#if 0</span>
<a name="l02824"></a>02824 <span class="preprocessor"></span><span class="comment">/*!</span>
<a name="l02825"></a>02825 <span class="comment"> * \brief creates transport.</span>
<a name="l02826"></a>02826 <span class="comment"> * \param label, buddy to dump it into. </span>
<a name="l02827"></a>02827 <span class="comment"> * \return 0.</span>
<a name="l02828"></a>02828 <span class="comment"> */</span>
<a name="l02829"></a>02829 <span class="comment">/* no connecting to transports today */</span>
<a name="l02830"></a>02830 <span class="keyword">static</span> <span class="keywordtype">int</span> aji_create_transport(<span class="keywordtype">char</span> *label, <span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02831"></a>02831 {
<a name="l02832"></a>02832    <span class="keywordtype">char</span> *server = NULL, *buddyname = NULL, *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL, *<a class="code" href="res__config__ldap_8c.html#a68433c52f2199bd92a3c151b295de06e">pass</a> = NULL;
<a name="l02833"></a>02833    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l02834"></a>02834 
<a name="l02835"></a>02835    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>,label);
<a name="l02836"></a>02836    <span class="keywordflow">if</span> (!buddy) {
<a name="l02837"></a>02837       buddy = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*buddy));
<a name="l02838"></a>02838       <span class="keywordflow">if</span>(!buddy) {
<a name="l02839"></a>02839          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l02840"></a>02840          <span class="keywordflow">return</span> 0;
<a name="l02841"></a>02841       }
<a name="l02842"></a>02842       <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(buddy);
<a name="l02843"></a>02843    }
<a name="l02844"></a>02844    <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(buddy);
<a name="l02845"></a>02845    server = label;
<a name="l02846"></a>02846    <span class="keywordflow">if</span> ((buddyname = strchr(label, <span class="charliteral">&apos;,&apos;</span>))) {
<a name="l02847"></a>02847       *buddyname = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02848"></a>02848       buddyname++;
<a name="l02849"></a>02849       <span class="keywordflow">if</span> (buddyname &amp;&amp; buddyname[0] != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02850"></a>02850          <span class="keywordflow">if</span> ((user = strchr(buddyname, <span class="charliteral">&apos;,&apos;</span>))) {
<a name="l02851"></a>02851             *user = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02852"></a>02852             user++;
<a name="l02853"></a>02853             <span class="keywordflow">if</span> (user &amp;&amp; user[0] != <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02854"></a>02854                <span class="keywordflow">if</span> ((pass = strchr(user, <span class="charliteral">&apos;,&apos;</span>))) {
<a name="l02855"></a>02855                   *pass = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02856"></a>02856                   pass++;
<a name="l02857"></a>02857                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;pass, pass, <span class="keyword">sizeof</span>(buddy-&gt;pass));
<a name="l02858"></a>02858                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;user, user, <span class="keyword">sizeof</span>(buddy-&gt;user));
<a name="l02859"></a>02859                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>, buddyname, <span class="keyword">sizeof</span>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>));
<a name="l02860"></a>02860                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;server, server, <span class="keyword">sizeof</span>(buddy-&gt;server));
<a name="l02861"></a>02861                   <span class="keywordflow">return</span> 1;
<a name="l02862"></a>02862                }
<a name="l02863"></a>02863             }
<a name="l02864"></a>02864          }
<a name="l02865"></a>02865       }
<a name="l02866"></a>02866    }
<a name="l02867"></a>02867    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(buddy);
<a name="l02868"></a>02868    <a class="code" href="astobj_8h.html#a789fc1432f54cb615e839f0db9decad5" title="Unmark an ASTOBJ by subtracting the ASTOBJ_FLAG_MARKED flag from its objflags mask...">ASTOBJ_UNMARK</a>(buddy);
<a name="l02869"></a>02869    <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, buddy);
<a name="l02870"></a>02870    <span class="keywordflow">return</span> 0;
<a name="l02871"></a>02871 }
<a name="l02872"></a>02872 <span class="preprocessor">#endif</span>
<a name="l02873"></a>02873 <span class="preprocessor"></span><span class="comment"></span>
<a name="l02874"></a>02874 <span class="comment">/*!</span>
<a name="l02875"></a>02875 <span class="comment"> * \brief creates buddy.</span>
<a name="l02876"></a>02876 <span class="comment"> * \param label char.</span>
<a name="l02877"></a>02877 <span class="comment"> * \param client the configured XMPP client we use to connect to a XMPP server </span>
<a name="l02878"></a>02878 <span class="comment"> * \return 1 on success, 0 on failure.</span>
<a name="l02879"></a>02879 <span class="comment"> */</span>
<a name="l02880"></a><a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371">02880</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a1097eeb9e8887f482496e95a77cbb371" title="creates buddy.">aji_create_buddy</a>(<span class="keywordtype">char</span> *label, <span class="keyword">struct</span> <a class="code" href="structaji__client.html">aji_client</a> *client)
<a name="l02881"></a>02881 {
<a name="l02882"></a>02882    <span class="keyword">struct </span><a class="code" href="structaji__buddy.html">aji_buddy</a> *buddy = NULL;
<a name="l02883"></a>02883    <span class="keywordtype">int</span> flag = 0;
<a name="l02884"></a>02884    buddy = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>,label);
<a name="l02885"></a>02885    <span class="keywordflow">if</span> (!buddy) {
<a name="l02886"></a>02886       flag = 1;
<a name="l02887"></a>02887       buddy = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*buddy));
<a name="l02888"></a>02888       <span class="keywordflow">if</span>(!buddy) {
<a name="l02889"></a>02889          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Out of memory\n&quot;</span>);
<a name="l02890"></a>02890          <span class="keywordflow">return</span> 0;
<a name="l02891"></a>02891       }
<a name="l02892"></a>02892       <a class="code" href="astobj_8h.html#a996db3d193843755068f61f21e14c3dd" title="Initialize an object.">ASTOBJ_INIT</a>(buddy);
<a name="l02893"></a>02893    }
<a name="l02894"></a>02894    <a class="code" href="astobj_8h.html#ab4a4c9fe0af3b6237d81ae6fd7b857d4" title="Lock an ASTOBJ for writing.">ASTOBJ_WRLOCK</a>(buddy);
<a name="l02895"></a>02895    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>, label, <span class="keyword">sizeof</span>(buddy-&gt;<a class="code" href="structaji__buddy.html#aa65d2e8413d62f15b0528e19af53a2b4">name</a>));
<a name="l02896"></a>02896    <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(buddy);
<a name="l02897"></a>02897    <span class="keywordflow">if</span>(flag)
<a name="l02898"></a>02898       <a class="code" href="astobj_8h.html#a73bb2d9f59430fd47007a3c6ea651de6" title="Add an object to a container.">ASTOBJ_CONTAINER_LINK</a>(&amp;client-&gt;<a class="code" href="structaji__client.html#acb477f162f95d7daa23c110e9ce62b60">buddies</a>, buddy);
<a name="l02899"></a>02899    <span class="keywordflow">else</span> {
<a name="l02900"></a>02900       <a class="code" href="astobj_8h.html#a789fc1432f54cb615e839f0db9decad5" title="Unmark an ASTOBJ by subtracting the ASTOBJ_FLAG_MARKED flag from its objflags mask...">ASTOBJ_UNMARK</a>(buddy);
<a name="l02901"></a>02901       <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(buddy, <a class="code" href="res__jabber_8c.html#a8df4b1f53a33f2e7f894be7b69dba561" title="Deletes the aji_buddy data structure.">aji_buddy_destroy</a>);
<a name="l02902"></a>02902    }
<a name="l02903"></a>02903    <span class="keywordflow">return</span> 1;
<a name="l02904"></a>02904 }
<a name="l02905"></a>02905 <span class="comment"></span>
<a name="l02906"></a>02906 <span class="comment">/*!&lt; load config file. \return 1. */</span>
<a name="l02907"></a><a class="code" href="res__jabber_8c.html#ae5802ee540d5ced70ff5a0b32d20bb70">02907</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ae5802ee540d5ced70ff5a0b32d20bb70">aji_load_config</a>(<span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>)
<a name="l02908"></a>02908 {
<a name="l02909"></a>02909    <span class="keywordtype">char</span> *cat = NULL;
<a name="l02910"></a>02910    <span class="keywordtype">int</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a> = 1;
<a name="l02911"></a>02911    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg = NULL;
<a name="l02912"></a>02912    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a> = NULL;
<a name="l02913"></a>02913    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l02914"></a>02914 
<a name="l02915"></a>02915    <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="res__jabber_8c.html#ae61bb5ae111d446dd928959847812526">JABBER_CONFIG</a>, config_flags)) == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>)
<a name="l02916"></a>02916       <span class="keywordflow">return</span> -1;
<a name="l02917"></a>02917 
<a name="l02918"></a>02918    <span class="comment">/* Reset flags to default value */</span>
<a name="l02919"></a>02919    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;globalflags, <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02920"></a>02920 
<a name="l02921"></a>02921    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l02922"></a>02922       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such configuration file %s\n&quot;</span>, <a class="code" href="res__jabber_8c.html#ae61bb5ae111d446dd928959847812526">JABBER_CONFIG</a>);
<a name="l02923"></a>02923       <span class="keywordflow">return</span> 0;
<a name="l02924"></a>02924    }
<a name="l02925"></a>02925 
<a name="l02926"></a>02926    cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l02927"></a>02927    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02928"></a>02928       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;debug&quot;</span>)) {
<a name="l02929"></a>02929          debug = (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;debug&quot;</span>))) ? 0 : 1;
<a name="l02930"></a>02930       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoprune&quot;</span>)) {
<a name="l02931"></a>02931          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;globalflags, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a5bf8f469c15d256015b2a3084bcdef59">AJI_AUTOPRUNE</a>);
<a name="l02932"></a>02932       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autoregister&quot;</span>)) {
<a name="l02933"></a>02933          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(&amp;globalflags, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>), <a class="code" href="jabber_8h.html#aeac2de18c0ed342a690b3e2ba3c52426a7f858074245d785e6248f4abea89b260">AJI_AUTOREGISTER</a>);
<a name="l02934"></a>02934       }
<a name="l02935"></a>02935    }
<a name="l02936"></a>02936 
<a name="l02937"></a>02937    <span class="keywordflow">while</span> (cat) {
<a name="l02938"></a>02938       <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l02939"></a>02939             var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat);
<a name="l02940"></a>02940             <a class="code" href="res__jabber_8c.html#a6381553337670894fe004c0536752062" title="creates aji_client structure.">aji_create_client</a>(cat, var, debug);
<a name="l02941"></a>02941       }
<a name="l02942"></a>02942       cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat);
<a name="l02943"></a>02943    }
<a name="l02944"></a>02944    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg); <span class="comment">/* or leak memory */</span>
<a name="l02945"></a>02945    <span class="keywordflow">return</span> 1;
<a name="l02946"></a>02946 }
<a name="l02947"></a>02947 <span class="comment"></span>
<a name="l02948"></a>02948 <span class="comment">/*!</span>
<a name="l02949"></a>02949 <span class="comment"> * \brief grab a aji_client structure by label name or JID </span>
<a name="l02950"></a>02950 <span class="comment"> * (without the resource string)</span>
<a name="l02951"></a>02951 <span class="comment"> * \param name label or JID </span>
<a name="l02952"></a>02952 <span class="comment"> * \return aji_client.</span>
<a name="l02953"></a>02953 <span class="comment"> */</span>
<a name="l02954"></a><a class="code" href="res__jabber_8c.html#a6689c8e948c8d55e092f30277336fde7">02954</a> <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *<a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l02955"></a>02955 {
<a name="l02956"></a>02956    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l02957"></a>02957    <span class="keywordtype">char</span> *aux = NULL;
<a name="l02958"></a>02958 
<a name="l02959"></a>02959    client = <a class="code" href="astobj_8h.html#aca5d7206cd0c6817140bba786a9b6b8a" title="Find an object in a container.">ASTOBJ_CONTAINER_FIND</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, name);
<a name="l02960"></a>02960    <span class="keywordflow">if</span> (!client &amp;&amp; strchr(name, <span class="charliteral">&apos;@&apos;</span>)) {
<a name="l02961"></a>02961       <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l02962"></a>02962          aux = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(iterator-&gt;user);
<a name="l02963"></a>02963          <span class="keywordflow">if</span> (strchr(aux, <span class="charliteral">&apos;/&apos;</span>)) {
<a name="l02964"></a>02964             <span class="comment">/* strip resource for comparison */</span>
<a name="l02965"></a>02965             aux = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;aux, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l02966"></a>02966          }
<a name="l02967"></a>02967          <span class="keywordflow">if</span> (!strncasecmp(aux, name, strlen(aux))) {
<a name="l02968"></a>02968             client = iterator;
<a name="l02969"></a>02969          }           
<a name="l02970"></a>02970       });
<a name="l02971"></a>02971    }
<a name="l02972"></a>02972 
<a name="l02973"></a>02973    <span class="keywordflow">return</span> client;
<a name="l02974"></a>02974 }
<a name="l02975"></a>02975 
<a name="l02976"></a><a class="code" href="res__jabber_8c.html#a740bf5f4ba6bf40ff9273ca8f7a89710">02976</a> <span class="keyword">struct </span><a class="code" href="structaji__client__container.html">aji_client_container</a> *<a class="code" href="jabber_8h.html#a740bf5f4ba6bf40ff9273ca8f7a89710">ast_aji_get_clients</a>(<span class="keywordtype">void</span>)
<a name="l02977"></a>02977 {
<a name="l02978"></a>02978    <span class="keywordflow">return</span> &amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>;
<a name="l02979"></a>02979 }
<a name="l02980"></a>02980 
<a name="l02981"></a><a class="code" href="res__jabber_8c.html#a06597455b511878dd26b69b5bfc4e529">02981</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__jabber_8c.html#a06597455b511878dd26b69b5bfc4e529">mandescr_jabber_send</a>[] =
<a name="l02982"></a>02982 <span class="stringliteral">&quot;Description: Sends a message to a Jabber Client.\n&quot;</span>
<a name="l02983"></a>02983 <span class="stringliteral">&quot;Variables: \n&quot;</span>
<a name="l02984"></a>02984 <span class="stringliteral">&quot;  Jabber:    Client or transport Asterisk uses to connect to JABBER\n&quot;</span>
<a name="l02985"></a>02985 <span class="stringliteral">&quot;  JID:       XMPP/Jabber JID (Name) of recipient\n&quot;</span> 
<a name="l02986"></a>02986 <span class="stringliteral">&quot;  Message:   Message to be sent to the buddy\n&quot;</span>;
<a name="l02987"></a>02987 <span class="comment"></span>
<a name="l02988"></a>02988 <span class="comment">/*! </span>
<a name="l02989"></a>02989 <span class="comment"> * \brief  Send a Jabber Message via call from the Manager </span>
<a name="l02990"></a>02990 <span class="comment"> * \param s mansession Manager session</span>
<a name="l02991"></a>02991 <span class="comment"> * \param m message Message to send</span>
<a name="l02992"></a>02992 <span class="comment"> * \return  0</span>
<a name="l02993"></a>02993 <span class="comment">*/</span>
<a name="l02994"></a><a class="code" href="res__jabber_8c.html#a48ebc7a99890a29f1901304e574d4f03">02994</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#a48ebc7a99890a29f1901304e574d4f03" title="Send a Jabber Message via call from the Manager.">manager_jabber_send</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l02995"></a>02995 {
<a name="l02996"></a>02996    <span class="keyword">struct </span><a class="code" href="structaji__client.html">aji_client</a> *client = NULL;
<a name="l02997"></a>02997    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l02998"></a>02998    <span class="keyword">const</span> <span class="keywordtype">char</span> *jabber = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;Jabber&quot;</span>);
<a name="l02999"></a>02999    <span class="keyword">const</span> <span class="keywordtype">char</span> *screenname = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;ScreenName&quot;</span>);
<a name="l03000"></a>03000    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structmessage.html">message</a> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m,<span class="stringliteral">&quot;Message&quot;</span>);
<a name="l03001"></a>03001 
<a name="l03002"></a>03002    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(jabber)) {
<a name="l03003"></a>03003       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No transport specified&quot;</span>);
<a name="l03004"></a>03004       <span class="keywordflow">return</span> 0;
<a name="l03005"></a>03005    }
<a name="l03006"></a>03006    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(screenname)) {
<a name="l03007"></a>03007       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No ScreenName specified&quot;</span>);
<a name="l03008"></a>03008       <span class="keywordflow">return</span> 0;
<a name="l03009"></a>03009    }
<a name="l03010"></a>03010    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(message)) {
<a name="l03011"></a>03011       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No Message specified&quot;</span>);
<a name="l03012"></a>03012       <span class="keywordflow">return</span> 0;
<a name="l03013"></a>03013    }
<a name="l03014"></a>03014 
<a name="l03015"></a>03015    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Attempting to send Jabber Message&quot;</span>);
<a name="l03016"></a>03016    client = <a class="code" href="jabber_8h.html#a6689c8e948c8d55e092f30277336fde7" title="grab a aji_client structure by label name or JID (without the resource string)">ast_aji_get_client</a>(jabber);
<a name="l03017"></a>03017    <span class="keywordflow">if</span> (!client) {
<a name="l03018"></a>03018       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Could not find Sender&quot;</span>);
<a name="l03019"></a>03019       <span class="keywordflow">return</span> 0;
<a name="l03020"></a>03020    }
<a name="l03021"></a>03021    <span class="keywordflow">if</span> (strchr(screenname, <span class="charliteral">&apos;@&apos;</span>) &amp;&amp; message) {
<a name="l03022"></a>03022       <a class="code" href="jabber_8h.html#af2b674ed94b89a5798fe22714a44f046" title="sends messages.">ast_aji_send_chat</a>(client, screenname, message);
<a name="l03023"></a>03023       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Response: Success\r\n&quot;</span>);
<a name="l03024"></a>03024    } <span class="keywordflow">else</span> {
<a name="l03025"></a>03025       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Response: Error\r\n&quot;</span>);
<a name="l03026"></a>03026    }
<a name="l03027"></a>03027    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>)) {
<a name="l03028"></a>03028       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>,<span class="keywordtype">id</span>);
<a name="l03029"></a>03029    }
<a name="l03030"></a>03030    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;\r\n&quot;</span>);
<a name="l03031"></a>03031    <span class="keywordflow">return</span> 0;
<a name="l03032"></a>03032 }
<a name="l03033"></a>03033 <span class="comment"></span>
<a name="l03034"></a>03034 <span class="comment">/*! \brief Reload the jabber module */</span>
<a name="l03035"></a><a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de">03035</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(<span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>)
<a name="l03036"></a>03036 {
<a name="l03037"></a>03037    <span class="keywordtype">int</span> res;
<a name="l03038"></a>03038 
<a name="l03039"></a>03039    <a class="code" href="astobj_8h.html#a5e865869ca1acadd652b42810fec2ec9" title="Mark all the objects in a container.">ASTOBJ_CONTAINER_MARKALL</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>);
<a name="l03040"></a>03040    <span class="keywordflow">if</span> (!(res = <a class="code" href="res__jabber_8c.html#ae5802ee540d5ced70ff5a0b32d20bb70">aji_load_config</a>(reload))) {
<a name="l03041"></a>03041       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;JABBER: Failed to load config.\n&quot;</span>);
<a name="l03042"></a>03042       <span class="keywordflow">return</span> 0;
<a name="l03043"></a>03043    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1)
<a name="l03044"></a>03044       <span class="keywordflow">return</span> 1;
<a name="l03045"></a>03045 
<a name="l03046"></a>03046    <a class="code" href="astobj_8h.html#a794727ca4ef71982250ff9f36a9668d7" title="Prune marked objects from a container.">ASTOBJ_CONTAINER_PRUNE_MARKED</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l03047"></a>03047    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l03048"></a>03048       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l03049"></a>03049       <span class="keywordflow">if</span>(iterator-&gt;state == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a46d3c148625b0889f793b6c355051d3b">AJI_DISCONNECTED</a>) {
<a name="l03050"></a>03050          <span class="keywordflow">if</span> (!iterator-&gt;thread)
<a name="l03051"></a>03051             <a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;iterator-&gt;thread, NULL, <a class="code" href="res__jabber_8c.html#a29f749367c5d39d4eb02841f70a07006" title="receive message loop.">aji_recv_loop</a>, iterator);
<a name="l03052"></a>03052       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (iterator-&gt;state == <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0ade80d6f33c170eeaeb1fbc84ebdb1a2f">AJI_CONNECTING</a>)
<a name="l03053"></a>03053          <a class="code" href="res__jabber_8c.html#a064f178d1c5b750e1ee2c0a80da62771" title="Get the roster of jabber users.">aji_get_roster</a>(iterator);
<a name="l03054"></a>03054       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l03055"></a>03055    });
<a name="l03056"></a>03056    
<a name="l03057"></a>03057    <span class="keywordflow">return</span> 1;
<a name="l03058"></a>03058 }
<a name="l03059"></a>03059 <span class="comment"></span>
<a name="l03060"></a>03060 <span class="comment">/*! \brief Unload the jabber module */</span>
<a name="l03061"></a><a class="code" href="res__jabber_8c.html#ad09fa931f468002152a3cc2d5ce25eae">03061</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l03062"></a>03062 {
<a name="l03063"></a>03063 
<a name="l03064"></a>03064    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(aji_cli, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(aji_cli));
<a name="l03065"></a>03065    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_ajisend);
<a name="l03066"></a>03066    <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_ajistatus);
<a name="l03067"></a>03067    <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;JabberSend&quot;</span>);
<a name="l03068"></a>03068    <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;jabberstatus_function);
<a name="l03069"></a>03069    
<a name="l03070"></a>03070    <a class="code" href="astobj_8h.html#a8483cbd2bcf0b91ac62168fb1cb7f5b1" title="Iterate through the objects in a container.">ASTOBJ_CONTAINER_TRAVERSE</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, 1, {
<a name="l03071"></a>03071       <a class="code" href="astobj_8h.html#a8d411cc142b0b49472fe38cf7b0845e1" title="Lock an ASTOBJ for reading.">ASTOBJ_RDLOCK</a>(iterator);
<a name="l03072"></a>03072       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;JABBER: Releasing and disconnecting client: %s\n&quot;</span>, iterator-&gt;name);
<a name="l03073"></a>03073       iterator-&gt;state = <a class="code" href="jabber_8h.html#a75f56fc355bdf37aa9ed1ee97b5986b0a9f2e9be855a781b74badbe0c1bda278e">AJI_DISCONNECTING</a>;
<a name="l03074"></a>03074       <a class="code" href="jabber_8h.html#a06f01ad5dc78d9300fed1415b54be04a" title="disconnect from jabber server.">ast_aji_disconnect</a>(iterator);
<a name="l03075"></a>03075       pthread_join(iterator-&gt;thread, NULL);
<a name="l03076"></a>03076       <a class="code" href="astobj_8h.html#a9acee27cc52e8533d439f6cc10d11fbc" title="Unlock a locked object.">ASTOBJ_UNLOCK</a>(iterator);
<a name="l03077"></a>03077    });
<a name="l03078"></a>03078 
<a name="l03079"></a>03079    <a class="code" href="astobj_8h.html#a5b923418ce1d4908359bb3b27b211411" title="Empty a container.">ASTOBJ_CONTAINER_DESTROYALL</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>, <a class="code" href="res__jabber_8c.html#a86b1a4282e5190def65358b7867a5207" title="Deletes the aji_client data structure.">aji_client_destroy</a>);
<a name="l03080"></a>03080    <a class="code" href="astobj_8h.html#a49ab9467549d53be33f3f9f3ecae97f9" title="Destroy a container.">ASTOBJ_CONTAINER_DESTROY</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>);
<a name="l03081"></a>03081    <span class="keywordflow">return</span> 0;
<a name="l03082"></a>03082 }
<a name="l03083"></a>03083 <span class="comment"></span>
<a name="l03084"></a>03084 <span class="comment">/*! \brief Unload the jabber module */</span>
<a name="l03085"></a><a class="code" href="res__jabber_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">03085</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Unload the jabber module.">load_module</a>(<span class="keywordtype">void</span>)
<a name="l03086"></a>03086 {
<a name="l03087"></a>03087    <a class="code" href="astobj_8h.html#a8551f606c8aecc4797ef7728c7792827" title="Initialize a container.">ASTOBJ_CONTAINER_INIT</a>(&amp;<a class="code" href="res__jabber_8c.html#a412e6d5d6035a37146acd5af40e881cb">clients</a>);
<a name="l03088"></a>03088    <span class="keywordflow">if</span>(!<a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(0))
<a name="l03089"></a>03089       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l03090"></a>03090    <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;JabberSend&quot;</span>, <a class="code" href="manager_8h.html#a420f0f755e1c3378b45ca7f6f0669ffa">EVENT_FLAG_SYSTEM</a>, <a class="code" href="res__jabber_8c.html#a48ebc7a99890a29f1901304e574d4f03" title="Send a Jabber Message via call from the Manager.">manager_jabber_send</a>,
<a name="l03091"></a>03091          <span class="stringliteral">&quot;Sends a message to a Jabber Client&quot;</span>, mandescr_jabber_send);
<a name="l03092"></a>03092    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_ajisend, <a class="code" href="res__jabber_8c.html#a26515ff8bd0588f1181bb6a3abc56f90" title="Dial plan function to send a message.">aji_send_exec</a>);
<a name="l03093"></a>03093    <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_ajistatus, <a class="code" href="res__jabber_8c.html#af34ff341cd5689c2c1355daf38e38682" title="Dial plan function status(). puts the status of watched user into a channel variable...">aji_status_exec</a>);
<a name="l03094"></a>03094    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(aji_cli, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(aji_cli));
<a name="l03095"></a>03095    <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;jabberstatus_function);
<a name="l03096"></a>03096 
<a name="l03097"></a>03097    <span class="keywordflow">return</span> 0;
<a name="l03098"></a>03098 }
<a name="l03099"></a>03099 <span class="comment"></span>
<a name="l03100"></a>03100 <span class="comment">/*! \brief Wrapper for aji_reload */</span>
<a name="l03101"></a><a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668">03101</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>(<span class="keywordtype">void</span>)
<a name="l03102"></a>03102 {
<a name="l03103"></a>03103    <a class="code" href="res__jabber_8c.html#ad7e3d90484987374674cd6568d39a3de" title="Reload the jabber module.">aji_reload</a>(1);
<a name="l03104"></a>03104    <span class="keywordflow">return</span> 0;
<a name="l03105"></a>03105 }
<a name="l03106"></a>03106 
<a name="l03107"></a>03107 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a835b27a90d895a488e4e14cc3d2dee8c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">&quot;AJI - Asterisk Jabber Interface&quot;</span>,
<a name="l03108"></a>03108       .load = <a class="code" href="res__jabber_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9" title="Unload the jabber module.">load_module</a>,
<a name="l03109"></a>03109       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l03110"></a>03110       .<a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a> = <a class="code" href="res__jabber_8c.html#ad1982509765f4870f1f63412a53ea668" title="Wrapper for aji_reload.">reload</a>,
<a name="l03111"></a><a class="code" href="res__jabber_8c.html#ae25b9f3970870610911f8850897e8ead">03111</a>           );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:46 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
