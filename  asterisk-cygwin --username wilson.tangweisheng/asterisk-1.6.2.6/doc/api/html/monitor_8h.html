<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:22:24 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_1ab815038f534adda65c8b4ae4993449.html">include</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_16d825f1fa9ecca2e70b1a8d9256d0e6.html">asterisk</a>
  </div>
</div>
<div class="contents">
<h1>monitor.h File Reference</h1>
<p>Channel monitoring.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>

<p><a href="monitor_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Data Structures</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="structast__channel__monitor.html">ast_channel_monitor</a></td></tr>
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#ac938418713970abe50535bcd17697dbd">X_JOIN</a>&nbsp;&nbsp;&nbsp;4</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a95b90f61870300ea984afae5123dd44f">X_REC_IN</a>&nbsp;&nbsp;&nbsp;1</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#ac03869f26afacb6d45355d401ced19d8">X_REC_OUT</a>&nbsp;&nbsp;&nbsp;2</td></tr>
<tr><td colspan="2"><h2>Enumerations</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">enum &nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868df">AST_MONITORING_STATE</a> { <a class="el" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dface918b901d180f5ea85f8a941fc8cbdb">AST_MONITOR_RUNNING</a>, 
<a class="el" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dfaaa5de0713f705b8e962f613e0797015d">AST_MONITOR_PAUSED</a>
 }</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#ab339a19ed613598412944dcc380afc60">ast_monitor_change_fname</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *fname_base, int need_lock) attribute_weak</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Change monitored filename of channel.  <a href="#ab339a19ed613598412944dcc380afc60"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a65c488d10682d8be4a53fb0b2e380711">ast_monitor_pause</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>) attribute_weak</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Pause monitoring of channel.  <a href="#a65c488d10682d8be4a53fb0b2e380711"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a170e08ebc79dab55c1ff3a5fd4d9214e">ast_monitor_setjoinfiles</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, int turnon) attribute_weak</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a5c2b029a972b1819e2baaa63906d5bc6">ast_monitor_start</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *format_spec, const char *fname_base, int need_lock, int stream_action) attribute_weak</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Start monitoring a channel.  <a href="#a5c2b029a972b1819e2baaa63906d5bc6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a253c38ba1cc3e91586210246b3255234">ast_monitor_stop</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, int need_lock) attribute_weak</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Stop monitoring channel.  <a href="#a253c38ba1cc3e91586210246b3255234"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="monitor_8h.html#a07e2488c28aae7fc4757e45451523740">ast_monitor_unpause</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>) attribute_weak</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Unpause monitoring of channel.  <a href="#a07e2488c28aae7fc4757e45451523740"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Channel monitoring. </p>

<p>Definition in file <a class="el" href="monitor_8h_source.html">monitor.h</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="ac938418713970abe50535bcd17697dbd"></a><!-- doxytag: member="monitor.h::X_JOIN" ref="ac938418713970abe50535bcd17697dbd" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define X_JOIN&nbsp;&nbsp;&nbsp;4</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="monitor_8h_source.html#l00036">36</a> of file <a class="el" href="monitor_8h_source.html">monitor.h</a>.</p>

<p>Referenced by <a class="el" href="res__monitor_8c_source.html#l00495">start_monitor_exec()</a>.</p>

</div>
</div>
<a class="anchor" id="a95b90f61870300ea984afae5123dd44f"></a><!-- doxytag: member="monitor.h::X_REC_IN" ref="a95b90f61870300ea984afae5123dd44f" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define X_REC_IN&nbsp;&nbsp;&nbsp;1</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="monitor_8h_source.html#l00034">34</a> of file <a class="el" href="monitor_8h_source.html">monitor.h</a>.</p>

<p>Referenced by <a class="el" href="chan__agent_8c_source.html#l00486">__agent_start_monitoring()</a>, <a class="el" href="res__monitor_8c_source.html#l00148">ast_monitor_start()</a>, <a class="el" href="res__monitor_8c_source.html#l00605">start_monitor_action()</a>, <a class="el" href="res__monitor_8c_source.html#l00495">start_monitor_exec()</a>, and <a class="el" href="app__queue_8c_source.html#l03569">try_calling()</a>.</p>

</div>
</div>
<a class="anchor" id="ac03869f26afacb6d45355d401ced19d8"></a><!-- doxytag: member="monitor.h::X_REC_OUT" ref="ac03869f26afacb6d45355d401ced19d8" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define X_REC_OUT&nbsp;&nbsp;&nbsp;2</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="monitor_8h_source.html#l00035">35</a> of file <a class="el" href="monitor_8h_source.html">monitor.h</a>.</p>

<p>Referenced by <a class="el" href="chan__agent_8c_source.html#l00486">__agent_start_monitoring()</a>, <a class="el" href="res__monitor_8c_source.html#l00148">ast_monitor_start()</a>, <a class="el" href="res__monitor_8c_source.html#l00605">start_monitor_action()</a>, <a class="el" href="res__monitor_8c_source.html#l00495">start_monitor_exec()</a>, and <a class="el" href="app__queue_8c_source.html#l03569">try_calling()</a>.</p>

</div>
</div>
<hr/><h2>Enumeration Type Documentation</h2>
<a class="anchor" id="a9b57685a45dd0700625ea8ba83a868df"></a><!-- doxytag: member="monitor.h::AST_MONITORING_STATE" ref="a9b57685a45dd0700625ea8ba83a868df" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">enum <a class="el" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868df">AST_MONITORING_STATE</a></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<dl><dt><b>Enumerator: </b></dt><dd><table border="0" cellspacing="2" cellpadding="0">
<tr><td valign="top"><em><a class="anchor" id="a9b57685a45dd0700625ea8ba83a868dface918b901d180f5ea85f8a941fc8cbdb"></a><!-- doxytag: member="AST_MONITOR_RUNNING" ref="a9b57685a45dd0700625ea8ba83a868dface918b901d180f5ea85f8a941fc8cbdb" args="" -->AST_MONITOR_RUNNING</em>&nbsp;</td><td>
</td></tr>
<tr><td valign="top"><em><a class="anchor" id="a9b57685a45dd0700625ea8ba83a868dfaaa5de0713f705b8e962f613e0797015d"></a><!-- doxytag: member="AST_MONITOR_PAUSED" ref="a9b57685a45dd0700625ea8ba83a868dfaaa5de0713f705b8e962f613e0797015d" args="" -->AST_MONITOR_PAUSED</em>&nbsp;</td><td>
</td></tr>
</table>
</dd>
</dl>

<p>Definition at line <a class="el" href="monitor_8h_source.html#l00028">28</a> of file <a class="el" href="monitor_8h_source.html">monitor.h</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00028"></a>00028                           {
<a name="l00029"></a>00029    <a class="code" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dface918b901d180f5ea85f8a941fc8cbdb">AST_MONITOR_RUNNING</a>,
<a name="l00030"></a>00030    <a class="code" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dfaaa5de0713f705b8e962f613e0797015d">AST_MONITOR_PAUSED</a>
<a name="l00031"></a>00031 };
</pre></div></p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="ab339a19ed613598412944dcc380afc60"></a><!-- doxytag: member="monitor.h::ast_monitor_change_fname" ref="ab339a19ed613598412944dcc380afc60" args="(struct ast_channel *chan, const char *fname_base, int need_lock) attribute_weak" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_monitor_change_fname </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>fname_base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>need_lock</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Change monitored filename of channel. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fname_base</em>&nbsp;</td><td>new filename </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>need_lock</em>&nbsp;</td><td></td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure. </td></tr>
  </table>
  </dd>
</dl>

<p><dl class="note"><dt><b>Note:</b></dt><dd>We cannot just compare filenames, due to symlinks, relative paths, and other possible filesystem issues. We could use realpath(3), but its use is discouraged. However, if we try to create the same file from two different paths, the second will fail, and so we have our notification that the filenames point to the same path.</dd></dl>
<p>Remember, also, that we're using the basename of the file (i.e. the file without the format suffix), so it does not already exist and we aren't interfering with the recording itself.</p>
</p>

<p>Definition at line <a class="el" href="res__monitor_8c_source.html#l00415">415</a> of file <a class="el" href="res__monitor_8c_source.html">res_monitor.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00252">ast_config_AST_MONITOR_DIR</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l01765">ast_mkdir()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="monitor_8h_source.html#l00044">ast_channel_monitor::filename_base</a>, <a class="el" href="monitor_8h_source.html#l00045">ast_channel_monitor::filename_changed</a>, <a class="el" href="res__monitor_8c_source.html#l00050">LOCK_IF_NEEDED</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="channel_8h_source.html#l00425">ast_channel::monitor</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, and <a class="el" href="res__monitor_8c_source.html#l00055">UNLOCK_IF_NEEDED</a>.</p>

<p>Referenced by <a class="el" href="res__monitor_8c_source.html#l00688">change_monitor_action()</a>, <a class="el" href="res__monitor_8c_source.html#l00585">change_monitor_exec()</a>, <a class="el" href="res__monitor_8c_source.html#l00605">start_monitor_action()</a>, and <a class="el" href="res__monitor_8c_source.html#l00495">start_monitor_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00416"></a>00416 {
<a name="l00417"></a>00417    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(fname_base)) {
<a name="l00418"></a>00418       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot change monitor filename of channel %s to null\n&quot;</span>, chan-&gt;name);
<a name="l00419"></a>00419       <span class="keywordflow">return</span> -1;
<a name="l00420"></a>00420    }
<a name="l00421"></a>00421 
<a name="l00422"></a>00422    <a class="code" href="res__monitor_8c.html#a020604393fec8dbcab1897c13bdd44e7">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00423"></a>00423 
<a name="l00424"></a>00424    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>) {
<a name="l00425"></a>00425       <span class="keywordtype">int</span> directory = strchr(fname_base, <span class="charliteral">&apos;/&apos;</span>) ? 1 : 0;
<a name="l00426"></a>00426       <span class="keyword">const</span> <span class="keywordtype">char</span> *absolute = *fname_base == <span class="charliteral">&apos;/&apos;</span> ? <span class="stringliteral">&quot;&quot;</span> : <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>;
<a name="l00427"></a>00427       <span class="keywordtype">char</span> tmpstring[<span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>)] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00428"></a>00428       <span class="keywordtype">int</span> i, fd[2] = { -1, -1 }, doexit = 0;
<a name="l00429"></a>00429 
<a name="l00430"></a>00430       <span class="comment">/* before continuing, see if we&apos;re trying to rename the file to itself... */</span>
<a name="l00431"></a>00431       snprintf(tmpstring, <span class="keyword">sizeof</span>(tmpstring), <span class="stringliteral">&quot;%s/%s&quot;</span>, absolute, fname_base);
<a name="l00432"></a>00432 <span class="comment"></span>
<a name="l00433"></a>00433 <span class="comment">      /*!\note We cannot just compare filenames, due to symlinks, relative</span>
<a name="l00434"></a>00434 <span class="comment">       * paths, and other possible filesystem issues.  We could use</span>
<a name="l00435"></a>00435 <span class="comment">       * realpath(3), but its use is discouraged.  However, if we try to</span>
<a name="l00436"></a>00436 <span class="comment">       * create the same file from two different paths, the second will</span>
<a name="l00437"></a>00437 <span class="comment">       * fail, and so we have our notification that the filenames point to</span>
<a name="l00438"></a>00438 <span class="comment">       * the same path.</span>
<a name="l00439"></a>00439 <span class="comment">       *</span>
<a name="l00440"></a>00440 <span class="comment">       * Remember, also, that we&apos;re using the basename of the file (i.e.</span>
<a name="l00441"></a>00441 <span class="comment">       * the file without the format suffix), so it does not already exist</span>
<a name="l00442"></a>00442 <span class="comment">       * and we aren&apos;t interfering with the recording itself.</span>
<a name="l00443"></a>00443 <span class="comment">       */</span>
<a name="l00444"></a>00444       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;comparing tmpstring %s to filename_base %s\n&quot;</span>, tmpstring, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>);
<a name="l00445"></a>00445       
<a name="l00446"></a>00446       <span class="keywordflow">if</span> ((fd[0] = open(tmpstring, O_CREAT | O_WRONLY, 0644)) &lt; 0 ||
<a name="l00447"></a>00447          (fd[1] = open(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>, O_CREAT | O_EXCL | O_WRONLY, 0644)) &lt; 0) {
<a name="l00448"></a>00448          <span class="keywordflow">if</span> (fd[0] &lt; 0) {
<a name="l00449"></a>00449             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to compare filenames: %s\n&quot;</span>, strerror(errno));
<a name="l00450"></a>00450          } <span class="keywordflow">else</span> {
<a name="l00451"></a>00451             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;No need to rename monitor filename to itself\n&quot;</span>);
<a name="l00452"></a>00452          }
<a name="l00453"></a>00453          doexit = 1;
<a name="l00454"></a>00454       }
<a name="l00455"></a>00455 
<a name="l00456"></a>00456       <span class="comment">/* Cleanup temporary files */</span>
<a name="l00457"></a>00457       <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l00458"></a>00458          <span class="keywordflow">if</span> (fd[i] &gt;= 0) {
<a name="l00459"></a>00459             <span class="keywordflow">while</span> (close(fd[i]) &lt; 0 &amp;&amp; errno == EINTR);
<a name="l00460"></a>00460          }
<a name="l00461"></a>00461       }
<a name="l00462"></a>00462       unlink(tmpstring);
<a name="l00463"></a>00463       unlink(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465       <span class="keywordflow">if</span> (doexit) {
<a name="l00466"></a>00466          <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00467"></a>00467          <span class="keywordflow">return</span> 0;
<a name="l00468"></a>00468       }
<a name="l00469"></a>00469 
<a name="l00470"></a>00470       <span class="comment">/* try creating the directory just in case it doesn&apos;t exist */</span>
<a name="l00471"></a>00471       <span class="keywordflow">if</span> (directory) {
<a name="l00472"></a>00472          <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fname_base);
<a name="l00473"></a>00473          <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(dirname(name), 0777);
<a name="l00474"></a>00474       }
<a name="l00475"></a>00475 
<a name="l00476"></a>00476       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>, tmpstring, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>));
<a name="l00477"></a>00477       chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a230e3f2ccbf0c5b0701d5f9709eb9f29">filename_changed</a> = 1;
<a name="l00478"></a>00478    } <span class="keywordflow">else</span> {
<a name="l00479"></a>00479       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot change monitor filename of channel %s to %s, monitoring not started\n&quot;</span>, chan-&gt;name, fname_base);
<a name="l00480"></a>00480    }
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00483"></a>00483 
<a name="l00484"></a>00484    <span class="keywordflow">return</span> 0;
<a name="l00485"></a>00485 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a65c488d10682d8be4a53fb0b2e380711"></a><!-- doxytag: member="monitor.h::ast_monitor_pause" ref="a65c488d10682d8be4a53fb0b2e380711" args="(struct ast_channel *chan) attribute_weak" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_monitor_pause </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Pause monitoring of channel. </p>

<p>Definition at line <a class="el" href="res__monitor_8c_source.html#l00384">384</a> of file <a class="el" href="res__monitor_8c_source.html">res_monitor.c</a>.</p>

<p>References <a class="el" href="monitor_8h_source.html#l00030">AST_MONITOR_PAUSED</a>, and <a class="el" href="res__monitor_8c_source.html#l00125">ast_monitor_set_state()</a>.</p>

<p>Referenced by <a class="el" href="res__monitor_8c_source.html#l00728">do_pause_or_unpause()</a>, and <a class="el" href="res__monitor_8c_source.html#l00396">pause_monitor_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00385"></a>00385 {
<a name="l00386"></a>00386    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#ab740a457e68200049b8d7177a3ae96de" title="Change state of monitored channel.">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dfaaa5de0713f705b8e962f613e0797015d">AST_MONITOR_PAUSED</a>);
<a name="l00387"></a>00387 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a170e08ebc79dab55c1ff3a5fd4d9214e"></a><!-- doxytag: member="monitor.h::ast_monitor_setjoinfiles" ref="a170e08ebc79dab55c1ff3a5fd4d9214e" args="(struct ast_channel *chan, int turnon) attribute_weak" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void ast_monitor_setjoinfiles </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>turnon</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="res__monitor_8c_source.html#l00716">716</a> of file <a class="el" href="res__monitor_8c_source.html">res_monitor.c</a>.</p>

<p>References <a class="el" href="monitor_8h_source.html#l00047">ast_channel_monitor::joinfiles</a>, and <a class="el" href="channel_8h_source.html#l00425">ast_channel::monitor</a>.</p>

<p>Referenced by <a class="el" href="chan__agent_8c_source.html#l00486">__agent_start_monitoring()</a>, <a class="el" href="res__monitor_8c_source.html#l00605">start_monitor_action()</a>, <a class="el" href="res__monitor_8c_source.html#l00495">start_monitor_exec()</a>, and <a class="el" href="app__queue_8c_source.html#l03569">try_calling()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00717"></a>00717 {
<a name="l00718"></a>00718    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>)
<a name="l00719"></a>00719       chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a7b71d4ef14ee85d131a71845d8c38926">joinfiles</a> = turnon;
<a name="l00720"></a>00720 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5c2b029a972b1819e2baaa63906d5bc6"></a><!-- doxytag: member="monitor.h::ast_monitor_start" ref="a5c2b029a972b1819e2baaa63906d5bc6" args="(struct ast_channel *chan, const char *format_spec, const char *fname_base, int need_lock, int stream_action) attribute_weak" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_monitor_start </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>format_spec</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>fname_base</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>need_lock</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>stream_action</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Start monitoring a channel. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td><a class="el" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> struct to record </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>format_spec</em>&nbsp;</td><td>file format to use for recording </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>fname_base</em>&nbsp;</td><td>filename base to record to </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>need_lock</em>&nbsp;</td><td>whether to lock the channel mutex </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>stream_action</em>&nbsp;</td><td>whether to record the input and/or output streams. X_REC_IN | X_REC_OUT is most often used Creates the file to record, if no format is specified it assumes WAV It also sets channel variable __MONITORED=yes </td></tr>
  </table>
  </dd>
</dl>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>on success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>-1</em>&nbsp;</td><td>on failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="res__monitor_8c_source.html#l00148">148</a> of file <a class="el" href="res__monitor_8c_source.html">res_monitor.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00072">ast_calloc</a>, <a class="el" href="file_8c_source.html#l00887">ast_closestream()</a>, <a class="el" href="asterisk_8c_source.html#l00252">ast_config_AST_MONITOR_DIR</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="asterisk_8h_source.html#l00036">AST_FILE_MODE</a>, <a class="el" href="file_8c_source.html#l00928">ast_filedelete()</a>, <a class="el" href="file_8c_source.html#l00914">ast_fileexists()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="utils_8c_source.html#l01765">ast_mkdir()</a>, <a class="el" href="monitor_8h_source.html#l00029">AST_MONITOR_RUNNING</a>, <a class="el" href="res__monitor_8c_source.html#l00125">ast_monitor_set_state()</a>, <a class="el" href="res__monitor_8c_source.html#l00291">ast_monitor_stop()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="astmm_8h_source.html#l00099">ast_strdup</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="file_8c_source.html#l01033">ast_writefile()</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="monitor_8h_source.html#l00044">ast_channel_monitor::filename_base</a>, <a class="el" href="monitor_8h_source.html#l00045">ast_channel_monitor::filename_changed</a>, <a class="el" href="private_8h_source.html#l00207">FILENAME_MAX</a>, <a class="el" href="monitor_8h_source.html#l00046">ast_channel_monitor::format</a>, <a class="el" href="res__monitor_8c_source.html#l00050">LOCK_IF_NEEDED</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="chan__phone_8c_source.html#l00107">monitor</a>, <a class="el" href="channel_8h_source.html#l00425">ast_channel::monitor</a>, <a class="el" href="res__monitor_8c_source.html#l00048">monitorlock</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>, <a class="el" href="monitor_8h_source.html#l00042">ast_channel_monitor::read_filename</a>, <a class="el" href="monitor_8h_source.html#l00040">ast_channel_monitor::read_stream</a>, <a class="el" href="structast__channel__monitor.html#ad5c0f502e23625be7e65715c03c54748">ast_channel_monitor::stop</a>, <a class="el" href="res__monitor_8c_source.html#l00055">UNLOCK_IF_NEEDED</a>, <a class="el" href="monitor_8h_source.html#l00043">ast_channel_monitor::write_filename</a>, <a class="el" href="monitor_8h_source.html#l00041">ast_channel_monitor::write_stream</a>, <a class="el" href="monitor_8h_source.html#l00034">X_REC_IN</a>, and <a class="el" href="monitor_8h_source.html#l00035">X_REC_OUT</a>.</p>

<p>Referenced by <a class="el" href="chan__agent_8c_source.html#l00486">__agent_start_monitoring()</a>, <a class="el" href="res__monitor_8c_source.html#l00605">start_monitor_action()</a>, <a class="el" href="res__monitor_8c_source.html#l00495">start_monitor_exec()</a>, and <a class="el" href="app__queue_8c_source.html#l03569">try_calling()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00150"></a>00150 {
<a name="l00151"></a>00151    <span class="keywordtype">int</span> res = 0;
<a name="l00152"></a>00152 
<a name="l00153"></a>00153    <a class="code" href="res__monitor_8c.html#a020604393fec8dbcab1897c13bdd44e7">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00154"></a>00154 
<a name="l00155"></a>00155    <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>)) {
<a name="l00156"></a>00156       <span class="keyword">struct </span><a class="code" href="structast__channel__monitor.html">ast_channel_monitor</a> *<a class="code" href="chan__phone_8c.html#a4e40373706bcf5cdb9409dac3166d280">monitor</a>;
<a name="l00157"></a>00157       <span class="keywordtype">char</span> *channel_name, *p;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159       <span class="comment">/* Create monitoring directory if needed */</span>
<a name="l00160"></a>00160       <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(<a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, 0777);
<a name="l00161"></a>00161 
<a name="l00162"></a>00162       <span class="keywordflow">if</span> (!(monitor = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*monitor)))) {
<a name="l00163"></a>00163          <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00164"></a>00164          <span class="keywordflow">return</span> -1;
<a name="l00165"></a>00165       }
<a name="l00166"></a>00166 
<a name="l00167"></a>00167       <span class="comment">/* Determine file names */</span>
<a name="l00168"></a>00168       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(fname_base)) {
<a name="l00169"></a>00169          <span class="keywordtype">int</span> directory = strchr(fname_base, <span class="charliteral">&apos;/&apos;</span>) ? 1 : 0;
<a name="l00170"></a>00170          <span class="keyword">const</span> <span class="keywordtype">char</span> *absolute = *fname_base == <span class="charliteral">&apos;/&apos;</span> ? <span class="stringliteral">&quot;&quot;</span> : <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>;
<a name="l00171"></a>00171 
<a name="l00172"></a>00172          snprintf(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s/%s-in&quot;</span>,
<a name="l00173"></a>00173                   absolute, fname_base);
<a name="l00174"></a>00174          snprintf(monitor-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s/%s-out&quot;</span>,
<a name="l00175"></a>00175                   absolute, fname_base);
<a name="l00176"></a>00176          snprintf(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s/%s&quot;</span>,
<a name="l00177"></a>00177                   absolute, fname_base);
<a name="l00178"></a>00178 
<a name="l00179"></a>00179          <span class="comment">/* try creating the directory just in case it doesn&apos;t exist */</span>
<a name="l00180"></a>00180          <span class="keywordflow">if</span> (directory) {
<a name="l00181"></a>00181             <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>);
<a name="l00182"></a>00182             <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(dirname(name), 0777);
<a name="l00183"></a>00183          }
<a name="l00184"></a>00184       } <span class="keywordflow">else</span> {
<a name="l00185"></a>00185          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__monitor_8c.html#ab192ebed6ae1909520f4553be0c335d8">monitorlock</a>);
<a name="l00186"></a>00186          snprintf(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s/audio-in-%ld&quot;</span>,
<a name="l00187"></a>00187                   <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, <a class="code" href="res__monitor_8c.html#a189930c4babdc38135a74db479534069">seq</a>);
<a name="l00188"></a>00188          snprintf(monitor-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s/audio-out-%ld&quot;</span>,
<a name="l00189"></a>00189                   <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, <a class="code" href="res__monitor_8c.html#a189930c4babdc38135a74db479534069">seq</a>);
<a name="l00190"></a>00190          <a class="code" href="res__monitor_8c.html#a189930c4babdc38135a74db479534069">seq</a>++;
<a name="l00191"></a>00191          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__monitor_8c.html#ab192ebed6ae1909520f4553be0c335d8">monitorlock</a>);
<a name="l00192"></a>00192 
<a name="l00193"></a>00193          channel_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;name);
<a name="l00194"></a>00194          <span class="keywordflow">while</span> ((p = strchr(channel_name, <span class="charliteral">&apos;/&apos;</span>))) {
<a name="l00195"></a>00195             *p = <span class="charliteral">&apos;-&apos;</span>;
<a name="l00196"></a>00196          }
<a name="l00197"></a>00197          snprintf(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s/%d-%s&quot;</span>,
<a name="l00198"></a>00198                 <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, (<span class="keywordtype">int</span>)time(NULL), channel_name);
<a name="l00199"></a>00199          monitor-&gt;<a class="code" href="structast__channel__monitor.html#a230e3f2ccbf0c5b0701d5f9709eb9f29">filename_changed</a> = 1;
<a name="l00200"></a>00200       }
<a name="l00201"></a>00201 
<a name="l00202"></a>00202       monitor-&gt;<a class="code" href="structast__channel__monitor.html#ad5c0f502e23625be7e65715c03c54748">stop</a> = <a class="code" href="monitor_8h.html#a253c38ba1cc3e91586210246b3255234" title="Stop monitoring channel.">ast_monitor_stop</a>;
<a name="l00203"></a>00203 
<a name="l00204"></a>00204       <span class="comment">/* Determine file format */</span>
<a name="l00205"></a>00205       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(format_spec)) {
<a name="l00206"></a>00206          monitor-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(format_spec);
<a name="l00207"></a>00207       } <span class="keywordflow">else</span> {
<a name="l00208"></a>00208          monitor-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;wav&quot;</span>);
<a name="l00209"></a>00209       }
<a name="l00210"></a>00210       
<a name="l00211"></a>00211       <span class="comment">/* open files */</span>
<a name="l00212"></a>00212       <span class="keywordflow">if</span> (stream_action &amp; <a class="code" href="monitor_8h.html#a95b90f61870300ea984afae5123dd44f">X_REC_IN</a>) {
<a name="l00213"></a>00213          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>, NULL, NULL) &gt; 0)
<a name="l00214"></a>00214             <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>, NULL);
<a name="l00215"></a>00215          <span class="keywordflow">if</span> (!(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a71e6f392234194bc5a27b42b90f9df56">read_stream</a> = <a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>,
<a name="l00216"></a>00216                      monitor-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>, NULL,
<a name="l00217"></a>00217                      O_CREAT|O_TRUNC|O_WRONLY, 0, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>))) {
<a name="l00218"></a>00218             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not create file %s\n&quot;</span>,
<a name="l00219"></a>00219                      monitor-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>);
<a name="l00220"></a>00220             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(monitor);
<a name="l00221"></a>00221             <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00222"></a>00222             <span class="keywordflow">return</span> -1;
<a name="l00223"></a>00223          }
<a name="l00224"></a>00224       } <span class="keywordflow">else</span>
<a name="l00225"></a>00225          monitor-&gt;<a class="code" href="structast__channel__monitor.html#a71e6f392234194bc5a27b42b90f9df56">read_stream</a> = NULL;
<a name="l00226"></a>00226 
<a name="l00227"></a>00227       <span class="keywordflow">if</span> (stream_action &amp; <a class="code" href="monitor_8h.html#ac03869f26afacb6d45355d401ced19d8">X_REC_OUT</a>) {
<a name="l00228"></a>00228          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>, NULL, NULL) &gt; 0) {
<a name="l00229"></a>00229             <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>, NULL);
<a name="l00230"></a>00230          }
<a name="l00231"></a>00231          <span class="keywordflow">if</span> (!(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a0d944be9f8d5fbcf9055775775d99760">write_stream</a> = <a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>,
<a name="l00232"></a>00232                      monitor-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>, NULL,
<a name="l00233"></a>00233                      O_CREAT|O_TRUNC|O_WRONLY, 0, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>))) {
<a name="l00234"></a>00234             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not create file %s\n&quot;</span>,
<a name="l00235"></a>00235                      monitor-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>);
<a name="l00236"></a>00236             <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(monitor-&gt;<a class="code" href="structast__channel__monitor.html#a71e6f392234194bc5a27b42b90f9df56">read_stream</a>);
<a name="l00237"></a>00237             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(monitor);
<a name="l00238"></a>00238             <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00239"></a>00239             <span class="keywordflow">return</span> -1;
<a name="l00240"></a>00240          }
<a name="l00241"></a>00241       } <span class="keywordflow">else</span>
<a name="l00242"></a>00242          monitor-&gt;<a class="code" href="structast__channel__monitor.html#a0d944be9f8d5fbcf9055775775d99760">write_stream</a> = NULL;
<a name="l00243"></a>00243 
<a name="l00244"></a>00244       chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a> = monitor;
<a name="l00245"></a>00245       <a class="code" href="res__monitor_8c.html#ab740a457e68200049b8d7177a3ae96de" title="Change state of monitored channel.">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dface918b901d180f5ea85f8a941fc8cbdb">AST_MONITOR_RUNNING</a>);
<a name="l00246"></a>00246       <span class="comment">/* so we know this call has been monitored in case we need to bill for it or something */</span>
<a name="l00247"></a>00247       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;__MONITORED&quot;</span>,<span class="stringliteral">&quot;true&quot;</span>);
<a name="l00248"></a>00248 
<a name="l00249"></a>00249       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MonitorStart&quot;</span>,
<a name="l00250"></a>00250                          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l00251"></a>00251                           <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,                        
<a name="l00252"></a>00252                            chan-&gt;name,
<a name="l00253"></a>00253                          chan-&gt;uniqueid                        
<a name="l00254"></a>00254                           );
<a name="l00255"></a>00255    } <span class="keywordflow">else</span> {
<a name="l00256"></a>00256       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Cannot start monitoring %s, already monitored\n&quot;</span>, chan-&gt;name);
<a name="l00257"></a>00257       res = -1;
<a name="l00258"></a>00258    }
<a name="l00259"></a>00259 
<a name="l00260"></a>00260    <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00261"></a>00261 
<a name="l00262"></a>00262    <span class="keywordflow">return</span> res;
<a name="l00263"></a>00263 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a253c38ba1cc3e91586210246b3255234"></a><!-- doxytag: member="monitor.h::ast_monitor_stop" ref="a253c38ba1cc3e91586210246b3255234" args="(struct ast_channel *chan, int need_lock) attribute_weak" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_monitor_stop </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>need_lock</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Stop monitoring channel. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td></td></tr>
    <tr><td valign="top"></td><td valign="top"><em>need_lock</em>&nbsp;</td><td>Stop the recording, close any open streams, mix in/out <a class="el" href="structchannels.html" title="the list of channels we have. Note that the lock for this list is used for both the...">channels</a> if required </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Always 0 </dd></dl>

<p>Definition at line <a class="el" href="res__monitor_8c_source.html#l00291">291</a> of file <a class="el" href="res__monitor_8c_source.html">res_monitor.c</a>.</p>

<p>References <a class="el" href="file_8c_source.html#l00887">ast_closestream()</a>, <a class="el" href="asterisk_8c_source.html#l00252">ast_config_AST_MONITOR_DIR</a>, <a class="el" href="strings_8h_source.html#l00218">ast_copy_string()</a>, <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="file_8c_source.html#l00928">ast_filedelete()</a>, <a class="el" href="file_8c_source.html#l00914">ast_fileexists()</a>, <a class="el" href="file_8c_source.html#l00933">ast_filerename()</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="asterisk_8c_source.html#l01001">ast_safe_system()</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="adsistub_8c_source.html#l00077">dir</a>, <a class="el" href="manager_8h_source.html#l00062">EVENT_FLAG_CALL</a>, <a class="el" href="monitor_8h_source.html#l00044">ast_channel_monitor::filename_base</a>, <a class="el" href="monitor_8h_source.html#l00045">ast_channel_monitor::filename_changed</a>, <a class="el" href="private_8h_source.html#l00207">FILENAME_MAX</a>, <a class="el" href="cdr__custom_8c_source.html#l00058">format</a>, <a class="el" href="monitor_8h_source.html#l00046">ast_channel_monitor::format</a>, <a class="el" href="res__monitor_8c_source.html#l00272">get_soxmix_format()</a>, <a class="el" href="monitor_8h_source.html#l00047">ast_channel_monitor::joinfiles</a>, <a class="el" href="res__monitor_8c_source.html#l00050">LOCK_IF_NEEDED</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="manager_8h_source.html#l00181">manager_event</a>, <a class="el" href="channel_8h_source.html#l00425">ast_channel::monitor</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="pbx_8c_source.html#l08951">pbx_builtin_getvar_helper()</a>, <a class="el" href="monitor_8h_source.html#l00042">ast_channel_monitor::read_filename</a>, <a class="el" href="monitor_8h_source.html#l00040">ast_channel_monitor::read_stream</a>, <a class="el" href="res__monitor_8c_source.html#l00055">UNLOCK_IF_NEEDED</a>, <a class="el" href="monitor_8h_source.html#l00043">ast_channel_monitor::write_filename</a>, and <a class="el" href="monitor_8h_source.html#l00041">ast_channel_monitor::write_stream</a>.</p>

<p>Referenced by <a class="el" href="res__monitor_8c_source.html#l00148">ast_monitor_start()</a>, <a class="el" href="res__monitor_8c_source.html#l00655">stop_monitor_action()</a>, and <a class="el" href="res__monitor_8c_source.html#l00579">stop_monitor_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00292"></a>00292 {
<a name="l00293"></a>00293    <span class="keywordtype">int</span> delfiles = 0;
<a name="l00294"></a>00294 
<a name="l00295"></a>00295    <a class="code" href="res__monitor_8c.html#a020604393fec8dbcab1897c13bdd44e7">LOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00296"></a>00296 
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>) {
<a name="l00298"></a>00298       <span class="keywordtype">char</span> filename[ <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a> ];
<a name="l00299"></a>00299 
<a name="l00300"></a>00300       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a71e6f392234194bc5a27b42b90f9df56">read_stream</a>) {
<a name="l00301"></a>00301          <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a71e6f392234194bc5a27b42b90f9df56">read_stream</a>);
<a name="l00302"></a>00302       }
<a name="l00303"></a>00303       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a0d944be9f8d5fbcf9055775775d99760">write_stream</a>) {
<a name="l00304"></a>00304          <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a0d944be9f8d5fbcf9055775775d99760">write_stream</a>);
<a name="l00305"></a>00305       }
<a name="l00306"></a>00306 
<a name="l00307"></a>00307       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a230e3f2ccbf0c5b0701d5f9709eb9f29">filename_changed</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>)) {
<a name="l00308"></a>00308          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>,NULL,NULL) &gt; 0) {
<a name="l00309"></a>00309             snprintf(filename, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s-in&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>);
<a name="l00310"></a>00310             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(filename, NULL, NULL) &gt; 0) {
<a name="l00311"></a>00311                <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(filename, NULL);
<a name="l00312"></a>00312             }
<a name="l00313"></a>00313             <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>, filename, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>);
<a name="l00314"></a>00314          } <span class="keywordflow">else</span> {
<a name="l00315"></a>00315             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;File %s not found\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a9afddcb68bd1c417f69fa2114dba93b4">read_filename</a>);
<a name="l00316"></a>00316          }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>,NULL,NULL) &gt; 0) {
<a name="l00319"></a>00319             snprintf(filename, <a class="code" href="private_8h.html#aada6f64b4a36eb39c9b4cfd44eef7b36">FILENAME_MAX</a>, <span class="stringliteral">&quot;%s-out&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>);
<a name="l00320"></a>00320             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(filename, NULL, NULL) &gt; 0) {
<a name="l00321"></a>00321                <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(filename, NULL);
<a name="l00322"></a>00322             }
<a name="l00323"></a>00323             <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>, filename, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>);
<a name="l00324"></a>00324          } <span class="keywordflow">else</span> {
<a name="l00325"></a>00325             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;File %s not found\n&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#aa207af3400ab4d9b71c64de0c1333311">write_filename</a>);
<a name="l00326"></a>00326          }
<a name="l00327"></a>00327       }
<a name="l00328"></a>00328 
<a name="l00329"></a>00329       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a7b71d4ef14ee85d131a71845d8c38926">joinfiles</a> &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>)) {
<a name="l00330"></a>00330          <span class="keywordtype">char</span> tmp[1024];
<a name="l00331"></a>00331          <span class="keywordtype">char</span> tmp2[1024];
<a name="l00332"></a>00332          <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a> = !strcasecmp(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>,<span class="stringliteral">&quot;wav49&quot;</span>) ? <span class="stringliteral">&quot;WAV&quot;</span> : chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>;
<a name="l00333"></a>00333          <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a34151f04e7ec5b41736e78fd49685a39">filename_base</a>;
<a name="l00334"></a>00334          <span class="keywordtype">int</span> directory = strchr(name, <span class="charliteral">&apos;/&apos;</span>) ? 1 : 0;
<a name="l00335"></a>00335          <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a> = directory ? <span class="stringliteral">&quot;&quot;</span> : <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>;
<a name="l00336"></a>00336          <span class="keyword">const</span> <span class="keywordtype">char</span> *execute, *execute_args;
<a name="l00337"></a>00337          <span class="keyword">const</span> <span class="keywordtype">char</span> *absolute = *name == <span class="charliteral">&apos;/&apos;</span> ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;/&quot;</span>;
<a name="l00338"></a>00338 
<a name="l00339"></a>00339          <span class="comment">/* Set the execute application */</span>
<a name="l00340"></a>00340          execute = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MONITOR_EXEC&quot;</span>);
<a name="l00341"></a>00341          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(execute)) {
<a name="l00342"></a>00342 <span class="preprocessor">#ifdef HAVE_SOXMIX</span>
<a name="l00343"></a>00343 <span class="preprocessor"></span>            execute = <span class="stringliteral">&quot;nice -n 19 soxmix&quot;</span>;
<a name="l00344"></a>00344 <span class="preprocessor">#else</span>
<a name="l00345"></a>00345 <span class="preprocessor"></span>            execute = <span class="stringliteral">&quot;nice -n 19 sox -m&quot;</span>;
<a name="l00346"></a>00346 <span class="preprocessor">#endif</span>
<a name="l00347"></a>00347 <span class="preprocessor"></span>            format = <a class="code" href="res__monitor_8c.html#a9219f8f5ad92fa99bd39d2000a0601eb" title="Get audio format.">get_soxmix_format</a>(format);
<a name="l00348"></a>00348             delfiles = 1;
<a name="l00349"></a>00349          } 
<a name="l00350"></a>00350          execute_args = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MONITOR_EXEC_ARGS&quot;</span>);
<a name="l00351"></a>00351          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(execute_args)) {
<a name="l00352"></a>00352             execute_args = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00353"></a>00353          }
<a name="l00354"></a>00354          
<a name="l00355"></a>00355          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s \&quot;%s%s%s-in.%s\&quot; \&quot;%s%s%s-out.%s\&quot; \&quot;%s%s%s.%s\&quot; %s &amp;&quot;</span>, execute, dir, absolute, name, format, dir, absolute, name, format, dir, absolute, name, format,execute_args);
<a name="l00356"></a>00356          <span class="keywordflow">if</span> (delfiles) {
<a name="l00357"></a>00357             snprintf(tmp2,<span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">&quot;( %s&amp; rm -f \&quot;%s%s%s-\&quot;* ) &amp;&quot;</span>,tmp, dir, absolute, name); <span class="comment">/* remove legs when done mixing */</span>
<a name="l00358"></a>00358             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, tmp2, <span class="keyword">sizeof</span>(tmp));
<a name="l00359"></a>00359          }
<a name="l00360"></a>00360          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;monitor executing %s\n&quot;</span>,tmp);
<a name="l00361"></a>00361          <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(tmp) == -1)
<a name="l00362"></a>00362             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Execute of %s failed.\n&quot;</span>,tmp);
<a name="l00363"></a>00363       }
<a name="l00364"></a>00364       
<a name="l00365"></a>00365       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>-&gt;<a class="code" href="structast__channel__monitor.html#a5407a229a5e1a319d75fb29542c83eae">format</a>);
<a name="l00366"></a>00366       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>);
<a name="l00367"></a>00367       chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a> = NULL;
<a name="l00368"></a>00368 
<a name="l00369"></a>00369       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MonitorStop&quot;</span>,
<a name="l00370"></a>00370                          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l00371"></a>00371                            <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>,
<a name="l00372"></a>00372                            chan-&gt;name,
<a name="l00373"></a>00373                            chan-&gt;uniqueid
<a name="l00374"></a>00374                            );
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376 
<a name="l00377"></a>00377    <a class="code" href="res__monitor_8c.html#a4874e91ddd324a90ff297fb0d401662d">UNLOCK_IF_NEEDED</a>(chan, need_lock);
<a name="l00378"></a>00378 
<a name="l00379"></a>00379    <span class="keywordflow">return</span> 0;
<a name="l00380"></a>00380 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a07e2488c28aae7fc4757e45451523740"></a><!-- doxytag: member="monitor.h::ast_monitor_unpause" ref="a07e2488c28aae7fc4757e45451523740" args="(struct ast_channel *chan) attribute_weak" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int ast_monitor_unpause </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Unpause monitoring of channel. </p>

<p>Definition at line <a class="el" href="res__monitor_8c_source.html#l00390">390</a> of file <a class="el" href="res__monitor_8c_source.html">res_monitor.c</a>.</p>

<p>References <a class="el" href="monitor_8h_source.html#l00029">AST_MONITOR_RUNNING</a>, and <a class="el" href="res__monitor_8c_source.html#l00125">ast_monitor_set_state()</a>.</p>

<p>Referenced by <a class="el" href="res__monitor_8c_source.html#l00728">do_pause_or_unpause()</a>, and <a class="el" href="res__monitor_8c_source.html#l00402">unpause_monitor_exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00391"></a>00391 {
<a name="l00392"></a>00392    <span class="keywordflow">return</span> <a class="code" href="res__monitor_8c.html#ab740a457e68200049b8d7177a3ae96de" title="Change state of monitored channel.">ast_monitor_set_state</a>(chan, <a class="code" href="monitor_8h.html#a9b57685a45dd0700625ea8ba83a868dface918b901d180f5ea85f8a941fc8cbdb">AST_MONITOR_RUNNING</a>);
<a name="l00393"></a>00393 }
</pre></div></p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:22:24 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
