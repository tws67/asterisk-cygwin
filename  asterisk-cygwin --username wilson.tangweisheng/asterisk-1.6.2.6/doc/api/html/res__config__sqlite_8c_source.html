<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:46 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_config_sqlite.c</h1><a href="res__config__sqlite_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2006, Proformatique</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Written by Richard Braun &lt;rbraun@proformatique.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * Based on res_sqlite3 by Anthony Minessale II,</span>
<a name="l00009"></a>00009 <span class="comment"> * and res_config_mysql by Matthew Boehm</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00012"></a>00012 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00013"></a>00013 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00014"></a>00014 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00015"></a>00015 <span class="comment"> * channels for your use.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00018"></a>00018 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00019"></a>00019 <span class="comment"> * at the top of the source tree.</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">/*!</span>
<a name="l00023"></a>00023 <span class="comment"> * \page res_config_sqlite</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \section intro_sec Presentation</span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * res_config_sqlite is a module for the Asterisk Open Source PBX to</span>
<a name="l00028"></a>00028 <span class="comment"> * support SQLite 2 databases. It can be used to fetch configuration</span>
<a name="l00029"></a>00029 <span class="comment"> * from a database (static configuration files and/or using the Asterisk</span>
<a name="l00030"></a>00030 <span class="comment"> * RealTime Architecture - ARA).  It can also be used to log CDR entries. </span>
<a name="l00031"></a>00031 <span class="comment"> * Note that Asterisk already comes with a module named cdr_sqlite.</span>
<a name="l00032"></a>00032 <span class="comment"> * There are two reasons for including it in res_config_sqlite:</span>
<a name="l00033"></a>00033 <span class="comment"> * the first is that rewriting it was a training to learn how to write a</span>
<a name="l00034"></a>00034 <span class="comment"> * simple module for Asterisk, the other is to have the same database open for</span>
<a name="l00035"></a>00035 <span class="comment"> * all kinds of operations, which improves reliability and performance.</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> * \section conf_sec Configuration</span>
<a name="l00038"></a>00038 <span class="comment"> *</span>
<a name="l00039"></a>00039 <span class="comment"> * The main configuration file is res_config_sqlite.conf. It must be readable or</span>
<a name="l00040"></a>00040 <span class="comment"> * res_config_sqlite will fail to start. It is suggested to use the sample file</span>
<a name="l00041"></a>00041 <span class="comment"> * in this package as a starting point. The file has only one section</span>
<a name="l00042"></a>00042 <span class="comment"> * named &lt;code&gt;general&lt;/code&gt;. Here are the supported parameters :</span>
<a name="l00043"></a>00043 <span class="comment"> *</span>
<a name="l00044"></a>00044 <span class="comment"> * &lt;dl&gt;</span>
<a name="l00045"></a>00045 <span class="comment"> * &lt;dt&gt;&lt;code&gt;dbfile&lt;/code&gt;&lt;/dt&gt;</span>
<a name="l00046"></a>00046 <span class="comment"> * &lt;dd&gt;The absolute path to the SQLite database (the file can be non existent,</span>
<a name="l00047"></a>00047 <span class="comment"> *       res_config_sqlite will create it if it has the appropriate rights)&lt;/dd&gt;</span>
<a name="l00048"></a>00048 <span class="comment"> * &lt;dt&gt;&lt;code&gt;config_table&lt;/code&gt;&lt;/dt&gt;</span>
<a name="l00049"></a>00049 <span class="comment"> * &lt;dd&gt;The table used for static configuration&lt;/dd&gt;</span>
<a name="l00050"></a>00050 <span class="comment"> * &lt;dt&gt;&lt;code&gt;cdr_table&lt;/code&gt;&lt;/dt&gt;</span>
<a name="l00051"></a>00051 <span class="comment"> * &lt;dd&gt;The table used to store CDR entries (if ommitted, CDR support is</span>
<a name="l00052"></a>00052 <span class="comment"> *       disabled)&lt;/dd&gt;</span>
<a name="l00053"></a>00053 <span class="comment"> * &lt;/dl&gt;</span>
<a name="l00054"></a>00054 <span class="comment"> *</span>
<a name="l00055"></a>00055 <span class="comment"> * To use res_config_sqlite for static and/or RealTime configuration, refer to the</span>
<a name="l00056"></a>00056 <span class="comment"> * Asterisk documentation. The file tables.sql can be used to create the</span>
<a name="l00057"></a>00057 <span class="comment"> * needed tables.</span>
<a name="l00058"></a>00058 <span class="comment"> *</span>
<a name="l00059"></a>00059 <span class="comment"> * \section status_sec Driver status</span>
<a name="l00060"></a>00060 <span class="comment"> *</span>
<a name="l00061"></a>00061 <span class="comment"> * The CLI command &lt;code&gt;show sqlite status&lt;/code&gt; returns status information</span>
<a name="l00062"></a>00062 <span class="comment"> * about the running driver.</span>
<a name="l00063"></a>00063 <span class="comment"> *</span>
<a name="l00064"></a>00064 <span class="comment"> * \section credits_sec Credits</span>
<a name="l00065"></a>00065 <span class="comment"> *</span>
<a name="l00066"></a>00066 <span class="comment"> * res_config_sqlite was developed by Richard Braun at the Proformatique company.</span>
<a name="l00067"></a>00067 <span class="comment"> */</span>
<a name="l00068"></a>00068 <span class="comment"></span>
<a name="l00069"></a>00069 <span class="comment">/*!</span>
<a name="l00070"></a>00070 <span class="comment"> * \file</span>
<a name="l00071"></a>00071 <span class="comment"> * \brief res_config_sqlite module.</span>
<a name="l00072"></a>00072 <span class="comment"> */</span>
<a name="l00073"></a>00073 
<a name="l00074"></a>00074 <span class="comment">/*** MODULEINFO</span>
<a name="l00075"></a>00075 <span class="comment">   &lt;depend&gt;sqlite&lt;/depend&gt;</span>
<a name="l00076"></a>00076 <span class="comment"> ***/</span>
<a name="l00077"></a>00077 
<a name="l00078"></a>00078 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00079"></a>00079 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 211580 $&quot;</span>)
<a name="l00080"></a>00080 
<a name="l00081"></a>00081 <span class="preprocessor">#include &lt;sqlite.h&gt;</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;<a class="code" href="logger_8h.html" title="Support for logging to various files, console and syslog Configuration in file logger...">asterisk/logger.h</a>&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00086"></a>00086 <span class="preprocessor">#include &quot;<a class="code" href="cdr_8h.html" title="Call Detail Record API.">asterisk/cdr.h</a>&quot;</span>
<a name="l00087"></a>00087 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00088"></a>00088 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00089"></a>00089 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &quot;<a class="code" href="linkedlists_8h.html" title="A set of macros to manage forward-linked lists.">asterisk/linkedlists.h</a>&quot;</span>
<a name="l00092"></a>00092 
<a name="l00093"></a><a class="code" href="res__config__sqlite_8c.html#a6ea20bb10289e56e9a2af562401dad73">00093</a> <span class="preprocessor">#define MACRO_BEGIN  do {</span>
<a name="l00094"></a><a class="code" href="res__config__sqlite_8c.html#a24d643fdd618bef1cd183c98cc2e8201">00094</a> <span class="preprocessor"></span><span class="preprocessor">#define MACRO_END } while (0)</span>
<a name="l00095"></a>00095 <span class="preprocessor"></span>
<a name="l00096"></a><a class="code" href="res__config__sqlite_8c.html#acbd22ddbb653b6555ab5bc619780efc0">00096</a> <span class="preprocessor">#define RES_CONFIG_SQLITE_NAME &quot;res_config_sqlite&quot;</span>
<a name="l00097"></a><a class="code" href="res__config__sqlite_8c.html#af904e6a4f8bb70e7fabc40848744941f">00097</a> <span class="preprocessor"></span><span class="preprocessor">#define RES_CONFIG_SQLITE_DRIVER &quot;sqlite&quot;</span>
<a name="l00098"></a><a class="code" href="res__config__sqlite_8c.html#a2f82b578cab098832c975e3f4237ce12">00098</a> <span class="preprocessor"></span><span class="preprocessor">#define RES_CONFIG_SQLITE_DESCRIPTION &quot;Resource Module for SQLite 2&quot;</span>
<a name="l00099"></a><a class="code" href="res__config__sqlite_8c.html#a4ac391d995daec836742fde68abf645f">00099</a> <span class="preprocessor"></span><span class="preprocessor">#define RES_CONFIG_SQLITE_CONF_FILE &quot;res_config_sqlite.conf&quot;</span>
<a name="l00100"></a>00100 <span class="preprocessor"></span>
<a name="l00101"></a>00101 <span class="keyword">enum</span> {
<a name="l00102"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0629a788663cc64450958532c515165a">00102</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0629a788663cc64450958532c515165a">RES_CONFIG_SQLITE_CONFIG_ID</a>,
<a name="l00103"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda061efed6883712a4338a7b70873aa268">00103</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda061efed6883712a4338a7b70873aa268">RES_CONFIG_SQLITE_CONFIG_CAT_METRIC</a>,
<a name="l00104"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda793f0b280859ad957e1f2930a849208e">00104</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda793f0b280859ad957e1f2930a849208e">RES_CONFIG_SQLITE_CONFIG_VAR_METRIC</a>,
<a name="l00105"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda9734ede0883dda220fb6ba2a98d7085e">00105</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda9734ede0883dda220fb6ba2a98d7085e">RES_CONFIG_SQLITE_CONFIG_COMMENTED</a>,
<a name="l00106"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0b6ea6b0fddd2be25e1559cf4a49efae">00106</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0b6ea6b0fddd2be25e1559cf4a49efae">RES_CONFIG_SQLITE_CONFIG_FILENAME</a>,
<a name="l00107"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbdae873cc53ea86027d191a69cabe26846e">00107</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbdae873cc53ea86027d191a69cabe26846e">RES_CONFIG_SQLITE_CONFIG_CATEGORY</a>,
<a name="l00108"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0a6b34fcd5c07ea3e84b0727e33efdd5">00108</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0a6b34fcd5c07ea3e84b0727e33efdd5">RES_CONFIG_SQLITE_CONFIG_VAR_NAME</a>,
<a name="l00109"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda7ade715af5daf3ff81f2326e4c24f48f">00109</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda7ade715af5daf3ff81f2326e4c24f48f">RES_CONFIG_SQLITE_CONFIG_VAR_VAL</a>,
<a name="l00110"></a><a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda60b88f192e5aaf532b024bfd3195083d">00110</a>    <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda60b88f192e5aaf532b024bfd3195083d">RES_CONFIG_SQLITE_CONFIG_COLUMNS</a>,
<a name="l00111"></a>00111 };
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="res__config__sqlite_8c.html#abb5414f66b45fde76fd377295dfdbe45">00113</a> <span class="preprocessor">#define SET_VAR(config, to, from)         \</span>
<a name="l00114"></a>00114 <span class="preprocessor">MACRO_BEGIN                \</span>
<a name="l00115"></a>00115 <span class="preprocessor">   int __error;               \</span>
<a name="l00116"></a>00116 <span class="preprocessor">                     \</span>
<a name="l00117"></a>00117 <span class="preprocessor">   __error = set_var(&amp;to, #to, from-&gt;value); \</span>
<a name="l00118"></a>00118 <span class="preprocessor">                     \</span>
<a name="l00119"></a>00119 <span class="preprocessor">   if (__error) {             \</span>
<a name="l00120"></a>00120 <span class="preprocessor">      ast_config_destroy(config);      \</span>
<a name="l00121"></a>00121 <span class="preprocessor">      unload_config();        \</span>
<a name="l00122"></a>00122 <span class="preprocessor">      return 1;            \</span>
<a name="l00123"></a>00123 <span class="preprocessor">   }                 \</span>
<a name="l00124"></a>00124 <span class="preprocessor">MACRO_END</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>
<a name="l00126"></a><a class="code" href="res__config__sqlite_8c.html#afc4bfa5a94710e6f323a1033f82425b3">00126</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="res__config__sqlite_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>);
<a name="l00127"></a><a class="code" href="res__config__sqlite_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">00127</a> <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(<a class="code" href="res__config__sqlite_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a>);
<a name="l00128"></a>00128 <span class="comment"></span>
<a name="l00129"></a>00129 <span class="comment">/*!</span>
<a name="l00130"></a>00130 <span class="comment"> * Maximum number of loops before giving up executing a query. Calls to</span>
<a name="l00131"></a>00131 <span class="comment"> * sqlite_xxx() functions which can return SQLITE_BUSY</span>
<a name="l00132"></a>00132 <span class="comment"> * are enclosed by RES_CONFIG_SQLITE_BEGIN and RES_CONFIG_SQLITE_END, e.g.</span>
<a name="l00133"></a>00133 <span class="comment"> * &lt;pre&gt;</span>
<a name="l00134"></a>00134 <span class="comment"> * char *errormsg;</span>
<a name="l00135"></a>00135 <span class="comment"> * int error;</span>
<a name="l00136"></a>00136 <span class="comment"> *</span>
<a name="l00137"></a>00137 <span class="comment"> * RES_CONFIG_SQLITE_BEGIN</span>
<a name="l00138"></a>00138 <span class="comment"> *  error = sqlite_exec(db, query, NULL, NULL, &amp;errormsg);</span>
<a name="l00139"></a>00139 <span class="comment"> * RES_CONFIG_SQLITE_END(error)</span>
<a name="l00140"></a>00140 <span class="comment"> *</span>
<a name="l00141"></a>00141 <span class="comment"> * if (error)</span>
<a name="l00142"></a>00142 <span class="comment"> *  ...;</span>
<a name="l00143"></a>00143 <span class="comment"> * &lt;/pre&gt;</span>
<a name="l00144"></a>00144 <span class="comment"> */</span>
<a name="l00145"></a><a class="code" href="res__config__sqlite_8c.html#a685bbd45a4811eb231e0066852c31c94">00145</a> <span class="preprocessor">#define RES_CONFIG_SQLITE_MAX_LOOPS 10</span>
<a name="l00146"></a>00146 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00147"></a>00147 <span class="comment">/*!</span>
<a name="l00148"></a>00148 <span class="comment"> * Macro used before executing a query.</span>
<a name="l00149"></a>00149 <span class="comment"> *</span>
<a name="l00150"></a>00150 <span class="comment"> * \see RES_CONFIG_SQLITE_MAX_LOOPS.</span>
<a name="l00151"></a>00151 <span class="comment"> */</span>
<a name="l00152"></a><a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">00152</a> <span class="preprocessor">#define RES_CONFIG_SQLITE_BEGIN                 \</span>
<a name="l00153"></a>00153 <span class="preprocessor">MACRO_BEGIN                      \</span>
<a name="l00154"></a>00154 <span class="preprocessor">   int __i;                   \</span>
<a name="l00155"></a>00155 <span class="preprocessor">                           \</span>
<a name="l00156"></a>00156 <span class="preprocessor">   for (__i = 0; __i &lt; RES_CONFIG_SQLITE_MAX_LOOPS; __i++)  {</span>
<a name="l00157"></a>00157 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00158"></a>00158 <span class="comment">/*!</span>
<a name="l00159"></a>00159 <span class="comment"> * Macro used after executing a query.</span>
<a name="l00160"></a>00160 <span class="comment"> *</span>
<a name="l00161"></a>00161 <span class="comment"> * \see RES_CONFIG_SQLITE_MAX_LOOPS.</span>
<a name="l00162"></a>00162 <span class="comment"> */</span>
<a name="l00163"></a><a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">00163</a> <span class="preprocessor">#define RES_CONFIG_SQLITE_END(error)               \</span>
<a name="l00164"></a>00164 <span class="preprocessor">      if (error != SQLITE_BUSY)  \</span>
<a name="l00165"></a>00165 <span class="preprocessor">         break;                  \</span>
<a name="l00166"></a>00166 <span class="preprocessor">      usleep(1000);                 \</span>
<a name="l00167"></a>00167 <span class="preprocessor">   }                       \</span>
<a name="l00168"></a>00168 <span class="preprocessor">MACRO_END;</span>
<a name="l00169"></a>00169 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00170"></a>00170 <span class="comment">/*!</span>
<a name="l00171"></a>00171 <span class="comment"> * Structure sent to the SQLite callback function for static configuration.</span>
<a name="l00172"></a>00172 <span class="comment"> *</span>
<a name="l00173"></a>00173 <span class="comment"> * \see add_cfg_entry()</span>
<a name="l00174"></a>00174 <span class="comment"> */</span>
<a name="l00175"></a><a class="code" href="structcfg__entry__args.html">00175</a> <span class="keyword">struct </span><a class="code" href="structcfg__entry__args.html">cfg_entry_args</a> {
<a name="l00176"></a><a class="code" href="structcfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">00176</a>    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="structcfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a>;
<a name="l00177"></a><a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">00177</a>    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a>;
<a name="l00178"></a><a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">00178</a>    <span class="keywordtype">char</span> *<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a>;
<a name="l00179"></a><a class="code" href="structcfg__entry__args.html#aec78000b2897c094f68ed72559e18acd">00179</a>    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="structcfg__entry__args.html#aec78000b2897c094f68ed72559e18acd">flags</a>;
<a name="l00180"></a><a class="code" href="structcfg__entry__args.html#a8b2a59636d4dbe0f5bf74e2fe0422648">00180</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structcfg__entry__args.html#a8b2a59636d4dbe0f5bf74e2fe0422648">who_asked</a>;
<a name="l00181"></a>00181 };
<a name="l00182"></a>00182 <span class="comment"></span>
<a name="l00183"></a>00183 <span class="comment">/*!</span>
<a name="l00184"></a>00184 <span class="comment"> * Structure sent to the SQLite callback function for RealTime configuration.</span>
<a name="l00185"></a>00185 <span class="comment"> *</span>
<a name="l00186"></a>00186 <span class="comment"> * \see add_rt_cfg_entry()</span>
<a name="l00187"></a>00187 <span class="comment"> */</span>
<a name="l00188"></a><a class="code" href="structrt__cfg__entry__args.html">00188</a> <span class="keyword">struct </span><a class="code" href="structrt__cfg__entry__args.html">rt_cfg_entry_args</a> {
<a name="l00189"></a><a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">00189</a>    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">var</a>;
<a name="l00190"></a><a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">00190</a>    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">last</a>;
<a name="l00191"></a>00191 };
<a name="l00192"></a>00192 <span class="comment"></span>
<a name="l00193"></a>00193 <span class="comment">/*!</span>
<a name="l00194"></a>00194 <span class="comment"> * Structure sent to the SQLite callback function for RealTime configuration</span>
<a name="l00195"></a>00195 <span class="comment"> * (realtime_multi_handler()).</span>
<a name="l00196"></a>00196 <span class="comment"> *</span>
<a name="l00197"></a>00197 <span class="comment"> * \see add_rt_multi_cfg_entry()</span>
<a name="l00198"></a>00198 <span class="comment"> */</span>
<a name="l00199"></a><a class="code" href="structrt__multi__cfg__entry__args.html">00199</a> <span class="keyword">struct </span><a class="code" href="structrt__multi__cfg__entry__args.html">rt_multi_cfg_entry_args</a> {
<a name="l00200"></a><a class="code" href="structrt__multi__cfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">00200</a>    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="structrt__multi__cfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a>;
<a name="l00201"></a><a class="code" href="structrt__multi__cfg__entry__args.html#a9d097a0647a837d2fab0d6355278480a">00201</a>    <span class="keywordtype">char</span> *<a class="code" href="structrt__multi__cfg__entry__args.html#a9d097a0647a837d2fab0d6355278480a">initfield</a>;
<a name="l00202"></a>00202 };
<a name="l00203"></a>00203 <span class="comment"></span>
<a name="l00204"></a>00204 <span class="comment">/*!</span>
<a name="l00205"></a>00205 <span class="comment"> * \brief Allocate a variable.</span>
<a name="l00206"></a>00206 <span class="comment"> * \param var the address of the variable to set (it will be allocated)</span>
<a name="l00207"></a>00207 <span class="comment"> * \param name the name of the variable (for error handling)</span>
<a name="l00208"></a>00208 <span class="comment"> * \param value the value to store in var</span>
<a name="l00209"></a>00209 <span class="comment"> * \retval 0 on success</span>
<a name="l00210"></a>00210 <span class="comment"> * \retval 1 if an allocation error occurred</span>
<a name="l00211"></a>00211 <span class="comment"> */</span>
<a name="l00212"></a>00212 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a9493baa3343654ae2828e06ad1ace967" title="Allocate a variable.">set_var</a>(<span class="keywordtype">char</span> **<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value);
<a name="l00213"></a>00213 <span class="comment"></span>
<a name="l00214"></a>00214 <span class="comment">/*!</span>
<a name="l00215"></a>00215 <span class="comment"> * \brief Load the configuration file.</span>
<a name="l00216"></a>00216 <span class="comment"> * \see unload_config()</span>
<a name="l00217"></a>00217 <span class="comment"> *</span>
<a name="l00218"></a>00218 <span class="comment"> * This function sets dbfile, config_table, and cdr_table. It calls</span>
<a name="l00219"></a>00219 <span class="comment"> * check_vars() before returning, and unload_config() if an error occurred.</span>
<a name="l00220"></a>00220 <span class="comment"> *</span>
<a name="l00221"></a>00221 <span class="comment"> * \retval 0 on success</span>
<a name="l00222"></a>00222 <span class="comment"> * \retval 1 if an error occurred</span>
<a name="l00223"></a>00223 <span class="comment"> */</span>
<a name="l00224"></a>00224 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#aed5779f84d4ebb67745d801d3ebede43" title="Load the configuration file.">load_config</a>(<span class="keywordtype">void</span>);
<a name="l00225"></a>00225 <span class="comment"></span>
<a name="l00226"></a>00226 <span class="comment">/*!</span>
<a name="l00227"></a>00227 <span class="comment"> * \brief Free resources related to configuration.</span>
<a name="l00228"></a>00228 <span class="comment"> * \see load_config()</span>
<a name="l00229"></a>00229 <span class="comment"> */</span>
<a name="l00230"></a>00230 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__config__sqlite_8c.html#a72f99a227dc7bc5522ba90399070f385" title="Free resources related to configuration.">unload_config</a>(<span class="keywordtype">void</span>);
<a name="l00231"></a>00231 <span class="comment"></span>
<a name="l00232"></a>00232 <span class="comment">/*!</span>
<a name="l00233"></a>00233 <span class="comment"> * \brief Asterisk callback function for CDR support.</span>
<a name="l00234"></a>00234 <span class="comment"> * \param cdr the CDR entry Asterisk sends us.</span>
<a name="l00235"></a>00235 <span class="comment"> *</span>
<a name="l00236"></a>00236 <span class="comment"> * Asterisk will call this function each time a CDR entry must be logged if</span>
<a name="l00237"></a>00237 <span class="comment"> * CDR support is enabled.</span>
<a name="l00238"></a>00238 <span class="comment"> *</span>
<a name="l00239"></a>00239 <span class="comment"> * \retval 0 on success</span>
<a name="l00240"></a>00240 <span class="comment"> * \retval 1 if an error occurred</span>
<a name="l00241"></a>00241 <span class="comment"> */</span>
<a name="l00242"></a>00242 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a9b959d97c623a073d5562c5921b0635a" title="Asterisk callback function for CDR support.">cdr_handler</a>(<span class="keyword">struct</span> <a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *cdr);
<a name="l00243"></a>00243 <span class="comment"></span>
<a name="l00244"></a>00244 <span class="comment">/*!</span>
<a name="l00245"></a>00245 <span class="comment"> * \brief SQLite callback function for static configuration.</span>
<a name="l00246"></a>00246 <span class="comment"> *</span>
<a name="l00247"></a>00247 <span class="comment"> * This function is passed to the SQLite engine as a callback function to</span>
<a name="l00248"></a>00248 <span class="comment"> * parse a row and store it in a struct ast_config object. It relies on</span>
<a name="l00249"></a>00249 <span class="comment"> * resulting rows being sorted by category.</span>
<a name="l00250"></a>00250 <span class="comment"> *</span>
<a name="l00251"></a>00251 <span class="comment"> * \param arg a pointer to a struct cfg_entry_args object</span>
<a name="l00252"></a>00252 <span class="comment"> * \param argc number of columns</span>
<a name="l00253"></a>00253 <span class="comment"> * \param argv values in the row</span>
<a name="l00254"></a>00254 <span class="comment"> * \param columnNames names and types of the columns</span>
<a name="l00255"></a>00255 <span class="comment"> * \retval 0 on success</span>
<a name="l00256"></a>00256 <span class="comment"> * \retval 1 if an error occurred</span>
<a name="l00257"></a>00257 <span class="comment"> * \see cfg_entry_args</span>
<a name="l00258"></a>00258 <span class="comment"> * \see sql_get_config_table</span>
<a name="l00259"></a>00259 <span class="comment"> * \see config_handler()</span>
<a name="l00260"></a>00260 <span class="comment"> */</span>
<a name="l00261"></a>00261 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#ab0550541665aab14df8f089397bba5ae" title="SQLite callback function for static configuration.">add_cfg_entry</a>(<span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, <span class="keywordtype">char</span> **columnNames);
<a name="l00262"></a>00262 <span class="comment"></span>
<a name="l00263"></a>00263 <span class="comment">/*!</span>
<a name="l00264"></a>00264 <span class="comment"> * \brief Asterisk callback function for static configuration.</span>
<a name="l00265"></a>00265 <span class="comment"> *</span>
<a name="l00266"></a>00266 <span class="comment"> * Asterisk will call this function when it loads its static configuration,</span>
<a name="l00267"></a>00267 <span class="comment"> * which usually happens at startup and reload.</span>
<a name="l00268"></a>00268 <span class="comment"> *</span>
<a name="l00269"></a>00269 <span class="comment"> * \param database the database to use (ignored)</span>
<a name="l00270"></a>00270 <span class="comment"> * \param table the table to use</span>
<a name="l00271"></a>00271 <span class="comment"> * \param file the file to load from the database</span>
<a name="l00272"></a>00272 <span class="comment"> * \param cfg the struct ast_config object to use when storing variables</span>
<a name="l00273"></a>00273 <span class="comment"> * \param flags Optional flags.  Not used.</span>
<a name="l00274"></a>00274 <span class="comment"> * \param suggested_incl suggest include.</span>
<a name="l00275"></a>00275 <span class="comment"> * \retval cfg object</span>
<a name="l00276"></a>00276 <span class="comment"> * \retval NULL if an error occurred</span>
<a name="l00277"></a>00277 <span class="comment"> * \see add_cfg_entry()</span>
<a name="l00278"></a>00278 <span class="comment"> */</span>
<a name="l00279"></a>00279 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> * <a class="code" href="res__config__sqlite_8c.html#a7c363143661597b8480ef856c1acad80" title="Asterisk callback function for static configuration.">config_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *file,
<a name="l00280"></a>00280    <span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags, <span class="keyword">const</span> <span class="keywordtype">char</span> *suggested_incl, <span class="keyword">const</span> <span class="keywordtype">char</span> *who_asked);
<a name="l00281"></a>00281 <span class="comment"></span>
<a name="l00282"></a>00282 <span class="comment">/*!</span>
<a name="l00283"></a>00283 <span class="comment"> * \brief Helper function to parse a va_list object into 2 dynamic arrays of</span>
<a name="l00284"></a>00284 <span class="comment"> * strings, parameters and values.</span>
<a name="l00285"></a>00285 <span class="comment"> *</span>
<a name="l00286"></a>00286 <span class="comment"> * ap must have the following format : param1 val1 param2 val2 param3 val3 ...</span>
<a name="l00287"></a>00287 <span class="comment"> * arguments will be extracted to create 2 arrays:</span>
<a name="l00288"></a>00288 <span class="comment"> *</span>
<a name="l00289"></a>00289 <span class="comment"> * &lt;ul&gt;</span>
<a name="l00290"></a>00290 <span class="comment"> * &lt;li&gt;params : param1 param2 param3 ...&lt;/li&gt;</span>
<a name="l00291"></a>00291 <span class="comment"> * &lt;li&gt;vals : val1 val2 val3 ...&lt;/li&gt;</span>
<a name="l00292"></a>00292 <span class="comment"> * &lt;/ul&gt;</span>
<a name="l00293"></a>00293 <span class="comment"> *</span>
<a name="l00294"></a>00294 <span class="comment"> * The address of these arrays are stored in params_ptr and vals_ptr. It</span>
<a name="l00295"></a>00295 <span class="comment"> * is the responsibility of the caller to release the memory of these arrays.</span>
<a name="l00296"></a>00296 <span class="comment"> * It is considered an error that va_list has a null or odd number of strings.</span>
<a name="l00297"></a>00297 <span class="comment"> *</span>
<a name="l00298"></a>00298 <span class="comment"> * \param ap the va_list object to parse</span>
<a name="l00299"></a>00299 <span class="comment"> * \param params_ptr where the address of the params array is stored</span>
<a name="l00300"></a>00300 <span class="comment"> * \param vals_ptr where the address of the vals array is stored</span>
<a name="l00301"></a>00301 <span class="comment"> * \retval the number of elements in the arrays (which have the same size).</span>
<a name="l00302"></a>00302 <span class="comment"> * \retval 0 if an error occurred.</span>
<a name="l00303"></a>00303 <span class="comment"> */</span>
<a name="l00304"></a>00304 <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(va_list ap, <span class="keyword">const</span> <span class="keywordtype">char</span> ***params_ptr,
<a name="l00305"></a>00305    <span class="keyword">const</span> <span class="keywordtype">char</span> ***vals_ptr, <span class="keywordtype">int</span> warn);
<a name="l00306"></a>00306 <span class="comment"></span>
<a name="l00307"></a>00307 <span class="comment">/*!</span>
<a name="l00308"></a>00308 <span class="comment"> * \brief SQLite callback function for RealTime configuration.</span>
<a name="l00309"></a>00309 <span class="comment"> *</span>
<a name="l00310"></a>00310 <span class="comment"> * This function is passed to the SQLite engine as a callback function to</span>
<a name="l00311"></a>00311 <span class="comment"> * parse a row and store it in a linked list of struct ast_variable objects.</span>
<a name="l00312"></a>00312 <span class="comment"> *</span>
<a name="l00313"></a>00313 <span class="comment"> * \param arg a pointer to a struct rt_cfg_entry_args object</span>
<a name="l00314"></a>00314 <span class="comment"> * \param argc number of columns</span>
<a name="l00315"></a>00315 <span class="comment"> * \param argv values in the row</span>
<a name="l00316"></a>00316 <span class="comment"> * \param columnNames names and types of the columns</span>
<a name="l00317"></a>00317 <span class="comment"> * \retval 0 on success.</span>
<a name="l00318"></a>00318 <span class="comment"> * \retval 1 if an error occurred.</span>
<a name="l00319"></a>00319 <span class="comment"> * \see rt_cfg_entry_args</span>
<a name="l00320"></a>00320 <span class="comment"> * \see realtime_handler()</span>
<a name="l00321"></a>00321 <span class="comment"> */</span>
<a name="l00322"></a>00322 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a1acd2046121f2656b6e35ec0d5650913" title="SQLite callback function for RealTime configuration.">add_rt_cfg_entry</a>(<span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv,
<a name="l00323"></a>00323    <span class="keywordtype">char</span> **columnNames);
<a name="l00324"></a>00324 <span class="comment"></span>
<a name="l00325"></a>00325 <span class="comment">/*!</span>
<a name="l00326"></a>00326 <span class="comment"> * \brief Asterisk callback function for RealTime configuration.</span>
<a name="l00327"></a>00327 <span class="comment"> *</span>
<a name="l00328"></a>00328 <span class="comment"> * Asterisk will call this function each time it requires a variable</span>
<a name="l00329"></a>00329 <span class="comment"> * through the RealTime architecture. ap is a list of parameters and</span>
<a name="l00330"></a>00330 <span class="comment"> * values used to find a specific row, e.g one parameter &quot;name&quot; and</span>
<a name="l00331"></a>00331 <span class="comment"> * one value &quot;123&quot; so that the SQL query becomes &lt;code&gt;SELECT * FROM</span>
<a name="l00332"></a>00332 <span class="comment"> * table WHERE name = &apos;123&apos;;&lt;/code&gt;.</span>
<a name="l00333"></a>00333 <span class="comment"> *</span>
<a name="l00334"></a>00334 <span class="comment"> * \param database the database to use (ignored)</span>
<a name="l00335"></a>00335 <span class="comment"> * \param table the table to use</span>
<a name="l00336"></a>00336 <span class="comment"> * \param ap list of parameters and values to match</span>
<a name="l00337"></a>00337 <span class="comment"> *</span>
<a name="l00338"></a>00338 <span class="comment"> * \retval a linked list of struct ast_variable objects</span>
<a name="l00339"></a>00339 <span class="comment"> * \retval NULL if an error occurred</span>
<a name="l00340"></a>00340 <span class="comment"> * \see add_rt_cfg_entry()</span>
<a name="l00341"></a>00341 <span class="comment"> */</span>
<a name="l00342"></a>00342 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> * <a class="code" href="res__config__sqlite_8c.html#a338dc290c800ac25ab8c52e43376e951" title="Asterisk callback function for RealTime configuration.">realtime_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database,
<a name="l00343"></a>00343    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, va_list ap);
<a name="l00344"></a>00344 <span class="comment"></span>
<a name="l00345"></a>00345 <span class="comment">/*!</span>
<a name="l00346"></a>00346 <span class="comment"> * \brief SQLite callback function for RealTime configuration.</span>
<a name="l00347"></a>00347 <span class="comment"> *</span>
<a name="l00348"></a>00348 <span class="comment"> * This function performs the same actions as add_rt_cfg_entry() except</span>
<a name="l00349"></a>00349 <span class="comment"> * that the rt_multi_cfg_entry_args structure is designed to store</span>
<a name="l00350"></a>00350 <span class="comment"> * categories in addition to variables.</span>
<a name="l00351"></a>00351 <span class="comment"> *</span>
<a name="l00352"></a>00352 <span class="comment"> * \param arg a pointer to a struct rt_multi_cfg_entry_args object</span>
<a name="l00353"></a>00353 <span class="comment"> * \param argc number of columns</span>
<a name="l00354"></a>00354 <span class="comment"> * \param argv values in the row</span>
<a name="l00355"></a>00355 <span class="comment"> * \param columnNames names and types of the columns</span>
<a name="l00356"></a>00356 <span class="comment"> * \retval 0 on success.</span>
<a name="l00357"></a>00357 <span class="comment"> * \retval 1 if an error occurred.</span>
<a name="l00358"></a>00358 <span class="comment"> * \see rt_multi_cfg_entry_args</span>
<a name="l00359"></a>00359 <span class="comment"> * \see realtime_multi_handler()</span>
<a name="l00360"></a>00360 <span class="comment"> */</span>
<a name="l00361"></a>00361 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a17b5ad55ba185061850f5d682c397a98" title="SQLite callback function for RealTime configuration.">add_rt_multi_cfg_entry</a>(<span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv,
<a name="l00362"></a>00362    <span class="keywordtype">char</span> **columnNames);
<a name="l00363"></a>00363 <span class="comment"></span>
<a name="l00364"></a>00364 <span class="comment">/*!</span>
<a name="l00365"></a>00365 <span class="comment"> * \brief Asterisk callback function for RealTime configuration.</span>
<a name="l00366"></a>00366 <span class="comment"> *</span>
<a name="l00367"></a>00367 <span class="comment"> * This function performs the same actions as realtime_handler() except</span>
<a name="l00368"></a>00368 <span class="comment"> * that it can store variables per category, and can return several</span>
<a name="l00369"></a>00369 <span class="comment"> * categories.</span>
<a name="l00370"></a>00370 <span class="comment"> *</span>
<a name="l00371"></a>00371 <span class="comment"> * \param database the database to use (ignored)</span>
<a name="l00372"></a>00372 <span class="comment"> * \param table the table to use</span>
<a name="l00373"></a>00373 <span class="comment"> * \param ap list of parameters and values to match</span>
<a name="l00374"></a>00374 <span class="comment"> * \retval a struct ast_config object storing categories and variables.</span>
<a name="l00375"></a>00375 <span class="comment"> * \retval NULL if an error occurred.</span>
<a name="l00376"></a>00376 <span class="comment"> *</span>
<a name="l00377"></a>00377 <span class="comment"> * \see add_rt_multi_cfg_entry()</span>
<a name="l00378"></a>00378 <span class="comment"> */</span>
<a name="l00379"></a>00379 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> * <a class="code" href="res__config__sqlite_8c.html#ac1fb5f8486409dcf9931a7e616fd55cd" title="Asterisk callback function for RealTime configuration.">realtime_multi_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database,
<a name="l00380"></a>00380    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, va_list ap);
<a name="l00381"></a>00381 <span class="comment"></span>
<a name="l00382"></a>00382 <span class="comment">/*!</span>
<a name="l00383"></a>00383 <span class="comment"> * \brief Asterisk callback function for RealTime configuration (variable</span>
<a name="l00384"></a>00384 <span class="comment"> * update).</span>
<a name="l00385"></a>00385 <span class="comment"> *</span>
<a name="l00386"></a>00386 <span class="comment"> * Asterisk will call this function each time a variable has been modified</span>
<a name="l00387"></a>00387 <span class="comment"> * internally and must be updated in the backend engine. keyfield and entity</span>
<a name="l00388"></a>00388 <span class="comment"> * are used to find the row to update, e.g. &lt;code&gt;UPDATE table SET ... WHERE</span>
<a name="l00389"></a>00389 <span class="comment"> * keyfield = &apos;entity&apos;;&lt;/code&gt;. ap is a list of parameters and values with the</span>
<a name="l00390"></a>00390 <span class="comment"> * same format as the other realtime functions.</span>
<a name="l00391"></a>00391 <span class="comment"> *</span>
<a name="l00392"></a>00392 <span class="comment"> * \param database the database to use (ignored)</span>
<a name="l00393"></a>00393 <span class="comment"> * \param table the table to use</span>
<a name="l00394"></a>00394 <span class="comment"> * \param keyfield the column of the matching cell</span>
<a name="l00395"></a>00395 <span class="comment"> * \param entity the value of the matching cell</span>
<a name="l00396"></a>00396 <span class="comment"> * \param ap list of parameters and new values to update in the database</span>
<a name="l00397"></a>00397 <span class="comment"> * \retval the number of affected rows.</span>
<a name="l00398"></a>00398 <span class="comment"> * \retval -1 if an error occurred.</span>
<a name="l00399"></a>00399 <span class="comment"> */</span>
<a name="l00400"></a>00400 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a6da1e7dac50ebd5c89cd6320d17bc083" title="Asterisk callback function for RealTime configuration (variable update).">realtime_update_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l00401"></a>00401    <span class="keyword">const</span> <span class="keywordtype">char</span> *keyfield, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#ad4e4601988acb4a95ecd1ec380359ae5">entity</a>, va_list ap);
<a name="l00402"></a>00402 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a2ef5eb1d975679c1199dc6f00f87d03b">realtime_update2_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l00403"></a>00403    va_list ap);
<a name="l00404"></a>00404 <span class="comment"></span>
<a name="l00405"></a>00405 <span class="comment">/*!</span>
<a name="l00406"></a>00406 <span class="comment"> * \brief Asterisk callback function for RealTime configuration (variable</span>
<a name="l00407"></a>00407 <span class="comment"> * create/store).</span>
<a name="l00408"></a>00408 <span class="comment"> *</span>
<a name="l00409"></a>00409 <span class="comment"> * Asterisk will call this function each time a variable has been created</span>
<a name="l00410"></a>00410 <span class="comment"> * internally and must be stored in the backend engine.</span>
<a name="l00411"></a>00411 <span class="comment"> * are used to find the row to update, e.g. ap is a list of parameters and</span>
<a name="l00412"></a>00412 <span class="comment"> * values with the same format as the other realtime functions.</span>
<a name="l00413"></a>00413 <span class="comment"> *</span>
<a name="l00414"></a>00414 <span class="comment"> * \param database the database to use (ignored)</span>
<a name="l00415"></a>00415 <span class="comment"> * \param table the table to use</span>
<a name="l00416"></a>00416 <span class="comment"> * \param ap list of parameters and new values to insert into the database</span>
<a name="l00417"></a>00417 <span class="comment"> * \retval the rowid of inserted row.</span>
<a name="l00418"></a>00418 <span class="comment"> * \retval -1 if an error occurred.</span>
<a name="l00419"></a>00419 <span class="comment"> */</span>
<a name="l00420"></a>00420 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a75c583659a1549848c8c40bf5a3efff1" title="Asterisk callback function for RealTime configuration (variable create/store).">realtime_store_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l00421"></a>00421    va_list ap);
<a name="l00422"></a>00422 <span class="comment"></span>
<a name="l00423"></a>00423 <span class="comment">/*!</span>
<a name="l00424"></a>00424 <span class="comment"> * \brief Asterisk callback function for RealTime configuration (destroys</span>
<a name="l00425"></a>00425 <span class="comment"> * variable).</span>
<a name="l00426"></a>00426 <span class="comment"> *</span>
<a name="l00427"></a>00427 <span class="comment"> * Asterisk will call this function each time a variable has been destroyed</span>
<a name="l00428"></a>00428 <span class="comment"> * internally and must be removed from the backend engine. keyfield and entity</span>
<a name="l00429"></a>00429 <span class="comment"> * are used to find the row to delete, e.g. &lt;code&gt;DELETE FROM table WHERE</span>
<a name="l00430"></a>00430 <span class="comment"> * keyfield = &apos;entity&apos;;&lt;/code&gt;. ap is a list of parameters and values with the</span>
<a name="l00431"></a>00431 <span class="comment"> * same format as the other realtime functions.</span>
<a name="l00432"></a>00432 <span class="comment"> *</span>
<a name="l00433"></a>00433 <span class="comment"> * \param database the database to use (ignored)</span>
<a name="l00434"></a>00434 <span class="comment"> * \param table the table to use</span>
<a name="l00435"></a>00435 <span class="comment"> * \param keyfield the column of the matching cell</span>
<a name="l00436"></a>00436 <span class="comment"> * \param entity the value of the matching cell</span>
<a name="l00437"></a>00437 <span class="comment"> * \param ap list of additional parameters for cell matching</span>
<a name="l00438"></a>00438 <span class="comment"> * \retval the number of affected rows.</span>
<a name="l00439"></a>00439 <span class="comment"> * \retval -1 if an error occurred.</span>
<a name="l00440"></a>00440 <span class="comment"> */</span>
<a name="l00441"></a>00441 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#aabedc36062e3aa13370311d070d1f2eb" title="Asterisk callback function for RealTime configuration (destroys variable).">realtime_destroy_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l00442"></a>00442    <span class="keyword">const</span> <span class="keywordtype">char</span> *keyfield, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#ad4e4601988acb4a95ecd1ec380359ae5">entity</a>, va_list ap);
<a name="l00443"></a>00443 <span class="comment"></span>
<a name="l00444"></a>00444 <span class="comment">/*!</span>
<a name="l00445"></a>00445 <span class="comment"> * \brief Asterisk callback function for the CLI status command.</span>
<a name="l00446"></a>00446 <span class="comment"> *</span>
<a name="l00447"></a>00447 <span class="comment"> * \param e CLI command</span>
<a name="l00448"></a>00448 <span class="comment"> * \param cmd </span>
<a name="l00449"></a>00449 <span class="comment"> * \param a CLI argument list</span>
<a name="l00450"></a>00450 <span class="comment"> * \return RESULT_SUCCESS</span>
<a name="l00451"></a>00451 <span class="comment"> */</span>
<a name="l00452"></a>00452 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#ac09349f29c2d83b9c82873b6b30d960f" title="Asterisk callback function for the CLI status command.">handle_cli_show_sqlite_status</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00453"></a>00453 <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#a3ae4390cbd19f3cbb3b5f51b6488decb">handle_cli_sqlite_show_tables</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a);
<a name="l00454"></a>00454 
<a name="l00455"></a>00455 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a286f8ad5d7b6c69af0ca40c7fb799012">realtime_require_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, va_list ap);
<a name="l00456"></a>00456 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a4554cd4e901164ef2da59b8398d56d8f">realtime_unload_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *unused, <span class="keyword">const</span> <span class="keywordtype">char</span> *tablename);
<a name="l00457"></a>00457 <span class="comment"></span>
<a name="l00458"></a>00458 <span class="comment">/*! The SQLite database object. */</span>
<a name="l00459"></a><a class="code" href="res__config__sqlite_8c.html#a082868565d651c0da1d2f0c194cb3248">00459</a> <span class="keyword">static</span> sqlite *<a class="code" href="res__config__sqlite_8c.html#a082868565d651c0da1d2f0c194cb3248">db</a>;
<a name="l00460"></a>00460 <span class="comment"></span>
<a name="l00461"></a>00461 <span class="comment">/*! Set to 1 if CDR support is enabled. */</span>
<a name="l00462"></a><a class="code" href="res__config__sqlite_8c.html#a50d89dee97961b1992b5213744a59120">00462</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a50d89dee97961b1992b5213744a59120">use_cdr</a>;
<a name="l00463"></a>00463 <span class="comment"></span>
<a name="l00464"></a>00464 <span class="comment">/*! Set to 1 if the CDR callback function was registered. */</span>
<a name="l00465"></a><a class="code" href="res__config__sqlite_8c.html#a4d2e93e1c4b3210b679a29b71df49c21">00465</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a4d2e93e1c4b3210b679a29b71df49c21">cdr_registered</a>;
<a name="l00466"></a>00466 <span class="comment"></span>
<a name="l00467"></a>00467 <span class="comment">/*! Set to 1 if the CLI status command callback function was registered. */</span>
<a name="l00468"></a><a class="code" href="res__config__sqlite_8c.html#a5b8501d6d552484744440e2ded409689">00468</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a5b8501d6d552484744440e2ded409689">cli_status_registered</a>;
<a name="l00469"></a>00469 <span class="comment"></span>
<a name="l00470"></a>00470 <span class="comment">/*! The path of the database file. */</span>
<a name="l00471"></a><a class="code" href="res__config__sqlite_8c.html#a723e9edf0fe1cdfa024e00803401e74e">00471</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#a723e9edf0fe1cdfa024e00803401e74e">dbfile</a>;
<a name="l00472"></a>00472 <span class="comment"></span>
<a name="l00473"></a>00473 <span class="comment">/*! The name of the static configuration table. */</span>
<a name="l00474"></a><a class="code" href="res__config__sqlite_8c.html#a726fbbc714a0071010def61248cd0416">00474</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#a726fbbc714a0071010def61248cd0416">config_table</a>;
<a name="l00475"></a>00475 <span class="comment"></span>
<a name="l00476"></a>00476 <span class="comment">/*! The name of the table used to store CDR entries. */</span>
<a name="l00477"></a><a class="code" href="res__config__sqlite_8c.html#a5684b2e0f909bbe1870dcdfce38e9b6a">00477</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#a5684b2e0f909bbe1870dcdfce38e9b6a">cdr_table</a>;
<a name="l00478"></a>00478 <span class="comment"></span>
<a name="l00479"></a>00479 <span class="comment">/*!</span>
<a name="l00480"></a>00480 <span class="comment"> * The structure specifying all callback functions used by Asterisk for static</span>
<a name="l00481"></a>00481 <span class="comment"> * and RealTime configuration.</span>
<a name="l00482"></a>00482 <span class="comment"> */</span>
<a name="l00483"></a><a class="code" href="res__config__sqlite_8c.html#a7b48efb1da6b47259373e75543e0e320">00483</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config__engine.html" title="Configuration engine structure, used to define realtime drivers.">ast_config_engine</a> <a class="code" href="res__config__sqlite_8c.html#a7b48efb1da6b47259373e75543e0e320">sqlite_engine</a> =
<a name="l00484"></a>00484 {
<a name="l00485"></a>00485    .<a class="code" href="structast__config__engine.html#a5ac083a645d964373f022d03df4849c8">name</a> = <a class="code" href="res__config__sqlite_8c.html#af904e6a4f8bb70e7fabc40848744941f">RES_CONFIG_SQLITE_DRIVER</a>,
<a name="l00486"></a>00486    .load_func = <a class="code" href="res__config__sqlite_8c.html#a7c363143661597b8480ef856c1acad80" title="Asterisk callback function for static configuration.">config_handler</a>,
<a name="l00487"></a>00487    .realtime_func = <a class="code" href="res__config__sqlite_8c.html#a338dc290c800ac25ab8c52e43376e951" title="Asterisk callback function for RealTime configuration.">realtime_handler</a>,
<a name="l00488"></a>00488    .realtime_multi_func = <a class="code" href="res__config__sqlite_8c.html#ac1fb5f8486409dcf9931a7e616fd55cd" title="Asterisk callback function for RealTime configuration.">realtime_multi_handler</a>,
<a name="l00489"></a>00489    .store_func = <a class="code" href="res__config__sqlite_8c.html#a75c583659a1549848c8c40bf5a3efff1" title="Asterisk callback function for RealTime configuration (variable create/store).">realtime_store_handler</a>,
<a name="l00490"></a>00490    .destroy_func = <a class="code" href="res__config__sqlite_8c.html#aabedc36062e3aa13370311d070d1f2eb" title="Asterisk callback function for RealTime configuration (destroys variable).">realtime_destroy_handler</a>,
<a name="l00491"></a>00491    .update_func = <a class="code" href="res__config__sqlite_8c.html#a6da1e7dac50ebd5c89cd6320d17bc083" title="Asterisk callback function for RealTime configuration (variable update).">realtime_update_handler</a>,
<a name="l00492"></a>00492    .update2_func = <a class="code" href="res__config__sqlite_8c.html#a2ef5eb1d975679c1199dc6f00f87d03b">realtime_update2_handler</a>,
<a name="l00493"></a>00493    .require_func = <a class="code" href="res__config__sqlite_8c.html#a286f8ad5d7b6c69af0ca40c7fb799012">realtime_require_handler</a>,
<a name="l00494"></a>00494    .unload_func = <a class="code" href="res__config__sqlite_8c.html#a4554cd4e901164ef2da59b8398d56d8f">realtime_unload_handler</a>,
<a name="l00495"></a>00495 };
<a name="l00496"></a>00496 <span class="comment"></span>
<a name="l00497"></a>00497 <span class="comment">/*!</span>
<a name="l00498"></a>00498 <span class="comment"> * The mutex used to prevent simultaneous access to the SQLite database.</span>
<a name="l00499"></a>00499 <span class="comment"> */</span>
<a name="l00500"></a><a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">00500</a> <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00501"></a>00501 <span class="comment"></span>
<a name="l00502"></a>00502 <span class="comment">/*!</span>
<a name="l00503"></a>00503 <span class="comment"> * Structure containing details and callback functions for the CLI status</span>
<a name="l00504"></a>00504 <span class="comment"> * command.</span>
<a name="l00505"></a>00505 <span class="comment"> */</span>
<a name="l00506"></a><a class="code" href="res__config__sqlite_8c.html#a47b6b9c6ba9ec579e0cc93d497500db8">00506</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="res__config__sqlite_8c.html#a47b6b9c6ba9ec579e0cc93d497500db8">cli_status</a>[] = {
<a name="l00507"></a>00507    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__config__sqlite_8c.html#ac09349f29c2d83b9c82873b6b30d960f" title="Asterisk callback function for the CLI status command.">handle_cli_show_sqlite_status</a>, <span class="stringliteral">&quot;Show status information about the SQLite 2 driver&quot;</span>),
<a name="l00508"></a>00508    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="res__config__sqlite_8c.html#a3ae4390cbd19f3cbb3b5f51b6488decb">handle_cli_sqlite_show_tables</a>, <span class="stringliteral">&quot;Cached table information about the SQLite 2 driver&quot;</span>),
<a name="l00509"></a>00509 };
<a name="l00510"></a>00510 
<a name="l00511"></a><a class="code" href="structsqlite__cache__columns.html">00511</a> <span class="keyword">struct </span><a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a> {
<a name="l00512"></a><a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">00512</a>    <span class="keywordtype">char</span> *<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00513"></a><a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">00513</a>    <span class="keywordtype">char</span> *<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>;
<a name="l00514"></a><a class="code" href="structsqlite__cache__columns.html#a751d974203a2f02b0ccf870012d13ee9">00514</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structsqlite__cache__columns.html#a751d974203a2f02b0ccf870012d13ee9">isint</a>;    <span class="comment">/*!&lt; By definition, only INTEGER PRIMARY KEY is an integer; everything else is a string. */</span>
<a name="l00515"></a><a class="code" href="structsqlite__cache__columns.html#a27aeeeff07ffa60c5acc191dcde49ab3">00515</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a>) <a class="code" href="structsqlite__cache__columns.html#a291206e3702ce9f01cfed19396a638dc">list</a>;
<a name="l00516"></a>00516 };
<a name="l00517"></a>00517 
<a name="l00518"></a><a class="code" href="structsqlite__cache__tables.html">00518</a> struct <a class="code" href="structsqlite__cache__tables.html">sqlite_cache_tables</a> {
<a name="l00519"></a><a class="code" href="structsqlite__cache__tables.html#a5ac083a645d964373f022d03df4849c8">00519</a>    <span class="keywordtype">char</span> *<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00520"></a><a class="code" href="structsqlite__cache__tables_1_1__columns.html#ace4e0066a5b24f84b90536e9906619f6">00520</a>    <a class="code" href="linkedlists_8h.html#a93a29f1537444303ac1707e50b1a841d" title="Defines a structure to be used to hold a read/write list of specified type.">AST_RWLIST_HEAD</a>(<a class="code" href="structsqlite__cache__tables_1_1__columns.html">_columns</a>, <a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a>) <a class="code" href="structcolumns.html">columns</a>;
<a name="l00521"></a><a class="code" href="structsqlite__cache__tables.html#ad3d528019ddfd961e9124b266afb8a05">00521</a>    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(sqlite_cache_tables) list;
<a name="l00522"></a>00522 };
<a name="l00523"></a>00523 
<a name="l00524"></a><a class="code" href="structsqlite__tables.html#ace4e0066a5b24f84b90536e9906619f6">00524</a> static <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structsqlite__tables.html">sqlite_tables</a>, sqlite_cache_tables);
<a name="l00525"></a>00525 
<a name="l00526"></a>00526 <span class="comment">/*</span>
<a name="l00527"></a>00527 <span class="comment"> * Taken from Asterisk 1.2 cdr_sqlite.so.</span>
<a name="l00528"></a>00528 <span class="comment"> */</span>
<a name="l00529"></a>00529 <span class="comment"></span>
<a name="l00530"></a>00530 <span class="comment">/*! SQL query format to create the CDR table if non existent. */</span>
<a name="l00531"></a><a class="code" href="res__config__sqlite_8c.html#ae6feefd120eabf04edc898d1430fd9f0">00531</a> static <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#ae6feefd120eabf04edc898d1430fd9f0">sql_create_cdr_table</a> =
<a name="l00532"></a>00532 &quot;CREATE TABLE &apos;%q&apos; (\n&quot;
<a name="l00533"></a>00533 &quot;  <span class="keywordtype">id</span>    INTEGER,\n&quot;
<a name="l00534"></a>00534 &quot;  clid     VARCHAR(80) NOT NULL <a class="code" href="astobj2_8c.html#a022a436822026a8dd39d892e8056aa44a88ec7d5086d2469ba843c7fcceade8a6">DEFAULT</a> &apos;&apos;,\n&quot;
<a name="l00535"></a>00535 &quot;  src      VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00536"></a>00536 &quot;  dst      VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00537"></a>00537 &quot;  dcontext VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00538"></a>00538 &quot;  channel     VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00539"></a>00539 &quot;  dstchannel  VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00540"></a>00540 &quot;  lastapp     VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00541"></a>00541 &quot;  lastdata VARCHAR(80) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00542"></a>00542 &quot;  start    DATETIME NOT NULL DEFAULT &apos;0000-00-00 00:00:00&apos;,\n&quot;
<a name="l00543"></a>00543 &quot;  answer      DATETIME NOT NULL DEFAULT &apos;0000-00-00 00:00:00&apos;,\n&quot;
<a name="l00544"></a>00544 &quot;  end      DATETIME NOT NULL DEFAULT &apos;0000-00-00 00:00:00&apos;,\n&quot;
<a name="l00545"></a>00545 &quot;  duration INT(11)     NOT NULL DEFAULT 0,\n&quot;
<a name="l00546"></a>00546 &quot;  billsec     INT(11)     NOT NULL DEFAULT 0,\n&quot;
<a name="l00547"></a>00547 &quot;  disposition VARCHAR(45) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00548"></a>00548 &quot;  <a class="code" href="chan__iax2_8c.html#ad2cfb0f821c065261382a9298bb5a16b">amaflags</a> INT(11)     NOT NULL DEFAULT 0,\n&quot;
<a name="l00549"></a>00549 &quot;  <a class="code" href="chan__iax2_8c.html#adfee50d07a98645d4d20b896ce03785a">accountcode</a> VARCHAR(20) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00550"></a>00550 &quot;  uniqueid VARCHAR(32) NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00551"></a>00551 &quot;  userfield   VARCHAR(255)   NOT NULL DEFAULT &apos;&apos;,\n&quot;
<a name="l00552"></a>00552 &quot;  PRIMARY KEY (<span class="keywordtype">id</span>)\n&quot;
<a name="l00553"></a>00553 &quot;);&quot;;
<a name="l00554"></a>00554 <span class="comment"></span>
<a name="l00555"></a>00555 <span class="comment">/*!</span>
<a name="l00556"></a>00556 <span class="comment"> * SQL query format to describe the table structure</span>
<a name="l00557"></a>00557 <span class="comment"> */</span>
<a name="l00558"></a><a class="code" href="res__config__sqlite_8c.html#afea0cb44ed8d5fc52fcee6ae61e40561">00558</a> <span class="preprocessor">#define sql_table_structure &quot;SELECT sql FROM sqlite_master WHERE type=&apos;table&apos; AND tbl_name=&apos;%s&apos;&quot;</span>
<a name="l00559"></a>00559 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00560"></a>00560 <span class="comment">/*!</span>
<a name="l00561"></a>00561 <span class="comment"> * SQL query format to fetch the static configuration of a file.</span>
<a name="l00562"></a>00562 <span class="comment"> * Rows must be sorted by category.</span>
<a name="l00563"></a>00563 <span class="comment"> *</span>
<a name="l00564"></a>00564 <span class="comment"> * \see add_cfg_entry()</span>
<a name="l00565"></a>00565 <span class="comment"> */</span>
<a name="l00566"></a><a class="code" href="res__config__sqlite_8c.html#a5ca80598759ece103ebaf5cc9aae308a">00566</a> <span class="preprocessor">#define sql_get_config_table \</span>
<a name="l00567"></a>00567 <span class="preprocessor">   &quot;SELECT *&quot; \</span>
<a name="l00568"></a>00568 <span class="preprocessor">   &quot;  FROM &apos;%q&apos;&quot; \</span>
<a name="l00569"></a>00569 <span class="preprocessor">   &quot;  WHERE filename = &apos;%q&apos; AND commented = 0&quot; \</span>
<a name="l00570"></a>00570 <span class="preprocessor">   &quot;  ORDER BY cat_metric ASC, var_metric ASC;&quot;</span>
<a name="l00571"></a>00571 <span class="preprocessor"></span>
<a name="l00572"></a><a class="code" href="res__config__sqlite_8c.html#a5784f210e0f5472a18ecd99d64ffec9e">00572</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__config__sqlite_8c.html#a5784f210e0f5472a18ecd99d64ffec9e">free_table</a>(<span class="keyword">struct</span> sqlite_cache_tables *tblptr)
<a name="l00573"></a>00573 {
<a name="l00574"></a>00574    <span class="keyword">struct </span><a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a> *col;
<a name="l00575"></a>00575 
<a name="l00576"></a>00576    <span class="comment">/* Obtain a write lock to ensure there are no read locks outstanding */</span>
<a name="l00577"></a>00577    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l00578"></a>00578    <span class="keywordflow">while</span> ((col = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>), list))) {
<a name="l00579"></a>00579       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(col);
<a name="l00580"></a>00580    }
<a name="l00581"></a>00581    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l00582"></a>00582    <a class="code" href="linkedlists_8h.html#acc3deb56109ed902edf384070e3f8f42" title="Destroys an rwlist head structure.">AST_RWLIST_HEAD_DESTROY</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l00583"></a>00583    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tblptr);
<a name="l00584"></a>00584 }
<a name="l00585"></a>00585 
<a name="l00586"></a><a class="code" href="res__config__sqlite_8c.html#a31acdca539faef9b6707d7f930903657">00586</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a31acdca539faef9b6707d7f930903657">find_table_cb</a>(<span class="keywordtype">void</span> *vtblptr, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, <span class="keywordtype">char</span> **columnNames)
<a name="l00587"></a>00587 {
<a name="l00588"></a>00588    <span class="keyword">struct </span>sqlite_cache_tables *tblptr = vtblptr;
<a name="l00589"></a>00589    <span class="keywordtype">char</span> *sql = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(argv[0]), *start, *end, *<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, *remainder;
<a name="l00590"></a>00590    <span class="keywordtype">int</span> i;
<a name="l00591"></a>00591    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(fie,
<a name="l00592"></a>00592       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(ld)[100]; <span class="comment">/* This means we support up to 100 columns per table */</span>
<a name="l00593"></a>00593    );
<a name="l00594"></a>00594    <span class="keyword">struct </span><a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a> *col;
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    <span class="comment">/* This is really fun.  We get to parse an SQL statement to figure out</span>
<a name="l00597"></a>00597 <span class="comment">    * what columns are in the table.</span>
<a name="l00598"></a>00598 <span class="comment">    */</span>
<a name="l00599"></a>00599    <span class="keywordflow">if</span> ((start = strchr(sql, <span class="charliteral">&apos;(&apos;</span>)) &amp;&amp; (end = strrchr(sql, <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l00600"></a>00600       start++;
<a name="l00601"></a>00601       *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00602"></a>00602    } <span class="keywordflow">else</span> {
<a name="l00603"></a>00603       <span class="comment">/* Abort */</span>
<a name="l00604"></a>00604       <span class="keywordflow">return</span> -1;
<a name="l00605"></a>00605    }
<a name="l00606"></a>00606 
<a name="l00607"></a>00607    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(fie, start);
<a name="l00608"></a>00608    <span class="keywordflow">for</span> (i = 0; i &lt; fie.argc; i++) {
<a name="l00609"></a>00609       fie.ld[i] = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(fie.ld[i]);
<a name="l00610"></a>00610       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Found field: %s\n&quot;</span>, fie.ld[i]);
<a name="l00611"></a>00611       <span class="keywordflow">if</span> (strncasecmp(fie.ld[i], <span class="stringliteral">&quot;PRIMARY KEY&quot;</span>, 11) == 0 &amp;&amp; (start = strchr(fie.ld[i], <span class="charliteral">&apos;(&apos;</span>)) &amp;&amp; (end = strchr(fie.ld[i], <span class="charliteral">&apos;)&apos;</span>))) {
<a name="l00612"></a>00612          *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00613"></a>00613          <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>), col, list) {
<a name="l00614"></a>00614             <span class="keywordflow">if</span> (strcasecmp(start + 1, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>) == 0 &amp;&amp; <a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(col-&gt;<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, <span class="stringliteral">&quot;INTEGER&quot;</span>)) {
<a name="l00615"></a>00615                col-&gt;<a class="code" href="structsqlite__cache__columns.html#a751d974203a2f02b0ccf870012d13ee9">isint</a> = 1;
<a name="l00616"></a>00616             }
<a name="l00617"></a>00617          }
<a name="l00618"></a>00618          <span class="keywordflow">continue</span>;
<a name="l00619"></a>00619       }
<a name="l00620"></a>00620       <span class="comment">/* type delimiter could be any space character */</span>
<a name="l00621"></a>00621       <span class="keywordflow">for</span> (type = fie.ld[i]; *type &gt; 32; type++);
<a name="l00622"></a>00622       *type++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00623"></a>00623       type = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(type);
<a name="l00624"></a>00624       <span class="keywordflow">for</span> (remainder = type; *remainder &gt; 32; remainder++);
<a name="l00625"></a>00625       *remainder = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00626"></a>00626       <span class="keywordflow">if</span> (!(col = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*col) + strlen(fie.ld[i]) + strlen(type) + 2))) {
<a name="l00627"></a>00627          <span class="keywordflow">return</span> -1;
<a name="l00628"></a>00628       }
<a name="l00629"></a>00629       col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a> = (<span class="keywordtype">char</span> *)col + <span class="keyword">sizeof</span>(*col);
<a name="l00630"></a>00630       col-&gt;<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a> = (<span class="keywordtype">char</span> *)col + <span class="keyword">sizeof</span>(*col) + strlen(fie.ld[i]) + 1;
<a name="l00631"></a>00631       strcpy(col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>, fie.ld[i]); <span class="comment">/* SAFE */</span>
<a name="l00632"></a>00632       strcpy(col-&gt;<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, type); <span class="comment">/* SAFE */</span>
<a name="l00633"></a>00633       <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(col-&gt;<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, <span class="stringliteral">&quot;INTEGER&quot;</span>) &amp;&amp; <a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(col-&gt;<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, <span class="stringliteral">&quot;PRIMARY KEY&quot;</span>)) {
<a name="l00634"></a>00634          col-&gt;<a class="code" href="structsqlite__cache__columns.html#a751d974203a2f02b0ccf870012d13ee9">isint</a> = 1;
<a name="l00635"></a>00635       }
<a name="l00636"></a>00636       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>), col, list);
<a name="l00637"></a>00637    }
<a name="l00638"></a>00638    <span class="keywordflow">return</span> 0;
<a name="l00639"></a>00639 }
<a name="l00640"></a>00640 
<a name="l00641"></a><a class="code" href="res__config__sqlite_8c.html#a990147aa70d656ae71a98b581e05d7cd">00641</a> <span class="keyword">static</span> <span class="keyword">struct </span>sqlite_cache_tables *<a class="code" href="res__config__sqlite_8c.html#a990147aa70d656ae71a98b581e05d7cd">find_table</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *tablename)
<a name="l00642"></a>00642 {
<a name="l00643"></a>00643    <span class="keyword">struct </span>sqlite_cache_tables *tblptr;
<a name="l00644"></a>00644    <span class="keywordtype">int</span> i, err;
<a name="l00645"></a>00645    <span class="keywordtype">char</span> *sql, *errstr = NULL;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sqlite_tables);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649    <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l00650"></a>00650       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sqlite_tables, tblptr, list) {
<a name="l00651"></a>00651          <span class="keywordflow">if</span> (strcmp(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#a5ac083a645d964373f022d03df4849c8">name</a>, tablename) == 0) {
<a name="l00652"></a>00652             <span class="keywordflow">break</span>;
<a name="l00653"></a>00653          }
<a name="l00654"></a>00654       }
<a name="l00655"></a>00655       <span class="keywordflow">if</span> (tblptr) {
<a name="l00656"></a>00656          <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l00657"></a>00657          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l00658"></a>00658          <span class="keywordflow">return</span> tblptr;
<a name="l00659"></a>00659       }
<a name="l00660"></a>00660 
<a name="l00661"></a>00661       <span class="keywordflow">if</span> (i == 0) {
<a name="l00662"></a>00662          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l00663"></a>00663          <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sqlite_tables);
<a name="l00664"></a>00664       }
<a name="l00665"></a>00665    }
<a name="l00666"></a>00666 
<a name="l00667"></a>00667    <span class="comment">/* Table structure not cached; build the structure now */</span>
<a name="l00668"></a>00668    <span class="keywordflow">if</span> (<a class="code" href="astmm_8h.html#a5d1f84199c77c83b8b51928dd359e228">asprintf</a>(&amp;sql, <a class="code" href="res__config__sqlite_8c.html#afea0cb44ed8d5fc52fcee6ae61e40561">sql_table_structure</a>, tablename) &lt; 0) {
<a name="l00669"></a>00669       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;asprintf() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00670"></a>00670       sql = NULL;
<a name="l00671"></a>00671    }
<a name="l00672"></a>00672    <span class="keywordflow">if</span> (!(tblptr = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*tblptr) + strlen(tablename) + 1))) {
<a name="l00673"></a>00673       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l00674"></a>00674       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory error.  Cannot cache table &apos;%s&apos;\n&quot;</span>, tablename);
<a name="l00675"></a>00675       <span class="keywordflow">return</span> NULL;
<a name="l00676"></a>00676    }
<a name="l00677"></a>00677    tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#a5ac083a645d964373f022d03df4849c8">name</a> = (<span class="keywordtype">char</span> *)tblptr + <span class="keyword">sizeof</span>(*tblptr);
<a name="l00678"></a>00678    strcpy(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#a5ac083a645d964373f022d03df4849c8">name</a>, tablename); <span class="comment">/* SAFE */</span>
<a name="l00679"></a>00679    <a class="code" href="linkedlists_8h.html#a389aaa73318087dfed0cdd11e1d3090b" title="Initializes an rwlist head structure.">AST_RWLIST_HEAD_INIT</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l00680"></a>00680 
<a name="l00681"></a>00681    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;About to query table structure: %s\n&quot;</span>, sql);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00684"></a>00684    <span class="keywordflow">if</span> ((err = sqlite_exec(db, sql, <a class="code" href="res__config__sqlite_8c.html#a31acdca539faef9b6707d7f930903657">find_table_cb</a>, tblptr, &amp;errstr))) {
<a name="l00685"></a>00685       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00686"></a>00686       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQLite error %d: %s\n&quot;</span>, err, errstr);
<a name="l00687"></a>00687       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(errstr);
<a name="l00688"></a>00688       <a class="code" href="res__config__sqlite_8c.html#a5784f210e0f5472a18ecd99d64ffec9e">free_table</a>(tblptr);
<a name="l00689"></a>00689       <span class="keywordflow">return</span> NULL;
<a name="l00690"></a>00690    }
<a name="l00691"></a>00691    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00692"></a>00692 
<a name="l00693"></a>00693    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>))) {
<a name="l00694"></a>00694       <a class="code" href="res__config__sqlite_8c.html#a5784f210e0f5472a18ecd99d64ffec9e">free_table</a>(tblptr);
<a name="l00695"></a>00695       <span class="keywordflow">return</span> NULL;
<a name="l00696"></a>00696    }
<a name="l00697"></a>00697 
<a name="l00698"></a>00698    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;sqlite_tables, tblptr, list);
<a name="l00699"></a>00699    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;(tblptr-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l00700"></a>00700    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l00701"></a>00701    <span class="keywordflow">return</span> tblptr;
<a name="l00702"></a>00702 }
<a name="l00703"></a>00703 
<a name="l00704"></a><a class="code" href="res__config__sqlite_8c.html#a792da613ea8b323dedd14a35d0b367a2">00704</a> <span class="preprocessor">#define release_table(a)   AST_RWLIST_UNLOCK(&amp;((a)-&gt;columns))</span>
<a name="l00705"></a>00705 <span class="preprocessor"></span>
<a name="l00706"></a><a class="code" href="res__config__sqlite_8c.html#a9493baa3343654ae2828e06ad1ace967">00706</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a9493baa3343654ae2828e06ad1ace967" title="Allocate a variable.">set_var</a>(<span class="keywordtype">char</span> **<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *name, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l00707"></a>00707 {
<a name="l00708"></a>00708    <span class="keywordflow">if</span> (*var)
<a name="l00709"></a>00709       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(*var);
<a name="l00710"></a>00710 
<a name="l00711"></a>00711    *var = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(value);
<a name="l00712"></a>00712 
<a name="l00713"></a>00713    <span class="keywordflow">if</span> (!*var) {
<a name="l00714"></a>00714       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate variable %s\n&quot;</span>, name);
<a name="l00715"></a>00715       <span class="keywordflow">return</span> 1;
<a name="l00716"></a>00716    }
<a name="l00717"></a>00717 
<a name="l00718"></a>00718    <span class="keywordflow">return</span> 0;
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="res__config__sqlite_8c.html#aa12194f6de6564ba57f2639c27bf3530">00721</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#aa12194f6de6564ba57f2639c27bf3530">check_vars</a>(<span class="keywordtype">void</span>)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723    <span class="keywordflow">if</span> (!dbfile) {
<a name="l00724"></a>00724       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Required parameter undefined: dbfile\n&quot;</span>);
<a name="l00725"></a>00725       <span class="keywordflow">return</span> 1;
<a name="l00726"></a>00726    }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728    use_cdr = (cdr_table != NULL);
<a name="l00729"></a>00729 
<a name="l00730"></a>00730    <span class="keywordflow">return</span> 0;
<a name="l00731"></a>00731 }
<a name="l00732"></a>00732 
<a name="l00733"></a><a class="code" href="res__config__sqlite_8c.html#aed5779f84d4ebb67745d801d3ebede43">00733</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#aed5779f84d4ebb67745d801d3ebede43" title="Load the configuration file.">load_config</a>(<span class="keywordtype">void</span>)
<a name="l00734"></a>00734 {
<a name="l00735"></a>00735    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="cdr__csv_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>;
<a name="l00736"></a>00736    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l00737"></a>00737    <span class="keywordtype">int</span> error;
<a name="l00738"></a>00738    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l00739"></a>00739 
<a name="l00740"></a>00740    config = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="res__config__sqlite_8c.html#a4ac391d995daec836742fde68abf645f">RES_CONFIG_SQLITE_CONF_FILE</a>, config_flags);
<a name="l00741"></a>00741 
<a name="l00742"></a>00742    <span class="keywordflow">if</span> (config == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || config == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00743"></a>00743       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to load &quot;</span> <a class="code" href="res__config__sqlite_8c.html#a4ac391d995daec836742fde68abf645f">RES_CONFIG_SQLITE_CONF_FILE</a> <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l00744"></a>00744       <span class="keywordflow">return</span> 1;
<a name="l00745"></a>00745    }
<a name="l00746"></a>00746 
<a name="l00747"></a>00747    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(config, <span class="stringliteral">&quot;general&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00748"></a>00748       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;dbfile&quot;</span>))
<a name="l00749"></a>00749          <a class="code" href="res__config__sqlite_8c.html#abb5414f66b45fde76fd377295dfdbe45">SET_VAR</a>(config, dbfile, var);
<a name="l00750"></a>00750       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;config_table&quot;</span>))
<a name="l00751"></a>00751          <a class="code" href="res__config__sqlite_8c.html#abb5414f66b45fde76fd377295dfdbe45">SET_VAR</a>(config, config_table, var);
<a name="l00752"></a>00752       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;cdr_table&quot;</span>)) {
<a name="l00753"></a>00753          <a class="code" href="res__config__sqlite_8c.html#abb5414f66b45fde76fd377295dfdbe45">SET_VAR</a>(config, cdr_table, var);
<a name="l00754"></a>00754       } <span class="keywordflow">else</span>
<a name="l00755"></a>00755          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown parameter : %s\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00756"></a>00756    }
<a name="l00757"></a>00757 
<a name="l00758"></a>00758    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(config);
<a name="l00759"></a>00759    error = <a class="code" href="res__config__sqlite_8c.html#aa12194f6de6564ba57f2639c27bf3530">check_vars</a>();
<a name="l00760"></a>00760 
<a name="l00761"></a>00761    <span class="keywordflow">if</span> (error) {
<a name="l00762"></a>00762       <a class="code" href="res__config__sqlite_8c.html#a72f99a227dc7bc5522ba90399070f385" title="Free resources related to configuration.">unload_config</a>();
<a name="l00763"></a>00763       <span class="keywordflow">return</span> 1;
<a name="l00764"></a>00764    }
<a name="l00765"></a>00765 
<a name="l00766"></a>00766    <span class="keywordflow">return</span> 0;
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 
<a name="l00769"></a><a class="code" href="res__config__sqlite_8c.html#a72f99a227dc7bc5522ba90399070f385">00769</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__config__sqlite_8c.html#a72f99a227dc7bc5522ba90399070f385" title="Free resources related to configuration.">unload_config</a>(<span class="keywordtype">void</span>)
<a name="l00770"></a>00770 {
<a name="l00771"></a>00771    <span class="keyword">struct </span>sqlite_cache_tables *tbl;
<a name="l00772"></a>00772    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(dbfile);
<a name="l00773"></a>00773    dbfile = NULL;
<a name="l00774"></a>00774    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(config_table);
<a name="l00775"></a>00775    config_table = NULL;
<a name="l00776"></a>00776    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cdr_table);
<a name="l00777"></a>00777    cdr_table = NULL;
<a name="l00778"></a>00778    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sqlite_tables);
<a name="l00779"></a>00779    <span class="keywordflow">while</span> ((tbl = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;sqlite_tables, list))) {
<a name="l00780"></a>00780       <a class="code" href="res__config__sqlite_8c.html#a5784f210e0f5472a18ecd99d64ffec9e">free_table</a>(tbl);
<a name="l00781"></a>00781    }
<a name="l00782"></a>00782    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 
<a name="l00785"></a><a class="code" href="res__config__sqlite_8c.html#a9b959d97c623a073d5562c5921b0635a">00785</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a9b959d97c623a073d5562c5921b0635a" title="Asterisk callback function for CDR support.">cdr_handler</a>(<span class="keyword">struct</span> <a class="code" href="structast__cdr.html" title="Responsible for call detail data.">ast_cdr</a> *cdr)
<a name="l00786"></a>00786 {
<a name="l00787"></a>00787    <span class="keywordtype">char</span> *errormsg = NULL, *tmp, workspace[500];
<a name="l00788"></a>00788    <span class="keywordtype">int</span> error, scannum;
<a name="l00789"></a>00789    <span class="keyword">struct </span>sqlite_cache_tables *tbl = <a class="code" href="res__config__sqlite_8c.html#a990147aa70d656ae71a98b581e05d7cd">find_table</a>(cdr_table);
<a name="l00790"></a>00790    <span class="keyword">struct </span><a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a> *col;
<a name="l00791"></a>00791    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql1 = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(160), *sql2 = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(16);
<a name="l00792"></a>00792    <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> = 1;
<a name="l00793"></a>00793 
<a name="l00794"></a>00794    <span class="keywordflow">if</span> (!tbl) {
<a name="l00795"></a>00795       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No such table: %s\n&quot;</span>, cdr_table);
<a name="l00796"></a>00796       <span class="keywordflow">return</span> -1;
<a name="l00797"></a>00797    }
<a name="l00798"></a>00798 
<a name="l00799"></a>00799    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql1, 0, <span class="stringliteral">&quot;INSERT INTO %s (&quot;</span>, cdr_table);
<a name="l00800"></a>00800    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql2, 0, <span class="stringliteral">&quot;) VALUES (&quot;</span>);
<a name="l00801"></a>00801 
<a name="l00802"></a>00802    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;(tbl-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>), col, list) {
<a name="l00803"></a>00803       <span class="keywordflow">if</span> (col-&gt;<a class="code" href="structsqlite__cache__columns.html#a751d974203a2f02b0ccf870012d13ee9">isint</a>) {
<a name="l00804"></a>00804          <a class="code" href="cdr_8h.html#a7e49e9d173fdc79d0567337f96a648a1">ast_cdr_getvar</a>(cdr, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>, &amp;tmp, workspace, <span class="keyword">sizeof</span>(workspace), 0, 1);
<a name="l00805"></a>00805          <span class="keywordflow">if</span> (!tmp) {
<a name="l00806"></a>00806             <span class="keywordflow">continue</span>;
<a name="l00807"></a>00807          }
<a name="l00808"></a>00808          <span class="keywordflow">if</span> (sscanf(tmp, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;scannum) == 1) {
<a name="l00809"></a>00809             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql1, 0, <span class="stringliteral">&quot;%s%s&quot;</span>, first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00810"></a>00810             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql2, 0, <span class="stringliteral">&quot;%s%d&quot;</span>, first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>, scannum);
<a name="l00811"></a>00811          }
<a name="l00812"></a>00812       } <span class="keywordflow">else</span> {
<a name="l00813"></a>00813          <a class="code" href="cdr_8h.html#a7e49e9d173fdc79d0567337f96a648a1">ast_cdr_getvar</a>(cdr, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>, &amp;tmp, workspace, <span class="keyword">sizeof</span>(workspace), 0, 0);
<a name="l00814"></a>00814          <span class="keywordflow">if</span> (!tmp) {
<a name="l00815"></a>00815             <span class="keywordflow">continue</span>;
<a name="l00816"></a>00816          }
<a name="l00817"></a>00817          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql1, 0, <span class="stringliteral">&quot;%s%s&quot;</span>, first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00818"></a>00818          tmp = sqlite_mprintf(<span class="stringliteral">&quot;%Q&quot;</span>, tmp);
<a name="l00819"></a>00819          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql2, 0, <span class="stringliteral">&quot;%s%s&quot;</span>, first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>, tmp);
<a name="l00820"></a>00820          sqlite_freemem(tmp);
<a name="l00821"></a>00821       }
<a name="l00822"></a>00822       first = 0;
<a name="l00823"></a>00823    }
<a name="l00824"></a>00824    <a class="code" href="res__config__pgsql_8c.html#a82afbdbc2221a2a7323b0b40c6b99879">release_table</a>(tbl);
<a name="l00825"></a>00825 
<a name="l00826"></a>00826    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql1, 0, <span class="stringliteral">&quot;%s)&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql2));
<a name="l00827"></a>00827    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql2);
<a name="l00828"></a>00828 
<a name="l00829"></a>00829    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql1));
<a name="l00830"></a>00830 
<a name="l00831"></a>00831    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00832"></a>00832 
<a name="l00833"></a>00833    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l00834"></a>00834       error = sqlite_exec(db, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql1), NULL, NULL, &amp;errormsg);
<a name="l00835"></a>00835    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l00836"></a>00836 
<a name="l00837"></a>00837    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00838"></a>00838 
<a name="l00839"></a>00839    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(sql1);
<a name="l00840"></a>00840 
<a name="l00841"></a>00841    <span class="keywordflow">if</span> (error) {
<a name="l00842"></a>00842       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l00843"></a>00843       sqlite_freemem(errormsg);
<a name="l00844"></a>00844       <span class="keywordflow">return</span> 1;
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846    sqlite_freemem(errormsg);
<a name="l00847"></a>00847 
<a name="l00848"></a>00848    <span class="keywordflow">return</span> 0;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00851"></a><a class="code" href="res__config__sqlite_8c.html#ab0550541665aab14df8f089397bba5ae">00851</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#ab0550541665aab14df8f089397bba5ae" title="SQLite callback function for static configuration.">add_cfg_entry</a>(<span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, <span class="keywordtype">char</span> **columnNames)
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853    <span class="keyword">struct </span><a class="code" href="structcfg__entry__args.html">cfg_entry_args</a> *args;
<a name="l00854"></a>00854    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l00855"></a>00855 
<a name="l00856"></a>00856    <span class="keywordflow">if</span> (argc != <a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda60b88f192e5aaf532b024bfd3195083d">RES_CONFIG_SQLITE_CONFIG_COLUMNS</a>) {
<a name="l00857"></a>00857       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Corrupt table\n&quot;</span>);
<a name="l00858"></a>00858       <span class="keywordflow">return</span> 1;
<a name="l00859"></a>00859    }
<a name="l00860"></a>00860 
<a name="l00861"></a>00861    args = arg;
<a name="l00862"></a>00862 
<a name="l00863"></a>00863    <span class="keywordflow">if</span> (!strcmp(argv[<a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda0a6b34fcd5c07ea3e84b0727e33efdd5">RES_CONFIG_SQLITE_CONFIG_VAR_NAME</a>], <span class="stringliteral">&quot;#include&quot;</span>)) {
<a name="l00864"></a>00864       <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l00865"></a>00865       <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>;
<a name="l00866"></a>00866 
<a name="l00867"></a>00867       val = argv[<a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda7ade715af5daf3ff81f2326e4c24f48f">RES_CONFIG_SQLITE_CONFIG_VAR_VAL</a>];
<a name="l00868"></a>00868       cfg = <a class="code" href="config_8h.html#a721d5cd60abda2bdd96838336dc09669">ast_config_internal_load</a>(val, args-&gt;<a class="code" href="structcfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a>, args-&gt;<a class="code" href="structcfg__entry__args.html#aec78000b2897c094f68ed72559e18acd">flags</a>, <span class="stringliteral">&quot;&quot;</span>, args-&gt;<a class="code" href="structcfg__entry__args.html#a8b2a59636d4dbe0f5bf74e2fe0422648">who_asked</a>);
<a name="l00869"></a>00869 
<a name="l00870"></a>00870       <span class="keywordflow">if</span> (!cfg) {
<a name="l00871"></a>00871          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to include %s\n&quot;</span>, val);
<a name="l00872"></a>00872          <span class="keywordflow">return</span> 1;
<a name="l00873"></a>00873       } <span class="keywordflow">else</span> {
<a name="l00874"></a>00874          args-&gt;<a class="code" href="structcfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a> = cfg;
<a name="l00875"></a>00875          <span class="keywordflow">return</span> 0;
<a name="l00876"></a>00876       }
<a name="l00877"></a>00877    }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879    <span class="keywordflow">if</span> (!args-&gt;<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a> || strcmp(args-&gt;<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a>, argv[<a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbdae873cc53ea86027d191a69cabe26846e">RES_CONFIG_SQLITE_CONFIG_CATEGORY</a>])) {
<a name="l00880"></a>00880       args-&gt;<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a> = <a class="code" href="config_8h.html#affebac76d69639677b677037d9871e29" title="Create a category structure.">ast_category_new</a>(argv[RES_CONFIG_SQLITE_CONFIG_CATEGORY], <span class="stringliteral">&quot;&quot;</span>, 99999);
<a name="l00881"></a>00881 
<a name="l00882"></a>00882       <span class="keywordflow">if</span> (!args-&gt;<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a>) {
<a name="l00883"></a>00883          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate category\n&quot;</span>);
<a name="l00884"></a>00884          <span class="keywordflow">return</span> 1;
<a name="l00885"></a>00885       }
<a name="l00886"></a>00886 
<a name="l00887"></a>00887       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(args-&gt;<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a>);
<a name="l00888"></a>00888       args-&gt;<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(argv[RES_CONFIG_SQLITE_CONFIG_CATEGORY]);
<a name="l00889"></a>00889 
<a name="l00890"></a>00890       <span class="keywordflow">if</span> (!args-&gt;<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a>) {
<a name="l00891"></a>00891          <a class="code" href="config_8h.html#abd17f201d0e7c31c124dc0cd3a0d073b">ast_category_destroy</a>(args-&gt;<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a>);
<a name="l00892"></a>00892          <span class="keywordflow">return</span> 1;
<a name="l00893"></a>00893       }
<a name="l00894"></a>00894 
<a name="l00895"></a>00895       <a class="code" href="config_8h.html#ab7b56ec66b058952423f313752c734e7">ast_category_append</a>(args-&gt;<a class="code" href="structcfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a>, args-&gt;<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a>);
<a name="l00896"></a>00896    }
<a name="l00897"></a>00897 
<a name="l00898"></a>00898    var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(argv[RES_CONFIG_SQLITE_CONFIG_VAR_NAME], argv[<a class="code" href="res__config__sqlite_8c.html#aa62371d642974c67a0c0efa77d54fcbda7ade715af5daf3ff81f2326e4c24f48f">RES_CONFIG_SQLITE_CONFIG_VAR_VAL</a>], <span class="stringliteral">&quot;&quot;</span>);
<a name="l00899"></a>00899 
<a name="l00900"></a>00900    <span class="keywordflow">if</span> (!var) {
<a name="l00901"></a>00901       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate variable&quot;</span>);
<a name="l00902"></a>00902       <span class="keywordflow">return</span> 1;
<a name="l00903"></a>00903    }
<a name="l00904"></a>00904 
<a name="l00905"></a>00905    <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(args-&gt;<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a>, var);
<a name="l00906"></a>00906 
<a name="l00907"></a>00907    <span class="keywordflow">return</span> 0;
<a name="l00908"></a>00908 }
<a name="l00909"></a>00909 
<a name="l00910"></a><a class="code" href="res__config__sqlite_8c.html#a7c363143661597b8480ef856c1acad80">00910</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="res__config__sqlite_8c.html#a7c363143661597b8480ef856c1acad80" title="Asterisk callback function for static configuration.">config_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *file,
<a name="l00911"></a>00911    <span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags, <span class="keyword">const</span> <span class="keywordtype">char</span> *suggested_incl, <span class="keyword">const</span> <span class="keywordtype">char</span> *who_asked)
<a name="l00912"></a>00912 {
<a name="l00913"></a>00913    <span class="keyword">struct </span><a class="code" href="structcfg__entry__args.html">cfg_entry_args</a> args;
<a name="l00914"></a>00914    <span class="keywordtype">char</span> *query, *errormsg = NULL;
<a name="l00915"></a>00915    <span class="keywordtype">int</span> error;
<a name="l00916"></a>00916 
<a name="l00917"></a>00917    <span class="keywordflow">if</span> (!config_table) {
<a name="l00918"></a>00918       <span class="keywordflow">if</span> (!table) {
<a name="l00919"></a>00919          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l00920"></a>00920          <span class="keywordflow">return</span> NULL;
<a name="l00921"></a>00921       }
<a name="l00922"></a>00922    } <span class="keywordflow">else</span>
<a name="l00923"></a>00923       table = config_table;
<a name="l00924"></a>00924 
<a name="l00925"></a>00925    query = sqlite_mprintf(<a class="code" href="res__config__sqlite_8c.html#a5ca80598759ece103ebaf5cc9aae308a">sql_get_config_table</a>, table, file);
<a name="l00926"></a>00926 
<a name="l00927"></a>00927    <span class="keywordflow">if</span> (!query) {
<a name="l00928"></a>00928       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l00929"></a>00929       <span class="keywordflow">return</span> NULL;
<a name="l00930"></a>00930    }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l00933"></a>00933    args.<a class="code" href="structcfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a> = cfg;
<a name="l00934"></a>00934    args.<a class="code" href="structcfg__entry__args.html#af0777f6e41548d3c2f4b24ce2b3d3180">cat</a> = NULL;
<a name="l00935"></a>00935    args.<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a> = NULL;
<a name="l00936"></a>00936    args.<a class="code" href="structcfg__entry__args.html#aec78000b2897c094f68ed72559e18acd">flags</a> = flags;
<a name="l00937"></a>00937    args.<a class="code" href="structcfg__entry__args.html#a8b2a59636d4dbe0f5bf74e2fe0422648">who_asked</a> = who_asked;
<a name="l00938"></a>00938 
<a name="l00939"></a>00939    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00940"></a>00940 
<a name="l00941"></a>00941    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l00942"></a>00942       error = sqlite_exec(db, query, <a class="code" href="res__config__sqlite_8c.html#ab0550541665aab14df8f089397bba5ae" title="SQLite callback function for static configuration.">add_cfg_entry</a>, &amp;args, &amp;errormsg);
<a name="l00943"></a>00943    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l00944"></a>00944 
<a name="l00945"></a>00945    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l00946"></a>00946 
<a name="l00947"></a>00947    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(args.<a class="code" href="structcfg__entry__args.html#ad6cc2cefc21f66d15111d57909fe53b4">cat_name</a>);
<a name="l00948"></a>00948    sqlite_freemem(query);
<a name="l00949"></a>00949 
<a name="l00950"></a>00950    <span class="keywordflow">if</span> (error) {
<a name="l00951"></a>00951       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l00952"></a>00952       sqlite_freemem(errormsg);
<a name="l00953"></a>00953       <span class="keywordflow">return</span> NULL;
<a name="l00954"></a>00954    }
<a name="l00955"></a>00955    sqlite_freemem(errormsg);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957    <span class="keywordflow">return</span> cfg;
<a name="l00958"></a>00958 }
<a name="l00959"></a>00959 
<a name="l00960"></a><a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430">00960</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(va_list ap, <span class="keyword">const</span> <span class="keywordtype">char</span> ***params_ptr, <span class="keyword">const</span> <span class="keywordtype">char</span> ***vals_ptr, <span class="keywordtype">int</span> warn)
<a name="l00961"></a>00961 {
<a name="l00962"></a>00962    <span class="keyword">const</span> <span class="keywordtype">char</span> **tmp, *param, *<a class="code" href="structval.html">val</a>, **params, **vals;
<a name="l00963"></a>00963    <span class="keywordtype">size_t</span> params_count;
<a name="l00964"></a>00964 
<a name="l00965"></a>00965    params = NULL;
<a name="l00966"></a>00966    vals = NULL;
<a name="l00967"></a>00967    params_count = 0;
<a name="l00968"></a>00968 
<a name="l00969"></a>00969    <span class="keywordflow">while</span> ((param = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *)) &amp;&amp; (val = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l00970"></a>00970       <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(params, (params_count + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l00971"></a>00971          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l00972"></a>00972          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l00973"></a>00973          <span class="keywordflow">return</span> 0;
<a name="l00974"></a>00974       }
<a name="l00975"></a>00975       params = tmp;
<a name="l00976"></a>00976 
<a name="l00977"></a>00977       <span class="keywordflow">if</span> (!(tmp = <a class="code" href="astmm_8h.html#aa852314efa0cfeecee97ffc51b649734">ast_realloc</a>(vals, (params_count + 1) * <span class="keyword">sizeof</span>(<span class="keywordtype">char</span> *)))) {
<a name="l00978"></a>00978          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l00979"></a>00979          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l00980"></a>00980          <span class="keywordflow">return</span> 0;
<a name="l00981"></a>00981       }
<a name="l00982"></a>00982       vals = tmp;
<a name="l00983"></a>00983 
<a name="l00984"></a>00984       params[params_count] = param;
<a name="l00985"></a>00985       vals[params_count] = val;
<a name="l00986"></a>00986       params_count++;
<a name="l00987"></a>00987    }
<a name="l00988"></a>00988 
<a name="l00989"></a>00989    <span class="keywordflow">if</span> (params_count &gt; 0) {
<a name="l00990"></a>00990       *params_ptr = params;
<a name="l00991"></a>00991       *vals_ptr = vals;
<a name="l00992"></a>00992    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (warn) {
<a name="l00993"></a>00993       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;1 parameter and 1 value at least required\n&quot;</span>);
<a name="l00994"></a>00994    }
<a name="l00995"></a>00995 
<a name="l00996"></a>00996    <span class="keywordflow">return</span> params_count;
<a name="l00997"></a>00997 }
<a name="l00998"></a>00998 
<a name="l00999"></a><a class="code" href="res__config__sqlite_8c.html#a1acd2046121f2656b6e35ec0d5650913">00999</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a1acd2046121f2656b6e35ec0d5650913" title="SQLite callback function for RealTime configuration.">add_rt_cfg_entry</a>(<span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, <span class="keywordtype">char</span> **columnNames)
<a name="l01000"></a>01000 {
<a name="l01001"></a>01001    <span class="keyword">struct </span><a class="code" href="structrt__cfg__entry__args.html">rt_cfg_entry_args</a> *args;
<a name="l01002"></a>01002    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l01003"></a>01003    <span class="keywordtype">int</span> i;
<a name="l01004"></a>01004 
<a name="l01005"></a>01005    args = arg;
<a name="l01006"></a>01006 
<a name="l01007"></a>01007    <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l01008"></a>01008       <span class="keywordflow">if</span> (!argv[i])
<a name="l01009"></a>01009          <span class="keywordflow">continue</span>;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011       <span class="keywordflow">if</span> (!(var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(columnNames[i], argv[i], <span class="stringliteral">&quot;&quot;</span>)))
<a name="l01012"></a>01012          <span class="keywordflow">return</span> 1;
<a name="l01013"></a>01013 
<a name="l01014"></a>01014       <span class="keywordflow">if</span> (!args-&gt;<a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">var</a>)
<a name="l01015"></a>01015          args-&gt;<a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">var</a> = var;
<a name="l01016"></a>01016 
<a name="l01017"></a>01017       <span class="keywordflow">if</span> (!args-&gt;<a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">last</a>)
<a name="l01018"></a>01018          args-&gt;<a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">last</a> = var;
<a name="l01019"></a>01019       <span class="keywordflow">else</span> {
<a name="l01020"></a>01020          args-&gt;<a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">last</a>-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a> = var;
<a name="l01021"></a>01021          args-&gt;<a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">last</a> = var;
<a name="l01022"></a>01022       }
<a name="l01023"></a>01023    }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025    <span class="keywordflow">return</span> 0;
<a name="l01026"></a>01026 }
<a name="l01027"></a>01027 
<a name="l01028"></a><a class="code" href="res__config__sqlite_8c.html#a338dc290c800ac25ab8c52e43376e951">01028</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> * <a class="code" href="res__config__sqlite_8c.html#a338dc290c800ac25ab8c52e43376e951" title="Asterisk callback function for RealTime configuration.">realtime_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, va_list ap)
<a name="l01029"></a>01029 {
<a name="l01030"></a>01030    <span class="keywordtype">char</span> *query, *errormsg = NULL, *op, *tmp_str;
<a name="l01031"></a>01031    <span class="keyword">struct </span><a class="code" href="structrt__cfg__entry__args.html">rt_cfg_entry_args</a> args;
<a name="l01032"></a>01032    <span class="keyword">const</span> <span class="keywordtype">char</span> **params, **vals;
<a name="l01033"></a>01033    <span class="keywordtype">size_t</span> params_count;
<a name="l01034"></a>01034    <span class="keywordtype">int</span> error;
<a name="l01035"></a>01035 
<a name="l01036"></a>01036    <span class="keywordflow">if</span> (!table) {
<a name="l01037"></a>01037       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l01038"></a>01038       <span class="keywordflow">return</span> NULL;
<a name="l01039"></a>01039    }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041    params_count = <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(ap, &amp;params, &amp;vals, 1);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043    <span class="keywordflow">if</span> (params_count == 0)
<a name="l01044"></a>01044       <span class="keywordflow">return</span> NULL;
<a name="l01045"></a>01045 
<a name="l01046"></a>01046    op = (strchr(params[0], <span class="charliteral">&apos; &apos;</span>) == NULL) ? <span class="stringliteral">&quot; =&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01047"></a>01047 
<a name="l01048"></a>01048 <span class="comment">/* \cond DOXYGEN_CAN_PARSE_THIS */</span>
<a name="l01049"></a>01049 <span class="preprocessor">#undef QUERY</span>
<a name="l01050"></a>01050 <span class="preprocessor"></span><span class="preprocessor">#define QUERY &quot;SELECT * FROM &apos;%q&apos; WHERE%s %q%s &apos;%q&apos;&quot;</span>
<a name="l01051"></a>01051 <span class="preprocessor"></span><span class="comment">/* \endcond */</span>
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    query = sqlite_mprintf(QUERY, table, !strcmp(config_table, table) ? <span class="stringliteral">&quot; commented = 0 AND&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, params[0], op, vals[0]);
<a name="l01054"></a>01054 
<a name="l01055"></a>01055    <span class="keywordflow">if</span> (!query) {
<a name="l01056"></a>01056       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l01057"></a>01057       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01058"></a>01058       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01059"></a>01059       <span class="keywordflow">return</span> NULL;
<a name="l01060"></a>01060    }
<a name="l01061"></a>01061 
<a name="l01062"></a>01062    <span class="keywordflow">if</span> (params_count &gt; 1) {
<a name="l01063"></a>01063       <span class="keywordtype">size_t</span> i;
<a name="l01064"></a>01064 
<a name="l01065"></a>01065       <span class="keywordflow">for</span> (i = 1; i &lt; params_count; i++) {
<a name="l01066"></a>01066          op = (strchr(params[i], <span class="charliteral">&apos; &apos;</span>) == NULL) ? <span class="stringliteral">&quot; =&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01067"></a>01067          tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s AND %q%s &apos;%q&apos;&quot;</span>, query, params[i], op, vals[i]);
<a name="l01068"></a>01068          sqlite_freemem(query);
<a name="l01069"></a>01069 
<a name="l01070"></a>01070          <span class="keywordflow">if</span> (!tmp_str) {
<a name="l01071"></a>01071             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01072"></a>01072             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01073"></a>01073             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01074"></a>01074             <span class="keywordflow">return</span> NULL;
<a name="l01075"></a>01075          }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077          query = tmp_str;
<a name="l01078"></a>01078       }
<a name="l01079"></a>01079    }
<a name="l01080"></a>01080 
<a name="l01081"></a>01081    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01082"></a>01082    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01083"></a>01083 
<a name="l01084"></a>01084    tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s LIMIT 1;&quot;</span>, query);
<a name="l01085"></a>01085    sqlite_freemem(query);
<a name="l01086"></a>01086 
<a name="l01087"></a>01087    <span class="keywordflow">if</span> (!tmp_str) {
<a name="l01088"></a>01088       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01089"></a>01089       <span class="keywordflow">return</span> NULL;
<a name="l01090"></a>01090    }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092    query = tmp_str;
<a name="l01093"></a>01093    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l01094"></a>01094    args.<a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">var</a> = NULL;
<a name="l01095"></a>01095    args.<a class="code" href="structrt__cfg__entry__args.html#ac6bc41916ca996a56407db9d13e2e734">last</a> = NULL;
<a name="l01096"></a>01096 
<a name="l01097"></a>01097    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01098"></a>01098 
<a name="l01099"></a>01099    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01100"></a>01100       error = sqlite_exec(db, query, <a class="code" href="res__config__sqlite_8c.html#a1acd2046121f2656b6e35ec0d5650913" title="SQLite callback function for RealTime configuration.">add_rt_cfg_entry</a>, &amp;args, &amp;errormsg);
<a name="l01101"></a>01101    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01102"></a>01102 
<a name="l01103"></a>01103    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    sqlite_freemem(query);
<a name="l01106"></a>01106 
<a name="l01107"></a>01107    <span class="keywordflow">if</span> (error) {
<a name="l01108"></a>01108       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01109"></a>01109       sqlite_freemem(errormsg);
<a name="l01110"></a>01110       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(args.<a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">var</a>);
<a name="l01111"></a>01111       <span class="keywordflow">return</span> NULL;
<a name="l01112"></a>01112    }
<a name="l01113"></a>01113    sqlite_freemem(errormsg);
<a name="l01114"></a>01114 
<a name="l01115"></a>01115    <span class="keywordflow">return</span> args.<a class="code" href="structrt__cfg__entry__args.html#abdd578cbdfc77b2ee01a545c8e2bffc8">var</a>;
<a name="l01116"></a>01116 }
<a name="l01117"></a>01117 
<a name="l01118"></a><a class="code" href="res__config__sqlite_8c.html#a17b5ad55ba185061850f5d682c397a98">01118</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a17b5ad55ba185061850f5d682c397a98" title="SQLite callback function for RealTime configuration.">add_rt_multi_cfg_entry</a>(<span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> argc, <span class="keywordtype">char</span> **argv, <span class="keywordtype">char</span> **columnNames)
<a name="l01119"></a>01119 {
<a name="l01120"></a>01120    <span class="keyword">struct </span><a class="code" href="structrt__multi__cfg__entry__args.html">rt_multi_cfg_entry_args</a> *args;
<a name="l01121"></a>01121    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cat;
<a name="l01122"></a>01122    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l01123"></a>01123    <span class="keywordtype">char</span> *cat_name;
<a name="l01124"></a>01124    <span class="keywordtype">size_t</span> i;
<a name="l01125"></a>01125 
<a name="l01126"></a>01126    args = arg;
<a name="l01127"></a>01127    cat_name = NULL;
<a name="l01128"></a>01128 
<a name="l01129"></a>01129    <span class="comment">/*</span>
<a name="l01130"></a>01130 <span class="comment">    * cat_name should always be set here, since initfield is forged from</span>
<a name="l01131"></a>01131 <span class="comment">    * params[0] in realtime_multi_handler(), which is a search parameter</span>
<a name="l01132"></a>01132 <span class="comment">    * of the SQL query.</span>
<a name="l01133"></a>01133 <span class="comment">    */</span>
<a name="l01134"></a>01134    <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l01135"></a>01135       <span class="keywordflow">if</span> (!strcmp(args-&gt;<a class="code" href="structrt__multi__cfg__entry__args.html#a9d097a0647a837d2fab0d6355278480a">initfield</a>, columnNames[i]))
<a name="l01136"></a>01136          cat_name = argv[i];
<a name="l01137"></a>01137    }
<a name="l01138"></a>01138 
<a name="l01139"></a>01139    <span class="keywordflow">if</span> (!cat_name) {
<a name="l01140"></a>01140       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Bogus SQL results, cat_name is NULL !\n&quot;</span>);
<a name="l01141"></a>01141       <span class="keywordflow">return</span> 1;
<a name="l01142"></a>01142    }
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8h.html#affebac76d69639677b677037d9871e29" title="Create a category structure.">ast_category_new</a>(cat_name, <span class="stringliteral">&quot;&quot;</span>, 99999))) {
<a name="l01145"></a>01145       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate category\n&quot;</span>);
<a name="l01146"></a>01146       <span class="keywordflow">return</span> 1;
<a name="l01147"></a>01147    }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    <a class="code" href="config_8h.html#ab7b56ec66b058952423f313752c734e7">ast_category_append</a>(args-&gt;<a class="code" href="structrt__multi__cfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a>, cat);
<a name="l01150"></a>01150 
<a name="l01151"></a>01151    <span class="keywordflow">for</span> (i = 0; i &lt; argc; i++) {
<a name="l01152"></a>01152       <span class="keywordflow">if</span> (!argv[i] || !strcmp(args-&gt;<a class="code" href="structrt__multi__cfg__entry__args.html#a9d097a0647a837d2fab0d6355278480a">initfield</a>, columnNames[i]))
<a name="l01153"></a>01153          <span class="keywordflow">continue</span>;
<a name="l01154"></a>01154 
<a name="l01155"></a>01155       <span class="keywordflow">if</span> (!(var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(columnNames[i], argv[i], <span class="stringliteral">&quot;&quot;</span>))) {
<a name="l01156"></a>01156          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate variable\n&quot;</span>);
<a name="l01157"></a>01157          <span class="keywordflow">return</span> 1;
<a name="l01158"></a>01158       }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160       <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(cat, var);
<a name="l01161"></a>01161    }
<a name="l01162"></a>01162 
<a name="l01163"></a>01163    <span class="keywordflow">return</span> 0;
<a name="l01164"></a>01164 }
<a name="l01165"></a>01165 
<a name="l01166"></a><a class="code" href="res__config__sqlite_8c.html#ac1fb5f8486409dcf9931a7e616fd55cd">01166</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="res__config__sqlite_8c.html#ac1fb5f8486409dcf9931a7e616fd55cd" title="Asterisk callback function for RealTime configuration.">realtime_multi_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database,
<a name="l01167"></a>01167    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, va_list ap)
<a name="l01168"></a>01168 {
<a name="l01169"></a>01169    <span class="keywordtype">char</span> *query, *errormsg = NULL, *op, *tmp_str, *initfield;
<a name="l01170"></a>01170    <span class="keyword">struct </span><a class="code" href="structrt__multi__cfg__entry__args.html">rt_multi_cfg_entry_args</a> args;
<a name="l01171"></a>01171    <span class="keyword">const</span> <span class="keywordtype">char</span> **params, **vals;
<a name="l01172"></a>01172    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l01173"></a>01173    <span class="keywordtype">size_t</span> params_count;
<a name="l01174"></a>01174    <span class="keywordtype">int</span> error;
<a name="l01175"></a>01175 
<a name="l01176"></a>01176    <span class="keywordflow">if</span> (!table) {
<a name="l01177"></a>01177       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l01178"></a>01178       <span class="keywordflow">return</span> NULL;
<a name="l01179"></a>01179    }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a45e1a284d7d84c4b4a316764fbb887fb" title="Create a new base configuration structure.">ast_config_new</a>())) {
<a name="l01182"></a>01182       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate configuration structure\n&quot;</span>);
<a name="l01183"></a>01183       <span class="keywordflow">return</span> NULL;
<a name="l01184"></a>01184    }
<a name="l01185"></a>01185 
<a name="l01186"></a>01186    <span class="keywordflow">if</span> (!(params_count = <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(ap, &amp;params, &amp;vals, 1))) {
<a name="l01187"></a>01187       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01188"></a>01188       <span class="keywordflow">return</span> NULL;
<a name="l01189"></a>01189    }
<a name="l01190"></a>01190 
<a name="l01191"></a>01191    <span class="keywordflow">if</span> (!(initfield = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(params[0]))) {
<a name="l01192"></a>01192       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01193"></a>01193       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01194"></a>01194       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01195"></a>01195       <span class="keywordflow">return</span> NULL;
<a name="l01196"></a>01196    }
<a name="l01197"></a>01197 
<a name="l01198"></a>01198    tmp_str = strchr(initfield, <span class="charliteral">&apos; &apos;</span>);
<a name="l01199"></a>01199 
<a name="l01200"></a>01200    <span class="keywordflow">if</span> (tmp_str)
<a name="l01201"></a>01201       *tmp_str = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01202"></a>01202 
<a name="l01203"></a>01203    op = (!strchr(params[0], <span class="charliteral">&apos; &apos;</span>)) ? <span class="stringliteral">&quot; =&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01204"></a>01204 
<a name="l01205"></a>01205    <span class="comment">/*</span>
<a name="l01206"></a>01206 <span class="comment">    * Asterisk sends us an already escaped string when searching for</span>
<a name="l01207"></a>01207 <span class="comment">    * &quot;exten LIKE&quot; (uh!). Handle it separately.</span>
<a name="l01208"></a>01208 <span class="comment">    */</span>
<a name="l01209"></a>01209    tmp_str = (!strcmp(vals[0], <span class="stringliteral">&quot;\\_%&quot;</span>)) ? <span class="stringliteral">&quot;_%&quot;</span> : (<span class="keywordtype">char</span> *)vals[0];
<a name="l01210"></a>01210 
<a name="l01211"></a>01211 <span class="comment">/* \cond DOXYGEN_CAN_PARSE_THIS */</span>
<a name="l01212"></a>01212 <span class="preprocessor">#undef QUERY</span>
<a name="l01213"></a>01213 <span class="preprocessor"></span><span class="preprocessor">#define QUERY &quot;SELECT * FROM &apos;%q&apos; WHERE commented = 0 AND %q%s &apos;%q&apos;&quot;</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span><span class="comment">/* \endcond */</span>
<a name="l01215"></a>01215 
<a name="l01216"></a>01216    <span class="keywordflow">if</span> (!(query = sqlite_mprintf(QUERY, table, params[0], op, tmp_str))) {
<a name="l01217"></a>01217       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l01218"></a>01218       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01219"></a>01219       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01220"></a>01220       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01221"></a>01221       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(initfield);
<a name="l01222"></a>01222       <span class="keywordflow">return</span> NULL;
<a name="l01223"></a>01223    }
<a name="l01224"></a>01224 
<a name="l01225"></a>01225    <span class="keywordflow">if</span> (params_count &gt; 1) {
<a name="l01226"></a>01226       <span class="keywordtype">size_t</span> i;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228       <span class="keywordflow">for</span> (i = 1; i &lt; params_count; i++) {
<a name="l01229"></a>01229          op = (!strchr(params[i], <span class="charliteral">&apos; &apos;</span>)) ? <span class="stringliteral">&quot; =&quot;</span> : <span class="stringliteral">&quot;&quot;</span>;
<a name="l01230"></a>01230          tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s AND %q%s &apos;%q&apos;&quot;</span>, query, params[i], op, vals[i]);
<a name="l01231"></a>01231          sqlite_freemem(query);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233          <span class="keywordflow">if</span> (!tmp_str) {
<a name="l01234"></a>01234             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01235"></a>01235             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01236"></a>01236             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01237"></a>01237             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01238"></a>01238             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(initfield);
<a name="l01239"></a>01239             <span class="keywordflow">return</span> NULL;
<a name="l01240"></a>01240          }
<a name="l01241"></a>01241 
<a name="l01242"></a>01242          query = tmp_str;
<a name="l01243"></a>01243       }
<a name="l01244"></a>01244    }
<a name="l01245"></a>01245 
<a name="l01246"></a>01246    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01247"></a>01247    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01248"></a>01248 
<a name="l01249"></a>01249    <span class="keywordflow">if</span> (!(tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s ORDER BY %q;&quot;</span>, query, initfield))) {
<a name="l01250"></a>01250       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01251"></a>01251       sqlite_freemem(query);
<a name="l01252"></a>01252       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01253"></a>01253       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(initfield);
<a name="l01254"></a>01254       <span class="keywordflow">return</span> NULL;
<a name="l01255"></a>01255    }
<a name="l01256"></a>01256 
<a name="l01257"></a>01257    sqlite_freemem(query);
<a name="l01258"></a>01258    query = tmp_str;
<a name="l01259"></a>01259    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l01260"></a>01260    args.<a class="code" href="structrt__multi__cfg__entry__args.html#a282e93e50b0029b0e52977a85b96aab7">cfg</a> = cfg;
<a name="l01261"></a>01261    args.<a class="code" href="structrt__multi__cfg__entry__args.html#a9d097a0647a837d2fab0d6355278480a">initfield</a> = initfield;
<a name="l01262"></a>01262 
<a name="l01263"></a>01263    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01264"></a>01264 
<a name="l01265"></a>01265    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01266"></a>01266       error = sqlite_exec(db, query, <a class="code" href="res__config__sqlite_8c.html#a17b5ad55ba185061850f5d682c397a98" title="SQLite callback function for RealTime configuration.">add_rt_multi_cfg_entry</a>, &amp;args, &amp;errormsg);
<a name="l01267"></a>01267    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01268"></a>01268 
<a name="l01269"></a>01269    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01270"></a>01270 
<a name="l01271"></a>01271    sqlite_freemem(query);
<a name="l01272"></a>01272    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(initfield);
<a name="l01273"></a>01273 
<a name="l01274"></a>01274    <span class="keywordflow">if</span> (error) {
<a name="l01275"></a>01275       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01276"></a>01276       sqlite_freemem(errormsg);
<a name="l01277"></a>01277       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l01278"></a>01278       <span class="keywordflow">return</span> NULL;
<a name="l01279"></a>01279    }
<a name="l01280"></a>01280    sqlite_freemem(errormsg);
<a name="l01281"></a>01281 
<a name="l01282"></a>01282    <span class="keywordflow">return</span> cfg;
<a name="l01283"></a>01283 }
<a name="l01284"></a>01284 
<a name="l01285"></a><a class="code" href="res__config__sqlite_8c.html#a6da1e7dac50ebd5c89cd6320d17bc083">01285</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a6da1e7dac50ebd5c89cd6320d17bc083" title="Asterisk callback function for RealTime configuration (variable update).">realtime_update_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l01286"></a>01286    <span class="keyword">const</span> <span class="keywordtype">char</span> *keyfield, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#ad4e4601988acb4a95ecd1ec380359ae5">entity</a>, va_list ap)
<a name="l01287"></a>01287 {
<a name="l01288"></a>01288    <span class="keywordtype">char</span> *query, *errormsg = NULL, *tmp_str;
<a name="l01289"></a>01289    <span class="keyword">const</span> <span class="keywordtype">char</span> **params, **vals;
<a name="l01290"></a>01290    <span class="keywordtype">size_t</span> params_count;
<a name="l01291"></a>01291    <span class="keywordtype">int</span> error, rows_num;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293    <span class="keywordflow">if</span> (!table) {
<a name="l01294"></a>01294       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l01295"></a>01295       <span class="keywordflow">return</span> -1;
<a name="l01296"></a>01296    }
<a name="l01297"></a>01297 
<a name="l01298"></a>01298    <span class="keywordflow">if</span> (!(params_count = <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(ap, &amp;params, &amp;vals, 1)))
<a name="l01299"></a>01299       <span class="keywordflow">return</span> -1;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301 <span class="comment">/* \cond DOXYGEN_CAN_PARSE_THIS */</span>
<a name="l01302"></a>01302 <span class="preprocessor">#undef QUERY</span>
<a name="l01303"></a>01303 <span class="preprocessor"></span><span class="preprocessor">#define QUERY &quot;UPDATE &apos;%q&apos; SET %q = &apos;%q&apos;&quot;</span>
<a name="l01304"></a>01304 <span class="preprocessor"></span><span class="comment">/* \endcond */</span>
<a name="l01305"></a>01305 
<a name="l01306"></a>01306    <span class="keywordflow">if</span> (!(query = sqlite_mprintf(QUERY, table, params[0], vals[0]))) {
<a name="l01307"></a>01307       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l01308"></a>01308       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01309"></a>01309       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01310"></a>01310       <span class="keywordflow">return</span> -1;
<a name="l01311"></a>01311    }
<a name="l01312"></a>01312 
<a name="l01313"></a>01313    <span class="keywordflow">if</span> (params_count &gt; 1) {
<a name="l01314"></a>01314       <span class="keywordtype">size_t</span> i;
<a name="l01315"></a>01315 
<a name="l01316"></a>01316       <span class="keywordflow">for</span> (i = 1; i &lt; params_count; i++) {
<a name="l01317"></a>01317          tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s, %q = &apos;%q&apos;&quot;</span>, query, params[i], vals[i]);
<a name="l01318"></a>01318          sqlite_freemem(query);
<a name="l01319"></a>01319 
<a name="l01320"></a>01320          <span class="keywordflow">if</span> (!tmp_str) {
<a name="l01321"></a>01321             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01322"></a>01322             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01323"></a>01323             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01324"></a>01324             <span class="keywordflow">return</span> -1;
<a name="l01325"></a>01325          }
<a name="l01326"></a>01326 
<a name="l01327"></a>01327          query = tmp_str;
<a name="l01328"></a>01328       }
<a name="l01329"></a>01329    }
<a name="l01330"></a>01330 
<a name="l01331"></a>01331    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01332"></a>01332    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01333"></a>01333 
<a name="l01334"></a>01334    <span class="keywordflow">if</span> (!(tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s WHERE %q = &apos;%q&apos;;&quot;</span>, query, keyfield, entity))) {
<a name="l01335"></a>01335       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01336"></a>01336       sqlite_freemem(query);
<a name="l01337"></a>01337       <span class="keywordflow">return</span> -1;
<a name="l01338"></a>01338    }
<a name="l01339"></a>01339 
<a name="l01340"></a>01340    sqlite_freemem(query);
<a name="l01341"></a>01341    query = tmp_str;
<a name="l01342"></a>01342    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l01343"></a>01343 
<a name="l01344"></a>01344    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01345"></a>01345 
<a name="l01346"></a>01346    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01347"></a>01347       error = sqlite_exec(db, query, NULL, NULL, &amp;errormsg);
<a name="l01348"></a>01348    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01349"></a>01349 
<a name="l01350"></a>01350    <span class="keywordflow">if</span> (!error)
<a name="l01351"></a>01351       rows_num = sqlite_changes(db);
<a name="l01352"></a>01352    <span class="keywordflow">else</span>
<a name="l01353"></a>01353       rows_num = -1;
<a name="l01354"></a>01354 
<a name="l01355"></a>01355    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01356"></a>01356 
<a name="l01357"></a>01357    sqlite_freemem(query);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    <span class="keywordflow">if</span> (error) {
<a name="l01360"></a>01360       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01361"></a>01361    }
<a name="l01362"></a>01362    sqlite_freemem(errormsg);
<a name="l01363"></a>01363 
<a name="l01364"></a>01364    <span class="keywordflow">return</span> rows_num;
<a name="l01365"></a>01365 }
<a name="l01366"></a>01366 
<a name="l01367"></a><a class="code" href="res__config__sqlite_8c.html#a2ef5eb1d975679c1199dc6f00f87d03b">01367</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a2ef5eb1d975679c1199dc6f00f87d03b">realtime_update2_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l01368"></a>01368    va_list ap)
<a name="l01369"></a>01369 {
<a name="l01370"></a>01370    <span class="keywordtype">char</span> *errormsg = NULL, *tmp1, *tmp2;
<a name="l01371"></a>01371    <span class="keywordtype">int</span> error, rows_num, <a class="code" href="devicestate_8c.html#abd2135e6f8a41bc900933b1985d97165">first</a> = 1;
<a name="l01372"></a>01372    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *sql = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#afc4bfa5a94710e6f323a1033f82425b3">sql_buf</a>, 100);
<a name="l01373"></a>01373    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *where = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a2b636f309367e4fa49ffb2c0a55e5bdd">where_buf</a>, 100);
<a name="l01374"></a>01374    <span class="keyword">const</span> <span class="keywordtype">char</span> *param, *value;
<a name="l01375"></a>01375 
<a name="l01376"></a>01376    <span class="keywordflow">if</span> (!table) {
<a name="l01377"></a>01377       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l01378"></a>01378       <span class="keywordflow">return</span> -1;
<a name="l01379"></a>01379    }
<a name="l01380"></a>01380 
<a name="l01381"></a>01381    <span class="keywordflow">if</span> (!sql) {
<a name="l01382"></a>01382       <span class="keywordflow">return</span> -1;
<a name="l01383"></a>01383    }
<a name="l01384"></a>01384 
<a name="l01385"></a>01385    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;sql, 0, <span class="stringliteral">&quot;UPDATE %s SET&quot;</span>, table);
<a name="l01386"></a>01386    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;where, 0, <span class="stringliteral">&quot; WHERE&quot;</span>);
<a name="l01387"></a>01387 
<a name="l01388"></a>01388    <span class="keywordflow">while</span> ((param = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l01389"></a>01389       value = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l01390"></a>01390       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;where, 0, <span class="stringliteral">&quot;%s %s = %s&quot;</span>,
<a name="l01391"></a>01391          first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; AND&quot;</span>,
<a name="l01392"></a>01392          tmp1 = sqlite_mprintf(<span class="stringliteral">&quot;%q&quot;</span>, param),
<a name="l01393"></a>01393          tmp2 = sqlite_mprintf(<span class="stringliteral">&quot;%Q&quot;</span>, value));
<a name="l01394"></a>01394       sqlite_freemem(tmp1);
<a name="l01395"></a>01395       sqlite_freemem(tmp2);
<a name="l01396"></a>01396       first = 0;
<a name="l01397"></a>01397    }
<a name="l01398"></a>01398 
<a name="l01399"></a>01399    <span class="keywordflow">if</span> (first) {
<a name="l01400"></a>01400       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No criteria specified on update to &apos;%s@%s&apos;!\n&quot;</span>, table, database);
<a name="l01401"></a>01401       <span class="keywordflow">return</span> -1;
<a name="l01402"></a>01402    }
<a name="l01403"></a>01403 
<a name="l01404"></a>01404    first = 1;
<a name="l01405"></a>01405    <span class="keywordflow">while</span> ((param = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *))) {
<a name="l01406"></a>01406       value = va_arg(ap, <span class="keyword">const</span> <span class="keywordtype">char</span> *);
<a name="l01407"></a>01407       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot;%s %s = %s&quot;</span>,
<a name="l01408"></a>01408          first ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;,&quot;</span>,
<a name="l01409"></a>01409          tmp1 = sqlite_mprintf(<span class="stringliteral">&quot;%q&quot;</span>, param),
<a name="l01410"></a>01410          tmp2 = sqlite_mprintf(<span class="stringliteral">&quot;%Q&quot;</span>, value));
<a name="l01411"></a>01411       sqlite_freemem(tmp1);
<a name="l01412"></a>01412       sqlite_freemem(tmp2);
<a name="l01413"></a>01413       first = 0;
<a name="l01414"></a>01414    }
<a name="l01415"></a>01415 
<a name="l01416"></a>01416    <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;sql, 0, <span class="stringliteral">&quot; %s&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(where));
<a name="l01417"></a>01417    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql));
<a name="l01418"></a>01418 
<a name="l01419"></a>01419    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01420"></a>01420 
<a name="l01421"></a>01421    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01422"></a>01422       error = sqlite_exec(db, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(sql), NULL, NULL, &amp;errormsg);
<a name="l01423"></a>01423    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01424"></a>01424 
<a name="l01425"></a>01425    <span class="keywordflow">if</span> (!error) {
<a name="l01426"></a>01426       rows_num = sqlite_changes(db);
<a name="l01427"></a>01427    } <span class="keywordflow">else</span> {
<a name="l01428"></a>01428       rows_num = -1;
<a name="l01429"></a>01429    }
<a name="l01430"></a>01430 
<a name="l01431"></a>01431    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01432"></a>01432 
<a name="l01433"></a>01433    <span class="keywordflow">if</span> (error) {
<a name="l01434"></a>01434       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01435"></a>01435    }
<a name="l01436"></a>01436    sqlite_freemem(errormsg);
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <span class="keywordflow">return</span> rows_num;
<a name="l01439"></a>01439 }
<a name="l01440"></a>01440 
<a name="l01441"></a><a class="code" href="res__config__sqlite_8c.html#a75c583659a1549848c8c40bf5a3efff1">01441</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a75c583659a1549848c8c40bf5a3efff1" title="Asterisk callback function for RealTime configuration (variable create/store).">realtime_store_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>, va_list ap)
<a name="l01442"></a>01442 {
<a name="l01443"></a>01443    <span class="keywordtype">char</span> *errormsg = NULL, *tmp_str, *tmp_keys = NULL, *tmp_keys2 = NULL, *tmp_vals = NULL, *tmp_vals2 = NULL;
<a name="l01444"></a>01444    <span class="keyword">const</span> <span class="keywordtype">char</span> **params, **vals;
<a name="l01445"></a>01445    <span class="keywordtype">size_t</span> params_count;
<a name="l01446"></a>01446    <span class="keywordtype">int</span> error, rows_id;
<a name="l01447"></a>01447    <span class="keywordtype">size_t</span> i;
<a name="l01448"></a>01448 
<a name="l01449"></a>01449    <span class="keywordflow">if</span> (!table) {
<a name="l01450"></a>01450       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l01451"></a>01451       <span class="keywordflow">return</span> -1;
<a name="l01452"></a>01452    }
<a name="l01453"></a>01453 
<a name="l01454"></a>01454    <span class="keywordflow">if</span> (!(params_count = <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(ap, &amp;params, &amp;vals, 1)))
<a name="l01455"></a>01455       <span class="keywordflow">return</span> -1;
<a name="l01456"></a>01456 
<a name="l01457"></a>01457 <span class="comment">/* \cond DOXYGEN_CAN_PARSE_THIS */</span>
<a name="l01458"></a>01458 <span class="preprocessor">#undef QUERY</span>
<a name="l01459"></a>01459 <span class="preprocessor"></span><span class="preprocessor">#define QUERY &quot;INSERT into &apos;%q&apos; (%s) VALUES (%s);&quot;</span>
<a name="l01460"></a>01460 <span class="preprocessor"></span><span class="comment">/* \endcond */</span>
<a name="l01461"></a>01461 
<a name="l01462"></a>01462    <span class="keywordflow">for</span> (i = 0; i &lt; params_count; i++) {
<a name="l01463"></a>01463       <span class="keywordflow">if</span> ( tmp_keys2 ) {
<a name="l01464"></a>01464          tmp_keys = sqlite_mprintf(<span class="stringliteral">&quot;%s, %q&quot;</span>, tmp_keys2, params[i]);
<a name="l01465"></a>01465          sqlite_freemem(tmp_keys2);
<a name="l01466"></a>01466       } <span class="keywordflow">else</span> {
<a name="l01467"></a>01467          tmp_keys = sqlite_mprintf(<span class="stringliteral">&quot;%q&quot;</span>, params[i]);
<a name="l01468"></a>01468       }
<a name="l01469"></a>01469       <span class="keywordflow">if</span> (!tmp_keys) {
<a name="l01470"></a>01470          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01471"></a>01471          sqlite_freemem(tmp_vals);
<a name="l01472"></a>01472          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01473"></a>01473          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01474"></a>01474          <span class="keywordflow">return</span> -1;
<a name="l01475"></a>01475       }
<a name="l01476"></a>01476 
<a name="l01477"></a>01477       <span class="keywordflow">if</span> ( tmp_vals2 ) {
<a name="l01478"></a>01478          tmp_vals = sqlite_mprintf(<span class="stringliteral">&quot;%s, &apos;%q&apos;&quot;</span>, tmp_vals2, vals[i]);
<a name="l01479"></a>01479          sqlite_freemem(tmp_vals2);
<a name="l01480"></a>01480       } <span class="keywordflow">else</span> {
<a name="l01481"></a>01481          tmp_vals = sqlite_mprintf(<span class="stringliteral">&quot;&apos;%q&apos;&quot;</span>, vals[i]);
<a name="l01482"></a>01482       }
<a name="l01483"></a>01483       <span class="keywordflow">if</span> (!tmp_vals) {
<a name="l01484"></a>01484          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01485"></a>01485          sqlite_freemem(tmp_keys);
<a name="l01486"></a>01486          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01487"></a>01487          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01488"></a>01488          <span class="keywordflow">return</span> -1;
<a name="l01489"></a>01489       }
<a name="l01490"></a>01490 
<a name="l01491"></a>01491 
<a name="l01492"></a>01492       tmp_keys2 = tmp_keys;
<a name="l01493"></a>01493       tmp_vals2 = tmp_vals;
<a name="l01494"></a>01494    }
<a name="l01495"></a>01495 
<a name="l01496"></a>01496    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01497"></a>01497    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01498"></a>01498 
<a name="l01499"></a>01499    <span class="keywordflow">if</span> (!(tmp_str = sqlite_mprintf(QUERY, table, tmp_keys, tmp_vals))) {
<a name="l01500"></a>01500       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01501"></a>01501       sqlite_freemem(tmp_keys);
<a name="l01502"></a>01502       sqlite_freemem(tmp_vals);
<a name="l01503"></a>01503       <span class="keywordflow">return</span> -1;
<a name="l01504"></a>01504    }
<a name="l01505"></a>01505 
<a name="l01506"></a>01506    sqlite_freemem(tmp_keys);
<a name="l01507"></a>01507    sqlite_freemem(tmp_vals);
<a name="l01508"></a>01508 
<a name="l01509"></a>01509    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, tmp_str);
<a name="l01510"></a>01510 
<a name="l01511"></a>01511    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01512"></a>01512 
<a name="l01513"></a>01513    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01514"></a>01514       error = sqlite_exec(db, tmp_str, NULL, NULL, &amp;errormsg);
<a name="l01515"></a>01515    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01516"></a>01516 
<a name="l01517"></a>01517    <span class="keywordflow">if</span> (!error) {
<a name="l01518"></a>01518       rows_id = sqlite_last_insert_rowid(db);
<a name="l01519"></a>01519    } <span class="keywordflow">else</span> {
<a name="l01520"></a>01520       rows_id = -1;
<a name="l01521"></a>01521    }
<a name="l01522"></a>01522 
<a name="l01523"></a>01523    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01524"></a>01524 
<a name="l01525"></a>01525    sqlite_freemem(tmp_str);
<a name="l01526"></a>01526 
<a name="l01527"></a>01527    <span class="keywordflow">if</span> (error) {
<a name="l01528"></a>01528       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01529"></a>01529    }
<a name="l01530"></a>01530    sqlite_freemem(errormsg);
<a name="l01531"></a>01531 
<a name="l01532"></a>01532    <span class="keywordflow">return</span> rows_id;
<a name="l01533"></a>01533 }
<a name="l01534"></a>01534 
<a name="l01535"></a><a class="code" href="res__config__sqlite_8c.html#aabedc36062e3aa13370311d070d1f2eb">01535</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#aabedc36062e3aa13370311d070d1f2eb" title="Asterisk callback function for RealTime configuration (destroys variable).">realtime_destroy_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *database, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__odbc_8c.html#a68d1e6e752f2cf81551fac543cae108a">table</a>,
<a name="l01536"></a>01536    <span class="keyword">const</span> <span class="keywordtype">char</span> *keyfield, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="isdn__lib_8c.html#ad4e4601988acb4a95ecd1ec380359ae5">entity</a>, va_list ap)
<a name="l01537"></a>01537 {
<a name="l01538"></a>01538    <span class="keywordtype">char</span> *query, *errormsg = NULL, *tmp_str;
<a name="l01539"></a>01539    <span class="keyword">const</span> <span class="keywordtype">char</span> **params = NULL, **vals = NULL;
<a name="l01540"></a>01540    <span class="keywordtype">size_t</span> params_count;
<a name="l01541"></a>01541    <span class="keywordtype">int</span> error, rows_num;
<a name="l01542"></a>01542    <span class="keywordtype">size_t</span> i;
<a name="l01543"></a>01543 
<a name="l01544"></a>01544    <span class="keywordflow">if</span> (!table) {
<a name="l01545"></a>01545       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Table name unspecified\n&quot;</span>);
<a name="l01546"></a>01546       <span class="keywordflow">return</span> -1;
<a name="l01547"></a>01547    }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549    params_count = <a class="code" href="res__config__sqlite_8c.html#a9ec040d27f77844f1c24689cf7e33430" title="Helper function to parse a va_list object into 2 dynamic arrays of strings, parameters...">get_params</a>(ap, &amp;params, &amp;vals, 0);
<a name="l01550"></a>01550 
<a name="l01551"></a>01551 <span class="comment">/* \cond DOXYGEN_CAN_PARSE_THIS */</span>
<a name="l01552"></a>01552 <span class="preprocessor">#undef QUERY</span>
<a name="l01553"></a>01553 <span class="preprocessor"></span><span class="preprocessor">#define QUERY &quot;DELETE FROM &apos;%q&apos; WHERE&quot;</span>
<a name="l01554"></a>01554 <span class="preprocessor"></span><span class="comment">/* \endcond */</span>
<a name="l01555"></a>01555 
<a name="l01556"></a>01556    <span class="keywordflow">if</span> (!(query = sqlite_mprintf(QUERY, table))) {
<a name="l01557"></a>01557       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l01558"></a>01558       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01559"></a>01559       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01560"></a>01560       <span class="keywordflow">return</span> -1;
<a name="l01561"></a>01561    }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563    <span class="keywordflow">for</span> (i = 0; i &lt; params_count; i++) {
<a name="l01564"></a>01564       tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s %q = &apos;%q&apos; AND&quot;</span>, query, params[i], vals[i]);
<a name="l01565"></a>01565       sqlite_freemem(query);
<a name="l01566"></a>01566 
<a name="l01567"></a>01567       <span class="keywordflow">if</span> (!tmp_str) {
<a name="l01568"></a>01568          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01569"></a>01569          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01570"></a>01570          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01571"></a>01571          <span class="keywordflow">return</span> -1;
<a name="l01572"></a>01572       }
<a name="l01573"></a>01573 
<a name="l01574"></a>01574       query = tmp_str;
<a name="l01575"></a>01575    }
<a name="l01576"></a>01576 
<a name="l01577"></a>01577    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(params);
<a name="l01578"></a>01578    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vals);
<a name="l01579"></a>01579    <span class="keywordflow">if</span> (!(tmp_str = sqlite_mprintf(<span class="stringliteral">&quot;%s %q = &apos;%q&apos;;&quot;</span>, query, keyfield, entity))) {
<a name="l01580"></a>01580       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to reallocate SQL query\n&quot;</span>);
<a name="l01581"></a>01581       sqlite_freemem(query);
<a name="l01582"></a>01582       <span class="keywordflow">return</span> -1;
<a name="l01583"></a>01583    }
<a name="l01584"></a>01584    sqlite_freemem(query);
<a name="l01585"></a>01585    query = tmp_str;
<a name="l01586"></a>01586    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l01587"></a>01587 
<a name="l01588"></a>01588    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01589"></a>01589 
<a name="l01590"></a>01590    <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01591"></a>01591       error = sqlite_exec(db, query, NULL, NULL, &amp;errormsg);
<a name="l01592"></a>01592    <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01593"></a>01593 
<a name="l01594"></a>01594    <span class="keywordflow">if</span> (!error) {
<a name="l01595"></a>01595       rows_num = sqlite_changes(db);
<a name="l01596"></a>01596    } <span class="keywordflow">else</span> {
<a name="l01597"></a>01597       rows_num = -1;
<a name="l01598"></a>01598    }
<a name="l01599"></a>01599 
<a name="l01600"></a>01600    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="res__config__sqlite_8c.html#a1cf414f64e7e755faa275f1c6383a9cc">mutex</a>);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602    sqlite_freemem(query);
<a name="l01603"></a>01603 
<a name="l01604"></a>01604    <span class="keywordflow">if</span> (error) {
<a name="l01605"></a>01605       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01606"></a>01606    }
<a name="l01607"></a>01607    sqlite_freemem(errormsg);
<a name="l01608"></a>01608 
<a name="l01609"></a>01609    <span class="keywordflow">return</span> rows_num;
<a name="l01610"></a>01610 }
<a name="l01611"></a>01611 
<a name="l01612"></a><a class="code" href="res__config__sqlite_8c.html#a286f8ad5d7b6c69af0ca40c7fb799012">01612</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a286f8ad5d7b6c69af0ca40c7fb799012">realtime_require_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *unused, <span class="keyword">const</span> <span class="keywordtype">char</span> *tablename, va_list ap)
<a name="l01613"></a>01613 {
<a name="l01614"></a>01614    <span class="keyword">struct </span>sqlite_cache_tables *tbl = <a class="code" href="res__config__sqlite_8c.html#a990147aa70d656ae71a98b581e05d7cd">find_table</a>(tablename);
<a name="l01615"></a>01615    <span class="keyword">struct </span><a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a> *col;
<a name="l01616"></a>01616    <span class="keywordtype">char</span> *elm;
<a name="l01617"></a>01617    <span class="keywordtype">int</span> <a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>, size, res = 0;
<a name="l01618"></a>01618 
<a name="l01619"></a>01619    <span class="keywordflow">if</span> (!tbl) {
<a name="l01620"></a>01620       <span class="keywordflow">return</span> -1;
<a name="l01621"></a>01621    }
<a name="l01622"></a>01622 
<a name="l01623"></a>01623    <span class="keywordflow">while</span> ((elm = va_arg(ap, <span class="keywordtype">char</span> *))) {
<a name="l01624"></a>01624       type = va_arg(ap, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3" title="Types used in ast_realtime_require_field.">require_type</a>);
<a name="l01625"></a>01625       size = va_arg(ap, <span class="keywordtype">int</span>);
<a name="l01626"></a>01626       <span class="comment">/* Check if the field matches the criteria */</span>
<a name="l01627"></a>01627       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;tbl-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>, col, list) {
<a name="l01628"></a>01628          <span class="keywordflow">if</span> (strcmp(col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>, elm) == 0) {
<a name="l01629"></a>01629             <span class="comment">/* SQLite only has two types - the 32-bit integer field that</span>
<a name="l01630"></a>01630 <span class="comment">             * is the key column, and everything else (everything else</span>
<a name="l01631"></a>01631 <span class="comment">             * being a string).</span>
<a name="l01632"></a>01632 <span class="comment">             */</span>
<a name="l01633"></a>01633             <span class="keywordflow">if</span> (col-&gt;<a class="code" href="structsqlite__cache__columns.html#a751d974203a2f02b0ccf870012d13ee9">isint</a> &amp;&amp; !ast_rq_is_int(type)) {
<a name="l01634"></a>01634                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Realtime table %s: column &apos;%s&apos; is an integer field, but Asterisk requires that it not be!\n&quot;</span>, tablename, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l01635"></a>01635                res = -1;
<a name="l01636"></a>01636             }
<a name="l01637"></a>01637             <span class="keywordflow">break</span>;
<a name="l01638"></a>01638          }
<a name="l01639"></a>01639       }
<a name="l01640"></a>01640       <span class="keywordflow">if</span> (!col) {
<a name="l01641"></a>01641          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Realtime table %s requires column &apos;%s&apos;, but that column does not exist!\n&quot;</span>, tablename, elm);
<a name="l01642"></a>01642       }
<a name="l01643"></a>01643    }
<a name="l01644"></a>01644    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;(tbl-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>));
<a name="l01645"></a>01645    <span class="keywordflow">return</span> res;
<a name="l01646"></a>01646 }
<a name="l01647"></a>01647 
<a name="l01648"></a><a class="code" href="res__config__sqlite_8c.html#a4554cd4e901164ef2da59b8398d56d8f">01648</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#a4554cd4e901164ef2da59b8398d56d8f">realtime_unload_handler</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *unused, <span class="keyword">const</span> <span class="keywordtype">char</span> *tablename)
<a name="l01649"></a>01649 {
<a name="l01650"></a>01650    <span class="keyword">struct </span>sqlite_cache_tables *tbl;
<a name="l01651"></a>01651    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sqlite_tables);
<a name="l01652"></a>01652    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;sqlite_tables, tbl, list) {
<a name="l01653"></a>01653       <span class="keywordflow">if</span> (!strcasecmp(tbl-&gt;<a class="code" href="structsqlite__cache__tables.html#a5ac083a645d964373f022d03df4849c8">name</a>, tablename)) {
<a name="l01654"></a>01654          <a class="code" href="linkedlists_8h.html#a02212548652c9eb0f3db38dc4e4bd285">AST_RWLIST_REMOVE_CURRENT</a>(list);
<a name="l01655"></a>01655          <a class="code" href="res__config__sqlite_8c.html#a5784f210e0f5472a18ecd99d64ffec9e">free_table</a>(tbl);
<a name="l01656"></a>01656       }
<a name="l01657"></a>01657    }
<a name="l01658"></a>01658    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l01659"></a>01659    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l01660"></a>01660    <span class="keywordflow">return</span> 0;
<a name="l01661"></a>01661 }
<a name="l01662"></a>01662 
<a name="l01663"></a><a class="code" href="res__config__sqlite_8c.html#ac09349f29c2d83b9c82873b6b30d960f">01663</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#ac09349f29c2d83b9c82873b6b30d960f" title="Asterisk callback function for the CLI status command.">handle_cli_show_sqlite_status</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01664"></a>01664 {
<a name="l01665"></a>01665    <span class="keywordflow">switch</span> (cmd) {
<a name="l01666"></a>01666    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01667"></a>01667       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;sqlite show status&quot;</span>;
<a name="l01668"></a>01668       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01669"></a>01669          <span class="stringliteral">&quot;Usage: sqlite show status\n&quot;</span>
<a name="l01670"></a>01670          <span class="stringliteral">&quot;       Show status information about the SQLite 2 driver\n&quot;</span>;
<a name="l01671"></a>01671       <span class="keywordflow">return</span> NULL;
<a name="l01672"></a>01672    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01673"></a>01673       <span class="keywordflow">return</span> NULL;
<a name="l01674"></a>01674    }
<a name="l01675"></a>01675 
<a name="l01676"></a>01676    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l01677"></a>01677       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01678"></a>01678 
<a name="l01679"></a>01679    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;SQLite database path: %s\n&quot;</span>, dbfile);
<a name="l01680"></a>01680    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;config_table: &quot;</span>);
<a name="l01681"></a>01681 
<a name="l01682"></a>01682    <span class="keywordflow">if</span> (!config_table)
<a name="l01683"></a>01683       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;unspecified, must be present in extconfig.conf\n&quot;</span>);
<a name="l01684"></a>01684    <span class="keywordflow">else</span>
<a name="l01685"></a>01685       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, config_table);
<a name="l01686"></a>01686 
<a name="l01687"></a>01687    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;cdr_table: &quot;</span>);
<a name="l01688"></a>01688 
<a name="l01689"></a>01689    <span class="keywordflow">if</span> (!cdr_table)
<a name="l01690"></a>01690       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;unspecified, CDR support disabled\n&quot;</span>);
<a name="l01691"></a>01691    <span class="keywordflow">else</span>
<a name="l01692"></a>01692       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, cdr_table);
<a name="l01693"></a>01693 
<a name="l01694"></a>01694    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01695"></a>01695 }
<a name="l01696"></a>01696 
<a name="l01697"></a><a class="code" href="res__config__sqlite_8c.html#a3ae4390cbd19f3cbb3b5f51b6488decb">01697</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="res__config__sqlite_8c.html#a3ae4390cbd19f3cbb3b5f51b6488decb">handle_cli_sqlite_show_tables</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01698"></a>01698 {
<a name="l01699"></a>01699    <span class="keyword">struct </span>sqlite_cache_tables *tbl;
<a name="l01700"></a>01700    <span class="keyword">struct </span><a class="code" href="structsqlite__cache__columns.html">sqlite_cache_columns</a> *col;
<a name="l01701"></a>01701    <span class="keywordtype">int</span> found = 0;
<a name="l01702"></a>01702 
<a name="l01703"></a>01703    <span class="keywordflow">switch</span> (cmd) {
<a name="l01704"></a>01704    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01705"></a>01705       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;sqlite show tables&quot;</span>;
<a name="l01706"></a>01706       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01707"></a>01707          <span class="stringliteral">&quot;Usage: sqlite show tables\n&quot;</span>
<a name="l01708"></a>01708          <span class="stringliteral">&quot;       Show table information about the SQLite 2 driver\n&quot;</span>;
<a name="l01709"></a>01709       <span class="keywordflow">return</span> NULL;
<a name="l01710"></a>01710    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01711"></a>01711       <span class="keywordflow">return</span> NULL;
<a name="l01712"></a>01712    }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l01715"></a>01715       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01716"></a>01716 
<a name="l01717"></a>01717    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sqlite_tables);
<a name="l01718"></a>01718    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sqlite_tables, tbl, list) {
<a name="l01719"></a>01719       found++;
<a name="l01720"></a>01720       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Table %s:\n&quot;</span>, tbl-&gt;<a class="code" href="structsqlite__cache__tables.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l01721"></a>01721       <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;(tbl-&gt;<a class="code" href="structsqlite__cache__tables.html#ace37f2e206feb41915a65dad68c3100c">columns</a>), col, list) {
<a name="l01722"></a>01722          fprintf(stderr, <span class="stringliteral">&quot;%s\n&quot;</span>, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l01723"></a>01723          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;  %20.20s  %-30.30s\n&quot;</span>, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a5ac083a645d964373f022d03df4849c8">name</a>, col-&gt;<a class="code" href="structsqlite__cache__columns.html#a23506fc4821ab6d9671f3e6222591a96">type</a>);
<a name="l01724"></a>01724       }
<a name="l01725"></a>01725    }
<a name="l01726"></a>01726    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sqlite_tables);
<a name="l01727"></a>01727 
<a name="l01728"></a>01728    <span class="keywordflow">if</span> (!found) {
<a name="l01729"></a>01729       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No tables currently in cache\n&quot;</span>);
<a name="l01730"></a>01730    }
<a name="l01731"></a>01731 
<a name="l01732"></a>01732    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01733"></a>01733 }
<a name="l01734"></a>01734 
<a name="l01735"></a><a class="code" href="res__config__sqlite_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01735</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01736"></a>01736 {
<a name="l01737"></a>01737    <span class="keywordflow">if</span> (cli_status_registered)
<a name="l01738"></a>01738       <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_status, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_status));
<a name="l01739"></a>01739 
<a name="l01740"></a>01740    <span class="keywordflow">if</span> (cdr_registered)
<a name="l01741"></a>01741       <a class="code" href="cdr_8h.html#a31a2a5a50d025225f13633c95f7bcd4d" title="Unregister a CDR handling engine.">ast_cdr_unregister</a>(<a class="code" href="res__config__sqlite_8c.html#acbd22ddbb653b6555ab5bc619780efc0">RES_CONFIG_SQLITE_NAME</a>);
<a name="l01742"></a>01742 
<a name="l01743"></a>01743    <a class="code" href="config_8h.html#a7028ff4b11d7167ee4030b4d3e123d76" title="Deregister config engine.">ast_config_engine_deregister</a>(&amp;sqlite_engine);
<a name="l01744"></a>01744 
<a name="l01745"></a>01745    <span class="keywordflow">if</span> (db)
<a name="l01746"></a>01746       sqlite_close(db);
<a name="l01747"></a>01747 
<a name="l01748"></a>01748    <a class="code" href="res__config__sqlite_8c.html#a72f99a227dc7bc5522ba90399070f385" title="Free resources related to configuration.">unload_config</a>();
<a name="l01749"></a>01749 
<a name="l01750"></a>01750    <span class="keywordflow">return</span> 0;
<a name="l01751"></a>01751 }
<a name="l01752"></a>01752 
<a name="l01753"></a><a class="code" href="res__config__sqlite_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01753</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__config__sqlite_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01754"></a>01754 {
<a name="l01755"></a>01755    <span class="keywordtype">char</span> *errormsg = NULL;
<a name="l01756"></a>01756    <span class="keywordtype">int</span> error;
<a name="l01757"></a>01757 
<a name="l01758"></a>01758    db = NULL;
<a name="l01759"></a>01759    cdr_registered = 0;
<a name="l01760"></a>01760    cli_status_registered = 0;
<a name="l01761"></a>01761    dbfile = NULL;
<a name="l01762"></a>01762    config_table = NULL;
<a name="l01763"></a>01763    cdr_table = NULL;
<a name="l01764"></a>01764    error = <a class="code" href="res__config__sqlite_8c.html#aed5779f84d4ebb67745d801d3ebede43" title="Load the configuration file.">load_config</a>();
<a name="l01765"></a>01765 
<a name="l01766"></a>01766    <span class="keywordflow">if</span> (error)
<a name="l01767"></a>01767       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01768"></a>01768 
<a name="l01769"></a>01769    <span class="keywordflow">if</span> (!(db = sqlite_open(dbfile, 0660, &amp;errormsg))) {
<a name="l01770"></a>01770       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01771"></a>01771       sqlite_freemem(errormsg);
<a name="l01772"></a>01772       <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01773"></a>01773       <span class="keywordflow">return</span> 1;
<a name="l01774"></a>01774    }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776    sqlite_freemem(errormsg);
<a name="l01777"></a>01777    errormsg = NULL;
<a name="l01778"></a>01778    <a class="code" href="config_8h.html#af15c271e1708b251fc938b30baba18f1" title="Register config engine.">ast_config_engine_register</a>(&amp;sqlite_engine);
<a name="l01779"></a>01779 
<a name="l01780"></a>01780    <span class="keywordflow">if</span> (use_cdr) {
<a name="l01781"></a>01781       <span class="keywordtype">char</span> *query;
<a name="l01782"></a>01782 
<a name="l01783"></a>01783 <span class="comment">/* \cond DOXYGEN_CAN_PARSE_THIS */</span>
<a name="l01784"></a>01784 <span class="preprocessor">#undef QUERY</span>
<a name="l01785"></a>01785 <span class="preprocessor"></span><span class="preprocessor">#define QUERY &quot;SELECT COUNT(id) FROM %Q;&quot;</span>
<a name="l01786"></a>01786 <span class="preprocessor"></span><span class="comment">/* \endcond */</span>
<a name="l01787"></a>01787 
<a name="l01788"></a>01788       query = sqlite_mprintf(QUERY, cdr_table);
<a name="l01789"></a>01789 
<a name="l01790"></a>01790       <span class="keywordflow">if</span> (!query) {
<a name="l01791"></a>01791          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l01792"></a>01792          <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01793"></a>01793          <span class="keywordflow">return</span> 1;
<a name="l01794"></a>01794       }
<a name="l01795"></a>01795 
<a name="l01796"></a>01796       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l01797"></a>01797 
<a name="l01798"></a>01798       <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01799"></a>01799          error = sqlite_exec(db, query, NULL, NULL, &amp;errormsg);
<a name="l01800"></a>01800       <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01801"></a>01801 
<a name="l01802"></a>01802       sqlite_freemem(query);
<a name="l01803"></a>01803 
<a name="l01804"></a>01804       <span class="keywordflow">if</span> (error) {
<a name="l01805"></a>01805          <span class="comment">/*</span>
<a name="l01806"></a>01806 <span class="comment">          * Unexpected error.</span>
<a name="l01807"></a>01807 <span class="comment">          */</span>
<a name="l01808"></a>01808          <span class="keywordflow">if</span> (error != SQLITE_ERROR) {
<a name="l01809"></a>01809             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01810"></a>01810             sqlite_freemem(errormsg);
<a name="l01811"></a>01811             <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01812"></a>01812             <span class="keywordflow">return</span> 1;
<a name="l01813"></a>01813          }
<a name="l01814"></a>01814 
<a name="l01815"></a>01815          sqlite_freemem(errormsg);
<a name="l01816"></a>01816          errormsg = NULL;
<a name="l01817"></a>01817          query = sqlite_mprintf(<a class="code" href="res__config__sqlite_8c.html#ae6feefd120eabf04edc898d1430fd9f0">sql_create_cdr_table</a>, cdr_table);
<a name="l01818"></a>01818 
<a name="l01819"></a>01819          <span class="keywordflow">if</span> (!query) {
<a name="l01820"></a>01820             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to allocate SQL query\n&quot;</span>);
<a name="l01821"></a>01821             <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01822"></a>01822             <span class="keywordflow">return</span> 1;
<a name="l01823"></a>01823          }
<a name="l01824"></a>01824 
<a name="l01825"></a>01825          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;SQL query: %s\n&quot;</span>, query);
<a name="l01826"></a>01826 
<a name="l01827"></a>01827          <a class="code" href="res__config__sqlite_8c.html#ad68868f34232bc245b29318442eff1ce">RES_CONFIG_SQLITE_BEGIN</a>
<a name="l01828"></a>01828             error = sqlite_exec(db, query, NULL, NULL, &amp;errormsg);
<a name="l01829"></a>01829          <a class="code" href="res__config__sqlite_8c.html#a273fbdbcd4491234b3c4dcfe5b5c5d52">RES_CONFIG_SQLITE_END</a>(error)
<a name="l01830"></a>01830 
<a name="l01831"></a>01831          sqlite_freemem(query);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833          <span class="keywordflow">if</span> (error) {
<a name="l01834"></a>01834             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(errormsg, sqlite_error_string(error)));
<a name="l01835"></a>01835             sqlite_freemem(errormsg);
<a name="l01836"></a>01836             <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01837"></a>01837             <span class="keywordflow">return</span> 1;
<a name="l01838"></a>01838          }
<a name="l01839"></a>01839       }
<a name="l01840"></a>01840       sqlite_freemem(errormsg);
<a name="l01841"></a>01841       errormsg = NULL;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843       error = <a class="code" href="cdr_8h.html#abdbcf7f728cbacea0b28bf9c51f99b92" title="Register a CDR handling engine.">ast_cdr_register</a>(<a class="code" href="res__config__sqlite_8c.html#acbd22ddbb653b6555ab5bc619780efc0">RES_CONFIG_SQLITE_NAME</a>, <a class="code" href="res__config__sqlite_8c.html#a2f82b578cab098832c975e3f4237ce12">RES_CONFIG_SQLITE_DESCRIPTION</a>, <a class="code" href="res__config__sqlite_8c.html#a9b959d97c623a073d5562c5921b0635a" title="Asterisk callback function for CDR support.">cdr_handler</a>);
<a name="l01844"></a>01844 
<a name="l01845"></a>01845       <span class="keywordflow">if</span> (error) {
<a name="l01846"></a>01846          <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01847"></a>01847          <span class="keywordflow">return</span> 1;
<a name="l01848"></a>01848       }
<a name="l01849"></a>01849 
<a name="l01850"></a>01850       cdr_registered = 1;
<a name="l01851"></a>01851    }
<a name="l01852"></a>01852 
<a name="l01853"></a>01853    error = <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_status, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_status));
<a name="l01854"></a>01854 
<a name="l01855"></a>01855    <span class="keywordflow">if</span> (error) {
<a name="l01856"></a>01856       <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>();
<a name="l01857"></a>01857       <span class="keywordflow">return</span> 1;
<a name="l01858"></a>01858    }
<a name="l01859"></a>01859 
<a name="l01860"></a>01860    cli_status_registered = 1;
<a name="l01861"></a>01861 
<a name="l01862"></a>01862    <span class="keywordflow">return</span> 0;
<a name="l01863"></a>01863 }
<a name="l01864"></a>01864 
<a name="l01865"></a>01865 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a835b27a90d895a488e4e14cc3d2dee8c">AST_MODFLAG_GLOBAL_SYMBOLS</a>, <span class="stringliteral">&quot;Realtime SQLite configuration&quot;</span>,
<a name="l01866"></a>01866       .load = <a class="code" href="res__config__sqlite_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l01867"></a>01867       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l01868"></a><a class="code" href="res__config__sqlite_8c.html#ae25b9f3970870610911f8850897e8ead">01868</a> );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:46 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
