<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:24 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_chanspy.c</h1><a href="app__chanspy_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 2005 Anthony Minessale II (anthmct@yahoo.com)</span>
<a name="l00005"></a>00005 <span class="comment"> * Copyright (C) 2005 - 2008, Digium, Inc.</span>
<a name="l00006"></a>00006 <span class="comment"> *</span>
<a name="l00007"></a>00007 <span class="comment"> * A license has been granted to Digium (via disclaimer) for the use of</span>
<a name="l00008"></a>00008 <span class="comment"> * this code.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00011"></a>00011 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00012"></a>00012 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00013"></a>00013 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00014"></a>00014 <span class="comment"> * channels for your use.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00017"></a>00017 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00018"></a>00018 <span class="comment"> * at the top of the source tree.</span>
<a name="l00019"></a>00019 <span class="comment"> */</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">/*! \file</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \brief ChanSpy: Listen in on any channel.</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \author Anthony Minessale II &lt;anthmct@yahoo.com&gt;</span>
<a name="l00026"></a>00026 <span class="comment"> * \author Joshua Colp &lt;jcolp@digium.com&gt;</span>
<a name="l00027"></a>00027 <span class="comment"> * \author Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00028"></a>00028 <span class="comment"> *</span>
<a name="l00029"></a>00029 <span class="comment"> * \ingroup applications</span>
<a name="l00030"></a>00030 <span class="comment"> */</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00033"></a>00033 
<a name="l00034"></a>00034 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 228195 $&quot;</span>)
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;errno.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span> <span class="comment">/* use ast_config_AST_MONITOR_DIR */</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="audiohook_8h.html" title="Audiohooks Architecture.">asterisk/audiohook.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="features_8h.html" title="Call Parking and Pickup API Includes code and algorithms from the Zapata library...">asterisk/features.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="options_8h.html" title="Options provided by main asterisk program.">asterisk/options.h</a>&quot;</span>
<a name="l00053"></a>00053 
<a name="l00054"></a><a class="code" href="app__chanspy_8c.html#ae0cb3deeda0e38de0a56694e69f1a11a">00054</a> <span class="preprocessor">#define AST_NAME_STRLEN 256</span>
<a name="l00055"></a><a class="code" href="app__chanspy_8c.html#a19a50459d318fcd424c0cb03d07a18c8">00055</a> <span class="preprocessor"></span><span class="preprocessor">#define NUM_SPYGROUPS 128</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a>00057 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00058"></a>00058 <span class="comment">   &lt;application name=&quot;ChanSpy&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00059"></a>00059 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00060"></a>00060 <span class="comment">         Listen to a channel, and optionally whisper into it.</span>
<a name="l00061"></a>00061 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00062"></a>00062 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00063"></a>00063 <span class="comment">         &lt;parameter name=&quot;chanprefix&quot; /&gt;</span>
<a name="l00064"></a>00064 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00065"></a>00065 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00066"></a>00066 <span class="comment">               &lt;option name=&quot;b&quot;&gt;</span>
<a name="l00067"></a>00067 <span class="comment">                  &lt;para&gt;Only spy on channels involved in a bridged call.&lt;/para&gt;</span>
<a name="l00068"></a>00068 <span class="comment">               &lt;/option&gt;</span>
<a name="l00069"></a>00069 <span class="comment">               &lt;option name=&quot;B&quot;&gt;</span>
<a name="l00070"></a>00070 <span class="comment">                  &lt;para&gt;Instead of whispering on a single channel barge in on both</span>
<a name="l00071"></a>00071 <span class="comment">                  channels involved in the call.&lt;/para&gt;</span>
<a name="l00072"></a>00072 <span class="comment">               &lt;/option&gt;</span>
<a name="l00073"></a>00073 <span class="comment">               &lt;option name=&quot;d&quot;&gt;</span>
<a name="l00074"></a>00074 <span class="comment">                  &lt;para&gt;Override the typical numeric DTMF functionality and instead</span>
<a name="l00075"></a>00075 <span class="comment">                  use DTMF to switch between spy modes.&lt;/para&gt;</span>
<a name="l00076"></a>00076 <span class="comment">                  &lt;enumlist&gt;</span>
<a name="l00077"></a>00077 <span class="comment">                     &lt;enum name=&quot;4&quot;&gt;</span>
<a name="l00078"></a>00078 <span class="comment">                        &lt;para&gt;spy mode&lt;/para&gt;</span>
<a name="l00079"></a>00079 <span class="comment">                     &lt;/enum&gt;</span>
<a name="l00080"></a>00080 <span class="comment">                     &lt;enum name=&quot;5&quot;&gt;</span>
<a name="l00081"></a>00081 <span class="comment">                        &lt;para&gt;whisper mode&lt;/para&gt;</span>
<a name="l00082"></a>00082 <span class="comment">                     &lt;/enum&gt;</span>
<a name="l00083"></a>00083 <span class="comment">                     &lt;enum name=&quot;6&quot;&gt;</span>
<a name="l00084"></a>00084 <span class="comment">                        &lt;para&gt;barge mode&lt;/para&gt;</span>
<a name="l00085"></a>00085 <span class="comment">                     &lt;/enum&gt;</span>
<a name="l00086"></a>00086 <span class="comment">                  &lt;/enumlist&gt;</span>
<a name="l00087"></a>00087 <span class="comment">               &lt;/option&gt;</span>
<a name="l00088"></a>00088 <span class="comment">               &lt;option name=&quot;g&quot;&gt;</span>
<a name="l00089"></a>00089 <span class="comment">                  &lt;argument name=&quot;grp&quot; required=&quot;true&quot;&gt;</span>
<a name="l00090"></a>00090 <span class="comment">                     &lt;para&gt;Only spy on channels in which one or more of the groups</span>
<a name="l00091"></a>00091 <span class="comment">                     listed in &lt;replaceable&gt;grp&lt;/replaceable&gt; matches one or more groups from the</span>
<a name="l00092"></a>00092 <span class="comment">                     &lt;variable&gt;SPYGROUP&lt;/variable&gt; variable set on the channel to be spied upon.&lt;/para&gt;</span>
<a name="l00093"></a>00093 <span class="comment">                  &lt;/argument&gt;</span>
<a name="l00094"></a>00094 <span class="comment">                  &lt;note&gt;&lt;para&gt;both &lt;replaceable&gt;grp&lt;/replaceable&gt; and &lt;variable&gt;SPYGROUP&lt;/variable&gt; can contain </span>
<a name="l00095"></a>00095 <span class="comment">                  either a single group or a colon-delimited list of groups, such</span>
<a name="l00096"></a>00096 <span class="comment">                  as &lt;literal&gt;sales:support:accounting&lt;/literal&gt;.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00097"></a>00097 <span class="comment">               &lt;/option&gt;</span>
<a name="l00098"></a>00098 <span class="comment">               &lt;option name=&quot;n&quot; argsep=&quot;@&quot;&gt;</span>
<a name="l00099"></a>00099 <span class="comment">                  &lt;para&gt;Say the name of the person being spied on if that person has recorded</span>
<a name="l00100"></a>00100 <span class="comment">                  his/her name. If a context is specified, then that voicemail context will</span>
<a name="l00101"></a>00101 <span class="comment">                  be searched when retrieving the name, otherwise the &lt;literal&gt;default&lt;/literal&gt; context</span>
<a name="l00102"></a>00102 <span class="comment">                  be used when searching for the name (i.e. if SIP/1000 is the channel being</span>
<a name="l00103"></a>00103 <span class="comment">                  spied on and no mailbox is specified, then &lt;literal&gt;1000&lt;/literal&gt; will be used when searching</span>
<a name="l00104"></a>00104 <span class="comment">                  for the name).&lt;/para&gt;</span>
<a name="l00105"></a>00105 <span class="comment">                  &lt;argument name=&quot;mailbox&quot; /&gt;</span>
<a name="l00106"></a>00106 <span class="comment">                  &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00107"></a>00107 <span class="comment">               &lt;/option&gt;</span>
<a name="l00108"></a>00108 <span class="comment">               &lt;option name=&quot;q&quot;&gt;</span>
<a name="l00109"></a>00109 <span class="comment">                  &lt;para&gt;Don&apos;t play a beep when beginning to spy on a channel, or speak the</span>
<a name="l00110"></a>00110 <span class="comment">                  selected channel name.&lt;/para&gt;</span>
<a name="l00111"></a>00111 <span class="comment">               &lt;/option&gt;</span>
<a name="l00112"></a>00112 <span class="comment">               &lt;option name=&quot;r&quot;&gt;</span>
<a name="l00113"></a>00113 <span class="comment">                  &lt;para&gt;Record the session to the monitor spool directory. An optional base for the filename </span>
<a name="l00114"></a>00114 <span class="comment">                  may be specified. The default is &lt;literal&gt;chanspy&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00115"></a>00115 <span class="comment">                  &lt;argument name=&quot;basename&quot; /&gt;</span>
<a name="l00116"></a>00116 <span class="comment">               &lt;/option&gt;</span>
<a name="l00117"></a>00117 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00118"></a>00118 <span class="comment">                  &lt;para&gt;Skip the playback of the channel type (i.e. SIP, IAX, etc) when</span>
<a name="l00119"></a>00119 <span class="comment">                  speaking the selected channel name.&lt;/para&gt;</span>
<a name="l00120"></a>00120 <span class="comment">               &lt;/option&gt;</span>
<a name="l00121"></a>00121 <span class="comment">               &lt;option name=&quot;v&quot;&gt;</span>
<a name="l00122"></a>00122 <span class="comment">                  &lt;argument name=&quot;value&quot; /&gt;</span>
<a name="l00123"></a>00123 <span class="comment">                  &lt;para&gt;Adjust the initial volume in the range from &lt;literal&gt;-4&lt;/literal&gt; </span>
<a name="l00124"></a>00124 <span class="comment">                  to &lt;literal&gt;4&lt;/literal&gt;. A negative value refers to a quieter setting.&lt;/para&gt;</span>
<a name="l00125"></a>00125 <span class="comment">               &lt;/option&gt;</span>
<a name="l00126"></a>00126 <span class="comment">               &lt;option name=&quot;w&quot;&gt;</span>
<a name="l00127"></a>00127 <span class="comment">                  &lt;para&gt;Enable &lt;literal&gt;whisper&lt;/literal&gt; mode, so the spying channel can talk to</span>
<a name="l00128"></a>00128 <span class="comment">                  the spied-on channel.&lt;/para&gt;</span>
<a name="l00129"></a>00129 <span class="comment">               &lt;/option&gt;</span>
<a name="l00130"></a>00130 <span class="comment">               &lt;option name=&quot;W&quot;&gt;</span>
<a name="l00131"></a>00131 <span class="comment">                  &lt;para&gt;Enable &lt;literal&gt;private whisper&lt;/literal&gt; mode, so the spying channel can</span>
<a name="l00132"></a>00132 <span class="comment">                  talk to the spied-on channel but cannot listen to that channel.&lt;/para&gt;</span>
<a name="l00133"></a>00133 <span class="comment">               &lt;/option&gt;</span>
<a name="l00134"></a>00134 <span class="comment">               &lt;option name=&quot;o&quot;&gt;</span>
<a name="l00135"></a>00135 <span class="comment">                  &lt;para&gt;Only listen to audio coming from this channel.&lt;/para&gt;</span>
<a name="l00136"></a>00136 <span class="comment">               &lt;/option&gt;</span>
<a name="l00137"></a>00137 <span class="comment">               &lt;option name=&quot;X&quot;&gt;</span>
<a name="l00138"></a>00138 <span class="comment">                  &lt;para&gt;Allow the user to exit ChanSpy to a valid single digit</span>
<a name="l00139"></a>00139 <span class="comment">                  numeric extension in the current context or the context</span>
<a name="l00140"></a>00140 <span class="comment">                  specified by the &lt;variable&gt;SPY_EXIT_CONTEXT&lt;/variable&gt; channel variable. The</span>
<a name="l00141"></a>00141 <span class="comment">                  name of the last channel that was spied on will be stored</span>
<a name="l00142"></a>00142 <span class="comment">                  in the &lt;variable&gt;SPY_CHANNEL&lt;/variable&gt; variable.&lt;/para&gt;</span>
<a name="l00143"></a>00143 <span class="comment">               &lt;/option&gt;</span>
<a name="l00144"></a>00144 <span class="comment">               &lt;option name=&quot;e&quot;&gt;</span>
<a name="l00145"></a>00145 <span class="comment">                  &lt;argument name=&quot;ext&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00146"></a>00146 <span class="comment">                  &lt;para&gt;Enable &lt;emphasis&gt;enforced&lt;/emphasis&gt; mode, so the spying channel can</span>
<a name="l00147"></a>00147 <span class="comment">                  only monitor extensions whose name is in the &lt;replaceable&gt;ext&lt;/replaceable&gt; : delimited </span>
<a name="l00148"></a>00148 <span class="comment">                  list.&lt;/para&gt;</span>
<a name="l00149"></a>00149 <span class="comment">               &lt;/option&gt;</span>
<a name="l00150"></a>00150 <span class="comment">            &lt;/optionlist&gt;     </span>
<a name="l00151"></a>00151 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00152"></a>00152 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00153"></a>00153 <span class="comment">      &lt;description&gt;</span>
<a name="l00154"></a>00154 <span class="comment">         &lt;para&gt;This application is used to listen to the audio from an Asterisk channel. This includes the audio </span>
<a name="l00155"></a>00155 <span class="comment">         coming in and &quot;out of the channel being spied on. If the &lt;literal&gt;chanprefix&lt;/literal&gt; parameter is specified,</span>
<a name="l00156"></a>00156 <span class="comment">         only channels beginning with this string will be spied upon.&lt;/para&gt;</span>
<a name="l00157"></a>00157 <span class="comment">         &lt;para&gt;While spying, the following actions may be performed:&lt;/para&gt;</span>
<a name="l00158"></a>00158 <span class="comment">         &lt;para&gt; - Dialing &lt;literal&gt;#&lt;/literal&gt; cycles the volume level.&lt;/para&gt;</span>
<a name="l00159"></a>00159 <span class="comment">         &lt;para&gt; - Dialing &lt;literal&gt;*&lt;/literal&gt; will stop spying and look for another channel to spy on.&lt;/para&gt;</span>
<a name="l00160"></a>00160 <span class="comment">         &lt;para&gt; - Dialing a series of digits followed by &lt;literal&gt;#&lt;/literal&gt; builds a channel name to append</span>
<a name="l00161"></a>00161 <span class="comment">         to &apos;chanprefix&apos;. For example, executing ChanSpy(Agent) and then dialing the digits &apos;1234#&apos; </span>
<a name="l00162"></a>00162 <span class="comment">         while spying will begin spying on the channel &apos;Agent/1234&apos;. Note that this feature will be overridden if the &apos;d&apos; option</span>
<a name="l00163"></a>00163 <span class="comment">         is used&lt;/para&gt;</span>
<a name="l00164"></a>00164 <span class="comment">         &lt;note&gt;&lt;para&gt;The &lt;replaceable&gt;X&lt;/replaceable&gt; option supersedes the three features above in that if a valid</span>
<a name="l00165"></a>00165 <span class="comment">         single digit extension exists in the correct context ChanSpy will exit to it.</span>
<a name="l00166"></a>00166 <span class="comment">         This also disables choosing a channel based on &lt;literal&gt;chanprefix&lt;/literal&gt; and a digit sequence.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00167"></a>00167 <span class="comment">      &lt;/description&gt;</span>
<a name="l00168"></a>00168 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00169"></a>00169 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;ExtenSpy&lt;/ref&gt;</span>
<a name="l00170"></a>00170 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00171"></a>00171 <span class="comment">   &lt;/application&gt;</span>
<a name="l00172"></a>00172 <span class="comment">   &lt;application name=&quot;ExtenSpy&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00173"></a>00173 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00174"></a>00174 <span class="comment">         Listen to a channel, and optionally whisper into it.</span>
<a name="l00175"></a>00175 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00176"></a>00176 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00177"></a>00177 <span class="comment">         &lt;parameter name=&quot;exten&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span>
<a name="l00178"></a>00178 <span class="comment">            &lt;argument name=&quot;exten&quot; required=&quot;true&quot;&gt;</span>
<a name="l00179"></a>00179 <span class="comment">               &lt;para&gt;Specify extension.&lt;/para&gt;</span>
<a name="l00180"></a>00180 <span class="comment">            &lt;/argument&gt;</span>
<a name="l00181"></a>00181 <span class="comment">            &lt;argument name=&quot;context&quot;&gt;</span>
<a name="l00182"></a>00182 <span class="comment">               &lt;para&gt;Optionally specify a context, defaults to &lt;literal&gt;default&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00183"></a>00183 <span class="comment">            &lt;/argument&gt;</span>
<a name="l00184"></a>00184 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00185"></a>00185 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00186"></a>00186 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00187"></a>00187 <span class="comment">               &lt;option name=&quot;b&quot;&gt;</span>
<a name="l00188"></a>00188 <span class="comment">                  &lt;para&gt;Only spy on channels involved in a bridged call.&lt;/para&gt;</span>
<a name="l00189"></a>00189 <span class="comment">               &lt;/option&gt;</span>
<a name="l00190"></a>00190 <span class="comment">               &lt;option name=&quot;B&quot;&gt;</span>
<a name="l00191"></a>00191 <span class="comment">                  &lt;para&gt;Instead of whispering on a single channel barge in on both</span>
<a name="l00192"></a>00192 <span class="comment">                  channels involved in the call.&lt;/para&gt;</span>
<a name="l00193"></a>00193 <span class="comment">               &lt;/option&gt;</span>
<a name="l00194"></a>00194 <span class="comment">               &lt;option name=&quot;d&quot;&gt;</span>
<a name="l00195"></a>00195 <span class="comment">                  &lt;para&gt;Override the typical numeric DTMF functionality and instead</span>
<a name="l00196"></a>00196 <span class="comment">                  use DTMF to switch between spy modes.&lt;/para&gt;</span>
<a name="l00197"></a>00197 <span class="comment">                  &lt;enumlist&gt;</span>
<a name="l00198"></a>00198 <span class="comment">                     &lt;enum name=&quot;4&quot;&gt;</span>
<a name="l00199"></a>00199 <span class="comment">                        &lt;para&gt;spy mode&lt;/para&gt;</span>
<a name="l00200"></a>00200 <span class="comment">                     &lt;/enum&gt;</span>
<a name="l00201"></a>00201 <span class="comment">                     &lt;enum name=&quot;5&quot;&gt;</span>
<a name="l00202"></a>00202 <span class="comment">                        &lt;para&gt;whisper mode&lt;/para&gt;</span>
<a name="l00203"></a>00203 <span class="comment">                     &lt;/enum&gt;</span>
<a name="l00204"></a>00204 <span class="comment">                     &lt;enum name=&quot;6&quot;&gt;</span>
<a name="l00205"></a>00205 <span class="comment">                        &lt;para&gt;barge mode&lt;/para&gt;</span>
<a name="l00206"></a>00206 <span class="comment">                     &lt;/enum&gt;</span>
<a name="l00207"></a>00207 <span class="comment">                  &lt;/enumlist&gt;</span>
<a name="l00208"></a>00208 <span class="comment">               &lt;/option&gt;</span>
<a name="l00209"></a>00209 <span class="comment">               &lt;option name=&quot;g&quot;&gt;</span>
<a name="l00210"></a>00210 <span class="comment">                  &lt;argument name=&quot;grp&quot; required=&quot;true&quot;&gt;</span>
<a name="l00211"></a>00211 <span class="comment">                     &lt;para&gt;Only spy on channels in which one or more of the groups</span>
<a name="l00212"></a>00212 <span class="comment">                     listed in &lt;replaceable&gt;grp&lt;/replaceable&gt; matches one or more groups from the</span>
<a name="l00213"></a>00213 <span class="comment">                     &lt;variable&gt;SPYGROUP&lt;/variable&gt; variable set on the channel to be spied upon.&lt;/para&gt;</span>
<a name="l00214"></a>00214 <span class="comment">                  &lt;/argument&gt;</span>
<a name="l00215"></a>00215 <span class="comment">                  &lt;note&gt;&lt;para&gt;both &lt;replaceable&gt;grp&lt;/replaceable&gt; and &lt;variable&gt;SPYGROUP&lt;/variable&gt; can contain </span>
<a name="l00216"></a>00216 <span class="comment">                  either a single group or a colon-delimited list of groups, such</span>
<a name="l00217"></a>00217 <span class="comment">                  as &lt;literal&gt;sales:support:accounting&lt;/literal&gt;.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00218"></a>00218 <span class="comment">               &lt;/option&gt;</span>
<a name="l00219"></a>00219 <span class="comment">               &lt;option name=&quot;n&quot; argsep=&quot;@&quot;&gt;</span>
<a name="l00220"></a>00220 <span class="comment">                  &lt;para&gt;Say the name of the person being spied on if that person has recorded</span>
<a name="l00221"></a>00221 <span class="comment">                  his/her name. If a context is specified, then that voicemail context will</span>
<a name="l00222"></a>00222 <span class="comment">                  be searched when retrieving the name, otherwise the &lt;literal&gt;default&lt;/literal&gt; context</span>
<a name="l00223"></a>00223 <span class="comment">                  be used when searching for the name (i.e. if SIP/1000 is the channel being</span>
<a name="l00224"></a>00224 <span class="comment">                  spied on and no mailbox is specified, then &lt;literal&gt;1000&lt;/literal&gt; will be used when searching</span>
<a name="l00225"></a>00225 <span class="comment">                  for the name).&lt;/para&gt;</span>
<a name="l00226"></a>00226 <span class="comment">                  &lt;argument name=&quot;mailbox&quot; /&gt;</span>
<a name="l00227"></a>00227 <span class="comment">                  &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00228"></a>00228 <span class="comment">               &lt;/option&gt;</span>
<a name="l00229"></a>00229 <span class="comment">               &lt;option name=&quot;q&quot;&gt;</span>
<a name="l00230"></a>00230 <span class="comment">                  &lt;para&gt;Don&apos;t play a beep when beginning to spy on a channel, or speak the</span>
<a name="l00231"></a>00231 <span class="comment">                  selected channel name.&lt;/para&gt;</span>
<a name="l00232"></a>00232 <span class="comment">               &lt;/option&gt;</span>
<a name="l00233"></a>00233 <span class="comment">               &lt;option name=&quot;r&quot;&gt;</span>
<a name="l00234"></a>00234 <span class="comment">                  &lt;para&gt;Record the session to the monitor spool directory. An optional base for the filename </span>
<a name="l00235"></a>00235 <span class="comment">                  may be specified. The default is &lt;literal&gt;chanspy&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00236"></a>00236 <span class="comment">                  &lt;argument name=&quot;basename&quot; /&gt;</span>
<a name="l00237"></a>00237 <span class="comment">               &lt;/option&gt;</span>
<a name="l00238"></a>00238 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00239"></a>00239 <span class="comment">                  &lt;para&gt;Skip the playback of the channel type (i.e. SIP, IAX, etc) when</span>
<a name="l00240"></a>00240 <span class="comment">                  speaking the selected channel name.&lt;/para&gt;</span>
<a name="l00241"></a>00241 <span class="comment">               &lt;/option&gt;</span>
<a name="l00242"></a>00242 <span class="comment">               &lt;option name=&quot;v&quot;&gt;</span>
<a name="l00243"></a>00243 <span class="comment">                  &lt;argument name=&quot;value&quot; /&gt;</span>
<a name="l00244"></a>00244 <span class="comment">                  &lt;para&gt;Adjust the initial volume in the range from &lt;literal&gt;-4&lt;/literal&gt; </span>
<a name="l00245"></a>00245 <span class="comment">                  to &lt;literal&gt;4&lt;/literal&gt;. A negative value refers to a quieter setting.&lt;/para&gt;</span>
<a name="l00246"></a>00246 <span class="comment">               &lt;/option&gt;</span>
<a name="l00247"></a>00247 <span class="comment">               &lt;option name=&quot;w&quot;&gt;</span>
<a name="l00248"></a>00248 <span class="comment">                  &lt;para&gt;Enable &lt;literal&gt;whisper&lt;/literal&gt; mode, so the spying channel can talk to</span>
<a name="l00249"></a>00249 <span class="comment">                  the spied-on channel.&lt;/para&gt;</span>
<a name="l00250"></a>00250 <span class="comment">               &lt;/option&gt;</span>
<a name="l00251"></a>00251 <span class="comment">               &lt;option name=&quot;W&quot;&gt;</span>
<a name="l00252"></a>00252 <span class="comment">                  &lt;para&gt;Enable &lt;literal&gt;private whisper&lt;/literal&gt; mode, so the spying channel can</span>
<a name="l00253"></a>00253 <span class="comment">                  talk to the spied-on channel but cannot listen to that channel.&lt;/para&gt;</span>
<a name="l00254"></a>00254 <span class="comment">               &lt;/option&gt;</span>
<a name="l00255"></a>00255 <span class="comment">               &lt;option name=&quot;o&quot;&gt;</span>
<a name="l00256"></a>00256 <span class="comment">                  &lt;para&gt;Only listen to audio coming from this channel.&lt;/para&gt;</span>
<a name="l00257"></a>00257 <span class="comment">               &lt;/option&gt;</span>
<a name="l00258"></a>00258 <span class="comment">               &lt;option name=&quot;X&quot;&gt;</span>
<a name="l00259"></a>00259 <span class="comment">                  &lt;para&gt;Allow the user to exit ChanSpy to a valid single digit</span>
<a name="l00260"></a>00260 <span class="comment">                  numeric extension in the current context or the context</span>
<a name="l00261"></a>00261 <span class="comment">                  specified by the &lt;variable&gt;SPY_EXIT_CONTEXT&lt;/variable&gt; channel variable. The</span>
<a name="l00262"></a>00262 <span class="comment">                  name of the last channel that was spied on will be stored</span>
<a name="l00263"></a>00263 <span class="comment">                  in the &lt;variable&gt;SPY_CHANNEL&lt;/variable&gt; variable.&lt;/para&gt;</span>
<a name="l00264"></a>00264 <span class="comment">               &lt;/option&gt;</span>
<a name="l00265"></a>00265 <span class="comment">               &lt;option name=&quot;e&quot;&gt;</span>
<a name="l00266"></a>00266 <span class="comment">                  &lt;argument name=&quot;ext&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00267"></a>00267 <span class="comment">                  &lt;para&gt;Enable &lt;emphasis&gt;enforced&lt;/emphasis&gt; mode, so the spying channel can</span>
<a name="l00268"></a>00268 <span class="comment">                  only monitor extensions whose name is in the &lt;replaceable&gt;ext&lt;/replaceable&gt; : delimited </span>
<a name="l00269"></a>00269 <span class="comment">                  list.&lt;/para&gt;</span>
<a name="l00270"></a>00270 <span class="comment">               &lt;/option&gt;</span>
<a name="l00271"></a>00271 <span class="comment">            &lt;/optionlist&gt;  </span>
<a name="l00272"></a>00272 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00273"></a>00273 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00274"></a>00274 <span class="comment">      &lt;description&gt;</span>
<a name="l00275"></a>00275 <span class="comment">         &lt;para&gt;This application is used to listen to the audio from an Asterisk channel. This includes </span>
<a name="l00276"></a>00276 <span class="comment">         the audio coming in and out of the channel being spied on. Only channels created by outgoing calls for the</span>
<a name="l00277"></a>00277 <span class="comment">         specified extension will be selected for spying. If the optional context is not supplied, </span>
<a name="l00278"></a>00278 <span class="comment">         the current channel&apos;s context will be used.&lt;/para&gt;</span>
<a name="l00279"></a>00279 <span class="comment">         &lt;para&gt;While spying, the following actions may be performed:&lt;/para&gt;</span>
<a name="l00280"></a>00280 <span class="comment">         &lt;para&gt; - Dialing &lt;literal&gt;#&lt;/literal&gt; cycles the volume level.&lt;/para&gt;</span>
<a name="l00281"></a>00281 <span class="comment">                        &lt;para&gt; - Dialing &lt;literal&gt;*&lt;/literal&gt; will stop spying and look for another channel to spy on.&lt;/para&gt;</span>
<a name="l00282"></a>00282 <span class="comment">         &lt;note&gt;&lt;para&gt;The &lt;replaceable&gt;X&lt;/replaceable&gt; option supersedes the three features above in that if a valid</span>
<a name="l00283"></a>00283 <span class="comment">         single digit extension exists in the correct context ChanSpy will exit to it.</span>
<a name="l00284"></a>00284 <span class="comment">         This also disables choosing a channel based on &lt;literal&gt;chanprefix&lt;/literal&gt; and a digit sequence.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00285"></a>00285 <span class="comment">      &lt;/description&gt;</span>
<a name="l00286"></a>00286 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00287"></a>00287 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;ChanSpy&lt;/ref&gt;</span>
<a name="l00288"></a>00288 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00289"></a>00289 <span class="comment">   &lt;/application&gt;</span>
<a name="l00290"></a>00290 <span class="comment"></span>
<a name="l00291"></a>00291 <span class="comment"> ***/</span>
<a name="l00292"></a><a class="code" href="app__chanspy_8c.html#a18f53ecdb8778fc1e4acfe5792376a5f">00292</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__chanspy_8c.html#a18f53ecdb8778fc1e4acfe5792376a5f">app_chan</a> = <span class="stringliteral">&quot;ChanSpy&quot;</span>;
<a name="l00293"></a>00293 
<a name="l00294"></a><a class="code" href="app__chanspy_8c.html#af60aea1412bdf35bc7f9ff561578a58c">00294</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__chanspy_8c.html#af60aea1412bdf35bc7f9ff561578a58c">app_ext</a> = <span class="stringliteral">&quot;ExtenSpy&quot;</span>;
<a name="l00295"></a>00295 
<a name="l00296"></a>00296 <span class="keyword">enum</span> {
<a name="l00297"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">00297</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>             = (1 &lt;&lt; 0),    <span class="comment">/* Quiet, no announcement */</span>
<a name="l00298"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a26ff2d51a8148f407f1d27422e8e100b">00298</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a26ff2d51a8148f407f1d27422e8e100b">OPTION_BRIDGED</a>           = (1 &lt;&lt; 1),    <span class="comment">/* Only look at bridged calls */</span>
<a name="l00299"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7afc2bb7ff4e37e40134e58603c9160898">00299</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7afc2bb7ff4e37e40134e58603c9160898">OPTION_VOLUME</a>            = (1 &lt;&lt; 2),    <span class="comment">/* Specify initial volume */</span>
<a name="l00300"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7ebf68220b9eb6f2a0b42c992485adfc">00300</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7ebf68220b9eb6f2a0b42c992485adfc">OPTION_GROUP</a>             = (1 &lt;&lt; 3),    <span class="comment">/* Only look at channels in group */</span>
<a name="l00301"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a376d099a3022b28797087ce8ccfc3140">00301</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a376d099a3022b28797087ce8ccfc3140">OPTION_RECORD</a>            = (1 &lt;&lt; 4),
<a name="l00302"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">00302</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>           = (1 &lt;&lt; 5),
<a name="l00303"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">00303</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">OPTION_PRIVATE</a>           = (1 &lt;&lt; 6),    <span class="comment">/* Private Whisper mode */</span>
<a name="l00304"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a79ef002eb9aaf309587a34a2f061cd53">00304</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a79ef002eb9aaf309587a34a2f061cd53">OPTION_READONLY</a>          = (1 &lt;&lt; 7),    <span class="comment">/* Don&apos;t mix the two channels */</span>
<a name="l00305"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a2227204a6dda84506c9ce8fa0b6a6ff7">00305</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a2227204a6dda84506c9ce8fa0b6a6ff7">OPTION_EXIT</a>              = (1 &lt;&lt; 8),    <span class="comment">/* Exit to a valid single digit extension */</span>
<a name="l00306"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0e97e0e983231509740f1f3b590f4c13">00306</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0e97e0e983231509740f1f3b590f4c13">OPTION_ENFORCED</a>          = (1 &lt;&lt; 9),    <span class="comment">/* Enforced mode */</span>
<a name="l00307"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7abea03a976d4fb445b5b5e33f575801da">00307</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7abea03a976d4fb445b5b5e33f575801da">OPTION_NOTECH</a>            = (1 &lt;&lt; 10),   <span class="comment">/* Skip technology name playback */</span>
<a name="l00308"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">00308</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">OPTION_BARGE</a>             = (1 &lt;&lt; 11),   <span class="comment">/* Barge mode (whisper to both channels) */</span>
<a name="l00309"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">00309</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">OPTION_NAME</a>              = (1 &lt;&lt; 12),   <span class="comment">/* Say the name of the person on whom we will spy */</span>
<a name="l00310"></a><a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a9bbf649c205bbc6888d5cebdc01d96a8">00310</a>    <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a9bbf649c205bbc6888d5cebdc01d96a8">OPTION_DTMF_SWITCH_MODES</a> = (1 &lt;&lt; 13),   <span class="comment">/*Allow numeric DTMF to switch between chanspy modes */</span>
<a name="l00311"></a>00311 } <a class="code" href="app__chanspy_8c.html#a9fcb14e6c8f8261e9bf140d2f687ce77">chanspy_opt_flags</a>;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313 <span class="keyword">enum</span> {
<a name="l00314"></a><a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ac31114b0c2250979c4021b4170e046ca">00314</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ac31114b0c2250979c4021b4170e046ca">OPT_ARG_VOLUME</a> = 0,
<a name="l00315"></a><a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5afce708639b9a3a5d208d694724f0dbd1">00315</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5afce708639b9a3a5d208d694724f0dbd1">OPT_ARG_GROUP</a>,
<a name="l00316"></a><a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a386501e86d89afb66489abdeb3c4ad59">00316</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a386501e86d89afb66489abdeb3c4ad59">OPT_ARG_RECORD</a>,
<a name="l00317"></a><a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ad1315938fca1334bc1f4590a0ac718eb">00317</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ad1315938fca1334bc1f4590a0ac718eb">OPT_ARG_ENFORCED</a>,
<a name="l00318"></a><a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a828cbbd9db97b9076ac75637f462d729">00318</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a828cbbd9db97b9076ac75637f462d729">OPT_ARG_NAME</a>,
<a name="l00319"></a><a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">00319</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>,
<a name="l00320"></a>00320 } <a class="code" href="app__chanspy_8c.html#a283938c20bf01d8e4a864ea733e0ecf7">chanspy_opt_args</a>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(spy_opts, {
<a name="l00323"></a>00323    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;q&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>),
<a name="l00324"></a>00324    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;b&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a26ff2d51a8148f407f1d27422e8e100b">OPTION_BRIDGED</a>),
<a name="l00325"></a>00325    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;B&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">OPTION_BARGE</a>),
<a name="l00326"></a>00326    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;w&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>),
<a name="l00327"></a>00327    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;W&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">OPTION_PRIVATE</a>),
<a name="l00328"></a>00328    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;v&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7afc2bb7ff4e37e40134e58603c9160898">OPTION_VOLUME</a>, <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ac31114b0c2250979c4021b4170e046ca">OPT_ARG_VOLUME</a>),
<a name="l00329"></a>00329    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;g&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7ebf68220b9eb6f2a0b42c992485adfc">OPTION_GROUP</a>, <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5afce708639b9a3a5d208d694724f0dbd1">OPT_ARG_GROUP</a>),
<a name="l00330"></a>00330    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;r&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a376d099a3022b28797087ce8ccfc3140">OPTION_RECORD</a>, <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a386501e86d89afb66489abdeb3c4ad59">OPT_ARG_RECORD</a>),
<a name="l00331"></a>00331    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;e&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0e97e0e983231509740f1f3b590f4c13">OPTION_ENFORCED</a>, <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ad1315938fca1334bc1f4590a0ac718eb">OPT_ARG_ENFORCED</a>),
<a name="l00332"></a>00332    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;o&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a79ef002eb9aaf309587a34a2f061cd53">OPTION_READONLY</a>),
<a name="l00333"></a>00333    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;X&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a2227204a6dda84506c9ce8fa0b6a6ff7">OPTION_EXIT</a>),
<a name="l00334"></a>00334    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;s&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7abea03a976d4fb445b5b5e33f575801da">OPTION_NOTECH</a>),
<a name="l00335"></a>00335    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;n&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">OPTION_NAME</a>, <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a828cbbd9db97b9076ac75637f462d729">OPT_ARG_NAME</a>),
<a name="l00336"></a>00336    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;d&apos;</span>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a9bbf649c205bbc6888d5cebdc01d96a8">OPTION_DTMF_SWITCH_MODES</a>),
<a name="l00337"></a>00337 });
<a name="l00338"></a>00338 
<a name="l00339"></a><a class="code" href="app__chanspy_8c.html#a7af3d3e6fda5ce1af9b082a529ba6c67">00339</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#a7af3d3e6fda5ce1af9b082a529ba6c67">next_unique_id_to_use</a> = 0;
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="structchanspy__translation__helper.html">00341</a> <span class="keyword">struct </span><a class="code" href="structchanspy__translation__helper.html">chanspy_translation_helper</a> {
<a name="l00342"></a>00342    <span class="comment">/* spy data */</span>
<a name="l00343"></a><a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">00343</a>    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> <a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>;
<a name="l00344"></a><a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">00344</a>    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> <a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>;
<a name="l00345"></a><a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">00345</a>    <span class="keyword">struct </span><a class="code" href="structast__audiohook.html">ast_audiohook</a> <a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>;
<a name="l00346"></a><a class="code" href="structchanspy__translation__helper.html#a6f8059414f0228f0256115e024eeed4b">00346</a>    <span class="keywordtype">int</span> <a class="code" href="structchanspy__translation__helper.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l00347"></a><a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">00347</a>    <span class="keywordtype">int</span> <a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a>;
<a name="l00348"></a>00348 };
<a name="l00349"></a>00349 
<a name="l00350"></a><a class="code" href="app__chanspy_8c.html#a09a425a040263beb877243aefca430e3">00350</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app__chanspy_8c.html#a09a425a040263beb877243aefca430e3">spy_alloc</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00351"></a>00351 {
<a name="l00352"></a>00352    <span class="comment">/* just store the data pointer in the channel structure */</span>
<a name="l00353"></a>00353    <span class="keywordflow">return</span> data;
<a name="l00354"></a>00354 }
<a name="l00355"></a>00355 
<a name="l00356"></a><a class="code" href="app__chanspy_8c.html#adf3e4b0884895f8eb073920f0dc46b99">00356</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__chanspy_8c.html#adf3e4b0884895f8eb073920f0dc46b99">spy_release</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00357"></a>00357 {
<a name="l00358"></a>00358    <span class="comment">/* nothing to do */</span>
<a name="l00359"></a>00359 }
<a name="l00360"></a>00360 
<a name="l00361"></a><a class="code" href="app__chanspy_8c.html#afa79ad21fa6c452bd84717f9b146d103">00361</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#afa79ad21fa6c452bd84717f9b146d103">spy_generate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> samples)
<a name="l00362"></a>00362 {
<a name="l00363"></a>00363    <span class="keyword">struct </span><a class="code" href="structchanspy__translation__helper.html">chanspy_translation_helper</a> *csth = data;
<a name="l00364"></a>00364    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, *cur;
<a name="l00365"></a>00365 
<a name="l00366"></a>00366    <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00367"></a>00367    <span class="keywordflow">if</span> (csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>.<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> != <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>) {
<a name="l00368"></a>00368       <span class="comment">/* Channel is already gone more than likely */</span>
<a name="l00369"></a>00369       <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00370"></a>00370       <span class="keywordflow">return</span> -1;
<a name="l00371"></a>00371    }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a79ef002eb9aaf309587a34a2f061cd53">OPTION_READONLY</a>)) {
<a name="l00374"></a>00374       <span class="comment">/* Option &apos;o&apos; was set, so don&apos;t mix channel audio */</span>
<a name="l00375"></a>00375       f = <a class="code" href="audiohook_8h.html#a0e5d69771f8bd48682ca3d40bc2111c2" title="Reads a frame in from the audiohook structure.">ast_audiohook_read_frame</a>(&amp;csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>, samples, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a56916f7012e7fe0ec9b6dd4e4c0e2a65">AST_AUDIOHOOK_DIRECTION_READ</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l00376"></a>00376    } <span class="keywordflow">else</span> {
<a name="l00377"></a>00377       f = <a class="code" href="audiohook_8h.html#a0e5d69771f8bd48682ca3d40bc2111c2" title="Reads a frame in from the audiohook structure.">ast_audiohook_read_frame</a>(&amp;csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>, samples, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899af84e1c36b65319be79e79b03c8f4a360">AST_AUDIOHOOK_DIRECTION_BOTH</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l00378"></a>00378    }
<a name="l00379"></a>00379 
<a name="l00380"></a>00380    <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth-&gt;<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00381"></a>00381 
<a name="l00382"></a>00382    <span class="keywordflow">if</span> (!f)
<a name="l00383"></a>00383       <span class="keywordflow">return</span> 0;
<a name="l00384"></a>00384 
<a name="l00385"></a>00385    <span class="keywordflow">for</span> (cur = f; cur; cur = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(cur, frame_list)) {
<a name="l00386"></a>00386       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, cur)) {
<a name="l00387"></a>00387          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00388"></a>00388          <span class="keywordflow">return</span> -1;
<a name="l00389"></a>00389       }
<a name="l00390"></a>00390 
<a name="l00391"></a>00391       <span class="keywordflow">if</span> (csth-&gt;<a class="code" href="structchanspy__translation__helper.html#a6f8059414f0228f0256115e024eeed4b">fd</a>) {
<a name="l00392"></a>00392          <span class="keywordflow">if</span> (write(csth-&gt;<a class="code" href="structchanspy__translation__helper.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, cur-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, cur-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>) &lt; 0) {
<a name="l00393"></a>00393             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;write() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00394"></a>00394          }
<a name="l00395"></a>00395       }
<a name="l00396"></a>00396    }
<a name="l00397"></a>00397 
<a name="l00398"></a>00398    <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00399"></a>00399 
<a name="l00400"></a>00400    <span class="keywordflow">return</span> 0;
<a name="l00401"></a>00401 }
<a name="l00402"></a>00402 
<a name="l00403"></a><a class="code" href="app__chanspy_8c.html#afeda50fa4679167abb5c5f1008d44e4d">00403</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__generator.html">ast_generator</a> <a class="code" href="app__chanspy_8c.html#afeda50fa4679167abb5c5f1008d44e4d">spygen</a> = {
<a name="l00404"></a>00404    .<a class="code" href="structast__generator.html#a4cdb1ccb0ee9d0a97af1862c625e6bc8">alloc</a> = <a class="code" href="app__chanspy_8c.html#a09a425a040263beb877243aefca430e3">spy_alloc</a>,
<a name="l00405"></a>00405    .release = <a class="code" href="app__chanspy_8c.html#adf3e4b0884895f8eb073920f0dc46b99">spy_release</a>,
<a name="l00406"></a>00406    .generate = <a class="code" href="app__chanspy_8c.html#afa79ad21fa6c452bd84717f9b146d103">spy_generate</a>,
<a name="l00407"></a>00407 };
<a name="l00408"></a>00408 
<a name="l00409"></a><a class="code" href="app__chanspy_8c.html#afcde442f4dc10498f468133227580087">00409</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#afcde442f4dc10498f468133227580087">start_spying</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *spychan_name, <span class="keyword">struct</span> <a class="code" href="structast__audiohook.html">ast_audiohook</a> *audiohook)
<a name="l00410"></a>00410 {
<a name="l00411"></a>00411    <span class="keywordtype">int</span> res = 0;
<a name="l00412"></a>00412    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *peer = NULL;
<a name="l00413"></a>00413 
<a name="l00414"></a>00414    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Attaching %s to %s\n&quot;</span>, spychan_name, chan-&gt;name);
<a name="l00415"></a>00415 
<a name="l00416"></a>00416    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(audiohook, <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951afe01f1fbfa9f1096386a2c7905f2630e">AST_AUDIOHOOK_TRIGGER_SYNC</a> | <a class="code" href="audiohook_8h.html#a6d4c98ade1d3dd2e755ffb52b1106951abffa78ee38fcba6555775cd6b5f46622">AST_AUDIOHOOK_SMALL_QUEUE</a>);
<a name="l00417"></a>00417    res = <a class="code" href="audiohook_8h.html#a94abfad20db137f9d6a33f641d37ac31" title="Attach audiohook to channel.">ast_audiohook_attach</a>(chan, audiohook);
<a name="l00418"></a>00418 
<a name="l00419"></a>00419    <span class="keywordflow">if</span> (!res &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a3215f563ba01d2837d919b6aaeb122ec">AST_FLAG_NBRIDGE</a>) &amp;&amp; (peer = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(chan))) { 
<a name="l00420"></a>00420       <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(peer, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709ab5066a7ae4553197c7e712139b879f15">AST_SOFTHANGUP_UNBRIDGE</a>);
<a name="l00421"></a>00421    }
<a name="l00422"></a>00422    <span class="keywordflow">return</span> res;
<a name="l00423"></a>00423 }
<a name="l00424"></a>00424 
<a name="l00425"></a><a class="code" href="structchanspy__ds.html">00425</a> <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> {
<a name="l00426"></a><a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">00426</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l00427"></a><a class="code" href="structchanspy__ds.html#ac9c5094a313dec13f297dfc88a938dd2">00427</a>    <span class="keywordtype">char</span> <a class="code" href="structchanspy__ds.html#ac9c5094a313dec13f297dfc88a938dd2">unique_id</a>[20];
<a name="l00428"></a><a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">00428</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l00429"></a>00429 };
<a name="l00430"></a>00430 
<a name="l00431"></a><a class="code" href="app__chanspy_8c.html#a83a238c812fa765c7f82b7ce283032b5">00431</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__chanspy_8c.html#a83a238c812fa765c7f82b7ce283032b5">change_spy_mode</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> digit, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *<a class="code" href="structast__channel.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l00432"></a>00432 {
<a name="l00433"></a>00433    <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;4&apos;</span>) {
<a name="l00434"></a>00434       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>);
<a name="l00435"></a>00435       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">OPTION_BARGE</a>);
<a name="l00436"></a>00436    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;5&apos;</span>) {
<a name="l00437"></a>00437       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">OPTION_BARGE</a>);
<a name="l00438"></a>00438       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>);
<a name="l00439"></a>00439    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;6&apos;</span>) {
<a name="l00440"></a>00440       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>);
<a name="l00441"></a>00441       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">OPTION_BARGE</a>);
<a name="l00442"></a>00442    }
<a name="l00443"></a>00443 }
<a name="l00444"></a>00444 
<a name="l00445"></a><a class="code" href="app__chanspy_8c.html#ab3693dfe830e0f8731363bff2baf5f25">00445</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#ab3693dfe830e0f8731363bff2baf5f25">channel_spy</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structchanspy__ds.html">chanspy_ds</a> *spyee_chanspy_ds, 
<a name="l00446"></a>00446    <span class="keywordtype">int</span> *volfactor, <span class="keywordtype">int</span> fd, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *<a class="code" href="structast__channel.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>) 
<a name="l00447"></a>00447 {
<a name="l00448"></a>00448    <span class="keyword">struct </span><a class="code" href="structchanspy__translation__helper.html">chanspy_translation_helper</a> csth;
<a name="l00449"></a>00449    <span class="keywordtype">int</span> running = 0, res, x = 0;
<a name="l00450"></a>00450    <span class="keywordtype">char</span> inp[24] = {0};
<a name="l00451"></a>00451    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00452"></a>00452    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00453"></a>00453    <span class="keyword">struct </span><a class="code" href="structast__silence__generator.html">ast_silence_generator</a> *silgen = NULL;
<a name="l00454"></a>00454    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *spyee = NULL, *spyee_bridge = NULL;
<a name="l00455"></a>00455    <span class="keyword">const</span> <span class="keywordtype">char</span> *spyer_name;
<a name="l00456"></a>00456 
<a name="l00457"></a>00457    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00458"></a>00458    spyer_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;name);
<a name="l00459"></a>00459    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00460"></a>00460 
<a name="l00461"></a>00461    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;spyee_chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00462"></a>00462    <span class="keywordflow">while</span> ((spyee = spyee_chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) &amp;&amp; <a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(spyee)) {
<a name="l00463"></a>00463       <span class="comment">/* avoid a deadlock here, just in case spyee is masqueraded and</span>
<a name="l00464"></a>00464 <span class="comment">       * chanspy_ds_chan_fixup() is called with the channel locked */</span>
<a name="l00465"></a>00465       <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;spyee_chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00466"></a>00466    }
<a name="l00467"></a>00467    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;spyee_chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    <span class="keywordflow">if</span> (!spyee) {
<a name="l00470"></a>00470       <span class="keywordflow">return</span> 0;
<a name="l00471"></a>00471    }
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <span class="comment">/* We now hold the channel lock on spyee */</span>
<a name="l00474"></a>00474 
<a name="l00475"></a>00475    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(spyee)) {
<a name="l00476"></a>00476       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(spyee);
<a name="l00477"></a>00477       <span class="keywordflow">return</span> 0;
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480    name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(spyee-&gt;name);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Spying on channel %s\n&quot;</span>, name);
<a name="l00483"></a>00483    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;ChanSpyStart&quot;</span>,
<a name="l00484"></a>00484          <span class="stringliteral">&quot;SpyerChannel: %s\r\n&quot;</span>
<a name="l00485"></a>00485          <span class="stringliteral">&quot;SpyeeChannel: %s\r\n&quot;</span>,
<a name="l00486"></a>00486          spyer_name, name);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    memset(&amp;csth, 0, <span class="keyword">sizeof</span>(csth));
<a name="l00489"></a>00489    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>, flags, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491    <a class="code" href="audiohook_8h.html#a94bd83e9f3444f406174971481b862c2" title="Initialize an audiohook structure.">ast_audiohook_init</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>, <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0a29865bbf4732a7e78748db47b91e46f5">AST_AUDIOHOOK_TYPE_SPY</a>, <span class="stringliteral">&quot;ChanSpy&quot;</span>);
<a name="l00492"></a>00492 
<a name="l00493"></a>00493    <span class="keywordflow">if</span> (<a class="code" href="app__chanspy_8c.html#afcde442f4dc10498f468133227580087">start_spying</a>(spyee, spyer_name, &amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>)) {
<a name="l00494"></a>00494       <a class="code" href="audiohook_8h.html#a9fa661730d6fa6b9b12e410d66a3437b" title="Destroys an audiohook structure.">ast_audiohook_destroy</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00495"></a>00495       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(spyee);
<a name="l00496"></a>00496       <span class="keywordflow">return</span> 0;
<a name="l00497"></a>00497    }
<a name="l00498"></a>00498 
<a name="l00499"></a>00499    <a class="code" href="audiohook_8h.html#a94bd83e9f3444f406174971481b862c2" title="Initialize an audiohook structure.">ast_audiohook_init</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>, <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>, <span class="stringliteral">&quot;ChanSpy&quot;</span>);
<a name="l00500"></a>00500    <a class="code" href="audiohook_8h.html#a94bd83e9f3444f406174971481b862c2" title="Initialize an audiohook structure.">ast_audiohook_init</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>, <a class="code" href="audiohook_8h.html#abce1d2faae234aa016905215014542b0aecdafbcdb7048512d25cd19089198edd">AST_AUDIOHOOK_TYPE_WHISPER</a>, <span class="stringliteral">&quot;Chanspy&quot;</span>);
<a name="l00501"></a>00501    <span class="keywordflow">if</span> (<a class="code" href="app__chanspy_8c.html#afcde442f4dc10498f468133227580087">start_spying</a>(spyee, spyer_name, &amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>)) {
<a name="l00502"></a>00502       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to attach whisper audiohook to spyee %s. Whisper mode disabled!\n&quot;</span>, spyee-&gt;name);
<a name="l00503"></a>00503    }
<a name="l00504"></a>00504    <span class="keywordflow">if</span> ((spyee_bridge = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(spyee))) {
<a name="l00505"></a>00505       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(spyee_bridge);
<a name="l00506"></a>00506       <span class="keywordflow">if</span> (<a class="code" href="app__chanspy_8c.html#afcde442f4dc10498f468133227580087">start_spying</a>(spyee_bridge, spyer_name, &amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>)) {
<a name="l00507"></a>00507          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to attach barge audiohook on spyee %s. Barge mode disabled!\n&quot;</span>, spyee-&gt;name);
<a name="l00508"></a>00508       }
<a name="l00509"></a>00509       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(spyee_bridge);
<a name="l00510"></a>00510    }
<a name="l00511"></a>00511    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(spyee);
<a name="l00512"></a>00512    spyee = NULL;
<a name="l00513"></a>00513 
<a name="l00514"></a>00514    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00515"></a>00515    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l00516"></a>00516    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00517"></a>00517 
<a name="l00518"></a>00518    csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a> = *volfactor;
<a name="l00519"></a>00519 
<a name="l00520"></a>00520    <span class="keywordflow">if</span> (csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a>) {
<a name="l00521"></a>00521       csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>.<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a> = csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a>;
<a name="l00522"></a>00522       csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>.<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a> = csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a>;
<a name="l00523"></a>00523    }
<a name="l00524"></a>00524 
<a name="l00525"></a>00525    csth.<a class="code" href="structchanspy__translation__helper.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = fd;
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">OPTION_PRIVATE</a>))
<a name="l00528"></a>00528       silgen = <a class="code" href="channel_8h.html#a2a2e0ff24c57491a877cac39cb670024" title="Starts a silence generator on the given channel.">ast_channel_start_silence_generator</a>(chan);
<a name="l00529"></a>00529    <span class="keywordflow">else</span>
<a name="l00530"></a>00530       <a class="code" href="channel_8h.html#a12a58dda74a19f383f6b77cf7fa88b54">ast_activate_generator</a>(chan, &amp;spygen, &amp;csth);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532    <span class="comment">/* We can no longer rely on &apos;spyee&apos; being an actual channel;</span>
<a name="l00533"></a>00533 <span class="comment">      it can be hung up and freed out from under us. However, the</span>
<a name="l00534"></a>00534 <span class="comment">      channel destructor will put NULL into our csth.spy.chan</span>
<a name="l00535"></a>00535 <span class="comment">      field when that happens, so that is our signal that the spyee</span>
<a name="l00536"></a>00536 <span class="comment">      channel has gone away.</span>
<a name="l00537"></a>00537 <span class="comment">   */</span>
<a name="l00538"></a>00538 
<a name="l00539"></a>00539    <span class="comment">/* Note: it is very important that the ast_waitfor() be the first</span>
<a name="l00540"></a>00540 <span class="comment">      condition in this expression, so that if we wait for some period</span>
<a name="l00541"></a>00541 <span class="comment">      of time before receiving a frame from our spying channel, we check</span>
<a name="l00542"></a>00542 <span class="comment">      for hangup on the spied-on channel _after_ knowing that a frame</span>
<a name="l00543"></a>00543 <span class="comment">      has arrived, since the spied-on channel could have gone away while</span>
<a name="l00544"></a>00544 <span class="comment">      we were waiting</span>
<a name="l00545"></a>00545 <span class="comment">   */</span>
<a name="l00546"></a>00546    <span class="keywordflow">while</span> ((res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, -1) &gt; -1) &amp;&amp; csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>.<a class="code" href="structast__audiohook.html#a9c2c1a66c786d5e486ac428388d62e28">status</a> == <a class="code" href="audiohook_8h.html#acf2dd361123daa6446ade7c7ecfe55adabcc7793ac9fbdcaa9e727aacfda27f26">AST_AUDIOHOOK_STATUS_RUNNING</a>) {
<a name="l00547"></a>00547       <span class="keywordflow">if</span> (!(f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan)) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00548"></a>00548          running = -1;
<a name="l00549"></a>00549          <span class="keywordflow">break</span>;
<a name="l00550"></a>00550       }
<a name="l00551"></a>00551 
<a name="l00552"></a>00552       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7e48ee542bd10c6568f132b989e7f2cf">OPTION_BARGE</a>) &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l00553"></a>00553          <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00554"></a>00554          <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>);
<a name="l00555"></a>00555          <a class="code" href="audiohook_8h.html#a3391dbd95c95f041cf14fa30e0f5c73d" title="Writes a frame into the audiohook structure.">ast_audiohook_write_frame</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>, f);
<a name="l00556"></a>00556          <a class="code" href="audiohook_8h.html#a3391dbd95c95f041cf14fa30e0f5c73d" title="Writes a frame into the audiohook structure.">ast_audiohook_write_frame</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>, f);
<a name="l00557"></a>00557          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00558"></a>00558          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>);
<a name="l00559"></a>00559          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00560"></a>00560          <span class="keywordflow">continue</span>;
<a name="l00561"></a>00561       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>) &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l00562"></a>00562          <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00563"></a>00563          <a class="code" href="audiohook_8h.html#a3391dbd95c95f041cf14fa30e0f5c73d" title="Writes a frame into the audiohook structure.">ast_audiohook_write_frame</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>, <a class="code" href="audiohook_8h.html#a34d75d3d5e7418b6a772e3d522a16899a8254a5b3fc181d3fe3f2af892010b586">AST_AUDIOHOOK_DIRECTION_WRITE</a>, f);
<a name="l00564"></a>00564          <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00565"></a>00565          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00566"></a>00566          <span class="keywordflow">continue</span>;
<a name="l00567"></a>00567       }
<a name="l00568"></a>00568       
<a name="l00569"></a>00569       res = (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) ? f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> : 0;
<a name="l00570"></a>00570       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00571"></a>00571       <span class="keywordflow">if</span> (!res)
<a name="l00572"></a>00572          <span class="keywordflow">continue</span>;
<a name="l00573"></a>00573 
<a name="l00574"></a>00574       <span class="keywordflow">if</span> (x == <span class="keyword">sizeof</span>(inp))
<a name="l00575"></a>00575          x = 0;
<a name="l00576"></a>00576 
<a name="l00577"></a>00577       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00578"></a>00578          running = -1;
<a name="l00579"></a>00579          <span class="keywordflow">break</span>;
<a name="l00580"></a>00580       }
<a name="l00581"></a>00581 
<a name="l00582"></a>00582       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a2227204a6dda84506c9ce8fa0b6a6ff7">OPTION_EXIT</a>)) {
<a name="l00583"></a>00583          <span class="keywordtype">char</span> tmp[2];
<a name="l00584"></a>00584          tmp[0] = res;
<a name="l00585"></a>00585          tmp[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00586"></a>00586          <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(chan, exitcontext, tmp, 1)) {
<a name="l00587"></a>00587             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got DTMF %c, goto context %s\n&quot;</span>, tmp[0], exitcontext);
<a name="l00588"></a>00588             <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SPY_CHANNEL&quot;</span>, name);
<a name="l00589"></a>00589             running = -2;
<a name="l00590"></a>00590             <span class="keywordflow">break</span>;
<a name="l00591"></a>00591          } <span class="keywordflow">else</span> {
<a name="l00592"></a>00592             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Exit by single digit did not work in chanspy. Extension %s does not exist in context %s\n&quot;</span>, tmp, exitcontext);
<a name="l00593"></a>00593          }
<a name="l00594"></a>00594       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt;= <span class="charliteral">&apos;0&apos;</span> &amp;&amp; res &lt;= <span class="charliteral">&apos;9&apos;</span>) {
<a name="l00595"></a>00595          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a9bbf649c205bbc6888d5cebdc01d96a8">OPTION_DTMF_SWITCH_MODES</a>)) {
<a name="l00596"></a>00596             <a class="code" href="app__chanspy_8c.html#a83a238c812fa765c7f82b7ce283032b5">change_spy_mode</a>(res, flags);
<a name="l00597"></a>00597          } <span class="keywordflow">else</span> {
<a name="l00598"></a>00598             inp[x++] = res;
<a name="l00599"></a>00599          }
<a name="l00600"></a>00600       }
<a name="l00601"></a>00601 
<a name="l00602"></a>00602       <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l00603"></a>00603          running = 0;
<a name="l00604"></a>00604          <span class="keywordflow">break</span>;
<a name="l00605"></a>00605       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l00606"></a>00606          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(inp)) {
<a name="l00607"></a>00607             running = atoi(inp);
<a name="l00608"></a>00608             <span class="keywordflow">break</span>;
<a name="l00609"></a>00609          }
<a name="l00610"></a>00610 
<a name="l00611"></a>00611          (*volfactor)++;
<a name="l00612"></a>00612          <span class="keywordflow">if</span> (*volfactor &gt; 4)
<a name="l00613"></a>00613             *volfactor = -4;
<a name="l00614"></a>00614          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Setting spy volume on %s to %d\n&quot;</span>, chan-&gt;name, *volfactor);
<a name="l00615"></a>00615 
<a name="l00616"></a>00616          csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a> = *volfactor;
<a name="l00617"></a>00617          csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>.<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#a7cc03ad396ddfb53729e9c02edd14703">read_volume</a> = csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a>;
<a name="l00618"></a>00618          csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>.<a class="code" href="structast__audiohook.html#a9334d7560b8f09767b5202780731fb0f">options</a>.<a class="code" href="structast__audiohook__options.html#aebed8739a031eafdf88cf936abac9388">write_volume</a> = csth.<a class="code" href="structchanspy__translation__helper.html#aca78b78137ee9161853b0118f171bd08">volfactor</a>;
<a name="l00619"></a>00619       }
<a name="l00620"></a>00620    }
<a name="l00621"></a>00621 
<a name="l00622"></a>00622    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">OPTION_PRIVATE</a>))
<a name="l00623"></a>00623       <a class="code" href="channel_8h.html#a6643cbe766a051d2d06750ab5b3e933d" title="Stops a previously-started silence generator on the given channel.">ast_channel_stop_silence_generator</a>(chan, silgen);
<a name="l00624"></a>00624    <span class="keywordflow">else</span>
<a name="l00625"></a>00625       <a class="code" href="channel_8h.html#a7160355005776732fba88cc020f4a45b">ast_deactivate_generator</a>(chan);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00628"></a>00628    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329a668ac945c84f50becaca2a6134e64058">AST_FLAG_END_DTMF_ONLY</a>);
<a name="l00629"></a>00629    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00630"></a>00630 
<a name="l00631"></a>00631    <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00632"></a>00632    <a class="code" href="audiohook_8h.html#a88b9ad3730e7adbc3b396bef4e85b12a" title="Detach audiohook from channel.">ast_audiohook_detach</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00633"></a>00633    <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00634"></a>00634    <a class="code" href="audiohook_8h.html#a9fa661730d6fa6b9b12e410d66a3437b" title="Destroys an audiohook structure.">ast_audiohook_destroy</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a637262446d12a1c4fd17434c29ffdd40">whisper_audiohook</a>);
<a name="l00635"></a>00635    
<a name="l00636"></a>00636    <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>);
<a name="l00637"></a>00637    <a class="code" href="audiohook_8h.html#a88b9ad3730e7adbc3b396bef4e85b12a" title="Detach audiohook from channel.">ast_audiohook_detach</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>);
<a name="l00638"></a>00638    <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>);
<a name="l00639"></a>00639    <a class="code" href="audiohook_8h.html#a9fa661730d6fa6b9b12e410d66a3437b" title="Destroys an audiohook structure.">ast_audiohook_destroy</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#a26ea47f2d8030743c2426d043c606f29">bridge_whisper_audiohook</a>);
<a name="l00640"></a>00640 
<a name="l00641"></a>00641    <a class="code" href="audiohook_8h.html#a6456e346fe813617f13d5bbf7e92db5a" title="Lock an audiohook.">ast_audiohook_lock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00642"></a>00642    <a class="code" href="audiohook_8h.html#a88b9ad3730e7adbc3b396bef4e85b12a" title="Detach audiohook from channel.">ast_audiohook_detach</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00643"></a>00643    <a class="code" href="audiohook_8h.html#aae4ac794c0f7ab8decd713cb9c43acf4" title="Unlock an audiohook.">ast_audiohook_unlock</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00644"></a>00644    <a class="code" href="audiohook_8h.html#a9fa661730d6fa6b9b12e410d66a3437b" title="Destroys an audiohook structure.">ast_audiohook_destroy</a>(&amp;csth.<a class="code" href="structchanspy__translation__helper.html#ad8107cbd6260e60d91f89234a80c0c22">spy_audiohook</a>);
<a name="l00645"></a>00645    
<a name="l00646"></a>00646    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;Done Spying on channel %s\n&quot;</span>, name);
<a name="l00647"></a>00647    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;ChanSpyStop&quot;</span>, <span class="stringliteral">&quot;SpyeeChannel: %s\r\n&quot;</span>, name);
<a name="l00648"></a>00648 
<a name="l00649"></a>00649    <span class="keywordflow">return</span> running;
<a name="l00650"></a>00650 }
<a name="l00651"></a>00651 <span class="comment"></span>
<a name="l00652"></a>00652 <span class="comment">/*!</span>
<a name="l00653"></a>00653 <span class="comment"> * \note This relies on the embedded lock to be recursive, as it may be called</span>
<a name="l00654"></a>00654 <span class="comment"> * due to a call to chanspy_ds_free with the lock held there.</span>
<a name="l00655"></a>00655 <span class="comment"> */</span>
<a name="l00656"></a><a class="code" href="app__chanspy_8c.html#a7224138721268f2b4260464e5bf38112">00656</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__chanspy_8c.html#a7224138721268f2b4260464e5bf38112">chanspy_ds_destroy</a>(<span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>)
<a name="l00657"></a>00657 {
<a name="l00658"></a>00658    <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="structchanspy__ds.html">chanspy_ds</a> = data;
<a name="l00659"></a>00659 
<a name="l00660"></a>00660    <span class="comment">/* Setting chan to be NULL is an atomic operation, but we don&apos;t want this</span>
<a name="l00661"></a>00661 <span class="comment">    * value to change while this lock is held.  The lock is held elsewhere</span>
<a name="l00662"></a>00662 <span class="comment">    * while it performs non-atomic operations with this channel pointer */</span>
<a name="l00663"></a>00663 
<a name="l00664"></a>00664    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00665"></a>00665    chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = NULL;
<a name="l00666"></a>00666    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00667"></a>00667 }
<a name="l00668"></a>00668 
<a name="l00669"></a><a class="code" href="app__chanspy_8c.html#a3c8d3ee3e45d67d9146030b400145ed6">00669</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__chanspy_8c.html#a3c8d3ee3e45d67d9146030b400145ed6">chanspy_ds_chan_fixup</a>(<span class="keywordtype">void</span> *data, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *old_chan, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *new_chan)
<a name="l00670"></a>00670 {
<a name="l00671"></a>00671    <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="structchanspy__ds.html">chanspy_ds</a> = data;
<a name="l00672"></a>00672    
<a name="l00673"></a>00673    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00674"></a>00674    chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = new_chan;
<a name="l00675"></a>00675    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00676"></a>00676 }
<a name="l00677"></a>00677 
<a name="l00678"></a><a class="code" href="app__chanspy_8c.html#aca90eeaa47d5a55e36df7db5431ee8c3">00678</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__datastore__info.html" title="Structure for a data store type.">ast_datastore_info</a> <a class="code" href="app__chanspy_8c.html#aca90eeaa47d5a55e36df7db5431ee8c3">chanspy_ds_info</a> = {
<a name="l00679"></a>00679    .<a class="code" href="structast__datastore__info.html#a763fd8db6bba8fbbbc113ca0d61c47c2">type</a> = <span class="stringliteral">&quot;chanspy&quot;</span>,
<a name="l00680"></a>00680    .destroy = <a class="code" href="app__chanspy_8c.html#a7224138721268f2b4260464e5bf38112">chanspy_ds_destroy</a>,
<a name="l00681"></a>00681    .chan_fixup = <a class="code" href="app__chanspy_8c.html#a3c8d3ee3e45d67d9146030b400145ed6">chanspy_ds_chan_fixup</a>,
<a name="l00682"></a>00682 };
<a name="l00683"></a>00683 
<a name="l00684"></a><a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">00684</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(<span class="keyword">struct</span> <a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="structchanspy__ds.html">chanspy_ds</a>)
<a name="l00685"></a>00685 {
<a name="l00686"></a>00686    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688    <span class="keywordflow">if</span> (!chanspy_ds) {
<a name="l00689"></a>00689       <span class="keywordflow">return</span> NULL;
<a name="l00690"></a>00690    }
<a name="l00691"></a>00691 
<a name="l00692"></a>00692    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00693"></a>00693    <span class="keywordflow">while</span> ((chan = chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)) {
<a name="l00694"></a>00694       <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore;
<a name="l00695"></a>00695 
<a name="l00696"></a>00696       <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(chan)) {
<a name="l00697"></a>00697          <a class="code" href="lock_8h.html#a851106e971b4611a38cb4be8b39d9fcf">DEADLOCK_AVOIDANCE</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00698"></a>00698          <span class="keywordflow">continue</span>;
<a name="l00699"></a>00699       }
<a name="l00700"></a>00700       <span class="keywordflow">if</span> ((datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;chanspy_ds_info, chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#ac9c5094a313dec13f297dfc88a938dd2">unique_id</a>))) {
<a name="l00701"></a>00701          <a class="code" href="channel_8h.html#a1ff1c62b6d50823da93a920575c9c0c9" title="Remove a datastore from a channel.">ast_channel_datastore_remove</a>(chan, datastore);
<a name="l00702"></a>00702          <span class="comment">/* chanspy_ds-&gt;chan is NULL after this call */</span>
<a name="l00703"></a>00703          <a class="code" href="app__chanspy_8c.html#a7224138721268f2b4260464e5bf38112">chanspy_ds_destroy</a>(datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l00704"></a>00704          datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = NULL;
<a name="l00705"></a>00705          <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(datastore);
<a name="l00706"></a>00706       }
<a name="l00707"></a>00707       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00708"></a>00708       <span class="keywordflow">break</span>;
<a name="l00709"></a>00709    }
<a name="l00710"></a>00710    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00711"></a>00711 
<a name="l00712"></a>00712    <span class="keywordflow">return</span> NULL;
<a name="l00713"></a>00713 }
<a name="l00714"></a>00714 <span class="comment"></span>
<a name="l00715"></a>00715 <span class="comment">/*! \note Returns the channel in the chanspy_ds locked as well as the chanspy_ds locked */</span>
<a name="l00716"></a><a class="code" href="app__chanspy_8c.html#a7f78ae4d974cedb4512cf34a09944467">00716</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="app__chanspy_8c.html#a7f78ae4d974cedb4512cf34a09944467">setup_chanspy_ds</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="structchanspy__ds.html">chanspy_ds</a>)
<a name="l00717"></a>00717 {
<a name="l00718"></a>00718    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore = NULL;
<a name="l00719"></a>00719 
<a name="l00720"></a>00720    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722    <span class="keywordflow">if</span> (!(datastore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;chanspy_ds_info, chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#ac9c5094a313dec13f297dfc88a938dd2">unique_id</a>))) {
<a name="l00723"></a>00723       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00724"></a>00724       chanspy_ds = <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(chanspy_ds);
<a name="l00725"></a>00725       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00726"></a>00726       <span class="keywordflow">return</span> NULL;
<a name="l00727"></a>00727    }
<a name="l00728"></a>00728    
<a name="l00729"></a>00729    chanspy_ds-&gt;<a class="code" href="structchanspy__ds.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l00730"></a>00730    datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = chanspy_ds;
<a name="l00731"></a>00731    <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, datastore);
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    <span class="keywordflow">return</span> chanspy_ds;
<a name="l00734"></a>00734 }
<a name="l00735"></a>00735 
<a name="l00736"></a><a class="code" href="app__chanspy_8c.html#a68f6244f622622b43f31ca0bf5ca419f">00736</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="app__chanspy_8c.html#a68f6244f622622b43f31ca0bf5ca419f">next_channel</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>,
<a name="l00737"></a>00737    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *spec,
<a name="l00738"></a>00738    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">struct</span> <a class="code" href="structchanspy__ds.html">chanspy_ds</a> *<a class="code" href="structchanspy__ds.html">chanspy_ds</a>)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *next;
<a name="l00741"></a>00741    <span class="keyword">const</span> <span class="keywordtype">size_t</span> pseudo_len = strlen(<span class="stringliteral">&quot;DAHDI/pseudo&quot;</span>);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743 redo:
<a name="l00744"></a>00744    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(spec))
<a name="l00745"></a>00745       next = <a class="code" href="channel_8h.html#ad0be2bd6da179c80fec23a04c468b872" title="Get channel by name or uniqueid prefix (locks channel).">ast_walk_channel_by_name_prefix_locked</a>(last, spec, strlen(spec));
<a name="l00746"></a>00746    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exten))
<a name="l00747"></a>00747       next = <a class="code" href="channel_8h.html#a4625f1350f67ea98bdc598329a78f1e7" title="Get next channel by exten (and optionally context) and lock it.">ast_walk_channel_by_exten_locked</a>(last, exten, context);
<a name="l00748"></a>00748    <span class="keywordflow">else</span>
<a name="l00749"></a>00749       next = <a class="code" href="channel_8h.html#af287194cacb2db8ac7bb50d16a3a2d60" title="Browse channels in use Browse the channels currently in use.">ast_channel_walk_locked</a>(last);
<a name="l00750"></a>00750 
<a name="l00751"></a>00751    <span class="keywordflow">if</span> (!next)
<a name="l00752"></a>00752       <span class="keywordflow">return</span> NULL;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754    <span class="keywordflow">if</span> (!strncmp(next-&gt;name, <span class="stringliteral">&quot;DAHDI/pseudo&quot;</span>, pseudo_len)) {
<a name="l00755"></a>00755       last = next;
<a name="l00756"></a>00756       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(next);
<a name="l00757"></a>00757       <span class="keywordflow">goto</span> redo;
<a name="l00758"></a>00758    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (next == chan) {
<a name="l00759"></a>00759       last = next;
<a name="l00760"></a>00760       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(next);
<a name="l00761"></a>00761       <span class="keywordflow">goto</span> redo;
<a name="l00762"></a>00762    }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764    <span class="keywordflow">return</span> <a class="code" href="app__chanspy_8c.html#a7f78ae4d974cedb4512cf34a09944467">setup_chanspy_ds</a>(next, chanspy_ds);
<a name="l00765"></a>00765 }
<a name="l00766"></a>00766 
<a name="l00767"></a><a class="code" href="app__chanspy_8c.html#ac81b3ddbfdec5bc96db3e7afb4bfa6c3">00767</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#ac81b3ddbfdec5bc96db3e7afb4bfa6c3">common_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *<a class="code" href="structast__channel.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>,
<a name="l00768"></a>00768    <span class="keywordtype">int</span> volfactor, <span class="keyword">const</span> <span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *mygroup, <span class="keyword">const</span> <span class="keywordtype">char</span> *myenforced,
<a name="l00769"></a>00769    <span class="keyword">const</span> <span class="keywordtype">char</span> *spec, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>,
<a name="l00770"></a>00770    <span class="keyword">const</span> <span class="keywordtype">char</span> *name_context)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772    <span class="keywordtype">char</span> nameprefix[<a class="code" href="app__chanspy_8c.html#ae0cb3deeda0e38de0a56694e69f1a11a">AST_NAME_STRLEN</a>];
<a name="l00773"></a>00773    <span class="keywordtype">char</span> peer_name[<a class="code" href="app__chanspy_8c.html#ae0cb3deeda0e38de0a56694e69f1a11a">AST_NAME_STRLEN</a> + 5];
<a name="l00774"></a>00774    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00775"></a>00775    <span class="keywordtype">signed</span> <span class="keywordtype">char</span> zero_volume = 0;
<a name="l00776"></a>00776    <span class="keywordtype">int</span> waitms;
<a name="l00777"></a>00777    <span class="keywordtype">int</span> res;
<a name="l00778"></a>00778    <span class="keywordtype">char</span> *ptr;
<a name="l00779"></a>00779    <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l00780"></a>00780    <span class="keywordtype">int</span> num_spyed_upon = 1;
<a name="l00781"></a>00781    <span class="keyword">struct </span><a class="code" href="structchanspy__ds.html">chanspy_ds</a> chanspy_ds = { 0, };
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a2227204a6dda84506c9ce8fa0b6a6ff7">OPTION_EXIT</a>)) {
<a name="l00784"></a>00784       <span class="keyword">const</span> <span class="keywordtype">char</span> *c;
<a name="l00785"></a>00785       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l00786"></a>00786       <span class="keywordflow">if</span> ((c = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;SPY_EXIT_CONTEXT&quot;</span>))) {
<a name="l00787"></a>00787          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exitcontext, c, <span class="keyword">sizeof</span>(exitcontext));
<a name="l00788"></a>00788       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>)) {
<a name="l00789"></a>00789          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exitcontext, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="keyword">sizeof</span>(exitcontext));
<a name="l00790"></a>00790       } <span class="keywordflow">else</span> {
<a name="l00791"></a>00791          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exitcontext, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(exitcontext));
<a name="l00792"></a>00792       }
<a name="l00793"></a>00793       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l00794"></a>00794    }
<a name="l00795"></a>00795 
<a name="l00796"></a>00796    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;chanspy_ds.<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l00797"></a>00797 
<a name="l00798"></a>00798    snprintf(chanspy_ds.<a class="code" href="structchanspy__ds.html#ac9c5094a313dec13f297dfc88a938dd2">unique_id</a>, <span class="keyword">sizeof</span>(chanspy_ds.<a class="code" href="structchanspy__ds.html#ac9c5094a313dec13f297dfc88a938dd2">unique_id</a>), <span class="stringliteral">&quot;%d&quot;</span>, <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;next_unique_id_to_use, +1));
<a name="l00799"></a>00799 
<a name="l00800"></a>00800    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l00801"></a>00801       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l00802"></a>00802 
<a name="l00803"></a>00803    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac8135af71631b5eea201e126e7c018de">AST_FLAG_SPYING</a>); <span class="comment">/* so nobody can spy on us while we are spying */</span>
<a name="l00804"></a>00804 
<a name="l00805"></a>00805    waitms = 100;
<a name="l00806"></a>00806 
<a name="l00807"></a>00807    <span class="keywordflow">for</span> (;;) {
<a name="l00808"></a>00808       <span class="keyword">struct </span>chanspy_ds *peer_chanspy_ds = NULL, *next_chanspy_ds = NULL;
<a name="l00809"></a>00809       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *prev = NULL, *peer = NULL;
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>) &amp;&amp; num_spyed_upon) {
<a name="l00812"></a>00812          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, chan-&gt;language);
<a name="l00813"></a>00813          <span class="keywordflow">if</span> (!res)
<a name="l00814"></a>00814             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00815"></a>00815          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00816"></a>00816             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac8135af71631b5eea201e126e7c018de">AST_FLAG_SPYING</a>);
<a name="l00817"></a>00817             <span class="keywordflow">break</span>;
<a name="l00818"></a>00818          }
<a name="l00819"></a>00819          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exitcontext)) {
<a name="l00820"></a>00820             <span class="keywordtype">char</span> tmp[2];
<a name="l00821"></a>00821             tmp[0] = res;
<a name="l00822"></a>00822             tmp[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00823"></a>00823             <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(chan, exitcontext, tmp, 1))
<a name="l00824"></a>00824                <span class="keywordflow">goto</span> exit;
<a name="l00825"></a>00825             <span class="keywordflow">else</span>
<a name="l00826"></a>00826                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Exit by single digit did not work in chanspy. Extension %s does not exist in context %s\n&quot;</span>, tmp, exitcontext);
<a name="l00827"></a>00827          }
<a name="l00828"></a>00828       }
<a name="l00829"></a>00829 
<a name="l00830"></a>00830       res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, waitms);
<a name="l00831"></a>00831       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00832"></a>00832          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac8135af71631b5eea201e126e7c018de">AST_FLAG_SPYING</a>);
<a name="l00833"></a>00833          <span class="keywordflow">break</span>;
<a name="l00834"></a>00834       }
<a name="l00835"></a>00835       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(exitcontext)) {
<a name="l00836"></a>00836          <span class="keywordtype">char</span> tmp[2];
<a name="l00837"></a>00837          tmp[0] = res;
<a name="l00838"></a>00838          tmp[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00839"></a>00839          <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(chan, exitcontext, tmp, 1))
<a name="l00840"></a>00840             <span class="keywordflow">goto</span> exit;
<a name="l00841"></a>00841          <span class="keywordflow">else</span>
<a name="l00842"></a>00842             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Exit by single digit did not work in chanspy. Extension %s does not exist in context %s\n&quot;</span>, tmp, exitcontext);
<a name="l00843"></a>00843       }
<a name="l00844"></a>00844 
<a name="l00845"></a>00845       <span class="comment">/* reset for the next loop around, unless overridden later */</span>
<a name="l00846"></a>00846       waitms = 100;
<a name="l00847"></a>00847       num_spyed_upon = 0;
<a name="l00848"></a>00848 
<a name="l00849"></a>00849       <span class="keywordflow">for</span> (peer_chanspy_ds = <a class="code" href="app__chanspy_8c.html#a68f6244f622622b43f31ca0bf5ca419f">next_channel</a>(chan, prev, spec, exten, context, &amp;chanspy_ds);
<a name="l00850"></a>00850            peer_chanspy_ds;
<a name="l00851"></a>00851           <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds), prev = peer,
<a name="l00852"></a>00852            peer_chanspy_ds = next_chanspy_ds ? next_chanspy_ds : 
<a name="l00853"></a>00853             <a class="code" href="app__chanspy_8c.html#a68f6244f622622b43f31ca0bf5ca419f">next_channel</a>(chan, prev, spec, exten, context, &amp;chanspy_ds), next_chanspy_ds = NULL) {
<a name="l00854"></a>00854          <span class="keywordtype">int</span> igrp = !mygroup;
<a name="l00855"></a>00855          <span class="keywordtype">int</span> ienf = !myenforced;
<a name="l00856"></a>00856          <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l00857"></a>00857 
<a name="l00858"></a>00858          peer = peer_chanspy_ds-&gt;chan;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;peer_chanspy_ds-&gt;lock);
<a name="l00861"></a>00861 
<a name="l00862"></a>00862          <span class="keywordflow">if</span> (peer == prev) {
<a name="l00863"></a>00863             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l00864"></a>00864             <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds);
<a name="l00865"></a>00865             <span class="keywordflow">break</span>;
<a name="l00866"></a>00866          }
<a name="l00867"></a>00867 
<a name="l00868"></a>00868          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l00869"></a>00869             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l00870"></a>00870             <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds);
<a name="l00871"></a>00871             <span class="keywordflow">break</span>;
<a name="l00872"></a>00872          }
<a name="l00873"></a>00873 
<a name="l00874"></a>00874          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a26ff2d51a8148f407f1d27422e8e100b">OPTION_BRIDGED</a>) &amp;&amp; !<a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(peer)) {
<a name="l00875"></a>00875             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l00876"></a>00876             <span class="keywordflow">continue</span>;
<a name="l00877"></a>00877          }
<a name="l00878"></a>00878 
<a name="l00879"></a>00879          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(peer) || <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(peer, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac8135af71631b5eea201e126e7c018de">AST_FLAG_SPYING</a>)) {
<a name="l00880"></a>00880             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l00881"></a>00881             <span class="keywordflow">continue</span>;
<a name="l00882"></a>00882          }
<a name="l00883"></a>00883 
<a name="l00884"></a>00884          <span class="keywordflow">if</span> (mygroup) {
<a name="l00885"></a>00885             <span class="keywordtype">int</span> num_groups = 0;
<a name="l00886"></a>00886             <span class="keywordtype">int</span> num_mygroups = 0;
<a name="l00887"></a>00887             <span class="keywordtype">char</span> dup_group[512];
<a name="l00888"></a>00888             <span class="keywordtype">char</span> dup_mygroup[512];
<a name="l00889"></a>00889             <span class="keywordtype">char</span> *<a class="code" href="structgroups.html">groups</a>[<a class="code" href="app__chanspy_8c.html#a19a50459d318fcd424c0cb03d07a18c8">NUM_SPYGROUPS</a>];
<a name="l00890"></a>00890             <span class="keywordtype">char</span> *mygroups[<a class="code" href="app__chanspy_8c.html#a19a50459d318fcd424c0cb03d07a18c8">NUM_SPYGROUPS</a>];
<a name="l00891"></a>00891             <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structgroup.html">group</a>;
<a name="l00892"></a>00892             <span class="keywordtype">int</span> x;
<a name="l00893"></a>00893             <span class="keywordtype">int</span> y;
<a name="l00894"></a>00894             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dup_mygroup, mygroup, <span class="keyword">sizeof</span>(dup_mygroup));
<a name="l00895"></a>00895             num_mygroups = <a class="code" href="app_8h.html#a588ed7395623b8493efcf229024af9c5">ast_app_separate_args</a>(dup_mygroup, <span class="charliteral">&apos;:&apos;</span>, mygroups,
<a name="l00896"></a>00896                <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(mygroups));
<a name="l00897"></a>00897 
<a name="l00898"></a>00898             <span class="keywordflow">if</span> ((group = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(peer, <span class="stringliteral">&quot;SPYGROUP&quot;</span>))) {
<a name="l00899"></a>00899                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(dup_group, group, <span class="keyword">sizeof</span>(dup_group));
<a name="l00900"></a>00900                num_groups = <a class="code" href="app_8h.html#a588ed7395623b8493efcf229024af9c5">ast_app_separate_args</a>(dup_group, <span class="charliteral">&apos;:&apos;</span>, groups,
<a name="l00901"></a>00901                   <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(groups));
<a name="l00902"></a>00902             }
<a name="l00903"></a>00903 
<a name="l00904"></a>00904             <span class="keywordflow">for</span> (y = 0; y &lt; num_mygroups; y++) {
<a name="l00905"></a>00905                <span class="keywordflow">for</span> (x = 0; x &lt; num_groups; x++) {
<a name="l00906"></a>00906                   <span class="keywordflow">if</span> (!strcmp(mygroups[y], groups[x])) {
<a name="l00907"></a>00907                      igrp = 1;
<a name="l00908"></a>00908                      <span class="keywordflow">break</span>;
<a name="l00909"></a>00909                   }
<a name="l00910"></a>00910                }
<a name="l00911"></a>00911             }
<a name="l00912"></a>00912          }
<a name="l00913"></a>00913 
<a name="l00914"></a>00914          <span class="keywordflow">if</span> (!igrp) {
<a name="l00915"></a>00915             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l00916"></a>00916             <span class="keywordflow">continue</span>;
<a name="l00917"></a>00917          }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919          <span class="keywordflow">if</span> (myenforced) {
<a name="l00920"></a>00920             <span class="keywordtype">char</span> <a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>[<a class="code" href="channel_8h.html#ab57c278099ea5f8d7cedbb41eba58b56">AST_CHANNEL_NAME</a> + 3];
<a name="l00921"></a>00921             <span class="keywordtype">char</span> buffer[512];
<a name="l00922"></a>00922             <span class="keywordtype">char</span> *end;
<a name="l00923"></a>00923 
<a name="l00924"></a>00924             snprintf(buffer, <span class="keyword">sizeof</span>(buffer) - 1, <span class="stringliteral">&quot;:%s:&quot;</span>, myenforced);
<a name="l00925"></a>00925 
<a name="l00926"></a>00926             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ext + 1, peer-&gt;name, <span class="keyword">sizeof</span>(ext) - 1);
<a name="l00927"></a>00927             <span class="keywordflow">if</span> ((end = strchr(ext, <span class="charliteral">&apos;-&apos;</span>))) {
<a name="l00928"></a>00928                *end++ = <span class="charliteral">&apos;:&apos;</span>;
<a name="l00929"></a>00929                *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00930"></a>00930             }
<a name="l00931"></a>00931 
<a name="l00932"></a>00932             ext[0] = <span class="charliteral">&apos;:&apos;</span>;
<a name="l00933"></a>00933 
<a name="l00934"></a>00934             <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(buffer, ext)) {
<a name="l00935"></a>00935                ienf = 1;
<a name="l00936"></a>00936             }
<a name="l00937"></a>00937          }
<a name="l00938"></a>00938 
<a name="l00939"></a>00939          <span class="keywordflow">if</span> (!ienf) {
<a name="l00940"></a>00940             <span class="keywordflow">continue</span>;
<a name="l00941"></a>00941          }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943          strcpy(peer_name, <span class="stringliteral">&quot;spy-&quot;</span>);
<a name="l00944"></a>00944          strncat(peer_name, peer-&gt;name, <a class="code" href="app__chanspy_8c.html#ae0cb3deeda0e38de0a56694e69f1a11a">AST_NAME_STRLEN</a> - 4 - 1);
<a name="l00945"></a>00945          ptr = strchr(peer_name, <span class="charliteral">&apos;/&apos;</span>);
<a name="l00946"></a>00946          *ptr++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00947"></a>00947          ptr = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;ptr, <span class="stringliteral">&quot;-&quot;</span>);
<a name="l00948"></a>00948 
<a name="l00949"></a>00949          <span class="keywordflow">for</span> (s = peer_name; s &lt; ptr; s++)
<a name="l00950"></a>00950             *s = tolower(*s);
<a name="l00951"></a>00951          <span class="comment">/* We have to unlock the peer channel here to avoid a deadlock.</span>
<a name="l00952"></a>00952 <span class="comment">          * So, when we need to dereference it again, we have to lock the </span>
<a name="l00953"></a>00953 <span class="comment">          * datastore and get the pointer from there to see if the channel </span>
<a name="l00954"></a>00954 <span class="comment">          * is still valid. */</span>
<a name="l00955"></a>00955          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(peer);
<a name="l00956"></a>00956 
<a name="l00957"></a>00957          <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a694d0dbcb8cf31b3fd89309101e2eb65">OPTION_QUIET</a>)) {
<a name="l00958"></a>00958             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">OPTION_NAME</a>)) {
<a name="l00959"></a>00959                <span class="keyword">const</span> <span class="keywordtype">char</span> *local_context = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(name_context, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l00960"></a>00960                <span class="keyword">const</span> <span class="keywordtype">char</span> *local_mailbox = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(mailbox, ptr);
<a name="l00961"></a>00961                res = <a class="code" href="app_8h.html#a3c444cef1f29205f033db05bfeee8298" title="Given a mailbox and context, play that mailbox owner&amp;#39;s name to the channel specified...">ast_app_sayname</a>(chan, local_mailbox, local_context);
<a name="l00962"></a>00962             }
<a name="l00963"></a>00963             <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">OPTION_NAME</a>) || res &lt; 0) {
<a name="l00964"></a>00964                <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7abea03a976d4fb445b5b5e33f575801da">OPTION_NOTECH</a>)) {
<a name="l00965"></a>00965                   <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(peer_name, NULL, NULL) != -1) {
<a name="l00966"></a>00966                      res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, peer_name, chan-&gt;language);
<a name="l00967"></a>00967                      <span class="keywordflow">if</span> (!res) {
<a name="l00968"></a>00968                         res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l00969"></a>00969                      }
<a name="l00970"></a>00970                      <span class="keywordflow">if</span> (res) {
<a name="l00971"></a>00971                         <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds);
<a name="l00972"></a>00972                         <span class="keywordflow">break</span>;
<a name="l00973"></a>00973                      }
<a name="l00974"></a>00974                   } <span class="keywordflow">else</span> {
<a name="l00975"></a>00975                      res = <a class="code" href="say_8h.html#a5a2049959851520fd46c332fc127e9a5">ast_say_character_str</a>(chan, peer_name, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l00976"></a>00976                   }
<a name="l00977"></a>00977                }
<a name="l00978"></a>00978                <span class="keywordflow">if</span> ((num = atoi(ptr)))
<a name="l00979"></a>00979                   <a class="code" href="say_8h.html#a7cf9dcf6ae6fcedb7752d0deac683b3b" title="says digits">ast_say_digits</a>(chan, atoi(ptr), <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l00980"></a>00980             }
<a name="l00981"></a>00981          }
<a name="l00982"></a>00982 
<a name="l00983"></a>00983          res = <a class="code" href="app__chanspy_8c.html#ab3693dfe830e0f8731363bff2baf5f25">channel_spy</a>(chan, peer_chanspy_ds, &amp;volfactor, fd, flags, exitcontext);
<a name="l00984"></a>00984          num_spyed_upon++; 
<a name="l00985"></a>00985 
<a name="l00986"></a>00986          <span class="keywordflow">if</span> (res == -1) {
<a name="l00987"></a>00987             <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds);
<a name="l00988"></a>00988             <span class="keywordflow">goto</span> exit;
<a name="l00989"></a>00989          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -2) {
<a name="l00990"></a>00990             res = 0;
<a name="l00991"></a>00991             <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds);
<a name="l00992"></a>00992             <span class="keywordflow">goto</span> exit;
<a name="l00993"></a>00993          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 1 &amp;&amp; spec) {
<a name="l00994"></a>00994             <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *next;
<a name="l00995"></a>00995 
<a name="l00996"></a>00996             snprintf(nameprefix, <a class="code" href="app__chanspy_8c.html#ae0cb3deeda0e38de0a56694e69f1a11a">AST_NAME_STRLEN</a>, <span class="stringliteral">&quot;%s/%d&quot;</span>, spec, res);
<a name="l00997"></a>00997 
<a name="l00998"></a>00998             <span class="keywordflow">if</span> ((next = <a class="code" href="channel_8h.html#a67239a95ab93867fb9da5a8b20281224" title="Get channel by name or uniqueid prefix (locks channel).">ast_get_channel_by_name_prefix_locked</a>(nameprefix, strlen(nameprefix)))) {
<a name="l00999"></a>00999                peer_chanspy_ds = <a class="code" href="app__chanspy_8c.html#a4edb864c73604e7bc82ea083d14ce919">chanspy_ds_free</a>(peer_chanspy_ds);
<a name="l01000"></a>01000                next_chanspy_ds = <a class="code" href="app__chanspy_8c.html#a7f78ae4d974cedb4512cf34a09944467">setup_chanspy_ds</a>(next, &amp;chanspy_ds);
<a name="l01001"></a>01001             } <span class="keywordflow">else</span> {
<a name="l01002"></a>01002                <span class="comment">/* stay on this channel, if it is still valid */</span>
<a name="l01003"></a>01003 
<a name="l01004"></a>01004                <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;peer_chanspy_ds-&gt;lock);
<a name="l01005"></a>01005                <span class="keywordflow">if</span> (peer_chanspy_ds-&gt;chan) {
<a name="l01006"></a>01006                   <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(peer_chanspy_ds-&gt;chan);
<a name="l01007"></a>01007                   next_chanspy_ds = peer_chanspy_ds;
<a name="l01008"></a>01008                   peer_chanspy_ds = NULL;
<a name="l01009"></a>01009                } <span class="keywordflow">else</span> {
<a name="l01010"></a>01010                   <span class="comment">/* the channel is gone */</span>
<a name="l01011"></a>01011                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;peer_chanspy_ds-&gt;lock);
<a name="l01012"></a>01012                   next_chanspy_ds = NULL;
<a name="l01013"></a>01013                }
<a name="l01014"></a>01014             }
<a name="l01015"></a>01015 
<a name="l01016"></a>01016             peer = NULL;
<a name="l01017"></a>01017          }
<a name="l01018"></a>01018       }
<a name="l01019"></a>01019       <span class="keywordflow">if</span> (res == -1 || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan))
<a name="l01020"></a>01020          <span class="keywordflow">break</span>;
<a name="l01021"></a>01021    }
<a name="l01022"></a>01022 exit:
<a name="l01023"></a>01023 
<a name="l01024"></a>01024    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(chan, <a class="code" href="channel_8h.html#adbaf9202177df73e6880eab6e6aab329ac8135af71631b5eea201e126e7c018de">AST_FLAG_SPYING</a>);
<a name="l01025"></a>01025 
<a name="l01026"></a>01026    <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#abcf55626860f173284cafa474946d9b2">AST_OPTION_TXGAIN</a>, &amp;zero_volume, <span class="keyword">sizeof</span>(zero_volume), 0);
<a name="l01027"></a>01027 
<a name="l01028"></a>01028    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;chanspy_ds.<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01029"></a>01029    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;chanspy_ds.<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01030"></a>01030    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;chanspy_ds.<a class="code" href="structchanspy__ds.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>);
<a name="l01031"></a>01031 
<a name="l01032"></a>01032    <span class="keywordflow">return</span> res;
<a name="l01033"></a>01033 }
<a name="l01034"></a>01034 
<a name="l01035"></a><a class="code" href="app__chanspy_8c.html#a0aa5b64722ce1a4002100e00d09eafca">01035</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#a0aa5b64722ce1a4002100e00d09eafca">chanspy_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>)
<a name="l01036"></a>01036 {
<a name="l01037"></a>01037    <span class="keywordtype">char</span> *myenforced = NULL;
<a name="l01038"></a>01038    <span class="keywordtype">char</span> *mygroup = NULL;
<a name="l01039"></a>01039    <span class="keywordtype">char</span> *recbase = NULL;
<a name="l01040"></a>01040    <span class="keywordtype">int</span> fd = 0;
<a name="l01041"></a>01041    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags;
<a name="l01042"></a>01042    <span class="keywordtype">int</span> oldwf = 0;
<a name="l01043"></a>01043    <span class="keywordtype">int</span> volfactor = 0;
<a name="l01044"></a>01044    <span class="keywordtype">int</span> res;
<a name="l01045"></a>01045    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a> = NULL;
<a name="l01046"></a>01046    <span class="keywordtype">char</span> *name_context = NULL;
<a name="l01047"></a>01047    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l01048"></a>01048       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(spec);
<a name="l01049"></a>01049       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l01050"></a>01050    );
<a name="l01051"></a>01051    <span class="keywordtype">char</span> *opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>];
<a name="l01052"></a>01052 
<a name="l01053"></a>01053    data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l01054"></a>01054    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056    <span class="keywordflow">if</span> (args.spec &amp;&amp; !strcmp(args.spec, <span class="stringliteral">&quot;all&quot;</span>))
<a name="l01057"></a>01057       args.spec = NULL;
<a name="l01058"></a>01058 
<a name="l01059"></a>01059    <span class="keywordflow">if</span> (args.options) {
<a name="l01060"></a>01060       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(spy_opts, &amp;flags, opts, args.options);
<a name="l01061"></a>01061       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7ebf68220b9eb6f2a0b42c992485adfc">OPTION_GROUP</a>))
<a name="l01062"></a>01062          mygroup = opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5afce708639b9a3a5d208d694724f0dbd1">OPT_ARG_GROUP</a>];
<a name="l01063"></a>01063 
<a name="l01064"></a>01064       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a376d099a3022b28797087ce8ccfc3140">OPTION_RECORD</a>) &amp;&amp;
<a name="l01065"></a>01065          !(recbase = opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a386501e86d89afb66489abdeb3c4ad59">OPT_ARG_RECORD</a>]))
<a name="l01066"></a>01066          recbase = <span class="stringliteral">&quot;chanspy&quot;</span>;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7afc2bb7ff4e37e40134e58603c9160898">OPTION_VOLUME</a>) &amp;&amp; opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ac31114b0c2250979c4021b4170e046ca">OPT_ARG_VOLUME</a>]) {
<a name="l01069"></a>01069          <span class="keywordtype">int</span> vol;
<a name="l01070"></a>01070 
<a name="l01071"></a>01071          <span class="keywordflow">if</span> ((sscanf(opts[OPT_ARG_VOLUME], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;vol) != 1) || (vol &gt; 4) || (vol &lt; -4))
<a name="l01072"></a>01072             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Volume factor must be a number between -4 and 4\n&quot;</span>);
<a name="l01073"></a>01073          <span class="keywordflow">else</span>
<a name="l01074"></a>01074             volfactor = vol;
<a name="l01075"></a>01075       }
<a name="l01076"></a>01076 
<a name="l01077"></a>01077       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">OPTION_PRIVATE</a>))
<a name="l01078"></a>01078          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>);
<a name="l01079"></a>01079 
<a name="l01080"></a>01080       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0e97e0e983231509740f1f3b590f4c13">OPTION_ENFORCED</a>))
<a name="l01081"></a>01081          myenforced = opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ad1315938fca1334bc1f4590a0ac718eb">OPT_ARG_ENFORCED</a>];
<a name="l01082"></a>01082       
<a name="l01083"></a>01083       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">OPTION_NAME</a>)) {
<a name="l01084"></a>01084          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a828cbbd9db97b9076ac75637f462d729">OPT_ARG_NAME</a>])) {
<a name="l01085"></a>01085             <span class="keywordtype">char</span> *delimiter;
<a name="l01086"></a>01086             <span class="keywordflow">if</span> ((delimiter = strchr(opts[OPT_ARG_NAME], <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l01087"></a>01087                mailbox = opts[OPT_ARG_NAME];
<a name="l01088"></a>01088                *delimiter++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01089"></a>01089                name_context = delimiter;
<a name="l01090"></a>01090             } <span class="keywordflow">else</span> {
<a name="l01091"></a>01091                mailbox = opts[OPT_ARG_NAME];
<a name="l01092"></a>01092             }
<a name="l01093"></a>01093          }
<a name="l01094"></a>01094       }
<a name="l01095"></a>01095 
<a name="l01096"></a>01096 
<a name="l01097"></a>01097    } <span class="keywordflow">else</span>
<a name="l01098"></a>01098       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;flags, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01099"></a>01099 
<a name="l01100"></a>01100    oldwf = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l01101"></a>01101    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) &lt; 0) {
<a name="l01102"></a>01102       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could Not Set Write Format.\n&quot;</span>);
<a name="l01103"></a>01103       <span class="keywordflow">return</span> -1;
<a name="l01104"></a>01104    }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106    <span class="keywordflow">if</span> (recbase) {
<a name="l01107"></a>01107       <span class="keywordtype">char</span> filename[PATH_MAX];
<a name="l01108"></a>01108 
<a name="l01109"></a>01109       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/%s.%d.raw&quot;</span>, <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, recbase, (<span class="keywordtype">int</span>) time(NULL));
<a name="l01110"></a>01110       <span class="keywordflow">if</span> ((fd = open(filename, O_CREAT | O_WRONLY | O_TRUNC, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>)) &lt;= 0) {
<a name="l01111"></a>01111          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open &apos;%s&apos; for recording\n&quot;</span>, filename);
<a name="l01112"></a>01112          fd = 0;
<a name="l01113"></a>01113       }
<a name="l01114"></a>01114    }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116    res = <a class="code" href="app__chanspy_8c.html#ac81b3ddbfdec5bc96db3e7afb4bfa6c3">common_exec</a>(chan, &amp;flags, volfactor, fd, mygroup, myenforced, args.spec, NULL, NULL, mailbox, name_context);
<a name="l01117"></a>01117 
<a name="l01118"></a>01118    <span class="keywordflow">if</span> (fd)
<a name="l01119"></a>01119       close(fd);
<a name="l01120"></a>01120 
<a name="l01121"></a>01121    <span class="keywordflow">if</span> (oldwf &amp;&amp; <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, oldwf) &lt; 0)
<a name="l01122"></a>01122       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could Not Set Write Format.\n&quot;</span>);
<a name="l01123"></a>01123 
<a name="l01124"></a>01124    <span class="keywordflow">return</span> res;
<a name="l01125"></a>01125 }
<a name="l01126"></a>01126 
<a name="l01127"></a><a class="code" href="app__chanspy_8c.html#ae119f65b41980ba4795388e411d0ea71">01127</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#ae119f65b41980ba4795388e411d0ea71">extenspy_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l01128"></a>01128 {
<a name="l01129"></a>01129    <span class="keywordtype">char</span> *ptr, *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = NULL;
<a name="l01130"></a>01130    <span class="keywordtype">char</span> *mygroup = NULL;
<a name="l01131"></a>01131    <span class="keywordtype">char</span> *recbase = NULL;
<a name="l01132"></a>01132    <span class="keywordtype">int</span> fd = 0;
<a name="l01133"></a>01133    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags;
<a name="l01134"></a>01134    <span class="keywordtype">int</span> oldwf = 0;
<a name="l01135"></a>01135    <span class="keywordtype">int</span> volfactor = 0;
<a name="l01136"></a>01136    <span class="keywordtype">int</span> res;
<a name="l01137"></a>01137    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a> = NULL;
<a name="l01138"></a>01138    <span class="keywordtype">char</span> *name_context = NULL;
<a name="l01139"></a>01139    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l01140"></a>01140       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01141"></a>01141       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l01142"></a>01142    );
<a name="l01143"></a>01143 
<a name="l01144"></a>01144    data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l01145"></a>01145 
<a name="l01146"></a>01146    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, data);
<a name="l01147"></a>01147    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.context) &amp;&amp; (ptr = strchr(args.context, <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l01148"></a>01148       exten = args.context;
<a name="l01149"></a>01149       *ptr++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01150"></a>01150       args.context = ptr;
<a name="l01151"></a>01151    }
<a name="l01152"></a>01152 
<a name="l01153"></a>01153    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.context))
<a name="l01154"></a>01154       args.context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01155"></a>01155 
<a name="l01156"></a>01156    <span class="keywordflow">if</span> (args.options) {
<a name="l01157"></a>01157       <span class="keywordtype">char</span> *opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>];
<a name="l01158"></a>01158 
<a name="l01159"></a>01159       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(spy_opts, &amp;flags, opts, args.options);
<a name="l01160"></a>01160       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a7ebf68220b9eb6f2a0b42c992485adfc">OPTION_GROUP</a>))
<a name="l01161"></a>01161          mygroup = opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5afce708639b9a3a5d208d694724f0dbd1">OPT_ARG_GROUP</a>];
<a name="l01162"></a>01162 
<a name="l01163"></a>01163       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a376d099a3022b28797087ce8ccfc3140">OPTION_RECORD</a>) &amp;&amp;
<a name="l01164"></a>01164          !(recbase = opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a386501e86d89afb66489abdeb3c4ad59">OPT_ARG_RECORD</a>]))
<a name="l01165"></a>01165          recbase = <span class="stringliteral">&quot;chanspy&quot;</span>;
<a name="l01166"></a>01166 
<a name="l01167"></a>01167       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7afc2bb7ff4e37e40134e58603c9160898">OPTION_VOLUME</a>) &amp;&amp; opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5ac31114b0c2250979c4021b4170e046ca">OPT_ARG_VOLUME</a>]) {
<a name="l01168"></a>01168          <span class="keywordtype">int</span> vol;
<a name="l01169"></a>01169 
<a name="l01170"></a>01170          <span class="keywordflow">if</span> ((sscanf(opts[OPT_ARG_VOLUME], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;vol) != 1) || (vol &gt; 4) || (vol &lt; -4))
<a name="l01171"></a>01171             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Volume factor must be a number between -4 and 4\n&quot;</span>);
<a name="l01172"></a>01172          <span class="keywordflow">else</span>
<a name="l01173"></a>01173             volfactor = vol;
<a name="l01174"></a>01174       }
<a name="l01175"></a>01175 
<a name="l01176"></a>01176       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a0a927a7c9a0f0509ed7af1ce81593e1b">OPTION_PRIVATE</a>))
<a name="l01177"></a>01177          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a53e691fea12f334b66acd51665966eca">OPTION_WHISPER</a>);
<a name="l01178"></a>01178 
<a name="l01179"></a>01179       
<a name="l01180"></a>01180       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__chanspy_8c.html#adf764cbdea00d65edcd07bb9953ad2b7a5993be02d63f8b41be7d0d8faf24ad61">OPTION_NAME</a>)) {
<a name="l01181"></a>01181          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5a828cbbd9db97b9076ac75637f462d729">OPT_ARG_NAME</a>])) {
<a name="l01182"></a>01182             <span class="keywordtype">char</span> *delimiter;
<a name="l01183"></a>01183             <span class="keywordflow">if</span> ((delimiter = strchr(opts[OPT_ARG_NAME], <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l01184"></a>01184                mailbox = opts[OPT_ARG_NAME];
<a name="l01185"></a>01185                *delimiter++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01186"></a>01186                name_context = delimiter;
<a name="l01187"></a>01187             } <span class="keywordflow">else</span> {
<a name="l01188"></a>01188                mailbox = opts[OPT_ARG_NAME];
<a name="l01189"></a>01189             }
<a name="l01190"></a>01190          }
<a name="l01191"></a>01191       }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193    } <span class="keywordflow">else</span>
<a name="l01194"></a>01194       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;flags, <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);
<a name="l01195"></a>01195 
<a name="l01196"></a>01196    oldwf = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>;
<a name="l01197"></a>01197    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) &lt; 0) {
<a name="l01198"></a>01198       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could Not Set Write Format.\n&quot;</span>);
<a name="l01199"></a>01199       <span class="keywordflow">return</span> -1;
<a name="l01200"></a>01200    }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202    <span class="keywordflow">if</span> (recbase) {
<a name="l01203"></a>01203       <span class="keywordtype">char</span> filename[PATH_MAX];
<a name="l01204"></a>01204 
<a name="l01205"></a>01205       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s/%s.%d.raw&quot;</span>, <a class="code" href="paths_8h.html#ae8b54021bf362dc04d5783fa3b4b4abd">ast_config_AST_MONITOR_DIR</a>, recbase, (<span class="keywordtype">int</span>) time(NULL));
<a name="l01206"></a>01206       <span class="keywordflow">if</span> ((fd = open(filename, O_CREAT | O_WRONLY | O_TRUNC, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>)) &lt;= 0) {
<a name="l01207"></a>01207          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot open &apos;%s&apos; for recording\n&quot;</span>, filename);
<a name="l01208"></a>01208          fd = 0;
<a name="l01209"></a>01209       }
<a name="l01210"></a>01210    }
<a name="l01211"></a>01211 
<a name="l01212"></a>01212 
<a name="l01213"></a>01213    res = <a class="code" href="app__chanspy_8c.html#ac81b3ddbfdec5bc96db3e7afb4bfa6c3">common_exec</a>(chan, &amp;flags, volfactor, fd, mygroup, NULL, NULL, exten, args.context, mailbox, name_context);
<a name="l01214"></a>01214 
<a name="l01215"></a>01215    <span class="keywordflow">if</span> (fd)
<a name="l01216"></a>01216       close(fd);
<a name="l01217"></a>01217 
<a name="l01218"></a>01218    <span class="keywordflow">if</span> (oldwf &amp;&amp; <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, oldwf) &lt; 0)
<a name="l01219"></a>01219       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could Not Set Write Format.\n&quot;</span>);
<a name="l01220"></a>01220 
<a name="l01221"></a>01221    <span class="keywordflow">return</span> res;
<a name="l01222"></a>01222 }
<a name="l01223"></a>01223 
<a name="l01224"></a><a class="code" href="app__chanspy_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01224</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01225"></a>01225 {
<a name="l01226"></a>01226    <span class="keywordtype">int</span> res = 0;
<a name="l01227"></a>01227 
<a name="l01228"></a>01228    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_chan);
<a name="l01229"></a>01229    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app_ext);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231    <span class="keywordflow">return</span> res;
<a name="l01232"></a>01232 }
<a name="l01233"></a>01233 
<a name="l01234"></a><a class="code" href="app__chanspy_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01234</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__chanspy_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01235"></a>01235 {
<a name="l01236"></a>01236    <span class="keywordtype">int</span> res = 0;
<a name="l01237"></a>01237 
<a name="l01238"></a>01238    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_chan, <a class="code" href="app__chanspy_8c.html#a0aa5b64722ce1a4002100e00d09eafca">chanspy_exec</a>);
<a name="l01239"></a>01239    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app_ext, <a class="code" href="app__chanspy_8c.html#ae119f65b41980ba4795388e411d0ea71">extenspy_exec</a>);
<a name="l01240"></a>01240 
<a name="l01241"></a>01241    <span class="keywordflow">return</span> res;
<a name="l01242"></a>01242 }
<a name="l01243"></a>01243 
<a name="l01244"></a>01244 <a class="code" href="module_8h.html#a70ea6b2dde349dfaae4d21d93b9a5683">AST_MODULE_INFO_STANDARD</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <span class="stringliteral">&quot;Listen to the audio of an active channel&quot;</span>);
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:24 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
