<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:27 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_voicemail.c</h1><a href="app__voicemail_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Comedian Mail - Voicemail System</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \extref Unixodbc - http://www.unixodbc.org</span>
<a name="l00026"></a>00026 <span class="comment"> * \extref A source distribution of University of Washington&apos;s IMAP</span>
<a name="l00027"></a>00027 <span class="comment">c-client (http://www.washington.edu/imap/</span>
<a name="l00028"></a>00028 <span class="comment"> * </span>
<a name="l00029"></a>00029 <span class="comment"> * \par See also</span>
<a name="l00030"></a>00030 <span class="comment"> * \arg \ref Config_vm</span>
<a name="l00031"></a>00031 <span class="comment"> * \note For information about voicemail IMAP storage, read doc/imapstorage.txt</span>
<a name="l00032"></a>00032 <span class="comment"> * \ingroup applications</span>
<a name="l00033"></a>00033 <span class="comment"> * \note This module requires res_adsi to load. This needs to be optional</span>
<a name="l00034"></a>00034 <span class="comment"> * during compilation.</span>
<a name="l00035"></a>00035 <span class="comment"> *</span>
<a name="l00036"></a>00036 <span class="comment"> *</span>
<a name="l00037"></a>00037 <span class="comment"> *</span>
<a name="l00038"></a>00038 <span class="comment"> * \note  This file is now almost impossible to work with, due to all \#ifdefs.</span>
<a name="l00039"></a>00039 <span class="comment"> *        Feels like the database code before realtime. Someone - please come up</span>
<a name="l00040"></a>00040 <span class="comment"> *        with a plan to clean this up.</span>
<a name="l00041"></a>00041 <span class="comment"> */</span>
<a name="l00042"></a>00042 
<a name="l00043"></a>00043 <span class="comment">/*** MAKEOPTS</span>
<a name="l00044"></a>00044 <span class="comment">&lt;category name=&quot;MENUSELECT_OPTS_app_voicemail&quot; displayname=&quot;Voicemail Build Options&quot; positive_output=&quot;yes&quot; remove_on_change=&quot;apps/app_voicemail.o apps/app_voicemail.so apps/app_directory.o apps/app_directory.so&quot;&gt;</span>
<a name="l00045"></a>00045 <span class="comment">   &lt;member name=&quot;FILE_STORAGE&quot; displayname=&quot;Storage of Voicemail using filesystem&quot;&gt;</span>
<a name="l00046"></a>00046 <span class="comment">      &lt;conflict&gt;ODBC_STORAGE&lt;/conflict&gt;</span>
<a name="l00047"></a>00047 <span class="comment">      &lt;conflict&gt;IMAP_STORAGE&lt;/conflict&gt;</span>
<a name="l00048"></a>00048 <span class="comment">      &lt;defaultenabled&gt;yes&lt;/defaultenabled&gt;</span>
<a name="l00049"></a>00049 <span class="comment">   &lt;/member&gt;</span>
<a name="l00050"></a>00050 <span class="comment">   &lt;member name=&quot;ODBC_STORAGE&quot; displayname=&quot;Storage of Voicemail using ODBC&quot;&gt;</span>
<a name="l00051"></a>00051 <span class="comment">      &lt;depend&gt;generic_odbc&lt;/depend&gt;</span>
<a name="l00052"></a>00052 <span class="comment">      &lt;depend&gt;ltdl&lt;/depend&gt;</span>
<a name="l00053"></a>00053 <span class="comment">      &lt;conflict&gt;IMAP_STORAGE&lt;/conflict&gt;</span>
<a name="l00054"></a>00054 <span class="comment">      &lt;conflict&gt;FILE_STORAGE&lt;/conflict&gt;</span>
<a name="l00055"></a>00055 <span class="comment">      &lt;defaultenabled&gt;no&lt;/defaultenabled&gt;</span>
<a name="l00056"></a>00056 <span class="comment">   &lt;/member&gt;</span>
<a name="l00057"></a>00057 <span class="comment">   &lt;member name=&quot;IMAP_STORAGE&quot; displayname=&quot;Storage of Voicemail using IMAP4&quot;&gt;</span>
<a name="l00058"></a>00058 <span class="comment">      &lt;depend&gt;imap_tk&lt;/depend&gt;</span>
<a name="l00059"></a>00059 <span class="comment">      &lt;conflict&gt;ODBC_STORAGE&lt;/conflict&gt;</span>
<a name="l00060"></a>00060 <span class="comment">      &lt;conflict&gt;FILE_STORAGE&lt;/conflict&gt;</span>
<a name="l00061"></a>00061 <span class="comment">      &lt;use&gt;openssl&lt;/use&gt;</span>
<a name="l00062"></a>00062 <span class="comment">      &lt;defaultenabled&gt;no&lt;/defaultenabled&gt;</span>
<a name="l00063"></a>00063 <span class="comment">   &lt;/member&gt;</span>
<a name="l00064"></a>00064 <span class="comment">&lt;/category&gt;</span>
<a name="l00065"></a>00065 <span class="comment"> ***/</span>
<a name="l00066"></a>00066 
<a name="l00067"></a>00067 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00068"></a>00068 
<a name="l00069"></a>00069 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00070"></a>00070 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00071"></a>00071 <span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00072"></a>00072 <span class="preprocessor">#include &lt;pwd.h&gt;</span>
<a name="l00073"></a>00073 <span class="preprocessor">#ifdef USE_SYSTEM_IMAP</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#include &lt;imap/c-client.h&gt;</span>
<a name="l00075"></a>00075 <span class="preprocessor">#include &lt;imap/imap4r1.h&gt;</span>
<a name="l00076"></a>00076 <span class="preprocessor">#include &lt;imap/linkage.h&gt;</span>
<a name="l00077"></a>00077 <span class="preprocessor">#elif defined (USE_SYSTEM_CCLIENT)</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#include &lt;c-client/c-client.h&gt;</span>
<a name="l00079"></a>00079 <span class="preprocessor">#include &lt;c-client/imap4r1.h&gt;</span>
<a name="l00080"></a>00080 <span class="preprocessor">#include &lt;c-client/linkage.h&gt;</span>
<a name="l00081"></a>00081 <span class="preprocessor">#else</span>
<a name="l00082"></a>00082 <span class="preprocessor"></span><span class="preprocessor">#include &quot;c-client.h&quot;</span>
<a name="l00083"></a>00083 <span class="preprocessor">#include &quot;imap4r1.h&quot;</span>
<a name="l00084"></a>00084 <span class="preprocessor">#include &quot;linkage.h&quot;</span>
<a name="l00085"></a>00085 <span class="preprocessor">#endif</span>
<a name="l00086"></a>00086 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00087"></a>00087 <span class="preprocessor"></span>
<a name="l00088"></a>00088 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 250977 $&quot;</span>)
<a name="l00089"></a>00089 
<a name="l00090"></a>00090 <span class="preprocessor">#include &quot;asterisk/paths.h&quot;   </span><span class="comment">/* use ast_config_AST_SPOOL_DIR */</span>
<a name="l00091"></a>00091 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00092"></a>00092 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
<a name="l00093"></a>00093 <span class="preprocessor">#include &lt;sys/mman.h&gt;</span>
<a name="l00094"></a>00094 <span class="preprocessor">#include &lt;<a class="code" href="time_8h.html" title="Time-related functions and macros.">time.h</a>&gt;</span>
<a name="l00095"></a>00095 <span class="preprocessor">#include &lt;dirent.h&gt;</span>
<a name="l00096"></a>00096 
<a name="l00097"></a>00097 <span class="preprocessor">#include &quot;<a class="code" href="logger_8h.html" title="Support for logging to various files, console and syslog Configuration in file logger...">asterisk/logger.h</a>&quot;</span>
<a name="l00098"></a>00098 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00099"></a>00099 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00100"></a>00100 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00101"></a>00101 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00102"></a>00102 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00103"></a>00103 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00104"></a>00104 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00105"></a>00105 <span class="preprocessor">#include &quot;<a class="code" href="adsi_8h.html" title="ADSI Support (built upon Caller*ID).">asterisk/adsi.h</a>&quot;</span>
<a name="l00106"></a>00106 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00107"></a>00107 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00108"></a>00108 <span class="preprocessor">#include &quot;<a class="code" href="dsp_8h.html" title="Convenient Signal Processing routines.">asterisk/dsp.h</a>&quot;</span>
<a name="l00109"></a>00109 <span class="preprocessor">#include &quot;<a class="code" href="localtime_8h.html" title="Custom localtime functions for multiple timezones.">asterisk/localtime.h</a>&quot;</span>
<a name="l00110"></a>00110 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00111"></a>00111 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00112"></a>00112 <span class="preprocessor">#include &quot;<a class="code" href="stringfields_8h.html" title="String fields in structures.">asterisk/stringfields.h</a>&quot;</span>
<a name="l00113"></a>00113 <span class="preprocessor">#include &quot;<a class="code" href="smdi_8h.html" title="SMDI support for Asterisk.">asterisk/smdi.h</a>&quot;</span>
<a name="l00114"></a>00114 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00115"></a>00115 <span class="preprocessor">#include &quot;<a class="code" href="event_8h.html">asterisk/event.h</a>&quot;</span>
<a name="l00116"></a>00116 <span class="preprocessor">#include &quot;<a class="code" href="taskprocessor_8h.html" title="An API for managing task processing threads that can be shared across modules.">asterisk/taskprocessor.h</a>&quot;</span>
<a name="l00117"></a>00117 
<a name="l00118"></a>00118 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l00119"></a>00119 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="res__odbc_8h.html" title="ODBC resource manager.">asterisk/res_odbc.h</a>&quot;</span>
<a name="l00120"></a>00120 <span class="preprocessor">#endif</span>
<a name="l00121"></a>00121 <span class="preprocessor"></span>
<a name="l00122"></a>00122 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00123"></a>00123 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="threadstorage_8h.html" title="Definitions to aid in the use of thread local storage.">asterisk/threadstorage.h</a>&quot;</span>
<a name="l00124"></a>00124 <span class="preprocessor">#endif</span>
<a name="l00125"></a>00125 <span class="preprocessor"></span>
<a name="l00126"></a>00126 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00127"></a>00127 <span class="comment">   &lt;application name=&quot;VoiceMail&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00128"></a>00128 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00129"></a>00129 <span class="comment">         Leave a Voicemail message.</span>
<a name="l00130"></a>00130 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00131"></a>00131 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00132"></a>00132 <span class="comment">         &lt;parameter name=&quot;mailboxs&quot; argsep=&quot;&amp;amp;&quot; required=&quot;true&quot;&gt;</span>
<a name="l00133"></a>00133 <span class="comment">            &lt;argument name=&quot;mailbox1&quot; argsep=&quot;@&quot; required=&quot;true&quot;&gt;</span>
<a name="l00134"></a>00134 <span class="comment">               &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00135"></a>00135 <span class="comment">               &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00136"></a>00136 <span class="comment">            &lt;/argument&gt;</span>
<a name="l00137"></a>00137 <span class="comment">            &lt;argument name=&quot;mailbox2&quot; argsep=&quot;@&quot; multiple=&quot;true&quot;&gt;</span>
<a name="l00138"></a>00138 <span class="comment">               &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00139"></a>00139 <span class="comment">               &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00140"></a>00140 <span class="comment">            &lt;/argument&gt;</span>
<a name="l00141"></a>00141 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00142"></a>00142 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00143"></a>00143 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00144"></a>00144 <span class="comment">               &lt;option name=&quot;b&quot;&gt;</span>
<a name="l00145"></a>00145 <span class="comment">                  &lt;para&gt;Play the &lt;literal&gt;busy&lt;/literal&gt; greeting to the calling party.&lt;/para&gt;</span>
<a name="l00146"></a>00146 <span class="comment">               &lt;/option&gt;</span>
<a name="l00147"></a>00147 <span class="comment">               &lt;option name=&quot;d&quot;&gt;</span>
<a name="l00148"></a>00148 <span class="comment">                  &lt;argument name=&quot;c&quot; /&gt;</span>
<a name="l00149"></a>00149 <span class="comment">                  &lt;para&gt;Accept digits for a new extension in context &lt;replaceable&gt;c&lt;/replaceable&gt;,</span>
<a name="l00150"></a>00150 <span class="comment">                  if played during the greeting. Context defaults to the current context.&lt;/para&gt;</span>
<a name="l00151"></a>00151 <span class="comment">               &lt;/option&gt;</span>
<a name="l00152"></a>00152 <span class="comment">               &lt;option name=&quot;g&quot;&gt;</span>
<a name="l00153"></a>00153 <span class="comment">                  &lt;argument name=&quot;#&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00154"></a>00154 <span class="comment">                  &lt;para&gt;Use the specified amount of gain when recording the voicemail</span>
<a name="l00155"></a>00155 <span class="comment">                  message. The units are whole-number decibels (dB). Only works on supported</span>
<a name="l00156"></a>00156 <span class="comment">                  technologies, which is DAHDI only.&lt;/para&gt;</span>
<a name="l00157"></a>00157 <span class="comment">               &lt;/option&gt;</span>
<a name="l00158"></a>00158 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00159"></a>00159 <span class="comment">                  &lt;para&gt;Skip the playback of instructions for leaving a message to the</span>
<a name="l00160"></a>00160 <span class="comment">                  calling party.&lt;/para&gt;</span>
<a name="l00161"></a>00161 <span class="comment">               &lt;/option&gt;</span>
<a name="l00162"></a>00162 <span class="comment">               &lt;option name=&quot;u&quot;&gt;</span>
<a name="l00163"></a>00163 <span class="comment">                  &lt;para&gt;Play the &lt;literal&gt;unavailable&lt;/literal&gt; greeting.&lt;/para&gt;</span>
<a name="l00164"></a>00164 <span class="comment">               &lt;/option&gt;</span>
<a name="l00165"></a>00165 <span class="comment">               &lt;option name=&quot;U&quot;&gt;</span>
<a name="l00166"></a>00166 <span class="comment">                  &lt;para&gt;Mark message as &lt;literal&gt;URGENT&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00167"></a>00167 <span class="comment">               &lt;/option&gt;</span>
<a name="l00168"></a>00168 <span class="comment">               &lt;option name=&quot;P&quot;&gt;</span>
<a name="l00169"></a>00169 <span class="comment">                  &lt;para&gt;Mark message as &lt;literal&gt;PRIORITY&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00170"></a>00170 <span class="comment">               &lt;/option&gt;</span>
<a name="l00171"></a>00171 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00172"></a>00172 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00173"></a>00173 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00174"></a>00174 <span class="comment">      &lt;description&gt;</span>
<a name="l00175"></a>00175 <span class="comment">         &lt;para&gt;This application allows the calling party to leave a message for the specified</span>
<a name="l00176"></a>00176 <span class="comment">         list of mailboxes. When multiple mailboxes are specified, the greeting will be taken from</span>
<a name="l00177"></a>00177 <span class="comment">         the first mailbox specified. Dialplan execution will stop if the specified mailbox does not</span>
<a name="l00178"></a>00178 <span class="comment">         exist.&lt;/para&gt;</span>
<a name="l00179"></a>00179 <span class="comment">         &lt;para&gt;The Voicemail application will exit if any of the following DTMF digits are received:&lt;/para&gt;</span>
<a name="l00180"></a>00180 <span class="comment">         &lt;enumlist&gt;</span>
<a name="l00181"></a>00181 <span class="comment">            &lt;enum name=&quot;0&quot;&gt;</span>
<a name="l00182"></a>00182 <span class="comment">               &lt;para&gt;Jump to the &lt;literal&gt;o&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;</span>
<a name="l00183"></a>00183 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00184"></a>00184 <span class="comment">            &lt;enum name=&quot;*&quot;&gt;</span>
<a name="l00185"></a>00185 <span class="comment">               &lt;para&gt;Jump to the &lt;literal&gt;a&lt;/literal&gt; extension in the current dialplan context.&lt;/para&gt;</span>
<a name="l00186"></a>00186 <span class="comment">            &lt;/enum&gt;</span>
<a name="l00187"></a>00187 <span class="comment">         &lt;/enumlist&gt;</span>
<a name="l00188"></a>00188 <span class="comment">         &lt;para&gt;This application will set the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00189"></a>00189 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00190"></a>00190 <span class="comment">            &lt;variable name=&quot;VMSTATUS&quot;&gt;</span>
<a name="l00191"></a>00191 <span class="comment">               &lt;para&gt;This indicates the status of the execution of the VoiceMail application.&lt;/para&gt;</span>
<a name="l00192"></a>00192 <span class="comment">               &lt;value name=&quot;SUCCESS&quot; /&gt;</span>
<a name="l00193"></a>00193 <span class="comment">               &lt;value name=&quot;USEREXIT&quot; /&gt;</span>
<a name="l00194"></a>00194 <span class="comment">               &lt;value name=&quot;FAILED&quot; /&gt;</span>
<a name="l00195"></a>00195 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00196"></a>00196 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00197"></a>00197 <span class="comment">      &lt;/description&gt;</span>
<a name="l00198"></a>00198 <span class="comment">   &lt;/application&gt;</span>
<a name="l00199"></a>00199 <span class="comment">   &lt;application name=&quot;VoiceMailMain&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00200"></a>00200 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00201"></a>00201 <span class="comment">         Check Voicemail messages.</span>
<a name="l00202"></a>00202 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00203"></a>00203 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00204"></a>00204 <span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span>
<a name="l00205"></a>00205 <span class="comment">            &lt;argument name=&quot;mailbox&quot; /&gt;</span>
<a name="l00206"></a>00206 <span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00207"></a>00207 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00208"></a>00208 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00209"></a>00209 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00210"></a>00210 <span class="comment">               &lt;option name=&quot;p&quot;&gt;</span>
<a name="l00211"></a>00211 <span class="comment">                  &lt;para&gt;Consider the &lt;replaceable&gt;mailbox&lt;/replaceable&gt; parameter as a prefix to</span>
<a name="l00212"></a>00212 <span class="comment">                  the mailbox that is entered by the caller.&lt;/para&gt;</span>
<a name="l00213"></a>00213 <span class="comment">               &lt;/option&gt;</span>
<a name="l00214"></a>00214 <span class="comment">               &lt;option name=&quot;g&quot;&gt;</span>
<a name="l00215"></a>00215 <span class="comment">                  &lt;argument name=&quot;#&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00216"></a>00216 <span class="comment">                  &lt;para&gt;Use the specified amount of gain when recording a voicemail message.</span>
<a name="l00217"></a>00217 <span class="comment">                  The units are whole-number decibels (dB).&lt;/para&gt;</span>
<a name="l00218"></a>00218 <span class="comment">               &lt;/option&gt;</span>
<a name="l00219"></a>00219 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00220"></a>00220 <span class="comment">                  &lt;para&gt;Skip checking the passcode for the mailbox.&lt;/para&gt;</span>
<a name="l00221"></a>00221 <span class="comment">               &lt;/option&gt;</span>
<a name="l00222"></a>00222 <span class="comment">               &lt;option name=&quot;a&quot;&gt;</span>
<a name="l00223"></a>00223 <span class="comment">                  &lt;argument name=&quot;folder&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00224"></a>00224 <span class="comment">                  &lt;para&gt;Skip folder prompt and go directly to &lt;replaceable&gt;folder&lt;/replaceable&gt; specified.</span>
<a name="l00225"></a>00225 <span class="comment">                  Defaults to &lt;literal&gt;0&lt;/literal&gt; (INBOX).&lt;/para&gt;</span>
<a name="l00226"></a>00226 <span class="comment">                  &lt;enumlist&gt;</span>
<a name="l00227"></a>00227 <span class="comment">                     &lt;enum name=&quot;0&quot;&gt;&lt;para&gt;INBOX&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00228"></a>00228 <span class="comment">                     &lt;enum name=&quot;1&quot;&gt;&lt;para&gt;Old&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00229"></a>00229 <span class="comment">                     &lt;enum name=&quot;2&quot;&gt;&lt;para&gt;Work&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00230"></a>00230 <span class="comment">                     &lt;enum name=&quot;3&quot;&gt;&lt;para&gt;Family&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00231"></a>00231 <span class="comment">                     &lt;enum name=&quot;4&quot;&gt;&lt;para&gt;Friends&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00232"></a>00232 <span class="comment">                     &lt;enum name=&quot;5&quot;&gt;&lt;para&gt;Cust1&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00233"></a>00233 <span class="comment">                     &lt;enum name=&quot;6&quot;&gt;&lt;para&gt;Cust2&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00234"></a>00234 <span class="comment">                     &lt;enum name=&quot;7&quot;&gt;&lt;para&gt;Cust3&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00235"></a>00235 <span class="comment">                     &lt;enum name=&quot;8&quot;&gt;&lt;para&gt;Cust4&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00236"></a>00236 <span class="comment">                     &lt;enum name=&quot;9&quot;&gt;&lt;para&gt;Cust5&lt;/para&gt;&lt;/enum&gt;</span>
<a name="l00237"></a>00237 <span class="comment">                  &lt;/enumlist&gt;</span>
<a name="l00238"></a>00238 <span class="comment">               &lt;/option&gt;</span>
<a name="l00239"></a>00239 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00240"></a>00240 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00241"></a>00241 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00242"></a>00242 <span class="comment">      &lt;description&gt;</span>
<a name="l00243"></a>00243 <span class="comment">         &lt;para&gt;This application allows the calling party to check voicemail messages. A specific</span>
<a name="l00244"></a>00244 <span class="comment">         &lt;replaceable&gt;mailbox&lt;/replaceable&gt;, and optional corresponding &lt;replaceable&gt;context&lt;/replaceable&gt;,</span>
<a name="l00245"></a>00245 <span class="comment">         may be specified. If a &lt;replaceable&gt;mailbox&lt;/replaceable&gt; is not provided, the calling party will</span>
<a name="l00246"></a>00246 <span class="comment">         be prompted to enter one. If a &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, the</span>
<a name="l00247"></a>00247 <span class="comment">         &lt;literal&gt;default&lt;/literal&gt; context will be used.&lt;/para&gt;</span>
<a name="l00248"></a>00248 <span class="comment">      &lt;/description&gt;</span>
<a name="l00249"></a>00249 <span class="comment">   &lt;/application&gt;</span>
<a name="l00250"></a>00250 <span class="comment">   &lt;application name=&quot;MailboxExists&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00251"></a>00251 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00252"></a>00252 <span class="comment">         Check to see if Voicemail mailbox exists.</span>
<a name="l00253"></a>00253 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00254"></a>00254 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00255"></a>00255 <span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span>
<a name="l00256"></a>00256 <span class="comment">            &lt;argument name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00257"></a>00257 <span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00258"></a>00258 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00259"></a>00259 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00260"></a>00260 <span class="comment">            &lt;para&gt;None options.&lt;/para&gt;</span>
<a name="l00261"></a>00261 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00262"></a>00262 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00263"></a>00263 <span class="comment">      &lt;description&gt;</span>
<a name="l00264"></a>00264 <span class="comment">         &lt;para&gt;Check to see if the specified &lt;replaceable&gt;mailbox&lt;/replaceable&gt; exists. If no voicemail</span>
<a name="l00265"></a>00265 <span class="comment">         &lt;replaceable&gt;context&lt;/replaceable&gt; is specified, the &lt;literal&gt;default&lt;/literal&gt; context</span>
<a name="l00266"></a>00266 <span class="comment">         will be used.&lt;/para&gt;</span>
<a name="l00267"></a>00267 <span class="comment">         &lt;para&gt;This application will set the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00268"></a>00268 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00269"></a>00269 <span class="comment">            &lt;variable name=&quot;VMBOXEXISTSSTATUS&quot;&gt;</span>
<a name="l00270"></a>00270 <span class="comment">               &lt;para&gt;This will contain the status of the execution of the MailboxExists application.</span>
<a name="l00271"></a>00271 <span class="comment">               Possible values include:&lt;/para&gt;</span>
<a name="l00272"></a>00272 <span class="comment">               &lt;value name=&quot;SUCCESS&quot; /&gt;</span>
<a name="l00273"></a>00273 <span class="comment">               &lt;value name=&quot;FAILED&quot; /&gt;</span>
<a name="l00274"></a>00274 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00275"></a>00275 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00276"></a>00276 <span class="comment">      &lt;/description&gt;</span>
<a name="l00277"></a>00277 <span class="comment">   &lt;/application&gt;</span>
<a name="l00278"></a>00278 <span class="comment">   &lt;application name=&quot;VMAuthenticate&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00279"></a>00279 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00280"></a>00280 <span class="comment">         Authenticate with Voicemail passwords.</span>
<a name="l00281"></a>00281 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00282"></a>00282 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00283"></a>00283 <span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; argsep=&quot;@&quot;&gt;</span>
<a name="l00284"></a>00284 <span class="comment">            &lt;argument name=&quot;mailbox&quot; /&gt;</span>
<a name="l00285"></a>00285 <span class="comment">            &lt;argument name=&quot;context&quot; /&gt;</span>
<a name="l00286"></a>00286 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00287"></a>00287 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00288"></a>00288 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00289"></a>00289 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00290"></a>00290 <span class="comment">                  &lt;para&gt;Skip playing the initial prompts.&lt;/para&gt;</span>
<a name="l00291"></a>00291 <span class="comment">               &lt;/option&gt;</span>
<a name="l00292"></a>00292 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00293"></a>00293 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00294"></a>00294 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00295"></a>00295 <span class="comment">      &lt;description&gt;</span>
<a name="l00296"></a>00296 <span class="comment">         &lt;para&gt;This application behaves the same way as the Authenticate application, but the passwords</span>
<a name="l00297"></a>00297 <span class="comment">         are taken from &lt;filename&gt;voicemail.conf&lt;/filename&gt;. If the &lt;replaceable&gt;mailbox&lt;/replaceable&gt; is</span>
<a name="l00298"></a>00298 <span class="comment">         specified, only that mailbox&apos;s password will be considered valid. If the &lt;replaceable&gt;mailbox&lt;/replaceable&gt;</span>
<a name="l00299"></a>00299 <span class="comment">         is not specified, the channel variable &lt;variable&gt;AUTH_MAILBOX&lt;/variable&gt; will be set with the authenticated</span>
<a name="l00300"></a>00300 <span class="comment">         mailbox.&lt;/para&gt;</span>
<a name="l00301"></a>00301 <span class="comment">      &lt;/description&gt;</span>
<a name="l00302"></a>00302 <span class="comment">   &lt;/application&gt;</span>
<a name="l00303"></a>00303 <span class="comment">   &lt;function name=&quot;MAILBOX_EXISTS&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00304"></a>00304 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00305"></a>00305 <span class="comment">         Tell if a mailbox is configured.</span>
<a name="l00306"></a>00306 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00307"></a>00307 <span class="comment">      &lt;syntax argsep=&quot;@&quot;&gt;</span>
<a name="l00308"></a>00308 <span class="comment">         &lt;parameter name=&quot;mailbox&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00309"></a>00309 <span class="comment">         &lt;parameter name=&quot;context&quot; /&gt;</span>
<a name="l00310"></a>00310 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00311"></a>00311 <span class="comment">      &lt;description&gt;</span>
<a name="l00312"></a>00312 <span class="comment">         &lt;para&gt;Returns a boolean of whether the corresponding &lt;replaceable&gt;mailbox&lt;/replaceable&gt; exists.</span>
<a name="l00313"></a>00313 <span class="comment">         If &lt;replaceable&gt;context&lt;/replaceable&gt; is not specified, defaults to the &lt;literal&gt;default&lt;/literal&gt;</span>
<a name="l00314"></a>00314 <span class="comment">         context.&lt;/para&gt;</span>
<a name="l00315"></a>00315 <span class="comment">      &lt;/description&gt;</span>
<a name="l00316"></a>00316 <span class="comment">   &lt;/function&gt;</span>
<a name="l00317"></a>00317 <span class="comment"> ***/</span>
<a name="l00318"></a>00318 
<a name="l00319"></a>00319 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00320"></a>00320 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> imapserver[48];
<a name="l00321"></a>00321 <span class="keyword">static</span> <span class="keywordtype">char</span> imapport[8];
<a name="l00322"></a>00322 <span class="keyword">static</span> <span class="keywordtype">char</span> imapflags[128];
<a name="l00323"></a>00323 <span class="keyword">static</span> <span class="keywordtype">char</span> imapfolder[64];
<a name="l00324"></a>00324 <span class="keyword">static</span> <span class="keywordtype">char</span> imapparentfolder[64] = <span class="stringliteral">&quot;\0&quot;</span>;
<a name="l00325"></a>00325 <span class="keyword">static</span> <span class="keywordtype">char</span> greetingfolder[64];
<a name="l00326"></a>00326 <span class="keyword">static</span> <span class="keywordtype">char</span> authuser[32];
<a name="l00327"></a>00327 <span class="keyword">static</span> <span class="keywordtype">char</span> authpassword[42];
<a name="l00328"></a>00328 <span class="keyword">static</span> <span class="keywordtype">int</span> imapversion = 1;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330 <span class="keyword">static</span> <span class="keywordtype">int</span> expungeonhangup = 1;
<a name="l00331"></a>00331 <span class="keyword">static</span> <span class="keywordtype">int</span> imapgreetings = 0;
<a name="l00332"></a>00332 <span class="keyword">static</span> <span class="keywordtype">char</span> delimiter = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00333"></a>00333 
<a name="l00334"></a>00334 <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a>;
<a name="l00335"></a>00335 <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a>;
<a name="l00336"></a>00336 
<a name="l00337"></a>00337 <a class="code" href="threadstorage_8h.html#ac268c0a8272ec11e73269392507fb1a6" title="Define a thread storage variable.">AST_THREADSTORAGE</a>(ts_vmstate);
<a name="l00338"></a>00338 
<a name="l00339"></a>00339 <span class="comment">/* Forward declarations for IMAP */</span>
<a name="l00340"></a>00340 <span class="keyword">static</span> <span class="keywordtype">int</span> init_mailstream(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box);
<a name="l00341"></a>00341 <span class="keyword">static</span> <span class="keywordtype">void</span> write_file(<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l00342"></a>00342 <span class="keyword">static</span> <span class="keywordtype">char</span> *get_header_by_tag(<span class="keywordtype">char</span> *header, <span class="keywordtype">char</span> *tag, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l00343"></a>00343 <span class="keyword">static</span> <span class="keywordtype">void</span> vm_imap_delete(<span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu);
<a name="l00344"></a>00344 <span class="keyword">static</span> <span class="keywordtype">char</span> *get_user_by_mailbox(<span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>);
<a name="l00345"></a>00345 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *get_vm_state_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">int</span> interactive);
<a name="l00346"></a>00346 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *get_vm_state_by_mailbox(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">int</span> interactive);
<a name="l00347"></a>00347 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *create_vm_state_from_user(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu);
<a name="l00348"></a>00348 <span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_insert(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms);
<a name="l00349"></a>00349 <span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_delete(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms);
<a name="l00350"></a>00350 <span class="keyword">static</span> <span class="keywordtype">void</span> set_update(MAILSTREAM * stream);
<a name="l00351"></a>00351 <span class="keyword">static</span> <span class="keywordtype">void</span> init_vm_state(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms);
<a name="l00352"></a>00352 <span class="keyword">static</span> <span class="keywordtype">int</span> save_body(BODY *body, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *section, <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">int</span> is_intro);
<a name="l00353"></a>00353 <span class="keyword">static</span> <span class="keywordtype">void</span> get_mailbox_delimiter(MAILSTREAM *stream);
<a name="l00354"></a>00354 <span class="keyword">static</span> <span class="keywordtype">void</span> mm_parsequota (MAILSTREAM *stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, QUOTALIST *pquota);
<a name="l00355"></a>00355 <span class="keyword">static</span> <span class="keywordtype">void</span> imap_mailbox_name(<span class="keywordtype">char</span> *spec, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box, <span class="keywordtype">int</span> target);
<a name="l00356"></a>00356 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_store_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> duration, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag);
<a name="l00357"></a>00357 <span class="keyword">static</span> <span class="keywordtype">void</span> update_messages_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structnumber.html" title="Number structure.">number</a>);
<a name="l00358"></a>00358 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e" title="Removes the voicemail sound and information file.">vm_delete</a>(<span class="keywordtype">char</span> *file);
<a name="l00359"></a>00359 
<a name="l00360"></a>00360 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_remove_file (<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keywordtype">int</span> msgnum);
<a name="l00361"></a>00361 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_retrieve_file (<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> msgnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l00362"></a>00362 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_delete_old_greeting (<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms);
<a name="l00363"></a>00363 <span class="keyword">static</span> <span class="keywordtype">void</span> check_quota(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l00364"></a>00364 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box);
<a name="l00365"></a>00365 <span class="keyword">struct </span>vmstate {
<a name="l00366"></a>00366    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l00367"></a>00367    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(vmstate) list;
<a name="l00368"></a>00368 };
<a name="l00369"></a>00369 
<a name="l00370"></a>00370 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(vmstates, vmstate);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372 <span class="preprocessor">#endif</span>
<a name="l00373"></a>00373 <span class="preprocessor"></span>
<a name="l00374"></a><a class="code" href="app__voicemail_8c.html#ab396ba916ebd13b58eedfb621a602413">00374</a> <span class="preprocessor">#define SMDI_MWI_WAIT_TIMEOUT 1000 </span><span class="comment">/* 1 second */</span>
<a name="l00375"></a>00375 
<a name="l00376"></a><a class="code" href="app__voicemail_8c.html#a4ec5f68b5fd7b11e202f1f2f508a3fee">00376</a> <span class="preprocessor">#define COMMAND_TIMEOUT 5000</span>
<a name="l00377"></a>00377 <span class="preprocessor"></span><span class="comment">/* Don&apos;t modify these here; set your umask at runtime instead */</span>
<a name="l00378"></a><a class="code" href="app__voicemail_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">00378</a> <span class="preprocessor">#define  VOICEMAIL_DIR_MODE   0777</span>
<a name="l00379"></a><a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">00379</a> <span class="preprocessor"></span><span class="preprocessor">#define  VOICEMAIL_FILE_MODE  0666</span>
<a name="l00380"></a><a class="code" href="app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">00380</a> <span class="preprocessor"></span><span class="preprocessor">#define  CHUNKSIZE   65536</span>
<a name="l00381"></a>00381 <span class="preprocessor"></span>
<a name="l00382"></a><a class="code" href="app__voicemail_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">00382</a> <span class="preprocessor">#define VOICEMAIL_CONFIG &quot;voicemail.conf&quot;</span>
<a name="l00383"></a><a class="code" href="app__voicemail_8c.html#a5e790f0ee1dbde79705c49bf33a1060d">00383</a> <span class="preprocessor"></span><span class="preprocessor">#define ASTERISK_USERNAME &quot;asterisk&quot;</span>
<a name="l00384"></a>00384 <span class="preprocessor"></span>
<a name="l00385"></a>00385 <span class="comment">/* Define fast-forward, pause, restart, and reverse keys</span>
<a name="l00386"></a>00386 <span class="comment">   while listening to a voicemail message - these are</span>
<a name="l00387"></a>00387 <span class="comment">   strings, not characters */</span>
<a name="l00388"></a><a class="code" href="app__voicemail_8c.html#a1eb1e0cbaef35879c60c6afd79dcc6af">00388</a> <span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_FORWARD_KEY &quot;#&quot;</span>
<a name="l00389"></a><a class="code" href="app__voicemail_8c.html#adf398fc1e24857033174482891adab4a">00389</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_REVERSE_KEY &quot;*&quot;</span>
<a name="l00390"></a><a class="code" href="app__voicemail_8c.html#aab009b1bd02c3b2580f86581c9fa2c70">00390</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_PAUSE_KEY &quot;0&quot;</span>
<a name="l00391"></a><a class="code" href="app__voicemail_8c.html#a724057a0c369a6b5dd798ccc31cf53f2">00391</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_RESTART_KEY &quot;2&quot;</span>
<a name="l00392"></a><a class="code" href="app__voicemail_8c.html#a7decd8d5e42401e22d0d86d150e70a04">00392</a> <span class="preprocessor"></span><span class="preprocessor">#define DEFAULT_LISTEN_CONTROL_STOP_KEY &quot;13456789&quot;</span>
<a name="l00393"></a><a class="code" href="app__voicemail_8c.html#ace804dd195bf827b988e3f2282422d25">00393</a> <span class="preprocessor"></span><span class="preprocessor">#define VALID_DTMF &quot;1234567890*#&quot; </span><span class="comment">/* Yes ABCD are valid dtmf but what phones have those? */</span>
<a name="l00394"></a>00394 
<a name="l00395"></a>00395 <span class="comment">/* Default mail command to mail voicemail. Change it with the</span>
<a name="l00396"></a>00396 <span class="comment">    mailcmd= command in voicemail.conf */</span>
<a name="l00397"></a><a class="code" href="app__voicemail_8c.html#a92d8fb2d08cf9220d520ae9691b5e6c4">00397</a> <span class="preprocessor">#define SENDMAIL &quot;/usr/sbin/sendmail -t&quot;</span>
<a name="l00398"></a>00398 <span class="preprocessor"></span>
<a name="l00399"></a><a class="code" href="app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">00399</a> <span class="preprocessor">#define INTRO &quot;vm-intro&quot;</span>
<a name="l00400"></a>00400 <span class="preprocessor"></span>
<a name="l00401"></a><a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">00401</a> <span class="preprocessor">#define MAXMSG 100</span>
<a name="l00402"></a><a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">00402</a> <span class="preprocessor"></span><span class="preprocessor">#define MAXMSGLIMIT 9999</span>
<a name="l00403"></a>00403 <span class="preprocessor"></span>
<a name="l00404"></a><a class="code" href="app__voicemail_8c.html#aca7150caac3749421acc40d7bc3483f1">00404</a> <span class="preprocessor">#define MINPASSWORD 0 </span><span class="comment">/*!&lt; Default minimum mailbox password length */</span>
<a name="l00405"></a>00405 
<a name="l00406"></a><a class="code" href="app__voicemail_8c.html#a1e31aa9d6eb3fa3e9287e3f3c3c16969">00406</a> <span class="preprocessor">#define BASELINELEN 72</span>
<a name="l00407"></a><a class="code" href="app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">00407</a> <span class="preprocessor"></span><span class="preprocessor">#define BASEMAXINLINE 256</span>
<a name="l00408"></a><a class="code" href="app__voicemail_8c.html#a55b81f273444186ad83e1087f9a3706d">00408</a> <span class="preprocessor"></span><span class="preprocessor">#define eol &quot;\r\n&quot;</span>
<a name="l00409"></a>00409 <span class="preprocessor"></span>
<a name="l00410"></a><a class="code" href="app__voicemail_8c.html#ad76c4e7e27885ab5ae9cd4652bf0f95a">00410</a> <span class="preprocessor">#define MAX_DATETIME_FORMAT   512</span>
<a name="l00411"></a><a class="code" href="app__voicemail_8c.html#aab88842146c214975db358115d86c726">00411</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_NUM_CID_CONTEXTS 10</span>
<a name="l00412"></a>00412 <span class="preprocessor"></span>
<a name="l00413"></a><a class="code" href="app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">00413</a> <span class="preprocessor">#define VM_REVIEW        (1 &lt;&lt; 0)   </span><span class="comment">/*!&lt; After recording, permit the caller to review the recording before saving */</span>
<a name="l00414"></a><a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">00414</a> <span class="preprocessor">#define VM_OPERATOR      (1 &lt;&lt; 1)   </span><span class="comment">/*!&lt; Allow 0 to be pressed to go to &apos;o&apos; extension */</span>
<a name="l00415"></a><a class="code" href="app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">00415</a> <span class="preprocessor">#define VM_SAYCID        (1 &lt;&lt; 2)   </span><span class="comment">/*!&lt; Repeat the CallerID info during envelope playback */</span>
<a name="l00416"></a><a class="code" href="app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">00416</a> <span class="preprocessor">#define VM_SVMAIL        (1 &lt;&lt; 3)   </span><span class="comment">/*!&lt; Allow the user to compose a new VM from within VoicemailMain */</span>
<a name="l00417"></a><a class="code" href="app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">00417</a> <span class="preprocessor">#define VM_ENVELOPE      (1 &lt;&lt; 4)   </span><span class="comment">/*!&lt; Play the envelope information (who-from, time received, etc.) */</span>
<a name="l00418"></a><a class="code" href="app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">00418</a> <span class="preprocessor">#define VM_SAYDURATION   (1 &lt;&lt; 5)   </span><span class="comment">/*!&lt; Play the length of the message during envelope playback */</span>
<a name="l00419"></a><a class="code" href="app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">00419</a> <span class="preprocessor">#define VM_SKIPAFTERCMD  (1 &lt;&lt; 6)   </span><span class="comment">/*!&lt; After deletion, assume caller wants to go to the next message */</span>
<a name="l00420"></a><a class="code" href="app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">00420</a> <span class="preprocessor">#define VM_FORCENAME     (1 &lt;&lt; 7)   </span><span class="comment">/*!&lt; Have new users record their name */</span>
<a name="l00421"></a><a class="code" href="app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">00421</a> <span class="preprocessor">#define VM_FORCEGREET    (1 &lt;&lt; 8)   </span><span class="comment">/*!&lt; Have new users record their greetings */</span>
<a name="l00422"></a><a class="code" href="app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">00422</a> <span class="preprocessor">#define VM_PBXSKIP       (1 &lt;&lt; 9)   </span><span class="comment">/*!&lt; Skip the [PBX] preamble in the Subject line of emails */</span>
<a name="l00423"></a><a class="code" href="app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">00423</a> <span class="preprocessor">#define VM_DIRECFORWARD  (1 &lt;&lt; 10)  </span><span class="comment">/*!&lt; Permit caller to use the Directory app for selecting to which mailbox to forward a VM */</span>
<a name="l00424"></a><a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">00424</a> <span class="preprocessor">#define VM_ATTACH        (1 &lt;&lt; 11)  </span><span class="comment">/*!&lt; Attach message to voicemail notifications? */</span>
<a name="l00425"></a><a class="code" href="app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">00425</a> <span class="preprocessor">#define VM_DELETE        (1 &lt;&lt; 12)  </span><span class="comment">/*!&lt; Delete message after sending notification */</span>
<a name="l00426"></a><a class="code" href="app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">00426</a> <span class="preprocessor">#define VM_ALLOCED       (1 &lt;&lt; 13)  </span><span class="comment">/*!&lt; Structure was malloc&apos;ed, instead of placed in a return (usually static) buffer */</span>
<a name="l00427"></a><a class="code" href="app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">00427</a> <span class="preprocessor">#define VM_SEARCH        (1 &lt;&lt; 14)  </span><span class="comment">/*!&lt; Search all contexts for a matching mailbox */</span>
<a name="l00428"></a><a class="code" href="app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">00428</a> <span class="preprocessor">#define VM_TEMPGREETWARN (1 &lt;&lt; 15)  </span><span class="comment">/*!&lt; Remind user tempgreeting is set */</span>
<a name="l00429"></a><a class="code" href="app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">00429</a> <span class="preprocessor">#define VM_MOVEHEARD     (1 &lt;&lt; 16)  </span><span class="comment">/*!&lt; Move a &quot;heard&quot; message to Old after listening to it */</span>
<a name="l00430"></a><a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">00430</a> <span class="preprocessor">#define VM_MESSAGEWRAP   (1 &lt;&lt; 17)  </span><span class="comment">/*!&lt; Wrap around from the last message to the first, and vice-versa */</span>
<a name="l00431"></a><a class="code" href="app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">00431</a> <span class="preprocessor">#define VM_FWDURGAUTO    (1 &lt;&lt; 18)  </span><span class="comment">/*!&lt; Autoset of Urgent flag on forwarded Urgent messages set globally */</span>
<a name="l00432"></a><a class="code" href="app__voicemail_8c.html#a207c95b6a18096172f7278b3af01f96d">00432</a> <span class="preprocessor">#define ERROR_LOCK_PATH  -100</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span>
<a name="l00434"></a>00434 
<a name="l00435"></a>00435 <span class="keyword">enum</span> {
<a name="l00436"></a><a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">00436</a>    <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>,
<a name="l00437"></a><a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">00437</a>    <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>,
<a name="l00438"></a><a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603ae4c30257a35e061da61e8d4e8e8f9169">00438</a>    <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603ae4c30257a35e061da61e8d4e8e8f9169">WORK_FOLDER</a>,
<a name="l00439"></a><a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603acc9384c009ceb460c1acdc3b680683bd">00439</a>    <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603acc9384c009ceb460c1acdc3b680683bd">FAMILY_FOLDER</a>,
<a name="l00440"></a><a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a3009ee50d2975ad7932cb6e7f610e64f">00440</a>    <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a3009ee50d2975ad7932cb6e7f610e64f">FRIENDS_FOLDER</a>,
<a name="l00441"></a><a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a922b06033e574a67b32a35b379dc8953">00441</a>    <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>
<a name="l00442"></a>00442 } <a class="code" href="app__voicemail_8c.html#acb3f4ffbed6e1718481666b195176077">vm_box</a>;
<a name="l00443"></a>00443 
<a name="l00444"></a>00444 <span class="keyword">enum</span> {
<a name="l00445"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba9c6a0359498684912cb0a3810e03138d">00445</a>    <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a> =           (1 &lt;&lt; 0),
<a name="l00446"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba6021f80ddb5561e6e07a285ea47b086e">00446</a>    <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a> =    (1 &lt;&lt; 1),
<a name="l00447"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba96240d093eacd367dd06de745d12e559">00447</a>    <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a> = (1 &lt;&lt; 2),
<a name="l00448"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba6f62412bc497c9dd7db876c7ea4f9cfd">00448</a>    <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a> =       (1 &lt;&lt; 3),
<a name="l00449"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba4707725f61e9b0b350f4dea90a9b6e01">00449</a>    <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a> =  (1 &lt;&lt; 4),
<a name="l00450"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae46e13cc6d4a1bfd34b1a4a939cf64f3">00450</a>    <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a> =         (1 &lt;&lt; 6),
<a name="l00451"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">00451</a>    <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a> =         (1 &lt;&lt; 7),
<a name="l00452"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae021f439fd94915a5a0b750b7bd9e1b0">00452</a>    <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a> =   (1 &lt;&lt; 8),
<a name="l00453"></a><a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba3ab39b91a9114a34f145da5f96ac7fce">00453</a>    <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a> = (1 &lt;&lt; 9)
<a name="l00454"></a>00454 } <a class="code" href="app__voicemail_8c.html#ab1d4d68081344b8c41b63b93f0d36dbc">vm_option_flags</a>;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456 <span class="keyword">enum</span> {
<a name="l00457"></a><a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294ca0ba3410dc4adff3119e1a4007cf90a7d">00457</a>    <a class="code" href="app__minivm_8c.html#a7ff5f2dff38e7639981794c43dc9167ba0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a> = 0,
<a name="l00458"></a><a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294cab3c235d8800fef13d32bda9908cb0599">00458</a>    <a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294cab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a> = 1,
<a name="l00459"></a><a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294caf287dd95d8f656a0423cc51f3f63e1c5">00459</a>    <a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294caf287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a>   = 2,
<a name="l00460"></a>00460    <span class="comment">/* This *must* be the last value in this enum! */</span>
<a name="l00461"></a><a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294caec7326f60e7edad15d96ff935e5616d6">00461</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a> = 3,
<a name="l00462"></a>00462 } <a class="code" href="app__voicemail_8c.html#ae85d1393d8b225413a6aef8d6618aa34">vm_option_args</a>;
<a name="l00463"></a>00463 
<a name="l00464"></a>00464 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(vm_app_options, {
<a name="l00465"></a>00465    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;s&apos;</span>, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>),
<a name="l00466"></a>00466    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;b&apos;</span>, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a>),
<a name="l00467"></a>00467    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;u&apos;</span>, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a>),
<a name="l00468"></a>00468    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;g&apos;</span>, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a>, <a class="code" href="app__minivm_8c.html#a7ff5f2dff38e7639981794c43dc9167ba0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a>),
<a name="l00469"></a>00469    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;d&apos;</span>, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>, <a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294caf287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a>),
<a name="l00470"></a>00470    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;p&apos;</span>, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a>),
<a name="l00471"></a>00471    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;a&apos;</span>, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a>, <a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294cab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a>),
<a name="l00472"></a>00472    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;U&apos;</span>, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a>),
<a name="l00473"></a>00473    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;P&apos;</span>, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a>)
<a name="l00474"></a>00474 });
<a name="l00475"></a>00475 
<a name="l00476"></a>00476 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(<span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>);
<a name="l00477"></a>00477 <span class="comment"></span>
<a name="l00478"></a>00478 <span class="comment">/*! \page vmlang Voicemail Language Syntaxes Supported</span>
<a name="l00479"></a>00479 <span class="comment"></span>
<a name="l00480"></a>00480 <span class="comment">   \par Syntaxes supported, not really language codes.</span>
<a name="l00481"></a>00481 <span class="comment">   \arg \b en    - English</span>
<a name="l00482"></a>00482 <span class="comment">   \arg \b de    - German</span>
<a name="l00483"></a>00483 <span class="comment">   \arg \b es    - Spanish</span>
<a name="l00484"></a>00484 <span class="comment">   \arg \b fr    - French</span>
<a name="l00485"></a>00485 <span class="comment">   \arg \b it    - Italian</span>
<a name="l00486"></a>00486 <span class="comment">   \arg \b nl    - Dutch</span>
<a name="l00487"></a>00487 <span class="comment">   \arg \b pt    - Portuguese</span>
<a name="l00488"></a>00488 <span class="comment">   \arg \b pt_BR - Portuguese (Brazil)</span>
<a name="l00489"></a>00489 <span class="comment">   \arg \b gr    - Greek</span>
<a name="l00490"></a>00490 <span class="comment">   \arg \b no    - Norwegian</span>
<a name="l00491"></a>00491 <span class="comment">   \arg \b se    - Swedish</span>
<a name="l00492"></a>00492 <span class="comment">   \arg \b tw    - Chinese (Taiwan)</span>
<a name="l00493"></a>00493 <span class="comment">   \arg \b ua - Ukrainian</span>
<a name="l00494"></a>00494 <span class="comment"></span>
<a name="l00495"></a>00495 <span class="comment">German requires the following additional soundfile:</span>
<a name="l00496"></a>00496 <span class="comment">\arg \b 1F  einE (feminine)</span>
<a name="l00497"></a>00497 <span class="comment"></span>
<a name="l00498"></a>00498 <span class="comment">Spanish requires the following additional soundfile:</span>
<a name="l00499"></a>00499 <span class="comment">\arg \b 1M      un (masculine)</span>
<a name="l00500"></a>00500 <span class="comment"></span>
<a name="l00501"></a>00501 <span class="comment">Dutch, Portuguese &amp; Spanish require the following additional soundfiles:</span>
<a name="l00502"></a>00502 <span class="comment">\arg \b vm-INBOXs singular of &apos;new&apos;</span>
<a name="l00503"></a>00503 <span class="comment">\arg \b vm-Olds      singular of &apos;old/heard/read&apos;</span>
<a name="l00504"></a>00504 <span class="comment"></span>
<a name="l00505"></a>00505 <span class="comment">NB these are plural:</span>
<a name="l00506"></a>00506 <span class="comment">\arg \b vm-INBOX  nieuwe (nl)</span>
<a name="l00507"></a>00507 <span class="comment">\arg \b vm-Old    oude (nl)</span>
<a name="l00508"></a>00508 <span class="comment"></span>
<a name="l00509"></a>00509 <span class="comment">Polish uses:</span>
<a name="l00510"></a>00510 <span class="comment">\arg \b vm-new-a  &apos;new&apos;, feminine singular accusative</span>
<a name="l00511"></a>00511 <span class="comment">\arg \b vm-new-e  &apos;new&apos;, feminine plural accusative</span>
<a name="l00512"></a>00512 <span class="comment">\arg \b vm-new-ych   &apos;new&apos;, feminine plural genitive</span>
<a name="l00513"></a>00513 <span class="comment">\arg \b vm-old-a  &apos;old&apos;, feminine singular accusative</span>
<a name="l00514"></a>00514 <span class="comment">\arg \b vm-old-e  &apos;old&apos;, feminine plural accusative</span>
<a name="l00515"></a>00515 <span class="comment">\arg \b vm-old-ych   &apos;old&apos;, feminine plural genitive</span>
<a name="l00516"></a>00516 <span class="comment">\arg \b digits/1-a   &apos;one&apos;, not always same as &apos;digits/1&apos;</span>
<a name="l00517"></a>00517 <span class="comment">\arg \b digits/2-ie  &apos;two&apos;, not always same as &apos;digits/2&apos;</span>
<a name="l00518"></a>00518 <span class="comment"></span>
<a name="l00519"></a>00519 <span class="comment">Swedish uses:</span>
<a name="l00520"></a>00520 <span class="comment">\arg \b vm-nytt      singular of &apos;new&apos;</span>
<a name="l00521"></a>00521 <span class="comment">\arg \b vm-nya    plural of &apos;new&apos;</span>
<a name="l00522"></a>00522 <span class="comment">\arg \b vm-gammalt   singular of &apos;old&apos;</span>
<a name="l00523"></a>00523 <span class="comment">\arg \b vm-gamla  plural of &apos;old&apos;</span>
<a name="l00524"></a>00524 <span class="comment">\arg \b digits/ett   &apos;one&apos;, not always same as &apos;digits/1&apos;</span>
<a name="l00525"></a>00525 <span class="comment"></span>
<a name="l00526"></a>00526 <span class="comment">Norwegian uses:</span>
<a name="l00527"></a>00527 <span class="comment">\arg \b vm-ny     singular of &apos;new&apos;</span>
<a name="l00528"></a>00528 <span class="comment">\arg \b vm-nye    plural of &apos;new&apos;</span>
<a name="l00529"></a>00529 <span class="comment">\arg \b vm-gammel singular of &apos;old&apos;</span>
<a name="l00530"></a>00530 <span class="comment">\arg \b vm-gamle  plural of &apos;old&apos;</span>
<a name="l00531"></a>00531 <span class="comment"></span>
<a name="l00532"></a>00532 <span class="comment">Dutch also uses:</span>
<a name="l00533"></a>00533 <span class="comment">\arg \b nl-om     &apos;at&apos;?</span>
<a name="l00534"></a>00534 <span class="comment"></span>
<a name="l00535"></a>00535 <span class="comment">Spanish also uses:</span>
<a name="l00536"></a>00536 <span class="comment">\arg \b vm-youhaveno</span>
<a name="l00537"></a>00537 <span class="comment"></span>
<a name="l00538"></a>00538 <span class="comment">Italian requires the following additional soundfile:</span>
<a name="l00539"></a>00539 <span class="comment"></span>
<a name="l00540"></a>00540 <span class="comment">For vm_intro_it:</span>
<a name="l00541"></a>00541 <span class="comment">\arg \b vm-nuovo  new</span>
<a name="l00542"></a>00542 <span class="comment">\arg \b vm-nuovi  new plural</span>
<a name="l00543"></a>00543 <span class="comment">\arg \b vm-vecchio   old</span>
<a name="l00544"></a>00544 <span class="comment">\arg \b vm-vecchi old plural</span>
<a name="l00545"></a>00545 <span class="comment"></span>
<a name="l00546"></a>00546 <span class="comment">Chinese (Taiwan) requires the following additional soundfile:</span>
<a name="l00547"></a>00547 <span class="comment">\arg \b vm-tong      A class-word for call (tong1)</span>
<a name="l00548"></a>00548 <span class="comment">\arg \b vm-ri     A class-word for day (ri4)</span>
<a name="l00549"></a>00549 <span class="comment">\arg \b vm-you    You (ni3)</span>
<a name="l00550"></a>00550 <span class="comment">\arg \b vm-haveno   Have no (mei2 you3)</span>
<a name="l00551"></a>00551 <span class="comment">\arg \b vm-have     Have (you3)</span>
<a name="l00552"></a>00552 <span class="comment">\arg \b vm-listen   To listen (yao4 ting1)</span>
<a name="l00553"></a>00553 <span class="comment"></span>
<a name="l00554"></a>00554 <span class="comment"></span>
<a name="l00555"></a>00555 <span class="comment">\note Don&apos;t use vm-INBOX or vm-Old, because they are the name of the INBOX and Old folders,</span>
<a name="l00556"></a>00556 <span class="comment">spelled among others when you have to change folder. For the above reasons, vm-INBOX</span>
<a name="l00557"></a>00557 <span class="comment">and vm-Old are spelled plural, to make them sound more as folder name than an adjective.</span>
<a name="l00558"></a>00558 <span class="comment"></span>
<a name="l00559"></a>00559 <span class="comment">*/</span>
<a name="l00560"></a>00560 
<a name="l00561"></a><a class="code" href="structbaseio.html">00561</a> <span class="keyword">struct </span><a class="code" href="structbaseio.html">baseio</a> {
<a name="l00562"></a><a class="code" href="structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">00562</a>    <span class="keywordtype">int</span> iocp;
<a name="l00563"></a><a class="code" href="structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">00563</a>    <span class="keywordtype">int</span> iolen;
<a name="l00564"></a><a class="code" href="structbaseio.html#a4cd390d771f962d39585708c848317e5">00564</a>    <span class="keywordtype">int</span> linelength;
<a name="l00565"></a><a class="code" href="structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">00565</a>    <span class="keywordtype">int</span> ateof;
<a name="l00566"></a><a class="code" href="structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">00566</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iobuf[<a class="code" href="app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>];
<a name="l00567"></a>00567 };
<a name="l00568"></a>00568 <span class="comment"></span>
<a name="l00569"></a>00569 <span class="comment">/*! Structure for linked list of users </span>
<a name="l00570"></a>00570 <span class="comment"> * Use ast_vm_user_destroy() to free one of these structures. */</span>
<a name="l00571"></a><a class="code" href="structast__vm__user.html">00571</a> <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> {
<a name="l00572"></a><a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">00572</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>];   <span class="comment">/*!&lt; Voicemail context */</span>
<a name="l00573"></a><a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">00573</a>    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>]; <span class="comment">/*!&lt; Mailbox id, unique within vm context */</span>
<a name="l00574"></a><a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">00574</a>    <span class="keywordtype">char</span> password[80];               <span class="comment">/*!&lt; Secret pin code, numbers only */</span>
<a name="l00575"></a><a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">00575</a>    <span class="keywordtype">char</span> fullname[80];               <span class="comment">/*!&lt; Full name, for directory app */</span>
<a name="l00576"></a><a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">00576</a>    <span class="keywordtype">char</span> <a class="code" href="pbx__dundi_8c.html#aadd75c09e15efa9061997f033b3f224b">email</a>[80];                  <span class="comment">/*!&lt; E-mail address */</span>
<a name="l00577"></a><a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">00577</a>    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>;              <span class="comment">/*!&lt; E-mail subject */</span>
<a name="l00578"></a><a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">00578</a>    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>;                 <span class="comment">/*!&lt; E-mail body */</span>
<a name="l00579"></a><a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">00579</a>    <span class="keywordtype">char</span> pager[80];                  <span class="comment">/*!&lt; E-mail address to pager (no attachment) */</span>
<a name="l00580"></a><a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">00580</a>    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>[80];            <span class="comment">/*!&lt; From: Mail address */</span>
<a name="l00581"></a><a class="code" href="structast__vm__user.html#a1f5a71f874226acc1147ab54fff050a3">00581</a>    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>[160];               <span class="comment">/*!&lt; Configurable mail command */</span>
<a name="l00582"></a><a class="code" href="structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">00582</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>];     <span class="comment">/*!&lt; Config: Language setting */</span>
<a name="l00583"></a><a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">00583</a>    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>[80];                <span class="comment">/*!&lt; Time zone */</span>
<a name="l00584"></a><a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">00584</a>    <span class="keywordtype">char</span> callback[80];
<a name="l00585"></a><a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">00585</a>    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>[80];
<a name="l00586"></a><a class="code" href="structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">00586</a>    <span class="keywordtype">char</span> uniqueid[80];               <span class="comment">/*!&lt; Unique integer identifier */</span>
<a name="l00587"></a><a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">00587</a>    <span class="keywordtype">char</span> exit[80];
<a name="l00588"></a><a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">00588</a>    <span class="keywordtype">char</span> attachfmt[20];              <span class="comment">/*!&lt; Attachment format */</span>
<a name="l00589"></a><a class="code" href="structast__vm__user.html#ac92588540e8c1d014a08cd8a45462b19">00589</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags;              <span class="comment">/*!&lt; VM_ flags */</span> 
<a name="l00590"></a><a class="code" href="structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">00590</a>    <span class="keywordtype">int</span> saydurationm;
<a name="l00591"></a><a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">00591</a>    <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>;                      <span class="comment">/*!&lt; Maximum number of msgs per folder for this mailbox */</span>
<a name="l00592"></a><a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">00592</a>    <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>;               <span class="comment">/*!&lt; Maximum number of deleted msgs saved for this mailbox */</span>
<a name="l00593"></a><a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">00593</a>    <span class="keywordtype">int</span> maxsecs;                     <span class="comment">/*!&lt; Maximum number of seconds per message for this mailbox */</span>
<a name="l00594"></a>00594 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00595"></a>00595 <span class="preprocessor"></span>   <span class="keywordtype">char</span> imapuser[80];               <span class="comment">/*!&lt; IMAP server login */</span>
<a name="l00596"></a>00596    <span class="keywordtype">char</span> imappassword[80];           <span class="comment">/*!&lt; IMAP server password if authpassword not defined */</span>
<a name="l00597"></a>00597    <span class="keywordtype">char</span> imapvmshareid[80];          <span class="comment">/*!&lt; Shared mailbox ID to use rather than the dialed one */</span>
<a name="l00598"></a>00598    <span class="keywordtype">int</span> imapversion;                 <span class="comment">/*!&lt; If configuration changes, use the new values */</span>
<a name="l00599"></a>00599 <span class="preprocessor">#endif</span>
<a name="l00600"></a><a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">00600</a> <span class="preprocessor"></span>   <span class="keywordtype">double</span> <a class="code" href="app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>;                  <span class="comment">/*!&lt; Volume gain for voicemails sent via email */</span>
<a name="l00601"></a>00601    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structast__vm__user.html">ast_vm_user</a>) list;
<a name="l00602"></a>00602 };
<a name="l00603"></a>00603 <span class="comment"></span>
<a name="l00604"></a>00604 <span class="comment">/*! Voicemail time zones */</span>
<a name="l00605"></a><a class="code" href="structvm__zone.html">00605</a> struct <a class="code" href="structvm__zone.html">vm_zone</a> {
<a name="l00606"></a>00606    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(vm_zone) list;
<a name="l00607"></a>00607    <span class="keywordtype">char</span> <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>[80];
<a name="l00608"></a>00608    <span class="keywordtype">char</span> timezone[80];
<a name="l00609"></a>00609    <span class="keywordtype">char</span> msg_format[512];
<a name="l00610"></a>00610 };
<a name="l00611"></a>00611 
<a name="l00612"></a><a class="code" href="app__voicemail_8c.html#a120b9c8ba5c2f37645d9d3683655e9f9">00612</a> <span class="preprocessor">#define VMSTATE_MAX_MSG_ARRAY 256</span>
<a name="l00613"></a>00613 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00614"></a>00614 <span class="comment">/*! Voicemail mailbox state */</span>
<a name="l00615"></a><a class="code" href="structvm__state.html">00615</a> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> {
<a name="l00616"></a><a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">00616</a>    <span class="keywordtype">char</span> curbox[80];
<a name="l00617"></a><a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">00617</a>    <span class="keywordtype">char</span> username[80];
<a name="l00618"></a><a class="code" href="structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">00618</a>    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>[80];
<a name="l00619"></a><a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">00619</a>    <span class="keywordtype">char</span> curdir[PATH_MAX];
<a name="l00620"></a><a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">00620</a>    <span class="keywordtype">char</span> vmbox[PATH_MAX];
<a name="l00621"></a><a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">00621</a>    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l00622"></a><a class="code" href="structvm__state.html#a6df2b4baa52e93571c0ac57d7f318de5">00622</a>    <span class="keywordtype">char</span> <a class="code" href="res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">intro</a>[PATH_MAX];
<a name="l00623"></a><a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">00623</a>    <span class="keywordtype">int</span> *deleted;
<a name="l00624"></a><a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">00624</a>    <span class="keywordtype">int</span> *heard;
<a name="l00625"></a><a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">00625</a>    <span class="keywordtype">int</span> curmsg;
<a name="l00626"></a><a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">00626</a>    <span class="keywordtype">int</span> lastmsg;
<a name="l00627"></a><a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">00627</a>    <span class="keywordtype">int</span> newmessages;
<a name="l00628"></a><a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">00628</a>    <span class="keywordtype">int</span> oldmessages;
<a name="l00629"></a><a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">00629</a>    <span class="keywordtype">int</span> urgentmessages;
<a name="l00630"></a><a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">00630</a>    <span class="keywordtype">int</span> starting;
<a name="l00631"></a><a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">00631</a>    <span class="keywordtype">int</span> repeats;
<a name="l00632"></a>00632 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00633"></a>00633 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l00634"></a>00634    <span class="keywordtype">int</span> updated;                         <span class="comment">/*!&lt; decremented on each mail check until 1 -allows delay */</span>
<a name="l00635"></a>00635    <span class="keywordtype">long</span> msgArray[<a class="code" href="app__voicemail_8c.html#a120b9c8ba5c2f37645d9d3683655e9f9">VMSTATE_MAX_MSG_ARRAY</a>];
<a name="l00636"></a>00636    MAILSTREAM *mailstream;
<a name="l00637"></a>00637    <span class="keywordtype">int</span> vmArrayIndex;
<a name="l00638"></a>00638    <span class="keywordtype">char</span> imapuser[80];                   <span class="comment">/*!&lt; IMAP server login */</span>
<a name="l00639"></a>00639    <span class="keywordtype">int</span> imapversion;
<a name="l00640"></a>00640    <span class="keywordtype">int</span> interactive;
<a name="l00641"></a>00641    <span class="keywordtype">char</span> introfn[PATH_MAX];              <span class="comment">/*!&lt; Name of prepended file */</span>
<a name="l00642"></a>00642    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> quota_limit;
<a name="l00643"></a>00643    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> quota_usage;
<a name="l00644"></a>00644    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *persist_vms;
<a name="l00645"></a>00645 <span class="preprocessor">#endif</span>
<a name="l00646"></a>00646 <span class="preprocessor"></span>};
<a name="l00647"></a>00647 
<a name="l00648"></a>00648 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l00649"></a>00649 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> odbc_database[80];
<a name="l00650"></a>00650 <span class="keyword">static</span> <span class="keywordtype">char</span> odbc_table[80];
<a name="l00651"></a>00651 <span class="preprocessor">#define RETRIEVE(a,b,c,d) retrieve_file(a,b)</span>
<a name="l00652"></a>00652 <span class="preprocessor"></span><span class="preprocessor">#define DISPOSE(a,b) remove_file(a,b)</span>
<a name="l00653"></a>00653 <span class="preprocessor"></span><span class="preprocessor">#define STORE(a,b,c,d,e,f,g,h,i,j) store_file(a,b,c,d)</span>
<a name="l00654"></a>00654 <span class="preprocessor"></span><span class="preprocessor">#define EXISTS(a,b,c,d) (message_exists(a,b))</span>
<a name="l00655"></a>00655 <span class="preprocessor"></span><span class="preprocessor">#define RENAME(a,b,c,d,e,f,g,h) (rename_file(a,b,c,d,e,f))</span>
<a name="l00656"></a>00656 <span class="preprocessor"></span><span class="preprocessor">#define COPY(a,b,c,d,e,f,g,h) (copy_file(a,b,c,d,e,f))</span>
<a name="l00657"></a>00657 <span class="preprocessor"></span><span class="preprocessor">#define DELETE(a,b,c,d) (delete_file(a,b))</span>
<a name="l00658"></a>00658 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00659"></a>00659 <span class="preprocessor"></span><span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00660"></a>00660 <span class="preprocessor"></span><span class="preprocessor">#define DISPOSE(a,b) (imap_remove_file(a,b))</span>
<a name="l00661"></a>00661 <span class="preprocessor"></span><span class="preprocessor">#define STORE(a,b,c,d,e,f,g,h,i,j) (imap_store_file(a,b,c,d,e,f,g,h,i,j))</span>
<a name="l00662"></a>00662 <span class="preprocessor"></span><span class="preprocessor">#define RETRIEVE(a,b,c,d) imap_retrieve_file(a,b,c,d)</span>
<a name="l00663"></a>00663 <span class="preprocessor"></span><span class="preprocessor">#define EXISTS(a,b,c,d) (ast_fileexists(c,NULL,d) &gt; 0)</span>
<a name="l00664"></a>00664 <span class="preprocessor"></span><span class="preprocessor">#define RENAME(a,b,c,d,e,f,g,h) (rename_file(g,h));</span>
<a name="l00665"></a>00665 <span class="preprocessor"></span><span class="preprocessor">#define COPY(a,b,c,d,e,f,g,h) (copy_file(g,h));</span>
<a name="l00666"></a>00666 <span class="preprocessor"></span><span class="preprocessor">#define DELETE(a,b,c,d) (vm_imap_delete(a,b,d))</span>
<a name="l00667"></a>00667 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00668"></a><a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">00668</a> <span class="preprocessor"></span><span class="preprocessor">#define RETRIEVE(a,b,c,d)</span>
<a name="l00669"></a><a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">00669</a> <span class="preprocessor"></span><span class="preprocessor">#define DISPOSE(a,b)</span>
<a name="l00670"></a><a class="code" href="app__voicemail_8c.html#ab02316037e0d0e5b69b6aef860aabe08">00670</a> <span class="preprocessor"></span><span class="preprocessor">#define STORE(a,b,c,d,e,f,g,h,i,j)</span>
<a name="l00671"></a><a class="code" href="app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">00671</a> <span class="preprocessor"></span><span class="preprocessor">#define EXISTS(a,b,c,d) (ast_fileexists(c,NULL,d) &gt; 0)</span>
<a name="l00672"></a><a class="code" href="app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">00672</a> <span class="preprocessor"></span><span class="preprocessor">#define RENAME(a,b,c,d,e,f,g,h) (rename_file(g,h));</span>
<a name="l00673"></a><a class="code" href="app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">00673</a> <span class="preprocessor"></span><span class="preprocessor">#define COPY(a,b,c,d,e,f,g,h) (copy_plain_file(g,h)); </span>
<a name="l00674"></a><a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">00674</a> <span class="preprocessor"></span><span class="preprocessor">#define DELETE(a,b,c,d) (vm_delete(c))</span>
<a name="l00675"></a>00675 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00676"></a>00676 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00677"></a>00677 <span class="preprocessor"></span>
<a name="l00678"></a><a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">00678</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>[PATH_MAX];
<a name="l00679"></a>00679 
<a name="l00680"></a><a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">00680</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>[128];
<a name="l00681"></a><a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">00681</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>[128];
<a name="l00682"></a>00682 
<a name="l00683"></a><a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">00683</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a>;
<a name="l00684"></a>00684 
<a name="l00685"></a><a class="code" href="app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">00685</a> <span class="preprocessor">#define PWDCHANGE_INTERNAL (1 &lt;&lt; 1)</span>
<a name="l00686"></a><a class="code" href="app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">00686</a> <span class="preprocessor"></span><span class="preprocessor">#define PWDCHANGE_EXTERNAL (1 &lt;&lt; 2)</span>
<a name="l00687"></a><a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">00687</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> = <a class="code" href="app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l00690"></a>00690 <span class="preprocessor"></span><span class="preprocessor">#define tdesc &quot;Comedian Mail (Voicemail System) with ODBC Storage&quot;</span>
<a name="l00691"></a>00691 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l00692"></a>00692 <span class="preprocessor"></span><span class="preprocessor"># ifdef IMAP_STORAGE</span>
<a name="l00693"></a>00693 <span class="preprocessor"></span><span class="preprocessor"># define tdesc &quot;Comedian Mail (Voicemail System) with IMAP Storage&quot;</span>
<a name="l00694"></a>00694 <span class="preprocessor"></span><span class="preprocessor"># else</span>
<a name="l00695"></a><a class="code" href="app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">00695</a> <span class="preprocessor"></span><span class="preprocessor"># define tdesc &quot;Comedian Mail (Voicemail System)&quot;</span>
<a name="l00696"></a>00696 <span class="preprocessor"></span><span class="preprocessor"># endif</span>
<a name="l00697"></a>00697 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00698"></a>00698 <span class="preprocessor"></span>
<a name="l00699"></a><a class="code" href="app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">00699</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l00700"></a>00700 
<a name="l00701"></a><a class="code" href="app__voicemail_8c.html#addcd618c70c26637518d590003c700c2">00701</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#addcd618c70c26637518d590003c700c2">addesc</a> = <span class="stringliteral">&quot;Comedian Mail&quot;</span>;
<a name="l00702"></a>00702 
<a name="l00703"></a>00703 <span class="comment">/* Leave a message */</span>
<a name="l00704"></a><a class="code" href="app__voicemail_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">00704</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = <span class="stringliteral">&quot;VoiceMail&quot;</span>;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706 <span class="comment">/* Check mail, control, etc */</span>
<a name="l00707"></a><a class="code" href="app__voicemail_8c.html#a481fef4b16e813bdf173274384491281">00707</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a481fef4b16e813bdf173274384491281">app2</a> = <span class="stringliteral">&quot;VoiceMailMain&quot;</span>;
<a name="l00708"></a>00708 
<a name="l00709"></a><a class="code" href="app__voicemail_8c.html#aeee927ac8205016fe2119d75793e9c07">00709</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#aeee927ac8205016fe2119d75793e9c07">app3</a> = <span class="stringliteral">&quot;MailboxExists&quot;</span>;
<a name="l00710"></a><a class="code" href="app__voicemail_8c.html#a7c76a62fa9a3feb78b315578d82e4a48">00710</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a7c76a62fa9a3feb78b315578d82e4a48">app4</a> = <span class="stringliteral">&quot;VMAuthenticate&quot;</span>;
<a name="l00711"></a>00711 
<a name="l00712"></a>00712 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, <a class="code" href="structast__vm__user.html">ast_vm_user</a>);
<a name="l00713"></a>00713 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(zones, <a class="code" href="structvm__zone.html">vm_zone</a>);
<a name="l00714"></a><a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">00714</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>[80];
<a name="l00715"></a><a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">00715</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>;
<a name="l00716"></a><a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">00716</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>;
<a name="l00717"></a><a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">00717</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>;
<a name="l00718"></a><a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">00718</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a> = 128;
<a name="l00719"></a><a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">00719</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>[80];
<a name="l00720"></a><a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">00720</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>[160];  <span class="comment">/* Configurable mail cmd */</span>
<a name="l00721"></a><a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">00721</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>[160]; 
<a name="l00722"></a><a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">00722</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__smdi__interface.html">ast_smdi_interface</a> *<a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a> = NULL;
<a name="l00723"></a><a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">00723</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>[80];
<a name="l00724"></a><a class="code" href="app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">00724</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>;
<a name="l00725"></a><a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">00725</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>;
<a name="l00726"></a><a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">00726</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>;
<a name="l00727"></a><a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">00727</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>;
<a name="l00728"></a><a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">00728</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a>;
<a name="l00729"></a><a class="code" href="app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">00729</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">maxlogins</a>;
<a name="l00730"></a><a class="code" href="app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">00730</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a>;
<a name="l00731"></a>00731 <span class="comment"></span>
<a name="l00732"></a>00732 <span class="comment">/*! Poll mailboxes for changes since there is something external to</span>
<a name="l00733"></a>00733 <span class="comment"> *  app_voicemail that may change them. */</span>
<a name="l00734"></a><a class="code" href="app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">00734</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a>;
<a name="l00735"></a>00735 <span class="comment"></span>
<a name="l00736"></a>00736 <span class="comment">/*! Polling frequency */</span>
<a name="l00737"></a><a class="code" href="app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">00737</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a>;<span class="comment"></span>
<a name="l00738"></a>00738 <span class="comment">/*! By default, poll every 30 seconds */</span>
<a name="l00739"></a><a class="code" href="app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">00739</a> <span class="preprocessor">#define DEFAULT_POLL_FREQ 30</span>
<a name="l00740"></a>00740 <span class="preprocessor"></span>
<a name="l00741"></a>00741 <a class="code" href="lock_8h.html#ac840092853644cea0a186efdc58985f5">AST_MUTEX_DEFINE_STATIC</a>(poll_lock);
<a name="l00742"></a><a class="code" href="app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">00742</a> <span class="keyword">static</span> <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">poll_cond</a> = PTHREAD_COND_INITIALIZER;
<a name="l00743"></a><a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">00743</a> <span class="keyword">static</span> pthread_t <a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l00744"></a><a class="code" href="app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">00744</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a>;
<a name="l00745"></a>00745 <span class="comment"></span>
<a name="l00746"></a>00746 <span class="comment">/*! Subscription to ... MWI event subscriptions */</span>
<a name="l00747"></a><a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">00747</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *<a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a>;<span class="comment"></span>
<a name="l00748"></a>00748 <span class="comment">/*! Subscription to ... MWI event un-subscriptions */</span>
<a name="l00749"></a><a class="code" href="app__voicemail_8c.html#a19bcada07e6dab968098269032e41c5b">00749</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__event__sub.html" title="Event subscription.">ast_event_sub</a> *<a class="code" href="app__voicemail_8c.html#a19bcada07e6dab968098269032e41c5b">mwi_unsub_sub</a>;
<a name="l00750"></a>00750 <span class="comment"></span>
<a name="l00751"></a>00751 <span class="comment">/*!</span>
<a name="l00752"></a>00752 <span class="comment"> * \brief An MWI subscription</span>
<a name="l00753"></a>00753 <span class="comment"> *</span>
<a name="l00754"></a>00754 <span class="comment"> * This is so we can keep track of which mailboxes are subscribed to.</span>
<a name="l00755"></a>00755 <span class="comment"> * This way, we know which mailboxes to poll when the pollmailboxes</span>
<a name="l00756"></a>00756 <span class="comment"> * option is being used.</span>
<a name="l00757"></a>00757 <span class="comment"> */</span>
<a name="l00758"></a><a class="code" href="structmwi__sub.html">00758</a> <span class="keyword">struct </span><a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a> {
<a name="l00759"></a>00759    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>) entry;
<a name="l00760"></a>00760    <span class="keywordtype">int</span> old_urgent;
<a name="l00761"></a>00761    <span class="keywordtype">int</span> old_new;
<a name="l00762"></a>00762    <span class="keywordtype">int</span> old_old;
<a name="l00763"></a>00763    uint32_t uniqueid;
<a name="l00764"></a>00764    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>[1];
<a name="l00765"></a>00765 };
<a name="l00766"></a>00766 
<a name="l00767"></a><a class="code" href="structmwi__sub__task.html">00767</a> <span class="keyword">struct </span><a class="code" href="structmwi__sub__task.html">mwi_sub_task</a> {
<a name="l00768"></a><a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">00768</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>;
<a name="l00769"></a><a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">00769</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l00770"></a><a class="code" href="structmwi__sub__task.html#a118e8a66b7de05b645dbfbb7e964024c">00770</a>    uint32_t uniqueid;
<a name="l00771"></a>00771 };
<a name="l00772"></a>00772 
<a name="l00773"></a><a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">00773</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__taskprocessor.html" title="A ast_taskprocessor structure is a singleton by name.">ast_taskprocessor</a> *<a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a>;
<a name="l00774"></a>00774 
<a name="l00775"></a>00775 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(mwi_subs, <a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777 <span class="comment">/* custom audio control prompts for voicemail playback */</span>
<a name="l00778"></a><a class="code" href="app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">00778</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a>[12];
<a name="l00779"></a><a class="code" href="app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">00779</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a>[12];
<a name="l00780"></a><a class="code" href="app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">00780</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a>[12];
<a name="l00781"></a><a class="code" href="app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">00781</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a>[12];
<a name="l00782"></a><a class="code" href="app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">00782</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a>[12];
<a name="l00783"></a>00783 
<a name="l00784"></a>00784 <span class="comment">/* custom password sounds */</span>
<a name="l00785"></a><a class="code" href="app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">00785</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">vm_password</a>[80] = <span class="stringliteral">&quot;vm-password&quot;</span>;
<a name="l00786"></a><a class="code" href="app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">00786</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a>[80] = <span class="stringliteral">&quot;vm-newpassword&quot;</span>;
<a name="l00787"></a><a class="code" href="app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">00787</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a>[80] = <span class="stringliteral">&quot;vm-passchanged&quot;</span>;
<a name="l00788"></a><a class="code" href="app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">00788</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a>[80] = <span class="stringliteral">&quot;vm-reenterpassword&quot;</span>;
<a name="l00789"></a><a class="code" href="app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">00789</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a>[80] = <span class="stringliteral">&quot;vm-mismatch&quot;</span>;
<a name="l00790"></a><a class="code" href="app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">00790</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a>[80] = <span class="stringliteral">&quot;vm-invalid-password&quot;</span>;
<a name="l00791"></a><a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">00791</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>[80] = <span class="stringliteral">&quot;vm-pls-try-again&quot;</span>;
<a name="l00792"></a>00792 
<a name="l00793"></a><a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">00793</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a> = {0};
<a name="l00794"></a>00794 
<a name="l00795"></a><a class="code" href="app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">00795</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a>;
<a name="l00796"></a>00796 
<a name="l00797"></a><a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">00797</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00798"></a><a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">00798</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00799"></a><a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">00799</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00800"></a>00800 
<a name="l00801"></a><a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">00801</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[<a class="code" href="app__minivm_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a>][64];
<a name="l00802"></a>00802 
<a name="l00803"></a>00803 
<a name="l00804"></a><a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">00804</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = NULL;
<a name="l00805"></a><a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">00805</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = NULL;
<a name="l00806"></a><a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">00806</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a> = NULL;
<a name="l00807"></a><a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">00807</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a> = NULL;
<a name="l00808"></a><a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">00808</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>[100];
<a name="l00809"></a><a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">00809</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>[100];
<a name="l00810"></a><a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">00810</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>[32] = <span class="stringliteral">&quot;ISO-8859-1&quot;</span>;
<a name="l00811"></a>00811 
<a name="l00812"></a><a class="code" href="app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">00812</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a>[4] = <span class="stringliteral">&quot;\x00\x00\x00\x0F&quot;</span>;
<a name="l00813"></a><a class="code" href="app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767">00813</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767">adsisec</a>[4] = <span class="stringliteral">&quot;\x9B\xDB\xF7\xAC&quot;</span>;
<a name="l00814"></a><a class="code" href="app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">00814</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a> = 1;
<a name="l00815"></a><a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">00815</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>[32] = <span class="stringliteral">&quot;%A, %B %d, %Y at %r&quot;</span>;
<a name="l00816"></a>00816 
<a name="l00817"></a>00817 <span class="comment">/* Forward declarations - generic */</span>
<a name="l00818"></a>00818 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box);
<a name="l00819"></a>00819 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921" title="The advanced options within a message.">advanced_options</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> option, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain);
<a name="l00820"></a>00820 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>, <span class="keywordtype">char</span> *outgoing_context);
<a name="l00821"></a>00821 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *playfile, <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime,
<a name="l00822"></a>00822          <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> outsidecaller, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> *duration, <span class="keyword">const</span> <span class="keywordtype">char</span> *unlockdir,
<a name="l00823"></a>00823          <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *flag);
<a name="l00824"></a>00824 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650" title="The handler for &amp;#39;record a temporary greeting&amp;#39;.">vm_tempgreeting</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain);
<a name="l00825"></a>00825 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>);
<a name="l00826"></a>00826 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158" title="Sends email notification that a user has a new voicemail waiting for them.">notify_new_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag);
<a name="l00827"></a>00827 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#ae3cbc800cf1d17d77a43c57a6015a4f2" title="Creates the email file to be sent to indicate a new voicemail exists for a user.">make_email_file</a>(FILE *p, <span class="keywordtype">char</span> *srcemail, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *attach2, <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">int</span> duration, <span class="keywordtype">int</span> attach_user_voicemail, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keywordtype">int</span> imap, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag);
<a name="l00828"></a>00828 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2" title="Destructively Parse options and apply.">apply_options</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *options);
<a name="l00829"></a>00829 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(FILE *p, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *greeting_attachment, <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keywordtype">char</span> *bound, <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>, <span class="keywordtype">int</span> msgnum);
<a name="l00830"></a>00830 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *key);
<a name="l00831"></a>00831 
<a name="l00832"></a><a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">00832</a> <span class="keyword">struct </span><a class="code" href="structao2__container.html">ao2_container</a> *<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>;
<a name="l00833"></a>00833 
<a name="l00834"></a><a class="code" href="structinprocess.html">00834</a> <span class="keyword">struct </span><a class="code" href="structinprocess.html">inprocess</a> {
<a name="l00835"></a><a class="code" href="structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">00835</a>    <span class="keywordtype">int</span> count;
<a name="l00836"></a><a class="code" href="structinprocess.html#a1f27749679e8054ef014a38569492895">00836</a>    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l00837"></a><a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">00837</a>    <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>[0];
<a name="l00838"></a>00838 };
<a name="l00839"></a>00839 
<a name="l00840"></a><a class="code" href="app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039">00840</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039">inprocess_hash_fn</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *obj, <span class="keyword">const</span> <span class="keywordtype">int</span> flags)
<a name="l00841"></a>00841 {
<a name="l00842"></a>00842    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structinprocess.html">inprocess</a> *i = obj;
<a name="l00843"></a>00843    <span class="keywordflow">return</span> atoi(i-&gt;<a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>);
<a name="l00844"></a>00844 }
<a name="l00845"></a>00845 
<a name="l00846"></a><a class="code" href="app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90">00846</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90">inprocess_cmp_fn</a>(<span class="keywordtype">void</span> *obj, <span class="keywordtype">void</span> *arg, <span class="keywordtype">int</span> flags)
<a name="l00847"></a>00847 {
<a name="l00848"></a>00848    <span class="keyword">struct </span><a class="code" href="structinprocess.html">inprocess</a> *i = obj, *j = arg;
<a name="l00849"></a>00849    <span class="keywordflow">if</span> (!strcmp(i-&gt;<a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>, j-&gt;mailbox)) {
<a name="l00850"></a>00850       <span class="keywordflow">return</span> 0;
<a name="l00851"></a>00851    }
<a name="l00852"></a>00852    <span class="keywordflow">return</span> !strcmp(i-&gt;<a class="code" href="structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>, j-&gt;context) ? <a class="code" href="astobj2_8h.html#a1f8b41308be4c47de8ff89a3b9c7e7d1a1959468a3c5d6aecd2fa1272d8e30fbf">CMP_MATCH</a> : 0;
<a name="l00853"></a>00853 }
<a name="l00854"></a>00854 
<a name="l00855"></a><a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">00855</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keywordtype">int</span> delta)
<a name="l00856"></a>00856 {
<a name="l00857"></a>00857    <span class="keyword">struct </span><a class="code" href="structinprocess.html">inprocess</a> *i, *arg = alloca(<span class="keyword">sizeof</span>(*arg) + strlen(context) + strlen(mailbox) + 2);
<a name="l00858"></a>00858    arg-&gt;<a class="code" href="structinprocess.html#a1f27749679e8054ef014a38569492895">context</a> = arg-&gt;<a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a> + strlen(mailbox) + 1;
<a name="l00859"></a>00859    strcpy(arg-&gt;<a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>, mailbox); <span class="comment">/* SAFE */</span>
<a name="l00860"></a>00860    strcpy(arg-&gt;<a class="code" href="structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>, context); <span class="comment">/* SAFE */</span>
<a name="l00861"></a>00861    <a class="code" href="astobj2_8h.html#a3077056d07f6f9e348a54a743769bad5" title="Lock an object.">ao2_lock</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>);
<a name="l00862"></a>00862    <span class="keywordflow">if</span> ((i = <a class="code" href="astobj2_8h.html#a618587b42226725315b96db394b13673">ao2_find</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>, arg, 0))) {
<a name="l00863"></a>00863       <span class="keywordtype">int</span> ret = <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;i-&gt;<a class="code" href="structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a>, delta);
<a name="l00864"></a>00864       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>);
<a name="l00865"></a>00865       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(i, -1);
<a name="l00866"></a>00866       <span class="keywordflow">return</span> ret;
<a name="l00867"></a>00867    }
<a name="l00868"></a>00868    <span class="keywordflow">if</span> (!(i = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*i) + strlen(context) + strlen(mailbox) + 2, NULL))) {
<a name="l00869"></a>00869       <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>);
<a name="l00870"></a>00870       <span class="keywordflow">return</span> 0;
<a name="l00871"></a>00871    }
<a name="l00872"></a>00872    i-&gt;<a class="code" href="structinprocess.html#a1f27749679e8054ef014a38569492895">context</a> = i-&gt;<a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a> + strlen(mailbox) + 1;
<a name="l00873"></a>00873    strcpy(i-&gt;<a class="code" href="structinprocess.html#aaea3b00555054087360d600593121f95">mailbox</a>, mailbox); <span class="comment">/* SAFE */</span>
<a name="l00874"></a>00874    strcpy(i-&gt;<a class="code" href="structinprocess.html#a1f27749679e8054ef014a38569492895">context</a>, context); <span class="comment">/* SAFE */</span>
<a name="l00875"></a>00875    i-&gt;<a class="code" href="structinprocess.html#ad43c3812e6d13e0518d9f8b8f463ffcf">count</a> = delta;
<a name="l00876"></a>00876    <a class="code" href="astobj2_8h.html#a210544bdcc5afe0601d01d6e529c22d8">ao2_link</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>, i);
<a name="l00877"></a>00877    <a class="code" href="astobj2_8h.html#a379cc936a320f2179f7beb422dc15230" title="Unlock an object.">ao2_unlock</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>);
<a name="l00878"></a>00878    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(i, -1);
<a name="l00879"></a>00879    <span class="keywordflow">return</span> 0;
<a name="l00880"></a>00880 }
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="preprocessor">#if !(defined(ODBC_STORAGE) || defined(IMAP_STORAGE))</span>
<a name="l00883"></a>00883 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keywordtype">int</span> shortcircuit);
<a name="l00884"></a>00884 <span class="preprocessor">#endif</span>
<a name="l00885"></a>00885 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00886"></a>00886 <span class="comment">/*!</span>
<a name="l00887"></a>00887 <span class="comment"> * \brief Strips control and non 7-bit clean characters from input string.</span>
<a name="l00888"></a>00888 <span class="comment"> *</span>
<a name="l00889"></a>00889 <span class="comment"> * \note To map control and none 7-bit characters to a 7-bit clean characters</span>
<a name="l00890"></a>00890 <span class="comment"> *  please use ast_str_encode_mine().</span>
<a name="l00891"></a>00891 <span class="comment"> */</span>
<a name="l00892"></a><a class="code" href="app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c">00892</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c" title="Strips control and non 7-bit clean characters from input string.">strip_control_and_high</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a5a634cf4429798b1c921a81de8250051">input</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> buflen)
<a name="l00893"></a>00893 {
<a name="l00894"></a>00894    <span class="keywordtype">char</span> *bufptr = buf;
<a name="l00895"></a>00895    <span class="keywordflow">for</span> (; *input; input++) {
<a name="l00896"></a>00896       <span class="keywordflow">if</span> (*input &lt; 32) {
<a name="l00897"></a>00897          <span class="keywordflow">continue</span>;
<a name="l00898"></a>00898       }
<a name="l00899"></a>00899       *bufptr++ = *input;
<a name="l00900"></a>00900       <span class="keywordflow">if</span> (bufptr == buf + buflen - 1) {
<a name="l00901"></a>00901          <span class="keywordflow">break</span>;
<a name="l00902"></a>00902       }
<a name="l00903"></a>00903    }
<a name="l00904"></a>00904    *bufptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00905"></a>00905    <span class="keywordflow">return</span> buf;
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00908"></a>00908 <span class="comment"></span>
<a name="l00909"></a>00909 <span class="comment">/*!</span>
<a name="l00910"></a>00910 <span class="comment"> * \brief Sets default voicemail system options to a voicemail user.</span>
<a name="l00911"></a>00911 <span class="comment"> *</span>
<a name="l00912"></a>00912 <span class="comment"> * This applies select global settings to a newly created (dynamic) instance of a voicemail user.</span>
<a name="l00913"></a>00913 <span class="comment"> * - all the globalflags</span>
<a name="l00914"></a>00914 <span class="comment"> * - the saydurationminfo</span>
<a name="l00915"></a>00915 <span class="comment"> * - the callcontext</span>
<a name="l00916"></a>00916 <span class="comment"> * - the dialcontext</span>
<a name="l00917"></a>00917 <span class="comment"> * - the exitcontext</span>
<a name="l00918"></a>00918 <span class="comment"> * - vmmaxsecs, vmmaxmsg, maxdeletedmsg</span>
<a name="l00919"></a>00919 <span class="comment"> * - volume gain.</span>
<a name="l00920"></a>00920 <span class="comment"> */</span>
<a name="l00921"></a><a class="code" href="app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0">00921</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0" title="Sets default voicemail system options to a voicemail user.">populate_defaults</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l00922"></a>00922 {
<a name="l00923"></a>00923    <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(vmu, (&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="utils_8h.html#afb8683b4d96960d7a82a86a974a57599">AST_FLAGS_ALL</a>);   
<a name="l00924"></a>00924    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a>)
<a name="l00925"></a>00925       vmu-&gt;<a class="code" href="structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a> = <a class="code" href="app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a>;
<a name="l00926"></a>00926    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>, <a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>));
<a name="l00927"></a>00927    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>, <a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>));
<a name="l00928"></a>00928    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>));
<a name="l00929"></a>00929    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, <a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));
<a name="l00930"></a>00930    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>)
<a name="l00931"></a>00931       vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>;
<a name="l00932"></a>00932    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>)
<a name="l00933"></a>00933       vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>;
<a name="l00934"></a>00934    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>)
<a name="l00935"></a>00935       vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>;
<a name="l00936"></a>00936    vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> = <a class="code" href="app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>;
<a name="l00937"></a>00937    vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = NULL;
<a name="l00938"></a>00938    vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = NULL;
<a name="l00939"></a>00939 }
<a name="l00940"></a>00940 <span class="comment"></span>
<a name="l00941"></a>00941 <span class="comment">/*!</span>
<a name="l00942"></a>00942 <span class="comment"> * \brief Sets a a specific property value.</span>
<a name="l00943"></a>00943 <span class="comment"> * \param vmu The voicemail user object to work with.</span>
<a name="l00944"></a>00944 <span class="comment"> * \param var The name of the property to be set.</span>
<a name="l00945"></a>00945 <span class="comment"> * \param value The value to be set to the property.</span>
<a name="l00946"></a>00946 <span class="comment"> * </span>
<a name="l00947"></a>00947 <span class="comment"> * The property name must be one of the understood properties. See the source for details.</span>
<a name="l00948"></a>00948 <span class="comment"> */</span>
<a name="l00949"></a><a class="code" href="app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587">00949</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587" title="Sets a a specific property value.">apply_option</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l00950"></a>00950 {
<a name="l00951"></a>00951    <span class="keywordtype">int</span> x;
<a name="l00952"></a>00952    <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;attach&quot;</span>)) {
<a name="l00953"></a>00953       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);
<a name="l00954"></a>00954    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;attachfmt&quot;</span>)) {
<a name="l00955"></a>00955       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>));
<a name="l00956"></a>00956    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;serveremail&quot;</span>)) {
<a name="l00957"></a>00957       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>));
<a name="l00958"></a>00958    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;language&quot;</span>)) {
<a name="l00959"></a>00959       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>));
<a name="l00960"></a>00960    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;tz&quot;</span>)) {
<a name="l00961"></a>00961       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));
<a name="l00962"></a>00962 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l00963"></a>00963 <span class="preprocessor"></span>   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapuser&quot;</span>)) {
<a name="l00964"></a>00964       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;imapuser, value, <span class="keyword">sizeof</span>(vmu-&gt;imapuser));
<a name="l00965"></a>00965       vmu-&gt;imapversion = imapversion;
<a name="l00966"></a>00966    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imappassword&quot;</span>) || !strcasecmp(var, <span class="stringliteral">&quot;imapsecret&quot;</span>)) {
<a name="l00967"></a>00967       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;imappassword, value, <span class="keyword">sizeof</span>(vmu-&gt;imappassword));
<a name="l00968"></a>00968       vmu-&gt;imapversion = imapversion;
<a name="l00969"></a>00969    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;imapvmshareid&quot;</span>)) {
<a name="l00970"></a>00970       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;imapvmshareid, value, <span class="keyword">sizeof</span>(vmu-&gt;imapvmshareid));
<a name="l00971"></a>00971       vmu-&gt;imapversion = imapversion;
<a name="l00972"></a>00972 <span class="preprocessor">#endif</span>
<a name="l00973"></a>00973 <span class="preprocessor"></span>   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;delete&quot;</span>) || !strcasecmp(var, <span class="stringliteral">&quot;deletevoicemail&quot;</span>)) {
<a name="l00974"></a>00974       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>); 
<a name="l00975"></a>00975    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;saycid&quot;</span>)){
<a name="l00976"></a>00976       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>); 
<a name="l00977"></a>00977    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var,<span class="stringliteral">&quot;sendvoicemail&quot;</span>)){
<a name="l00978"></a>00978       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>); 
<a name="l00979"></a>00979    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;review&quot;</span>)){
<a name="l00980"></a>00980       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>);
<a name="l00981"></a>00981    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;tempgreetwarn&quot;</span>)){
<a name="l00982"></a>00982       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>);   
<a name="l00983"></a>00983    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;messagewrap&quot;</span>)){
<a name="l00984"></a>00984       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>);  
<a name="l00985"></a>00985    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;operator&quot;</span>)) {
<a name="l00986"></a>00986       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>);  
<a name="l00987"></a>00987    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;envelope&quot;</span>)){
<a name="l00988"></a>00988       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>);  
<a name="l00989"></a>00989    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;moveheard&quot;</span>)){
<a name="l00990"></a>00990       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>);
<a name="l00991"></a>00991    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;sayduration&quot;</span>)){
<a name="l00992"></a>00992       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>);  
<a name="l00993"></a>00993    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;saydurationm&quot;</span>)){
<a name="l00994"></a>00994       <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l00995"></a>00995          vmu-&gt;<a class="code" href="structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a> = x;
<a name="l00996"></a>00996       } <span class="keywordflow">else</span> {
<a name="l00997"></a>00997          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min duration for say duration\n&quot;</span>);
<a name="l00998"></a>00998       }
<a name="l00999"></a>00999    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;forcename&quot;</span>)){
<a name="l01000"></a>01000       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>); 
<a name="l01001"></a>01001    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;forcegreetings&quot;</span>)){
<a name="l01002"></a>01002       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value), <a class="code" href="app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>);   
<a name="l01003"></a>01003    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;callback&quot;</span>)) {
<a name="l01004"></a>01004       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>));
<a name="l01005"></a>01005    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;dialout&quot;</span>)) {
<a name="l01006"></a>01006       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>));
<a name="l01007"></a>01007    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;exitcontext&quot;</span>)) {
<a name="l01008"></a>01008       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, value, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>));
<a name="l01009"></a>01009    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;maxmessage&quot;</span>) || !strcasecmp(var, <span class="stringliteral">&quot;maxsecs&quot;</span>)) {
<a name="l01010"></a>01010       vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = atoi(value);
<a name="l01011"></a>01011       <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> &lt;= 0) {
<a name="l01012"></a>01012          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message length of %s. Using global value %d\n&quot;</span>, value, <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>);
<a name="l01013"></a>01013          vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a>;
<a name="l01014"></a>01014       } <span class="keywordflow">else</span> {
<a name="l01015"></a>01015          vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a> = atoi(value);
<a name="l01016"></a>01016       }
<a name="l01017"></a>01017       <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;maxmessage&quot;</span>))
<a name="l01018"></a>01018          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Option &apos;maxmessage&apos; has been deprecated in favor of &apos;maxsecs&apos;.  Please make that change in your voicemail config.\n&quot;</span>);
<a name="l01019"></a>01019    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;maxmsg&quot;</span>)) {
<a name="l01020"></a>01020       vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = atoi(value);
<a name="l01021"></a>01021       <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &lt;= 0) {
<a name="l01022"></a>01022          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages per folder maxmsg=%s. Using default value %d\n&quot;</span>, value, <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);
<a name="l01023"></a>01023          vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l01024"></a>01024       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &gt; <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {
<a name="l01025"></a>01025          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of messages per folder is %d. Cannot accept value maxmsg=%s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, value);
<a name="l01026"></a>01026          vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;
<a name="l01027"></a>01027       }
<a name="l01028"></a>01028    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;backupdeleted&quot;</span>)) {
<a name="l01029"></a>01029       <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1)
<a name="l01030"></a>01030          vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = x;
<a name="l01031"></a>01031       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(value))
<a name="l01032"></a>01032          vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l01033"></a>01033       <span class="keywordflow">else</span>
<a name="l01034"></a>01034          vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = 0;
<a name="l01035"></a>01035 
<a name="l01036"></a>01036       <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> &lt; 0) {
<a name="l01037"></a>01037          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of deleted messages saved per mailbox backupdeleted=%s. Using default value %d\n&quot;</span>, value, <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);
<a name="l01038"></a>01038          vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l01039"></a>01039       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> &gt; <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {
<a name="l01040"></a>01040          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of deleted messages saved per mailbox is %d. Cannot accept value backupdeleted=%s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, value);
<a name="l01041"></a>01041          vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;
<a name="l01042"></a>01042       }
<a name="l01043"></a>01043    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;volgain&quot;</span>)) {
<a name="l01044"></a>01044       sscanf(value, <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>);
<a name="l01045"></a>01045    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var, <span class="stringliteral">&quot;options&quot;</span>)) {
<a name="l01046"></a>01046       <a class="code" href="app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2" title="Destructively Parse options and apply.">apply_options</a>(vmu, value);
<a name="l01047"></a>01047    }
<a name="l01048"></a>01048 }
<a name="l01049"></a>01049 
<a name="l01050"></a><a class="code" href="app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f">01050</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f">vm_check_password_shell</a>(<span class="keywordtype">char</span> *command, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>) 
<a name="l01051"></a>01051 {
<a name="l01052"></a>01052    <span class="keywordtype">int</span> fds[2], pid = 0;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054    memset(buf, 0, len);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056    <span class="keywordflow">if</span> (pipe(fds)) {
<a name="l01057"></a>01057       snprintf(buf, len, <span class="stringliteral">&quot;FAILURE: Pipe failed: %s&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01058"></a>01058    } <span class="keywordflow">else</span> {
<a name="l01059"></a>01059       <span class="comment">/* good to go*/</span>
<a name="l01060"></a>01060       pid = <a class="code" href="app_8h.html#a7a4c7e208ffc4d11a1918beb0e920ec0" title="Common routine to safely fork without a chance of a signal handler firing badly in...">ast_safe_fork</a>(0);
<a name="l01061"></a>01061 
<a name="l01062"></a>01062       <span class="keywordflow">if</span> (pid &lt; 0) {
<a name="l01063"></a>01063          <span class="comment">/* ok maybe not */</span>
<a name="l01064"></a>01064          close(fds[0]);
<a name="l01065"></a>01065          close(fds[1]);
<a name="l01066"></a>01066          snprintf(buf, len, <span class="stringliteral">&quot;FAILURE: Fork failed&quot;</span>);
<a name="l01067"></a>01067       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pid) {
<a name="l01068"></a>01068          <span class="comment">/* parent */</span>
<a name="l01069"></a>01069          close(fds[1]);
<a name="l01070"></a>01070          <span class="keywordflow">if</span> (read(fds[0], buf, len) &lt; 0) {
<a name="l01071"></a>01071             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;read() failed: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01072"></a>01072          }
<a name="l01073"></a>01073          close(fds[0]);
<a name="l01074"></a>01074       } <span class="keywordflow">else</span> {
<a name="l01075"></a>01075          <span class="comment">/*  child */</span>
<a name="l01076"></a>01076          <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(arg,
<a name="l01077"></a>01077             <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(v)[20];
<a name="l01078"></a>01078          );
<a name="l01079"></a>01079          <span class="keywordtype">char</span> *mycmd = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(command);
<a name="l01080"></a>01080 
<a name="l01081"></a>01081          close(fds[0]);
<a name="l01082"></a>01082          dup2(fds[1], STDOUT_FILENO);
<a name="l01083"></a>01083          close(fds[1]);
<a name="l01084"></a>01084          <a class="code" href="app_8h.html#afcbfdd6dfc8c5f0f549b0a5d7e263e97" title="Common routine for child processes, to close all fds prior to exec(2).">ast_close_fds_above_n</a>(STDOUT_FILENO);
<a name="l01085"></a>01085 
<a name="l01086"></a>01086          <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(arg, mycmd, <span class="charliteral">&apos; &apos;</span>);
<a name="l01087"></a>01087 
<a name="l01088"></a>01088          execv(arg.v[0], arg.v); 
<a name="l01089"></a>01089          printf(<span class="stringliteral">&quot;FAILURE: %s&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01090"></a>01090          _exit(0);
<a name="l01091"></a>01091       }
<a name="l01092"></a>01092    }
<a name="l01093"></a>01093    <span class="keywordflow">return</span> buf;
<a name="l01094"></a>01094 }
<a name="l01095"></a>01095 <span class="comment"></span>
<a name="l01096"></a>01096 <span class="comment">/*!</span>
<a name="l01097"></a>01097 <span class="comment"> * \brief Check that password meets minimum required length</span>
<a name="l01098"></a>01098 <span class="comment"> * \param vmu The voicemail user to change the password for.</span>
<a name="l01099"></a>01099 <span class="comment"> * \param password The password string to check</span>
<a name="l01100"></a>01100 <span class="comment"> *</span>
<a name="l01101"></a>01101 <span class="comment"> * \return zero on ok, 1 on not ok.</span>
<a name="l01102"></a>01102 <span class="comment"> */</span>
<a name="l01103"></a><a class="code" href="app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc">01103</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc" title="Check that password meets minimum required length.">check_password</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *password)
<a name="l01104"></a>01104 {
<a name="l01105"></a>01105    <span class="comment">/* check minimum length */</span>
<a name="l01106"></a>01106    <span class="keywordflow">if</span> (strlen(password) &lt; <a class="code" href="app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a>)
<a name="l01107"></a>01107       <span class="keywordflow">return</span> 1;
<a name="l01108"></a>01108    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>)) {
<a name="l01109"></a>01109       <span class="keywordtype">char</span> cmd[255], <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[255];
<a name="l01110"></a>01110 
<a name="l01111"></a>01111       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a739c2b2152120f3ac341424b9a595562">AST_LOG_DEBUG</a>, <span class="stringliteral">&quot;Verify password policies for %s\n&quot;</span>, password);
<a name="l01112"></a>01112 
<a name="l01113"></a>01113       snprintf(cmd, <span class="keyword">sizeof</span>(cmd), <span class="stringliteral">&quot;%s %s %s %s %s&quot;</span>, <a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, password);
<a name="l01114"></a>01114       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a11fb20ac91a60a1586aa8183f5c0892f">vm_check_password_shell</a>(cmd, buf, <span class="keyword">sizeof</span>(buf))) {
<a name="l01115"></a>01115          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Result: %s\n&quot;</span>, buf);
<a name="l01116"></a>01116          <span class="keywordflow">if</span> (!strncasecmp(buf, <span class="stringliteral">&quot;VALID&quot;</span>, 5)) {
<a name="l01117"></a>01117             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Passed password check: &apos;%s&apos;\n&quot;</span>, buf);
<a name="l01118"></a>01118             <span class="keywordflow">return</span> 0;
<a name="l01119"></a>01119          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(buf, <span class="stringliteral">&quot;FAILURE&quot;</span>, 7)) {
<a name="l01120"></a>01120             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to execute password validation script: &apos;%s&apos;.\n&quot;</span>, buf);
<a name="l01121"></a>01121             <span class="keywordflow">return</span> 0;
<a name="l01122"></a>01122          } <span class="keywordflow">else</span> {
<a name="l01123"></a>01123             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Password doesn&apos;t match policies for user %s %s\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, password);
<a name="l01124"></a>01124             <span class="keywordflow">return</span> 1;
<a name="l01125"></a>01125          }
<a name="l01126"></a>01126       }
<a name="l01127"></a>01127    }
<a name="l01128"></a>01128    <span class="keywordflow">return</span> 0;
<a name="l01129"></a>01129 }
<a name="l01130"></a>01130 <span class="comment"></span>
<a name="l01131"></a>01131 <span class="comment">/*! </span>
<a name="l01132"></a>01132 <span class="comment"> * \brief Performs a change of the voicemail passowrd in the realtime engine.</span>
<a name="l01133"></a>01133 <span class="comment"> * \param vmu The voicemail user to change the password for.</span>
<a name="l01134"></a>01134 <span class="comment"> * \param password The new value to be set to the password for this user.</span>
<a name="l01135"></a>01135 <span class="comment"> * </span>
<a name="l01136"></a>01136 <span class="comment"> * This only works if there is a realtime engine configured.</span>
<a name="l01137"></a>01137 <span class="comment"> * This is called from the (top level) vm_change_password.</span>
<a name="l01138"></a>01138 <span class="comment"> *</span>
<a name="l01139"></a>01139 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l01140"></a>01140 <span class="comment"> */</span>
<a name="l01141"></a><a class="code" href="app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c">01141</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c" title="Performs a change of the voicemail passowrd in the realtime engine.">change_password_realtime</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *password)
<a name="l01142"></a>01142 {
<a name="l01143"></a>01143    <span class="keywordtype">int</span> res = -1;
<a name="l01144"></a>01144    <span class="keywordflow">if</span> (!strcmp(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, password)) {
<a name="l01145"></a>01145       <span class="comment">/* No change (but an update would return 0 rows updated, so we opt out here) */</span>
<a name="l01146"></a>01146       <span class="keywordflow">return</span> 0;
<a name="l01147"></a>01147    }
<a name="l01148"></a>01148 
<a name="l01149"></a>01149    <span class="keywordflow">if</span> (strlen(password) &gt; 10) {
<a name="l01150"></a>01150       <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;password&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, strlen(password), <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01151"></a>01151    }
<a name="l01152"></a>01152    <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a30c75d60cfd1f61e41c7275bb30c77f6" title="Update realtime configuration.">ast_update2_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;mailbox&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>, <span class="stringliteral">&quot;password&quot;</span>, password, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>) &gt; 0) {
<a name="l01153"></a>01153       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, password, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01154"></a>01154       res = 0;
<a name="l01155"></a>01155    }
<a name="l01156"></a>01156    <span class="keywordflow">return</span> res;
<a name="l01157"></a>01157 }
<a name="l01158"></a>01158 <span class="comment"></span>
<a name="l01159"></a>01159 <span class="comment">/*!</span>
<a name="l01160"></a>01160 <span class="comment"> * \brief Destructively Parse options and apply.</span>
<a name="l01161"></a>01161 <span class="comment"> */</span>
<a name="l01162"></a><a class="code" href="app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2">01162</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2" title="Destructively Parse options and apply.">apply_options</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *options)
<a name="l01163"></a>01163 {  
<a name="l01164"></a>01164    <span class="keywordtype">char</span> *stringp;
<a name="l01165"></a>01165    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l01166"></a>01166    <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *value;
<a name="l01167"></a>01167    stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(options);
<a name="l01168"></a>01168    <span class="keywordflow">while</span> ((s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>))) {
<a name="l01169"></a>01169       value = s;
<a name="l01170"></a>01170       <span class="keywordflow">if</span> ((var = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;value, <span class="stringliteral">&quot;=&quot;</span>)) &amp;&amp; value) {
<a name="l01171"></a>01171          <a class="code" href="app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587" title="Sets a a specific property value.">apply_option</a>(vmu, var, value);
<a name="l01172"></a>01172       }
<a name="l01173"></a>01173    }  
<a name="l01174"></a>01174 }
<a name="l01175"></a>01175 <span class="comment"></span>
<a name="l01176"></a>01176 <span class="comment">/*!</span>
<a name="l01177"></a>01177 <span class="comment"> * \brief Loads the options specific to a voicemail user.</span>
<a name="l01178"></a>01178 <span class="comment"> * </span>
<a name="l01179"></a>01179 <span class="comment"> * This is called when a vm_user structure is being set up, such as from load_options.</span>
<a name="l01180"></a>01180 <span class="comment"> */</span>
<a name="l01181"></a><a class="code" href="app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f">01181</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f" title="Loads the options specific to a voicemail user.">apply_options_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *retval, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>)
<a name="l01182"></a>01182 {
<a name="l01183"></a>01183    <span class="keywordflow">for</span> (; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01184"></a>01184       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;vmsecret&quot;</span>)) {
<a name="l01185"></a>01185          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01186"></a>01186       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;secret&quot;</span>) || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;password&quot;</span>)) { <span class="comment">/* don&apos;t overwrite vmsecret if it exists */</span>
<a name="l01187"></a>01187          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(retval-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>))
<a name="l01188"></a>01188             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01189"></a>01189       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;uniqueid&quot;</span>)) {
<a name="l01190"></a>01190          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">uniqueid</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">uniqueid</a>));
<a name="l01191"></a>01191       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pager&quot;</span>)) {
<a name="l01192"></a>01192          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>));
<a name="l01193"></a>01193       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;email&quot;</span>)) {
<a name="l01194"></a>01194          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>));
<a name="l01195"></a>01195       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;fullname&quot;</span>)) {
<a name="l01196"></a>01196          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>));
<a name="l01197"></a>01197       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l01198"></a>01198          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l01199"></a>01199       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;emailsubject&quot;</span>)) {
<a name="l01200"></a>01200          retval-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01201"></a>01201       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;emailbody&quot;</span>)) {
<a name="l01202"></a>01202          retval-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01203"></a>01203 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l01204"></a>01204 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapuser&quot;</span>)) {
<a name="l01205"></a>01205          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;imapuser, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapuser));
<a name="l01206"></a>01206          retval-&gt;imapversion = imapversion;
<a name="l01207"></a>01207       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imappassword&quot;</span>) || !strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapsecret&quot;</span>)) {
<a name="l01208"></a>01208          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;imappassword, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imappassword));
<a name="l01209"></a>01209          retval-&gt;imapversion = imapversion;
<a name="l01210"></a>01210       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;imapvmshareid&quot;</span>)) {
<a name="l01211"></a>01211          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;imapvmshareid, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(retval-&gt;imapvmshareid));
<a name="l01212"></a>01212          retval-&gt;imapversion = imapversion;
<a name="l01213"></a>01213 <span class="preprocessor">#endif</span>
<a name="l01214"></a>01214 <span class="preprocessor"></span>      } <span class="keywordflow">else</span>
<a name="l01215"></a>01215          <a class="code" href="app__voicemail_8c.html#af60e2269ce2d97043acafb2587162587" title="Sets a a specific property value.">apply_option</a>(retval, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01216"></a>01216    }
<a name="l01217"></a>01217 }
<a name="l01218"></a>01218 <span class="comment"></span>
<a name="l01219"></a>01219 <span class="comment">/*!</span>
<a name="l01220"></a>01220 <span class="comment"> * \brief Determines if a DTMF key entered is valid.</span>
<a name="l01221"></a>01221 <span class="comment"> * \param key The character to be compared. expects a single character. Though is capable of handling a string, this is internally copies using ast_strdupa.</span>
<a name="l01222"></a>01222 <span class="comment"> *</span>
<a name="l01223"></a>01223 <span class="comment"> * Tests the character entered against the set of valid DTMF characters. </span>
<a name="l01224"></a>01224 <span class="comment"> * \return 1 if the character entered is a valid DTMF digit, 0 if the character is invalid.</span>
<a name="l01225"></a>01225 <span class="comment"> */</span>
<a name="l01226"></a><a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb">01226</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *key)
<a name="l01227"></a>01227 {
<a name="l01228"></a>01228    <span class="keywordtype">int</span> i;
<a name="l01229"></a>01229    <span class="keywordtype">char</span> *local_key = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(key);
<a name="l01230"></a>01230 
<a name="l01231"></a>01231    <span class="keywordflow">for</span> (i = 0; i &lt; strlen(key); ++i) {
<a name="l01232"></a>01232       <span class="keywordflow">if</span> (!strchr(<a class="code" href="app__voicemail_8c.html#ace804dd195bf827b988e3f2282422d25">VALID_DTMF</a>, *local_key)) {
<a name="l01233"></a>01233          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid DTMF key \&quot;%c\&quot; used in voicemail configuration file\n&quot;</span>, *local_key);
<a name="l01234"></a>01234          <span class="keywordflow">return</span> 0;
<a name="l01235"></a>01235       }
<a name="l01236"></a>01236       local_key++;
<a name="l01237"></a>01237    }
<a name="l01238"></a>01238    <span class="keywordflow">return</span> 1;
<a name="l01239"></a>01239 }
<a name="l01240"></a>01240 <span class="comment"></span>
<a name="l01241"></a>01241 <span class="comment">/*!</span>
<a name="l01242"></a>01242 <span class="comment"> * \brief Finds a voicemail user from the realtime engine.</span>
<a name="l01243"></a>01243 <span class="comment"> * \param ivm</span>
<a name="l01244"></a>01244 <span class="comment"> * \param context</span>
<a name="l01245"></a>01245 <span class="comment"> * \param mailbox</span>
<a name="l01246"></a>01246 <span class="comment"> *</span>
<a name="l01247"></a>01247 <span class="comment"> * This is called as a fall through case when the normal find_user() was not able to find a user. That is, the default it so look in the usual voicemail users file first.</span>
<a name="l01248"></a>01248 <span class="comment"> *</span>
<a name="l01249"></a>01249 <span class="comment"> * \return The ast_vm_user structure for the user that was found.</span>
<a name="l01250"></a>01250 <span class="comment"> */</span>
<a name="l01251"></a><a class="code" href="app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e">01251</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *<a class="code" href="app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e" title="Finds a voicemail user from the realtime engine.">find_user_realtime</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *ivm, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)
<a name="l01252"></a>01252 {
<a name="l01253"></a>01253    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l01254"></a>01254    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *retval;
<a name="l01255"></a>01255 
<a name="l01256"></a>01256    <span class="keywordflow">if</span> ((retval = (ivm ? ivm : <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*retval))))) {
<a name="l01257"></a>01257       <span class="keywordflow">if</span> (!ivm)
<a name="l01258"></a>01258          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(retval, <a class="code" href="app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);   
<a name="l01259"></a>01259       <span class="keywordflow">else</span>
<a name="l01260"></a>01260          memset(retval, 0, <span class="keyword">sizeof</span>(*retval));
<a name="l01261"></a>01261       <span class="keywordflow">if</span> (mailbox) 
<a name="l01262"></a>01262          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(retval-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, mailbox, <span class="keyword">sizeof</span>(retval-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>));
<a name="l01263"></a>01263       <a class="code" href="app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0" title="Sets default voicemail system options to a voicemail user.">populate_defaults</a>(retval);
<a name="l01264"></a>01264       <span class="keywordflow">if</span> (!context &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>))
<a name="l01265"></a>01265          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;mailbox&quot;</span>, mailbox, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01266"></a>01266       <span class="keywordflow">else</span>
<a name="l01267"></a>01267          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;mailbox&quot;</span>, mailbox, <span class="stringliteral">&quot;context&quot;</span>, context, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l01268"></a>01268       <span class="keywordflow">if</span> (var) {
<a name="l01269"></a>01269          <a class="code" href="app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f" title="Loads the options specific to a voicemail user.">apply_options_full</a>(retval, var);
<a name="l01270"></a>01270          <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l01271"></a>01271       } <span class="keywordflow">else</span> { 
<a name="l01272"></a>01272          <span class="keywordflow">if</span> (!ivm) 
<a name="l01273"></a>01273             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(retval);
<a name="l01274"></a>01274          retval = NULL;
<a name="l01275"></a>01275       }  
<a name="l01276"></a>01276    } 
<a name="l01277"></a>01277    <span class="keywordflow">return</span> retval;
<a name="l01278"></a>01278 }
<a name="l01279"></a>01279 <span class="comment"></span>
<a name="l01280"></a>01280 <span class="comment">/*!</span>
<a name="l01281"></a>01281 <span class="comment"> * \brief Finds a voicemail user from the users file or the realtime engine.</span>
<a name="l01282"></a>01282 <span class="comment"> * \param ivm</span>
<a name="l01283"></a>01283 <span class="comment"> * \param context</span>
<a name="l01284"></a>01284 <span class="comment"> * \param mailbox</span>
<a name="l01285"></a>01285 <span class="comment"> * </span>
<a name="l01286"></a>01286 <span class="comment"> * \return The ast_vm_user structure for the user that was found.</span>
<a name="l01287"></a>01287 <span class="comment"> */</span>
<a name="l01288"></a><a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061">01288</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *<a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *ivm, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)
<a name="l01289"></a>01289 {
<a name="l01290"></a>01290    <span class="comment">/* This function could be made to generate one from a database, too */</span>
<a name="l01291"></a>01291    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu=NULL, *cur;
<a name="l01292"></a>01292    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l01293"></a>01293 
<a name="l01294"></a>01294    <span class="keywordflow">if</span> (!context &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>))
<a name="l01295"></a>01295       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l01296"></a>01296 
<a name="l01297"></a>01297    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, cur, list) {
<a name="l01298"></a>01298 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l01299"></a>01299 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (cur-&gt;imapversion != imapversion) {
<a name="l01300"></a>01300          <span class="keywordflow">continue</span>;
<a name="l01301"></a>01301       }
<a name="l01302"></a>01302 <span class="preprocessor">#endif</span>
<a name="l01303"></a>01303 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>) &amp;&amp; !strcasecmp(mailbox, cur-&gt;mailbox))
<a name="l01304"></a>01304          <span class="keywordflow">break</span>;
<a name="l01305"></a>01305       <span class="keywordflow">if</span> (context &amp;&amp; (!strcasecmp(context, cur-&gt;context)) &amp;&amp; (!strcasecmp(mailbox, cur-&gt;mailbox)))
<a name="l01306"></a>01306          <span class="keywordflow">break</span>;
<a name="l01307"></a>01307    }
<a name="l01308"></a>01308    <span class="keywordflow">if</span> (cur) {
<a name="l01309"></a>01309       <span class="comment">/* Make a copy, so that on a reload, we have no race */</span>
<a name="l01310"></a>01310       <span class="keywordflow">if</span> ((vmu = (ivm ? ivm : <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*vmu))))) {
<a name="l01311"></a>01311          memcpy(vmu, cur, <span class="keyword">sizeof</span>(*vmu));
<a name="l01312"></a>01312          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(vmu, !ivm, <a class="code" href="app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);
<a name="l01313"></a>01313          <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(vmu, list) = NULL;
<a name="l01314"></a>01314       }
<a name="l01315"></a>01315    } <span class="keywordflow">else</span>
<a name="l01316"></a>01316       vmu = <a class="code" href="app__voicemail_8c.html#a17e9a183fe629a3a4658222d7ba95e1e" title="Finds a voicemail user from the realtime engine.">find_user_realtime</a>(ivm, context, mailbox);
<a name="l01317"></a>01317    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l01318"></a>01318    <span class="keywordflow">return</span> vmu;
<a name="l01319"></a>01319 }
<a name="l01320"></a>01320 <span class="comment"></span>
<a name="l01321"></a>01321 <span class="comment">/*!</span>
<a name="l01322"></a>01322 <span class="comment"> * \brief Resets a user password to a specified password.</span>
<a name="l01323"></a>01323 <span class="comment"> * \param context</span>
<a name="l01324"></a>01324 <span class="comment"> * \param mailbox</span>
<a name="l01325"></a>01325 <span class="comment"> * \param newpass</span>
<a name="l01326"></a>01326 <span class="comment"> *</span>
<a name="l01327"></a>01327 <span class="comment"> * This does the actual change password work, called by the vm_change_password() function.</span>
<a name="l01328"></a>01328 <span class="comment"> *</span>
<a name="l01329"></a>01329 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l01330"></a>01330 <span class="comment"> */</span>
<a name="l01331"></a><a class="code" href="app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01">01331</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01" title="Resets a user password to a specified password.">reset_user_pw</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *newpass)
<a name="l01332"></a>01332 {
<a name="l01333"></a>01333    <span class="comment">/* This function could be made to generate one from a database, too */</span>
<a name="l01334"></a>01334    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *cur;
<a name="l01335"></a>01335    <span class="keywordtype">int</span> res = -1;
<a name="l01336"></a>01336    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l01337"></a>01337    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, cur, list) {
<a name="l01338"></a>01338       <span class="keywordflow">if</span> ((!context || !strcasecmp(context, cur-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)) &amp;&amp;
<a name="l01339"></a>01339          (!strcasecmp(mailbox, cur-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)))
<a name="l01340"></a>01340             <span class="keywordflow">break</span>;
<a name="l01341"></a>01341    }
<a name="l01342"></a>01342    <span class="keywordflow">if</span> (cur) {
<a name="l01343"></a>01343       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cur-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpass, <span class="keyword">sizeof</span>(cur-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01344"></a>01344       res = 0;
<a name="l01345"></a>01345    }
<a name="l01346"></a>01346    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l01347"></a>01347    <span class="keywordflow">return</span> res;
<a name="l01348"></a>01348 }
<a name="l01349"></a>01349 <span class="comment"></span>
<a name="l01350"></a>01350 <span class="comment">/*! </span>
<a name="l01351"></a>01351 <span class="comment"> * \brief The handler for the change password option.</span>
<a name="l01352"></a>01352 <span class="comment"> * \param vmu The voicemail user to work with.</span>
<a name="l01353"></a>01353 <span class="comment"> * \param newpassword The new password (that has been gathered from the appropriate prompting).</span>
<a name="l01354"></a>01354 <span class="comment"> * This is called when a new user logs in for the first time and the option to force them to change their password is set.</span>
<a name="l01355"></a>01355 <span class="comment"> * It is also called when the user wants to change their password from menu option &apos;5&apos; on the mailbox options menu.</span>
<a name="l01356"></a>01356 <span class="comment"> */</span>
<a name="l01357"></a><a class="code" href="app__voicemail_8c.html#a778f09605f89f85529e369351472b174">01357</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a778f09605f89f85529e369351472b174" title="The handler for the change password option.">vm_change_password</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *newpassword)
<a name="l01358"></a>01358 {
<a name="l01359"></a>01359    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a>   *cfg=NULL;
<a name="l01360"></a>01360    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>=NULL;
<a name="l01361"></a>01361    <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *cat=NULL;
<a name="l01362"></a>01362    <span class="keywordtype">char</span> *category=NULL, *value=NULL, *<span class="keyword">new</span>=NULL;
<a name="l01363"></a>01363    <span class="keyword">const</span> <span class="keywordtype">char</span> *tmp=NULL;
<a name="l01364"></a>01364    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26abc16a274124ae96d43f8e52e344292c3">CONFIG_FLAG_WITHCOMMENTS</a> };
<a name="l01365"></a>01365    <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#a45a741eda0606c72d39d65668ef7d64c" title="Performs a change of the voicemail passowrd in the realtime engine.">change_password_realtime</a>(vmu, newpassword))
<a name="l01366"></a>01366       <span class="keywordflow">return</span>;
<a name="l01367"></a>01367 
<a name="l01368"></a>01368    <span class="comment">/* check voicemail.conf */</span>
<a name="l01369"></a>01369    <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__directory_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, config_flags)) &amp;&amp; cfg != <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01370"></a>01370       <span class="keywordflow">while</span> ((category = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, category))) {
<a name="l01371"></a>01371          <span class="keywordflow">if</span> (!strcasecmp(category, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)) {
<a name="l01372"></a>01372             <span class="keywordflow">if</span> (!(tmp = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, category, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>))) {
<a name="l01373"></a>01373                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;We could not find the mailbox.\n&quot;</span>);
<a name="l01374"></a>01374                <span class="keywordflow">break</span>;
<a name="l01375"></a>01375             }
<a name="l01376"></a>01376             value = strstr(tmp,<span class="stringliteral">&quot;,&quot;</span>);
<a name="l01377"></a>01377             <span class="keywordflow">if</span> (!value) {
<a name="l01378"></a>01378                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;variable has bad format.\n&quot;</span>);
<a name="l01379"></a>01379                <span class="keywordflow">break</span>;
<a name="l01380"></a>01380             }
<a name="l01381"></a>01381             <span class="keyword">new</span> = alloca((strlen(value)+strlen(newpassword)+1));
<a name="l01382"></a>01382             sprintf(<span class="keyword">new</span>,<span class="stringliteral">&quot;%s%s&quot;</span>, newpassword, value);
<a name="l01383"></a>01383             <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8h.html#a0c2db6370e5051f282b2926f5893b2ea" title="Retrieve a category if it exists.">ast_category_get</a>(cfg, category))) {
<a name="l01384"></a>01384                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to get category structure.\n&quot;</span>);
<a name="l01385"></a>01385                <span class="keywordflow">break</span>;
<a name="l01386"></a>01386             }
<a name="l01387"></a>01387             <a class="code" href="config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8" title="Update variable value within a config.">ast_variable_update</a>(cat, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">new</span>, NULL, 0);
<a name="l01388"></a>01388          }
<a name="l01389"></a>01389       }
<a name="l01390"></a>01390       <span class="comment">/* save the results */</span>
<a name="l01391"></a>01391       <a class="code" href="app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01" title="Resets a user password to a specified password.">reset_user_pw</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, newpassword);
<a name="l01392"></a>01392       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01393"></a>01393       <a class="code" href="config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(<a class="code" href="app__directory_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, cfg, <span class="stringliteral">&quot;AppVoicemail&quot;</span>);
<a name="l01394"></a>01394    }
<a name="l01395"></a>01395    category = NULL;
<a name="l01396"></a>01396    var = NULL;
<a name="l01397"></a>01397    <span class="comment">/* check users.conf and update the password stored for the mailbox*/</span>
<a name="l01398"></a>01398    <span class="comment">/* if no vmsecret entry exists create one. */</span>
<a name="l01399"></a>01399    <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) &amp;&amp; cfg != <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01400"></a>01400       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;we are looking for %s\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l01401"></a>01401       <span class="keywordflow">while</span> ((category = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, category))) {
<a name="l01402"></a>01402          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;users.conf: %s\n&quot;</span>, category);
<a name="l01403"></a>01403          <span class="keywordflow">if</span> (!strcasecmp(category, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)) {
<a name="l01404"></a>01404             <span class="keywordflow">if</span> (!(tmp = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, category, <span class="stringliteral">&quot;vmsecret&quot;</span>))) {
<a name="l01405"></a>01405                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;looks like we need to make vmsecret!\n&quot;</span>);
<a name="l01406"></a>01406                var = <a class="code" href="config_8h.html#a08e94d96f459e7301a74daf32035423b">ast_variable_new</a>(<span class="stringliteral">&quot;vmsecret&quot;</span>, newpassword, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01407"></a>01407             } 
<a name="l01408"></a>01408             <span class="keyword">new</span> = alloca(strlen(newpassword)+1);
<a name="l01409"></a>01409             sprintf(<span class="keyword">new</span>, <span class="stringliteral">&quot;%s&quot;</span>, newpassword);
<a name="l01410"></a>01410             <span class="keywordflow">if</span> (!(cat = <a class="code" href="config_8h.html#a0c2db6370e5051f282b2926f5893b2ea" title="Retrieve a category if it exists.">ast_category_get</a>(cfg, category))) {
<a name="l01411"></a>01411                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;failed to get category!\n&quot;</span>);
<a name="l01412"></a>01412                <span class="keywordflow">break</span>;
<a name="l01413"></a>01413             }
<a name="l01414"></a>01414             <span class="keywordflow">if</span> (!var)      
<a name="l01415"></a>01415                <a class="code" href="config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8" title="Update variable value within a config.">ast_variable_update</a>(cat, <span class="stringliteral">&quot;vmsecret&quot;</span>, <span class="keyword">new</span>, NULL, 0);
<a name="l01416"></a>01416             <span class="keywordflow">else</span>
<a name="l01417"></a>01417                <a class="code" href="config_8h.html#a132ddbd39dd9d26395c410f7647f76db">ast_variable_append</a>(cat, var);
<a name="l01418"></a>01418          }
<a name="l01419"></a>01419       }
<a name="l01420"></a>01420       <span class="comment">/* save the results and clean things up */</span>
<a name="l01421"></a>01421       <a class="code" href="app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01" title="Resets a user password to a specified password.">reset_user_pw</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, newpassword);  
<a name="l01422"></a>01422       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01423"></a>01423       <a class="code" href="config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, cfg, <span class="stringliteral">&quot;AppVoicemail&quot;</span>);
<a name="l01424"></a>01424    }
<a name="l01425"></a>01425 }
<a name="l01426"></a>01426 
<a name="l01427"></a><a class="code" href="app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">01427</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *newpassword)
<a name="l01428"></a>01428 {
<a name="l01429"></a>01429    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[255];
<a name="l01430"></a>01430    snprintf(buf,255,<span class="stringliteral">&quot;%s %s %s %s&quot;</span>,<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>,vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>,vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>,newpassword);
<a name="l01431"></a>01431    <span class="keywordflow">if</span> (!<a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(buf)) {
<a name="l01432"></a>01432       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, newpassword, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l01433"></a>01433       <span class="comment">/* Reset the password in memory, too */</span>
<a name="l01434"></a>01434       <a class="code" href="app__voicemail_8c.html#a464e68010ebec43ad6eb83fd63494e01" title="Resets a user password to a specified password.">reset_user_pw</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, newpassword);
<a name="l01435"></a>01435    }
<a name="l01436"></a>01436 }
<a name="l01437"></a>01437 <span class="comment"></span>
<a name="l01438"></a>01438 <span class="comment">/*! </span>
<a name="l01439"></a>01439 <span class="comment"> * \brief Creates a file system path expression for a folder within the voicemail data folder and the appropriate context.</span>
<a name="l01440"></a>01440 <span class="comment"> * \param dest The variable to hold the output generated path expression. This buffer should be of size PATH_MAX.</span>
<a name="l01441"></a>01441 <span class="comment"> * \param len The length of the path string that was written out.</span>
<a name="l01442"></a>01442 <span class="comment"> * </span>
<a name="l01443"></a>01443 <span class="comment"> * The path is constructed as </span>
<a name="l01444"></a>01444 <span class="comment"> *    VM_SPOOL_DIRcontext/ext/folder</span>
<a name="l01445"></a>01445 <span class="comment"> *</span>
<a name="l01446"></a>01446 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l01447"></a>01447 <span class="comment"> */</span>
<a name="l01448"></a><a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22">01448</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(<span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l01449"></a>01449 {
<a name="l01450"></a>01450    <span class="keywordflow">return</span> snprintf(dest, len, <span class="stringliteral">&quot;%s%s/%s/%s&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, ext, folder);
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 <span class="comment"></span>
<a name="l01453"></a>01453 <span class="comment">/*! </span>
<a name="l01454"></a>01454 <span class="comment"> * \brief Creates a file system path expression for a folder within the voicemail data folder and the appropriate context.</span>
<a name="l01455"></a>01455 <span class="comment"> * \param dest The variable to hold the output generated path expression. This buffer should be of size PATH_MAX.</span>
<a name="l01456"></a>01456 <span class="comment"> * \param len The length of the path string that was written out.</span>
<a name="l01457"></a>01457 <span class="comment"> * </span>
<a name="l01458"></a>01458 <span class="comment"> * The path is constructed as </span>
<a name="l01459"></a>01459 <span class="comment"> *    VM_SPOOL_DIRcontext/ext/folder</span>
<a name="l01460"></a>01460 <span class="comment"> *</span>
<a name="l01461"></a>01461 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l01462"></a>01462 <span class="comment"> */</span>
<a name="l01463"></a><a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd">01463</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(<span class="keywordtype">char</span> *dest, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>)
<a name="l01464"></a>01464 {
<a name="l01465"></a>01465    <span class="keywordflow">return</span> snprintf(dest, len, <span class="stringliteral">&quot;%s/msg%04d&quot;</span>, dir, num);
<a name="l01466"></a>01466 }
<a name="l01467"></a>01467 
<a name="l01468"></a>01468 <span class="comment">/* same as mkstemp, but return a FILE * */</span>
<a name="l01469"></a><a class="code" href="app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">01469</a> <span class="keyword">static</span> FILE *<a class="code" href="app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(<span class="keywordtype">char</span> *<span class="keyword">template</span>)
<a name="l01470"></a>01470 {
<a name="l01471"></a>01471    FILE *p = NULL;
<a name="l01472"></a>01472    <span class="keywordtype">int</span> pfd = mkstemp(<span class="keyword">template</span>);
<a name="l01473"></a>01473    chmod(<span class="keyword">template</span>, <a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a> &amp; ~<a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a>);
<a name="l01474"></a>01474    <span class="keywordflow">if</span> (pfd &gt; -1) {
<a name="l01475"></a>01475       p = fdopen(pfd, <span class="stringliteral">&quot;w+&quot;</span>);
<a name="l01476"></a>01476       <span class="keywordflow">if</span> (!p) {
<a name="l01477"></a>01477          close(pfd);
<a name="l01478"></a>01478          pfd = -1;
<a name="l01479"></a>01479       }
<a name="l01480"></a>01480    }
<a name="l01481"></a>01481    <span class="keywordflow">return</span> p;
<a name="l01482"></a>01482 }
<a name="l01483"></a>01483 <span class="comment"></span>
<a name="l01484"></a>01484 <span class="comment">/*! \brief basically mkdir -p $dest/$context/$ext/$folder</span>
<a name="l01485"></a>01485 <span class="comment"> * \param dest    String. base directory.</span>
<a name="l01486"></a>01486 <span class="comment"> * \param len     Length of dest.</span>
<a name="l01487"></a>01487 <span class="comment"> * \param context String. Ignored if is null or empty string.</span>
<a name="l01488"></a>01488 <span class="comment"> * \param ext     String. Ignored if is null or empty string.</span>
<a name="l01489"></a>01489 <span class="comment"> * \param folder  String. Ignored if is null or empty string. </span>
<a name="l01490"></a>01490 <span class="comment"> * \return -1 on failure, 0 on success.</span>
<a name="l01491"></a>01491 <span class="comment"> */</span>
<a name="l01492"></a><a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938">01492</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(<span class="keywordtype">char</span> *dest, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l01493"></a>01493 {
<a name="l01494"></a>01494    mode_t   mode = <a class="code" href="app__minivm_8c.html#a158fef5d62bdc9b70bcf52e13c6a76c1">VOICEMAIL_DIR_MODE</a>;
<a name="l01495"></a>01495    <span class="keywordtype">int</span> res;
<a name="l01496"></a>01496 
<a name="l01497"></a>01497    <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(dest, len, context, ext, folder);
<a name="l01498"></a>01498    <span class="keywordflow">if</span> ((res = <a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(dest, mode))) {
<a name="l01499"></a>01499       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;ast_mkdir &apos;%s&apos; failed: %s\n&quot;</span>, dest, strerror(res));
<a name="l01500"></a>01500       <span class="keywordflow">return</span> -1;
<a name="l01501"></a>01501    }
<a name="l01502"></a>01502    <span class="keywordflow">return</span> 0;
<a name="l01503"></a>01503 }
<a name="l01504"></a>01504 
<a name="l01505"></a><a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">01505</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(<span class="keywordtype">int</span> <span class="keywordtype">id</span>)
<a name="l01506"></a>01506 {
<a name="l01507"></a>01507    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *msgs[] = {
<a name="l01508"></a>01508 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l01509"></a>01509 <span class="preprocessor"></span>      imapfolder,
<a name="l01510"></a>01510 <span class="preprocessor">#else</span>
<a name="l01511"></a>01511 <span class="preprocessor"></span>      <span class="stringliteral">&quot;INBOX&quot;</span>,
<a name="l01512"></a>01512 <span class="preprocessor">#endif</span>
<a name="l01513"></a>01513 <span class="preprocessor"></span>      <span class="stringliteral">&quot;Old&quot;</span>,
<a name="l01514"></a>01514       <span class="stringliteral">&quot;Work&quot;</span>,
<a name="l01515"></a>01515       <span class="stringliteral">&quot;Family&quot;</span>,
<a name="l01516"></a>01516       <span class="stringliteral">&quot;Friends&quot;</span>,
<a name="l01517"></a>01517       <span class="stringliteral">&quot;Cust1&quot;</span>,
<a name="l01518"></a>01518       <span class="stringliteral">&quot;Cust2&quot;</span>,
<a name="l01519"></a>01519       <span class="stringliteral">&quot;Cust3&quot;</span>,
<a name="l01520"></a>01520       <span class="stringliteral">&quot;Cust4&quot;</span>,
<a name="l01521"></a>01521       <span class="stringliteral">&quot;Cust5&quot;</span>,
<a name="l01522"></a>01522       <span class="stringliteral">&quot;Deleted&quot;</span>,
<a name="l01523"></a>01523       <span class="stringliteral">&quot;Urgent&quot;</span>
<a name="l01524"></a>01524    };
<a name="l01525"></a>01525    <span class="keywordflow">return</span> (<span class="keywordtype">id</span> &gt;= 0 &amp;&amp; <span class="keywordtype">id</span> &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(msgs)) ? msgs[id] : <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l01526"></a>01526 }
<a name="l01527"></a>01527 
<a name="l01528"></a><a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">01528</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l01529"></a>01529 {
<a name="l01530"></a>01530    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>)) {
<a name="l01531"></a>01531       <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> != NULL) {
<a name="l01532"></a>01532          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);
<a name="l01533"></a>01533          vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = NULL;
<a name="l01534"></a>01534       }
<a name="l01535"></a>01535       <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> != NULL) {
<a name="l01536"></a>01536          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);
<a name="l01537"></a>01537          vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = NULL;
<a name="l01538"></a>01538       }
<a name="l01539"></a>01539       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu);
<a name="l01540"></a>01540    }
<a name="l01541"></a>01541 }
<a name="l01542"></a>01542 
<a name="l01543"></a>01543 <span class="comment">/* All IMAP-specific functions should go in this block. This</span>
<a name="l01544"></a>01544 <span class="comment"> * keeps them from being spread out all over the code */</span>
<a name="l01545"></a>01545 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l01546"></a>01546 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">void</span> vm_imap_delete(<span class="keywordtype">char</span> *file, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l01547"></a>01547 {
<a name="l01548"></a>01548    <span class="keywordtype">char</span> arg[10];
<a name="l01549"></a>01549    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l01550"></a>01550    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> messageNum;
<a name="l01551"></a>01551 
<a name="l01552"></a>01552    <span class="comment">/* If greetings aren&apos;t stored in IMAP, just delete the file */</span>
<a name="l01553"></a>01553    <span class="keywordflow">if</span> (msgnum &lt; 0 &amp;&amp; !imapgreetings) {
<a name="l01554"></a>01554       <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(file, NULL);
<a name="l01555"></a>01555       <span class="keywordflow">return</span>;
<a name="l01556"></a>01556    }
<a name="l01557"></a>01557 
<a name="l01558"></a>01558    <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 1)) &amp;&amp; !(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 0))) {
<a name="l01559"></a>01559       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t find a vm_state for mailbox %s. Unable to set \\DELETED flag for message %d\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, msgnum);
<a name="l01560"></a>01560       <span class="keywordflow">return</span>;
<a name="l01561"></a>01561    }
<a name="l01562"></a>01562 
<a name="l01563"></a>01563    <span class="comment">/* find real message number based on msgnum */</span>
<a name="l01564"></a>01564    <span class="comment">/* this may be an index into vms-&gt;msgArray based on the msgnum. */</span>
<a name="l01565"></a>01565    messageNum = vms-&gt;msgArray[msgnum];
<a name="l01566"></a>01566    <span class="keywordflow">if</span> (messageNum == 0) {
<a name="l01567"></a>01567       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;msgnum %d, mailbox message %lu is zero.\n&quot;</span>,msgnum,messageNum);
<a name="l01568"></a>01568       <span class="keywordflow">return</span>;
<a name="l01569"></a>01569    }
<a name="l01570"></a>01570    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l01571"></a>01571       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;deleting msgnum %d, which is mailbox message %lu\n&quot;</span>,msgnum,messageNum);
<a name="l01572"></a>01572    <span class="comment">/* delete message */</span>
<a name="l01573"></a>01573    snprintf (arg, <span class="keyword">sizeof</span>(arg), <span class="stringliteral">&quot;%lu&quot;</span>,messageNum);
<a name="l01574"></a>01574    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l01575"></a>01575    mail_setflag (vms-&gt;mailstream,arg,<span class="stringliteral">&quot;\\DELETED&quot;</span>);
<a name="l01576"></a>01576    mail_expunge(vms-&gt;mailstream);
<a name="l01577"></a>01577    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l01578"></a>01578 }
<a name="l01579"></a>01579 
<a name="l01580"></a>01580 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_retrieve_greeting(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l01581"></a>01581 {
<a name="l01582"></a>01582    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms_p;
<a name="l01583"></a>01583    <span class="keywordtype">char</span> *file, *filename;
<a name="l01584"></a>01584    <span class="keywordtype">char</span> *attachment;
<a name="l01585"></a>01585    <span class="keywordtype">int</span> ret = 0, i;
<a name="l01586"></a>01586    BODY *body;
<a name="l01587"></a>01587 
<a name="l01588"></a>01588    <span class="comment">/* This function is only used for retrieval of IMAP greetings</span>
<a name="l01589"></a>01589 <span class="comment">    * regular messages are not retrieved this way, nor are greetings</span>
<a name="l01590"></a>01590 <span class="comment">    * if they are stored locally*/</span>
<a name="l01591"></a>01591    <span class="keywordflow">if</span> (msgnum &gt; -1 || !imapgreetings) {
<a name="l01592"></a>01592       <span class="keywordflow">return</span> 0;
<a name="l01593"></a>01593    } <span class="keywordflow">else</span> {
<a name="l01594"></a>01594       file = strrchr(<a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(dir), <span class="charliteral">&apos;/&apos;</span>);
<a name="l01595"></a>01595       <span class="keywordflow">if</span> (file)
<a name="l01596"></a>01596          *file++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01597"></a>01597       <span class="keywordflow">else</span> {
<a name="l01598"></a>01598          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a> (1, <span class="stringliteral">&quot;Failed to procure file name from directory passed.\n&quot;</span>);
<a name="l01599"></a>01599          <span class="keywordflow">return</span> -1;
<a name="l01600"></a>01600       }
<a name="l01601"></a>01601    }
<a name="l01602"></a>01602 
<a name="l01603"></a>01603    <span class="comment">/* check if someone is accessing this box right now... */</span>
<a name="l01604"></a>01604    <span class="keywordflow">if</span> (!(vms_p = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 1)) &amp;&amp; 
<a name="l01605"></a>01605       !(vms_p = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 0))) {
<a name="l01606"></a>01606       <span class="comment">/* Unlike when retrieving a message, it is reasonable not to be able to find a </span>
<a name="l01607"></a>01607 <span class="comment">      * vm_state for a mailbox when trying to retrieve a greeting. Just create one,</span>
<a name="l01608"></a>01608 <span class="comment">      * that&apos;s all we need to do.</span>
<a name="l01609"></a>01609 <span class="comment">      */</span>
<a name="l01610"></a>01610       <span class="keywordflow">if</span> (!(vms_p = create_vm_state_from_user(vmu))) {
<a name="l01611"></a>01611          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unable to create vm_state object!\n&quot;</span>);
<a name="l01612"></a>01612          <span class="keywordflow">return</span> -1;
<a name="l01613"></a>01613       }
<a name="l01614"></a>01614    }
<a name="l01615"></a>01615    
<a name="l01616"></a>01616    <span class="comment">/* Greetings will never have a prepended message */</span>
<a name="l01617"></a>01617    *vms_p-&gt;introfn = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01618"></a>01618 
<a name="l01619"></a>01619    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms_p-&gt;lock);
<a name="l01620"></a>01620    ret = init_mailstream(vms_p, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>);
<a name="l01621"></a>01621    <span class="keywordflow">if</span> (!vms_p-&gt;mailstream) {
<a name="l01622"></a>01622       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream is NULL\n&quot;</span>);
<a name="l01623"></a>01623       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);
<a name="l01624"></a>01624       <span class="keywordflow">return</span> -1;
<a name="l01625"></a>01625    }
<a name="l01626"></a>01626 
<a name="l01627"></a>01627    <span class="comment">/*XXX Yuck, this could probably be done a lot better */</span>
<a name="l01628"></a>01628    <span class="keywordflow">for</span> (i = 0; i &lt; vms_p-&gt;mailstream-&gt;nmsgs; i++) {
<a name="l01629"></a>01629       mail_fetchstructure(vms_p-&gt;mailstream, i + 1, &amp;body);
<a name="l01630"></a>01630       <span class="comment">/* We have the body, now we extract the file name of the first attachment. */</span>
<a name="l01631"></a>01631       <span class="keywordflow">if</span> (body-&gt;nested.part &amp;&amp; body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {
<a name="l01632"></a>01632          attachment = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);
<a name="l01633"></a>01633       } <span class="keywordflow">else</span> {
<a name="l01634"></a>01634          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;There is no file attached to this IMAP message.\n&quot;</span>);
<a name="l01635"></a>01635          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);
<a name="l01636"></a>01636          <span class="keywordflow">return</span> -1;
<a name="l01637"></a>01637       }
<a name="l01638"></a>01638       filename = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;attachment, <span class="stringliteral">&quot;.&quot;</span>);
<a name="l01639"></a>01639       <span class="keywordflow">if</span> (!strcmp(filename, file)) {
<a name="l01640"></a>01640          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms_p-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, dir, <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>));
<a name="l01641"></a>01641          vms_p-&gt;msgArray[vms_p-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = i + 1;
<a name="l01642"></a>01642          save_body(body, vms_p, <span class="stringliteral">&quot;2&quot;</span>, attachment, 0);
<a name="l01643"></a>01643          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);
<a name="l01644"></a>01644          <span class="keywordflow">return</span> 0;
<a name="l01645"></a>01645       }
<a name="l01646"></a>01646    }
<a name="l01647"></a>01647    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);
<a name="l01648"></a>01648 
<a name="l01649"></a>01649    <span class="keywordflow">return</span> -1;
<a name="l01650"></a>01650 }
<a name="l01651"></a>01651 
<a name="l01652"></a>01652 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_retrieve_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">int</span> msgnum, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)
<a name="l01653"></a>01653 {
<a name="l01654"></a>01654    BODY *body;
<a name="l01655"></a>01655    <span class="keywordtype">char</span> *header_content;
<a name="l01656"></a>01656    <span class="keywordtype">char</span> *attachedfilefmt;
<a name="l01657"></a>01657    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[80];
<a name="l01658"></a>01658    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l01659"></a>01659    <span class="keywordtype">char</span> text_file[PATH_MAX];
<a name="l01660"></a>01660    FILE *text_file_ptr;
<a name="l01661"></a>01661    <span class="keywordtype">int</span> res = 0;
<a name="l01662"></a>01662    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l01663"></a>01663 
<a name="l01664"></a>01664    <span class="keywordflow">if</span> (!(vmu = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(NULL, context, mailbox))) {
<a name="l01665"></a>01665       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t find user with mailbox %s@%s\n&quot;</span>, mailbox, context);
<a name="l01666"></a>01666       <span class="keywordflow">return</span> -1;
<a name="l01667"></a>01667    }
<a name="l01668"></a>01668    
<a name="l01669"></a>01669    <span class="keywordflow">if</span> (msgnum &lt; 0) {
<a name="l01670"></a>01670       <span class="keywordflow">if</span> (imapgreetings) {
<a name="l01671"></a>01671          res = imap_retrieve_greeting(dir, msgnum, vmu);
<a name="l01672"></a>01672          <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01673"></a>01673       } <span class="keywordflow">else</span> {
<a name="l01674"></a>01674          res = 0;
<a name="l01675"></a>01675          <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01676"></a>01676       }
<a name="l01677"></a>01677    }
<a name="l01678"></a>01678 
<a name="l01679"></a>01679    <span class="comment">/* Before anything can happen, we need a vm_state so that we can</span>
<a name="l01680"></a>01680 <span class="comment">    * actually access the imap server through the vms-&gt;mailstream</span>
<a name="l01681"></a>01681 <span class="comment">    */</span>
<a name="l01682"></a>01682    <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 1)) &amp;&amp; !(vms = get_vm_state_by_mailbox(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 0))) {
<a name="l01683"></a>01683       <span class="comment">/* This should not happen. If it does, then I guess we&apos;d</span>
<a name="l01684"></a>01684 <span class="comment">       * need to create the vm_state, extract which mailbox to</span>
<a name="l01685"></a>01685 <span class="comment">       * open, and then set up the msgArray so that the correct</span>
<a name="l01686"></a>01686 <span class="comment">       * IMAP message could be accessed. If I have seen correctly</span>
<a name="l01687"></a>01687 <span class="comment">       * though, the vms should be obtainable from the vmstates list</span>
<a name="l01688"></a>01688 <span class="comment">       * and should have its msgArray properly set up.</span>
<a name="l01689"></a>01689 <span class="comment">       */</span>
<a name="l01690"></a>01690       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t find a vm_state for mailbox %s!!! Oh no!\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l01691"></a>01691       res = -1;
<a name="l01692"></a>01692       <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01693"></a>01693    }
<a name="l01694"></a>01694    
<a name="l01695"></a>01695    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), dir, msgnum);
<a name="l01696"></a>01696    snprintf(vms-&gt;introfn, <span class="keyword">sizeof</span>(vms-&gt;introfn), <span class="stringliteral">&quot;%sintro&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l01697"></a>01697 
<a name="l01698"></a>01698    <span class="comment">/* Don&apos;t try to retrieve a message from IMAP if it already is on the file system */</span>
<a name="l01699"></a>01699    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, NULL, NULL) &gt; 0) {
<a name="l01700"></a>01700       res = 0;
<a name="l01701"></a>01701       <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01702"></a>01702    }
<a name="l01703"></a>01703 
<a name="l01704"></a>01704    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l01705"></a>01705       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;Before mail_fetchheaders, curmsg is: %d, imap messages is %lu\n&quot;</span>, msgnum, vms-&gt;msgArray[msgnum]);
<a name="l01706"></a>01706    <span class="keywordflow">if</span> (vms-&gt;msgArray[msgnum] == 0) {
<a name="l01707"></a>01707       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>,<span class="stringliteral">&quot;Trying to access unknown message\n&quot;</span>);
<a name="l01708"></a>01708       res = -1;
<a name="l01709"></a>01709       <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01710"></a>01710    }
<a name="l01711"></a>01711 
<a name="l01712"></a>01712    <span class="comment">/* This will only work for new messages... */</span>
<a name="l01713"></a>01713    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l01714"></a>01714    header_content = mail_fetchheader (vms-&gt;mailstream, vms-&gt;msgArray[msgnum]);
<a name="l01715"></a>01715    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l01716"></a>01716    <span class="comment">/* empty string means no valid header */</span>
<a name="l01717"></a>01717    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(header_content)) {
<a name="l01718"></a>01718       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;Could not fetch header for message number %ld\n&quot;</span>,vms-&gt;msgArray[msgnum]);
<a name="l01719"></a>01719       res = -1;
<a name="l01720"></a>01720       <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01721"></a>01721    }
<a name="l01722"></a>01722 
<a name="l01723"></a>01723    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l01724"></a>01724    mail_fetchstructure (vms-&gt;mailstream,vms-&gt;msgArray[msgnum],&amp;body);
<a name="l01725"></a>01725    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727    <span class="comment">/* We have the body, now we extract the file name of the first attachment. */</span>
<a name="l01728"></a>01728    <span class="keywordflow">if</span> (body-&gt;nested.part &amp;&amp; body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {
<a name="l01729"></a>01729       attachedfilefmt = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);
<a name="l01730"></a>01730    } <span class="keywordflow">else</span> {
<a name="l01731"></a>01731       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;There is no file attached to this IMAP message.\n&quot;</span>);
<a name="l01732"></a>01732       res = -1;
<a name="l01733"></a>01733       <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01734"></a>01734    }
<a name="l01735"></a>01735    
<a name="l01736"></a>01736    <span class="comment">/* Find the format of the attached file */</span>
<a name="l01737"></a>01737 
<a name="l01738"></a>01738    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;attachedfilefmt, <span class="stringliteral">&quot;.&quot;</span>);
<a name="l01739"></a>01739    <span class="keywordflow">if</span> (!attachedfilefmt) {
<a name="l01740"></a>01740       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;File format could not be obtained from IMAP message attachment\n&quot;</span>);
<a name="l01741"></a>01741       res = -1;
<a name="l01742"></a>01742       <span class="keywordflow">goto</span> <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>;
<a name="l01743"></a>01743    }
<a name="l01744"></a>01744    
<a name="l01745"></a>01745    save_body(body, vms, <span class="stringliteral">&quot;2&quot;</span>, attachedfilefmt, 0);
<a name="l01746"></a>01746    <span class="keywordflow">if</span> (save_body(body, vms, <span class="stringliteral">&quot;3&quot;</span>, attachedfilefmt, 1)) {
<a name="l01747"></a>01747       *vms-&gt;introfn = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01748"></a>01748    }
<a name="l01749"></a>01749 
<a name="l01750"></a>01750    <span class="comment">/* Get info from headers!! */</span>
<a name="l01751"></a>01751    snprintf(text_file, <span class="keyword">sizeof</span>(text_file), <span class="stringliteral">&quot;%s.%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="stringliteral">&quot;txt&quot;</span>);
<a name="l01752"></a>01752 
<a name="l01753"></a>01753    <span class="keywordflow">if</span> (!(text_file_ptr = fopen(text_file, <span class="stringliteral">&quot;w&quot;</span>))) {
<a name="l01754"></a>01754       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open/create file %s: %s\n&quot;</span>, text_file, strerror(errno));
<a name="l01755"></a>01755    }
<a name="l01756"></a>01756 
<a name="l01757"></a>01757    fprintf(text_file_ptr, <span class="stringliteral">&quot;%s\n&quot;</span>, <span class="stringliteral">&quot;[message]&quot;</span>);
<a name="l01758"></a>01758 
<a name="l01759"></a>01759    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Name:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01760"></a>01760    fprintf(text_file_ptr, <span class="stringliteral">&quot;callerid=\&quot;%s\&quot; &quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01761"></a>01761    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Num:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01762"></a>01762    fprintf(text_file_ptr, <span class="stringliteral">&quot;&lt;%s&gt;\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01763"></a>01763    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Context:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01764"></a>01764    fprintf(text_file_ptr, <span class="stringliteral">&quot;context=%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01765"></a>01765    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Orig-time:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01766"></a>01766    fprintf(text_file_ptr, <span class="stringliteral">&quot;origtime=%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01767"></a>01767    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Duration:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01768"></a>01768    fprintf(text_file_ptr, <span class="stringliteral">&quot;duration=%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01769"></a>01769    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Category:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01770"></a>01770    fprintf(text_file_ptr, <span class="stringliteral">&quot;category=%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01771"></a>01771    get_header_by_tag(header_content, <span class="stringliteral">&quot;X-Asterisk-VM-Flag:&quot;</span>, buf, <span class="keyword">sizeof</span>(buf));
<a name="l01772"></a>01772    fprintf(text_file_ptr, <span class="stringliteral">&quot;flag=%s\n&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(buf, <span class="stringliteral">&quot;&quot;</span>));
<a name="l01773"></a>01773    fclose(text_file_ptr);
<a name="l01774"></a>01774 
<a name="l01775"></a>01775 <a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>:
<a name="l01776"></a>01776    <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l01777"></a>01777    <span class="keywordflow">return</span> res;
<a name="l01778"></a>01778 }
<a name="l01779"></a>01779 
<a name="l01780"></a>01780 <span class="keyword">static</span> <span class="keywordtype">int</span> folder_int(<span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l01781"></a>01781 {
<a name="l01782"></a>01782    <span class="comment">/*assume a NULL folder means INBOX*/</span>
<a name="l01783"></a>01783    <span class="keywordflow">if</span> (!folder)
<a name="l01784"></a>01784       <span class="keywordflow">return</span> 0;
<a name="l01785"></a>01785 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l01786"></a>01786 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!strcasecmp(folder, imapfolder))
<a name="l01787"></a>01787 <span class="preprocessor">#else</span>
<a name="l01788"></a>01788 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>))
<a name="l01789"></a>01789 <span class="preprocessor">#endif</span>
<a name="l01790"></a>01790 <span class="preprocessor"></span>      <span class="keywordflow">return</span> 0;
<a name="l01791"></a>01791    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Old&quot;</span>))
<a name="l01792"></a>01792       <span class="keywordflow">return</span> 1;
<a name="l01793"></a>01793    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Work&quot;</span>))
<a name="l01794"></a>01794       <span class="keywordflow">return</span> 2;
<a name="l01795"></a>01795    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Family&quot;</span>))
<a name="l01796"></a>01796       <span class="keywordflow">return</span> 3;
<a name="l01797"></a>01797    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Friends&quot;</span>))
<a name="l01798"></a>01798       <span class="keywordflow">return</span> 4;
<a name="l01799"></a>01799    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust1&quot;</span>))
<a name="l01800"></a>01800       <span class="keywordflow">return</span> 5;
<a name="l01801"></a>01801    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust2&quot;</span>))
<a name="l01802"></a>01802       <span class="keywordflow">return</span> 6;
<a name="l01803"></a>01803    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust3&quot;</span>))
<a name="l01804"></a>01804       <span class="keywordflow">return</span> 7;
<a name="l01805"></a>01805    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust4&quot;</span>))
<a name="l01806"></a>01806       <span class="keywordflow">return</span> 8;
<a name="l01807"></a>01807    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(folder, <span class="stringliteral">&quot;Cust5&quot;</span>))
<a name="l01808"></a>01808       <span class="keywordflow">return</span> 9;
<a name="l01809"></a>01809    <span class="keywordflow">else</span> <span class="comment">/*assume they meant INBOX if folder is not found otherwise*/</span>
<a name="l01810"></a>01810       <span class="keywordflow">return</span> 0;
<a name="l01811"></a>01811 }
<a name="l01812"></a>01812 
<a name="l01813"></a>01813 <span class="keyword">static</span> <span class="keywordtype">int</span> __messagecount(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l01814"></a>01814 {
<a name="l01815"></a>01815    SEARCHPGM *pgm;
<a name="l01816"></a>01816    SEARCHHEADER *hdr;
<a name="l01817"></a>01817 
<a name="l01818"></a>01818    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, vmus;
<a name="l01819"></a>01819    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms_p;
<a name="l01820"></a>01820    <span class="keywordtype">int</span> ret = 0;
<a name="l01821"></a>01821    <span class="keywordtype">int</span> fold = folder_int(folder);
<a name="l01822"></a>01822    <span class="keywordtype">int</span> urgent = 0;
<a name="l01823"></a>01823    
<a name="l01824"></a>01824    <span class="comment">/* If URGENT, then look at INBOX */</span>
<a name="l01825"></a>01825    <span class="keywordflow">if</span> (fold == 11) {
<a name="l01826"></a>01826       fold = <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>;
<a name="l01827"></a>01827       urgent = 1;
<a name="l01828"></a>01828    }
<a name="l01829"></a>01829 
<a name="l01830"></a>01830    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox))
<a name="l01831"></a>01831       <span class="keywordflow">return</span> 0;
<a name="l01832"></a>01832 
<a name="l01833"></a>01833    <span class="comment">/* We have to get the user before we can open the stream! */</span>
<a name="l01834"></a>01834    vmu = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;vmus, context, mailbox);
<a name="l01835"></a>01835    <span class="keywordflow">if</span> (!vmu) {
<a name="l01836"></a>01836       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t find mailbox %s in context %s\n&quot;</span>, mailbox, context);
<a name="l01837"></a>01837       <span class="keywordflow">return</span> -1;
<a name="l01838"></a>01838    } <span class="keywordflow">else</span> {
<a name="l01839"></a>01839       <span class="comment">/* No IMAP account available */</span>
<a name="l01840"></a>01840       <span class="keywordflow">if</span> (vmu-&gt;imapuser[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01841"></a>01841          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;IMAP user not set for mailbox %s\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l01842"></a>01842          <span class="keywordflow">return</span> -1;
<a name="l01843"></a>01843       }
<a name="l01844"></a>01844    }
<a name="l01845"></a>01845    
<a name="l01846"></a>01846    <span class="comment">/* No IMAP account available */</span>
<a name="l01847"></a>01847    <span class="keywordflow">if</span> (vmu-&gt;imapuser[0] == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l01848"></a>01848       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;IMAP user not set for mailbox %s\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l01849"></a>01849       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l01850"></a>01850       <span class="keywordflow">return</span> -1;
<a name="l01851"></a>01851    }
<a name="l01852"></a>01852 
<a name="l01853"></a>01853    <span class="comment">/* check if someone is accessing this box right now... */</span>
<a name="l01854"></a>01854    vms_p = get_vm_state_by_imapuser(vmu-&gt;imapuser,1);
<a name="l01855"></a>01855    <span class="keywordflow">if</span> (!vms_p) {
<a name="l01856"></a>01856       vms_p = get_vm_state_by_mailbox(mailbox, context, 1);
<a name="l01857"></a>01857    }
<a name="l01858"></a>01858    <span class="keywordflow">if</span> (vms_p) {
<a name="l01859"></a>01859       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Returning before search - user is logged in\n&quot;</span>);
<a name="l01860"></a>01860       <span class="keywordflow">if</span> (fold == 0) { <span class="comment">/* INBOX */</span>
<a name="l01861"></a>01861          <span class="keywordflow">return</span> vms_p-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;
<a name="l01862"></a>01862       }
<a name="l01863"></a>01863       <span class="keywordflow">if</span> (fold == 1) { <span class="comment">/* Old messages */</span>
<a name="l01864"></a>01864          <span class="keywordflow">return</span> vms_p-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;
<a name="l01865"></a>01865       }
<a name="l01866"></a>01866       <span class="keywordflow">if</span> (fold == 11) {<span class="comment">/*Urgent messages*/</span>
<a name="l01867"></a>01867          <span class="keywordflow">return</span> vms_p-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>;
<a name="l01868"></a>01868       }
<a name="l01869"></a>01869    }
<a name="l01870"></a>01870 
<a name="l01871"></a>01871    <span class="comment">/* add one if not there... */</span>
<a name="l01872"></a>01872    vms_p = get_vm_state_by_imapuser(vmu-&gt;imapuser,0);
<a name="l01873"></a>01873    <span class="keywordflow">if</span> (!vms_p) {
<a name="l01874"></a>01874       vms_p = get_vm_state_by_mailbox(mailbox, context, 0);
<a name="l01875"></a>01875    }
<a name="l01876"></a>01876 
<a name="l01877"></a>01877    <span class="keywordflow">if</span> (!vms_p) {
<a name="l01878"></a>01878       vms_p = create_vm_state_from_user(vmu);
<a name="l01879"></a>01879    }
<a name="l01880"></a>01880    ret = init_mailstream(vms_p, fold);
<a name="l01881"></a>01881    <span class="keywordflow">if</span> (!vms_p-&gt;mailstream) {
<a name="l01882"></a>01882       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Houston we have a problem - IMAP mailstream is NULL\n&quot;</span>);
<a name="l01883"></a>01883       <span class="keywordflow">return</span> -1;
<a name="l01884"></a>01884    }
<a name="l01885"></a>01885    <span class="keywordflow">if</span> (ret == 0) {
<a name="l01886"></a>01886       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms_p-&gt;lock);
<a name="l01887"></a>01887       pgm = mail_newsearchpgm ();
<a name="l01888"></a>01888       hdr = mail_newsearchheader (<span class="stringliteral">&quot;X-Asterisk-VM-Extension&quot;</span>, (<span class="keywordtype">char</span> *)(!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : mailbox));
<a name="l01889"></a>01889       hdr-&gt;next = mail_newsearchheader(<span class="stringliteral">&quot;X-Asterisk-VM-Context&quot;</span>, (<span class="keywordtype">char</span> *) <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;default&quot;</span>));
<a name="l01890"></a>01890       pgm-&gt;header = hdr;
<a name="l01891"></a>01891       <span class="keywordflow">if</span> (fold != 1) {
<a name="l01892"></a>01892          pgm-&gt;unseen = 1;
<a name="l01893"></a>01893          pgm-&gt;seen = 0;
<a name="l01894"></a>01894       }
<a name="l01895"></a>01895       <span class="comment">/* In the special case where fold is 1 (old messages) we have to do things a bit</span>
<a name="l01896"></a>01896 <span class="comment">       * differently. Old messages are stored in the INBOX but are marked as &quot;seen&quot;</span>
<a name="l01897"></a>01897 <span class="comment">       */</span>
<a name="l01898"></a>01898       <span class="keywordflow">else</span> {
<a name="l01899"></a>01899          pgm-&gt;unseen = 0;
<a name="l01900"></a>01900          pgm-&gt;seen = 1;
<a name="l01901"></a>01901       }
<a name="l01902"></a>01902       <span class="comment">/* look for urgent messages */</span>
<a name="l01903"></a>01903       <span class="keywordflow">if</span> (urgent) {
<a name="l01904"></a>01904          pgm-&gt;flagged = 1;
<a name="l01905"></a>01905          pgm-&gt;unflagged = 0;
<a name="l01906"></a>01906       }
<a name="l01907"></a>01907       pgm-&gt;undeleted = 1;
<a name="l01908"></a>01908       pgm-&gt;deleted = 0;
<a name="l01909"></a>01909 
<a name="l01910"></a>01910       vms_p-&gt;vmArrayIndex = 0;
<a name="l01911"></a>01911       mail_search_full (vms_p-&gt;mailstream, NULL, pgm, NIL);
<a name="l01912"></a>01912       <span class="keywordflow">if</span> (fold == 0 &amp;&amp; urgent == 0)
<a name="l01913"></a>01913          vms_p-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = vms_p-&gt;vmArrayIndex;
<a name="l01914"></a>01914       <span class="keywordflow">if</span> (fold == 1)
<a name="l01915"></a>01915          vms_p-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = vms_p-&gt;vmArrayIndex;
<a name="l01916"></a>01916       <span class="keywordflow">if</span> (fold == 0 &amp;&amp; urgent == 1)
<a name="l01917"></a>01917          vms_p-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> = vms_p-&gt;vmArrayIndex;
<a name="l01918"></a>01918       <span class="comment">/*Freeing the searchpgm also frees the searchhdr*/</span>
<a name="l01919"></a>01919       mail_free_searchpgm(&amp;pgm);
<a name="l01920"></a>01920       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);
<a name="l01921"></a>01921       vms_p-&gt;updated = 0;
<a name="l01922"></a>01922       <span class="keywordflow">return</span> vms_p-&gt;vmArrayIndex;
<a name="l01923"></a>01923    } <span class="keywordflow">else</span> {
<a name="l01924"></a>01924       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms_p-&gt;lock);
<a name="l01925"></a>01925       mail_ping(vms_p-&gt;mailstream);
<a name="l01926"></a>01926       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms_p-&gt;lock);
<a name="l01927"></a>01927    }
<a name="l01928"></a>01928    <span class="keywordflow">return</span> 0;
<a name="l01929"></a>01929 }
<a name="l01930"></a>01930 <span class="comment"></span>
<a name="l01931"></a>01931 <span class="comment">/*!</span>
<a name="l01932"></a>01932 <span class="comment"> * \brief Gets the number of messages that exist in a mailbox folder.</span>
<a name="l01933"></a>01933 <span class="comment"> * \param context</span>
<a name="l01934"></a>01934 <span class="comment"> * \param mailbox</span>
<a name="l01935"></a>01935 <span class="comment"> * \param folder</span>
<a name="l01936"></a>01936 <span class="comment"> * </span>
<a name="l01937"></a>01937 <span class="comment"> * This method is used when IMAP backend is used.</span>
<a name="l01938"></a>01938 <span class="comment"> * \return The number of messages in this mailbox folder (zero or more).</span>
<a name="l01939"></a>01939 <span class="comment"> */</span>
<a name="l01940"></a>01940 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a276efe40a0edb56b717e542b711bf5aa">messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l01941"></a>01941 {
<a name="l01942"></a>01942    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(folder) || !strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>)) {
<a name="l01943"></a>01943       <span class="keywordflow">return</span> __messagecount(context, mailbox, <span class="stringliteral">&quot;INBOX&quot;</span>) + __messagecount(context, mailbox, <span class="stringliteral">&quot;Urgent&quot;</span>);
<a name="l01944"></a>01944    } <span class="keywordflow">else</span> {
<a name="l01945"></a>01945       <span class="keywordflow">return</span> __messagecount(context, mailbox, folder);
<a name="l01946"></a>01946    }
<a name="l01947"></a>01947 }
<a name="l01948"></a>01948 
<a name="l01949"></a>01949 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_store_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">int</span> msgnum, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> duration, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l01950"></a>01950 {
<a name="l01951"></a>01951    <span class="keywordtype">char</span> *myserveremail = <a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;
<a name="l01952"></a>01952    <span class="keywordtype">char</span> <a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>[PATH_MAX];
<a name="l01953"></a>01953    <span class="keywordtype">char</span> introfn[PATH_MAX];
<a name="l01954"></a>01954    <span class="keywordtype">char</span> mailbox[256];
<a name="l01955"></a>01955    <span class="keywordtype">char</span> *stringp;
<a name="l01956"></a>01956    FILE *p=NULL;
<a name="l01957"></a>01957    <span class="keywordtype">char</span> tmp[80] = <span class="stringliteral">&quot;/tmp/astmail-XXXXXX&quot;</span>;
<a name="l01958"></a>01958    <span class="keywordtype">long</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01959"></a>01959    <span class="keywordtype">void</span> *buf;
<a name="l01960"></a>01960    <span class="keywordtype">int</span> tempcopy = 0;
<a name="l01961"></a>01961    STRING <a class="code" href="app__jack_8c.html#af25d6dc49269fa2003ac7c7fa6f13915">str</a>;
<a name="l01962"></a>01962    <span class="keywordtype">int</span> ret; <span class="comment">/* for better error checking */</span>
<a name="l01963"></a>01963    <span class="keywordtype">char</span> *imap_flags = NIL;
<a name="l01964"></a>01964 
<a name="l01965"></a>01965     <span class="comment">/* Back out early if this is a greeting and we don&apos;t want to store greetings in IMAP */</span>
<a name="l01966"></a>01966     <span class="keywordflow">if</span> (msgnum &lt; 0 &amp;&amp; !imapgreetings) {
<a name="l01967"></a>01967         <span class="keywordflow">return</span> 0;
<a name="l01968"></a>01968     }
<a name="l01969"></a>01969 
<a name="l01970"></a>01970    <span class="comment">/* Set urgent flag for IMAP message */</span>
<a name="l01971"></a>01971    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) {
<a name="l01972"></a>01972       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Setting message flag \\\\FLAGGED.\n&quot;</span>);
<a name="l01973"></a>01973       imap_flags=<span class="stringliteral">&quot;\\FLAGGED&quot;</span>;
<a name="l01974"></a>01974    }
<a name="l01975"></a>01975    
<a name="l01976"></a>01976    <span class="comment">/* Attach only the first format */</span>
<a name="l01977"></a>01977    fmt = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fmt);
<a name="l01978"></a>01978    stringp = fmt;
<a name="l01979"></a>01979    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l01980"></a>01980 
<a name="l01981"></a>01981    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>))
<a name="l01982"></a>01982       myserveremail = vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;
<a name="l01983"></a>01983 
<a name="l01984"></a>01984    <span class="keywordflow">if</span> (msgnum &gt; -1)
<a name="l01985"></a>01985       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);
<a name="l01986"></a>01986    <span class="keywordflow">else</span>
<a name="l01987"></a>01987       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a> (fn, dir, <span class="keyword">sizeof</span>(fn));
<a name="l01988"></a>01988 
<a name="l01989"></a>01989    snprintf(introfn, <span class="keyword">sizeof</span>(introfn), <span class="stringliteral">&quot;%sintro&quot;</span>, fn);
<a name="l01990"></a>01990    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(introfn, NULL, NULL) &lt;= 0) {
<a name="l01991"></a>01991       *introfn = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01992"></a>01992    }
<a name="l01993"></a>01993    
<a name="l01994"></a>01994    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>)) {
<a name="l01995"></a>01995       <span class="comment">/* We need the vmu-&gt;email to be set when we call make_email_file, but</span>
<a name="l01996"></a>01996 <span class="comment">       * if we keep it set, a duplicate e-mail will be created. So at the end</span>
<a name="l01997"></a>01997 <span class="comment">       * of this function, we will revert back to an empty string if tempcopy</span>
<a name="l01998"></a>01998 <span class="comment">       * is 1.</span>
<a name="l01999"></a>01999 <span class="comment">       */</span>
<a name="l02000"></a>02000       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>, vmu-&gt;imapuser, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>));
<a name="l02001"></a>02001       tempcopy = 1;
<a name="l02002"></a>02002    }
<a name="l02003"></a>02003 
<a name="l02004"></a>02004    <span class="keywordflow">if</span> (!strcmp(fmt, <span class="stringliteral">&quot;wav49&quot;</span>))
<a name="l02005"></a>02005       fmt = <span class="stringliteral">&quot;WAV&quot;</span>;
<a name="l02006"></a>02006    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Storing file &apos;%s&apos;, format &apos;%s&apos;\n&quot;</span>, fn, fmt);
<a name="l02007"></a>02007 
<a name="l02008"></a>02008    <span class="comment">/* Make a temporary file instead of piping directly to sendmail, in case the mail</span>
<a name="l02009"></a>02009 <span class="comment">      command hangs. */</span>
<a name="l02010"></a>02010    <span class="keywordflow">if</span> (!(p = <a class="code" href="app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(tmp))) {
<a name="l02011"></a>02011       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to store &apos;%s&apos; (can&apos;t create temporary file)\n&quot;</span>, fn);
<a name="l02012"></a>02012       <span class="keywordflow">if</span> (tempcopy)
<a name="l02013"></a>02013          *(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02014"></a>02014       <span class="keywordflow">return</span> -1;
<a name="l02015"></a>02015    }
<a name="l02016"></a>02016 
<a name="l02017"></a>02017    <span class="keywordflow">if</span> (msgnum &lt; 0 &amp;&amp; imapgreetings) {
<a name="l02018"></a>02018       <span class="keywordflow">if</span> ((ret = init_mailstream(vms, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>))) {
<a name="l02019"></a>02019          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open mailstream.\n&quot;</span>);
<a name="l02020"></a>02020          <span class="keywordflow">return</span> -1;
<a name="l02021"></a>02021       }
<a name="l02022"></a>02022       imap_delete_old_greeting(fn, vms);
<a name="l02023"></a>02023    }
<a name="l02024"></a>02024 
<a name="l02025"></a>02025    <a class="code" href="app__voicemail_8c.html#ae3cbc800cf1d17d77a43c57a6015a4f2" title="Creates the email file to be sent to indicate a new voicemail exists for a user.">make_email_file</a>(p, myserveremail, vmu, msgnum, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, NULL), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL), fn, introfn, fmt, duration, 1, chan, NULL, 1, flag);
<a name="l02026"></a>02026    <span class="comment">/* read mail file to memory */</span>
<a name="l02027"></a>02027    len = ftell(p);
<a name="l02028"></a>02028    rewind(p);
<a name="l02029"></a>02029    <span class="keywordflow">if</span> (!(buf = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(len + 1))) {
<a name="l02030"></a>02030       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Can&apos;t allocate %ld bytes to read message\n&quot;</span>, len + 1);
<a name="l02031"></a>02031       fclose(p);
<a name="l02032"></a>02032       <span class="keywordflow">if</span> (tempcopy)
<a name="l02033"></a>02033          *(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02034"></a>02034       <span class="keywordflow">return</span> -1;
<a name="l02035"></a>02035    }
<a name="l02036"></a>02036    <span class="keywordflow">if</span> (fread(buf, len, 1, p) &lt; len) {
<a name="l02037"></a>02037       <span class="keywordflow">if</span> (ferror(p)) {
<a name="l02038"></a>02038          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Short read while reading in mail file.\n&quot;</span>);
<a name="l02039"></a>02039          <span class="keywordflow">return</span> -1;
<a name="l02040"></a>02040       }
<a name="l02041"></a>02041    }
<a name="l02042"></a>02042    ((<span class="keywordtype">char</span> *)buf)[len] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02043"></a>02043    INIT(&amp;str, mail_string, buf, len);
<a name="l02044"></a>02044    ret = init_mailstream(vms, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l02045"></a>02045    <span class="keywordflow">if</span> (ret == 0) {
<a name="l02046"></a>02046       imap_mailbox_name(mailbox, <span class="keyword">sizeof</span>(mailbox), vms, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>, 1);
<a name="l02047"></a>02047       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l02048"></a>02048       <span class="keywordflow">if</span>(!mail_append_full(vms-&gt;mailstream, mailbox, imap_flags, NIL, &amp;str))
<a name="l02049"></a>02049          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error while sending the message to %s\n&quot;</span>, mailbox);
<a name="l02050"></a>02050       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l02051"></a>02051       fclose(p);
<a name="l02052"></a>02052       unlink(tmp);
<a name="l02053"></a>02053       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);
<a name="l02054"></a>02054    } <span class="keywordflow">else</span> {
<a name="l02055"></a>02055       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not initialize mailstream for %s\n&quot;</span>,mailbox);
<a name="l02056"></a>02056       fclose(p);
<a name="l02057"></a>02057       unlink(tmp);
<a name="l02058"></a>02058       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(buf);
<a name="l02059"></a>02059       <span class="keywordflow">return</span> -1;
<a name="l02060"></a>02060    }
<a name="l02061"></a>02061    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;%s stored\n&quot;</span>, fn);
<a name="l02062"></a>02062    
<a name="l02063"></a>02063    <span class="keywordflow">if</span> (tempcopy)
<a name="l02064"></a>02064       *(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>) = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02065"></a>02065    
<a name="l02066"></a>02066    <span class="keywordflow">return</span> 0;
<a name="l02067"></a>02067 
<a name="l02068"></a>02068 }
<a name="l02069"></a>02069 <span class="comment"></span>
<a name="l02070"></a>02070 <span class="comment">/*!</span>
<a name="l02071"></a>02071 <span class="comment"> * \brief Gets the number of messages that exist in the inbox folder.</span>
<a name="l02072"></a>02072 <span class="comment"> * \param mailbox_context</span>
<a name="l02073"></a>02073 <span class="comment"> * \param newmsgs The variable that is updated with the count of new messages within this inbox.</span>
<a name="l02074"></a>02074 <span class="comment"> * \param oldmsgs The variable that is updated with the count of old messages within this inbox.</span>
<a name="l02075"></a>02075 <span class="comment"> * \param urgentmsgs The variable that is updated with the count of urgent messages within this inbox.</span>
<a name="l02076"></a>02076 <span class="comment"> * </span>
<a name="l02077"></a>02077 <span class="comment"> * This method is used when IMAP backend is used.</span>
<a name="l02078"></a>02078 <span class="comment"> * Simultaneously determines the count of new,old, and urgent messages. The total messages would then be the sum of these three.</span>
<a name="l02079"></a>02079 <span class="comment"> *</span>
<a name="l02080"></a>02080 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l02081"></a>02081 <span class="comment"> */</span>
<a name="l02082"></a>02082 
<a name="l02083"></a>02083 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox_context, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)
<a name="l02084"></a>02084 {
<a name="l02085"></a>02085    <span class="keywordtype">char</span> tmp[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02086"></a>02086    <span class="keywordtype">char</span> *mailboxnc;
<a name="l02087"></a>02087    <span class="keywordtype">char</span> *context;
<a name="l02088"></a>02088    <span class="keywordtype">char</span> *mb;
<a name="l02089"></a>02089    <span class="keywordtype">char</span> *cur;
<a name="l02090"></a>02090    <span class="keywordflow">if</span> (newmsgs)
<a name="l02091"></a>02091       *newmsgs = 0;
<a name="l02092"></a>02092    <span class="keywordflow">if</span> (oldmsgs)
<a name="l02093"></a>02093       *oldmsgs = 0;
<a name="l02094"></a>02094    <span class="keywordflow">if</span> (urgentmsgs)
<a name="l02095"></a>02095       *urgentmsgs = 0;
<a name="l02096"></a>02096 
<a name="l02097"></a>02097    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3,<span class="stringliteral">&quot;Mailbox is set to %s\n&quot;</span>,mailbox_context);
<a name="l02098"></a>02098    <span class="comment">/* If no mailbox, return immediately */</span>
<a name="l02099"></a>02099    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox_context))
<a name="l02100"></a>02100       <span class="keywordflow">return</span> 0;
<a name="l02101"></a>02101    
<a name="l02102"></a>02102    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox_context, <span class="keyword">sizeof</span>(tmp));
<a name="l02103"></a>02103    context = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>);
<a name="l02104"></a>02104    <span class="keywordflow">if</span> (strchr(mailbox_context, <span class="charliteral">&apos;,&apos;</span>)) {
<a name="l02105"></a>02105       <span class="keywordtype">int</span> tmpnew, tmpold, tmpurgent;
<a name="l02106"></a>02106       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox_context, <span class="keyword">sizeof</span>(tmp));
<a name="l02107"></a>02107       mb = tmp;
<a name="l02108"></a>02108       <span class="keywordflow">while</span> ((cur = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;mb, <span class="stringliteral">&quot;, &quot;</span>))) {
<a name="l02109"></a>02109          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cur)) {
<a name="l02110"></a>02110             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(cur, urgentmsgs ? &amp;tmpurgent : NULL, newmsgs ? &amp;tmpnew : NULL, oldmsgs ? &amp;tmpold : NULL))
<a name="l02111"></a>02111                <span class="keywordflow">return</span> -1;
<a name="l02112"></a>02112             <span class="keywordflow">else</span> {
<a name="l02113"></a>02113                <span class="keywordflow">if</span> (newmsgs)
<a name="l02114"></a>02114                   *newmsgs += tmpnew; 
<a name="l02115"></a>02115                <span class="keywordflow">if</span> (oldmsgs)
<a name="l02116"></a>02116                   *oldmsgs += tmpold;
<a name="l02117"></a>02117                <span class="keywordflow">if</span> (urgentmsgs)
<a name="l02118"></a>02118                   *urgentmsgs += tmpurgent;
<a name="l02119"></a>02119             }
<a name="l02120"></a>02120          }
<a name="l02121"></a>02121       }
<a name="l02122"></a>02122       <span class="keywordflow">return</span> 0;
<a name="l02123"></a>02123    }
<a name="l02124"></a>02124    <span class="keywordflow">if</span> (context) {
<a name="l02125"></a>02125       *context = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02126"></a>02126       mailboxnc = tmp;
<a name="l02127"></a>02127       context++;
<a name="l02128"></a>02128    } <span class="keywordflow">else</span> {
<a name="l02129"></a>02129       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l02130"></a>02130       mailboxnc = (<span class="keywordtype">char</span> *)mailbox_context;
<a name="l02131"></a>02131    }
<a name="l02132"></a>02132    <span class="keywordflow">if</span> (newmsgs) {
<a name="l02133"></a>02133       <span class="keywordflow">if</span> ((*newmsgs = __messagecount(context, mailboxnc, imapfolder)) &lt; 0) {
<a name="l02134"></a>02134          <span class="keywordflow">return</span> -1;
<a name="l02135"></a>02135       }
<a name="l02136"></a>02136    }
<a name="l02137"></a>02137    <span class="keywordflow">if</span> (oldmsgs) {
<a name="l02138"></a>02138       <span class="keywordflow">if</span> ((*oldmsgs = __messagecount(context, mailboxnc, <span class="stringliteral">&quot;Old&quot;</span>)) &lt; 0) {
<a name="l02139"></a>02139          <span class="keywordflow">return</span> -1;
<a name="l02140"></a>02140       }
<a name="l02141"></a>02141    }
<a name="l02142"></a>02142    <span class="keywordflow">if</span> (urgentmsgs) {
<a name="l02143"></a>02143       <span class="keywordflow">if</span> ((*urgentmsgs = __messagecount(context, mailboxnc, <span class="stringliteral">&quot;Urgent&quot;</span>)) &lt; 0) {
<a name="l02144"></a>02144          <span class="keywordflow">return</span> -1;
<a name="l02145"></a>02145       }
<a name="l02146"></a>02146    }
<a name="l02147"></a>02147    <span class="keywordflow">return</span> 0;
<a name="l02148"></a>02148 }
<a name="l02149"></a>02149 <span class="comment"></span>
<a name="l02150"></a>02150 <span class="comment">/** </span>
<a name="l02151"></a>02151 <span class="comment"> * \brief Determines if the given folder has messages.</span>
<a name="l02152"></a>02152 <span class="comment"> * \param mailbox The @ delimited string for user@context. If no context is found, uses &apos;default&apos; for the context.</span>
<a name="l02153"></a>02153 <span class="comment"> * \param folder the folder to look in</span>
<a name="l02154"></a>02154 <span class="comment"> *</span>
<a name="l02155"></a>02155 <span class="comment"> * This function is used when the mailbox is stored in an IMAP back end.</span>
<a name="l02156"></a>02156 <span class="comment"> * This invokes the messagecount(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.</span>
<a name="l02157"></a>02157 <span class="comment"> * \return 1 if the folder has one or more messages. zero otherwise.</span>
<a name="l02158"></a>02158 <span class="comment"> */</span>
<a name="l02159"></a>02159 
<a name="l02160"></a>02160 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7" title="Determines if the given folder has messages.">has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l02161"></a>02161 {
<a name="l02162"></a>02162    <span class="keywordtype">char</span> tmp[256], *tmp2, *box, *context;
<a name="l02163"></a>02163    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));
<a name="l02164"></a>02164    tmp2 = tmp;
<a name="l02165"></a>02165    <span class="keywordflow">if</span> (strchr(tmp2, <span class="charliteral">&apos;,&apos;</span>) || strchr(tmp2, <span class="charliteral">&apos;&amp;&apos;</span>)) {
<a name="l02166"></a>02166       <span class="keywordflow">while</span> ((box = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp2, <span class="stringliteral">&quot;,&amp;&quot;</span>))) {
<a name="l02167"></a>02167          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(box)) {
<a name="l02168"></a>02168             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7" title="Determines if the given folder has messages.">has_voicemail</a>(box, folder)) {
<a name="l02169"></a>02169                <span class="keywordflow">return</span> 1;
<a name="l02170"></a>02170             }
<a name="l02171"></a>02171          }
<a name="l02172"></a>02172       }
<a name="l02173"></a>02173    }
<a name="l02174"></a>02174    <span class="keywordflow">if</span> ((context = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l02175"></a>02175       *context++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02176"></a>02176    } <span class="keywordflow">else</span> {
<a name="l02177"></a>02177       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l02178"></a>02178    }
<a name="l02179"></a>02179    <span class="keywordflow">return</span> __messagecount(context, tmp, folder) ? 1 : 0;
<a name="l02180"></a>02180 }
<a name="l02181"></a>02181 <span class="comment"></span>
<a name="l02182"></a>02182 <span class="comment">/*!</span>
<a name="l02183"></a>02183 <span class="comment"> * \brief Copies a message from one mailbox to another.</span>
<a name="l02184"></a>02184 <span class="comment"> * \param chan</span>
<a name="l02185"></a>02185 <span class="comment"> * \param vmu</span>
<a name="l02186"></a>02186 <span class="comment"> * \param imbox</span>
<a name="l02187"></a>02187 <span class="comment"> * \param msgnum</span>
<a name="l02188"></a>02188 <span class="comment"> * \param duration</span>
<a name="l02189"></a>02189 <span class="comment"> * \param recip</span>
<a name="l02190"></a>02190 <span class="comment"> * \param fmt</span>
<a name="l02191"></a>02191 <span class="comment"> * \param dir</span>
<a name="l02192"></a>02192 <span class="comment"> *</span>
<a name="l02193"></a>02193 <span class="comment"> * This works with IMAP storage based mailboxes.</span>
<a name="l02194"></a>02194 <span class="comment"> *</span>
<a name="l02195"></a>02195 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l02196"></a>02196 <span class="comment"> */</span>
<a name="l02197"></a>02197 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a6a81ca7c488e8311134145f6c11c16b9" title="Copies a message from one mailbox to another.">copy_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> imbox, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *recip, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *dir, <span class="keywordtype">char</span> *flag)
<a name="l02198"></a>02198 {
<a name="l02199"></a>02199    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *sendvms = NULL, *destvms = NULL;
<a name="l02200"></a>02200    <span class="keywordtype">char</span> messagestring[10]; <span class="comment">/*I guess this could be a problem if someone has more than 999999999 messages...*/</span>
<a name="l02201"></a>02201    <span class="keywordflow">if</span> (msgnum &gt;= recip-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>) {
<a name="l02202"></a>02202       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to copy mail, mailbox %s is full\n&quot;</span>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l02203"></a>02203       <span class="keywordflow">return</span> -1;
<a name="l02204"></a>02204    }
<a name="l02205"></a>02205    <span class="keywordflow">if</span> (!(sendvms = get_vm_state_by_imapuser(vmu-&gt;imapuser, 0))) {
<a name="l02206"></a>02206       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t get vm_state for originator&apos;s mailbox!!\n&quot;</span>);
<a name="l02207"></a>02207       <span class="keywordflow">return</span> -1;
<a name="l02208"></a>02208    }
<a name="l02209"></a>02209    <span class="keywordflow">if</span> (!(destvms = get_vm_state_by_imapuser(recip-&gt;imapuser, 0))) {
<a name="l02210"></a>02210       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t get vm_state for destination mailbox!\n&quot;</span>);
<a name="l02211"></a>02211       <span class="keywordflow">return</span> -1;
<a name="l02212"></a>02212    }
<a name="l02213"></a>02213    snprintf(messagestring, <span class="keyword">sizeof</span>(messagestring), <span class="stringliteral">&quot;%ld&quot;</span>, sendvms-&gt;msgArray[msgnum]);
<a name="l02214"></a>02214    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;sendvms-&gt;lock);
<a name="l02215"></a>02215    <span class="keywordflow">if</span> ((mail_copy(sendvms-&gt;mailstream, messagestring, (<span class="keywordtype">char</span> *) <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(imbox)) == T)) {
<a name="l02216"></a>02216       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;sendvms-&gt;lock);
<a name="l02217"></a>02217       <span class="keywordflow">return</span> 0;
<a name="l02218"></a>02218    }
<a name="l02219"></a>02219    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;sendvms-&gt;lock);
<a name="l02220"></a>02220    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to copy message from mailbox %s to mailbox %s\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l02221"></a>02221    <span class="keywordflow">return</span> -1;
<a name="l02222"></a>02222 }
<a name="l02223"></a>02223 
<a name="l02224"></a>02224 <span class="keyword">static</span> <span class="keywordtype">void</span> imap_mailbox_name(<span class="keywordtype">char</span> *spec, <span class="keywordtype">size_t</span> len, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box, <span class="keywordtype">int</span> use_folder)
<a name="l02225"></a>02225 {
<a name="l02226"></a>02226    <span class="keywordtype">char</span> tmp[256], *t = tmp;
<a name="l02227"></a>02227    <span class="keywordtype">size_t</span> left = <span class="keyword">sizeof</span>(tmp);
<a name="l02228"></a>02228    
<a name="l02229"></a>02229    <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {
<a name="l02230"></a>02230       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(<a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>), <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));
<a name="l02231"></a>02231    } <span class="keywordflow">else</span> {
<a name="l02232"></a>02232       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box), <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));
<a name="l02233"></a>02233    }
<a name="l02234"></a>02234 
<a name="l02235"></a>02235    <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>) {
<a name="l02236"></a>02236       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="stringliteral">&quot;vm-INBOX&quot;</span>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>));
<a name="l02237"></a>02237    } <span class="keywordflow">else</span> {
<a name="l02238"></a>02238       snprintf(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l02239"></a>02239    }
<a name="l02240"></a>02240 
<a name="l02241"></a>02241    <span class="comment">/* Build up server information */</span>
<a name="l02242"></a>02242    <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;{%s:%s/imap&quot;</span>, imapserver, imapport);
<a name="l02243"></a>02243 
<a name="l02244"></a>02244    <span class="comment">/* Add authentication user if present */</span>
<a name="l02245"></a>02245    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(authuser))
<a name="l02246"></a>02246       <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/authuser=%s&quot;</span>, authuser);
<a name="l02247"></a>02247 
<a name="l02248"></a>02248    <span class="comment">/* Add flags if present */</span>
<a name="l02249"></a>02249    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(imapflags))
<a name="l02250"></a>02250       <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/%s&quot;</span>, imapflags);
<a name="l02251"></a>02251 
<a name="l02252"></a>02252    <span class="comment">/* End with username */</span>
<a name="l02253"></a>02253 <span class="preprocessor">#if 1</span>
<a name="l02254"></a>02254 <span class="preprocessor"></span>   <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/user=%s}&quot;</span>, vms-&gt;imapuser);
<a name="l02255"></a>02255 <span class="preprocessor">#else</span>
<a name="l02256"></a>02256 <span class="preprocessor"></span>   <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;t, &amp;left, <span class="stringliteral">&quot;/user=%s/novalidate-cert}&quot;</span>, vms-&gt;imapuser);
<a name="l02257"></a>02257 <span class="preprocessor">#endif</span>
<a name="l02258"></a>02258 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> || box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>)
<a name="l02259"></a>02259       snprintf(spec, len, <span class="stringliteral">&quot;%s%s&quot;</span>, tmp, use_folder? imapfolder: <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l02260"></a>02260    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a922b06033e574a67b32a35b379dc8953">GREETINGS_FOLDER</a>)
<a name="l02261"></a>02261       snprintf(spec, len, <span class="stringliteral">&quot;%s%s&quot;</span>, tmp, greetingfolder);
<a name="l02262"></a>02262    <span class="keywordflow">else</span> {   <span class="comment">/* Other folders such as Friends, Family, etc... */</span>
<a name="l02263"></a>02263       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(imapparentfolder)) {
<a name="l02264"></a>02264          <span class="comment">/* imapparentfolder would typically be set to INBOX */</span>
<a name="l02265"></a>02265          snprintf(spec, len, <span class="stringliteral">&quot;%s%s%c%s&quot;</span>, tmp, imapparentfolder, delimiter, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l02266"></a>02266       } <span class="keywordflow">else</span> {
<a name="l02267"></a>02267          snprintf(spec, len, <span class="stringliteral">&quot;%s%s&quot;</span>, tmp, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l02268"></a>02268       }
<a name="l02269"></a>02269    }
<a name="l02270"></a>02270 }
<a name="l02271"></a>02271 
<a name="l02272"></a>02272 <span class="keyword">static</span> <span class="keywordtype">int</span> init_mailstream(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> box)
<a name="l02273"></a>02273 {
<a name="l02274"></a>02274    MAILSTREAM *stream = NIL;
<a name="l02275"></a>02275    <span class="keywordtype">long</span> <a class="code" href="app__rpt_8c.html#ac3e1795766a80ec63b157951b4b9a7d4">debug</a>;
<a name="l02276"></a>02276    <span class="keywordtype">char</span> tmp[256];
<a name="l02277"></a>02277    
<a name="l02278"></a>02278    <span class="keywordflow">if</span> (!vms) {
<a name="l02279"></a>02279       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>,<span class="stringliteral">&quot;vm_state is NULL!\n&quot;</span>);
<a name="l02280"></a>02280       <span class="keywordflow">return</span> -1;
<a name="l02281"></a>02281    }
<a name="l02282"></a>02282    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l02283"></a>02283       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;vm_state user is:%s\n&quot;</span>,vms-&gt;imapuser);
<a name="l02284"></a>02284    <span class="keywordflow">if</span> (vms-&gt;mailstream == NIL || !vms-&gt;mailstream) {
<a name="l02285"></a>02285       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>)
<a name="l02286"></a>02286          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;mailstream not set.\n&quot;</span>);
<a name="l02287"></a>02287    } <span class="keywordflow">else</span> {
<a name="l02288"></a>02288       stream = vms-&gt;mailstream;
<a name="l02289"></a>02289    }
<a name="l02290"></a>02290    <span class="comment">/* debug = T;  user wants protocol telemetry? */</span>
<a name="l02291"></a>02291    debug = NIL;  <span class="comment">/* NO protocol telemetry? */</span>
<a name="l02292"></a>02292 
<a name="l02293"></a>02293    <span class="keywordflow">if</span> (delimiter == <span class="charliteral">&apos;\0&apos;</span>) {      <span class="comment">/* did not probe the server yet */</span>
<a name="l02294"></a>02294       <span class="keywordtype">char</span> *cp;
<a name="l02295"></a>02295 <span class="preprocessor">#ifdef USE_SYSTEM_IMAP</span>
<a name="l02296"></a>02296 <span class="preprocessor"></span><span class="preprocessor">#include &lt;imap/linkage.c&gt;</span>
<a name="l02297"></a>02297 <span class="preprocessor">#elif defined(USE_SYSTEM_CCLIENT)</span>
<a name="l02298"></a>02298 <span class="preprocessor"></span><span class="preprocessor">#include &lt;c-client/linkage.c&gt;</span>
<a name="l02299"></a>02299 <span class="preprocessor">#else</span>
<a name="l02300"></a>02300 <span class="preprocessor"></span><span class="preprocessor">#include &quot;linkage.c&quot;</span>
<a name="l02301"></a>02301 <span class="preprocessor">#endif</span>
<a name="l02302"></a>02302 <span class="preprocessor"></span>      <span class="comment">/* Connect to INBOX first to get folders delimiter */</span>
<a name="l02303"></a>02303       imap_mailbox_name(tmp, <span class="keyword">sizeof</span>(tmp), vms, 0, 1);
<a name="l02304"></a>02304       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l02305"></a>02305       stream = mail_open (stream, tmp, debug ? OP_DEBUG : NIL);
<a name="l02306"></a>02306       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l02307"></a>02307       <span class="keywordflow">if</span> (stream == NIL) {
<a name="l02308"></a>02308          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Can&apos;t connect to imap server %s\n&quot;</span>, tmp);
<a name="l02309"></a>02309          <span class="keywordflow">return</span> -1;
<a name="l02310"></a>02310       }
<a name="l02311"></a>02311       get_mailbox_delimiter(stream);
<a name="l02312"></a>02312       <span class="comment">/* update delimiter in imapfolder */</span>
<a name="l02313"></a>02313       <span class="keywordflow">for</span> (cp = imapfolder; *cp; cp++)
<a name="l02314"></a>02314          <span class="keywordflow">if</span> (*cp == <span class="charliteral">&apos;/&apos;</span>)
<a name="l02315"></a>02315             *cp = delimiter;
<a name="l02316"></a>02316    }
<a name="l02317"></a>02317    <span class="comment">/* Now connect to the target folder */</span>
<a name="l02318"></a>02318    imap_mailbox_name(tmp, <span class="keyword">sizeof</span>(tmp), vms, box, 1);
<a name="l02319"></a>02319    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l02320"></a>02320       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a> (<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>,<span class="stringliteral">&quot;Before mail_open, server: %s, box:%d\n&quot;</span>, tmp, box);
<a name="l02321"></a>02321    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l02322"></a>02322    vms-&gt;mailstream = mail_open (stream, tmp, debug ? OP_DEBUG : NIL);
<a name="l02323"></a>02323    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l02324"></a>02324    <span class="keywordflow">if</span> (vms-&gt;mailstream == NIL) {
<a name="l02325"></a>02325       <span class="keywordflow">return</span> -1;
<a name="l02326"></a>02326    } <span class="keywordflow">else</span> {
<a name="l02327"></a>02327       <span class="keywordflow">return</span> 0;
<a name="l02328"></a>02328    }
<a name="l02329"></a>02329 }
<a name="l02330"></a>02330 
<a name="l02331"></a>02331 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box)
<a name="l02332"></a>02332 {
<a name="l02333"></a>02333    SEARCHPGM *pgm;
<a name="l02334"></a>02334    SEARCHHEADER *hdr;
<a name="l02335"></a>02335    <span class="keywordtype">int</span> ret, urgent = 0;
<a name="l02336"></a>02336 
<a name="l02337"></a>02337    <span class="comment">/* If Urgent, then look at INBOX */</span>
<a name="l02338"></a>02338    <span class="keywordflow">if</span> (box == 11) {
<a name="l02339"></a>02339       box = <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>;
<a name="l02340"></a>02340       urgent = 1;
<a name="l02341"></a>02341    }
<a name="l02342"></a>02342 
<a name="l02343"></a>02343    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms-&gt;imapuser,vmu-&gt;imapuser, <span class="keyword">sizeof</span>(vms-&gt;imapuser));
<a name="l02344"></a>02344    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3,<span class="stringliteral">&quot;Before init_mailstream, user is %s\n&quot;</span>,vmu-&gt;imapuser);
<a name="l02345"></a>02345    vms-&gt;imapversion = vmu-&gt;imapversion;
<a name="l02346"></a>02346 
<a name="l02347"></a>02347    <span class="keywordflow">if</span> ((ret = init_mailstream(vms, box)) || !vms-&gt;mailstream) {
<a name="l02348"></a>02348       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not initialize mailstream\n&quot;</span>);
<a name="l02349"></a>02349       <span class="keywordflow">return</span> -1;
<a name="l02350"></a>02350    }
<a name="l02351"></a>02351    
<a name="l02352"></a>02352    <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l02353"></a>02353    
<a name="l02354"></a>02354    <span class="comment">/* Check Quota */</span>
<a name="l02355"></a>02355    <span class="keywordflow">if</span>  (box == 0)  {
<a name="l02356"></a>02356       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Mailbox name set to: %s, about to check quotas\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l02357"></a>02357       check_quota(vms,(<span class="keywordtype">char</span> *)<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l02358"></a>02358    }
<a name="l02359"></a>02359 
<a name="l02360"></a>02360    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l02361"></a>02361    pgm = mail_newsearchpgm();
<a name="l02362"></a>02362 
<a name="l02363"></a>02363    <span class="comment">/* Check IMAP folder for Asterisk messages only... */</span>
<a name="l02364"></a>02364    hdr = mail_newsearchheader(<span class="stringliteral">&quot;X-Asterisk-VM-Extension&quot;</span>, (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>));
<a name="l02365"></a>02365    hdr-&gt;next = mail_newsearchheader(<span class="stringliteral">&quot;X-Asterisk-VM-Context&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l02366"></a>02366    pgm-&gt;header = hdr;
<a name="l02367"></a>02367    pgm-&gt;deleted = 0;
<a name="l02368"></a>02368    pgm-&gt;undeleted = 1;
<a name="l02369"></a>02369 
<a name="l02370"></a>02370    <span class="comment">/* if box = NEW_FOLDER, check for new, if box = OLD_FOLDER, check for read */</span>
<a name="l02371"></a>02371    <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> &amp;&amp; urgent == 1) {
<a name="l02372"></a>02372       pgm-&gt;unseen = 1;
<a name="l02373"></a>02373       pgm-&gt;seen = 0;
<a name="l02374"></a>02374       pgm-&gt;flagged = 1;
<a name="l02375"></a>02375       pgm-&gt;unflagged = 0;
<a name="l02376"></a>02376    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> &amp;&amp; urgent == 0) {
<a name="l02377"></a>02377       pgm-&gt;unseen = 1;
<a name="l02378"></a>02378       pgm-&gt;seen = 0;
<a name="l02379"></a>02379       pgm-&gt;flagged = 0;
<a name="l02380"></a>02380       pgm-&gt;unflagged = 1;
<a name="l02381"></a>02381    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {
<a name="l02382"></a>02382       pgm-&gt;seen = 1;
<a name="l02383"></a>02383       pgm-&gt;unseen = 0;
<a name="l02384"></a>02384    }
<a name="l02385"></a>02385 
<a name="l02386"></a>02386    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3,<span class="stringliteral">&quot;Before mail_search_full, user is %s\n&quot;</span>,vmu-&gt;imapuser);
<a name="l02387"></a>02387 
<a name="l02388"></a>02388    vms-&gt;vmArrayIndex = 0;
<a name="l02389"></a>02389    mail_search_full (vms-&gt;mailstream, NULL, pgm, NIL);
<a name="l02390"></a>02390    vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = vms-&gt;vmArrayIndex - 1;
<a name="l02391"></a>02391    mail_free_searchpgm(&amp;pgm);
<a name="l02392"></a>02392 
<a name="l02393"></a>02393    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l02394"></a>02394    <span class="keywordflow">return</span> 0;
<a name="l02395"></a>02395 }
<a name="l02396"></a>02396 
<a name="l02397"></a>02397 <span class="keyword">static</span> <span class="keywordtype">void</span> write_file(<span class="keywordtype">char</span> *filename, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len)
<a name="l02398"></a>02398 {
<a name="l02399"></a>02399    FILE *output;
<a name="l02400"></a>02400 
<a name="l02401"></a>02401    output = fopen (filename, <span class="stringliteral">&quot;w&quot;</span>);
<a name="l02402"></a>02402    <span class="keywordflow">if</span> (<a class="code" href="ast__expr2f_8c.html#a8541b986268a39ba1b07d9e912d31732">fwrite</a>(buffer, len, 1, output) != 1) {
<a name="l02403"></a>02403       <span class="keywordflow">if</span> (ferror(output)) {
<a name="l02404"></a>02404          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Short write while writing e-mail body: %s.\n&quot;</span>, strerror(errno));
<a name="l02405"></a>02405       }
<a name="l02406"></a>02406    }
<a name="l02407"></a>02407    fclose (output);
<a name="l02408"></a>02408 }
<a name="l02409"></a>02409 
<a name="l02410"></a>02410 <span class="keyword">static</span> <span class="keywordtype">void</span> update_messages_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <a class="code" href="structnumber.html" title="Number structure.">number</a>)
<a name="l02411"></a>02411 {
<a name="l02412"></a>02412    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms = get_vm_state_by_imapuser(user, 1);
<a name="l02413"></a>02413 
<a name="l02414"></a>02414    <span class="keywordflow">if</span> (!vms &amp;&amp; !(vms = get_vm_state_by_imapuser(user, 0))) {
<a name="l02415"></a>02415       <span class="keywordflow">return</span>;
<a name="l02416"></a>02416    }
<a name="l02417"></a>02417 
<a name="l02418"></a>02418    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;saving mailbox message number %lu as message %d. Interactive set to %d\n&quot;</span>, number, vms-&gt;vmArrayIndex, vms-&gt;interactive);
<a name="l02419"></a>02419    vms-&gt;msgArray[vms-&gt;vmArrayIndex++] = number;
<a name="l02420"></a>02420 }
<a name="l02421"></a>02421 
<a name="l02422"></a>02422 <span class="keywordtype">void</span> mm_searched(MAILSTREAM *stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)
<a name="l02423"></a>02423 {
<a name="l02424"></a>02424    <span class="keywordtype">char</span> *mailbox = stream-&gt;mailbox, buf[1024] = <span class="stringliteral">&quot;&quot;</span>, *user;
<a name="l02425"></a>02425 
<a name="l02426"></a>02426    <span class="keywordflow">if</span> (!(user = get_user_by_mailbox(mailbox, buf, <span class="keyword">sizeof</span>(buf))))
<a name="l02427"></a>02427       <span class="keywordflow">return</span>;
<a name="l02428"></a>02428 
<a name="l02429"></a>02429    update_messages_by_imapuser(user, number);
<a name="l02430"></a>02430 }
<a name="l02431"></a>02431 
<a name="l02432"></a>02432 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *find_user_realtime_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *imapuser)
<a name="l02433"></a>02433 {
<a name="l02434"></a>02434    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l02435"></a>02435    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l02436"></a>02436 
<a name="l02437"></a>02437    vmu = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span> *vmu);
<a name="l02438"></a>02438    <span class="keywordflow">if</span> (!vmu)
<a name="l02439"></a>02439       <span class="keywordflow">return</span> NULL;
<a name="l02440"></a>02440    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);
<a name="l02441"></a>02441    <a class="code" href="app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0" title="Sets default voicemail system options to a voicemail user.">populate_defaults</a>(vmu);
<a name="l02442"></a>02442 
<a name="l02443"></a>02443    var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;imapuser&quot;</span>, imapuser, NULL);
<a name="l02444"></a>02444    <span class="keywordflow">if</span> (var) {
<a name="l02445"></a>02445       <a class="code" href="app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f" title="Loads the options specific to a voicemail user.">apply_options_full</a>(vmu, var);
<a name="l02446"></a>02446       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l02447"></a>02447       <span class="keywordflow">return</span> vmu;
<a name="l02448"></a>02448    } <span class="keywordflow">else</span> {
<a name="l02449"></a>02449       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vmu);
<a name="l02450"></a>02450       <span class="keywordflow">return</span> NULL;
<a name="l02451"></a>02451    }
<a name="l02452"></a>02452 }
<a name="l02453"></a>02453 
<a name="l02454"></a>02454 <span class="comment">/* Interfaces to C-client */</span>
<a name="l02455"></a>02455 
<a name="l02456"></a>02456 <span class="keywordtype">void</span> mm_exists(MAILSTREAM * stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)
<a name="l02457"></a>02457 {
<a name="l02458"></a>02458    <span class="comment">/* mail_ping will callback here if new mail! */</span>
<a name="l02459"></a>02459    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Entering EXISTS callback for message %ld\n&quot;</span>, number);
<a name="l02460"></a>02460    <span class="keywordflow">if</span> (number == 0) <span class="keywordflow">return</span>;
<a name="l02461"></a>02461    set_update(stream);
<a name="l02462"></a>02462 }
<a name="l02463"></a>02463 
<a name="l02464"></a>02464 
<a name="l02465"></a>02465 <span class="keywordtype">void</span> mm_expunged(MAILSTREAM * stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)
<a name="l02466"></a>02466 {
<a name="l02467"></a>02467    <span class="comment">/* mail_ping will callback here if expunged mail! */</span>
<a name="l02468"></a>02468    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Entering EXPUNGE callback for message %ld\n&quot;</span>, number);
<a name="l02469"></a>02469    <span class="keywordflow">if</span> (number == 0) <span class="keywordflow">return</span>;
<a name="l02470"></a>02470    set_update(stream);
<a name="l02471"></a>02471 }
<a name="l02472"></a>02472 
<a name="l02473"></a>02473 
<a name="l02474"></a>02474 <span class="keywordtype">void</span> mm_flags(MAILSTREAM * stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> number)
<a name="l02475"></a>02475 {
<a name="l02476"></a>02476    <span class="comment">/* mail_ping will callback here if read mail! */</span>
<a name="l02477"></a>02477    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Entering FLAGS callback for message %ld\n&quot;</span>, number);
<a name="l02478"></a>02478    <span class="keywordflow">if</span> (number == 0) <span class="keywordflow">return</span>;
<a name="l02479"></a>02479    set_update(stream);
<a name="l02480"></a>02480 }
<a name="l02481"></a>02481 
<a name="l02482"></a>02482 
<a name="l02483"></a>02483 <span class="keywordtype">void</span> mm_notify(MAILSTREAM * stream, <span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">long</span> errflg)
<a name="l02484"></a>02484 {
<a name="l02485"></a>02485    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Entering NOTIFY callback, errflag is %ld, string is %s\n&quot;</span>, errflg, <span class="keywordtype">string</span>);
<a name="l02486"></a>02486    mm_log (<span class="keywordtype">string</span>, errflg);
<a name="l02487"></a>02487 }
<a name="l02488"></a>02488 
<a name="l02489"></a>02489 
<a name="l02490"></a>02490 <span class="keywordtype">void</span> mm_list(MAILSTREAM * stream, <span class="keywordtype">int</span> delim, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">long</span> attributes)
<a name="l02491"></a>02491 {
<a name="l02492"></a>02492    <span class="keywordflow">if</span> (delimiter == <span class="charliteral">&apos;\0&apos;</span>) {
<a name="l02493"></a>02493       delimiter = delim;
<a name="l02494"></a>02494    }
<a name="l02495"></a>02495 
<a name="l02496"></a>02496    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Delimiter set to %c and mailbox %s\n&quot;</span>,delim, mailbox);
<a name="l02497"></a>02497    <span class="keywordflow">if</span> (attributes &amp; LATT_NOINFERIORS)
<a name="l02498"></a>02498       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;no inferiors\n&quot;</span>);
<a name="l02499"></a>02499    <span class="keywordflow">if</span> (attributes &amp; LATT_NOSELECT)
<a name="l02500"></a>02500       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;no select\n&quot;</span>);
<a name="l02501"></a>02501    <span class="keywordflow">if</span> (attributes &amp; LATT_MARKED)
<a name="l02502"></a>02502       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;marked\n&quot;</span>);
<a name="l02503"></a>02503    <span class="keywordflow">if</span> (attributes &amp; LATT_UNMARKED)
<a name="l02504"></a>02504       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;unmarked\n&quot;</span>);
<a name="l02505"></a>02505 }
<a name="l02506"></a>02506 
<a name="l02507"></a>02507 
<a name="l02508"></a>02508 <span class="keywordtype">void</span> mm_lsub(MAILSTREAM * stream, <span class="keywordtype">int</span> delim, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">long</span> attributes)
<a name="l02509"></a>02509 {
<a name="l02510"></a>02510    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Delimiter set to %c and mailbox %s\n&quot;</span>,delim, mailbox);
<a name="l02511"></a>02511    <span class="keywordflow">if</span> (attributes &amp; LATT_NOINFERIORS)
<a name="l02512"></a>02512       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;no inferiors\n&quot;</span>);
<a name="l02513"></a>02513    <span class="keywordflow">if</span> (attributes &amp; LATT_NOSELECT)
<a name="l02514"></a>02514       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;no select\n&quot;</span>);
<a name="l02515"></a>02515    <span class="keywordflow">if</span> (attributes &amp; LATT_MARKED)
<a name="l02516"></a>02516       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;marked\n&quot;</span>);
<a name="l02517"></a>02517    <span class="keywordflow">if</span> (attributes &amp; LATT_UNMARKED)
<a name="l02518"></a>02518       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;unmarked\n&quot;</span>);
<a name="l02519"></a>02519 }
<a name="l02520"></a>02520 
<a name="l02521"></a>02521 
<a name="l02522"></a>02522 <span class="keywordtype">void</span> mm_status(MAILSTREAM * stream, <span class="keywordtype">char</span> *mailbox, MAILSTATUS * <a class="code" href="app__jack_8c.html#ac191e5810fa65e63095409471eb5648f">status</a>)
<a name="l02523"></a>02523 {
<a name="l02524"></a>02524    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot; Mailbox %s&quot;</span>, mailbox);
<a name="l02525"></a>02525    <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_MESSAGES)
<a name="l02526"></a>02526       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;, %lu messages&quot;</span>, status-&gt;messages);
<a name="l02527"></a>02527    <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_RECENT)
<a name="l02528"></a>02528       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;, %lu recent&quot;</span>, status-&gt;recent);
<a name="l02529"></a>02529    <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_UNSEEN)
<a name="l02530"></a>02530       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;, %lu unseen&quot;</span>, status-&gt;unseen);
<a name="l02531"></a>02531    <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_UIDVALIDITY)
<a name="l02532"></a>02532       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;, %lu UID validity&quot;</span>, status-&gt;uidvalidity);
<a name="l02533"></a>02533    <span class="keywordflow">if</span> (status-&gt;flags &amp; SA_UIDNEXT)
<a name="l02534"></a>02534       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;, %lu next UID&quot;</span>, status-&gt;uidnext);
<a name="l02535"></a>02535    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l02536"></a>02536 }
<a name="l02537"></a>02537 
<a name="l02538"></a>02538 
<a name="l02539"></a>02539 <span class="keywordtype">void</span> mm_log(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>, <span class="keywordtype">long</span> errflg)
<a name="l02540"></a>02540 {
<a name="l02541"></a>02541    <span class="keywordflow">switch</span> ((<span class="keywordtype">short</span>) errflg) {
<a name="l02542"></a>02542       <span class="keywordflow">case</span> NIL:
<a name="l02543"></a>02543          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;IMAP Info: %s\n&quot;</span>, <span class="keywordtype">string</span>);
<a name="l02544"></a>02544          <span class="keywordflow">break</span>;
<a name="l02545"></a>02545       <span class="keywordflow">case</span> PARSE:
<a name="l02546"></a>02546       <span class="keywordflow">case</span> WARN:
<a name="l02547"></a>02547          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;IMAP Warning: %s\n&quot;</span>, <span class="keywordtype">string</span>);
<a name="l02548"></a>02548          <span class="keywordflow">break</span>;
<a name="l02549"></a>02549       <span class="keywordflow">case</span> ERROR:
<a name="l02550"></a>02550          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP Error: %s\n&quot;</span>, <span class="keywordtype">string</span>);
<a name="l02551"></a>02551          <span class="keywordflow">break</span>;
<a name="l02552"></a>02552    }
<a name="l02553"></a>02553 }
<a name="l02554"></a>02554 
<a name="l02555"></a>02555 
<a name="l02556"></a>02556 <span class="keywordtype">void</span> mm_dlog(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>)
<a name="l02557"></a>02557 {
<a name="l02558"></a>02558    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;%s\n&quot;</span>, <span class="keywordtype">string</span>);
<a name="l02559"></a>02559 }
<a name="l02560"></a>02560 
<a name="l02561"></a>02561 
<a name="l02562"></a>02562 <span class="keywordtype">void</span> mm_login(NETMBX * mb, <span class="keywordtype">char</span> *user, <span class="keywordtype">char</span> *pwd, <span class="keywordtype">long</span> trial)
<a name="l02563"></a>02563 {
<a name="l02564"></a>02564    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l02565"></a>02565 
<a name="l02566"></a>02566    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(4, <span class="stringliteral">&quot;Entering callback mm_login\n&quot;</span>);
<a name="l02567"></a>02567 
<a name="l02568"></a>02568    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(user, mb-&gt;user, MAILTMPLEN);
<a name="l02569"></a>02569 
<a name="l02570"></a>02570    <span class="comment">/* We should only do this when necessary */</span>
<a name="l02571"></a>02571    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(authpassword)) {
<a name="l02572"></a>02572       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pwd, authpassword, MAILTMPLEN);
<a name="l02573"></a>02573    } <span class="keywordflow">else</span> {
<a name="l02574"></a>02574       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list) {
<a name="l02575"></a>02575          <span class="keywordflow">if</span> (!strcasecmp(mb-&gt;user, vmu-&gt;imapuser)) {
<a name="l02576"></a>02576             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pwd, vmu-&gt;imappassword, MAILTMPLEN);
<a name="l02577"></a>02577             <span class="keywordflow">break</span>;
<a name="l02578"></a>02578          }
<a name="l02579"></a>02579       }
<a name="l02580"></a>02580       <span class="keywordflow">if</span> (!vmu) {
<a name="l02581"></a>02581          <span class="keywordflow">if</span> ((vmu = find_user_realtime_imapuser(mb-&gt;user))) {
<a name="l02582"></a>02582             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pwd, vmu-&gt;imappassword, MAILTMPLEN);
<a name="l02583"></a>02583             <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l02584"></a>02584          }
<a name="l02585"></a>02585       }
<a name="l02586"></a>02586    }
<a name="l02587"></a>02587 }
<a name="l02588"></a>02588 
<a name="l02589"></a>02589 
<a name="l02590"></a>02590 <span class="keywordtype">void</span> mm_critical(MAILSTREAM * stream)
<a name="l02591"></a>02591 {
<a name="l02592"></a>02592 }
<a name="l02593"></a>02593 
<a name="l02594"></a>02594 
<a name="l02595"></a>02595 <span class="keywordtype">void</span> mm_nocritical(MAILSTREAM * stream)
<a name="l02596"></a>02596 {
<a name="l02597"></a>02597 }
<a name="l02598"></a>02598 
<a name="l02599"></a>02599 
<a name="l02600"></a>02600 <span class="keywordtype">long</span> mm_diskerror(MAILSTREAM * stream, <span class="keywordtype">long</span> errcode, <span class="keywordtype">long</span> serious)
<a name="l02601"></a>02601 {
<a name="l02602"></a>02602    kill (getpid (), SIGSTOP);
<a name="l02603"></a>02603    <span class="keywordflow">return</span> NIL;
<a name="l02604"></a>02604 }
<a name="l02605"></a>02605 
<a name="l02606"></a>02606 
<a name="l02607"></a>02607 <span class="keywordtype">void</span> mm_fatal(<span class="keywordtype">char</span> *<span class="keywordtype">string</span>)
<a name="l02608"></a>02608 {
<a name="l02609"></a>02609    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP access FATAL error: %s\n&quot;</span>, <span class="keywordtype">string</span>);
<a name="l02610"></a>02610 }
<a name="l02611"></a>02611 
<a name="l02612"></a>02612 <span class="comment">/* C-client callback to handle quota */</span>
<a name="l02613"></a>02613 <span class="keyword">static</span> <span class="keywordtype">void</span> mm_parsequota(MAILSTREAM *stream, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, QUOTALIST *pquota)
<a name="l02614"></a>02614 {
<a name="l02615"></a>02615    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l02616"></a>02616    <span class="keywordtype">char</span> *mailbox = stream-&gt;mailbox, *user;
<a name="l02617"></a>02617    <span class="keywordtype">char</span> buf[1024] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02618"></a>02618    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> usage = 0, limit = 0;
<a name="l02619"></a>02619    
<a name="l02620"></a>02620    <span class="keywordflow">while</span> (pquota) {
<a name="l02621"></a>02621       usage = pquota-&gt;usage;
<a name="l02622"></a>02622       limit = pquota-&gt;limit;
<a name="l02623"></a>02623       pquota = pquota-&gt;next;
<a name="l02624"></a>02624    }
<a name="l02625"></a>02625    
<a name="l02626"></a>02626    <span class="keywordflow">if</span> (!(user = get_user_by_mailbox(mailbox, buf, <span class="keyword">sizeof</span>(buf))) || (!(vms = get_vm_state_by_imapuser(user, 2)) &amp;&amp; !(vms = get_vm_state_by_imapuser(user, 0)))) {
<a name="l02627"></a>02627       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;No state found.\n&quot;</span>);
<a name="l02628"></a>02628       <span class="keywordflow">return</span>;
<a name="l02629"></a>02629    }
<a name="l02630"></a>02630 
<a name="l02631"></a>02631    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;User %s usage is %lu, limit is %lu\n&quot;</span>, user, usage, limit);
<a name="l02632"></a>02632 
<a name="l02633"></a>02633    vms-&gt;quota_usage = usage;
<a name="l02634"></a>02634    vms-&gt;quota_limit = limit;
<a name="l02635"></a>02635 }
<a name="l02636"></a>02636 
<a name="l02637"></a>02637 <span class="keyword">static</span> <span class="keywordtype">char</span> *get_header_by_tag(<span class="keywordtype">char</span> *header, <span class="keywordtype">char</span> *tag, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len)
<a name="l02638"></a>02638 {
<a name="l02639"></a>02639    <span class="keywordtype">char</span> *start, *eol_pnt;
<a name="l02640"></a>02640    <span class="keywordtype">int</span> taglen;
<a name="l02641"></a>02641 
<a name="l02642"></a>02642    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(header) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tag))
<a name="l02643"></a>02643       <span class="keywordflow">return</span> NULL;
<a name="l02644"></a>02644 
<a name="l02645"></a>02645    taglen = strlen(tag) + 1;
<a name="l02646"></a>02646    <span class="keywordflow">if</span> (taglen &lt; 1)
<a name="l02647"></a>02647       <span class="keywordflow">return</span> NULL;
<a name="l02648"></a>02648 
<a name="l02649"></a>02649    <span class="keywordflow">if</span> (!(start = strstr(header, tag)))
<a name="l02650"></a>02650       <span class="keywordflow">return</span> NULL;
<a name="l02651"></a>02651 
<a name="l02652"></a>02652    <span class="comment">/* Since we can be called multiple times we should clear our buffer */</span>
<a name="l02653"></a>02653    memset(buf, 0, len);
<a name="l02654"></a>02654 
<a name="l02655"></a>02655    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, start+taglen, len);
<a name="l02656"></a>02656    <span class="keywordflow">if</span> ((eol_pnt = strchr(buf,<span class="charliteral">&apos;\r&apos;</span>)) || (eol_pnt = strchr(buf,<span class="charliteral">&apos;\n&apos;</span>)))
<a name="l02657"></a>02657       *eol_pnt = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02658"></a>02658    <span class="keywordflow">return</span> buf;
<a name="l02659"></a>02659 }
<a name="l02660"></a>02660 
<a name="l02661"></a>02661 <span class="keyword">static</span> <span class="keywordtype">char</span> *get_user_by_mailbox(<span class="keywordtype">char</span> *mailbox, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len)
<a name="l02662"></a>02662 {
<a name="l02663"></a>02663    <span class="keywordtype">char</span> *start, *<a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a>, *eol_pnt;
<a name="l02664"></a>02664 
<a name="l02665"></a>02665    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox))
<a name="l02666"></a>02666       <span class="keywordflow">return</span> NULL;
<a name="l02667"></a>02667 
<a name="l02668"></a>02668    <span class="keywordflow">if</span> (!(start = strstr(mailbox, <span class="stringliteral">&quot;/user=&quot;</span>)))
<a name="l02669"></a>02669       <span class="keywordflow">return</span> NULL;
<a name="l02670"></a>02670 
<a name="l02671"></a>02671    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, start+6, len);
<a name="l02672"></a>02672 
<a name="l02673"></a>02673    <span class="keywordflow">if</span> (!(quote = strchr(buf, <span class="charliteral">&apos;\&quot;&apos;</span>))) {
<a name="l02674"></a>02674       <span class="keywordflow">if</span> (!(eol_pnt = strchr(buf, <span class="charliteral">&apos;/&apos;</span>)))
<a name="l02675"></a>02675          eol_pnt = strchr(buf,<span class="charliteral">&apos;}&apos;</span>);
<a name="l02676"></a>02676       *eol_pnt = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02677"></a>02677       <span class="keywordflow">return</span> buf;
<a name="l02678"></a>02678    } <span class="keywordflow">else</span> {
<a name="l02679"></a>02679       eol_pnt = strchr(buf+1,<span class="charliteral">&apos;\&quot;&apos;</span>);
<a name="l02680"></a>02680       *eol_pnt = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02681"></a>02681       <span class="keywordflow">return</span> buf+1;
<a name="l02682"></a>02682    }
<a name="l02683"></a>02683 }
<a name="l02684"></a>02684 
<a name="l02685"></a>02685 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *create_vm_state_from_user(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l02686"></a>02686 {
<a name="l02687"></a>02687    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms_p;
<a name="l02688"></a>02688 
<a name="l02689"></a>02689    pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<a name="l02690"></a>02690    <span class="keywordflow">if</span> ((vms_p = pthread_getspecific(ts_vmstate.key)) &amp;&amp; !strcmp(vms_p-&gt;imapuser, vmu-&gt;imapuser) &amp;&amp; !strcmp(vms_p-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)) {
<a name="l02691"></a>02691       <span class="keywordflow">return</span> vms_p;
<a name="l02692"></a>02692    }
<a name="l02693"></a>02693    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 4)
<a name="l02694"></a>02694       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a739c2b2152120f3ac341424b9a595562">AST_LOG_DEBUG</a>,<span class="stringliteral">&quot;Adding new vmstate for %s\n&quot;</span>,vmu-&gt;imapuser);
<a name="l02695"></a>02695    <span class="keywordflow">if</span> (!(vms_p = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*vms_p))))
<a name="l02696"></a>02696       <span class="keywordflow">return</span> NULL;
<a name="l02697"></a>02697    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms_p-&gt;imapuser, vmu-&gt;imapuser, <span class="keyword">sizeof</span>(vms_p-&gt;imapuser));
<a name="l02698"></a>02698    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms_p-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>)); <span class="comment">/* save for access from interactive entry point */</span>
<a name="l02699"></a>02699    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms_p-&gt;<a class="code" href="structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>));
<a name="l02700"></a>02700    vms_p-&gt;mailstream = NIL; <span class="comment">/* save for access from interactive entry point */</span>
<a name="l02701"></a>02701    vms_p-&gt;imapversion = vmu-&gt;imapversion;
<a name="l02702"></a>02702    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 4)
<a name="l02703"></a>02703       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a739c2b2152120f3ac341424b9a595562">AST_LOG_DEBUG</a>,<span class="stringliteral">&quot;Copied %s to %s\n&quot;</span>,vmu-&gt;imapuser,vms_p-&gt;imapuser);
<a name="l02704"></a>02704    vms_p-&gt;updated = 1;
<a name="l02705"></a>02705    <span class="comment">/* set mailbox to INBOX! */</span>
<a name="l02706"></a>02706    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms_p-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(0), <span class="keyword">sizeof</span>(vms_p-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));
<a name="l02707"></a>02707    init_vm_state(vms_p);
<a name="l02708"></a>02708    vmstate_insert(vms_p);
<a name="l02709"></a>02709    <span class="keywordflow">return</span> vms_p;
<a name="l02710"></a>02710 }
<a name="l02711"></a>02711 
<a name="l02712"></a>02712 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *get_vm_state_by_imapuser(<span class="keyword">const</span> <span class="keywordtype">char</span> *user, <span class="keywordtype">int</span> interactive)
<a name="l02713"></a>02713 {
<a name="l02714"></a>02714    <span class="keyword">struct </span>vmstate *vlist = NULL;
<a name="l02715"></a>02715 
<a name="l02716"></a>02716    <span class="keywordflow">if</span> (interactive) {
<a name="l02717"></a>02717       <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l02718"></a>02718       pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<a name="l02719"></a>02719       vms = pthread_getspecific(ts_vmstate.key);
<a name="l02720"></a>02720       <span class="keywordflow">return</span> vms;
<a name="l02721"></a>02721    }
<a name="l02722"></a>02722 
<a name="l02723"></a>02723    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;vmstates);
<a name="l02724"></a>02724    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;vmstates, vlist, list) {
<a name="l02725"></a>02725       <span class="keywordflow">if</span> (!vlist-&gt;vms) {
<a name="l02726"></a>02726          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;error: vms is NULL for %s\n&quot;</span>, user);
<a name="l02727"></a>02727          <span class="keywordflow">continue</span>;
<a name="l02728"></a>02728       }
<a name="l02729"></a>02729       <span class="keywordflow">if</span> (vlist-&gt;vms-&gt;imapversion != imapversion) {
<a name="l02730"></a>02730          <span class="keywordflow">continue</span>;
<a name="l02731"></a>02731       }
<a name="l02732"></a>02732       <span class="keywordflow">if</span> (!vlist-&gt;vms-&gt;imapuser) {
<a name="l02733"></a>02733          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;error: imapuser is NULL for %s\n&quot;</span>, user);
<a name="l02734"></a>02734          <span class="keywordflow">continue</span>;
<a name="l02735"></a>02735       }
<a name="l02736"></a>02736 
<a name="l02737"></a>02737       <span class="keywordflow">if</span> (!strcmp(vlist-&gt;vms-&gt;imapuser, user) &amp;&amp; (interactive == 2 || vlist-&gt;vms-&gt;interactive == interactive)) {
<a name="l02738"></a>02738          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;vmstates);
<a name="l02739"></a>02739          <span class="keywordflow">return</span> vlist-&gt;vms;
<a name="l02740"></a>02740       }
<a name="l02741"></a>02741    }
<a name="l02742"></a>02742    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;vmstates);
<a name="l02743"></a>02743 
<a name="l02744"></a>02744    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;%s not found in vmstates\n&quot;</span>, user);
<a name="l02745"></a>02745 
<a name="l02746"></a>02746    <span class="keywordflow">return</span> NULL;
<a name="l02747"></a>02747 }
<a name="l02748"></a>02748 
<a name="l02749"></a>02749 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *get_vm_state_by_mailbox(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keywordtype">int</span> interactive)
<a name="l02750"></a>02750 {
<a name="l02751"></a>02751 
<a name="l02752"></a>02752    <span class="keyword">struct </span>vmstate *vlist = NULL;
<a name="l02753"></a>02753    <span class="keyword">const</span> <span class="keywordtype">char</span> *local_context = <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;default&quot;</span>);
<a name="l02754"></a>02754 
<a name="l02755"></a>02755    <span class="keywordflow">if</span> (interactive) {
<a name="l02756"></a>02756       <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l02757"></a>02757       pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<a name="l02758"></a>02758       vms = pthread_getspecific(ts_vmstate.key);
<a name="l02759"></a>02759       <span class="keywordflow">return</span> vms;
<a name="l02760"></a>02760    }
<a name="l02761"></a>02761 
<a name="l02762"></a>02762    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;vmstates);
<a name="l02763"></a>02763    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;vmstates, vlist, list) {
<a name="l02764"></a>02764       <span class="keywordflow">if</span> (!vlist-&gt;vms) {
<a name="l02765"></a>02765          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;error: vms is NULL for %s\n&quot;</span>, mailbox);
<a name="l02766"></a>02766          <span class="keywordflow">continue</span>;
<a name="l02767"></a>02767       }
<a name="l02768"></a>02768       <span class="keywordflow">if</span> (vlist-&gt;vms-&gt;imapversion != imapversion) {
<a name="l02769"></a>02769          <span class="keywordflow">continue</span>;
<a name="l02770"></a>02770       }
<a name="l02771"></a>02771       <span class="keywordflow">if</span> (!vlist-&gt;vms-&gt;username || !vlist-&gt;vms-&gt;context) {
<a name="l02772"></a>02772          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;error: username is NULL for %s\n&quot;</span>, mailbox);
<a name="l02773"></a>02773          <span class="keywordflow">continue</span>;
<a name="l02774"></a>02774       }
<a name="l02775"></a>02775 
<a name="l02776"></a>02776       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;comparing mailbox %s@%s (i=%d) to vmstate mailbox %s@%s (i=%d)\n&quot;</span>, mailbox, local_context, interactive, vlist-&gt;vms-&gt;username, vlist-&gt;vms-&gt;context, vlist-&gt;vms-&gt;interactive);
<a name="l02777"></a>02777       
<a name="l02778"></a>02778       <span class="keywordflow">if</span> (!strcmp(vlist-&gt;vms-&gt;username,mailbox) &amp;&amp; !strcmp(vlist-&gt;vms-&gt;context, local_context) &amp;&amp; vlist-&gt;vms-&gt;interactive == interactive) {
<a name="l02779"></a>02779          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Found it!\n&quot;</span>);
<a name="l02780"></a>02780          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;vmstates);
<a name="l02781"></a>02781          <span class="keywordflow">return</span> vlist-&gt;vms;
<a name="l02782"></a>02782       }
<a name="l02783"></a>02783    }
<a name="l02784"></a>02784    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;vmstates);
<a name="l02785"></a>02785 
<a name="l02786"></a>02786    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;%s not found in vmstates\n&quot;</span>, mailbox);
<a name="l02787"></a>02787 
<a name="l02788"></a>02788    <span class="keywordflow">return</span> NULL;
<a name="l02789"></a>02789 }
<a name="l02790"></a>02790 
<a name="l02791"></a>02791 <span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_insert(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms) 
<a name="l02792"></a>02792 {
<a name="l02793"></a>02793    <span class="keyword">struct </span>vmstate *v;
<a name="l02794"></a>02794    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *altvms;
<a name="l02795"></a>02795 
<a name="l02796"></a>02796    <span class="comment">/* If interactive, it probably already exists, and we should</span>
<a name="l02797"></a>02797 <span class="comment">      use the one we already have since it is more up to date.</span>
<a name="l02798"></a>02798 <span class="comment">      We can compare the username to find the duplicate */</span>
<a name="l02799"></a>02799    <span class="keywordflow">if</span> (vms-&gt;interactive == 1) {
<a name="l02800"></a>02800       altvms = get_vm_state_by_mailbox(vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vms-&gt;<a class="code" href="structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, 0);
<a name="l02801"></a>02801       <span class="keywordflow">if</span> (altvms) {  
<a name="l02802"></a>02802          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Duplicate mailbox %s, copying message info...\n&quot;</span>,vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l02803"></a>02803          vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = altvms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;
<a name="l02804"></a>02804          vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = altvms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;
<a name="l02805"></a>02805          vms-&gt;vmArrayIndex = altvms-&gt;vmArrayIndex;
<a name="l02806"></a>02806          vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = altvms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;
<a name="l02807"></a>02807          vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = altvms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;
<a name="l02808"></a>02808          <span class="comment">/* get a pointer to the persistent store */</span>
<a name="l02809"></a>02809          vms-&gt;persist_vms = altvms;
<a name="l02810"></a>02810          <span class="comment">/* Reuse the mailstream? */</span>
<a name="l02811"></a>02811 <span class="preprocessor">#ifdef REALLY_FAST_EVEN_IF_IT_MEANS_RESOURCE_LEAKS</span>
<a name="l02812"></a>02812 <span class="preprocessor"></span>         vms-&gt;mailstream = altvms-&gt;mailstream;
<a name="l02813"></a>02813 <span class="preprocessor">#else</span>
<a name="l02814"></a>02814 <span class="preprocessor"></span>         vms-&gt;mailstream = NIL;
<a name="l02815"></a>02815 <span class="preprocessor">#endif</span>
<a name="l02816"></a>02816 <span class="preprocessor"></span>      }
<a name="l02817"></a>02817       <span class="keywordflow">return</span>;
<a name="l02818"></a>02818    }
<a name="l02819"></a>02819 
<a name="l02820"></a>02820    <span class="keywordflow">if</span> (!(v = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*v))))
<a name="l02821"></a>02821       <span class="keywordflow">return</span>;
<a name="l02822"></a>02822    
<a name="l02823"></a>02823    v-&gt;vms = vms;
<a name="l02824"></a>02824 
<a name="l02825"></a>02825    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Inserting vm_state for user:%s, mailbox %s\n&quot;</span>,vms-&gt;imapuser,vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l02826"></a>02826 
<a name="l02827"></a>02827    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;vmstates);
<a name="l02828"></a>02828    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;vmstates, v, list);
<a name="l02829"></a>02829    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;vmstates);
<a name="l02830"></a>02830 }
<a name="l02831"></a>02831 
<a name="l02832"></a>02832 <span class="keyword">static</span> <span class="keywordtype">void</span> vmstate_delete(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms) 
<a name="l02833"></a>02833 {
<a name="l02834"></a>02834    <span class="keyword">struct </span>vmstate *vc = NULL;
<a name="l02835"></a>02835    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *altvms = NULL;
<a name="l02836"></a>02836 
<a name="l02837"></a>02837    <span class="comment">/* If interactive, we should copy pertinent info</span>
<a name="l02838"></a>02838 <span class="comment">      back to the persistent state (to make update immediate) */</span>
<a name="l02839"></a>02839    <span class="keywordflow">if</span> (vms-&gt;interactive == 1 &amp;&amp; (altvms = vms-&gt;persist_vms)) {
<a name="l02840"></a>02840       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Duplicate mailbox %s, copying message info...\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l02841"></a>02841       altvms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;
<a name="l02842"></a>02842       altvms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;
<a name="l02843"></a>02843       altvms-&gt;updated = 1;
<a name="l02844"></a>02844       vms-&gt;mailstream = mail_close(vms-&gt;mailstream);
<a name="l02845"></a>02845 
<a name="l02846"></a>02846       <span class="comment">/* Interactive states are not stored within the persistent list */</span>
<a name="l02847"></a>02847       <span class="keywordflow">return</span>;
<a name="l02848"></a>02848    }
<a name="l02849"></a>02849    
<a name="l02850"></a>02850    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Removing vm_state for user:%s, mailbox %s\n&quot;</span>, vms-&gt;imapuser, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l02851"></a>02851    
<a name="l02852"></a>02852    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;vmstates);
<a name="l02853"></a>02853    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;vmstates, vc, list) {
<a name="l02854"></a>02854       <span class="keywordflow">if</span> (vc-&gt;vms == vms) {
<a name="l02855"></a>02855          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l02856"></a>02856          <span class="keywordflow">break</span>;
<a name="l02857"></a>02857       }
<a name="l02858"></a>02858    }
<a name="l02859"></a>02859    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l02860"></a>02860    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;vmstates);
<a name="l02861"></a>02861    
<a name="l02862"></a>02862    <span class="keywordflow">if</span> (vc) {
<a name="l02863"></a>02863       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;vc-&gt;vms-&gt;lock);
<a name="l02864"></a>02864       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vc);
<a name="l02865"></a>02865    }
<a name="l02866"></a>02866    <span class="keywordflow">else</span>
<a name="l02867"></a>02867       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;No vmstate found for user:%s, mailbox %s\n&quot;</span>, vms-&gt;imapuser, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l02868"></a>02868 }
<a name="l02869"></a>02869 
<a name="l02870"></a>02870 <span class="keyword">static</span> <span class="keywordtype">void</span> set_update(MAILSTREAM * stream) 
<a name="l02871"></a>02871 {
<a name="l02872"></a>02872    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms;
<a name="l02873"></a>02873    <span class="keywordtype">char</span> *mailbox = stream-&gt;mailbox, *user;
<a name="l02874"></a>02874    <span class="keywordtype">char</span> buf[1024] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02875"></a>02875 
<a name="l02876"></a>02876    <span class="keywordflow">if</span> (!(user = get_user_by_mailbox(mailbox, buf, <span class="keyword">sizeof</span>(buf))) || !(vms = get_vm_state_by_imapuser(user, 0))) {
<a name="l02877"></a>02877       <span class="keywordflow">if</span> (user &amp;&amp; <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l02878"></a>02878          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;User %s mailbox not found for update.\n&quot;</span>, user);
<a name="l02879"></a>02879       <span class="keywordflow">return</span>;
<a name="l02880"></a>02880    }
<a name="l02881"></a>02881 
<a name="l02882"></a>02882    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;User %s mailbox set for update.\n&quot;</span>, user);
<a name="l02883"></a>02883 
<a name="l02884"></a>02884    vms-&gt;updated = 1; <span class="comment">/* Set updated flag since mailbox changed */</span>
<a name="l02885"></a>02885 }
<a name="l02886"></a>02886 
<a name="l02887"></a>02887 <span class="keyword">static</span> <span class="keywordtype">void</span> init_vm_state(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms) 
<a name="l02888"></a>02888 {
<a name="l02889"></a>02889    <span class="keywordtype">int</span> x;
<a name="l02890"></a>02890    vms-&gt;vmArrayIndex = 0;
<a name="l02891"></a>02891    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="app__voicemail_8c.html#a120b9c8ba5c2f37645d9d3683655e9f9">VMSTATE_MAX_MSG_ARRAY</a>; x++) {
<a name="l02892"></a>02892       vms-&gt;msgArray[x] = 0;
<a name="l02893"></a>02893    }
<a name="l02894"></a>02894    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;vms-&gt;lock);
<a name="l02895"></a>02895 }
<a name="l02896"></a>02896 
<a name="l02897"></a>02897 <span class="keyword">static</span> <span class="keywordtype">int</span> save_body(BODY *body, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *section, <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">int</span> is_intro) 
<a name="l02898"></a>02898 {
<a name="l02899"></a>02899    <span class="keywordtype">char</span> *body_content;
<a name="l02900"></a>02900    <span class="keywordtype">char</span> *body_decoded;
<a name="l02901"></a>02901    <span class="keywordtype">char</span> *fn = is_intro ? vms-&gt;introfn : vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>;
<a name="l02902"></a>02902    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> len;
<a name="l02903"></a>02903    <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> newlen;
<a name="l02904"></a>02904    <span class="keywordtype">char</span> filename[256];
<a name="l02905"></a>02905    
<a name="l02906"></a>02906    <span class="keywordflow">if</span> (!body || body == NIL)
<a name="l02907"></a>02907       <span class="keywordflow">return</span> -1;
<a name="l02908"></a>02908 
<a name="l02909"></a>02909    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l02910"></a>02910    body_content = mail_fetchbody(vms-&gt;mailstream, vms-&gt;msgArray[vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>], section, &amp;len);
<a name="l02911"></a>02911    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l02912"></a>02912    <span class="keywordflow">if</span> (body_content != NIL) {
<a name="l02913"></a>02913       snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.%s&quot;</span>, fn, format);
<a name="l02914"></a>02914       <span class="comment">/* ast_debug(1,body_content); */</span>
<a name="l02915"></a>02915       body_decoded = rfc822_base64((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)body_content, len, &amp;newlen);
<a name="l02916"></a>02916       <span class="comment">/* If the body of the file is empty, return an error */</span>
<a name="l02917"></a>02917       <span class="keywordflow">if</span> (!newlen) {
<a name="l02918"></a>02918          <span class="keywordflow">return</span> -1;
<a name="l02919"></a>02919       }
<a name="l02920"></a>02920       write_file(filename, (<span class="keywordtype">char</span> *) body_decoded, newlen);
<a name="l02921"></a>02921    } <span class="keywordflow">else</span> {
<a name="l02922"></a>02922       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Body of message is NULL.\n&quot;</span>);
<a name="l02923"></a>02923       <span class="keywordflow">return</span> -1;
<a name="l02924"></a>02924    }
<a name="l02925"></a>02925    <span class="keywordflow">return</span> 0;
<a name="l02926"></a>02926 }
<a name="l02927"></a>02927 <span class="comment"></span>
<a name="l02928"></a>02928 <span class="comment">/*! </span>
<a name="l02929"></a>02929 <span class="comment"> * \brief Get delimiter via mm_list callback </span>
<a name="l02930"></a>02930 <span class="comment"> * \param stream</span>
<a name="l02931"></a>02931 <span class="comment"> *</span>
<a name="l02932"></a>02932 <span class="comment"> * Determines the delimiter character that is used by the underlying IMAP based mail store.</span>
<a name="l02933"></a>02933 <span class="comment"> */</span>
<a name="l02934"></a>02934 <span class="comment">/* MUTEX should already be held */</span>
<a name="l02935"></a>02935 <span class="keyword">static</span> <span class="keywordtype">void</span> get_mailbox_delimiter(MAILSTREAM *stream) {
<a name="l02936"></a>02936    <span class="keywordtype">char</span> tmp[50];
<a name="l02937"></a>02937    snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;{%s}&quot;</span>, imapserver);
<a name="l02938"></a>02938    mail_list(stream, tmp, <span class="stringliteral">&quot;*&quot;</span>);
<a name="l02939"></a>02939 }
<a name="l02940"></a>02940 <span class="comment"></span>
<a name="l02941"></a>02941 <span class="comment">/*! </span>
<a name="l02942"></a>02942 <span class="comment"> * \brief Check Quota for user </span>
<a name="l02943"></a>02943 <span class="comment"> * \param vms a pointer to a vm_state struct, will use the mailstream property of this.</span>
<a name="l02944"></a>02944 <span class="comment"> * \param mailbox the mailbox to check the quota for.</span>
<a name="l02945"></a>02945 <span class="comment"> *</span>
<a name="l02946"></a>02946 <span class="comment"> * Calls imap_getquotaroot, which will populate its results into the vm_state vms input structure.</span>
<a name="l02947"></a>02947 <span class="comment"> */</span>
<a name="l02948"></a>02948 <span class="keyword">static</span> <span class="keywordtype">void</span> check_quota(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *mailbox) {
<a name="l02949"></a>02949    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l02950"></a>02950    mail_parameters(NULL, SET_QUOTA, (<span class="keywordtype">void</span> *) mm_parsequota);
<a name="l02951"></a>02951    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Mailbox name set to: %s, about to check quotas\n&quot;</span>, mailbox);
<a name="l02952"></a>02952    <span class="keywordflow">if</span> (vms &amp;&amp; vms-&gt;mailstream != NULL) {
<a name="l02953"></a>02953       imap_getquotaroot(vms-&gt;mailstream, mailbox);
<a name="l02954"></a>02954    } <span class="keywordflow">else</span> {
<a name="l02955"></a>02955       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Mailstream not available for mailbox: %s\n&quot;</span>, mailbox);
<a name="l02956"></a>02956    }
<a name="l02957"></a>02957    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l02958"></a>02958 }
<a name="l02959"></a>02959 
<a name="l02960"></a>02960 <span class="preprocessor">#endif </span><span class="comment">/* IMAP_STORAGE */</span>
<a name="l02961"></a>02961 <span class="comment"></span>
<a name="l02962"></a>02962 <span class="comment">/*! \brief Lock file path</span>
<a name="l02963"></a>02963 <span class="comment">    only return failure if ast_lock_path returns &apos;timeout&apos;,</span>
<a name="l02964"></a>02964 <span class="comment">   not if the path does not exist or any other reason</span>
<a name="l02965"></a>02965 <span class="comment">*/</span>
<a name="l02966"></a><a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1">02966</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *path)
<a name="l02967"></a>02967 {
<a name="l02968"></a>02968    <span class="keywordflow">switch</span> (<a class="code" href="app_8h.html#a74c57b5a842dcbc15cc991a31f679a13" title="Lock a filesystem path.">ast_lock_path</a>(path)) {
<a name="l02969"></a>02969    <span class="keywordflow">case</span> <a class="code" href="app_8h.html#a382bf96f47f0b7fa86ae5ed0644b3f8ca9c0f41302de02bb0130a92669d17333d">AST_LOCK_TIMEOUT</a>:
<a name="l02970"></a>02970       <span class="keywordflow">return</span> -1;
<a name="l02971"></a>02971    <span class="keywordflow">default</span>:
<a name="l02972"></a>02972       <span class="keywordflow">return</span> 0;
<a name="l02973"></a>02973    }
<a name="l02974"></a>02974 }
<a name="l02975"></a>02975 
<a name="l02976"></a>02976 
<a name="l02977"></a>02977 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l02978"></a>02978 <span class="preprocessor"></span><span class="keyword">struct </span>generic_prepare_struct {
<a name="l02979"></a>02979    <span class="keywordtype">char</span> *sql;
<a name="l02980"></a>02980    <span class="keywordtype">int</span> argc;
<a name="l02981"></a>02981    <span class="keywordtype">char</span> **argv;
<a name="l02982"></a>02982 };
<a name="l02983"></a>02983 
<a name="l02984"></a>02984 <span class="keyword">static</span> SQLHSTMT <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>(<span class="keyword">struct</span> <a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj, <span class="keywordtype">void</span> *data)
<a name="l02985"></a>02985 {
<a name="l02986"></a>02986    <span class="keyword">struct </span>generic_prepare_struct *gps = data;
<a name="l02987"></a>02987    <span class="keywordtype">int</span> res, i;
<a name="l02988"></a>02988    SQLHSTMT stmt;
<a name="l02989"></a>02989 
<a name="l02990"></a>02990    res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;<a class="code" href="structodbc__obj.html#ae83918cc26dc7acd65bbec1712593054">con</a>, &amp;stmt);
<a name="l02991"></a>02991    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l02992"></a>02992       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Alloc Handle failed!\n&quot;</span>);
<a name="l02993"></a>02993       <span class="keywordflow">return</span> NULL;
<a name="l02994"></a>02994    }
<a name="l02995"></a>02995    res = SQLPrepare(stmt, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)gps-&gt;sql, SQL_NTS);
<a name="l02996"></a>02996    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l02997"></a>02997       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Prepare failed![%s]\n&quot;</span>, gps-&gt;sql);
<a name="l02998"></a>02998       SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l02999"></a>02999       <span class="keywordflow">return</span> NULL;
<a name="l03000"></a>03000    }
<a name="l03001"></a>03001    <span class="keywordflow">for</span> (i = 0; i &lt; gps-&gt;argc; i++)
<a name="l03002"></a>03002       SQLBindParameter(stmt, i + 1, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(gps-&gt;argv[i]), 0, gps-&gt;argv[i], 0, NULL);
<a name="l03003"></a>03003 
<a name="l03004"></a>03004    <span class="keywordflow">return</span> stmt;
<a name="l03005"></a>03005 }
<a name="l03006"></a>03006 <span class="comment"></span>
<a name="l03007"></a>03007 <span class="comment">/*!</span>
<a name="l03008"></a>03008 <span class="comment"> * \brief Retrieves a file from an ODBC data store.</span>
<a name="l03009"></a>03009 <span class="comment"> * \param dir the path to the file to be retreived.</span>
<a name="l03010"></a>03010 <span class="comment"> * \param msgnum the message number, such as within a mailbox folder.</span>
<a name="l03011"></a>03011 <span class="comment"> * </span>
<a name="l03012"></a>03012 <span class="comment"> * This method is used by the RETRIEVE macro when mailboxes are stored in an ODBC back end.</span>
<a name="l03013"></a>03013 <span class="comment"> * The purpose is to get the message from the database store to the local file system, so that the message may be played, or the information file may be read.</span>
<a name="l03014"></a>03014 <span class="comment"> *</span>
<a name="l03015"></a>03015 <span class="comment"> * The file is looked up by invoking a SQL on the odbc_table (default &apos;voicemessages&apos;) using the dir and msgnum input parameters.</span>
<a name="l03016"></a>03016 <span class="comment"> * The output is the message information file with the name msgnum and the extension .txt</span>
<a name="l03017"></a>03017 <span class="comment"> * and the message file with the extension of its format, in the directory with base file name of the msgnum.</span>
<a name="l03018"></a>03018 <span class="comment"> * </span>
<a name="l03019"></a>03019 <span class="comment"> * \return 0 on success, -1 on error.</span>
<a name="l03020"></a>03020 <span class="comment"> */</span>
<a name="l03021"></a>03021 <span class="keyword">static</span> <span class="keywordtype">int</span> retrieve_file(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)
<a name="l03022"></a>03022 {
<a name="l03023"></a>03023    <span class="keywordtype">int</span> x = 0;
<a name="l03024"></a>03024    <span class="keywordtype">int</span> res;
<a name="l03025"></a>03025    <span class="keywordtype">int</span> fd=-1;
<a name="l03026"></a>03026    <span class="keywordtype">size_t</span> fdlen = 0;
<a name="l03027"></a>03027    <span class="keywordtype">void</span> *fdm = MAP_FAILED;
<a name="l03028"></a>03028    SQLSMALLINT colcount=0;
<a name="l03029"></a>03029    SQLHSTMT stmt;
<a name="l03030"></a>03030    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l03031"></a>03031    <span class="keywordtype">char</span> fmt[80]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03032"></a>03032    <span class="keywordtype">char</span> *c;
<a name="l03033"></a>03033    <span class="keywordtype">char</span> coltitle[256];
<a name="l03034"></a>03034    SQLSMALLINT collen;
<a name="l03035"></a>03035    SQLSMALLINT datatype;
<a name="l03036"></a>03036    SQLSMALLINT decimaldigits;
<a name="l03037"></a>03037    SQLSMALLINT nullable;
<a name="l03038"></a>03038    SQLULEN colsize;
<a name="l03039"></a>03039    SQLLEN colsize2;
<a name="l03040"></a>03040    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>=NULL;
<a name="l03041"></a>03041    <span class="keywordtype">char</span> rowdata[80];
<a name="l03042"></a>03042    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l03043"></a>03043    <span class="keywordtype">char</span> full_fn[PATH_MAX];
<a name="l03044"></a>03044    <span class="keywordtype">char</span> msgnums[80];
<a name="l03045"></a>03045    <span class="keywordtype">char</span> *argv[] = { dir, msgnums };
<a name="l03046"></a>03046    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };
<a name="l03047"></a>03047 
<a name="l03048"></a>03048    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03049"></a>03049    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l03050"></a>03050    <span class="keywordflow">if</span> (obj) {
<a name="l03051"></a>03051       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fmt, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, <span class="keyword">sizeof</span>(fmt));
<a name="l03052"></a>03052       c = strchr(fmt, <span class="charliteral">&apos;|&apos;</span>);
<a name="l03053"></a>03053       <span class="keywordflow">if</span> (c)
<a name="l03054"></a>03054          *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03055"></a>03055       <span class="keywordflow">if</span> (!strcasecmp(fmt, <span class="stringliteral">&quot;wav49&quot;</span>))
<a name="l03056"></a>03056          strcpy(fmt, <span class="stringliteral">&quot;WAV&quot;</span>);
<a name="l03057"></a>03057       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums),<span class="stringliteral">&quot;%d&quot;</span>, msgnum);
<a name="l03058"></a>03058       <span class="keywordflow">if</span> (msgnum &gt; -1)
<a name="l03059"></a>03059          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);
<a name="l03060"></a>03060       <span class="keywordflow">else</span>
<a name="l03061"></a>03061          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));
<a name="l03062"></a>03062 
<a name="l03063"></a>03063       <span class="comment">/* Create the information file */</span>
<a name="l03064"></a>03064       snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);
<a name="l03065"></a>03065       
<a name="l03066"></a>03066       <span class="keywordflow">if</span> (!(f = fopen(full_fn, <span class="stringliteral">&quot;w+&quot;</span>))) {
<a name="l03067"></a>03067          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open/create &apos;%s&apos;\n&quot;</span>, full_fn);
<a name="l03068"></a>03068          <span class="keywordflow">goto</span> yuck;
<a name="l03069"></a>03069       }
<a name="l03070"></a>03070       
<a name="l03071"></a>03071       snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.%s&quot;</span>, fn, fmt);
<a name="l03072"></a>03072       snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT * FROM %s WHERE dir=? AND msgnum=?&quot;</span>,odbc_table);
<a name="l03073"></a>03073       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l03074"></a>03074       <span class="keywordflow">if</span> (!stmt) {
<a name="l03075"></a>03075          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03076"></a>03076          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03077"></a>03077          <span class="keywordflow">goto</span> yuck;
<a name="l03078"></a>03078       }
<a name="l03079"></a>03079       res = SQLFetch(stmt);
<a name="l03080"></a>03080       <span class="keywordflow">if</span> (res == SQL_NO_DATA) {
<a name="l03081"></a>03081          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03082"></a>03082          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03083"></a>03083          <span class="keywordflow">goto</span> yuck;
<a name="l03084"></a>03084       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03085"></a>03085          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03086"></a>03086          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03087"></a>03087          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03088"></a>03088          <span class="keywordflow">goto</span> yuck;
<a name="l03089"></a>03089       }
<a name="l03090"></a>03090       fd = open(full_fn, O_RDWR | O_CREAT | O_TRUNC, <a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>);
<a name="l03091"></a>03091       <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l03092"></a>03092          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write &apos;%s&apos;: %s\n&quot;</span>, full_fn, strerror(errno));
<a name="l03093"></a>03093          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03094"></a>03094          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03095"></a>03095          <span class="keywordflow">goto</span> yuck;
<a name="l03096"></a>03096       }
<a name="l03097"></a>03097       res = SQLNumResultCols(stmt, &amp;colcount);
<a name="l03098"></a>03098       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {  
<a name="l03099"></a>03099          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Column Count error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03100"></a>03100          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03101"></a>03101          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03102"></a>03102          <span class="keywordflow">goto</span> yuck;
<a name="l03103"></a>03103       }
<a name="l03104"></a>03104       <span class="keywordflow">if</span> (f) 
<a name="l03105"></a>03105          fprintf(f, <span class="stringliteral">&quot;[message]\n&quot;</span>);
<a name="l03106"></a>03106       <span class="keywordflow">for</span> (x=0;x&lt;colcount;x++) {
<a name="l03107"></a>03107          rowdata[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03108"></a>03108          collen = <span class="keyword">sizeof</span>(coltitle);
<a name="l03109"></a>03109          res = SQLDescribeCol(stmt, x + 1, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)coltitle, <span class="keyword">sizeof</span>(coltitle), &amp;collen, 
<a name="l03110"></a>03110                   &amp;datatype, &amp;colsize, &amp;decimaldigits, &amp;nullable);
<a name="l03111"></a>03111          <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03112"></a>03112             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Describe Column error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03113"></a>03113             SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03114"></a>03114             <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03115"></a>03115             <span class="keywordflow">goto</span> yuck;
<a name="l03116"></a>03116          }
<a name="l03117"></a>03117          <span class="keywordflow">if</span> (!strcasecmp(coltitle, <span class="stringliteral">&quot;recording&quot;</span>)) {
<a name="l03118"></a>03118             off_t offset;
<a name="l03119"></a>03119             res = SQLGetData(stmt, x + 1, SQL_BINARY, rowdata, 0, &amp;colsize2);
<a name="l03120"></a>03120             fdlen = colsize2;
<a name="l03121"></a>03121             <span class="keywordflow">if</span> (fd &gt; -1) {
<a name="l03122"></a>03122                <span class="keywordtype">char</span> tmp[1]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03123"></a>03123                lseek(fd, fdlen - 1, SEEK_SET);
<a name="l03124"></a>03124                <span class="keywordflow">if</span> (write(fd, tmp, 1) != 1) {
<a name="l03125"></a>03125                   close(fd);
<a name="l03126"></a>03126                   fd = -1;
<a name="l03127"></a>03127                   <span class="keywordflow">continue</span>;
<a name="l03128"></a>03128                }
<a name="l03129"></a>03129                <span class="comment">/* Read out in small chunks */</span>
<a name="l03130"></a>03130                <span class="keywordflow">for</span> (offset = 0; offset &lt; colsize2; offset += <a class="code" href="app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>) {
<a name="l03131"></a>03131                   <span class="keywordflow">if</span> ((fdm = mmap(NULL, <a class="code" href="app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>, PROT_READ | PROT_WRITE, MAP_SHARED, fd, offset)) == MAP_FAILED) {
<a name="l03132"></a>03132                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Could not mmap the output file: %s (%d)\n&quot;</span>, strerror(errno), errno);
<a name="l03133"></a>03133                      SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l03134"></a>03134                      <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03135"></a>03135                      <span class="keywordflow">goto</span> yuck;
<a name="l03136"></a>03136                   } <span class="keywordflow">else</span> {
<a name="l03137"></a>03137                      res = SQLGetData(stmt, x + 1, SQL_BINARY, fdm, <a class="code" href="app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>, NULL);
<a name="l03138"></a>03138                      munmap(fdm, <a class="code" href="app__voicemail_8c.html#a239bebe1697b474e6f84945e9fb9faee">CHUNKSIZE</a>);
<a name="l03139"></a>03139                      <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03140"></a>03140                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03141"></a>03141                         unlink(full_fn);
<a name="l03142"></a>03142                         SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l03143"></a>03143                         <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03144"></a>03144                         <span class="keywordflow">goto</span> yuck;
<a name="l03145"></a>03145                      }
<a name="l03146"></a>03146                   }
<a name="l03147"></a>03147                }
<a name="l03148"></a>03148                <span class="keywordflow">if</span> (truncate(full_fn, fdlen) &lt; 0) {
<a name="l03149"></a>03149                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to truncate &apos;%s&apos;: %s\n&quot;</span>, full_fn, strerror(errno));
<a name="l03150"></a>03150                }
<a name="l03151"></a>03151             }
<a name="l03152"></a>03152          } <span class="keywordflow">else</span> {
<a name="l03153"></a>03153             res = SQLGetData(stmt, x + 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l03154"></a>03154             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03155"></a>03155                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error! coltitle=%s\n[%s]\n\n&quot;</span>, coltitle, sql);
<a name="l03156"></a>03156                SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03157"></a>03157                <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03158"></a>03158                <span class="keywordflow">goto</span> yuck;
<a name="l03159"></a>03159             }
<a name="l03160"></a>03160             <span class="keywordflow">if</span> (strcasecmp(coltitle, <span class="stringliteral">&quot;msgnum&quot;</span>) &amp;&amp; strcasecmp(coltitle, <span class="stringliteral">&quot;dir&quot;</span>) &amp;&amp; f)
<a name="l03161"></a>03161                fprintf(f, <span class="stringliteral">&quot;%s=%s\n&quot;</span>, coltitle, rowdata);
<a name="l03162"></a>03162          }
<a name="l03163"></a>03163       }
<a name="l03164"></a>03164       SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03165"></a>03165       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03166"></a>03166    } <span class="keywordflow">else</span>
<a name="l03167"></a>03167       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03168"></a>03168 yuck: 
<a name="l03169"></a>03169    <span class="keywordflow">if</span> (f)
<a name="l03170"></a>03170       fclose(f);
<a name="l03171"></a>03171    <span class="keywordflow">if</span> (fd &gt; -1)
<a name="l03172"></a>03172       close(fd);
<a name="l03173"></a>03173    <span class="keywordflow">return</span> x - 1;
<a name="l03174"></a>03174 }
<a name="l03175"></a>03175 <span class="comment"></span>
<a name="l03176"></a>03176 <span class="comment">/*!</span>
<a name="l03177"></a>03177 <span class="comment"> * \brief Determines the highest message number in use for a given user and mailbox folder.</span>
<a name="l03178"></a>03178 <span class="comment"> * \param vmu </span>
<a name="l03179"></a>03179 <span class="comment"> * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.</span>
<a name="l03180"></a>03180 <span class="comment"> *</span>
<a name="l03181"></a>03181 <span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span>
<a name="l03182"></a>03182 <span class="comment"> * Typical use to set the msgnum would be to take the value returned from this method and add one to it.</span>
<a name="l03183"></a>03183 <span class="comment"> *</span>
<a name="l03184"></a>03184 <span class="comment"> * \return the value of zero or greaterto indicate the last message index in use, -1 to indicate none.</span>
<a name="l03185"></a>03185 <span class="comment"> */</span>
<a name="l03186"></a>03186 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)
<a name="l03187"></a>03187 {
<a name="l03188"></a>03188    <span class="keywordtype">int</span> x = 0;
<a name="l03189"></a>03189    <span class="keywordtype">int</span> res;
<a name="l03190"></a>03190    SQLHSTMT stmt;
<a name="l03191"></a>03191    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l03192"></a>03192    <span class="keywordtype">char</span> rowdata[20];
<a name="l03193"></a>03193    <span class="keywordtype">char</span> *argv[] = { dir };
<a name="l03194"></a>03194    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 1, .argv = argv };
<a name="l03195"></a>03195 
<a name="l03196"></a>03196    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03197"></a>03197    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l03198"></a>03198    <span class="keywordflow">if</span> (obj) {
<a name="l03199"></a>03199       snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir=?&quot;</span>,odbc_table);
<a name="l03200"></a>03200       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l03201"></a>03201       <span class="keywordflow">if</span> (!stmt) {
<a name="l03202"></a>03202          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03203"></a>03203          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03204"></a>03204          <span class="keywordflow">goto</span> yuck;
<a name="l03205"></a>03205       }
<a name="l03206"></a>03206       res = SQLFetch(stmt);
<a name="l03207"></a>03207       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03208"></a>03208          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03209"></a>03209          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03210"></a>03210          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03211"></a>03211          <span class="keywordflow">goto</span> yuck;
<a name="l03212"></a>03212       }
<a name="l03213"></a>03213       res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l03214"></a>03214       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03215"></a>03215          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03216"></a>03216          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03217"></a>03217          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03218"></a>03218          <span class="keywordflow">goto</span> yuck;
<a name="l03219"></a>03219       }
<a name="l03220"></a>03220       <span class="keywordflow">if</span> (sscanf(rowdata, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) != 1)
<a name="l03221"></a>03221          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to read message count!\n&quot;</span>);
<a name="l03222"></a>03222       SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03223"></a>03223       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03224"></a>03224    } <span class="keywordflow">else</span>
<a name="l03225"></a>03225       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03226"></a>03226 yuck: 
<a name="l03227"></a>03227    <span class="keywordflow">return</span> x - 1;
<a name="l03228"></a>03228 }
<a name="l03229"></a>03229 <span class="comment"></span>
<a name="l03230"></a>03230 <span class="comment">/*!</span>
<a name="l03231"></a>03231 <span class="comment"> * \brief Determines if the specified message exists.</span>
<a name="l03232"></a>03232 <span class="comment"> * \param dir the folder the mailbox folder to look for messages. </span>
<a name="l03233"></a>03233 <span class="comment"> * \param msgnum the message index to query for.</span>
<a name="l03234"></a>03234 <span class="comment"> *</span>
<a name="l03235"></a>03235 <span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span>
<a name="l03236"></a>03236 <span class="comment"> *</span>
<a name="l03237"></a>03237 <span class="comment"> * \return greater than zero if the message exists, zero when the message does not exist or on error.</span>
<a name="l03238"></a>03238 <span class="comment"> */</span>
<a name="l03239"></a>03239 <span class="keyword">static</span> <span class="keywordtype">int</span> message_exists(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)
<a name="l03240"></a>03240 {
<a name="l03241"></a>03241    <span class="keywordtype">int</span> x = 0;
<a name="l03242"></a>03242    <span class="keywordtype">int</span> res;
<a name="l03243"></a>03243    SQLHSTMT stmt;
<a name="l03244"></a>03244    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l03245"></a>03245    <span class="keywordtype">char</span> rowdata[20];
<a name="l03246"></a>03246    <span class="keywordtype">char</span> msgnums[20];
<a name="l03247"></a>03247    <span class="keywordtype">char</span> *argv[] = { dir, msgnums };
<a name="l03248"></a>03248    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };
<a name="l03249"></a>03249 
<a name="l03250"></a>03250    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03251"></a>03251    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l03252"></a>03252    <span class="keywordflow">if</span> (obj) {
<a name="l03253"></a>03253       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);
<a name="l03254"></a>03254       snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir=? AND msgnum=?&quot;</span>,odbc_table);
<a name="l03255"></a>03255       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l03256"></a>03256       <span class="keywordflow">if</span> (!stmt) {
<a name="l03257"></a>03257          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03258"></a>03258          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03259"></a>03259          <span class="keywordflow">goto</span> yuck;
<a name="l03260"></a>03260       }
<a name="l03261"></a>03261       res = SQLFetch(stmt);
<a name="l03262"></a>03262       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03263"></a>03263          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03264"></a>03264          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03265"></a>03265          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03266"></a>03266          <span class="keywordflow">goto</span> yuck;
<a name="l03267"></a>03267       }
<a name="l03268"></a>03268       res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l03269"></a>03269       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03270"></a>03270          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03271"></a>03271          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03272"></a>03272          <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03273"></a>03273          <span class="keywordflow">goto</span> yuck;
<a name="l03274"></a>03274       }
<a name="l03275"></a>03275       <span class="keywordflow">if</span> (sscanf(rowdata, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) != 1)
<a name="l03276"></a>03276          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to read message count!\n&quot;</span>);
<a name="l03277"></a>03277       SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03278"></a>03278       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03279"></a>03279    } <span class="keywordflow">else</span>
<a name="l03280"></a>03280       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03281"></a>03281 yuck: 
<a name="l03282"></a>03282    <span class="keywordflow">return</span> x;
<a name="l03283"></a>03283 }
<a name="l03284"></a>03284 <span class="comment"></span>
<a name="l03285"></a>03285 <span class="comment">/*!</span>
<a name="l03286"></a>03286 <span class="comment"> * \brief returns the one-based count for messages.</span>
<a name="l03287"></a>03287 <span class="comment"> * \param vmu</span>
<a name="l03288"></a>03288 <span class="comment"> * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.</span>
<a name="l03289"></a>03289 <span class="comment"> *</span>
<a name="l03290"></a>03290 <span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span>
<a name="l03291"></a>03291 <span class="comment"> * The message index is zero-based, the first message will be index 0. For convenient display it is good to have the</span>
<a name="l03292"></a>03292 <span class="comment"> * one-based messages.</span>
<a name="l03293"></a>03293 <span class="comment"> * This method just calls last_message_index and returns +1 of its value.</span>
<a name="l03294"></a>03294 <span class="comment"> *</span>
<a name="l03295"></a>03295 <span class="comment"> * \return the value greater than zero on success to indicate the one-based count of messages, less than zero on error.</span>
<a name="l03296"></a>03296 <span class="comment"> */</span>
<a name="l03297"></a>03297 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6" title="Find all .txt files - even if they are not in sequence from 0000.">count_messages</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)
<a name="l03298"></a>03298 {
<a name="l03299"></a>03299    <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(vmu, dir) + 1;
<a name="l03300"></a>03300 }
<a name="l03301"></a>03301 <span class="comment"></span>
<a name="l03302"></a>03302 <span class="comment">/*!</span>
<a name="l03303"></a>03303 <span class="comment"> * \brief Deletes a message from the mailbox folder.</span>
<a name="l03304"></a>03304 <span class="comment"> * \param sdir The mailbox folder to work in.</span>
<a name="l03305"></a>03305 <span class="comment"> * \param smsg The message index to be deleted.</span>
<a name="l03306"></a>03306 <span class="comment"> *</span>
<a name="l03307"></a>03307 <span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span>
<a name="l03308"></a>03308 <span class="comment"> * The specified message is directly deleted from the database &apos;voicemessages&apos; table.</span>
<a name="l03309"></a>03309 <span class="comment"> * </span>
<a name="l03310"></a>03310 <span class="comment"> * \return the value greater than zero on success to indicate the number of messages, less than zero on error.</span>
<a name="l03311"></a>03311 <span class="comment"> */</span>
<a name="l03312"></a>03312 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *sdir, <span class="keywordtype">int</span> smsg)
<a name="l03313"></a>03313 {
<a name="l03314"></a>03314    SQLHSTMT stmt;
<a name="l03315"></a>03315    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l03316"></a>03316    <span class="keywordtype">char</span> msgnums[20];
<a name="l03317"></a>03317    <span class="keywordtype">char</span> *argv[] = { NULL, msgnums };
<a name="l03318"></a>03318    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 2, .argv = argv };
<a name="l03319"></a>03319    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03320"></a>03320 
<a name="l03321"></a>03321    argv[0] = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(sdir);
<a name="l03322"></a>03322 
<a name="l03323"></a>03323    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l03324"></a>03324    <span class="keywordflow">if</span> (obj) {
<a name="l03325"></a>03325       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, smsg);
<a name="l03326"></a>03326       snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;DELETE FROM %s WHERE dir=? AND msgnum=?&quot;</span>,odbc_table);
<a name="l03327"></a>03327       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l03328"></a>03328       <span class="keywordflow">if</span> (!stmt)
<a name="l03329"></a>03329          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03330"></a>03330       <span class="keywordflow">else</span>
<a name="l03331"></a>03331          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03332"></a>03332       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03333"></a>03333    } <span class="keywordflow">else</span>
<a name="l03334"></a>03334       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03335"></a>03335    <span class="keywordflow">return</span>;  
<a name="l03336"></a>03336 }
<a name="l03337"></a>03337 <span class="comment"></span>
<a name="l03338"></a>03338 <span class="comment">/*!</span>
<a name="l03339"></a>03339 <span class="comment"> * \brief Copies a voicemail from one mailbox to another.</span>
<a name="l03340"></a>03340 <span class="comment"> * \param sdir the folder for which to look for the message to be copied.</span>
<a name="l03341"></a>03341 <span class="comment"> * \param smsg the index of the message to be copied.</span>
<a name="l03342"></a>03342 <span class="comment"> * \param ddir the destination folder to copy the message into.</span>
<a name="l03343"></a>03343 <span class="comment"> * \param dmsg the index to be used for the copied message.</span>
<a name="l03344"></a>03344 <span class="comment"> * \param dmailboxuser The user who owns the mailbox tha contains the destination folder.</span>
<a name="l03345"></a>03345 <span class="comment"> * \param dmailboxcontext The context for the destination user.</span>
<a name="l03346"></a>03346 <span class="comment"> *</span>
<a name="l03347"></a>03347 <span class="comment"> * This method is used for the COPY macro when mailboxes are stored in an ODBC back end.</span>
<a name="l03348"></a>03348 <span class="comment"> */</span>
<a name="l03349"></a>03349 <span class="keyword">static</span> <span class="keywordtype">void</span> copy_file(<span class="keywordtype">char</span> *sdir, <span class="keywordtype">int</span> smsg, <span class="keywordtype">char</span> *ddir, <span class="keywordtype">int</span> dmsg, <span class="keywordtype">char</span> *dmailboxuser, <span class="keywordtype">char</span> *dmailboxcontext)
<a name="l03350"></a>03350 {
<a name="l03351"></a>03351    SQLHSTMT stmt;
<a name="l03352"></a>03352    <span class="keywordtype">char</span> sql[512];
<a name="l03353"></a>03353    <span class="keywordtype">char</span> msgnums[20];
<a name="l03354"></a>03354    <span class="keywordtype">char</span> msgnumd[20];
<a name="l03355"></a>03355    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03356"></a>03356    <span class="keywordtype">char</span> *argv[] = { ddir, msgnumd, dmailboxuser, dmailboxcontext, sdir, msgnums };
<a name="l03357"></a>03357    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 6, .argv = argv };
<a name="l03358"></a>03358 
<a name="l03359"></a>03359    <a class="code" href="res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(ddir, dmsg);
<a name="l03360"></a>03360    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l03361"></a>03361    <span class="keywordflow">if</span> (obj) {
<a name="l03362"></a>03362       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, smsg);
<a name="l03363"></a>03363       snprintf(msgnumd, <span class="keyword">sizeof</span>(msgnumd), <span class="stringliteral">&quot;%d&quot;</span>, dmsg);
<a name="l03364"></a>03364       snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO %s (dir, msgnum, context, macrocontext, callerid, origtime, duration, recording, flag, mailboxuser, mailboxcontext) SELECT ?,?,context,macrocontext,callerid,origtime,duration,recording,flag,?,? FROM %s WHERE dir=? AND msgnum=?&quot;</span>,odbc_table,odbc_table);
<a name="l03365"></a>03365       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l03366"></a>03366       <span class="keywordflow">if</span> (!stmt)
<a name="l03367"></a>03367          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s] (You probably don&apos;t have MySQL 4.1 or later installed)\n\n&quot;</span>, sql);
<a name="l03368"></a>03368       <span class="keywordflow">else</span>
<a name="l03369"></a>03369          SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l03370"></a>03370       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03371"></a>03371    } <span class="keywordflow">else</span>
<a name="l03372"></a>03372       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03373"></a>03373    <span class="keywordflow">return</span>;  
<a name="l03374"></a>03374 }
<a name="l03375"></a>03375 
<a name="l03376"></a>03376 <span class="keyword">struct </span>insert_data {
<a name="l03377"></a>03377    <span class="keywordtype">char</span> *sql;
<a name="l03378"></a>03378    <span class="keyword">const</span> <span class="keywordtype">char</span> *dir;
<a name="l03379"></a>03379    <span class="keyword">const</span> <span class="keywordtype">char</span> *msgnums;
<a name="l03380"></a>03380    <span class="keywordtype">void</span> *data;
<a name="l03381"></a>03381    SQLLEN datalen;
<a name="l03382"></a>03382    SQLLEN indlen;
<a name="l03383"></a>03383    <span class="keyword">const</span> <span class="keywordtype">char</span> *context;
<a name="l03384"></a>03384    <span class="keyword">const</span> <span class="keywordtype">char</span> *macrocontext;
<a name="l03385"></a>03385    <span class="keyword">const</span> <span class="keywordtype">char</span> *callerid;
<a name="l03386"></a>03386    <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime;
<a name="l03387"></a>03387    <span class="keyword">const</span> <span class="keywordtype">char</span> *duration;
<a name="l03388"></a>03388    <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser;
<a name="l03389"></a>03389    <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext;
<a name="l03390"></a>03390    <span class="keyword">const</span> <span class="keywordtype">char</span> *category;
<a name="l03391"></a>03391    <span class="keyword">const</span> <span class="keywordtype">char</span> *flag;
<a name="l03392"></a>03392 };
<a name="l03393"></a>03393 
<a name="l03394"></a>03394 <span class="keyword">static</span> SQLHSTMT insert_data_cb(<span class="keyword">struct</span> <a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj, <span class="keywordtype">void</span> *vdata)
<a name="l03395"></a>03395 {
<a name="l03396"></a>03396    <span class="keyword">struct </span>insert_data *data = vdata;
<a name="l03397"></a>03397    <span class="keywordtype">int</span> res;
<a name="l03398"></a>03398    SQLHSTMT stmt;
<a name="l03399"></a>03399 
<a name="l03400"></a>03400    res = SQLAllocHandle(SQL_HANDLE_STMT, obj-&gt;<a class="code" href="structodbc__obj.html#ae83918cc26dc7acd65bbec1712593054">con</a>, &amp;stmt);
<a name="l03401"></a>03401    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03402"></a>03402       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Alloc Handle failed!\n&quot;</span>);
<a name="l03403"></a>03403       SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l03404"></a>03404       <span class="keywordflow">return</span> NULL;
<a name="l03405"></a>03405    }
<a name="l03406"></a>03406 
<a name="l03407"></a>03407    SQLBindParameter(stmt, 1, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;dir), 0, (<span class="keywordtype">void</span> *)data-&gt;dir, 0, NULL);
<a name="l03408"></a>03408    SQLBindParameter(stmt, 2, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;msgnums), 0, (<span class="keywordtype">void</span> *)data-&gt;msgnums, 0, NULL);
<a name="l03409"></a>03409    SQLBindParameter(stmt, 3, SQL_PARAM_INPUT, SQL_C_BINARY, SQL_LONGVARBINARY, data-&gt;datalen, 0, (<span class="keywordtype">void</span> *)data-&gt;data, data-&gt;datalen, &amp;data-&gt;indlen);
<a name="l03410"></a>03410    SQLBindParameter(stmt, 4, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;context), 0, (<span class="keywordtype">void</span> *)data-&gt;context, 0, NULL);
<a name="l03411"></a>03411    SQLBindParameter(stmt, 5, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;macrocontext), 0, (<span class="keywordtype">void</span> *)data-&gt;macrocontext, 0, NULL);
<a name="l03412"></a>03412    SQLBindParameter(stmt, 6, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;callerid), 0, (<span class="keywordtype">void</span> *)data-&gt;callerid, 0, NULL);
<a name="l03413"></a>03413    SQLBindParameter(stmt, 7, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;origtime), 0, (<span class="keywordtype">void</span> *)data-&gt;origtime, 0, NULL);
<a name="l03414"></a>03414    SQLBindParameter(stmt, 8, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;duration), 0, (<span class="keywordtype">void</span> *)data-&gt;duration, 0, NULL);
<a name="l03415"></a>03415    SQLBindParameter(stmt, 9, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;mailboxuser), 0, (<span class="keywordtype">void</span> *)data-&gt;mailboxuser, 0, NULL);
<a name="l03416"></a>03416    SQLBindParameter(stmt, 10, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;mailboxcontext), 0, (<span class="keywordtype">void</span> *)data-&gt;mailboxcontext, 0, NULL);
<a name="l03417"></a>03417    SQLBindParameter(stmt, 11, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;flag), 0, (<span class="keywordtype">void</span> *)data-&gt;flag, 0, NULL);
<a name="l03418"></a>03418    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data-&gt;category)) {
<a name="l03419"></a>03419       SQLBindParameter(stmt, 12, SQL_PARAM_INPUT, SQL_C_CHAR, SQL_CHAR, strlen(data-&gt;category), 0, (<span class="keywordtype">void</span> *)data-&gt;category, 0, NULL);
<a name="l03420"></a>03420    }
<a name="l03421"></a>03421    res = SQLExecDirect(stmt, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)data-&gt;sql, SQL_NTS);
<a name="l03422"></a>03422    <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l03423"></a>03423       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Direct Execute failed!\n&quot;</span>);
<a name="l03424"></a>03424       SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l03425"></a>03425       <span class="keywordflow">return</span> NULL;
<a name="l03426"></a>03426    }
<a name="l03427"></a>03427 
<a name="l03428"></a>03428    <span class="keywordflow">return</span> stmt;
<a name="l03429"></a>03429 }
<a name="l03430"></a>03430 <span class="comment"></span>
<a name="l03431"></a>03431 <span class="comment">/*!</span>
<a name="l03432"></a>03432 <span class="comment"> * \brief Stores a voicemail into the database.</span>
<a name="l03433"></a>03433 <span class="comment"> * \param dir the folder the mailbox folder to store the message.</span>
<a name="l03434"></a>03434 <span class="comment"> * \param mailboxuser the user owning the mailbox folder.</span>
<a name="l03435"></a>03435 <span class="comment"> * \param mailboxcontext</span>
<a name="l03436"></a>03436 <span class="comment"> * \param msgnum the message index for the message to be stored.</span>
<a name="l03437"></a>03437 <span class="comment"> *</span>
<a name="l03438"></a>03438 <span class="comment"> * This method is used when mailboxes are stored in an ODBC back end.</span>
<a name="l03439"></a>03439 <span class="comment"> * The message sound file and information file is looked up on the file system. </span>
<a name="l03440"></a>03440 <span class="comment"> * A SQL query is invoked to store the message into the (MySQL) database.</span>
<a name="l03441"></a>03441 <span class="comment"> *</span>
<a name="l03442"></a>03442 <span class="comment"> * \return the zero on success -1 on error.</span>
<a name="l03443"></a>03443 <span class="comment"> */</span>
<a name="l03444"></a>03444 <span class="keyword">static</span> <span class="keywordtype">int</span> store_file(<span class="keyword">const</span> <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxuser, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">int</span> msgnum)
<a name="l03445"></a>03445 {
<a name="l03446"></a>03446    <span class="keywordtype">int</span> res = 0;
<a name="l03447"></a>03447    <span class="keywordtype">int</span> fd = -1;
<a name="l03448"></a>03448    <span class="keywordtype">void</span> *fdm = MAP_FAILED;
<a name="l03449"></a>03449    <span class="keywordtype">size_t</span> fdlen = -1;
<a name="l03450"></a>03450    SQLHSTMT stmt;
<a name="l03451"></a>03451    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l03452"></a>03452    <span class="keywordtype">char</span> msgnums[20];
<a name="l03453"></a>03453    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l03454"></a>03454    <span class="keywordtype">char</span> full_fn[PATH_MAX];
<a name="l03455"></a>03455    <span class="keywordtype">char</span> fmt[80]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l03456"></a>03456    <span class="keywordtype">char</span> *c;
<a name="l03457"></a>03457    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg=NULL;
<a name="l03458"></a>03458    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03459"></a>03459    <span class="keyword">struct </span>insert_data idata = { .sql = sql, .msgnums = msgnums, .dir = dir, .mailboxuser = mailboxuser, .mailboxcontext = mailboxcontext,
<a name="l03460"></a>03460       .context = <span class="stringliteral">&quot;&quot;</span>, .macrocontext = <span class="stringliteral">&quot;&quot;</span>, .callerid = <span class="stringliteral">&quot;&quot;</span>, .origtime = <span class="stringliteral">&quot;&quot;</span>, .duration = <span class="stringliteral">&quot;&quot;</span>, .category = <span class="stringliteral">&quot;&quot;</span>, .flag = <span class="stringliteral">&quot;&quot;</span> };
<a name="l03461"></a>03461    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26a3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };
<a name="l03462"></a>03462 
<a name="l03463"></a>03463    <a class="code" href="res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(dir, msgnum);
<a name="l03464"></a>03464    <span class="keywordflow">if</span> (!(obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0))) {
<a name="l03465"></a>03465       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03466"></a>03466       <span class="keywordflow">return</span> -1;
<a name="l03467"></a>03467    }
<a name="l03468"></a>03468 
<a name="l03469"></a>03469    <span class="keywordflow">do</span> {
<a name="l03470"></a>03470       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fmt, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, <span class="keyword">sizeof</span>(fmt));
<a name="l03471"></a>03471       c = strchr(fmt, <span class="charliteral">&apos;|&apos;</span>);
<a name="l03472"></a>03472       <span class="keywordflow">if</span> (c)
<a name="l03473"></a>03473          *c = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03474"></a>03474       <span class="keywordflow">if</span> (!strcasecmp(fmt, <span class="stringliteral">&quot;wav49&quot;</span>))
<a name="l03475"></a>03475          strcpy(fmt, <span class="stringliteral">&quot;WAV&quot;</span>);
<a name="l03476"></a>03476       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums),<span class="stringliteral">&quot;%d&quot;</span>, msgnum);
<a name="l03477"></a>03477       <span class="keywordflow">if</span> (msgnum &gt; -1)
<a name="l03478"></a>03478          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);
<a name="l03479"></a>03479       <span class="keywordflow">else</span>
<a name="l03480"></a>03480          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));
<a name="l03481"></a>03481       snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);
<a name="l03482"></a>03482       cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(full_fn, config_flags);
<a name="l03483"></a>03483       snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.%s&quot;</span>, fn, fmt);
<a name="l03484"></a>03484       fd = open(full_fn, O_RDWR);
<a name="l03485"></a>03485       <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l03486"></a>03486          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Open of sound file &apos;%s&apos; failed: %s\n&quot;</span>, full_fn, strerror(errno));
<a name="l03487"></a>03487          res = -1;
<a name="l03488"></a>03488          <span class="keywordflow">break</span>;
<a name="l03489"></a>03489       }
<a name="l03490"></a>03490       <span class="keywordflow">if</span> (cfg &amp;&amp; cfg != <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l03491"></a>03491          <span class="keywordflow">if</span> (!(idata.context = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>))) {
<a name="l03492"></a>03492             idata.context = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03493"></a>03493          }
<a name="l03494"></a>03494          <span class="keywordflow">if</span> (!(idata.macrocontext = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;macrocontext&quot;</span>))) {
<a name="l03495"></a>03495             idata.macrocontext = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03496"></a>03496          }
<a name="l03497"></a>03497          <span class="keywordflow">if</span> (!(idata.callerid = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {
<a name="l03498"></a>03498             idata.callerid = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03499"></a>03499          }
<a name="l03500"></a>03500          <span class="keywordflow">if</span> (!(idata.origtime = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {
<a name="l03501"></a>03501             idata.origtime = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03502"></a>03502          }
<a name="l03503"></a>03503          <span class="keywordflow">if</span> (!(idata.duration = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {
<a name="l03504"></a>03504             idata.duration = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03505"></a>03505          }
<a name="l03506"></a>03506          <span class="keywordflow">if</span> (!(idata.category = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;category&quot;</span>))) {
<a name="l03507"></a>03507             idata.category = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03508"></a>03508          }
<a name="l03509"></a>03509          <span class="keywordflow">if</span> (!(idata.flag = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;flag&quot;</span>))) {
<a name="l03510"></a>03510             idata.flag = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03511"></a>03511          }
<a name="l03512"></a>03512       }
<a name="l03513"></a>03513       fdlen = lseek(fd, 0, SEEK_END);
<a name="l03514"></a>03514       lseek(fd, 0, SEEK_SET);
<a name="l03515"></a>03515       printf(<span class="stringliteral">&quot;Length is %zd\n&quot;</span>, fdlen);
<a name="l03516"></a>03516       fdm = mmap(NULL, fdlen, PROT_READ | PROT_WRITE, MAP_SHARED,fd, 0);
<a name="l03517"></a>03517       <span class="keywordflow">if</span> (fdm == MAP_FAILED) {
<a name="l03518"></a>03518          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Memory map failed!\n&quot;</span>);
<a name="l03519"></a>03519          res = -1;
<a name="l03520"></a>03520          <span class="keywordflow">break</span>;
<a name="l03521"></a>03521       } 
<a name="l03522"></a>03522       idata.data = fdm;
<a name="l03523"></a>03523       idata.datalen = idata.indlen = fdlen;
<a name="l03524"></a>03524 
<a name="l03525"></a>03525       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(idata.category)) 
<a name="l03526"></a>03526          snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO %s (dir,msgnum,recording,context,macrocontext,callerid,origtime,duration,mailboxuser,mailboxcontext,flag,category) VALUES (?,?,?,?,?,?,?,?,?,?,?,?)&quot;</span>,odbc_table); 
<a name="l03527"></a>03527       <span class="keywordflow">else</span>
<a name="l03528"></a>03528          snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;INSERT INTO %s (dir,msgnum,recording,context,macrocontext,callerid,origtime,duration,mailboxuser,mailboxcontext,flag) VALUES (?,?,?,?,?,?,?,?,?,?,?)&quot;</span>,odbc_table);
<a name="l03529"></a>03529 
<a name="l03530"></a>03530       <span class="keywordflow">if</span> ((stmt = <a class="code" href="res__odbc_8h.html#ac29fe8d9aba364c43aa8b5c47e48587e" title="Executes an non prepared statement and returns the resulting statement handle.">ast_odbc_direct_execute</a>(obj, insert_data_cb, &amp;idata))) {
<a name="l03531"></a>03531          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l03532"></a>03532       } <span class="keywordflow">else</span> {
<a name="l03533"></a>03533          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03534"></a>03534          res = -1;
<a name="l03535"></a>03535       }
<a name="l03536"></a>03536    } <span class="keywordflow">while</span> (0);
<a name="l03537"></a>03537    <span class="keywordflow">if</span> (obj) {
<a name="l03538"></a>03538       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03539"></a>03539    }
<a name="l03540"></a>03540    <span class="keywordflow">if</span> (cfg)
<a name="l03541"></a>03541       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03542"></a>03542    <span class="keywordflow">if</span> (fdm != MAP_FAILED)
<a name="l03543"></a>03543       munmap(fdm, fdlen);
<a name="l03544"></a>03544    <span class="keywordflow">if</span> (fd &gt; -1)
<a name="l03545"></a>03545       close(fd);
<a name="l03546"></a>03546    <span class="keywordflow">return</span> res;
<a name="l03547"></a>03547 }
<a name="l03548"></a>03548 <span class="comment"></span>
<a name="l03549"></a>03549 <span class="comment">/*!</span>
<a name="l03550"></a>03550 <span class="comment"> * \brief Renames a message in a mailbox folder.</span>
<a name="l03551"></a>03551 <span class="comment"> * \param sdir The folder of the message to be renamed.</span>
<a name="l03552"></a>03552 <span class="comment"> * \param smsg The index of the message to be renamed.</span>
<a name="l03553"></a>03553 <span class="comment"> * \param mailboxuser The user to become the owner of the message after it is renamed. Usually this will be the same as the original owner.</span>
<a name="l03554"></a>03554 <span class="comment"> * \param mailboxcontext The context to be set for the message. Usually this will be the same as the original context.</span>
<a name="l03555"></a>03555 <span class="comment"> * \param ddir The destination folder for the message to be renamed into</span>
<a name="l03556"></a>03556 <span class="comment"> * \param dmsg The destination message for the message to be renamed.</span>
<a name="l03557"></a>03557 <span class="comment"> *</span>
<a name="l03558"></a>03558 <span class="comment"> * This method is used by the RENAME macro when mailboxes are stored in an ODBC back end.</span>
<a name="l03559"></a>03559 <span class="comment"> * The is usually used to resequence the messages in the mailbox, such as to delete messag index 0, it would be called successively to slide all the other messages down one index.</span>
<a name="l03560"></a>03560 <span class="comment"> * But in theory, because the SQL query performs an update on (dir, msgnum, mailboxuser, mailboxcontext) in the database, it should be possible to have the message relocated to another mailbox or context as well.</span>
<a name="l03561"></a>03561 <span class="comment"> */</span>
<a name="l03562"></a>03562 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3" title="Renames a message in a mailbox folder.">rename_file</a>(<span class="keywordtype">char</span> *sdir, <span class="keywordtype">int</span> smsg, <span class="keywordtype">char</span> *mailboxuser, <span class="keywordtype">char</span> *mailboxcontext, <span class="keywordtype">char</span> *ddir, <span class="keywordtype">int</span> dmsg)
<a name="l03563"></a>03563 {
<a name="l03564"></a>03564    SQLHSTMT stmt;
<a name="l03565"></a>03565    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l03566"></a>03566    <span class="keywordtype">char</span> msgnums[20];
<a name="l03567"></a>03567    <span class="keywordtype">char</span> msgnumd[20];
<a name="l03568"></a>03568    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj;
<a name="l03569"></a>03569    <span class="keywordtype">char</span> *argv[] = { ddir, msgnumd, mailboxuser, mailboxcontext, sdir, msgnums };
<a name="l03570"></a>03570    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 6, .argv = argv };
<a name="l03571"></a>03571 
<a name="l03572"></a>03572    <a class="code" href="res__phoneprov_8c.html#a9a2102f5ce1bbef671a27b071df6d806">delete_file</a>(ddir, dmsg);
<a name="l03573"></a>03573    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l03574"></a>03574    <span class="keywordflow">if</span> (obj) {
<a name="l03575"></a>03575       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, smsg);
<a name="l03576"></a>03576       snprintf(msgnumd, <span class="keyword">sizeof</span>(msgnumd), <span class="stringliteral">&quot;%d&quot;</span>, dmsg);
<a name="l03577"></a>03577       snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;UPDATE %s SET dir=?, msgnum=?, mailboxuser=?, mailboxcontext=? WHERE dir=? AND msgnum=?&quot;</span>,odbc_table);
<a name="l03578"></a>03578       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l03579"></a>03579       <span class="keywordflow">if</span> (!stmt)
<a name="l03580"></a>03580          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l03581"></a>03581       <span class="keywordflow">else</span>
<a name="l03582"></a>03582          SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l03583"></a>03583       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l03584"></a>03584    } <span class="keywordflow">else</span>
<a name="l03585"></a>03585       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l03586"></a>03586    <span class="keywordflow">return</span>;  
<a name="l03587"></a>03587 }
<a name="l03588"></a>03588 <span class="comment"></span>
<a name="l03589"></a>03589 <span class="comment">/*!</span>
<a name="l03590"></a>03590 <span class="comment"> * \brief Removes a voicemail message file.</span>
<a name="l03591"></a>03591 <span class="comment"> * \param dir the path to the message file.</span>
<a name="l03592"></a>03592 <span class="comment"> * \param msgnum the unique number for the message within the mailbox.</span>
<a name="l03593"></a>03593 <span class="comment"> *</span>
<a name="l03594"></a>03594 <span class="comment"> * Removes the message content file and the information file.</span>
<a name="l03595"></a>03595 <span class="comment"> * This method is used by the DISPOSE macro when mailboxes are stored in an ODBC back end.</span>
<a name="l03596"></a>03596 <span class="comment"> * Typical use is to clean up after a RETRIEVE operation. </span>
<a name="l03597"></a>03597 <span class="comment"> * Note that this does not remove the message from the mailbox folders, to do that we would use delete_file().</span>
<a name="l03598"></a>03598 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l03599"></a>03599 <span class="comment"> */</span>
<a name="l03600"></a>03600 <span class="keyword">static</span> <span class="keywordtype">int</span> remove_file(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)
<a name="l03601"></a>03601 {
<a name="l03602"></a>03602    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l03603"></a>03603    <span class="keywordtype">char</span> full_fn[PATH_MAX];
<a name="l03604"></a>03604    <span class="keywordtype">char</span> msgnums[80];
<a name="l03605"></a>03605    
<a name="l03606"></a>03606    <span class="keywordflow">if</span> (msgnum &gt; -1) {
<a name="l03607"></a>03607       snprintf(msgnums, <span class="keyword">sizeof</span>(msgnums), <span class="stringliteral">&quot;%d&quot;</span>, msgnum);
<a name="l03608"></a>03608       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);
<a name="l03609"></a>03609    } <span class="keywordflow">else</span>
<a name="l03610"></a>03610       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));
<a name="l03611"></a>03611    <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(fn, NULL);  
<a name="l03612"></a>03612    snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);
<a name="l03613"></a>03613    unlink(full_fn);
<a name="l03614"></a>03614    <span class="keywordflow">return</span> 0;
<a name="l03615"></a>03615 }
<a name="l03616"></a>03616 <span class="preprocessor">#else</span>
<a name="l03617"></a>03617 <span class="preprocessor"></span><span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l03618"></a>03618 <span class="preprocessor"></span><span class="comment">/*!</span>
<a name="l03619"></a>03619 <span class="comment"> * \brief Find all .txt files - even if they are not in sequence from 0000.</span>
<a name="l03620"></a>03620 <span class="comment"> * \param vmu</span>
<a name="l03621"></a>03621 <span class="comment"> * \param dir</span>
<a name="l03622"></a>03622 <span class="comment"> *</span>
<a name="l03623"></a>03623 <span class="comment"> * This method is used when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</span>
<a name="l03624"></a>03624 <span class="comment"> *</span>
<a name="l03625"></a>03625 <span class="comment"> * \return the count of messages, zero or more.</span>
<a name="l03626"></a>03626 <span class="comment"> */</span>
<a name="l03627"></a><a class="code" href="app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6">03627</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6" title="Find all .txt files - even if they are not in sequence from 0000.">count_messages</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)
<a name="l03628"></a>03628 {
<a name="l03629"></a>03629 
<a name="l03630"></a>03630    <span class="keywordtype">int</span> vmcount = 0;
<a name="l03631"></a>03631    DIR *vmdir = NULL;
<a name="l03632"></a>03632    <span class="keyword">struct </span>dirent *vment = NULL;
<a name="l03633"></a>03633 
<a name="l03634"></a>03634    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(dir))
<a name="l03635"></a>03635       <span class="keywordflow">return</span> <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;
<a name="l03636"></a>03636 
<a name="l03637"></a>03637    <span class="keywordflow">if</span> ((vmdir = opendir(dir))) {
<a name="l03638"></a>03638       <span class="keywordflow">while</span> ((vment = readdir(vmdir))) {
<a name="l03639"></a>03639          <span class="keywordflow">if</span> (strlen(vment-&gt;d_name) &gt; 7 &amp;&amp; !strncmp(vment-&gt;d_name + 7, <span class="stringliteral">&quot;.txt&quot;</span>, 4)) {
<a name="l03640"></a>03640             vmcount++;
<a name="l03641"></a>03641          }
<a name="l03642"></a>03642       }
<a name="l03643"></a>03643       closedir(vmdir);
<a name="l03644"></a>03644    }
<a name="l03645"></a>03645    <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(dir);
<a name="l03646"></a>03646    
<a name="l03647"></a>03647    <span class="keywordflow">return</span> vmcount;
<a name="l03648"></a>03648 }
<a name="l03649"></a>03649 <span class="comment"></span>
<a name="l03650"></a>03650 <span class="comment">/*!</span>
<a name="l03651"></a>03651 <span class="comment"> * \brief Renames a message in a mailbox folder.</span>
<a name="l03652"></a>03652 <span class="comment"> * \param sfn The path to the mailbox information and data file to be renamed.</span>
<a name="l03653"></a>03653 <span class="comment"> * \param dfn The path for where the message data and information files will be renamed to.</span>
<a name="l03654"></a>03654 <span class="comment"> *</span>
<a name="l03655"></a>03655 <span class="comment"> * This method is used by the RENAME macro when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</span>
<a name="l03656"></a>03656 <span class="comment"> */</span>
<a name="l03657"></a><a class="code" href="app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3">03657</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a641453ff932559ad5d8bcd3e9203bcf3" title="Renames a message in a mailbox folder.">rename_file</a>(<span class="keywordtype">char</span> *sfn, <span class="keywordtype">char</span> *dfn)
<a name="l03658"></a>03658 {
<a name="l03659"></a>03659    <span class="keywordtype">char</span> stxt[PATH_MAX];
<a name="l03660"></a>03660    <span class="keywordtype">char</span> dtxt[PATH_MAX];
<a name="l03661"></a>03661    <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(sfn,dfn,NULL);
<a name="l03662"></a>03662    snprintf(stxt, <span class="keyword">sizeof</span>(stxt), <span class="stringliteral">&quot;%s.txt&quot;</span>, sfn);
<a name="l03663"></a>03663    snprintf(dtxt, <span class="keyword">sizeof</span>(dtxt), <span class="stringliteral">&quot;%s.txt&quot;</span>, dfn);
<a name="l03664"></a>03664    <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l03665"></a>03665       <a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, sfn, <span class="stringliteral">&quot;filename&quot;</span>, dfn, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l03666"></a>03666    }
<a name="l03667"></a>03667    rename(stxt, dtxt);
<a name="l03668"></a>03668 }
<a name="l03669"></a>03669 <span class="comment"></span>
<a name="l03670"></a>03670 <span class="comment">/*! </span>
<a name="l03671"></a>03671 <span class="comment"> * \brief Determines the highest message number in use for a given user and mailbox folder.</span>
<a name="l03672"></a>03672 <span class="comment"> * \param vmu </span>
<a name="l03673"></a>03673 <span class="comment"> * \param dir the folder the mailbox folder to look for messages. Used to construct the SQL where clause.</span>
<a name="l03674"></a>03674 <span class="comment"> *</span>
<a name="l03675"></a>03675 <span class="comment"> * This method is used when mailboxes are stored on the filesystem. (not ODBC and not IMAP).</span>
<a name="l03676"></a>03676 <span class="comment"> * Typical use to set the msgnum would be to take the value returned from this method and add one to it.</span>
<a name="l03677"></a>03677 <span class="comment"> *</span>
<a name="l03678"></a>03678 <span class="comment"> * \note Should always be called with a lock already set on dir.</span>
<a name="l03679"></a>03679 <span class="comment"> * \return the value of zero or greaterto indicate the last message index in use, -1 to indicate none.</span>
<a name="l03680"></a>03680 <span class="comment"> */</span>
<a name="l03681"></a><a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429">03681</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *dir)
<a name="l03682"></a>03682 {
<a name="l03683"></a>03683    <span class="keywordtype">int</span> x;
<a name="l03684"></a>03684    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="misdn__config_8c.html#a92a7399cbb76f6349df98d9432ad52c6">map</a>[<a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03685"></a>03685    DIR *msgdir;
<a name="l03686"></a>03686    <span class="keyword">struct </span>dirent *msgdirent;
<a name="l03687"></a>03687    <span class="keywordtype">int</span> msgdirint;
<a name="l03688"></a>03688 
<a name="l03689"></a>03689    <span class="comment">/* Reading the entire directory into a file map scales better than</span>
<a name="l03690"></a>03690 <span class="comment">    * doing a stat repeatedly on a predicted sequence.  I suspect this</span>
<a name="l03691"></a>03691 <span class="comment">    * is partially due to stat(2) internally doing a readdir(2) itself to</span>
<a name="l03692"></a>03692 <span class="comment">    * find each file. */</span>
<a name="l03693"></a>03693    <span class="keywordflow">if</span> (!(msgdir = opendir(dir))) {
<a name="l03694"></a>03694       <span class="keywordflow">return</span> -1;
<a name="l03695"></a>03695    }
<a name="l03696"></a>03696 
<a name="l03697"></a>03697    <span class="keywordflow">while</span> ((msgdirent = readdir(msgdir))) {
<a name="l03698"></a>03698       <span class="keywordflow">if</span> (sscanf(msgdirent-&gt;d_name, <span class="stringliteral">&quot;msg%30d&quot;</span>, &amp;msgdirint) == 1 &amp;&amp; msgdirint &lt; <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>)
<a name="l03699"></a>03699          map[msgdirint] = 1;
<a name="l03700"></a>03700    }
<a name="l03701"></a>03701    closedir(msgdir);
<a name="l03702"></a>03702 
<a name="l03703"></a>03703    <span class="keywordflow">for</span> (x = 0; x &lt; vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>; x++) {
<a name="l03704"></a>03704       <span class="keywordflow">if</span> (map[x] == 0)
<a name="l03705"></a>03705          <span class="keywordflow">break</span>;
<a name="l03706"></a>03706    }
<a name="l03707"></a>03707 
<a name="l03708"></a>03708    <span class="keywordflow">return</span> x - 1;
<a name="l03709"></a>03709 }
<a name="l03710"></a>03710 
<a name="l03711"></a>03711 <span class="preprocessor">#endif </span><span class="comment">/* #ifndef IMAP_STORAGE */</span>
<a name="l03712"></a>03712 <span class="preprocessor">#endif </span><span class="comment">/* #else of #ifdef ODBC_STORAGE */</span>
<a name="l03713"></a>03713 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l03714"></a>03714 <span class="preprocessor"></span><span class="comment">/*!</span>
<a name="l03715"></a>03715 <span class="comment"> * \brief Utility function to copy a file.</span>
<a name="l03716"></a>03716 <span class="comment"> * \param infile The path to the file to be copied. The file must be readable, it is opened in read only mode.</span>
<a name="l03717"></a>03717 <span class="comment"> * \param outfile The path for which to copy the file to. The directory permissions must allow the creation (or truncation) of the file, and allow for opening the file in write only mode.</span>
<a name="l03718"></a>03718 <span class="comment"> *</span>
<a name="l03719"></a>03719 <span class="comment"> * When the compiler option HARDLINK_WHEN_POSSIBLE is set, the copy operation will attempt to use the hard link facility instead of copy the file (to save disk space). If the link operation fails, it falls back to the copy operation.</span>
<a name="l03720"></a>03720 <span class="comment"> * The copy operation copies up to 4096 bytes at once.</span>
<a name="l03721"></a>03721 <span class="comment"> *</span>
<a name="l03722"></a>03722 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l03723"></a>03723 <span class="comment"> */</span>
<a name="l03724"></a><a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531">03724</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a>(<span class="keywordtype">char</span> *infile, <span class="keywordtype">char</span> *outfile)
<a name="l03725"></a>03725 {
<a name="l03726"></a>03726    <span class="keywordtype">int</span> ifd;
<a name="l03727"></a>03727    <span class="keywordtype">int</span> ofd;
<a name="l03728"></a>03728    <span class="keywordtype">int</span> res;
<a name="l03729"></a>03729    <span class="keywordtype">int</span> len;
<a name="l03730"></a>03730    <span class="keywordtype">char</span> buf[4096];
<a name="l03731"></a>03731 
<a name="l03732"></a>03732 <span class="preprocessor">#ifdef HARDLINK_WHEN_POSSIBLE</span>
<a name="l03733"></a>03733 <span class="preprocessor"></span>   <span class="comment">/* Hard link if possible; saves disk space &amp; is faster */</span>
<a name="l03734"></a>03734    <span class="keywordflow">if</span> (link(infile, outfile)) {
<a name="l03735"></a>03735 <span class="preprocessor">#endif</span>
<a name="l03736"></a>03736 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ((ifd = open(infile, O_RDONLY)) &lt; 0) {
<a name="l03737"></a>03737          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s in read-only mode: %s\n&quot;</span>, infile, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03738"></a>03738          <span class="keywordflow">return</span> -1;
<a name="l03739"></a>03739       }
<a name="l03740"></a>03740       <span class="keywordflow">if</span> ((ofd = open(outfile, O_WRONLY | O_TRUNC | O_CREAT, <a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>)) &lt; 0) {
<a name="l03741"></a>03741          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open %s in write-only mode: %s\n&quot;</span>, outfile, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03742"></a>03742          close(ifd);
<a name="l03743"></a>03743          <span class="keywordflow">return</span> -1;
<a name="l03744"></a>03744       }
<a name="l03745"></a>03745       <span class="keywordflow">do</span> {
<a name="l03746"></a>03746          len = read(ifd, buf, <span class="keyword">sizeof</span>(buf));
<a name="l03747"></a>03747          <span class="keywordflow">if</span> (len &lt; 0) {
<a name="l03748"></a>03748             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Read failed on %s: %s\n&quot;</span>, infile, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03749"></a>03749             close(ifd);
<a name="l03750"></a>03750             close(ofd);
<a name="l03751"></a>03751             unlink(outfile);
<a name="l03752"></a>03752          }
<a name="l03753"></a>03753          <span class="keywordflow">if</span> (len) {
<a name="l03754"></a>03754             res = write(ofd, buf, len);
<a name="l03755"></a>03755             <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOMEM || <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> == ENOSPC || res != len) {
<a name="l03756"></a>03756                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Write failed on %s (%d of %d): %s\n&quot;</span>, outfile, res, len, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03757"></a>03757                close(ifd);
<a name="l03758"></a>03758                close(ofd);
<a name="l03759"></a>03759                unlink(outfile);
<a name="l03760"></a>03760             }
<a name="l03761"></a>03761          }
<a name="l03762"></a>03762       } <span class="keywordflow">while</span> (len);
<a name="l03763"></a>03763       close(ifd);
<a name="l03764"></a>03764       close(ofd);
<a name="l03765"></a>03765       <span class="keywordflow">return</span> 0;
<a name="l03766"></a>03766 <span class="preprocessor">#ifdef HARDLINK_WHEN_POSSIBLE</span>
<a name="l03767"></a>03767 <span class="preprocessor"></span>   } <span class="keywordflow">else</span> {
<a name="l03768"></a>03768       <span class="comment">/* Hard link succeeded */</span>
<a name="l03769"></a>03769       <span class="keywordflow">return</span> 0;
<a name="l03770"></a>03770    }
<a name="l03771"></a>03771 <span class="preprocessor">#endif</span>
<a name="l03772"></a>03772 <span class="preprocessor"></span>}
<a name="l03773"></a>03773 <span class="comment"></span>
<a name="l03774"></a>03774 <span class="comment">/*!</span>
<a name="l03775"></a>03775 <span class="comment"> * \brief Copies a voicemail information (envelope) file.</span>
<a name="l03776"></a>03776 <span class="comment"> * \param frompath</span>
<a name="l03777"></a>03777 <span class="comment"> * \param topath </span>
<a name="l03778"></a>03778 <span class="comment"> *</span>
<a name="l03779"></a>03779 <span class="comment"> * Every voicemail has the data (.wav) file, and the information file.</span>
<a name="l03780"></a>03780 <span class="comment"> * This function performs the file system copying of the information file for a voicemail, handling the internal fields and their values.</span>
<a name="l03781"></a>03781 <span class="comment"> * This is used by the COPY macro when not using IMAP storage.</span>
<a name="l03782"></a>03782 <span class="comment"> */</span>
<a name="l03783"></a><a class="code" href="app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1">03783</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1" title="Copies a voicemail information (envelope) file.">copy_plain_file</a>(<span class="keywordtype">char</span> *frompath, <span class="keywordtype">char</span> *topath)
<a name="l03784"></a>03784 {
<a name="l03785"></a>03785    <span class="keywordtype">char</span> frompath2[PATH_MAX], topath2[PATH_MAX];
<a name="l03786"></a>03786    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *tmp,*var = NULL;
<a name="l03787"></a>03787    <span class="keyword">const</span> <span class="keywordtype">char</span> *origmailbox = NULL, *context = NULL, *macrocontext = NULL, *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = NULL, *priority = NULL, *callerchan = NULL, *callerid = NULL, *origdate = NULL, *origtime = NULL, *category = NULL, *duration = NULL;
<a name="l03788"></a>03788    <a class="code" href="file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b" title="Copies a file.">ast_filecopy</a>(frompath, topath, NULL);
<a name="l03789"></a>03789    snprintf(frompath2, <span class="keyword">sizeof</span>(frompath2), <span class="stringliteral">&quot;%s.txt&quot;</span>, frompath);
<a name="l03790"></a>03790    snprintf(topath2, <span class="keyword">sizeof</span>(topath2), <span class="stringliteral">&quot;%s.txt&quot;</span>, topath);
<a name="l03791"></a>03791    <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l03792"></a>03792       var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, frompath, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l03793"></a>03793       <span class="comment">/* This cycle converts ast_variable linked list, to va_list list of arguments, may be there is a better way to do it? */</span>
<a name="l03794"></a>03794       <span class="keywordflow">for</span> (tmp = var; tmp; tmp = tmp-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03795"></a>03795          <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;origmailbox&quot;</span>)) {
<a name="l03796"></a>03796             origmailbox = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03797"></a>03797          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;context&quot;</span>)) {
<a name="l03798"></a>03798             context = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03799"></a>03799          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;macrocontext&quot;</span>)) {
<a name="l03800"></a>03800             macrocontext = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03801"></a>03801          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;exten&quot;</span>)) {
<a name="l03802"></a>03802             exten = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03803"></a>03803          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;priority&quot;</span>)) {
<a name="l03804"></a>03804             priority = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03805"></a>03805          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerchan&quot;</span>)) {
<a name="l03806"></a>03806             callerchan = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03807"></a>03807          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;callerid&quot;</span>)) {
<a name="l03808"></a>03808             callerid = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03809"></a>03809          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;origdate&quot;</span>)) {
<a name="l03810"></a>03810             origdate = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03811"></a>03811          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;origtime&quot;</span>)) {
<a name="l03812"></a>03812             origtime = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03813"></a>03813          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;category&quot;</span>)) {
<a name="l03814"></a>03814             category = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03815"></a>03815          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(tmp-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;duration&quot;</span>)) {
<a name="l03816"></a>03816             duration = tmp-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>;
<a name="l03817"></a>03817          }
<a name="l03818"></a>03818       }
<a name="l03819"></a>03819       <a class="code" href="config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2" title="Create realtime configuration.">ast_store_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, topath, <span class="stringliteral">&quot;origmailbox&quot;</span>, origmailbox, <span class="stringliteral">&quot;context&quot;</span>, context, <span class="stringliteral">&quot;macrocontext&quot;</span>, macrocontext, <span class="stringliteral">&quot;exten&quot;</span>, exten, <span class="stringliteral">&quot;priority&quot;</span>, priority, <span class="stringliteral">&quot;callerchan&quot;</span>, callerchan, <span class="stringliteral">&quot;callerid&quot;</span>, callerid, <span class="stringliteral">&quot;origdate&quot;</span>, origdate, <span class="stringliteral">&quot;origtime&quot;</span>, origtime, <span class="stringliteral">&quot;category&quot;</span>, category, <span class="stringliteral">&quot;duration&quot;</span>, duration, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l03820"></a>03820    }
<a name="l03821"></a>03821    <a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a>(frompath2, topath2);
<a name="l03822"></a>03822    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l03823"></a>03823 }
<a name="l03824"></a>03824 <span class="preprocessor">#endif</span>
<a name="l03825"></a>03825 <span class="preprocessor"></span><span class="comment"></span>
<a name="l03826"></a>03826 <span class="comment">/*! </span>
<a name="l03827"></a>03827 <span class="comment"> * \brief Removes the voicemail sound and information file.</span>
<a name="l03828"></a>03828 <span class="comment"> * \param file The path to the sound file. This will be the the folder and message index, without the extension.</span>
<a name="l03829"></a>03829 <span class="comment"> *</span>
<a name="l03830"></a>03830 <span class="comment"> * This is used by the DELETE macro when voicemails are stored on the file system.</span>
<a name="l03831"></a>03831 <span class="comment"> *</span>
<a name="l03832"></a>03832 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l03833"></a>03833 <span class="comment"> */</span>
<a name="l03834"></a><a class="code" href="app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e">03834</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e" title="Removes the voicemail sound and information file.">vm_delete</a>(<span class="keywordtype">char</span> *file)
<a name="l03835"></a>03835 {
<a name="l03836"></a>03836    <span class="keywordtype">char</span> *txt;
<a name="l03837"></a>03837    <span class="keywordtype">int</span> txtsize = 0;
<a name="l03838"></a>03838 
<a name="l03839"></a>03839    txtsize = (strlen(file) + 5)*<span class="keyword">sizeof</span>(<span class="keywordtype">char</span>);
<a name="l03840"></a>03840    txt = alloca(txtsize);
<a name="l03841"></a>03841    <span class="comment">/* Sprintf here would safe because we alloca&apos;d exactly the right length,</span>
<a name="l03842"></a>03842 <span class="comment">    * but trying to eliminate all sprintf&apos;s anyhow</span>
<a name="l03843"></a>03843 <span class="comment">    */</span>
<a name="l03844"></a>03844    <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l03845"></a>03845       <a class="code" href="config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3" title="Destroy realtime configuration.">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, file, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l03846"></a>03846    }
<a name="l03847"></a>03847    snprintf(txt, txtsize, <span class="stringliteral">&quot;%s.txt&quot;</span>, file);
<a name="l03848"></a>03848    unlink(txt);
<a name="l03849"></a>03849    <span class="keywordflow">return</span> <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(file, NULL);
<a name="l03850"></a>03850 }
<a name="l03851"></a>03851 <span class="comment"></span>
<a name="l03852"></a>03852 <span class="comment">/*!</span>
<a name="l03853"></a>03853 <span class="comment"> * \brief utility used by inchar(), for base_encode()</span>
<a name="l03854"></a>03854 <span class="comment"> */</span>
<a name="l03855"></a><a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86">03855</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a>(<span class="keyword">struct</span> <a class="code" href="structbaseio.html">baseio</a> *bio, FILE *fi)
<a name="l03856"></a>03856 {
<a name="l03857"></a>03857    <span class="keywordtype">int</span> l;
<a name="l03858"></a>03858 
<a name="l03859"></a>03859    <span class="keywordflow">if</span> (bio-&gt;<a class="code" href="structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">ateof</a>)
<a name="l03860"></a>03860       <span class="keywordflow">return</span> 0;
<a name="l03861"></a>03861 
<a name="l03862"></a>03862    <span class="keywordflow">if</span> ((l = fread(bio-&gt;<a class="code" href="structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">iobuf</a>,1,<a class="code" href="app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>,fi)) &lt;= 0) {
<a name="l03863"></a>03863       <span class="keywordflow">if</span> (ferror(fi))
<a name="l03864"></a>03864          <span class="keywordflow">return</span> -1;
<a name="l03865"></a>03865 
<a name="l03866"></a>03866       bio-&gt;<a class="code" href="structbaseio.html#aa3cbb055ee45b46498457488c3df39d8">ateof</a> = 1;
<a name="l03867"></a>03867       <span class="keywordflow">return</span> 0;
<a name="l03868"></a>03868    }
<a name="l03869"></a>03869 
<a name="l03870"></a>03870    bio-&gt;<a class="code" href="structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">iolen</a>= l;
<a name="l03871"></a>03871    bio-&gt;<a class="code" href="structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a>= 0;
<a name="l03872"></a>03872 
<a name="l03873"></a>03873    <span class="keywordflow">return</span> 1;
<a name="l03874"></a>03874 }
<a name="l03875"></a>03875 <span class="comment"></span>
<a name="l03876"></a>03876 <span class="comment">/*!</span>
<a name="l03877"></a>03877 <span class="comment"> * \brief utility used by base_encode()</span>
<a name="l03878"></a>03878 <span class="comment"> */</span>
<a name="l03879"></a><a class="code" href="app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e">03879</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e" title="utility used by base_encode()">inchar</a>(<span class="keyword">struct</span> <a class="code" href="structbaseio.html">baseio</a> *bio, FILE *fi)
<a name="l03880"></a>03880 {
<a name="l03881"></a>03881    <span class="keywordflow">if</span> (bio-&gt;<a class="code" href="structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a>&gt;=bio-&gt;<a class="code" href="structbaseio.html#a3e47346bcad694f3bfc4099f56531cee">iolen</a>) {
<a name="l03882"></a>03882       <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#ac70fbae4ed48b5b48ff4b49f01e29f86" title="utility used by inchar(), for base_encode()">inbuf</a>(bio, fi))
<a name="l03883"></a>03883          <span class="keywordflow">return</span> EOF;
<a name="l03884"></a>03884    }
<a name="l03885"></a>03885 
<a name="l03886"></a>03886    <span class="keywordflow">return</span> bio-&gt;<a class="code" href="structbaseio.html#a4c937bd693e91661c05e41cfe0cf7fe3">iobuf</a>[bio-&gt;<a class="code" href="structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a>++];
<a name="l03887"></a>03887 }
<a name="l03888"></a>03888 <span class="comment"></span>
<a name="l03889"></a>03889 <span class="comment">/*!</span>
<a name="l03890"></a>03890 <span class="comment"> * \brief utility used by base_encode()</span>
<a name="l03891"></a>03891 <span class="comment"> */</span>
<a name="l03892"></a><a class="code" href="app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa">03892</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa" title="utility used by base_encode()">ochar</a>(<span class="keyword">struct</span> <a class="code" href="structbaseio.html">baseio</a> *bio, <span class="keywordtype">int</span> c, FILE *so)
<a name="l03893"></a>03893 {
<a name="l03894"></a>03894    <span class="keywordflow">if</span> (bio-&gt;<a class="code" href="structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a> &gt;= <a class="code" href="app__voicemail_8c.html#a1e31aa9d6eb3fa3e9287e3f3c3c16969">BASELINELEN</a>) {
<a name="l03895"></a>03895       <span class="keywordflow">if</span> (fputs(<a class="code" href="app__voicemail_8c.html#a55b81f273444186ad83e1087f9a3706d">eol</a>,so) == EOF)
<a name="l03896"></a>03896          <span class="keywordflow">return</span> -1;
<a name="l03897"></a>03897 
<a name="l03898"></a>03898       bio-&gt;<a class="code" href="structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a>= 0;
<a name="l03899"></a>03899    }
<a name="l03900"></a>03900 
<a name="l03901"></a>03901    <span class="keywordflow">if</span> (putc(((<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>)c),so) == EOF)
<a name="l03902"></a>03902       <span class="keywordflow">return</span> -1;
<a name="l03903"></a>03903 
<a name="l03904"></a>03904    bio-&gt;<a class="code" href="structbaseio.html#a4cd390d771f962d39585708c848317e5">linelength</a>++;
<a name="l03905"></a>03905 
<a name="l03906"></a>03906    <span class="keywordflow">return</span> 1;
<a name="l03907"></a>03907 }
<a name="l03908"></a>03908 <span class="comment"></span>
<a name="l03909"></a>03909 <span class="comment">/*!</span>
<a name="l03910"></a>03910 <span class="comment"> * \brief Performs a base 64 encode algorithm on the contents of a File</span>
<a name="l03911"></a>03911 <span class="comment"> * \param filename The path to the file to be encoded. Must be readable, file is opened in read mode.</span>
<a name="l03912"></a>03912 <span class="comment"> * \param so A FILE handle to the output file to receive the base 64 encoded contents of the input file, identified by filename.</span>
<a name="l03913"></a>03913 <span class="comment"> *</span>
<a name="l03914"></a>03914 <span class="comment"> * TODO: shouldn&apos;t this (and the above 3 support functions) be put into some kind of external utility location, such as funcs/func_base64.c ?</span>
<a name="l03915"></a>03915 <span class="comment"> *</span>
<a name="l03916"></a>03916 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l03917"></a>03917 <span class="comment"> */</span>
<a name="l03918"></a><a class="code" href="app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17">03918</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17" title="Performs a base 64 encode algorithm on the contents of a File.">base_encode</a>(<span class="keywordtype">char</span> *filename, FILE *so)
<a name="l03919"></a>03919 {
<a name="l03920"></a>03920    <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dtable[] = { <span class="charliteral">&apos;A&apos;</span>, <span class="charliteral">&apos;B&apos;</span>, <span class="charliteral">&apos;C&apos;</span>, <span class="charliteral">&apos;D&apos;</span>, <span class="charliteral">&apos;E&apos;</span>, <span class="charliteral">&apos;F&apos;</span>, <span class="charliteral">&apos;G&apos;</span>, <span class="charliteral">&apos;H&apos;</span>, <span class="charliteral">&apos;I&apos;</span>, <span class="charliteral">&apos;J&apos;</span>, <span class="charliteral">&apos;K&apos;</span>,
<a name="l03921"></a>03921       <span class="charliteral">&apos;L&apos;</span>, <span class="charliteral">&apos;M&apos;</span>, <span class="charliteral">&apos;N&apos;</span>, <span class="charliteral">&apos;O&apos;</span>, <span class="charliteral">&apos;P&apos;</span>, <span class="charliteral">&apos;Q&apos;</span>, <span class="charliteral">&apos;R&apos;</span>, <span class="charliteral">&apos;S&apos;</span>, <span class="charliteral">&apos;T&apos;</span>, <span class="charliteral">&apos;U&apos;</span>, <span class="charliteral">&apos;V&apos;</span>, <span class="charliteral">&apos;W&apos;</span>, <span class="charliteral">&apos;X&apos;</span>, <span class="charliteral">&apos;Y&apos;</span>, <span class="charliteral">&apos;Z&apos;</span>, <span class="charliteral">&apos;a&apos;</span>, <span class="charliteral">&apos;b&apos;</span>, <span class="charliteral">&apos;c&apos;</span>, <span class="charliteral">&apos;d&apos;</span>, <span class="charliteral">&apos;e&apos;</span>, <span class="charliteral">&apos;f&apos;</span>,
<a name="l03922"></a>03922       <span class="charliteral">&apos;g&apos;</span>, <span class="charliteral">&apos;h&apos;</span>, <span class="charliteral">&apos;i&apos;</span>, <span class="charliteral">&apos;j&apos;</span>, <span class="charliteral">&apos;k&apos;</span>, <span class="charliteral">&apos;l&apos;</span>, <span class="charliteral">&apos;m&apos;</span>, <span class="charliteral">&apos;n&apos;</span>, <span class="charliteral">&apos;o&apos;</span>, <span class="charliteral">&apos;p&apos;</span>, <span class="charliteral">&apos;q&apos;</span>, <span class="charliteral">&apos;r&apos;</span>, <span class="charliteral">&apos;s&apos;</span>, <span class="charliteral">&apos;t&apos;</span>, <span class="charliteral">&apos;u&apos;</span>, <span class="charliteral">&apos;v&apos;</span>, <span class="charliteral">&apos;w&apos;</span>, <span class="charliteral">&apos;x&apos;</span>, <span class="charliteral">&apos;y&apos;</span>, <span class="charliteral">&apos;z&apos;</span>, <span class="charliteral">&apos;0&apos;</span>,
<a name="l03923"></a>03923       <span class="charliteral">&apos;1&apos;</span>, <span class="charliteral">&apos;2&apos;</span>, <span class="charliteral">&apos;3&apos;</span>, <span class="charliteral">&apos;4&apos;</span>, <span class="charliteral">&apos;5&apos;</span>, <span class="charliteral">&apos;6&apos;</span>, <span class="charliteral">&apos;7&apos;</span>, <span class="charliteral">&apos;8&apos;</span>, <span class="charliteral">&apos;9&apos;</span>, <span class="charliteral">&apos;+&apos;</span>, <span class="charliteral">&apos;/&apos;</span>};
<a name="l03924"></a>03924    <span class="keywordtype">int</span> i,hiteof= 0;
<a name="l03925"></a>03925    FILE *fi;
<a name="l03926"></a>03926    <span class="keyword">struct </span><a class="code" href="structbaseio.html">baseio</a> bio;
<a name="l03927"></a>03927 
<a name="l03928"></a>03928    memset(&amp;bio, 0, <span class="keyword">sizeof</span>(bio));
<a name="l03929"></a>03929    bio.<a class="code" href="structbaseio.html#aaa24cfd3a54978c05a8d852aa7e77ec5">iocp</a> = <a class="code" href="app__voicemail_8c.html#a8aaeb2a0ce8bd9fc6543ba7547ea2cfd">BASEMAXINLINE</a>;
<a name="l03930"></a>03930 
<a name="l03931"></a>03931    <span class="keywordflow">if</span> (!(fi = fopen(filename, <span class="stringliteral">&quot;rb&quot;</span>))) {
<a name="l03932"></a>03932       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to open file: %s: %s\n&quot;</span>, filename, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03933"></a>03933       <span class="keywordflow">return</span> -1;
<a name="l03934"></a>03934    }
<a name="l03935"></a>03935 
<a name="l03936"></a>03936    <span class="keywordflow">while</span> (!hiteof){
<a name="l03937"></a>03937       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> igroup[3], ogroup[4];
<a name="l03938"></a>03938       <span class="keywordtype">int</span> c,n;
<a name="l03939"></a>03939 
<a name="l03940"></a>03940       igroup[0]= igroup[1]= igroup[2]= 0;
<a name="l03941"></a>03941 
<a name="l03942"></a>03942       <span class="keywordflow">for</span> (n= 0;n&lt;3;n++) {
<a name="l03943"></a>03943          <span class="keywordflow">if</span> ((c = <a class="code" href="app__voicemail_8c.html#a5b0be371bf94a4de90d8daff733c0d2e" title="utility used by base_encode()">inchar</a>(&amp;bio, fi)) == EOF) {
<a name="l03944"></a>03944             hiteof= 1;
<a name="l03945"></a>03945             <span class="keywordflow">break</span>;
<a name="l03946"></a>03946          }
<a name="l03947"></a>03947 
<a name="l03948"></a>03948          igroup[n]= (<span class="keywordtype">unsigned</span> char)c;
<a name="l03949"></a>03949       }
<a name="l03950"></a>03950 
<a name="l03951"></a>03951       <span class="keywordflow">if</span> (n&gt; 0) {
<a name="l03952"></a>03952          ogroup[0]= dtable[igroup[0]&gt;&gt;2];
<a name="l03953"></a>03953          ogroup[1]= dtable[((igroup[0]&amp;3)&lt;&lt;4) | (igroup[1]&gt;&gt;4)];
<a name="l03954"></a>03954          ogroup[2]= dtable[((igroup[1]&amp;0xF)&lt;&lt;2) | (igroup[2]&gt;&gt;6)];
<a name="l03955"></a>03955          ogroup[3]= dtable[igroup[2]&amp;0x3F];
<a name="l03956"></a>03956 
<a name="l03957"></a>03957          <span class="keywordflow">if</span> (n&lt;3) {
<a name="l03958"></a>03958             ogroup[3]= <span class="charliteral">&apos;=&apos;</span>;
<a name="l03959"></a>03959 
<a name="l03960"></a>03960             <span class="keywordflow">if</span> (n&lt;2)
<a name="l03961"></a>03961                ogroup[2]= <span class="charliteral">&apos;=&apos;</span>;
<a name="l03962"></a>03962          }
<a name="l03963"></a>03963 
<a name="l03964"></a>03964          <span class="keywordflow">for</span> (i= 0;i&lt;4;i++)
<a name="l03965"></a>03965             <a class="code" href="app__voicemail_8c.html#a1dcb0c236f2228fe4e16002f44afecaa" title="utility used by base_encode()">ochar</a>(&amp;bio, ogroup[i], so);
<a name="l03966"></a>03966       }
<a name="l03967"></a>03967    }
<a name="l03968"></a>03968 
<a name="l03969"></a>03969    fclose(fi);
<a name="l03970"></a>03970    
<a name="l03971"></a>03971    <span class="keywordflow">if</span> (fputs(<a class="code" href="app__voicemail_8c.html#a55b81f273444186ad83e1087f9a3706d">eol</a>,so)==EOF)
<a name="l03972"></a>03972       <span class="keywordflow">return</span> 0;
<a name="l03973"></a>03973 
<a name="l03974"></a>03974    <span class="keywordflow">return</span> 1;
<a name="l03975"></a>03975 }
<a name="l03976"></a>03976 
<a name="l03977"></a><a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">03977</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">char</span> *dur, <span class="keywordtype">char</span> *date, <span class="keywordtype">char</span> *passdata, <span class="keywordtype">size_t</span> passdatasize, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l03978"></a>03978 {
<a name="l03979"></a>03979    <span class="keywordtype">char</span> callerid[256];
<a name="l03980"></a>03980    <span class="keywordtype">char</span> fromdir[256], fromfile[256];
<a name="l03981"></a>03981    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *msg_cfg;
<a name="l03982"></a>03982    <span class="keyword">const</span> <span class="keywordtype">char</span> *origcallerid, *origtime;
<a name="l03983"></a>03983    <span class="keywordtype">char</span> origcidname[80], origcidnum[80], origdate[80];
<a name="l03984"></a>03984    <span class="keywordtype">int</span> inttime;
<a name="l03985"></a>03985    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26a3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };
<a name="l03986"></a>03986 
<a name="l03987"></a>03987    <span class="comment">/* Prepare variables for substitution in email body and subject */</span>
<a name="l03988"></a>03988    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_NAME&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>);
<a name="l03989"></a>03989    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_DUR&quot;</span>, dur);
<a name="l03990"></a>03990    snprintf(passdata, passdatasize, <span class="stringliteral">&quot;%d&quot;</span>, msgnum);
<a name="l03991"></a>03991    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_MSGNUM&quot;</span>, passdata);
<a name="l03992"></a>03992    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CONTEXT&quot;</span>, context);
<a name="l03993"></a>03993    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_MAILBOX&quot;</span>, mailbox);
<a name="l03994"></a>03994    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CALLERID&quot;</span>, (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidname) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidnum)) ?
<a name="l03995"></a>03995       <a class="code" href="callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(callerid, <span class="keyword">sizeof</span>(callerid), cidname, cidnum, NULL) : <span class="stringliteral">&quot;an unknown caller&quot;</span>);
<a name="l03996"></a>03996    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CIDNAME&quot;</span>, (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidname) ? cidname : <span class="stringliteral">&quot;an unknown caller&quot;</span>));
<a name="l03997"></a>03997    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CIDNUM&quot;</span>, (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidnum) ? cidnum : <span class="stringliteral">&quot;an unknown caller&quot;</span>));
<a name="l03998"></a>03998    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_DATE&quot;</span>, date);
<a name="l03999"></a>03999    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_CATEGORY&quot;</span>, category ? <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(category) : <span class="stringliteral">&quot;no category&quot;</span>);
<a name="l04000"></a>04000    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;VM_FLAG&quot;</span>, flag);
<a name="l04001"></a>04001 
<a name="l04002"></a>04002    <span class="comment">/* Retrieve info from VM attribute file */</span>
<a name="l04003"></a>04003    <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(fromdir, <span class="keyword">sizeof</span>(fromdir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, fromfolder);
<a name="l04004"></a>04004    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fromfile, <span class="keyword">sizeof</span>(fromfile), fromdir, msgnum - 1);
<a name="l04005"></a>04005    <span class="keywordflow">if</span> (strlen(fromfile) &lt; <span class="keyword">sizeof</span>(fromfile) - 5) {
<a name="l04006"></a>04006       strcat(fromfile, <span class="stringliteral">&quot;.txt&quot;</span>);
<a name="l04007"></a>04007    }
<a name="l04008"></a>04008    <span class="keywordflow">if</span> (!(msg_cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(fromfile, config_flags))) {
<a name="l04009"></a>04009       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 0) {
<a name="l04010"></a>04010          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Config load for message text file &apos;%s&apos; failed\n&quot;</span>, fromfile);
<a name="l04011"></a>04011       }
<a name="l04012"></a>04012       <span class="keywordflow">return</span>;
<a name="l04013"></a>04013    }
<a name="l04014"></a>04014 
<a name="l04015"></a>04015    <span class="keywordflow">if</span> ((origcallerid = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {
<a name="l04016"></a>04016       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_CALLERID&quot;</span>, origcallerid);
<a name="l04017"></a>04017       <a class="code" href="callerid_8h.html#af33ee38631fe79ab21d91bcd0634903a">ast_callerid_split</a>(origcallerid, origcidname, <span class="keyword">sizeof</span>(origcidname), origcidnum, <span class="keyword">sizeof</span>(origcidnum));
<a name="l04018"></a>04018       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_CIDNAME&quot;</span>, origcidname);
<a name="l04019"></a>04019       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_CIDNUM&quot;</span>, origcidnum);
<a name="l04020"></a>04020    }
<a name="l04021"></a>04021 
<a name="l04022"></a>04022    <span class="keywordflow">if</span> ((origtime = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>)) &amp;&amp; sscanf(origtime, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;inttime) == 1) {
<a name="l04023"></a>04023       <span class="keyword">struct </span>timeval tv = { inttime, };
<a name="l04024"></a>04024       <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l04025"></a>04025       <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;tv, &amp;tm, NULL);
<a name="l04026"></a>04026       <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(origdate, <span class="keyword">sizeof</span>(origdate), <a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>, &amp;tm);
<a name="l04027"></a>04027       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ast, <span class="stringliteral">&quot;ORIG_VM_DATE&quot;</span>, origdate);
<a name="l04028"></a>04028    }
<a name="l04029"></a>04029    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l04030"></a>04030 }
<a name="l04031"></a>04031 <span class="comment"></span>
<a name="l04032"></a>04032 <span class="comment">/*!</span>
<a name="l04033"></a>04033 <span class="comment"> * \brief Wraps a character sequence in double quotes, escaping occurences of quotes within the string.</span>
<a name="l04034"></a>04034 <span class="comment"> * \param from The string to work with.</span>
<a name="l04035"></a>04035 <span class="comment"> * \param to The string to write the modified quoted string. This buffer should be sufficiently larger than the from string, so as to allow it to be expanded by the surrounding quotes and escaping of internal quotes.</span>
<a name="l04036"></a>04036 <span class="comment"> * </span>
<a name="l04037"></a>04037 <span class="comment"> * \return The destination string with quotes wrapped on it (the to field).</span>
<a name="l04038"></a>04038 <span class="comment"> */</span>
<a name="l04039"></a><a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f">04039</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *from, <span class="keywordtype">char</span> *to, <span class="keywordtype">size_t</span> len)
<a name="l04040"></a>04040 {
<a name="l04041"></a>04041    <span class="keywordtype">char</span> *ptr = to;
<a name="l04042"></a>04042    *ptr++ = <span class="charliteral">&apos;&quot;&apos;</span>;
<a name="l04043"></a>04043    <span class="keywordflow">for</span> (; ptr &lt; to + len - 1; from++) {
<a name="l04044"></a>04044       <span class="keywordflow">if</span> (*from == <span class="charliteral">&apos;&quot;&apos;</span>)
<a name="l04045"></a>04045          *ptr++ = <span class="charliteral">&apos;\\&apos;</span>;
<a name="l04046"></a>04046       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*from == <span class="charliteral">&apos;\0&apos;</span>)
<a name="l04047"></a>04047          <span class="keywordflow">break</span>;
<a name="l04048"></a>04048       *ptr++ = *from;
<a name="l04049"></a>04049    }
<a name="l04050"></a>04050    <span class="keywordflow">if</span> (ptr &lt; to + len - 1)
<a name="l04051"></a>04051       *ptr++ = <span class="charliteral">&apos;&quot;&apos;</span>;
<a name="l04052"></a>04052    *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04053"></a>04053    <span class="keywordflow">return</span> to;
<a name="l04054"></a>04054 }
<a name="l04055"></a>04055 <span class="comment"></span>
<a name="l04056"></a>04056 <span class="comment">/*! \brief</span>
<a name="l04057"></a>04057 <span class="comment"> * fill in *tm for current time according to the proper timezone, if any.</span>
<a name="l04058"></a>04058 <span class="comment"> * Return tm so it can be used as a function argument.</span>
<a name="l04059"></a>04059 <span class="comment"> */</span>
<a name="l04060"></a><a class="code" href="app__voicemail_8c.html#ad177a58ec2a39d04903d16f5b7ca0e4b">04060</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> *<a class="code" href="app__voicemail_8c.html#ad177a58ec2a39d04903d16f5b7ca0e4b" title="fill in *tm for current time according to the proper timezone, if any. Return tm...">vmu_tm</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structast__tm.html">ast_tm</a> *tm)
<a name="l04061"></a>04061 {
<a name="l04062"></a>04062    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structvm__zone.html">vm_zone</a> *z = NULL;
<a name="l04063"></a>04063    <span class="keyword">struct </span>timeval t = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l04064"></a>04064 
<a name="l04065"></a>04065    <span class="comment">/* Does this user have a timezone specified? */</span>
<a name="l04066"></a>04066    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>)) {
<a name="l04067"></a>04067       <span class="comment">/* Find the zone in the list */</span>
<a name="l04068"></a>04068       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;zones);
<a name="l04069"></a>04069       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;zones, z, list) {
<a name="l04070"></a>04070          <span class="keywordflow">if</span> (!strcmp(z-&gt;name, vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>))
<a name="l04071"></a>04071             <span class="keywordflow">break</span>;
<a name="l04072"></a>04072       }
<a name="l04073"></a>04073       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;zones);
<a name="l04074"></a>04074    }
<a name="l04075"></a>04075    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;t, tm, z ? z-&gt;timezone : NULL);
<a name="l04076"></a>04076    <span class="keywordflow">return</span> tm;
<a name="l04077"></a>04077 }
<a name="l04078"></a>04078 <span class="comment"></span>
<a name="l04079"></a>04079 <span class="comment">/*!\brief Check if the string would need encoding within the MIME standard, to</span>
<a name="l04080"></a>04080 <span class="comment"> * avoid confusing certain mail software that expects messages to be 7-bit</span>
<a name="l04081"></a>04081 <span class="comment"> * clean.</span>
<a name="l04082"></a>04082 <span class="comment"> */</span>
<a name="l04083"></a><a class="code" href="app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb">04083</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb" title="Check if the string would need encoding within the MIME standard, to avoid confusing...">check_mime</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *str)
<a name="l04084"></a>04084 {
<a name="l04085"></a>04085    <span class="keywordflow">for</span> (; *str; str++) {
<a name="l04086"></a>04086       <span class="keywordflow">if</span> (*str &gt; 126 || *str &lt; 32 || strchr(<span class="stringliteral">&quot;()&lt;&gt;@,:;/\&quot;[]?.=&quot;</span>, *str)) {
<a name="l04087"></a>04087          <span class="keywordflow">return</span> 1;
<a name="l04088"></a>04088       }
<a name="l04089"></a>04089    }
<a name="l04090"></a>04090    <span class="keywordflow">return</span> 0;
<a name="l04091"></a>04091 }
<a name="l04092"></a>04092 <span class="comment"></span>
<a name="l04093"></a>04093 <span class="comment">/*!\brief Encode a string according to the MIME rules for encoding strings</span>
<a name="l04094"></a>04094 <span class="comment"> * that are not 7-bit clean or contain control characters.</span>
<a name="l04095"></a>04095 <span class="comment"> *</span>
<a name="l04096"></a>04096 <span class="comment"> * Additionally, if the encoded string would exceed the MIME limit of 76</span>
<a name="l04097"></a>04097 <span class="comment"> * characters per line, then the encoding will be broken up into multiple</span>
<a name="l04098"></a>04098 <span class="comment"> * sections, separated by a space character, in order to facilitate</span>
<a name="l04099"></a>04099 <span class="comment"> * breaking up the associated header across multiple lines.</span>
<a name="l04100"></a>04100 <span class="comment"> *</span>
<a name="l04101"></a>04101 <span class="comment"> * \param start A string to be encoded</span>
<a name="l04102"></a>04102 <span class="comment"> * \param end An expandable buffer for holding the result</span>
<a name="l04103"></a>04103 <span class="comment"> * \param preamble The length of the first line already used for this string,</span>
<a name="l04104"></a>04104 <span class="comment"> * to ensure that each line maintains a maximum length of 76 chars.</span>
<a name="l04105"></a>04105 <span class="comment"> * \param postamble the length of any additional characters appended to the</span>
<a name="l04106"></a>04106 <span class="comment"> * line, used to ensure proper field wrapping.</span>
<a name="l04107"></a>04107 <span class="comment"> * \retval The encoded string.</span>
<a name="l04108"></a>04108 <span class="comment"> */</span>
<a name="l04109"></a><a class="code" href="app__voicemail_8c.html#ad5ac80585ea7e740734bf3d33dd80471">04109</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ad5ac80585ea7e740734bf3d33dd80471" title="Encode a string according to the MIME rules for encoding strings that are not 7-bit...">encode_mime_str</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *start, <span class="keywordtype">char</span> *end, <span class="keywordtype">size_t</span> endsize, <span class="keywordtype">size_t</span> preamble, <span class="keywordtype">size_t</span> postamble)
<a name="l04110"></a>04110 {
<a name="l04111"></a>04111    <span class="keywordtype">char</span> tmp[80];
<a name="l04112"></a>04112    <span class="keywordtype">int</span> first_section = 1;
<a name="l04113"></a>04113    <span class="keywordtype">size_t</span> endlen = 0, tmplen = 0;
<a name="l04114"></a>04114    *end = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04115"></a>04115 
<a name="l04116"></a>04116    tmplen = snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;=?%s?Q?&quot;</span>, <a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>);
<a name="l04117"></a>04117    <span class="keywordflow">for</span> (; *start; start++) {
<a name="l04118"></a>04118       <span class="keywordtype">int</span> need_encoding = 0;
<a name="l04119"></a>04119       <span class="keywordflow">if</span> (*start &lt; 33 || *start &gt; 126 || strchr(<span class="stringliteral">&quot;()&lt;&gt;@,:;/\&quot;[]?.=_&quot;</span>, *start)) {
<a name="l04120"></a>04120          need_encoding = 1;
<a name="l04121"></a>04121       }
<a name="l04122"></a>04122       <span class="keywordflow">if</span> ((first_section &amp;&amp; need_encoding &amp;&amp; preamble + tmplen &gt; 70) ||
<a name="l04123"></a>04123          (first_section &amp;&amp; !need_encoding &amp;&amp; preamble + tmplen &gt; 72) ||
<a name="l04124"></a>04124          (!first_section &amp;&amp; need_encoding &amp;&amp; tmplen &gt; 70) ||
<a name="l04125"></a>04125          (!first_section &amp;&amp; !need_encoding &amp;&amp; tmplen &gt; 72)) {
<a name="l04126"></a>04126          <span class="comment">/* Start new line */</span>
<a name="l04127"></a>04127          endlen += snprintf(end + endlen, endsize - endlen, <span class="stringliteral">&quot;%s%s?=&quot;</span>, first_section ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; &quot;</span>, tmp);
<a name="l04128"></a>04128          tmplen = snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;=?%s?Q?&quot;</span>, <a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>);
<a name="l04129"></a>04129          first_section = 0;
<a name="l04130"></a>04130       }
<a name="l04131"></a>04131       <span class="keywordflow">if</span> (need_encoding &amp;&amp; *start == <span class="charliteral">&apos; &apos;</span>) {
<a name="l04132"></a>04132          tmplen += snprintf(tmp + tmplen, <span class="keyword">sizeof</span>(tmp) - tmplen, <span class="stringliteral">&quot;_&quot;</span>);
<a name="l04133"></a>04133       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (need_encoding) {
<a name="l04134"></a>04134          tmplen += snprintf(tmp + tmplen, <span class="keyword">sizeof</span>(tmp) - tmplen, <span class="stringliteral">&quot;=%hhX&quot;</span>, *start);
<a name="l04135"></a>04135       } <span class="keywordflow">else</span> {
<a name="l04136"></a>04136          tmplen += snprintf(tmp + tmplen, <span class="keyword">sizeof</span>(tmp) - tmplen, <span class="stringliteral">&quot;%c&quot;</span>, *start);
<a name="l04137"></a>04137       }
<a name="l04138"></a>04138    }
<a name="l04139"></a>04139    snprintf(end + endlen, endsize - endlen, <span class="stringliteral">&quot;%s%s?=%s&quot;</span>, first_section ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot; &quot;</span>, tmp, endlen + postamble &gt; 74 ? <span class="stringliteral">&quot; &quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l04140"></a>04140    <span class="keywordflow">return</span> end;
<a name="l04141"></a>04141 }
<a name="l04142"></a>04142 <span class="comment"></span>
<a name="l04143"></a>04143 <span class="comment">/*!</span>
<a name="l04144"></a>04144 <span class="comment"> * \brief Creates the email file to be sent to indicate a new voicemail exists for a user.</span>
<a name="l04145"></a>04145 <span class="comment"> * \param p The output file to generate the email contents into.</span>
<a name="l04146"></a>04146 <span class="comment"> * \param srcemail The email address to send the email to, presumably the email address for the owner of the mailbox.</span>
<a name="l04147"></a>04147 <span class="comment"> * \param vmu The voicemail user who is sending the voicemail.</span>
<a name="l04148"></a>04148 <span class="comment"> * \param msgnum The message index in the mailbox folder.</span>
<a name="l04149"></a>04149 <span class="comment"> * \param context </span>
<a name="l04150"></a>04150 <span class="comment"> * \param mailbox The voicemail box to read the voicemail to be notified in this email.</span>
<a name="l04151"></a>04151 <span class="comment"> * \param cidnum The caller ID number.</span>
<a name="l04152"></a>04152 <span class="comment"> * \param cidname The caller ID name.</span>
<a name="l04153"></a>04153 <span class="comment"> * \param attach the name of the sound file to be attached to the email, if attach_user_voicemail == 1.</span>
<a name="l04154"></a>04154 <span class="comment"> * \param format The message sound file format. i.e. .wav</span>
<a name="l04155"></a>04155 <span class="comment"> * \param duration The time of the message content, in seconds.</span>
<a name="l04156"></a>04156 <span class="comment"> * \param attach_user_voicemail if 1, the sound file is attached to the email.</span>
<a name="l04157"></a>04157 <span class="comment"> * \param chan</span>
<a name="l04158"></a>04158 <span class="comment"> * \param category</span>
<a name="l04159"></a>04159 <span class="comment"> * \param imap if == 1, indicates the target folder for the email notification to be sent to will be an IMAP mailstore. This causes additional mailbox headers to be set, which would facilitate searching for the email in the destination IMAP folder.</span>
<a name="l04160"></a>04160 <span class="comment"> *</span>
<a name="l04161"></a>04161 <span class="comment"> * The email body, and base 64 encoded attachement (if any) are stored to the file identified by *p. This method does not actually send the email.  That is done by invoking the configure &apos;mailcmd&apos; and piping this generated file into it, or with the sendemail() function.</span>
<a name="l04162"></a>04162 <span class="comment"> */</span>
<a name="l04163"></a><a class="code" href="app__voicemail_8c.html#ae3cbc800cf1d17d77a43c57a6015a4f2">04163</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#ae3cbc800cf1d17d77a43c57a6015a4f2" title="Creates the email file to be sent to indicate a new voicemail exists for a user.">make_email_file</a>(FILE *p, <span class="keywordtype">char</span> *srcemail, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *attach2, <span class="keywordtype">char</span> *format, <span class="keywordtype">int</span> duration, <span class="keywordtype">int</span> attach_user_voicemail, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keywordtype">int</span> imap, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l04164"></a>04164 {
<a name="l04165"></a>04165    <span class="keywordtype">char</span> date[256];
<a name="l04166"></a>04166    <span class="keywordtype">char</span> host[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04167"></a>04167    <span class="keywordtype">char</span> who[256];
<a name="l04168"></a>04168    <span class="keywordtype">char</span> bound[256];
<a name="l04169"></a>04169    <span class="keywordtype">char</span> dur[256];
<a name="l04170"></a>04170    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l04171"></a>04171    <span class="keywordtype">char</span> enc_cidnum[256] = <span class="stringliteral">&quot;&quot;</span>, enc_cidname[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04172"></a>04172    <span class="keywordtype">char</span> *passdata = NULL, *passdata2;
<a name="l04173"></a>04173    <span class="keywordtype">size_t</span> len_passdata = 0, len_passdata2, tmplen;
<a name="l04174"></a>04174    <span class="keywordtype">char</span> *greeting_attachment; 
<a name="l04175"></a>04175    <span class="keywordtype">char</span> filename[256];
<a name="l04176"></a>04176 
<a name="l04177"></a>04177 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l04178"></a>04178 <span class="preprocessor"></span><span class="preprocessor">#define ENDL &quot;\r\n&quot;</span>
<a name="l04179"></a>04179 <span class="preprocessor"></span><span class="preprocessor">#else</span>
<a name="l04180"></a>04180 <span class="preprocessor"></span><span class="preprocessor">#define ENDL &quot;\n&quot;</span>
<a name="l04181"></a>04181 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l04182"></a>04182 <span class="preprocessor"></span>
<a name="l04183"></a>04183    <span class="comment">/* One alloca for multiple fields */</span>
<a name="l04184"></a>04184    len_passdata2 = strlen(vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>);
<a name="l04185"></a>04185    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> &amp;&amp; (tmplen = strlen(<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>)) &gt; len_passdata2) {
<a name="l04186"></a>04186       len_passdata2 = tmplen;
<a name="l04187"></a>04187    }
<a name="l04188"></a>04188    <span class="keywordflow">if</span> ((tmplen = strlen(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>)) &gt; len_passdata2) {
<a name="l04189"></a>04189       len_passdata2 = tmplen;
<a name="l04190"></a>04190    }
<a name="l04191"></a>04191    len_passdata2 = len_passdata2 * 3 + 200;
<a name="l04192"></a>04192    passdata2 = alloca(len_passdata2);
<a name="l04193"></a>04193 
<a name="l04194"></a>04194    <span class="keywordflow">if</span> (cidnum) {
<a name="l04195"></a>04195       <a class="code" href="app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c" title="Strips control and non 7-bit clean characters from input string.">strip_control_and_high</a>(cidnum, enc_cidnum, <span class="keyword">sizeof</span>(enc_cidnum));
<a name="l04196"></a>04196    }
<a name="l04197"></a>04197    <span class="keywordflow">if</span> (cidname) {
<a name="l04198"></a>04198       <a class="code" href="app__voicemail_8c.html#a5ff423fdf598de1c23b18626a2b20c3c" title="Strips control and non 7-bit clean characters from input string.">strip_control_and_high</a>(cidname, enc_cidname, <span class="keyword">sizeof</span>(enc_cidname));
<a name="l04199"></a>04199    }
<a name="l04200"></a>04200    gethostname(host, <span class="keyword">sizeof</span>(host) - 1);
<a name="l04201"></a>04201 
<a name="l04202"></a>04202    <span class="keywordflow">if</span> (strchr(srcemail, <span class="charliteral">&apos;@&apos;</span>))
<a name="l04203"></a>04203       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(who, srcemail, <span class="keyword">sizeof</span>(who));
<a name="l04204"></a>04204    <span class="keywordflow">else</span> 
<a name="l04205"></a>04205       snprintf(who, <span class="keyword">sizeof</span>(who), <span class="stringliteral">&quot;%s@%s&quot;</span>, srcemail, host);
<a name="l04206"></a>04206    
<a name="l04207"></a>04207    greeting_attachment = strrchr(<a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(attach), <span class="charliteral">&apos;/&apos;</span>);
<a name="l04208"></a>04208    <span class="keywordflow">if</span> (greeting_attachment)
<a name="l04209"></a>04209       *greeting_attachment++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04210"></a>04210 
<a name="l04211"></a>04211    snprintf(dur, <span class="keyword">sizeof</span>(dur), <span class="stringliteral">&quot;%d:%02d&quot;</span>, duration / 60, duration % 60);
<a name="l04212"></a>04212    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), <span class="stringliteral">&quot;%a, %d %b %Y %H:%M:%S %z&quot;</span>, <a class="code" href="app__voicemail_8c.html#ad177a58ec2a39d04903d16f5b7ca0e4b" title="fill in *tm for current time according to the proper timezone, if any. Return tm...">vmu_tm</a>(vmu, &amp;tm));
<a name="l04213"></a>04213    fprintf(p, <span class="stringliteral">&quot;Date: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, date);
<a name="l04214"></a>04214 
<a name="l04215"></a>04215    <span class="comment">/* Set date format for voicemail mail */</span>
<a name="l04216"></a>04216    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), <a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>, &amp;tm);
<a name="l04217"></a>04217 
<a name="l04218"></a>04218    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>)) {
<a name="l04219"></a>04219       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast;
<a name="l04220"></a>04220       <span class="keywordflow">if</span> ((ast = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Substitution/voicemail&quot;</span>))) {
<a name="l04221"></a>04221          <span class="keywordtype">char</span> *ptr;
<a name="l04222"></a>04222          memset(passdata2, 0, len_passdata2);
<a name="l04223"></a>04223          <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, enc_cidnum, enc_cidname, dur, date, passdata2, len_passdata2, category, flag);
<a name="l04224"></a>04224          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(ast, <a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>, passdata2, len_passdata2);
<a name="l04225"></a>04225          len_passdata = strlen(passdata2) * 3 + 300;
<a name="l04226"></a>04226          passdata = alloca(len_passdata);
<a name="l04227"></a>04227          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb" title="Check if the string would need encoding within the MIME standard, to avoid confusing...">check_mime</a>(passdata2)) {
<a name="l04228"></a>04228             <span class="keywordtype">int</span> first_line = 1;
<a name="l04229"></a>04229             <a class="code" href="app__voicemail_8c.html#ad5ac80585ea7e740734bf3d33dd80471" title="Encode a string according to the MIME rules for encoding strings that are not 7-bit...">encode_mime_str</a>(passdata2, passdata, len_passdata, strlen(<span class="stringliteral">&quot;From: &quot;</span>), strlen(who) + 3);
<a name="l04230"></a>04230             <span class="keywordflow">while</span> ((ptr = strchr(passdata, <span class="charliteral">&apos; &apos;</span>))) {
<a name="l04231"></a>04231                *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04232"></a>04232                fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;From:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, passdata);
<a name="l04233"></a>04233                first_line = 0;
<a name="l04234"></a>04234                passdata = ptr + 1;
<a name="l04235"></a>04235             }
<a name="l04236"></a>04236             fprintf(p, <span class="stringliteral">&quot;%s %s &lt;%s&gt;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;From:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, passdata, who);
<a name="l04237"></a>04237          } <span class="keywordflow">else</span> {
<a name="l04238"></a>04238             fprintf(p, <span class="stringliteral">&quot;From: %s &lt;%s&gt;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a>(passdata2, passdata, len_passdata), who);
<a name="l04239"></a>04239          }
<a name="l04240"></a>04240          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(ast);
<a name="l04241"></a>04241       } <span class="keywordflow">else</span> {
<a name="l04242"></a>04242          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);
<a name="l04243"></a>04243       }
<a name="l04244"></a>04244    } <span class="keywordflow">else</span> {
<a name="l04245"></a>04245       fprintf(p, <span class="stringliteral">&quot;From: Asterisk PBX &lt;%s&gt;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, who);
<a name="l04246"></a>04246    }
<a name="l04247"></a>04247 
<a name="l04248"></a>04248    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb" title="Check if the string would need encoding within the MIME standard, to avoid confusing...">check_mime</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>)) {
<a name="l04249"></a>04249       <span class="keywordtype">int</span> first_line = 1;
<a name="l04250"></a>04250       <span class="keywordtype">char</span> *ptr;
<a name="l04251"></a>04251       <a class="code" href="app__voicemail_8c.html#ad5ac80585ea7e740734bf3d33dd80471" title="Encode a string according to the MIME rules for encoding strings that are not 7-bit...">encode_mime_str</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, passdata2, len_passdata2, strlen(<span class="stringliteral">&quot;To: &quot;</span>), strlen(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>) + 3);
<a name="l04252"></a>04252       <span class="keywordflow">while</span> ((ptr = strchr(passdata2, <span class="charliteral">&apos; &apos;</span>))) {
<a name="l04253"></a>04253          *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04254"></a>04254          fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;To:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, passdata2);
<a name="l04255"></a>04255          first_line = 0;
<a name="l04256"></a>04256          passdata2 = ptr + 1;
<a name="l04257"></a>04257       }
<a name="l04258"></a>04258       fprintf(p, <span class="stringliteral">&quot;%s %s &lt;%s&gt;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;To:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, passdata2, vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>);
<a name="l04259"></a>04259    } <span class="keywordflow">else</span> {
<a name="l04260"></a>04260       fprintf(p, <span class="stringliteral">&quot;To: %s &lt;%s&gt;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="app__voicemail_8c.html#a0d851e2ec853422973f33c7d0d77035f" title="Wraps a character sequence in double quotes, escaping occurences of quotes within...">quote</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, passdata2, len_passdata2), vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>);
<a name="l04261"></a>04261    }
<a name="l04262"></a>04262    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>) || !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>)) {
<a name="l04263"></a>04263       <span class="keywordtype">char</span> *e_subj = !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>) ? vmu-&gt;<a class="code" href="structast__vm__user.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> : <a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>;
<a name="l04264"></a>04264       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast;
<a name="l04265"></a>04265       <span class="keywordflow">if</span> ((ast = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Substitution/voicemail&quot;</span>))) {
<a name="l04266"></a>04266          <span class="keywordtype">int</span> vmlen = strlen(e_subj) * 3 + 200;
<a name="l04267"></a>04267          <span class="comment">/* Only allocate more space if the previous was not large enough */</span>
<a name="l04268"></a>04268          <span class="keywordflow">if</span> (vmlen &gt; len_passdata) {
<a name="l04269"></a>04269             passdata = alloca(vmlen);
<a name="l04270"></a>04270             len_passdata = vmlen;
<a name="l04271"></a>04271          }
<a name="l04272"></a>04272 
<a name="l04273"></a>04273          memset(passdata, 0, len_passdata);
<a name="l04274"></a>04274          <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, passdata, len_passdata, category, flag);
<a name="l04275"></a>04275          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(ast, e_subj, passdata, len_passdata);
<a name="l04276"></a>04276          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a42eb1cc1b531f7e8f240fbe0eb6ad1bb" title="Check if the string would need encoding within the MIME standard, to avoid confusing...">check_mime</a>(passdata)) {
<a name="l04277"></a>04277             <span class="keywordtype">int</span> first_line = 1;
<a name="l04278"></a>04278             <span class="keywordtype">char</span> *ptr;
<a name="l04279"></a>04279             <a class="code" href="app__voicemail_8c.html#ad5ac80585ea7e740734bf3d33dd80471" title="Encode a string according to the MIME rules for encoding strings that are not 7-bit...">encode_mime_str</a>(passdata, passdata2, len_passdata2, strlen(<span class="stringliteral">&quot;Subject: &quot;</span>), 0);
<a name="l04280"></a>04280             <span class="keywordflow">while</span> ((ptr = strchr(passdata2, <span class="charliteral">&apos; &apos;</span>))) {
<a name="l04281"></a>04281                *ptr = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04282"></a>04282                fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;Subject:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, passdata2);
<a name="l04283"></a>04283                first_line = 0;
<a name="l04284"></a>04284                passdata2 = ptr + 1;
<a name="l04285"></a>04285             }
<a name="l04286"></a>04286             fprintf(p, <span class="stringliteral">&quot;%s %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, first_line ? <span class="stringliteral">&quot;Subject:&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, passdata2);
<a name="l04287"></a>04287          } <span class="keywordflow">else</span> {
<a name="l04288"></a>04288             fprintf(p, <span class="stringliteral">&quot;Subject: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, passdata);
<a name="l04289"></a>04289          }
<a name="l04290"></a>04290          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(ast);
<a name="l04291"></a>04291       } <span class="keywordflow">else</span> {
<a name="l04292"></a>04292          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);
<a name="l04293"></a>04293       }
<a name="l04294"></a>04294    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">VM_PBXSKIP</a>)) {
<a name="l04295"></a>04295       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag)) {
<a name="l04296"></a>04296          fprintf(p, <span class="stringliteral">&quot;Subject: New message %d in mailbox %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1, mailbox);
<a name="l04297"></a>04297       } <span class="keywordflow">else</span> {
<a name="l04298"></a>04298          fprintf(p, <span class="stringliteral">&quot;Subject: New %s message %d in mailbox %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, flag, msgnum + 1, mailbox);
<a name="l04299"></a>04299       }
<a name="l04300"></a>04300    } <span class="keywordflow">else</span> {
<a name="l04301"></a>04301       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag)) {
<a name="l04302"></a>04302          fprintf(p, <span class="stringliteral">&quot;Subject: [PBX]: New message %d in mailbox %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1, mailbox);
<a name="l04303"></a>04303       } <span class="keywordflow">else</span> {
<a name="l04304"></a>04304          fprintf(p, <span class="stringliteral">&quot;Subject: [PBX]: New %s message %d in mailbox %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, flag, msgnum + 1, mailbox);
<a name="l04305"></a>04305       }
<a name="l04306"></a>04306    }
<a name="l04307"></a>04307 
<a name="l04308"></a>04308    fprintf(p, <span class="stringliteral">&quot;Message-ID: &lt;Asterisk-%d-%d-%s-%d@%s&gt;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>(), mailbox, (<span class="keywordtype">int</span>)getpid(), host);
<a name="l04309"></a>04309    <span class="keywordflow">if</span> (imap) {
<a name="l04310"></a>04310       <span class="comment">/* additional information needed for IMAP searching */</span>
<a name="l04311"></a>04311       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Message-Num: %d&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum + 1);
<a name="l04312"></a>04312       <span class="comment">/* fprintf(p, &quot;X-Asterisk-VM-Orig-Mailbox: %s&quot; ENDL, ext); */</span>
<a name="l04313"></a>04313       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Server-Name: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>);
<a name="l04314"></a>04314       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Context: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, context);
<a name="l04315"></a>04315 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l04316"></a>04316 <span class="preprocessor"></span>      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Extension: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;imapvmshareid) ? vmu-&gt;imapvmshareid : mailbox));
<a name="l04317"></a>04317 <span class="preprocessor">#else</span>
<a name="l04318"></a>04318 <span class="preprocessor"></span>      fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Extension: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, mailbox);
<a name="l04319"></a>04319 <span class="preprocessor">#endif</span>
<a name="l04320"></a>04320 <span class="preprocessor"></span>      <span class="comment">/* flag added for Urgent */</span>
<a name="l04321"></a>04321       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Flag: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, flag);
<a name="l04322"></a>04322       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Priority: %d&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l04323"></a>04323       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-channel: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, chan-&gt;name);
<a name="l04324"></a>04324       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Num: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidnum);
<a name="l04325"></a>04325       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Caller-ID-Name: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidname);
<a name="l04326"></a>04326       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Duration: %d&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, duration);
<a name="l04327"></a>04327       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(category)) {
<a name="l04328"></a>04328          fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Category: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, category);
<a name="l04329"></a>04329       } <span class="keywordflow">else</span> {
<a name="l04330"></a>04330          fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Category: &quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);
<a name="l04331"></a>04331       }
<a name="l04332"></a>04332       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Message-Type: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, msgnum &gt; -1 ? <span class="stringliteral">&quot;Message&quot;</span> : greeting_attachment);
<a name="l04333"></a>04333       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Orig-date: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, date);
<a name="l04334"></a>04334       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-VM-Orig-time: %ld&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, (<span class="keywordtype">long</span>)time(NULL));
<a name="l04335"></a>04335    }
<a name="l04336"></a>04336    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidnum)) {
<a name="l04337"></a>04337       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-CallerID: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidnum);
<a name="l04338"></a>04338    }
<a name="l04339"></a>04339    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cidname)) {
<a name="l04340"></a>04340       fprintf(p, <span class="stringliteral">&quot;X-Asterisk-CallerIDName: %s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, enc_cidname);
<a name="l04341"></a>04341    }
<a name="l04342"></a>04342    fprintf(p, <span class="stringliteral">&quot;MIME-Version: 1.0&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);
<a name="l04343"></a>04343    <span class="keywordflow">if</span> (attach_user_voicemail) {
<a name="l04344"></a>04344       <span class="comment">/* Something unique. */</span>
<a name="l04345"></a>04345       snprintf(bound, <span class="keyword">sizeof</span>(bound), <span class="stringliteral">&quot;----voicemail_%d%s%d%d&quot;</span>, msgnum + 1, mailbox, (<span class="keywordtype">int</span>)getpid(), (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>());
<a name="l04346"></a>04346 
<a name="l04347"></a>04347       fprintf(p, <span class="stringliteral">&quot;Content-Type: multipart/mixed; boundary=\&quot;%s\&quot;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, bound);
<a name="l04348"></a>04348       fprintf(p, <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <span class="stringliteral">&quot;This is a multi-part message in MIME format.&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);
<a name="l04349"></a>04349       fprintf(p, <span class="stringliteral">&quot;--%s&quot;</span> ENDL, bound);
<a name="l04350"></a>04350    }
<a name="l04351"></a>04351    fprintf(p, <span class="stringliteral">&quot;Content-Type: text/plain; charset=%s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <span class="stringliteral">&quot;Content-Transfer-Encoding: 8bit&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, <a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>);
<a name="l04352"></a>04352    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> || vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>) {
<a name="l04353"></a>04353       <span class="keywordtype">char</span>* e_body = vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> ? vmu-&gt;<a class="code" href="structast__vm__user.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> : <a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>;
<a name="l04354"></a>04354       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast;
<a name="l04355"></a>04355       <span class="keywordflow">if</span> ((ast = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Substitution/voicemail&quot;</span>))) {
<a name="l04356"></a>04356          <span class="keywordtype">char</span> *passdata;
<a name="l04357"></a>04357          <span class="keywordtype">int</span> vmlen = strlen(e_body) * 3 + 200;
<a name="l04358"></a>04358          passdata = alloca(vmlen);
<a name="l04359"></a>04359          memset(passdata, 0, vmlen);
<a name="l04360"></a>04360          <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, passdata, vmlen, category, flag);
<a name="l04361"></a>04361          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(ast, e_body, passdata, vmlen);
<a name="l04362"></a>04362          fprintf(p, <span class="stringliteral">&quot;%s&quot;</span> ENDL, passdata);
<a name="l04363"></a>04363          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(ast);
<a name="l04364"></a>04364       } <span class="keywordflow">else</span>
<a name="l04365"></a>04365          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);
<a name="l04366"></a>04366    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (msgnum &gt; -1) {
<a name="l04367"></a>04367       <span class="keywordflow">if</span> (strcmp(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, mailbox)) {
<a name="l04368"></a>04368          <span class="comment">/* Forwarded type */</span>
<a name="l04369"></a>04369          <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *msg_cfg;
<a name="l04370"></a>04370          <span class="keyword">const</span> <span class="keywordtype">char</span> *v;
<a name="l04371"></a>04371          <span class="keywordtype">int</span> inttime;
<a name="l04372"></a>04372          <span class="keywordtype">char</span> fromdir[256], fromfile[256], origdate[80] = <span class="stringliteral">&quot;&quot;</span>, origcallerid[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04373"></a>04373          <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26a3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };
<a name="l04374"></a>04374          <span class="comment">/* Retrieve info from VM attribute file */</span>
<a name="l04375"></a>04375          <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(fromdir, <span class="keyword">sizeof</span>(fromdir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, fromfolder);
<a name="l04376"></a>04376          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fromfile, <span class="keyword">sizeof</span>(fromfile), fromdir, msgnum);
<a name="l04377"></a>04377          <span class="keywordflow">if</span> (strlen(fromfile) &lt; <span class="keyword">sizeof</span>(fromfile) - 5) {
<a name="l04378"></a>04378             strcat(fromfile, <span class="stringliteral">&quot;.txt&quot;</span>);
<a name="l04379"></a>04379          }
<a name="l04380"></a>04380          <span class="keywordflow">if</span> ((msg_cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(fromfile, config_flags))) {
<a name="l04381"></a>04381             <span class="keywordflow">if</span> ((v = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>))) {
<a name="l04382"></a>04382                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(origcallerid, v, <span class="keyword">sizeof</span>(origcallerid));
<a name="l04383"></a>04383             }
<a name="l04384"></a>04384 
<a name="l04385"></a>04385             <span class="comment">/* You might be tempted to do origdate, except that a) it&apos;s in the wrong</span>
<a name="l04386"></a>04386 <span class="comment">             * format, and b) it&apos;s missing for IMAP recordings. */</span>
<a name="l04387"></a>04387             <span class="keywordflow">if</span> ((v = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>)) &amp;&amp; sscanf(v, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;inttime) == 1) {
<a name="l04388"></a>04388                <span class="keyword">struct </span>timeval tv = { inttime, };
<a name="l04389"></a>04389                <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l04390"></a>04390                <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;tv, &amp;tm, NULL);
<a name="l04391"></a>04391                <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(origdate, <span class="keyword">sizeof</span>(origdate), <a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>, &amp;tm);
<a name="l04392"></a>04392             }
<a name="l04393"></a>04393             fprintf(p, <span class="stringliteral">&quot;Dear %s:&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\tJust wanted to let you know you were just forwarded&quot;</span>
<a name="l04394"></a>04394                <span class="stringliteral">&quot; a %s long message (number %d)&quot;</span> ENDL <span class="stringliteral">&quot;in mailbox %s from %s, on %s&quot;</span> ENDL
<a name="l04395"></a>04395                <span class="stringliteral">&quot;(originally sent by %s on %s)&quot;</span> ENDL <span class="stringliteral">&quot;so you might want to check it when you get a&quot;</span>
<a name="l04396"></a>04396                <span class="stringliteral">&quot; chance.  Thanks!&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\t\t\t\t--Asterisk&quot;</span> ENDL ENDL, vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, dur,
<a name="l04397"></a>04397                msgnum + 1, mailbox, (cidname ? cidname : (cidnum ? cidnum : <span class="stringliteral">&quot;an unknown caller&quot;</span>)),
<a name="l04398"></a>04398                date, origcallerid, origdate);
<a name="l04399"></a>04399             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l04400"></a>04400          } <span class="keywordflow">else</span> {
<a name="l04401"></a>04401             <span class="keywordflow">goto</span> plain_message;
<a name="l04402"></a>04402          }
<a name="l04403"></a>04403       } <span class="keywordflow">else</span> {
<a name="l04404"></a>04404 plain_message:
<a name="l04405"></a>04405          fprintf(p, <span class="stringliteral">&quot;Dear %s:&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\tJust wanted to let you know you were just left a &quot;</span>
<a name="l04406"></a>04406             <span class="stringliteral">&quot;%s long message (number %d)&quot;</span> ENDL <span class="stringliteral">&quot;in mailbox %s from %s, on %s so you might&quot;</span> ENDL
<a name="l04407"></a>04407             <span class="stringliteral">&quot;want to check it when you get a chance.  Thanks!&quot;</span> ENDL ENDL <span class="stringliteral">&quot;\t\t\t\t--Asterisk&quot;</span>
<a name="l04408"></a>04408             ENDL ENDL, vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, dur, msgnum + 1, mailbox,
<a name="l04409"></a>04409             (cidname ? cidname : (cidnum ? cidnum : <span class="stringliteral">&quot;an unknown caller&quot;</span>)), date);
<a name="l04410"></a>04410       }
<a name="l04411"></a>04411    } <span class="keywordflow">else</span> {
<a name="l04412"></a>04412       fprintf(p, <span class="stringliteral">&quot;This message is to let you know that your greeting was changed on %s.&quot;</span> ENDL
<a name="l04413"></a>04413             <span class="stringliteral">&quot;Please do not delete this message, lest your greeting vanish with it.&quot;</span> ENDL ENDL, date);
<a name="l04414"></a>04414    }
<a name="l04415"></a>04415 
<a name="l04416"></a>04416    <span class="keywordflow">if</span> (imap || attach_user_voicemail) {
<a name="l04417"></a>04417       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(attach2)) {
<a name="l04418"></a>04418          snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;msg%04d.%s&quot;</span>, msgnum, format);
<a name="l04419"></a>04419          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;creating second attachment filename %s\n&quot;</span>, filename);
<a name="l04420"></a>04420          <a class="code" href="app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(p, vmu, format, attach, greeting_attachment, mailbox, bound, filename, 0, msgnum);
<a name="l04421"></a>04421          snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;msgintro%04d.%s&quot;</span>, msgnum, format);
<a name="l04422"></a>04422          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;creating attachment filename %s\n&quot;</span>, filename);
<a name="l04423"></a>04423          <a class="code" href="app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(p, vmu, format, attach2, greeting_attachment, mailbox, bound, filename, 1, msgnum);
<a name="l04424"></a>04424       } <span class="keywordflow">else</span> {
<a name="l04425"></a>04425          snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;msg%04d.%s&quot;</span>, msgnum, format);
<a name="l04426"></a>04426          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;creating attachment filename %s, no second attachment.\n&quot;</span>, filename);
<a name="l04427"></a>04427          <a class="code" href="app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(p, vmu, format, attach, greeting_attachment, mailbox, bound, filename, 1, msgnum);
<a name="l04428"></a>04428       }
<a name="l04429"></a>04429    }
<a name="l04430"></a>04430 }
<a name="l04431"></a>04431 
<a name="l04432"></a><a class="code" href="app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">04432</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa2008dd91df3ec0b2625cdac457c8eaf">add_email_attachment</a>(FILE *p, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *format, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *greeting_attachment, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">char</span> *bound, <span class="keywordtype">char</span> *filename, <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>, <span class="keywordtype">int</span> msgnum)
<a name="l04433"></a>04433 {
<a name="l04434"></a>04434    <span class="keywordtype">char</span> tmpdir[256], newtmp[256];
<a name="l04435"></a>04435    <span class="keywordtype">char</span> fname[256];
<a name="l04436"></a>04436    <span class="keywordtype">char</span> tmpcmd[256];
<a name="l04437"></a>04437    <span class="keywordtype">int</span> tmpfd = -1;
<a name="l04438"></a>04438 
<a name="l04439"></a>04439    <span class="comment">/* Eww. We want formats to tell us their own MIME type */</span>
<a name="l04440"></a>04440    <span class="keywordtype">char</span> *ctype = (!strcasecmp(format, <span class="stringliteral">&quot;ogg&quot;</span>)) ? <span class="stringliteral">&quot;application/&quot;</span> : <span class="stringliteral">&quot;audio/x-&quot;</span>;
<a name="l04441"></a>04441 
<a name="l04442"></a>04442    <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &lt; -.001 || vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> &gt; .001) {
<a name="l04443"></a>04443       <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(tmpdir, <span class="keyword">sizeof</span>(tmpdir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="stringliteral">&quot;tmp&quot;</span>);
<a name="l04444"></a>04444       snprintf(newtmp, <span class="keyword">sizeof</span>(newtmp), <span class="stringliteral">&quot;%s/XXXXXX&quot;</span>, tmpdir);
<a name="l04445"></a>04445       tmpfd = mkstemp(newtmp);
<a name="l04446"></a>04446       chmod(newtmp, <a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a> &amp; ~<a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a>);
<a name="l04447"></a>04447       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;newtmp: %s\n&quot;</span>, newtmp);
<a name="l04448"></a>04448       <span class="keywordflow">if</span> (tmpfd &gt; -1) {
<a name="l04449"></a>04449          <span class="keywordtype">int</span> soxstatus;
<a name="l04450"></a>04450          snprintf(tmpcmd, <span class="keyword">sizeof</span>(tmpcmd), <span class="stringliteral">&quot;sox -v %.4f %s.%s %s.%s&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>, attach, format, newtmp, format);
<a name="l04451"></a>04451          <span class="keywordflow">if</span> ((soxstatus = <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(tmpcmd)) == 0) {
<a name="l04452"></a>04452             attach = newtmp;
<a name="l04453"></a>04453             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;VOLGAIN: Stored at: %s.%s - Level: %.4f - Mailbox: %s\n&quot;</span>, attach, format, vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>, mailbox);
<a name="l04454"></a>04454          } <span class="keywordflow">else</span> {
<a name="l04455"></a>04455             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Sox failed to reencode %s.%s: %s (have you installed support for all sox file formats?)\n&quot;</span>, attach, format,
<a name="l04456"></a>04456                soxstatus == 1 ? <span class="stringliteral">&quot;Problem with command line options&quot;</span> : <span class="stringliteral">&quot;An error occurred during file processing&quot;</span>);
<a name="l04457"></a>04457             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Voicemail attachment will have no volume gain.\n&quot;</span>);
<a name="l04458"></a>04458          }
<a name="l04459"></a>04459       }
<a name="l04460"></a>04460    }
<a name="l04461"></a>04461    fprintf(p, <span class="stringliteral">&quot;--%s&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, bound);
<a name="l04462"></a>04462    <span class="keywordflow">if</span> (msgnum &gt; -1)
<a name="l04463"></a>04463       fprintf(p, <span class="stringliteral">&quot;Content-Type: %s%s; name=\&quot;%s\&quot;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, ctype, format, filename);
<a name="l04464"></a>04464    <span class="keywordflow">else</span>
<a name="l04465"></a>04465       fprintf(p, <span class="stringliteral">&quot;Content-Type: %s%s; name=\&quot;%s.%s\&quot;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, ctype, format, greeting_attachment, format);
<a name="l04466"></a>04466    fprintf(p, <span class="stringliteral">&quot;Content-Transfer-Encoding: base64&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);
<a name="l04467"></a>04467    fprintf(p, <span class="stringliteral">&quot;Content-Description: Voicemail sound attachment.&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>);
<a name="l04468"></a>04468    <span class="keywordflow">if</span> (msgnum &gt; -1)
<a name="l04469"></a>04469       fprintf(p, <span class="stringliteral">&quot;Content-Disposition: attachment; filename=\&quot;%s\&quot;&quot;</span> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a> <a class="code" href="app__voicemail_8c.html#a90dc3f3ee970394e0080300526390a84">ENDL</a>, filename);
<a name="l04470"></a>04470    <span class="keywordflow">else</span>
<a name="l04471"></a>04471       fprintf(p, <span class="stringliteral">&quot;Content-Disposition: attachment; filename=\&quot;%s.%s\&quot;&quot;</span> ENDL ENDL, greeting_attachment, format);
<a name="l04472"></a>04472    snprintf(fname, <span class="keyword">sizeof</span>(fname), <span class="stringliteral">&quot;%s.%s&quot;</span>, attach, format);
<a name="l04473"></a>04473    <a class="code" href="app__voicemail_8c.html#a47ff5177c51504731acbd567efea2b17" title="Performs a base 64 encode algorithm on the contents of a File.">base_encode</a>(fname, p);
<a name="l04474"></a>04474    <span class="keywordflow">if</span> (last)
<a name="l04475"></a>04475       fprintf(p, ENDL ENDL <span class="stringliteral">&quot;--%s--&quot;</span> ENDL <span class="stringliteral">&quot;.&quot;</span> ENDL, bound);
<a name="l04476"></a>04476    <span class="keywordflow">if</span> (tmpfd &gt; -1) {
<a name="l04477"></a>04477       unlink(fname);
<a name="l04478"></a>04478       close(tmpfd);
<a name="l04479"></a>04479       unlink(newtmp);
<a name="l04480"></a>04480    }
<a name="l04481"></a>04481    <span class="keywordflow">return</span> 0;
<a name="l04482"></a>04482 }
<a name="l04483"></a>04483 <span class="preprocessor">#undef ENDL</span>
<a name="l04484"></a>04484 <span class="preprocessor"></span>
<a name="l04485"></a><a class="code" href="app__voicemail_8c.html#a183096024fd4bf12223521cbfae96856">04485</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a183096024fd4bf12223521cbfae96856">sendmail</a>(<span class="keywordtype">char</span> *srcemail, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">char</span> *attach, <span class="keywordtype">char</span> *attach2, <span class="keywordtype">char</span> *format, <span class="keywordtype">int</span> duration, <span class="keywordtype">int</span> attach_user_voicemail, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l04486"></a>04486 {
<a name="l04487"></a>04487    FILE *p=NULL;
<a name="l04488"></a>04488    <span class="keywordtype">char</span> tmp[80] = <span class="stringliteral">&quot;/tmp/astmail-XXXXXX&quot;</span>;
<a name="l04489"></a>04489    <span class="keywordtype">char</span> tmp2[256];
<a name="l04490"></a>04490 
<a name="l04491"></a>04491    <span class="keywordflow">if</span> (vmu &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>)) {
<a name="l04492"></a>04492       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;E-mail address missing for mailbox [%s].  E-mail will not be sent.\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>);
<a name="l04493"></a>04493       <span class="keywordflow">return</span>(0);
<a name="l04494"></a>04494    }
<a name="l04495"></a>04495    <span class="keywordflow">if</span> (!strcmp(format, <span class="stringliteral">&quot;wav49&quot;</span>))
<a name="l04496"></a>04496       format = <span class="stringliteral">&quot;WAV&quot;</span>;
<a name="l04497"></a>04497    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Attaching file &apos;%s&apos;, format &apos;%s&apos;, uservm is &apos;%d&apos;, global is %d\n&quot;</span>, attach, format, attach_user_voicemail, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>));
<a name="l04498"></a>04498    <span class="comment">/* Make a temporary file instead of piping directly to sendmail, in case the mail</span>
<a name="l04499"></a>04499 <span class="comment">      command hangs */</span>
<a name="l04500"></a>04500    <span class="keywordflow">if</span> ((p = <a class="code" href="app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(tmp)) == NULL) {
<a name="l04501"></a>04501       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to launch &apos;%s&apos; (can&apos;t create temporary file)\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>);
<a name="l04502"></a>04502       <span class="keywordflow">return</span> -1;
<a name="l04503"></a>04503    } <span class="keywordflow">else</span> {
<a name="l04504"></a>04504       <a class="code" href="app__voicemail_8c.html#ae3cbc800cf1d17d77a43c57a6015a4f2" title="Creates the email file to be sent to indicate a new voicemail exists for a user.">make_email_file</a>(p, srcemail, vmu, msgnum, context, mailbox, fromfolder, cidnum, cidname, attach, attach2, format, duration, attach_user_voicemail, chan, category, 0, flag);
<a name="l04505"></a>04505       fclose(p);
<a name="l04506"></a>04506       snprintf(tmp2, <span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">&quot;( %s &lt; %s ; rm -f %s ) &amp;&quot;</span>, <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>, tmp, tmp);
<a name="l04507"></a>04507       <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(tmp2);
<a name="l04508"></a>04508       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sent mail to %s with command &apos;%s&apos;\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>, <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>);
<a name="l04509"></a>04509    }
<a name="l04510"></a>04510    <span class="keywordflow">return</span> 0;
<a name="l04511"></a>04511 }
<a name="l04512"></a>04512 
<a name="l04513"></a><a class="code" href="app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe">04513</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe">sendpage</a>(<span class="keywordtype">char</span> *srcemail, <span class="keywordtype">char</span> *pager, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *fromfolder, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keywordtype">int</span> duration, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *category, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l04514"></a>04514 {
<a name="l04515"></a>04515    <span class="keywordtype">char</span> date[256];
<a name="l04516"></a>04516    <span class="keywordtype">char</span> host[<a class="code" href="network_8h.html#afd80ecbe3170ca4fc85b65cda8659f82">MAXHOSTNAMELEN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04517"></a>04517    <span class="keywordtype">char</span> who[256];
<a name="l04518"></a>04518    <span class="keywordtype">char</span> dur[PATH_MAX];
<a name="l04519"></a>04519    <span class="keywordtype">char</span> tmp[80] = <span class="stringliteral">&quot;/tmp/astmail-XXXXXX&quot;</span>;
<a name="l04520"></a>04520    <span class="keywordtype">char</span> tmp2[PATH_MAX];
<a name="l04521"></a>04521    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l04522"></a>04522    FILE *p;
<a name="l04523"></a>04523 
<a name="l04524"></a>04524    <span class="keywordflow">if</span> ((p = <a class="code" href="app__voicemail_8c.html#a823c8996a141b154215521998b4adedf">vm_mkftemp</a>(tmp)) == NULL) {
<a name="l04525"></a>04525       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to launch &apos;%s&apos; (can&apos;t create temporary file)\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>);
<a name="l04526"></a>04526       <span class="keywordflow">return</span> -1;
<a name="l04527"></a>04527    }
<a name="l04528"></a>04528    gethostname(host, <span class="keyword">sizeof</span>(host)-1);
<a name="l04529"></a>04529    <span class="keywordflow">if</span> (strchr(srcemail, <span class="charliteral">&apos;@&apos;</span>))
<a name="l04530"></a>04530       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(who, srcemail, <span class="keyword">sizeof</span>(who));
<a name="l04531"></a>04531    <span class="keywordflow">else</span> 
<a name="l04532"></a>04532       snprintf(who, <span class="keyword">sizeof</span>(who), <span class="stringliteral">&quot;%s@%s&quot;</span>, srcemail, host);
<a name="l04533"></a>04533    snprintf(dur, <span class="keyword">sizeof</span>(dur), <span class="stringliteral">&quot;%d:%02d&quot;</span>, duration / 60, duration % 60);
<a name="l04534"></a>04534    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), <span class="stringliteral">&quot;%a, %d %b %Y %H:%M:%S %z&quot;</span>, <a class="code" href="app__voicemail_8c.html#ad177a58ec2a39d04903d16f5b7ca0e4b" title="fill in *tm for current time according to the proper timezone, if any. Return tm...">vmu_tm</a>(vmu, &amp;tm));
<a name="l04535"></a>04535    fprintf(p, <span class="stringliteral">&quot;Date: %s\n&quot;</span>, date);
<a name="l04536"></a>04536 
<a name="l04537"></a>04537    <span class="keywordflow">if</span> (*<a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>) {
<a name="l04538"></a>04538       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast;
<a name="l04539"></a>04539       <span class="keywordflow">if</span> ((ast = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Substitution/voicemail&quot;</span>))) {
<a name="l04540"></a>04540          <span class="keywordtype">char</span> *passdata;
<a name="l04541"></a>04541          <span class="keywordtype">int</span> vmlen = strlen(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>)*3 + 200;
<a name="l04542"></a>04542          passdata = alloca(vmlen);
<a name="l04543"></a>04543          memset(passdata, 0, vmlen);
<a name="l04544"></a>04544          <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, passdata, vmlen, category, flag);
<a name="l04545"></a>04545          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(ast, <a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>, passdata, vmlen);
<a name="l04546"></a>04546          fprintf(p, <span class="stringliteral">&quot;From: %s &lt;%s&gt;\n&quot;</span>, passdata, who);
<a name="l04547"></a>04547          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(ast);
<a name="l04548"></a>04548       } <span class="keywordflow">else</span> 
<a name="l04549"></a>04549          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);
<a name="l04550"></a>04550    } <span class="keywordflow">else</span>
<a name="l04551"></a>04551       fprintf(p, <span class="stringliteral">&quot;From: Asterisk PBX &lt;%s&gt;\n&quot;</span>, who);
<a name="l04552"></a>04552    fprintf(p, <span class="stringliteral">&quot;To: %s\n&quot;</span>, pager);
<a name="l04553"></a>04553    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a>) {
<a name="l04554"></a>04554       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast;
<a name="l04555"></a>04555       <span class="keywordflow">if</span> ((ast = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Substitution/voicemail&quot;</span>))) {
<a name="l04556"></a>04556          <span class="keywordtype">char</span> *passdata;
<a name="l04557"></a>04557          <span class="keywordtype">int</span> vmlen = strlen(<a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a>) * 3 + 200;
<a name="l04558"></a>04558          passdata = alloca(vmlen);
<a name="l04559"></a>04559          memset(passdata, 0, vmlen);
<a name="l04560"></a>04560          <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, passdata, vmlen, category, flag);
<a name="l04561"></a>04561          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(ast, <a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a>, passdata, vmlen);
<a name="l04562"></a>04562          fprintf(p, <span class="stringliteral">&quot;Subject: %s\n\n&quot;</span>, passdata);
<a name="l04563"></a>04563          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(ast);
<a name="l04564"></a>04564       } <span class="keywordflow">else</span>
<a name="l04565"></a>04565          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);
<a name="l04566"></a>04566    } <span class="keywordflow">else</span> {
<a name="l04567"></a>04567       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag)) {
<a name="l04568"></a>04568          fprintf(p, <span class="stringliteral">&quot;Subject: New VM\n\n&quot;</span>);
<a name="l04569"></a>04569       } <span class="keywordflow">else</span> {
<a name="l04570"></a>04570          fprintf(p, <span class="stringliteral">&quot;Subject: New %s VM\n\n&quot;</span>, flag);
<a name="l04571"></a>04571       }
<a name="l04572"></a>04572    }
<a name="l04573"></a>04573 
<a name="l04574"></a>04574    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(date, <span class="keyword">sizeof</span>(date), <span class="stringliteral">&quot;%A, %B %d, %Y at %r&quot;</span>, &amp;tm);
<a name="l04575"></a>04575    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a>) {
<a name="l04576"></a>04576       <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *ast;
<a name="l04577"></a>04577       <span class="keywordflow">if</span> ((ast = <a class="code" href="channel_8h.html#adfbceb39821586c0f9be0c47496a4e18">ast_channel_alloc</a>(0, <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660a81348336816e0a2f6f3a76da487a46dc">AST_STATE_DOWN</a>, 0, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <span class="stringliteral">&quot;Substitution/voicemail&quot;</span>))) {
<a name="l04578"></a>04578          <span class="keywordtype">char</span> *passdata;
<a name="l04579"></a>04579          <span class="keywordtype">int</span> vmlen = strlen(<a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a>) * 3 + 200;
<a name="l04580"></a>04580          passdata = alloca(vmlen);
<a name="l04581"></a>04581          memset(passdata, 0, vmlen);
<a name="l04582"></a>04582          <a class="code" href="app__voicemail_8c.html#a37a52a37622602a56437e2fd9c1f64f5">prep_email_sub_vars</a>(ast, vmu, msgnum + 1, context, mailbox, fromfolder, cidnum, cidname, dur, date, passdata, vmlen, category, flag);
<a name="l04583"></a>04583          <a class="code" href="pbx_8h.html#a3eac2009888ce9c4a108e882d02cb04d">pbx_substitute_variables_helper</a>(ast, <a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a>, passdata, vmlen);
<a name="l04584"></a>04584          fprintf(p, <span class="stringliteral">&quot;%s\n&quot;</span>, passdata);
<a name="l04585"></a>04585          <a class="code" href="channel_8h.html#a239d899b30002db4e8b08c055ac9d8e5" title="Free a channel structure.">ast_channel_free</a>(ast);
<a name="l04586"></a>04586       } <span class="keywordflow">else</span>
<a name="l04587"></a>04587          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Cannot allocate the channel for variables substitution\n&quot;</span>);
<a name="l04588"></a>04588    } <span class="keywordflow">else</span> {
<a name="l04589"></a>04589       fprintf(p, <span class="stringliteral">&quot;New %s long %s msg in box %s\n&quot;</span>
<a name="l04590"></a>04590             <span class="stringliteral">&quot;from %s, on %s&quot;</span>, dur, flag, mailbox, (cidname ? cidname : (cidnum ? cidnum : <span class="stringliteral">&quot;unknown&quot;</span>)), date);
<a name="l04591"></a>04591    }
<a name="l04592"></a>04592    fclose(p);
<a name="l04593"></a>04593    snprintf(tmp2, <span class="keyword">sizeof</span>(tmp2), <span class="stringliteral">&quot;( %s &lt; %s ; rm -f %s ) &amp;&quot;</span>, <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>, tmp, tmp);
<a name="l04594"></a>04594    <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(tmp2);
<a name="l04595"></a>04595    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sent page to %s with command &apos;%s&apos;\n&quot;</span>, pager, <a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>);
<a name="l04596"></a>04596    <span class="keywordflow">return</span> 0;
<a name="l04597"></a>04597 }
<a name="l04598"></a>04598 <span class="comment"></span>
<a name="l04599"></a>04599 <span class="comment">/*!</span>
<a name="l04600"></a>04600 <span class="comment"> * \brief Gets the current date and time, as formatted string.</span>
<a name="l04601"></a>04601 <span class="comment"> * \param s The buffer to hold the output formatted date.</span>
<a name="l04602"></a>04602 <span class="comment"> * \param len the length of the buffer. Used to prevent buffer overflow in ast_strftime.</span>
<a name="l04603"></a>04603 <span class="comment"> * </span>
<a name="l04604"></a>04604 <span class="comment"> * The date format string used is &quot;%a %b %e %r UTC %Y&quot;.</span>
<a name="l04605"></a>04605 <span class="comment"> * </span>
<a name="l04606"></a>04606 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l04607"></a>04607 <span class="comment"> */</span>
<a name="l04608"></a><a class="code" href="app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271">04608</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271" title="Gets the current date and time, as formatted string.">get_date</a>(<span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> len)
<a name="l04609"></a>04609 {
<a name="l04610"></a>04610    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l04611"></a>04611    <span class="keyword">struct </span>timeval t = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l04612"></a>04612    
<a name="l04613"></a>04613    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;t, &amp;tm, <span class="stringliteral">&quot;UTC&quot;</span>);
<a name="l04614"></a>04614 
<a name="l04615"></a>04615    <span class="keywordflow">return</span> <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(s, len, <span class="stringliteral">&quot;%a %b %e %r UTC %Y&quot;</span>, &amp;tm);
<a name="l04616"></a>04616 }
<a name="l04617"></a>04617 
<a name="l04618"></a><a class="code" href="app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456">04618</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456">invent_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keywordtype">int</span> busy, <span class="keywordtype">char</span> *ecodes)
<a name="l04619"></a>04619 {
<a name="l04620"></a>04620    <span class="keywordtype">int</span> res;
<a name="l04621"></a>04621    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l04622"></a>04622    <span class="keywordtype">char</span> dest[PATH_MAX];
<a name="l04623"></a>04623 
<a name="l04624"></a>04624    snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, ext);
<a name="l04625"></a>04625 
<a name="l04626"></a>04626    <span class="keywordflow">if</span> ((res = <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(dest, <span class="keyword">sizeof</span>(dest), context, ext, <span class="stringliteral">&quot;&quot;</span>))) {
<a name="l04627"></a>04627       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to make directory(%s)\n&quot;</span>, fn);
<a name="l04628"></a>04628       <span class="keywordflow">return</span> -1;
<a name="l04629"></a>04629    }
<a name="l04630"></a>04630 
<a name="l04631"></a>04631    <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(fn, -1, ext, context);
<a name="l04632"></a>04632    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(fn, NULL, NULL) &gt; 0) {
<a name="l04633"></a>04633       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, fn, ecodes);
<a name="l04634"></a>04634       <span class="keywordflow">if</span> (res) {
<a name="l04635"></a>04635          <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);
<a name="l04636"></a>04636          <span class="keywordflow">return</span> res;
<a name="l04637"></a>04637       }
<a name="l04638"></a>04638    } <span class="keywordflow">else</span> {
<a name="l04639"></a>04639       <span class="comment">/* Dispose just in case */</span>
<a name="l04640"></a>04640       <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);
<a name="l04641"></a>04641       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-theperson&quot;</span>, ecodes);
<a name="l04642"></a>04642       <span class="keywordflow">if</span> (res)
<a name="l04643"></a>04643          <span class="keywordflow">return</span> res;
<a name="l04644"></a>04644       res = <a class="code" href="say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce" title="says digits of a string">ast_say_digit_str</a>(chan, ext, ecodes, chan-&gt;language);
<a name="l04645"></a>04645       <span class="keywordflow">if</span> (res)
<a name="l04646"></a>04646          <span class="keywordflow">return</span> res;
<a name="l04647"></a>04647    }
<a name="l04648"></a>04648    res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, busy ? <span class="stringliteral">&quot;vm-isonphone&quot;</span> : <span class="stringliteral">&quot;vm-isunavail&quot;</span>, ecodes);
<a name="l04649"></a>04649    <span class="keywordflow">return</span> res;
<a name="l04650"></a>04650 }
<a name="l04651"></a>04651 
<a name="l04652"></a><a class="code" href="app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2">04652</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2">free_zone</a>(<span class="keyword">struct</span> <a class="code" href="structvm__zone.html">vm_zone</a> *z)
<a name="l04653"></a>04653 {
<a name="l04654"></a>04654    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(z);
<a name="l04655"></a>04655 }
<a name="l04656"></a>04656 
<a name="l04657"></a>04657 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l04658"></a>04658 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)
<a name="l04659"></a>04659 {
<a name="l04660"></a>04660    <span class="keywordtype">int</span> x = -1;
<a name="l04661"></a>04661    <span class="keywordtype">int</span> res;
<a name="l04662"></a>04662    SQLHSTMT stmt = NULL;
<a name="l04663"></a>04663    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l04664"></a>04664    <span class="keywordtype">char</span> rowdata[20];
<a name="l04665"></a>04665    <span class="keywordtype">char</span> tmp[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04666"></a>04666    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj = NULL;
<a name="l04667"></a>04667    <span class="keywordtype">char</span> *context;
<a name="l04668"></a>04668    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 0 };
<a name="l04669"></a>04669 
<a name="l04670"></a>04670    <span class="keywordflow">if</span> (newmsgs)
<a name="l04671"></a>04671       *newmsgs = 0;
<a name="l04672"></a>04672    <span class="keywordflow">if</span> (oldmsgs)
<a name="l04673"></a>04673       *oldmsgs = 0;
<a name="l04674"></a>04674    <span class="keywordflow">if</span> (urgentmsgs)
<a name="l04675"></a>04675       *urgentmsgs = 0;
<a name="l04676"></a>04676 
<a name="l04677"></a>04677    <span class="comment">/* If no mailbox, return immediately */</span>
<a name="l04678"></a>04678    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox))
<a name="l04679"></a>04679       <span class="keywordflow">return</span> 0;
<a name="l04680"></a>04680 
<a name="l04681"></a>04681    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));
<a name="l04682"></a>04682 
<a name="l04683"></a>04683    <span class="keywordflow">if</span> (strchr(mailbox, <span class="charliteral">&apos; &apos;</span>) || strchr(mailbox, <span class="charliteral">&apos;,&apos;</span>)) {
<a name="l04684"></a>04684       <span class="keywordtype">int</span> u, n, o;
<a name="l04685"></a>04685       <span class="keywordtype">char</span> *next, *remaining = tmp;
<a name="l04686"></a>04686       <span class="keywordflow">while</span> ((next = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;remaining, <span class="stringliteral">&quot; ,&quot;</span>))) {
<a name="l04687"></a>04687          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(next, urgentmsgs ? &amp;u : NULL, &amp;n, &amp;o)) {
<a name="l04688"></a>04688             <span class="keywordflow">return</span> -1;
<a name="l04689"></a>04689          }
<a name="l04690"></a>04690          <span class="keywordflow">if</span> (urgentmsgs) {
<a name="l04691"></a>04691             *urgentmsgs += u;
<a name="l04692"></a>04692          }
<a name="l04693"></a>04693          <span class="keywordflow">if</span> (newmsgs) {
<a name="l04694"></a>04694             *newmsgs += n;
<a name="l04695"></a>04695          }
<a name="l04696"></a>04696          <span class="keywordflow">if</span> (oldmsgs) {
<a name="l04697"></a>04697             *oldmsgs += o;
<a name="l04698"></a>04698          }
<a name="l04699"></a>04699       }
<a name="l04700"></a>04700       <span class="keywordflow">return</span> 0;
<a name="l04701"></a>04701    }
<a name="l04702"></a>04702 
<a name="l04703"></a>04703    context = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>);
<a name="l04704"></a>04704    <span class="keywordflow">if</span> (context) {
<a name="l04705"></a>04705       *context = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04706"></a>04706       context++;
<a name="l04707"></a>04707    } <span class="keywordflow">else</span>
<a name="l04708"></a>04708       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l04709"></a>04709 
<a name="l04710"></a>04710    <span class="keywordflow">if</span> ((obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0))) {
<a name="l04711"></a>04711       <span class="keywordflow">do</span> {
<a name="l04712"></a>04712          <span class="keywordflow">if</span> (newmsgs) {
<a name="l04713"></a>04713             snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &apos;%s%s/%s/%s&apos;&quot;</span>, odbc_table, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, tmp, <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l04714"></a>04714             <span class="keywordflow">if</span> (!(stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps))) {
<a name="l04715"></a>04715                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04716"></a>04716                <span class="keywordflow">break</span>;
<a name="l04717"></a>04717             }
<a name="l04718"></a>04718             res = SQLFetch(stmt);
<a name="l04719"></a>04719             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04720"></a>04720                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04721"></a>04721                <span class="keywordflow">break</span>;
<a name="l04722"></a>04722             }
<a name="l04723"></a>04723             res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l04724"></a>04724             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04725"></a>04725                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04726"></a>04726                <span class="keywordflow">break</span>;
<a name="l04727"></a>04727             }
<a name="l04728"></a>04728             *newmsgs = atoi(rowdata);
<a name="l04729"></a>04729             SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l04730"></a>04730          }
<a name="l04731"></a>04731 
<a name="l04732"></a>04732          <span class="keywordflow">if</span> (oldmsgs) {
<a name="l04733"></a>04733             snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &apos;%s%s/%s/%s&apos;&quot;</span>, odbc_table, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, tmp, <span class="stringliteral">&quot;Old&quot;</span>);
<a name="l04734"></a>04734             <span class="keywordflow">if</span> (!(stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps))) {
<a name="l04735"></a>04735                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04736"></a>04736                <span class="keywordflow">break</span>;
<a name="l04737"></a>04737             }
<a name="l04738"></a>04738             res = SQLFetch(stmt);
<a name="l04739"></a>04739             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04740"></a>04740                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04741"></a>04741                <span class="keywordflow">break</span>;
<a name="l04742"></a>04742             }
<a name="l04743"></a>04743             res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l04744"></a>04744             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04745"></a>04745                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04746"></a>04746                <span class="keywordflow">break</span>;
<a name="l04747"></a>04747             }
<a name="l04748"></a>04748             SQLFreeHandle(SQL_HANDLE_STMT, stmt);
<a name="l04749"></a>04749             *oldmsgs = atoi(rowdata);
<a name="l04750"></a>04750          }
<a name="l04751"></a>04751 
<a name="l04752"></a>04752          <span class="keywordflow">if</span> (urgentmsgs) {
<a name="l04753"></a>04753             snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &apos;%s%s/%s/%s&apos;&quot;</span>, odbc_table, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, tmp, <span class="stringliteral">&quot;Urgent&quot;</span>);
<a name="l04754"></a>04754             <span class="keywordflow">if</span> (!(stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps))) {
<a name="l04755"></a>04755                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04756"></a>04756                <span class="keywordflow">break</span>;
<a name="l04757"></a>04757             }
<a name="l04758"></a>04758             res = SQLFetch(stmt);
<a name="l04759"></a>04759             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04760"></a>04760                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04761"></a>04761                <span class="keywordflow">break</span>;
<a name="l04762"></a>04762             }
<a name="l04763"></a>04763             res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l04764"></a>04764             <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04765"></a>04765                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04766"></a>04766                <span class="keywordflow">break</span>;
<a name="l04767"></a>04767             }
<a name="l04768"></a>04768             *urgentmsgs = atoi(rowdata);
<a name="l04769"></a>04769          }
<a name="l04770"></a>04770 
<a name="l04771"></a>04771          x = 0;
<a name="l04772"></a>04772       } <span class="keywordflow">while</span> (0);
<a name="l04773"></a>04773    } <span class="keywordflow">else</span> {
<a name="l04774"></a>04774       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l04775"></a>04775    }
<a name="l04776"></a>04776 
<a name="l04777"></a>04777    <span class="keywordflow">if</span> (stmt) {
<a name="l04778"></a>04778       SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l04779"></a>04779    }
<a name="l04780"></a>04780    <span class="keywordflow">if</span> (obj) {
<a name="l04781"></a>04781       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l04782"></a>04782    }
<a name="l04783"></a>04783 
<a name="l04784"></a>04784    <span class="keywordflow">return</span> x;
<a name="l04785"></a>04785 }
<a name="l04786"></a>04786 <span class="comment"></span>
<a name="l04787"></a>04787 <span class="comment">/*!</span>
<a name="l04788"></a>04788 <span class="comment"> * \brief Gets the number of messages that exist in a mailbox folder.</span>
<a name="l04789"></a>04789 <span class="comment"> * \param context</span>
<a name="l04790"></a>04790 <span class="comment"> * \param mailbox</span>
<a name="l04791"></a>04791 <span class="comment"> * \param folder</span>
<a name="l04792"></a>04792 <span class="comment"> * </span>
<a name="l04793"></a>04793 <span class="comment"> * This method is used when ODBC backend is used.</span>
<a name="l04794"></a>04794 <span class="comment"> * \return The number of messages in this mailbox folder (zero or more).</span>
<a name="l04795"></a>04795 <span class="comment"> */</span>
<a name="l04796"></a>04796 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a276efe40a0edb56b717e542b711bf5aa">messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l04797"></a>04797 {
<a name="l04798"></a>04798    <span class="keyword">struct </span><a class="code" href="structodbc__obj.html" title="ODBC container.">odbc_obj</a> *obj = NULL;
<a name="l04799"></a>04799    <span class="keywordtype">int</span> nummsgs = 0;
<a name="l04800"></a>04800    <span class="keywordtype">int</span> res;
<a name="l04801"></a>04801    SQLHSTMT stmt = NULL;
<a name="l04802"></a>04802    <span class="keywordtype">char</span> sql[PATH_MAX];
<a name="l04803"></a>04803    <span class="keywordtype">char</span> rowdata[20];
<a name="l04804"></a>04804    <span class="keyword">struct </span>generic_prepare_struct gps = { .sql = sql, .argc = 0 };
<a name="l04805"></a>04805    <span class="keywordflow">if</span> (!folder)
<a name="l04806"></a>04806       folder = <span class="stringliteral">&quot;INBOX&quot;</span>;
<a name="l04807"></a>04807    <span class="comment">/* If no mailbox, return immediately */</span>
<a name="l04808"></a>04808    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox))
<a name="l04809"></a>04809       <span class="keywordflow">return</span> 0;
<a name="l04810"></a>04810 
<a name="l04811"></a>04811    obj = <a class="code" href="res__odbc_8h.html#ad34ae2bdba165ef6c7405afc94f2a7f3">ast_odbc_request_obj</a>(odbc_database, 0);
<a name="l04812"></a>04812    <span class="keywordflow">if</span> (obj) {
<a name="l04813"></a>04813       <span class="keywordflow">if</span> (!strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>)) {
<a name="l04814"></a>04814          snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &apos;%s%s/%s/INBOX&apos; OR dir = &apos;%s%s/%s/Urgent&apos;&quot;</span>, odbc_table, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, mailbox, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, mailbox);
<a name="l04815"></a>04815       } <span class="keywordflow">else</span> {
<a name="l04816"></a>04816          snprintf(sql, <span class="keyword">sizeof</span>(sql), <span class="stringliteral">&quot;SELECT COUNT(*) FROM %s WHERE dir = &apos;%s%s/%s/%s&apos;&quot;</span>, odbc_table, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, mailbox, folder);
<a name="l04817"></a>04817       }
<a name="l04818"></a>04818       stmt = <a class="code" href="res__odbc_8h.html#ad1e82a2b1ba4eda1924d8b8f591de065" title="Prepares, executes, and returns the resulting statement handle.">ast_odbc_prepare_and_execute</a>(obj, <a class="code" href="cdr__adaptive__odbc_8c.html#a605e5e635448d77ff0144fbd75e8af72">generic_prepare</a>, &amp;gps);
<a name="l04819"></a>04819       <span class="keywordflow">if</span> (!stmt) {
<a name="l04820"></a>04820          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Execute error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04821"></a>04821          <span class="keywordflow">goto</span> yuck;
<a name="l04822"></a>04822       }
<a name="l04823"></a>04823       res = SQLFetch(stmt);
<a name="l04824"></a>04824       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04825"></a>04825          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Fetch error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04826"></a>04826          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l04827"></a>04827          <span class="keywordflow">goto</span> yuck;
<a name="l04828"></a>04828       }
<a name="l04829"></a>04829       res = SQLGetData(stmt, 1, SQL_CHAR, rowdata, <span class="keyword">sizeof</span>(rowdata), NULL);
<a name="l04830"></a>04830       <span class="keywordflow">if</span> ((res != SQL_SUCCESS) &amp;&amp; (res != SQL_SUCCESS_WITH_INFO)) {
<a name="l04831"></a>04831          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;SQL Get Data error!\n[%s]\n\n&quot;</span>, sql);
<a name="l04832"></a>04832          SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l04833"></a>04833          <span class="keywordflow">goto</span> yuck;
<a name="l04834"></a>04834       }
<a name="l04835"></a>04835       nummsgs = atoi(rowdata);
<a name="l04836"></a>04836       SQLFreeHandle (SQL_HANDLE_STMT, stmt);
<a name="l04837"></a>04837    } <span class="keywordflow">else</span>
<a name="l04838"></a>04838       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to obtain database object for &apos;%s&apos;!\n&quot;</span>, odbc_database);
<a name="l04839"></a>04839 
<a name="l04840"></a>04840 yuck:
<a name="l04841"></a>04841    <span class="keywordflow">if</span> (obj)
<a name="l04842"></a>04842       <a class="code" href="res__odbc_8h.html#a78d14d1dd01c269c9c0a47b49475eeea" title="Releases an ODBC object previously allocated by odbc_request_obj().">ast_odbc_release_obj</a>(obj);
<a name="l04843"></a>04843    <span class="keywordflow">return</span> nummsgs;
<a name="l04844"></a>04844 }
<a name="l04845"></a>04845 <span class="comment"></span>
<a name="l04846"></a>04846 <span class="comment">/** </span>
<a name="l04847"></a>04847 <span class="comment"> * \brief Determines if the given folder has messages.</span>
<a name="l04848"></a>04848 <span class="comment"> * \param mailbox The @ delimited string for user@context. If no context is found, uses &apos;default&apos; for the context.</span>
<a name="l04849"></a>04849 <span class="comment"> * </span>
<a name="l04850"></a>04850 <span class="comment"> * This function is used when the mailbox is stored in an ODBC back end.</span>
<a name="l04851"></a>04851 <span class="comment"> * This invokes the messagecount(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.</span>
<a name="l04852"></a>04852 <span class="comment"> * \return 1 if the folder has one or more messages. zero otherwise.</span>
<a name="l04853"></a>04853 <span class="comment"> */</span>
<a name="l04854"></a>04854 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7" title="Determines if the given folder has messages.">has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l04855"></a>04855 {
<a name="l04856"></a>04856    <span class="keywordtype">char</span> tmp[256], *tmp2 = tmp, *box, *context;
<a name="l04857"></a>04857    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));
<a name="l04858"></a>04858    <span class="keywordflow">while</span> ((context = box = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp2, <span class="stringliteral">&quot;,&amp;&quot;</span>))) {
<a name="l04859"></a>04859       <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l04860"></a>04860       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l04861"></a>04861          context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l04862"></a>04862       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a276efe40a0edb56b717e542b711bf5aa">messagecount</a>(context, box, folder))
<a name="l04863"></a>04863          <span class="keywordflow">return</span> 1;
<a name="l04864"></a>04864    }
<a name="l04865"></a>04865    <span class="keywordflow">return</span> 0;
<a name="l04866"></a>04866 }
<a name="l04867"></a>04867 <span class="preprocessor">#endif</span>
<a name="l04868"></a>04868 <span class="preprocessor"></span><span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l04869"></a>04869 <span class="preprocessor"></span><span class="comment">/*! </span>
<a name="l04870"></a>04870 <span class="comment"> * \brief Copies a message from one mailbox to another.</span>
<a name="l04871"></a>04871 <span class="comment"> * \param chan</span>
<a name="l04872"></a>04872 <span class="comment"> * \param vmu</span>
<a name="l04873"></a>04873 <span class="comment"> * \param imbox</span>
<a name="l04874"></a>04874 <span class="comment"> * \param msgnum</span>
<a name="l04875"></a>04875 <span class="comment"> * \param duration</span>
<a name="l04876"></a>04876 <span class="comment"> * \param recip</span>
<a name="l04877"></a>04877 <span class="comment"> * \param fmt</span>
<a name="l04878"></a>04878 <span class="comment"> * \param dir</span>
<a name="l04879"></a>04879 <span class="comment"> *</span>
<a name="l04880"></a>04880 <span class="comment"> * This is only used by file storage based mailboxes.</span>
<a name="l04881"></a>04881 <span class="comment"> *</span>
<a name="l04882"></a>04882 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l04883"></a>04883 <span class="comment"> */</span>
<a name="l04884"></a><a class="code" href="app__voicemail_8c.html#a6a81ca7c488e8311134145f6c11c16b9">04884</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a6a81ca7c488e8311134145f6c11c16b9" title="Copies a message from one mailbox to another.">copy_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> imbox, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *recip, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *dir, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l04885"></a>04885 {
<a name="l04886"></a>04886    <span class="keywordtype">char</span> fromdir[PATH_MAX], todir[PATH_MAX], frompath[PATH_MAX], topath[PATH_MAX];
<a name="l04887"></a>04887    <span class="keyword">const</span> <span class="keywordtype">char</span> *frombox = <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(imbox);
<a name="l04888"></a>04888    <span class="keywordtype">int</span> recipmsgnum;
<a name="l04889"></a>04889 
<a name="l04890"></a>04890    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Copying message from %s@%s to %s@%s\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l04891"></a>04891 
<a name="l04892"></a>04892    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) { <span class="comment">/* If urgent, copy to Urgent folder */</span>
<a name="l04893"></a>04893       <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(todir, <span class="keyword">sizeof</span>(todir), recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="stringliteral">&quot;Urgent&quot;</span>);
<a name="l04894"></a>04894    } <span class="keywordflow">else</span> {
<a name="l04895"></a>04895       <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(todir, <span class="keyword">sizeof</span>(todir), recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l04896"></a>04896    }
<a name="l04897"></a>04897    
<a name="l04898"></a>04898    <span class="keywordflow">if</span> (!dir)
<a name="l04899"></a>04899       <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(fromdir, <span class="keyword">sizeof</span>(fromdir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, frombox);
<a name="l04900"></a>04900    <span class="keywordflow">else</span>
<a name="l04901"></a>04901       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fromdir, dir, <span class="keyword">sizeof</span>(fromdir));
<a name="l04902"></a>04902 
<a name="l04903"></a>04903    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(frompath, <span class="keyword">sizeof</span>(frompath), fromdir, msgnum);
<a name="l04904"></a>04904    <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(todir, <span class="keyword">sizeof</span>(todir), recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l04905"></a>04905 
<a name="l04906"></a>04906    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(todir))
<a name="l04907"></a>04907       <span class="keywordflow">return</span> <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;
<a name="l04908"></a>04908 
<a name="l04909"></a>04909    recipmsgnum = <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(recip, todir) + 1;
<a name="l04910"></a>04910    <span class="keywordflow">if</span> (recipmsgnum &lt; recip-&gt;<a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> - (imbox ? 0 : <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 0))) {
<a name="l04911"></a>04911       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(topath, <span class="keyword">sizeof</span>(topath), todir, recipmsgnum);
<a name="l04912"></a>04912       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(fromdir, msgnum, frompath, chan-&gt;language)) {
<a name="l04913"></a>04913          <a class="code" href="app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">COPY</a>(fromdir, msgnum, todir, recipmsgnum, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, frompath, topath);
<a name="l04914"></a>04914       } <span class="keywordflow">else</span> {
<a name="l04915"></a>04915          <span class="comment">/* For ODBC storage, if the file we want to copy isn&apos;t yet in the database, then the SQL</span>
<a name="l04916"></a>04916 <span class="comment">          * copy will fail. Instead, we need to create a local copy, store it, and delete the local</span>
<a name="l04917"></a>04917 <span class="comment">          * copy. We don&apos;t have to #ifdef this because if file storage reaches this point, there&apos;s a</span>
<a name="l04918"></a>04918 <span class="comment">          * much worse problem happening and IMAP storage doesn&apos;t call this function</span>
<a name="l04919"></a>04919 <span class="comment">          */</span>
<a name="l04920"></a>04920          <a class="code" href="app__voicemail_8c.html#aa9165d06328e9d07c0ccbdbf9325f9d1" title="Copies a voicemail information (envelope) file.">copy_plain_file</a>(frompath, topath);
<a name="l04921"></a>04921          <a class="code" href="app__voicemail_8c.html#ab02316037e0d0e5b69b6aef860aabe08">STORE</a>(todir, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, recipmsgnum, chan, recip, fmt, duration, NULL, NULL);
<a name="l04922"></a>04922          <a class="code" href="app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e" title="Removes the voicemail sound and information file.">vm_delete</a>(topath);
<a name="l04923"></a>04923       }
<a name="l04924"></a>04924    } <span class="keywordflow">else</span> {
<a name="l04925"></a>04925       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Recipient mailbox %s@%s is full\n&quot;</span>, recip-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, recip-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l04926"></a>04926    }
<a name="l04927"></a>04927    <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(todir);
<a name="l04928"></a>04928    <a class="code" href="app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158" title="Sends email notification that a user has a new voicemail waiting for them.">notify_new_message</a>(chan, recip, NULL, recipmsgnum, duration, fmt, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, NULL), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL), flag);
<a name="l04929"></a>04929    
<a name="l04930"></a>04930    <span class="keywordflow">return</span> 0;
<a name="l04931"></a>04931 }
<a name="l04932"></a>04932 <span class="preprocessor">#endif</span>
<a name="l04933"></a>04933 <span class="preprocessor"></span><span class="preprocessor">#if !(defined(IMAP_STORAGE) || defined(ODBC_STORAGE))</span>
<a name="l04934"></a>04934 <span class="preprocessor"></span>
<a name="l04935"></a><a class="code" href="app__voicemail_8c.html#a276efe40a0edb56b717e542b711bf5aa">04935</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a276efe40a0edb56b717e542b711bf5aa">messagecount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l04936"></a>04936 {
<a name="l04937"></a>04937    <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, mailbox, folder, 0) + (folder &amp;&amp; strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>) ? 0 : <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, mailbox, <span class="stringliteral">&quot;Urgent&quot;</span>, 0));
<a name="l04938"></a>04938 }
<a name="l04939"></a>04939 
<a name="l04940"></a><a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">04940</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder, <span class="keywordtype">int</span> shortcircuit)
<a name="l04941"></a>04941 {
<a name="l04942"></a>04942    DIR *dir;
<a name="l04943"></a>04943    <span class="keyword">struct </span>dirent *de;
<a name="l04944"></a>04944    <span class="keywordtype">char</span> fn[256];
<a name="l04945"></a>04945    <span class="keywordtype">int</span> ret = 0;
<a name="l04946"></a>04946 
<a name="l04947"></a>04947    <span class="comment">/* If no mailbox, return immediately */</span>
<a name="l04948"></a>04948    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox))
<a name="l04949"></a>04949       <span class="keywordflow">return</span> 0;
<a name="l04950"></a>04950 
<a name="l04951"></a>04951    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(folder))
<a name="l04952"></a>04952       folder = <span class="stringliteral">&quot;INBOX&quot;</span>;
<a name="l04953"></a>04953    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l04954"></a>04954       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l04955"></a>04955 
<a name="l04956"></a>04956    snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s%s/%s/%s&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, mailbox, folder);
<a name="l04957"></a>04957 
<a name="l04958"></a>04958    <span class="keywordflow">if</span> (!(dir = opendir(fn)))
<a name="l04959"></a>04959       <span class="keywordflow">return</span> 0;
<a name="l04960"></a>04960 
<a name="l04961"></a>04961    <span class="keywordflow">while</span> ((de = readdir(dir))) {
<a name="l04962"></a>04962       <span class="keywordflow">if</span> (!strncasecmp(de-&gt;d_name, <span class="stringliteral">&quot;msg&quot;</span>, 3)) {
<a name="l04963"></a>04963          <span class="keywordflow">if</span> (shortcircuit) {
<a name="l04964"></a>04964             ret = 1;
<a name="l04965"></a>04965             <span class="keywordflow">break</span>;
<a name="l04966"></a>04966          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(de-&gt;d_name + 8, <span class="stringliteral">&quot;txt&quot;</span>, 3)) {
<a name="l04967"></a>04967             ret++;
<a name="l04968"></a>04968          }
<a name="l04969"></a>04969       }
<a name="l04970"></a>04970    }
<a name="l04971"></a>04971 
<a name="l04972"></a>04972    closedir(dir);
<a name="l04973"></a>04973 
<a name="l04974"></a>04974    <span class="keywordflow">return</span> ret;
<a name="l04975"></a>04975 }
<a name="l04976"></a>04976 <span class="comment"></span>
<a name="l04977"></a>04977 <span class="comment">/** </span>
<a name="l04978"></a>04978 <span class="comment"> * \brief Determines if the given folder has messages.</span>
<a name="l04979"></a>04979 <span class="comment"> * \param mailbox The @ delimited string for user@context. If no context is found, uses &apos;default&apos; for the context.</span>
<a name="l04980"></a>04980 <span class="comment"> * \param folder the folder to look in</span>
<a name="l04981"></a>04981 <span class="comment"> *</span>
<a name="l04982"></a>04982 <span class="comment"> * This function is used when the mailbox is stored in a filesystem back end.</span>
<a name="l04983"></a>04983 <span class="comment"> * This invokes the __has_voicemail(). Here we are interested in the presence of messages (&gt; 0) only, not the actual count.</span>
<a name="l04984"></a>04984 <span class="comment"> * \return 1 if the folder has one or more messages. zero otherwise.</span>
<a name="l04985"></a>04985 <span class="comment"> */</span>
<a name="l04986"></a><a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7">04986</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7" title="Determines if the given folder has messages.">has_voicemail</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *folder)
<a name="l04987"></a>04987 {
<a name="l04988"></a>04988    <span class="keywordtype">char</span> tmp[256], *tmp2 = tmp, *box, *context;
<a name="l04989"></a>04989    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));
<a name="l04990"></a>04990    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(folder)) {
<a name="l04991"></a>04991       folder = <span class="stringliteral">&quot;INBOX&quot;</span>;
<a name="l04992"></a>04992    }
<a name="l04993"></a>04993    <span class="keywordflow">while</span> ((box = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmp2, <span class="stringliteral">&quot;,&amp;&quot;</span>))) {
<a name="l04994"></a>04994       <span class="keywordflow">if</span> ((context = strchr(box, <span class="charliteral">&apos;@&apos;</span>)))
<a name="l04995"></a>04995          *context++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04996"></a>04996       <span class="keywordflow">else</span>
<a name="l04997"></a>04997          context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l04998"></a>04998       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, box, folder, 1))
<a name="l04999"></a>04999          <span class="keywordflow">return</span> 1;
<a name="l05000"></a>05000       <span class="comment">/* If we are checking INBOX, we should check Urgent as well */</span>
<a name="l05001"></a>05001       <span class="keywordflow">if</span> (!strcmp(folder, <span class="stringliteral">&quot;INBOX&quot;</span>) &amp;&amp; <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, box, <span class="stringliteral">&quot;Urgent&quot;</span>, 1)) {
<a name="l05002"></a>05002          <span class="keywordflow">return</span> 1;
<a name="l05003"></a>05003       }
<a name="l05004"></a>05004    }
<a name="l05005"></a>05005    <span class="keywordflow">return</span> 0;
<a name="l05006"></a>05006 }
<a name="l05007"></a>05007 
<a name="l05008"></a>05008 
<a name="l05009"></a><a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">05009</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *urgentmsgs, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)
<a name="l05010"></a>05010 {
<a name="l05011"></a>05011    <span class="keywordtype">char</span> tmp[256];
<a name="l05012"></a>05012    <span class="keywordtype">char</span> *context;
<a name="l05013"></a>05013 
<a name="l05014"></a>05014    <span class="comment">/* If no mailbox, return immediately */</span>
<a name="l05015"></a>05015    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox))
<a name="l05016"></a>05016       <span class="keywordflow">return</span> 0;
<a name="l05017"></a>05017 
<a name="l05018"></a>05018    <span class="keywordflow">if</span> (newmsgs)
<a name="l05019"></a>05019       *newmsgs = 0;
<a name="l05020"></a>05020    <span class="keywordflow">if</span> (oldmsgs)
<a name="l05021"></a>05021       *oldmsgs = 0;
<a name="l05022"></a>05022    <span class="keywordflow">if</span> (urgentmsgs)
<a name="l05023"></a>05023       *urgentmsgs = 0;
<a name="l05024"></a>05024 
<a name="l05025"></a>05025    <span class="keywordflow">if</span> (strchr(mailbox, <span class="charliteral">&apos;,&apos;</span>)) {
<a name="l05026"></a>05026       <span class="keywordtype">int</span> tmpnew, tmpold, tmpurgent;
<a name="l05027"></a>05027       <span class="keywordtype">char</span> *mb, *cur;
<a name="l05028"></a>05028 
<a name="l05029"></a>05029       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));
<a name="l05030"></a>05030       mb = tmp;
<a name="l05031"></a>05031       <span class="keywordflow">while</span> ((cur = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;mb, <span class="stringliteral">&quot;, &quot;</span>))) {
<a name="l05032"></a>05032          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cur)) {
<a name="l05033"></a>05033             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(cur, urgentmsgs ? &amp;tmpurgent : NULL, newmsgs ? &amp;tmpnew : NULL, oldmsgs ? &amp;tmpold : NULL))
<a name="l05034"></a>05034                <span class="keywordflow">return</span> -1;
<a name="l05035"></a>05035             <span class="keywordflow">else</span> {
<a name="l05036"></a>05036                <span class="keywordflow">if</span> (newmsgs)
<a name="l05037"></a>05037                   *newmsgs += tmpnew; 
<a name="l05038"></a>05038                <span class="keywordflow">if</span> (oldmsgs)
<a name="l05039"></a>05039                   *oldmsgs += tmpold;
<a name="l05040"></a>05040                <span class="keywordflow">if</span> (urgentmsgs)
<a name="l05041"></a>05041                   *urgentmsgs += tmpurgent;
<a name="l05042"></a>05042             }
<a name="l05043"></a>05043          }
<a name="l05044"></a>05044       }
<a name="l05045"></a>05045       <span class="keywordflow">return</span> 0;
<a name="l05046"></a>05046    }
<a name="l05047"></a>05047 
<a name="l05048"></a>05048    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tmp, mailbox, <span class="keyword">sizeof</span>(tmp));
<a name="l05049"></a>05049    
<a name="l05050"></a>05050    <span class="keywordflow">if</span> ((context = strchr(tmp, <span class="charliteral">&apos;@&apos;</span>)))
<a name="l05051"></a>05051       *context++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05052"></a>05052    <span class="keywordflow">else</span>
<a name="l05053"></a>05053       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l05054"></a>05054 
<a name="l05055"></a>05055    <span class="keywordflow">if</span> (newmsgs)
<a name="l05056"></a>05056       *newmsgs = <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, tmp, <span class="stringliteral">&quot;INBOX&quot;</span>, 0);
<a name="l05057"></a>05057    <span class="keywordflow">if</span> (oldmsgs)
<a name="l05058"></a>05058       *oldmsgs = <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, tmp, <span class="stringliteral">&quot;Old&quot;</span>, 0);
<a name="l05059"></a>05059    <span class="keywordflow">if</span> (urgentmsgs)
<a name="l05060"></a>05060       *urgentmsgs = <a class="code" href="app__voicemail_8c.html#a85d50dd448c64ed2edf77efc42dc51fa">__has_voicemail</a>(context, tmp, <span class="stringliteral">&quot;Urgent&quot;</span>, 0);
<a name="l05061"></a>05061 
<a name="l05062"></a>05062    <span class="keywordflow">return</span> 0;
<a name="l05063"></a>05063 }
<a name="l05064"></a>05064 
<a name="l05065"></a>05065 <span class="preprocessor">#endif</span>
<a name="l05066"></a>05066 <span class="preprocessor"></span>
<a name="l05067"></a>05067 <span class="comment">/* Exactly the same function for file-based, ODBC-based, and IMAP-based, so why create 3 different copies? */</span>
<a name="l05068"></a><a class="code" href="app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">05068</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> *newmsgs, <span class="keywordtype">int</span> *oldmsgs)
<a name="l05069"></a>05069 {
<a name="l05070"></a>05070    <span class="keywordtype">int</span> urgentmsgs = 0;
<a name="l05071"></a>05071    <span class="keywordtype">int</span> res = <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(mailbox, &amp;urgentmsgs, newmsgs, oldmsgs);
<a name="l05072"></a>05072    <span class="keywordflow">if</span> (newmsgs) {
<a name="l05073"></a>05073       *newmsgs += urgentmsgs;
<a name="l05074"></a>05074    }
<a name="l05075"></a>05075    <span class="keywordflow">return</span> res;
<a name="l05076"></a>05076 }
<a name="l05077"></a>05077 
<a name="l05078"></a><a class="code" href="app__voicemail_8c.html#a9c5687a6ba659f56c96ebc103673d85a">05078</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a9c5687a6ba659f56c96ebc103673d85a">run_externnotify</a>(<span class="keywordtype">char</span> *context, <span class="keywordtype">char</span> *<a class="code" href="structextension.html">extension</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l05079"></a>05079 {
<a name="l05080"></a>05080    <span class="keywordtype">char</span> arguments[255];
<a name="l05081"></a>05081    <span class="keywordtype">char</span> ext_context[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05082"></a>05082    <span class="keywordtype">int</span> newvoicemails = 0, oldvoicemails = 0, urgentvoicemails = 0;
<a name="l05083"></a>05083    <span class="keyword">struct </span><a class="code" href="structast__smdi__mwi__message.html" title="An SMDI message waiting indicator message.">ast_smdi_mwi_message</a> *mwi_msg;
<a name="l05084"></a>05084 
<a name="l05085"></a>05085    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l05086"></a>05086       snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, extension, context);
<a name="l05087"></a>05087    <span class="keywordflow">else</span>
<a name="l05088"></a>05088       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ext_context, extension, <span class="keyword">sizeof</span>(ext_context));
<a name="l05089"></a>05089 
<a name="l05090"></a>05090    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a>) {
<a name="l05091"></a>05091       <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#ae5953304e56862ac7efc1fed0ac6732f" title="Determine if a given mailbox has any voicemail If folder is NULL, defaults to &amp;quot;INBOX&amp;quot;...">ast_app_has_voicemail</a>(ext_context, NULL)) 
<a name="l05092"></a>05092          <a class="code" href="smdi_8h.html#a4b03364640d2d27d752c09cbafc6c96e" title="Set the MWI indicator for a mailbox.">ast_smdi_mwi_set</a>(<a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a>, extension);
<a name="l05093"></a>05093       <span class="keywordflow">else</span>
<a name="l05094"></a>05094          <a class="code" href="smdi_8h.html#afdb61f0da8c6f539f66c8a7871c7a2fa" title="Unset the MWI indicator for a mailbox.">ast_smdi_mwi_unset</a>(<a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a>, extension);
<a name="l05095"></a>05095 
<a name="l05096"></a>05096       <span class="keywordflow">if</span> ((mwi_msg = <a class="code" href="smdi_8h.html#aa4a0e3987fed1bc93c8c396916688383">ast_smdi_mwi_message_wait_station</a>(<a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a>, <a class="code" href="app__voicemail_8c.html#ab396ba916ebd13b58eedfb621a602413">SMDI_MWI_WAIT_TIMEOUT</a>, extension))) {
<a name="l05097"></a>05097          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Error executing SMDI MWI change for %s\n&quot;</span>, extension);
<a name="l05098"></a>05098          <span class="keywordflow">if</span> (!strncmp(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>, <span class="stringliteral">&quot;INV&quot;</span>, 3))
<a name="l05099"></a>05099             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid MWI extension: %s\n&quot;</span>, mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>);
<a name="l05100"></a>05100          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncmp(mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>, <span class="stringliteral">&quot;BLK&quot;</span>, 3))
<a name="l05101"></a>05101             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;MWI light was already on or off for %s\n&quot;</span>, mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#aa117f98c3165cac31c1cb2da17475fcf">fwd_st</a>);
<a name="l05102"></a>05102          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;The switch reported &apos;%s&apos;\n&quot;</span>, mwi_msg-&gt;<a class="code" href="structast__smdi__mwi__message.html#a3b3500852ae2642c562389b5a8ce9654">cause</a>);
<a name="l05103"></a>05103          <a class="code" href="astobj_8h.html#aed02826b481ce75ec710c1184ac8f059" title="Decrement the reference count on an object.">ASTOBJ_UNREF</a>(mwi_msg, <a class="code" href="smdi_8h.html#adbf3873da6231af24d5a38113d6a8def" title="ast_smdi_mwi_message destructor.">ast_smdi_mwi_message_destroy</a>);
<a name="l05104"></a>05104       } <span class="keywordflow">else</span> {
<a name="l05105"></a>05105          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Successfully executed SMDI MWI change for %s\n&quot;</span>, extension);
<a name="l05106"></a>05106       }
<a name="l05107"></a>05107    }
<a name="l05108"></a>05108 
<a name="l05109"></a>05109    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>)) {
<a name="l05110"></a>05110       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(ext_context, &amp;urgentvoicemails, &amp;newvoicemails, &amp;oldvoicemails)) {
<a name="l05111"></a>05111          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Problem in calculating number of voicemail messages available for extension %s\n&quot;</span>, extension);
<a name="l05112"></a>05112       } <span class="keywordflow">else</span> {
<a name="l05113"></a>05113          snprintf(arguments, <span class="keyword">sizeof</span>(arguments), <span class="stringliteral">&quot;%s %s %s %d %d %d &amp;&quot;</span>, <a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>, context, extension, newvoicemails, oldvoicemails, urgentvoicemails);
<a name="l05114"></a>05114          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Executing %s\n&quot;</span>, arguments);
<a name="l05115"></a>05115          <a class="code" href="app_8h.html#a9fb5cf0385848033ee3e98625e5f9784" title="Safely spawn an external program while closing file descriptors.">ast_safe_system</a>(arguments);
<a name="l05116"></a>05116       }
<a name="l05117"></a>05117    }
<a name="l05118"></a>05118 }
<a name="l05119"></a>05119 <span class="comment"></span>
<a name="l05120"></a>05120 <span class="comment">/*!</span>
<a name="l05121"></a>05121 <span class="comment"> * \brief Variables used for saving a voicemail.</span>
<a name="l05122"></a>05122 <span class="comment"> *</span>
<a name="l05123"></a>05123 <span class="comment"> * This includes the record gain, mode flags, and the exit context of the chanel that was used for leaving the voicemail.</span>
<a name="l05124"></a>05124 <span class="comment"> */</span>
<a name="l05125"></a>05125 <span class="keyword">struct </span><a class="code" href="structleave__vm__options.html" title="Options for leaving voicemail with the voicemail() application.">leave_vm_options</a> {
<a name="l05126"></a>05126    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> flags;
<a name="l05127"></a>05127    <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain;
<a name="l05128"></a><a class="code" href="structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">05128</a>    <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>;
<a name="l05129"></a>05129 };
<a name="l05130"></a>05130 <span class="comment"></span>
<a name="l05131"></a>05131 <span class="comment">/*!</span>
<a name="l05132"></a>05132 <span class="comment"> * \brief Prompts the user and records a voicemail to a mailbox.</span>
<a name="l05133"></a>05133 <span class="comment"> * \param chan</span>
<a name="l05134"></a>05134 <span class="comment"> * \param ext</span>
<a name="l05135"></a>05135 <span class="comment"> * \param options OPT_BUSY_GREETING, OPT_UNAVAIL_GREETING</span>
<a name="l05136"></a>05136 <span class="comment"> * </span>
<a name="l05137"></a>05137 <span class="comment"> * </span>
<a name="l05138"></a>05138 <span class="comment"> * </span>
<a name="l05139"></a>05139 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l05140"></a>05140 <span class="comment"> */</span>
<a name="l05141"></a><a class="code" href="app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff">05141</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff" title="Prompts the user and records a voicemail to a mailbox.">leave_voicemail</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>, <span class="keyword">struct</span> <a class="code" href="structleave__vm__options.html" title="Options for leaving voicemail with the voicemail() application.">leave_vm_options</a> *options)
<a name="l05142"></a>05142 {
<a name="l05143"></a>05143 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l05144"></a>05144 <span class="preprocessor"></span>   <span class="keywordtype">int</span> newmsgs, oldmsgs;
<a name="l05145"></a>05145 <span class="preprocessor">#else</span>
<a name="l05146"></a>05146 <span class="preprocessor"></span>   <span class="keywordtype">char</span> urgdir[PATH_MAX];
<a name="l05147"></a>05147 <span class="preprocessor">#endif</span>
<a name="l05148"></a>05148 <span class="preprocessor"></span>   <span class="keywordtype">char</span> txtfile[PATH_MAX];
<a name="l05149"></a>05149    <span class="keywordtype">char</span> tmptxtfile[PATH_MAX];
<a name="l05150"></a>05150    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *vms = NULL;
<a name="l05151"></a>05151    <span class="keywordtype">char</span> callerid[256];
<a name="l05152"></a>05152    FILE *txt;
<a name="l05153"></a>05153    <span class="keywordtype">char</span> date[256];
<a name="l05154"></a>05154    <span class="keywordtype">int</span> txtdes;
<a name="l05155"></a>05155    <span class="keywordtype">int</span> res = 0;
<a name="l05156"></a>05156    <span class="keywordtype">int</span> msgnum;
<a name="l05157"></a>05157    <span class="keywordtype">int</span> duration = 0;
<a name="l05158"></a>05158    <span class="keywordtype">int</span> ausemacro = 0;
<a name="l05159"></a>05159    <span class="keywordtype">int</span> ousemacro = 0;
<a name="l05160"></a>05160    <span class="keywordtype">int</span> ouseexten = 0;
<a name="l05161"></a>05161    <span class="keywordtype">char</span> tmpdur[16];
<a name="l05162"></a>05162    <span class="keywordtype">char</span> priority[16];
<a name="l05163"></a>05163    <span class="keywordtype">char</span> origtime[16];
<a name="l05164"></a>05164    <span class="keywordtype">char</span> dir[PATH_MAX];
<a name="l05165"></a>05165    <span class="keywordtype">char</span> tmpdir[PATH_MAX];
<a name="l05166"></a>05166    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l05167"></a>05167    <span class="keywordtype">char</span> prefile[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05168"></a>05168    <span class="keywordtype">char</span> tempfile[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05169"></a>05169    <span class="keywordtype">char</span> ext_context[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05170"></a>05170    <span class="keywordtype">char</span> fmt[80];
<a name="l05171"></a>05171    <span class="keywordtype">char</span> *context;
<a name="l05172"></a>05172    <span class="keywordtype">char</span> ecodes[17] = <span class="stringliteral">&quot;#&quot;</span>;
<a name="l05173"></a>05173    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *tmp = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(16);
<a name="l05174"></a>05174    <span class="keywordtype">char</span> *tmpptr;
<a name="l05175"></a>05175    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l05176"></a>05176    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> svm;
<a name="l05177"></a>05177    <span class="keyword">const</span> <span class="keywordtype">char</span> *category = NULL;
<a name="l05178"></a>05178    <span class="keyword">const</span> <span class="keywordtype">char</span> *code;
<a name="l05179"></a>05179    <span class="keyword">const</span> <span class="keywordtype">char</span> *alldtmf = <span class="stringliteral">&quot;0123456789ABCD*#&quot;</span>;
<a name="l05180"></a>05180    <span class="keywordtype">char</span> flag[80];
<a name="l05181"></a>05181 
<a name="l05182"></a>05182    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;tmp, 0, <span class="stringliteral">&quot;%s&quot;</span>, ext);
<a name="l05183"></a>05183    ext = <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(tmp);
<a name="l05184"></a>05184    <span class="keywordflow">if</span> ((context = strchr(ext, <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l05185"></a>05185       *context++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05186"></a>05186       tmpptr = strchr(context, <span class="charliteral">&apos;&amp;&apos;</span>);
<a name="l05187"></a>05187    } <span class="keywordflow">else</span> {
<a name="l05188"></a>05188       tmpptr = strchr(ext, <span class="charliteral">&apos;&amp;&apos;</span>);
<a name="l05189"></a>05189    }
<a name="l05190"></a>05190 
<a name="l05191"></a>05191    <span class="keywordflow">if</span> (tmpptr)
<a name="l05192"></a>05192       *tmpptr++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05193"></a>05193 
<a name="l05194"></a>05194    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l05195"></a>05195    <span class="keywordflow">if</span> ((category = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;VM_CATEGORY&quot;</span>))) {
<a name="l05196"></a>05196       category = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(category);
<a name="l05197"></a>05197    }
<a name="l05198"></a>05198    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l05199"></a>05199 
<a name="l05200"></a>05200    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a>)) {
<a name="l05201"></a>05201       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(flag, <span class="stringliteral">&quot;Urgent&quot;</span>, <span class="keyword">sizeof</span>(flag));
<a name="l05202"></a>05202    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a>)) {
<a name="l05203"></a>05203       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(flag, <span class="stringliteral">&quot;PRIORITY&quot;</span>, <span class="keyword">sizeof</span>(flag));
<a name="l05204"></a>05204    } <span class="keywordflow">else</span> {
<a name="l05205"></a>05205       flag[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05206"></a>05206    }
<a name="l05207"></a>05207 
<a name="l05208"></a>05208    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Before find_user\n&quot;</span>);
<a name="l05209"></a>05209    <span class="keywordflow">if</span> (!(vmu = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;svm, context, ext))) {
<a name="l05210"></a>05210       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No entry in voicemail config file for &apos;%s&apos;\n&quot;</span>, ext);
<a name="l05211"></a>05211       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l05212"></a>05212       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05213"></a>05213       <span class="keywordflow">return</span> res;
<a name="l05214"></a>05214    }
<a name="l05215"></a>05215    <span class="comment">/* Setup pre-file if appropriate */</span>
<a name="l05216"></a>05216    <span class="keywordflow">if</span> (strcmp(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;default&quot;</span>))
<a name="l05217"></a>05217       snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, ext, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l05218"></a>05218    <span class="keywordflow">else</span>
<a name="l05219"></a>05219       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(ext_context, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="keyword">sizeof</span>(ext_context));
<a name="l05220"></a>05220 
<a name="l05221"></a>05221    <span class="comment">/* Set the path to the prefile. Will be one of </span>
<a name="l05222"></a>05222 <span class="comment">      VM_SPOOL_DIRcontext/ext/busy</span>
<a name="l05223"></a>05223 <span class="comment">      VM_SPOOL_DIRcontext/ext/unavail</span>
<a name="l05224"></a>05224 <span class="comment">      Depending on the flag set in options.</span>
<a name="l05225"></a>05225 <span class="comment">   */</span>
<a name="l05226"></a>05226    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a>)) {
<a name="l05227"></a>05227       snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/busy&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext);
<a name="l05228"></a>05228    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a>)) {
<a name="l05229"></a>05229       snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/unavail&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext);
<a name="l05230"></a>05230    }
<a name="l05231"></a>05231    <span class="comment">/* Set the path to the tmpfile as</span>
<a name="l05232"></a>05232 <span class="comment">      VM_SPOOL_DIR/context/ext/temp</span>
<a name="l05233"></a>05233 <span class="comment">      and attempt to create the folder structure.</span>
<a name="l05234"></a>05234 <span class="comment">   */</span>
<a name="l05235"></a>05235    snprintf(tempfile, <span class="keyword">sizeof</span>(tempfile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext);
<a name="l05236"></a>05236    <span class="keywordflow">if</span> ((res = <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(tmpdir, <span class="keyword">sizeof</span>(tmpdir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext, <span class="stringliteral">&quot;tmp&quot;</span>))) {
<a name="l05237"></a>05237       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to make directory (%s)\n&quot;</span>, tempfile);
<a name="l05238"></a>05238       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05239"></a>05239       <span class="keywordflow">return</span> -1;
<a name="l05240"></a>05240    }
<a name="l05241"></a>05241    <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(tempfile, -1, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l05242"></a>05242    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(tempfile, NULL, NULL) &gt; 0)
<a name="l05243"></a>05243       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(prefile, tempfile, <span class="keyword">sizeof</span>(prefile));
<a name="l05244"></a>05244 
<a name="l05245"></a>05245    <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(tempfile, -1);
<a name="l05246"></a>05246    <span class="comment">/* It&apos;s easier just to try to make it than to check for its existence */</span>
<a name="l05247"></a>05247    <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(dir, <span class="keyword">sizeof</span>(dir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext, <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l05248"></a>05248 
<a name="l05249"></a>05249    <span class="comment">/* Check current or macro-calling context for special extensions */</span>
<a name="l05250"></a>05250    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>)) {
<a name="l05251"></a>05251       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {
<a name="l05252"></a>05252          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="stringliteral">&quot;o&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l05253"></a>05253             strncat(ecodes, <span class="stringliteral">&quot;0&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05254"></a>05254             ouseexten = 1;
<a name="l05255"></a>05255          }
<a name="l05256"></a>05256       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;o&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l05257"></a>05257          strncat(ecodes, <span class="stringliteral">&quot;0&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05258"></a>05258          ouseexten = 1;
<a name="l05259"></a>05259       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>) &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="stringliteral">&quot;o&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l05260"></a>05260          strncat(ecodes, <span class="stringliteral">&quot;0&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05261"></a>05261          ousemacro = 1;
<a name="l05262"></a>05262       }
<a name="l05263"></a>05263    }
<a name="l05264"></a>05264 
<a name="l05265"></a>05265    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {
<a name="l05266"></a>05266       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="stringliteral">&quot;a&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>))
<a name="l05267"></a>05267          strncat(ecodes, <span class="stringliteral">&quot;*&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05268"></a>05268    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;a&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>))
<a name="l05269"></a>05269       strncat(ecodes, <span class="stringliteral">&quot;*&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05270"></a>05270    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>) &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="stringliteral">&quot;a&quot;</span>, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>)) {
<a name="l05271"></a>05271       strncat(ecodes, <span class="stringliteral">&quot;*&quot;</span>, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05272"></a>05272       ausemacro = 1;
<a name="l05273"></a>05273    }
<a name="l05274"></a>05274 
<a name="l05275"></a>05275    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>)) {
<a name="l05276"></a>05276       <span class="keywordflow">for</span> (code = alldtmf; *code; code++) {
<a name="l05277"></a>05277          <span class="keywordtype">char</span> e[2] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l05278"></a>05278          e[0] = *code;
<a name="l05279"></a>05279          <span class="keywordflow">if</span> (strchr(ecodes, e[0]) == NULL &amp;&amp; <a class="code" href="pbx_8h.html#a93f9868530c1e8a9d9d367d1ead8782e" title="Looks for a valid matching extension.">ast_canmatch_extension</a>(chan, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, e, 1, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>))
<a name="l05280"></a>05280             strncat(ecodes, e, <span class="keyword">sizeof</span>(ecodes) - strlen(ecodes) - 1);
<a name="l05281"></a>05281       }
<a name="l05282"></a>05282    }
<a name="l05283"></a>05283 
<a name="l05284"></a>05284    <span class="comment">/* Play the beginning intro if desired */</span>
<a name="l05285"></a>05285    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(prefile)) {
<a name="l05286"></a>05286 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l05287"></a>05287 <span class="preprocessor"></span>      <span class="keywordtype">int</span> success = 
<a name="l05288"></a>05288 <span class="preprocessor">#endif</span>
<a name="l05289"></a>05289 <span class="preprocessor"></span>         <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, ext, context);
<a name="l05290"></a>05290       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &gt; 0) {
<a name="l05291"></a>05291          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, prefile, chan-&gt;language) &gt; -1) 
<a name="l05292"></a>05292             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, ecodes);
<a name="l05293"></a>05293 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l05294"></a>05294 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (success == -1) {
<a name="l05295"></a>05295             <span class="comment">/* We couldn&apos;t retrieve the file from the database, but we found it on the file system. Let&apos;s put it in the database. */</span>
<a name="l05296"></a>05296             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Greeting not retrieved from database, but found in file storage. Inserting into database\n&quot;</span>);
<a name="l05297"></a>05297             store_file(prefile, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05298"></a>05298          }
<a name="l05299"></a>05299 <span class="preprocessor">#endif</span>
<a name="l05300"></a>05300 <span class="preprocessor"></span>      } <span class="keywordflow">else</span> {
<a name="l05301"></a>05301          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s doesn&apos;t exist, doing what we can\n&quot;</span>, prefile);
<a name="l05302"></a>05302          res = <a class="code" href="app__voicemail_8c.html#a351a8aa4db36ca91592694f589709456">invent_message</a>(chan, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a>), ecodes);
<a name="l05303"></a>05303       }
<a name="l05304"></a>05304       <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);
<a name="l05305"></a>05305       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l05306"></a>05306          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Hang up during prefile playback\n&quot;</span>);
<a name="l05307"></a>05307          <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l05308"></a>05308          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l05309"></a>05309          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05310"></a>05310          <span class="keywordflow">return</span> -1;
<a name="l05311"></a>05311       }
<a name="l05312"></a>05312    }
<a name="l05313"></a>05313    <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l05314"></a>05314       <span class="comment">/* On a &apos;#&apos; we skip the instructions */</span>
<a name="l05315"></a>05315       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(options, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);
<a name="l05316"></a>05316       res = 0;
<a name="l05317"></a>05317    }
<a name="l05318"></a>05318    <span class="keywordflow">if</span> (!res &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>)) {
<a name="l05319"></a>05319       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">INTRO</a>, ecodes);
<a name="l05320"></a>05320       <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l05321"></a>05321          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(options, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);
<a name="l05322"></a>05322          res = 0;
<a name="l05323"></a>05323       }
<a name="l05324"></a>05324    }
<a name="l05325"></a>05325    <span class="keywordflow">if</span> (res &gt; 0)
<a name="l05326"></a>05326       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l05327"></a>05327    <span class="comment">/* Check for a &apos;*&apos; here in case the caller wants to escape from voicemail to something</span>
<a name="l05328"></a>05328 <span class="comment">    other than the operator -- an automated attendant or mailbox login for example */</span>
<a name="l05329"></a>05329    <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l05330"></a>05330       chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>[0] = <span class="charliteral">&apos;a&apos;</span>;
<a name="l05331"></a>05331       chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05332"></a>05332       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {
<a name="l05333"></a>05333          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l05334"></a>05334       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ausemacro &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>)) {
<a name="l05335"></a>05335          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l05336"></a>05336       }
<a name="l05337"></a>05337       chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l05338"></a>05338       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l05339"></a>05339       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;USEREXIT&quot;</span>);
<a name="l05340"></a>05340       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05341"></a>05341       <span class="keywordflow">return</span> 0;
<a name="l05342"></a>05342    }
<a name="l05343"></a>05343 
<a name="l05344"></a>05344    <span class="comment">/* Check for a &apos;0&apos; here */</span>
<a name="l05345"></a>05345    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>) &amp;&amp; res == <span class="charliteral">&apos;0&apos;</span>) {
<a name="l05346"></a>05346    <a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>:
<a name="l05347"></a>05347       <span class="keywordflow">if</span> (ouseexten || ousemacro) {
<a name="l05348"></a>05348          chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>[0] = <span class="charliteral">&apos;o&apos;</span>;
<a name="l05349"></a>05349          chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05350"></a>05350          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>)) {
<a name="l05351"></a>05351             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l05352"></a>05352          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ousemacro &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>)) {
<a name="l05353"></a>05353             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l05354"></a>05354          }
<a name="l05355"></a>05355          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;transfer&quot;</span>);
<a name="l05356"></a>05356          chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l05357"></a>05357          <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l05358"></a>05358          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;USEREXIT&quot;</span>);
<a name="l05359"></a>05359       }
<a name="l05360"></a>05360       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05361"></a>05361       <span class="keywordflow">return</span> 0;
<a name="l05362"></a>05362    }
<a name="l05363"></a>05363 
<a name="l05364"></a>05364    <span class="comment">/* Allow all other digits to exit Voicemail and return to the dialplan */</span>
<a name="l05365"></a>05365    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(options, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>) &amp;&amp; res &gt; 0) {
<a name="l05366"></a>05366       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(options-&gt;<a class="code" href="structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a>))
<a name="l05367"></a>05367          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, options-&gt;<a class="code" href="structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l05368"></a>05368       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l05369"></a>05369       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;USEREXIT&quot;</span>);
<a name="l05370"></a>05370       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05371"></a>05371       <span class="keywordflow">return</span> res;
<a name="l05372"></a>05372    }
<a name="l05373"></a>05373 
<a name="l05374"></a>05374    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l05375"></a>05375       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l05376"></a>05376       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l05377"></a>05377       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05378"></a>05378       <span class="keywordflow">return</span> -1;
<a name="l05379"></a>05379    }
<a name="l05380"></a>05380    <span class="comment">/* The meat of recording the message...  All the announcements and beeps have been played*/</span>
<a name="l05381"></a>05381    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fmt, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, <span class="keyword">sizeof</span>(fmt));
<a name="l05382"></a>05382    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(fmt)) {
<a name="l05383"></a>05383       msgnum = 0;
<a name="l05384"></a>05384 
<a name="l05385"></a>05385 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l05386"></a>05386 <span class="preprocessor"></span>      <span class="comment">/* Is ext a mailbox? */</span>
<a name="l05387"></a>05387       <span class="comment">/* must open stream for this user to get info! */</span>
<a name="l05388"></a>05388       res = <a class="code" href="app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(ext_context, &amp;newmsgs, &amp;oldmsgs);
<a name="l05389"></a>05389       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l05390"></a>05390          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Can not leave voicemail, unable to count messages\n&quot;</span>);
<a name="l05391"></a>05391          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05392"></a>05392          <span class="keywordflow">return</span> -1;
<a name="l05393"></a>05393       }
<a name="l05394"></a>05394       <span class="keywordflow">if</span> (!(vms = get_vm_state_by_mailbox(ext, context, 0))) {
<a name="l05395"></a>05395       <span class="comment">/* It is possible under certain circumstances that inboxcount did not</span>
<a name="l05396"></a>05396 <span class="comment">       * create a vm_state when it was needed. This is a catchall which will</span>
<a name="l05397"></a>05397 <span class="comment">       * rarely be used.</span>
<a name="l05398"></a>05398 <span class="comment">       */</span>
<a name="l05399"></a>05399          <span class="keywordflow">if</span> (!(vms = create_vm_state_from_user(vmu))) {
<a name="l05400"></a>05400             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t allocate necessary space\n&quot;</span>);
<a name="l05401"></a>05401             <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05402"></a>05402             <span class="keywordflow">return</span> -1;
<a name="l05403"></a>05403          }
<a name="l05404"></a>05404       }
<a name="l05405"></a>05405       vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>++;
<a name="l05406"></a>05406       
<a name="l05407"></a>05407       <span class="comment">/* here is a big difference! We add one to it later */</span>
<a name="l05408"></a>05408       msgnum = newmsgs + oldmsgs;
<a name="l05409"></a>05409       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Messagecount set to %d\n&quot;</span>,msgnum);
<a name="l05410"></a>05410       snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s/imap/msg%s%04d&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, msgnum);
<a name="l05411"></a>05411       <span class="comment">/* set variable for compatibility */</span>
<a name="l05412"></a>05412       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VM_MESSAGEFILE&quot;</span>, <span class="stringliteral">&quot;IMAP_STORAGE&quot;</span>);
<a name="l05413"></a>05413 
<a name="l05414"></a>05414       <span class="comment">/* Check if mailbox is full */</span>
<a name="l05415"></a>05415       check_quota(vms, imapfolder);
<a name="l05416"></a>05416       <span class="keywordflow">if</span> (vms-&gt;quota_limit &amp;&amp; vms-&gt;quota_usage &gt;= vms-&gt;quota_limit) {
<a name="l05417"></a>05417          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;*** QUOTA EXCEEDED!! %u &gt;= %u\n&quot;</span>, vms-&gt;quota_usage, vms-&gt;quota_limit);
<a name="l05418"></a>05418          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);
<a name="l05419"></a>05419          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05420"></a>05420          <span class="keywordflow">return</span> -1;
<a name="l05421"></a>05421       }
<a name="l05422"></a>05422       
<a name="l05423"></a>05423       <span class="comment">/* Check if we have exceeded maxmsg */</span>
<a name="l05424"></a>05424       <span class="keywordflow">if</span> (msgnum &gt;= vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>  - <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 0)) {
<a name="l05425"></a>05425          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to leave message since we will exceed the maximum number of messages allowed (%u &gt; %u)\n&quot;</span>, msgnum, vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);
<a name="l05426"></a>05426          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);
<a name="l05427"></a>05427          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05428"></a>05428          <span class="keywordflow">return</span> -1;
<a name="l05429"></a>05429       }
<a name="l05430"></a>05430 <span class="preprocessor">#else</span>
<a name="l05431"></a>05431 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6" title="Find all .txt files - even if they are not in sequence from 0000.">count_messages</a>(vmu, dir) &gt;= vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> - <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, +1)) {
<a name="l05432"></a>05432          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>, chan-&gt;language);
<a name="l05433"></a>05433          <span class="keywordflow">if</span> (!res)
<a name="l05434"></a>05434             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05435"></a>05435          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No more messages possible\n&quot;</span>);
<a name="l05436"></a>05436          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l05437"></a>05437          <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05438"></a>05438          <span class="keywordflow">goto</span> leave_vm_out;
<a name="l05439"></a>05439       }
<a name="l05440"></a>05440 
<a name="l05441"></a>05441 <span class="preprocessor">#endif</span>
<a name="l05442"></a>05442 <span class="preprocessor"></span>      snprintf(tmptxtfile, <span class="keyword">sizeof</span>(tmptxtfile), <span class="stringliteral">&quot;%s/XXXXXX&quot;</span>, tmpdir);
<a name="l05443"></a>05443       txtdes = mkstemp(tmptxtfile);
<a name="l05444"></a>05444       chmod(tmptxtfile, <a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a> &amp; ~<a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a>);
<a name="l05445"></a>05445       <span class="keywordflow">if</span> (txtdes &lt; 0) {
<a name="l05446"></a>05446          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>, chan-&gt;language);
<a name="l05447"></a>05447          <span class="keywordflow">if</span> (!res)
<a name="l05448"></a>05448             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05449"></a>05449          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to create message file: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l05450"></a>05450          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l05451"></a>05451          <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05452"></a>05452          <span class="keywordflow">goto</span> leave_vm_out;
<a name="l05453"></a>05453       }
<a name="l05454"></a>05454 
<a name="l05455"></a>05455       <span class="comment">/* Now play the beep once we have the message number for our next message. */</span>
<a name="l05456"></a>05456       <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l05457"></a>05457          <span class="comment">/* Unless we&apos;re *really* silent, try to send the beep */</span>
<a name="l05458"></a>05458          res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05459"></a>05459       }
<a name="l05460"></a>05460             
<a name="l05461"></a>05461       <span class="comment">/* Store information in real-time storage */</span>
<a name="l05462"></a>05462       <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l05463"></a>05463          snprintf(priority, <span class="keyword">sizeof</span>(priority), <span class="stringliteral">&quot;%d&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l05464"></a>05464          snprintf(origtime, <span class="keyword">sizeof</span>(origtime), <span class="stringliteral">&quot;%ld&quot;</span>, (<span class="keywordtype">long</span>)time(NULL));
<a name="l05465"></a>05465          <a class="code" href="app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271" title="Gets the current date and time, as formatted string.">get_date</a>(date, <span class="keyword">sizeof</span>(date));
<a name="l05466"></a>05466          <a class="code" href="config_8h.html#abbd9786e26d09dce06c32a53fd3c0cc2" title="Create realtime configuration.">ast_store_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;origmailbox&quot;</span>, ext, <span class="stringliteral">&quot;context&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="stringliteral">&quot;macrocontext&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="stringliteral">&quot;exten&quot;</span>, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="stringliteral">&quot;priority&quot;</span>, priority, <span class="stringliteral">&quot;callerchan&quot;</span>, chan-&gt;name, <span class="stringliteral">&quot;callerid&quot;</span>, <a class="code" href="callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(callerid, <span class="keyword">sizeof</span>(callerid), chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;Unknown&quot;</span>), <span class="stringliteral">&quot;origdate&quot;</span>, date, <span class="stringliteral">&quot;origtime&quot;</span>, origtime, <span class="stringliteral">&quot;category&quot;</span>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(category,<span class="stringliteral">&quot;&quot;</span>), <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l05467"></a>05467       }
<a name="l05468"></a>05468 
<a name="l05469"></a>05469       <span class="comment">/* Store information */</span>
<a name="l05470"></a>05470       txt = fdopen(txtdes, <span class="stringliteral">&quot;w+&quot;</span>);
<a name="l05471"></a>05471       <span class="keywordflow">if</span> (txt) {
<a name="l05472"></a>05472          <a class="code" href="app__voicemail_8c.html#aec217dce71a357d4890727f2a1a0a271" title="Gets the current date and time, as formatted string.">get_date</a>(date, <span class="keyword">sizeof</span>(date));
<a name="l05473"></a>05473          fprintf(txt, 
<a name="l05474"></a>05474             <span class="stringliteral">&quot;;\n&quot;</span>
<a name="l05475"></a>05475             <span class="stringliteral">&quot;; Message Information file\n&quot;</span>
<a name="l05476"></a>05476             <span class="stringliteral">&quot;;\n&quot;</span>
<a name="l05477"></a>05477             <span class="stringliteral">&quot;[message]\n&quot;</span>
<a name="l05478"></a>05478             <span class="stringliteral">&quot;origmailbox=%s\n&quot;</span>
<a name="l05479"></a>05479             <span class="stringliteral">&quot;context=%s\n&quot;</span>
<a name="l05480"></a>05480             <span class="stringliteral">&quot;macrocontext=%s\n&quot;</span>
<a name="l05481"></a>05481             <span class="stringliteral">&quot;exten=%s\n&quot;</span>
<a name="l05482"></a>05482             <span class="stringliteral">&quot;priority=%d\n&quot;</span>
<a name="l05483"></a>05483             <span class="stringliteral">&quot;callerchan=%s\n&quot;</span>
<a name="l05484"></a>05484             <span class="stringliteral">&quot;callerid=%s\n&quot;</span>
<a name="l05485"></a>05485             <span class="stringliteral">&quot;origdate=%s\n&quot;</span>
<a name="l05486"></a>05486             <span class="stringliteral">&quot;origtime=%ld\n&quot;</span>
<a name="l05487"></a>05487             <span class="stringliteral">&quot;category=%s\n&quot;</span>,
<a name="l05488"></a>05488             ext,
<a name="l05489"></a>05489             chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>,
<a name="l05490"></a>05490             chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, 
<a name="l05491"></a>05491             chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>,
<a name="l05492"></a>05492             chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>,
<a name="l05493"></a>05493             chan-&gt;name,
<a name="l05494"></a>05494             <a class="code" href="callerid_8h.html#a1c25633b1ed63682c95ec613d7cbe559">ast_callerid_merge</a>(callerid, <span class="keyword">sizeof</span>(callerid), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, NULL), <span class="stringliteral">&quot;Unknown&quot;</span>),
<a name="l05495"></a>05495             date, (<span class="keywordtype">long</span>)time(NULL),
<a name="l05496"></a>05496             category ? category : <span class="stringliteral">&quot;&quot;</span>);
<a name="l05497"></a>05497       } <span class="keywordflow">else</span> {
<a name="l05498"></a>05498          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Error opening text file for output\n&quot;</span>);
<a name="l05499"></a>05499          <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05500"></a>05500          <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l05501"></a>05501             <a class="code" href="config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3" title="Destroy realtime configuration.">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l05502"></a>05502          }
<a name="l05503"></a>05503          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>, chan-&gt;language);
<a name="l05504"></a>05504          <span class="keywordflow">goto</span> leave_vm_out;
<a name="l05505"></a>05505       }
<a name="l05506"></a>05506       res = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, NULL, tmptxtfile, vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>, fmt, 1, vmu, &amp;duration, NULL, options-&gt;<a class="code" href="structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a>, vms, flag);
<a name="l05507"></a>05507 
<a name="l05508"></a>05508       <span class="keywordflow">if</span> (txt) {
<a name="l05509"></a>05509          fprintf(txt, <span class="stringliteral">&quot;flag=%s\n&quot;</span>, flag);
<a name="l05510"></a>05510          <span class="keywordflow">if</span> (duration &lt; <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>) {
<a name="l05511"></a>05511             fclose(txt);
<a name="l05512"></a>05512             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 2) 
<a name="l05513"></a>05513                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>( <a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;Recording was %d seconds long but needs to be at least %d - abandoning\n&quot;</span>, duration, <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>);
<a name="l05514"></a>05514             <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(tmptxtfile, NULL);
<a name="l05515"></a>05515             unlink(tmptxtfile);
<a name="l05516"></a>05516             <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l05517"></a>05517                <a class="code" href="config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3" title="Destroy realtime configuration.">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l05518"></a>05518             }
<a name="l05519"></a>05519             <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05520"></a>05520          } <span class="keywordflow">else</span> {
<a name="l05521"></a>05521             fprintf(txt, <span class="stringliteral">&quot;duration=%d\n&quot;</span>, duration);
<a name="l05522"></a>05522             fclose(txt);
<a name="l05523"></a>05523             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(dir)) {
<a name="l05524"></a>05524                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t lock directory %s.  Voicemail will be lost.\n&quot;</span>, dir);
<a name="l05525"></a>05525                <span class="comment">/* Delete files */</span>
<a name="l05526"></a>05526                <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(tmptxtfile, NULL);
<a name="l05527"></a>05527                unlink(tmptxtfile);
<a name="l05528"></a>05528                <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05529"></a>05529             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(tmptxtfile, NULL, NULL) &lt;= 0) {
<a name="l05530"></a>05530                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;The recorded media file is gone, so we should remove the .txt file too!\n&quot;</span>);
<a name="l05531"></a>05531                unlink(tmptxtfile);
<a name="l05532"></a>05532                <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(dir);
<a name="l05533"></a>05533                <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05534"></a>05534                <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l05535"></a>05535                   <a class="code" href="config_8h.html#a944fdb5d328401dee4c35ebd413d3bc3" title="Destroy realtime configuration.">ast_destroy_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l05536"></a>05536                }
<a name="l05537"></a>05537             } <span class="keywordflow">else</span> {
<a name="l05538"></a>05538 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l05539"></a>05539 <span class="preprocessor"></span>               msgnum = <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(vmu, dir) + 1;
<a name="l05540"></a>05540 <span class="preprocessor">#endif</span>
<a name="l05541"></a>05541 <span class="preprocessor"></span>               <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);
<a name="l05542"></a>05542 
<a name="l05543"></a>05543                <span class="comment">/* assign a variable with the name of the voicemail file */</span> 
<a name="l05544"></a>05544 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l05545"></a>05545 <span class="preprocessor"></span>               <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VM_MESSAGEFILE&quot;</span>, fn);
<a name="l05546"></a>05546 <span class="preprocessor">#else</span>
<a name="l05547"></a>05547 <span class="preprocessor"></span>               <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VM_MESSAGEFILE&quot;</span>, <span class="stringliteral">&quot;IMAP_STORAGE&quot;</span>);
<a name="l05548"></a>05548 <span class="preprocessor">#endif</span>
<a name="l05549"></a>05549 <span class="preprocessor"></span>
<a name="l05550"></a>05550                snprintf(txtfile, <span class="keyword">sizeof</span>(txtfile), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);
<a name="l05551"></a>05551                <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(tmptxtfile, fn, NULL);
<a name="l05552"></a>05552                rename(tmptxtfile, txtfile);
<a name="l05553"></a>05553                <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05554"></a>05554 
<a name="l05555"></a>05555                <span class="comment">/* Properly set permissions on voicemail text descriptor file.</span>
<a name="l05556"></a>05556 <span class="comment">                  Unfortunately mkstemp() makes this file 0600 on most unix systems. */</span>
<a name="l05557"></a>05557                <span class="keywordflow">if</span> (chmod(txtfile, <a class="code" href="app__voicemail_8c.html#ad7a947388a2ca648ab06fc5c510524d4">VOICEMAIL_FILE_MODE</a>) &lt; 0)
<a name="l05558"></a>05558                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Couldn&apos;t set permissions on voicemail text file %s: %s&quot;</span>, txtfile, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l05559"></a>05559 
<a name="l05560"></a>05560                <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(dir);
<a name="l05561"></a>05561                <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l05562"></a>05562                   snprintf(tmpdur, <span class="keyword">sizeof</span>(tmpdur), <span class="stringliteral">&quot;%d&quot;</span>, duration);
<a name="l05563"></a>05563                   <a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, tmptxtfile, <span class="stringliteral">&quot;filename&quot;</span>, fn, <span class="stringliteral">&quot;duration&quot;</span>, tmpdur, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l05564"></a>05564                }
<a name="l05565"></a>05565                <span class="comment">/* We must store the file first, before copying the message, because</span>
<a name="l05566"></a>05566 <span class="comment">                * ODBC storage does the entire copy with SQL.</span>
<a name="l05567"></a>05567 <span class="comment">                */</span>
<a name="l05568"></a>05568                <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(fn, NULL, NULL) &gt; 0) {
<a name="l05569"></a>05569                   <a class="code" href="app__voicemail_8c.html#ab02316037e0d0e5b69b6aef860aabe08">STORE</a>(dir, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, msgnum, chan, vmu, fmt, duration, vms, flag);
<a name="l05570"></a>05570                }
<a name="l05571"></a>05571 
<a name="l05572"></a>05572                <span class="comment">/* Are there to be more recipients of this message? */</span>
<a name="l05573"></a>05573                <span class="keywordflow">while</span> (tmpptr) {
<a name="l05574"></a>05574                   <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> recipu, *recip;
<a name="l05575"></a>05575                   <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, *cntx;
<a name="l05576"></a>05576                
<a name="l05577"></a>05577                   exten = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tmpptr, <span class="stringliteral">&quot;&amp;&quot;</span>);
<a name="l05578"></a>05578                   cntx = strchr(exten, <span class="charliteral">&apos;@&apos;</span>);
<a name="l05579"></a>05579                   <span class="keywordflow">if</span> (cntx) {
<a name="l05580"></a>05580                      *cntx = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l05581"></a>05581                      cntx++;
<a name="l05582"></a>05582                   }
<a name="l05583"></a>05583                   <span class="keywordflow">if</span> ((recip = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;recipu, cntx, exten))) {
<a name="l05584"></a>05584                      <a class="code" href="app__voicemail_8c.html#a6a81ca7c488e8311134145f6c11c16b9" title="Copies a message from one mailbox to another.">copy_message</a>(chan, vmu, 0, msgnum, duration, recip, fmt, dir, flag);
<a name="l05585"></a>05585                      <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(recip);
<a name="l05586"></a>05586                   }
<a name="l05587"></a>05587                }
<a name="l05588"></a>05588 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l05589"></a>05589 <span class="preprocessor"></span>               <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) { <span class="comment">/* If this is an Urgent message */</span>
<a name="l05590"></a>05590                   <span class="comment">/* Move the message from INBOX to Urgent folder if this is urgent! */</span>
<a name="l05591"></a>05591                   <span class="keywordtype">char</span> sfn[PATH_MAX];
<a name="l05592"></a>05592                   <span class="keywordtype">char</span> dfn[PATH_MAX];
<a name="l05593"></a>05593                   <span class="keywordtype">int</span> x;
<a name="l05594"></a>05594                   <span class="comment">/* It&apos;s easier just to try to make it than to check for its existence */</span>
<a name="l05595"></a>05595                   <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(urgdir, <span class="keyword">sizeof</span>(urgdir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ext, <span class="stringliteral">&quot;Urgent&quot;</span>);
<a name="l05596"></a>05596                   x = <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(vmu, urgdir) + 1;
<a name="l05597"></a>05597                   <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(sfn, <span class="keyword">sizeof</span>(sfn), dir, msgnum);
<a name="l05598"></a>05598                   <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(dfn, <span class="keyword">sizeof</span>(dfn), urgdir, x);
<a name="l05599"></a>05599                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Created an Urgent message, moving file from %s to %s.\n&quot;</span>, sfn, dfn);
<a name="l05600"></a>05600                   <a class="code" href="app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a>(dir, msgnum, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, urgdir, x, sfn, dfn);
<a name="l05601"></a>05601                   <span class="comment">/* Notification must happen for this new message in Urgent folder, not INBOX */</span>
<a name="l05602"></a>05602                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fn, dfn, <span class="keyword">sizeof</span>(fn));
<a name="l05603"></a>05603                   msgnum = x;
<a name="l05604"></a>05604                }
<a name="l05605"></a>05605 <span class="preprocessor">#endif</span>
<a name="l05606"></a>05606 <span class="preprocessor"></span>               <span class="comment">/* Notification needs to happen after the copy, though. */</span>
<a name="l05607"></a>05607                <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(fn, NULL, NULL)) {
<a name="l05608"></a>05608 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l05609"></a>05609 <span class="preprocessor"></span>                  <a class="code" href="app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158" title="Sends email notification that a user has a new voicemail waiting for them.">notify_new_message</a>(chan, vmu, vms, msgnum, duration, fmt, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, NULL), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL), flag);
<a name="l05610"></a>05610 <span class="preprocessor">#else</span>
<a name="l05611"></a>05611 <span class="preprocessor"></span>                  <a class="code" href="app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158" title="Sends email notification that a user has a new voicemail waiting for them.">notify_new_message</a>(chan, vmu, NULL, msgnum, duration, fmt, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, NULL), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL), flag);
<a name="l05612"></a>05612 <span class="preprocessor">#endif</span>
<a name="l05613"></a>05613 <span class="preprocessor"></span>               }
<a name="l05614"></a>05614 
<a name="l05615"></a>05615                <span class="comment">/* Disposal needs to happen after the optional move and copy */</span>
<a name="l05616"></a>05616                <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(fn, NULL, NULL)) {
<a name="l05617"></a>05617                   <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(dir, msgnum);
<a name="l05618"></a>05618                }
<a name="l05619"></a>05619             }
<a name="l05620"></a>05620          }
<a name="l05621"></a>05621       } <span class="keywordflow">else</span> {
<a name="l05622"></a>05622          <a class="code" href="app__voicemail_8c.html#a9cfc31f6dff7a6c4cca28ef985a18f9c">inprocess_count</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1);
<a name="l05623"></a>05623       }
<a name="l05624"></a>05624       <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;0&apos;</span>) {
<a name="l05625"></a>05625          <span class="keywordflow">goto</span> <a class="code" href="chan__mgcp_8c.html#a9caa677def8fa97666646d9e2e607b7c">transfer</a>;
<a name="l05626"></a>05626       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res &gt; 0)
<a name="l05627"></a>05627          res = 0;
<a name="l05628"></a>05628 
<a name="l05629"></a>05629       <span class="keywordflow">if</span> (duration &lt; <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>)
<a name="l05630"></a>05630          <span class="comment">/* XXX We should really give a prompt too short/option start again, with leave_vm_out called only after a timeout XXX */</span>
<a name="l05631"></a>05631          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l05632"></a>05632       <span class="keywordflow">else</span>
<a name="l05633"></a>05633          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l05634"></a>05634    } <span class="keywordflow">else</span>
<a name="l05635"></a>05635       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No format for saving voicemail?\n&quot;</span>);
<a name="l05636"></a>05636 leave_vm_out:
<a name="l05637"></a>05637    <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l05638"></a>05638 
<a name="l05639"></a>05639 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l05640"></a>05640 <span class="preprocessor"></span>   <span class="comment">/* expunge message - use UID Expunge if supported on IMAP server*/</span>
<a name="l05641"></a>05641    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;*** Checking if we can expunge, expungeonhangup set to %d\n&quot;</span>,expungeonhangup);
<a name="l05642"></a>05642    <span class="keywordflow">if</span> (expungeonhangup == 1) {
<a name="l05643"></a>05643       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l05644"></a>05644 <span class="preprocessor">#ifdef HAVE_IMAP_TK2006</span>
<a name="l05645"></a>05645 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (LEVELUIDPLUS (vms-&gt;mailstream)) {
<a name="l05646"></a>05646          mail_expunge_full(vms-&gt;mailstream,NIL,EX_UID);
<a name="l05647"></a>05647       } <span class="keywordflow">else</span> 
<a name="l05648"></a>05648 <span class="preprocessor">#endif</span>
<a name="l05649"></a>05649 <span class="preprocessor"></span>         mail_expunge(vms-&gt;mailstream);
<a name="l05650"></a>05650       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l05651"></a>05651    }
<a name="l05652"></a>05652 <span class="preprocessor">#endif</span>
<a name="l05653"></a>05653 <span class="preprocessor"></span>
<a name="l05654"></a>05654    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(tmp);
<a name="l05655"></a>05655    <span class="keywordflow">return</span> res;
<a name="l05656"></a>05656 }
<a name="l05657"></a>05657 
<a name="l05658"></a><a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">05658</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>)
<a name="l05659"></a>05659 {
<a name="l05660"></a>05660    <span class="keywordtype">int</span> d;
<a name="l05661"></a>05661    d = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, num, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, language, NULL);
<a name="l05662"></a>05662    <span class="keywordflow">return</span> d;
<a name="l05663"></a>05663 }
<a name="l05664"></a>05664 
<a name="l05665"></a><a class="code" href="app__voicemail_8c.html#a1cec50a2281ad7263c1cf7959ed79632">05665</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1cec50a2281ad7263c1cf7959ed79632">save_to_folder</a>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msg, <span class="keywordtype">int</span> box)
<a name="l05666"></a>05666 {
<a name="l05667"></a>05667 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l05668"></a>05668 <span class="preprocessor"></span>   <span class="comment">/* we must use mbox(x) folder names, and copy the message there */</span>
<a name="l05669"></a>05669    <span class="comment">/* simple. huh? */</span>
<a name="l05670"></a>05670    <span class="keywordtype">char</span> sequence[10];
<a name="l05671"></a>05671    <span class="keywordtype">char</span> mailbox[256];
<a name="l05672"></a>05672    <span class="keywordtype">int</span> res;
<a name="l05673"></a>05673 
<a name="l05674"></a>05674    <span class="comment">/* get the real IMAP message number for this message */</span>
<a name="l05675"></a>05675    snprintf(sequence, <span class="keyword">sizeof</span>(sequence), <span class="stringliteral">&quot;%ld&quot;</span>, vms-&gt;msgArray[msg]);
<a name="l05676"></a>05676    
<a name="l05677"></a>05677    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Copying sequence %s to mailbox %s\n&quot;</span>, sequence, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l05678"></a>05678    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l05679"></a>05679    <span class="comment">/* if save to Old folder, put in INBOX as read */</span>
<a name="l05680"></a>05680    <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>) {
<a name="l05681"></a>05681       mail_setflag(vms-&gt;mailstream, sequence, <span class="stringliteral">&quot;\\Seen&quot;</span>);
<a name="l05682"></a>05682       mail_clearflag(vms-&gt;mailstream, sequence, <span class="stringliteral">&quot;\\Unseen&quot;</span>);
<a name="l05683"></a>05683    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>) {
<a name="l05684"></a>05684       mail_setflag(vms-&gt;mailstream, sequence, <span class="stringliteral">&quot;\\Unseen&quot;</span>);
<a name="l05685"></a>05685       mail_clearflag(vms-&gt;mailstream, sequence, <span class="stringliteral">&quot;\\Seen&quot;</span>);
<a name="l05686"></a>05686    }
<a name="l05687"></a>05687    <span class="keywordflow">if</span> (!strcasecmp(<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(<a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>), vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>) &amp;&amp; (box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a> || box == <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>)) {
<a name="l05688"></a>05688       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l05689"></a>05689       <span class="keywordflow">return</span> 0;
<a name="l05690"></a>05690    }
<a name="l05691"></a>05691    <span class="comment">/* Create the folder if it don&apos;t exist */</span>
<a name="l05692"></a>05692    imap_mailbox_name(mailbox, <span class="keyword">sizeof</span>(mailbox), vms, box, 1); <span class="comment">/* Get the full mailbox name */</span>
<a name="l05693"></a>05693    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Checking if folder exists: %s\n&quot;</span>,mailbox);
<a name="l05694"></a>05694    <span class="keywordflow">if</span> (mail_create(vms-&gt;mailstream, mailbox) == NIL) 
<a name="l05695"></a>05695       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(5, <span class="stringliteral">&quot;Folder exists.\n&quot;</span>);
<a name="l05696"></a>05696    <span class="keywordflow">else</span>
<a name="l05697"></a>05697       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Folder %s created!\n&quot;</span>,<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l05698"></a>05698    res = !mail_copy(vms-&gt;mailstream, sequence, (<span class="keywordtype">char</span> *)<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l05699"></a>05699    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l05700"></a>05700    <span class="keywordflow">return</span> res;
<a name="l05701"></a>05701 <span class="preprocessor">#else</span>
<a name="l05702"></a>05702 <span class="preprocessor"></span>   <span class="keywordtype">char</span> *dir = vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>;
<a name="l05703"></a>05703    <span class="keywordtype">char</span> *username = vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>;
<a name="l05704"></a>05704    <span class="keywordtype">char</span> *context = vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l05705"></a>05705    <span class="keywordtype">char</span> sfn[PATH_MAX];
<a name="l05706"></a>05706    <span class="keywordtype">char</span> dfn[PATH_MAX];
<a name="l05707"></a>05707    <span class="keywordtype">char</span> ddir[PATH_MAX];
<a name="l05708"></a>05708    <span class="keyword">const</span> <span class="keywordtype">char</span> *dbox = <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box);
<a name="l05709"></a>05709    <span class="keywordtype">int</span> x, i;
<a name="l05710"></a>05710    <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(ddir, <span class="keyword">sizeof</span>(ddir), context, username, dbox);
<a name="l05711"></a>05711 
<a name="l05712"></a>05712    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(ddir))
<a name="l05713"></a>05713       <span class="keywordflow">return</span> <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;
<a name="l05714"></a>05714 
<a name="l05715"></a>05715    x = <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(vmu, ddir) + 1;
<a name="l05716"></a>05716 
<a name="l05717"></a>05717    <span class="keywordflow">if</span> (box == 10 &amp;&amp; x &gt;= vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>) { <span class="comment">/* &quot;Deleted&quot; folder*/</span>
<a name="l05718"></a>05718       x--;
<a name="l05719"></a>05719       <span class="keywordflow">for</span> (i = 1; i &lt;= x; i++) {
<a name="l05720"></a>05720          <span class="comment">/* Push files down a &quot;slot&quot;.  The oldest file (msg0000) will be deleted. */</span>
<a name="l05721"></a>05721          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(sfn, <span class="keyword">sizeof</span>(sfn), ddir, i);
<a name="l05722"></a>05722          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(dfn, <span class="keyword">sizeof</span>(dfn), ddir, i - 1);
<a name="l05723"></a>05723          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(ddir, i, sfn, NULL)) {
<a name="l05724"></a>05724             <a class="code" href="app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a>(ddir, i, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, ddir, i - 1, sfn, dfn);
<a name="l05725"></a>05725          } <span class="keywordflow">else</span>
<a name="l05726"></a>05726             <span class="keywordflow">break</span>;
<a name="l05727"></a>05727       }
<a name="l05728"></a>05728    } <span class="keywordflow">else</span> {
<a name="l05729"></a>05729       <span class="keywordflow">if</span> (x &gt;= vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>) {
<a name="l05730"></a>05730          <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(ddir);
<a name="l05731"></a>05731          <span class="keywordflow">return</span> -1;
<a name="l05732"></a>05732       }
<a name="l05733"></a>05733    }
<a name="l05734"></a>05734    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(sfn, <span class="keyword">sizeof</span>(sfn), dir, msg);
<a name="l05735"></a>05735    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(dfn, <span class="keyword">sizeof</span>(dfn), ddir, x);
<a name="l05736"></a>05736    <span class="keywordflow">if</span> (strcmp(sfn, dfn)) {
<a name="l05737"></a>05737       <a class="code" href="app__voicemail_8c.html#a5095feba60bfdcc711f49a0ad2e27985">COPY</a>(dir, msg, ddir, x, username, context, sfn, dfn);
<a name="l05738"></a>05738    }
<a name="l05739"></a>05739    <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(ddir);
<a name="l05740"></a>05740 <span class="preprocessor">#endif</span>
<a name="l05741"></a>05741 <span class="preprocessor"></span>   <span class="keywordflow">return</span> 0;
<a name="l05742"></a>05742 }
<a name="l05743"></a>05743 
<a name="l05744"></a><a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">05744</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *buf)
<a name="l05745"></a>05745 {
<a name="l05746"></a>05746    <span class="keywordtype">int</span> bytes = 0;
<a name="l05747"></a>05747    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Comedian Mail&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05748"></a>05748    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;(C)2002-2006 Digium, Inc.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05749"></a>05749    <span class="keywordflow">return</span> bytes;
<a name="l05750"></a>05750 }
<a name="l05751"></a>05751 
<a name="l05752"></a><a class="code" href="app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c">05752</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c">adsi_load_vmail</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">int</span> *useadsi)
<a name="l05753"></a>05753 {
<a name="l05754"></a>05754    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l05755"></a>05755    <span class="keywordtype">int</span> bytes=0;
<a name="l05756"></a>05756    <span class="keywordtype">int</span> x;
<a name="l05757"></a>05757    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>[5];
<a name="l05758"></a>05758 
<a name="l05759"></a>05759    *useadsi = 0;
<a name="l05760"></a>05760    bytes += <a class="code" href="adsi_8h.html#a80b703aa4e9a1342400af797dd5e603a" title="Puts CPE in data mode.">ast_adsi_data_mode</a>(buf + bytes);
<a name="l05761"></a>05761    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05762"></a>05762 
<a name="l05763"></a>05763    bytes = 0;
<a name="l05764"></a>05764    bytes += <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf);
<a name="l05765"></a>05765    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Downloading Scripts&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05766"></a>05766 <span class="preprocessor">#ifdef DISPLAY</span>
<a name="l05767"></a>05767 <span class="preprocessor"></span>   bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   .&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05768"></a>05768 <span class="preprocessor">#endif</span>
<a name="l05769"></a>05769 <span class="preprocessor"></span>   bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05770"></a>05770    bytes += <a class="code" href="adsi_8h.html#a80b703aa4e9a1342400af797dd5e603a" title="Puts CPE in data mode.">ast_adsi_data_mode</a>(buf + bytes);
<a name="l05771"></a>05771    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05772"></a>05772 
<a name="l05773"></a>05773    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#a8f98a667128bb0296f9a2e09786f61bb">ast_adsi_begin_download</a>(chan, <a class="code" href="app__voicemail_8c.html#addcd618c70c26637518d590003c700c2">addesc</a>, <a class="code" href="app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a>, <a class="code" href="app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767">adsisec</a>, <a class="code" href="app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a>)) {
<a name="l05774"></a>05774       bytes = 0;
<a name="l05775"></a>05775       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Load Cancelled.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05776"></a>05776       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;ADSI Unavailable&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05777"></a>05777       bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05778"></a>05778       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05779"></a>05779       <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05780"></a>05780       <span class="keywordflow">return</span> 0;
<a name="l05781"></a>05781    }
<a name="l05782"></a>05782 
<a name="l05783"></a>05783 <span class="preprocessor">#ifdef DISPLAY</span>
<a name="l05784"></a>05784 <span class="preprocessor"></span>   <span class="comment">/* Add a dot */</span>
<a name="l05785"></a>05785    bytes = 0;
<a name="l05786"></a>05786    bytes += ast_adsi_logo(buf);
<a name="l05787"></a>05787    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Downloading Scripts&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05788"></a>05788    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   ..&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05789"></a>05789    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05790"></a>05790    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05791"></a>05791 <span class="preprocessor">#endif</span>
<a name="l05792"></a>05792 <span class="preprocessor"></span>   bytes = 0;
<a name="l05793"></a>05793    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 0, <span class="stringliteral">&quot;Listen&quot;</span>, <span class="stringliteral">&quot;Listen&quot;</span>, <span class="stringliteral">&quot;1&quot;</span>, 1);
<a name="l05794"></a>05794    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1, <span class="stringliteral">&quot;Folder&quot;</span>, <span class="stringliteral">&quot;Folder&quot;</span>, <span class="stringliteral">&quot;2&quot;</span>, 1);
<a name="l05795"></a>05795    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 2, <span class="stringliteral">&quot;Advanced&quot;</span>, <span class="stringliteral">&quot;Advnced&quot;</span>, <span class="stringliteral">&quot;3&quot;</span>, 1);
<a name="l05796"></a>05796    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3, <span class="stringliteral">&quot;Options&quot;</span>, <span class="stringliteral">&quot;Options&quot;</span>, <span class="stringliteral">&quot;0&quot;</span>, 1);
<a name="l05797"></a>05797    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 4, <span class="stringliteral">&quot;Help&quot;</span>, <span class="stringliteral">&quot;Help&quot;</span>, <span class="stringliteral">&quot;*&quot;</span>, 1);
<a name="l05798"></a>05798    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 5, <span class="stringliteral">&quot;Exit&quot;</span>, <span class="stringliteral">&quot;Exit&quot;</span>, <span class="stringliteral">&quot;#&quot;</span>, 1);
<a name="l05799"></a>05799    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);
<a name="l05800"></a>05800 
<a name="l05801"></a>05801 <span class="preprocessor">#ifdef DISPLAY</span>
<a name="l05802"></a>05802 <span class="preprocessor"></span>   <span class="comment">/* Add another dot */</span>
<a name="l05803"></a>05803    bytes = 0;
<a name="l05804"></a>05804    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   ...&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05805"></a>05805    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05806"></a>05806 
<a name="l05807"></a>05807    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05808"></a>05808    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05809"></a>05809 <span class="preprocessor">#endif</span>
<a name="l05810"></a>05810 <span class="preprocessor"></span>
<a name="l05811"></a>05811    bytes = 0;
<a name="l05812"></a>05812    <span class="comment">/* These buttons we load but don&apos;t use yet */</span>
<a name="l05813"></a>05813    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 6, <span class="stringliteral">&quot;Previous&quot;</span>, <span class="stringliteral">&quot;Prev&quot;</span>, <span class="stringliteral">&quot;4&quot;</span>, 1);
<a name="l05814"></a>05814    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 8, <span class="stringliteral">&quot;Repeat&quot;</span>, <span class="stringliteral">&quot;Repeat&quot;</span>, <span class="stringliteral">&quot;5&quot;</span>, 1);
<a name="l05815"></a>05815    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 7, <span class="stringliteral">&quot;Delete&quot;</span>, <span class="stringliteral">&quot;Delete&quot;</span>, <span class="stringliteral">&quot;7&quot;</span>, 1);
<a name="l05816"></a>05816    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 9, <span class="stringliteral">&quot;Next&quot;</span>, <span class="stringliteral">&quot;Next&quot;</span>, <span class="stringliteral">&quot;6&quot;</span>, 1);
<a name="l05817"></a>05817    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 10, <span class="stringliteral">&quot;Save&quot;</span>, <span class="stringliteral">&quot;Save&quot;</span>, <span class="stringliteral">&quot;9&quot;</span>, 1);
<a name="l05818"></a>05818    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 11, <span class="stringliteral">&quot;Undelete&quot;</span>, <span class="stringliteral">&quot;Restore&quot;</span>, <span class="stringliteral">&quot;7&quot;</span>, 1);
<a name="l05819"></a>05819    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);
<a name="l05820"></a>05820 
<a name="l05821"></a>05821 <span class="preprocessor">#ifdef DISPLAY</span>
<a name="l05822"></a>05822 <span class="preprocessor"></span>   <span class="comment">/* Add another dot */</span>
<a name="l05823"></a>05823    bytes = 0;
<a name="l05824"></a>05824    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   ....&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05825"></a>05825    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05826"></a>05826    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05827"></a>05827 <span class="preprocessor">#endif</span>
<a name="l05828"></a>05828 <span class="preprocessor"></span>
<a name="l05829"></a>05829    bytes = 0;
<a name="l05830"></a>05830    <span class="keywordflow">for</span> (x=0;x&lt;5;x++) {
<a name="l05831"></a>05831       snprintf(num, <span class="keyword">sizeof</span>(num), <span class="stringliteral">&quot;%d&quot;</span>, x);
<a name="l05832"></a>05832       bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + x, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(x), <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(x), num, 1);
<a name="l05833"></a>05833    }
<a name="l05834"></a>05834    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + 5, <span class="stringliteral">&quot;Cancel&quot;</span>, <span class="stringliteral">&quot;Cancel&quot;</span>, <span class="stringliteral">&quot;#&quot;</span>, 1);
<a name="l05835"></a>05835    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);
<a name="l05836"></a>05836 
<a name="l05837"></a>05837 <span class="preprocessor">#ifdef DISPLAY</span>
<a name="l05838"></a>05838 <span class="preprocessor"></span>   <span class="comment">/* Add another dot */</span>
<a name="l05839"></a>05839    bytes = 0;
<a name="l05840"></a>05840    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;   .....&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05841"></a>05841    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05842"></a>05842    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05843"></a>05843 <span class="preprocessor">#endif</span>
<a name="l05844"></a>05844 <span class="preprocessor"></span>
<a name="l05845"></a>05845    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#a12c4576517435afede8d83ca1ea8e7dd">ast_adsi_end_download</a>(chan)) {
<a name="l05846"></a>05846       bytes = 0;
<a name="l05847"></a>05847       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Download Unsuccessful.&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05848"></a>05848       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;ADSI Unavailable&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05849"></a>05849       bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05850"></a>05850       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05851"></a>05851       <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05852"></a>05852       <span class="keywordflow">return</span> 0;
<a name="l05853"></a>05853    }
<a name="l05854"></a>05854    bytes = 0;
<a name="l05855"></a>05855    bytes += <a class="code" href="adsi_8h.html#aaff06e2b870849b76f084c8edc7453a8" title="Disconnects (and hopefully saves) a downloaded script.">ast_adsi_download_disconnect</a>(buf + bytes);
<a name="l05856"></a>05856    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05857"></a>05857    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>);
<a name="l05858"></a>05858 
<a name="l05859"></a>05859    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Done downloading scripts...\n&quot;</span>);
<a name="l05860"></a>05860 
<a name="l05861"></a>05861 <span class="preprocessor">#ifdef DISPLAY</span>
<a name="l05862"></a>05862 <span class="preprocessor"></span>   <span class="comment">/* Add last dot */</span>
<a name="l05863"></a>05863    bytes = 0;
<a name="l05864"></a>05864    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;   ......&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05865"></a>05865    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05866"></a>05866 <span class="preprocessor">#endif</span>
<a name="l05867"></a>05867 <span class="preprocessor"></span>   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Restarting session...\n&quot;</span>);
<a name="l05868"></a>05868 
<a name="l05869"></a>05869    bytes = 0;
<a name="l05870"></a>05870    <span class="comment">/* Load the session now */</span>
<a name="l05871"></a>05871    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#a4c7e441bdf356ad4cbc6e549c2ff0ea1" title="Check if scripts for a given app are already loaded. Version may be -1, if any version...">ast_adsi_load_session</a>(chan, <a class="code" href="app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a>, <a class="code" href="app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a>, 1) == 1) {
<a name="l05872"></a>05872       *useadsi = 1;
<a name="l05873"></a>05873       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Scripts Loaded!&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05874"></a>05874    } <span class="keywordflow">else</span>
<a name="l05875"></a>05875       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Load Failed!&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05876"></a>05876 
<a name="l05877"></a>05877    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05878"></a>05878    <span class="keywordflow">return</span> 0;
<a name="l05879"></a>05879 }
<a name="l05880"></a>05880 
<a name="l05881"></a><a class="code" href="app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">05881</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">int</span> *useadsi)
<a name="l05882"></a>05882 {
<a name="l05883"></a>05883    <span class="keywordtype">int</span> x;
<a name="l05884"></a>05884    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l05885"></a>05885       <span class="keywordflow">return</span>;
<a name="l05886"></a>05886    x = <a class="code" href="adsi_8h.html#a4c7e441bdf356ad4cbc6e549c2ff0ea1" title="Check if scripts for a given app are already loaded. Version may be -1, if any version...">ast_adsi_load_session</a>(chan, <a class="code" href="app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a>, <a class="code" href="app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a>, 1);
<a name="l05887"></a>05887    <span class="keywordflow">if</span> (x &lt; 0)
<a name="l05888"></a>05888       <span class="keywordflow">return</span>;
<a name="l05889"></a>05889    <span class="keywordflow">if</span> (!x) {
<a name="l05890"></a>05890       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a777bfeec35518998fe5509e9a266216c">adsi_load_vmail</a>(chan, useadsi)) {
<a name="l05891"></a>05891          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to upload voicemail scripts\n&quot;</span>);
<a name="l05892"></a>05892          <span class="keywordflow">return</span>;
<a name="l05893"></a>05893       }
<a name="l05894"></a>05894    } <span class="keywordflow">else</span>
<a name="l05895"></a>05895       *useadsi = 1;
<a name="l05896"></a>05896 }
<a name="l05897"></a>05897 
<a name="l05898"></a><a class="code" href="app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">05898</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan)
<a name="l05899"></a>05899 {
<a name="l05900"></a>05900    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l05901"></a>05901    <span class="keywordtype">int</span> bytes=0;
<a name="l05902"></a>05902    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l05903"></a>05903    <span class="keywordtype">int</span> x;
<a name="l05904"></a>05904    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l05905"></a>05905       <span class="keywordflow">return</span>;
<a name="l05906"></a>05906 
<a name="l05907"></a>05907    <span class="keywordflow">for</span> (x=0;x&lt;8;x++)
<a name="l05908"></a>05908       keys[x] = 0;
<a name="l05909"></a>05909    <span class="comment">/* Set one key for next */</span>
<a name="l05910"></a>05910    keys[3] = <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3;
<a name="l05911"></a>05911 
<a name="l05912"></a>05912    bytes += <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);
<a name="l05913"></a>05913    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05914"></a>05914    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05915"></a>05915    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05916"></a>05916    bytes += <a class="code" href="adsi_8h.html#af964448bdeaae9b285547109cba5f1b1" title="Set input format.">ast_adsi_input_format</a>(buf + bytes, 1, <a class="code" href="adsi_8h.html#ae5cda91c55554914c5b7af2cfddca68f">ADSI_DIR_FROM_LEFT</a>, 0, <span class="stringliteral">&quot;Mailbox: ******&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05917"></a>05917    bytes += <a class="code" href="adsi_8h.html#a9fa4ae76cd4fb95fafcdddc8ce5fc955" title="Set input information.">ast_adsi_input_control</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, 1, 1, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>);
<a name="l05918"></a>05918    bytes += <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a>(buf + bytes, <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3, <span class="stringliteral">&quot;Enter&quot;</span>, <span class="stringliteral">&quot;Enter&quot;</span>, <span class="stringliteral">&quot;#&quot;</span>, 1);
<a name="l05919"></a>05919    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l05920"></a>05920    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05921"></a>05921    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05922"></a>05922 }
<a name="l05923"></a>05923 
<a name="l05924"></a><a class="code" href="app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47">05924</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47">adsi_password</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan)
<a name="l05925"></a>05925 {
<a name="l05926"></a>05926    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l05927"></a>05927    <span class="keywordtype">int</span> bytes=0;
<a name="l05928"></a>05928    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l05929"></a>05929    <span class="keywordtype">int</span> x;
<a name="l05930"></a>05930    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l05931"></a>05931       <span class="keywordflow">return</span>;
<a name="l05932"></a>05932 
<a name="l05933"></a>05933    <span class="keywordflow">for</span> (x=0;x&lt;8;x++)
<a name="l05934"></a>05934       keys[x] = 0;
<a name="l05935"></a>05935    <span class="comment">/* Set one key for next */</span>
<a name="l05936"></a>05936    keys[3] = <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 3;
<a name="l05937"></a>05937 
<a name="l05938"></a>05938    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05939"></a>05939    bytes += <a class="code" href="adsi_8h.html#af964448bdeaae9b285547109cba5f1b1" title="Set input format.">ast_adsi_input_format</a>(buf + bytes, 1, <a class="code" href="adsi_8h.html#ae5cda91c55554914c5b7af2cfddca68f">ADSI_DIR_FROM_LEFT</a>, 0, <span class="stringliteral">&quot;Password: ******&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05940"></a>05940    bytes += <a class="code" href="adsi_8h.html#a9fa4ae76cd4fb95fafcdddc8ce5fc955" title="Set input information.">ast_adsi_input_control</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, 0, 1, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>);
<a name="l05941"></a>05941    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l05942"></a>05942    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05943"></a>05943    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05944"></a>05944 }
<a name="l05945"></a>05945 
<a name="l05946"></a><a class="code" href="app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">05946</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">int</span> start, <span class="keywordtype">char</span> *label)
<a name="l05947"></a>05947 {
<a name="l05948"></a>05948    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l05949"></a>05949    <span class="keywordtype">int</span> bytes=0;
<a name="l05950"></a>05950    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l05951"></a>05951    <span class="keywordtype">int</span> x,y;
<a name="l05952"></a>05952 
<a name="l05953"></a>05953    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l05954"></a>05954       <span class="keywordflow">return</span>;
<a name="l05955"></a>05955 
<a name="l05956"></a>05956    <span class="keywordflow">for</span> (x=0;x&lt;5;x++) {
<a name="l05957"></a>05957       y = <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + start + x;
<a name="l05958"></a>05958       <span class="keywordflow">if</span> (y &gt; <a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 12 + 4)
<a name="l05959"></a>05959          y = 0;
<a name="l05960"></a>05960       keys[x] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | y;
<a name="l05961"></a>05961    }
<a name="l05962"></a>05962    keys[5] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 17);
<a name="l05963"></a>05963    keys[6] = 0;
<a name="l05964"></a>05964    keys[7] = 0;
<a name="l05965"></a>05965 
<a name="l05966"></a>05966    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, label, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05967"></a>05967    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l05968"></a>05968    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l05969"></a>05969    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l05970"></a>05970    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l05971"></a>05971 
<a name="l05972"></a>05972    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l05973"></a>05973 }
<a name="l05974"></a>05974 
<a name="l05975"></a><a class="code" href="app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">05975</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l05976"></a>05976 {
<a name="l05977"></a>05977    <span class="keywordtype">int</span> bytes=0;
<a name="l05978"></a>05978    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256]; 
<a name="l05979"></a>05979    <span class="keywordtype">char</span> buf1[256], buf2[256];
<a name="l05980"></a>05980    <span class="keywordtype">char</span> fn2[PATH_MAX];
<a name="l05981"></a>05981 
<a name="l05982"></a>05982    <span class="keywordtype">char</span> cid[256]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l05983"></a>05983    <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>;
<a name="l05984"></a>05984    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *<a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l05985"></a>05985    <span class="keywordtype">char</span> datetime[21]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l05986"></a>05986    FILE *f;
<a name="l05987"></a>05987 
<a name="l05988"></a>05988    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l05989"></a>05989 
<a name="l05990"></a>05990    <span class="keywordtype">int</span> x;
<a name="l05991"></a>05991 
<a name="l05992"></a>05992    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l05993"></a>05993       <span class="keywordflow">return</span>;
<a name="l05994"></a>05994 
<a name="l05995"></a>05995    <span class="comment">/* Retrieve important info */</span>
<a name="l05996"></a>05996    snprintf(fn2, <span class="keyword">sizeof</span>(fn2), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l05997"></a>05997    f = fopen(fn2, <span class="stringliteral">&quot;r&quot;</span>);
<a name="l05998"></a>05998    <span class="keywordflow">if</span> (f) {
<a name="l05999"></a>05999       <span class="keywordflow">while</span> (!feof(f)) {   
<a name="l06000"></a>06000          <span class="keywordflow">if</span> (!fgets((<span class="keywordtype">char</span> *)buf, <span class="keyword">sizeof</span>(buf), f)) {
<a name="l06001"></a>06001             <span class="keywordflow">continue</span>;
<a name="l06002"></a>06002          }
<a name="l06003"></a>06003          <span class="keywordflow">if</span> (!feof(f)) {
<a name="l06004"></a>06004             <span class="keywordtype">char</span> *stringp=NULL;
<a name="l06005"></a>06005             stringp = (<span class="keywordtype">char</span> *)buf;
<a name="l06006"></a>06006             <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l06007"></a>06007             val = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l06008"></a>06008             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(val)) {
<a name="l06009"></a>06009                <span class="keywordflow">if</span> (!strcmp((<span class="keywordtype">char</span> *)buf, <span class="stringliteral">&quot;callerid&quot;</span>))
<a name="l06010"></a>06010                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cid, val, <span class="keyword">sizeof</span>(cid));
<a name="l06011"></a>06011                <span class="keywordflow">if</span> (!strcmp((<span class="keywordtype">char</span> *)buf, <span class="stringliteral">&quot;origdate&quot;</span>))
<a name="l06012"></a>06012                   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(datetime, val, <span class="keyword">sizeof</span>(datetime));
<a name="l06013"></a>06013             }
<a name="l06014"></a>06014          }
<a name="l06015"></a>06015       }
<a name="l06016"></a>06016       fclose(f);
<a name="l06017"></a>06017    }
<a name="l06018"></a>06018    <span class="comment">/* New meaning for keys */</span>
<a name="l06019"></a>06019    <span class="keywordflow">for</span> (x=0;x&lt;5;x++)
<a name="l06020"></a>06020       keys[x] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 6 + x);
<a name="l06021"></a>06021    keys[6] = 0x0;
<a name="l06022"></a>06022    keys[7] = 0x0;
<a name="l06023"></a>06023 
<a name="l06024"></a>06024    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {
<a name="l06025"></a>06025       <span class="comment">/* No prev key, provide &quot;Folder&quot; instead */</span>
<a name="l06026"></a>06026       keys[0] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);
<a name="l06027"></a>06027    }
<a name="l06028"></a>06028    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt;= vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l06029"></a>06029       <span class="comment">/* If last message ... */</span>
<a name="l06030"></a>06030       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {
<a name="l06031"></a>06031          <span class="comment">/* but not only message, provide &quot;Folder&quot; instead */</span>
<a name="l06032"></a>06032          keys[3] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);
<a name="l06033"></a>06033          bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l06034"></a>06034 
<a name="l06035"></a>06035       } <span class="keywordflow">else</span> {
<a name="l06036"></a>06036          <span class="comment">/* Otherwise if only message, leave blank */</span>
<a name="l06037"></a>06037          keys[3] = 1;
<a name="l06038"></a>06038       }
<a name="l06039"></a>06039    }
<a name="l06040"></a>06040 
<a name="l06041"></a>06041    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cid)) {
<a name="l06042"></a>06042       <a class="code" href="callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df" title="Destructively parse inbuf into name and location (or number) Parses callerid stream...">ast_callerid_parse</a>(cid, &amp;name, &amp;num);
<a name="l06043"></a>06043       <span class="keywordflow">if</span> (!name)
<a name="l06044"></a>06044          name = num;
<a name="l06045"></a>06045    } <span class="keywordflow">else</span>
<a name="l06046"></a>06046       name = <span class="stringliteral">&quot;Unknown Caller&quot;</span>;
<a name="l06047"></a>06047 
<a name="l06048"></a>06048    <span class="comment">/* If deleted, show &quot;undeleted&quot; */</span>
<a name="l06049"></a>06049 
<a name="l06050"></a>06050    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>])
<a name="l06051"></a>06051       keys[1] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 11);
<a name="l06052"></a>06052 
<a name="l06053"></a>06053    <span class="comment">/* Except &quot;Exit&quot; */</span>
<a name="l06054"></a>06054    keys[5] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 5);
<a name="l06055"></a>06055    snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;%s%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>,
<a name="l06056"></a>06056       strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) ? <span class="stringliteral">&quot; Messages&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l06057"></a>06057    snprintf(buf2, <span class="keyword">sizeof</span>(buf2), <span class="stringliteral">&quot;Message %d of %d&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);
<a name="l06058"></a>06058 
<a name="l06059"></a>06059    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf1, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06060"></a>06060    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf2, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06061"></a>06061    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, name, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06062"></a>06062    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, datetime, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06063"></a>06063    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l06064"></a>06064    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l06065"></a>06065    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l06066"></a>06066 
<a name="l06067"></a>06067    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l06068"></a>06068 }
<a name="l06069"></a>06069 
<a name="l06070"></a><a class="code" href="app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4">06070</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4">adsi_delete</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l06071"></a>06071 {
<a name="l06072"></a>06072    <span class="keywordtype">int</span> bytes=0;
<a name="l06073"></a>06073    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l06074"></a>06074    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l06075"></a>06075 
<a name="l06076"></a>06076    <span class="keywordtype">int</span> x;
<a name="l06077"></a>06077 
<a name="l06078"></a>06078    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l06079"></a>06079       <span class="keywordflow">return</span>;
<a name="l06080"></a>06080 
<a name="l06081"></a>06081    <span class="comment">/* New meaning for keys */</span>
<a name="l06082"></a>06082    <span class="keywordflow">for</span> (x=0;x&lt;5;x++)
<a name="l06083"></a>06083       keys[x] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 6 + x);
<a name="l06084"></a>06084 
<a name="l06085"></a>06085    keys[6] = 0x0;
<a name="l06086"></a>06086    keys[7] = 0x0;
<a name="l06087"></a>06087 
<a name="l06088"></a>06088    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {
<a name="l06089"></a>06089       <span class="comment">/* No prev key, provide &quot;Folder&quot; instead */</span>
<a name="l06090"></a>06090       keys[0] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);
<a name="l06091"></a>06091    }
<a name="l06092"></a>06092    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt;= vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l06093"></a>06093       <span class="comment">/* If last message ... */</span>
<a name="l06094"></a>06094       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {
<a name="l06095"></a>06095          <span class="comment">/* but not only message, provide &quot;Folder&quot; instead */</span>
<a name="l06096"></a>06096          keys[3] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 1);
<a name="l06097"></a>06097       } <span class="keywordflow">else</span> {
<a name="l06098"></a>06098          <span class="comment">/* Otherwise if only message, leave blank */</span>
<a name="l06099"></a>06099          keys[3] = 1;
<a name="l06100"></a>06100       }
<a name="l06101"></a>06101    }
<a name="l06102"></a>06102 
<a name="l06103"></a>06103    <span class="comment">/* If deleted, show &quot;undeleted&quot; */</span>
<a name="l06104"></a>06104    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>]) 
<a name="l06105"></a>06105       keys[1] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 11);
<a name="l06106"></a>06106 
<a name="l06107"></a>06107    <span class="comment">/* Except &quot;Exit&quot; */</span>
<a name="l06108"></a>06108    keys[5] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + 5);
<a name="l06109"></a>06109    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l06110"></a>06110    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l06111"></a>06111 
<a name="l06112"></a>06112    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l06113"></a>06113 }
<a name="l06114"></a>06114 
<a name="l06115"></a><a class="code" href="app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">06115</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l06116"></a>06116 {
<a name="l06117"></a>06117    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06118"></a>06118    <span class="keywordtype">char</span> buf1[256] = <span class="stringliteral">&quot;&quot;</span>, buf2[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06119"></a>06119    <span class="keywordtype">int</span> bytes=0;
<a name="l06120"></a>06120    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l06121"></a>06121    <span class="keywordtype">int</span> x;
<a name="l06122"></a>06122 
<a name="l06123"></a>06123    <span class="keywordtype">char</span> *newm = (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) ? <span class="stringliteral">&quot;message&quot;</span> : <span class="stringliteral">&quot;messages&quot;</span>;
<a name="l06124"></a>06124    <span class="keywordtype">char</span> *oldm = (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) ? <span class="stringliteral">&quot;message&quot;</span> : <span class="stringliteral">&quot;messages&quot;</span>;
<a name="l06125"></a>06125    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l06126"></a>06126       <span class="keywordflow">return</span>;
<a name="l06127"></a>06127    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l06128"></a>06128       snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;You have %d new&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>);
<a name="l06129"></a>06129       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l06130"></a>06130          strncat(buf1, <span class="stringliteral">&quot; and&quot;</span>, <span class="keyword">sizeof</span>(buf1) - strlen(buf1) - 1);
<a name="l06131"></a>06131          snprintf(buf2, <span class="keyword">sizeof</span>(buf2), <span class="stringliteral">&quot;%d old %s.&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, oldm);
<a name="l06132"></a>06132       } <span class="keywordflow">else</span> {
<a name="l06133"></a>06133          snprintf(buf2, <span class="keyword">sizeof</span>(buf2), <span class="stringliteral">&quot;%s.&quot;</span>, newm);
<a name="l06134"></a>06134       }
<a name="l06135"></a>06135    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l06136"></a>06136       snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;You have %d old&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>);
<a name="l06137"></a>06137       snprintf(buf2, <span class="keyword">sizeof</span>(buf2), <span class="stringliteral">&quot;%s.&quot;</span>, oldm);
<a name="l06138"></a>06138    } <span class="keywordflow">else</span> {
<a name="l06139"></a>06139       strcpy(buf1, <span class="stringliteral">&quot;You have no messages.&quot;</span>);
<a name="l06140"></a>06140       buf2[0] = <span class="charliteral">&apos; &apos;</span>;
<a name="l06141"></a>06141       buf2[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l06142"></a>06142    }
<a name="l06143"></a>06143    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf1, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06144"></a>06144    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf2, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06145"></a>06145    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l06146"></a>06146 
<a name="l06147"></a>06147    <span class="keywordflow">for</span> (x=0;x&lt;6;x++)
<a name="l06148"></a>06148       keys[x] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + x);
<a name="l06149"></a>06149    keys[6] = 0;
<a name="l06150"></a>06150    keys[7] = 0;
<a name="l06151"></a>06151 
<a name="l06152"></a>06152    <span class="comment">/* Don&apos;t let them listen if there are none */</span>
<a name="l06153"></a>06153    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0)
<a name="l06154"></a>06154       keys[0] = 1;
<a name="l06155"></a>06155    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l06156"></a>06156 
<a name="l06157"></a>06157    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l06158"></a>06158 
<a name="l06159"></a>06159    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l06160"></a>06160 }
<a name="l06161"></a>06161 
<a name="l06162"></a><a class="code" href="app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353">06162</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353">adsi_status2</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l06163"></a>06163 {
<a name="l06164"></a>06164    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06165"></a>06165    <span class="keywordtype">char</span> buf1[256] = <span class="stringliteral">&quot;&quot;</span>, buf2[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06166"></a>06166    <span class="keywordtype">int</span> bytes=0;
<a name="l06167"></a>06167    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structkeys.html">keys</a>[8];
<a name="l06168"></a>06168    <span class="keywordtype">int</span> x;
<a name="l06169"></a>06169 
<a name="l06170"></a>06170    <span class="keywordtype">char</span> *mess = (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> == 0) ? <span class="stringliteral">&quot;message&quot;</span> : <span class="stringliteral">&quot;messages&quot;</span>;
<a name="l06171"></a>06171 
<a name="l06172"></a>06172    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l06173"></a>06173       <span class="keywordflow">return</span>;
<a name="l06174"></a>06174 
<a name="l06175"></a>06175    <span class="comment">/* Original command keys */</span>
<a name="l06176"></a>06176    <span class="keywordflow">for</span> (x=0;x&lt;6;x++)
<a name="l06177"></a>06177       keys[x] = <a class="code" href="adsi_8h.html#a5c34c039ca9214ec4be70b2c4059f891">ADSI_KEY_SKT</a> | (<a class="code" href="adsi_8h.html#a002af0b7a6a7398c3a1bfd2f412a7e8b">ADSI_KEY_APPS</a> + x);
<a name="l06178"></a>06178 
<a name="l06179"></a>06179    keys[6] = 0;
<a name="l06180"></a>06180    keys[7] = 0;
<a name="l06181"></a>06181 
<a name="l06182"></a>06182    <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1) &lt; 1)
<a name="l06183"></a>06183       keys[0] = 0;
<a name="l06184"></a>06184 
<a name="l06185"></a>06185    snprintf(buf1, <span class="keyword">sizeof</span>(buf1), <span class="stringliteral">&quot;%s%s has&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>,
<a name="l06186"></a>06186       strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) ? <span class="stringliteral">&quot; folder&quot;</span> : <span class="stringliteral">&quot;&quot;</span>);
<a name="l06187"></a>06187 
<a name="l06188"></a>06188    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1)
<a name="l06189"></a>06189       snprintf(buf2, <span class="keyword">sizeof</span>(buf2), <span class="stringliteral">&quot;%d %s.&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1, mess);
<a name="l06190"></a>06190    <span class="keywordflow">else</span>
<a name="l06191"></a>06191       strcpy(buf2, <span class="stringliteral">&quot;no messages.&quot;</span>);
<a name="l06192"></a>06192    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf1, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06193"></a>06193    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 2, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, buf2, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06194"></a>06194    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06195"></a>06195    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l06196"></a>06196    bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(buf + bytes, keys);
<a name="l06197"></a>06197 
<a name="l06198"></a>06198    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l06199"></a>06199 
<a name="l06200"></a>06200    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l06201"></a>06201    
<a name="l06202"></a>06202 }
<a name="l06203"></a>06203 
<a name="l06204"></a>06204 <span class="comment">/*</span>
<a name="l06205"></a>06205 <span class="comment">static void adsi_clear(struct ast_channel *chan)</span>
<a name="l06206"></a>06206 <span class="comment">{</span>
<a name="l06207"></a>06207 <span class="comment">   char buf[256];</span>
<a name="l06208"></a>06208 <span class="comment">   int bytes=0;</span>
<a name="l06209"></a>06209 <span class="comment">   if (!ast_adsi_available(chan))</span>
<a name="l06210"></a>06210 <span class="comment">      return;</span>
<a name="l06211"></a>06211 <span class="comment">   bytes += ast_adsi_set_line(buf + bytes, ADSI_COMM_PAGE, 1);</span>
<a name="l06212"></a>06212 <span class="comment">   bytes += ast_adsi_voice_mode(buf + bytes, 0);</span>
<a name="l06213"></a>06213 <span class="comment"></span>
<a name="l06214"></a>06214 <span class="comment">   ast_adsi_transmit_message(chan, buf, bytes, ADSI_MSG_DISPLAY);</span>
<a name="l06215"></a>06215 <span class="comment">}</span>
<a name="l06216"></a>06216 <span class="comment">*/</span>
<a name="l06217"></a>06217 
<a name="l06218"></a><a class="code" href="app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa">06218</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa">adsi_goodbye</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan)
<a name="l06219"></a>06219 {
<a name="l06220"></a>06220    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l06221"></a>06221    <span class="keywordtype">int</span> bytes=0;
<a name="l06222"></a>06222 
<a name="l06223"></a>06223    <span class="keywordflow">if</span> (!<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan))
<a name="l06224"></a>06224       <span class="keywordflow">return</span>;
<a name="l06225"></a>06225    bytes += <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);
<a name="l06226"></a>06226    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>, 0, <span class="stringliteral">&quot; &quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06227"></a>06227    bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Goodbye&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06228"></a>06228    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l06229"></a>06229    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l06230"></a>06230 
<a name="l06231"></a>06231    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l06232"></a>06232 }
<a name="l06233"></a>06233 <span class="comment"></span>
<a name="l06234"></a>06234 <span class="comment">/*!\brief get_folder: Folder menu</span>
<a name="l06235"></a>06235 <span class="comment"> * Plays &quot;press 1 for INBOX messages&quot; etc.</span>
<a name="l06236"></a>06236 <span class="comment"> * Should possibly be internationalized</span>
<a name="l06237"></a>06237 <span class="comment"> */</span>
<a name="l06238"></a><a class="code" href="app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5">06238</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5" title="get_folder: Folder menu Plays &amp;quot;press 1 for INBOX messages&amp;quot; etc. Should...">get_folder</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">int</span> start)
<a name="l06239"></a>06239 {
<a name="l06240"></a>06240    <span class="keywordtype">int</span> x;
<a name="l06241"></a>06241    <span class="keywordtype">int</span> d;
<a name="l06242"></a>06242    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l06243"></a>06243    d = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-press&quot;</span>);  <span class="comment">/* &quot;Press&quot; */</span>
<a name="l06244"></a>06244    <span class="keywordflow">if</span> (d)
<a name="l06245"></a>06245       <span class="keywordflow">return</span> d;
<a name="l06246"></a>06246    <span class="keywordflow">for</span> (x = start; x&lt; 5; x++) {  <span class="comment">/* For all folders */</span>
<a name="l06247"></a>06247       <span class="keywordflow">if</span> ((d = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, x, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, NULL)))
<a name="l06248"></a>06248          <span class="keywordflow">return</span> d;
<a name="l06249"></a>06249       d = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-for&quot;</span>); <span class="comment">/* &quot;for&quot; */</span>
<a name="l06250"></a>06250       <span class="keywordflow">if</span> (d)
<a name="l06251"></a>06251          <span class="keywordflow">return</span> d;
<a name="l06252"></a>06252       snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(x));  <span class="comment">/* Folder name */</span>
<a name="l06253"></a>06253       d = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, fn);
<a name="l06254"></a>06254       <span class="keywordflow">if</span> (d)
<a name="l06255"></a>06255          <span class="keywordflow">return</span> d;
<a name="l06256"></a>06256       d = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 500);
<a name="l06257"></a>06257       <span class="keywordflow">if</span> (d)
<a name="l06258"></a>06258          <span class="keywordflow">return</span> d;
<a name="l06259"></a>06259    }
<a name="l06260"></a>06260    d = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocancel&quot;</span>); <span class="comment">/* &quot;or pound to cancel&quot; */</span>
<a name="l06261"></a>06261    <span class="keywordflow">if</span> (d)
<a name="l06262"></a>06262       <span class="keywordflow">return</span> d;
<a name="l06263"></a>06263    d = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 4000);
<a name="l06264"></a>06264    <span class="keywordflow">return</span> d;
<a name="l06265"></a>06265 }
<a name="l06266"></a>06266 <span class="comment"></span>
<a name="l06267"></a>06267 <span class="comment">/*!</span>
<a name="l06268"></a>06268 <span class="comment"> * \brief plays a prompt and waits for a keypress.</span>
<a name="l06269"></a>06269 <span class="comment"> * \param chan</span>
<a name="l06270"></a>06270 <span class="comment"> * \param fn the name of the voice prompt file to be played. For example, &apos;vm-changeto&apos;, &apos;vm-savefolder&apos;</span>
<a name="l06271"></a>06271 <span class="comment"> * \param start Does not appear to be used at this time.</span>
<a name="l06272"></a>06272 <span class="comment"> *</span>
<a name="l06273"></a>06273 <span class="comment"> * This is used by the main menu option to move a message to a folder or to save a message into a folder.</span>
<a name="l06274"></a>06274 <span class="comment"> * After playing the  message identified by the fn parameter value, it calls get_folder(), which plays the </span>
<a name="l06275"></a>06275 <span class="comment"> * prompting for the number inputs that correspond to the available folders.</span>
<a name="l06276"></a>06276 <span class="comment"> * </span>
<a name="l06277"></a>06277 <span class="comment"> * \return zero on success, or -1 on error.</span>
<a name="l06278"></a>06278 <span class="comment"> */</span>
<a name="l06279"></a><a class="code" href="app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6">06279</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6" title="plays a prompt and waits for a keypress.">get_folder2</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *fn, <span class="keywordtype">int</span> start)
<a name="l06280"></a>06280 {
<a name="l06281"></a>06281    <span class="keywordtype">int</span> res = 0;
<a name="l06282"></a>06282    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, fn);  <span class="comment">/* Folder name */</span>
<a name="l06283"></a>06283    <span class="keywordflow">while</span> (((res &lt; <span class="charliteral">&apos;0&apos;</span>) || (res &gt; <span class="charliteral">&apos;9&apos;</span>)) &amp;&amp;
<a name="l06284"></a>06284          (res != <span class="charliteral">&apos;#&apos;</span>) &amp;&amp; (res &gt;= 0)) {
<a name="l06285"></a>06285       res = <a class="code" href="app__voicemail_8c.html#a1129848f393043d9157c3e2580a6f9a5" title="get_folder: Folder menu Plays &amp;quot;press 1 for INBOX messages&amp;quot; etc. Should...">get_folder</a>(chan, 0);
<a name="l06286"></a>06286    }
<a name="l06287"></a>06287    <span class="keywordflow">return</span> res;
<a name="l06288"></a>06288 }
<a name="l06289"></a>06289 <span class="comment"></span>
<a name="l06290"></a>06290 <span class="comment">/*!</span>
<a name="l06291"></a>06291 <span class="comment"> * \brief presents the option to prepend to an existing message when forwarding it.</span>
<a name="l06292"></a>06292 <span class="comment"> * \param chan</span>
<a name="l06293"></a>06293 <span class="comment"> * \param vmu</span>
<a name="l06294"></a>06294 <span class="comment"> * \param curdir</span>
<a name="l06295"></a>06295 <span class="comment"> * \param curmsg</span>
<a name="l06296"></a>06296 <span class="comment"> * \param vmfmts</span>
<a name="l06297"></a>06297 <span class="comment"> * \param context</span>
<a name="l06298"></a>06298 <span class="comment"> * \param record_gain</span>
<a name="l06299"></a>06299 <span class="comment"> * \param duration</span>
<a name="l06300"></a>06300 <span class="comment"> * \param vms</span>
<a name="l06301"></a>06301 <span class="comment"> *</span>
<a name="l06302"></a>06302 <span class="comment"> * Presents a prompt for 1 to prepend the current message, 2 to forward the message without prepending, or * to return to the main menu.</span>
<a name="l06303"></a>06303 <span class="comment"> *</span>
<a name="l06304"></a>06304 <span class="comment"> * This is invoked from forward_message() when performing a forward operation (option 8 from main menu).</span>
<a name="l06305"></a>06305 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l06306"></a>06306 <span class="comment"> */</span>
<a name="l06307"></a><a class="code" href="app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273">06307</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273" title="presents the option to prepend to an existing message when forwarding it.">vm_forwardoptions</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *curdir, <span class="keywordtype">int</span> curmsg, <span class="keywordtype">char</span> *vm_fmts,
<a name="l06308"></a>06308          <span class="keywordtype">char</span> *context, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain, <span class="keywordtype">long</span> *duration, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *flag)
<a name="l06309"></a>06309 {
<a name="l06310"></a>06310 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06311"></a>06311 <span class="preprocessor"></span>   <span class="keywordtype">int</span> res;
<a name="l06312"></a>06312 <span class="preprocessor">#endif</span>
<a name="l06313"></a>06313 <span class="preprocessor"></span>   <span class="keywordtype">int</span> cmd = 0;
<a name="l06314"></a>06314    <span class="keywordtype">int</span> retries = 0, prepend_duration = 0, already_recorded = 0;
<a name="l06315"></a>06315    <span class="keywordtype">char</span> msgfile[PATH_MAX], backup[PATH_MAX], backup_textfile[PATH_MAX];
<a name="l06316"></a>06316    <span class="keywordtype">char</span> textfile[PATH_MAX];
<a name="l06317"></a>06317    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *msg_cfg;
<a name="l06318"></a>06318    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26a3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };
<a name="l06319"></a>06319 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l06320"></a>06320 <span class="preprocessor"></span>   <span class="keywordtype">signed</span> <span class="keywordtype">char</span> zero_gain = 0;
<a name="l06321"></a>06321 <span class="preprocessor">#endif</span>
<a name="l06322"></a>06322 <span class="preprocessor"></span>   <span class="keyword">const</span> <span class="keywordtype">char</span> *duration_str;
<a name="l06323"></a>06323 
<a name="l06324"></a>06324    <span class="comment">/* Must always populate duration correctly */</span>
<a name="l06325"></a>06325    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), curdir, curmsg);
<a name="l06326"></a>06326    strcpy(textfile, msgfile);
<a name="l06327"></a>06327    strcpy(backup, msgfile);
<a name="l06328"></a>06328    strcpy(backup_textfile, msgfile);
<a name="l06329"></a>06329    strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - strlen(textfile) - 1);
<a name="l06330"></a>06330    strncat(backup, <span class="stringliteral">&quot;-bak&quot;</span>, <span class="keyword">sizeof</span>(backup) - strlen(backup) - 1);
<a name="l06331"></a>06331    strncat(backup_textfile, <span class="stringliteral">&quot;-bak.txt&quot;</span>, <span class="keyword">sizeof</span>(backup_textfile) - strlen(backup_textfile) - 1);
<a name="l06332"></a>06332 
<a name="l06333"></a>06333    <span class="keywordflow">if</span> ((msg_cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(textfile, config_flags)) &amp;&amp; msg_cfg != <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a> &amp;&amp; (duration_str = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>))) {
<a name="l06334"></a>06334       *duration = atoi(duration_str);
<a name="l06335"></a>06335    } <span class="keywordflow">else</span> {
<a name="l06336"></a>06336       *duration = 0;
<a name="l06337"></a>06337    }
<a name="l06338"></a>06338 
<a name="l06339"></a>06339    <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>) &amp;&amp; (cmd != <span class="charliteral">&apos;*&apos;</span>)) {
<a name="l06340"></a>06340       <span class="keywordflow">if</span> (cmd)
<a name="l06341"></a>06341          retries = 0;
<a name="l06342"></a>06342       <span class="keywordflow">switch</span> (cmd) {
<a name="l06343"></a>06343       <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: 
<a name="l06344"></a>06344 
<a name="l06345"></a>06345 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06346"></a>06346 <span class="preprocessor"></span>         <span class="comment">/* Record new intro file */</span>
<a name="l06347"></a>06347          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;introfn, <span class="keyword">sizeof</span>(vms-&gt;introfn), curdir, curmsg);
<a name="l06348"></a>06348          strncat(vms-&gt;introfn, <span class="stringliteral">&quot;intro&quot;</span>, <span class="keyword">sizeof</span>(vms-&gt;introfn));
<a name="l06349"></a>06349          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">INTRO</a>);
<a name="l06350"></a>06350          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>);
<a name="l06351"></a>06351          res = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, NULL, vms-&gt;introfn, vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>, vm_fmts, 1, vmu, (<span class="keywordtype">int</span> *)duration, NULL, record_gain, vms, flag);
<a name="l06352"></a>06352          cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l06353"></a>06353 <span class="preprocessor">#else</span>
<a name="l06354"></a>06354 <span class="preprocessor"></span>
<a name="l06355"></a>06355          <span class="comment">/* prepend a message to the current message, update the metadata and return */</span>
<a name="l06356"></a>06356 
<a name="l06357"></a>06357          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), curdir, curmsg);
<a name="l06358"></a>06358          strcpy(textfile, msgfile);
<a name="l06359"></a>06359          strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - 1);
<a name="l06360"></a>06360          *duration = 0;
<a name="l06361"></a>06361 
<a name="l06362"></a>06362          <span class="comment">/* if we can&apos;t read the message metadata, stop now */</span>
<a name="l06363"></a>06363          <span class="keywordflow">if</span> (!msg_cfg) {
<a name="l06364"></a>06364             cmd = 0;
<a name="l06365"></a>06365             <span class="keywordflow">break</span>;
<a name="l06366"></a>06366          }
<a name="l06367"></a>06367          
<a name="l06368"></a>06368          <span class="comment">/* Back up the original file, so we can retry the prepend and restore it after forward. */</span>
<a name="l06369"></a>06369          <span class="keywordflow">if</span> (already_recorded) {
<a name="l06370"></a>06370             <a class="code" href="file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b" title="Copies a file.">ast_filecopy</a>(backup, msgfile, NULL);
<a name="l06371"></a>06371             <a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a>(backup_textfile, textfile);
<a name="l06372"></a>06372          }
<a name="l06373"></a>06373          <span class="keywordflow">else</span> {
<a name="l06374"></a>06374             <a class="code" href="file_8h.html#aab7814972ae21f8cc68e1d62b97fc88b" title="Copies a file.">ast_filecopy</a>(msgfile, backup, NULL);
<a name="l06375"></a>06375             <a class="code" href="app__voicemail_8c.html#abe15777a07ac747625b018ac01f92531" title="Utility function to copy a file.">copy</a>(textfile,backup_textfile);
<a name="l06376"></a>06376          }
<a name="l06377"></a>06377          already_recorded = 1;
<a name="l06378"></a>06378 
<a name="l06379"></a>06379          <span class="keywordflow">if</span> (record_gain)
<a name="l06380"></a>06380             <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;record_gain, <span class="keyword">sizeof</span>(record_gain), 0);
<a name="l06381"></a>06381 
<a name="l06382"></a>06382          cmd = <a class="code" href="app_8h.html#a46e323bf2b852abe8ed7490fcb6e1f6d" title="Record a message and prepend the message to the given record file after playing the...">ast_play_and_prepend</a>(chan, NULL, msgfile, 0, vm_fmts, &amp;prepend_duration, 1, <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>);
<a name="l06383"></a>06383          <span class="keywordflow">if</span> (record_gain)
<a name="l06384"></a>06384             <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;zero_gain, <span class="keyword">sizeof</span>(zero_gain), 0);
<a name="l06385"></a>06385 
<a name="l06386"></a>06386          
<a name="l06387"></a>06387          <span class="keywordflow">if</span> ((duration_str = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>)))
<a name="l06388"></a>06388             *duration = atoi(duration_str);
<a name="l06389"></a>06389 
<a name="l06390"></a>06390          <span class="keywordflow">if</span> (prepend_duration) {
<a name="l06391"></a>06391             <span class="keyword">struct </span><a class="code" href="structast__category.html">ast_category</a> *msg_cat;
<a name="l06392"></a>06392             <span class="comment">/* need enough space for a maximum-length message duration */</span>
<a name="l06393"></a>06393             <span class="keywordtype">char</span> duration_buf[12];
<a name="l06394"></a>06394 
<a name="l06395"></a>06395             *duration += prepend_duration;
<a name="l06396"></a>06396             msg_cat = <a class="code" href="config_8h.html#a0c2db6370e5051f282b2926f5893b2ea" title="Retrieve a category if it exists.">ast_category_get</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>);
<a name="l06397"></a>06397             snprintf(duration_buf, 11, <span class="stringliteral">&quot;%ld&quot;</span>, *duration);
<a name="l06398"></a>06398             <span class="keywordflow">if</span> (!<a class="code" href="config_8h.html#a61b77e9b543a66af82d7ac7d4d6b4ac8" title="Update variable value within a config.">ast_variable_update</a>(msg_cat, <span class="stringliteral">&quot;duration&quot;</span>, duration_buf, NULL, 0)) {
<a name="l06399"></a>06399                <a class="code" href="config_8h.html#a473721b764b20c167c95b99239bc0654">ast_config_text_file_save</a>(textfile, msg_cfg, <span class="stringliteral">&quot;app_voicemail&quot;</span>);
<a name="l06400"></a>06400             }
<a name="l06401"></a>06401          }
<a name="l06402"></a>06402 
<a name="l06403"></a>06403 <span class="preprocessor">#endif</span>
<a name="l06404"></a>06404 <span class="preprocessor"></span>         <span class="keywordflow">break</span>;
<a name="l06405"></a>06405       <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>: 
<a name="l06406"></a>06406          <span class="comment">/* NULL out introfile so we know there is no intro! */</span>
<a name="l06407"></a>06407 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06408"></a>06408 <span class="preprocessor"></span>         *vms-&gt;introfn = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l06409"></a>06409 <span class="preprocessor">#endif</span>
<a name="l06410"></a>06410 <span class="preprocessor"></span>         cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l06411"></a>06411          <span class="keywordflow">break</span>;
<a name="l06412"></a>06412       <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l06413"></a>06413          cmd = <span class="charliteral">&apos;*&apos;</span>;
<a name="l06414"></a>06414          <span class="keywordflow">break</span>;
<a name="l06415"></a>06415       <span class="keywordflow">default</span>: 
<a name="l06416"></a>06416          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan,<span class="stringliteral">&quot;vm-forwardoptions&quot;</span>);
<a name="l06417"></a>06417             <span class="comment">/* &quot;Press 1 to prepend a message or 2 to forward the message without prepending&quot; */</span>
<a name="l06418"></a>06418          <span class="keywordflow">if</span> (!cmd)
<a name="l06419"></a>06419             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan,<span class="stringliteral">&quot;vm-starmain&quot;</span>);
<a name="l06420"></a>06420             <span class="comment">/* &quot;press star to return to the main menu&quot; */</span>
<a name="l06421"></a>06421          <span class="keywordflow">if</span> (!cmd)
<a name="l06422"></a>06422             cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan,6000);
<a name="l06423"></a>06423          <span class="keywordflow">if</span> (!cmd)
<a name="l06424"></a>06424             retries++;
<a name="l06425"></a>06425          <span class="keywordflow">if</span> (retries &gt; 3)
<a name="l06426"></a>06426             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l06427"></a>06427       }
<a name="l06428"></a>06428    }
<a name="l06429"></a>06429 
<a name="l06430"></a>06430    <span class="keywordflow">if</span> (msg_cfg)
<a name="l06431"></a>06431       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l06432"></a>06432    <span class="keywordflow">if</span> (prepend_duration)
<a name="l06433"></a>06433       *duration = prepend_duration;
<a name="l06434"></a>06434 
<a name="l06435"></a>06435    <span class="keywordflow">if</span> (already_recorded &amp;&amp; cmd == -1) {
<a name="l06436"></a>06436       <span class="comment">/* restore original message if prepention cancelled */</span>
<a name="l06437"></a>06437       <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(backup, msgfile, NULL);
<a name="l06438"></a>06438       rename(backup_textfile, textfile);
<a name="l06439"></a>06439    }
<a name="l06440"></a>06440 
<a name="l06441"></a>06441    <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;S&apos;</span>)
<a name="l06442"></a>06442       cmd = 0;
<a name="l06443"></a>06443    <span class="keywordflow">return</span> cmd;
<a name="l06444"></a>06444 }
<a name="l06445"></a>06445 
<a name="l06446"></a><a class="code" href="app__voicemail_8c.html#a953cfa381bf19b85e5f9c90c0d72407a">06446</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a953cfa381bf19b85e5f9c90c0d72407a">queue_mwi_event</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *box, <span class="keywordtype">int</span> urgent, <span class="keywordtype">int</span> <span class="keyword">new</span>, <span class="keywordtype">int</span> old)
<a name="l06447"></a>06447 {
<a name="l06448"></a>06448    <span class="keyword">struct </span><a class="code" href="structast__event.html" title="An event.">ast_event</a> *event;
<a name="l06449"></a>06449    <span class="keywordtype">char</span> *mailbox, *context;
<a name="l06450"></a>06450 
<a name="l06451"></a>06451    <span class="comment">/* Strip off @default */</span>
<a name="l06452"></a>06452    context = mailbox = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(box);
<a name="l06453"></a>06453    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;context, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l06454"></a>06454    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(context))
<a name="l06455"></a>06455       context = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l06456"></a>06456 
<a name="l06457"></a>06457    <span class="keywordflow">if</span> (!(event = <a class="code" href="event_8h.html#afb4a2a00de28bb0733037060da8c4bac" title="Create a new event.">ast_event_new</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>,
<a name="l06458"></a>06458          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aae6c80d8f4c6ab3cee006ed57d874710" title="Mailbox name.">AST_EVENT_IE_MAILBOX</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, mailbox,
<a name="l06459"></a>06459          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a25764e2fb734ccb3ee1f6f41caba5318" title="Context IE Used by AST_EVENT_MWI Payload type: str.">AST_EVENT_IE_CONTEXT</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6ab82ac16f0791be2f8f918429a73430be">AST_EVENT_IE_PLTYPE_STR</a>, context,
<a name="l06460"></a>06460          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aff40847f0450f17c96e94e721aee38f2" title="Number of new messages Used by: AST_EVENT_MWI Payload type: UINT.">AST_EVENT_IE_NEWMSGS</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6a4647cbfacd475cb5067f9f9906107641">AST_EVENT_IE_PLTYPE_UINT</a>, (<span class="keyword">new</span>+urgent),
<a name="l06461"></a>06461          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aeda30786b0dfece37a9a06b84a653fd9" title="Number of Used by: AST_EVENT_MWI Payload type: UINT.">AST_EVENT_IE_OLDMSGS</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6a4647cbfacd475cb5067f9f9906107641">AST_EVENT_IE_PLTYPE_UINT</a>, old,
<a name="l06462"></a>06462          <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>))) {
<a name="l06463"></a>06463       <span class="keywordflow">return</span>;
<a name="l06464"></a>06464    }
<a name="l06465"></a>06465 
<a name="l06466"></a>06466    <a class="code" href="event_8h.html#a5ef4e1053ab8a91ebdcf4dd6ad1c81c4" title="Queue and cache an event.">ast_event_queue_and_cache</a>(event);
<a name="l06467"></a>06467 }
<a name="l06468"></a>06468 <span class="comment"></span>
<a name="l06469"></a>06469 <span class="comment">/*!</span>
<a name="l06470"></a>06470 <span class="comment"> * \brief Sends email notification that a user has a new voicemail waiting for them.</span>
<a name="l06471"></a>06471 <span class="comment"> * \param chan</span>
<a name="l06472"></a>06472 <span class="comment"> * \param vmu</span>
<a name="l06473"></a>06473 <span class="comment"> * \param vms</span>
<a name="l06474"></a>06474 <span class="comment"> * \param msgnum</span>
<a name="l06475"></a>06475 <span class="comment"> * \param duration</span>
<a name="l06476"></a>06476 <span class="comment"> * \param fmt</span>
<a name="l06477"></a>06477 <span class="comment"> * \param cidnum The Caller ID phone number value.</span>
<a name="l06478"></a>06478 <span class="comment"> * \param cidname The Caller ID name value.</span>
<a name="l06479"></a>06479 <span class="comment"> *</span>
<a name="l06480"></a>06480 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l06481"></a>06481 <span class="comment"> */</span>
<a name="l06482"></a><a class="code" href="app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158">06482</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae0e219c6e443e0d38b3ee75931222158" title="Sends email notification that a user has a new voicemail waiting for them.">notify_new_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">long</span> duration, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">char</span> *cidnum, <span class="keywordtype">char</span> *cidname, <span class="keyword">const</span> <span class="keywordtype">char</span> *flag)
<a name="l06483"></a>06483 {
<a name="l06484"></a>06484    <span class="keywordtype">char</span> todir[PATH_MAX], fn[PATH_MAX], ext_context[PATH_MAX], *stringp;
<a name="l06485"></a>06485    <span class="keywordtype">int</span> newmsgs = 0, oldmsgs = 0, urgentmsgs = 0;
<a name="l06486"></a>06486    <span class="keyword">const</span> <span class="keywordtype">char</span> *category;
<a name="l06487"></a>06487    <span class="keywordtype">char</span> *myserveremail = <a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;
<a name="l06488"></a>06488 
<a name="l06489"></a>06489    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l06490"></a>06490    <span class="keywordflow">if</span> ((category = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;VM_CATEGORY&quot;</span>))) {
<a name="l06491"></a>06491       category = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(category);
<a name="l06492"></a>06492    }
<a name="l06493"></a>06493    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l06494"></a>06494 
<a name="l06495"></a>06495    <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(todir, <span class="keyword">sizeof</span>(todir), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>) ? <span class="stringliteral">&quot;Urgent&quot;</span> : <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l06496"></a>06496    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), todir, msgnum);
<a name="l06497"></a>06497    snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l06498"></a>06498 
<a name="l06499"></a>06499    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>)) {
<a name="l06500"></a>06500       <span class="keywordflow">if</span> (strstr(fmt, vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>))
<a name="l06501"></a>06501          fmt = vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>;
<a name="l06502"></a>06502       <span class="keywordflow">else</span>
<a name="l06503"></a>06503          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Attachment format &apos;%s&apos; is not one of the recorded formats &apos;%s&apos;.  Falling back to default format for &apos;%s@%s&apos;.\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>, fmt, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l06504"></a>06504    }
<a name="l06505"></a>06505 
<a name="l06506"></a>06506    <span class="comment">/* Attach only the first format */</span>
<a name="l06507"></a>06507    fmt = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(fmt);
<a name="l06508"></a>06508    stringp = fmt;
<a name="l06509"></a>06509    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l06510"></a>06510 
<a name="l06511"></a>06511    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>))
<a name="l06512"></a>06512       myserveremail = vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;
<a name="l06513"></a>06513 
<a name="l06514"></a>06514    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>)) {
<a name="l06515"></a>06515       <span class="keywordtype">int</span> attach_user_voicemail = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);
<a name="l06516"></a>06516       <span class="keywordflow">if</span> (!attach_user_voicemail)
<a name="l06517"></a>06517          attach_user_voicemail = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);
<a name="l06518"></a>06518 
<a name="l06519"></a>06519       <span class="keywordflow">if</span> (attach_user_voicemail)
<a name="l06520"></a>06520          <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(todir, msgnum, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l06521"></a>06521 
<a name="l06522"></a>06522       <span class="comment">/* XXX possible imap issue, should category be NULL XXX */</span>
<a name="l06523"></a>06523       <a class="code" href="app__voicemail_8c.html#a183096024fd4bf12223521cbfae96856">sendmail</a>(myserveremail, vmu, msgnum, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(0), cidnum, cidname, fn, NULL, fmt, duration, attach_user_voicemail, chan, category, flag);
<a name="l06524"></a>06524 
<a name="l06525"></a>06525       <span class="keywordflow">if</span> (attach_user_voicemail)
<a name="l06526"></a>06526          <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(todir, msgnum);
<a name="l06527"></a>06527    }
<a name="l06528"></a>06528 
<a name="l06529"></a>06529    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>)) {
<a name="l06530"></a>06530       <a class="code" href="app__voicemail_8c.html#ac9d8114df0acde590ff96c9c3758b6fe">sendpage</a>(myserveremail, vmu-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, msgnum, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(0), cidnum, cidname, duration, vmu, category, flag);
<a name="l06531"></a>06531    }
<a name="l06532"></a>06532 
<a name="l06533"></a>06533    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>))
<a name="l06534"></a>06534       <a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(todir, msgnum, fn, vmu);
<a name="l06535"></a>06535 
<a name="l06536"></a>06536    <span class="comment">/* Leave voicemail for someone */</span>
<a name="l06537"></a>06537    <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#ae5953304e56862ac7efc1fed0ac6732f" title="Determine if a given mailbox has any voicemail If folder is NULL, defaults to &amp;quot;INBOX&amp;quot;...">ast_app_has_voicemail</a>(ext_context, NULL)) 
<a name="l06538"></a>06538       <a class="code" href="app_8h.html#a6f9a8f7a54dd80f1b5363b6cadfd4939" title="Determine number of urgent/new/old messages in a mailbox.">ast_app_inboxcount2</a>(ext_context, &amp;urgentmsgs, &amp;newmsgs, &amp;oldmsgs);
<a name="l06539"></a>06539 
<a name="l06540"></a>06540    <a class="code" href="app__voicemail_8c.html#a953cfa381bf19b85e5f9c90c0d72407a">queue_mwi_event</a>(ext_context, urgentmsgs, newmsgs, oldmsgs);
<a name="l06541"></a>06541 
<a name="l06542"></a>06542    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MessageWaiting&quot;</span>, <span class="stringliteral">&quot;Mailbox: %s@%s\r\nWaiting: %d\r\nNew: %d\r\nOld: %d\r\n&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="app_8h.html#ae5953304e56862ac7efc1fed0ac6732f" title="Determine if a given mailbox has any voicemail If folder is NULL, defaults to &amp;quot;INBOX&amp;quot;...">ast_app_has_voicemail</a>(ext_context, NULL), newmsgs, oldmsgs);
<a name="l06543"></a>06543    <a class="code" href="app__voicemail_8c.html#a9c5687a6ba659f56c96ebc103673d85a">run_externnotify</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, flag);
<a name="l06544"></a>06544 
<a name="l06545"></a>06545 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06546"></a>06546 <span class="preprocessor"></span>   <a class="code" href="app__voicemail_8c.html#a1efddf47b6f25c6e1b97e064e35c214e" title="Removes the voicemail sound and information file.">vm_delete</a>(fn);  <span class="comment">/* Delete the file, but not the IMAP message */</span>
<a name="l06547"></a>06547    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>))  { <span class="comment">/* Delete the IMAP message if delete = yes */</span>
<a name="l06548"></a>06548       vm_imap_delete(NULL, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu);
<a name="l06549"></a>06549       vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>--;  <span class="comment">/* Fix new message count */</span>
<a name="l06550"></a>06550    }
<a name="l06551"></a>06551 <span class="preprocessor">#endif</span>
<a name="l06552"></a>06552 <span class="preprocessor"></span>
<a name="l06553"></a>06553    <span class="keywordflow">return</span> 0;
<a name="l06554"></a>06554 }
<a name="l06555"></a>06555 <span class="comment"></span>
<a name="l06556"></a>06556 <span class="comment">/*!</span>
<a name="l06557"></a>06557 <span class="comment"> * \brief Sends a voicemail message to a mailbox recipient.</span>
<a name="l06558"></a>06558 <span class="comment"> * \param ast_channel</span>
<a name="l06559"></a>06559 <span class="comment"> * \param context</span>
<a name="l06560"></a>06560 <span class="comment"> * \param vms</span>
<a name="l06561"></a>06561 <span class="comment"> * \param sender</span>
<a name="l06562"></a>06562 <span class="comment"> * \param fmt</span>
<a name="l06563"></a>06563 <span class="comment"> * \param is_new_message Used to indicate the mode for which this method was invoked. </span>
<a name="l06564"></a>06564 <span class="comment"> *             Will be 0 when called to forward an existing message (option 8)</span>
<a name="l06565"></a>06565 <span class="comment"> *             Will be 1 when called to leave a message (option 3-&gt;5)</span>
<a name="l06566"></a>06566 <span class="comment"> * \param record_gain </span>
<a name="l06567"></a>06567 <span class="comment"> *</span>
<a name="l06568"></a>06568 <span class="comment"> * Reads the destination mailbox(es) from keypad input for CID, or if use_directory feature is enabled, the Directory.</span>
<a name="l06569"></a>06569 <span class="comment"> * </span>
<a name="l06570"></a>06570 <span class="comment"> * When in the leave message mode (is_new_message == 1):</span>
<a name="l06571"></a>06571 <span class="comment"> *   - allow the leaving of a message for ourselves. (Will not allow us to forward a message to ourselves, when is_new_message == 0).</span>
<a name="l06572"></a>06572 <span class="comment"> *   - attempt to determine the context and and mailbox, and then invoke leave_message() function to record and store the message.</span>
<a name="l06573"></a>06573 <span class="comment"> *</span>
<a name="l06574"></a>06574 <span class="comment"> * When in the forward message mode (is_new_message == 0):</span>
<a name="l06575"></a>06575 <span class="comment"> *   - retreives the current message to be forwarded</span>
<a name="l06576"></a>06576 <span class="comment"> *   - copies the original message to a temporary file, so updates to the envelope can be done.</span>
<a name="l06577"></a>06577 <span class="comment"> *   - determines the target mailbox and folders</span>
<a name="l06578"></a>06578 <span class="comment"> *   - copies the message into the target mailbox, using copy_message() or by generating the message into an email attachment if using imap folders.</span>
<a name="l06579"></a>06579 <span class="comment"> *</span>
<a name="l06580"></a>06580 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l06581"></a>06581 <span class="comment"> */</span>
<a name="l06582"></a><a class="code" href="app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c">06582</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c" title="Sends a voicemail message to a mailbox recipient.">forward_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *context, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *sender, <span class="keywordtype">char</span> *fmt, <span class="keywordtype">int</span> is_new_message, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain, <span class="keywordtype">int</span> urgent)
<a name="l06583"></a>06583 {
<a name="l06584"></a>06584 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06585"></a>06585 <span class="preprocessor"></span>   <span class="keywordtype">int</span> todircount=0;
<a name="l06586"></a>06586    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> *dstvms;
<a name="l06587"></a>06587 <span class="preprocessor">#endif</span>
<a name="l06588"></a>06588 <span class="preprocessor"></span>   <span class="keywordtype">char</span> <a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>[70]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l06589"></a>06589    <span class="keywordtype">char</span> fn[PATH_MAX]; <span class="comment">/* for playback of name greeting */</span>
<a name="l06590"></a>06590    <span class="keywordtype">char</span> ecodes[16] = <span class="stringliteral">&quot;#&quot;</span>;
<a name="l06591"></a>06591    <span class="keywordtype">int</span> res = 0, cmd = 0;
<a name="l06592"></a>06592    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *receiver = NULL, *vmtmp;
<a name="l06593"></a>06593    <a class="code" href="linkedlists_8h.html#a547735280f0983afc46bf476d17be24a" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_NOLOCK_STATIC</a>(extensions, <a class="code" href="structast__vm__user.html">ast_vm_user</a>);
<a name="l06594"></a>06594    <span class="keywordtype">char</span> *stringp;
<a name="l06595"></a>06595    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l06596"></a>06596    <span class="keywordtype">int</span> saved_messages = 0, found = 0;
<a name="l06597"></a>06597    <span class="keywordtype">int</span> valid_extensions = 0;
<a name="l06598"></a>06598    <span class="keywordtype">char</span> *dir;
<a name="l06599"></a>06599    <span class="keywordtype">int</span> curmsg;
<a name="l06600"></a>06600    <span class="keywordtype">char</span> urgent_str[7] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06601"></a>06601    <span class="keywordtype">char</span> tmptxtfile[PATH_MAX];
<a name="l06602"></a>06602 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l06603"></a>06603 <span class="preprocessor"></span>   <span class="keywordtype">char</span> msgfile[PATH_MAX], textfile[PATH_MAX], backup[PATH_MAX], backup_textfile[PATH_MAX];
<a name="l06604"></a>06604 <span class="preprocessor">#endif</span>
<a name="l06605"></a>06605 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">VM_FWDURGAUTO</a>)) {
<a name="l06606"></a>06606       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(urgent_str, urgent ? <span class="stringliteral">&quot;Urgent&quot;</span> : <span class="stringliteral">&quot;&quot;</span>, <span class="keyword">sizeof</span>(urgent_str));
<a name="l06607"></a>06607    }
<a name="l06608"></a>06608 
<a name="l06609"></a>06609    <span class="keywordflow">if</span> (vms == NULL) <span class="keywordflow">return</span> -1;
<a name="l06610"></a>06610    dir = vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>;
<a name="l06611"></a>06611    curmsg = vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>;
<a name="l06612"></a>06612 
<a name="l06613"></a>06613    tmptxtfile[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l06614"></a>06614    <span class="keywordflow">while</span> (!res &amp;&amp; !valid_extensions) {
<a name="l06615"></a>06615       <span class="keywordtype">int</span> use_directory = 0;
<a name="l06616"></a>06616       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a>)) {
<a name="l06617"></a>06617          <span class="keywordtype">int</span> done = 0;
<a name="l06618"></a>06618          <span class="keywordtype">int</span> retries = 0;
<a name="l06619"></a>06619          cmd=0;
<a name="l06620"></a>06620          <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; !done ){
<a name="l06621"></a>06621             <span class="keywordflow">if</span> (cmd)
<a name="l06622"></a>06622                retries = 0;
<a name="l06623"></a>06623             <span class="keywordflow">switch</span> (cmd) {
<a name="l06624"></a>06624             <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: 
<a name="l06625"></a>06625                use_directory = 0;
<a name="l06626"></a>06626                done = 1;
<a name="l06627"></a>06627                <span class="keywordflow">break</span>;
<a name="l06628"></a>06628             <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>: 
<a name="l06629"></a>06629                use_directory = 1;
<a name="l06630"></a>06630                done=1;
<a name="l06631"></a>06631                <span class="keywordflow">break</span>;
<a name="l06632"></a>06632             <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>: 
<a name="l06633"></a>06633                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l06634"></a>06634                done = 1;
<a name="l06635"></a>06635                <span class="keywordflow">break</span>;
<a name="l06636"></a>06636             <span class="keywordflow">default</span>: 
<a name="l06637"></a>06637                <span class="comment">/* Press 1 to enter an extension press 2 to use the directory */</span>
<a name="l06638"></a>06638                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan,<span class="stringliteral">&quot;vm-forward&quot;</span>);
<a name="l06639"></a>06639                <span class="keywordflow">if</span> (!cmd)
<a name="l06640"></a>06640                   cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan,3000);
<a name="l06641"></a>06641                <span class="keywordflow">if</span> (!cmd)
<a name="l06642"></a>06642                   retries++;
<a name="l06643"></a>06643                <span class="keywordflow">if</span> (retries &gt; 3) {
<a name="l06644"></a>06644                   cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l06645"></a>06645                   done = 1;
<a name="l06646"></a>06646                }
<a name="l06647"></a>06647                
<a name="l06648"></a>06648             }
<a name="l06649"></a>06649          }
<a name="l06650"></a>06650          <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span>)
<a name="l06651"></a>06651             <span class="keywordflow">break</span>;
<a name="l06652"></a>06652       }
<a name="l06653"></a>06653       
<a name="l06654"></a>06654       <span class="keywordflow">if</span> (use_directory) {
<a name="l06655"></a>06655          <span class="comment">/* use app_directory */</span>
<a name="l06656"></a>06656          
<a name="l06657"></a>06657          <span class="keywordtype">char</span> old_context[<span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>)];
<a name="l06658"></a>06658          <span class="keywordtype">char</span> old_exten[<span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>)];
<a name="l06659"></a>06659          <span class="keywordtype">int</span> old_priority;
<a name="l06660"></a>06660          <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a>* directory_app;
<a name="l06661"></a>06661 
<a name="l06662"></a>06662          directory_app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;Directory&quot;</span>);
<a name="l06663"></a>06663          <span class="keywordflow">if</span> (directory_app) {
<a name="l06664"></a>06664             <span class="keywordtype">char</span> vmcontext[256];
<a name="l06665"></a>06665             <span class="comment">/* make backup copies */</span>
<a name="l06666"></a>06666             memcpy(old_context, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l06667"></a>06667             memcpy(old_exten, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l06668"></a>06668             old_priority = chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>;
<a name="l06669"></a>06669             
<a name="l06670"></a>06670             <span class="comment">/* call the the Directory, changes the channel */</span>
<a name="l06671"></a>06671             snprintf(vmcontext, <span class="keyword">sizeof</span>(vmcontext), <span class="stringliteral">&quot;%s,,v&quot;</span>, context ? context : <span class="stringliteral">&quot;default&quot;</span>);
<a name="l06672"></a>06672             res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, directory_app, vmcontext);
<a name="l06673"></a>06673             
<a name="l06674"></a>06674             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(username, chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, <span class="keyword">sizeof</span>(username));
<a name="l06675"></a>06675             
<a name="l06676"></a>06676             <span class="comment">/* restore the old context, exten, and priority */</span>
<a name="l06677"></a>06677             memcpy(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, old_context, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l06678"></a>06678             memcpy(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, old_exten, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l06679"></a>06679             chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = old_priority;
<a name="l06680"></a>06680          } <span class="keywordflow">else</span> {
<a name="l06681"></a>06681             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find the Directory application, disabling directory_forward\n&quot;</span>);
<a name="l06682"></a>06682             <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a>);
<a name="l06683"></a>06683          }
<a name="l06684"></a>06684       } <span class="keywordflow">else</span> {
<a name="l06685"></a>06685          <span class="comment">/* Ask for an extension */</span>
<a name="l06686"></a>06686          res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-extension&quot;</span>, chan-&gt;language); <span class="comment">/* &quot;extension&quot; */</span>
<a name="l06687"></a>06687          <span class="keywordflow">if</span> (res)
<a name="l06688"></a>06688             <span class="keywordflow">break</span>;
<a name="l06689"></a>06689          <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, username, <span class="keyword">sizeof</span>(username) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>) &lt; 0))
<a name="l06690"></a>06690             <span class="keywordflow">break</span>;
<a name="l06691"></a>06691       }
<a name="l06692"></a>06692       
<a name="l06693"></a>06693       <span class="comment">/* start all over if no username */</span>
<a name="l06694"></a>06694       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(username))
<a name="l06695"></a>06695          <span class="keywordflow">continue</span>;
<a name="l06696"></a>06696       stringp = username;
<a name="l06697"></a>06697       s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;*&quot;</span>);
<a name="l06698"></a>06698       <span class="comment">/* start optimistic */</span>
<a name="l06699"></a>06699       valid_extensions = 1;
<a name="l06700"></a>06700       <span class="keywordflow">while</span> (s) {
<a name="l06701"></a>06701          <span class="keywordflow">if</span> ((is_new_message == 1 || strcmp(s, sender-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)) &amp;&amp; (receiver = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(NULL, context, s))) {
<a name="l06702"></a>06702             <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;extensions, receiver, list);
<a name="l06703"></a>06703             found++;
<a name="l06704"></a>06704          } <span class="keywordflow">else</span> {
<a name="l06705"></a>06705             <span class="comment">/* XXX Optimization for the future.  When we encounter a single bad extension,</span>
<a name="l06706"></a>06706 <span class="comment">             * bailing out on all of the extensions may not be the way to go.  We should</span>
<a name="l06707"></a>06707 <span class="comment">             * probably just bail on that single extension, then allow the user to enter</span>
<a name="l06708"></a>06708 <span class="comment">             * several more. XXX</span>
<a name="l06709"></a>06709 <span class="comment">             */</span>
<a name="l06710"></a>06710             <span class="keywordflow">while</span> ((receiver = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;extensions, list))) {
<a name="l06711"></a>06711                <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(receiver);
<a name="l06712"></a>06712             }
<a name="l06713"></a>06713             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid mailbox\n&quot;</span>, s);
<a name="l06714"></a>06714             valid_extensions = 0;
<a name="l06715"></a>06715             <span class="keywordflow">break</span>;
<a name="l06716"></a>06716          }
<a name="l06717"></a>06717 
<a name="l06718"></a>06718          <span class="comment">/* play name if available, else play extension number */</span>
<a name="l06719"></a>06719          snprintf(fn, <span class="keyword">sizeof</span>(fn), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, receiver-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, s);
<a name="l06720"></a>06720          <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(fn, -1, s, receiver-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l06721"></a>06721          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(fn, NULL, NULL) &gt; 0) {
<a name="l06722"></a>06722             res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, fn, ecodes);
<a name="l06723"></a>06723             <span class="keywordflow">if</span> (res) {
<a name="l06724"></a>06724                <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);
<a name="l06725"></a>06725                <span class="keywordflow">return</span> res;
<a name="l06726"></a>06726             }
<a name="l06727"></a>06727          } <span class="keywordflow">else</span> {
<a name="l06728"></a>06728             res = <a class="code" href="say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce" title="says digits of a string">ast_say_digit_str</a>(chan, s, ecodes, chan-&gt;language);
<a name="l06729"></a>06729          }
<a name="l06730"></a>06730          <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(fn, -1);
<a name="l06731"></a>06731 
<a name="l06732"></a>06732          s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;*&quot;</span>);
<a name="l06733"></a>06733       }
<a name="l06734"></a>06734       <span class="comment">/* break from the loop of reading the extensions */</span>
<a name="l06735"></a>06735       <span class="keywordflow">if</span> (valid_extensions)
<a name="l06736"></a>06736          <span class="keywordflow">break</span>;
<a name="l06737"></a>06737       <span class="comment">/* &quot;I am sorry, that&apos;s not a valid extension.  Please try again.&quot; */</span>
<a name="l06738"></a>06738       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;pbx-invalid&quot;</span>);
<a name="l06739"></a>06739    }
<a name="l06740"></a>06740    <span class="comment">/* check if we&apos;re clear to proceed */</span>
<a name="l06741"></a>06741    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;extensions) || !valid_extensions)
<a name="l06742"></a>06742       <span class="keywordflow">return</span> res;
<a name="l06743"></a>06743    <span class="keywordflow">if</span> (is_new_message == 1) {
<a name="l06744"></a>06744       <span class="keyword">struct </span><a class="code" href="structleave__vm__options.html" title="Options for leaving voicemail with the voicemail() application.">leave_vm_options</a> leave_options;
<a name="l06745"></a>06745       <span class="keywordtype">char</span> mailbox[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a> * 2 + 2];
<a name="l06746"></a>06746       snprintf(mailbox, <span class="keyword">sizeof</span>(mailbox), <span class="stringliteral">&quot;%s@%s&quot;</span>, username, context);
<a name="l06747"></a>06747 
<a name="l06748"></a>06748       <span class="comment">/* Send VoiceMail */</span>
<a name="l06749"></a>06749       memset(&amp;leave_options, 0, <span class="keyword">sizeof</span>(leave_options));
<a name="l06750"></a>06750       leave_options.<a class="code" href="structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a> = record_gain;
<a name="l06751"></a>06751       cmd = <a class="code" href="app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff" title="Prompts the user and records a voicemail to a mailbox.">leave_voicemail</a>(chan, mailbox, &amp;leave_options);
<a name="l06752"></a>06752    } <span class="keywordflow">else</span> {
<a name="l06753"></a>06753       <span class="comment">/* Forward VoiceMail */</span>
<a name="l06754"></a>06754       <span class="keywordtype">long</span> duration = 0;
<a name="l06755"></a>06755       <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> vmstmp;
<a name="l06756"></a>06756       memcpy(&amp;vmstmp, vms, <span class="keyword">sizeof</span>(vmstmp));
<a name="l06757"></a>06757 
<a name="l06758"></a>06758       <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(dir, curmsg, sender-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, sender-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l06759"></a>06759 
<a name="l06760"></a>06760       cmd = <a class="code" href="app__voicemail_8c.html#aa93908872a830d4aecaca36f45bd0273" title="presents the option to prepend to an existing message when forwarding it.">vm_forwardoptions</a>(chan, sender, vmstmp.<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, curmsg, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(context, <span class="stringliteral">&quot;default&quot;</span>), record_gain, &amp;duration, &amp;vmstmp, urgent_str);
<a name="l06761"></a>06761       <span class="keywordflow">if</span> (!cmd) {
<a name="l06762"></a>06762          <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;extensions, vmtmp, list) {
<a name="l06763"></a>06763 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06764"></a>06764 <span class="preprocessor"></span>            <span class="keywordtype">int</span> attach_user_voicemail;
<a name="l06765"></a>06765             <span class="keywordtype">char</span> *myserveremail = <a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>;
<a name="l06766"></a>06766             
<a name="l06767"></a>06767             <span class="comment">/* get destination mailbox */</span>
<a name="l06768"></a>06768             dstvms = get_vm_state_by_mailbox(vmtmp-&gt;mailbox, vmtmp-&gt;context, 0);
<a name="l06769"></a>06769             <span class="keywordflow">if</span> (!dstvms) {
<a name="l06770"></a>06770                dstvms = create_vm_state_from_user(vmtmp);
<a name="l06771"></a>06771             }
<a name="l06772"></a>06772             <span class="keywordflow">if</span> (dstvms) {
<a name="l06773"></a>06773                init_mailstream(dstvms, 0);
<a name="l06774"></a>06774                <span class="keywordflow">if</span> (!dstvms-&gt;mailstream) {
<a name="l06775"></a>06775                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;IMAP mailstream for %s is NULL\n&quot;</span>, vmtmp-&gt;mailbox);
<a name="l06776"></a>06776                } <span class="keywordflow">else</span> {
<a name="l06777"></a>06777                   <a class="code" href="app__voicemail_8c.html#ab02316037e0d0e5b69b6aef860aabe08">STORE</a>(vmstmp.<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vmtmp-&gt;mailbox, vmtmp-&gt;context, dstvms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, chan, vmtmp, fmt, duration, dstvms, urgent_str);
<a name="l06778"></a>06778                   <a class="code" href="app__voicemail_8c.html#a9c5687a6ba659f56c96ebc103673d85a">run_externnotify</a>(vmtmp-&gt;context, vmtmp-&gt;mailbox, urgent_str); 
<a name="l06779"></a>06779                }
<a name="l06780"></a>06780             } <span class="keywordflow">else</span> {
<a name="l06781"></a>06781                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not find state information for mailbox %s\n&quot;</span>, vmtmp-&gt;mailbox);
<a name="l06782"></a>06782             }
<a name="l06783"></a>06783             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmtmp-&gt;serveremail))
<a name="l06784"></a>06784                myserveremail = vmtmp-&gt;serveremail;
<a name="l06785"></a>06785             attach_user_voicemail = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmtmp, <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>);
<a name="l06786"></a>06786             <span class="comment">/* NULL category for IMAP storage */</span>
<a name="l06787"></a>06787             <a class="code" href="app__voicemail_8c.html#a183096024fd4bf12223521cbfae96856">sendmail</a>(myserveremail, vmtmp, todircount, vmtmp-&gt;context, vmtmp-&gt;mailbox, dstvms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, NULL), <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, NULL), vmstmp.<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmstmp.introfn, fmt, duration, attach_user_voicemail, chan, NULL, urgent_str);
<a name="l06788"></a>06788 <span class="preprocessor">#else</span>
<a name="l06789"></a>06789 <span class="preprocessor"></span>            <a class="code" href="app__voicemail_8c.html#a6a81ca7c488e8311134145f6c11c16b9" title="Copies a message from one mailbox to another.">copy_message</a>(chan, sender, 0, curmsg, duration, vmtmp, fmt, dir, urgent_str);
<a name="l06790"></a>06790 <span class="preprocessor">#endif</span>
<a name="l06791"></a>06791 <span class="preprocessor"></span>            saved_messages++;
<a name="l06792"></a>06792             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(list);
<a name="l06793"></a>06793             <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmtmp);
<a name="l06794"></a>06794             <span class="keywordflow">if</span> (res)
<a name="l06795"></a>06795                <span class="keywordflow">break</span>;
<a name="l06796"></a>06796          }
<a name="l06797"></a>06797          <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l06798"></a>06798          <span class="keywordflow">if</span> (saved_messages &gt; 0) {
<a name="l06799"></a>06799             <span class="comment">/* give confirmation that the message was saved */</span>
<a name="l06800"></a>06800             <span class="comment">/* commented out since we can&apos;t forward batches yet</span>
<a name="l06801"></a>06801 <span class="comment">            if (saved_messages == 1)</span>
<a name="l06802"></a>06802 <span class="comment">               res = ast_play_and_wait(chan, &quot;vm-message&quot;);</span>
<a name="l06803"></a>06803 <span class="comment">            else</span>
<a name="l06804"></a>06804 <span class="comment">               res = ast_play_and_wait(chan, &quot;vm-messages&quot;);</span>
<a name="l06805"></a>06805 <span class="comment">            if (!res)</span>
<a name="l06806"></a>06806 <span class="comment">               res = ast_play_and_wait(chan, &quot;vm-saved&quot;); */</span>
<a name="l06807"></a>06807 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l06808"></a>06808 <span class="preprocessor"></span>            <span class="comment">/* If forwarded with intro, DON&apos;T PLAY THIS MESSAGE AGAIN! */</span>
<a name="l06809"></a>06809             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmstmp.introfn))
<a name="l06810"></a>06810 <span class="preprocessor">#endif</span>
<a name="l06811"></a>06811 <span class="preprocessor"></span>            res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>);
<a name="l06812"></a>06812          }  
<a name="l06813"></a>06813 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l06814"></a>06814 <span class="preprocessor"></span>         <span class="comment">/* Restore original message without prepended message if backup exists */</span>
<a name="l06815"></a>06815          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(msgfile, <span class="keyword">sizeof</span>(msgfile), dir, curmsg);
<a name="l06816"></a>06816          strcpy(textfile, msgfile);
<a name="l06817"></a>06817          strcpy(backup, msgfile);
<a name="l06818"></a>06818          strcpy(backup_textfile, msgfile);
<a name="l06819"></a>06819          strncat(textfile, <span class="stringliteral">&quot;.txt&quot;</span>, <span class="keyword">sizeof</span>(textfile) - strlen(textfile) - 1);
<a name="l06820"></a>06820          strncat(backup, <span class="stringliteral">&quot;-bak&quot;</span>, <span class="keyword">sizeof</span>(backup) - strlen(backup) - 1);
<a name="l06821"></a>06821          strncat(backup_textfile, <span class="stringliteral">&quot;-bak.txt&quot;</span>, <span class="keyword">sizeof</span>(backup_textfile) - strlen(backup_textfile) - 1);
<a name="l06822"></a>06822          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(backup, NULL, NULL) &gt; 0) {
<a name="l06823"></a>06823             <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(backup, msgfile, NULL);
<a name="l06824"></a>06824             rename(backup_textfile, textfile);
<a name="l06825"></a>06825          }
<a name="l06826"></a>06826 <span class="preprocessor">#endif</span>
<a name="l06827"></a>06827 <span class="preprocessor"></span>      }
<a name="l06828"></a>06828       <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(dir, curmsg);
<a name="l06829"></a>06829    }
<a name="l06830"></a>06830 
<a name="l06831"></a>06831    <span class="comment">/* If anything failed above, we still have this list to free */</span>
<a name="l06832"></a>06832    <span class="keywordflow">while</span> ((vmtmp = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;extensions, list)))
<a name="l06833"></a>06833       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmtmp);
<a name="l06834"></a>06834    <span class="keywordflow">return</span> res ? res : cmd;
<a name="l06835"></a>06835 }
<a name="l06836"></a>06836 
<a name="l06837"></a><a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">06837</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *file)
<a name="l06838"></a>06838 {
<a name="l06839"></a>06839    <span class="keywordtype">int</span> res;
<a name="l06840"></a>06840    <span class="keywordflow">if</span> ((res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, file, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>)) &lt; 0) 
<a name="l06841"></a>06841       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to play message %s\n&quot;</span>, file); 
<a name="l06842"></a>06842    <span class="keywordflow">return</span> res;
<a name="l06843"></a>06843 }
<a name="l06844"></a>06844 
<a name="l06845"></a><a class="code" href="app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">06845</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *file) 
<a name="l06846"></a>06846 {
<a name="l06847"></a>06847    <span class="keywordflow">return</span> <a class="code" href="app_8h.html#a3405b1282cefdceebba734b8e756c55d" title="Stream a file with fast forward, pause, reverse, restart.">ast_control_streamfile</a>(chan, file, <a class="code" href="app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a>, <a class="code" href="app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a>, <a class="code" href="app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a>, <a class="code" href="app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a>, <a class="code" href="app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a>, <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a>, NULL);
<a name="l06848"></a>06848 }
<a name="l06849"></a>06849 
<a name="l06850"></a><a class="code" href="app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7">06850</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7">play_message_category</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *category)
<a name="l06851"></a>06851 {
<a name="l06852"></a>06852    <span class="keywordtype">int</span> res = 0;
<a name="l06853"></a>06853 
<a name="l06854"></a>06854    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(category))
<a name="l06855"></a>06855       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, category);
<a name="l06856"></a>06856 
<a name="l06857"></a>06857    <span class="keywordflow">if</span> (res) {
<a name="l06858"></a>06858       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No sound file for category &apos;%s&apos; was found.\n&quot;</span>, category);
<a name="l06859"></a>06859       res = 0;
<a name="l06860"></a>06860    }
<a name="l06861"></a>06861 
<a name="l06862"></a>06862    <span class="keywordflow">return</span> res;
<a name="l06863"></a>06863 }
<a name="l06864"></a>06864 
<a name="l06865"></a><a class="code" href="app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">06865</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime, <span class="keyword">const</span> <span class="keywordtype">char</span> *filename)
<a name="l06866"></a>06866 {
<a name="l06867"></a>06867    <span class="keywordtype">int</span> res = 0;
<a name="l06868"></a>06868    <span class="keyword">struct </span><a class="code" href="structvm__zone.html">vm_zone</a> *the_zone = NULL;
<a name="l06869"></a>06869    time_t t;
<a name="l06870"></a>06870 
<a name="l06871"></a>06871    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a3b5457e5f5679935093d94b0f788769e" title="get values from config variables.">ast_get_time_t</a>(origtime, &amp;t, 0, NULL)) {
<a name="l06872"></a>06872       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t find origtime in %s\n&quot;</span>, filename);
<a name="l06873"></a>06873       <span class="keywordflow">return</span> 0;
<a name="l06874"></a>06874    }
<a name="l06875"></a>06875 
<a name="l06876"></a>06876    <span class="comment">/* Does this user have a timezone specified? */</span>
<a name="l06877"></a>06877    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>)) {
<a name="l06878"></a>06878       <span class="comment">/* Find the zone in the list */</span>
<a name="l06879"></a>06879       <span class="keyword">struct </span><a class="code" href="structvm__zone.html">vm_zone</a> *z;
<a name="l06880"></a>06880       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;zones);
<a name="l06881"></a>06881       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;zones, z, list) {
<a name="l06882"></a>06882          <span class="keywordflow">if</span> (!strcmp(z-&gt;name, vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>)) {
<a name="l06883"></a>06883             the_zone = z;
<a name="l06884"></a>06884             <span class="keywordflow">break</span>;
<a name="l06885"></a>06885          }
<a name="l06886"></a>06886       }
<a name="l06887"></a>06887       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;zones);
<a name="l06888"></a>06888    }
<a name="l06889"></a>06889 
<a name="l06890"></a>06890 <span class="comment">/* No internal variable parsing for now, so we&apos;ll comment it out for the time being */</span>
<a name="l06891"></a>06891 <span class="preprocessor">#if 0</span>
<a name="l06892"></a>06892 <span class="preprocessor"></span>   <span class="comment">/* Set the DIFF_* variables */</span>
<a name="l06893"></a>06893    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;t, &amp;time_now, NULL);
<a name="l06894"></a>06894    tv_now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l06895"></a>06895    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;tv_now, &amp;time_then, NULL);
<a name="l06896"></a>06896 
<a name="l06897"></a>06897    <span class="comment">/* Day difference */</span>
<a name="l06898"></a>06898    <span class="keywordflow">if</span> (time_now.tm_year == time_then.tm_year)
<a name="l06899"></a>06899       snprintf(temp,<span class="keyword">sizeof</span>(temp),<span class="stringliteral">&quot;%d&quot;</span>,time_now.tm_yday);
<a name="l06900"></a>06900    <span class="keywordflow">else</span>
<a name="l06901"></a>06901       snprintf(temp,<span class="keyword">sizeof</span>(temp),<span class="stringliteral">&quot;%d&quot;</span>,(time_now.tm_year - time_then.tm_year) * 365 + (time_now.tm_yday - time_then.tm_yday));
<a name="l06902"></a>06902    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;DIFF_DAY&quot;</span>, temp);
<a name="l06903"></a>06903 
<a name="l06904"></a>06904    <span class="comment">/* Can&apos;t think of how other diffs might be helpful, but I&apos;m sure somebody will think of something. */</span>
<a name="l06905"></a>06905 <span class="preprocessor">#endif</span>
<a name="l06906"></a>06906 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (the_zone) {
<a name="l06907"></a>06907       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, the_zone-&gt;msg_format, the_zone-&gt;timezone);
<a name="l06908"></a>06908    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;de&quot;</span>, 2)) {     <span class="comment">/* GERMAN syntax */</span>
<a name="l06909"></a>06909       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; Q &apos;digits/at&apos; HM&quot;</span>, NULL);
<a name="l06910"></a>06910    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;gr&quot;</span>, 2)) {     <span class="comment">/* GREEK syntax */</span>
<a name="l06911"></a>06911       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; q  H &apos;digits/kai&apos; M &quot;</span>, NULL);
<a name="l06912"></a>06912    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;it&quot;</span>, 2)) {     <span class="comment">/* ITALIAN syntax */</span>
<a name="l06913"></a>06913       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; q &apos;digits/at&apos; &apos;digits/hours&apos; k &apos;digits/e&apos; M &apos;digits/minutes&apos;&quot;</span>, NULL);
<a name="l06914"></a>06914    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;nl&quot;</span>, 2)) {     <span class="comment">/* DUTCH syntax */</span>
<a name="l06915"></a>06915       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; q &apos;digits/nl-om&apos; HM&quot;</span>, NULL);
<a name="l06916"></a>06916    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;no&quot;</span>, 2)) {     <span class="comment">/* NORWEGIAN syntax */</span>
<a name="l06917"></a>06917       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; Q &apos;digits/at&apos; HM&quot;</span>, NULL);
<a name="l06918"></a>06918    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pl&quot;</span>, 2)) {     <span class="comment">/* POLISH syntax */</span>
<a name="l06919"></a>06919       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; Q HM&quot;</span>, NULL);
<a name="l06920"></a>06920    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pt_BR&quot;</span>, 5)) {  <span class="comment">/* Brazillian PORTUGUESE syntax */</span>
<a name="l06921"></a>06921       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; Ad &apos;digits/pt-de&apos; B &apos;digits/pt-de&apos; Y &apos;digits/pt-as&apos; HM &quot;</span>, NULL);
<a name="l06922"></a>06922    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;se&quot;</span>, 2)) {     <span class="comment">/* SWEDISH syntax */</span>
<a name="l06923"></a>06923       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; dB &apos;digits/at&apos; k &apos;and&apos; M&quot;</span>, NULL);
<a name="l06924"></a>06924    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;zh&quot;</span>, 2)) {     <span class="comment">/* CHINESE (Taiwan) syntax */</span>
<a name="l06925"></a>06925       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;qR &apos;vm-received&apos;&quot;</span>, NULL);
<a name="l06926"></a>06926    } <span class="keywordflow">else</span> {
<a name="l06927"></a>06927       res = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>(chan, t, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;&apos;vm-received&apos; q &apos;digits/at&apos; IMp&quot;</span>, NULL);
<a name="l06928"></a>06928    }
<a name="l06929"></a>06929 <span class="preprocessor">#if 0</span>
<a name="l06930"></a>06930 <span class="preprocessor"></span>   <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;DIFF_DAY&quot;</span>, NULL);
<a name="l06931"></a>06931 <span class="preprocessor">#endif</span>
<a name="l06932"></a>06932 <span class="preprocessor"></span>   <span class="keywordflow">return</span> res;
<a name="l06933"></a>06933 }
<a name="l06934"></a>06934 
<a name="l06935"></a>06935 
<a name="l06936"></a>06936 
<a name="l06937"></a><a class="code" href="app__voicemail_8c.html#aa8115f2c7ff87c075e34851f9ea8ce58">06937</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aa8115f2c7ff87c075e34851f9ea8ce58">play_message_callerid</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *cid, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keywordtype">int</span> callback)
<a name="l06938"></a>06938 {
<a name="l06939"></a>06939    <span class="keywordtype">int</span> res = 0;
<a name="l06940"></a>06940    <span class="keywordtype">int</span> i;
<a name="l06941"></a>06941    <span class="keywordtype">char</span> *callerid, *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l06942"></a>06942    <span class="keywordtype">char</span> prefile[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l06943"></a>06943    
<a name="l06944"></a>06944 
<a name="l06945"></a>06945    <span class="comment">/* If voicemail cid is not enabled, or we didn&apos;t get cid or context from</span>
<a name="l06946"></a>06946 <span class="comment">    * the attribute file, leave now.</span>
<a name="l06947"></a>06947 <span class="comment">    *</span>
<a name="l06948"></a>06948 <span class="comment">    * TODO Still need to change this so that if this function is called by the</span>
<a name="l06949"></a>06949 <span class="comment">    * message envelope (and someone is explicitly requesting to hear the CID),</span>
<a name="l06950"></a>06950 <span class="comment">    * it does not check to see if CID is enabled in the config file.</span>
<a name="l06951"></a>06951 <span class="comment">    */</span>
<a name="l06952"></a>06952    <span class="keywordflow">if</span> ((cid == NULL)||(context == NULL))
<a name="l06953"></a>06953       <span class="keywordflow">return</span> res;
<a name="l06954"></a>06954 
<a name="l06955"></a>06955    <span class="comment">/* Strip off caller ID number from name */</span>
<a name="l06956"></a>06956    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: composite caller ID received: %s, context: %s\n&quot;</span>, cid, context);
<a name="l06957"></a>06957    <a class="code" href="callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df" title="Destructively parse inbuf into name and location (or number) Parses callerid stream...">ast_callerid_parse</a>(cid, &amp;name, &amp;callerid);
<a name="l06958"></a>06958    <span class="keywordflow">if</span> ((!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(callerid)) &amp;&amp; strcmp(callerid, <span class="stringliteral">&quot;Unknown&quot;</span>)) {
<a name="l06959"></a>06959       <span class="comment">/* Check for internal contexts and only */</span>
<a name="l06960"></a>06960       <span class="comment">/* say extension when the call didn&apos;t come from an internal context in the list */</span>
<a name="l06961"></a>06961       <span class="keywordflow">for</span> (i = 0 ; i &lt; <a class="code" href="app__minivm_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a> ; i++){
<a name="l06962"></a>06962          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: comparing internalcontext: %s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[i]);
<a name="l06963"></a>06963          <span class="keywordflow">if</span> ((strcmp(<a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[i], context) == 0))
<a name="l06964"></a>06964             <span class="keywordflow">break</span>;
<a name="l06965"></a>06965       }
<a name="l06966"></a>06966       <span class="keywordflow">if</span> (i != MAX_NUM_CID_CONTEXTS){ <span class="comment">/* internal context? */</span>
<a name="l06967"></a>06967          <span class="keywordflow">if</span> (!res) {
<a name="l06968"></a>06968             snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, callerid);
<a name="l06969"></a>06969             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(prefile)) {
<a name="l06970"></a>06970             <span class="comment">/* See if we can find a recorded name for this person instead of their extension number */</span>
<a name="l06971"></a>06971                <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &gt; 0) {
<a name="l06972"></a>06972                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing envelope info: CID number &apos;%s&apos; matches mailbox number, playing recorded name\n&quot;</span>, callerid);
<a name="l06973"></a>06973                   <span class="keywordflow">if</span> (!callback)
<a name="l06974"></a>06974                      res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from&quot;</span>);
<a name="l06975"></a>06975                   res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, prefile, <span class="stringliteral">&quot;&quot;</span>);
<a name="l06976"></a>06976                } <span class="keywordflow">else</span> {
<a name="l06977"></a>06977                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Playing envelope info: message from &apos;%s&apos;\n&quot;</span>, callerid);
<a name="l06978"></a>06978                   <span class="comment">/* Say &quot;from extension&quot; as one saying to sound smoother */</span>
<a name="l06979"></a>06979                   <span class="keywordflow">if</span> (!callback)
<a name="l06980"></a>06980                      res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from-extension&quot;</span>);
<a name="l06981"></a>06981                   res = <a class="code" href="say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce" title="says digits of a string">ast_say_digit_str</a>(chan, callerid, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l06982"></a>06982                }
<a name="l06983"></a>06983             }
<a name="l06984"></a>06984          }
<a name="l06985"></a>06985       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l06986"></a>06986          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: Numeric caller id: (%s)\n&quot;</span>, callerid);
<a name="l06987"></a>06987          <span class="comment">/* Since this is all nicely figured out, why not say &quot;from phone number&quot; in this case? */</span>
<a name="l06988"></a>06988          <span class="keywordflow">if</span> (!callback)
<a name="l06989"></a>06989             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-from-phonenumber&quot;</span>);
<a name="l06990"></a>06990          res = <a class="code" href="say_8h.html#ac8bd6c34b6aa664adb9ebfab68a500ce" title="says digits of a string">ast_say_digit_str</a>(chan, callerid, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language);
<a name="l06991"></a>06991       }
<a name="l06992"></a>06992    } <span class="keywordflow">else</span> {
<a name="l06993"></a>06993       <span class="comment">/* Number unknown */</span>
<a name="l06994"></a>06994       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM-CID: From an unknown number\n&quot;</span>);
<a name="l06995"></a>06995       <span class="comment">/* Say &quot;from an unknown caller&quot; as one phrase - it is already recorded by &quot;the voice&quot; anyhow */</span>
<a name="l06996"></a>06996       res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-unknown-caller&quot;</span>);
<a name="l06997"></a>06997    }
<a name="l06998"></a>06998    <span class="keywordflow">return</span> res;
<a name="l06999"></a>06999 }
<a name="l07000"></a>07000 
<a name="l07001"></a><a class="code" href="app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a">07001</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a">play_message_duration</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> *duration, <span class="keywordtype">int</span> minduration)
<a name="l07002"></a>07002 {
<a name="l07003"></a>07003    <span class="keywordtype">int</span> res = 0;
<a name="l07004"></a>07004    <span class="keywordtype">int</span> durationm;
<a name="l07005"></a>07005    <span class="keywordtype">int</span> durations;
<a name="l07006"></a>07006    <span class="comment">/* Verify that we have a duration for the message */</span>
<a name="l07007"></a>07007    <span class="keywordflow">if</span> (duration == NULL)
<a name="l07008"></a>07008       <span class="keywordflow">return</span> res;
<a name="l07009"></a>07009 
<a name="l07010"></a>07010    <span class="comment">/* Convert from seconds to minutes */</span>
<a name="l07011"></a>07011    durations=atoi(duration);
<a name="l07012"></a>07012    durationm=(durations / 60);
<a name="l07013"></a>07013 
<a name="l07014"></a>07014    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM-Duration: duration is: %d seconds converted to: %d minutes\n&quot;</span>, durations, durationm);
<a name="l07015"></a>07015 
<a name="l07016"></a>07016    <span class="keywordflow">if</span> ((!res) &amp;&amp; (durationm &gt;= minduration)) {
<a name="l07017"></a>07017       res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-duration&quot;</span>);
<a name="l07018"></a>07018 
<a name="l07019"></a>07019       <span class="comment">/* POLISH syntax */</span>
<a name="l07020"></a>07020       <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pl&quot;</span>, 2)) {
<a name="l07021"></a>07021          div_t <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a> = div(durationm, 10);
<a name="l07022"></a>07022 
<a name="l07023"></a>07023          <span class="keywordflow">if</span> (durationm == 1) {
<a name="l07024"></a>07024             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1z&quot;</span>);
<a name="l07025"></a>07025             res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-minute-ta&quot;</span>);
<a name="l07026"></a>07026          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {
<a name="l07027"></a>07027             <span class="keywordflow">if</span> (num.rem == 2) {
<a name="l07028"></a>07028                <span class="keywordflow">if</span> (!num.quot) {
<a name="l07029"></a>07029                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);
<a name="l07030"></a>07030                } <span class="keywordflow">else</span> {
<a name="l07031"></a>07031                   res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, durationm - 2 , chan-&gt;language);
<a name="l07032"></a>07032                   res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);
<a name="l07033"></a>07033                }
<a name="l07034"></a>07034             } <span class="keywordflow">else</span> {
<a name="l07035"></a>07035                res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, durationm, chan-&gt;language);
<a name="l07036"></a>07036             }
<a name="l07037"></a>07037             res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-minute-ty&quot;</span>);
<a name="l07038"></a>07038          } <span class="keywordflow">else</span> {
<a name="l07039"></a>07039             res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, durationm, chan-&gt;language);
<a name="l07040"></a>07040             res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-minute-t&quot;</span>);
<a name="l07041"></a>07041          }
<a name="l07042"></a>07042       <span class="comment">/* DEFAULT syntax */</span>
<a name="l07043"></a>07043       } <span class="keywordflow">else</span> {
<a name="l07044"></a>07044          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, durationm, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, NULL);
<a name="l07045"></a>07045          res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-minutes&quot;</span>);
<a name="l07046"></a>07046       }
<a name="l07047"></a>07047    }
<a name="l07048"></a>07048    <span class="keywordflow">return</span> res;
<a name="l07049"></a>07049 }
<a name="l07050"></a>07050 
<a name="l07051"></a><a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">07051</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07052"></a>07052 {
<a name="l07053"></a>07053    <span class="keywordtype">int</span> res = 0;
<a name="l07054"></a>07054    <span class="keywordtype">char</span> filename[256], *cid;
<a name="l07055"></a>07055    <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime, *context, *category, *duration, *flag;
<a name="l07056"></a>07056    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *msg_cfg;
<a name="l07057"></a>07057    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26a3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a> };
<a name="l07058"></a>07058 
<a name="l07059"></a>07059    vms-&gt;<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 0;
<a name="l07060"></a>07060    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);
<a name="l07061"></a>07061    <a class="code" href="app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a>(chan, vms);
<a name="l07062"></a>07062    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>)
<a name="l07063"></a>07063       res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-first&quot;</span>);  <span class="comment">/* &quot;First&quot; */</span>
<a name="l07064"></a>07064    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> == vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)
<a name="l07065"></a>07065       res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-last&quot;</span>);      <span class="comment">/* &quot;last&quot; */</span>
<a name="l07066"></a>07066 
<a name="l07067"></a>07067    snprintf(filename, <span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l07068"></a>07068    <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l07069"></a>07069    msg_cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);
<a name="l07070"></a>07070    <span class="keywordflow">if</span> (!msg_cfg || msg_cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l07071"></a>07071       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No message attribute file?!! (%s)\n&quot;</span>, filename);
<a name="l07072"></a>07072       <span class="keywordflow">return</span> 0;
<a name="l07073"></a>07073    }
<a name="l07074"></a>07074    flag = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;flag&quot;</span>);
<a name="l07075"></a>07075 
<a name="l07076"></a>07076    <span class="comment">/* Play the word urgent if we are listening to urgent messages */</span>
<a name="l07077"></a>07077    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; !strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>)) {
<a name="l07078"></a>07078       res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-Urgent&quot;</span>); <span class="comment">/* &quot;urgent&quot; */</span>
<a name="l07079"></a>07079    }
<a name="l07080"></a>07080 
<a name="l07081"></a>07081    <span class="keywordflow">if</span> (!res) {
<a name="l07082"></a>07082       <span class="comment">/* POLISH syntax */</span>
<a name="l07083"></a>07083       <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pl&quot;</span>, 2)) {
<a name="l07084"></a>07084          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &amp;&amp; (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)) {
<a name="l07085"></a>07085             <span class="keywordtype">int</span> ten, one;
<a name="l07086"></a>07086             <span class="keywordtype">char</span> nextmsg[256];
<a name="l07087"></a>07087             ten = (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1) / 10;
<a name="l07088"></a>07088             one = (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1) % 10;
<a name="l07089"></a>07089 
<a name="l07090"></a>07090             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; 20) {
<a name="l07091"></a>07091                snprintf(nextmsg, <span class="keyword">sizeof</span>(nextmsg), <span class="stringliteral">&quot;digits/n-%d&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1);
<a name="l07092"></a>07092                res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, nextmsg);
<a name="l07093"></a>07093             } <span class="keywordflow">else</span> {
<a name="l07094"></a>07094                snprintf(nextmsg, <span class="keyword">sizeof</span>(nextmsg), <span class="stringliteral">&quot;digits/n-%d&quot;</span>, ten * 10);
<a name="l07095"></a>07095                res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, nextmsg);
<a name="l07096"></a>07096                <span class="keywordflow">if</span> (one &gt; 0) {
<a name="l07097"></a>07097                   <span class="keywordflow">if</span> (!res) {
<a name="l07098"></a>07098                      snprintf(nextmsg, <span class="keyword">sizeof</span>(nextmsg), <span class="stringliteral">&quot;digits/n-%d&quot;</span>, one);
<a name="l07099"></a>07099                      res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, nextmsg);
<a name="l07100"></a>07100                   }
<a name="l07101"></a>07101                }
<a name="l07102"></a>07102             }
<a name="l07103"></a>07103          }
<a name="l07104"></a>07104          <span class="keywordflow">if</span> (!res)
<a name="l07105"></a>07105             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07106"></a>07106       <span class="comment">/* HEBREW syntax */</span>
<a name="l07107"></a>07107       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;he&quot;</span>, 2)) {
<a name="l07108"></a>07108          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>) {
<a name="l07109"></a>07109             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07110"></a>07110             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-first&quot;</span>);
<a name="l07111"></a>07111          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> == vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l07112"></a>07112             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07113"></a>07113             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-last&quot;</span>);
<a name="l07114"></a>07114          } <span class="keywordflow">else</span> {
<a name="l07115"></a>07115             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07116"></a>07116             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-number&quot;</span>);
<a name="l07117"></a>07117             res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l07118"></a>07118          }
<a name="l07119"></a>07119       } <span class="keywordflow">else</span> {
<a name="l07120"></a>07120          <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;se&quot;</span>, 2)) { <span class="comment">/* SWEDISH syntax */</span>
<a name="l07121"></a>07121             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-meddelandet&quot;</span>);  <span class="comment">/* &quot;message&quot; */</span>
<a name="l07122"></a>07122          } <span class="keywordflow">else</span> { <span class="comment">/* DEFAULT syntax */</span>
<a name="l07123"></a>07123             res = <a class="code" href="app__voicemail_8c.html#a2012b5c7bf02359d9f3f8925adda0188">wait_file2</a>(chan, vms, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07124"></a>07124          }
<a name="l07125"></a>07125          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &amp;&amp; (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>)) {
<a name="l07126"></a>07126             <span class="keywordflow">if</span> (!res) {
<a name="l07127"></a>07127                res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, NULL);
<a name="l07128"></a>07128             }
<a name="l07129"></a>07129          }
<a name="l07130"></a>07130       }
<a name="l07131"></a>07131    }
<a name="l07132"></a>07132 
<a name="l07133"></a>07133    <span class="keywordflow">if</span> (!msg_cfg) {
<a name="l07134"></a>07134       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No message attribute file?!! (%s)\n&quot;</span>, filename);
<a name="l07135"></a>07135       <span class="keywordflow">return</span> 0;
<a name="l07136"></a>07136    }
<a name="l07137"></a>07137 
<a name="l07138"></a>07138    <span class="keywordflow">if</span> (!(origtime = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {
<a name="l07139"></a>07139       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No origtime?!\n&quot;</span>);
<a name="l07140"></a>07140       <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);
<a name="l07141"></a>07141       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l07142"></a>07142       <span class="keywordflow">return</span> 0;
<a name="l07143"></a>07143    }
<a name="l07144"></a>07144 
<a name="l07145"></a>07145    cid = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>));
<a name="l07146"></a>07146    duration = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;duration&quot;</span>);
<a name="l07147"></a>07147    category = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;category&quot;</span>);
<a name="l07148"></a>07148 
<a name="l07149"></a>07149    context = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>);
<a name="l07150"></a>07150    <span class="keywordflow">if</span> (!strncasecmp(<span class="stringliteral">&quot;macro&quot;</span>,context,5)) <span class="comment">/* Macro names in contexts are useless for our needs */</span>
<a name="l07151"></a>07151       context = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>,<span class="stringliteral">&quot;macrocontext&quot;</span>);
<a name="l07152"></a>07152    <span class="keywordflow">if</span> (!res) {
<a name="l07153"></a>07153       res = <a class="code" href="app__voicemail_8c.html#a44be24993dd8a1b6ba1dbbf5963be7f7">play_message_category</a>(chan, category);
<a name="l07154"></a>07154    }
<a name="l07155"></a>07155    <span class="keywordflow">if</span> ((!res) &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>)))
<a name="l07156"></a>07156       res = <a class="code" href="app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a>(chan, vmu, origtime, filename);
<a name="l07157"></a>07157    <span class="keywordflow">if</span> ((!res) &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>)))
<a name="l07158"></a>07158       res = <a class="code" href="app__voicemail_8c.html#aa8115f2c7ff87c075e34851f9ea8ce58">play_message_callerid</a>(chan, vms, cid, context, 0);
<a name="l07159"></a>07159    <span class="keywordflow">if</span> ((!res) &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>)))
<a name="l07160"></a>07160       res = <a class="code" href="app__voicemail_8c.html#a3dd583755e5b2238016cdeb757a4ef0a">play_message_duration</a>(chan, vms, duration, vmu-&gt;<a class="code" href="structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a>);
<a name="l07161"></a>07161    <span class="comment">/* Allow pressing &apos;1&apos; to skip envelope / callerid */</span>
<a name="l07162"></a>07162    <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;1&apos;</span>)
<a name="l07163"></a>07163       res = 0;
<a name="l07164"></a>07164    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l07165"></a>07165 
<a name="l07166"></a>07166    <span class="keywordflow">if</span> (!res) {
<a name="l07167"></a>07167       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);
<a name="l07168"></a>07168       vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 1;
<a name="l07169"></a>07169 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l07170"></a>07170 <span class="preprocessor"></span>      <span class="comment">/*IMAP storage stores any prepended message from a forward</span>
<a name="l07171"></a>07171 <span class="comment">       * as a separate file from the rest of the message</span>
<a name="l07172"></a>07172 <span class="comment">       */</span>
<a name="l07173"></a>07173       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vms-&gt;introfn) &amp;&amp; <a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(vms-&gt;introfn, NULL, NULL) &gt; 0) {
<a name="l07174"></a>07174          <a class="code" href="app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;introfn);
<a name="l07175"></a>07175       }
<a name="l07176"></a>07176 <span class="preprocessor">#endif</span>
<a name="l07177"></a>07177 <span class="preprocessor"></span>      <span class="keywordflow">if</span> ((res = <a class="code" href="app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>)) &lt; 0) {
<a name="l07178"></a>07178          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Playback of message %s failed\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l07179"></a>07179          res = 0;
<a name="l07180"></a>07180       }
<a name="l07181"></a>07181    }
<a name="l07182"></a>07182    <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);
<a name="l07183"></a>07183    <span class="keywordflow">return</span> res;
<a name="l07184"></a>07184 }
<a name="l07185"></a>07185 
<a name="l07186"></a>07186 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l07187"></a>07187 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> imap_remove_file(<span class="keywordtype">char</span> *dir, <span class="keywordtype">int</span> msgnum)
<a name="l07188"></a>07188 {
<a name="l07189"></a>07189    <span class="keywordtype">char</span> fn[PATH_MAX];
<a name="l07190"></a>07190    <span class="keywordtype">char</span> full_fn[PATH_MAX];
<a name="l07191"></a>07191    <span class="keywordtype">char</span> <a class="code" href="res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">intro</a>[PATH_MAX] = {0,};
<a name="l07192"></a>07192    
<a name="l07193"></a>07193    <span class="keywordflow">if</span> (msgnum &gt; -1) {
<a name="l07194"></a>07194       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn, <span class="keyword">sizeof</span>(fn), dir, msgnum);
<a name="l07195"></a>07195       snprintf(intro, <span class="keyword">sizeof</span>(intro), <span class="stringliteral">&quot;%sintro&quot;</span>, fn);
<a name="l07196"></a>07196    } <span class="keywordflow">else</span>
<a name="l07197"></a>07197       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fn, dir, <span class="keyword">sizeof</span>(fn));
<a name="l07198"></a>07198    
<a name="l07199"></a>07199    <span class="keywordflow">if</span> ((msgnum &lt; 0 &amp;&amp; imapgreetings) || msgnum &gt; -1) {
<a name="l07200"></a>07200       <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(fn, NULL);
<a name="l07201"></a>07201       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(intro)) {
<a name="l07202"></a>07202          <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(intro, NULL);
<a name="l07203"></a>07203       }
<a name="l07204"></a>07204       snprintf(full_fn, <span class="keyword">sizeof</span>(full_fn), <span class="stringliteral">&quot;%s.txt&quot;</span>, fn);
<a name="l07205"></a>07205       unlink(full_fn);
<a name="l07206"></a>07206    }
<a name="l07207"></a>07207    <span class="keywordflow">return</span> 0;
<a name="l07208"></a>07208 }
<a name="l07209"></a>07209 
<a name="l07210"></a>07210 
<a name="l07211"></a>07211 
<a name="l07212"></a>07212 <span class="keyword">static</span> <span class="keywordtype">int</span> imap_delete_old_greeting (<span class="keywordtype">char</span> *dir, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07213"></a>07213 {
<a name="l07214"></a>07214    <span class="keywordtype">char</span> *file, *filename;
<a name="l07215"></a>07215    <span class="keywordtype">char</span> *attachment;
<a name="l07216"></a>07216    <span class="keywordtype">char</span> arg[10];
<a name="l07217"></a>07217    <span class="keywordtype">int</span> i;
<a name="l07218"></a>07218    BODY* body;
<a name="l07219"></a>07219 
<a name="l07220"></a>07220    
<a name="l07221"></a>07221    file = strrchr(<a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(dir), <span class="charliteral">&apos;/&apos;</span>);
<a name="l07222"></a>07222    <span class="keywordflow">if</span> (file)
<a name="l07223"></a>07223       *file++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l07224"></a>07224    <span class="keywordflow">else</span> {
<a name="l07225"></a>07225       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to procure file name from directory passed. You should never see this.\n&quot;</span>);
<a name="l07226"></a>07226       <span class="keywordflow">return</span> -1;
<a name="l07227"></a>07227    }
<a name="l07228"></a>07228 
<a name="l07229"></a>07229    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms-&gt;lock);
<a name="l07230"></a>07230    <span class="keywordflow">for</span> (i = 0; i &lt; vms-&gt;mailstream-&gt;nmsgs; i++) {
<a name="l07231"></a>07231       mail_fetchstructure(vms-&gt;mailstream, i + 1, &amp;body);
<a name="l07232"></a>07232       <span class="comment">/* We have the body, now we extract the file name of the first attachment. */</span>
<a name="l07233"></a>07233       <span class="keywordflow">if</span> (body-&gt;nested.part-&gt;next &amp;&amp; body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value) {
<a name="l07234"></a>07234          attachment = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(body-&gt;nested.part-&gt;next-&gt;body.parameter-&gt;value);
<a name="l07235"></a>07235       } <span class="keywordflow">else</span> {
<a name="l07236"></a>07236          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;There is no file attached to this IMAP message.\n&quot;</span>);
<a name="l07237"></a>07237          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l07238"></a>07238          <span class="keywordflow">return</span> -1;
<a name="l07239"></a>07239       }
<a name="l07240"></a>07240       filename = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;attachment, <span class="stringliteral">&quot;.&quot;</span>);
<a name="l07241"></a>07241       <span class="keywordflow">if</span> (!strcmp(filename, file)) {
<a name="l07242"></a>07242          sprintf (arg,<span class="stringliteral">&quot;%d&quot;</span>, i+1);
<a name="l07243"></a>07243          mail_setflag (vms-&gt;mailstream,arg,<span class="stringliteral">&quot;\\DELETED&quot;</span>);
<a name="l07244"></a>07244       }
<a name="l07245"></a>07245    }
<a name="l07246"></a>07246    mail_expunge(vms-&gt;mailstream);
<a name="l07247"></a>07247    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms-&gt;lock);
<a name="l07248"></a>07248    <span class="keywordflow">return</span> 0;
<a name="l07249"></a>07249 }
<a name="l07250"></a>07250 
<a name="l07251"></a>07251 <span class="preprocessor">#else</span>
<a name="l07252"></a>07252 <span class="preprocessor"></span><span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l07253"></a><a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">07253</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> box)
<a name="l07254"></a>07254 {
<a name="l07255"></a>07255    <span class="keywordtype">int</span> count_msg, last_msg;
<a name="l07256"></a>07256 
<a name="l07257"></a>07257    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box), <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>));
<a name="l07258"></a>07258    
<a name="l07259"></a>07259    <span class="comment">/* Rename the member vmbox HERE so that we don&apos;t try to return before</span>
<a name="l07260"></a>07260 <span class="comment">    * we know what&apos;s going on.</span>
<a name="l07261"></a>07261 <span class="comment">    */</span>
<a name="l07262"></a>07262    snprintf(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l07263"></a>07263    
<a name="l07264"></a>07264    <span class="comment">/* Faster to make the directory than to check if it exists. */</span>
<a name="l07265"></a>07265    <a class="code" href="app__voicemail_8c.html#aa5e3e27fd305eed351172eff40037938" title="basically mkdir -p $dest/$context/$ext/$folder">create_dirpath</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l07266"></a>07266 
<a name="l07267"></a>07267    count_msg = <a class="code" href="app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6" title="Find all .txt files - even if they are not in sequence from 0000.">count_messages</a>(vmu, vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);
<a name="l07268"></a>07268    <span class="keywordflow">if</span> (count_msg &lt; 0)
<a name="l07269"></a>07269       <span class="keywordflow">return</span> count_msg;
<a name="l07270"></a>07270    <span class="keywordflow">else</span>
<a name="l07271"></a>07271       vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = count_msg - 1;
<a name="l07272"></a>07272 
<a name="l07273"></a>07273    <span class="comment">/*</span>
<a name="l07274"></a>07274 <span class="comment">   The following test is needed in case sequencing gets messed up.</span>
<a name="l07275"></a>07275 <span class="comment">   There appears to be more than one way to mess up sequence, so</span>
<a name="l07276"></a>07276 <span class="comment">   we will not try to find all of the root causes--just fix it when</span>
<a name="l07277"></a>07277 <span class="comment">   detected.</span>
<a name="l07278"></a>07278 <span class="comment">   */</span>
<a name="l07279"></a>07279 
<a name="l07280"></a>07280    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>)) {
<a name="l07281"></a>07281       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not open mailbox %s:  mailbox is locked\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);
<a name="l07282"></a>07282       <span class="keywordflow">return</span> -1;
<a name="l07283"></a>07283    }
<a name="l07284"></a>07284 
<a name="l07285"></a>07285    last_msg = <a class="code" href="app__voicemail_8c.html#a14e2e330719d3180d96608a3b4aad429" title="Determines the highest message number in use for a given user and mailbox folder...">last_message_index</a>(vmu, vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);
<a name="l07286"></a>07286    <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);
<a name="l07287"></a>07287 
<a name="l07288"></a>07288    <span class="keywordflow">if</span> (last_msg &lt; 0) 
<a name="l07289"></a>07289       <span class="keywordflow">return</span> last_msg;
<a name="l07290"></a>07290 
<a name="l07291"></a>07291    <span class="keywordflow">return</span> 0;
<a name="l07292"></a>07292 }
<a name="l07293"></a>07293 <span class="preprocessor">#endif</span>
<a name="l07294"></a>07294 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l07295"></a>07295 <span class="preprocessor"></span>
<a name="l07296"></a><a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">07296</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l07297"></a>07297 {
<a name="l07298"></a>07298    <span class="keywordtype">int</span> x = 0;
<a name="l07299"></a>07299 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l07300"></a>07300 <span class="preprocessor"></span>   <span class="keywordtype">int</span> res = 0, nummsg;
<a name="l07301"></a>07301    <span class="keywordtype">char</span> fn2[PATH_MAX];
<a name="l07302"></a>07302 <span class="preprocessor">#endif</span>
<a name="l07303"></a>07303 <span class="preprocessor"></span>
<a name="l07304"></a>07304    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt;= -1)
<a name="l07305"></a>07305       <span class="keywordflow">goto</span> done;
<a name="l07306"></a>07306 
<a name="l07307"></a>07307    vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1; 
<a name="l07308"></a>07308 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l07309"></a>07309 <span class="preprocessor"></span>   <span class="comment">/* Get the deleted messages fixed */</span> 
<a name="l07310"></a>07310    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a7b7715fe7d49edf843394ee1232f7de1" title="Lock file path only return failure if ast_lock_path returns &amp;#39;timeout&amp;#39;, not...">vm_lock_path</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>))
<a name="l07311"></a>07311       <span class="keywordflow">return</span> <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>;
<a name="l07312"></a>07312 
<a name="l07313"></a>07313    <span class="keywordflow">for</span> (x = 0; x &lt; vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>; x++) { 
<a name="l07314"></a>07314       <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] &amp;&amp; ((strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) &amp;&amp; strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;Urgent&quot;</span>)) || !vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] || (vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>)))) { 
<a name="l07315"></a>07315          <span class="comment">/* Save this message.  It&apos;s not in INBOX or hasn&apos;t been heard */</span> 
<a name="l07316"></a>07316          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x); 
<a name="l07317"></a>07317          <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, NULL)) 
<a name="l07318"></a>07318             <span class="keywordflow">break</span>;
<a name="l07319"></a>07319          vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++; 
<a name="l07320"></a>07320          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(fn2, <span class="keyword">sizeof</span>(fn2), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>); 
<a name="l07321"></a>07321          <span class="keywordflow">if</span> (strcmp(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, fn2)) { 
<a name="l07322"></a>07322             <a class="code" href="app__voicemail_8c.html#ac258dc9954bb3f9738fd55cdae23d38c">RENAME</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>,vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, fn2);
<a name="l07323"></a>07323          } 
<a name="l07324"></a>07324       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((!strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>) || !strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>, <span class="stringliteral">&quot;Urgent&quot;</span>)) &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>) &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x]) { 
<a name="l07325"></a>07325          <span class="comment">/* Move to old folder before deleting */</span> 
<a name="l07326"></a>07326          res = <a class="code" href="app__voicemail_8c.html#a1cec50a2281ad7263c1cf7959ed79632">save_to_folder</a>(vmu, vms, x, 1);
<a name="l07327"></a>07327          <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l07328"></a>07328             <span class="comment">/* If save failed do not delete the message */</span>
<a name="l07329"></a>07329             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Save failed.  Not moving message: %s.\n&quot;</span>, res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a> ? <span class="stringliteral">&quot;unable to lock path&quot;</span> : <span class="stringliteral">&quot;destination folder full&quot;</span>);
<a name="l07330"></a>07330             vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] = 0;
<a name="l07331"></a>07331             vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] = 0;
<a name="l07332"></a>07332             --x;
<a name="l07333"></a>07333          }
<a name="l07334"></a>07334       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] &amp;&amp; vmu-&gt;<a class="code" href="structast__vm__user.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a>) {
<a name="l07335"></a>07335          <span class="comment">/* Move to deleted folder */</span> 
<a name="l07336"></a>07336          res = <a class="code" href="app__voicemail_8c.html#a1cec50a2281ad7263c1cf7959ed79632">save_to_folder</a>(vmu, vms, x, 10);
<a name="l07337"></a>07337          <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l07338"></a>07338             <span class="comment">/* If save failed do not delete the message */</span>
<a name="l07339"></a>07339             vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] = 0;
<a name="l07340"></a>07340             vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[x] = 0;
<a name="l07341"></a>07341             --x;
<a name="l07342"></a>07342          }
<a name="l07343"></a>07343       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x] &amp;&amp; <a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>)) {
<a name="l07344"></a>07344          <span class="comment">/* If realtime storage enabled - we should explicitly delete this message,</span>
<a name="l07345"></a>07345 <span class="comment">         cause RENAME() will overwrite files, but will keep duplicate records in RT-storage */</span>
<a name="l07346"></a>07346          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x);
<a name="l07347"></a>07347          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, NULL))
<a name="l07348"></a>07348             <a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmu);
<a name="l07349"></a>07349       }
<a name="l07350"></a>07350    } 
<a name="l07351"></a>07351 
<a name="l07352"></a>07352    <span class="comment">/* Delete ALL remaining messages */</span>
<a name="l07353"></a>07353    nummsg = x - 1;
<a name="l07354"></a>07354    <span class="keywordflow">for</span> (x = vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1; x &lt;= nummsg; x++) {
<a name="l07355"></a>07355       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x);
<a name="l07356"></a>07356       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a0aef50eb58931d34f6a6d4ad18182d7c">EXISTS</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, NULL))
<a name="l07357"></a>07357          <a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmu);
<a name="l07358"></a>07358    }
<a name="l07359"></a>07359    <a class="code" href="app_8h.html#af6428878db94a4adf8136850e6a654f5" title="Unlock a path.">ast_unlock_path</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>);
<a name="l07360"></a>07360 <span class="preprocessor">#else</span>
<a name="l07361"></a>07361 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>) {
<a name="l07362"></a>07362       <span class="keywordflow">for</span> (x=0;x &lt; vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>;x++) { 
<a name="l07363"></a>07363          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[x]) { 
<a name="l07364"></a>07364             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3,<span class="stringliteral">&quot;IMAP delete of %d\n&quot;</span>,x);
<a name="l07365"></a>07365             <a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, x, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, vmu);
<a name="l07366"></a>07366          }
<a name="l07367"></a>07367       }
<a name="l07368"></a>07368    }
<a name="l07369"></a>07369 <span class="preprocessor">#endif</span>
<a name="l07370"></a>07370 <span class="preprocessor"></span>
<a name="l07371"></a>07371 done:
<a name="l07372"></a>07372    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>)
<a name="l07373"></a>07373       memset(vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>, 0, vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)); 
<a name="l07374"></a>07374    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>)
<a name="l07375"></a>07375       memset(vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>, 0, vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> * <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)); 
<a name="l07376"></a>07376 
<a name="l07377"></a>07377    <span class="keywordflow">return</span> 0;
<a name="l07378"></a>07378 }
<a name="l07379"></a>07379 
<a name="l07380"></a>07380 <span class="comment">/* In Greek even though we CAN use a syntax like &quot;friends messages&quot;</span>
<a name="l07381"></a>07381 <span class="comment"> * (&quot;filika mynhmata&quot;) it is not elegant. This also goes for &quot;work/family messages&quot;</span>
<a name="l07382"></a>07382 <span class="comment"> * (&quot;ergasiaka/oikogeniaka mynhmata&quot;). Therefore it is better to use a reversed </span>
<a name="l07383"></a>07383 <span class="comment"> * syntax for the above three categories which is more elegant. </span>
<a name="l07384"></a>07384 <span class="comment"> */</span>
<a name="l07385"></a>07385 
<a name="l07386"></a><a class="code" href="app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821">07386</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821">vm_play_folder_name_gr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)
<a name="l07387"></a>07387 {
<a name="l07388"></a>07388    <span class="keywordtype">int</span> cmd;
<a name="l07389"></a>07389    <span class="keywordtype">char</span> *buf;
<a name="l07390"></a>07390 
<a name="l07391"></a>07391    buf = alloca(strlen(box)+2); 
<a name="l07392"></a>07392    strcpy(buf, box);
<a name="l07393"></a>07393    strcat(buf,<span class="stringliteral">&quot;s&quot;</span>);
<a name="l07394"></a>07394 
<a name="l07395"></a>07395    <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Old&quot;</span>)){
<a name="l07396"></a>07396       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, buf); <span class="comment">/* &quot;NEA / PALIA&quot; */</span>
<a name="l07397"></a>07397       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages&quot; -&gt; &quot;MYNHMATA&quot; */</span>
<a name="l07398"></a>07398    } <span class="keywordflow">else</span> {
<a name="l07399"></a>07399       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages&quot; -&gt; &quot;MYNHMATA&quot; */</span>
<a name="l07400"></a>07400       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box); <span class="comment">/* friends/family/work... -&gt; &quot;FILWN&quot;/&quot;OIKOGENIAS&quot;/&quot;DOULEIAS&quot;*/</span>
<a name="l07401"></a>07401    }
<a name="l07402"></a>07402 }
<a name="l07403"></a>07403 
<a name="l07404"></a><a class="code" href="app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9">07404</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9">vm_play_folder_name_pl</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)
<a name="l07405"></a>07405 {
<a name="l07406"></a>07406    <span class="keywordtype">int</span> cmd;
<a name="l07407"></a>07407 
<a name="l07408"></a>07408    <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Old&quot;</span>)) {
<a name="l07409"></a>07409       <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-INBOX&quot;</span>))
<a name="l07410"></a>07410          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-e&quot;</span>);
<a name="l07411"></a>07411       <span class="keywordflow">else</span>
<a name="l07412"></a>07412          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-e&quot;</span>);
<a name="l07413"></a>07413       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07414"></a>07414    } <span class="keywordflow">else</span> {
<a name="l07415"></a>07415       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07416"></a>07416       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box);
<a name="l07417"></a>07417    }
<a name="l07418"></a>07418 }
<a name="l07419"></a>07419 
<a name="l07420"></a><a class="code" href="app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9">07420</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9">vm_play_folder_name_ua</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)
<a name="l07421"></a>07421 {
<a name="l07422"></a>07422    <span class="keywordtype">int</span> cmd;
<a name="l07423"></a>07423 
<a name="l07424"></a>07424    <span class="keywordflow">if</span> (!strcasecmp(box, <span class="stringliteral">&quot;vm-Family&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Friends&quot;</span>) || !strcasecmp(box, <span class="stringliteral">&quot;vm-Work&quot;</span>)){
<a name="l07425"></a>07425       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07426"></a>07426       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box);
<a name="l07427"></a>07427    } <span class="keywordflow">else</span> {
<a name="l07428"></a>07428       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box);
<a name="l07429"></a>07429       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07430"></a>07430    }
<a name="l07431"></a>07431 }
<a name="l07432"></a>07432 
<a name="l07433"></a><a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">07433</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *box)
<a name="l07434"></a>07434 {
<a name="l07435"></a>07435    <span class="keywordtype">int</span> cmd;
<a name="l07436"></a>07436 
<a name="l07437"></a>07437    <span class="keywordflow">if</span> (  !strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;it&quot;</span>, 2) ||
<a name="l07438"></a>07438         !strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;es&quot;</span>, 2) ||
<a name="l07439"></a>07439         !strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pt&quot;</span>, 2)) { <span class="comment">/* Italian, Spanish, or Portuguese syntax */</span>
<a name="l07440"></a>07440       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages */</span>
<a name="l07441"></a>07441       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box);
<a name="l07442"></a>07442    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;gr&quot;</span>, 2)) {
<a name="l07443"></a>07443       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a333bf47dfcf80161478d3d83a6c40821">vm_play_folder_name_gr</a>(chan, box);
<a name="l07444"></a>07444    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;he&quot;</span>, 2)) {  <span class="comment">/* Hebrew syntax */</span>
<a name="l07445"></a>07445       <span class="keywordflow">return</span> <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box);
<a name="l07446"></a>07446    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pl&quot;</span>, 2)) {
<a name="l07447"></a>07447       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#aabf07ec03610021ae7c6f07e486ae9d9">vm_play_folder_name_pl</a>(chan, box);
<a name="l07448"></a>07448    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;ua&quot;</span>, 2)) {  <span class="comment">/* Ukrainian syntax */</span>
<a name="l07449"></a>07449       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#ade4426f4085a7869e60fd75ac4fb52f9">vm_play_folder_name_ua</a>(chan, box);
<a name="l07450"></a>07450    } <span class="keywordflow">else</span> {  <span class="comment">/* Default English */</span>
<a name="l07451"></a>07451       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, box);
<a name="l07452"></a>07452       <span class="keywordflow">return</span> cmd ? cmd : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>); <span class="comment">/* &quot;messages */</span>
<a name="l07453"></a>07453    }
<a name="l07454"></a>07454 }
<a name="l07455"></a>07455 
<a name="l07456"></a>07456 <span class="comment">/* GREEK SYNTAX</span>
<a name="l07457"></a>07457 <span class="comment">   In greek the plural for old/new is</span>
<a name="l07458"></a>07458 <span class="comment">   different so we need the following files</span>
<a name="l07459"></a>07459 <span class="comment">   We also need vm-denExeteMynhmata because</span>
<a name="l07460"></a>07460 <span class="comment">   this syntax is different.</span>
<a name="l07461"></a>07461 <span class="comment"></span>
<a name="l07462"></a>07462 <span class="comment">   -&gt; vm-Olds.wav : &quot;Palia&quot;</span>
<a name="l07463"></a>07463 <span class="comment">   -&gt; vm-INBOXs.wav : &quot;Nea&quot;</span>
<a name="l07464"></a>07464 <span class="comment">   -&gt; vm-denExeteMynhmata : &quot;den exete mynhmata&quot;</span>
<a name="l07465"></a>07465 <span class="comment">*/</span>
<a name="l07466"></a>07466 
<a name="l07467"></a>07467 
<a name="l07468"></a><a class="code" href="app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c">07468</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c">vm_intro_gr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07469"></a>07469 {
<a name="l07470"></a>07470    <span class="keywordtype">int</span> res = 0;
<a name="l07471"></a>07471 
<a name="l07472"></a>07472    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07473"></a>07473       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07474"></a>07474       <span class="keywordflow">if</span> (!res) 
<a name="l07475"></a>07475          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, NULL);
<a name="l07476"></a>07476       <span class="keywordflow">if</span> (!res) {
<a name="l07477"></a>07477          <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)) {
<a name="l07478"></a>07478             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l07479"></a>07479             <span class="keywordflow">if</span> (!res)
<a name="l07480"></a>07480                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07481"></a>07481          } <span class="keywordflow">else</span> {
<a name="l07482"></a>07482             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);
<a name="l07483"></a>07483             <span class="keywordflow">if</span> (!res)
<a name="l07484"></a>07484                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07485"></a>07485          }
<a name="l07486"></a>07486       }
<a name="l07487"></a>07487    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>){
<a name="l07488"></a>07488       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07489"></a>07489       <span class="keywordflow">if</span> (!res)
<a name="l07490"></a>07490          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, NULL);
<a name="l07491"></a>07491       <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)){
<a name="l07492"></a>07492          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l07493"></a>07493          <span class="keywordflow">if</span> (!res)
<a name="l07494"></a>07494             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07495"></a>07495       } <span class="keywordflow">else</span> {
<a name="l07496"></a>07496          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);
<a name="l07497"></a>07497          <span class="keywordflow">if</span> (!res)
<a name="l07498"></a>07498             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07499"></a>07499       }
<a name="l07500"></a>07500    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) 
<a name="l07501"></a>07501       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-denExeteMynhmata&quot;</span>); 
<a name="l07502"></a>07502    <span class="keywordflow">return</span> res;
<a name="l07503"></a>07503 }
<a name="l07504"></a>07504 
<a name="l07505"></a>07505 <span class="comment">/* Version of vm_intro() designed to work for many languages.</span>
<a name="l07506"></a>07506 <span class="comment"> *</span>
<a name="l07507"></a>07507 <span class="comment"> * It is hoped that this function can prevent the proliferation of </span>
<a name="l07508"></a>07508 <span class="comment"> * language-specific vm_intro() functions and in time replace the language-</span>
<a name="l07509"></a>07509 <span class="comment"> * specific functions which already exist.  An examination of the language-</span>
<a name="l07510"></a>07510 <span class="comment"> * specific functions revealed that they all corrected the same deficiencies</span>
<a name="l07511"></a>07511 <span class="comment"> * in vm_intro_en() (which was the default function). Namely:</span>
<a name="l07512"></a>07512 <span class="comment"> *</span>
<a name="l07513"></a>07513 <span class="comment"> *  1) The vm-Old and vm-INBOX sound files were overloaded.  The English </span>
<a name="l07514"></a>07514 <span class="comment"> *     wording of the voicemail greeting hides this problem.  For example,</span>
<a name="l07515"></a>07515 <span class="comment"> *     vm-INBOX contains only the word &quot;new&quot;.  This means that both of these</span>
<a name="l07516"></a>07516 <span class="comment"> *     sequences produce valid utterances:</span>
<a name="l07517"></a>07517 <span class="comment"> *      * vm-youhave digit/1 vm-INBOX vm-message (you have one new message)</span>
<a name="l07518"></a>07518 <span class="comment"> *      * vm-press digit/1 vm-for vm-INBOX vm-messages (press 1 for new messages)</span>
<a name="l07519"></a>07519 <span class="comment"> *     However, if we rerecord vm-INBOX to say &quot;the new&quot; (which is unavoidable</span>
<a name="l07520"></a>07520 <span class="comment"> *     in many languages) the first utterance becomes &quot;you have 1 the new message&quot;.</span>
<a name="l07521"></a>07521 <span class="comment"> *  2) The function contains hardcoded rules for pluralizing the word &quot;message&quot;.</span>
<a name="l07522"></a>07522 <span class="comment"> *     These rules are correct for English, but not for many other languages.</span>
<a name="l07523"></a>07523 <span class="comment"> *  3) No attempt is made to pluralize the adjectives (&quot;old&quot; and &quot;new&quot;) as</span>
<a name="l07524"></a>07524 <span class="comment"> *     required in many languages.</span>
<a name="l07525"></a>07525 <span class="comment"> *  4) The gender of the word for &quot;message&quot; is not specified. This is a problem</span>
<a name="l07526"></a>07526 <span class="comment"> *     because in many languages the gender of the number in phrases such</span>
<a name="l07527"></a>07527 <span class="comment"> *     as &quot;you have one new message&quot; must match the gender of the word</span>
<a name="l07528"></a>07528 <span class="comment"> *     meaning &quot;message&quot;.</span>
<a name="l07529"></a>07529 <span class="comment"> *</span>
<a name="l07530"></a>07530 <span class="comment"> * Fixing these problems for each new language has meant duplication of effort.</span>
<a name="l07531"></a>07531 <span class="comment"> * This new function solves the problems in the following general ways:</span>
<a name="l07532"></a>07532 <span class="comment"> *  1) Add new sound files vm-new and vm-old.  These can be linked to vm-INBOX</span>
<a name="l07533"></a>07533 <span class="comment"> *     and vm-Old respectively for those languages where it makes sense.</span>
<a name="l07534"></a>07534 <span class="comment"> *  2) Call ast_say_counted_noun() to put the proper gender and number prefix</span>
<a name="l07535"></a>07535 <span class="comment"> *     on vm-message.</span>
<a name="l07536"></a>07536 <span class="comment"> *  3) Call ast_say_counted_adjective() to put the proper gender and number</span>
<a name="l07537"></a>07537 <span class="comment"> *     prefix on vm-new and vm-old (none for English).</span>
<a name="l07538"></a>07538 <span class="comment"> *  4) Pass the gender of the language&apos;s word for &quot;message&quot; as an agument to</span>
<a name="l07539"></a>07539 <span class="comment"> *     this function which is can in turn pass on to the functions which </span>
<a name="l07540"></a>07540 <span class="comment"> *     say numbers and put endings on nounds and adjectives.</span>
<a name="l07541"></a>07541 <span class="comment"> *</span>
<a name="l07542"></a>07542 <span class="comment"> * All languages require these messages:</span>
<a name="l07543"></a>07543 <span class="comment"> *  vm-youhave    &quot;You have...&quot;</span>
<a name="l07544"></a>07544 <span class="comment"> *  vm-and     &quot;and&quot;</span>
<a name="l07545"></a>07545 <span class="comment"> *  vm-no      &quot;no&quot; (in the sense of &quot;none&quot;, as in &quot;you have no messages&quot;)</span>
<a name="l07546"></a>07546 <span class="comment"> *</span>
<a name="l07547"></a>07547 <span class="comment"> * To use it for English, you will need these additional sound files:</span>
<a name="l07548"></a>07548 <span class="comment"> *  vm-new     &quot;new&quot;</span>
<a name="l07549"></a>07549 <span class="comment"> *  vm-message    &quot;message&quot;, singular</span>
<a name="l07550"></a>07550 <span class="comment"> *  vm-messages      &quot;messages&quot;, plural</span>
<a name="l07551"></a>07551 <span class="comment"> *</span>
<a name="l07552"></a>07552 <span class="comment"> * If you use it for Russian and other slavic languages, you will need these additional sound files:</span>
<a name="l07553"></a>07553 <span class="comment"> *</span>
<a name="l07554"></a>07554 <span class="comment"> *  vm-newn    &quot;novoye&quot; (singular, neuter)</span>
<a name="l07555"></a>07555 <span class="comment"> *  vm-newx    &quot;novikh&quot; (counting plural form, genative plural)</span>
<a name="l07556"></a>07556 <span class="comment"> *  vm-message    &quot;sobsheniye&quot; (singular form)</span>
<a name="l07557"></a>07557 <span class="comment"> *  vm-messagex1  &quot;sobsheniya&quot; (first counting plural form, genative singular)</span>
<a name="l07558"></a>07558 <span class="comment"> *  vm-messagex2  &quot;sobsheniy&quot; (second counting plural form, genative plural)</span>
<a name="l07559"></a>07559 <span class="comment"> *  digits/1n     &quot;odno&quot; (neuter singular for phrases such as &quot;one message&quot; or &quot;thirty one messages&quot;)</span>
<a name="l07560"></a>07560 <span class="comment"> *  digits/2n     &quot;dva&quot; (neuter singular)</span>
<a name="l07561"></a>07561 <span class="comment"> */</span>
<a name="l07562"></a><a class="code" href="app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">07562</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">const</span> <span class="keywordtype">char</span> message_gender[])
<a name="l07563"></a>07563 {
<a name="l07564"></a>07564    <span class="keywordtype">int</span> res;
<a name="l07565"></a>07565    <span class="keywordtype">int</span> lastnum = 0;
<a name="l07566"></a>07566 
<a name="l07567"></a>07567    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07568"></a>07568 
<a name="l07569"></a>07569    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07570"></a>07570       lastnum = vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>;
<a name="l07571"></a>07571 
<a name="l07572"></a>07572       <span class="keywordflow">if</span> (!(res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, lastnum, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, message_gender))) {
<a name="l07573"></a>07573          res = <a class="code" href="say_8h.html#ac3420184b387e73718d56aa73aa16b25">ast_say_counted_adjective</a>(chan, lastnum, <span class="stringliteral">&quot;vm-new&quot;</span>, message_gender);
<a name="l07574"></a>07574       }
<a name="l07575"></a>07575 
<a name="l07576"></a>07576       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07577"></a>07577          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07578"></a>07578       }
<a name="l07579"></a>07579    }
<a name="l07580"></a>07580 
<a name="l07581"></a>07581    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07582"></a>07582       lastnum = vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>;
<a name="l07583"></a>07583 
<a name="l07584"></a>07584       <span class="keywordflow">if</span> (!(res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, lastnum, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, message_gender))) {
<a name="l07585"></a>07585          res = <a class="code" href="say_8h.html#ac3420184b387e73718d56aa73aa16b25">ast_say_counted_adjective</a>(chan, lastnum, <span class="stringliteral">&quot;vm-old&quot;</span>, message_gender);
<a name="l07586"></a>07586       }
<a name="l07587"></a>07587    }
<a name="l07588"></a>07588 
<a name="l07589"></a>07589    <span class="keywordflow">if</span> (!res) {
<a name="l07590"></a>07590       <span class="keywordflow">if</span> (lastnum == 0) {
<a name="l07591"></a>07591          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l07592"></a>07592       }
<a name="l07593"></a>07593       <span class="keywordflow">if</span> (!res) {
<a name="l07594"></a>07594          res = <a class="code" href="say_8h.html#aa8c3ccdaf588396ad33b5028e79aa1c4">ast_say_counted_noun</a>(chan, lastnum, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07595"></a>07595       }
<a name="l07596"></a>07596    }
<a name="l07597"></a>07597 
<a name="l07598"></a>07598    <span class="keywordflow">return</span> res;
<a name="l07599"></a>07599 }
<a name="l07600"></a>07600 
<a name="l07601"></a>07601 <span class="comment">/* Default Hebrew syntax */</span>
<a name="l07602"></a><a class="code" href="app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c">07602</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c">vm_intro_he</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07603"></a>07603 {
<a name="l07604"></a>07604    <span class="keywordtype">int</span> res = 0;
<a name="l07605"></a>07605 
<a name="l07606"></a>07606    <span class="comment">/* Introduce messages they have */</span>
<a name="l07607"></a>07607    <span class="keywordflow">if</span> (!res) {
<a name="l07608"></a>07608       <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) || (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)) {
<a name="l07609"></a>07609          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07610"></a>07610       }
<a name="l07611"></a>07611       <span class="comment">/*</span>
<a name="l07612"></a>07612 <span class="comment">       * The word &quot;shtei&quot; refers to the number 2 in hebrew when performing a count</span>
<a name="l07613"></a>07613 <span class="comment">       * of elements. In Hebrew, there are 6 forms of enumerating the number 2 for</span>
<a name="l07614"></a>07614 <span class="comment">       * an element, this is one of them.</span>
<a name="l07615"></a>07615 <span class="comment">       */</span>
<a name="l07616"></a>07616       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07617"></a>07617          <span class="keywordflow">if</span> (!res) {
<a name="l07618"></a>07618             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {
<a name="l07619"></a>07619                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX1&quot;</span>);
<a name="l07620"></a>07620             } <span class="keywordflow">else</span> {
<a name="l07621"></a>07621                <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 2) {
<a name="l07622"></a>07622                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-shtei&quot;</span>);
<a name="l07623"></a>07623                } <span class="keywordflow">else</span> {
<a name="l07624"></a>07624                   res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l07625"></a>07625                }
<a name="l07626"></a>07626                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l07627"></a>07627             }
<a name="l07628"></a>07628          }
<a name="l07629"></a>07629          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res) {
<a name="l07630"></a>07630             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07631"></a>07631             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l07632"></a>07632                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old1&quot;</span>);
<a name="l07633"></a>07633             } <span class="keywordflow">else</span> {
<a name="l07634"></a>07634                <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 2) {
<a name="l07635"></a>07635                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-shtei&quot;</span>);
<a name="l07636"></a>07636                } <span class="keywordflow">else</span> {
<a name="l07637"></a>07637                   res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l07638"></a>07638                }
<a name="l07639"></a>07639                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l07640"></a>07640             }
<a name="l07641"></a>07641          }
<a name="l07642"></a>07642       }
<a name="l07643"></a>07643       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07644"></a>07644          <span class="keywordflow">if</span> (!res) {
<a name="l07645"></a>07645             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l07646"></a>07646                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old1&quot;</span>);
<a name="l07647"></a>07647             } <span class="keywordflow">else</span> {
<a name="l07648"></a>07648                <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 2) {
<a name="l07649"></a>07649                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-shtei&quot;</span>);
<a name="l07650"></a>07650                } <span class="keywordflow">else</span> {
<a name="l07651"></a>07651                   res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);            
<a name="l07652"></a>07652                }
<a name="l07653"></a>07653                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l07654"></a>07654             }
<a name="l07655"></a>07655          }
<a name="l07656"></a>07656       }
<a name="l07657"></a>07657       <span class="keywordflow">if</span> (!res) {
<a name="l07658"></a>07658          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07659"></a>07659             <span class="keywordflow">if</span> (!res) {
<a name="l07660"></a>07660                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomessages&quot;</span>);
<a name="l07661"></a>07661             }
<a name="l07662"></a>07662          }
<a name="l07663"></a>07663       }
<a name="l07664"></a>07664    }
<a name="l07665"></a>07665    <span class="keywordflow">return</span> res;
<a name="l07666"></a>07666 }
<a name="l07667"></a>07667    
<a name="l07668"></a>07668 <span class="comment">/* Default English syntax */</span>
<a name="l07669"></a><a class="code" href="app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f">07669</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f">vm_intro_en</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07670"></a>07670 {
<a name="l07671"></a>07671    <span class="keywordtype">int</span> res;
<a name="l07672"></a>07672 
<a name="l07673"></a>07673    <span class="comment">/* Introduce messages they have */</span>
<a name="l07674"></a>07674    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07675"></a>07675    <span class="keywordflow">if</span> (!res) {
<a name="l07676"></a>07676       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l07677"></a>07677          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>, chan-&gt;language);
<a name="l07678"></a>07678          <span class="keywordflow">if</span> (!res)
<a name="l07679"></a>07679             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Urgent&quot;</span>);
<a name="l07680"></a>07680          <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> || vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &amp;&amp; !res) {
<a name="l07681"></a>07681             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07682"></a>07682          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l07683"></a>07683             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> == 1))
<a name="l07684"></a>07684                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07685"></a>07685             <span class="keywordflow">else</span>
<a name="l07686"></a>07686                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07687"></a>07687          }
<a name="l07688"></a>07688       }
<a name="l07689"></a>07689       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07690"></a>07690          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07691"></a>07691          <span class="keywordflow">if</span> (!res)
<a name="l07692"></a>07692             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l07693"></a>07693          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l07694"></a>07694             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07695"></a>07695          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l07696"></a>07696             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l07697"></a>07697                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07698"></a>07698             <span class="keywordflow">else</span>
<a name="l07699"></a>07699                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07700"></a>07700          }
<a name="l07701"></a>07701             
<a name="l07702"></a>07702       }
<a name="l07703"></a>07703       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07704"></a>07704          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l07705"></a>07705          <span class="keywordflow">if</span> (!res)
<a name="l07706"></a>07706             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l07707"></a>07707          <span class="keywordflow">if</span> (!res) {
<a name="l07708"></a>07708             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)
<a name="l07709"></a>07709                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07710"></a>07710             <span class="keywordflow">else</span>
<a name="l07711"></a>07711                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07712"></a>07712          }
<a name="l07713"></a>07713       }
<a name="l07714"></a>07714       <span class="keywordflow">if</span> (!res) {
<a name="l07715"></a>07715          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07716"></a>07716             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l07717"></a>07717             <span class="keywordflow">if</span> (!res)
<a name="l07718"></a>07718                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07719"></a>07719          }
<a name="l07720"></a>07720       }
<a name="l07721"></a>07721    }
<a name="l07722"></a>07722    <span class="keywordflow">return</span> res;
<a name="l07723"></a>07723 }
<a name="l07724"></a>07724 
<a name="l07725"></a>07725 <span class="comment">/* ITALIAN syntax */</span>
<a name="l07726"></a><a class="code" href="app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c">07726</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c">vm_intro_it</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07727"></a>07727 {
<a name="l07728"></a>07728    <span class="comment">/* Introduce messages they have */</span>
<a name="l07729"></a>07729    <span class="keywordtype">int</span> res;
<a name="l07730"></a>07730    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp;!vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>)
<a name="l07731"></a>07731       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>) ||
<a name="l07732"></a>07732          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07733"></a>07733    <span class="keywordflow">else</span>
<a name="l07734"></a>07734       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07735"></a>07735    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07736"></a>07736       res = (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) ?
<a name="l07737"></a>07737          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/un&quot;</span>) ||
<a name="l07738"></a>07738          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nuovo&quot;</span>) ||
<a name="l07739"></a>07739          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>) :
<a name="l07740"></a>07740          <span class="comment">/* 2 or more new messages */</span>
<a name="l07741"></a>07741          <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language) ||
<a name="l07742"></a>07742          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nuovi&quot;</span>) ||
<a name="l07743"></a>07743          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07744"></a>07744       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)
<a name="l07745"></a>07745          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07746"></a>07746    }
<a name="l07747"></a>07747    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07748"></a>07748       res = (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) ?
<a name="l07749"></a>07749          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/un&quot;</span>) ||
<a name="l07750"></a>07750          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-vecchio&quot;</span>) ||
<a name="l07751"></a>07751          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>) :
<a name="l07752"></a>07752          <span class="comment">/* 2 or more old messages */</span>
<a name="l07753"></a>07753          <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language) ||
<a name="l07754"></a>07754          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-vecchi&quot;</span>) ||
<a name="l07755"></a>07755          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07756"></a>07756    }
<a name="l07757"></a>07757    <span class="keywordflow">return</span> res;
<a name="l07758"></a>07758 }
<a name="l07759"></a>07759 
<a name="l07760"></a>07760 <span class="comment">/* POLISH syntax */</span>
<a name="l07761"></a><a class="code" href="app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7">07761</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7">vm_intro_pl</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07762"></a>07762 {
<a name="l07763"></a>07763    <span class="comment">/* Introduce messages they have */</span>
<a name="l07764"></a>07764    <span class="keywordtype">int</span> res;
<a name="l07765"></a>07765    div_t <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l07766"></a>07766 
<a name="l07767"></a>07767    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07768"></a>07768       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l07769"></a>07769       res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07770"></a>07770       <span class="keywordflow">return</span> res;
<a name="l07771"></a>07771    } <span class="keywordflow">else</span> {
<a name="l07772"></a>07772       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07773"></a>07773    }
<a name="l07774"></a>07774 
<a name="l07775"></a>07775    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07776"></a>07776       num = div(vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, 10);
<a name="l07777"></a>07777       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {
<a name="l07778"></a>07778          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1-a&quot;</span>);
<a name="l07779"></a>07779          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-a&quot;</span>);
<a name="l07780"></a>07780          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07781"></a>07781       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {
<a name="l07782"></a>07782          <span class="keywordflow">if</span> (num.rem == 2) {
<a name="l07783"></a>07783             <span class="keywordflow">if</span> (!num.quot) {
<a name="l07784"></a>07784                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);
<a name="l07785"></a>07785             } <span class="keywordflow">else</span> {
<a name="l07786"></a>07786                res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> - 2 , chan-&gt;language);
<a name="l07787"></a>07787                res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);
<a name="l07788"></a>07788             }
<a name="l07789"></a>07789          } <span class="keywordflow">else</span> {
<a name="l07790"></a>07790             res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07791"></a>07791          }
<a name="l07792"></a>07792          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-e&quot;</span>);
<a name="l07793"></a>07793          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07794"></a>07794       } <span class="keywordflow">else</span> {
<a name="l07795"></a>07795          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07796"></a>07796          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-new-ych&quot;</span>);
<a name="l07797"></a>07797          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07798"></a>07798       }
<a name="l07799"></a>07799       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)
<a name="l07800"></a>07800          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07801"></a>07801    }
<a name="l07802"></a>07802    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07803"></a>07803       num = div(vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, 10);
<a name="l07804"></a>07804       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l07805"></a>07805          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1-a&quot;</span>);
<a name="l07806"></a>07806          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-a&quot;</span>);
<a name="l07807"></a>07807          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07808"></a>07808       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (num.rem &gt; 1 &amp;&amp; num.rem &lt; 5 &amp;&amp; num.quot != 1) {
<a name="l07809"></a>07809          <span class="keywordflow">if</span> (num.rem == 2) {
<a name="l07810"></a>07810             <span class="keywordflow">if</span> (!num.quot) {
<a name="l07811"></a>07811                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);
<a name="l07812"></a>07812             } <span class="keywordflow">else</span> {
<a name="l07813"></a>07813                res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> - 2 , chan-&gt;language);
<a name="l07814"></a>07814                res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/2-ie&quot;</span>);
<a name="l07815"></a>07815             }
<a name="l07816"></a>07816          } <span class="keywordflow">else</span> {
<a name="l07817"></a>07817             res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l07818"></a>07818          }
<a name="l07819"></a>07819          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-e&quot;</span>);
<a name="l07820"></a>07820          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07821"></a>07821       } <span class="keywordflow">else</span> {
<a name="l07822"></a>07822          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l07823"></a>07823          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-old-ych&quot;</span>);
<a name="l07824"></a>07824          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07825"></a>07825       }
<a name="l07826"></a>07826    }
<a name="l07827"></a>07827 
<a name="l07828"></a>07828    <span class="keywordflow">return</span> res;
<a name="l07829"></a>07829 }
<a name="l07830"></a>07830 
<a name="l07831"></a>07831 <span class="comment">/* SWEDISH syntax */</span>
<a name="l07832"></a><a class="code" href="app__voicemail_8c.html#af54b6b5388c2838875f222a795850409">07832</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#af54b6b5388c2838875f222a795850409">vm_intro_se</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07833"></a>07833 {
<a name="l07834"></a>07834    <span class="comment">/* Introduce messages they have */</span>
<a name="l07835"></a>07835    <span class="keywordtype">int</span> res;
<a name="l07836"></a>07836 
<a name="l07837"></a>07837    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07838"></a>07838    <span class="keywordflow">if</span> (res)
<a name="l07839"></a>07839       <span class="keywordflow">return</span> res;
<a name="l07840"></a>07840 
<a name="l07841"></a>07841    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l07842"></a>07842       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l07843"></a>07843       res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07844"></a>07844       <span class="keywordflow">return</span> res;
<a name="l07845"></a>07845    }
<a name="l07846"></a>07846 
<a name="l07847"></a>07847    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07848"></a>07848       <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)) {
<a name="l07849"></a>07849          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/ett&quot;</span>);
<a name="l07850"></a>07850          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nytt&quot;</span>);
<a name="l07851"></a>07851          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07852"></a>07852       } <span class="keywordflow">else</span> {
<a name="l07853"></a>07853          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07854"></a>07854          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nya&quot;</span>);
<a name="l07855"></a>07855          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07856"></a>07856       }
<a name="l07857"></a>07857       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)
<a name="l07858"></a>07858          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07859"></a>07859    }
<a name="l07860"></a>07860    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07861"></a>07861       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l07862"></a>07862          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/ett&quot;</span>);
<a name="l07863"></a>07863          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gammalt&quot;</span>);
<a name="l07864"></a>07864          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07865"></a>07865       } <span class="keywordflow">else</span> {
<a name="l07866"></a>07866          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l07867"></a>07867          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gamla&quot;</span>);
<a name="l07868"></a>07868          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07869"></a>07869       }
<a name="l07870"></a>07870    }
<a name="l07871"></a>07871 
<a name="l07872"></a>07872    <span class="keywordflow">return</span> res;
<a name="l07873"></a>07873 }
<a name="l07874"></a>07874 
<a name="l07875"></a>07875 <span class="comment">/* NORWEGIAN syntax */</span>
<a name="l07876"></a><a class="code" href="app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8">07876</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8">vm_intro_no</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07877"></a>07877 {
<a name="l07878"></a>07878    <span class="comment">/* Introduce messages they have */</span>
<a name="l07879"></a>07879    <span class="keywordtype">int</span> res;
<a name="l07880"></a>07880 
<a name="l07881"></a>07881    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07882"></a>07882    <span class="keywordflow">if</span> (res)
<a name="l07883"></a>07883       <span class="keywordflow">return</span> res;
<a name="l07884"></a>07884 
<a name="l07885"></a>07885    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l07886"></a>07886       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l07887"></a>07887       res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07888"></a>07888       <span class="keywordflow">return</span> res;
<a name="l07889"></a>07889    }
<a name="l07890"></a>07890 
<a name="l07891"></a>07891    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07892"></a>07892       <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)) {
<a name="l07893"></a>07893          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);
<a name="l07894"></a>07894          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-ny&quot;</span>);
<a name="l07895"></a>07895          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07896"></a>07896       } <span class="keywordflow">else</span> {
<a name="l07897"></a>07897          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07898"></a>07898          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nye&quot;</span>);
<a name="l07899"></a>07899          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07900"></a>07900       }
<a name="l07901"></a>07901       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>)
<a name="l07902"></a>07902          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07903"></a>07903    }
<a name="l07904"></a>07904    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07905"></a>07905       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l07906"></a>07906          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);
<a name="l07907"></a>07907          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gamel&quot;</span>);
<a name="l07908"></a>07908          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07909"></a>07909       } <span class="keywordflow">else</span> {
<a name="l07910"></a>07910          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l07911"></a>07911          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-gamle&quot;</span>);
<a name="l07912"></a>07912          res = res ? res : <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07913"></a>07913       }
<a name="l07914"></a>07914    }
<a name="l07915"></a>07915 
<a name="l07916"></a>07916    <span class="keywordflow">return</span> res;
<a name="l07917"></a>07917 }
<a name="l07918"></a>07918 
<a name="l07919"></a>07919 <span class="comment">/* GERMAN syntax */</span>
<a name="l07920"></a><a class="code" href="app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a">07920</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a">vm_intro_de</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07921"></a>07921 {
<a name="l07922"></a>07922    <span class="comment">/* Introduce messages they have */</span>
<a name="l07923"></a>07923    <span class="keywordtype">int</span> res;
<a name="l07924"></a>07924    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07925"></a>07925    <span class="keywordflow">if</span> (!res) {
<a name="l07926"></a>07926       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07927"></a>07927          <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l07928"></a>07928             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1F&quot;</span>);
<a name="l07929"></a>07929          <span class="keywordflow">else</span>
<a name="l07930"></a>07930             res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07931"></a>07931          <span class="keywordflow">if</span> (!res)
<a name="l07932"></a>07932             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l07933"></a>07933          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l07934"></a>07934             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07935"></a>07935          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l07936"></a>07936             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l07937"></a>07937                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07938"></a>07938             <span class="keywordflow">else</span>
<a name="l07939"></a>07939                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07940"></a>07940          }
<a name="l07941"></a>07941             
<a name="l07942"></a>07942       }
<a name="l07943"></a>07943       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l07944"></a>07944          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)
<a name="l07945"></a>07945             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1F&quot;</span>);
<a name="l07946"></a>07946          <span class="keywordflow">else</span>
<a name="l07947"></a>07947             res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l07948"></a>07948          <span class="keywordflow">if</span> (!res)
<a name="l07949"></a>07949             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l07950"></a>07950          <span class="keywordflow">if</span> (!res) {
<a name="l07951"></a>07951             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)
<a name="l07952"></a>07952                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07953"></a>07953             <span class="keywordflow">else</span>
<a name="l07954"></a>07954                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07955"></a>07955          }
<a name="l07956"></a>07956       }
<a name="l07957"></a>07957       <span class="keywordflow">if</span> (!res) {
<a name="l07958"></a>07958          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l07959"></a>07959             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l07960"></a>07960             <span class="keywordflow">if</span> (!res)
<a name="l07961"></a>07961                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07962"></a>07962          }
<a name="l07963"></a>07963       }
<a name="l07964"></a>07964    }
<a name="l07965"></a>07965    <span class="keywordflow">return</span> res;
<a name="l07966"></a>07966 }
<a name="l07967"></a>07967 
<a name="l07968"></a>07968 <span class="comment">/* SPANISH syntax */</span>
<a name="l07969"></a><a class="code" href="app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae">07969</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae">vm_intro_es</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l07970"></a>07970 {
<a name="l07971"></a>07971    <span class="comment">/* Introduce messages they have */</span>
<a name="l07972"></a>07972    <span class="keywordtype">int</span> res;
<a name="l07973"></a>07973    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l07974"></a>07974       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhaveno&quot;</span>);
<a name="l07975"></a>07975       <span class="keywordflow">if</span> (!res)
<a name="l07976"></a>07976          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07977"></a>07977    } <span class="keywordflow">else</span> {
<a name="l07978"></a>07978       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l07979"></a>07979    }
<a name="l07980"></a>07980    <span class="keywordflow">if</span> (!res) {
<a name="l07981"></a>07981       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l07982"></a>07982          <span class="keywordflow">if</span> (!res) {
<a name="l07983"></a>07983             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)) {
<a name="l07984"></a>07984                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1M&quot;</span>);
<a name="l07985"></a>07985                <span class="keywordflow">if</span> (!res)
<a name="l07986"></a>07986                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l07987"></a>07987                <span class="keywordflow">if</span> (!res)
<a name="l07988"></a>07988                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);
<a name="l07989"></a>07989             } <span class="keywordflow">else</span> {
<a name="l07990"></a>07990                res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l07991"></a>07991                <span class="keywordflow">if</span> (!res)
<a name="l07992"></a>07992                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l07993"></a>07993                <span class="keywordflow">if</span> (!res)
<a name="l07994"></a>07994                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l07995"></a>07995             }
<a name="l07996"></a>07996          }
<a name="l07997"></a>07997          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l07998"></a>07998             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l07999"></a>07999       }
<a name="l08000"></a>08000       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08001"></a>08001          <span class="keywordflow">if</span> (!res) {
<a name="l08002"></a>08002             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l08003"></a>08003                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1M&quot;</span>);
<a name="l08004"></a>08004                <span class="keywordflow">if</span> (!res)
<a name="l08005"></a>08005                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08006"></a>08006                <span class="keywordflow">if</span> (!res)
<a name="l08007"></a>08007                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);
<a name="l08008"></a>08008             } <span class="keywordflow">else</span> {
<a name="l08009"></a>08009                res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l08010"></a>08010                <span class="keywordflow">if</span> (!res)
<a name="l08011"></a>08011                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08012"></a>08012                <span class="keywordflow">if</span> (!res)
<a name="l08013"></a>08013                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l08014"></a>08014             }
<a name="l08015"></a>08015          }
<a name="l08016"></a>08016       }
<a name="l08017"></a>08017    }
<a name="l08018"></a>08018 <span class="keywordflow">return</span> res;
<a name="l08019"></a>08019 }
<a name="l08020"></a>08020 
<a name="l08021"></a>08021 <span class="comment">/* BRAZILIAN PORTUGUESE syntax */</span>
<a name="l08022"></a><a class="code" href="app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">08022</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">vm_intro_pt_BR</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms) {
<a name="l08023"></a>08023    <span class="comment">/* Introduce messages they have */</span>
<a name="l08024"></a>08024    <span class="keywordtype">int</span> res;
<a name="l08025"></a>08025    <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l08026"></a>08026       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomessages&quot;</span>);
<a name="l08027"></a>08027       <span class="keywordflow">return</span> res;
<a name="l08028"></a>08028    } <span class="keywordflow">else</span> {
<a name="l08029"></a>08029       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l08030"></a>08030    }
<a name="l08031"></a>08031    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08032"></a>08032       <span class="keywordflow">if</span> (!res)
<a name="l08033"></a>08033          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l08034"></a>08034       <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)) {
<a name="l08035"></a>08035          <span class="keywordflow">if</span> (!res)
<a name="l08036"></a>08036             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08037"></a>08037          <span class="keywordflow">if</span> (!res)
<a name="l08038"></a>08038             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);
<a name="l08039"></a>08039       } <span class="keywordflow">else</span> {
<a name="l08040"></a>08040          <span class="keywordflow">if</span> (!res)
<a name="l08041"></a>08041             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08042"></a>08042          <span class="keywordflow">if</span> (!res)
<a name="l08043"></a>08043             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l08044"></a>08044       }
<a name="l08045"></a>08045       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l08046"></a>08046          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l08047"></a>08047    }
<a name="l08048"></a>08048    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08049"></a>08049       <span class="keywordflow">if</span> (!res)
<a name="l08050"></a>08050          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l08051"></a>08051       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l08052"></a>08052          <span class="keywordflow">if</span> (!res)
<a name="l08053"></a>08053             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08054"></a>08054          <span class="keywordflow">if</span> (!res)
<a name="l08055"></a>08055             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);
<a name="l08056"></a>08056       } <span class="keywordflow">else</span> {
<a name="l08057"></a>08057          <span class="keywordflow">if</span> (!res)
<a name="l08058"></a>08058             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08059"></a>08059          <span class="keywordflow">if</span> (!res)
<a name="l08060"></a>08060             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l08061"></a>08061       }
<a name="l08062"></a>08062    }
<a name="l08063"></a>08063    <span class="keywordflow">return</span> res;
<a name="l08064"></a>08064 }
<a name="l08065"></a>08065 
<a name="l08066"></a>08066 <span class="comment">/* FRENCH syntax */</span>
<a name="l08067"></a><a class="code" href="app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">08067</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">vm_intro_fr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l08068"></a>08068 {
<a name="l08069"></a>08069    <span class="comment">/* Introduce messages they have */</span>
<a name="l08070"></a>08070    <span class="keywordtype">int</span> res;
<a name="l08071"></a>08071    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l08072"></a>08072    <span class="keywordflow">if</span> (!res) {
<a name="l08073"></a>08073       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08074"></a>08074          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l08075"></a>08075          <span class="keywordflow">if</span> (!res)
<a name="l08076"></a>08076             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l08077"></a>08077          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l08078"></a>08078             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l08079"></a>08079          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l08080"></a>08080             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l08081"></a>08081                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08082"></a>08082             <span class="keywordflow">else</span>
<a name="l08083"></a>08083                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08084"></a>08084          }
<a name="l08085"></a>08085             
<a name="l08086"></a>08086       }
<a name="l08087"></a>08087       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08088"></a>08088          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l08089"></a>08089          <span class="keywordflow">if</span> (!res)
<a name="l08090"></a>08090             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l08091"></a>08091          <span class="keywordflow">if</span> (!res) {
<a name="l08092"></a>08092             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)
<a name="l08093"></a>08093                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08094"></a>08094             <span class="keywordflow">else</span>
<a name="l08095"></a>08095                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08096"></a>08096          }
<a name="l08097"></a>08097       }
<a name="l08098"></a>08098       <span class="keywordflow">if</span> (!res) {
<a name="l08099"></a>08099          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l08100"></a>08100             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08101"></a>08101             <span class="keywordflow">if</span> (!res)
<a name="l08102"></a>08102                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08103"></a>08103          }
<a name="l08104"></a>08104       }
<a name="l08105"></a>08105    }
<a name="l08106"></a>08106    <span class="keywordflow">return</span> res;
<a name="l08107"></a>08107 }
<a name="l08108"></a>08108 
<a name="l08109"></a>08109 <span class="comment">/* DUTCH syntax */</span>
<a name="l08110"></a><a class="code" href="app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">08110</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">vm_intro_nl</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l08111"></a>08111 {
<a name="l08112"></a>08112    <span class="comment">/* Introduce messages they have */</span>
<a name="l08113"></a>08113    <span class="keywordtype">int</span> res;
<a name="l08114"></a>08114    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l08115"></a>08115    <span class="keywordflow">if</span> (!res) {
<a name="l08116"></a>08116       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08117"></a>08117          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l08118"></a>08118          <span class="keywordflow">if</span> (!res) {
<a name="l08119"></a>08119             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)
<a name="l08120"></a>08120                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);
<a name="l08121"></a>08121             <span class="keywordflow">else</span>
<a name="l08122"></a>08122                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l08123"></a>08123          }
<a name="l08124"></a>08124          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l08125"></a>08125             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l08126"></a>08126          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l08127"></a>08127             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l08128"></a>08128                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08129"></a>08129             <span class="keywordflow">else</span>
<a name="l08130"></a>08130                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08131"></a>08131          }
<a name="l08132"></a>08132             
<a name="l08133"></a>08133       }
<a name="l08134"></a>08134       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08135"></a>08135          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l08136"></a>08136          <span class="keywordflow">if</span> (!res) {
<a name="l08137"></a>08137             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)
<a name="l08138"></a>08138                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);
<a name="l08139"></a>08139             <span class="keywordflow">else</span>
<a name="l08140"></a>08140                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l08141"></a>08141          }
<a name="l08142"></a>08142          <span class="keywordflow">if</span> (!res) {
<a name="l08143"></a>08143             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1)
<a name="l08144"></a>08144                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08145"></a>08145             <span class="keywordflow">else</span>
<a name="l08146"></a>08146                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08147"></a>08147          }
<a name="l08148"></a>08148       }
<a name="l08149"></a>08149       <span class="keywordflow">if</span> (!res) {
<a name="l08150"></a>08150          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l08151"></a>08151             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08152"></a>08152             <span class="keywordflow">if</span> (!res)
<a name="l08153"></a>08153                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08154"></a>08154          }
<a name="l08155"></a>08155       }
<a name="l08156"></a>08156    }
<a name="l08157"></a>08157    <span class="keywordflow">return</span> res;
<a name="l08158"></a>08158 }
<a name="l08159"></a>08159 
<a name="l08160"></a>08160 <span class="comment">/* PORTUGUESE syntax */</span>
<a name="l08161"></a><a class="code" href="app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">08161</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">vm_intro_pt</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan,<span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l08162"></a>08162 {
<a name="l08163"></a>08163    <span class="comment">/* Introduce messages they have */</span>
<a name="l08164"></a>08164    <span class="keywordtype">int</span> res;
<a name="l08165"></a>08165    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l08166"></a>08166    <span class="keywordflow">if</span> (!res) {
<a name="l08167"></a>08167       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08168"></a>08168          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l08169"></a>08169          <span class="keywordflow">if</span> (!res) {
<a name="l08170"></a>08170             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1)) {
<a name="l08171"></a>08171                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08172"></a>08172                <span class="keywordflow">if</span> (!res)
<a name="l08173"></a>08173                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOXs&quot;</span>);
<a name="l08174"></a>08174             } <span class="keywordflow">else</span> {
<a name="l08175"></a>08175                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08176"></a>08176                <span class="keywordflow">if</span> (!res)
<a name="l08177"></a>08177                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l08178"></a>08178             }
<a name="l08179"></a>08179          }
<a name="l08180"></a>08180          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l08181"></a>08181             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l08182"></a>08182       }
<a name="l08183"></a>08183       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08184"></a>08184          res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, <span class="stringliteral">&quot;f&quot;</span>);
<a name="l08185"></a>08185          <span class="keywordflow">if</span> (!res) {
<a name="l08186"></a>08186             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1) {
<a name="l08187"></a>08187                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08188"></a>08188                <span class="keywordflow">if</span> (!res)
<a name="l08189"></a>08189                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Olds&quot;</span>);
<a name="l08190"></a>08190             } <span class="keywordflow">else</span> {
<a name="l08191"></a>08191                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08192"></a>08192                <span class="keywordflow">if</span> (!res)
<a name="l08193"></a>08193                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l08194"></a>08194             }
<a name="l08195"></a>08195          }
<a name="l08196"></a>08196       }
<a name="l08197"></a>08197       <span class="keywordflow">if</span> (!res) {
<a name="l08198"></a>08198          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l08199"></a>08199             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08200"></a>08200             <span class="keywordflow">if</span> (!res)
<a name="l08201"></a>08201                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08202"></a>08202          }
<a name="l08203"></a>08203       }
<a name="l08204"></a>08204    }
<a name="l08205"></a>08205    <span class="keywordflow">return</span> res;
<a name="l08206"></a>08206 }
<a name="l08207"></a>08207 
<a name="l08208"></a>08208 
<a name="l08209"></a>08209 <span class="comment">/* CZECH syntax */</span>
<a name="l08210"></a>08210 <span class="comment">/* in czech there must be declension of word new and message</span>
<a name="l08211"></a>08211 <span class="comment"> * czech        : english        : czech      : english</span>
<a name="l08212"></a>08212 <span class="comment"> * --------------------------------------------------------</span>
<a name="l08213"></a>08213 <span class="comment"> * vm-youhave   : you have </span>
<a name="l08214"></a>08214 <span class="comment"> * vm-novou     : one new        : vm-zpravu  : message</span>
<a name="l08215"></a>08215 <span class="comment"> * vm-nove      : 2-4 new        : vm-zpravy  : messages</span>
<a name="l08216"></a>08216 <span class="comment"> * vm-novych    : 5-infinite new : vm-zprav   : messages</span>
<a name="l08217"></a>08217 <span class="comment"> * vm-starou   : one old</span>
<a name="l08218"></a>08218 <span class="comment"> * vm-stare     : 2-4 old </span>
<a name="l08219"></a>08219 <span class="comment"> * vm-starych   : 5-infinite old</span>
<a name="l08220"></a>08220 <span class="comment"> * jednu        : one   - falling 4. </span>
<a name="l08221"></a>08221 <span class="comment"> * vm-no        : no  ( no messages )</span>
<a name="l08222"></a>08222 <span class="comment"> */</span>
<a name="l08223"></a>08223 
<a name="l08224"></a><a class="code" href="app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">08224</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l08225"></a>08225 {
<a name="l08226"></a>08226    <span class="keywordtype">int</span> res;
<a name="l08227"></a>08227    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l08228"></a>08228    <span class="keywordflow">if</span> (!res) {
<a name="l08229"></a>08229       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08230"></a>08230          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1) {
<a name="l08231"></a>08231             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/jednu&quot;</span>);
<a name="l08232"></a>08232          } <span class="keywordflow">else</span> {
<a name="l08233"></a>08233             res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l08234"></a>08234          }
<a name="l08235"></a>08235          <span class="keywordflow">if</span> (!res) {
<a name="l08236"></a>08236             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l08237"></a>08237                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-novou&quot;</span>);
<a name="l08238"></a>08238             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &lt; 5))
<a name="l08239"></a>08239                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nove&quot;</span>);
<a name="l08240"></a>08240             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 4)
<a name="l08241"></a>08241                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-novych&quot;</span>);
<a name="l08242"></a>08242          }
<a name="l08243"></a>08243          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l08244"></a>08244             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l08245"></a>08245          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) {
<a name="l08246"></a>08246             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> == 1))
<a name="l08247"></a>08247                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravu&quot;</span>);
<a name="l08248"></a>08248             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &lt; 5))
<a name="l08249"></a>08249                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravy&quot;</span>);
<a name="l08250"></a>08250             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 4)
<a name="l08251"></a>08251                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zprav&quot;</span>);
<a name="l08252"></a>08252          }
<a name="l08253"></a>08253       }
<a name="l08254"></a>08254       <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08255"></a>08255          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l08256"></a>08256          <span class="keywordflow">if</span> (!res) {
<a name="l08257"></a>08257             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1))
<a name="l08258"></a>08258                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starou&quot;</span>);
<a name="l08259"></a>08259             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &lt; 5))
<a name="l08260"></a>08260                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-stare&quot;</span>);
<a name="l08261"></a>08261             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &gt; 4)
<a name="l08262"></a>08262                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starych&quot;</span>);
<a name="l08263"></a>08263          }
<a name="l08264"></a>08264          <span class="keywordflow">if</span> (!res) {
<a name="l08265"></a>08265             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> == 1))
<a name="l08266"></a>08266                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravu&quot;</span>);
<a name="l08267"></a>08267             <span class="keywordflow">if</span> ((vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) &gt; 1 &amp;&amp; (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &lt; 5))
<a name="l08268"></a>08268                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravy&quot;</span>);
<a name="l08269"></a>08269             <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &gt; 4)
<a name="l08270"></a>08270                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zprav&quot;</span>);
<a name="l08271"></a>08271          }
<a name="l08272"></a>08272       }
<a name="l08273"></a>08273       <span class="keywordflow">if</span> (!res) {
<a name="l08274"></a>08274          <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l08275"></a>08275             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08276"></a>08276             <span class="keywordflow">if</span> (!res)
<a name="l08277"></a>08277                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-zpravy&quot;</span>);
<a name="l08278"></a>08278          }
<a name="l08279"></a>08279       }
<a name="l08280"></a>08280    }
<a name="l08281"></a>08281    <span class="keywordflow">return</span> res;
<a name="l08282"></a>08282 }
<a name="l08283"></a>08283 
<a name="l08284"></a>08284 <span class="comment">/* CHINESE (Taiwan) syntax */</span>
<a name="l08285"></a><a class="code" href="app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">08285</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">vm_intro_zh</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l08286"></a>08286 {
<a name="l08287"></a>08287    <span class="keywordtype">int</span> res;
<a name="l08288"></a>08288    <span class="comment">/* Introduce messages they have */</span>
<a name="l08289"></a>08289    res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-you&quot;</span>);
<a name="l08290"></a>08290 
<a name="l08291"></a>08291    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08292"></a>08292       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-have&quot;</span>);
<a name="l08293"></a>08293       <span class="keywordflow">if</span> (!res)
<a name="l08294"></a>08294          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>, chan-&gt;language);
<a name="l08295"></a>08295       <span class="keywordflow">if</span> (!res)
<a name="l08296"></a>08296          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tong&quot;</span>);
<a name="l08297"></a>08297       <span class="keywordflow">if</span> (!res)
<a name="l08298"></a>08298          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-INBOX&quot;</span>);
<a name="l08299"></a>08299       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !res)
<a name="l08300"></a>08300          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-and&quot;</span>);
<a name="l08301"></a>08301       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!res) 
<a name="l08302"></a>08302          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08303"></a>08303    }
<a name="l08304"></a>08304    <span class="keywordflow">if</span> (!res &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l08305"></a>08305       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-have&quot;</span>);
<a name="l08306"></a>08306       <span class="keywordflow">if</span> (!res)
<a name="l08307"></a>08307          res = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>, chan-&gt;language);
<a name="l08308"></a>08308       <span class="keywordflow">if</span> (!res)
<a name="l08309"></a>08309          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tong&quot;</span>);
<a name="l08310"></a>08310       <span class="keywordflow">if</span> (!res)
<a name="l08311"></a>08311          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-Old&quot;</span>);
<a name="l08312"></a>08312       <span class="keywordflow">if</span> (!res)
<a name="l08313"></a>08313          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08314"></a>08314    }
<a name="l08315"></a>08315    <span class="keywordflow">if</span> (!res &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> &amp;&amp; !vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l08316"></a>08316       res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-haveno&quot;</span>);
<a name="l08317"></a>08317       <span class="keywordflow">if</span> (!res)
<a name="l08318"></a>08318          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08319"></a>08319    }
<a name="l08320"></a>08320    <span class="keywordflow">return</span> res;
<a name="l08321"></a>08321 }
<a name="l08322"></a>08322 
<a name="l08323"></a><a class="code" href="app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">08323</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">vm_intro</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms)
<a name="l08324"></a>08324 {
<a name="l08325"></a>08325    <span class="keywordtype">char</span> prefile[256];
<a name="l08326"></a>08326    
<a name="l08327"></a>08327    <span class="comment">/* Notify the user that the temp greeting is set and give them the option to remove it */</span>
<a name="l08328"></a>08328    snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08329"></a>08329    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>)) {
<a name="l08330"></a>08330       <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l08331"></a>08331       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &gt; 0) {
<a name="l08332"></a>08332          <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tempgreetactive&quot;</span>);
<a name="l08333"></a>08333       }
<a name="l08334"></a>08334       <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);
<a name="l08335"></a>08335    }
<a name="l08336"></a>08336 
<a name="l08337"></a>08337    <span class="comment">/* Play voicemail intro - syntax is different for different languages */</span>
<a name="l08338"></a>08338    <span class="keywordflow">if</span> (0) {
<a name="l08339"></a>08339    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;cs&quot;</span>, 2)) {  <span class="comment">/* CZECH syntax */</span>
<a name="l08340"></a>08340       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a>(chan, vms);
<a name="l08341"></a>08341    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;cz&quot;</span>, 2)) {  <span class="comment">/* deprecated CZECH syntax */</span>
<a name="l08342"></a>08342       <span class="keyword">static</span> <span class="keywordtype">int</span> deprecation_warning = 0;
<a name="l08343"></a>08343       <span class="keywordflow">if</span> (deprecation_warning++ % 10 == 0) {
<a name="l08344"></a>08344          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;cz is not a standard language code.  Please switch to using cs instead.\n&quot;</span>);
<a name="l08345"></a>08345       }
<a name="l08346"></a>08346       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a761b2afbca06109ec90f4430bb8c0935">vm_intro_cs</a>(chan, vms);
<a name="l08347"></a>08347    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;de&quot;</span>, 2)) {  <span class="comment">/* GERMAN syntax */</span>
<a name="l08348"></a>08348       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a54ba5a3384c68e34bd62ee0a0da20e7a">vm_intro_de</a>(chan, vms);
<a name="l08349"></a>08349    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;es&quot;</span>, 2)) {  <span class="comment">/* SPANISH syntax */</span>
<a name="l08350"></a>08350       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#ad32ab72f58e10936461fcd7a696e1fae">vm_intro_es</a>(chan, vms);
<a name="l08351"></a>08351    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;fr&quot;</span>, 2)) {  <span class="comment">/* FRENCH syntax */</span>
<a name="l08352"></a>08352       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#ab6b048d794fbfa09f0e13c6b3c0a0f31">vm_intro_fr</a>(chan, vms);
<a name="l08353"></a>08353    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;gr&quot;</span>, 2)) {  <span class="comment">/* GREEK syntax */</span>
<a name="l08354"></a>08354       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#afa9da39009fbb2a8ca57396c57eb8f6c">vm_intro_gr</a>(chan, vms);
<a name="l08355"></a>08355    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;he&quot;</span>, 2)) {  <span class="comment">/* HEBREW syntax */</span>
<a name="l08356"></a>08356       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a2febb422c919a552aaf9cc3d4ebc801c">vm_intro_he</a>(chan, vms);
<a name="l08357"></a>08357    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;it&quot;</span>, 2)) {  <span class="comment">/* ITALIAN syntax */</span>
<a name="l08358"></a>08358       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#af8fbf1ad20e08b5b0d68c2a5476cc10c">vm_intro_it</a>(chan, vms);
<a name="l08359"></a>08359    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;nl&quot;</span>, 2)) {  <span class="comment">/* DUTCH syntax */</span>
<a name="l08360"></a>08360       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a7dd67802952f9785334caeff45282665">vm_intro_nl</a>(chan, vms);
<a name="l08361"></a>08361    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;no&quot;</span>, 2)) {  <span class="comment">/* NORWEGIAN syntax */</span>
<a name="l08362"></a>08362       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#afcf0f4fdfdac15cb43d5a412394689d8">vm_intro_no</a>(chan, vms);
<a name="l08363"></a>08363    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pl&quot;</span>, 2)) {  <span class="comment">/* POLISH syntax */</span>
<a name="l08364"></a>08364       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a0c4c042c64d338b5f15956bff0fd2ff7">vm_intro_pl</a>(chan, vms);
<a name="l08365"></a>08365    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pt_BR&quot;</span>, 5)) {  <span class="comment">/* BRAZILIAN PORTUGUESE syntax */</span>
<a name="l08366"></a>08366       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a673a6b1672bc6b5a12dd7270e1a4cee0">vm_intro_pt_BR</a>(chan, vms);
<a name="l08367"></a>08367    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pt&quot;</span>, 2)) {  <span class="comment">/* PORTUGUESE syntax */</span>
<a name="l08368"></a>08368       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a863d82d0cdc03163833e89dc36e3ad4c">vm_intro_pt</a>(chan, vms);
<a name="l08369"></a>08369    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;ru&quot;</span>, 2)) {  <span class="comment">/* RUSSIAN syntax */</span>
<a name="l08370"></a>08370       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a>(chan, vms, <span class="stringliteral">&quot;n&quot;</span>);
<a name="l08371"></a>08371    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;se&quot;</span>, 2)) {  <span class="comment">/* SWEDISH syntax */</span>
<a name="l08372"></a>08372       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#af54b6b5388c2838875f222a795850409">vm_intro_se</a>(chan, vms);
<a name="l08373"></a>08373    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;ua&quot;</span>, 2)) {  <span class="comment">/* UKRAINIAN syntax */</span>
<a name="l08374"></a>08374       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a4a157c1f8c73923881f545c532236a22">vm_intro_multilang</a>(chan, vms, <span class="stringliteral">&quot;n&quot;</span>);
<a name="l08375"></a>08375    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;zh&quot;</span>, 2)) { <span class="comment">/* CHINESE (Taiwan) syntax */</span>
<a name="l08376"></a>08376       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a831a6a1e183f3f25a93692de2fdc5404">vm_intro_zh</a>(chan, vms);
<a name="l08377"></a>08377    } <span class="keywordflow">else</span> {                                             <span class="comment">/* Default to ENGLISH */</span>
<a name="l08378"></a>08378       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#ab2462cdadf665ab4acb2ec25d83caa7f">vm_intro_en</a>(chan, vms);
<a name="l08379"></a>08379    }
<a name="l08380"></a>08380 }
<a name="l08381"></a>08381 
<a name="l08382"></a><a class="code" href="app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">08382</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)
<a name="l08383"></a>08383 {
<a name="l08384"></a>08384    <span class="keywordtype">int</span> res = 0;
<a name="l08385"></a>08385    <span class="comment">/* Play instructions and wait for new command */</span>
<a name="l08386"></a>08386    <span class="keywordflow">while</span> (!res) {
<a name="l08387"></a>08387       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l08388"></a>08388          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08389"></a>08389             <span class="keywordflow">if</span> (skipadvanced)
<a name="l08390"></a>08390                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor-full&quot;</span>);
<a name="l08391"></a>08391             <span class="keywordflow">else</span>
<a name="l08392"></a>08392                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor&quot;</span>);
<a name="l08393"></a>08393             <span class="keywordflow">if</span> (!res)
<a name="l08394"></a>08394                res = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);
<a name="l08395"></a>08395          }
<a name="l08396"></a>08396          <span class="keywordflow">if</span> (!res) {
<a name="l08397"></a>08397             <span class="keywordflow">if</span> (skipadvanced)
<a name="l08398"></a>08398                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts-full&quot;</span>);
<a name="l08399"></a>08399             <span class="keywordflow">else</span>
<a name="l08400"></a>08400                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);
<a name="l08401"></a>08401          }
<a name="l08402"></a>08402       } <span class="keywordflow">else</span> {
<a name="l08403"></a>08403          <span class="comment">/* Added for additional help */</span>
<a name="l08404"></a>08404          <span class="keywordflow">if</span> (skipadvanced) {
<a name="l08405"></a>08405             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor-full&quot;</span>);
<a name="l08406"></a>08406             <span class="keywordflow">if</span> (!res)
<a name="l08407"></a>08407                res = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);
<a name="l08408"></a>08408             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts-full&quot;</span>);
<a name="l08409"></a>08409          }
<a name="l08410"></a>08410          <span class="comment">/* Logic:</span>
<a name="l08411"></a>08411 <span class="comment">          * If the current message is not the first OR</span>
<a name="l08412"></a>08412 <span class="comment">          * if we&apos;re listening to the first new message and there are</span>
<a name="l08413"></a>08413 <span class="comment">          * also urgent messages, then prompt for navigation to the</span>
<a name="l08414"></a>08414 <span class="comment">          * previous message</span>
<a name="l08415"></a>08415 <span class="comment">          */</span>
<a name="l08416"></a>08416          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> || (!in_urgent &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &gt; 0) || (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0)) {
<a name="l08417"></a>08417             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-prev&quot;</span>);
<a name="l08418"></a>08418          }
<a name="l08419"></a>08419          <span class="keywordflow">if</span> (!res &amp;&amp; !skipadvanced)
<a name="l08420"></a>08420             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-advopts&quot;</span>);
<a name="l08421"></a>08421          <span class="keywordflow">if</span> (!res)
<a name="l08422"></a>08422             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-repeat&quot;</span>);
<a name="l08423"></a>08423          <span class="comment">/* Logic:</span>
<a name="l08424"></a>08424 <span class="comment">          * If we&apos;re not listening to the last message OR</span>
<a name="l08425"></a>08425 <span class="comment">          * we&apos;re listening to the last urgent message and there are</span>
<a name="l08426"></a>08426 <span class="comment">          * also new non-urgent messages, then prompt for navigation</span>
<a name="l08427"></a>08427 <span class="comment">          * to the next message</span>
<a name="l08428"></a>08428 <span class="comment">          */</span>
<a name="l08429"></a>08429          <span class="keywordflow">if</span> (!res &amp;&amp; ((vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> != vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) || (in_urgent &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) ||
<a name="l08430"></a>08430             (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) )) {
<a name="l08431"></a>08431             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-next&quot;</span>);
<a name="l08432"></a>08432          }
<a name="l08433"></a>08433          <span class="keywordflow">if</span> (!res) {
<a name="l08434"></a>08434             <span class="keywordflow">if</span> (!vms-&gt;<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>])
<a name="l08435"></a>08435                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-delete&quot;</span>);
<a name="l08436"></a>08436             <span class="keywordflow">else</span>
<a name="l08437"></a>08437                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-undelete&quot;</span>);
<a name="l08438"></a>08438             <span class="keywordflow">if</span> (!res)
<a name="l08439"></a>08439                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toforward&quot;</span>);
<a name="l08440"></a>08440             <span class="keywordflow">if</span> (!res)
<a name="l08441"></a>08441                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-savemessage&quot;</span>);
<a name="l08442"></a>08442          }
<a name="l08443"></a>08443       }
<a name="l08444"></a>08444       <span class="keywordflow">if</span> (!res) {
<a name="l08445"></a>08445          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-helpexit&quot;</span>);
<a name="l08446"></a>08446       }
<a name="l08447"></a>08447       <span class="keywordflow">if</span> (!res)
<a name="l08448"></a>08448          res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 6000);
<a name="l08449"></a>08449       <span class="keywordflow">if</span> (!res) {
<a name="l08450"></a>08450          vms-&gt;<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a>++;
<a name="l08451"></a>08451          <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> &gt; 2) {
<a name="l08452"></a>08452             res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l08453"></a>08453          }
<a name="l08454"></a>08454       }
<a name="l08455"></a>08455    }
<a name="l08456"></a>08456    <span class="keywordflow">return</span> res;
<a name="l08457"></a>08457 }
<a name="l08458"></a>08458 
<a name="l08459"></a><a class="code" href="app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">08459</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">vm_instructions_zh</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms,  <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)
<a name="l08460"></a>08460 {
<a name="l08461"></a>08461    <span class="keywordtype">int</span> res = 0;
<a name="l08462"></a>08462    <span class="comment">/* Play instructions and wait for new command */</span>
<a name="l08463"></a>08463    <span class="keywordflow">while</span> (!res) {
<a name="l08464"></a>08464       <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08465"></a>08465          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-listen&quot;</span>);
<a name="l08466"></a>08466          <span class="keywordflow">if</span> (!res)
<a name="l08467"></a>08467             res = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);
<a name="l08468"></a>08468          <span class="keywordflow">if</span> (!res)
<a name="l08469"></a>08469             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;press&quot;</span>);
<a name="l08470"></a>08470          <span class="keywordflow">if</span> (!res)
<a name="l08471"></a>08471             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;digits/1&quot;</span>);
<a name="l08472"></a>08472       }
<a name="l08473"></a>08473       <span class="keywordflow">if</span> (!res)
<a name="l08474"></a>08474          res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);
<a name="l08475"></a>08475       <span class="keywordflow">if</span> (!res) {
<a name="l08476"></a>08476          vms-&gt;<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 0;
<a name="l08477"></a>08477          <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a>(chan, vmu, vms, skipadvanced, in_urgent);
<a name="l08478"></a>08478       }
<a name="l08479"></a>08479    }
<a name="l08480"></a>08480    <span class="keywordflow">return</span> res;
<a name="l08481"></a>08481 }
<a name="l08482"></a>08482 
<a name="l08483"></a><a class="code" href="app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">08483</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> skipadvanced, <span class="keywordtype">int</span> in_urgent)
<a name="l08484"></a>08484 {
<a name="l08485"></a>08485    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> &amp;&amp; !strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;zh&quot;</span>, 2)) { <span class="comment">/* CHINESE (Taiwan) syntax */</span>
<a name="l08486"></a>08486       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a776a062edcd1b6e8e2c17cf40af28af0">vm_instructions_zh</a>(chan, vmu, vms, skipadvanced, in_urgent);
<a name="l08487"></a>08487    } <span class="keywordflow">else</span> {             <span class="comment">/* Default to ENGLISH */</span>
<a name="l08488"></a>08488       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#abb5a064892dcd900e8fe8cee81d9da37">vm_instructions_en</a>(chan, vmu, vms, skipadvanced, in_urgent);
<a name="l08489"></a>08489    }
<a name="l08490"></a>08490 }
<a name="l08491"></a>08491 
<a name="l08492"></a>08492 
<a name="l08493"></a><a class="code" href="app__voicemail_8c.html#ab43bc388c009596efb43c134433bfa1d">08493</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ab43bc388c009596efb43c134433bfa1d">vm_newuser</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)
<a name="l08494"></a>08494 {
<a name="l08495"></a>08495    <span class="keywordtype">int</span> cmd = 0;
<a name="l08496"></a>08496    <span class="keywordtype">int</span> duration = 0;
<a name="l08497"></a>08497    <span class="keywordtype">int</span> tries = 0;
<a name="l08498"></a>08498    <span class="keywordtype">char</span> newpassword[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08499"></a>08499    <span class="keywordtype">char</span> newpassword2[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08500"></a>08500    <span class="keywordtype">char</span> prefile[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08501"></a>08501    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l08502"></a>08502    <span class="keywordtype">int</span> bytes=0;
<a name="l08503"></a>08503 
<a name="l08504"></a>08504    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan)) {
<a name="l08505"></a>08505       bytes += <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);
<a name="l08506"></a>08506       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;New User Setup&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08507"></a>08507       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Not Done&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08508"></a>08508       bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l08509"></a>08509       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l08510"></a>08510       <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l08511"></a>08511    }
<a name="l08512"></a>08512 
<a name="l08513"></a>08513    <span class="comment">/* First, have the user change their password </span>
<a name="l08514"></a>08514 <span class="comment">      so they won&apos;t get here again */</span>
<a name="l08515"></a>08515    <span class="keywordflow">for</span> (;;) {
<a name="l08516"></a>08516       newpassword[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08517"></a>08517       newpassword[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a>);
<a name="l08518"></a>08518       <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08519"></a>08519          newpassword[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08520"></a>08520       <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08521"></a>08521          <span class="keywordflow">return</span> cmd;
<a name="l08522"></a>08522       cmd = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan,newpassword + strlen(newpassword),<span class="keyword">sizeof</span>(newpassword)-1,2000,10000,<span class="stringliteral">&quot;#&quot;</span>);
<a name="l08523"></a>08523       <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08524"></a>08524          <span class="keywordflow">return</span> cmd;
<a name="l08525"></a>08525       cmd = <a class="code" href="app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc" title="Check that password meets minimum required length.">check_password</a>(vmu, newpassword); <span class="comment">/* perform password validation */</span>
<a name="l08526"></a>08526       <span class="keywordflow">if</span> (cmd != 0) {
<a name="l08527"></a>08527          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid password for user %s (%s)\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword);
<a name="l08528"></a>08528          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a>);
<a name="l08529"></a>08529       } <span class="keywordflow">else</span> {
<a name="l08530"></a>08530          newpassword2[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08531"></a>08531          newpassword2[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a>);
<a name="l08532"></a>08532          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08533"></a>08533             newpassword2[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08534"></a>08534          <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08535"></a>08535             <span class="keywordflow">return</span> cmd;
<a name="l08536"></a>08536          cmd = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, newpassword2 + strlen(newpassword2), <span class="keyword">sizeof</span>(newpassword2) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>);
<a name="l08537"></a>08537          <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08538"></a>08538             <span class="keywordflow">return</span> cmd;
<a name="l08539"></a>08539          <span class="keywordflow">if</span> (!strcmp(newpassword, newpassword2))
<a name="l08540"></a>08540             <span class="keywordflow">break</span>;
<a name="l08541"></a>08541          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Password mismatch for user %s (%s != %s)\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword, newpassword2);
<a name="l08542"></a>08542          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a>);
<a name="l08543"></a>08543       }
<a name="l08544"></a>08544       <span class="keywordflow">if</span> (++tries == 3)
<a name="l08545"></a>08545          <span class="keywordflow">return</span> -1;
<a name="l08546"></a>08546       <span class="keywordflow">if</span> (cmd != 0) {
<a name="l08547"></a>08547          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>);
<a name="l08548"></a>08548       }
<a name="l08549"></a>08549    }
<a name="l08550"></a>08550    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> &amp; <a class="code" href="app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>)
<a name="l08551"></a>08551       <a class="code" href="app__voicemail_8c.html#a778f09605f89f85529e369351472b174" title="The handler for the change password option.">vm_change_password</a>(vmu, newpassword);
<a name="l08552"></a>08552    <span class="keywordflow">if</span> ((<a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> &amp; <a class="code" href="app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>))
<a name="l08553"></a>08553       <a class="code" href="app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a>(vmu, newpassword);
<a name="l08554"></a>08554 
<a name="l08555"></a>08555    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;User %s set password to %s of length %d\n&quot;</span>,vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>,newpassword,(<span class="keywordtype">int</span>)strlen(newpassword));
<a name="l08556"></a>08556    cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a>);
<a name="l08557"></a>08557 
<a name="l08558"></a>08558    <span class="comment">/* If forcename is set, have the user record their name */</span>  
<a name="l08559"></a>08559    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>)) {
<a name="l08560"></a>08560       snprintf(prefile,<span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08561"></a>08561       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &lt; 1) {
<a name="l08562"></a>08562          cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-name&quot;</span>, prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08563"></a>08563          <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08564"></a>08564             <span class="keywordflow">return</span> cmd;
<a name="l08565"></a>08565       }
<a name="l08566"></a>08566    }
<a name="l08567"></a>08567 
<a name="l08568"></a>08568    <span class="comment">/* If forcegreetings is set, have the user record their greetings */</span>
<a name="l08569"></a>08569    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>)) {
<a name="l08570"></a>08570       snprintf(prefile,<span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/unavail&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08571"></a>08571       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &lt; 1) {
<a name="l08572"></a>08572          cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-unv&quot;</span>, prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08573"></a>08573          <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08574"></a>08574             <span class="keywordflow">return</span> cmd;
<a name="l08575"></a>08575       }
<a name="l08576"></a>08576 
<a name="l08577"></a>08577       snprintf(prefile,<span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/busy&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08578"></a>08578       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &lt; 1) {
<a name="l08579"></a>08579          cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-busy&quot;</span>, prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08580"></a>08580          <span class="keywordflow">if</span> (cmd &lt; 0 || cmd == <span class="charliteral">&apos;t&apos;</span> || cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08581"></a>08581             <span class="keywordflow">return</span> cmd;
<a name="l08582"></a>08582       }
<a name="l08583"></a>08583    }
<a name="l08584"></a>08584 
<a name="l08585"></a>08585    <span class="keywordflow">return</span> cmd;
<a name="l08586"></a>08586 }
<a name="l08587"></a>08587 
<a name="l08588"></a><a class="code" href="app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">08588</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">vm_options</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)
<a name="l08589"></a>08589 {
<a name="l08590"></a>08590    <span class="keywordtype">int</span> cmd = 0;
<a name="l08591"></a>08591    <span class="keywordtype">int</span> retries = 0;
<a name="l08592"></a>08592    <span class="keywordtype">int</span> duration = 0;
<a name="l08593"></a>08593    <span class="keywordtype">char</span> newpassword[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08594"></a>08594    <span class="keywordtype">char</span> newpassword2[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08595"></a>08595    <span class="keywordtype">char</span> prefile[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08596"></a>08596    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l08597"></a>08597    <span class="keywordtype">int</span> bytes=0;
<a name="l08598"></a>08598 
<a name="l08599"></a>08599    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan)) {
<a name="l08600"></a>08600       bytes += <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);
<a name="l08601"></a>08601       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Options Menu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08602"></a>08602       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Not Done&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08603"></a>08603       bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l08604"></a>08604       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l08605"></a>08605       <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l08606"></a>08606    }
<a name="l08607"></a>08607    <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>)) {
<a name="l08608"></a>08608       <span class="keywordflow">if</span> (cmd)
<a name="l08609"></a>08609          retries = 0;
<a name="l08610"></a>08610       <span class="keywordflow">switch</span> (cmd) {
<a name="l08611"></a>08611       <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: <span class="comment">/* Record your unavailable message */</span>
<a name="l08612"></a>08612          snprintf(prefile,<span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/unavail&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08613"></a>08613          cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan,<span class="stringliteral">&quot;vm-rec-unv&quot;</span>,prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08614"></a>08614          <span class="keywordflow">break</span>;
<a name="l08615"></a>08615       <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:  <span class="comment">/* Record your busy message */</span>
<a name="l08616"></a>08616          snprintf(prefile,<span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/busy&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08617"></a>08617          cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan,<span class="stringliteral">&quot;vm-rec-busy&quot;</span>,prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08618"></a>08618          <span class="keywordflow">break</span>;
<a name="l08619"></a>08619       <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>: <span class="comment">/* Record greeting */</span>
<a name="l08620"></a>08620          snprintf(prefile,<span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08621"></a>08621          cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan,<span class="stringliteral">&quot;vm-rec-name&quot;</span>,prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08622"></a>08622          <span class="keywordflow">break</span>;
<a name="l08623"></a>08623       <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:  <span class="comment">/* manage the temporary greeting */</span>
<a name="l08624"></a>08624          cmd = <a class="code" href="app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650" title="The handler for &amp;#39;record a temporary greeting&amp;#39;.">vm_tempgreeting</a>(chan, vmu, vms, fmtc, record_gain);
<a name="l08625"></a>08625          <span class="keywordflow">break</span>;
<a name="l08626"></a>08626       <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>: <span class="comment">/* change password */</span>
<a name="l08627"></a>08627          <span class="keywordflow">if</span> (vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[0] == <span class="charliteral">&apos;-&apos;</span>) {
<a name="l08628"></a>08628             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08629"></a>08629             <span class="keywordflow">break</span>;
<a name="l08630"></a>08630          }
<a name="l08631"></a>08631          newpassword[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08632"></a>08632          newpassword[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a>);
<a name="l08633"></a>08633          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08634"></a>08634             newpassword[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08635"></a>08635          <span class="keywordflow">else</span> {
<a name="l08636"></a>08636             <span class="keywordflow">if</span> (cmd &lt; 0)
<a name="l08637"></a>08637                <span class="keywordflow">break</span>;
<a name="l08638"></a>08638             <span class="keywordflow">if</span> ((cmd = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan,newpassword + strlen(newpassword),<span class="keyword">sizeof</span>(newpassword)-1,2000,10000,<span class="stringliteral">&quot;#&quot;</span>)) &lt; 0) {
<a name="l08639"></a>08639                <span class="keywordflow">break</span>;
<a name="l08640"></a>08640             }
<a name="l08641"></a>08641          }
<a name="l08642"></a>08642          cmd = <a class="code" href="app__voicemail_8c.html#a86e0b87be99e44b8431556b58fef88bc" title="Check that password meets minimum required length.">check_password</a>(vmu, newpassword); <span class="comment">/* perform password validation */</span>
<a name="l08643"></a>08643          <span class="keywordflow">if</span> (cmd != 0) {
<a name="l08644"></a>08644             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Invalid password for user %s (%s)\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword);
<a name="l08645"></a>08645             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a>);
<a name="l08646"></a>08646             <span class="keywordflow">if</span> (!cmd) {
<a name="l08647"></a>08647                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>);
<a name="l08648"></a>08648             }
<a name="l08649"></a>08649             <span class="keywordflow">break</span>;
<a name="l08650"></a>08650          }
<a name="l08651"></a>08651          newpassword2[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08652"></a>08652          newpassword2[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a>);
<a name="l08653"></a>08653          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;#&apos;</span>)
<a name="l08654"></a>08654             newpassword2[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l08655"></a>08655          <span class="keywordflow">else</span> {
<a name="l08656"></a>08656             <span class="keywordflow">if</span> (cmd &lt; 0)
<a name="l08657"></a>08657                <span class="keywordflow">break</span>;
<a name="l08658"></a>08658 
<a name="l08659"></a>08659             <span class="keywordflow">if</span> ((cmd = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan,newpassword2 + strlen(newpassword2),<span class="keyword">sizeof</span>(newpassword2)-1,2000,10000,<span class="stringliteral">&quot;#&quot;</span>)) &lt; 0) {
<a name="l08660"></a>08660                <span class="keywordflow">break</span>;
<a name="l08661"></a>08661             }
<a name="l08662"></a>08662          }
<a name="l08663"></a>08663          <span class="keywordflow">if</span> (strcmp(newpassword, newpassword2)) {
<a name="l08664"></a>08664             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Password mismatch for user %s (%s != %s)\n&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, newpassword, newpassword2);
<a name="l08665"></a>08665             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a>);
<a name="l08666"></a>08666             <span class="keywordflow">if</span> (!cmd) {
<a name="l08667"></a>08667                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>);
<a name="l08668"></a>08668             }
<a name="l08669"></a>08669             <span class="keywordflow">break</span>;
<a name="l08670"></a>08670          }
<a name="l08671"></a>08671          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> &amp; <a class="code" href="app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>)
<a name="l08672"></a>08672             <a class="code" href="app__voicemail_8c.html#a778f09605f89f85529e369351472b174" title="The handler for the change password option.">vm_change_password</a>(vmu, newpassword);
<a name="l08673"></a>08673          <span class="keywordflow">if</span> ((<a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> &amp; <a class="code" href="app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>))
<a name="l08674"></a>08674             <a class="code" href="app__voicemail_8c.html#ab5fdc062c2a85b1d3739a861d3d3232f">vm_change_password_shell</a>(vmu, newpassword);
<a name="l08675"></a>08675 
<a name="l08676"></a>08676          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;User %s set password to %s of length %d\n&quot;</span>,vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>,newpassword,(<span class="keywordtype">int</span>)strlen(newpassword));
<a name="l08677"></a>08677          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a>);
<a name="l08678"></a>08678          <span class="keywordflow">break</span>;
<a name="l08679"></a>08679       <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>: 
<a name="l08680"></a>08680          cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l08681"></a>08681          <span class="keywordflow">break</span>;
<a name="l08682"></a>08682       <span class="keywordflow">default</span>: 
<a name="l08683"></a>08683          cmd = 0;
<a name="l08684"></a>08684          snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08685"></a>08685          <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l08686"></a>08686          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL)) {
<a name="l08687"></a>08687             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tmpexists&quot;</span>);
<a name="l08688"></a>08688          }
<a name="l08689"></a>08689          <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);
<a name="l08690"></a>08690          <span class="keywordflow">if</span> (!cmd) {
<a name="l08691"></a>08691             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-options&quot;</span>);
<a name="l08692"></a>08692          }
<a name="l08693"></a>08693          <span class="keywordflow">if</span> (!cmd) {
<a name="l08694"></a>08694             cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan,6000);
<a name="l08695"></a>08695          }
<a name="l08696"></a>08696          <span class="keywordflow">if</span> (!cmd) {
<a name="l08697"></a>08697             retries++;
<a name="l08698"></a>08698          }
<a name="l08699"></a>08699          <span class="keywordflow">if</span> (retries &gt; 3) {
<a name="l08700"></a>08700             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l08701"></a>08701          }
<a name="l08702"></a>08702       }
<a name="l08703"></a>08703    }
<a name="l08704"></a>08704    <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;t&apos;</span>)
<a name="l08705"></a>08705       cmd = 0;
<a name="l08706"></a>08706    <span class="keywordflow">return</span> cmd;
<a name="l08707"></a>08707 }
<a name="l08708"></a>08708 <span class="comment"></span>
<a name="l08709"></a>08709 <span class="comment">/*!</span>
<a name="l08710"></a>08710 <span class="comment"> * \brief The handler for &apos;record a temporary greeting&apos;. </span>
<a name="l08711"></a>08711 <span class="comment"> * \param chan</span>
<a name="l08712"></a>08712 <span class="comment"> * \param vmu</span>
<a name="l08713"></a>08713 <span class="comment"> * \param vms</span>
<a name="l08714"></a>08714 <span class="comment"> * \param fmtc</span>
<a name="l08715"></a>08715 <span class="comment"> * \param record_gain</span>
<a name="l08716"></a>08716 <span class="comment"> *</span>
<a name="l08717"></a>08717 <span class="comment"> * This is option 4 from the mailbox options menu.</span>
<a name="l08718"></a>08718 <span class="comment"> * This function manages the following promptings:</span>
<a name="l08719"></a>08719 <span class="comment"> * 1: play / record / review the temporary greeting. : invokes play_record_review().</span>
<a name="l08720"></a>08720 <span class="comment"> * 2: remove (delete) the temporary greeting.</span>
<a name="l08721"></a>08721 <span class="comment"> * *: return to the main menu.</span>
<a name="l08722"></a>08722 <span class="comment"> *</span>
<a name="l08723"></a>08723 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08724"></a>08724 <span class="comment"> */</span>
<a name="l08725"></a><a class="code" href="app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650">08725</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a968fb00e5d6578cbdd7faa2069ac8650" title="The handler for &amp;#39;record a temporary greeting&amp;#39;.">vm_tempgreeting</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *fmtc, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)
<a name="l08726"></a>08726 {
<a name="l08727"></a>08727    <span class="keywordtype">int</span> cmd = 0;
<a name="l08728"></a>08728    <span class="keywordtype">int</span> retries = 0;
<a name="l08729"></a>08729    <span class="keywordtype">int</span> duration = 0;
<a name="l08730"></a>08730    <span class="keywordtype">char</span> prefile[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l08731"></a>08731    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> buf[256];
<a name="l08732"></a>08732    <span class="keywordtype">int</span> bytes = 0;
<a name="l08733"></a>08733 
<a name="l08734"></a>08734    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a>(chan)) {
<a name="l08735"></a>08735       bytes += <a class="code" href="app__voicemail_8c.html#aa37835209fb22c9ca1e3f697b3da03f7">adsi_logo</a>(buf + bytes);
<a name="l08736"></a>08736       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 3, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Temp Greeting Menu&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08737"></a>08737       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 4, <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>, 0, <span class="stringliteral">&quot;Not Done&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l08738"></a>08738       bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#aae985f992f116d9c01a729e8f6df8717">ADSI_COMM_PAGE</a>, 1);
<a name="l08739"></a>08739       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l08740"></a>08740       <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>);
<a name="l08741"></a>08741    }
<a name="l08742"></a>08742 
<a name="l08743"></a>08743    snprintf(prefile, <span class="keyword">sizeof</span>(prefile), <span class="stringliteral">&quot;%s%s/%s/temp&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vms-&gt;<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>);
<a name="l08744"></a>08744    <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>)) {
<a name="l08745"></a>08745       <span class="keywordflow">if</span> (cmd)
<a name="l08746"></a>08746          retries = 0;
<a name="l08747"></a>08747       <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(prefile, -1, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l08748"></a>08748       <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &lt;= 0) {
<a name="l08749"></a>08749          <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-temp&quot;</span>, prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08750"></a>08750          cmd = <span class="charliteral">&apos;t&apos;</span>;  
<a name="l08751"></a>08751       } <span class="keywordflow">else</span> {
<a name="l08752"></a>08752          <span class="keywordflow">switch</span> (cmd) {
<a name="l08753"></a>08753          <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l08754"></a>08754             cmd = <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-temp&quot;</span>, prefile, <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a>, fmtc, 0, vmu, &amp;duration, NULL, record_gain, vms, NULL);
<a name="l08755"></a>08755             <span class="keywordflow">break</span>;
<a name="l08756"></a>08756          <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l08757"></a>08757             <a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(prefile, -1, prefile, vmu);
<a name="l08758"></a>08758             <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tempremoved&quot;</span>);
<a name="l08759"></a>08759             cmd = <span class="charliteral">&apos;t&apos;</span>;  
<a name="l08760"></a>08760             <span class="keywordflow">break</span>;
<a name="l08761"></a>08761          <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>: 
<a name="l08762"></a>08762             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l08763"></a>08763             <span class="keywordflow">break</span>;
<a name="l08764"></a>08764          <span class="keywordflow">default</span>:
<a name="l08765"></a>08765             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan,
<a name="l08766"></a>08766                <a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(prefile, NULL, NULL) &gt; 0 ? <span class="comment">/* XXX always true ? */</span>
<a name="l08767"></a>08767                   <span class="stringliteral">&quot;vm-tempgreeting2&quot;</span> : <span class="stringliteral">&quot;vm-tempgreeting&quot;</span>);
<a name="l08768"></a>08768             <span class="keywordflow">if</span> (!cmd)
<a name="l08769"></a>08769                cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan,6000);
<a name="l08770"></a>08770             <span class="keywordflow">if</span> (!cmd)
<a name="l08771"></a>08771                retries++;
<a name="l08772"></a>08772             <span class="keywordflow">if</span> (retries &gt; 3)
<a name="l08773"></a>08773                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l08774"></a>08774          }
<a name="l08775"></a>08775       }
<a name="l08776"></a>08776       <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(prefile, -1);
<a name="l08777"></a>08777    }
<a name="l08778"></a>08778    <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;t&apos;</span>)
<a name="l08779"></a>08779       cmd = 0;
<a name="l08780"></a>08780    <span class="keywordflow">return</span> cmd;
<a name="l08781"></a>08781 }
<a name="l08782"></a>08782 <span class="comment"></span>
<a name="l08783"></a>08783 <span class="comment">/*!</span>
<a name="l08784"></a>08784 <span class="comment"> * \brief Greek syntax for &apos;You have N messages&apos; greeting.</span>
<a name="l08785"></a>08785 <span class="comment"> * \param chan</span>
<a name="l08786"></a>08786 <span class="comment"> * \param vms</span>
<a name="l08787"></a>08787 <span class="comment"> * \param vmu</span>
<a name="l08788"></a>08788 <span class="comment"> *</span>
<a name="l08789"></a>08789 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08790"></a>08790 <span class="comment"> */</span>   
<a name="l08791"></a><a class="code" href="app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751">08791</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751" title="Greek syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_gr</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08792"></a>08792 {
<a name="l08793"></a>08793    <span class="keywordtype">int</span> cmd=0;
<a name="l08794"></a>08794 
<a name="l08795"></a>08795    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08796"></a>08796       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08797"></a>08797    } <span class="keywordflow">else</span> {
<a name="l08798"></a>08798       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhaveno&quot;</span>);
<a name="l08799"></a>08799       <span class="keywordflow">if</span> (!strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="stringliteral">&quot;vm-INBOX&quot;</span>) ||!strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>, <span class="stringliteral">&quot;vm-Old&quot;</span>)){
<a name="l08800"></a>08800          <span class="keywordflow">if</span> (!cmd) {
<a name="l08801"></a>08801             snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%ss&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08802"></a>08802             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08803"></a>08803          }
<a name="l08804"></a>08804          <span class="keywordflow">if</span> (!cmd)
<a name="l08805"></a>08805             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08806"></a>08806       } <span class="keywordflow">else</span> {
<a name="l08807"></a>08807          <span class="keywordflow">if</span> (!cmd)
<a name="l08808"></a>08808             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08809"></a>08809          <span class="keywordflow">if</span> (!cmd) {
<a name="l08810"></a>08810             snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08811"></a>08811             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08812"></a>08812          }
<a name="l08813"></a>08813       }
<a name="l08814"></a>08814    } 
<a name="l08815"></a>08815    <span class="keywordflow">return</span> cmd;
<a name="l08816"></a>08816 }
<a name="l08817"></a>08817 
<a name="l08818"></a>08818 <span class="comment">/* Hebrew Syntax */</span>
<a name="l08819"></a><a class="code" href="app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">08819</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">vm_browse_messages_he</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08820"></a>08820 {
<a name="l08821"></a>08821    <span class="keywordtype">int</span> cmd = 0;
<a name="l08822"></a>08822 
<a name="l08823"></a>08823    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08824"></a>08824       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08825"></a>08825    } <span class="keywordflow">else</span> {
<a name="l08826"></a>08826       <span class="keywordflow">if</span> (!strcasecmp(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="stringliteral">&quot;INBOX&quot;</span>)) {
<a name="l08827"></a>08827          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nonewmessages&quot;</span>);
<a name="l08828"></a>08828       } <span class="keywordflow">else</span> {
<a name="l08829"></a>08829          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomessages&quot;</span>);
<a name="l08830"></a>08830       }
<a name="l08831"></a>08831    }
<a name="l08832"></a>08832    <span class="keywordflow">return</span> cmd;
<a name="l08833"></a>08833 }
<a name="l08834"></a>08834 <span class="comment"></span>
<a name="l08835"></a>08835 <span class="comment">/*! </span>
<a name="l08836"></a>08836 <span class="comment"> * \brief Default English syntax for &apos;You have N messages&apos; greeting.</span>
<a name="l08837"></a>08837 <span class="comment"> * \param chan</span>
<a name="l08838"></a>08838 <span class="comment"> * \param vms</span>
<a name="l08839"></a>08839 <span class="comment"> * \param vmu</span>
<a name="l08840"></a>08840 <span class="comment"> *</span>
<a name="l08841"></a>08841 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08842"></a>08842 <span class="comment"> */</span>
<a name="l08843"></a><a class="code" href="app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14">08843</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14" title="Default English syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_en</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08844"></a>08844 {
<a name="l08845"></a>08845    <span class="keywordtype">int</span> cmd=0;
<a name="l08846"></a>08846 
<a name="l08847"></a>08847    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08848"></a>08848       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08849"></a>08849    } <span class="keywordflow">else</span> {
<a name="l08850"></a>08850       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>);
<a name="l08851"></a>08851       <span class="keywordflow">if</span> (!cmd) 
<a name="l08852"></a>08852          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08853"></a>08853       <span class="keywordflow">if</span> (!cmd) {
<a name="l08854"></a>08854          snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08855"></a>08855          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08856"></a>08856       }
<a name="l08857"></a>08857       <span class="keywordflow">if</span> (!cmd)
<a name="l08858"></a>08858          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08859"></a>08859    }
<a name="l08860"></a>08860    <span class="keywordflow">return</span> cmd;
<a name="l08861"></a>08861 }
<a name="l08862"></a>08862 <span class="comment"></span>
<a name="l08863"></a>08863 <span class="comment">/*! </span>
<a name="l08864"></a>08864 <span class="comment"> *\brief Italian syntax for &apos;You have N messages&apos; greeting.</span>
<a name="l08865"></a>08865 <span class="comment"> * \param chan</span>
<a name="l08866"></a>08866 <span class="comment"> * \param vms</span>
<a name="l08867"></a>08867 <span class="comment"> * \param vmu</span>
<a name="l08868"></a>08868 <span class="comment"> *</span>
<a name="l08869"></a>08869 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08870"></a>08870 <span class="comment"> */</span>
<a name="l08871"></a><a class="code" href="app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108">08871</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108" title="Italian syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_it</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08872"></a>08872 {
<a name="l08873"></a>08873    <span class="keywordtype">int</span> cmd=0;
<a name="l08874"></a>08874 
<a name="l08875"></a>08875    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08876"></a>08876       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08877"></a>08877    } <span class="keywordflow">else</span> {
<a name="l08878"></a>08878       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08879"></a>08879       <span class="keywordflow">if</span> (!cmd)
<a name="l08880"></a>08880          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l08881"></a>08881       <span class="keywordflow">if</span> (!cmd) {
<a name="l08882"></a>08882          snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08883"></a>08883          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08884"></a>08884       }
<a name="l08885"></a>08885    }
<a name="l08886"></a>08886    <span class="keywordflow">return</span> cmd;
<a name="l08887"></a>08887 }
<a name="l08888"></a>08888 <span class="comment"></span>
<a name="l08889"></a>08889 <span class="comment">/*! </span>
<a name="l08890"></a>08890 <span class="comment"> * \brief Spanish syntax for &apos;You have N messages&apos; greeting.</span>
<a name="l08891"></a>08891 <span class="comment"> * \param chan</span>
<a name="l08892"></a>08892 <span class="comment"> * \param vms</span>
<a name="l08893"></a>08893 <span class="comment"> * \param vmu</span>
<a name="l08894"></a>08894 <span class="comment"> *</span>
<a name="l08895"></a>08895 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08896"></a>08896 <span class="comment"> */</span>
<a name="l08897"></a><a class="code" href="app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a">08897</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a" title="Spanish syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_es</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08898"></a>08898 {
<a name="l08899"></a>08899    <span class="keywordtype">int</span> cmd=0;
<a name="l08900"></a>08900 
<a name="l08901"></a>08901    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08902"></a>08902       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08903"></a>08903    } <span class="keywordflow">else</span> {
<a name="l08904"></a>08904       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-youhaveno&quot;</span>);
<a name="l08905"></a>08905       <span class="keywordflow">if</span> (!cmd)
<a name="l08906"></a>08906          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08907"></a>08907       <span class="keywordflow">if</span> (!cmd) {
<a name="l08908"></a>08908          snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08909"></a>08909          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08910"></a>08910       }
<a name="l08911"></a>08911    }
<a name="l08912"></a>08912    <span class="keywordflow">return</span> cmd;
<a name="l08913"></a>08913 }
<a name="l08914"></a>08914 <span class="comment"></span>
<a name="l08915"></a>08915 <span class="comment">/*! </span>
<a name="l08916"></a>08916 <span class="comment"> * \brief Portuguese syntax for &apos;You have N messages&apos; greeting.</span>
<a name="l08917"></a>08917 <span class="comment"> * \param chan</span>
<a name="l08918"></a>08918 <span class="comment"> * \param vms</span>
<a name="l08919"></a>08919 <span class="comment"> * \param vmu</span>
<a name="l08920"></a>08920 <span class="comment"> *</span>
<a name="l08921"></a>08921 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08922"></a>08922 <span class="comment"> */</span>
<a name="l08923"></a><a class="code" href="app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739">08923</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739" title="Portuguese syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_pt</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08924"></a>08924 {
<a name="l08925"></a>08925    <span class="keywordtype">int</span> cmd=0;
<a name="l08926"></a>08926 
<a name="l08927"></a>08927    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08928"></a>08928       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08929"></a>08929    } <span class="keywordflow">else</span> {
<a name="l08930"></a>08930       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-no&quot;</span>);
<a name="l08931"></a>08931       <span class="keywordflow">if</span> (!cmd) {
<a name="l08932"></a>08932          snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08933"></a>08933          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08934"></a>08934       }
<a name="l08935"></a>08935       <span class="keywordflow">if</span> (!cmd)
<a name="l08936"></a>08936          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08937"></a>08937    }
<a name="l08938"></a>08938    <span class="keywordflow">return</span> cmd;
<a name="l08939"></a>08939 }
<a name="l08940"></a>08940 <span class="comment"></span>
<a name="l08941"></a>08941 <span class="comment">/*! </span>
<a name="l08942"></a>08942 <span class="comment"> * \brief Chinese (Taiwan)syntax for &apos;You have N messages&apos; greeting.</span>
<a name="l08943"></a>08943 <span class="comment"> * \param chan</span>
<a name="l08944"></a>08944 <span class="comment"> * \param vms</span>
<a name="l08945"></a>08945 <span class="comment"> * \param vmu</span>
<a name="l08946"></a>08946 <span class="comment"> *</span>
<a name="l08947"></a>08947 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08948"></a>08948 <span class="comment"> */</span>
<a name="l08949"></a><a class="code" href="app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3">08949</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3" title="Chinese (Taiwan)syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_zh</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08950"></a>08950 {
<a name="l08951"></a>08951    <span class="keywordtype">int</span> cmd=0;
<a name="l08952"></a>08952 
<a name="l08953"></a>08953    <span class="keywordflow">if</span> (vms-&gt;<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l08954"></a>08954       cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, vms);
<a name="l08955"></a>08955    } <span class="keywordflow">else</span> {
<a name="l08956"></a>08956       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-you&quot;</span>);
<a name="l08957"></a>08957       <span class="keywordflow">if</span> (!cmd) 
<a name="l08958"></a>08958          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-haveno&quot;</span>);
<a name="l08959"></a>08959       <span class="keywordflow">if</span> (!cmd)
<a name="l08960"></a>08960          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-messages&quot;</span>);
<a name="l08961"></a>08961       <span class="keywordflow">if</span> (!cmd) {
<a name="l08962"></a>08962          snprintf(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a544d78076d61749c3919be3bbb87ca7f">curbox</a>);
<a name="l08963"></a>08963          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l08964"></a>08964       }
<a name="l08965"></a>08965    }
<a name="l08966"></a>08966    <span class="keywordflow">return</span> cmd;
<a name="l08967"></a>08967 }
<a name="l08968"></a>08968 <span class="comment"></span>
<a name="l08969"></a>08969 <span class="comment">/*!</span>
<a name="l08970"></a>08970 <span class="comment"> * \brief Top level method to invoke the language variant vm_browse_messages_XX function.</span>
<a name="l08971"></a>08971 <span class="comment"> * \param chan The channel for the current user. We read the language property from this.</span>
<a name="l08972"></a>08972 <span class="comment"> * \param vms passed into the language-specific vm_browse_messages function.</span>
<a name="l08973"></a>08973 <span class="comment"> * \param vmu passed into the language-specific vm_browse_messages function.</span>
<a name="l08974"></a>08974 <span class="comment"> * </span>
<a name="l08975"></a>08975 <span class="comment"> * The method to be invoked is determined by the value of language code property in the user&apos;s channel.</span>
<a name="l08976"></a>08976 <span class="comment"> * The default (when unable to match) is to use english.</span>
<a name="l08977"></a>08977 <span class="comment"> *</span>
<a name="l08978"></a>08978 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l08979"></a>08979 <span class="comment"> */</span>
<a name="l08980"></a><a class="code" href="app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7">08980</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7" title="Top level method to invoke the language variant vm_browse_messages_XX function.">vm_browse_messages</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu)
<a name="l08981"></a>08981 {
<a name="l08982"></a>08982    <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;es&quot;</span>, 2)) {         <span class="comment">/* SPANISH */</span>
<a name="l08983"></a>08983       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a5bba9e85c2fe23ee80a59a7a00a5c74a" title="Spanish syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_es</a>(chan, vms, vmu);
<a name="l08984"></a>08984    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;gr&quot;</span>, 2)) {  <span class="comment">/* GREEK */</span>
<a name="l08985"></a>08985       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#af98522cd60be017011cde1f8522ed751" title="Greek syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_gr</a>(chan, vms, vmu);
<a name="l08986"></a>08986    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;he&quot;</span>, 2)) {  <span class="comment">/* HEBREW */</span>
<a name="l08987"></a>08987       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#ac5e05af0fcfd551b8996cad383a2a56c">vm_browse_messages_he</a>(chan, vms, vmu);
<a name="l08988"></a>08988    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;it&quot;</span>, 2)) {  <span class="comment">/* ITALIAN */</span>
<a name="l08989"></a>08989       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#aba5f1994c382f15d5d1e053166da0108" title="Italian syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_it</a>(chan, vms, vmu);
<a name="l08990"></a>08990    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;pt&quot;</span>, 2)) {  <span class="comment">/* PORTUGUESE */</span>
<a name="l08991"></a>08991       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a3f31453846f663c1b3f842c32ba48739" title="Portuguese syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_pt</a>(chan, vms, vmu);
<a name="l08992"></a>08992    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;zh&quot;</span>, 2)) {
<a name="l08993"></a>08993       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a2df9fff4e7799595bf0571bcc81de9f3" title="Chinese (Taiwan)syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_zh</a>(chan, vms, vmu);   <span class="comment">/* CHINESE (Taiwan) */</span>
<a name="l08994"></a>08994    } <span class="keywordflow">else</span> {                                             <span class="comment">/* Default to English syntax */</span>
<a name="l08995"></a>08995       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a097d7083995be395b171563aa8fd8a14" title="Default English syntax for &amp;#39;You have N messages&amp;#39; greeting.">vm_browse_messages_en</a>(chan, vms, vmu);
<a name="l08996"></a>08996    }
<a name="l08997"></a>08997 }
<a name="l08998"></a>08998 
<a name="l08999"></a><a class="code" href="app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">08999</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *mailbox, <span class="keywordtype">int</span> mailbox_size,
<a name="l09000"></a>09000          <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *res_vmu, <span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>,
<a name="l09001"></a>09001          <span class="keywordtype">int</span> skipuser, <span class="keywordtype">int</span> max_logins, <span class="keywordtype">int</span> silent)
<a name="l09002"></a>09002 {
<a name="l09003"></a>09003    <span class="keywordtype">int</span> useadsi=0, valid=0, logretries=0;
<a name="l09004"></a>09004    <span class="keywordtype">char</span> password[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>]=<span class="stringliteral">&quot;&quot;</span>, *passptr;
<a name="l09005"></a>09005    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> vmus, *vmu = NULL;
<a name="l09006"></a>09006 
<a name="l09007"></a>09007    <span class="comment">/* If ADSI is supported, setup login screen */</span>
<a name="l09008"></a>09008    <a class="code" href="app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a>(chan, &amp;useadsi);
<a name="l09009"></a>09009    <span class="keywordflow">if</span> (!skipuser &amp;&amp; useadsi)
<a name="l09010"></a>09010       <a class="code" href="app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a>(chan);
<a name="l09011"></a>09011    <span class="keywordflow">if</span> (!silent &amp;&amp; !skipuser &amp;&amp; <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-login&quot;</span>, chan-&gt;language)) {
<a name="l09012"></a>09012       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t stream login file\n&quot;</span>);
<a name="l09013"></a>09013       <span class="keywordflow">return</span> -1;
<a name="l09014"></a>09014    }
<a name="l09015"></a>09015    
<a name="l09016"></a>09016    <span class="comment">/* Authenticate them and get their mailbox/password */</span>
<a name="l09017"></a>09017    
<a name="l09018"></a>09018    <span class="keywordflow">while</span> (!valid &amp;&amp; (logretries &lt; max_logins)) {
<a name="l09019"></a>09019       <span class="comment">/* Prompt for, and read in the username */</span>
<a name="l09020"></a>09020       <span class="keywordflow">if</span> (!skipuser &amp;&amp; <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, mailbox, mailbox_size - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>) &lt; 0) {
<a name="l09021"></a>09021          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t read username\n&quot;</span>);
<a name="l09022"></a>09022          <span class="keywordflow">return</span> -1;
<a name="l09023"></a>09023       }
<a name="l09024"></a>09024       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mailbox)) {
<a name="l09025"></a>09025          <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>) {
<a name="l09026"></a>09026             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mailbox, chan-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, mailbox_size);
<a name="l09027"></a>09027          } <span class="keywordflow">else</span> {
<a name="l09028"></a>09028             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3,<span class="stringliteral">&quot;Username not entered\n&quot;</span>);  
<a name="l09029"></a>09029             <span class="keywordflow">return</span> -1;
<a name="l09030"></a>09030          }
<a name="l09031"></a>09031       }
<a name="l09032"></a>09032       <span class="keywordflow">if</span> (useadsi)
<a name="l09033"></a>09033          <a class="code" href="app__voicemail_8c.html#a0c73425198917b11dde1f5b059175f47">adsi_password</a>(chan);
<a name="l09034"></a>09034 
<a name="l09035"></a>09035       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(prefix)) {
<a name="l09036"></a>09036          <span class="keywordtype">char</span> fullusername[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l09037"></a>09037          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(fullusername, prefix, <span class="keyword">sizeof</span>(fullusername));
<a name="l09038"></a>09038          strncat(fullusername, mailbox, <span class="keyword">sizeof</span>(fullusername) - 1 - strlen(fullusername));
<a name="l09039"></a>09039          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mailbox, fullusername, mailbox_size);
<a name="l09040"></a>09040       }
<a name="l09041"></a>09041 
<a name="l09042"></a>09042       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Before find user for mailbox %s\n&quot;</span>,mailbox);
<a name="l09043"></a>09043       vmu = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;vmus, context, mailbox);
<a name="l09044"></a>09044       <span class="keywordflow">if</span> (vmu &amp;&amp; (vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[0] == <span class="charliteral">&apos;\0&apos;</span> || (vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[0] == <span class="charliteral">&apos;-&apos;</span> &amp;&amp; vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>[1] == <span class="charliteral">&apos;\0&apos;</span>))) {
<a name="l09045"></a>09045          <span class="comment">/* saved password is blank, so don&apos;t bother asking */</span>
<a name="l09046"></a>09046          password[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09047"></a>09047       } <span class="keywordflow">else</span> {
<a name="l09048"></a>09048          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <a class="code" href="app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">vm_password</a>, chan-&gt;language)) {
<a name="l09049"></a>09049             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stream password file\n&quot;</span>);
<a name="l09050"></a>09050             <span class="keywordflow">return</span> -1;
<a name="l09051"></a>09051          }
<a name="l09052"></a>09052          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, password, <span class="keyword">sizeof</span>(password) - 1, 2000, 10000, <span class="stringliteral">&quot;#&quot;</span>) &lt; 0) {
<a name="l09053"></a>09053             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to read password\n&quot;</span>);
<a name="l09054"></a>09054             <span class="keywordflow">return</span> -1;
<a name="l09055"></a>09055          }
<a name="l09056"></a>09056       }
<a name="l09057"></a>09057 
<a name="l09058"></a>09058       <span class="keywordflow">if</span> (vmu) {
<a name="l09059"></a>09059          passptr = vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>;
<a name="l09060"></a>09060          <span class="keywordflow">if</span> (passptr[0] == <span class="charliteral">&apos;-&apos;</span>) passptr++;
<a name="l09061"></a>09061       }
<a name="l09062"></a>09062       <span class="keywordflow">if</span> (vmu &amp;&amp; !strcmp(passptr, password))
<a name="l09063"></a>09063          valid++;
<a name="l09064"></a>09064       <span class="keywordflow">else</span> {
<a name="l09065"></a>09065          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Incorrect password &apos;%s&apos; for user &apos;%s&apos; (context = %s)\n&quot;</span>, password, mailbox, context ? context : <span class="stringliteral">&quot;default&quot;</span>);
<a name="l09066"></a>09066          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(prefix))
<a name="l09067"></a>09067             mailbox[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09068"></a>09068       }
<a name="l09069"></a>09069       logretries++;
<a name="l09070"></a>09070       <span class="keywordflow">if</span> (!valid) {
<a name="l09071"></a>09071          <span class="keywordflow">if</span> (skipuser || logretries &gt;= max_logins) {
<a name="l09072"></a>09072             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-incorrect&quot;</span>, chan-&gt;language)) {
<a name="l09073"></a>09073                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stream incorrect message\n&quot;</span>);
<a name="l09074"></a>09074                <span class="keywordflow">return</span> -1;
<a name="l09075"></a>09075             }
<a name="l09076"></a>09076          } <span class="keywordflow">else</span> {
<a name="l09077"></a>09077             <span class="keywordflow">if</span> (useadsi)
<a name="l09078"></a>09078                <a class="code" href="app__voicemail_8c.html#a84250923008fa3be2ba9f54e1cc3298a">adsi_login</a>(chan);
<a name="l09079"></a>09079             <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-incorrect-mailbox&quot;</span>, chan-&gt;language)) {
<a name="l09080"></a>09080                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to stream incorrect mailbox message\n&quot;</span>);
<a name="l09081"></a>09081                <span class="keywordflow">return</span> -1;
<a name="l09082"></a>09082             }
<a name="l09083"></a>09083          }
<a name="l09084"></a>09084          <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>)) <span class="comment">/* Channel is hung up */</span>
<a name="l09085"></a>09085             <span class="keywordflow">return</span> -1;
<a name="l09086"></a>09086       }
<a name="l09087"></a>09087    }
<a name="l09088"></a>09088    <span class="keywordflow">if</span> (!valid &amp;&amp; (logretries &gt;= max_logins)) {
<a name="l09089"></a>09089       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l09090"></a>09090       <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);
<a name="l09091"></a>09091       <span class="keywordflow">return</span> -1;
<a name="l09092"></a>09092    }
<a name="l09093"></a>09093    <span class="keywordflow">if</span> (vmu &amp;&amp; !skipuser) {
<a name="l09094"></a>09094       memcpy(res_vmu, vmu, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a>));
<a name="l09095"></a>09095    }
<a name="l09096"></a>09096    <span class="keywordflow">return</span> 0;
<a name="l09097"></a>09097 }
<a name="l09098"></a>09098 
<a name="l09099"></a><a class="code" href="app__voicemail_8c.html#aba46cc3472f058c271aff3bf26a1064e">09099</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aba46cc3472f058c271aff3bf26a1064e">vm_execmain</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09100"></a>09100 {
<a name="l09101"></a>09101    <span class="comment">/* XXX This is, admittedly, some pretty horrendous code.  For some</span>
<a name="l09102"></a>09102 <span class="comment">      reason it just seemed a lot easier to do with GOTO&apos;s.  I feel</span>
<a name="l09103"></a>09103 <span class="comment">      like I&apos;m back in my GWBASIC days. XXX */</span>
<a name="l09104"></a>09104    <span class="keywordtype">int</span> res=-1;
<a name="l09105"></a>09105    <span class="keywordtype">int</span> cmd=0;
<a name="l09106"></a>09106    <span class="keywordtype">int</span> valid = 0;
<a name="l09107"></a>09107    <span class="keywordtype">char</span> prefixstr[80] =<span class="stringliteral">&quot;&quot;</span>;
<a name="l09108"></a>09108    <span class="keywordtype">char</span> ext_context[256]=<span class="stringliteral">&quot;&quot;</span>;
<a name="l09109"></a>09109    <span class="keywordtype">int</span> box;
<a name="l09110"></a>09110    <span class="keywordtype">int</span> useadsi = 0;
<a name="l09111"></a>09111    <span class="keywordtype">int</span> skipuser = 0;
<a name="l09112"></a>09112    <span class="keyword">struct </span><a class="code" href="structvm__state.html">vm_state</a> vms;
<a name="l09113"></a>09113    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu = NULL, vmus;
<a name="l09114"></a>09114    <span class="keywordtype">char</span> *context=NULL;
<a name="l09115"></a>09115    <span class="keywordtype">int</span> silentexit = 0;
<a name="l09116"></a>09116    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags = { 0 };
<a name="l09117"></a>09117    <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain = 0;
<a name="l09118"></a>09118    <span class="keywordtype">int</span> play_auto = 0;
<a name="l09119"></a>09119    <span class="keywordtype">int</span> play_folder = 0;
<a name="l09120"></a>09120    <span class="keywordtype">int</span> in_urgent = 0;
<a name="l09121"></a>09121 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l09122"></a>09122 <span class="preprocessor"></span>   <span class="keywordtype">int</span> deleted = 0;
<a name="l09123"></a>09123 <span class="preprocessor">#endif</span>
<a name="l09124"></a>09124 <span class="preprocessor"></span>
<a name="l09125"></a>09125    <span class="comment">/* Add the vm_state to the active list and keep it active */</span>
<a name="l09126"></a>09126    memset(&amp;vms, 0, <span class="keyword">sizeof</span>(vms));
<a name="l09127"></a>09127 
<a name="l09128"></a>09128    vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> = -1;
<a name="l09129"></a>09129 
<a name="l09130"></a>09130    memset(&amp;vmus, 0, <span class="keyword">sizeof</span>(vmus));
<a name="l09131"></a>09131 
<a name="l09132"></a>09132    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l09133"></a>09133       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Before ast_answer\n&quot;</span>);
<a name="l09134"></a>09134       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l09135"></a>09135    }
<a name="l09136"></a>09136 
<a name="l09137"></a>09137    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09138"></a>09138       <span class="keywordtype">char</span> *opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>];
<a name="l09139"></a>09139       <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l09140"></a>09140       <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l09141"></a>09141          <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(argv0);
<a name="l09142"></a>09142          <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(argv1);
<a name="l09143"></a>09143       );
<a name="l09144"></a>09144 
<a name="l09145"></a>09145       parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09146"></a>09146 
<a name="l09147"></a>09147       <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l09148"></a>09148 
<a name="l09149"></a>09149       <span class="keywordflow">if</span> (args.argc == 2) {
<a name="l09150"></a>09150          <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(vm_app_options, &amp;flags, opts, args.argv1))
<a name="l09151"></a>09151             <span class="keywordflow">return</span> -1;
<a name="l09152"></a>09152          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a>)) {
<a name="l09153"></a>09153             <span class="keywordtype">int</span> gain;
<a name="l09154"></a>09154             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(opts[<a class="code" href="app__minivm_8c.html#a7ff5f2dff38e7639981794c43dc9167ba0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a>])) {
<a name="l09155"></a>09155                <span class="keywordflow">if</span> (sscanf(opts[OPT_ARG_RECORDGAIN], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;gain) != 1) {
<a name="l09156"></a>09156                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &apos;%s&apos; provided for record gain option\n&quot;</span>, opts[OPT_ARG_RECORDGAIN]);
<a name="l09157"></a>09157                   <span class="keywordflow">return</span> -1;
<a name="l09158"></a>09158                } <span class="keywordflow">else</span> {
<a name="l09159"></a>09159                   record_gain = (<span class="keywordtype">signed</span> char) gain;
<a name="l09160"></a>09160                }
<a name="l09161"></a>09161             } <span class="keywordflow">else</span> {
<a name="l09162"></a>09162                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid Gain level set with option g\n&quot;</span>);
<a name="l09163"></a>09163             }
<a name="l09164"></a>09164          }
<a name="l09165"></a>09165          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae46e13cc6d4a1bfd34b1a4a939cf64f3">OPT_AUTOPLAY</a>) ) {
<a name="l09166"></a>09166             play_auto = 1;
<a name="l09167"></a>09167             <span class="keywordflow">if</span> (opts[<a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294cab3c235d8800fef13d32bda9908cb0599">OPT_ARG_PLAYFOLDER</a>]) {
<a name="l09168"></a>09168                <span class="keywordflow">if</span> (sscanf(opts[OPT_ARG_PLAYFOLDER], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;play_folder) != 1) {
<a name="l09169"></a>09169                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &apos;%s&apos; provided for folder autoplay option\n&quot;</span>, opts[OPT_ARG_PLAYFOLDER]);
<a name="l09170"></a>09170                }
<a name="l09171"></a>09171             } <span class="keywordflow">else</span> {
<a name="l09172"></a>09172                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid folder set with option a\n&quot;</span>);
<a name="l09173"></a>09173             }  
<a name="l09174"></a>09174             <span class="keywordflow">if</span> ( play_folder &gt; 9 || play_folder &lt; 0) {
<a name="l09175"></a>09175                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &apos;%d&apos; provided for folder autoplay option\n&quot;</span>, play_folder);
<a name="l09176"></a>09176                play_folder = 0;
<a name="l09177"></a>09177             }
<a name="l09178"></a>09178          }
<a name="l09179"></a>09179       } <span class="keywordflow">else</span> {
<a name="l09180"></a>09180          <span class="comment">/* old style options parsing */</span>
<a name="l09181"></a>09181          <span class="keywordflow">while</span> (*(args.argv0)) {
<a name="l09182"></a>09182             <span class="keywordflow">if</span> (*(args.argv0) == <span class="charliteral">&apos;s&apos;</span>)
<a name="l09183"></a>09183                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;flags, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);
<a name="l09184"></a>09184             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*(args.argv0) == <span class="charliteral">&apos;p&apos;</span>)
<a name="l09185"></a>09185                <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;flags, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a>);
<a name="l09186"></a>09186             <span class="keywordflow">else</span> 
<a name="l09187"></a>09187                <span class="keywordflow">break</span>;
<a name="l09188"></a>09188             (args.argv0)++;
<a name="l09189"></a>09189          }
<a name="l09190"></a>09190 
<a name="l09191"></a>09191       }
<a name="l09192"></a>09192 
<a name="l09193"></a>09193       valid = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a>);
<a name="l09194"></a>09194 
<a name="l09195"></a>09195       <span class="keywordflow">if</span> ((context = strchr(args.argv0, <span class="charliteral">&apos;@&apos;</span>)))
<a name="l09196"></a>09196          *context++ = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09197"></a>09197 
<a name="l09198"></a>09198       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba4707725f61e9b0b350f4dea90a9b6e01">OPT_PREPEND_MAILBOX</a>))
<a name="l09199"></a>09199          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(prefixstr, args.argv0, <span class="keyword">sizeof</span>(prefixstr));
<a name="l09200"></a>09200       <span class="keywordflow">else</span>
<a name="l09201"></a>09201          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, args.argv0, <span class="keyword">sizeof</span>(vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>));
<a name="l09202"></a>09202 
<a name="l09203"></a>09203       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>) &amp;&amp; (vmu = <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;vmus, context ,vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>)))
<a name="l09204"></a>09204          skipuser++;
<a name="l09205"></a>09205       <span class="keywordflow">else</span>
<a name="l09206"></a>09206          valid = 0;
<a name="l09207"></a>09207    }
<a name="l09208"></a>09208 
<a name="l09209"></a>09209    <span class="keywordflow">if</span> (!valid)
<a name="l09210"></a>09210       res = <a class="code" href="app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a>(chan, vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>), &amp;vmus, context, prefixstr, skipuser, <a class="code" href="app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">maxlogins</a>, 0);
<a name="l09211"></a>09211 
<a name="l09212"></a>09212    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;After vm_authenticate\n&quot;</span>);
<a name="l09213"></a>09213    <span class="keywordflow">if</span> (!res) {
<a name="l09214"></a>09214       valid = 1;
<a name="l09215"></a>09215       <span class="keywordflow">if</span> (!skipuser)
<a name="l09216"></a>09216          vmu = &amp;vmus;
<a name="l09217"></a>09217    } <span class="keywordflow">else</span> {
<a name="l09218"></a>09218       res = 0;
<a name="l09219"></a>09219    }
<a name="l09220"></a>09220 
<a name="l09221"></a>09221    <span class="comment">/* If ADSI is supported, setup login screen */</span>
<a name="l09222"></a>09222    <a class="code" href="app__voicemail_8c.html#a2632e0d8df527e365b09e974e75ffbc7">adsi_begin</a>(chan, &amp;useadsi);
<a name="l09223"></a>09223 
<a name="l09224"></a>09224    <span class="keywordflow">if</span> (!valid) {
<a name="l09225"></a>09225       <span class="keywordflow">goto</span> out;
<a name="l09226"></a>09226    }
<a name="l09227"></a>09227 
<a name="l09228"></a>09228 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l09229"></a>09229 <span class="preprocessor"></span>   pthread_once(&amp;ts_vmstate.once, ts_vmstate.key_init);
<a name="l09230"></a>09230    pthread_setspecific(ts_vmstate.key, &amp;vms);
<a name="l09231"></a>09231 
<a name="l09232"></a>09232    vms.interactive = 1;
<a name="l09233"></a>09233    vms.updated = 1;
<a name="l09234"></a>09234    <span class="keywordflow">if</span> (vmu)
<a name="l09235"></a>09235       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vms.<a class="code" href="structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="structvm__state.html#aa82b0f9cb665ad5b9c2516e9850e6a6b">context</a>));
<a name="l09236"></a>09236    vmstate_insert(&amp;vms);
<a name="l09237"></a>09237    init_vm_state(&amp;vms);
<a name="l09238"></a>09238 <span class="preprocessor">#endif</span>
<a name="l09239"></a>09239 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (!(vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)))) {
<a name="l09240"></a>09240       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not allocate memory for deleted message storage!\n&quot;</span>);
<a name="l09241"></a>09241       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;an-error-has-occured&quot;</span>);
<a name="l09242"></a>09242       <span class="keywordflow">return</span> -1;
<a name="l09243"></a>09243    }
<a name="l09244"></a>09244    <span class="keywordflow">if</span> (!(vms.<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">int</span>)))) {
<a name="l09245"></a>09245       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not allocate memory for heard message storage!\n&quot;</span>);
<a name="l09246"></a>09246       cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;an-error-has-occured&quot;</span>);
<a name="l09247"></a>09247       <span class="keywordflow">return</span> -1;
<a name="l09248"></a>09248    }
<a name="l09249"></a>09249    
<a name="l09250"></a>09250    <span class="comment">/* Set language from config to override channel language */</span>
<a name="l09251"></a>09251    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>))
<a name="l09252"></a>09252       <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan, <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>);
<a name="l09253"></a>09253 
<a name="l09254"></a>09254    <span class="comment">/* Retrieve urgent, old and new message counts */</span>
<a name="l09255"></a>09255    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Before open_mailbox\n&quot;</span>);
<a name="l09256"></a>09256    res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>); <span class="comment">/* Count all messages, even Urgent */</span>
<a name="l09257"></a>09257    <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09258"></a>09258       <span class="keywordflow">goto</span> out;
<a name="l09259"></a>09259    vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a> = vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1;
<a name="l09260"></a>09260    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Number of old messages: %d\n&quot;</span>,vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>);
<a name="l09261"></a>09261    <span class="comment">/* check INBOX */</span>
<a name="l09262"></a>09262    res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l09263"></a>09263    <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09264"></a>09264       <span class="keywordflow">goto</span> out;
<a name="l09265"></a>09265    vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> = vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1;
<a name="l09266"></a>09266    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Number of new messages: %d\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>);
<a name="l09267"></a>09267    <span class="comment">/* Start in Urgent */</span>
<a name="l09268"></a>09268    in_urgent = 1;
<a name="l09269"></a>09269    res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, 11); <span class="comment">/*11 is the Urgent folder */</span>
<a name="l09270"></a>09270    <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09271"></a>09271       <span class="keywordflow">goto</span> out;
<a name="l09272"></a>09272    vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> = vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1;
<a name="l09273"></a>09273    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Number of urgent messages: %d\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>);
<a name="l09274"></a>09274 
<a name="l09275"></a>09275    <span class="comment">/* Select proper mailbox FIRST!! */</span>
<a name="l09276"></a>09276    <span class="keywordflow">if</span> (play_auto) {
<a name="l09277"></a>09277       <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>) {
<a name="l09278"></a>09278          in_urgent = 1;
<a name="l09279"></a>09279          res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, 11);
<a name="l09280"></a>09280       } <span class="keywordflow">else</span> {
<a name="l09281"></a>09281          in_urgent = 0;
<a name="l09282"></a>09282          res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, play_folder);
<a name="l09283"></a>09283       }
<a name="l09284"></a>09284       <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09285"></a>09285          <span class="keywordflow">goto</span> out;
<a name="l09286"></a>09286 
<a name="l09287"></a>09287       <span class="comment">/* If there are no new messages, inform the user and hangup */</span>
<a name="l09288"></a>09288       <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> == -1) {
<a name="l09289"></a>09289          in_urgent = 0;
<a name="l09290"></a>09290          cmd = <a class="code" href="app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7" title="Top level method to invoke the language variant vm_browse_messages_XX function.">vm_browse_messages</a>(chan, &amp;vms, vmu);
<a name="l09291"></a>09291          res = 0;
<a name="l09292"></a>09292          <span class="keywordflow">goto</span> out;
<a name="l09293"></a>09293       }
<a name="l09294"></a>09294    } <span class="keywordflow">else</span> {
<a name="l09295"></a>09295       <span class="keywordflow">if</span> (!vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &amp;&amp; !vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) {
<a name="l09296"></a>09296          <span class="comment">/* If we only have old messages start here */</span>
<a name="l09297"></a>09297          res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603af55fd9d32663ca9220bebe6daf760530">OLD_FOLDER</a>); <span class="comment">/* Count all messages, even Urgent */</span>
<a name="l09298"></a>09298          in_urgent = 0;
<a name="l09299"></a>09299          play_folder = 1;
<a name="l09300"></a>09300          <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09301"></a>09301             <span class="keywordflow">goto</span> out;
<a name="l09302"></a>09302       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &amp;&amp; vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>) {
<a name="l09303"></a>09303          <span class="comment">/* If we have new messages but none are urgent */</span>
<a name="l09304"></a>09304          in_urgent = 0;
<a name="l09305"></a>09305          res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l09306"></a>09306          <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09307"></a>09307             <span class="keywordflow">goto</span> out;
<a name="l09308"></a>09308       }
<a name="l09309"></a>09309    }
<a name="l09310"></a>09310 
<a name="l09311"></a>09311    <span class="keywordflow">if</span> (useadsi)
<a name="l09312"></a>09312       <a class="code" href="app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a>(chan, &amp;vms);
<a name="l09313"></a>09313    res = 0;
<a name="l09314"></a>09314 
<a name="l09315"></a>09315    <span class="comment">/* Check to see if this is a new user */</span>
<a name="l09316"></a>09316    <span class="keywordflow">if</span> (!strcasecmp(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>) &amp;&amp; 
<a name="l09317"></a>09317       (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a> | <a class="code" href="app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>))) {
<a name="l09318"></a>09318       <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-newuser&quot;</span>) == -1)
<a name="l09319"></a>09319          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t stream new user file\n&quot;</span>);
<a name="l09320"></a>09320       cmd = <a class="code" href="app__voicemail_8c.html#ab43bc388c009596efb43c134433bfa1d">vm_newuser</a>(chan, vmu, &amp;vms, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, record_gain);
<a name="l09321"></a>09321       <span class="keywordflow">if</span> ((cmd == <span class="charliteral">&apos;t&apos;</span>) || (cmd == <span class="charliteral">&apos;#&apos;</span>)) {
<a name="l09322"></a>09322          <span class="comment">/* Timeout */</span>
<a name="l09323"></a>09323          res = 0;
<a name="l09324"></a>09324          <span class="keywordflow">goto</span> out;
<a name="l09325"></a>09325       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &lt; 0) {
<a name="l09326"></a>09326          <span class="comment">/* Hangup */</span>
<a name="l09327"></a>09327          res = -1;
<a name="l09328"></a>09328          <span class="keywordflow">goto</span> out;
<a name="l09329"></a>09329       }
<a name="l09330"></a>09330    }
<a name="l09331"></a>09331 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l09332"></a>09332 <span class="preprocessor"></span>      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Checking quotas: comparing %u to %u\n&quot;</span>,vms.quota_usage,vms.quota_limit);
<a name="l09333"></a>09333       <span class="keywordflow">if</span> (vms.quota_limit &amp;&amp; vms.quota_usage &gt;= vms.quota_limit) {
<a name="l09334"></a>09334          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;*** QUOTA EXCEEDED!!\n&quot;</span>);
<a name="l09335"></a>09335          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);
<a name="l09336"></a>09336       }
<a name="l09337"></a>09337       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Checking quotas: User has %d messages and limit is %d.\n&quot;</span>,(vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> + vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>),vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);
<a name="l09338"></a>09338       <span class="keywordflow">if</span> ((vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> + vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>) &gt;= vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>) {
<a name="l09339"></a>09339          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No more messages possible.  User has %d messages and limit is %d.\n&quot;</span>, (vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> + vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>), vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>);
<a name="l09340"></a>09340          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);
<a name="l09341"></a>09341       }
<a name="l09342"></a>09342 <span class="preprocessor">#endif</span>
<a name="l09343"></a>09343 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (play_auto) {
<a name="l09344"></a>09344       cmd = <span class="charliteral">&apos;1&apos;</span>;
<a name="l09345"></a>09345    } <span class="keywordflow">else</span> {
<a name="l09346"></a>09346       cmd = <a class="code" href="app__voicemail_8c.html#a52a9526aa84df7047ca4cb9edad78fa5">vm_intro</a>(chan, vmu, &amp;vms);
<a name="l09347"></a>09347    }
<a name="l09348"></a>09348 
<a name="l09349"></a>09349    vms.<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> = 0;
<a name="l09350"></a>09350    vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 1;
<a name="l09351"></a>09351    <span class="keywordflow">while</span> ((cmd &gt; -1) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>) &amp;&amp; (cmd != <span class="charliteral">&apos;#&apos;</span>)) {
<a name="l09352"></a>09352       <span class="comment">/* Run main menu */</span>
<a name="l09353"></a>09353       <span class="keywordflow">switch</span> (cmd) {
<a name="l09354"></a>09354       <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: <span class="comment">/* First message */</span>
<a name="l09355"></a>09355          vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;
<a name="l09356"></a>09356          <span class="comment">/* Fall through */</span>
<a name="l09357"></a>09357       <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>: <span class="comment">/* Play current message */</span>
<a name="l09358"></a>09358          cmd = <a class="code" href="app__voicemail_8c.html#a520e1cbd2171aa7abae658420d940fc7" title="Top level method to invoke the language variant vm_browse_messages_XX function.">vm_browse_messages</a>(chan, &amp;vms, vmu);
<a name="l09359"></a>09359          <span class="keywordflow">break</span>;
<a name="l09360"></a>09360       <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>: <span class="comment">/* Change folders */</span>
<a name="l09361"></a>09361          <span class="keywordflow">if</span> (useadsi)
<a name="l09362"></a>09362             <a class="code" href="app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a>(chan, 0, <span class="stringliteral">&quot;Change to folder...&quot;</span>);
<a name="l09363"></a>09363          cmd = <a class="code" href="app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6" title="plays a prompt and waits for a keypress.">get_folder2</a>(chan, <span class="stringliteral">&quot;vm-changeto&quot;</span>, 0);
<a name="l09364"></a>09364          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l09365"></a>09365             cmd = 0;
<a name="l09366"></a>09366          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &gt; 0) {
<a name="l09367"></a>09367             cmd = cmd - <span class="charliteral">&apos;0&apos;</span>;
<a name="l09368"></a>09368             res = <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09369"></a>09369             <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09370"></a>09370                <span class="keywordflow">goto</span> out;
<a name="l09371"></a>09371             <span class="comment">/* If folder is not urgent, set in_urgent to zero! */</span>
<a name="l09372"></a>09372             <span class="keywordflow">if</span> (cmd != 11) in_urgent = 0;
<a name="l09373"></a>09373             res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, cmd);
<a name="l09374"></a>09374             <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09375"></a>09375                <span class="keywordflow">goto</span> out;
<a name="l09376"></a>09376             play_folder = cmd;
<a name="l09377"></a>09377             cmd = 0;
<a name="l09378"></a>09378          }
<a name="l09379"></a>09379          <span class="keywordflow">if</span> (useadsi)
<a name="l09380"></a>09380             <a class="code" href="app__voicemail_8c.html#acf98df015fe3d94786514c85bbc05353">adsi_status2</a>(chan, &amp;vms);
<a name="l09381"></a>09381             
<a name="l09382"></a>09382          <span class="keywordflow">if</span> (!cmd)
<a name="l09383"></a>09383             cmd = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);
<a name="l09384"></a>09384 
<a name="l09385"></a>09385          vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 1;
<a name="l09386"></a>09386          <span class="keywordflow">break</span>;
<a name="l09387"></a>09387       <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>: <span class="comment">/* Advanced options */</span>
<a name="l09388"></a>09388          cmd = 0;
<a name="l09389"></a>09389          vms.<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> = 0;
<a name="l09390"></a>09390          <span class="keywordflow">while</span> ((cmd &gt; -1) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>) &amp;&amp; (cmd != <span class="charliteral">&apos;#&apos;</span>)) {
<a name="l09391"></a>09391             <span class="keywordflow">switch</span> (cmd) {
<a name="l09392"></a>09392             <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: <span class="comment">/* Reply */</span>
<a name="l09393"></a>09393                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1 &amp;&amp; !vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l09394"></a>09394                   cmd = <a class="code" href="app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921" title="The advanced options within a message.">advanced_options</a>(chan, vmu, &amp;vms, vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, 1, record_gain);
<a name="l09395"></a>09395                   <span class="keywordflow">if</span> (cmd == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09396"></a>09396                      res = cmd;
<a name="l09397"></a>09397                      <span class="keywordflow">goto</span> out;
<a name="l09398"></a>09398                   }
<a name="l09399"></a>09399                } <span class="keywordflow">else</span>
<a name="l09400"></a>09400                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l09401"></a>09401                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l09402"></a>09402                <span class="keywordflow">break</span>;
<a name="l09403"></a>09403             <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>: <span class="comment">/* Callback */</span>
<a name="l09404"></a>09404                <span class="keywordflow">if</span> (!vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>)
<a name="l09405"></a>09405                   <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Callback Requested\n&quot;</span>);
<a name="l09406"></a>09406                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>) &amp;&amp; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1 &amp;&amp; !vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l09407"></a>09407                   cmd = <a class="code" href="app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921" title="The advanced options within a message.">advanced_options</a>(chan, vmu, &amp;vms, vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, 2, record_gain);
<a name="l09408"></a>09408                   <span class="keywordflow">if</span> (cmd == 9) {
<a name="l09409"></a>09409                      silentexit = 1;
<a name="l09410"></a>09410                      <span class="keywordflow">goto</span> out;
<a name="l09411"></a>09411                   } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09412"></a>09412                      res = cmd;
<a name="l09413"></a>09413                      <span class="keywordflow">goto</span> out;
<a name="l09414"></a>09414                   }
<a name="l09415"></a>09415                } <span class="keywordflow">else</span> 
<a name="l09416"></a>09416                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l09417"></a>09417                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l09418"></a>09418                <span class="keywordflow">break</span>;
<a name="l09419"></a>09419             <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>: <span class="comment">/* Envelope */</span>
<a name="l09420"></a>09420                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1 &amp;&amp; !vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l09421"></a>09421                   cmd = <a class="code" href="app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921" title="The advanced options within a message.">advanced_options</a>(chan, vmu, &amp;vms, vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, 3, record_gain);
<a name="l09422"></a>09422                   <span class="keywordflow">if</span> (cmd == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09423"></a>09423                      res = cmd;
<a name="l09424"></a>09424                      <span class="keywordflow">goto</span> out;
<a name="l09425"></a>09425                   }
<a name="l09426"></a>09426                } <span class="keywordflow">else</span>
<a name="l09427"></a>09427                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l09428"></a>09428                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l09429"></a>09429                <span class="keywordflow">break</span>;
<a name="l09430"></a>09430             <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>: <span class="comment">/* Dialout */</span>
<a name="l09431"></a>09431                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {
<a name="l09432"></a>09432                   cmd = <a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(chan, vmu, NULL, vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>);
<a name="l09433"></a>09433                   <span class="keywordflow">if</span> (cmd == 9) {
<a name="l09434"></a>09434                      silentexit = 1;
<a name="l09435"></a>09435                      <span class="keywordflow">goto</span> out;
<a name="l09436"></a>09436                   }
<a name="l09437"></a>09437                } <span class="keywordflow">else</span> 
<a name="l09438"></a>09438                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l09439"></a>09439                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l09440"></a>09440                <span class="keywordflow">break</span>;
<a name="l09441"></a>09441 
<a name="l09442"></a>09442             <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>: <span class="comment">/* Leave VoiceMail */</span>
<a name="l09443"></a>09443                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>)) {
<a name="l09444"></a>09444                   cmd = <a class="code" href="app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c" title="Sends a voicemail message to a mailbox recipient.">forward_message</a>(chan, context, &amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, 1, record_gain, 0);
<a name="l09445"></a>09445                   <span class="keywordflow">if</span> (cmd == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09446"></a>09446                      res = cmd;
<a name="l09447"></a>09447                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;forward_message failed to lock path.\n&quot;</span>);
<a name="l09448"></a>09448                      <span class="keywordflow">goto</span> out;
<a name="l09449"></a>09449                   }
<a name="l09450"></a>09450                } <span class="keywordflow">else</span>
<a name="l09451"></a>09451                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan,<span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l09452"></a>09452                cmd=<span class="charliteral">&apos;t&apos;</span>;
<a name="l09453"></a>09453                <span class="keywordflow">break</span>;
<a name="l09454"></a>09454                
<a name="l09455"></a>09455             <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>: <span class="comment">/* Return to main menu */</span>
<a name="l09456"></a>09456                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l09457"></a>09457                <span class="keywordflow">break</span>;
<a name="l09458"></a>09458 
<a name="l09459"></a>09459             <span class="keywordflow">default</span>:
<a name="l09460"></a>09460                cmd = 0;
<a name="l09461"></a>09461                <span class="keywordflow">if</span> (!vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l09462"></a>09462                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toreply&quot;</span>);
<a name="l09463"></a>09463                }
<a name="l09464"></a>09464                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>) &amp;&amp; !vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> &amp;&amp; !cmd) {
<a name="l09465"></a>09465                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocallback&quot;</span>);
<a name="l09466"></a>09466                }
<a name="l09467"></a>09467                <span class="keywordflow">if</span> (!cmd &amp;&amp; !vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l09468"></a>09468                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tohearenv&quot;</span>);
<a name="l09469"></a>09469                }
<a name="l09470"></a>09470                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>) &amp;&amp; !cmd) {
<a name="l09471"></a>09471                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tomakecall&quot;</span>);
<a name="l09472"></a>09472                }
<a name="l09473"></a>09473                <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>) &amp;&amp; !cmd)
<a name="l09474"></a>09474                   cmd=<a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-leavemsg&quot;</span>);
<a name="l09475"></a>09475                <span class="keywordflow">if</span> (!cmd)
<a name="l09476"></a>09476                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-starmain&quot;</span>);
<a name="l09477"></a>09477                <span class="keywordflow">if</span> (!cmd)
<a name="l09478"></a>09478                   cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan,6000);
<a name="l09479"></a>09479                <span class="keywordflow">if</span> (!cmd)
<a name="l09480"></a>09480                   vms.<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a>++;
<a name="l09481"></a>09481                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> &gt; 3)
<a name="l09482"></a>09482                   cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l09483"></a>09483             }
<a name="l09484"></a>09484          }
<a name="l09485"></a>09485          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;t&apos;</span>) {
<a name="l09486"></a>09486             cmd = 0;
<a name="l09487"></a>09487             vms.<a class="code" href="structvm__state.html#a6d81f902729a57d095fa343793596c1e">repeats</a> = 0;
<a name="l09488"></a>09488          }
<a name="l09489"></a>09489          <span class="keywordflow">break</span>;
<a name="l09490"></a>09490       <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>: <span class="comment">/* Go to the previous message */</span>
<a name="l09491"></a>09491          <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt; 0) {
<a name="l09492"></a>09492             vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>--;
<a name="l09493"></a>09493             cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09494"></a>09494          } <span class="keywordflow">else</span> {
<a name="l09495"></a>09495             <span class="comment">/* Check if we were listening to new</span>
<a name="l09496"></a>09496 <span class="comment">               messages.  If so, go to Urgent messages</span>
<a name="l09497"></a>09497 <span class="comment">               instead of saying &quot;no more messages&quot;</span>
<a name="l09498"></a>09498 <span class="comment">            */</span>
<a name="l09499"></a>09499             <span class="keywordflow">if</span> (in_urgent == 0 &amp;&amp; vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a> &gt; 0) {
<a name="l09500"></a>09500                <span class="comment">/* Check for Urgent messages */</span>
<a name="l09501"></a>09501                in_urgent = 1;
<a name="l09502"></a>09502                res = <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09503"></a>09503                <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09504"></a>09504                   <span class="keywordflow">goto</span> out;
<a name="l09505"></a>09505                res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, 11);  <span class="comment">/* Open Urgent folder */</span>
<a name="l09506"></a>09506                <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09507"></a>09507                   <span class="keywordflow">goto</span> out;
<a name="l09508"></a>09508                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No more new messages, opened INBOX and got %d Urgent messages\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);
<a name="l09509"></a>09509                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;
<a name="l09510"></a>09510                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0)
<a name="l09511"></a>09511                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09512"></a>09512             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {
<a name="l09513"></a>09513                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>;
<a name="l09514"></a>09514                cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09515"></a>09515             } <span class="keywordflow">else</span> {
<a name="l09516"></a>09516                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09517"></a>09517             }
<a name="l09518"></a>09518          }
<a name="l09519"></a>09519          <span class="keywordflow">break</span>;
<a name="l09520"></a>09520       <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>: <span class="comment">/* Go to the next message */</span>
<a name="l09521"></a>09521          <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l09522"></a>09522             vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;
<a name="l09523"></a>09523             cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09524"></a>09524          } <span class="keywordflow">else</span> {
<a name="l09525"></a>09525             <span class="keywordflow">if</span> (in_urgent &amp;&amp; vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) {
<a name="l09526"></a>09526                <span class="comment">/* Check if we were listening to urgent</span>
<a name="l09527"></a>09527 <span class="comment">                * messages.  If so, go to regular new messages</span>
<a name="l09528"></a>09528 <span class="comment">                * instead of saying &quot;no more messages&quot;</span>
<a name="l09529"></a>09529 <span class="comment">                */</span>
<a name="l09530"></a>09530                in_urgent = 0;
<a name="l09531"></a>09531                res = <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09532"></a>09532                <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09533"></a>09533                   <span class="keywordflow">goto</span> out;
<a name="l09534"></a>09534                res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l09535"></a>09535                <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09536"></a>09536                   <span class="keywordflow">goto</span> out;
<a name="l09537"></a>09537                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);
<a name="l09538"></a>09538                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;
<a name="l09539"></a>09539                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0) {
<a name="l09540"></a>09540                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09541"></a>09541                }
<a name="l09542"></a>09542             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {
<a name="l09543"></a>09543                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;
<a name="l09544"></a>09544                cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09545"></a>09545             } <span class="keywordflow">else</span> {
<a name="l09546"></a>09546                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09547"></a>09547             }
<a name="l09548"></a>09548          }
<a name="l09549"></a>09549          <span class="keywordflow">break</span>;
<a name="l09550"></a>09550       <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>: <span class="comment">/* Delete the current message */</span>
<a name="l09551"></a>09551          <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt;= 0 &amp;&amp; vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt;= vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l09552"></a>09552             vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = !vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>];
<a name="l09553"></a>09553             <span class="keywordflow">if</span> (useadsi)
<a name="l09554"></a>09554                <a class="code" href="app__voicemail_8c.html#a592ba317beefe6a1db0f55adf1e6d0d4">adsi_delete</a>(chan, &amp;vms);
<a name="l09555"></a>09555             <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>]) {
<a name="l09556"></a>09556                <span class="keywordflow">if</span> (play_folder == 0) {
<a name="l09557"></a>09557                   <span class="keywordflow">if</span> (in_urgent) {
<a name="l09558"></a>09558                      vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>--;
<a name="l09559"></a>09559                   } <span class="keywordflow">else</span> {
<a name="l09560"></a>09560                      vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>--;
<a name="l09561"></a>09561                   }
<a name="l09562"></a>09562                }
<a name="l09563"></a>09563                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (play_folder == 1)
<a name="l09564"></a>09564                   vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>--;
<a name="l09565"></a>09565                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-deleted&quot;</span>);
<a name="l09566"></a>09566             } <span class="keywordflow">else</span> {
<a name="l09567"></a>09567                <span class="keywordflow">if</span> (play_folder == 0) {
<a name="l09568"></a>09568                   <span class="keywordflow">if</span> (in_urgent) {
<a name="l09569"></a>09569                      vms.<a class="code" href="structvm__state.html#a1051ba897840656830c47c213332b1a5">urgentmessages</a>++;
<a name="l09570"></a>09570                   } <span class="keywordflow">else</span> {
<a name="l09571"></a>09571                      vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a>++;
<a name="l09572"></a>09572                   }
<a name="l09573"></a>09573                }
<a name="l09574"></a>09574                <span class="keywordflow">else</span> <span class="keywordflow">if</span> (play_folder == 1)
<a name="l09575"></a>09575                   vms.<a class="code" href="structvm__state.html#aef5ca4e8463cbf34719addd12f7bf3d5">oldmessages</a>++;
<a name="l09576"></a>09576                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-undeleted&quot;</span>);
<a name="l09577"></a>09577             }
<a name="l09578"></a>09578             <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>)) {
<a name="l09579"></a>09579                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l09580"></a>09580                   vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;
<a name="l09581"></a>09581                   cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09582"></a>09582                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {
<a name="l09583"></a>09583                   vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;
<a name="l09584"></a>09584                   cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09585"></a>09585                } <span class="keywordflow">else</span> {
<a name="l09586"></a>09586                   <span class="comment">/* Check if we were listening to urgent</span>
<a name="l09587"></a>09587 <span class="comment">                     messages.  If so, go to regular new messages</span>
<a name="l09588"></a>09588 <span class="comment">                     instead of saying &quot;no more messages&quot;</span>
<a name="l09589"></a>09589 <span class="comment">                  */</span>
<a name="l09590"></a>09590                   <span class="keywordflow">if</span> (in_urgent == 1) {
<a name="l09591"></a>09591                      <span class="comment">/* Check for new messages */</span>
<a name="l09592"></a>09592                      in_urgent = 0;
<a name="l09593"></a>09593                      res = <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09594"></a>09594                      <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09595"></a>09595                         <span class="keywordflow">goto</span> out;
<a name="l09596"></a>09596                      res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l09597"></a>09597                      <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09598"></a>09598                         <span class="keywordflow">goto</span> out;
<a name="l09599"></a>09599                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);
<a name="l09600"></a>09600                      vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;
<a name="l09601"></a>09601                      <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0)
<a name="l09602"></a>09602                         cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09603"></a>09603                   } <span class="keywordflow">else</span> {
<a name="l09604"></a>09604                      cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09605"></a>09605                   }
<a name="l09606"></a>09606                }
<a name="l09607"></a>09607             }
<a name="l09608"></a>09608          } <span class="keywordflow">else</span> <span class="comment">/* Delete not valid if we haven&apos;t selected a message */</span>
<a name="l09609"></a>09609             cmd = 0;
<a name="l09610"></a>09610 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l09611"></a>09611 <span class="preprocessor"></span>         deleted = 1;
<a name="l09612"></a>09612 <span class="preprocessor">#endif</span>
<a name="l09613"></a>09613 <span class="preprocessor"></span>         <span class="keywordflow">break</span>;
<a name="l09614"></a>09614    
<a name="l09615"></a>09615       <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>: <span class="comment">/* Forward the current messgae */</span>
<a name="l09616"></a>09616          <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; -1) {
<a name="l09617"></a>09617             cmd = <a class="code" href="app__voicemail_8c.html#ad1fbdf312bcc5372c9cc5836920b1d6c" title="Sends a voicemail message to a mailbox recipient.">forward_message</a>(chan, context, &amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, 0, record_gain, in_urgent);
<a name="l09618"></a>09618             <span class="keywordflow">if</span> (cmd == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09619"></a>09619                res = cmd;
<a name="l09620"></a>09620                <span class="keywordflow">goto</span> out;
<a name="l09621"></a>09621             }
<a name="l09622"></a>09622          } <span class="keywordflow">else</span> {
<a name="l09623"></a>09623             <span class="comment">/* Check if we were listening to urgent</span>
<a name="l09624"></a>09624 <span class="comment">               messages.  If so, go to regular new messages</span>
<a name="l09625"></a>09625 <span class="comment">               instead of saying &quot;no more messages&quot;</span>
<a name="l09626"></a>09626 <span class="comment">            */</span>
<a name="l09627"></a>09627             <span class="keywordflow">if</span> (in_urgent == 1 &amp;&amp; vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) {
<a name="l09628"></a>09628                <span class="comment">/* Check for new messages */</span>
<a name="l09629"></a>09629                in_urgent = 0;
<a name="l09630"></a>09630                res = <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09631"></a>09631                <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09632"></a>09632                   <span class="keywordflow">goto</span> out;
<a name="l09633"></a>09633                res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l09634"></a>09634                <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09635"></a>09635                   <span class="keywordflow">goto</span> out;
<a name="l09636"></a>09636                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);
<a name="l09637"></a>09637                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;
<a name="l09638"></a>09638                <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0)
<a name="l09639"></a>09639                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09640"></a>09640             } <span class="keywordflow">else</span> {
<a name="l09641"></a>09641                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09642"></a>09642             }
<a name="l09643"></a>09643          }
<a name="l09644"></a>09644          <span class="keywordflow">break</span>;
<a name="l09645"></a>09645       <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>: <span class="comment">/* Save message to folder */</span>
<a name="l09646"></a>09646          <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; 0 || vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &gt; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l09647"></a>09647             <span class="comment">/* No message selected */</span>
<a name="l09648"></a>09648             cmd = 0;
<a name="l09649"></a>09649             <span class="keywordflow">break</span>;
<a name="l09650"></a>09650          }
<a name="l09651"></a>09651          <span class="keywordflow">if</span> (useadsi)
<a name="l09652"></a>09652             <a class="code" href="app__voicemail_8c.html#a12d07d7662dd94386a312ef17ade18f5">adsi_folders</a>(chan, 1, <span class="stringliteral">&quot;Save to folder...&quot;</span>);
<a name="l09653"></a>09653          cmd = <a class="code" href="app__voicemail_8c.html#a8ff15b65c3b44614e084af8cd71a61b6" title="plays a prompt and waits for a keypress.">get_folder2</a>(chan, <span class="stringliteral">&quot;vm-savefolder&quot;</span>, 1);
<a name="l09654"></a>09654          box = 0; <span class="comment">/* Shut up compiler */</span>
<a name="l09655"></a>09655          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;#&apos;</span>) {
<a name="l09656"></a>09656             cmd = 0;
<a name="l09657"></a>09657             <span class="keywordflow">break</span>;
<a name="l09658"></a>09658          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd &gt; 0) {
<a name="l09659"></a>09659             box = cmd = cmd - <span class="charliteral">&apos;0&apos;</span>;
<a name="l09660"></a>09660             cmd = <a class="code" href="app__voicemail_8c.html#a1cec50a2281ad7263c1cf7959ed79632">save_to_folder</a>(vmu, &amp;vms, vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, cmd);
<a name="l09661"></a>09661             <span class="keywordflow">if</span> (cmd == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09662"></a>09662                res = cmd;
<a name="l09663"></a>09663                <span class="keywordflow">goto</span> out;
<a name="l09664"></a>09664 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l09665"></a>09665 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!cmd) {
<a name="l09666"></a>09666                vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 1;
<a name="l09667"></a>09667 <span class="preprocessor">#endif</span>
<a name="l09668"></a>09668 <span class="preprocessor"></span>            } <span class="keywordflow">else</span> {
<a name="l09669"></a>09669                vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>[vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 0;
<a name="l09670"></a>09670                vms.<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>] = 0;
<a name="l09671"></a>09671             }
<a name="l09672"></a>09672          }
<a name="l09673"></a>09673          <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms.<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms.<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);
<a name="l09674"></a>09674          <span class="keywordflow">if</span> (useadsi)
<a name="l09675"></a>09675             <a class="code" href="app__voicemail_8c.html#a5e4fd0e364e72e18607259fe6d1f46cd">adsi_message</a>(chan, &amp;vms);
<a name="l09676"></a>09676          snprintf(vms.<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms.<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), <span class="stringliteral">&quot;vm-%s&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>(box));
<a name="l09677"></a>09677          <span class="keywordflow">if</span> (!cmd) {
<a name="l09678"></a>09678             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-message&quot;</span>);
<a name="l09679"></a>09679             <span class="keywordflow">if</span> (!cmd) 
<a name="l09680"></a>09680                cmd = <a class="code" href="app__voicemail_8c.html#a2724cf00d9e64469d126a23ff80770c7">say_and_wait</a>(chan, vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> + 1, chan-&gt;language);
<a name="l09681"></a>09681             <span class="keywordflow">if</span> (!cmd)
<a name="l09682"></a>09682                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-savedto&quot;</span>);
<a name="l09683"></a>09683             <span class="keywordflow">if</span> (!cmd)
<a name="l09684"></a>09684                cmd = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l09685"></a>09685          } <span class="keywordflow">else</span> {
<a name="l09686"></a>09686             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-mailboxfull&quot;</span>);
<a name="l09687"></a>09687          }
<a name="l09688"></a>09688          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>)) {
<a name="l09689"></a>09689             <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> &lt; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a>) {
<a name="l09690"></a>09690                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>++;
<a name="l09691"></a>09691                cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09692"></a>09692             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>) &amp;&amp; vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &gt; 0) {
<a name="l09693"></a>09693                vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = 0;
<a name="l09694"></a>09694                cmd = <a class="code" href="app__voicemail_8c.html#a7cb6e4d2a6cf5eccead170cac7517d8c">play_message</a>(chan, vmu, &amp;vms);
<a name="l09695"></a>09695             } <span class="keywordflow">else</span> {
<a name="l09696"></a>09696                <span class="comment">/* Check if we were listening to urgent</span>
<a name="l09697"></a>09697 <span class="comment">                  messages.  If so, go to regular new messages</span>
<a name="l09698"></a>09698 <span class="comment">                  instead of saying &quot;no more messages&quot;</span>
<a name="l09699"></a>09699 <span class="comment">               */</span>
<a name="l09700"></a>09700                <span class="keywordflow">if</span> (in_urgent == 1 &amp;&amp; vms.<a class="code" href="structvm__state.html#a661d8b405850d3a0c8aaa328b2b06fd1">newmessages</a> &gt; 0) {
<a name="l09701"></a>09701                   <span class="comment">/* Check for new messages */</span>
<a name="l09702"></a>09702                   in_urgent = 0;
<a name="l09703"></a>09703                   res = <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09704"></a>09704                   <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09705"></a>09705                      <span class="keywordflow">goto</span> out;
<a name="l09706"></a>09706                   res = <a class="code" href="app__voicemail_8c.html#a8315b0ac46c7de2ae3b6b79bf8a9fcbc">open_mailbox</a>(&amp;vms, vmu, <a class="code" href="app__voicemail_8c.html#aedcf2109f459315e1a7f2af73ec9b603a34081af5a88436b3a96b513fe17878c1">NEW_FOLDER</a>);
<a name="l09707"></a>09707                   <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>)
<a name="l09708"></a>09708                      <span class="keywordflow">goto</span> out;
<a name="l09709"></a>09709                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No more urgent messages, opened INBOX and got %d new messages\n&quot;</span>,vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> + 1);
<a name="l09710"></a>09710                   vms.<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a> = -1;
<a name="l09711"></a>09711                   <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a11dec1601684237c86e01cdb42901ace">lastmsg</a> &lt; 0)
<a name="l09712"></a>09712                      cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09713"></a>09713                } <span class="keywordflow">else</span> {
<a name="l09714"></a>09714                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nomore&quot;</span>);
<a name="l09715"></a>09715                }
<a name="l09716"></a>09716             }
<a name="l09717"></a>09717          }
<a name="l09718"></a>09718          <span class="keywordflow">break</span>;
<a name="l09719"></a>09719       <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>: <span class="comment">/* Help */</span>
<a name="l09720"></a>09720          <span class="keywordflow">if</span> (!vms.<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a>) {
<a name="l09721"></a>09721             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-onefor&quot;</span>);
<a name="l09722"></a>09722             <span class="keywordflow">if</span> (!strncasecmp(chan-&gt;language, <span class="stringliteral">&quot;he&quot;</span>, 2)) {
<a name="l09723"></a>09723                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-for&quot;</span>);
<a name="l09724"></a>09724             }
<a name="l09725"></a>09725             <span class="keywordflow">if</span> (!cmd)
<a name="l09726"></a>09726                cmd = <a class="code" href="app__voicemail_8c.html#adca07b25adb77cf322868e73ba5a39c8">vm_play_folder_name</a>(chan, vms.<a class="code" href="structvm__state.html#aeac36e072112b058cf05376bc10170a9">vmbox</a>);
<a name="l09727"></a>09727             <span class="keywordflow">if</span> (!cmd)
<a name="l09728"></a>09728                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-opts&quot;</span>);
<a name="l09729"></a>09729             <span class="keywordflow">if</span> (!cmd)
<a name="l09730"></a>09730                cmd = <a class="code" href="app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(chan, vmu, &amp;vms, 1, in_urgent);
<a name="l09731"></a>09731          } <span class="keywordflow">else</span>
<a name="l09732"></a>09732             cmd = 0;
<a name="l09733"></a>09733          <span class="keywordflow">break</span>;
<a name="l09734"></a>09734       <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>: <span class="comment">/* Mailbox options */</span>
<a name="l09735"></a>09735          cmd = <a class="code" href="app__voicemail_8c.html#ab38caff0330c37e2ce31314733755404">vm_options</a>(chan, vmu, &amp;vms, <a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, record_gain);
<a name="l09736"></a>09736          <span class="keywordflow">if</span> (useadsi)
<a name="l09737"></a>09737             <a class="code" href="app__voicemail_8c.html#a7ddd9d0b860a368069624140abecbbbc">adsi_status</a>(chan, &amp;vms);
<a name="l09738"></a>09738          <span class="keywordflow">break</span>;
<a name="l09739"></a>09739       <span class="keywordflow">default</span>: <span class="comment">/* Nothing */</span>
<a name="l09740"></a>09740          cmd = <a class="code" href="app__voicemail_8c.html#ade618edc558143e7341a4f3f25cabe60">vm_instructions</a>(chan, vmu, &amp;vms, 0, in_urgent);
<a name="l09741"></a>09741          <span class="keywordflow">break</span>;
<a name="l09742"></a>09742       }
<a name="l09743"></a>09743    }
<a name="l09744"></a>09744    <span class="keywordflow">if</span> ((cmd == <span class="charliteral">&apos;t&apos;</span>) || (cmd == <span class="charliteral">&apos;#&apos;</span>)) {
<a name="l09745"></a>09745       <span class="comment">/* Timeout */</span>
<a name="l09746"></a>09746       res = 0;
<a name="l09747"></a>09747    } <span class="keywordflow">else</span> {
<a name="l09748"></a>09748       <span class="comment">/* Hangup */</span>
<a name="l09749"></a>09749       res = -1;
<a name="l09750"></a>09750    }
<a name="l09751"></a>09751 
<a name="l09752"></a>09752 out:
<a name="l09753"></a>09753    <span class="keywordflow">if</span> (res &gt; -1) {
<a name="l09754"></a>09754       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l09755"></a>09755       <a class="code" href="app__voicemail_8c.html#a91eea11f926632631350a2c9678525aa">adsi_goodbye</a>(chan);
<a name="l09756"></a>09756       <span class="keywordflow">if</span> (valid) {
<a name="l09757"></a>09757          <span class="keywordflow">if</span> (silentexit)
<a name="l09758"></a>09758             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-dialout&quot;</span>);
<a name="l09759"></a>09759          <span class="keywordflow">else</span> 
<a name="l09760"></a>09760             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);
<a name="l09761"></a>09761          <span class="keywordflow">if</span> (res &gt; 0)
<a name="l09762"></a>09762             res = 0;
<a name="l09763"></a>09763       }
<a name="l09764"></a>09764       <span class="keywordflow">if</span> (useadsi)
<a name="l09765"></a>09765          <a class="code" href="adsi_8h.html#aa65291a80a241bda57a53d4f26ec5bed">ast_adsi_unload_session</a>(chan);
<a name="l09766"></a>09766    }
<a name="l09767"></a>09767    <span class="keywordflow">if</span> (vmu)
<a name="l09768"></a>09768       <a class="code" href="app__voicemail_8c.html#a134460fff8dee50c51edf76e5dd3a76b">close_mailbox</a>(&amp;vms, vmu);
<a name="l09769"></a>09769    <span class="keywordflow">if</span> (valid) {
<a name="l09770"></a>09770       <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;
<a name="l09771"></a>09771       snprintf(ext_context, <span class="keyword">sizeof</span>(ext_context), <span class="stringliteral">&quot;%s@%s&quot;</span>, vms.<a class="code" href="structvm__state.html#a60b121e87a5e71fe64bae70e1721ac3c">username</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l09772"></a>09772       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MessageWaiting&quot;</span>, <span class="stringliteral">&quot;Mailbox: %s\r\nWaiting: %d\r\n&quot;</span>, ext_context, <a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7" title="Determines if the given folder has messages.">has_voicemail</a>(ext_context, NULL));
<a name="l09773"></a>09773       <span class="comment">/* Urgent flag not passwd to externnotify here */</span>
<a name="l09774"></a>09774       <a class="code" href="app__voicemail_8c.html#a9c5687a6ba659f56c96ebc103673d85a">run_externnotify</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, NULL);
<a name="l09775"></a>09775       <a class="code" href="app_8h.html#a6f9a8f7a54dd80f1b5363b6cadfd4939" title="Determine number of urgent/new/old messages in a mailbox.">ast_app_inboxcount2</a>(ext_context, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);
<a name="l09776"></a>09776       <a class="code" href="app__voicemail_8c.html#a953cfa381bf19b85e5f9c90c0d72407a">queue_mwi_event</a>(ext_context, urgent, <span class="keyword">new</span>, old);
<a name="l09777"></a>09777    }
<a name="l09778"></a>09778 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l09779"></a>09779 <span class="preprocessor"></span>   <span class="comment">/* expunge message - use UID Expunge if supported on IMAP server*/</span>
<a name="l09780"></a>09780    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;*** Checking if we can expunge, deleted set to %d, expungeonhangup set to %d\n&quot;</span>,deleted,expungeonhangup);
<a name="l09781"></a>09781    <span class="keywordflow">if</span> (vmu &amp;&amp; deleted == 1 &amp;&amp; expungeonhangup == 1 &amp;&amp; vms.mailstream != NULL) {
<a name="l09782"></a>09782       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;vms.lock);
<a name="l09783"></a>09783 <span class="preprocessor">#ifdef HAVE_IMAP_TK2006</span>
<a name="l09784"></a>09784 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (LEVELUIDPLUS (vms.mailstream)) {
<a name="l09785"></a>09785          mail_expunge_full(vms.mailstream,NIL,EX_UID);
<a name="l09786"></a>09786       } <span class="keywordflow">else</span> 
<a name="l09787"></a>09787 <span class="preprocessor">#endif</span>
<a name="l09788"></a>09788 <span class="preprocessor"></span>         mail_expunge(vms.mailstream);
<a name="l09789"></a>09789       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;vms.lock);
<a name="l09790"></a>09790    }
<a name="l09791"></a>09791    <span class="comment">/*  before we delete the state, we should copy pertinent info</span>
<a name="l09792"></a>09792 <span class="comment">    *  back to the persistent model */</span>
<a name="l09793"></a>09793    <span class="keywordflow">if</span> (vmu) {
<a name="l09794"></a>09794       vmstate_delete(&amp;vms);
<a name="l09795"></a>09795    }
<a name="l09796"></a>09796 <span class="preprocessor">#endif</span>
<a name="l09797"></a>09797 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (vmu)
<a name="l09798"></a>09798       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(vmu);
<a name="l09799"></a>09799    <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>)
<a name="l09800"></a>09800       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms.<a class="code" href="structvm__state.html#a2bfed4d96614bbf76d9e6ab43d3b8d42">deleted</a>);
<a name="l09801"></a>09801    <span class="keywordflow">if</span> (vms.<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>)
<a name="l09802"></a>09802       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(vms.<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>);
<a name="l09803"></a>09803 
<a name="l09804"></a>09804 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l09805"></a>09805 <span class="preprocessor"></span>   pthread_setspecific(ts_vmstate.key, NULL);
<a name="l09806"></a>09806 <span class="preprocessor">#endif</span>
<a name="l09807"></a>09807 <span class="preprocessor"></span>   <span class="keywordflow">return</span> res;
<a name="l09808"></a>09808 }
<a name="l09809"></a>09809 
<a name="l09810"></a><a class="code" href="app__voicemail_8c.html#a8506f88c9481bf3508695725d6beb0f6">09810</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a8506f88c9481bf3508695725d6beb0f6">vm_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l09811"></a>09811 {
<a name="l09812"></a>09812    <span class="keywordtype">int</span> res = 0;
<a name="l09813"></a>09813    <span class="keywordtype">char</span> *tmp;
<a name="l09814"></a>09814    <span class="keyword">struct </span><a class="code" href="structleave__vm__options.html" title="Options for leaving voicemail with the voicemail() application.">leave_vm_options</a> leave_options;
<a name="l09815"></a>09815    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> flags = { 0 };
<a name="l09816"></a>09816    <span class="keywordtype">char</span> *opts[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>];
<a name="l09817"></a>09817    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l09818"></a>09818       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(argv0);
<a name="l09819"></a>09819       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(argv1);
<a name="l09820"></a>09820    );
<a name="l09821"></a>09821    
<a name="l09822"></a>09822    memset(&amp;leave_options, 0, <span class="keyword">sizeof</span>(leave_options));
<a name="l09823"></a>09823 
<a name="l09824"></a>09824    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l09825"></a>09825       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l09826"></a>09826 
<a name="l09827"></a>09827    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09828"></a>09828       tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09829"></a>09829       <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, tmp);
<a name="l09830"></a>09830       <span class="keywordflow">if</span> (args.argc == 2) {
<a name="l09831"></a>09831          <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(vm_app_options, &amp;flags, opts, args.argv1))
<a name="l09832"></a>09832             <span class="keywordflow">return</span> -1;
<a name="l09833"></a>09833          <a class="code" href="utils_8h.html#ab9da1c7265610eff83ed6146f104dc6f">ast_copy_flags</a>(&amp;leave_options, &amp;flags, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a9c6a0359498684912cb0a3810e03138d">OPT_SILENT</a> | <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6021f80ddb5561e6e07a285ea47b086e">OPT_BUSY_GREETING</a> | <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a96240d093eacd367dd06de745d12e559">OPT_UNAVAIL_GREETING</a> | <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47bae021f439fd94915a5a0b750b7bd9e1b0">OPT_MESSAGE_Urgent</a> | <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47ba3ab39b91a9114a34f145da5f96ac7fce">OPT_MESSAGE_PRIORITY</a> | <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>);
<a name="l09834"></a>09834          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__minivm_8c.html#ae4d5251432e1a9e6803c0240cc492e18a6f62412bc497c9dd7db876c7ea4f9cfd">OPT_RECORDGAIN</a>)) {
<a name="l09835"></a>09835             <span class="keywordtype">int</span> gain;
<a name="l09836"></a>09836 
<a name="l09837"></a>09837             <span class="keywordflow">if</span> (sscanf(opts[<a class="code" href="app__minivm_8c.html#a7ff5f2dff38e7639981794c43dc9167ba0ba3410dc4adff3119e1a4007cf90a7d">OPT_ARG_RECORDGAIN</a>], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;gain) != 1) {
<a name="l09838"></a>09838                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &apos;%s&apos; provided for record gain option\n&quot;</span>, opts[OPT_ARG_RECORDGAIN]);
<a name="l09839"></a>09839                <span class="keywordflow">return</span> -1;
<a name="l09840"></a>09840             } <span class="keywordflow">else</span> {
<a name="l09841"></a>09841                leave_options.<a class="code" href="structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a> = (<span class="keywordtype">signed</span> char) gain;
<a name="l09842"></a>09842             }
<a name="l09843"></a>09843          }
<a name="l09844"></a>09844          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;flags, <a class="code" href="app__voicemail_8c.html#a900dca9b26de42491763226e12dcd47baa4ee26176df97bdd791bab6e4000c945">OPT_DTMFEXIT</a>)) {
<a name="l09845"></a>09845             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(opts[<a class="code" href="app__voicemail_8c.html#a1be3860693af99a6c1da72580097294caf287dd95d8f656a0423cc51f3f63e1c5">OPT_ARG_DTMFEXIT</a>]))
<a name="l09846"></a>09846                leave_options.<a class="code" href="structleave__vm__options.html#a5125979a5deda764b319cf472c97ac81">exitcontext</a> = opts[OPT_ARG_DTMFEXIT];
<a name="l09847"></a>09847          }
<a name="l09848"></a>09848       }
<a name="l09849"></a>09849    } <span class="keywordflow">else</span> {
<a name="l09850"></a>09850       <span class="keywordtype">char</span> temp[256];
<a name="l09851"></a>09851       res = <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;vm-whichbox&quot;</span>, temp, <span class="keyword">sizeof</span>(temp) - 1, 0);
<a name="l09852"></a>09852       <span class="keywordflow">if</span> (res &lt; 0)
<a name="l09853"></a>09853          <span class="keywordflow">return</span> res;
<a name="l09854"></a>09854       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(temp))
<a name="l09855"></a>09855          <span class="keywordflow">return</span> 0;
<a name="l09856"></a>09856       args.argv0 = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(temp);
<a name="l09857"></a>09857    }
<a name="l09858"></a>09858 
<a name="l09859"></a>09859    res = <a class="code" href="app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff" title="Prompts the user and records a voicemail to a mailbox.">leave_voicemail</a>(chan, args.argv0, &amp;leave_options);
<a name="l09860"></a>09860 
<a name="l09861"></a>09861    <span class="keywordflow">if</span> (res == <a class="code" href="app__minivm_8c.html#a207c95b6a18096172f7278b3af01f96d">ERROR_LOCK_PATH</a>) {
<a name="l09862"></a>09862       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;Could not leave voicemail. The path is already locked.\n&quot;</span>);
<a name="l09863"></a>09863       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l09864"></a>09864       res = 0;
<a name="l09865"></a>09865    }
<a name="l09866"></a>09866 
<a name="l09867"></a>09867    <span class="keywordflow">return</span> res;
<a name="l09868"></a>09868 }
<a name="l09869"></a>09869 
<a name="l09870"></a><a class="code" href="app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">09870</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *<a class="code" href="app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *box)
<a name="l09871"></a>09871 {
<a name="l09872"></a>09872    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l09873"></a>09873 
<a name="l09874"></a>09874    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list) {
<a name="l09875"></a>09875       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>) &amp;&amp; !strcasecmp(box, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)) {
<a name="l09876"></a>09876          <span class="keywordflow">if</span> (strcasecmp(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context)) {
<a name="l09877"></a>09877             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;\nIt has been detected that you have defined mailbox &apos;%s&apos; in separate\</span>
<a name="l09878"></a>09878 <span class="stringliteral">                  \n\tcontexts and that you have the &apos;searchcontexts&apos; option on. This type of\</span>
<a name="l09879"></a>09879 <span class="stringliteral">                  \n\tconfiguration creates an ambiguity that you likely do not want. Please\</span>
<a name="l09880"></a>09880 <span class="stringliteral">                  \n\tamend your voicemail.conf file to avoid this situation.\n&quot;</span>, box);
<a name="l09881"></a>09881          }
<a name="l09882"></a>09882          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring duplicated mailbox %s\n&quot;</span>, box);
<a name="l09883"></a>09883          <span class="keywordflow">return</span> NULL;
<a name="l09884"></a>09884       }
<a name="l09885"></a>09885       <span class="keywordflow">if</span> (!strcasecmp(context, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) &amp;&amp; !strcasecmp(box, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>)) {
<a name="l09886"></a>09886          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Ignoring duplicated mailbox %s in context %s\n&quot;</span>, box, context);
<a name="l09887"></a>09887          <span class="keywordflow">return</span> NULL;
<a name="l09888"></a>09888       }
<a name="l09889"></a>09889    }
<a name="l09890"></a>09890    
<a name="l09891"></a>09891    <span class="keywordflow">if</span> (!(vmu = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*vmu))))
<a name="l09892"></a>09892       <span class="keywordflow">return</span> NULL;
<a name="l09893"></a>09893    
<a name="l09894"></a>09894    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, context, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l09895"></a>09895    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, box, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>));
<a name="l09896"></a>09896 
<a name="l09897"></a>09897    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list);
<a name="l09898"></a>09898    
<a name="l09899"></a>09899    <span class="keywordflow">return</span> vmu;
<a name="l09900"></a>09900 }
<a name="l09901"></a>09901 
<a name="l09902"></a><a class="code" href="app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">09902</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">append_mailbox</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *context, <span class="keyword">const</span> <span class="keywordtype">char</span> *box, <span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l09903"></a>09903 {
<a name="l09904"></a>09904    <span class="comment">/* Assumes lock is already held */</span>
<a name="l09905"></a>09905    <span class="keywordtype">char</span> *tmp;
<a name="l09906"></a>09906    <span class="keywordtype">char</span> *stringp;
<a name="l09907"></a>09907    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l09908"></a>09908    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l09909"></a>09909    <span class="keywordtype">char</span> *mailbox_full;
<a name="l09910"></a>09910    <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;
<a name="l09911"></a>09911 
<a name="l09912"></a>09912    tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09913"></a>09913 
<a name="l09914"></a>09914    <span class="keywordflow">if</span> (!(vmu = <a class="code" href="app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(context, box)))
<a name="l09915"></a>09915       <span class="keywordflow">return</span> -1;
<a name="l09916"></a>09916    
<a name="l09917"></a>09917    <a class="code" href="app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0" title="Sets default voicemail system options to a voicemail user.">populate_defaults</a>(vmu);
<a name="l09918"></a>09918 
<a name="l09919"></a>09919    stringp = tmp;
<a name="l09920"></a>09920    <span class="keywordflow">if</span> ((s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) 
<a name="l09921"></a>09921       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a5d49a297933d69b1790ea84cfc316510">password</a>));
<a name="l09922"></a>09922    <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) 
<a name="l09923"></a>09923       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>));
<a name="l09924"></a>09924    <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) 
<a name="l09925"></a>09925       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>));
<a name="l09926"></a>09926    <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) 
<a name="l09927"></a>09927       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>, s, <span class="keyword">sizeof</span>(vmu-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>));
<a name="l09928"></a>09928    <span class="keywordflow">if</span> (stringp &amp;&amp; (s = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>))) 
<a name="l09929"></a>09929       <a class="code" href="app__voicemail_8c.html#a9f87d8b8ba9bcabcf8afeeec984731b2" title="Destructively Parse options and apply.">apply_options</a>(vmu, s);
<a name="l09930"></a>09930 
<a name="l09931"></a>09931    mailbox_full = alloca(strlen(box) + strlen(context) + 1);
<a name="l09932"></a>09932    strcpy(mailbox_full, box);
<a name="l09933"></a>09933    strcat(mailbox_full, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l09934"></a>09934    strcat(mailbox_full, context);
<a name="l09935"></a>09935 
<a name="l09936"></a>09936    <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(mailbox_full, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);
<a name="l09937"></a>09937    <a class="code" href="app__voicemail_8c.html#a953cfa381bf19b85e5f9c90c0d72407a">queue_mwi_event</a>(mailbox_full, urgent, <span class="keyword">new</span>, old);
<a name="l09938"></a>09938 
<a name="l09939"></a>09939    <span class="keywordflow">return</span> 0;
<a name="l09940"></a>09940 }
<a name="l09941"></a>09941 
<a name="l09942"></a><a class="code" href="app__voicemail_8c.html#a9a419c66f69a173d0b848affba5c720b">09942</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a9a419c66f69a173d0b848affba5c720b">vm_box_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data) 
<a name="l09943"></a>09943 {
<a name="l09944"></a>09944    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> svm;
<a name="l09945"></a>09945    <span class="keywordtype">char</span> *context, *box;
<a name="l09946"></a>09946    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l09947"></a>09947       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>);
<a name="l09948"></a>09948       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l09949"></a>09949    );
<a name="l09950"></a>09950    <span class="keyword">static</span> <span class="keywordtype">int</span> dep_warning = 0;
<a name="l09951"></a>09951 
<a name="l09952"></a>09952    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l09953"></a>09953       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;MailboxExists requires an argument: (vmbox[@context][|options])\n&quot;</span>);
<a name="l09954"></a>09954       <span class="keywordflow">return</span> -1;
<a name="l09955"></a>09955    }
<a name="l09956"></a>09956 
<a name="l09957"></a>09957    <span class="keywordflow">if</span> (!dep_warning) {
<a name="l09958"></a>09958       dep_warning = 1;
<a name="l09959"></a>09959       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;MailboxExists is deprecated.  Please use ${MAILBOX_EXISTS(%s)} instead.\n&quot;</span>, (<span class="keywordtype">char</span> *)data);
<a name="l09960"></a>09960    }
<a name="l09961"></a>09961 
<a name="l09962"></a>09962    box = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l09963"></a>09963 
<a name="l09964"></a>09964    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, box);
<a name="l09965"></a>09965 
<a name="l09966"></a>09966    <span class="keywordflow">if</span> (args.options) {
<a name="l09967"></a>09967    }
<a name="l09968"></a>09968 
<a name="l09969"></a>09969    <span class="keywordflow">if</span> ((context = strchr(args.mbox, <span class="charliteral">&apos;@&apos;</span>))) {
<a name="l09970"></a>09970       *context = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l09971"></a>09971       context++;
<a name="l09972"></a>09972    }
<a name="l09973"></a>09973 
<a name="l09974"></a>09974    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;svm, context, args.mbox)) {
<a name="l09975"></a>09975       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMBOXEXISTSSTATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l09976"></a>09976    } <span class="keywordflow">else</span>
<a name="l09977"></a>09977       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;VMBOXEXISTSSTATUS&quot;</span>, <span class="stringliteral">&quot;FAILED&quot;</span>);
<a name="l09978"></a>09978 
<a name="l09979"></a>09979    <span class="keywordflow">return</span> 0;
<a name="l09980"></a>09980 }
<a name="l09981"></a>09981 
<a name="l09982"></a><a class="code" href="app__voicemail_8c.html#a56779d5f3f9d73c5983988352fa09a27">09982</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a56779d5f3f9d73c5983988352fa09a27">acf_mailbox_exists</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *args, <span class="keywordtype">char</span> *buf, <span class="keywordtype">size_t</span> len)
<a name="l09983"></a>09983 {
<a name="l09984"></a>09984    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> svm;
<a name="l09985"></a>09985    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(arg,
<a name="l09986"></a>09986       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="app__voicemail_8c.html#ae81f3296e3dfcc29837a6b4b86f5c6bb">mbox</a>);
<a name="l09987"></a>09987       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(context);
<a name="l09988"></a>09988    );
<a name="l09989"></a>09989 
<a name="l09990"></a>09990    <a class="code" href="app_8h.html#accfcb380df76a64251d88ef49c2dd4e3" title="Performs the &amp;#39;nonstandard&amp;#39; argument separation process for an application...">AST_NONSTANDARD_APP_ARGS</a>(arg, args, <span class="charliteral">&apos;@&apos;</span>);
<a name="l09991"></a>09991 
<a name="l09992"></a>09992    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(arg.mbox)) {
<a name="l09993"></a>09993       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;MAILBOX_EXISTS requires an argument (&lt;mailbox&gt;[@&lt;context&gt;])\n&quot;</span>);
<a name="l09994"></a>09994       <span class="keywordflow">return</span> -1;
<a name="l09995"></a>09995    }
<a name="l09996"></a>09996 
<a name="l09997"></a>09997    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, <a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;svm, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(arg.context) ? <span class="stringliteral">&quot;default&quot;</span> : arg.context, arg.mbox) ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;0&quot;</span>, len);
<a name="l09998"></a>09998    <span class="keywordflow">return</span> 0;
<a name="l09999"></a>09999 }
<a name="l10000"></a>10000 
<a name="l10001"></a><a class="code" href="app__voicemail_8c.html#a3f6741bb45607f4107c08aa8d7e44509">10001</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__voicemail_8c.html#a3f6741bb45607f4107c08aa8d7e44509">mailbox_exists_acf</a> = {
<a name="l10002"></a>10002    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;MAILBOX_EXISTS&quot;</span>,
<a name="l10003"></a>10003    .read = <a class="code" href="app__voicemail_8c.html#a56779d5f3f9d73c5983988352fa09a27">acf_mailbox_exists</a>,
<a name="l10004"></a>10004 };
<a name="l10005"></a>10005 
<a name="l10006"></a><a class="code" href="app__voicemail_8c.html#a62edc65a5b9367acdf79742421d5283a">10006</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a62edc65a5b9367acdf79742421d5283a">vmauthenticate</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">void</span> *data)
<a name="l10007"></a>10007 {
<a name="l10008"></a>10008    <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = data, *user=NULL, *context=NULL, mailbox[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l10009"></a>10009    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> vmus;
<a name="l10010"></a>10010    <span class="keywordtype">char</span> *options = NULL;
<a name="l10011"></a>10011    <span class="keywordtype">int</span> silent = 0, skipuser = 0;
<a name="l10012"></a>10012    <span class="keywordtype">int</span> res = -1;
<a name="l10013"></a>10013    
<a name="l10014"></a>10014    <span class="keywordflow">if</span> (s) {
<a name="l10015"></a>10015       s = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(s);
<a name="l10016"></a>10016       user = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l10017"></a>10017       options = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l10018"></a>10018       <span class="keywordflow">if</span> (user) {
<a name="l10019"></a>10019          s = user;
<a name="l10020"></a>10020          user = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l10021"></a>10021          context = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;s, <span class="stringliteral">&quot;&quot;</span>);
<a name="l10022"></a>10022          <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(user))
<a name="l10023"></a>10023             skipuser++;
<a name="l10024"></a>10024          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(mailbox, user, <span class="keyword">sizeof</span>(mailbox));
<a name="l10025"></a>10025       }
<a name="l10026"></a>10026    }
<a name="l10027"></a>10027 
<a name="l10028"></a>10028    <span class="keywordflow">if</span> (options) {
<a name="l10029"></a>10029       silent = (strchr(options, <span class="charliteral">&apos;s&apos;</span>)) != NULL;
<a name="l10030"></a>10030    }
<a name="l10031"></a>10031 
<a name="l10032"></a>10032    <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#aad952a8efdeb4f2381c3d19d6e33e836">vm_authenticate</a>(chan, mailbox, <span class="keyword">sizeof</span>(mailbox), &amp;vmus, context, NULL, skipuser, 3, silent)) {
<a name="l10033"></a>10033       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AUTH_MAILBOX&quot;</span>, mailbox);
<a name="l10034"></a>10034       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;AUTH_CONTEXT&quot;</span>, vmus.<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l10035"></a>10035       <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;auth-thankyou&quot;</span>);
<a name="l10036"></a>10036       res = 0;
<a name="l10037"></a>10037    }
<a name="l10038"></a>10038 
<a name="l10039"></a>10039    <span class="keywordflow">return</span> res;
<a name="l10040"></a>10040 }
<a name="l10041"></a>10041 
<a name="l10042"></a><a class="code" href="app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">10042</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">show_users_realtime</a>(<span class="keywordtype">int</span> fd, <span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l10043"></a>10043 {
<a name="l10044"></a>10044    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l10045"></a>10045    <span class="keyword">const</span> <span class="keywordtype">char</span> *cat = NULL;
<a name="l10046"></a>10046 
<a name="l10047"></a>10047    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a29ff8cd717c0c0bac60abbd827fec409" title="Retrieve realtime configuration.">ast_load_realtime_multientry</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, 
<a name="l10048"></a>10048       <span class="stringliteral">&quot;context&quot;</span>, context, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>))) {
<a name="l10049"></a>10049       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l10050"></a>10050    }
<a name="l10051"></a>10051 
<a name="l10052"></a>10052    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,
<a name="l10053"></a>10053       <span class="stringliteral">&quot;\n&quot;</span>
<a name="l10054"></a>10054       <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l10055"></a>10055       <span class="stringliteral">&quot;=== Configured Voicemail Users ==============================\n&quot;</span>
<a name="l10056"></a>10056       <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l10057"></a>10057       <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l10058"></a>10058 
<a name="l10059"></a>10059    <span class="keywordflow">while</span> ((cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat))) {
<a name="l10060"></a>10060       <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *var = NULL;
<a name="l10061"></a>10061       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,
<a name="l10062"></a>10062          <span class="stringliteral">&quot;=== Mailbox ...\n&quot;</span>
<a name="l10063"></a>10063          <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l10064"></a>10064       <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>)
<a name="l10065"></a>10065          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd, <span class="stringliteral">&quot;=== ==&gt; %s: %s\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l10066"></a>10066       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,
<a name="l10067"></a>10067          <span class="stringliteral">&quot;===\n&quot;</span>
<a name="l10068"></a>10068          <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span>
<a name="l10069"></a>10069          <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l10070"></a>10070    }
<a name="l10071"></a>10071 
<a name="l10072"></a>10072    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(fd,
<a name="l10073"></a>10073       <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l10074"></a>10074       <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l10075"></a>10075 
<a name="l10076"></a>10076    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l10077"></a>10077 
<a name="l10078"></a>10078    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l10079"></a>10079 }
<a name="l10080"></a>10080 
<a name="l10081"></a><a class="code" href="app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">10081</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">complete_voicemail_show_users</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l10082"></a>10082 {
<a name="l10083"></a>10083    <span class="keywordtype">int</span> which = 0;
<a name="l10084"></a>10084    <span class="keywordtype">int</span> wordlen;
<a name="l10085"></a>10085    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l10086"></a>10086    <span class="keyword">const</span> <span class="keywordtype">char</span> *context = <span class="stringliteral">&quot;&quot;</span>;
<a name="l10087"></a>10087 
<a name="l10088"></a>10088    <span class="comment">/* 0 - show; 1 - voicemail; 2 - users; 3 - for; 4 - &lt;context&gt; */</span>
<a name="l10089"></a>10089    <span class="keywordflow">if</span> (pos &gt; 4)
<a name="l10090"></a>10090       <span class="keywordflow">return</span> NULL;
<a name="l10091"></a>10091    <span class="keywordflow">if</span> (pos == 3)
<a name="l10092"></a>10092       <span class="keywordflow">return</span> (state == 0) ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;for&quot;</span>) : NULL;
<a name="l10093"></a>10093    wordlen = strlen(word);
<a name="l10094"></a>10094    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list) {
<a name="l10095"></a>10095       <span class="keywordflow">if</span> (!strncasecmp(word, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, wordlen)) {
<a name="l10096"></a>10096          <span class="keywordflow">if</span> (context &amp;&amp; strcmp(context, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) &amp;&amp; ++which &gt; state)
<a name="l10097"></a>10097             <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l10098"></a>10098          <span class="comment">/* ignore repeated contexts ? */</span>
<a name="l10099"></a>10099          context = vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l10100"></a>10100       }
<a name="l10101"></a>10101    }
<a name="l10102"></a>10102    <span class="keywordflow">return</span> NULL;
<a name="l10103"></a>10103 }
<a name="l10104"></a>10104 <span class="comment"></span>
<a name="l10105"></a>10105 <span class="comment">/*! \brief Show a list of voicemail users in the CLI */</span>
<a name="l10106"></a><a class="code" href="app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a">10106</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a" title="Show a list of voicemail users in the CLI.">handle_voicemail_show_users</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l10107"></a>10107 {
<a name="l10108"></a>10108    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu;
<a name="l10109"></a>10109 <span class="preprocessor">#define HVSU_OUTPUT_FORMAT &quot;%-10s %-5s %-25s %-10s %6s\n&quot;</span>
<a name="l10110"></a>10110 <span class="preprocessor"></span>   <span class="keyword">const</span> <span class="keywordtype">char</span> *context = NULL;
<a name="l10111"></a>10111    <span class="keywordtype">int</span> users_counter = 0;
<a name="l10112"></a>10112 
<a name="l10113"></a>10113    <span class="keywordflow">switch</span> (cmd) {
<a name="l10114"></a>10114    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l10115"></a>10115       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail show users&quot;</span>;
<a name="l10116"></a>10116       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l10117"></a>10117          <span class="stringliteral">&quot;Usage: voicemail show users [for &lt;context&gt;]\n&quot;</span>
<a name="l10118"></a>10118          <span class="stringliteral">&quot;       Lists all mailboxes currently set up\n&quot;</span>;
<a name="l10119"></a>10119       <span class="keywordflow">return</span> NULL;
<a name="l10120"></a>10120    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l10121"></a>10121       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#abd383481e08b81dcccd729b13cdf0960">complete_voicemail_show_users</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l10122"></a>10122    }  
<a name="l10123"></a>10123 
<a name="l10124"></a>10124    <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 3) || (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 5) || (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4))
<a name="l10125"></a>10125       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l10126"></a>10126    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5) {
<a name="l10127"></a>10127       <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3],<span class="stringliteral">&quot;for&quot;</span>))
<a name="l10128"></a>10128          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l10129"></a>10129       context = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[4];
<a name="l10130"></a>10130    }
<a name="l10131"></a>10131 
<a name="l10132"></a>10132    <span class="keywordflow">if</span> (<a class="code" href="config_8h.html#a910f835a41772603d33e200c956549ff" title="Check if realtime engine is configured for family.">ast_check_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>)) {
<a name="l10133"></a>10133       <span class="keywordflow">if</span> (!context) {
<a name="l10134"></a>10134          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;You must specify a specific context to show users from realtime!\n&quot;</span>);
<a name="l10135"></a>10135          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l10136"></a>10136       }
<a name="l10137"></a>10137       <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#a11889eb6139e5f1151409abc2b076aa8">show_users_realtime</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, context);
<a name="l10138"></a>10138    }
<a name="l10139"></a>10139 
<a name="l10140"></a>10140    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10141"></a>10141    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>)) {
<a name="l10142"></a>10142       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There are no voicemail users currently defined\n&quot;</span>);
<a name="l10143"></a>10143       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10144"></a>10144       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l10145"></a>10145    }
<a name="l10146"></a>10146    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3)
<a name="l10147"></a>10147       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Context&quot;</span>, <span class="stringliteral">&quot;Mbox&quot;</span>, <span class="stringliteral">&quot;User&quot;</span>, <span class="stringliteral">&quot;Zone&quot;</span>, <span class="stringliteral">&quot;NewMsg&quot;</span>);
<a name="l10148"></a>10148    <span class="keywordflow">else</span> {
<a name="l10149"></a>10149       <span class="keywordtype">int</span> count = 0;
<a name="l10150"></a>10150       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list) {
<a name="l10151"></a>10151          <span class="keywordflow">if</span> (!strcmp(context, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>))
<a name="l10152"></a>10152             count++;
<a name="l10153"></a>10153       }
<a name="l10154"></a>10154       <span class="keywordflow">if</span> (count) {
<a name="l10155"></a>10155          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Context&quot;</span>, <span class="stringliteral">&quot;Mbox&quot;</span>, <span class="stringliteral">&quot;User&quot;</span>, <span class="stringliteral">&quot;Zone&quot;</span>, <span class="stringliteral">&quot;NewMsg&quot;</span>);
<a name="l10156"></a>10156       } <span class="keywordflow">else</span> {
<a name="l10157"></a>10157          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such voicemail context \&quot;%s\&quot;\n&quot;</span>, context);
<a name="l10158"></a>10158          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10159"></a>10159          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l10160"></a>10160       }
<a name="l10161"></a>10161    }
<a name="l10162"></a>10162    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list) {
<a name="l10163"></a>10163       <span class="keywordtype">int</span> newmsgs = 0, oldmsgs = 0;
<a name="l10164"></a>10164       <span class="keywordtype">char</span> count[12], tmp[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l10165"></a>10165 
<a name="l10166"></a>10166       <span class="keywordflow">if</span> ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3) || ((a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 5) &amp;&amp; !strcmp(context, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>))) {
<a name="l10167"></a>10167          snprintf(tmp, <span class="keyword">sizeof</span>(tmp), <span class="stringliteral">&quot;%s@%s&quot;</span>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>) ? <span class="stringliteral">&quot;default&quot;</span> : vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l10168"></a>10168          <a class="code" href="app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(tmp, &amp;newmsgs, &amp;oldmsgs);
<a name="l10169"></a>10169          snprintf(count, <span class="keyword">sizeof</span>(count), <span class="stringliteral">&quot;%d&quot;</span>, newmsgs);
<a name="l10170"></a>10170          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__voicemail_8c.html#a92444ec75fa1e9945e824bb196fb04d2">HVSU_OUTPUT_FORMAT</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, count);
<a name="l10171"></a>10171          users_counter++;
<a name="l10172"></a>10172       }
<a name="l10173"></a>10173    }
<a name="l10174"></a>10174    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10175"></a>10175    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d voicemail users configured.\n&quot;</span>, users_counter);
<a name="l10176"></a>10176    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l10177"></a>10177 }
<a name="l10178"></a>10178 <span class="comment"></span>
<a name="l10179"></a>10179 <span class="comment">/*! \brief Show a list of voicemail zones in the CLI */</span>
<a name="l10180"></a><a class="code" href="app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6">10180</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6" title="Show a list of voicemail zones in the CLI.">handle_voicemail_show_zones</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l10181"></a>10181 {
<a name="l10182"></a>10182    <span class="keyword">struct </span><a class="code" href="structvm__zone.html">vm_zone</a> *zone;
<a name="l10183"></a>10183 <span class="preprocessor">#define HVSZ_OUTPUT_FORMAT &quot;%-15s %-20s %-45s\n&quot;</span>
<a name="l10184"></a>10184 <span class="preprocessor"></span>   <span class="keywordtype">char</span> *res = <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l10185"></a>10185 
<a name="l10186"></a>10186    <span class="keywordflow">switch</span> (cmd) {
<a name="l10187"></a>10187    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l10188"></a>10188       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail show zones&quot;</span>;
<a name="l10189"></a>10189       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l10190"></a>10190          <span class="stringliteral">&quot;Usage: voicemail show zones\n&quot;</span>
<a name="l10191"></a>10191          <span class="stringliteral">&quot;       Lists zone message formats\n&quot;</span>;
<a name="l10192"></a>10192       <span class="keywordflow">return</span> NULL;
<a name="l10193"></a>10193    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l10194"></a>10194       <span class="keywordflow">return</span> NULL;
<a name="l10195"></a>10195    }
<a name="l10196"></a>10196 
<a name="l10197"></a>10197    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 3)
<a name="l10198"></a>10198       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l10199"></a>10199 
<a name="l10200"></a>10200    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;zones);
<a name="l10201"></a>10201    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;zones)) {
<a name="l10202"></a>10202       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__voicemail_8c.html#a9b7212bac1c90a7a89c6e8c87792c3db">HVSZ_OUTPUT_FORMAT</a>, <span class="stringliteral">&quot;Zone&quot;</span>, <span class="stringliteral">&quot;Timezone&quot;</span>, <span class="stringliteral">&quot;Message Format&quot;</span>);
<a name="l10203"></a>10203       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;zones, zone, list) {
<a name="l10204"></a>10204          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__voicemail_8c.html#a9b7212bac1c90a7a89c6e8c87792c3db">HVSZ_OUTPUT_FORMAT</a>, zone-&gt;name, zone-&gt;timezone, zone-&gt;msg_format);
<a name="l10205"></a>10205       }
<a name="l10206"></a>10206    } <span class="keywordflow">else</span> {
<a name="l10207"></a>10207       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;There are no voicemail zones currently defined\n&quot;</span>);
<a name="l10208"></a>10208       res = <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l10209"></a>10209    }
<a name="l10210"></a>10210    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;zones);
<a name="l10211"></a>10211 
<a name="l10212"></a>10212    <span class="keywordflow">return</span> res;
<a name="l10213"></a>10213 }
<a name="l10214"></a>10214 <span class="comment"></span>
<a name="l10215"></a>10215 <span class="comment">/*! \brief Reload voicemail configuration from the CLI */</span>
<a name="l10216"></a><a class="code" href="app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba">10216</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba" title="Reload voicemail configuration from the CLI.">handle_voicemail_reload</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l10217"></a>10217 {
<a name="l10218"></a>10218    <span class="keywordflow">switch</span> (cmd) {
<a name="l10219"></a>10219    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l10220"></a>10220       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;voicemail reload&quot;</span>;
<a name="l10221"></a>10221       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l10222"></a>10222          <span class="stringliteral">&quot;Usage: voicemail reload\n&quot;</span>
<a name="l10223"></a>10223          <span class="stringliteral">&quot;       Reload voicemail configuration\n&quot;</span>;
<a name="l10224"></a>10224       <span class="keywordflow">return</span> NULL;
<a name="l10225"></a>10225    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l10226"></a>10226       <span class="keywordflow">return</span> NULL;
<a name="l10227"></a>10227    }
<a name="l10228"></a>10228 
<a name="l10229"></a>10229    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != 2)
<a name="l10230"></a>10230       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l10231"></a>10231 
<a name="l10232"></a>10232    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Reloading voicemail configuration...\n&quot;</span>);   
<a name="l10233"></a>10233    <a class="code" href="app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(1);
<a name="l10234"></a>10234    
<a name="l10235"></a>10235    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l10236"></a>10236 }
<a name="l10237"></a>10237 
<a name="l10238"></a><a class="code" href="app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">10238</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a>[] = {
<a name="l10239"></a>10239    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__voicemail_8c.html#af561c590ea94fc23f5f75e8a31b1a70a" title="Show a list of voicemail users in the CLI.">handle_voicemail_show_users</a>, <span class="stringliteral">&quot;List defined voicemail boxes&quot;</span>),
<a name="l10240"></a>10240    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__voicemail_8c.html#aad10d8bd23492e02853159d49d2956c6" title="Show a list of voicemail zones in the CLI.">handle_voicemail_show_zones</a>, <span class="stringliteral">&quot;List zone message formats&quot;</span>),
<a name="l10241"></a>10241    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__voicemail_8c.html#a17fd24c96e8f7a2a8ec8190f40dbbcba" title="Reload voicemail configuration from the CLI.">handle_voicemail_reload</a>, <span class="stringliteral">&quot;Reload voicemail configuration&quot;</span>),
<a name="l10242"></a>10242 };
<a name="l10243"></a>10243 
<a name="l10244"></a><a class="code" href="app__voicemail_8c.html#a2cc5824a2134ce3079ac896c1033b06b">10244</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a2cc5824a2134ce3079ac896c1033b06b">poll_subscribed_mailbox</a>(<span class="keyword">struct</span> <a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a> *<a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>)
<a name="l10245"></a>10245 {
<a name="l10246"></a>10246    <span class="keywordtype">int</span> <span class="keyword">new</span> = 0, old = 0, urgent = 0;
<a name="l10247"></a>10247 
<a name="l10248"></a>10248    <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>(mwi_sub-&gt;mailbox, &amp;urgent, &amp;<span class="keyword">new</span>, &amp;old);
<a name="l10249"></a>10249 
<a name="l10250"></a>10250    <span class="keywordflow">if</span> (urgent != mwi_sub-&gt;old_urgent || <span class="keyword">new</span> != mwi_sub-&gt;old_new || old != mwi_sub-&gt;old_old) {
<a name="l10251"></a>10251       mwi_sub-&gt;old_urgent = urgent;
<a name="l10252"></a>10252       mwi_sub-&gt;old_new = <span class="keyword">new</span>;
<a name="l10253"></a>10253       mwi_sub-&gt;old_old = old;
<a name="l10254"></a>10254       <a class="code" href="app__voicemail_8c.html#a953cfa381bf19b85e5f9c90c0d72407a">queue_mwi_event</a>(mwi_sub-&gt;mailbox, urgent, <span class="keyword">new</span>, old);
<a name="l10255"></a>10255    }
<a name="l10256"></a>10256 }
<a name="l10257"></a>10257 
<a name="l10258"></a><a class="code" href="app__voicemail_8c.html#adf57cc13e808a9f4c11e4e9f5c1c273c">10258</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#adf57cc13e808a9f4c11e4e9f5c1c273c">poll_subscribed_mailboxes</a>(<span class="keywordtype">void</span>)
<a name="l10259"></a>10259 {
<a name="l10260"></a>10260    <span class="keyword">struct </span><a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a> *<a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>;
<a name="l10261"></a>10261 
<a name="l10262"></a>10262    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;mwi_subs);
<a name="l10263"></a>10263    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;mwi_subs, mwi_sub, entry) {
<a name="l10264"></a>10264       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(mwi_sub-&gt;mailbox)) {
<a name="l10265"></a>10265          <a class="code" href="app__voicemail_8c.html#a2cc5824a2134ce3079ac896c1033b06b">poll_subscribed_mailbox</a>(mwi_sub);
<a name="l10266"></a>10266       }
<a name="l10267"></a>10267    }
<a name="l10268"></a>10268    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;mwi_subs);
<a name="l10269"></a>10269 }
<a name="l10270"></a>10270 
<a name="l10271"></a><a class="code" href="app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">10271</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">mb_poll_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l10272"></a>10272 {
<a name="l10273"></a>10273    <span class="keywordflow">while</span> (<a class="code" href="app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a>) {
<a name="l10274"></a>10274       <span class="keyword">struct </span>timespec ts = { 0, };
<a name="l10275"></a>10275       <span class="keyword">struct </span>timeval wait;
<a name="l10276"></a>10276 
<a name="l10277"></a>10277       wait = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(<a class="code" href="app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a>, 1));
<a name="l10278"></a>10278       ts.tv_sec = wait.tv_sec;
<a name="l10279"></a>10279       ts.tv_nsec = wait.tv_usec * 1000;
<a name="l10280"></a>10280 
<a name="l10281"></a>10281       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;poll_lock);
<a name="l10282"></a>10282       <a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(&amp;<a class="code" href="app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">poll_cond</a>, &amp;poll_lock, &amp;ts);
<a name="l10283"></a>10283       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;poll_lock);
<a name="l10284"></a>10284 
<a name="l10285"></a>10285       <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a>)
<a name="l10286"></a>10286          <span class="keywordflow">break</span>;
<a name="l10287"></a>10287 
<a name="l10288"></a>10288       <a class="code" href="app__voicemail_8c.html#adf57cc13e808a9f4c11e4e9f5c1c273c">poll_subscribed_mailboxes</a>();
<a name="l10289"></a>10289    }
<a name="l10290"></a>10290 
<a name="l10291"></a>10291    <span class="keywordflow">return</span> NULL;
<a name="l10292"></a>10292 }
<a name="l10293"></a>10293 
<a name="l10294"></a><a class="code" href="app__voicemail_8c.html#a045b216892d3ab474cf294aa40ee4aaf">10294</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a045b216892d3ab474cf294aa40ee4aaf">mwi_sub_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a> *<a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>)
<a name="l10295"></a>10295 {
<a name="l10296"></a>10296    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mwi_sub);
<a name="l10297"></a>10297 }
<a name="l10298"></a>10298 
<a name="l10299"></a><a class="code" href="app__voicemail_8c.html#a3c1e8ee04348d840a25a0e15434e95a0">10299</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a3c1e8ee04348d840a25a0e15434e95a0">handle_unsubscribe</a>(<span class="keywordtype">void</span> *datap)
<a name="l10300"></a>10300 {
<a name="l10301"></a>10301    <span class="keyword">struct </span><a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a> *<a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>;
<a name="l10302"></a>10302    uint32_t *uniqueid = datap;
<a name="l10303"></a>10303    
<a name="l10304"></a>10304    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;mwi_subs);
<a name="l10305"></a>10305    <a class="code" href="linkedlists_8h.html#a21be6da4b2146b04b4868c2be5cae750">AST_RWLIST_TRAVERSE_SAFE_BEGIN</a>(&amp;mwi_subs, mwi_sub, entry) {
<a name="l10306"></a>10306       <span class="keywordflow">if</span> (mwi_sub-&gt;uniqueid == *uniqueid) {
<a name="l10307"></a>10307          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l10308"></a>10308          <span class="keywordflow">break</span>;
<a name="l10309"></a>10309       }
<a name="l10310"></a>10310    }
<a name="l10311"></a>10311    <a class="code" href="linkedlists_8h.html#a6bf0e81cb6ef01532ddebaba68f6de28">AST_RWLIST_TRAVERSE_SAFE_END</a>
<a name="l10312"></a>10312    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;mwi_subs);
<a name="l10313"></a>10313 
<a name="l10314"></a>10314    <span class="keywordflow">if</span> (mwi_sub)
<a name="l10315"></a>10315       <a class="code" href="app__voicemail_8c.html#a045b216892d3ab474cf294aa40ee4aaf">mwi_sub_destroy</a>(mwi_sub);
<a name="l10316"></a>10316 
<a name="l10317"></a>10317    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(uniqueid);  
<a name="l10318"></a>10318    <span class="keywordflow">return</span> 0;
<a name="l10319"></a>10319 }
<a name="l10320"></a>10320 
<a name="l10321"></a><a class="code" href="app__voicemail_8c.html#a61fc9e415905d8224028cce955ec24a4">10321</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a61fc9e415905d8224028cce955ec24a4">handle_subscribe</a>(<span class="keywordtype">void</span> *datap)
<a name="l10322"></a>10322 {
<a name="l10323"></a>10323    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> len;
<a name="l10324"></a>10324    <span class="keyword">struct </span><a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a> *<a class="code" href="structmwi__sub.html" title="An MWI subscription.">mwi_sub</a>;
<a name="l10325"></a>10325    <span class="keyword">struct </span><a class="code" href="structmwi__sub__task.html">mwi_sub_task</a> *p = datap;
<a name="l10326"></a>10326 
<a name="l10327"></a>10327    len = <span class="keyword">sizeof</span>(*mwi_sub);
<a name="l10328"></a>10328    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">mailbox</a>))
<a name="l10329"></a>10329       len += strlen(p-&gt;<a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">mailbox</a>);
<a name="l10330"></a>10330 
<a name="l10331"></a>10331    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">context</a>))
<a name="l10332"></a>10332       len += strlen(p-&gt;<a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">context</a>) + 1; <span class="comment">/* Allow for seperator */</span>
<a name="l10333"></a>10333 
<a name="l10334"></a>10334    <span class="keywordflow">if</span> (!(mwi_sub = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, len)))
<a name="l10335"></a>10335       <span class="keywordflow">return</span> -1;
<a name="l10336"></a>10336 
<a name="l10337"></a>10337    mwi_sub-&gt;uniqueid = p-&gt;<a class="code" href="structmwi__sub__task.html#a118e8a66b7de05b645dbfbb7e964024c">uniqueid</a>;
<a name="l10338"></a>10338    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">mailbox</a>))
<a name="l10339"></a>10339       strcpy(mwi_sub-&gt;mailbox, p-&gt;<a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">mailbox</a>);
<a name="l10340"></a>10340 
<a name="l10341"></a>10341    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(p-&gt;<a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">context</a>)) {
<a name="l10342"></a>10342       strcat(mwi_sub-&gt;mailbox, <span class="stringliteral">&quot;@&quot;</span>);
<a name="l10343"></a>10343       strcat(mwi_sub-&gt;mailbox, p-&gt;<a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">context</a>);
<a name="l10344"></a>10344    }
<a name="l10345"></a>10345 
<a name="l10346"></a>10346    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;mwi_subs);
<a name="l10347"></a>10347    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;mwi_subs, mwi_sub, entry);
<a name="l10348"></a>10348    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;mwi_subs);
<a name="l10349"></a>10349    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>((<span class="keywordtype">void</span> *) p-&gt;<a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">mailbox</a>);
<a name="l10350"></a>10350    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>((<span class="keywordtype">void</span> *) p-&gt;<a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">context</a>);
<a name="l10351"></a>10351    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(p);
<a name="l10352"></a>10352    <a class="code" href="app__voicemail_8c.html#a2cc5824a2134ce3079ac896c1033b06b">poll_subscribed_mailbox</a>(mwi_sub);
<a name="l10353"></a>10353    <span class="keywordflow">return</span> 0;
<a name="l10354"></a>10354 }
<a name="l10355"></a>10355 
<a name="l10356"></a><a class="code" href="app__voicemail_8c.html#a9ab25be935c7b595006640f268f4e690">10356</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a9ab25be935c7b595006640f268f4e690">mwi_unsub_event_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *userdata)
<a name="l10357"></a>10357 {
<a name="l10358"></a>10358    uint32_t u, *<a class="code" href="structmwi__sub__task.html#a118e8a66b7de05b645dbfbb7e964024c">uniqueid</a> = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*uniqueid));
<a name="l10359"></a>10359    <span class="keywordflow">if</span> (<a class="code" href="event_8h.html#ab3055e3d85399352f0a4ca7404549d4b" title="Get the type for an event.">ast_event_get_type</a>(event) != <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa2cf434566fd9444e02b7bde6e8a40770">AST_EVENT_UNSUB</a>)
<a name="l10360"></a>10360       <span class="keywordflow">return</span>;
<a name="l10361"></a>10361 
<a name="l10362"></a>10362    <span class="keywordflow">if</span> (<a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491adef1da9ee188613895b2bbfd05960710" title="Event type Used by: AST_EVENT_SUB, AST_EVENT_UNSUB Payload type: UINT.">AST_EVENT_IE_EVENTTYPE</a>) != <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>)
<a name="l10363"></a>10363       <span class="keywordflow">return</span>;
<a name="l10364"></a>10364 
<a name="l10365"></a>10365    u = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a53d47a901204e69f36bebff49196114d" title="Unique ID Used by: AST_EVENT_SUB, AST_EVENT_UNSUB Payload type: UINT.">AST_EVENT_IE_UNIQUEID</a>);
<a name="l10366"></a>10366    *uniqueid = u;
<a name="l10367"></a>10367    <span class="keywordflow">if</span> (<a class="code" href="taskprocessor_8h.html#a815e690b2db467f47655ebaa5d85fb69" title="Push a task into the specified taskprocessor queue and signal the taskprocessor thread...">ast_taskprocessor_push</a>(<a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a>, <a class="code" href="app__voicemail_8c.html#a3c1e8ee04348d840a25a0e15434e95a0">handle_unsubscribe</a>, uniqueid) &lt; 0) {
<a name="l10368"></a>10368       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(uniqueid);
<a name="l10369"></a>10369    }
<a name="l10370"></a>10370 }
<a name="l10371"></a>10371 
<a name="l10372"></a><a class="code" href="app__voicemail_8c.html#a4e013b433443a9f63bb6321d45a737c0">10372</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a4e013b433443a9f63bb6321d45a737c0">mwi_sub_event_cb</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__event.html" title="An event.">ast_event</a> *event, <span class="keywordtype">void</span> *userdata)
<a name="l10373"></a>10373 {
<a name="l10374"></a>10374    <span class="keyword">struct </span><a class="code" href="structmwi__sub__task.html">mwi_sub_task</a> *mwist;
<a name="l10375"></a>10375    
<a name="l10376"></a>10376    <span class="keywordflow">if</span> (<a class="code" href="event_8h.html#ab3055e3d85399352f0a4ca7404549d4b" title="Get the type for an event.">ast_event_get_type</a>(event) != <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79faefc08b90f280fd17876d70595c2c0eda">AST_EVENT_SUB</a>)
<a name="l10377"></a>10377       <span class="keywordflow">return</span>;
<a name="l10378"></a>10378 
<a name="l10379"></a>10379    <span class="keywordflow">if</span> (<a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491adef1da9ee188613895b2bbfd05960710" title="Event type Used by: AST_EVENT_SUB, AST_EVENT_UNSUB Payload type: UINT.">AST_EVENT_IE_EVENTTYPE</a>) != <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>)
<a name="l10380"></a>10380       <span class="keywordflow">return</span>;
<a name="l10381"></a>10381 
<a name="l10382"></a>10382    <span class="keywordflow">if</span> ((mwist = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, (<span class="keyword">sizeof</span>(*mwist)))) == NULL) {
<a name="l10383"></a>10383       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;could not allocate a mwi_sub_task\n&quot;</span>);
<a name="l10384"></a>10384       <span class="keywordflow">return</span>;
<a name="l10385"></a>10385    }
<a name="l10386"></a>10386    mwist-&gt;<a class="code" href="structmwi__sub__task.html#a9dc4c585c33ed23d20202dd23dc042b0">mailbox</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="event_8h.html#a0cfdd21162f4795714da583c31477151" title="Get the value of an information element that has a string payload.">ast_event_get_ie_str</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491aae6c80d8f4c6ab3cee006ed57d874710" title="Mailbox name.">AST_EVENT_IE_MAILBOX</a>));
<a name="l10387"></a>10387    mwist-&gt;<a class="code" href="structmwi__sub__task.html#a94f090d1fb5c71712726fcdf025b9ace">context</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="event_8h.html#a0cfdd21162f4795714da583c31477151" title="Get the value of an information element that has a string payload.">ast_event_get_ie_str</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a25764e2fb734ccb3ee1f6f41caba5318" title="Context IE Used by AST_EVENT_MWI Payload type: str.">AST_EVENT_IE_CONTEXT</a>));
<a name="l10388"></a>10388    mwist-&gt;<a class="code" href="structmwi__sub__task.html#a118e8a66b7de05b645dbfbb7e964024c">uniqueid</a> = <a class="code" href="event_8h.html#a317f6947b933acd0da82df6e9a4672e5" title="Get the value of an information element that has an integer payload.">ast_event_get_ie_uint</a>(event, <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a53d47a901204e69f36bebff49196114d" title="Unique ID Used by: AST_EVENT_SUB, AST_EVENT_UNSUB Payload type: UINT.">AST_EVENT_IE_UNIQUEID</a>);
<a name="l10389"></a>10389    
<a name="l10390"></a>10390    <span class="keywordflow">if</span> (<a class="code" href="taskprocessor_8h.html#a815e690b2db467f47655ebaa5d85fb69" title="Push a task into the specified taskprocessor queue and signal the taskprocessor thread...">ast_taskprocessor_push</a>(<a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a>, <a class="code" href="app__voicemail_8c.html#a61fc9e415905d8224028cce955ec24a4">handle_subscribe</a>, mwist) &lt; 0) {
<a name="l10391"></a>10391       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(mwist);
<a name="l10392"></a>10392    }
<a name="l10393"></a>10393 }
<a name="l10394"></a>10394 
<a name="l10395"></a><a class="code" href="app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">10395</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">start_poll_thread</a>(<span class="keywordtype">void</span>)
<a name="l10396"></a>10396 {
<a name="l10397"></a>10397    <a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a> = <a class="code" href="event_8h.html#a517ac17630e7658463b66b309a6ce78f" title="Subscribe to events.">ast_event_subscribe</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79faefc08b90f280fd17876d70595c2c0eda">AST_EVENT_SUB</a>, <a class="code" href="app__voicemail_8c.html#a4e013b433443a9f63bb6321d45a737c0">mwi_sub_event_cb</a>, NULL,
<a name="l10398"></a>10398       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491adef1da9ee188613895b2bbfd05960710" title="Event type Used by: AST_EVENT_SUB, AST_EVENT_UNSUB Payload type: UINT.">AST_EVENT_IE_EVENTTYPE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6a4647cbfacd475cb5067f9f9906107641">AST_EVENT_IE_PLTYPE_UINT</a>, <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>,
<a name="l10399"></a>10399       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l10400"></a>10400 
<a name="l10401"></a>10401    <a class="code" href="app__voicemail_8c.html#a19bcada07e6dab968098269032e41c5b">mwi_unsub_sub</a> = <a class="code" href="event_8h.html#a517ac17630e7658463b66b309a6ce78f" title="Subscribe to events.">ast_event_subscribe</a>(<a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa2cf434566fd9444e02b7bde6e8a40770">AST_EVENT_UNSUB</a>, <a class="code" href="app__voicemail_8c.html#a9ab25be935c7b595006640f268f4e690">mwi_unsub_event_cb</a>, NULL,
<a name="l10402"></a>10402       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491adef1da9ee188613895b2bbfd05960710" title="Event type Used by: AST_EVENT_SUB, AST_EVENT_UNSUB Payload type: UINT.">AST_EVENT_IE_EVENTTYPE</a>, <a class="code" href="event__defs_8h.html#a73dadfa1128d5e75107536e132e758c6a4647cbfacd475cb5067f9f9906107641">AST_EVENT_IE_PLTYPE_UINT</a>, <a class="code" href="event__defs_8h.html#a6fa079412d9d9c1cc539f6d71f37f79fa9a217b1f500680b3e458d62b048c0892">AST_EVENT_MWI</a>,
<a name="l10403"></a>10403       <a class="code" href="event__defs_8h.html#a003673523d7fe265c6738a5a9e49c491a04c78c1362e97d548344c354001c151f">AST_EVENT_IE_END</a>);
<a name="l10404"></a>10404 
<a name="l10405"></a>10405    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a>)
<a name="l10406"></a>10406       <a class="code" href="event_8h.html#ad00ed43b832d15156e03802e8445c15c" title="Report current subscriptions to a subscription subscriber.">ast_event_report_subs</a>(<a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a>);
<a name="l10407"></a>10407 
<a name="l10408"></a>10408    <a class="code" href="app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a> = 1;
<a name="l10409"></a>10409 
<a name="l10410"></a>10410    <a class="code" href="utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;<a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a>, NULL, <a class="code" href="app__voicemail_8c.html#a3643ef3067a8048f7a36abee577fdfe9">mb_poll_thread</a>, NULL);
<a name="l10411"></a>10411 }
<a name="l10412"></a>10412 
<a name="l10413"></a><a class="code" href="app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">10413</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a>(<span class="keywordtype">void</span>)
<a name="l10414"></a>10414 {
<a name="l10415"></a>10415    <a class="code" href="app__voicemail_8c.html#aa3e040b5c57658872817f5859bc653d4">poll_thread_run</a> = 0;
<a name="l10416"></a>10416 
<a name="l10417"></a>10417    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a>) {
<a name="l10418"></a>10418       <a class="code" href="event_8h.html#a71eb177cf8553883be773f1534e8a09a" title="Un-subscribe from events.">ast_event_unsubscribe</a>(<a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a>);
<a name="l10419"></a>10419       <a class="code" href="app__voicemail_8c.html#ac6daf6e3fd7c1406e664a4fa77a6161f">mwi_sub_sub</a> = NULL;
<a name="l10420"></a>10420    }
<a name="l10421"></a>10421 
<a name="l10422"></a>10422    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a19bcada07e6dab968098269032e41c5b">mwi_unsub_sub</a>) {
<a name="l10423"></a>10423       <a class="code" href="event_8h.html#a71eb177cf8553883be773f1534e8a09a" title="Un-subscribe from events.">ast_event_unsubscribe</a>(<a class="code" href="app__voicemail_8c.html#a19bcada07e6dab968098269032e41c5b">mwi_unsub_sub</a>);
<a name="l10424"></a>10424       <a class="code" href="app__voicemail_8c.html#a19bcada07e6dab968098269032e41c5b">mwi_unsub_sub</a> = NULL;
<a name="l10425"></a>10425    }
<a name="l10426"></a>10426 
<a name="l10427"></a>10427    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;poll_lock);
<a name="l10428"></a>10428    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="app__voicemail_8c.html#acf07ed2eba262b9d8580db31f6a0bd1f">poll_cond</a>);
<a name="l10429"></a>10429    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;poll_lock);
<a name="l10430"></a>10430 
<a name="l10431"></a>10431    pthread_join(<a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a>, NULL);
<a name="l10432"></a>10432 
<a name="l10433"></a>10433    <a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l10434"></a>10434 }
<a name="l10435"></a>10435 <span class="comment"></span>
<a name="l10436"></a>10436 <span class="comment">/*! \brief Manager list voicemail users command */</span>
<a name="l10437"></a><a class="code" href="app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752">10437</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752" title="Manager list voicemail users command.">manager_list_voicemail_users</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l10438"></a>10438 {
<a name="l10439"></a>10439    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu = NULL;
<a name="l10440"></a>10440    <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">id</span> = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l10441"></a>10441    <span class="keywordtype">char</span> actionid[128] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l10442"></a>10442 
<a name="l10443"></a>10443    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(<span class="keywordtype">id</span>))
<a name="l10444"></a>10444       snprintf(actionid, <span class="keyword">sizeof</span>(actionid), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, <span class="keywordtype">id</span>);
<a name="l10445"></a>10445 
<a name="l10446"></a>10446    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10447"></a>10447 
<a name="l10448"></a>10448    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>)) {
<a name="l10449"></a>10449       <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;There are no voicemail users currently defined.&quot;</span>);
<a name="l10450"></a>10450       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10451"></a>10451       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l10452"></a>10452    }
<a name="l10453"></a>10453    
<a name="l10454"></a>10454    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, <span class="stringliteral">&quot;Voicemail user list will follow&quot;</span>);
<a name="l10455"></a>10455    
<a name="l10456"></a>10456    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, vmu, list) {
<a name="l10457"></a>10457       <span class="keywordtype">char</span> dirname[256];
<a name="l10458"></a>10458 
<a name="l10459"></a>10459 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l10460"></a>10460 <span class="preprocessor"></span>      <span class="keywordtype">int</span> <span class="keyword">new</span>, old;
<a name="l10461"></a>10461       <a class="code" href="app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, &amp;<span class="keyword">new</span>, &amp;old);
<a name="l10462"></a>10462 <span class="preprocessor">#endif</span>
<a name="l10463"></a>10463 <span class="preprocessor"></span>      
<a name="l10464"></a>10464       <a class="code" href="app__voicemail_8c.html#a9f77d88e0a6a07d752892fa046507c22" title="Creates a file system path expression for a folder within the voicemail data folder...">make_dir</a>(dirname, <span class="keyword">sizeof</span>(dirname), vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, <span class="stringliteral">&quot;INBOX&quot;</span>);
<a name="l10465"></a>10465       <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l10466"></a>10466          <span class="stringliteral">&quot;%s&quot;</span>
<a name="l10467"></a>10467          <span class="stringliteral">&quot;Event: VoicemailUserEntry\r\n&quot;</span>
<a name="l10468"></a>10468          <span class="stringliteral">&quot;VMContext: %s\r\n&quot;</span>
<a name="l10469"></a>10469          <span class="stringliteral">&quot;VoiceMailbox: %s\r\n&quot;</span>
<a name="l10470"></a>10470          <span class="stringliteral">&quot;Fullname: %s\r\n&quot;</span>
<a name="l10471"></a>10471          <span class="stringliteral">&quot;Email: %s\r\n&quot;</span>
<a name="l10472"></a>10472          <span class="stringliteral">&quot;Pager: %s\r\n&quot;</span>
<a name="l10473"></a>10473          <span class="stringliteral">&quot;ServerEmail: %s\r\n&quot;</span>
<a name="l10474"></a>10474          <span class="stringliteral">&quot;MailCommand: %s\r\n&quot;</span>
<a name="l10475"></a>10475          <span class="stringliteral">&quot;Language: %s\r\n&quot;</span>
<a name="l10476"></a>10476          <span class="stringliteral">&quot;TimeZone: %s\r\n&quot;</span>
<a name="l10477"></a>10477          <span class="stringliteral">&quot;Callback: %s\r\n&quot;</span>
<a name="l10478"></a>10478          <span class="stringliteral">&quot;Dialout: %s\r\n&quot;</span>
<a name="l10479"></a>10479          <span class="stringliteral">&quot;UniqueID: %s\r\n&quot;</span>
<a name="l10480"></a>10480          <span class="stringliteral">&quot;ExitContext: %s\r\n&quot;</span>
<a name="l10481"></a>10481          <span class="stringliteral">&quot;SayDurationMinimum: %d\r\n&quot;</span>
<a name="l10482"></a>10482          <span class="stringliteral">&quot;SayEnvelope: %s\r\n&quot;</span>
<a name="l10483"></a>10483          <span class="stringliteral">&quot;SayCID: %s\r\n&quot;</span>
<a name="l10484"></a>10484          <span class="stringliteral">&quot;AttachMessage: %s\r\n&quot;</span>
<a name="l10485"></a>10485          <span class="stringliteral">&quot;AttachmentFormat: %s\r\n&quot;</span>
<a name="l10486"></a>10486          <span class="stringliteral">&quot;DeleteMessage: %s\r\n&quot;</span>
<a name="l10487"></a>10487          <span class="stringliteral">&quot;VolumeGain: %.2f\r\n&quot;</span>
<a name="l10488"></a>10488          <span class="stringliteral">&quot;CanReview: %s\r\n&quot;</span>
<a name="l10489"></a>10489          <span class="stringliteral">&quot;CallOperator: %s\r\n&quot;</span>
<a name="l10490"></a>10490          <span class="stringliteral">&quot;MaxMessageCount: %d\r\n&quot;</span>
<a name="l10491"></a>10491          <span class="stringliteral">&quot;MaxMessageLength: %d\r\n&quot;</span>
<a name="l10492"></a>10492          <span class="stringliteral">&quot;NewMessageCount: %d\r\n&quot;</span>
<a name="l10493"></a>10493 #ifdef IMAP_STORAGE
<a name="l10494"></a>10494          <span class="stringliteral">&quot;OldMessageCount: %d\r\n&quot;</span>
<a name="l10495"></a>10495          <span class="stringliteral">&quot;IMAPUser: %s\r\n&quot;</span>
<a name="l10496"></a>10496 #endif
<a name="l10497"></a>10497          <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l10498"></a>10498          actionid,
<a name="l10499"></a>10499          vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>,
<a name="l10500"></a>10500          vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>,
<a name="l10501"></a>10501          vmu-&gt;<a class="code" href="structast__vm__user.html#a162e24ed53cba3299d6623f91c8910d9">fullname</a>,
<a name="l10502"></a>10502          vmu-&gt;<a class="code" href="structast__vm__user.html#aadd75c09e15efa9061997f033b3f224b">email</a>,
<a name="l10503"></a>10503          vmu-&gt;<a class="code" href="structast__vm__user.html#a29b9b126bac9cc5f1cc334f140f39e8d">pager</a>,
<a name="l10504"></a>10504          vmu-&gt;<a class="code" href="structast__vm__user.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>,
<a name="l10505"></a>10505          vmu-&gt;<a class="code" href="structast__vm__user.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>,
<a name="l10506"></a>10506          vmu-&gt;<a class="code" href="structast__vm__user.html#adf416dc058363e2fd5750c77e2d78bee">language</a>,
<a name="l10507"></a>10507          vmu-&gt;<a class="code" href="structast__vm__user.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>,
<a name="l10508"></a>10508          vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>,
<a name="l10509"></a>10509          vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>,
<a name="l10510"></a>10510          vmu-&gt;<a class="code" href="structast__vm__user.html#a252682ca5737fd5b54db768e742bac81">uniqueid</a>,
<a name="l10511"></a>10511          vmu-&gt;<a class="code" href="structast__vm__user.html#aa9d4a76241ab2a75118261777526e04b">exit</a>,
<a name="l10512"></a>10512          vmu-&gt;<a class="code" href="structast__vm__user.html#a92c95d4eb5c3e28079cff9abe1816423">saydurationm</a>,
<a name="l10513"></a>10513          <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l10514"></a>10514          <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l10515"></a>10515          <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l10516"></a>10516          vmu-&gt;<a class="code" href="structast__vm__user.html#aef31b648e7b4ff25544d343ac1ff926e">attachfmt</a>,
<a name="l10517"></a>10517          <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#ab59ca309f2489a3919dd084022d386d7">VM_DELETE</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l10518"></a>10518          vmu-&gt;<a class="code" href="structast__vm__user.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>,
<a name="l10519"></a>10519          <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l10520"></a>10520          <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>) ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l10521"></a>10521          vmu-&gt;<a class="code" href="structast__vm__user.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a>,
<a name="l10522"></a>10522          vmu-&gt;<a class="code" href="structast__vm__user.html#a7710710968414887abc3b7a89d22f83d">maxsecs</a>,
<a name="l10523"></a>10523 #ifdef IMAP_STORAGE
<a name="l10524"></a>10524          <span class="keyword">new</span>, old, vmu-&gt;imapuser
<a name="l10525"></a>10525 #<span class="keywordflow">else</span>
<a name="l10526"></a>10526          <a class="code" href="app__voicemail_8c.html#a469419101eb621ce1ead45b4792fb5a6" title="Find all .txt files - even if they are not in sequence from 0000.">count_messages</a>(vmu, dirname)
<a name="l10527"></a>10527 #endif
<a name="l10528"></a>10528          );
<a name="l10529"></a>10529    }     
<a name="l10530"></a>10530    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s, <span class="stringliteral">&quot;Event: VoicemailUserEntryComplete\r\n%s\r\n&quot;</span>, actionid);
<a name="l10531"></a>10531 
<a name="l10532"></a>10532    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10533"></a>10533 
<a name="l10534"></a>10534    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7cc1753a05a0821f6c70dd2bccfbab5c">RESULT_SUCCESS</a>;
<a name="l10535"></a>10535 }
<a name="l10536"></a>10536 <span class="comment"></span>
<a name="l10537"></a>10537 <span class="comment">/*! \brief Free the users structure. */</span>
<a name="l10538"></a><a class="code" href="app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101">10538</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101" title="Free the users structure.">free_vm_users</a>(<span class="keywordtype">void</span>) 
<a name="l10539"></a>10539 {
<a name="l10540"></a>10540    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *current;
<a name="l10541"></a>10541    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10542"></a>10542    <span class="keywordflow">while</span> ((current = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>, list))) {
<a name="l10543"></a>10543       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(current, <a class="code" href="app__voicemail_8c.html#af1678d06f5af8cd60ec0ff15490331ab">VM_ALLOCED</a>);
<a name="l10544"></a>10544       <a class="code" href="app__voicemail_8c.html#a32180eaceaf227ae3a255af5af2fa617">free_user</a>(current);
<a name="l10545"></a>10545    }
<a name="l10546"></a>10546    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l10547"></a>10547 }
<a name="l10548"></a>10548 <span class="comment"></span>
<a name="l10549"></a>10549 <span class="comment">/*! \brief Free the zones structure. */</span>
<a name="l10550"></a><a class="code" href="app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473">10550</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473" title="Free the zones structure.">free_vm_zones</a>(<span class="keywordtype">void</span>)
<a name="l10551"></a>10551 {
<a name="l10552"></a>10552    <span class="keyword">struct </span><a class="code" href="structvm__zone.html">vm_zone</a> *zcur;
<a name="l10553"></a>10553    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;zones);
<a name="l10554"></a>10554    <span class="keywordflow">while</span> ((zcur = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;zones, list)))
<a name="l10555"></a>10555       <a class="code" href="app__voicemail_8c.html#a24e0f9feb18b6b7cc2bdcf0cabcab0a2">free_zone</a>(zcur);
<a name="l10556"></a>10556    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;zones);
<a name="l10557"></a>10557 }
<a name="l10558"></a>10558 
<a name="l10559"></a><a class="code" href="app__voicemail_8c.html#ab5cd9e7a9d7c43f1b3d03cd65c23a2a6">10559</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__voicemail_8c.html#ab5cd9e7a9d7c43f1b3d03cd65c23a2a6">substitute_escapes</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *value)
<a name="l10560"></a>10560 {
<a name="l10561"></a>10561    <span class="keywordtype">char</span> *current;
<a name="l10562"></a>10562 
<a name="l10563"></a>10563    <span class="comment">/* Add 16 for fudge factor */</span>
<a name="l10564"></a>10564    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *str = <a class="code" href="strings_8h.html#affe8ca3cf8ee9ab07fe29d11bc824ac4" title="Retrieve a thread locally stored dynamic string.">ast_str_thread_get</a>(&amp;ast_str_thread_global_buf, strlen(value) + 16);
<a name="l10565"></a>10565 
<a name="l10566"></a>10566    <a class="code" href="strings_8h.html#a7820deea616cbb2e28f16d518de91c80" title="Reset the content of a dynamic string. Useful before a series of ast_str_append.">ast_str_reset</a>(str);
<a name="l10567"></a>10567    
<a name="l10568"></a>10568    <span class="comment">/* Substitute strings \r, \n, and \t into the appropriate characters */</span>
<a name="l10569"></a>10569    <span class="keywordflow">for</span> (current = (<span class="keywordtype">char</span> *) value; *current; current++) {
<a name="l10570"></a>10570       <span class="keywordflow">if</span> (*current == <span class="charliteral">&apos;\\&apos;</span>) {
<a name="l10571"></a>10571          current++;
<a name="l10572"></a>10572          <span class="keywordflow">if</span> (!*current) {
<a name="l10573"></a>10573             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Incomplete escape at end of value.\n&quot;</span>);
<a name="l10574"></a>10574             <span class="keywordflow">break</span>;
<a name="l10575"></a>10575          }
<a name="l10576"></a>10576          <span class="keywordflow">switch</span> (*current) {
<a name="l10577"></a>10577          <span class="keywordflow">case</span> <span class="charliteral">&apos;r&apos;</span>:
<a name="l10578"></a>10578             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\r&quot;</span>);
<a name="l10579"></a>10579             <span class="keywordflow">break</span>;
<a name="l10580"></a>10580          <span class="keywordflow">case</span> <span class="charliteral">&apos;n&apos;</span>:
<a name="l10581"></a>10581 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l10582"></a>10582 <span class="preprocessor"></span>            <span class="keywordflow">if</span> (!str-&gt;used || str-&gt;str[str-&gt;used - 1] != <span class="charliteral">&apos;\r&apos;</span>) {
<a name="l10583"></a>10583                <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\r&quot;</span>);
<a name="l10584"></a>10584             }
<a name="l10585"></a>10585 <span class="preprocessor">#endif</span>
<a name="l10586"></a>10586 <span class="preprocessor"></span>            <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l10587"></a>10587             <span class="keywordflow">break</span>;
<a name="l10588"></a>10588          <span class="keywordflow">case</span> <span class="charliteral">&apos;t&apos;</span>:
<a name="l10589"></a>10589             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;\t&quot;</span>);
<a name="l10590"></a>10590             <span class="keywordflow">break</span>;
<a name="l10591"></a>10591          <span class="keywordflow">default</span>:
<a name="l10592"></a>10592             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad6810d73cb786e5e74c55c8bd8688e05">AST_LOG_NOTICE</a>, <span class="stringliteral">&quot;Substitution routine does not support this character: \\%c\n&quot;</span>, *current);
<a name="l10593"></a>10593             <span class="keywordflow">break</span>;
<a name="l10594"></a>10594          }
<a name="l10595"></a>10595       } <span class="keywordflow">else</span> {
<a name="l10596"></a>10596          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;str, 0, <span class="stringliteral">&quot;%c&quot;</span>, *current);
<a name="l10597"></a>10597       }
<a name="l10598"></a>10598    }
<a name="l10599"></a>10599 
<a name="l10600"></a>10600    <span class="keywordflow">return</span> <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(str);
<a name="l10601"></a>10601 }
<a name="l10602"></a>10602 
<a name="l10603"></a><a class="code" href="app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">10603</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(<span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l10604"></a>10604 {
<a name="l10605"></a>10605    <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> *current;
<a name="l10606"></a>10606    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg, *ucfg;
<a name="l10607"></a>10607    <span class="keywordtype">char</span> *cat;
<a name="l10608"></a>10608    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *var;
<a name="l10609"></a>10609    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>;
<a name="l10610"></a>10610    <span class="keywordtype">char</span> *q, *stringp, *tmp;
<a name="l10611"></a>10611    <span class="keywordtype">int</span> x;
<a name="l10612"></a>10612    <span class="keywordtype">int</span> tmpadsi[4];
<a name="l10613"></a>10613    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l10614"></a>10614 
<a name="l10615"></a>10615    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>);
<a name="l10616"></a>10616    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>);
<a name="l10617"></a>10617 
<a name="l10618"></a>10618    <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__directory_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, config_flags)) == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l10619"></a>10619       <span class="keywordflow">if</span> ((ucfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l10620"></a>10620          <span class="keywordflow">return</span> 0;
<a name="l10621"></a>10621       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (ucfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l10622"></a>10622          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file users.conf is in an invalid format.  Avoiding.\n&quot;</span>);
<a name="l10623"></a>10623          ucfg = NULL;
<a name="l10624"></a>10624       }
<a name="l10625"></a>10625       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;config_flags, <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a>);
<a name="l10626"></a>10626       <span class="keywordflow">if</span> ((cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__directory_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a>, config_flags)) == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l10627"></a>10627          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(ucfg);
<a name="l10628"></a>10628          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="app__directory_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l10629"></a>10629          <span class="keywordflow">return</span> 0;
<a name="l10630"></a>10630       }
<a name="l10631"></a>10631    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l10632"></a>10632       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="app__directory_8c.html#a62e6fabd28e7d7a9941945c7fde3bda6">VOICEMAIL_CONFIG</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l10633"></a>10633       <span class="keywordflow">return</span> 0;
<a name="l10634"></a>10634    } <span class="keywordflow">else</span> {
<a name="l10635"></a>10635       <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(&amp;config_flags, <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a>);
<a name="l10636"></a>10636       <span class="keywordflow">if</span> ((ucfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;users.conf&quot;</span>, config_flags)) == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l10637"></a>10637          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file users.conf is in an invalid format.  Avoiding.\n&quot;</span>);
<a name="l10638"></a>10638          ucfg = NULL;
<a name="l10639"></a>10639       }
<a name="l10640"></a>10640    }
<a name="l10641"></a>10641 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l10642"></a>10642 <span class="preprocessor"></span>   <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapparentfolder, <span class="stringliteral">&quot;\0&quot;</span>, <span class="keyword">sizeof</span>(imapparentfolder));
<a name="l10643"></a>10643 <span class="preprocessor">#endif</span>
<a name="l10644"></a>10644 <span class="preprocessor"></span>   <span class="comment">/* set audio control prompts */</span>
<a name="l10645"></a>10645    strcpy(<a class="code" href="app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a>,<a class="code" href="app__voicemail_8c.html#a1eb1e0cbaef35879c60c6afd79dcc6af">DEFAULT_LISTEN_CONTROL_FORWARD_KEY</a>);
<a name="l10646"></a>10646    strcpy(<a class="code" href="app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a>,<a class="code" href="app__voicemail_8c.html#adf398fc1e24857033174482891adab4a">DEFAULT_LISTEN_CONTROL_REVERSE_KEY</a>);
<a name="l10647"></a>10647    strcpy(<a class="code" href="app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a>,<a class="code" href="app__voicemail_8c.html#aab009b1bd02c3b2580f86581c9fa2c70">DEFAULT_LISTEN_CONTROL_PAUSE_KEY</a>);
<a name="l10648"></a>10648    strcpy(<a class="code" href="app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a>,<a class="code" href="app__voicemail_8c.html#a724057a0c369a6b5dd798ccc31cf53f2">DEFAULT_LISTEN_CONTROL_RESTART_KEY</a>);
<a name="l10649"></a>10649    strcpy(<a class="code" href="app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a>,<a class="code" href="app__voicemail_8c.html#a7decd8d5e42401e22d0d86d150e70a04">DEFAULT_LISTEN_CONTROL_STOP_KEY</a>);
<a name="l10650"></a>10650 
<a name="l10651"></a>10651    <span class="comment">/* Free all the users structure */</span>  
<a name="l10652"></a>10652    <a class="code" href="app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101" title="Free the users structure.">free_vm_users</a>();
<a name="l10653"></a>10653 
<a name="l10654"></a>10654    <span class="comment">/* Free all the zones structure */</span>
<a name="l10655"></a>10655    <a class="code" href="app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473" title="Free the zones structure.">free_vm_zones</a>();
<a name="l10656"></a>10656 
<a name="l10657"></a>10657    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);  
<a name="l10658"></a>10658 
<a name="l10659"></a>10659    memset(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>));
<a name="l10660"></a>10660    memset(<a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>));
<a name="l10661"></a>10661 
<a name="l10662"></a>10662    <span class="keywordflow">if</span> (cfg) {
<a name="l10663"></a>10663       <span class="comment">/* General settings */</span>
<a name="l10664"></a>10664 
<a name="l10665"></a>10665       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;userscontext&quot;</span>)))
<a name="l10666"></a>10666          val = <span class="stringliteral">&quot;default&quot;</span>;
<a name="l10667"></a>10667       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>));
<a name="l10668"></a>10668       <span class="comment">/* Attach voice message to mail message ? */</span>
<a name="l10669"></a>10669       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;attach&quot;</span>))) 
<a name="l10670"></a>10670          val = <span class="stringliteral">&quot;yes&quot;</span>;
<a name="l10671"></a>10671       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a893427f4de0013bcc1a008cdd77111a4">VM_ATTACH</a>); 
<a name="l10672"></a>10672 
<a name="l10673"></a>10673       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;searchcontexts&quot;</span>)))
<a name="l10674"></a>10674          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l10675"></a>10675       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a04ac58e561105b9614ff3539c505ba13">VM_SEARCH</a>);
<a name="l10676"></a>10676 
<a name="l10677"></a>10677       <a class="code" href="app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a> = 0.0;
<a name="l10678"></a>10678       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;volgain&quot;</span>)))
<a name="l10679"></a>10679          sscanf(val, <span class="stringliteral">&quot;%30lf&quot;</span>, &amp;<a class="code" href="app__voicemail_8c.html#a97d0f923218857a92e83d94dcbfe0263">volgain</a>);
<a name="l10680"></a>10680 
<a name="l10681"></a>10681 <span class="preprocessor">#ifdef ODBC_STORAGE</span>
<a name="l10682"></a>10682 <span class="preprocessor"></span>      strcpy(odbc_database, <span class="stringliteral">&quot;asterisk&quot;</span>);
<a name="l10683"></a>10683       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;odbcstorage&quot;</span>))) {
<a name="l10684"></a>10684          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(odbc_database, val, <span class="keyword">sizeof</span>(odbc_database));
<a name="l10685"></a>10685       }
<a name="l10686"></a>10686       strcpy(odbc_table, <span class="stringliteral">&quot;voicemessages&quot;</span>);
<a name="l10687"></a>10687       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;odbctable&quot;</span>))) {
<a name="l10688"></a>10688          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(odbc_table, val, <span class="keyword">sizeof</span>(odbc_table));
<a name="l10689"></a>10689       }
<a name="l10690"></a>10690 <span class="preprocessor">#endif      </span>
<a name="l10691"></a>10691 <span class="preprocessor"></span>      <span class="comment">/* Mail command */</span>
<a name="l10692"></a>10692       strcpy(<a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>, <a class="code" href="app__minivm_8c.html#a92d8fb2d08cf9220d520ae9691b5e6c4" title="Default mail command to mail voicemail. Change it with the mailcmd= command in voicemail...">SENDMAIL</a>);
<a name="l10693"></a>10693       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;mailcmd&quot;</span>)))
<a name="l10694"></a>10694          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a1f5a71f874226acc1147ab54fff050a3">mailcmd</a>)); <span class="comment">/* User setting */</span>
<a name="l10695"></a>10695 
<a name="l10696"></a>10696       <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> = 0;
<a name="l10697"></a>10697       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxsilence&quot;</span>))) {
<a name="l10698"></a>10698          <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> = atoi(val);
<a name="l10699"></a>10699          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> &gt; 0)
<a name="l10700"></a>10700             <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> *= 1000;
<a name="l10701"></a>10701       }
<a name="l10702"></a>10702       
<a name="l10703"></a>10703       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxmsg&quot;</span>))) {
<a name="l10704"></a>10704          <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l10705"></a>10705       } <span class="keywordflow">else</span> {
<a name="l10706"></a>10706          <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = atoi(val);
<a name="l10707"></a>10707          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &lt;= 0) {
<a name="l10708"></a>10708             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of messages per folder &apos;%s&apos;. Using default value %i\n&quot;</span>, val, <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);
<a name="l10709"></a>10709             <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l10710"></a>10710          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> &gt; <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {
<a name="l10711"></a>10711             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of messages per folder is %i. Cannot accept value &apos;%s&apos;\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, val);
<a name="l10712"></a>10712             <a class="code" href="app__voicemail_8c.html#a4cdc273d6b190940a91df6042d385099">maxmsg</a> = <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;
<a name="l10713"></a>10713          }
<a name="l10714"></a>10714       }
<a name="l10715"></a>10715 
<a name="l10716"></a>10716       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;backupdeleted&quot;</span>))) {
<a name="l10717"></a>10717          <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = 0;
<a name="l10718"></a>10718       } <span class="keywordflow">else</span> {
<a name="l10719"></a>10719          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1)
<a name="l10720"></a>10720             <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = x;
<a name="l10721"></a>10721          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val))
<a name="l10722"></a>10722             <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l10723"></a>10723          <span class="keywordflow">else</span>
<a name="l10724"></a>10724             <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = 0;
<a name="l10725"></a>10725 
<a name="l10726"></a>10726          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> &lt; 0) {
<a name="l10727"></a>10727             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid number of deleted messages saved per mailbox &apos;%s&apos;. Using default value %i\n&quot;</span>, val, <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>);
<a name="l10728"></a>10728             <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#a6e31d0ed0d32a0655e13233ddf82bf43">MAXMSG</a>;
<a name="l10729"></a>10729          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> &gt; <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>) {
<a name="l10730"></a>10730             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum number of deleted messages saved per mailbox is %i. Cannot accept value &apos;%s&apos;\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>, val);
<a name="l10731"></a>10731             <a class="code" href="app__voicemail_8c.html#ab46529fc3aca41f01be29d17fdcb2301">maxdeletedmsg</a> = <a class="code" href="app__voicemail_8c.html#ae5938cc449b29ca82b939b7d746b5689">MAXMSGLIMIT</a>;
<a name="l10732"></a>10732          }
<a name="l10733"></a>10733       }
<a name="l10734"></a>10734 
<a name="l10735"></a>10735       <span class="comment">/* Load date format config for voicemail mail */</span>
<a name="l10736"></a>10736       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;emaildateformat&quot;</span>))) {
<a name="l10737"></a>10737          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a836c1d4ec952b85cec781651bebba908">emaildateformat</a>));
<a name="l10738"></a>10738       }
<a name="l10739"></a>10739 
<a name="l10740"></a>10740       <span class="comment">/* External password changing command */</span>
<a name="l10741"></a>10741       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externpass&quot;</span>))) {
<a name="l10742"></a>10742          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>,val,<span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>));
<a name="l10743"></a>10743          <a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> = <a class="code" href="app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a>;
<a name="l10744"></a>10744       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externpassnotify&quot;</span>))) {
<a name="l10745"></a>10745          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>,val,<span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a95f0f63bc1e6a4c06a3449e2375f74be">ext_pass_cmd</a>));
<a name="l10746"></a>10746          <a class="code" href="app__voicemail_8c.html#a19699e5ae6b6319ff1d158c855d2bc84">pwdchange</a> = <a class="code" href="app__voicemail_8c.html#ad390f774c486c5adb506f2862564c57a">PWDCHANGE_EXTERNAL</a> | <a class="code" href="app__voicemail_8c.html#a73461ccedc28b990ab321ae8dae2e03b">PWDCHANGE_INTERNAL</a>;
<a name="l10747"></a>10747       }
<a name="l10748"></a>10748  
<a name="l10749"></a>10749       <span class="comment">/* External password validation command */</span>
<a name="l10750"></a>10750       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externpasscheck&quot;</span>))) {
<a name="l10751"></a>10751          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>));
<a name="l10752"></a>10752          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a739c2b2152120f3ac341424b9a595562">AST_LOG_DEBUG</a>, <span class="stringliteral">&quot;found externpasscheck: %s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#a672efc9a126f87f2aaab9f0bac2870f5">ext_pass_check_cmd</a>);
<a name="l10753"></a>10753       }
<a name="l10754"></a>10754 
<a name="l10755"></a>10755 <span class="preprocessor">#ifdef IMAP_STORAGE</span>
<a name="l10756"></a>10756 <span class="preprocessor"></span>      <span class="comment">/* IMAP server address */</span>
<a name="l10757"></a>10757       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapserver&quot;</span>))) {
<a name="l10758"></a>10758          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapserver, val, <span class="keyword">sizeof</span>(imapserver));
<a name="l10759"></a>10759       } <span class="keywordflow">else</span> {
<a name="l10760"></a>10760          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapserver,<span class="stringliteral">&quot;localhost&quot;</span>, <span class="keyword">sizeof</span>(imapserver));
<a name="l10761"></a>10761       }
<a name="l10762"></a>10762       <span class="comment">/* IMAP server port */</span>
<a name="l10763"></a>10763       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapport&quot;</span>))) {
<a name="l10764"></a>10764          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapport, val, <span class="keyword">sizeof</span>(imapport));
<a name="l10765"></a>10765       } <span class="keywordflow">else</span> {
<a name="l10766"></a>10766          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapport,<span class="stringliteral">&quot;143&quot;</span>, <span class="keyword">sizeof</span>(imapport));
<a name="l10767"></a>10767       }
<a name="l10768"></a>10768       <span class="comment">/* IMAP server flags */</span>
<a name="l10769"></a>10769       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapflags&quot;</span>))) {
<a name="l10770"></a>10770          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapflags, val, <span class="keyword">sizeof</span>(imapflags));
<a name="l10771"></a>10771       }
<a name="l10772"></a>10772       <span class="comment">/* IMAP server master username */</span>
<a name="l10773"></a>10773       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;authuser&quot;</span>))) {
<a name="l10774"></a>10774          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(authuser, val, <span class="keyword">sizeof</span>(authuser));
<a name="l10775"></a>10775       }
<a name="l10776"></a>10776       <span class="comment">/* IMAP server master password */</span>
<a name="l10777"></a>10777       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;authpassword&quot;</span>))) {
<a name="l10778"></a>10778          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(authpassword, val, <span class="keyword">sizeof</span>(authpassword));
<a name="l10779"></a>10779       }
<a name="l10780"></a>10780       <span class="comment">/* Expunge on exit */</span>
<a name="l10781"></a>10781       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;expungeonhangup&quot;</span>))) {
<a name="l10782"></a>10782          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(val))
<a name="l10783"></a>10783             expungeonhangup = 0;
<a name="l10784"></a>10784          <span class="keywordflow">else</span>
<a name="l10785"></a>10785             expungeonhangup = 1;
<a name="l10786"></a>10786       } <span class="keywordflow">else</span> {
<a name="l10787"></a>10787          expungeonhangup = 1;
<a name="l10788"></a>10788       }
<a name="l10789"></a>10789       <span class="comment">/* IMAP voicemail folder */</span>
<a name="l10790"></a>10790       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapfolder&quot;</span>))) {
<a name="l10791"></a>10791          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapfolder, val, <span class="keyword">sizeof</span>(imapfolder));
<a name="l10792"></a>10792       } <span class="keywordflow">else</span> {
<a name="l10793"></a>10793          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapfolder,<span class="stringliteral">&quot;INBOX&quot;</span>, <span class="keyword">sizeof</span>(imapfolder));
<a name="l10794"></a>10794       }
<a name="l10795"></a>10795       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapparentfolder&quot;</span>))) {
<a name="l10796"></a>10796          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(imapparentfolder, val, <span class="keyword">sizeof</span>(imapparentfolder));
<a name="l10797"></a>10797       }
<a name="l10798"></a>10798       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapgreetings&quot;</span>))) {
<a name="l10799"></a>10799          imapgreetings = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l10800"></a>10800       } <span class="keywordflow">else</span> {
<a name="l10801"></a>10801          imapgreetings = 0;
<a name="l10802"></a>10802       }
<a name="l10803"></a>10803       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;greetingfolder&quot;</span>))) {
<a name="l10804"></a>10804          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(greetingfolder, val, <span class="keyword">sizeof</span>(greetingfolder));
<a name="l10805"></a>10805       } <span class="keywordflow">else</span> {
<a name="l10806"></a>10806          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(greetingfolder, imapfolder, <span class="keyword">sizeof</span>(greetingfolder));
<a name="l10807"></a>10807       }
<a name="l10808"></a>10808 
<a name="l10809"></a>10809       <span class="comment">/* There is some very unorthodox casting done here. This is due</span>
<a name="l10810"></a>10810 <span class="comment">       * to the way c-client handles the argument passed in. It expects a </span>
<a name="l10811"></a>10811 <span class="comment">       * void pointer and casts the pointer directly to a long without</span>
<a name="l10812"></a>10812 <span class="comment">       * first dereferencing it. */</span>
<a name="l10813"></a>10813       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapreadtimeout&quot;</span>))) {
<a name="l10814"></a>10814          mail_parameters(NIL, SET_READTIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));
<a name="l10815"></a>10815       } <span class="keywordflow">else</span> {
<a name="l10816"></a>10816          mail_parameters(NIL, SET_READTIMEOUT, (<span class="keywordtype">void</span> *) 60L);
<a name="l10817"></a>10817       }
<a name="l10818"></a>10818 
<a name="l10819"></a>10819       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapwritetimeout&quot;</span>))) {
<a name="l10820"></a>10820          mail_parameters(NIL, SET_WRITETIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));
<a name="l10821"></a>10821       } <span class="keywordflow">else</span> {
<a name="l10822"></a>10822          mail_parameters(NIL, SET_WRITETIMEOUT, (<span class="keywordtype">void</span> *) 60L);
<a name="l10823"></a>10823       }
<a name="l10824"></a>10824 
<a name="l10825"></a>10825       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapopentimeout&quot;</span>))) {
<a name="l10826"></a>10826          mail_parameters(NIL, SET_OPENTIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));
<a name="l10827"></a>10827       } <span class="keywordflow">else</span> {
<a name="l10828"></a>10828          mail_parameters(NIL, SET_OPENTIMEOUT, (<span class="keywordtype">void</span> *) 60L);
<a name="l10829"></a>10829       }
<a name="l10830"></a>10830 
<a name="l10831"></a>10831       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;imapclosetimeout&quot;</span>))) {
<a name="l10832"></a>10832          mail_parameters(NIL, SET_CLOSETIMEOUT, (<span class="keywordtype">void</span> *) (atol(val)));
<a name="l10833"></a>10833       } <span class="keywordflow">else</span> {
<a name="l10834"></a>10834          mail_parameters(NIL, SET_CLOSETIMEOUT, (<span class="keywordtype">void</span> *) 60L);
<a name="l10835"></a>10835       }
<a name="l10836"></a>10836 
<a name="l10837"></a>10837       <span class="comment">/* Increment configuration version */</span>
<a name="l10838"></a>10838       imapversion++;
<a name="l10839"></a>10839 <span class="preprocessor">#endif</span>
<a name="l10840"></a>10840 <span class="preprocessor"></span>      <span class="comment">/* External voicemail notify application */</span>
<a name="l10841"></a>10841       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;externnotify&quot;</span>))) {
<a name="l10842"></a>10842          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>));
<a name="l10843"></a>10843          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;found externnotify: %s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>);
<a name="l10844"></a>10844       } <span class="keywordflow">else</span> {
<a name="l10845"></a>10845          <a class="code" href="app__voicemail_8c.html#aa2f937e69f79fbfcbf13a8ca51adcce0">externnotify</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l10846"></a>10846       }
<a name="l10847"></a>10847 
<a name="l10848"></a>10848       <span class="comment">/* SMDI voicemail notification */</span>
<a name="l10849"></a>10849       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;smdienable&quot;</span>)) &amp;&amp; <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val)) {
<a name="l10850"></a>10850          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Enabled SMDI voicemail notification\n&quot;</span>);
<a name="l10851"></a>10851          <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;smdiport&quot;</span>))) {
<a name="l10852"></a>10852             <a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a> = <a class="code" href="smdi_8h.html#aa5a1e111a1c9346decb38270aeb28c29" title="Find an SMDI interface with the specified name.">ast_smdi_interface_find</a> ? <a class="code" href="smdi_8h.html#aa5a1e111a1c9346decb38270aeb28c29" title="Find an SMDI interface with the specified name.">ast_smdi_interface_find</a>(val) : NULL;
<a name="l10853"></a>10853          } <span class="keywordflow">else</span> {
<a name="l10854"></a>10854             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No SMDI interface set, trying default (/dev/ttyS0)\n&quot;</span>);
<a name="l10855"></a>10855             <a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a> = <a class="code" href="smdi_8h.html#aa5a1e111a1c9346decb38270aeb28c29" title="Find an SMDI interface with the specified name.">ast_smdi_interface_find</a> ? <a class="code" href="smdi_8h.html#aa5a1e111a1c9346decb38270aeb28c29" title="Find an SMDI interface with the specified name.">ast_smdi_interface_find</a>(<span class="stringliteral">&quot;/dev/ttyS0&quot;</span>) : NULL;
<a name="l10856"></a>10856          }
<a name="l10857"></a>10857          <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#af9bb0c022848cf3af1e8e51ae3c18e06">smdi_iface</a>) {
<a name="l10858"></a>10858             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;No valid SMDI interface specfied, disabling SMDI voicemail notification\n&quot;</span>);
<a name="l10859"></a>10859          } 
<a name="l10860"></a>10860       }
<a name="l10861"></a>10861 
<a name="l10862"></a>10862       <span class="comment">/* Silence treshold */</span>
<a name="l10863"></a>10863       <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a> = <a class="code" href="dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca" title="Get silence threshold from dsp.conf.">ast_dsp_get_threshold_from_settings</a>(<a class="code" href="dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a>);
<a name="l10864"></a>10864       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;silencethreshold&quot;</span>)))
<a name="l10865"></a>10865          <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a> = atoi(val);
<a name="l10866"></a>10866       
<a name="l10867"></a>10867       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;serveremail&quot;</span>))) 
<a name="l10868"></a>10868          val = <a class="code" href="app__minivm_8c.html#a5e790f0ee1dbde79705c49bf33a1060d">ASTERISK_USERNAME</a>;
<a name="l10869"></a>10869       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a0d189d088982b574837ebaee7cd4ccbd">serveremail</a>));
<a name="l10870"></a>10870       
<a name="l10871"></a>10871       <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a> = 0;
<a name="l10872"></a>10872       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxsecs&quot;</span>))) {
<a name="l10873"></a>10873          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10874"></a>10874             <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a> = x;
<a name="l10875"></a>10875          } <span class="keywordflow">else</span> {
<a name="l10876"></a>10876             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message time length\n&quot;</span>);
<a name="l10877"></a>10877          }
<a name="l10878"></a>10878       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxmessage&quot;</span>))) {
<a name="l10879"></a>10879          <span class="keyword">static</span> <span class="keywordtype">int</span> maxmessage_deprecate = 0;
<a name="l10880"></a>10880          <span class="keywordflow">if</span> (maxmessage_deprecate == 0) {
<a name="l10881"></a>10881             maxmessage_deprecate = 1;
<a name="l10882"></a>10882             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Setting &apos;maxmessage&apos; has been deprecated in favor of &apos;maxsecs&apos;.\n&quot;</span>);
<a name="l10883"></a>10883          }
<a name="l10884"></a>10884          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10885"></a>10885             <a class="code" href="app__voicemail_8c.html#adaba37f7e2da2832461a35139379eae1">vmmaxsecs</a> = x;
<a name="l10886"></a>10886          } <span class="keywordflow">else</span> {
<a name="l10887"></a>10887             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message time length\n&quot;</span>);
<a name="l10888"></a>10888          }
<a name="l10889"></a>10889       }
<a name="l10890"></a>10890 
<a name="l10891"></a>10891       <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a> = 0;
<a name="l10892"></a>10892       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;minsecs&quot;</span>))) {
<a name="l10893"></a>10893          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10894"></a>10894             <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a> = x;
<a name="l10895"></a>10895             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> / 1000 &gt;= <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>) {
<a name="l10896"></a>10896                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;maxsilence should be less than minsecs or you may get empty messages\n&quot;</span>);
<a name="l10897"></a>10897             }
<a name="l10898"></a>10898          } <span class="keywordflow">else</span> {
<a name="l10899"></a>10899             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min message time length\n&quot;</span>);
<a name="l10900"></a>10900          }
<a name="l10901"></a>10901       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;minmessage&quot;</span>))) {
<a name="l10902"></a>10902          <span class="keyword">static</span> <span class="keywordtype">int</span> maxmessage_deprecate = 0;
<a name="l10903"></a>10903          <span class="keywordflow">if</span> (maxmessage_deprecate == 0) {
<a name="l10904"></a>10904             maxmessage_deprecate = 1;
<a name="l10905"></a>10905             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Setting &apos;minmessage&apos; has been deprecated in favor of &apos;minsecs&apos;.\n&quot;</span>);
<a name="l10906"></a>10906          }
<a name="l10907"></a>10907          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10908"></a>10908             <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a> = x;
<a name="l10909"></a>10909             <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> / 1000 &gt;= <a class="code" href="app__voicemail_8c.html#a25d922d91d1c3a161cd27f74198f5b46">vmminsecs</a>) {
<a name="l10910"></a>10910                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;maxsilence should be less than minmessage or you may get empty messages\n&quot;</span>);
<a name="l10911"></a>10911             }
<a name="l10912"></a>10912          } <span class="keywordflow">else</span> {
<a name="l10913"></a>10913             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min message time length\n&quot;</span>);
<a name="l10914"></a>10914          }
<a name="l10915"></a>10915       }
<a name="l10916"></a>10916 
<a name="l10917"></a>10917       val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;format&quot;</span>);
<a name="l10918"></a>10918       <span class="keywordflow">if</span> (!val) {
<a name="l10919"></a>10919          val = <span class="stringliteral">&quot;wav&quot;</span>;   
<a name="l10920"></a>10920       } <span class="keywordflow">else</span> {
<a name="l10921"></a>10921          tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(val);
<a name="l10922"></a>10922          val = <a class="code" href="file_8h.html#aa526fd9bb57d7d9afac2113c30d236f8">ast_format_str_reduce</a>(tmp);
<a name="l10923"></a>10923          <span class="keywordflow">if</span> (!val) {
<a name="l10924"></a>10924             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error processing format string, defaulting to format &apos;wav&apos;\n&quot;</span>);
<a name="l10925"></a>10925             val = <span class="stringliteral">&quot;wav&quot;</span>;
<a name="l10926"></a>10926          }
<a name="l10927"></a>10927       }
<a name="l10928"></a>10928       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a4e21bf8fea26018015ea015f7c04b14f">vmfmts</a>));
<a name="l10929"></a>10929 
<a name="l10930"></a>10930       <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a> = 3000;
<a name="l10931"></a>10931       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxgreet&quot;</span>))) {
<a name="l10932"></a>10932          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10933"></a>10933             <a class="code" href="app__voicemail_8c.html#a924855b544cbe4f128ba7f92e929065f">maxgreet</a> = x;
<a name="l10934"></a>10934          } <span class="keywordflow">else</span> {
<a name="l10935"></a>10935             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max message greeting length\n&quot;</span>);
<a name="l10936"></a>10936          }
<a name="l10937"></a>10937       }
<a name="l10938"></a>10938 
<a name="l10939"></a>10939       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;skipms&quot;</span>))) {
<a name="l10940"></a>10940          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10941"></a>10941             <a class="code" href="app__voicemail_8c.html#a1df943a05a384a407a19cf8831b2d237">skipms</a> = x;
<a name="l10942"></a>10942          } <span class="keywordflow">else</span> {
<a name="l10943"></a>10943             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid skipms value\n&quot;</span>);
<a name="l10944"></a>10944          }
<a name="l10945"></a>10945       }
<a name="l10946"></a>10946 
<a name="l10947"></a>10947       <a class="code" href="app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">maxlogins</a> = 3;
<a name="l10948"></a>10948       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;maxlogins&quot;</span>))) {
<a name="l10949"></a>10949          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10950"></a>10950             <a class="code" href="app__voicemail_8c.html#a9c4ef3c868dfcdfbedb244d4f882eec9">maxlogins</a> = x;
<a name="l10951"></a>10951          } <span class="keywordflow">else</span> {
<a name="l10952"></a>10952             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid max failed login attempts\n&quot;</span>);
<a name="l10953"></a>10953          }
<a name="l10954"></a>10954       }
<a name="l10955"></a>10955 
<a name="l10956"></a>10956       <a class="code" href="app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a> = <a class="code" href="app__voicemail_8c.html#aca7150caac3749421acc40d7bc3483f1">MINPASSWORD</a>;
<a name="l10957"></a>10957       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;minpassword&quot;</span>))) {
<a name="l10958"></a>10958          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l10959"></a>10959             <a class="code" href="app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a> = x;
<a name="l10960"></a>10960          } <span class="keywordflow">else</span> {
<a name="l10961"></a>10961             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid minimum password length.  Default to %d\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#acb03f04b845165af39cce94f03ac972b">minpassword</a>);
<a name="l10962"></a>10962          }
<a name="l10963"></a>10963       }
<a name="l10964"></a>10964 
<a name="l10965"></a>10965       <span class="comment">/* Force new user to record name ? */</span>
<a name="l10966"></a>10966       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;forcename&quot;</span>))) 
<a name="l10967"></a>10967          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l10968"></a>10968       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a95c962cfd04d0ad8f41215c1ece03e52">VM_FORCENAME</a>);
<a name="l10969"></a>10969 
<a name="l10970"></a>10970       <span class="comment">/* Force new user to record greetings ? */</span>
<a name="l10971"></a>10971       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;forcegreetings&quot;</span>))) 
<a name="l10972"></a>10972          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l10973"></a>10973       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a77ed313dc3dbb0b5336dd7eb091aa9b9">VM_FORCEGREET</a>);
<a name="l10974"></a>10974 
<a name="l10975"></a>10975       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;cidinternalcontexts&quot;</span>))) {
<a name="l10976"></a>10976          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM_CID Internal context string: %s\n&quot;</span>, val);
<a name="l10977"></a>10977          stringp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(val);
<a name="l10978"></a>10978          <span class="keywordflow">for</span> (x = 0 ; x &lt; <a class="code" href="app__minivm_8c.html#aab88842146c214975db358115d86c726">MAX_NUM_CID_CONTEXTS</a> ; x++){
<a name="l10979"></a>10979             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(stringp)) {
<a name="l10980"></a>10980                q = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l10981"></a>10981                <span class="keywordflow">while</span> ((*q == <span class="charliteral">&apos; &apos;</span>)||(*q == <span class="charliteral">&apos;\t&apos;</span>)) <span class="comment">/* Eat white space between contexts */</span>
<a name="l10982"></a>10982                   q++;
<a name="l10983"></a>10983                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[x], q, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[x]));
<a name="l10984"></a>10984                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;VM_CID Internal context %d: %s\n&quot;</span>, x, <a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[x]);
<a name="l10985"></a>10985             } <span class="keywordflow">else</span> {
<a name="l10986"></a>10986                <a class="code" href="app__voicemail_8c.html#a7a373c1fb8aaab7b824683b13836068e">cidinternalcontexts</a>[x][0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l10987"></a>10987             }
<a name="l10988"></a>10988          }
<a name="l10989"></a>10989       }
<a name="l10990"></a>10990       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;review&quot;</span>))){
<a name="l10991"></a>10991          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;VM Review Option disabled globally\n&quot;</span>);
<a name="l10992"></a>10992          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l10993"></a>10993       }
<a name="l10994"></a>10994       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>); 
<a name="l10995"></a>10995 
<a name="l10996"></a>10996       <span class="comment">/* Temporary greeting reminder */</span>
<a name="l10997"></a>10997       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tempgreetwarn&quot;</span>))) {
<a name="l10998"></a>10998          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM Temporary Greeting Reminder Option disabled globally\n&quot;</span>);
<a name="l10999"></a>10999          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11000"></a>11000       } <span class="keywordflow">else</span> {
<a name="l11001"></a>11001          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM Temporary Greeting Reminder Option enabled globally\n&quot;</span>);
<a name="l11002"></a>11002       }
<a name="l11003"></a>11003       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a1bb81e35de6fe1d146aff63f9d8b7809">VM_TEMPGREETWARN</a>);
<a name="l11004"></a>11004       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;messagewrap&quot;</span>))){
<a name="l11005"></a>11005          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;VM next message wrap disabled globally\n&quot;</span>);
<a name="l11006"></a>11006          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11007"></a>11007       }
<a name="l11008"></a>11008       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a78eb70f28d5f0960e183d68f2c3b6f92">VM_MESSAGEWRAP</a>);  
<a name="l11009"></a>11009 
<a name="l11010"></a>11010       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;operator&quot;</span>))){
<a name="l11011"></a>11011          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;VM Operator break disabled globally\n&quot;</span>);
<a name="l11012"></a>11012          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11013"></a>11013       }
<a name="l11014"></a>11014       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>);  
<a name="l11015"></a>11015 
<a name="l11016"></a>11016       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;saycid&quot;</span>))) {
<a name="l11017"></a>11017          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;VM CID Info before msg disabled globally\n&quot;</span>);
<a name="l11018"></a>11018          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11019"></a>11019       } 
<a name="l11020"></a>11020       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a0f36cea1aee9178611776ab267e0b4b3">VM_SAYCID</a>); 
<a name="l11021"></a>11021 
<a name="l11022"></a>11022       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg,<span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;sendvoicemail&quot;</span>))){
<a name="l11023"></a>11023          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Send Voicemail msg disabled globally\n&quot;</span>);
<a name="l11024"></a>11024          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11025"></a>11025       }
<a name="l11026"></a>11026       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#ad24266c6fec5b36dd7d0cb6fdbd005fa">VM_SVMAIL</a>);
<a name="l11027"></a>11027    
<a name="l11028"></a>11028       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;envelope&quot;</span>))) {
<a name="l11029"></a>11029          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;ENVELOPE before msg enabled globally\n&quot;</span>);
<a name="l11030"></a>11030          val = <span class="stringliteral">&quot;yes&quot;</span>;
<a name="l11031"></a>11031       }
<a name="l11032"></a>11032       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a6cd879daca608982739958c9f4bb787f">VM_ENVELOPE</a>);  
<a name="l11033"></a>11033 
<a name="l11034"></a>11034       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;moveheard&quot;</span>))) {
<a name="l11035"></a>11035          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Move Heard enabled globally\n&quot;</span>);
<a name="l11036"></a>11036          val = <span class="stringliteral">&quot;yes&quot;</span>;
<a name="l11037"></a>11037       }
<a name="l11038"></a>11038       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#aa219febcd18002914767729f33e94f13">VM_MOVEHEARD</a>); 
<a name="l11039"></a>11039 
<a name="l11040"></a>11040       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;forward_urgent_auto&quot;</span>))) {
<a name="l11041"></a>11041          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Autoset of Urgent flag on forwarded Urgent messages disabled globally\n&quot;</span>);
<a name="l11042"></a>11042          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11043"></a>11043       }
<a name="l11044"></a>11044       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a13d1fdecce26d4bee1b43cff66d1c544">VM_FWDURGAUTO</a>);   
<a name="l11045"></a>11045 
<a name="l11046"></a>11046       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;sayduration&quot;</span>))) {
<a name="l11047"></a>11047          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;Duration info before msg enabled globally\n&quot;</span>);
<a name="l11048"></a>11048          val = <span class="stringliteral">&quot;yes&quot;</span>;
<a name="l11049"></a>11049       }
<a name="l11050"></a>11050       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a15737b365a63c894e14d114db2ccddee">VM_SAYDURATION</a>);  
<a name="l11051"></a>11051 
<a name="l11052"></a>11052       <a class="code" href="app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a> = 2;
<a name="l11053"></a>11053       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;saydurationm&quot;</span>))) {
<a name="l11054"></a>11054          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;x) == 1) {
<a name="l11055"></a>11055             <a class="code" href="app__voicemail_8c.html#a888d5641c2b819d8fa55a8c89d4aa301">saydurationminfo</a> = x;
<a name="l11056"></a>11056          } <span class="keywordflow">else</span> {
<a name="l11057"></a>11057             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid min duration for say duration\n&quot;</span>);
<a name="l11058"></a>11058          }
<a name="l11059"></a>11059       }
<a name="l11060"></a>11060 
<a name="l11061"></a>11061       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;nextaftercmd&quot;</span>))) {
<a name="l11062"></a>11062          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1,<span class="stringliteral">&quot;We are not going to skip to the next msg after save/delete\n&quot;</span>);
<a name="l11063"></a>11063          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11064"></a>11064       }
<a name="l11065"></a>11065       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a491df09940a15d84df48c9c1e683acca">VM_SKIPAFTERCMD</a>);
<a name="l11066"></a>11066 
<a name="l11067"></a>11067       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dialout&quot;</span>))) {
<a name="l11068"></a>11068          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>));
<a name="l11069"></a>11069          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;found dialout context: %s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>);
<a name="l11070"></a>11070       } <span class="keywordflow">else</span> {
<a name="l11071"></a>11071          <a class="code" href="app__voicemail_8c.html#a695d5aca89839d016497739454f9779a">dialcontext</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;  
<a name="l11072"></a>11072       }
<a name="l11073"></a>11073       
<a name="l11074"></a>11074       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;callback&quot;</span>))) {
<a name="l11075"></a>11075          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>));
<a name="l11076"></a>11076          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;found callback context: %s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>);
<a name="l11077"></a>11077       } <span class="keywordflow">else</span> {
<a name="l11078"></a>11078          <a class="code" href="app__voicemail_8c.html#ab42ffe446700ea9a17e5798eafabbde8">callcontext</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l11079"></a>11079       }
<a name="l11080"></a>11080 
<a name="l11081"></a>11081       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;exitcontext&quot;</span>))) {
<a name="l11082"></a>11082          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>));
<a name="l11083"></a>11083          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;found operator context: %s\n&quot;</span>, <a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>);
<a name="l11084"></a>11084       } <span class="keywordflow">else</span> {
<a name="l11085"></a>11085          <a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l11086"></a>11086       }
<a name="l11087"></a>11087       
<a name="l11088"></a>11088       <span class="comment">/* load password sounds configuration */</span>
<a name="l11089"></a>11089       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-password&quot;</span>)))
<a name="l11090"></a>11090          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">vm_password</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a0265d0e785a2da7fb9857b6be6f8d6e1">vm_password</a>));
<a name="l11091"></a>11091       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-newpassword&quot;</span>)))
<a name="l11092"></a>11092          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a2fda4e7676a3733ec25d0d2dec3cc49d">vm_newpassword</a>));
<a name="l11093"></a>11093       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-invalid-password&quot;</span>)))
<a name="l11094"></a>11094          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a0358699b7469974a9d59e4b808640576">vm_invalid_password</a>));
<a name="l11095"></a>11095       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-passchanged&quot;</span>)))
<a name="l11096"></a>11096          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#af6c7bd4912342953ac3eaf70e1284f5a">vm_passchanged</a>));
<a name="l11097"></a>11097       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-reenterpassword&quot;</span>)))
<a name="l11098"></a>11098          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a8385f761f8389d40838c0ce72226d8a7">vm_reenterpassword</a>));
<a name="l11099"></a>11099       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-mismatch&quot;</span>)))
<a name="l11100"></a>11100          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a584c1c11a6620ca0ee6d3830689ebbea">vm_mismatch</a>));
<a name="l11101"></a>11101       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;vm-pls-try-again&quot;</span>))) {
<a name="l11102"></a>11102          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a5fb550720f95b169012042cdef395172">vm_pls_try_again</a>));
<a name="l11103"></a>11103       }
<a name="l11104"></a>11104       <span class="comment">/* load configurable audio prompts */</span>
<a name="l11105"></a>11105       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-forward-key&quot;</span>)) &amp;&amp; <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(val))
<a name="l11106"></a>11106          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a393ce5ed70ef6339066d87cae2cd598b">listen_control_forward_key</a>));
<a name="l11107"></a>11107       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-reverse-key&quot;</span>)) &amp;&amp; <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(val))
<a name="l11108"></a>11108          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a0a3bdd4928cf24add43a0a087998820d">listen_control_reverse_key</a>));
<a name="l11109"></a>11109       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-pause-key&quot;</span>)) &amp;&amp; <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(val))
<a name="l11110"></a>11110          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#abc8505638fbf1d579dfbd85d0f0b038f">listen_control_pause_key</a>));
<a name="l11111"></a>11111       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-restart-key&quot;</span>)) &amp;&amp; <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(val))
<a name="l11112"></a>11112          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#aa567daf2013573862651771d53d122f8">listen_control_restart_key</a>));
<a name="l11113"></a>11113       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;listen-control-stop-key&quot;</span>)) &amp;&amp; <a class="code" href="app__voicemail_8c.html#a9609372d445390793d9721bf721b9ccb" title="Determines if a DTMF key entered is valid.">is_valid_dtmf</a>(val))
<a name="l11114"></a>11114          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a7250744aee6e9088d51d864c9deefe1f">listen_control_stop_key</a>));
<a name="l11115"></a>11115 
<a name="l11116"></a>11116       <span class="keywordflow">if</span> (!(val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;usedirectory&quot;</span>))) 
<a name="l11117"></a>11117          val = <span class="stringliteral">&quot;no&quot;</span>;
<a name="l11118"></a>11118       <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#ac663639047fe35b19abc88a4c6a9c0fb">VM_DIRECFORWARD</a>); 
<a name="l11119"></a>11119 
<a name="l11120"></a>11120       <a class="code" href="app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a> = <a class="code" href="app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">DEFAULT_POLL_FREQ</a>;
<a name="l11121"></a>11121       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pollfreq&quot;</span>))) {
<a name="l11122"></a>11122          <span class="keywordflow">if</span> (sscanf(val, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;<a class="code" href="app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a>) != 1) {
<a name="l11123"></a>11123             <a class="code" href="app__voicemail_8c.html#acd54de61052c34990c4d76a8400c759c">poll_freq</a> = <a class="code" href="app__voicemail_8c.html#a6b8784f6ee73401816e2d4fa3264b777">DEFAULT_POLL_FREQ</a>;
<a name="l11124"></a>11124             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2fdd5bff193a29ec6c7278da2851ea56">AST_LOG_ERROR</a>, <span class="stringliteral">&quot;&apos;%s&apos; is not a valid value for the pollfreq option!\n&quot;</span>, val);
<a name="l11125"></a>11125          }
<a name="l11126"></a>11126       }
<a name="l11127"></a>11127 
<a name="l11128"></a>11128       <a class="code" href="app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a> = 0;
<a name="l11129"></a>11129       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pollmailboxes&quot;</span>)))
<a name="l11130"></a>11130          <a class="code" href="app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a> = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l11131"></a>11131 
<a name="l11132"></a>11132       <span class="keywordflow">if</span> (ucfg) { 
<a name="l11133"></a>11133          <span class="keywordflow">for</span> (cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(ucfg, NULL); cat ; cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(ucfg, cat)) {
<a name="l11134"></a>11134             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(<a class="code" href="config_8h.html#ad9fd2625614158b152434e45acf1d78b" title="Retrieve a configuration variable within the configuration set. Retrieves the named...">ast_config_option</a>(ucfg, cat, <span class="stringliteral">&quot;hasvoicemail&quot;</span>)))
<a name="l11135"></a>11135                <span class="keywordflow">continue</span>;
<a name="l11136"></a>11136             <span class="keywordflow">if</span> ((current = <a class="code" href="app__voicemail_8c.html#a6780ac062d86803af3bdc7f9525ffb37">find_or_create</a>(<a class="code" href="app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>, cat))) {
<a name="l11137"></a>11137                <a class="code" href="app__voicemail_8c.html#a29779fb1f6d01dc8ed301b23a394daa0" title="Sets default voicemail system options to a voicemail user.">populate_defaults</a>(current);
<a name="l11138"></a>11138                <a class="code" href="app__voicemail_8c.html#a274f7d7e2262b906dcb14a625067f41f" title="Loads the options specific to a voicemail user.">apply_options_full</a>(current, <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(ucfg, cat));
<a name="l11139"></a>11139                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(current-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="app__voicemail_8c.html#aad7cf03f8da8d217a3f3e964eda3c263">userscontext</a>, <span class="keyword">sizeof</span>(current-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l11140"></a>11140             }
<a name="l11141"></a>11141          }
<a name="l11142"></a>11142          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(ucfg);
<a name="l11143"></a>11143       }
<a name="l11144"></a>11144       cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, NULL);
<a name="l11145"></a>11145       <span class="keywordflow">while</span> (cat) {
<a name="l11146"></a>11146          <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>)) {
<a name="l11147"></a>11147             var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat);
<a name="l11148"></a>11148             <span class="keywordflow">if</span> (strcasecmp(cat, <span class="stringliteral">&quot;zonemessages&quot;</span>)) {
<a name="l11149"></a>11149                <span class="comment">/* Process mailboxes in this context */</span>
<a name="l11150"></a>11150                <span class="keywordflow">while</span> (var) {
<a name="l11151"></a>11151                   <a class="code" href="app__voicemail_8c.html#a7b5b2246bf0b55e177486fa6beb330cc">append_mailbox</a>(cat, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11152"></a>11152                   var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l11153"></a>11153                }
<a name="l11154"></a>11154             } <span class="keywordflow">else</span> {
<a name="l11155"></a>11155                <span class="comment">/* Timezones in this context */</span>
<a name="l11156"></a>11156                <span class="keywordflow">while</span> (var) {
<a name="l11157"></a>11157                   <span class="keyword">struct </span><a class="code" href="structvm__zone.html">vm_zone</a> *z;
<a name="l11158"></a>11158                   <span class="keywordflow">if</span> ((z = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(<span class="keyword">sizeof</span>(*z)))) {
<a name="l11159"></a>11159                      <span class="keywordtype">char</span> *msg_format, *tzone;
<a name="l11160"></a>11160                      msg_format = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l11161"></a>11161                      tzone = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;msg_format, <span class="stringliteral">&quot;|&quot;</span>);
<a name="l11162"></a>11162                      <span class="keywordflow">if</span> (msg_format) {
<a name="l11163"></a>11163                         <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(z-&gt;name, var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keyword">sizeof</span>(z-&gt;name));
<a name="l11164"></a>11164                         <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(z-&gt;timezone, tzone, <span class="keyword">sizeof</span>(z-&gt;timezone));
<a name="l11165"></a>11165                         <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(z-&gt;msg_format, msg_format, <span class="keyword">sizeof</span>(z-&gt;msg_format));
<a name="l11166"></a>11166                         <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;zones);
<a name="l11167"></a>11167                         <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;zones, z, list);
<a name="l11168"></a>11168                         <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;zones);
<a name="l11169"></a>11169                      } <span class="keywordflow">else</span> {
<a name="l11170"></a>11170                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid timezone definition at line %d\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>);
<a name="l11171"></a>11171                         <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(z);
<a name="l11172"></a>11172                      }
<a name="l11173"></a>11173                   } <span class="keywordflow">else</span> {
<a name="l11174"></a>11174                      <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l11175"></a>11175                      <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l11176"></a>11176                      <span class="keywordflow">return</span> -1;
<a name="l11177"></a>11177                   }
<a name="l11178"></a>11178                   var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l11179"></a>11179                }
<a name="l11180"></a>11180             }
<a name="l11181"></a>11181          }
<a name="l11182"></a>11182          cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat);
<a name="l11183"></a>11183       }
<a name="l11184"></a>11184       memset(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>));
<a name="l11185"></a>11185       memset(<a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>));
<a name="l11186"></a>11186       strcpy(<a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>, <span class="stringliteral">&quot;ISO-8859-1&quot;</span>);
<a name="l11187"></a>11187       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>) {
<a name="l11188"></a>11188          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a>);
<a name="l11189"></a>11189          <a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = NULL;
<a name="l11190"></a>11190       }
<a name="l11191"></a>11191       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>) {
<a name="l11192"></a>11192          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a>);
<a name="l11193"></a>11193          <a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = NULL;
<a name="l11194"></a>11194       }
<a name="l11195"></a>11195       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a>) {
<a name="l11196"></a>11196          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a>);
<a name="l11197"></a>11197          <a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a> = NULL;
<a name="l11198"></a>11198       }
<a name="l11199"></a>11199       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a>) {
<a name="l11200"></a>11200          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a>);
<a name="l11201"></a>11201          <a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a> = NULL;
<a name="l11202"></a>11202       }
<a name="l11203"></a>11203       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pbxskip&quot;</span>)))
<a name="l11204"></a>11204          <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>((&amp;<a class="code" href="app__voicemail_8c.html#a3888fe259904a2eb18b173cbf56bfa86">globalflags</a>), <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val), <a class="code" href="app__voicemail_8c.html#a61f1dd805f377ec2c4e32c5ebf01397f">VM_PBXSKIP</a>);
<a name="l11205"></a>11205       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;fromstring&quot;</span>)))
<a name="l11206"></a>11206          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a72e263d6ba290a92142dbd1a61ccc44b">fromstring</a>));
<a name="l11207"></a>11207       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagerfromstring&quot;</span>)))
<a name="l11208"></a>11208          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a011e3f0f5cd9056764ccaba9a75cc8c5">pagerfromstring</a>));
<a name="l11209"></a>11209       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;charset&quot;</span>)))
<a name="l11210"></a>11210          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#ac457ea24c7a0e5a913dba2b65abe24a5">charset</a>));
<a name="l11211"></a>11211       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;adsifdn&quot;</span>))) {
<a name="l11212"></a>11212          sscanf(val, <span class="stringliteral">&quot;%2x%2x%2x%2x&quot;</span>, &amp;tmpadsi[0], &amp;tmpadsi[1], &amp;tmpadsi[2], &amp;tmpadsi[3]);
<a name="l11213"></a>11213          <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++) {
<a name="l11214"></a>11214             memcpy(&amp;<a class="code" href="app__voicemail_8c.html#ad4b005e7fb5a0027448862b2b0f9c8dd">adsifdn</a>[x], &amp;tmpadsi[x], 1);
<a name="l11215"></a>11215          }
<a name="l11216"></a>11216       }
<a name="l11217"></a>11217       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;adsisec&quot;</span>))) {
<a name="l11218"></a>11218          sscanf(val, <span class="stringliteral">&quot;%2x%2x%2x%2x&quot;</span>, &amp;tmpadsi[0], &amp;tmpadsi[1], &amp;tmpadsi[2], &amp;tmpadsi[3]);
<a name="l11219"></a>11219          <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++) {
<a name="l11220"></a>11220             memcpy(&amp;<a class="code" href="app__voicemail_8c.html#a44aadf5d5e3c3253c56d6986e012a767">adsisec</a>[x], &amp;tmpadsi[x], 1);
<a name="l11221"></a>11221          }
<a name="l11222"></a>11222       }
<a name="l11223"></a>11223       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;adsiver&quot;</span>))) {
<a name="l11224"></a>11224          <span class="keywordflow">if</span> (atoi(val)) {
<a name="l11225"></a>11225             <a class="code" href="app__voicemail_8c.html#a99015feb18d767bc5af10ee57f921c37">adsiver</a> = atoi(val);
<a name="l11226"></a>11226          }
<a name="l11227"></a>11227       }
<a name="l11228"></a>11228       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;tz&quot;</span>))) {
<a name="l11229"></a>11229          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(<a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>, val, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#a4a081db7653645ce9fce8fd72e5a7bf1">zonetag</a>));
<a name="l11230"></a>11230       }
<a name="l11231"></a>11231       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;emailsubject&quot;</span>))) {
<a name="l11232"></a>11232          <a class="code" href="app__voicemail_8c.html#a9c53251b14e2c73274d41136b84ca816">emailsubject</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(val);
<a name="l11233"></a>11233       }
<a name="l11234"></a>11234       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;emailbody&quot;</span>))) {
<a name="l11235"></a>11235          <a class="code" href="app__voicemail_8c.html#ab89d128ff0a8b3ceab1ec2590bb98b2f">emailbody</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="app__voicemail_8c.html#ab5cd9e7a9d7c43f1b3d03cd65c23a2a6">substitute_escapes</a>(val));
<a name="l11236"></a>11236       }
<a name="l11237"></a>11237       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagersubject&quot;</span>))) {
<a name="l11238"></a>11238          <a class="code" href="app__voicemail_8c.html#a4c15fe41c8c6d5f4bd864ecec999afdc">pagersubject</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(val);
<a name="l11239"></a>11239       }
<a name="l11240"></a>11240       <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;pagerbody&quot;</span>))) {
<a name="l11241"></a>11241          <a class="code" href="app__voicemail_8c.html#a6865108119ce0a659ea9e383323b2d04">pagerbody</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<a class="code" href="app__voicemail_8c.html#ab5cd9e7a9d7c43f1b3d03cd65c23a2a6">substitute_escapes</a>(val));
<a name="l11242"></a>11242       }
<a name="l11243"></a>11243       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l11244"></a>11244       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l11245"></a>11245 
<a name="l11246"></a>11246       <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a> &amp;&amp; <a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a> == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l11247"></a>11247          <a class="code" href="app__voicemail_8c.html#abf3444228de1ea70778be8dbea3cee15">start_poll_thread</a>();
<a name="l11248"></a>11248       <span class="keywordflow">if</span> (!<a class="code" href="app__voicemail_8c.html#ac71d7f348bf10bc8070f4658dce38b6b">poll_mailboxes</a> &amp;&amp; <a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l11249"></a>11249          <a class="code" href="app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a>();;
<a name="l11250"></a>11250 
<a name="l11251"></a>11251       <span class="keywordflow">return</span> 0;
<a name="l11252"></a>11252    } <span class="keywordflow">else</span> {
<a name="l11253"></a>11253       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;<a class="code" href="structusers.html" title="list of users found in the config file">users</a>);
<a name="l11254"></a>11254       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to load configuration file.\n&quot;</span>);
<a name="l11255"></a>11255       <span class="keywordflow">if</span> (ucfg)
<a name="l11256"></a>11256          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(ucfg);
<a name="l11257"></a>11257       <span class="keywordflow">return</span> 0;
<a name="l11258"></a>11258    }
<a name="l11259"></a>11259 }
<a name="l11260"></a>11260 
<a name="l11261"></a><a class="code" href="app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">11261</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">const</span> <span class="keywordtype">char</span> *mailbox, <span class="keyword">const</span> <span class="keywordtype">char</span> *context)
<a name="l11262"></a>11262 {
<a name="l11263"></a>11263    <span class="keywordtype">int</span> res = -1;
<a name="l11264"></a>11264    <span class="keywordtype">char</span> dir[PATH_MAX];
<a name="l11265"></a>11265    snprintf(dir, <span class="keyword">sizeof</span>(dir), <span class="stringliteral">&quot;%s%s/%s/greet&quot;</span>, <a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, context, mailbox);
<a name="l11266"></a>11266    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;About to try retrieving name file %s\n&quot;</span>, dir);
<a name="l11267"></a>11267    <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(dir, -1, mailbox, context);
<a name="l11268"></a>11268    <span class="keywordflow">if</span> (<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(dir, NULL, NULL)) {
<a name="l11269"></a>11269       res = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, dir, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l11270"></a>11270    }
<a name="l11271"></a>11271    <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(dir, -1);
<a name="l11272"></a>11272    <span class="keywordflow">return</span> res;
<a name="l11273"></a>11273 }
<a name="l11274"></a>11274 
<a name="l11275"></a><a class="code" href="app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">11275</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l11276"></a>11276 {
<a name="l11277"></a>11277    <span class="keywordflow">return</span> <a class="code" href="app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(1);
<a name="l11278"></a>11278 }
<a name="l11279"></a>11279 
<a name="l11280"></a><a class="code" href="app__voicemail_8c.html#ad09fa931f468002152a3cc2d5ce25eae">11280</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l11281"></a>11281 {
<a name="l11282"></a>11282    <span class="keywordtype">int</span> res;
<a name="l11283"></a>11283 
<a name="l11284"></a>11284    res = <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>);
<a name="l11285"></a>11285    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__voicemail_8c.html#a481fef4b16e813bdf173274384491281">app2</a>);
<a name="l11286"></a>11286    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__voicemail_8c.html#aeee927ac8205016fe2119d75793e9c07">app3</a>);
<a name="l11287"></a>11287    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(<a class="code" href="app__voicemail_8c.html#a7c76a62fa9a3feb78b315578d82e4a48">app4</a>);
<a name="l11288"></a>11288    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;<a class="code" href="app__voicemail_8c.html#a3f6741bb45607f4107c08aa8d7e44509">mailbox_exists_acf</a>);
<a name="l11289"></a>11289    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;VoicemailUsersList&quot;</span>);
<a name="l11290"></a>11290    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(<a class="code" href="app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a>));
<a name="l11291"></a>11291    <a class="code" href="app_8h.html#a65d1324f7632267a35a6d933fdbdc6f9">ast_uninstall_vm_functions</a>();
<a name="l11292"></a>11292    <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a>, -1);
<a name="l11293"></a>11293 
<a name="l11294"></a>11294    <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a495591a348e5b9edcf4be80cb688ca89">poll_thread</a> != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>)
<a name="l11295"></a>11295       <a class="code" href="app__voicemail_8c.html#a6d6a58b45f010bc03c6410ccdc2d06dd">stop_poll_thread</a>();
<a name="l11296"></a>11296 
<a name="l11297"></a>11297    <a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a> = <a class="code" href="taskprocessor_8h.html#a32492eb2480cb8c46ad669622cff8556" title="Unreference the specified taskprocessor and its reference count will decrement.">ast_taskprocessor_unreference</a>(<a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a>);
<a name="l11298"></a>11298    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail&quot;</span>);
<a name="l11299"></a>11299    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>);
<a name="l11300"></a>11300 
<a name="l11301"></a>11301    <a class="code" href="app__voicemail_8c.html#afb17050e49a14f2871fdbd560024a101" title="Free the users structure.">free_vm_users</a>();
<a name="l11302"></a>11302    <a class="code" href="app__voicemail_8c.html#ad13b68ee650ddeaa242ba4dc5195c473" title="Free the zones structure.">free_vm_zones</a>();
<a name="l11303"></a>11303    <span class="keywordflow">return</span> res;
<a name="l11304"></a>11304 }
<a name="l11305"></a>11305 
<a name="l11306"></a><a class="code" href="app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">11306</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l11307"></a>11307 {
<a name="l11308"></a>11308    <span class="keywordtype">int</span> res;
<a name="l11309"></a>11309    <a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a> = umask(0);
<a name="l11310"></a>11310    umask(<a class="code" href="app__voicemail_8c.html#ae27e109c42f23e01c83b3f39a99acd01">my_umask</a>);
<a name="l11311"></a>11311 
<a name="l11312"></a>11312    <span class="keywordflow">if</span> (!(<a class="code" href="app__voicemail_8c.html#a8ae605b4118ef2bd9426f2b057835778">inprocess_container</a> = <a class="code" href="astobj2_8h.html#a82534c91be59ec9a3d3318ec85ac5695">ao2_container_alloc</a>(573, <a class="code" href="app__voicemail_8c.html#a17cf878dcf1769f74b1a3714b793a039">inprocess_hash_fn</a>, <a class="code" href="app__voicemail_8c.html#aaf8dbb4195a61c64d560b4c850dafb90">inprocess_cmp_fn</a>))) {
<a name="l11313"></a>11313       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l11314"></a>11314    }
<a name="l11315"></a>11315 
<a name="l11316"></a>11316    <span class="comment">/* compute the location of the voicemail spool directory */</span>
<a name="l11317"></a>11317    snprintf(<a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>, <span class="keyword">sizeof</span>(<a class="code" href="app__voicemail_8c.html#ab3318a367b69390dc5682a5f5e4b2999">VM_SPOOL_DIR</a>), <span class="stringliteral">&quot;%s/voicemail/&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>);
<a name="l11318"></a>11318    
<a name="l11319"></a>11319    <span class="keywordflow">if</span> (!(<a class="code" href="app__voicemail_8c.html#a2bb6469a0976d1715c300b32332352d9">mwi_subscription_tps</a> = <a class="code" href="taskprocessor_8h.html#a3d670ce6d9ed07b5db0dae8d2c11d275" title="Get a reference to a taskprocessor with the specified name and create the taskprocessor...">ast_taskprocessor_get</a>(<span class="stringliteral">&quot;app_voicemail&quot;</span>, 0))) {
<a name="l11320"></a>11320       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;failed to reference mwi subscription taskprocessor.  MWI will not work\n&quot;</span>);
<a name="l11321"></a>11321    }
<a name="l11322"></a>11322 
<a name="l11323"></a>11323    <span class="keywordflow">if</span> ((res = <a class="code" href="app__voicemail_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(0)))
<a name="l11324"></a>11324       <span class="keywordflow">return</span> res;
<a name="l11325"></a>11325 
<a name="l11326"></a>11326    res = <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>, <a class="code" href="app__voicemail_8c.html#a8506f88c9481bf3508695725d6beb0f6">vm_exec</a>);
<a name="l11327"></a>11327    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="app__voicemail_8c.html#a481fef4b16e813bdf173274384491281">app2</a>, <a class="code" href="app__voicemail_8c.html#aba46cc3472f058c271aff3bf26a1064e">vm_execmain</a>);
<a name="l11328"></a>11328    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="app__voicemail_8c.html#aeee927ac8205016fe2119d75793e9c07">app3</a>, <a class="code" href="app__voicemail_8c.html#a9a419c66f69a173d0b848affba5c720b">vm_box_exists</a>);
<a name="l11329"></a>11329    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(<a class="code" href="app__voicemail_8c.html#a7c76a62fa9a3feb78b315578d82e4a48">app4</a>, <a class="code" href="app__voicemail_8c.html#a62edc65a5b9367acdf79742421d5283a">vmauthenticate</a>);
<a name="l11330"></a>11330    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;<a class="code" href="app__voicemail_8c.html#a3f6741bb45607f4107c08aa8d7e44509">mailbox_exists_acf</a>);
<a name="l11331"></a>11331    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;VoicemailUsersList&quot;</span>, <a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a> | <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <a class="code" href="app__voicemail_8c.html#a1d25d65364805271d7963230e7d80752" title="Manager list voicemail users command.">manager_list_voicemail_users</a>, <span class="stringliteral">&quot;List All Voicemail User Information&quot;</span>);
<a name="l11332"></a>11332    <span class="keywordflow">if</span> (res)
<a name="l11333"></a>11333       <span class="keywordflow">return</span> res;
<a name="l11334"></a>11334 
<a name="l11335"></a>11335    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(<a class="code" href="app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a>, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="app__voicemail_8c.html#a7035bb955d2488f04c6750ff055f56c5">cli_voicemail</a>));
<a name="l11336"></a>11336 
<a name="l11337"></a>11337    <a class="code" href="app_8h.html#a27992e5c39b818ff6b190f726a80cb50" title="Set voicemail function callbacks.">ast_install_vm_functions</a>(<a class="code" href="app__voicemail_8c.html#ae092e449709dbba8ef9a27ce9531b1d7" title="Determines if the given folder has messages.">has_voicemail</a>, <a class="code" href="app__voicemail_8c.html#aac932b3188d5baf5f0f91b47ee656b79">inboxcount</a>, <a class="code" href="app__voicemail_8c.html#ae5fdb2a8c5cd5f9cdcee895fa7ec421b">inboxcount2</a>, <a class="code" href="app__voicemail_8c.html#a276efe40a0edb56b717e542b711bf5aa">messagecount</a>, <a class="code" href="app__voicemail_8c.html#aeab26b22621adc0bfdd81bca08ea0acf">sayname</a>);
<a name="l11338"></a>11338    <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;voicemail&quot;</span>, <span class="stringliteral">&quot;uniqueid&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a>, 11, <span class="stringliteral">&quot;password&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, 10, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l11339"></a>11339    <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;voicemail_data&quot;</span>, <span class="stringliteral">&quot;filename&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a75759a4654f061f8e7d6bd1ec7a3b4bb">RQ_CHAR</a>, 30, <span class="stringliteral">&quot;duration&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a>, 5, <a class="code" href="compiler_8h.html#af2af475b85aef66019c417d8ded1c435">SENTINEL</a>);
<a name="l11340"></a>11340 
<a name="l11341"></a>11341    <span class="keywordflow">return</span> res;
<a name="l11342"></a>11342 }
<a name="l11343"></a>11343 
<a name="l11344"></a><a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">11344</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>, <span class="keywordtype">char</span> *outgoing_context) 
<a name="l11345"></a>11345 {
<a name="l11346"></a>11346    <span class="keywordtype">int</span> cmd = 0;
<a name="l11347"></a>11347    <span class="keywordtype">char</span> destination[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11348"></a>11348    <span class="keywordtype">int</span> retries = 0;
<a name="l11349"></a>11349 
<a name="l11350"></a>11350    <span class="keywordflow">if</span> (!num) {
<a name="l11351"></a>11351       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Destination number will be entered manually\n&quot;</span>);
<a name="l11352"></a>11352       <span class="keywordflow">while</span> (retries &lt; 3 &amp;&amp; cmd != <span class="charliteral">&apos;t&apos;</span>) {
<a name="l11353"></a>11353          destination[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l11354"></a>11354          destination[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan,<span class="stringliteral">&quot;vm-enter-num-to-call&quot;</span>);
<a name="l11355"></a>11355          <span class="keywordflow">if</span> (!cmd)
<a name="l11356"></a>11356             destination[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-then-pound&quot;</span>);
<a name="l11357"></a>11357          <span class="keywordflow">if</span> (!cmd)
<a name="l11358"></a>11358             destination[0] = cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-star-cancel&quot;</span>);
<a name="l11359"></a>11359          <span class="keywordflow">if</span> (!cmd) {
<a name="l11360"></a>11360             cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 6000);
<a name="l11361"></a>11361             <span class="keywordflow">if</span> (cmd)
<a name="l11362"></a>11362                destination[0] = cmd;
<a name="l11363"></a>11363          }
<a name="l11364"></a>11364          <span class="keywordflow">if</span> (!cmd) {
<a name="l11365"></a>11365             retries++;
<a name="l11366"></a>11366          } <span class="keywordflow">else</span> {
<a name="l11367"></a>11367 
<a name="l11368"></a>11368             <span class="keywordflow">if</span> (cmd &lt; 0)
<a name="l11369"></a>11369                <span class="keywordflow">return</span> 0;
<a name="l11370"></a>11370             <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l11371"></a>11371                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;User hit &apos;*&apos; to cancel outgoing call\n&quot;</span>);
<a name="l11372"></a>11372                <span class="keywordflow">return</span> 0;
<a name="l11373"></a>11373             }
<a name="l11374"></a>11374             <span class="keywordflow">if</span> ((cmd = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan,destination + strlen(destination),<span class="keyword">sizeof</span>(destination)-1,6000,10000,<span class="stringliteral">&quot;#&quot;</span>)) &lt; 0) 
<a name="l11375"></a>11375                retries++;
<a name="l11376"></a>11376             <span class="keywordflow">else</span>
<a name="l11377"></a>11377                cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11378"></a>11378          }
<a name="l11379"></a>11379       }
<a name="l11380"></a>11380       <span class="keywordflow">if</span> (retries &gt;= 3) {
<a name="l11381"></a>11381          <span class="keywordflow">return</span> 0;
<a name="l11382"></a>11382       }
<a name="l11383"></a>11383       
<a name="l11384"></a>11384    } <span class="keywordflow">else</span> {
<a name="l11385"></a>11385       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 2)
<a name="l11386"></a>11386          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>( <a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;Destination number is CID number &apos;%s&apos;\n&quot;</span>, num);
<a name="l11387"></a>11387       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(destination, num, <span class="keyword">sizeof</span>(destination));
<a name="l11388"></a>11388    }
<a name="l11389"></a>11389 
<a name="l11390"></a>11390    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(destination)) {
<a name="l11391"></a>11391       <span class="keywordflow">if</span> (destination[strlen(destination) -1 ] == <span class="charliteral">&apos;*&apos;</span>)
<a name="l11392"></a>11392          <span class="keywordflow">return</span> 0; 
<a name="l11393"></a>11393       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#gaa294d0efa6a89c1a3d162787cac4fff5">option_verbose</a> &gt; 2)
<a name="l11394"></a>11394          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>( <a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;Placing outgoing call to extension &apos;%s&apos; in context &apos;%s&apos; from context &apos;%s&apos;\n&quot;</span>, destination, outgoing_context, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l11395"></a>11395       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>, destination, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#a78d4847658b695383d849efd12399b38">exten</a>));
<a name="l11396"></a>11396       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, outgoing_context, <span class="keyword">sizeof</span>(chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>));
<a name="l11397"></a>11397       chan-&gt;<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> = 0;
<a name="l11398"></a>11398       <span class="keywordflow">return</span> 9;
<a name="l11399"></a>11399    }
<a name="l11400"></a>11400    <span class="keywordflow">return</span> 0;
<a name="l11401"></a>11401 }
<a name="l11402"></a>11402 <span class="comment"></span>
<a name="l11403"></a>11403 <span class="comment">/*!</span>
<a name="l11404"></a>11404 <span class="comment"> * \brief The advanced options within a message.</span>
<a name="l11405"></a>11405 <span class="comment"> * \param chan</span>
<a name="l11406"></a>11406 <span class="comment"> * \param vmu </span>
<a name="l11407"></a>11407 <span class="comment"> * \param vms</span>
<a name="l11408"></a>11408 <span class="comment"> * \param msg</span>
<a name="l11409"></a>11409 <span class="comment"> * \param option</span>
<a name="l11410"></a>11410 <span class="comment"> * \param record_gain</span>
<a name="l11411"></a>11411 <span class="comment"> *</span>
<a name="l11412"></a>11412 <span class="comment"> * Provides handling for the play message envelope, call the person back, or reply to message. </span>
<a name="l11413"></a>11413 <span class="comment"> *</span>
<a name="l11414"></a>11414 <span class="comment"> * \return zero on success, -1 on error.</span>
<a name="l11415"></a>11415 <span class="comment"> */</span>
<a name="l11416"></a><a class="code" href="app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921">11416</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#a845ca9725fdfa35cf3b3b6a7087b5921" title="The advanced options within a message.">advanced_options</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">int</span> msg, <span class="keywordtype">int</span> option, <span class="keywordtype">signed</span> <span class="keywordtype">char</span> record_gain)
<a name="l11417"></a>11417 {
<a name="l11418"></a>11418    <span class="keywordtype">int</span> res = 0;
<a name="l11419"></a>11419    <span class="keywordtype">char</span> filename[PATH_MAX];
<a name="l11420"></a>11420    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *msg_cfg = NULL;
<a name="l11421"></a>11421    <span class="keyword">const</span> <span class="keywordtype">char</span> *origtime, *context;
<a name="l11422"></a>11422    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *<a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>;
<a name="l11423"></a>11423    <span class="keywordtype">int</span> retries = 0;
<a name="l11424"></a>11424    <span class="keywordtype">char</span> *cid;
<a name="l11425"></a>11425    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26a3b68640f31a2c5493459c159abee08ee">CONFIG_FLAG_NOCACHE</a>, };
<a name="l11426"></a>11426 
<a name="l11427"></a>11427    vms-&gt;<a class="code" href="structvm__state.html#ae3e9c2dd4477c3dbccc953a5dc27da6f">starting</a> = 0; 
<a name="l11428"></a>11428 
<a name="l11429"></a>11429    <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, msg);
<a name="l11430"></a>11430 
<a name="l11431"></a>11431    <span class="comment">/* Retrieve info from VM attribute file */</span>
<a name="l11432"></a>11432    snprintf(filename,<span class="keyword">sizeof</span>(filename), <span class="stringliteral">&quot;%s.txt&quot;</span>, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l11433"></a>11433    <a class="code" href="app__voicemail_8c.html#aaf72c03f2d29edec82911c55bd7c01a7">RETRIEVE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l11434"></a>11434    msg_cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(filename, config_flags);
<a name="l11435"></a>11435    <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, vms-&gt;<a class="code" href="structvm__state.html#ab866a3b365ca8eca41c286e4fe0031f8">curmsg</a>);
<a name="l11436"></a>11436    <span class="keywordflow">if</span> (!msg_cfg || msg_cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l11437"></a>11437       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;No message attribute file?!! (%s)\n&quot;</span>, filename);
<a name="l11438"></a>11438       <span class="keywordflow">return</span> 0;
<a name="l11439"></a>11439    }
<a name="l11440"></a>11440 
<a name="l11441"></a>11441    <span class="keywordflow">if</span> (!(origtime = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;origtime&quot;</span>))) {
<a name="l11442"></a>11442       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11443"></a>11443       <span class="keywordflow">return</span> 0;
<a name="l11444"></a>11444    }
<a name="l11445"></a>11445 
<a name="l11446"></a>11446    cid = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;callerid&quot;</span>));
<a name="l11447"></a>11447 
<a name="l11448"></a>11448    context = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>, <span class="stringliteral">&quot;context&quot;</span>);
<a name="l11449"></a>11449    <span class="keywordflow">if</span> (!strncasecmp(<span class="stringliteral">&quot;macro&quot;</span>,context,5)) <span class="comment">/* Macro names in contexts are useless for our needs */</span>
<a name="l11450"></a>11450       context = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(msg_cfg, <span class="stringliteral">&quot;message&quot;</span>,<span class="stringliteral">&quot;macrocontext&quot;</span>);
<a name="l11451"></a>11451    <span class="keywordflow">switch</span> (option) {
<a name="l11452"></a>11452    <span class="keywordflow">case</span> 3: <span class="comment">/* Play message envelope */</span>
<a name="l11453"></a>11453       <span class="keywordflow">if</span> (!res)
<a name="l11454"></a>11454          res = <a class="code" href="app__voicemail_8c.html#aa3b980dbdb4e669b052e22cde8e2d220">play_message_datetime</a>(chan, vmu, origtime, filename);
<a name="l11455"></a>11455       <span class="keywordflow">if</span> (!res)
<a name="l11456"></a>11456          res = <a class="code" href="app__voicemail_8c.html#aa8115f2c7ff87c075e34851f9ea8ce58">play_message_callerid</a>(chan, vms, cid, context, 0);
<a name="l11457"></a>11457 
<a name="l11458"></a>11458       res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11459"></a>11459       <span class="keywordflow">break</span>;
<a name="l11460"></a>11460 
<a name="l11461"></a>11461    <span class="keywordflow">case</span> 2:  <span class="comment">/* Call back */</span>
<a name="l11462"></a>11462 
<a name="l11463"></a>11463       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cid))
<a name="l11464"></a>11464          <span class="keywordflow">break</span>;
<a name="l11465"></a>11465 
<a name="l11466"></a>11466       <a class="code" href="callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df" title="Destructively parse inbuf into name and location (or number) Parses callerid stream...">ast_callerid_parse</a>(cid, &amp;name, &amp;num);
<a name="l11467"></a>11467       <span class="keywordflow">while</span> ((res &gt; -1) &amp;&amp; (res != <span class="charliteral">&apos;t&apos;</span>)) {
<a name="l11468"></a>11468          <span class="keywordflow">switch</span> (res) {
<a name="l11469"></a>11469          <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l11470"></a>11470             <span class="keywordflow">if</span> (num) {
<a name="l11471"></a>11471                <span class="comment">/* Dial the CID number */</span>
<a name="l11472"></a>11472                res = <a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(chan, vmu, num, vmu-&gt;<a class="code" href="structast__vm__user.html#a13b594c1beccc30477c646a703f17d71">callback</a>);
<a name="l11473"></a>11473                <span class="keywordflow">if</span> (res) {
<a name="l11474"></a>11474                   <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11475"></a>11475                   <span class="keywordflow">return</span> 9;
<a name="l11476"></a>11476                }
<a name="l11477"></a>11477             } <span class="keywordflow">else</span> {
<a name="l11478"></a>11478                res = <span class="charliteral">&apos;2&apos;</span>;
<a name="l11479"></a>11479             }
<a name="l11480"></a>11480             <span class="keywordflow">break</span>;
<a name="l11481"></a>11481 
<a name="l11482"></a>11482          <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l11483"></a>11483             <span class="comment">/* Want to enter a different number, can only do this if there&apos;s a dialout context for this user */</span>
<a name="l11484"></a>11484             <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {
<a name="l11485"></a>11485                res = <a class="code" href="app__voicemail_8c.html#ae8319c0fa0dcbae2fa2039e6a61ed7bb">dialout</a>(chan, vmu, NULL, vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>);
<a name="l11486"></a>11486                <span class="keywordflow">if</span> (res) {
<a name="l11487"></a>11487                   <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11488"></a>11488                   <span class="keywordflow">return</span> 9;
<a name="l11489"></a>11489                }
<a name="l11490"></a>11490             } <span class="keywordflow">else</span> {
<a name="l11491"></a>11491                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Caller can not specify callback number - no dialout context available\n&quot;</span>);
<a name="l11492"></a>11492                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l11493"></a>11493             }
<a name="l11494"></a>11494             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11495"></a>11495             <span class="keywordflow">return</span> res;
<a name="l11496"></a>11496          <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l11497"></a>11497             res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11498"></a>11498             <span class="keywordflow">break</span>;
<a name="l11499"></a>11499          <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>:
<a name="l11500"></a>11500          <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l11501"></a>11501          <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l11502"></a>11502          <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l11503"></a>11503          <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:
<a name="l11504"></a>11504          <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>:
<a name="l11505"></a>11505          <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l11506"></a>11506          <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>:
<a name="l11507"></a>11507 
<a name="l11508"></a>11508             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l11509"></a>11509             retries++;
<a name="l11510"></a>11510             <span class="keywordflow">break</span>;
<a name="l11511"></a>11511          <span class="keywordflow">default</span>:
<a name="l11512"></a>11512             <span class="keywordflow">if</span> (num) {
<a name="l11513"></a>11513                <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Confirm CID number &apos;%s&apos; is number to use for callback\n&quot;</span>, num);
<a name="l11514"></a>11514                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-num-i-have&quot;</span>);
<a name="l11515"></a>11515                <span class="keywordflow">if</span> (!res)
<a name="l11516"></a>11516                   res = <a class="code" href="app__voicemail_8c.html#aa8115f2c7ff87c075e34851f9ea8ce58">play_message_callerid</a>(chan, vms, num, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, 1);
<a name="l11517"></a>11517                <span class="keywordflow">if</span> (!res)
<a name="l11518"></a>11518                   res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocallnum&quot;</span>);
<a name="l11519"></a>11519                <span class="comment">/* Only prompt for a caller-specified number if there is a dialout context specified */</span>
<a name="l11520"></a>11520                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {
<a name="l11521"></a>11521                   <span class="keywordflow">if</span> (!res)
<a name="l11522"></a>11522                      res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-calldiffnum&quot;</span>);
<a name="l11523"></a>11523                }
<a name="l11524"></a>11524             } <span class="keywordflow">else</span> {
<a name="l11525"></a>11525                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nonumber&quot;</span>);
<a name="l11526"></a>11526                <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(vmu-&gt;<a class="code" href="structast__vm__user.html#a83f51ce5625200c6f2a1a892d0611dc8">dialout</a>)) {
<a name="l11527"></a>11527                   <span class="keywordflow">if</span> (!res)
<a name="l11528"></a>11528                      res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-toenternumber&quot;</span>);
<a name="l11529"></a>11529                }
<a name="l11530"></a>11530             }
<a name="l11531"></a>11531             <span class="keywordflow">if</span> (!res)
<a name="l11532"></a>11532                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-star-cancel&quot;</span>);
<a name="l11533"></a>11533             <span class="keywordflow">if</span> (!res)
<a name="l11534"></a>11534                res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 6000);
<a name="l11535"></a>11535             <span class="keywordflow">if</span> (!res) {
<a name="l11536"></a>11536                retries++;
<a name="l11537"></a>11537                <span class="keywordflow">if</span> (retries &gt; 3)
<a name="l11538"></a>11538                   res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11539"></a>11539             }
<a name="l11540"></a>11540             <span class="keywordflow">break</span>; 
<a name="l11541"></a>11541             
<a name="l11542"></a>11542          }
<a name="l11543"></a>11543          <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;t&apos;</span>)
<a name="l11544"></a>11544             res = 0;
<a name="l11545"></a>11545          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;*&apos;</span>)
<a name="l11546"></a>11546             res = -1;
<a name="l11547"></a>11547       }
<a name="l11548"></a>11548       <span class="keywordflow">break</span>;
<a name="l11549"></a>11549       
<a name="l11550"></a>11550    <span class="keywordflow">case</span> 1:  <span class="comment">/* Reply */</span>
<a name="l11551"></a>11551       <span class="comment">/* Send reply directly to sender */</span>
<a name="l11552"></a>11552       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cid))
<a name="l11553"></a>11553          <span class="keywordflow">break</span>;
<a name="l11554"></a>11554 
<a name="l11555"></a>11555       <a class="code" href="callerid_8h.html#a39e03ca4e8df3a1d2c75e888d76201df" title="Destructively parse inbuf into name and location (or number) Parses callerid stream...">ast_callerid_parse</a>(cid, &amp;name, &amp;num);
<a name="l11556"></a>11556       <span class="keywordflow">if</span> (!num) {
<a name="l11557"></a>11557          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;No CID number available, no reply sent\n&quot;</span>);
<a name="l11558"></a>11558          <span class="keywordflow">if</span> (!res)
<a name="l11559"></a>11559             res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nonumber&quot;</span>);
<a name="l11560"></a>11560          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11561"></a>11561          <span class="keywordflow">return</span> res;
<a name="l11562"></a>11562       } <span class="keywordflow">else</span> {
<a name="l11563"></a>11563          <span class="keyword">struct </span><a class="code" href="structast__vm__user.html">ast_vm_user</a> vmu2;
<a name="l11564"></a>11564          <span class="keywordflow">if</span> (<a class="code" href="app__voicemail_8c.html#a6fb8f5e6825dfc89afea7b5b2955c061" title="Finds a voicemail user from the users file or the realtime engine.">find_user</a>(&amp;vmu2, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, num)) {
<a name="l11565"></a>11565             <span class="keyword">struct </span><a class="code" href="structleave__vm__options.html" title="Options for leaving voicemail with the voicemail() application.">leave_vm_options</a> leave_options;
<a name="l11566"></a>11566             <span class="keywordtype">char</span> mailbox[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a> * 2 + 2];
<a name="l11567"></a>11567             snprintf(mailbox, <span class="keyword">sizeof</span>(mailbox), <span class="stringliteral">&quot;%s@%s&quot;</span>, num, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l11568"></a>11568 
<a name="l11569"></a>11569             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Leaving voicemail for &apos;%s&apos; in context &apos;%s&apos;\n&quot;</span>, num, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l11570"></a>11570             
<a name="l11571"></a>11571             memset(&amp;leave_options, 0, <span class="keyword">sizeof</span>(leave_options));
<a name="l11572"></a>11572             leave_options.<a class="code" href="structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a> = record_gain;
<a name="l11573"></a>11573             res = <a class="code" href="app__voicemail_8c.html#a122be913e1f6ff9245316ee210430aff" title="Prompts the user and records a voicemail to a mailbox.">leave_voicemail</a>(chan, mailbox, &amp;leave_options);
<a name="l11574"></a>11574             <span class="keywordflow">if</span> (!res)
<a name="l11575"></a>11575                res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11576"></a>11576             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11577"></a>11577             <span class="keywordflow">return</span> res;
<a name="l11578"></a>11578          } <span class="keywordflow">else</span> {
<a name="l11579"></a>11579             <span class="comment">/* Sender has no mailbox, can&apos;t reply */</span>
<a name="l11580"></a>11580             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;No mailbox number &apos;%s&apos; in context &apos;%s&apos;, no reply sent\n&quot;</span>, num, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l11581"></a>11581             <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nobox&quot;</span>);
<a name="l11582"></a>11582             res = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11583"></a>11583             <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11584"></a>11584             <span class="keywordflow">return</span> res;
<a name="l11585"></a>11585          }
<a name="l11586"></a>11586       } 
<a name="l11587"></a>11587       res = 0;
<a name="l11588"></a>11588 
<a name="l11589"></a>11589       <span class="keywordflow">break</span>;
<a name="l11590"></a>11590    }
<a name="l11591"></a>11591 
<a name="l11592"></a>11592 <span class="preprocessor">#ifndef IMAP_STORAGE</span>
<a name="l11593"></a>11593 <span class="preprocessor"></span>   <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(msg_cfg);
<a name="l11594"></a>11594 
<a name="l11595"></a>11595    <span class="keywordflow">if</span> (!res) {
<a name="l11596"></a>11596       <a class="code" href="app__voicemail_8c.html#a162bd6f075a05d0c1b4e9eb2c361facd" title="Creates a file system path expression for a folder within the voicemail data folder...">make_file</a>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>, <span class="keyword">sizeof</span>(vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>), vms-&gt;<a class="code" href="structvm__state.html#a3e18d3cc05ec901b83a690c32f865de8">curdir</a>, msg);
<a name="l11597"></a>11597       vms-&gt;<a class="code" href="structvm__state.html#add5b5c3d8e5133fbf295a7d302b7f300">heard</a>[msg] = 1;
<a name="l11598"></a>11598       res = <a class="code" href="app__voicemail_8c.html#a619a7ea83321438951dfe56b325c151a">wait_file</a>(chan, vms, vms-&gt;<a class="code" href="structvm__state.html#a7b855d6690caa0e60d0320cafd38051d">fn</a>);
<a name="l11599"></a>11599    }
<a name="l11600"></a>11600 <span class="preprocessor">#endif</span>
<a name="l11601"></a>11601 <span class="preprocessor"></span>   <span class="keywordflow">return</span> res;
<a name="l11602"></a>11602 }
<a name="l11603"></a>11603 
<a name="l11604"></a><a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">11604</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__voicemail_8c.html#aee59681011d4cfbecfadd4f8e749df94">play_record_review</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keywordtype">char</span> *playfile, <span class="keywordtype">char</span> *recordfile, <span class="keywordtype">int</span> maxtime, <span class="keywordtype">char</span> *fmt,
<a name="l11605"></a>11605          <span class="keywordtype">int</span> outsidecaller, <span class="keyword">struct</span> <a class="code" href="structast__vm__user.html">ast_vm_user</a> *vmu, <span class="keywordtype">int</span> *duration, <span class="keyword">const</span> <span class="keywordtype">char</span> *unlockdir,
<a name="l11606"></a>11606          <span class="keywordtype">signed</span> <span class="keywordtype">char</span> <a class="code" href="structleave__vm__options.html#a809cc53dfc8e9f1204c67c26aabaa322">record_gain</a>, <span class="keyword">struct</span> <a class="code" href="structvm__state.html">vm_state</a> *vms, <span class="keywordtype">char</span> *flag)
<a name="l11607"></a>11607 {
<a name="l11608"></a>11608    <span class="comment">/* Record message &amp; let caller review or re-record it, or set options if applicable */</span>
<a name="l11609"></a>11609    <span class="keywordtype">int</span> res = 0;
<a name="l11610"></a>11610    <span class="keywordtype">int</span> cmd = 0;
<a name="l11611"></a>11611    <span class="keywordtype">int</span> max_attempts = 3;
<a name="l11612"></a>11612    <span class="keywordtype">int</span> attempts = 0;
<a name="l11613"></a>11613    <span class="keywordtype">int</span> recorded = 0;
<a name="l11614"></a>11614    <span class="keywordtype">int</span> msg_exists = 0;
<a name="l11615"></a>11615    <span class="keywordtype">signed</span> <span class="keywordtype">char</span> zero_gain = 0;
<a name="l11616"></a>11616    <span class="keywordtype">char</span> tempfile[PATH_MAX];
<a name="l11617"></a>11617    <span class="keywordtype">char</span> *<a class="code" href="chan__agent_8c.html#a97629727ac11792aa963aed4457abde8">acceptdtmf</a> = <span class="stringliteral">&quot;#&quot;</span>;
<a name="l11618"></a>11618    <span class="keywordtype">char</span> *canceldtmf = <span class="stringliteral">&quot;&quot;</span>;
<a name="l11619"></a>11619 
<a name="l11620"></a>11620    <span class="comment">/* Note that urgent and private are for flagging messages as such in the future */</span>
<a name="l11621"></a>11621 
<a name="l11622"></a>11622    <span class="comment">/* barf if no pointer passed to store duration in */</span>
<a name="l11623"></a>11623    <span class="keywordflow">if</span> (duration == NULL) {
<a name="l11624"></a>11624       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a2878d83e36d91850732bad997524e45e">AST_LOG_WARNING</a>, <span class="stringliteral">&quot;Error play_record_review called without duration pointer\n&quot;</span>);
<a name="l11625"></a>11625       <span class="keywordflow">return</span> -1;
<a name="l11626"></a>11626    }
<a name="l11627"></a>11627 
<a name="l11628"></a>11628    <span class="keywordflow">if</span> (!outsidecaller)
<a name="l11629"></a>11629       snprintf(tempfile, <span class="keyword">sizeof</span>(tempfile), <span class="stringliteral">&quot;%s.tmp&quot;</span>, recordfile);
<a name="l11630"></a>11630    <span class="keywordflow">else</span>
<a name="l11631"></a>11631       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(tempfile, recordfile, <span class="keyword">sizeof</span>(tempfile));
<a name="l11632"></a>11632 
<a name="l11633"></a>11633    cmd = <span class="charliteral">&apos;3&apos;</span>;  <span class="comment">/* Want to start by recording */</span>
<a name="l11634"></a>11634 
<a name="l11635"></a>11635    <span class="keywordflow">while</span> ((cmd &gt;= 0) &amp;&amp; (cmd != <span class="charliteral">&apos;t&apos;</span>)) {
<a name="l11636"></a>11636       <span class="keywordflow">switch</span> (cmd) {
<a name="l11637"></a>11637       <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>:
<a name="l11638"></a>11638          <span class="keywordflow">if</span> (!msg_exists) {
<a name="l11639"></a>11639             <span class="comment">/* In this case, 1 is to record a message */</span>
<a name="l11640"></a>11640             cmd = <span class="charliteral">&apos;3&apos;</span>;
<a name="l11641"></a>11641             <span class="keywordflow">break</span>;
<a name="l11642"></a>11642          } <span class="keywordflow">else</span> {
<a name="l11643"></a>11643             <span class="comment">/* Otherwise 1 is to save the existing message */</span>
<a name="l11644"></a>11644             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Saving message as is\n&quot;</span>);
<a name="l11645"></a>11645             <span class="keywordflow">if</span> (!outsidecaller) 
<a name="l11646"></a>11646                <a class="code" href="file_8h.html#a57ea6065cde7fb5258c1f6a4595643ba" title="Renames a file.">ast_filerename</a>(tempfile, recordfile, NULL);
<a name="l11647"></a>11647             <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>, <span class="stringliteral">&quot;&quot;</span>);
<a name="l11648"></a>11648             <span class="keywordflow">if</span> (!outsidecaller) {
<a name="l11649"></a>11649                <span class="comment">/* Saves to IMAP server only if imapgreeting=yes */</span>
<a name="l11650"></a>11650                <a class="code" href="app__voicemail_8c.html#ab02316037e0d0e5b69b6aef860aabe08">STORE</a>(recordfile, vmu-&gt;<a class="code" href="structast__vm__user.html#ac81f44f4f22dee90de5975cf8fa4641b">mailbox</a>, vmu-&gt;<a class="code" href="structast__vm__user.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, -1, chan, vmu, fmt, *duration, vms, flag);
<a name="l11651"></a>11651                <a class="code" href="app__voicemail_8c.html#a60729729bc8dbe0d6614f14fc5229148">DISPOSE</a>(recordfile, -1);
<a name="l11652"></a>11652             }
<a name="l11653"></a>11653             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11654"></a>11654             <span class="keywordflow">return</span> res;
<a name="l11655"></a>11655          }
<a name="l11656"></a>11656       <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l11657"></a>11657          <span class="comment">/* Review */</span>
<a name="l11658"></a>11658          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Reviewing the message\n&quot;</span>);
<a name="l11659"></a>11659          cmd = <a class="code" href="file_8h.html#a95b94a020720147325a486e210b36775" title="stream file until digit If the file name is non-empty, try to play it.">ast_stream_and_wait</a>(chan, tempfile, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l11660"></a>11660          <span class="keywordflow">break</span>;
<a name="l11661"></a>11661       <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>:
<a name="l11662"></a>11662          msg_exists = 0;
<a name="l11663"></a>11663          <span class="comment">/* Record */</span>
<a name="l11664"></a>11664          <span class="keywordflow">if</span> (recorded == 1) 
<a name="l11665"></a>11665             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Re-recording the message\n&quot;</span>);
<a name="l11666"></a>11666          <span class="keywordflow">else</span>  
<a name="l11667"></a>11667             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Recording the message\n&quot;</span>);
<a name="l11668"></a>11668          
<a name="l11669"></a>11669          <span class="keywordflow">if</span> (recorded &amp;&amp; outsidecaller) {
<a name="l11670"></a>11670             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <a class="code" href="app__voicemail_8c.html#a3e31a9f80da1b70cf892de39b4bff759">INTRO</a>);
<a name="l11671"></a>11671             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>);
<a name="l11672"></a>11672          }
<a name="l11673"></a>11673          recorded = 1;
<a name="l11674"></a>11674          <span class="comment">/* After an attempt has been made to record message, we have to take care of INTRO and beep for incoming messages, but not for greetings */</span>
<a name="l11675"></a>11675          <span class="keywordflow">if</span> (record_gain)
<a name="l11676"></a>11676             <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;record_gain, <span class="keyword">sizeof</span>(record_gain), 0);
<a name="l11677"></a>11677          <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>))
<a name="l11678"></a>11678             canceldtmf = <span class="stringliteral">&quot;0&quot;</span>;
<a name="l11679"></a>11679          cmd = <a class="code" href="app_8h.html#a7f35e9e75513344d3ed7c56b22b8ea1f">ast_play_and_record_full</a>(chan, playfile, tempfile, maxtime, fmt, duration, <a class="code" href="app__voicemail_8c.html#abebd9f51e7ff2f4d68f3952210219b4e">silencethreshold</a>, <a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a>, unlockdir, acceptdtmf, canceldtmf);
<a name="l11680"></a>11680          <span class="keywordflow">if</span> (record_gain)
<a name="l11681"></a>11681             <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;zero_gain, <span class="keyword">sizeof</span>(zero_gain), 0);
<a name="l11682"></a>11682          <span class="keywordflow">if</span> (cmd == -1) {
<a name="l11683"></a>11683             <span class="comment">/* User has hung up, no options to give */</span>
<a name="l11684"></a>11684             <span class="keywordflow">if</span> (!outsidecaller) {
<a name="l11685"></a>11685                <span class="comment">/* user was recording a greeting and they hung up, so let&apos;s delete the recording. */</span>
<a name="l11686"></a>11686                <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(tempfile, NULL);
<a name="l11687"></a>11687             }     
<a name="l11688"></a>11688             <span class="keywordflow">return</span> cmd;
<a name="l11689"></a>11689          }
<a name="l11690"></a>11690          <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;0&apos;</span>) {
<a name="l11691"></a>11691             <span class="keywordflow">break</span>;
<a name="l11692"></a>11692          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l11693"></a>11693             <span class="keywordflow">break</span>;
<a name="l11694"></a>11694 <span class="preprocessor">#if 0</span>
<a name="l11695"></a>11695 <span class="preprocessor"></span>         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;review &amp;&amp; (*duration &lt; 5)) {
<a name="l11696"></a>11696             <span class="comment">/* Message is too short */</span>
<a name="l11697"></a>11697             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Message too short\n&quot;</span>);
<a name="l11698"></a>11698             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tooshort&quot;</span>);
<a name="l11699"></a>11699             cmd = <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(tempfile, NULL);
<a name="l11700"></a>11700             <span class="keywordflow">break</span>;
<a name="l11701"></a>11701          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (vmu-&gt;review &amp;&amp; (cmd == 2 &amp;&amp; *duration &lt; (<a class="code" href="app__voicemail_8c.html#ad87fa9ba37f50714bc922335b3b7ea91">maxsilence</a> + 3))) {
<a name="l11702"></a>11702             <span class="comment">/* Message is all silence */</span>
<a name="l11703"></a>11703             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Nothing recorded\n&quot;</span>);
<a name="l11704"></a>11704             cmd = <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(tempfile, NULL);
<a name="l11705"></a>11705             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-nothingrecorded&quot;</span>);
<a name="l11706"></a>11706             <span class="keywordflow">if</span> (!cmd)
<a name="l11707"></a>11707                cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-speakup&quot;</span>);
<a name="l11708"></a>11708             <span class="keywordflow">break</span>;
<a name="l11709"></a>11709 <span class="preprocessor">#endif</span>
<a name="l11710"></a>11710 <span class="preprocessor"></span>         } <span class="keywordflow">else</span> {
<a name="l11711"></a>11711             <span class="comment">/* If all is well, a message exists */</span>
<a name="l11712"></a>11712             msg_exists = 1;
<a name="l11713"></a>11713             cmd = 0;
<a name="l11714"></a>11714          }
<a name="l11715"></a>11715          <span class="keywordflow">break</span>;
<a name="l11716"></a>11716       <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l11717"></a>11717          <span class="keywordflow">if</span> (outsidecaller) {  <span class="comment">/* only mark vm messages */</span>
<a name="l11718"></a>11718             <span class="comment">/* Mark Urgent */</span>
<a name="l11719"></a>11719             <span class="keywordflow">if</span> ((flag &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag)) || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>))) {
<a name="l11720"></a>11720                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;marking message as Urgent\n&quot;</span>);
<a name="l11721"></a>11721                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1000, <span class="stringliteral">&quot;This message is too urgent!\n&quot;</span>);
<a name="l11722"></a>11722                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-marked-urgent&quot;</span>);
<a name="l11723"></a>11723                strcpy(flag, <span class="stringliteral">&quot;Urgent&quot;</span>);
<a name="l11724"></a>11724             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag) {
<a name="l11725"></a>11725                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<a class="code" href="logger_8h.html#a24b0f46e22f4ea3226fa082e955dd4ef">VERBOSE_PREFIX_3</a> <span class="stringliteral">&quot;UNmarking message as Urgent\n&quot;</span>);
<a name="l11726"></a>11726                res = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-urgent-removed&quot;</span>);
<a name="l11727"></a>11727                strcpy(flag, <span class="stringliteral">&quot;&quot;</span>);
<a name="l11728"></a>11728             } <span class="keywordflow">else</span> {
<a name="l11729"></a>11729                <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l11730"></a>11730             }
<a name="l11731"></a>11731             cmd = 0;
<a name="l11732"></a>11732          } <span class="keywordflow">else</span> {
<a name="l11733"></a>11733             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l11734"></a>11734          }
<a name="l11735"></a>11735          <span class="keywordflow">break</span>;
<a name="l11736"></a>11736       <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l11737"></a>11737       <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l11738"></a>11738       <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:
<a name="l11739"></a>11739       <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>:
<a name="l11740"></a>11740       <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l11741"></a>11741       <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l11742"></a>11742       <span class="keywordflow">case</span> <span class="charliteral">&apos;#&apos;</span>:
<a name="l11743"></a>11743          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l11744"></a>11744          <span class="keywordflow">break</span>;
<a name="l11745"></a>11745 <span class="preprocessor">#if 0 </span>
<a name="l11746"></a>11746 <span class="preprocessor"></span><span class="comment">/*  XXX Commented out for the moment because of the dangers of deleting</span>
<a name="l11747"></a>11747 <span class="comment">    a message while recording (can put the message numbers out of sync) */</span>
<a name="l11748"></a>11748       <span class="keywordflow">case</span> <span class="charliteral">&apos;*&apos;</span>:
<a name="l11749"></a>11749          <span class="comment">/* Cancel recording, delete message, offer to take another message*/</span>
<a name="l11750"></a>11750          cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-deleted&quot;</span>);
<a name="l11751"></a>11751          cmd = <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(tempfile, NULL);
<a name="l11752"></a>11752          <span class="keywordflow">if</span> (outsidecaller) {
<a name="l11753"></a>11753             res = <a class="code" href="app__voicemail_8c.html#a8506f88c9481bf3508695725d6beb0f6">vm_exec</a>(chan, NULL);
<a name="l11754"></a>11754             <span class="keywordflow">return</span> res;
<a name="l11755"></a>11755          }
<a name="l11756"></a>11756          <span class="keywordflow">else</span>
<a name="l11757"></a>11757             <span class="keywordflow">return</span> 1;
<a name="l11758"></a>11758 <span class="preprocessor">#endif</span>
<a name="l11759"></a>11759 <span class="preprocessor"></span>      <span class="keywordflow">case</span> <span class="charliteral">&apos;0&apos;</span>:
<a name="l11760"></a>11760          <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>)) {
<a name="l11761"></a>11761             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-sorry&quot;</span>);
<a name="l11762"></a>11762             <span class="keywordflow">break</span>;
<a name="l11763"></a>11763          }
<a name="l11764"></a>11764          <span class="keywordflow">if</span> (msg_exists || recorded) {
<a name="l11765"></a>11765             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-saveoper&quot;</span>);
<a name="l11766"></a>11766             <span class="keywordflow">if</span> (!cmd)
<a name="l11767"></a>11767                cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 3000);
<a name="l11768"></a>11768             <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;1&apos;</span>) {
<a name="l11769"></a>11769                <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>);
<a name="l11770"></a>11770                cmd = <span class="charliteral">&apos;0&apos;</span>;
<a name="l11771"></a>11771             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;4&apos;</span>) {
<a name="l11772"></a>11772                <span class="keywordflow">if</span> (flag) {
<a name="l11773"></a>11773                   <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-marked-urgent&quot;</span>);
<a name="l11774"></a>11774                   strcpy(flag, <span class="stringliteral">&quot;Urgent&quot;</span>);
<a name="l11775"></a>11775                }
<a name="l11776"></a>11776                <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-msgsaved&quot;</span>);
<a name="l11777"></a>11777                cmd = <span class="charliteral">&apos;0&apos;</span>;
<a name="l11778"></a>11778             } <span class="keywordflow">else</span> {
<a name="l11779"></a>11779                <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-deleted&quot;</span>);
<a name="l11780"></a>11780                <a class="code" href="app__voicemail_8c.html#a6f612696ee3ef9e74363b000efc92122">DELETE</a>(recordfile, -1, recordfile, vmu);
<a name="l11781"></a>11781                cmd = <span class="charliteral">&apos;0&apos;</span>;
<a name="l11782"></a>11782             }
<a name="l11783"></a>11783          }
<a name="l11784"></a>11784          <span class="keywordflow">return</span> cmd;
<a name="l11785"></a>11785       <span class="keywordflow">default</span>:
<a name="l11786"></a>11786          <span class="comment">/* If the caller is an ouside caller, and the review option is enabled,</span>
<a name="l11787"></a>11787 <span class="comment">            allow them to review the message, but let the owner of the box review</span>
<a name="l11788"></a>11788 <span class="comment">            their OGM&apos;s */</span>
<a name="l11789"></a>11789          <span class="keywordflow">if</span> (outsidecaller &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#aed272644d27e1104b1115318e2be6fe4">VM_REVIEW</a>))
<a name="l11790"></a>11790             <span class="keywordflow">return</span> cmd;
<a name="l11791"></a>11791          <span class="keywordflow">if</span> (msg_exists) {
<a name="l11792"></a>11792             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review&quot;</span>);
<a name="l11793"></a>11793             <span class="keywordflow">if</span> (!cmd &amp;&amp; outsidecaller) {
<a name="l11794"></a>11794                <span class="keywordflow">if</span> ((flag &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag)) || (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(flag) &amp;&amp; strcmp(flag, <span class="stringliteral">&quot;Urgent&quot;</span>))) {
<a name="l11795"></a>11795                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review-urgent&quot;</span>);
<a name="l11796"></a>11796                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (flag) {
<a name="l11797"></a>11797                   cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-review-nonurgent&quot;</span>);
<a name="l11798"></a>11798                }
<a name="l11799"></a>11799             }
<a name="l11800"></a>11800          } <span class="keywordflow">else</span> {
<a name="l11801"></a>11801             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-torerecord&quot;</span>);
<a name="l11802"></a>11802             <span class="keywordflow">if</span> (!cmd)
<a name="l11803"></a>11803                cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 600);
<a name="l11804"></a>11804          }
<a name="l11805"></a>11805          
<a name="l11806"></a>11806          <span class="keywordflow">if</span> (!cmd &amp;&amp; outsidecaller &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(vmu, <a class="code" href="app__voicemail_8c.html#a2f8ec3653f4ec69cd785b8026421a3ad">VM_OPERATOR</a>)) {
<a name="l11807"></a>11807             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-reachoper&quot;</span>);
<a name="l11808"></a>11808             <span class="keywordflow">if</span> (!cmd)
<a name="l11809"></a>11809                cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 600);
<a name="l11810"></a>11810          }
<a name="l11811"></a>11811 <span class="preprocessor">#if 0</span>
<a name="l11812"></a>11812 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (!cmd)
<a name="l11813"></a>11813             cmd = <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-tocancelmsg&quot;</span>);
<a name="l11814"></a>11814 <span class="preprocessor">#endif</span>
<a name="l11815"></a>11815 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (!cmd)
<a name="l11816"></a>11816             cmd = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 6000);
<a name="l11817"></a>11817          <span class="keywordflow">if</span> (!cmd) {
<a name="l11818"></a>11818             attempts++;
<a name="l11819"></a>11819          }
<a name="l11820"></a>11820          <span class="keywordflow">if</span> (attempts &gt; max_attempts) {
<a name="l11821"></a>11821             cmd = <span class="charliteral">&apos;t&apos;</span>;
<a name="l11822"></a>11822          }
<a name="l11823"></a>11823       }
<a name="l11824"></a>11824    }
<a name="l11825"></a>11825    <span class="keywordflow">if</span> (outsidecaller)
<a name="l11826"></a>11826       <a class="code" href="app_8h.html#abbbec6ab9a303e865a1d1a261152540d" title="Play a stream and wait for a digit, returning the digit that was pressed.">ast_play_and_wait</a>(chan, <span class="stringliteral">&quot;vm-goodbye&quot;</span>);
<a name="l11827"></a>11827    <span class="keywordflow">if</span> (cmd == <span class="charliteral">&apos;t&apos;</span>)
<a name="l11828"></a>11828       cmd = 0;
<a name="l11829"></a>11829    <span class="keywordflow">return</span> cmd;
<a name="l11830"></a>11830 }
<a name="l11831"></a>11831 
<a name="l11832"></a>11832 <span class="comment">/* This is a workaround so that menuselect displays a proper description</span>
<a name="l11833"></a>11833 <span class="comment"> * AST_MODULE_INFO(, , &quot;Comedian Mail (Voicemail System)&quot;</span>
<a name="l11834"></a>11834 <span class="comment"> */</span>
<a name="l11835"></a>11835 
<a name="l11836"></a>11836 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <a class="code" href="app__voicemail_8c.html#adb02bb3719cdf90c200c1ca30caa26a2">tdesc</a>,
<a name="l11837"></a>11837       .load = <a class="code" href="app__voicemail_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l11838"></a>11838       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l11839"></a>11839       .<a class="code" href="app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="app__voicemail_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l11840"></a>11840       );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:28 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
