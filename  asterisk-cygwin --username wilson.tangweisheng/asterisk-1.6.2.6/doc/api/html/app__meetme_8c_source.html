<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:25 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_meetme.c</h1><a href="app__meetme_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2007, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * SLA Implementation by:</span>
<a name="l00009"></a>00009 <span class="comment"> * Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00010"></a>00010 <span class="comment"> *</span>
<a name="l00011"></a>00011 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00012"></a>00012 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00013"></a>00013 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00014"></a>00014 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00015"></a>00015 <span class="comment"> * channels for your use.</span>
<a name="l00016"></a>00016 <span class="comment"> *</span>
<a name="l00017"></a>00017 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00018"></a>00018 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00019"></a>00019 <span class="comment"> * at the top of the source tree.</span>
<a name="l00020"></a>00020 <span class="comment"> */</span>
<a name="l00021"></a>00021 <span class="comment"></span>
<a name="l00022"></a>00022 <span class="comment">/*! \file</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \brief Meet me conference bridge and Shared Line Appearances</span>
<a name="l00025"></a>00025 <span class="comment"> *</span>
<a name="l00026"></a>00026 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00027"></a>00027 <span class="comment"> * \author (SLA) Russell Bryant &lt;russell@digium.com&gt;</span>
<a name="l00028"></a>00028 <span class="comment"> * </span>
<a name="l00029"></a>00029 <span class="comment"> * \ingroup applications</span>
<a name="l00030"></a>00030 <span class="comment"> */</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="comment">/*** MODULEINFO</span>
<a name="l00033"></a>00033 <span class="comment">   &lt;depend&gt;dahdi&lt;/depend&gt;</span>
<a name="l00034"></a>00034 <span class="comment"> ***/</span>
<a name="l00035"></a>00035 
<a name="l00036"></a>00036 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 238185 $&quot;</span>)
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;dahdi/user.h&gt;</span>
<a name="l00041"></a>00041 <span class="preprocessor"></span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="dsp_8h.html" title="Convenient Signal Processing routines.">asterisk/dsp.h</a>&quot;</span>
<a name="l00050"></a>00050 <span class="preprocessor">#include &quot;<a class="code" href="musiconhold_8h.html" title="Music on hold handling.">asterisk/musiconhold.h</a>&quot;</span>
<a name="l00051"></a>00051 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00052"></a>00052 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00053"></a>00053 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>
<a name="l00054"></a>00054 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00055"></a>00055 <span class="preprocessor">#include &quot;<a class="code" href="translate_8h.html" title="Support for translation of data formats. translate.c.">asterisk/translate.h</a>&quot;</span>
<a name="l00056"></a>00056 <span class="preprocessor">#include &quot;<a class="code" href="ulaw_8h.html" title="u-Law to Signed linear conversion">asterisk/ulaw.h</a>&quot;</span>
<a name="l00057"></a>00057 <span class="preprocessor">#include &quot;<a class="code" href="astobj2_8h.html">asterisk/astobj2.h</a>&quot;</span>
<a name="l00058"></a>00058 <span class="preprocessor">#include &quot;<a class="code" href="devicestate_8h.html" title="Device state management.">asterisk/devicestate.h</a>&quot;</span>
<a name="l00059"></a>00059 <span class="preprocessor">#include &quot;<a class="code" href="dial_8h.html" title="Dialing API.">asterisk/dial.h</a>&quot;</span>
<a name="l00060"></a>00060 <span class="preprocessor">#include &quot;<a class="code" href="causes_8h.html" title="Internal Asterisk hangup causes.">asterisk/causes.h</a>&quot;</span>
<a name="l00061"></a>00061 <span class="preprocessor">#include &quot;<a class="code" href="paths_8h.html" title="Asterisk file paths, configured in asterisk.conf.">asterisk/paths.h</a>&quot;</span>
<a name="l00062"></a>00062 
<a name="l00063"></a>00063 <span class="preprocessor">#include &quot;<a class="code" href="enter_8h.html">enter.h</a>&quot;</span>
<a name="l00064"></a>00064 <span class="preprocessor">#include &quot;<a class="code" href="leave_8h.html">leave.h</a>&quot;</span>
<a name="l00065"></a>00065 
<a name="l00066"></a>00066 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00067"></a>00067 <span class="comment">   &lt;application name=&quot;MeetMe&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00068"></a>00068 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00069"></a>00069 <span class="comment">         MeetMe conference bridge.</span>
<a name="l00070"></a>00070 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00071"></a>00071 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00072"></a>00072 <span class="comment">         &lt;parameter name=&quot;confno&quot;&gt;</span>
<a name="l00073"></a>00073 <span class="comment">            &lt;para&gt;The conference number&lt;/para&gt;</span>
<a name="l00074"></a>00074 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00075"></a>00075 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00076"></a>00076 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00077"></a>00077 <span class="comment">               &lt;option name=&quot;a&quot;&gt;</span>
<a name="l00078"></a>00078 <span class="comment">                  &lt;para&gt;Set admin mode.&lt;/para&gt;</span>
<a name="l00079"></a>00079 <span class="comment">               &lt;/option&gt;</span>
<a name="l00080"></a>00080 <span class="comment">               &lt;option name=&quot;A&quot;&gt;</span>
<a name="l00081"></a>00081 <span class="comment">                  &lt;para&gt;Set marked mode.&lt;/para&gt;</span>
<a name="l00082"></a>00082 <span class="comment">               &lt;/option&gt;</span>
<a name="l00083"></a>00083 <span class="comment">               &lt;option name=&quot;b&quot;&gt;</span>
<a name="l00084"></a>00084 <span class="comment">                  &lt;para&gt;Run AGI script specified in &lt;variable&gt;MEETME_AGI_BACKGROUND&lt;/variable&gt;</span>
<a name="l00085"></a>00085 <span class="comment">                  Default: &lt;literal&gt;conf-background.agi&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00086"></a>00086 <span class="comment">                  &lt;note&gt;&lt;para&gt;This does not work with non-DAHDI channels in the same</span>
<a name="l00087"></a>00087 <span class="comment">                  conference).&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00088"></a>00088 <span class="comment">               &lt;/option&gt;</span>
<a name="l00089"></a>00089 <span class="comment">               &lt;option name=&quot;c&quot;&gt;</span>
<a name="l00090"></a>00090 <span class="comment">                  &lt;para&gt;Announce user(s) count on joining a conference.&lt;/para&gt;</span>
<a name="l00091"></a>00091 <span class="comment">               &lt;/option&gt;</span>
<a name="l00092"></a>00092 <span class="comment">               &lt;option name=&quot;C&quot;&gt;</span>
<a name="l00093"></a>00093 <span class="comment">                  &lt;para&gt;Continue in dialplan when kicked out of conference.&lt;/para&gt;</span>
<a name="l00094"></a>00094 <span class="comment">               &lt;/option&gt;</span>
<a name="l00095"></a>00095 <span class="comment">               &lt;option name=&quot;d&quot;&gt;</span>
<a name="l00096"></a>00096 <span class="comment">                  &lt;para&gt;Dynamically add conference.&lt;/para&gt;</span>
<a name="l00097"></a>00097 <span class="comment">               &lt;/option&gt;</span>
<a name="l00098"></a>00098 <span class="comment">               &lt;option name=&quot;D&quot;&gt;</span>
<a name="l00099"></a>00099 <span class="comment">                  &lt;para&gt;Dynamically add conference, prompting for a PIN.&lt;/para&gt;</span>
<a name="l00100"></a>00100 <span class="comment">               &lt;/option&gt;</span>
<a name="l00101"></a>00101 <span class="comment">               &lt;option name=&quot;e&quot;&gt;</span>
<a name="l00102"></a>00102 <span class="comment">                  &lt;para&gt;Select an empty conference.&lt;/para&gt;</span>
<a name="l00103"></a>00103 <span class="comment">               &lt;/option&gt;</span>
<a name="l00104"></a>00104 <span class="comment">               &lt;option name=&quot;E&quot;&gt;</span>
<a name="l00105"></a>00105 <span class="comment">                  &lt;para&gt;Select an empty pinless conference.&lt;/para&gt;</span>
<a name="l00106"></a>00106 <span class="comment">               &lt;/option&gt;</span>
<a name="l00107"></a>00107 <span class="comment">               &lt;option name=&quot;F&quot;&gt;</span>
<a name="l00108"></a>00108 <span class="comment">                  &lt;para&gt;Pass DTMF through the conference.&lt;/para&gt;</span>
<a name="l00109"></a>00109 <span class="comment">               &lt;/option&gt;</span>
<a name="l00110"></a>00110 <span class="comment">               &lt;option name=&quot;i&quot;&gt;</span>
<a name="l00111"></a>00111 <span class="comment">                  &lt;para&gt;Announce user join/leave with review.&lt;/para&gt;</span>
<a name="l00112"></a>00112 <span class="comment">               &lt;/option&gt;</span>
<a name="l00113"></a>00113 <span class="comment">               &lt;option name=&quot;I&quot;&gt;</span>
<a name="l00114"></a>00114 <span class="comment">                  &lt;para&gt;Announce user join/leave without review.&lt;/para&gt;</span>
<a name="l00115"></a>00115 <span class="comment">               &lt;/option&gt;</span>
<a name="l00116"></a>00116 <span class="comment">               &lt;option name=&quot;l&quot;&gt;</span>
<a name="l00117"></a>00117 <span class="comment">                  &lt;para&gt;Set listen only mode (Listen only, no talking).&lt;/para&gt;</span>
<a name="l00118"></a>00118 <span class="comment">               &lt;/option&gt;</span>
<a name="l00119"></a>00119 <span class="comment">               &lt;option name=&quot;m&quot;&gt;</span>
<a name="l00120"></a>00120 <span class="comment">                  &lt;para&gt;Set initially muted.&lt;/para&gt;</span>
<a name="l00121"></a>00121 <span class="comment">               &lt;/option&gt;</span>
<a name="l00122"></a>00122 <span class="comment">               &lt;option name=&quot;M&quot; hasparams=&quot;optional&quot;&gt;</span>
<a name="l00123"></a>00123 <span class="comment">                  &lt;para&gt;Enable music on hold when the conference has a single caller. Optionally,</span>
<a name="l00124"></a>00124 <span class="comment">                  specify a musiconhold class to use. If one is not provided, it will use the</span>
<a name="l00125"></a>00125 <span class="comment">                  channel&apos;s currently set music class, or &lt;literal&gt;default&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00126"></a>00126 <span class="comment">                  &lt;argument name=&quot;class&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00127"></a>00127 <span class="comment">               &lt;/option&gt;</span>
<a name="l00128"></a>00128 <span class="comment">               &lt;option name=&quot;o&quot;&gt;</span>
<a name="l00129"></a>00129 <span class="comment">                  &lt;para&gt;Set talker optimization - treats talkers who aren&apos;t speaking as</span>
<a name="l00130"></a>00130 <span class="comment">                  being muted, meaning (a) No encode is done on transmission and (b)</span>
<a name="l00131"></a>00131 <span class="comment">                  Received audio that is not registered as talking is omitted causing no</span>
<a name="l00132"></a>00132 <span class="comment">                  buildup in background noise.&lt;/para&gt;</span>
<a name="l00133"></a>00133 <span class="comment">               &lt;/option&gt;</span>
<a name="l00134"></a>00134 <span class="comment">               &lt;option name=&quot;p&quot; hasparams=&quot;optional&quot;&gt;</span>
<a name="l00135"></a>00135 <span class="comment">                  &lt;para&gt;Allow user to exit the conference by pressing &lt;literal&gt;#&lt;/literal&gt; (default)</span>
<a name="l00136"></a>00136 <span class="comment">                  or any of the defined keys. If keys contain &lt;literal&gt;*&lt;/literal&gt; this will override</span>
<a name="l00137"></a>00137 <span class="comment">                  option &lt;literal&gt;s&lt;/literal&gt;. The key used is set to channel variable</span>
<a name="l00138"></a>00138 <span class="comment">                  &lt;variable&gt;MEETME_EXIT_KEY&lt;/variable&gt;.&lt;/para&gt;</span>
<a name="l00139"></a>00139 <span class="comment">                  &lt;argument name=&quot;keys&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00140"></a>00140 <span class="comment">               &lt;/option&gt;</span>
<a name="l00141"></a>00141 <span class="comment">               &lt;option name=&quot;P&quot;&gt;</span>
<a name="l00142"></a>00142 <span class="comment">                  &lt;para&gt;Always prompt for the pin even if it is specified.&lt;/para&gt;</span>
<a name="l00143"></a>00143 <span class="comment">               &lt;/option&gt;</span>
<a name="l00144"></a>00144 <span class="comment">               &lt;option name=&quot;q&quot;&gt;</span>
<a name="l00145"></a>00145 <span class="comment">                  &lt;para&gt;Quiet mode (don&apos;t play enter/leave sounds).&lt;/para&gt;</span>
<a name="l00146"></a>00146 <span class="comment">               &lt;/option&gt;</span>
<a name="l00147"></a>00147 <span class="comment">               &lt;option name=&quot;r&quot;&gt;</span>
<a name="l00148"></a>00148 <span class="comment">                  &lt;para&gt;Record conference (records as &lt;variable&gt;MEETME_RECORDINGFILE&lt;/variable&gt;</span>
<a name="l00149"></a>00149 <span class="comment">                  using format &lt;variable&gt;MEETME_RECORDINGFORMAT&lt;/variable&gt;. Default filename is</span>
<a name="l00150"></a>00150 <span class="comment">                  &lt;literal&gt;meetme-conf-rec-${CONFNO}-${UNIQUEID}&lt;/literal&gt; and the default format is</span>
<a name="l00151"></a>00151 <span class="comment">                  wav.&lt;/para&gt;</span>
<a name="l00152"></a>00152 <span class="comment">               &lt;/option&gt;</span>
<a name="l00153"></a>00153 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00154"></a>00154 <span class="comment">                  &lt;para&gt;Present menu (user or admin) when &lt;literal&gt;*&lt;/literal&gt; is received</span>
<a name="l00155"></a>00155 <span class="comment">                  (send to menu).&lt;/para&gt;</span>
<a name="l00156"></a>00156 <span class="comment">               &lt;/option&gt;</span>
<a name="l00157"></a>00157 <span class="comment">               &lt;option name=&quot;t&quot;&gt;</span>
<a name="l00158"></a>00158 <span class="comment">                  &lt;para&gt;Set talk only mode. (Talk only, no listening).&lt;/para&gt;</span>
<a name="l00159"></a>00159 <span class="comment">               &lt;/option&gt;</span>
<a name="l00160"></a>00160 <span class="comment">               &lt;option name=&quot;T&quot;&gt;</span>
<a name="l00161"></a>00161 <span class="comment">                  &lt;para&gt;Set talker detection (sent to manager interface and meetme list).&lt;/para&gt;</span>
<a name="l00162"></a>00162 <span class="comment">               &lt;/option&gt;</span>
<a name="l00163"></a>00163 <span class="comment">               &lt;option name=&quot;W&quot; hasparams=&quot;optional&quot;&gt;</span>
<a name="l00164"></a>00164 <span class="comment">                  &lt;para&gt;Wait until the marked user enters the conference.&lt;/para&gt;</span>
<a name="l00165"></a>00165 <span class="comment">                  &lt;argument name=&quot;secs&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00166"></a>00166 <span class="comment">               &lt;/option&gt;</span>
<a name="l00167"></a>00167 <span class="comment">               &lt;option name=&quot;x&quot;&gt;</span>
<a name="l00168"></a>00168 <span class="comment">                  &lt;para&gt;Close the conference when last marked user exits&lt;/para&gt;</span>
<a name="l00169"></a>00169 <span class="comment">               &lt;/option&gt;</span>
<a name="l00170"></a>00170 <span class="comment">               &lt;option name=&quot;X&quot;&gt;</span>
<a name="l00171"></a>00171 <span class="comment">                  &lt;para&gt;Allow user to exit the conference by entering a valid single digit</span>
<a name="l00172"></a>00172 <span class="comment">                  extension &lt;variable&gt;MEETME_EXIT_CONTEXT&lt;/variable&gt; or the current context</span>
<a name="l00173"></a>00173 <span class="comment">                  if that variable is not defined.&lt;/para&gt;</span>
<a name="l00174"></a>00174 <span class="comment">               &lt;/option&gt;</span>
<a name="l00175"></a>00175 <span class="comment">               &lt;option name=&quot;1&quot;&gt;</span>
<a name="l00176"></a>00176 <span class="comment">                  &lt;para&gt;Do not play message when first person enters&lt;/para&gt;</span>
<a name="l00177"></a>00177 <span class="comment">               &lt;/option&gt;</span>
<a name="l00178"></a>00178 <span class="comment">               &lt;option name=&quot;S&quot;&gt;</span>
<a name="l00179"></a>00179 <span class="comment">                  &lt;para&gt;Kick the user &lt;replaceable&gt;x&lt;/replaceable&gt; seconds &lt;emphasis&gt;after&lt;/emphasis&gt; he entered into</span>
<a name="l00180"></a>00180 <span class="comment">                  the conference.&lt;/para&gt;</span>
<a name="l00181"></a>00181 <span class="comment">                  &lt;argument name=&quot;x&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00182"></a>00182 <span class="comment">               &lt;/option&gt;</span>
<a name="l00183"></a>00183 <span class="comment">               &lt;option name=&quot;L&quot; argsep=&quot;:&quot;&gt;</span>
<a name="l00184"></a>00184 <span class="comment">                  &lt;para&gt;Limit the conference to &lt;replaceable&gt;x&lt;/replaceable&gt; ms. Play a warning when</span>
<a name="l00185"></a>00185 <span class="comment">                  &lt;replaceable&gt;y&lt;/replaceable&gt; ms are left. Repeat the warning every &lt;replaceable&gt;z&lt;/replaceable&gt; ms.</span>
<a name="l00186"></a>00186 <span class="comment">                  The following special variables can be used with this option:&lt;/para&gt;</span>
<a name="l00187"></a>00187 <span class="comment">                  &lt;variablelist&gt;</span>
<a name="l00188"></a>00188 <span class="comment">                     &lt;variable name=&quot;CONF_LIMIT_TIMEOUT_FILE&quot;&gt;</span>
<a name="l00189"></a>00189 <span class="comment">                        &lt;para&gt;File to play when time is up.&lt;/para&gt;</span>
<a name="l00190"></a>00190 <span class="comment">                     &lt;/variable&gt;</span>
<a name="l00191"></a>00191 <span class="comment">                     &lt;variable name=&quot;CONF_LIMIT_WARNING_FILE&quot;&gt;</span>
<a name="l00192"></a>00192 <span class="comment">                        &lt;para&gt;File to play as warning if &lt;replaceable&gt;y&lt;/replaceable&gt; is defined. The</span>
<a name="l00193"></a>00193 <span class="comment">                        default is to say the time remaining.&lt;/para&gt;</span>
<a name="l00194"></a>00194 <span class="comment">                     &lt;/variable&gt;</span>
<a name="l00195"></a>00195 <span class="comment">                  &lt;/variablelist&gt;</span>
<a name="l00196"></a>00196 <span class="comment">                  &lt;argument name=&quot;x&quot; /&gt;</span>
<a name="l00197"></a>00197 <span class="comment">                  &lt;argument name=&quot;y&quot; /&gt;</span>
<a name="l00198"></a>00198 <span class="comment">                  &lt;argument name=&quot;z&quot; /&gt;</span>
<a name="l00199"></a>00199 <span class="comment">               &lt;/option&gt;</span>
<a name="l00200"></a>00200 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00201"></a>00201 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00202"></a>00202 <span class="comment">         &lt;parameter name=&quot;pin&quot; /&gt;</span>
<a name="l00203"></a>00203 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00204"></a>00204 <span class="comment">      &lt;description&gt;</span>
<a name="l00205"></a>00205 <span class="comment">         &lt;para&gt;Enters the user into a specified MeetMe conference.  If the &lt;replaceable&gt;confno&lt;/replaceable&gt;</span>
<a name="l00206"></a>00206 <span class="comment">         is omitted, the user will be prompted to enter one.  User can exit the conference by hangup, or</span>
<a name="l00207"></a>00207 <span class="comment">         if the &lt;literal&gt;p&lt;/literal&gt; option is specified, by pressing &lt;literal&gt;#&lt;/literal&gt;.&lt;/para&gt;</span>
<a name="l00208"></a>00208 <span class="comment">         &lt;note&gt;&lt;para&gt;The DAHDI kernel modules and at least one hardware driver (or dahdi_dummy)</span>
<a name="l00209"></a>00209 <span class="comment">         must be present for conferencing to operate properly. In addition, the chan_dahdi channel driver</span>
<a name="l00210"></a>00210 <span class="comment">         must be loaded for the &lt;literal&gt;i&lt;/literal&gt; and &lt;literal&gt;r&lt;/literal&gt; options to operate at</span>
<a name="l00211"></a>00211 <span class="comment">         all.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00212"></a>00212 <span class="comment">      &lt;/description&gt;</span>
<a name="l00213"></a>00213 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00214"></a>00214 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MeetMeCount&lt;/ref&gt;</span>
<a name="l00215"></a>00215 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MeetMeAdmin&lt;/ref&gt;</span>
<a name="l00216"></a>00216 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MeetMeChannelAdmin&lt;/ref&gt;</span>
<a name="l00217"></a>00217 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00218"></a>00218 <span class="comment">   &lt;/application&gt;</span>
<a name="l00219"></a>00219 <span class="comment">   &lt;application name=&quot;MeetMeCount&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00220"></a>00220 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00221"></a>00221 <span class="comment">         MeetMe participant count.</span>
<a name="l00222"></a>00222 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00223"></a>00223 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00224"></a>00224 <span class="comment">         &lt;parameter name=&quot;confno&quot; required=&quot;true&quot;&gt;</span>
<a name="l00225"></a>00225 <span class="comment">            &lt;para&gt;Conference number.&lt;/para&gt;</span>
<a name="l00226"></a>00226 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00227"></a>00227 <span class="comment">         &lt;parameter name=&quot;var&quot; /&gt;</span>
<a name="l00228"></a>00228 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00229"></a>00229 <span class="comment">      &lt;description&gt;</span>
<a name="l00230"></a>00230 <span class="comment">         &lt;para&gt;Plays back the number of users in the specified MeetMe conference.</span>
<a name="l00231"></a>00231 <span class="comment">         If &lt;replaceable&gt;var&lt;/replaceable&gt; is specified, playback will be skipped and the value</span>
<a name="l00232"></a>00232 <span class="comment">         will be returned in the variable. Upon application completion, MeetMeCount will hangup</span>
<a name="l00233"></a>00233 <span class="comment">         the channel, unless priority &lt;literal&gt;n+1&lt;/literal&gt; exists, in which case priority progress will</span>
<a name="l00234"></a>00234 <span class="comment">         continue.&lt;/para&gt;</span>
<a name="l00235"></a>00235 <span class="comment">      &lt;/description&gt;</span>
<a name="l00236"></a>00236 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00237"></a>00237 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MeetMe&lt;/ref&gt;</span>
<a name="l00238"></a>00238 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00239"></a>00239 <span class="comment">   &lt;/application&gt;</span>
<a name="l00240"></a>00240 <span class="comment">   &lt;application name=&quot;MeetMeAdmin&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00241"></a>00241 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00242"></a>00242 <span class="comment">         MeetMe conference administration.</span>
<a name="l00243"></a>00243 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00244"></a>00244 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00245"></a>00245 <span class="comment">         &lt;parameter name=&quot;confno&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00246"></a>00246 <span class="comment">         &lt;parameter name=&quot;command&quot; required=&quot;true&quot;&gt;</span>
<a name="l00247"></a>00247 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00248"></a>00248 <span class="comment">               &lt;option name=&quot;e&quot;&gt;</span>
<a name="l00249"></a>00249 <span class="comment">                  &lt;para&gt;Eject last user that joined.&lt;/para&gt;</span>
<a name="l00250"></a>00250 <span class="comment">               &lt;/option&gt;</span>
<a name="l00251"></a>00251 <span class="comment">               &lt;option name=&quot;E&quot;&gt;</span>
<a name="l00252"></a>00252 <span class="comment">                  &lt;para&gt;Extend conference end time, if scheduled.&lt;/para&gt;</span>
<a name="l00253"></a>00253 <span class="comment">               &lt;/option&gt;</span>
<a name="l00254"></a>00254 <span class="comment">               &lt;option name=&quot;k&quot;&gt;</span>
<a name="l00255"></a>00255 <span class="comment">                  &lt;para&gt;Kick one user out of conference.&lt;/para&gt;</span>
<a name="l00256"></a>00256 <span class="comment">               &lt;/option&gt;</span>
<a name="l00257"></a>00257 <span class="comment">               &lt;option name=&quot;K&quot;&gt;</span>
<a name="l00258"></a>00258 <span class="comment">                  &lt;para&gt;Kick all users out of conference.&lt;/para&gt;</span>
<a name="l00259"></a>00259 <span class="comment">               &lt;/option&gt;</span>
<a name="l00260"></a>00260 <span class="comment">               &lt;option name=&quot;l&quot;&gt;</span>
<a name="l00261"></a>00261 <span class="comment">                  &lt;para&gt;Unlock conference.&lt;/para&gt;</span>
<a name="l00262"></a>00262 <span class="comment">               &lt;/option&gt;</span>
<a name="l00263"></a>00263 <span class="comment">               &lt;option name=&quot;L&quot;&gt;</span>
<a name="l00264"></a>00264 <span class="comment">                  &lt;para&gt;Lock conference.&lt;/para&gt;</span>
<a name="l00265"></a>00265 <span class="comment">               &lt;/option&gt;</span>
<a name="l00266"></a>00266 <span class="comment">               &lt;option name=&quot;m&quot;&gt;</span>
<a name="l00267"></a>00267 <span class="comment">                  &lt;para&gt;Unmute one user.&lt;/para&gt;</span>
<a name="l00268"></a>00268 <span class="comment">               &lt;/option&gt;</span>
<a name="l00269"></a>00269 <span class="comment">               &lt;option name=&quot;M&quot;&gt;</span>
<a name="l00270"></a>00270 <span class="comment">                  &lt;para&gt;Mute one user.&lt;/para&gt;</span>
<a name="l00271"></a>00271 <span class="comment">               &lt;/option&gt;</span>
<a name="l00272"></a>00272 <span class="comment">               &lt;option name=&quot;n&quot;&gt;</span>
<a name="l00273"></a>00273 <span class="comment">                  &lt;para&gt;Unmute all users in the conference.&lt;/para&gt;</span>
<a name="l00274"></a>00274 <span class="comment">               &lt;/option&gt;</span>
<a name="l00275"></a>00275 <span class="comment">               &lt;option name=&quot;N&quot;&gt;</span>
<a name="l00276"></a>00276 <span class="comment">                  &lt;para&gt;Mute all non-admin users in the conference.&lt;/para&gt;</span>
<a name="l00277"></a>00277 <span class="comment">               &lt;/option&gt;</span>
<a name="l00278"></a>00278 <span class="comment">               &lt;option name=&quot;r&quot;&gt;</span>
<a name="l00279"></a>00279 <span class="comment">                  &lt;para&gt;Reset one user&apos;s volume settings.&lt;/para&gt;</span>
<a name="l00280"></a>00280 <span class="comment">               &lt;/option&gt;</span>
<a name="l00281"></a>00281 <span class="comment">               &lt;option name=&quot;R&quot;&gt;</span>
<a name="l00282"></a>00282 <span class="comment">                  &lt;para&gt;Reset all users volume settings.&lt;/para&gt;</span>
<a name="l00283"></a>00283 <span class="comment">               &lt;/option&gt;</span>
<a name="l00284"></a>00284 <span class="comment">               &lt;option name=&quot;s&quot;&gt;</span>
<a name="l00285"></a>00285 <span class="comment">                  &lt;para&gt;Lower entire conference speaking volume.&lt;/para&gt;</span>
<a name="l00286"></a>00286 <span class="comment">               &lt;/option&gt;</span>
<a name="l00287"></a>00287 <span class="comment">               &lt;option name=&quot;S&quot;&gt;</span>
<a name="l00288"></a>00288 <span class="comment">                  &lt;para&gt;Raise entire conference speaking volume.&lt;/para&gt;</span>
<a name="l00289"></a>00289 <span class="comment">               &lt;/option&gt;</span>
<a name="l00290"></a>00290 <span class="comment">               &lt;option name=&quot;t&quot;&gt;</span>
<a name="l00291"></a>00291 <span class="comment">                  &lt;para&gt;Lower one user&apos;s talk volume.&lt;/para&gt;</span>
<a name="l00292"></a>00292 <span class="comment">               &lt;/option&gt;</span>
<a name="l00293"></a>00293 <span class="comment">               &lt;option name=&quot;T&quot;&gt;</span>
<a name="l00294"></a>00294 <span class="comment">                  &lt;para&gt;Raise one user&apos;s talk volume.&lt;/para&gt;</span>
<a name="l00295"></a>00295 <span class="comment">               &lt;/option&gt;</span>
<a name="l00296"></a>00296 <span class="comment">               &lt;option name=&quot;u&quot;&gt;</span>
<a name="l00297"></a>00297 <span class="comment">                  &lt;para&gt;Lower one user&apos;s listen volume.&lt;/para&gt;</span>
<a name="l00298"></a>00298 <span class="comment">               &lt;/option&gt;</span>
<a name="l00299"></a>00299 <span class="comment">               &lt;option name=&quot;U&quot;&gt;</span>
<a name="l00300"></a>00300 <span class="comment">                  &lt;para&gt;Raise one user&apos;s listen volume.&lt;/para&gt;</span>
<a name="l00301"></a>00301 <span class="comment">               &lt;/option&gt;</span>
<a name="l00302"></a>00302 <span class="comment">               &lt;option name=&quot;v&quot;&gt;</span>
<a name="l00303"></a>00303 <span class="comment">                  &lt;para&gt;Lower entire conference listening volume.&lt;/para&gt;</span>
<a name="l00304"></a>00304 <span class="comment">               &lt;/option&gt;</span>
<a name="l00305"></a>00305 <span class="comment">               &lt;option name=&quot;V&quot;&gt;</span>
<a name="l00306"></a>00306 <span class="comment">                  &lt;para&gt;Raise entire conference listening volume.&lt;/para&gt;</span>
<a name="l00307"></a>00307 <span class="comment">               &lt;/option&gt;</span>
<a name="l00308"></a>00308 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00309"></a>00309 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00310"></a>00310 <span class="comment">         &lt;parameter name=&quot;user&quot; /&gt;</span>
<a name="l00311"></a>00311 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00312"></a>00312 <span class="comment">      &lt;description&gt;</span>
<a name="l00313"></a>00313 <span class="comment">         &lt;para&gt;Run admin &lt;replaceable&gt;command&lt;/replaceable&gt; for conference &lt;replaceable&gt;confno&lt;/replaceable&gt;.&lt;/para&gt;</span>
<a name="l00314"></a>00314 <span class="comment">         &lt;para&gt;Will additionally set the variable &lt;variable&gt;MEETMEADMINSTATUS&lt;/variable&gt; with one of</span>
<a name="l00315"></a>00315 <span class="comment">         the following values:&lt;/para&gt;</span>
<a name="l00316"></a>00316 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00317"></a>00317 <span class="comment">            &lt;variable name=&quot;MEETMEADMINSTATUS&quot;&gt;</span>
<a name="l00318"></a>00318 <span class="comment">               &lt;value name=&quot;NOPARSE&quot;&gt;</span>
<a name="l00319"></a>00319 <span class="comment">                  Invalid arguments.</span>
<a name="l00320"></a>00320 <span class="comment">               &lt;/value&gt;</span>
<a name="l00321"></a>00321 <span class="comment">               &lt;value name=&quot;NOTFOUND&quot;&gt;</span>
<a name="l00322"></a>00322 <span class="comment">                  User specified was not found.</span>
<a name="l00323"></a>00323 <span class="comment">               &lt;/value&gt;</span>
<a name="l00324"></a>00324 <span class="comment">               &lt;value name=&quot;FAILED&quot;&gt;</span>
<a name="l00325"></a>00325 <span class="comment">                  Another failure occurred.</span>
<a name="l00326"></a>00326 <span class="comment">               &lt;/value&gt;</span>
<a name="l00327"></a>00327 <span class="comment">               &lt;value name=&quot;OK&quot;&gt;</span>
<a name="l00328"></a>00328 <span class="comment">                  The operation was completed successfully.</span>
<a name="l00329"></a>00329 <span class="comment">               &lt;/value&gt;</span>
<a name="l00330"></a>00330 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00331"></a>00331 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00332"></a>00332 <span class="comment">      &lt;/description&gt;</span>
<a name="l00333"></a>00333 <span class="comment">      &lt;see-also&gt;</span>
<a name="l00334"></a>00334 <span class="comment">         &lt;ref type=&quot;application&quot;&gt;MeetMe&lt;/ref&gt;</span>
<a name="l00335"></a>00335 <span class="comment">      &lt;/see-also&gt;</span>
<a name="l00336"></a>00336 <span class="comment">   &lt;/application&gt;</span>
<a name="l00337"></a>00337 <span class="comment">   &lt;application name=&quot;MeetMeChannelAdmin&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00338"></a>00338 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00339"></a>00339 <span class="comment">         MeetMe conference Administration (channel specific).</span>
<a name="l00340"></a>00340 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00341"></a>00341 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00342"></a>00342 <span class="comment">         &lt;parameter name=&quot;channel&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00343"></a>00343 <span class="comment">         &lt;parameter name=&quot;command&quot; required=&quot;true&quot;&gt;</span>
<a name="l00344"></a>00344 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00345"></a>00345 <span class="comment">               &lt;option name=&quot;k&quot;&gt;</span>
<a name="l00346"></a>00346 <span class="comment">                  &lt;para&gt;Kick the specified user out of the conference he is in.&lt;/para&gt;</span>
<a name="l00347"></a>00347 <span class="comment">               &lt;/option&gt;</span>
<a name="l00348"></a>00348 <span class="comment">               &lt;option name=&quot;m&quot;&gt;</span>
<a name="l00349"></a>00349 <span class="comment">                  &lt;para&gt;Unmute the specified user.&lt;/para&gt;</span>
<a name="l00350"></a>00350 <span class="comment">               &lt;/option&gt;</span>
<a name="l00351"></a>00351 <span class="comment">               &lt;option name=&quot;M&quot;&gt;</span>
<a name="l00352"></a>00352 <span class="comment">                  &lt;para&gt;Mute the specified user.&lt;/para&gt;</span>
<a name="l00353"></a>00353 <span class="comment">               &lt;/option&gt;</span>
<a name="l00354"></a>00354 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00355"></a>00355 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00356"></a>00356 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00357"></a>00357 <span class="comment">      &lt;description&gt;</span>
<a name="l00358"></a>00358 <span class="comment">         &lt;para&gt;Run admin &lt;replaceable&gt;command&lt;/replaceable&gt; for a specific</span>
<a name="l00359"></a>00359 <span class="comment">         &lt;replaceable&gt;channel&lt;/replaceable&gt; in any coference.&lt;/para&gt;</span>
<a name="l00360"></a>00360 <span class="comment">      &lt;/description&gt;</span>
<a name="l00361"></a>00361 <span class="comment">   &lt;/application&gt;</span>
<a name="l00362"></a>00362 <span class="comment">   &lt;application name=&quot;SLAStation&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00363"></a>00363 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00364"></a>00364 <span class="comment">         Shared Line Appearance Station.</span>
<a name="l00365"></a>00365 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00366"></a>00366 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00367"></a>00367 <span class="comment">         &lt;parameter name=&quot;station&quot; required=&quot;true&quot;&gt;</span>
<a name="l00368"></a>00368 <span class="comment">            &lt;para&gt;Station name&lt;/para&gt;</span>
<a name="l00369"></a>00369 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00370"></a>00370 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00371"></a>00371 <span class="comment">      &lt;description&gt;</span>
<a name="l00372"></a>00372 <span class="comment">         &lt;para&gt;This application should be executed by an SLA station. The argument depends</span>
<a name="l00373"></a>00373 <span class="comment">         on how the call was initiated. If the phone was just taken off hook, then the argument</span>
<a name="l00374"></a>00374 <span class="comment">         &lt;replaceable&gt;station&lt;/replaceable&gt; should be just the station name. If the call was</span>
<a name="l00375"></a>00375 <span class="comment">         initiated by pressing a line key, then the station name should be preceded by an underscore</span>
<a name="l00376"></a>00376 <span class="comment">         and the trunk name associated with that line button.&lt;/para&gt;</span>
<a name="l00377"></a>00377 <span class="comment">         &lt;para&gt;For example: &lt;literal&gt;station1_line1&lt;/literal&gt;&lt;/para&gt;</span>
<a name="l00378"></a>00378 <span class="comment">         &lt;para&gt;On exit, this application will set the variable &lt;variable&gt;SLASTATION_STATUS&lt;/variable&gt; to</span>
<a name="l00379"></a>00379 <span class="comment">         one of the following values:&lt;/para&gt;</span>
<a name="l00380"></a>00380 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00381"></a>00381 <span class="comment">            &lt;variable name=&quot;SLASTATION_STATUS&quot;&gt;</span>
<a name="l00382"></a>00382 <span class="comment">               &lt;value name=&quot;FAILURE&quot; /&gt;</span>
<a name="l00383"></a>00383 <span class="comment">               &lt;value name=&quot;CONGESTION&quot; /&gt;</span>
<a name="l00384"></a>00384 <span class="comment">               &lt;value name=&quot;SUCCESS&quot; /&gt;</span>
<a name="l00385"></a>00385 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00386"></a>00386 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00387"></a>00387 <span class="comment">      &lt;/description&gt;</span>
<a name="l00388"></a>00388 <span class="comment">   &lt;/application&gt;</span>
<a name="l00389"></a>00389 <span class="comment">   &lt;application name=&quot;SLATrunk&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00390"></a>00390 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00391"></a>00391 <span class="comment">         Shared Line Appearance Trunk.</span>
<a name="l00392"></a>00392 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00393"></a>00393 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00394"></a>00394 <span class="comment">         &lt;parameter name=&quot;trunk&quot; required=&quot;true&quot;&gt;</span>
<a name="l00395"></a>00395 <span class="comment">            &lt;para&gt;Trunk name&lt;/para&gt;</span>
<a name="l00396"></a>00396 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00397"></a>00397 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00398"></a>00398 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00399"></a>00399 <span class="comment">               &lt;option name=&quot;M&quot; hasparams=&quot;optional&quot;&gt;</span>
<a name="l00400"></a>00400 <span class="comment">                  &lt;para&gt;Play back the specified MOH &lt;replaceable&gt;class&lt;/replaceable&gt;</span>
<a name="l00401"></a>00401 <span class="comment">                  instead of ringing&lt;/para&gt;</span>
<a name="l00402"></a>00402 <span class="comment">                  &lt;argument name=&quot;class&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00403"></a>00403 <span class="comment">               &lt;/option&gt;</span>
<a name="l00404"></a>00404 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00405"></a>00405 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00406"></a>00406 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00407"></a>00407 <span class="comment">      &lt;description&gt;</span>
<a name="l00408"></a>00408 <span class="comment">         &lt;para&gt;This application should be executed by an SLA trunk on an inbound call. The channel calling</span>
<a name="l00409"></a>00409 <span class="comment">         this application should correspond to the SLA trunk with the name &lt;replaceable&gt;trunk&lt;/replaceable&gt;</span>
<a name="l00410"></a>00410 <span class="comment">         that is being passed as an argument.&lt;/para&gt;</span>
<a name="l00411"></a>00411 <span class="comment">         &lt;para&gt;On exit, this application will set the variable &lt;variable&gt;SLATRUNK_STATUS&lt;/variable&gt; to</span>
<a name="l00412"></a>00412 <span class="comment">         one of the following values:&lt;/para&gt;</span>
<a name="l00413"></a>00413 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00414"></a>00414 <span class="comment">            &lt;variable name=&quot;SLATRUNK_STATUS&quot;&gt;</span>
<a name="l00415"></a>00415 <span class="comment">               &lt;value name=&quot;FAILURE&quot; /&gt;</span>
<a name="l00416"></a>00416 <span class="comment">               &lt;value name=&quot;SUCCESS&quot; /&gt;</span>
<a name="l00417"></a>00417 <span class="comment">               &lt;value name=&quot;UNANSWERED&quot; /&gt;</span>
<a name="l00418"></a>00418 <span class="comment">               &lt;value name=&quot;RINGTIMEOUT&quot; /&gt;</span>
<a name="l00419"></a>00419 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00420"></a>00420 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00421"></a>00421 <span class="comment">      &lt;/description&gt;</span>
<a name="l00422"></a>00422 <span class="comment">   &lt;/application&gt;</span>
<a name="l00423"></a>00423 <span class="comment"> ***/</span>
<a name="l00424"></a>00424 
<a name="l00425"></a><a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">00425</a> <span class="preprocessor">#define CONFIG_FILE_NAME &quot;meetme.conf&quot;</span>
<a name="l00426"></a><a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">00426</a> <span class="preprocessor"></span><span class="preprocessor">#define SLA_CONFIG_FILE  &quot;sla.conf&quot;</span>
<a name="l00427"></a>00427 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00428"></a>00428 <span class="comment">/*! each buffer is 20ms, so this is 640ms total */</span>
<a name="l00429"></a><a class="code" href="app__meetme_8c.html#af71d7de559e9731a4d8e57bafa341486">00429</a> <span class="preprocessor">#define DEFAULT_AUDIO_BUFFERS  32</span>
<a name="l00430"></a>00430 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00431"></a>00431 <span class="comment">/*! String format for scheduled conferences */</span>
<a name="l00432"></a><a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">00432</a> <span class="preprocessor">#define DATE_FORMAT &quot;%Y-%m-%d %H:%M:%S&quot;</span>
<a name="l00433"></a>00433 <span class="preprocessor"></span>
<a name="l00434"></a>00434 <span class="keyword">enum</span> {
<a name="l00435"></a><a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">00435</a>    <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> =     (1 &lt;&lt; 1), <span class="comment">/*!&lt; User is muted */</span>
<a name="l00436"></a><a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">00436</a>    <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> = (1 &lt;&lt; 2), <span class="comment">/*!&lt; User muted self */</span>
<a name="l00437"></a><a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">00437</a>    <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a> =    (1 &lt;&lt; 3),  <span class="comment">/*!&lt; User has been kicked */</span><span class="comment"></span>
<a name="l00438"></a>00438 <span class="comment">   /*! User has requested to speak */</span>
<a name="l00439"></a><a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">00439</a>    <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a> = (1 &lt;&lt; 4),
<a name="l00440"></a>00440 };
<a name="l00441"></a>00441 
<a name="l00442"></a><a class="code" href="app__meetme_8c.html#acb4e9672a8f8da6bfbe4aec38d0f6454">00442</a> <span class="preprocessor">#define MEETME_DELAYDETECTTALK     300</span>
<a name="l00443"></a><a class="code" href="app__meetme_8c.html#a36a45aad3f831056ed083856012785e3">00443</a> <span class="preprocessor"></span><span class="preprocessor">#define MEETME_DELAYDETECTENDTALK  1000</span>
<a name="l00444"></a>00444 <span class="preprocessor"></span>
<a name="l00445"></a><a class="code" href="app__meetme_8c.html#addd70c99776f00581f71a71d3c10d86f">00445</a> <span class="preprocessor">#define AST_FRAME_BITS  32</span>
<a name="l00446"></a>00446 <span class="preprocessor"></span>
<a name="l00447"></a><a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780b">00447</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780b">volume_action</a> {
<a name="l00448"></a><a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">00448</a>    <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>,
<a name="l00449"></a><a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">00449</a>    <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>
<a name="l00450"></a>00450 };
<a name="l00451"></a>00451 
<a name="l00452"></a><a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49b">00452</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49b">entrance_sound</a> {
<a name="l00453"></a><a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49ba951ab68bb8f7daafb78951107080904e">00453</a>    <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49ba951ab68bb8f7daafb78951107080904e">ENTER</a>,
<a name="l00454"></a><a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49bae09e07839103de682cb13fa773793fc0">00454</a>    <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49bae09e07839103de682cb13fa773793fc0">LEAVE</a>
<a name="l00455"></a>00455 };
<a name="l00456"></a>00456 
<a name="l00457"></a><a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298">00457</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298">recording_state</a> {
<a name="l00458"></a><a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a44a4c13334429a322cb3408ec48c1cfb">00458</a>    <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a44a4c13334429a322cb3408ec48c1cfb">MEETME_RECORD_OFF</a>,
<a name="l00459"></a><a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a0ba2326d29dd47c10f7eb501b58bfb45">00459</a>    <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a0ba2326d29dd47c10f7eb501b58bfb45">MEETME_RECORD_STARTED</a>,
<a name="l00460"></a><a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298aed2f74b0993cd2122169387b4ff74113">00460</a>    <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298aed2f74b0993cd2122169387b4ff74113">MEETME_RECORD_ACTIVE</a>,
<a name="l00461"></a><a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a79313598c5f4a645e3b006f59572a75d">00461</a>    <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a79313598c5f4a645e3b006f59572a75d">MEETME_RECORD_TERMINATE</a>
<a name="l00462"></a>00462 };
<a name="l00463"></a>00463 
<a name="l00464"></a><a class="code" href="app__meetme_8c.html#a2be5f0b8c25b67aa5ca5502d61c16b73">00464</a> <span class="preprocessor">#define CONF_SIZE  320</span>
<a name="l00465"></a>00465 <span class="preprocessor"></span>
<a name="l00466"></a>00466 <span class="keyword">enum</span> {<span class="comment"></span>
<a name="l00467"></a>00467 <span class="comment">   /*! user has admin access on the conference */</span>
<a name="l00468"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">00468</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a> = (1 &lt;&lt; 0),<span class="comment"></span>
<a name="l00469"></a>00469 <span class="comment">   /*! If set the user can only receive audio from the conference */</span>
<a name="l00470"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">00470</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">CONFFLAG_MONITOR</a> = (1 &lt;&lt; 1),<span class="comment"></span>
<a name="l00471"></a>00471 <span class="comment">   /*! If set asterisk will exit conference when key defined in p() option is pressed */</span>
<a name="l00472"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aeae3eb825018940e6703d8151f1f20d5">00472</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aeae3eb825018940e6703d8151f1f20d5">CONFFLAG_KEYEXIT</a> = (1 &lt;&lt; 2),<span class="comment"></span>
<a name="l00473"></a>00473 <span class="comment">   /*! If set asterisk will provide a menu to the user when &apos;*&apos; is pressed */</span>
<a name="l00474"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8c1f23aabf6a93f20eb6b11fe8e2b857">00474</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8c1f23aabf6a93f20eb6b11fe8e2b857">CONFFLAG_STARMENU</a> = (1 &lt;&lt; 3),<span class="comment"></span>
<a name="l00475"></a>00475 <span class="comment">   /*! If set the use can only send audio to the conference */</span>
<a name="l00476"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a39a9c6b58c7b77ef675e56d00c89e0a8">00476</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a39a9c6b58c7b77ef675e56d00c89e0a8">CONFFLAG_TALKER</a> = (1 &lt;&lt; 4),<span class="comment"></span>
<a name="l00477"></a>00477 <span class="comment">   /*! If set there will be no enter or leave sounds */</span>
<a name="l00478"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">00478</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a> = (1 &lt;&lt; 5),<span class="comment"></span>
<a name="l00479"></a>00479 <span class="comment">   /*! If set, when user joins the conference, they will be told the number </span>
<a name="l00480"></a>00480 <span class="comment">    *  of users that are already in */</span>
<a name="l00481"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a642977b3db866f6c6f87b1d5f7791d5b">00481</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a642977b3db866f6c6f87b1d5f7791d5b">CONFFLAG_ANNOUNCEUSERCOUNT</a> = (1 &lt;&lt; 6),<span class="comment"></span>
<a name="l00482"></a>00482 <span class="comment">   /*! Set to run AGI Script in Background */</span>
<a name="l00483"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76bd08a36963707fcb29643b2d3bb49">00483</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76bd08a36963707fcb29643b2d3bb49">CONFFLAG_AGI</a> = (1 &lt;&lt; 7),<span class="comment"></span>
<a name="l00484"></a>00484 <span class="comment">   /*! Set to have music on hold when user is alone in conference */</span>
<a name="l00485"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">00485</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">CONFFLAG_MOH</a> = (1 &lt;&lt; 8),<span class="comment"></span>
<a name="l00486"></a>00486 <span class="comment">   /*! If set the MeetMe will return if all marked with this flag left */</span>
<a name="l00487"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">00487</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a> = (1 &lt;&lt; 9),<span class="comment"></span>
<a name="l00488"></a>00488 <span class="comment">   /*! If set, the MeetMe will wait until a marked user enters */</span>
<a name="l00489"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a6bc154143d10b63764f073b756dbdb4a">00489</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a6bc154143d10b63764f073b756dbdb4a">CONFFLAG_WAITMARKED</a> = (1 &lt;&lt; 10),<span class="comment"></span>
<a name="l00490"></a>00490 <span class="comment">   /*! If set, the MeetMe will exit to the specified context */</span>
<a name="l00491"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a61bdcc99c25b743f89316b3da3796cc1">00491</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a61bdcc99c25b743f89316b3da3796cc1">CONFFLAG_EXIT_CONTEXT</a> = (1 &lt;&lt; 11),<span class="comment"></span>
<a name="l00492"></a>00492 <span class="comment">   /*! If set, the user will be marked */</span>
<a name="l00493"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">00493</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">CONFFLAG_MARKEDUSER</a> = (1 &lt;&lt; 12),<span class="comment"></span>
<a name="l00494"></a>00494 <span class="comment">   /*! If set, user will be ask record name on entry of conference */</span>
<a name="l00495"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">00495</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a> = (1 &lt;&lt; 13),<span class="comment"></span>
<a name="l00496"></a>00496 <span class="comment">   /*! If set, the MeetMe will be recorded */</span>
<a name="l00497"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">00497</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a> = (1&lt;&lt; 14),<span class="comment"></span>
<a name="l00498"></a>00498 <span class="comment">   /*! If set, the user will be monitored if the user is talking or not */</span>
<a name="l00499"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">00499</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a> = (1 &lt;&lt; 15),
<a name="l00500"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae83ea6d46f620c57461a6df40e7b321c">00500</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae83ea6d46f620c57461a6df40e7b321c">CONFFLAG_DYNAMIC</a> = (1 &lt;&lt; 16),
<a name="l00501"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a85da35a1f1708d3792f40ddfdde12919">00501</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a85da35a1f1708d3792f40ddfdde12919">CONFFLAG_DYNAMICPIN</a> = (1 &lt;&lt; 17),
<a name="l00502"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a829c143c29ff7d7c84cf2a4b6a86cfe9">00502</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a829c143c29ff7d7c84cf2a4b6a86cfe9">CONFFLAG_EMPTY</a> = (1 &lt;&lt; 18),
<a name="l00503"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae572ce074f616f8c0d48ce7a7b4d7546">00503</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae572ce074f616f8c0d48ce7a7b4d7546">CONFFLAG_EMPTYNOPIN</a> = (1 &lt;&lt; 19),
<a name="l00504"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a403c4698d20d41dffb30064fdd738c09">00504</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a403c4698d20d41dffb30064fdd738c09">CONFFLAG_ALWAYSPROMPT</a> = (1 &lt;&lt; 20),<span class="comment"></span>
<a name="l00505"></a>00505 <span class="comment">   /*! If set, treat talking users as muted users */</span>
<a name="l00506"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">00506</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">CONFFLAG_OPTIMIZETALKER</a> = (1 &lt;&lt; 21),<span class="comment"></span>
<a name="l00507"></a>00507 <span class="comment">   /*! If set, won&apos;t speak the extra prompt when the first person </span>
<a name="l00508"></a>00508 <span class="comment">    *  enters the conference */</span>
<a name="l00509"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acebf32e64aaad2bef9c62ae75ee816b7">00509</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acebf32e64aaad2bef9c62ae75ee816b7">CONFFLAG_NOONLYPERSON</a> = (1 &lt;&lt; 22),<span class="comment"></span>
<a name="l00510"></a>00510 <span class="comment">   /*! If set, user will be asked to record name on entry of conference </span>
<a name="l00511"></a>00511 <span class="comment">    *  without review */</span>
<a name="l00512"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">00512</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a> = (1 &lt;&lt; 23),<span class="comment"></span>
<a name="l00513"></a>00513 <span class="comment">   /*! If set, the user will be initially self-muted */</span>
<a name="l00514"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ad7732ac9c48e20f3c0bb5948ff1e01cf">00514</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ad7732ac9c48e20f3c0bb5948ff1e01cf">CONFFLAG_STARTMUTED</a> = (1 &lt;&lt; 24),<span class="comment"></span>
<a name="l00515"></a>00515 <span class="comment">   /*! Pass DTMF through the conference */</span>
<a name="l00516"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">00516</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a> = (1 &lt;&lt; 25),
<a name="l00517"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac793d6a4a78ffd301d51be06a771b70c">00517</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac793d6a4a78ffd301d51be06a771b70c">CONFFLAG_SLA_STATION</a> = (1 &lt;&lt; 26),
<a name="l00518"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac5154b9d3575197ced6458b31fba2143">00518</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac5154b9d3575197ced6458b31fba2143">CONFFLAG_SLA_TRUNK</a> = (1 &lt;&lt; 27),<span class="comment"></span>
<a name="l00519"></a>00519 <span class="comment">   /*! If set, the user should continue in the dialplan if kicked out */</span>
<a name="l00520"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aba8445fa67502f63291f122cb214cb83">00520</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aba8445fa67502f63291f122cb214cb83">CONFFLAG_KICK_CONTINUE</a> = (1 &lt;&lt; 28),
<a name="l00521"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8626cc2dc0a4e9e97be85ecd0ebaef15">00521</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8626cc2dc0a4e9e97be85ecd0ebaef15">CONFFLAG_DURATION_STOP</a> = (1 &lt;&lt; 29),
<a name="l00522"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a67bec58b805ac5d933829e8a28fa89e6">00522</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a67bec58b805ac5d933829e8a28fa89e6">CONFFLAG_DURATION_LIMIT</a> = (1 &lt;&lt; 30),<span class="comment"></span>
<a name="l00523"></a>00523 <span class="comment">   /*! Do not write any audio to this channel until the state is up. */</span>
<a name="l00524"></a><a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac13efb0951d66c6cee3936d4a48d2107">00524</a>    <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac13efb0951d66c6cee3936d4a48d2107">CONFFLAG_NO_AUDIO_UNTIL_UP</a> = (1 &lt;&lt; 31),
<a name="l00525"></a>00525 };
<a name="l00526"></a>00526 
<a name="l00527"></a>00527 <span class="keyword">enum</span> {
<a name="l00528"></a><a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9abfe6814e02021fa3fde4e9dd602d110b">00528</a>    <a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9abfe6814e02021fa3fde4e9dd602d110b">OPT_ARG_WAITMARKED</a> = 0,
<a name="l00529"></a><a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a95e81c82fdf625d648da836620d15dca">00529</a>    <a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a95e81c82fdf625d648da836620d15dca">OPT_ARG_EXITKEYS</a>   = 1,
<a name="l00530"></a><a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a22d5403ad37aee04f7beb26b97518b33">00530</a>    <a class="code" href="app__dial_8c.html#abed82baf7f470b522273a3e37c24c600a22d5403ad37aee04f7beb26b97518b33">OPT_ARG_DURATION_STOP</a> = 2,
<a name="l00531"></a><a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9ab92f4dda872862b445c7ee78b5eca872">00531</a>    <a class="code" href="app__dial_8c.html#abed82baf7f470b522273a3e37c24c600ab92f4dda872862b445c7ee78b5eca872">OPT_ARG_DURATION_LIMIT</a> = 3,
<a name="l00532"></a><a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">00532</a>    <a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">OPT_ARG_MOH_CLASS</a> = 4,
<a name="l00533"></a><a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9aec7326f60e7edad15d96ff935e5616d6">00533</a>    <a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a> = 5,
<a name="l00534"></a>00534 };
<a name="l00535"></a>00535 
<a name="l00536"></a>00536 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(meetme_opts, <a class="code" href="app_8h.html#ab451a4653176c211d131b899e1f91bde">BEGIN_OPTIONS</a>
<a name="l00537"></a>00537    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;A&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">CONFFLAG_MARKEDUSER</a> ),
<a name="l00538"></a>00538    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;a&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a> ),
<a name="l00539"></a>00539    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;b&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76bd08a36963707fcb29643b2d3bb49">CONFFLAG_AGI</a> ),
<a name="l00540"></a>00540    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;c&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a642977b3db866f6c6f87b1d5f7791d5b">CONFFLAG_ANNOUNCEUSERCOUNT</a> ),
<a name="l00541"></a>00541    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;C&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aba8445fa67502f63291f122cb214cb83">CONFFLAG_KICK_CONTINUE</a>),
<a name="l00542"></a>00542    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;D&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a85da35a1f1708d3792f40ddfdde12919">CONFFLAG_DYNAMICPIN</a> ),
<a name="l00543"></a>00543    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;d&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae83ea6d46f620c57461a6df40e7b321c">CONFFLAG_DYNAMIC</a> ),
<a name="l00544"></a>00544    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;E&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae572ce074f616f8c0d48ce7a7b4d7546">CONFFLAG_EMPTYNOPIN</a> ),
<a name="l00545"></a>00545    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;e&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a829c143c29ff7d7c84cf2a4b6a86cfe9">CONFFLAG_EMPTY</a> ),
<a name="l00546"></a>00546    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;F&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a> ),
<a name="l00547"></a>00547    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;i&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a> ),
<a name="l00548"></a>00548    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;I&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a> ),
<a name="l00549"></a>00549    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;M&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">CONFFLAG_MOH</a>, <a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">OPT_ARG_MOH_CLASS</a> ),
<a name="l00550"></a>00550    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;m&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ad7732ac9c48e20f3c0bb5948ff1e01cf">CONFFLAG_STARTMUTED</a> ),
<a name="l00551"></a>00551    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;o&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">CONFFLAG_OPTIMIZETALKER</a> ),
<a name="l00552"></a>00552    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;P&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a403c4698d20d41dffb30064fdd738c09">CONFFLAG_ALWAYSPROMPT</a> ),
<a name="l00553"></a>00553    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;p&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aeae3eb825018940e6703d8151f1f20d5">CONFFLAG_KEYEXIT</a>, <a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a95e81c82fdf625d648da836620d15dca">OPT_ARG_EXITKEYS</a> ),
<a name="l00554"></a>00554    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;q&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a> ),
<a name="l00555"></a>00555    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;r&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a> ),
<a name="l00556"></a>00556    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;s&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8c1f23aabf6a93f20eb6b11fe8e2b857">CONFFLAG_STARMENU</a> ),
<a name="l00557"></a>00557    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;T&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a> ),
<a name="l00558"></a>00558    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;l&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">CONFFLAG_MONITOR</a> ),
<a name="l00559"></a>00559    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;t&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a39a9c6b58c7b77ef675e56d00c89e0a8">CONFFLAG_TALKER</a> ),
<a name="l00560"></a>00560    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;w&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a6bc154143d10b63764f073b756dbdb4a">CONFFLAG_WAITMARKED</a>, <a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9abfe6814e02021fa3fde4e9dd602d110b">OPT_ARG_WAITMARKED</a> ),
<a name="l00561"></a>00561    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;X&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a61bdcc99c25b743f89316b3da3796cc1">CONFFLAG_EXIT_CONTEXT</a> ),
<a name="l00562"></a>00562    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;x&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a> ),
<a name="l00563"></a>00563    <a class="code" href="app_8h.html#aca036489931bf5571e2472331c8ac80b" title="Declares an application option that does not accept an argument.">AST_APP_OPTION</a>(<span class="charliteral">&apos;1&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acebf32e64aaad2bef9c62ae75ee816b7">CONFFLAG_NOONLYPERSON</a> ),
<a name="l00564"></a>00564    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;S&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8626cc2dc0a4e9e97be85ecd0ebaef15">CONFFLAG_DURATION_STOP</a>, <a class="code" href="app__dial_8c.html#abed82baf7f470b522273a3e37c24c600a22d5403ad37aee04f7beb26b97518b33">OPT_ARG_DURATION_STOP</a>),
<a name="l00565"></a>00565    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;L&apos;</span>, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a67bec58b805ac5d933829e8a28fa89e6">CONFFLAG_DURATION_LIMIT</a>, <a class="code" href="app__dial_8c.html#abed82baf7f470b522273a3e37c24c600ab92f4dda872862b445c7ee78b5eca872">OPT_ARG_DURATION_LIMIT</a>),
<a name="l00566"></a>00566 <a class="code" href="app_8h.html#a2a1890787b3e55318c417c0a3e1432c7">END_OPTIONS</a> );
<a name="l00567"></a>00567 
<a name="l00568"></a><a class="code" href="app__meetme_8c.html#a83a793edb3d6a3a15f2a7fc99ffe8c90">00568</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = <span class="stringliteral">&quot;MeetMe&quot;</span>;
<a name="l00569"></a><a class="code" href="app__meetme_8c.html#a226108d015a7b45044c5f4eb82ffaa1b">00569</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a226108d015a7b45044c5f4eb82ffaa1b">app2</a> = <span class="stringliteral">&quot;MeetMeCount&quot;</span>;
<a name="l00570"></a><a class="code" href="app__meetme_8c.html#a3044a87a73ac4a63321105ddc9a77692">00570</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a3044a87a73ac4a63321105ddc9a77692">app3</a> = <span class="stringliteral">&quot;MeetMeAdmin&quot;</span>;
<a name="l00571"></a><a class="code" href="app__meetme_8c.html#a2f57c1b7cebdefada90f4dac8fd00fa6">00571</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a2f57c1b7cebdefada90f4dac8fd00fa6">app4</a> = <span class="stringliteral">&quot;MeetMeChannelAdmin&quot;</span>;
<a name="l00572"></a><a class="code" href="app__meetme_8c.html#aa807a317bb5bcaf1cba5a5113a1c6a99">00572</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#aa807a317bb5bcaf1cba5a5113a1c6a99">slastation_app</a> = <span class="stringliteral">&quot;SLAStation&quot;</span>;
<a name="l00573"></a><a class="code" href="app__meetme_8c.html#a9de8f771d09109ea403508528918cf92">00573</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a9de8f771d09109ea403508528918cf92">slatrunk_app</a> = <span class="stringliteral">&quot;SLATrunk&quot;</span>;
<a name="l00574"></a>00574 
<a name="l00575"></a>00575 <span class="comment">/* Lookup RealTime conferences based on confno and current time */</span>
<a name="l00576"></a><a class="code" href="app__meetme_8c.html#ae30bfc0de78dd15d5e61f3359a795ebb">00576</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ae30bfc0de78dd15d5e61f3359a795ebb">rt_schedule</a>;
<a name="l00577"></a><a class="code" href="app__meetme_8c.html#aacbac1f0d72bfec51d91f4ace69cbbd4">00577</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#aacbac1f0d72bfec51d91f4ace69cbbd4">fuzzystart</a>;
<a name="l00578"></a><a class="code" href="app__meetme_8c.html#aaaea827a7f6f7ee74d3dda01ec71644e">00578</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#aaaea827a7f6f7ee74d3dda01ec71644e">earlyalert</a>;
<a name="l00579"></a><a class="code" href="app__meetme_8c.html#a35cc725664fd0b4f53fbbb7d0f15c038">00579</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a35cc725664fd0b4f53fbbb7d0f15c038">endalert</a>;
<a name="l00580"></a><a class="code" href="app__meetme_8c.html#ae0a2b76878a215d1ac6e738b85b4b9d8">00580</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ae0a2b76878a215d1ac6e738b85b4b9d8">extendby</a>;
<a name="l00581"></a>00581 
<a name="l00582"></a>00582 <span class="comment">/* Log participant count to the RealTime backend */</span>
<a name="l00583"></a><a class="code" href="app__meetme_8c.html#a1590866b16d9cf85be855116bec22712">00583</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a1590866b16d9cf85be855116bec22712">rt_log_members</a>;
<a name="l00584"></a>00584 
<a name="l00585"></a><a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">00585</a> <span class="preprocessor">#define MAX_CONFNUM 80</span>
<a name="l00586"></a><a class="code" href="app__meetme_8c.html#a636a212051cf4b5561e4c3ee652a58fe">00586</a> <span class="preprocessor"></span><span class="preprocessor">#define MAX_PIN     80</span>
<a name="l00587"></a><a class="code" href="app__meetme_8c.html#a83128aa5fb371ea385d8bc0f6186e20f">00587</a> <span class="preprocessor"></span><span class="preprocessor">#define OPTIONS_LEN 100</span>
<a name="l00588"></a>00588 <span class="preprocessor"></span>
<a name="l00589"></a>00589 <span class="comment">/* Enough space for &quot;&lt;conference #&gt;,&lt;pin&gt;,&lt;admin pin&gt;&quot; followed by a 0 byte. */</span>
<a name="l00590"></a><a class="code" href="app__meetme_8c.html#afad3aadf1645aabf53eea7d30a839411">00590</a> <span class="preprocessor">#define MAX_SETTINGS (MAX_CONFNUM + MAX_PIN + MAX_PIN + 3)</span>
<a name="l00591"></a>00591 <span class="preprocessor"></span>
<a name="l00592"></a><a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bf">00592</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bf">announcetypes</a> {
<a name="l00593"></a><a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfa7a2844a08140930251b7a890184cf1f1">00593</a>    <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfa7a2844a08140930251b7a890184cf1f1">CONF_HASJOIN</a>,
<a name="l00594"></a><a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfafe977bca19aa4a5f72ff226a312b74af">00594</a>    <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfafe977bca19aa4a5f72ff226a312b74af">CONF_HASLEFT</a>
<a name="l00595"></a>00595 };
<a name="l00596"></a>00596 
<a name="l00597"></a><a class="code" href="structannounce__listitem.html">00597</a> <span class="keyword">struct </span><a class="code" href="structannounce__listitem.html">announce_listitem</a> {
<a name="l00598"></a>00598    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structannounce__listitem.html">announce_listitem</a>) entry;
<a name="l00599"></a>00599    <span class="keywordtype">char</span> namerecloc[PATH_MAX];          <span class="comment">/*!&lt; Name Recorded file Location */</span>
<a name="l00600"></a>00600    <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>[<a class="code" href="channel_8h.html#a9238c3318ae8d3bea2cbbe1d1e459eb7">MAX_LANGUAGE</a>];
<a name="l00601"></a>00601    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *confchan;
<a name="l00602"></a>00602    <span class="keywordtype">int</span> confusers;
<a name="l00603"></a>00603    <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bf">announcetypes</a> announcetype;
<a name="l00604"></a>00604 };
<a name="l00605"></a>00605 <span class="comment"></span>
<a name="l00606"></a>00606 <span class="comment">/*! \brief The MeetMe Conference object */</span>
<a name="l00607"></a><a class="code" href="structast__conference.html">00607</a> <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> {
<a name="l00608"></a><a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">00608</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>;                   <span class="comment">/*!&lt; Conference specific lock (players) */</span>
<a name="l00609"></a><a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">00609</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>;                 <span class="comment">/*!&lt; Conference specific lock (listeners) */</span>
<a name="l00610"></a><a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">00610</a>    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>[<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>];               <span class="comment">/*!&lt; Conference */</span>
<a name="l00611"></a><a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">00611</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;               <span class="comment">/*!&lt; Announcements channel */</span>
<a name="l00612"></a><a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">00612</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>;              <span class="comment">/*!&lt; Listen/Record channel */</span>
<a name="l00613"></a><a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">00613</a>    <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;                                 <span class="comment">/*!&lt; Announcements fd */</span>
<a name="l00614"></a><a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">00614</a>    <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a>;                            <span class="comment">/*!&lt; DAHDI Conf # */</span>
<a name="l00615"></a><a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">00615</a>    <span class="keywordtype">int</span> <a class="code" href="structusers.html" title="list of users found in the config file">users</a>;                              <span class="comment">/*!&lt; Number of active users */</span>
<a name="l00616"></a><a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">00616</a>    <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>;                        <span class="comment">/*!&lt; Number of marked users */</span>
<a name="l00617"></a><a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">00617</a>    <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">maxusers</a>;                           <span class="comment">/*!&lt; Participant limit if scheduled */</span>
<a name="l00618"></a><a class="code" href="structast__conference.html#a35cc725664fd0b4f53fbbb7d0f15c038">00618</a>    <span class="keywordtype">int</span> endalert;                           <span class="comment">/*!&lt; When to play conf ending message */</span>
<a name="l00619"></a><a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">00619</a>    time_t <a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>;                           <span class="comment">/*!&lt; Start time (s) */</span>
<a name="l00620"></a><a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">00620</a>    <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>;                           <span class="comment">/*!&lt; reference count of usage */</span>
<a name="l00621"></a><a class="code" href="structast__conference.html#a0fcf3d8cb0b08a4d668fd87f01bd4192">00621</a>    <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298">recording_state</a> recording:2;       <span class="comment">/*!&lt; recording status */</span>
<a name="l00622"></a>00622    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a0fcf3d8cb0b08a4d668fd87f01bd4192">isdynamic</a>:1;               <span class="comment">/*!&lt; Created on the fly? */</span>
<a name="l00623"></a><a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">00623</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a>:1;                  <span class="comment">/*!&lt; Is the conference locked? */</span>
<a name="l00624"></a><a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">00624</a>    pthread_t <a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a>;                 <span class="comment">/*!&lt; thread for recording */</span>
<a name="l00625"></a><a class="code" href="structast__conference.html#a36b5e5ca449d5db4d505c5ceed207e3b">00625</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structast__conference.html#a36b5e5ca449d5db4d505c5ceed207e3b">recordthreadlock</a>;           <span class="comment">/*!&lt; control threads trying to start recordthread */</span>
<a name="l00626"></a><a class="code" href="structast__conference.html#a324189adc86f9f14b363b10e4f9241f3">00626</a>    pthread_attr_t <a class="code" href="structast__conference.html#a324189adc86f9f14b363b10e4f9241f3">attr</a>;                    <span class="comment">/*!&lt; thread attribute */</span>
<a name="l00627"></a><a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">00627</a>    <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>;                <span class="comment">/*!&lt; Filename to record the Conference into */</span>
<a name="l00628"></a><a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">00628</a>    <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>;                  <span class="comment">/*!&lt; Format to record the Conference in */</span>
<a name="l00629"></a><a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">00629</a>    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>[<a class="code" href="app__meetme_8c.html#a636a212051cf4b5561e4c3ee652a58fe">MAX_PIN</a>];                      <span class="comment">/*!&lt; If protected by a PIN */</span>
<a name="l00630"></a><a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">00630</a>    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>[<a class="code" href="app__meetme_8c.html#a636a212051cf4b5561e4c3ee652a58fe">MAX_PIN</a>];                 <span class="comment">/*!&lt; If protected by a admin PIN */</span>
<a name="l00631"></a><a class="code" href="structast__conference.html#ae42dbdf188676f5840d98c4427e75a4f">00631</a>    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#ae42dbdf188676f5840d98c4427e75a4f">uniqueid</a>[32];
<a name="l00632"></a><a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">00632</a>    <span class="keywordtype">long</span> <a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a>;                           <span class="comment">/*!&lt; When to end the conf if scheduled */</span>
<a name="l00633"></a><a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">00633</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">useropts</a>;                   <span class="comment">/*!&lt; RealTime user flags */</span>
<a name="l00634"></a><a class="code" href="structast__conference.html#afa3f2aa238dd1090b0ab5e87b9188f2a">00634</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#afa3f2aa238dd1090b0ab5e87b9188f2a">adminopts</a>;                  <span class="comment">/*!&lt; RealTime moderator flags */</span>
<a name="l00635"></a><a class="code" href="structast__conference.html#a9c9fece27d0906bb0c5e522e26c92d7f">00635</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9c9fece27d0906bb0c5e522e26c92d7f">bookid</a>;                     <span class="comment">/*!&lt; RealTime conference id */</span>
<a name="l00636"></a><a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">00636</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[32];
<a name="l00637"></a><a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">00637</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>;
<a name="l00638"></a><a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">00638</a>    <span class="keyword">struct </span><a class="code" href="structast__trans__pvt.html" title="Default structure for translators, with the basic fields and buffers, all allocated...">ast_trans_pvt</a> *<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[32];
<a name="l00639"></a>00639    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a>) userlist;
<a name="l00640"></a>00640    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a>) list;
<a name="l00641"></a>00641    <span class="comment">/* announce_thread related data */</span>
<a name="l00642"></a>00642    pthread_t announcethread;
<a name="l00643"></a>00643    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> announcethreadlock;
<a name="l00644"></a>00644    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> announcethread_stop:1;
<a name="l00645"></a>00645    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> announcelist_addition;
<a name="l00646"></a>00646    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structannounce__listitem.html">announce_listitem</a>) announcelist;
<a name="l00647"></a>00647    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> announcelistlock;
<a name="l00648"></a>00648 };
<a name="l00649"></a>00649 
<a name="l00650"></a>00650 static <a class="code" href="linkedlists_8h.html#a10f9ed9242a397abf76de1ed1fa33c3b" title="Defines a structure to be used to hold a list of specified type, statically initialized...">AST_LIST_HEAD_STATIC</a>(confs, <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a>);
<a name="l00651"></a>00651 
<a name="l00652"></a><a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">00652</a> static <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">conf_map</a>[1024] = {0, };
<a name="l00653"></a>00653 
<a name="l00654"></a><a class="code" href="structvolume.html">00654</a> <span class="keyword">struct </span><a class="code" href="structvolume.html">volume</a> {
<a name="l00655"></a><a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">00655</a>    <span class="keywordtype">int</span> desired;                            <span class="comment">/*!&lt; Desired volume adjustment */</span>
<a name="l00656"></a><a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">00656</a>    <span class="keywordtype">int</span> actual;                             <span class="comment">/*!&lt; Actual volume adjustment (for channels that can&apos;t adjust) */</span>
<a name="l00657"></a>00657 };
<a name="l00658"></a>00658 <span class="comment"></span>
<a name="l00659"></a>00659 <span class="comment">/*! \brief The MeetMe User object */</span>
<a name="l00660"></a><a class="code" href="structast__conf__user.html">00660</a> <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> {
<a name="l00661"></a><a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">00661</a>    <span class="keywordtype">int</span> user_no;                            <span class="comment">/*!&lt; User Number */</span>
<a name="l00662"></a><a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">00662</a>    <span class="keywordtype">int</span> userflags;                          <span class="comment">/*!&lt; Flags as set in the conference */</span>
<a name="l00663"></a><a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">00663</a>    <span class="keywordtype">int</span> adminflags;                         <span class="comment">/*!&lt; Flags set by the Admin */</span>
<a name="l00664"></a><a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">00664</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;               <span class="comment">/*!&lt; Connected channel */</span>
<a name="l00665"></a><a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">00665</a>    <span class="keywordtype">int</span> talking;                            <span class="comment">/*!&lt; Is user talking */</span>
<a name="l00666"></a><a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">00666</a>    <span class="keywordtype">int</span> dahdichannel;                         <span class="comment">/*!&lt; Is a DAHDI channel */</span>
<a name="l00667"></a><a class="code" href="structast__conf__user.html#afb4343dd2ff2928ecf7017fdd8a013bb">00667</a>    <span class="keywordtype">char</span> usrvalue[50];                      <span class="comment">/*!&lt; Custom User Value */</span>
<a name="l00668"></a><a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">00668</a>    <span class="keywordtype">char</span> namerecloc[PATH_MAX];          <span class="comment">/*!&lt; Name Recorded file Location */</span>
<a name="l00669"></a><a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">00669</a>    time_t jointime;                        <span class="comment">/*!&lt; Time the user joined the conference */</span>
<a name="l00670"></a><a class="code" href="structast__conf__user.html#ae5ad22d81786b1fc2a541ad84f1cd860">00670</a>    time_t kicktime;                        <span class="comment">/*!&lt; Time the user will be kicked from the conference */</span>
<a name="l00671"></a><a class="code" href="structast__conf__user.html#ab83335d6897e2ea22f24b1b8afd95b0f">00671</a>    <span class="keyword">struct </span>timeval start_time;              <span class="comment">/*!&lt; Time the user entered into the conference */</span>
<a name="l00672"></a><a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">00672</a>    <span class="keywordtype">long</span> timelimit;                         <span class="comment">/*!&lt; Time limit for the user to be in the conference L(x:y:z) */</span>
<a name="l00673"></a><a class="code" href="structast__conf__user.html#af3d16394c849390df1c8f72569faeb37">00673</a>    <span class="keywordtype">long</span> play_warning;                      <span class="comment">/*!&lt; Play a warning when &apos;y&apos; ms are left */</span>
<a name="l00674"></a><a class="code" href="structast__conf__user.html#abc09654c9b36de6b0bd0bfd92d31c0c0">00674</a>    <span class="keywordtype">long</span> warning_freq;                      <span class="comment">/*!&lt; Repeat the warning every &apos;z&apos; ms */</span>
<a name="l00675"></a><a class="code" href="structast__conf__user.html#a1fa6cb6235cf4abe198a8561e3c18bae">00675</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *warning_sound;              <span class="comment">/*!&lt; File to play as warning if &apos;y&apos; is defined */</span>
<a name="l00676"></a><a class="code" href="structast__conf__user.html#a0b23b4ebfc857809d07d1ced94c9a6eb">00676</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *end_sound;                  <span class="comment">/*!&lt; File to play when time is up. */</span>
<a name="l00677"></a><a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">00677</a>    <span class="keyword">struct </span><a class="code" href="structvolume.html">volume</a> talk;
<a name="l00678"></a><a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">00678</a>    <span class="keyword">struct </span><a class="code" href="structvolume.html">volume</a> listen;
<a name="l00679"></a>00679    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a>) list;
<a name="l00680"></a>00680 };
<a name="l00681"></a>00681 
<a name="l00682"></a><a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215">00682</a> enum <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215">sla_which_trunk_refs</a> {
<a name="l00683"></a><a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">00683</a>    <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>,
<a name="l00684"></a><a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215a5b13df634bb3782cb4a25c0fe0712515">00684</a>    <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215a5b13df634bb3782cb4a25c0fe0712515">INACTIVE_TRUNK_REFS</a>,
<a name="l00685"></a>00685 };
<a name="l00686"></a>00686 
<a name="l00687"></a><a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75">00687</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75">sla_trunk_state</a> {
<a name="l00688"></a><a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">00688</a>    <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>,
<a name="l00689"></a><a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a4822569aa984228bec67e07f5b9862a5">00689</a>    <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a4822569aa984228bec67e07f5b9862a5">SLA_TRUNK_STATE_RINGING</a>,
<a name="l00690"></a><a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">00690</a>    <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>,
<a name="l00691"></a><a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a17322fe34775141bef95a88fd00ed59d">00691</a>    <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a17322fe34775141bef95a88fd00ed59d">SLA_TRUNK_STATE_ONHOLD</a>,
<a name="l00692"></a><a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">00692</a>    <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>,
<a name="l00693"></a>00693 };
<a name="l00694"></a>00694 
<a name="l00695"></a><a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685c">00695</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685c">sla_hold_access</a> {<span class="comment"></span>
<a name="l00696"></a>00696 <span class="comment">   /*! This means that any station can put it on hold, and any station</span>
<a name="l00697"></a>00697 <span class="comment">    * can retrieve the call from hold. */</span>
<a name="l00698"></a><a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685ca1e46cd00f27d565cf02c15ec55c8be06">00698</a>    <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685ca1e46cd00f27d565cf02c15ec55c8be06">SLA_HOLD_OPEN</a>,<span class="comment"></span>
<a name="l00699"></a>00699 <span class="comment">   /*! This means that only the station that put the call on hold may</span>
<a name="l00700"></a>00700 <span class="comment">    * retrieve it from hold. */</span>
<a name="l00701"></a><a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">00701</a>    <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">SLA_HOLD_PRIVATE</a>,
<a name="l00702"></a>00702 };
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a>;
<a name="l00705"></a>00705 
<a name="l00706"></a><a class="code" href="structsla__station.html">00706</a> <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> {
<a name="l00707"></a>00707    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structsla__station.html">sla_station</a>) entry;
<a name="l00708"></a>00708    <a class="code" href="stringfields_8h.html#a061580e89c55282a7140fa3fdfd52b6d" title="Declare the fields needed in a structure.">AST_DECLARE_STRING_FIELDS</a>(
<a name="l00709"></a>00709       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>); 
<a name="l00710"></a>00710       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(device);  
<a name="l00711"></a>00711       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(autocontext);   
<a name="l00712"></a>00712    );
<a name="l00713"></a>00713    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a>) trunks;
<a name="l00714"></a>00714    <span class="keyword">struct </span><a class="code" href="structast__dial.html" title="Main dialing structure. Contains global options, channels being dialed, and more!...">ast_dial</a> *dial;<span class="comment"></span>
<a name="l00715"></a>00715 <span class="comment">   /*! Ring timeout for this station, for any trunk.  If a ring timeout</span>
<a name="l00716"></a>00716 <span class="comment">    *  is set for a specific trunk on this station, that will take</span>
<a name="l00717"></a>00717 <span class="comment">    *  priority over this value. */</span>
<a name="l00718"></a>00718    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ring_timeout;<span class="comment"></span>
<a name="l00719"></a>00719 <span class="comment">   /*! Ring delay for this station, for any trunk.  If a ring delay</span>
<a name="l00720"></a>00720 <span class="comment">    *  is set for a specific trunk on this station, that will take</span>
<a name="l00721"></a>00721 <span class="comment">    *  priority over this value. */</span>
<a name="l00722"></a>00722    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ring_delay;<span class="comment"></span>
<a name="l00723"></a>00723 <span class="comment">   /*! This option uses the values in the sla_hold_access enum and sets the</span>
<a name="l00724"></a>00724 <span class="comment">    * access control type for hold on this station. */</span>
<a name="l00725"></a>00725    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hold_access:1;<span class="comment"></span>
<a name="l00726"></a>00726 <span class="comment">   /*! Use count for inside sla_station_exec */</span>
<a name="l00727"></a>00727    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ref_count;
<a name="l00728"></a>00728 };
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="structsla__station__ref.html">00730</a> <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> {
<a name="l00731"></a>00731    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structsla__station__ref.html">sla_station_ref</a>) entry;
<a name="l00732"></a>00732    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l00733"></a>00733 };
<a name="l00734"></a>00734 
<a name="l00735"></a><a class="code" href="structsla__trunk.html">00735</a> <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> {
<a name="l00736"></a>00736    <a class="code" href="linkedlists_8h.html#ac63e9e237da22b6faf3be4edfc4f5a11">AST_RWLIST_ENTRY</a>(<a class="code" href="structsla__trunk.html">sla_trunk</a>) entry;
<a name="l00737"></a>00737    <a class="code" href="stringfields_8h.html#a061580e89c55282a7140fa3fdfd52b6d" title="Declare the fields needed in a structure.">AST_DECLARE_STRING_FIELDS</a>(
<a name="l00738"></a>00738       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00739"></a>00739       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(device);
<a name="l00740"></a>00740       <a class="code" href="stringfields_8h.html#a51b5729220efb7cda4393ed35ecdfea2" title="Declare a string field.">AST_STRING_FIELD</a>(autocontext);   
<a name="l00741"></a>00741    );
<a name="l00742"></a>00742    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structsla__station__ref.html">sla_station_ref</a>) stations;<span class="comment"></span>
<a name="l00743"></a>00743 <span class="comment">   /*! Number of stations that use this trunk */</span>
<a name="l00744"></a>00744    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> num_stations;<span class="comment"></span>
<a name="l00745"></a>00745 <span class="comment">   /*! Number of stations currently on a call with this trunk */</span>
<a name="l00746"></a>00746    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> active_stations;<span class="comment"></span>
<a name="l00747"></a>00747 <span class="comment">   /*! Number of stations that have this trunk on hold. */</span>
<a name="l00748"></a>00748    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hold_stations;
<a name="l00749"></a>00749    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l00750"></a>00750    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ring_timeout;<span class="comment"></span>
<a name="l00751"></a>00751 <span class="comment">   /*! If set to 1, no station will be able to join an active call with</span>
<a name="l00752"></a>00752 <span class="comment">    *  this trunk. */</span>
<a name="l00753"></a>00753    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> barge_disabled:1;<span class="comment"></span>
<a name="l00754"></a>00754 <span class="comment">   /*! This option uses the values in the sla_hold_access enum and sets the</span>
<a name="l00755"></a>00755 <span class="comment">    * access control type for hold on this trunk. */</span>
<a name="l00756"></a>00756    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hold_access:1;<span class="comment"></span>
<a name="l00757"></a>00757 <span class="comment">   /*! Whether this trunk is currently on hold, meaning that once a station</span>
<a name="l00758"></a>00758 <span class="comment">    *  connects to it, the trunk channel needs to have UNHOLD indicated to it. */</span>
<a name="l00759"></a>00759    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="chan__h323_8c.html#a26e11e1159e5e1fae04d3a082b404840">on_hold</a>:1;<span class="comment"></span>
<a name="l00760"></a>00760 <span class="comment">   /*! Use count for inside sla_trunk_exec */</span>
<a name="l00761"></a>00761    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ref_count;
<a name="l00762"></a>00762 };
<a name="l00763"></a>00763 
<a name="l00764"></a><a class="code" href="structsla__trunk__ref.html">00764</a> <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> {
<a name="l00765"></a>00765    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a>) entry;
<a name="l00766"></a>00766    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l00767"></a>00767    <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75">sla_trunk_state</a> <a class="code" href="structstate.html">state</a>;
<a name="l00768"></a>00768    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;<span class="comment"></span>
<a name="l00769"></a>00769 <span class="comment">   /*! Ring timeout to use when this trunk is ringing on this specific</span>
<a name="l00770"></a>00770 <span class="comment">    *  station.  This takes higher priority than a ring timeout set at</span>
<a name="l00771"></a>00771 <span class="comment">    *  the station level. */</span>
<a name="l00772"></a>00772    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ring_timeout;<span class="comment"></span>
<a name="l00773"></a>00773 <span class="comment">   /*! Ring delay to use when this trunk is ringing on this specific</span>
<a name="l00774"></a>00774 <span class="comment">    *  station.  This takes higher priority than a ring delay set at</span>
<a name="l00775"></a>00775 <span class="comment">    *  the station level. */</span>
<a name="l00776"></a>00776    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ring_delay;
<a name="l00777"></a>00777 };
<a name="l00778"></a>00778 
<a name="l00779"></a>00779 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(sla_stations, <a class="code" href="structsla__station.html">sla_station</a>);
<a name="l00780"></a>00780 <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(sla_trunks, <a class="code" href="structsla__trunk.html">sla_trunk</a>);
<a name="l00781"></a>00781 
<a name="l00782"></a><a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">00782</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>[] = <span class="stringliteral">&quot;SLA&quot;</span>;
<a name="l00783"></a>00783 <span class="comment"></span>
<a name="l00784"></a>00784 <span class="comment">/*! \brief Event types that can be queued up for the SLA thread */</span>
<a name="l00785"></a><a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a">00785</a> <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a" title="Event types that can be queued up for the SLA thread.">sla_event_type</a> {<span class="comment"></span>
<a name="l00786"></a>00786 <span class="comment">   /*! A station has put the call on hold */</span>
<a name="l00787"></a><a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa23fb375274d3c96370d1a64e418f6a40">00787</a>    <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa23fb375274d3c96370d1a64e418f6a40">SLA_EVENT_HOLD</a>,<span class="comment"></span>
<a name="l00788"></a>00788 <span class="comment">   /*! The state of a dial has changed */</span>
<a name="l00789"></a><a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aacd2fcc269af2c1a25641c5afa9109ea3">00789</a>    <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aacd2fcc269af2c1a25641c5afa9109ea3">SLA_EVENT_DIAL_STATE</a>,<span class="comment"></span>
<a name="l00790"></a>00790 <span class="comment">   /*! The state of a ringing trunk has changed */</span>
<a name="l00791"></a><a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">00791</a>    <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>,<span class="comment"></span>
<a name="l00792"></a>00792 <span class="comment">   /*! A reload of configuration has been requested */</span>
<a name="l00793"></a><a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aabbba56c7b66dbbdd30b170de8ad228ce">00793</a>    <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aabbba56c7b66dbbdd30b170de8ad228ce">SLA_EVENT_RELOAD</a>,<span class="comment"></span>
<a name="l00794"></a>00794 <span class="comment">   /*! Poke the SLA thread so it can check if it can perform a reload */</span>
<a name="l00795"></a><a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">00795</a>    <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>,
<a name="l00796"></a>00796 };
<a name="l00797"></a>00797 
<a name="l00798"></a><a class="code" href="structsla__event.html">00798</a> <span class="keyword">struct </span><a class="code" href="structsla__event.html">sla_event</a> {
<a name="l00799"></a><a class="code" href="structsla__event.html#a0c10632f8ed1ab1d182c2d1f9ae163fc">00799</a>    <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a" title="Event types that can be queued up for the SLA thread.">sla_event_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>;
<a name="l00800"></a><a class="code" href="structsla__event.html#a0569f66b3f952276c1a8ec5f2ffd5466">00800</a>    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l00801"></a><a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">00801</a>    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l00802"></a>00802    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structsla__event.html">sla_event</a>) entry;
<a name="l00803"></a>00803 };
<a name="l00804"></a>00804 <span class="comment"></span>
<a name="l00805"></a>00805 <span class="comment">/*! \brief A station that failed to be dialed </span>
<a name="l00806"></a>00806 <span class="comment"> * \note Only used by the SLA thread. */</span>
<a name="l00807"></a><a class="code" href="structsla__failed__station.html">00807</a> struct <a class="code" href="structsla__failed__station.html" title="A station that failed to be dialed.">sla_failed_station</a> {
<a name="l00808"></a><a class="code" href="structsla__failed__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">00808</a>    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l00809"></a><a class="code" href="structsla__failed__station.html#ad0eecb6223757f0f347c81c1e2c14eb6">00809</a>    <span class="keyword">struct </span>timeval last_try;
<a name="l00810"></a>00810    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(sla_failed_station) entry;
<a name="l00811"></a>00811 };
<a name="l00812"></a>00812 <span class="comment"></span>
<a name="l00813"></a>00813 <span class="comment">/*! \brief A trunk that is ringing */</span>
<a name="l00814"></a><a class="code" href="structsla__ringing__trunk.html">00814</a> struct <a class="code" href="structsla__ringing__trunk.html" title="A trunk that is ringing.">sla_ringing_trunk</a> {
<a name="l00815"></a><a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">00815</a>    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;<span class="comment"></span>
<a name="l00816"></a>00816 <span class="comment">   /*! The time that this trunk started ringing */</span>
<a name="l00817"></a><a class="code" href="structsla__ringing__trunk.html#a5fad56bdd993af8ceb77ab8a83134f0f">00817</a>    <span class="keyword">struct </span>timeval ring_begin;
<a name="l00818"></a>00818    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structsla__station__ref.html">sla_station_ref</a>) timed_out_stations;
<a name="l00819"></a>00819    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(sla_ringing_trunk) entry;
<a name="l00820"></a>00820 };
<a name="l00821"></a>00821 
<a name="l00822"></a><a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0">00822</a> enum <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0">sla_station_hangup</a> {
<a name="l00823"></a><a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0a0d3359532f25486a8dd30e3ef7c90511">00823</a>    <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0a0d3359532f25486a8dd30e3ef7c90511">SLA_STATION_HANGUP_NORMAL</a>,
<a name="l00824"></a><a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0aac519ad8347eceb83b914cae3bdc8018">00824</a>    <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0aac519ad8347eceb83b914cae3bdc8018">SLA_STATION_HANGUP_TIMEOUT</a>,
<a name="l00825"></a>00825 };
<a name="l00826"></a>00826 <span class="comment"></span>
<a name="l00827"></a>00827 <span class="comment">/*! \brief A station that is ringing */</span>
<a name="l00828"></a><a class="code" href="structsla__ringing__station.html">00828</a> <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> {
<a name="l00829"></a><a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">00829</a>    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;<span class="comment"></span>
<a name="l00830"></a>00830 <span class="comment">   /*! The time that this station started ringing */</span>
<a name="l00831"></a><a class="code" href="structsla__ringing__station.html#a5fad56bdd993af8ceb77ab8a83134f0f">00831</a>    <span class="keyword">struct </span>timeval ring_begin;
<a name="l00832"></a>00832    <a class="code" href="linkedlists_8h.html#a67508a613c8f337732e35d9367b43ae7" title="Declare a forward link structure inside a list entry.">AST_LIST_ENTRY</a>(<a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a>) entry;
<a name="l00833"></a>00833 };
<a name="l00834"></a>00834 <span class="comment"></span>
<a name="l00835"></a>00835 <span class="comment">/*!</span>
<a name="l00836"></a>00836 <span class="comment"> * \brief A structure for data used by the sla thread</span>
<a name="l00837"></a>00837 <span class="comment"> */</span>
<a name="l00838"></a>00838 static struct {<span class="comment"></span>
<a name="l00839"></a>00839 <span class="comment">   /*! The SLA thread ID */</span>
<a name="l00840"></a><a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">00840</a>    pthread_t <a class="code" href="app__meetme_8c.html#a01f75a9ad916f63a94e06a27635ba278">thread</a>;
<a name="l00841"></a><a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">00841</a>    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> <a class="code" href="app__meetme_8c.html#a1c7181c39f99ee801943a0d0aa9872b9">cond</a>;
<a name="l00842"></a><a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">00842</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="app__meetme_8c.html#adf04f66344e3fb0a6f6a69bf39d19902">lock</a>;
<a name="l00843"></a>00843    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, sla_ringing_trunk) ringing_trunks;
<a name="l00844"></a>00844    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a>) ringing_stations;
<a name="l00845"></a>00845    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, sla_failed_station) failed_stations;
<a name="l00846"></a>00846    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structsla__event.html">sla_event</a>) event_q;
<a name="l00847"></a>00847    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="res__ais_8c.html#a111277a0849f92b793ed6aa1efe54462">stop</a>:1;<span class="comment"></span>
<a name="l00848"></a>00848 <span class="comment">   /*! Attempt to handle CallerID, even though it is known not to work</span>
<a name="l00849"></a>00849 <span class="comment">    *  properly in some situations. */</span>
<a name="l00850"></a>00850    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> attempt_callerid:1;<span class="comment"></span>
<a name="l00851"></a>00851 <span class="comment">   /*! A reload has been requested */</span>
<a name="l00852"></a>00852    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>:1;
<a name="l00853"></a>00853 } <a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a> = {
<a name="l00854"></a>00854    .thread = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>,
<a name="l00855"></a>00855 };
<a name="l00856"></a>00856 <span class="comment"></span>
<a name="l00857"></a>00857 <span class="comment">/*! The number of audio buffers to be allocated on pseudo channels</span>
<a name="l00858"></a>00858 <span class="comment"> *  when in a conference */</span>
<a name="l00859"></a><a class="code" href="app__meetme_8c.html#acf8ac9f199da16a627957d5e9e370c2f">00859</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#acf8ac9f199da16a627957d5e9e370c2f">audio_buffers</a>;
<a name="l00860"></a>00860 <span class="comment"></span>
<a name="l00861"></a>00861 <span class="comment">/*! Map &apos;volume&apos; levels from -5 through +5 into</span>
<a name="l00862"></a>00862 <span class="comment"> *  decibel (dB) settings for channel drivers</span>
<a name="l00863"></a>00863 <span class="comment"> *  Note: these are not a straight linear-to-dB</span>
<a name="l00864"></a>00864 <span class="comment"> *  conversion... the numbers have been modified</span>
<a name="l00865"></a>00865 <span class="comment"> *  to give the user a better level of adjustability</span>
<a name="l00866"></a>00866 <span class="comment"> */</span>
<a name="l00867"></a><a class="code" href="app__meetme_8c.html#ae74e5f1c3c2e1c50afefef4f9d9628a0">00867</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <span class="keyword">const</span> <a class="code" href="app__meetme_8c.html#ae74e5f1c3c2e1c50afefef4f9d9628a0">gain_map</a>[] = {
<a name="l00868"></a>00868    -15,
<a name="l00869"></a>00869    -13,
<a name="l00870"></a>00870    -10,
<a name="l00871"></a>00871    -6,
<a name="l00872"></a>00872    0,
<a name="l00873"></a>00873    0,
<a name="l00874"></a>00874    0,
<a name="l00875"></a>00875    6,
<a name="l00876"></a>00876    10,
<a name="l00877"></a>00877    13,
<a name="l00878"></a>00878    15,
<a name="l00879"></a>00879 };
<a name="l00880"></a>00880 
<a name="l00881"></a>00881 
<a name="l00882"></a>00882 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data);
<a name="l00883"></a>00883 <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a>(<span class="keywordtype">void</span> *args);
<a name="l00884"></a>00884 
<a name="l00885"></a><a class="code" href="app__meetme_8c.html#a42dfb845a7846bd1bc1612beecc492b7">00885</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a42dfb845a7846bd1bc1612beecc492b7">istalking</a>(<span class="keywordtype">int</span> x)
<a name="l00886"></a>00886 {
<a name="l00887"></a>00887    <span class="keywordflow">if</span> (x &gt; 0)
<a name="l00888"></a>00888       <span class="keywordflow">return</span> <span class="stringliteral">&quot;(talking)&quot;</span>;
<a name="l00889"></a>00889    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (x &lt; 0)
<a name="l00890"></a>00890       <span class="keywordflow">return</span> <span class="stringliteral">&quot;(unmonitored)&quot;</span>;
<a name="l00891"></a>00891    <span class="keywordflow">else</span> 
<a name="l00892"></a>00892       <span class="keywordflow">return</span> <span class="stringliteral">&quot;(not talking)&quot;</span>;
<a name="l00893"></a>00893 }
<a name="l00894"></a>00894 
<a name="l00895"></a><a class="code" href="app__meetme_8c.html#a274bd5a5386b1ea0514ec87feb3d8d85">00895</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a274bd5a5386b1ea0514ec87feb3d8d85">careful_write</a>(<span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> block)
<a name="l00896"></a>00896 {
<a name="l00897"></a>00897    <span class="keywordtype">int</span> res;
<a name="l00898"></a>00898    <span class="keywordtype">int</span> x;
<a name="l00899"></a>00899 
<a name="l00900"></a>00900    <span class="keywordflow">while</span> (len) {
<a name="l00901"></a>00901       <span class="keywordflow">if</span> (block) {
<a name="l00902"></a>00902          x = DAHDI_IOMUX_WRITE | DAHDI_IOMUX_SIGEVENT;
<a name="l00903"></a>00903          res = ioctl(fd, DAHDI_IOMUX, &amp;x);
<a name="l00904"></a>00904       } <span class="keywordflow">else</span>
<a name="l00905"></a>00905          res = 0;
<a name="l00906"></a>00906       <span class="keywordflow">if</span> (res &gt;= 0)
<a name="l00907"></a>00907          res = write(fd, data, len);
<a name="l00908"></a>00908       <span class="keywordflow">if</span> (res &lt; 1) {
<a name="l00909"></a>00909          <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EAGAIN) {
<a name="l00910"></a>00910             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to write audio data to conference: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l00911"></a>00911             <span class="keywordflow">return</span> -1;
<a name="l00912"></a>00912          } <span class="keywordflow">else</span>
<a name="l00913"></a>00913             <span class="keywordflow">return</span> 0;
<a name="l00914"></a>00914       }
<a name="l00915"></a>00915       len -= res;
<a name="l00916"></a>00916       data += res;
<a name="l00917"></a>00917    }
<a name="l00918"></a>00918 
<a name="l00919"></a>00919    <span class="keywordflow">return</span> 0;
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00922"></a><a class="code" href="app__meetme_8c.html#a4a7eef0979d0a4b9267d5bc5d98fde30">00922</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a4a7eef0979d0a4b9267d5bc5d98fde30">set_talk_volume</a>(<span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">int</span> <a class="code" href="structvolume.html">volume</a>)
<a name="l00923"></a>00923 {
<a name="l00924"></a>00924    <span class="keywordtype">char</span> gain_adjust;
<a name="l00925"></a>00925 
<a name="l00926"></a>00926    <span class="comment">/* attempt to make the adjustment in the channel driver;</span>
<a name="l00927"></a>00927 <span class="comment">      if successful, don&apos;t adjust in the frame reading routine</span>
<a name="l00928"></a>00928 <span class="comment">   */</span>
<a name="l00929"></a>00929    gain_adjust = gain_map[volume + 5];
<a name="l00930"></a>00930 
<a name="l00931"></a>00931    <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;gain_adjust, <span class="keyword">sizeof</span>(gain_adjust), 0);
<a name="l00932"></a>00932 }
<a name="l00933"></a>00933 
<a name="l00934"></a><a class="code" href="app__meetme_8c.html#a8187d6c217b26da3f3dccc3ce846325f">00934</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a8187d6c217b26da3f3dccc3ce846325f">set_listen_volume</a>(<span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">int</span> <a class="code" href="structvolume.html">volume</a>)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936    <span class="keywordtype">char</span> gain_adjust;
<a name="l00937"></a>00937 
<a name="l00938"></a>00938    <span class="comment">/* attempt to make the adjustment in the channel driver;</span>
<a name="l00939"></a>00939 <span class="comment">      if successful, don&apos;t adjust in the frame reading routine</span>
<a name="l00940"></a>00940 <span class="comment">   */</span>
<a name="l00941"></a>00941    gain_adjust = gain_map[volume + 5];
<a name="l00942"></a>00942 
<a name="l00943"></a>00943    <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#abcf55626860f173284cafa474946d9b2">AST_OPTION_TXGAIN</a>, &amp;gain_adjust, <span class="keyword">sizeof</span>(gain_adjust), 0);
<a name="l00944"></a>00944 }
<a name="l00945"></a>00945 
<a name="l00946"></a><a class="code" href="app__meetme_8c.html#a4780ccb62eb3184ace7cfae1af267115">00946</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a4780ccb62eb3184ace7cfae1af267115">tweak_volume</a>(<span class="keyword">struct</span> <a class="code" href="structvolume.html">volume</a> *vol, <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780b">volume_action</a> action)
<a name="l00947"></a>00947 {
<a name="l00948"></a>00948    <span class="keywordflow">switch</span> (action) {
<a name="l00949"></a>00949    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>:
<a name="l00950"></a>00950       <span class="keywordflow">switch</span> (vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>) { 
<a name="l00951"></a>00951       <span class="keywordflow">case</span> 5:
<a name="l00952"></a>00952          <span class="keywordflow">break</span>;
<a name="l00953"></a>00953       <span class="keywordflow">case</span> 0:
<a name="l00954"></a>00954          vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a> = 2;
<a name="l00955"></a>00955          <span class="keywordflow">break</span>;
<a name="l00956"></a>00956       <span class="keywordflow">case</span> -2:
<a name="l00957"></a>00957          vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a> = 0;
<a name="l00958"></a>00958          <span class="keywordflow">break</span>;
<a name="l00959"></a>00959       <span class="keywordflow">default</span>:
<a name="l00960"></a>00960          vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>++;
<a name="l00961"></a>00961          <span class="keywordflow">break</span>;
<a name="l00962"></a>00962       }
<a name="l00963"></a>00963       <span class="keywordflow">break</span>;
<a name="l00964"></a>00964    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>:
<a name="l00965"></a>00965       <span class="keywordflow">switch</span> (vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>) {
<a name="l00966"></a>00966       <span class="keywordflow">case</span> -5:
<a name="l00967"></a>00967          <span class="keywordflow">break</span>;
<a name="l00968"></a>00968       <span class="keywordflow">case</span> 2:
<a name="l00969"></a>00969          vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a> = 0;
<a name="l00970"></a>00970          <span class="keywordflow">break</span>;
<a name="l00971"></a>00971       <span class="keywordflow">case</span> 0:
<a name="l00972"></a>00972          vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a> = -2;
<a name="l00973"></a>00973          <span class="keywordflow">break</span>;
<a name="l00974"></a>00974       <span class="keywordflow">default</span>:
<a name="l00975"></a>00975          vol-&gt;<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>--;
<a name="l00976"></a>00976          <span class="keywordflow">break</span>;
<a name="l00977"></a>00977       }
<a name="l00978"></a>00978    }
<a name="l00979"></a>00979 }
<a name="l00980"></a>00980 
<a name="l00981"></a><a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">00981</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(<span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780b">volume_action</a> action)
<a name="l00982"></a>00982 {
<a name="l00983"></a>00983    <a class="code" href="app__meetme_8c.html#a4780ccb62eb3184ace7cfae1af267115">tweak_volume</a>(&amp;user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>, action);
<a name="l00984"></a>00984    <span class="comment">/* attempt to make the adjustment in the channel driver;</span>
<a name="l00985"></a>00985 <span class="comment">      if successful, don&apos;t adjust in the frame reading routine</span>
<a name="l00986"></a>00986 <span class="comment">   */</span>
<a name="l00987"></a>00987    <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a4a7eef0979d0a4b9267d5bc5d98fde30">set_talk_volume</a>(user, user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>))
<a name="l00988"></a>00988       user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a> = 0;
<a name="l00989"></a>00989    <span class="keywordflow">else</span>
<a name="l00990"></a>00990       user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a> = user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>;
<a name="l00991"></a>00991 }
<a name="l00992"></a>00992 
<a name="l00993"></a><a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">00993</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(<span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780b">volume_action</a> action)
<a name="l00994"></a>00994 {
<a name="l00995"></a>00995    <a class="code" href="app__meetme_8c.html#a4780ccb62eb3184ace7cfae1af267115">tweak_volume</a>(&amp;user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>, action);
<a name="l00996"></a>00996    <span class="comment">/* attempt to make the adjustment in the channel driver;</span>
<a name="l00997"></a>00997 <span class="comment">      if successful, don&apos;t adjust in the frame reading routine</span>
<a name="l00998"></a>00998 <span class="comment">   */</span>
<a name="l00999"></a>00999    <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a8187d6c217b26da3f3dccc3ce846325f">set_listen_volume</a>(user, user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>))
<a name="l01000"></a>01000       user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a> = 0;
<a name="l01001"></a>01001    <span class="keywordflow">else</span>
<a name="l01002"></a>01002       user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a> = user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>;
<a name="l01003"></a>01003 }
<a name="l01004"></a>01004 
<a name="l01005"></a><a class="code" href="app__meetme_8c.html#a57fc53d582772f2125adafaabe596b01">01005</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a57fc53d582772f2125adafaabe596b01">reset_volumes</a>(<span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>)
<a name="l01006"></a>01006 {
<a name="l01007"></a>01007    <span class="keywordtype">signed</span> <span class="keywordtype">char</span> zero_volume = 0;
<a name="l01008"></a>01008 
<a name="l01009"></a>01009    <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#abcf55626860f173284cafa474946d9b2">AST_OPTION_TXGAIN</a>, &amp;zero_volume, <span class="keyword">sizeof</span>(zero_volume), 0);
<a name="l01010"></a>01010    <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#a3e9274bcddca58b613f4e676b9943c03">AST_OPTION_RXGAIN</a>, &amp;zero_volume, <span class="keyword">sizeof</span>(zero_volume), 0);
<a name="l01011"></a>01011 }
<a name="l01012"></a>01012 
<a name="l01013"></a><a class="code" href="app__meetme_8c.html#a645090dd89fa3f8aaff60ea7eb38be18">01013</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a645090dd89fa3f8aaff60ea7eb38be18">conf_play</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf, <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49b">entrance_sound</a> <a class="code" href="structsound.html">sound</a>)
<a name="l01014"></a>01014 {
<a name="l01015"></a>01015    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data;
<a name="l01016"></a>01016    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01017"></a>01017    <span class="keywordtype">int</span> res = -1;
<a name="l01018"></a>01018 
<a name="l01019"></a>01019    <span class="keywordflow">if</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan))
<a name="l01020"></a>01020       res = <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01023"></a>01023 
<a name="l01024"></a>01024    <span class="keywordflow">switch</span>(sound) {
<a name="l01025"></a>01025    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49ba951ab68bb8f7daafb78951107080904e">ENTER</a>:
<a name="l01026"></a>01026       data = <a class="code" href="enter_8h.html#ada5f47456e76e78df8e950dd2b384e80">enter</a>;
<a name="l01027"></a>01027       len = <span class="keyword">sizeof</span>(<a class="code" href="enter_8h.html#ada5f47456e76e78df8e950dd2b384e80">enter</a>);
<a name="l01028"></a>01028       <span class="keywordflow">break</span>;
<a name="l01029"></a>01029    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49bae09e07839103de682cb13fa773793fc0">LEAVE</a>:
<a name="l01030"></a>01030       data = <a class="code" href="leave_8h.html#a17d53de1e565d7ea0537d5ec21b60472">leave</a>;
<a name="l01031"></a>01031       len = <span class="keyword">sizeof</span>(<a class="code" href="leave_8h.html#a17d53de1e565d7ea0537d5ec21b60472">leave</a>);
<a name="l01032"></a>01032       <span class="keywordflow">break</span>;
<a name="l01033"></a>01033    <span class="keywordflow">default</span>:
<a name="l01034"></a>01034       data = NULL;
<a name="l01035"></a>01035       len = 0;
<a name="l01036"></a>01036    }
<a name="l01037"></a>01037    <span class="keywordflow">if</span> (data) {
<a name="l01038"></a>01038       <a class="code" href="app__meetme_8c.html#a274bd5a5386b1ea0514ec87feb3d8d85">careful_write</a>(conf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, data, len, 1);
<a name="l01039"></a>01039    }
<a name="l01040"></a>01040 
<a name="l01041"></a>01041    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01042"></a>01042 
<a name="l01043"></a>01043    <span class="keywordflow">if</span> (!res) 
<a name="l01044"></a>01044       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l01045"></a>01045 }
<a name="l01046"></a>01046 <span class="comment"></span>
<a name="l01047"></a>01047 <span class="comment">/*!</span>
<a name="l01048"></a>01048 <span class="comment"> * \brief Find or create a conference</span>
<a name="l01049"></a>01049 <span class="comment"> *</span>
<a name="l01050"></a>01050 <span class="comment"> * \param confno The conference name/number</span>
<a name="l01051"></a>01051 <span class="comment"> * \param pin The regular user pin</span>
<a name="l01052"></a>01052 <span class="comment"> * \param pinadmin The admin pin</span>
<a name="l01053"></a>01053 <span class="comment"> * \param make Make the conf if it doesn&apos;t exist</span>
<a name="l01054"></a>01054 <span class="comment"> * \param dynamic Mark the newly created conference as dynamic</span>
<a name="l01055"></a>01055 <span class="comment"> * \param refcount How many references to mark on the conference</span>
<a name="l01056"></a>01056 <span class="comment"> * \param chan The asterisk channel</span>
<a name="l01057"></a>01057 <span class="comment"> *</span>
<a name="l01058"></a>01058 <span class="comment"> * \return A pointer to the conference struct, or NULL if it wasn&apos;t found and</span>
<a name="l01059"></a>01059 <span class="comment"> *         make or dynamic were not set.</span>
<a name="l01060"></a>01060 <span class="comment"> */</span>
<a name="l01061"></a><a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0">01061</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *<a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(<span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>, <span class="keywordtype">int</span> make, <span class="keywordtype">int</span> dynamic, <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01062"></a>01062 {
<a name="l01063"></a>01063    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf;
<a name="l01064"></a>01064    <span class="keyword">struct </span>dahdi_confinfo dahdic = { 0, };
<a name="l01065"></a>01065    <span class="keywordtype">int</span> confno_int = 0;
<a name="l01066"></a>01066 
<a name="l01067"></a>01067    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01068"></a>01068 
<a name="l01069"></a>01069    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l01070"></a>01070       <span class="keywordflow">if</span> (!strcmp(confno, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)) 
<a name="l01071"></a>01071          <span class="keywordflow">break</span>;
<a name="l01072"></a>01072    }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074    <span class="keywordflow">if</span> (cnf || (!make &amp;&amp; !dynamic))
<a name="l01075"></a>01075       <span class="keywordflow">goto</span> cnfout;
<a name="l01076"></a>01076 
<a name="l01077"></a>01077    <span class="comment">/* Make a new one */</span>
<a name="l01078"></a>01078    <span class="keywordflow">if</span> (!(cnf = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*cnf))))
<a name="l01079"></a>01079       <span class="keywordflow">goto</span> cnfout;
<a name="l01080"></a>01080 
<a name="l01081"></a>01081    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l01082"></a>01082    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l01083"></a>01083    cnf-&gt;<a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a> = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l01084"></a>01084    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#a36b5e5ca449d5db4d505c5ceed207e3b">recordthreadlock</a>);
<a name="l01085"></a>01085    cnf-&gt;announcethread = <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>;
<a name="l01086"></a>01086    <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;cnf-&gt;announcethreadlock);
<a name="l01087"></a>01087    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, confno, <span class="keyword">sizeof</span>(cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>));
<a name="l01088"></a>01088    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cnf-&gt;<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>, pin, <span class="keyword">sizeof</span>(cnf-&gt;<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>));
<a name="l01089"></a>01089    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>, pinadmin, <span class="keyword">sizeof</span>(cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>));
<a name="l01090"></a>01090    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(cnf-&gt;<a class="code" href="structast__conference.html#ae42dbdf188676f5840d98c4427e75a4f">uniqueid</a>, chan-&gt;uniqueid, <span class="keyword">sizeof</span>(cnf-&gt;<a class="code" href="structast__conference.html#ae42dbdf188676f5840d98c4427e75a4f">uniqueid</a>));
<a name="l01091"></a>01091 
<a name="l01092"></a>01092    <span class="comment">/* Setup a new dahdi conference */</span>
<a name="l01093"></a>01093    dahdic.confno = -1;
<a name="l01094"></a>01094    dahdic.confmode = DAHDI_CONF_CONFANN | DAHDI_CONF_CONFANNMON;
<a name="l01095"></a>01095    cnf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a> = open(<span class="stringliteral">&quot;/dev/dahdi/pseudo&quot;</span>, O_RDWR);
<a name="l01096"></a>01096    <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &lt; 0 || ioctl(cnf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l01097"></a>01097       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open pseudo device\n&quot;</span>);
<a name="l01098"></a>01098       <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &gt;= 0)
<a name="l01099"></a>01099          close(cnf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l01100"></a>01100       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cnf);
<a name="l01101"></a>01101       cnf = NULL;
<a name="l01102"></a>01102       <span class="keywordflow">goto</span> cnfout;
<a name="l01103"></a>01103    }
<a name="l01104"></a>01104 
<a name="l01105"></a>01105    cnf-&gt;<a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a> = dahdic.confno;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107    <span class="comment">/* Setup a new channel for playback of audio files */</span>
<a name="l01108"></a>01108    cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(<span class="stringliteral">&quot;DAHDI&quot;</span>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>, <span class="stringliteral">&quot;pseudo&quot;</span>, NULL);
<a name="l01109"></a>01109    <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) {
<a name="l01110"></a>01110       <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l01111"></a>01111       <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l01112"></a>01112       dahdic.chan = 0;
<a name="l01113"></a>01113       dahdic.confno = cnf-&gt;<a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a>;
<a name="l01114"></a>01114       dahdic.confmode = DAHDI_CONF_CONFANN | DAHDI_CONF_CONFANNMON;
<a name="l01115"></a>01115       <span class="keywordflow">if</span> (ioctl(cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0], DAHDI_SETCONF, &amp;dahdic)) {
<a name="l01116"></a>01116          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l01117"></a>01117          <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01118"></a>01118             <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l01119"></a>01119          <span class="keywordflow">else</span>
<a name="l01120"></a>01120             close(cnf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l01121"></a>01121 
<a name="l01122"></a>01122          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cnf);
<a name="l01123"></a>01123          cnf = NULL;
<a name="l01124"></a>01124          <span class="keywordflow">goto</span> cnfout;
<a name="l01125"></a>01125       }
<a name="l01126"></a>01126    }
<a name="l01127"></a>01127 
<a name="l01128"></a>01128    <span class="comment">/* Fill the conference struct */</span>
<a name="l01129"></a>01129    cnf-&gt;<a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a> = time(NULL);
<a name="l01130"></a>01130    cnf-&gt;<a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">maxusers</a> = 0x7fffffff;
<a name="l01131"></a>01131    cnf-&gt;<a class="code" href="structast__conference.html#a0fcf3d8cb0b08a4d668fd87f01bd4192">isdynamic</a> = dynamic ? 1 : 0;
<a name="l01132"></a>01132    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Created MeetMe conference %d for conference &apos;%s&apos;\n&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a>, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l01133"></a>01133    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;confs, cnf, list);
<a name="l01134"></a>01134 
<a name="l01135"></a>01135    <span class="comment">/* Reserve conference number in map */</span>
<a name="l01136"></a>01136    <span class="keywordflow">if</span> ((sscanf(cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;confno_int) == 1) &amp;&amp; (confno_int &gt;= 0 &amp;&amp; confno_int &lt; 1024))
<a name="l01137"></a>01137       <a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">conf_map</a>[confno_int] = 1;
<a name="l01138"></a>01138    
<a name="l01139"></a>01139 cnfout:
<a name="l01140"></a>01140    <span class="keywordflow">if</span> (cnf)
<a name="l01141"></a>01141       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>, refcount);
<a name="l01142"></a>01142 
<a name="l01143"></a>01143    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01144"></a>01144 
<a name="l01145"></a>01145    <span class="keywordflow">return</span> cnf;
<a name="l01146"></a>01146 }
<a name="l01147"></a>01147 
<a name="l01148"></a><a class="code" href="app__meetme_8c.html#ab2231cb0edc514c59bebbb930f2de44a">01148</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#ab2231cb0edc514c59bebbb930f2de44a">complete_meetmecmd</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *line, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ael_8tab_8c.html#a836535f59bf515522a395858a8029d42">word</a>, <span class="keywordtype">int</span> pos, <span class="keywordtype">int</span> <a class="code" href="structstate.html">state</a>)
<a name="l01149"></a>01149 {
<a name="l01150"></a>01150    <span class="keyword">static</span> <span class="keywordtype">char</span> *cmds[] = {<span class="stringliteral">&quot;concise&quot;</span>, <span class="stringliteral">&quot;lock&quot;</span>, <span class="stringliteral">&quot;unlock&quot;</span>, <span class="stringliteral">&quot;mute&quot;</span>, <span class="stringliteral">&quot;unmute&quot;</span>, <span class="stringliteral">&quot;kick&quot;</span>, <span class="stringliteral">&quot;list&quot;</span>, NULL};
<a name="l01151"></a>01151 
<a name="l01152"></a>01152    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = strlen(word);
<a name="l01153"></a>01153    <span class="keywordtype">int</span> which = 0;
<a name="l01154"></a>01154    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf = NULL;
<a name="l01155"></a>01155    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *usr = NULL;
<a name="l01156"></a>01156    <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a> = NULL;
<a name="l01157"></a>01157    <span class="keywordtype">char</span> usrno[50] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01158"></a>01158    <span class="keywordtype">char</span> *myline, *ret = NULL;
<a name="l01159"></a>01159    
<a name="l01160"></a>01160    <span class="keywordflow">if</span> (pos == 1) {      <span class="comment">/* Command */</span>
<a name="l01161"></a>01161       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a7d198ac45b2d75bb30eb773582caf89f">ast_cli_complete</a>(word, cmds, state);
<a name="l01162"></a>01162    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pos == 2) {  <span class="comment">/* Conference Number */</span>
<a name="l01163"></a>01163       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01164"></a>01164       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l01165"></a>01165          <span class="keywordflow">if</span> (!strncasecmp(word, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, len) &amp;&amp; ++which &gt; state) {
<a name="l01166"></a>01166             ret = cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>;
<a name="l01167"></a>01167             <span class="keywordflow">break</span>;
<a name="l01168"></a>01168          }
<a name="l01169"></a>01169       }
<a name="l01170"></a>01170       ret = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(ret); <span class="comment">/* dup before releasing the lock */</span>
<a name="l01171"></a>01171       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01172"></a>01172       <span class="keywordflow">return</span> ret;
<a name="l01173"></a>01173    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (pos == 3) {
<a name="l01174"></a>01174       <span class="comment">/* User Number || Conf Command option*/</span>
<a name="l01175"></a>01175       <span class="keywordflow">if</span> (strstr(line, <span class="stringliteral">&quot;mute&quot;</span>) || strstr(line, <span class="stringliteral">&quot;kick&quot;</span>)) {
<a name="l01176"></a>01176          <span class="keywordflow">if</span> (state == 0 &amp;&amp; (strstr(line, <span class="stringliteral">&quot;kick&quot;</span>) || strstr(line, <span class="stringliteral">&quot;mute&quot;</span>)) &amp;&amp; !strncasecmp(word, <span class="stringliteral">&quot;all&quot;</span>, len))
<a name="l01177"></a>01177             <span class="keywordflow">return</span> <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;all&quot;</span>);
<a name="l01178"></a>01178          which++;
<a name="l01179"></a>01179          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01180"></a>01180 
<a name="l01181"></a>01181          <span class="comment">/* TODO: Find the conf number from the cmdline (ignore spaces) &lt;- test this and make it fail-safe! */</span>
<a name="l01182"></a>01182          myline = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(line);
<a name="l01183"></a>01183          <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;myline, <span class="stringliteral">&quot; &quot;</span>) &amp;&amp; <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;myline, <span class="stringliteral">&quot; &quot;</span>) &amp;&amp; !confno) {
<a name="l01184"></a>01184             <span class="keywordflow">while</span>((confno = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;myline, <span class="stringliteral">&quot; &quot;</span>)) &amp;&amp; (strcmp(confno, <span class="stringliteral">&quot; &quot;</span>) == 0))
<a name="l01185"></a>01185                ;
<a name="l01186"></a>01186          }
<a name="l01187"></a>01187          
<a name="l01188"></a>01188          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l01189"></a>01189             <span class="keywordflow">if</span> (!strcmp(confno, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>))
<a name="l01190"></a>01190                 <span class="keywordflow">break</span>;
<a name="l01191"></a>01191          }
<a name="l01192"></a>01192 
<a name="l01193"></a>01193          <span class="keywordflow">if</span> (cnf) {
<a name="l01194"></a>01194             <span class="comment">/* Search for the user */</span>
<a name="l01195"></a>01195             <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, usr, list) {
<a name="l01196"></a>01196                snprintf(usrno, <span class="keyword">sizeof</span>(usrno), <span class="stringliteral">&quot;%d&quot;</span>, usr-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>);
<a name="l01197"></a>01197                <span class="keywordflow">if</span> (!strncasecmp(word, usrno, len) &amp;&amp; ++which &gt; state)
<a name="l01198"></a>01198                   <span class="keywordflow">break</span>;
<a name="l01199"></a>01199             }
<a name="l01200"></a>01200          }
<a name="l01201"></a>01201          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01202"></a>01202          <span class="keywordflow">return</span> usr ? <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(usrno) : NULL;
<a name="l01203"></a>01203       }
<a name="l01204"></a>01204    }
<a name="l01205"></a>01205 
<a name="l01206"></a>01206    <span class="keywordflow">return</span> NULL;
<a name="l01207"></a>01207 }
<a name="l01208"></a>01208 
<a name="l01209"></a><a class="code" href="app__meetme_8c.html#a5f272b0802dbeb3b9592c16839e4a134">01209</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a5f272b0802dbeb3b9592c16839e4a134">meetme_show_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01210"></a>01210 {
<a name="l01211"></a>01211    <span class="comment">/* Process the command */</span>
<a name="l01212"></a>01212    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l01213"></a>01213    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf;
<a name="l01214"></a>01214    <span class="keywordtype">int</span> hr, min, <a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>;
<a name="l01215"></a>01215    <span class="keywordtype">int</span> i = 0, <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> = 0;
<a name="l01216"></a>01216    time_t now;
<a name="l01217"></a>01217    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *cmdline = NULL;
<a name="l01218"></a>01218 <span class="preprocessor">#define MC_HEADER_FORMAT &quot;%-14s %-14s %-10s %-8s  %-8s  %-6s\n&quot;</span>
<a name="l01219"></a>01219 <span class="preprocessor"></span><span class="preprocessor">#define MC_DATA_FORMAT &quot;%-12.12s   %4.4d        %4.4s       %02d:%02d:%02d  %-8s  %-6s\n&quot;</span>
<a name="l01220"></a>01220 <span class="preprocessor"></span>
<a name="l01221"></a>01221    <span class="keywordflow">switch</span> (cmd) {
<a name="l01222"></a>01222    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01223"></a>01223       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;meetme list [concise]&quot;</span>;
<a name="l01224"></a>01224       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01225"></a>01225          <span class="stringliteral">&quot;Usage: meetme list [concise] &lt;confno&gt; \n&quot;</span>
<a name="l01226"></a>01226          <span class="stringliteral">&quot;       List all or a specific conference.\n&quot;</span>;
<a name="l01227"></a>01227       <span class="keywordflow">return</span> NULL;
<a name="l01228"></a>01228    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01229"></a>01229       <span class="keywordflow">return</span> <a class="code" href="app__meetme_8c.html#ab2231cb0edc514c59bebbb930f2de44a">complete_meetmecmd</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l01230"></a>01230    }
<a name="l01231"></a>01231 
<a name="l01232"></a>01232    <span class="comment">/* Check for length so no buffer will overflow... */</span>
<a name="l01233"></a>01233    <span class="keywordflow">for</span> (i = 0; i &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; i++) {
<a name="l01234"></a>01234       <span class="keywordflow">if</span> (strlen(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[i]) &gt; 100)
<a name="l01235"></a>01235          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Invalid Arguments.\n&quot;</span>);
<a name="l01236"></a>01236    }
<a name="l01237"></a>01237 
<a name="l01238"></a>01238    <span class="comment">/* Max confno length */</span>
<a name="l01239"></a>01239    <span class="keywordflow">if</span> (!(cmdline = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>))) {
<a name="l01240"></a>01240       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01241"></a>01241    }
<a name="l01242"></a>01242 
<a name="l01243"></a>01243    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 2 || (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;concise&quot;</span>))) {
<a name="l01244"></a>01244       <span class="comment">/* List all the conferences */</span>   
<a name="l01245"></a>01245       <span class="keywordtype">int</span> concise = (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 3 &amp;&amp; !strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2], <span class="stringliteral">&quot;concise&quot;</span>));
<a name="l01246"></a>01246       now = time(NULL);
<a name="l01247"></a>01247       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01248"></a>01248       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;confs)) {
<a name="l01249"></a>01249          <span class="keywordflow">if</span> (!concise) {
<a name="l01250"></a>01250             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No active MeetMe conferences.\n&quot;</span>);
<a name="l01251"></a>01251          }
<a name="l01252"></a>01252          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01253"></a>01253          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01254"></a>01254          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01255"></a>01255       }
<a name="l01256"></a>01256       <span class="keywordflow">if</span> (!concise) {
<a name="l01257"></a>01257          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__meetme_8c.html#ac5a6cd9121b3a70a3b1d4f04da316913">MC_HEADER_FORMAT</a>, <span class="stringliteral">&quot;Conf Num&quot;</span>, <span class="stringliteral">&quot;Parties&quot;</span>, <span class="stringliteral">&quot;Marked&quot;</span>, <span class="stringliteral">&quot;Activity&quot;</span>, <span class="stringliteral">&quot;Creation&quot;</span>, <span class="stringliteral">&quot;Locked&quot;</span>);
<a name="l01258"></a>01258       }
<a name="l01259"></a>01259       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l01260"></a>01260          <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a> == 0) {
<a name="l01261"></a>01261             <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;N/A &quot;</span>);
<a name="l01262"></a>01262          } <span class="keywordflow">else</span> {
<a name="l01263"></a>01263             <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;%4.4d&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>);
<a name="l01264"></a>01264          }
<a name="l01265"></a>01265          hr = (now - cnf-&gt;<a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) / 3600;
<a name="l01266"></a>01266          min = ((now - cnf-&gt;<a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) % 3600) / 60;
<a name="l01267"></a>01267          sec = (now - cnf-&gt;<a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>) % 60;
<a name="l01268"></a>01268          <span class="keywordflow">if</span> (!concise) {
<a name="l01269"></a>01269             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <a class="code" href="app__meetme_8c.html#a9fac8c38ea4be0b32e78fb14fa907dd0">MC_DATA_FORMAT</a>, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, cnf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(cmdline), hr, min, sec, cnf-&gt;<a class="code" href="structast__conference.html#a0fcf3d8cb0b08a4d668fd87f01bd4192">isdynamic</a> ? <span class="stringliteral">&quot;Dynamic&quot;</span> : <span class="stringliteral">&quot;Static&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>);
<a name="l01270"></a>01270          } <span class="keywordflow">else</span> {
<a name="l01271"></a>01271             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%s!%d!%d!%02d:%02d:%02d!%d!%d\n&quot;</span>,
<a name="l01272"></a>01272                cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>,
<a name="l01273"></a>01273                cnf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>,
<a name="l01274"></a>01274                cnf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>,
<a name="l01275"></a>01275                hr, min, sec,
<a name="l01276"></a>01276                cnf-&gt;<a class="code" href="structast__conference.html#a0fcf3d8cb0b08a4d668fd87f01bd4192">isdynamic</a>,
<a name="l01277"></a>01277                cnf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a>);
<a name="l01278"></a>01278          }
<a name="l01279"></a>01279 
<a name="l01280"></a>01280          <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> += cnf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>;
<a name="l01281"></a>01281       }
<a name="l01282"></a>01282       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01283"></a>01283       <span class="keywordflow">if</span> (!concise) {
<a name="l01284"></a>01284          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;* Total number of MeetMe users: %d\n&quot;</span>, <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a>);
<a name="l01285"></a>01285       }
<a name="l01286"></a>01286       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01287"></a>01287       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01288"></a>01288    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;list&quot;</span>) == 0) {
<a name="l01289"></a>01289       <span class="keywordtype">int</span> concise = (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 4 &amp;&amp; (!strcasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;concise&quot;</span>)));
<a name="l01290"></a>01290       <span class="comment">/* List all the users in a conference */</span>
<a name="l01291"></a>01291       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;confs)) {
<a name="l01292"></a>01292          <span class="keywordflow">if</span> (!concise) {
<a name="l01293"></a>01293             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No active MeetMe conferences.\n&quot;</span>);
<a name="l01294"></a>01294          }
<a name="l01295"></a>01295          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01296"></a>01296          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;  
<a name="l01297"></a>01297       }
<a name="l01298"></a>01298       <span class="comment">/* Find the right conference */</span>
<a name="l01299"></a>01299       <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01300"></a>01300       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l01301"></a>01301          <span class="keywordflow">if</span> (strcmp(cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]) == 0) {
<a name="l01302"></a>01302             <span class="keywordflow">break</span>;
<a name="l01303"></a>01303          }
<a name="l01304"></a>01304       }
<a name="l01305"></a>01305       <span class="keywordflow">if</span> (!cnf) {
<a name="l01306"></a>01306          <span class="keywordflow">if</span> (!concise)
<a name="l01307"></a>01307             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;No such conference: %s.\n&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);
<a name="l01308"></a>01308          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01309"></a>01309          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01310"></a>01310          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01311"></a>01311       }
<a name="l01312"></a>01312       <span class="comment">/* Show all the users */</span>
<a name="l01313"></a>01313       time(&amp;now);
<a name="l01314"></a>01314       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l01315"></a>01315          hr = (now - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>) / 3600;
<a name="l01316"></a>01316          min = ((now - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>) % 3600) / 60;
<a name="l01317"></a>01317          sec = (now - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>) % 60;
<a name="l01318"></a>01318          <span class="keywordflow">if</span> (!concise) {
<a name="l01319"></a>01319             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;User #: %-2.2d %12.12s %-20.20s Channel: %s %s %s %s %s %s %02d:%02d:%02d\n&quot;</span>,
<a name="l01320"></a>01320                user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>,
<a name="l01321"></a>01321                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l01322"></a>01322                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;no name&gt;&quot;</span>),
<a name="l01323"></a>01323                user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name,
<a name="l01324"></a>01324                user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a> ? <span class="stringliteral">&quot;(Admin)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01325"></a>01325                user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">CONFFLAG_MONITOR</a> ? <span class="stringliteral">&quot;(Listen only)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01326"></a>01326                user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> ? <span class="stringliteral">&quot;(Admin Muted)&quot;</span> : user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> ? <span class="stringliteral">&quot;(Muted)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01327"></a>01327                user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a> ? <span class="stringliteral">&quot;(Request to Talk)&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01328"></a>01328                <a class="code" href="app__meetme_8c.html#a42dfb845a7846bd1bc1612beecc492b7">istalking</a>(user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a>), hr, min, sec); 
<a name="l01329"></a>01329          } <span class="keywordflow">else</span> {
<a name="l01330"></a>01330             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d!%s!%s!%s!%s!%s!%s!%s!%d!%02d:%02d:%02d\n&quot;</span>,
<a name="l01331"></a>01331                user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>,
<a name="l01332"></a>01332                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&quot;</span>),
<a name="l01333"></a>01333                <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&quot;</span>),
<a name="l01334"></a>01334                user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name,
<a name="l01335"></a>01335                user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a>  &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a>   ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01336"></a>01336                user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a>  &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">CONFFLAG_MONITOR</a> ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01337"></a>01337                user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>) ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01338"></a>01338                user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a> ? <span class="stringliteral">&quot;1&quot;</span> : <span class="stringliteral">&quot;&quot;</span>,
<a name="l01339"></a>01339                user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a>, hr, min, sec);
<a name="l01340"></a>01340          }
<a name="l01341"></a>01341       }
<a name="l01342"></a>01342       <span class="keywordflow">if</span> (!concise) {
<a name="l01343"></a>01343          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;%d users in that conference.\n&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>);
<a name="l01344"></a>01344       }
<a name="l01345"></a>01345       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01346"></a>01346       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01347"></a>01347       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01348"></a>01348    }
<a name="l01349"></a>01349    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 2) {
<a name="l01350"></a>01350       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01351"></a>01351       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01352"></a>01352    }
<a name="l01353"></a>01353 
<a name="l01354"></a>01354    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Cmdline: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(cmdline));
<a name="l01355"></a>01355 
<a name="l01356"></a>01356    <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(cmdline));
<a name="l01357"></a>01357    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01358"></a>01358 
<a name="l01359"></a>01359    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01360"></a>01360 }
<a name="l01361"></a>01361 
<a name="l01362"></a>01362 
<a name="l01363"></a><a class="code" href="app__meetme_8c.html#ad9afdce96e1d514b69858b8a085b3b9e">01363</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#ad9afdce96e1d514b69858b8a085b3b9e">meetme_cmd</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01364"></a>01364 {
<a name="l01365"></a>01365    <span class="comment">/* Process the command */</span>
<a name="l01366"></a>01366    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *cmdline = NULL;
<a name="l01367"></a>01367    <span class="keywordtype">int</span> i = 0;
<a name="l01368"></a>01368 
<a name="l01369"></a>01369    <span class="keywordflow">switch</span> (cmd) {
<a name="l01370"></a>01370    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01371"></a>01371       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;meetme {lock|unlock|mute|unmute|kick}&quot;</span>;
<a name="l01372"></a>01372       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01373"></a>01373          <span class="stringliteral">&quot;Usage: meetme (un)lock|(un)mute|kick &lt;confno&gt; &lt;usernumber&gt;\n&quot;</span>
<a name="l01374"></a>01374          <span class="stringliteral">&quot;       Executes a command for the conference or on a conferee\n&quot;</span>;
<a name="l01375"></a>01375       <span class="keywordflow">return</span> NULL;
<a name="l01376"></a>01376    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01377"></a>01377       <span class="keywordflow">return</span> <a class="code" href="app__meetme_8c.html#ab2231cb0edc514c59bebbb930f2de44a">complete_meetmecmd</a>(a-&gt;<a class="code" href="structast__cli__args.html#a2a7a1aa13a4f14075411123a4495593c">line</a>, a-&gt;<a class="code" href="structast__cli__args.html#adc1f34651f7bbfa3ba5af27db5f53817">word</a>, a-&gt;<a class="code" href="structast__cli__args.html#a1910d262855b71da353ed0d07a6c7823">pos</a>, a-&gt;<a class="code" href="structast__cli__args.html#a76f11d9a0a47b94f72c2d0e77fb32240">n</a>);
<a name="l01378"></a>01378    }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &gt; 8)
<a name="l01381"></a>01381       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Invalid Arguments.\n&quot;</span>);
<a name="l01382"></a>01382    <span class="comment">/* Check for length so no buffer will overflow... */</span>
<a name="l01383"></a>01383    <span class="keywordflow">for</span> (i = 0; i &lt; a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a>; i++) {
<a name="l01384"></a>01384       <span class="keywordflow">if</span> (strlen(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[i]) &gt; 100)
<a name="l01385"></a>01385          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Invalid Arguments.\n&quot;</span>);
<a name="l01386"></a>01386    }
<a name="l01387"></a>01387 
<a name="l01388"></a>01388    <span class="comment">/* Max confno length */</span>
<a name="l01389"></a>01389    <span class="keywordflow">if</span> (!(cmdline = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>))) {
<a name="l01390"></a>01390       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l01391"></a>01391    }
<a name="l01392"></a>01392 
<a name="l01393"></a>01393    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 1) {
<a name="l01394"></a>01394       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01395"></a>01395       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01396"></a>01396    }
<a name="l01397"></a>01397 
<a name="l01398"></a>01398    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2]);  <span class="comment">/* Argv 2: conference number */</span>
<a name="l01399"></a>01399    <span class="keywordflow">if</span> (strstr(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;lock&quot;</span>)) {
<a name="l01400"></a>01400       <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;lock&quot;</span>) == 0) {
<a name="l01401"></a>01401          <span class="comment">/* Lock */</span>
<a name="l01402"></a>01402          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,L&quot;</span>);
<a name="l01403"></a>01403       } <span class="keywordflow">else</span> {
<a name="l01404"></a>01404          <span class="comment">/* Unlock */</span>
<a name="l01405"></a>01405          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,l&quot;</span>);
<a name="l01406"></a>01406       }
<a name="l01407"></a>01407    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strstr(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;mute&quot;</span>)) { 
<a name="l01408"></a>01408       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4) {
<a name="l01409"></a>01409          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01410"></a>01410          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01411"></a>01411       }
<a name="l01412"></a>01412       <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;mute&quot;</span>) == 0) {
<a name="l01413"></a>01413          <span class="comment">/* Mute */</span>
<a name="l01414"></a>01414          <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;all&quot;</span>) == 0) {
<a name="l01415"></a>01415             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,N&quot;</span>);
<a name="l01416"></a>01416          } <span class="keywordflow">else</span> {
<a name="l01417"></a>01417             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,M,%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);  
<a name="l01418"></a>01418          }
<a name="l01419"></a>01419       } <span class="keywordflow">else</span> {
<a name="l01420"></a>01420          <span class="comment">/* Unmute */</span>
<a name="l01421"></a>01421          <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;all&quot;</span>) == 0) {
<a name="l01422"></a>01422             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,n&quot;</span>);
<a name="l01423"></a>01423          } <span class="keywordflow">else</span> {
<a name="l01424"></a>01424             <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,m,%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01425"></a>01425          }
<a name="l01426"></a>01426       }
<a name="l01427"></a>01427    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[1], <span class="stringliteral">&quot;kick&quot;</span>) == 0) {
<a name="l01428"></a>01428       <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> &lt; 4) {
<a name="l01429"></a>01429          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01430"></a>01430          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01431"></a>01431       }
<a name="l01432"></a>01432       <span class="keywordflow">if</span> (strcmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3], <span class="stringliteral">&quot;all&quot;</span>) == 0) {
<a name="l01433"></a>01433          <span class="comment">/* Kick all */</span>
<a name="l01434"></a>01434          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,K&quot;</span>);
<a name="l01435"></a>01435       } <span class="keywordflow">else</span> {
<a name="l01436"></a>01436          <span class="comment">/* Kick a single user */</span>
<a name="l01437"></a>01437          <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;cmdline, 0, <span class="stringliteral">&quot;,k,%s&quot;</span>, a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3]);
<a name="l01438"></a>01438       }
<a name="l01439"></a>01439    } <span class="keywordflow">else</span> {
<a name="l01440"></a>01440       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01441"></a>01441       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l01442"></a>01442    }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Cmdline: %s\n&quot;</span>, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(cmdline));
<a name="l01445"></a>01445 
<a name="l01446"></a>01446    <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(cmdline));
<a name="l01447"></a>01447    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cmdline);
<a name="l01448"></a>01448 
<a name="l01449"></a>01449    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01450"></a>01450 }
<a name="l01451"></a>01451 
<a name="l01452"></a><a class="code" href="app__meetme_8c.html#a7fcb5686ee02006353e22f8c70dbcdef">01452</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a7fcb5686ee02006353e22f8c70dbcdef">sla_hold_str</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> hold_access)
<a name="l01453"></a>01453 {
<a name="l01454"></a>01454    <span class="keyword">const</span> <span class="keywordtype">char</span> *hold = <span class="stringliteral">&quot;Unknown&quot;</span>;
<a name="l01455"></a>01455 
<a name="l01456"></a>01456    <span class="keywordflow">switch</span> (hold_access) {
<a name="l01457"></a>01457    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685ca1e46cd00f27d565cf02c15ec55c8be06">SLA_HOLD_OPEN</a>:
<a name="l01458"></a>01458       hold = <span class="stringliteral">&quot;Open&quot;</span>;
<a name="l01459"></a>01459       <span class="keywordflow">break</span>;
<a name="l01460"></a>01460    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">SLA_HOLD_PRIVATE</a>:
<a name="l01461"></a>01461       hold = <span class="stringliteral">&quot;Private&quot;</span>;
<a name="l01462"></a>01462    <span class="keywordflow">default</span>:
<a name="l01463"></a>01463       <span class="keywordflow">break</span>;
<a name="l01464"></a>01464    }
<a name="l01465"></a>01465 
<a name="l01466"></a>01466    <span class="keywordflow">return</span> hold;
<a name="l01467"></a>01467 }
<a name="l01468"></a>01468 
<a name="l01469"></a><a class="code" href="app__meetme_8c.html#a94cb635b9fb6a74e88b8b134ac5e23d5">01469</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#a94cb635b9fb6a74e88b8b134ac5e23d5">sla_show_trunks</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01470"></a>01470 {
<a name="l01471"></a>01471    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l01472"></a>01472 
<a name="l01473"></a>01473    <span class="keywordflow">switch</span> (cmd) {
<a name="l01474"></a>01474    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01475"></a>01475       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;sla show trunks&quot;</span>;
<a name="l01476"></a>01476       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01477"></a>01477          <span class="stringliteral">&quot;Usage: sla show trunks\n&quot;</span>
<a name="l01478"></a>01478          <span class="stringliteral">&quot;       This will list all trunks defined in sla.conf\n&quot;</span>;
<a name="l01479"></a>01479       <span class="keywordflow">return</span> NULL;
<a name="l01480"></a>01480    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01481"></a>01481       <span class="keywordflow">return</span> NULL;
<a name="l01482"></a>01482    }
<a name="l01483"></a>01483 
<a name="l01484"></a>01484    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span>
<a name="l01485"></a>01485                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l01486"></a>01486                <span class="stringliteral">&quot;=== Configured SLA Trunks ===================================\n&quot;</span>
<a name="l01487"></a>01487                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l01488"></a>01488                <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l01489"></a>01489    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l01490"></a>01490    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_trunks, trunk, entry) {
<a name="l01491"></a>01491       <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l01492"></a>01492       <span class="keywordtype">char</span> ring_timeout[16] = <span class="stringliteral">&quot;(none)&quot;</span>;
<a name="l01493"></a>01493       <span class="keywordflow">if</span> (trunk-&gt;ring_timeout)
<a name="l01494"></a>01494          snprintf(ring_timeout, <span class="keyword">sizeof</span>(ring_timeout), <span class="stringliteral">&quot;%u Seconds&quot;</span>, trunk-&gt;ring_timeout);
<a name="l01495"></a>01495       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span>
<a name="l01496"></a>01496                   <span class="stringliteral">&quot;=== Trunk Name:       %s\n&quot;</span>
<a name="l01497"></a>01497                   <span class="stringliteral">&quot;=== ==&gt; Device:       %s\n&quot;</span>
<a name="l01498"></a>01498                   <span class="stringliteral">&quot;=== ==&gt; AutoContext:  %s\n&quot;</span>
<a name="l01499"></a>01499                   <span class="stringliteral">&quot;=== ==&gt; RingTimeout:  %s\n&quot;</span>
<a name="l01500"></a>01500                   <span class="stringliteral">&quot;=== ==&gt; BargeAllowed: %s\n&quot;</span>
<a name="l01501"></a>01501                   <span class="stringliteral">&quot;=== ==&gt; HoldAccess:   %s\n&quot;</span>
<a name="l01502"></a>01502                   <span class="stringliteral">&quot;=== ==&gt; Stations ...\n&quot;</span>,
<a name="l01503"></a>01503                   trunk-&gt;name, trunk-&gt;device, 
<a name="l01504"></a>01504                   <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(trunk-&gt;autocontext, <span class="stringliteral">&quot;(none)&quot;</span>), 
<a name="l01505"></a>01505                   ring_timeout,
<a name="l01506"></a>01506                   trunk-&gt;barge_disabled ? <span class="stringliteral">&quot;No&quot;</span> : <span class="stringliteral">&quot;Yes&quot;</span>,
<a name="l01507"></a>01507                   <a class="code" href="app__meetme_8c.html#a7fcb5686ee02006353e22f8c70dbcdef">sla_hold_str</a>(trunk-&gt;hold_access));
<a name="l01508"></a>01508       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_stations);
<a name="l01509"></a>01509       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;trunk-&gt;stations, station_ref, entry)
<a name="l01510"></a>01510          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;===    ==&gt; Station name: %s\n&quot;</span>, station_ref-&gt;station-&gt;name);
<a name="l01511"></a>01511       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l01512"></a>01512       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n===\n&quot;</span>);
<a name="l01513"></a>01513    }
<a name="l01514"></a>01514    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l01515"></a>01515    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=============================================================\n\n&quot;</span>);
<a name="l01516"></a>01516 
<a name="l01517"></a>01517    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01518"></a>01518 }
<a name="l01519"></a>01519 
<a name="l01520"></a><a class="code" href="app__meetme_8c.html#adca22e29e840747e49e804c977f67386">01520</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#adca22e29e840747e49e804c977f67386">trunkstate2str</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75">sla_trunk_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l01521"></a>01521 {
<a name="l01522"></a>01522 <span class="preprocessor">#define S(e) case e: return # e;</span>
<a name="l01523"></a>01523 <span class="preprocessor"></span>   <span class="keywordflow">switch</span> (state) {
<a name="l01524"></a>01524    <a class="code" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>(<a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>)
<a name="l01525"></a>01525    <a class="code" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>(<a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a4822569aa984228bec67e07f5b9862a5">SLA_TRUNK_STATE_RINGING</a>)
<a name="l01526"></a>01526    <a class="code" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>(<a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>)
<a name="l01527"></a>01527    <a class="code" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>(<a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a17322fe34775141bef95a88fd00ed59d">SLA_TRUNK_STATE_ONHOLD</a>)
<a name="l01528"></a>01528    <a class="code" href="app__meetme_8c.html#abd5465a13e11fe1c52a5a0f7b0b0812e">S</a>(<a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>)
<a name="l01529"></a>01529    }
<a name="l01530"></a>01530    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Uknown State&quot;</span>;
<a name="l01531"></a>01531 <span class="preprocessor">#undef S</span>
<a name="l01532"></a>01532 <span class="preprocessor"></span>}
<a name="l01533"></a>01533 
<a name="l01534"></a><a class="code" href="app__meetme_8c.html#ac9396eafa98ce0ee732f0ea84aefaee4">01534</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#ac9396eafa98ce0ee732f0ea84aefaee4">sla_show_stations</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l01535"></a>01535 {
<a name="l01536"></a>01536    <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538    <span class="keywordflow">switch</span> (cmd) {
<a name="l01539"></a>01539    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l01540"></a>01540       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;sla show stations&quot;</span>;
<a name="l01541"></a>01541       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l01542"></a>01542          <span class="stringliteral">&quot;Usage: sla show stations\n&quot;</span>
<a name="l01543"></a>01543          <span class="stringliteral">&quot;       This will list all stations defined in sla.conf\n&quot;</span>;
<a name="l01544"></a>01544       <span class="keywordflow">return</span> NULL;
<a name="l01545"></a>01545    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l01546"></a>01546       <span class="keywordflow">return</span> NULL;
<a name="l01547"></a>01547    }
<a name="l01548"></a>01548 
<a name="l01549"></a>01549    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;\n&quot;</span> 
<a name="l01550"></a>01550                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l01551"></a>01551                <span class="stringliteral">&quot;=== Configured SLA Stations =================================\n&quot;</span>
<a name="l01552"></a>01552                <span class="stringliteral">&quot;=============================================================\n&quot;</span>
<a name="l01553"></a>01553                <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l01554"></a>01554    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_stations);
<a name="l01555"></a>01555    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l01556"></a>01556       <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l01557"></a>01557       <span class="keywordtype">char</span> ring_timeout[16] = <span class="stringliteral">&quot;(none)&quot;</span>;
<a name="l01558"></a>01558       <span class="keywordtype">char</span> ring_delay[16] = <span class="stringliteral">&quot;(none)&quot;</span>;
<a name="l01559"></a>01559       <span class="keywordflow">if</span> (station-&gt;ring_timeout) {
<a name="l01560"></a>01560          snprintf(ring_timeout, <span class="keyword">sizeof</span>(ring_timeout), 
<a name="l01561"></a>01561             <span class="stringliteral">&quot;%u&quot;</span>, station-&gt;ring_timeout);
<a name="l01562"></a>01562       }
<a name="l01563"></a>01563       <span class="keywordflow">if</span> (station-&gt;ring_delay) {
<a name="l01564"></a>01564          snprintf(ring_delay, <span class="keyword">sizeof</span>(ring_delay), 
<a name="l01565"></a>01565             <span class="stringliteral">&quot;%u&quot;</span>, station-&gt;ring_delay);
<a name="l01566"></a>01566       }
<a name="l01567"></a>01567       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span>
<a name="l01568"></a>01568                   <span class="stringliteral">&quot;=== Station Name:    %s\n&quot;</span>
<a name="l01569"></a>01569                   <span class="stringliteral">&quot;=== ==&gt; Device:      %s\n&quot;</span>
<a name="l01570"></a>01570                   <span class="stringliteral">&quot;=== ==&gt; AutoContext: %s\n&quot;</span>
<a name="l01571"></a>01571                   <span class="stringliteral">&quot;=== ==&gt; RingTimeout: %s\n&quot;</span>
<a name="l01572"></a>01572                   <span class="stringliteral">&quot;=== ==&gt; RingDelay:   %s\n&quot;</span>
<a name="l01573"></a>01573                   <span class="stringliteral">&quot;=== ==&gt; HoldAccess:  %s\n&quot;</span>
<a name="l01574"></a>01574                   <span class="stringliteral">&quot;=== ==&gt; Trunks ...\n&quot;</span>,
<a name="l01575"></a>01575                   station-&gt;name, station-&gt;device,
<a name="l01576"></a>01576                   <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(station-&gt;autocontext, <span class="stringliteral">&quot;(none)&quot;</span>), 
<a name="l01577"></a>01577                   ring_timeout, ring_delay,
<a name="l01578"></a>01578                   <a class="code" href="app__meetme_8c.html#a7fcb5686ee02006353e22f8c70dbcdef">sla_hold_str</a>(station-&gt;hold_access));
<a name="l01579"></a>01579       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l01580"></a>01580       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l01581"></a>01581          <span class="keywordflow">if</span> (trunk_ref-&gt;ring_timeout) {
<a name="l01582"></a>01582             snprintf(ring_timeout, <span class="keyword">sizeof</span>(ring_timeout),
<a name="l01583"></a>01583                <span class="stringliteral">&quot;%u&quot;</span>, trunk_ref-&gt;ring_timeout);
<a name="l01584"></a>01584          } <span class="keywordflow">else</span>
<a name="l01585"></a>01585             strcpy(ring_timeout, <span class="stringliteral">&quot;(none)&quot;</span>);
<a name="l01586"></a>01586          <span class="keywordflow">if</span> (trunk_ref-&gt;ring_delay) {
<a name="l01587"></a>01587             snprintf(ring_delay, <span class="keyword">sizeof</span>(ring_delay),
<a name="l01588"></a>01588                <span class="stringliteral">&quot;%u&quot;</span>, trunk_ref-&gt;ring_delay);
<a name="l01589"></a>01589          } <span class="keywordflow">else</span>
<a name="l01590"></a>01590             strcpy(ring_delay, <span class="stringliteral">&quot;(none)&quot;</span>);
<a name="l01591"></a>01591             <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;===    ==&gt; Trunk Name: %s\n&quot;</span>
<a name="l01592"></a>01592                      <span class="stringliteral">&quot;===       ==&gt; State:       %s\n&quot;</span>
<a name="l01593"></a>01593                      <span class="stringliteral">&quot;===       ==&gt; RingTimeout: %s\n&quot;</span>
<a name="l01594"></a>01594                      <span class="stringliteral">&quot;===       ==&gt; RingDelay:   %s\n&quot;</span>,
<a name="l01595"></a>01595                      trunk_ref-&gt;trunk-&gt;name,
<a name="l01596"></a>01596                      <a class="code" href="app__meetme_8c.html#adca22e29e840747e49e804c977f67386">trunkstate2str</a>(trunk_ref-&gt;state),
<a name="l01597"></a>01597                      ring_timeout, ring_delay);
<a name="l01598"></a>01598       }
<a name="l01599"></a>01599       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l01600"></a>01600       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;=== ---------------------------------------------------------\n&quot;</span>
<a name="l01601"></a>01601                   <span class="stringliteral">&quot;===\n&quot;</span>);
<a name="l01602"></a>01602    }
<a name="l01603"></a>01603    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l01604"></a>01604    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;============================================================\n&quot;</span>
<a name="l01605"></a>01605                <span class="stringliteral">&quot;\n&quot;</span>);
<a name="l01606"></a>01606 
<a name="l01607"></a>01607    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l01608"></a>01608 }
<a name="l01609"></a>01609 
<a name="l01610"></a><a class="code" href="app__meetme_8c.html#a31b7cf161faa4ea68f99829392d4b2fd">01610</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="app__meetme_8c.html#a31b7cf161faa4ea68f99829392d4b2fd">cli_meetme</a>[] = {
<a name="l01611"></a>01611    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__meetme_8c.html#ad9afdce96e1d514b69858b8a085b3b9e">meetme_cmd</a>, <span class="stringliteral">&quot;Execute a command on a conference or conferee&quot;</span>),
<a name="l01612"></a>01612    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__meetme_8c.html#a5f272b0802dbeb3b9592c16839e4a134">meetme_show_cmd</a>, <span class="stringliteral">&quot;List all or one conference&quot;</span>),
<a name="l01613"></a>01613    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__meetme_8c.html#a94cb635b9fb6a74e88b8b134ac5e23d5">sla_show_trunks</a>, <span class="stringliteral">&quot;Show SLA Trunks&quot;</span>),
<a name="l01614"></a>01614    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__meetme_8c.html#ac9396eafa98ce0ee732f0ea84aefaee4">sla_show_stations</a>, <span class="stringliteral">&quot;Show SLA Stations&quot;</span>),
<a name="l01615"></a>01615 };
<a name="l01616"></a>01616 
<a name="l01617"></a><a class="code" href="app__meetme_8c.html#a42bbab56ce6a8eb0aaf501be26cf5271">01617</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a42bbab56ce6a8eb0aaf501be26cf5271">conf_flush</a>(<span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01618"></a>01618 {
<a name="l01619"></a>01619    <span class="keywordtype">int</span> x;
<a name="l01620"></a>01620 
<a name="l01621"></a>01621    <span class="comment">/* read any frames that may be waiting on the channel</span>
<a name="l01622"></a>01622 <span class="comment">      and throw them away</span>
<a name="l01623"></a>01623 <span class="comment">   */</span>
<a name="l01624"></a>01624    <span class="keywordflow">if</span> (chan) {
<a name="l01625"></a>01625       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01626"></a>01626 
<a name="l01627"></a>01627       <span class="comment">/* when no frames are available, this will wait</span>
<a name="l01628"></a>01628 <span class="comment">         for 1 millisecond maximum</span>
<a name="l01629"></a>01629 <span class="comment">      */</span>
<a name="l01630"></a>01630       <span class="keywordflow">while</span> (<a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, 1)) {
<a name="l01631"></a>01631          f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan);
<a name="l01632"></a>01632          <span class="keywordflow">if</span> (f)
<a name="l01633"></a>01633             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l01634"></a>01634          <span class="keywordflow">else</span> <span class="comment">/* channel was hung up or something else happened */</span>
<a name="l01635"></a>01635             <span class="keywordflow">break</span>;
<a name="l01636"></a>01636       }
<a name="l01637"></a>01637    }
<a name="l01638"></a>01638 
<a name="l01639"></a>01639    <span class="comment">/* flush any data sitting in the pseudo channel */</span>
<a name="l01640"></a>01640    x = DAHDI_FLUSH_ALL;
<a name="l01641"></a>01641    <span class="keywordflow">if</span> (ioctl(fd, DAHDI_FLUSH, &amp;x))
<a name="l01642"></a>01642       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error flushing channel\n&quot;</span>);
<a name="l01643"></a>01643 
<a name="l01644"></a>01644 }
<a name="l01645"></a>01645 
<a name="l01646"></a>01646 <span class="comment">/* Remove the conference from the list and free it.</span>
<a name="l01647"></a>01647 <span class="comment">   We assume that this was called while holding conflock. */</span>
<a name="l01648"></a><a class="code" href="app__meetme_8c.html#a2acb14ff82a951501e9dbd8b700e8509">01648</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a2acb14ff82a951501e9dbd8b700e8509">conf_free</a>(<span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf)
<a name="l01649"></a>01649 {
<a name="l01650"></a>01650    <span class="keywordtype">int</span> x;
<a name="l01651"></a>01651    <span class="keyword">struct </span><a class="code" href="structannounce__listitem.html">announce_listitem</a> *item;
<a name="l01652"></a>01652    
<a name="l01653"></a>01653    <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;confs, conf, list);
<a name="l01654"></a>01654    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeEnd&quot;</span>, <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l01655"></a>01655 
<a name="l01656"></a>01656    <span class="keywordflow">if</span> (conf-&gt;recording == <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298aed2f74b0993cd2122169387b4ff74113">MEETME_RECORD_ACTIVE</a>) {
<a name="l01657"></a>01657       conf-&gt;recording = <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a79313598c5f4a645e3b006f59572a75d">MEETME_RECORD_TERMINATE</a>;
<a name="l01658"></a>01658       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01659"></a>01659       <span class="keywordflow">while</span> (1) {
<a name="l01660"></a>01660          usleep(1);
<a name="l01661"></a>01661          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01662"></a>01662          <span class="keywordflow">if</span> (conf-&gt;recording == <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a44a4c13334429a322cb3408ec48c1cfb">MEETME_RECORD_OFF</a>)
<a name="l01663"></a>01663             <span class="keywordflow">break</span>;
<a name="l01664"></a>01664          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01665"></a>01665       }
<a name="l01666"></a>01666    }
<a name="l01667"></a>01667 
<a name="l01668"></a>01668    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="app__meetme_8c.html#addd70c99776f00581f71a71d3c10d86f">AST_FRAME_BITS</a>; x++) {
<a name="l01669"></a>01669       <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[x])
<a name="l01670"></a>01670          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[x]);
<a name="l01671"></a>01671       <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[x])
<a name="l01672"></a>01672          <a class="code" href="translate_8h.html#a8f767bf5c2095f182e7cbaa73e391207" title="Frees a translator path Frees the given translator path structure.">ast_translator_free_path</a>(conf-&gt;<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[x]);
<a name="l01673"></a>01673    }
<a name="l01674"></a>01674    <span class="keywordflow">if</span> (conf-&gt;announcethread != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01675"></a>01675       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;announcelistlock);
<a name="l01676"></a>01676       conf-&gt;announcethread_stop = 1;
<a name="l01677"></a>01677       <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(conf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2b3b711afc65059c4b51008c9fbc7aee">AST_SOFTHANGUP_EXPLICIT</a>);
<a name="l01678"></a>01678       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;conf-&gt;announcelist_addition);
<a name="l01679"></a>01679       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;announcelistlock);
<a name="l01680"></a>01680       pthread_join(conf-&gt;announcethread, NULL);
<a name="l01681"></a>01681    
<a name="l01682"></a>01682       <span class="keywordflow">while</span> ((item = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;conf-&gt;announcelist, entry))) {
<a name="l01683"></a>01683          <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(item-&gt;namerecloc, NULL);
<a name="l01684"></a>01684          <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(item, -1);
<a name="l01685"></a>01685       }
<a name="l01686"></a>01686       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;conf-&gt;announcelistlock);
<a name="l01687"></a>01687    }
<a name="l01688"></a>01688    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>)
<a name="l01689"></a>01689       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(conf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>);
<a name="l01690"></a>01690    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>)
<a name="l01691"></a>01691       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>);
<a name="l01692"></a>01692    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l01693"></a>01693       <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(conf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l01694"></a>01694    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a> &gt;= 0)
<a name="l01695"></a>01695       close(conf-&gt;<a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>);
<a name="l01696"></a>01696    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>) {
<a name="l01697"></a>01697       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>);
<a name="l01698"></a>01698    }
<a name="l01699"></a>01699    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>) {
<a name="l01700"></a>01700       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(conf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>);
<a name="l01701"></a>01701    }
<a name="l01702"></a>01702    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l01703"></a>01703    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l01704"></a>01704    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a36b5e5ca449d5db4d505c5ceed207e3b">recordthreadlock</a>);
<a name="l01705"></a>01705    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;conf-&gt;announcethreadlock);
<a name="l01706"></a>01706    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(conf);
<a name="l01707"></a>01707 
<a name="l01708"></a>01708    <span class="keywordflow">return</span> 0;
<a name="l01709"></a>01709 }
<a name="l01710"></a>01710 
<a name="l01711"></a><a class="code" href="app__meetme_8c.html#ada5e10a4d240af38d13e13d576b66f4a">01711</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#ada5e10a4d240af38d13e13d576b66f4a">conf_queue_dtmf</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf,
<a name="l01712"></a>01712    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *sender, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l01713"></a>01713 {
<a name="l01714"></a>01714    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l01715"></a>01715 
<a name="l01716"></a>01716    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conf-&gt;userlist, user, list) {
<a name="l01717"></a>01717       <span class="keywordflow">if</span> (user == sender)
<a name="l01718"></a>01718          <span class="keywordflow">continue</span>;
<a name="l01719"></a>01719       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, f) &lt; 0)
<a name="l01720"></a>01720          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error writing frame to channel %s\n&quot;</span>, user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name);
<a name="l01721"></a>01721    }
<a name="l01722"></a>01722 }
<a name="l01723"></a>01723 
<a name="l01724"></a><a class="code" href="app__meetme_8c.html#a4178d3abb2ecba4c119838052829dd94">01724</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a4178d3abb2ecba4c119838052829dd94">sla_queue_event_full</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a" title="Event types that can be queued up for the SLA thread.">sla_event_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, 
<a name="l01725"></a>01725    <span class="keyword">struct</span> <a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref, <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station, <span class="keywordtype">int</span> lock)
<a name="l01726"></a>01726 {
<a name="l01727"></a>01727    <span class="keyword">struct </span><a class="code" href="structsla__event.html">sla_event</a> *event;
<a name="l01728"></a>01728 
<a name="l01729"></a>01729    <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.thread == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l01730"></a>01730       <span class="keywordflow">return</span>;
<a name="l01731"></a>01731    }
<a name="l01732"></a>01732 
<a name="l01733"></a>01733    <span class="keywordflow">if</span> (!(event = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*event))))
<a name="l01734"></a>01734       <span class="keywordflow">return</span>;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736    <span class="keyword">event</span>-&gt;type = type;
<a name="l01737"></a>01737    <span class="keyword">event</span>-&gt;trunk_ref = trunk_ref;
<a name="l01738"></a>01738    <span class="keyword">event</span>-&gt;station = station;
<a name="l01739"></a>01739 
<a name="l01740"></a>01740    <span class="keywordflow">if</span> (!lock) {
<a name="l01741"></a>01741       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.event_q, event, entry);
<a name="l01742"></a>01742       <span class="keywordflow">return</span>;
<a name="l01743"></a>01743    }
<a name="l01744"></a>01744 
<a name="l01745"></a>01745    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l01746"></a>01746    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.event_q, event, entry);
<a name="l01747"></a>01747    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.cond);
<a name="l01748"></a>01748    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l01749"></a>01749 }
<a name="l01750"></a>01750 
<a name="l01751"></a><a class="code" href="app__meetme_8c.html#a45318e8513f0ffb15b49943c18ea0e58">01751</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a45318e8513f0ffb15b49943c18ea0e58">sla_queue_event_nolock</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a" title="Event types that can be queued up for the SLA thread.">sla_event_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l01752"></a>01752 {
<a name="l01753"></a>01753    <a class="code" href="app__meetme_8c.html#a4178d3abb2ecba4c119838052829dd94">sla_queue_event_full</a>(type, NULL, NULL, 0);
<a name="l01754"></a>01754 }
<a name="l01755"></a>01755 
<a name="l01756"></a><a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">01756</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a" title="Event types that can be queued up for the SLA thread.">sla_event_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l01757"></a>01757 {
<a name="l01758"></a>01758    <a class="code" href="app__meetme_8c.html#a4178d3abb2ecba4c119838052829dd94">sla_queue_event_full</a>(type, NULL, NULL, 1);
<a name="l01759"></a>01759 }
<a name="l01760"></a>01760 <span class="comment"></span>
<a name="l01761"></a>01761 <span class="comment">/*! \brief Queue a SLA event from the conference */</span>
<a name="l01762"></a><a class="code" href="app__meetme_8c.html#a5e80b8d035834753764ad2be58e4bb07">01762</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a5e80b8d035834753764ad2be58e4bb07" title="Queue a SLA event from the conference.">sla_queue_event_conf</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261a" title="Event types that can be queued up for the SLA thread.">sla_event_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>,
<a name="l01763"></a>01763    <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf)
<a name="l01764"></a>01764 {
<a name="l01765"></a>01765    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l01766"></a>01766    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref = NULL;
<a name="l01767"></a>01767    <span class="keywordtype">char</span> *trunk_name;
<a name="l01768"></a>01768 
<a name="l01769"></a>01769    trunk_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l01770"></a>01770    <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;trunk_name, <span class="stringliteral">&quot;_&quot;</span>);
<a name="l01771"></a>01771    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk_name)) {
<a name="l01772"></a>01772       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid conference name for SLA - &apos;%s&apos;!\n&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l01773"></a>01773       <span class="keywordflow">return</span>;
<a name="l01774"></a>01774    }
<a name="l01775"></a>01775 
<a name="l01776"></a>01776    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_stations);
<a name="l01777"></a>01777    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l01778"></a>01778       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l01779"></a>01779          <span class="keywordflow">if</span> (trunk_ref-&gt;chan == chan &amp;&amp; !strcmp(trunk_ref-&gt;trunk-&gt;name, trunk_name))
<a name="l01780"></a>01780             <span class="keywordflow">break</span>;
<a name="l01781"></a>01781       }
<a name="l01782"></a>01782       <span class="keywordflow">if</span> (trunk_ref)
<a name="l01783"></a>01783          <span class="keywordflow">break</span>;
<a name="l01784"></a>01784    }
<a name="l01785"></a>01785    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l01786"></a>01786 
<a name="l01787"></a>01787    <span class="keywordflow">if</span> (!trunk_ref) {
<a name="l01788"></a>01788       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Trunk not found for event!\n&quot;</span>);
<a name="l01789"></a>01789       <span class="keywordflow">return</span>;
<a name="l01790"></a>01790    }
<a name="l01791"></a>01791 
<a name="l01792"></a>01792    <a class="code" href="app__meetme_8c.html#a4178d3abb2ecba4c119838052829dd94">sla_queue_event_full</a>(type, trunk_ref, station, 1);
<a name="l01793"></a>01793 }
<a name="l01794"></a>01794 
<a name="l01795"></a>01795 <span class="comment">/* Decrement reference counts, as incremented by find_conf() */</span>
<a name="l01796"></a><a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">01796</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(<span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf)
<a name="l01797"></a>01797 {
<a name="l01798"></a>01798    <span class="keywordtype">int</span> res = 0;
<a name="l01799"></a>01799    <span class="keywordtype">int</span> confno_int = 0;
<a name="l01800"></a>01800 
<a name="l01801"></a>01801    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l01802"></a>01802    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ac0907a45f05d85848a4f7d5990a4d244" title="decrement *p by 1 and return true if the variable has reached 0. Useful e.g. to check...">ast_atomic_dec_and_test</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>)) {
<a name="l01803"></a>01803       <span class="comment">/* Take the conference room number out of an inuse state */</span>
<a name="l01804"></a>01804       <span class="keywordflow">if</span> ((sscanf(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="stringliteral">&quot;%4d&quot;</span>, &amp;confno_int) == 1) &amp;&amp; (confno_int &gt;= 0 &amp;&amp; confno_int &lt; 1024)) {
<a name="l01805"></a>01805          <a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">conf_map</a>[confno_int] = 0;
<a name="l01806"></a>01806       }
<a name="l01807"></a>01807       <a class="code" href="app__meetme_8c.html#a2acb14ff82a951501e9dbd8b700e8509">conf_free</a>(conf);
<a name="l01808"></a>01808       res = 1;
<a name="l01809"></a>01809    }
<a name="l01810"></a>01810    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l01811"></a>01811 
<a name="l01812"></a>01812    <span class="keywordflow">return</span> res;
<a name="l01813"></a>01813 }
<a name="l01814"></a>01814 
<a name="l01815"></a><a class="code" href="app__meetme_8c.html#ab44c6c825cc90e2059d766b860234708">01815</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ab44c6c825cc90e2059d766b860234708">rt_extend_conf</a>(<span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)
<a name="l01816"></a>01816 {
<a name="l01817"></a>01817    <span class="keywordtype">char</span> currenttime[32];
<a name="l01818"></a>01818    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a>[32];
<a name="l01819"></a>01819    <span class="keyword">struct </span>timeval now;
<a name="l01820"></a>01820    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l01821"></a>01821    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *orig_var;
<a name="l01822"></a>01822    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a9c9fece27d0906bb0c5e522e26c92d7f">bookid</a>[51];
<a name="l01823"></a>01823 
<a name="l01824"></a>01824    <span class="keywordflow">if</span> (!extendby) {
<a name="l01825"></a>01825       <span class="keywordflow">return</span> 0;
<a name="l01826"></a>01826    }
<a name="l01827"></a>01827 
<a name="l01828"></a>01828    now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l01829"></a>01829 
<a name="l01830"></a>01830    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l01831"></a>01831    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(currenttime, <span class="keyword">sizeof</span>(currenttime), <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;tm);
<a name="l01832"></a>01832 
<a name="l01833"></a>01833    var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>,
<a name="l01834"></a>01834       confno, <span class="stringliteral">&quot;startTime&lt;= &quot;</span>, currenttime,
<a name="l01835"></a>01835       <span class="stringliteral">&quot;endtime&gt;= &quot;</span>, currenttime, NULL);
<a name="l01836"></a>01836 
<a name="l01837"></a>01837    orig_var = var;
<a name="l01838"></a>01838 
<a name="l01839"></a>01839    <span class="comment">/* Identify the specific RealTime conference */</span>
<a name="l01840"></a>01840    <span class="keywordflow">while</span> (var) {
<a name="l01841"></a>01841       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bookid&quot;</span>)) {
<a name="l01842"></a>01842          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bookid, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(bookid));
<a name="l01843"></a>01843       }
<a name="l01844"></a>01844       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;endtime&quot;</span>)) {
<a name="l01845"></a>01845          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(endtime, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(endtime));
<a name="l01846"></a>01846       }
<a name="l01847"></a>01847 
<a name="l01848"></a>01848       var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l01849"></a>01849    }
<a name="l01850"></a>01850    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(orig_var);
<a name="l01851"></a>01851 
<a name="l01852"></a>01852    <a class="code" href="localtime_8h.html#a3eb2c73accce1b149ce597de80d1677a" title="Special version of strptime(3) which places the answer in the common structure ast_tm...">ast_strptime</a>(endtime, <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;tm);
<a name="l01853"></a>01853    now = <a class="code" href="localtime_8h.html#ae0843e4dbbd1fed36d2676dda58e0c44" title="Timezone-independent version of mktime(3).">ast_mktime</a>(&amp;tm, NULL);
<a name="l01854"></a>01854 
<a name="l01855"></a>01855    now.tv_sec += extendby;
<a name="l01856"></a>01856 
<a name="l01857"></a>01857    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l01858"></a>01858    <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(currenttime, <span class="keyword">sizeof</span>(currenttime), <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;tm);
<a name="l01859"></a>01859    strcat(currenttime, <span class="stringliteral">&quot;0&quot;</span>); <span class="comment">/* Seconds needs to be 00 */</span>
<a name="l01860"></a>01860 
<a name="l01861"></a>01861    var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>,
<a name="l01862"></a>01862       confno, <span class="stringliteral">&quot;startTime&lt;= &quot;</span>, currenttime,
<a name="l01863"></a>01863       <span class="stringliteral">&quot;endtime&gt;= &quot;</span>, currenttime, NULL);
<a name="l01864"></a>01864 
<a name="l01865"></a>01865    <span class="comment">/* If there is no conflict with extending the conference, update the DB */</span>
<a name="l01866"></a>01866    <span class="keywordflow">if</span> (!var) {
<a name="l01867"></a>01867       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Trying to update the endtime of Conference %s to %s\n&quot;</span>, confno, currenttime);
<a name="l01868"></a>01868       <a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;bookid&quot;</span>, bookid, <span class="stringliteral">&quot;endtime&quot;</span>, currenttime, NULL);
<a name="l01869"></a>01869       <span class="keywordflow">return</span> 0;
<a name="l01870"></a>01870 
<a name="l01871"></a>01871    }
<a name="l01872"></a>01872 
<a name="l01873"></a>01873    <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l01874"></a>01874    <span class="keywordflow">return</span> -1;
<a name="l01875"></a>01875 }
<a name="l01876"></a>01876 
<a name="l01877"></a><a class="code" href="app__meetme_8c.html#a5ab93ee8a01e294aa904de5413d78601">01877</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a5ab93ee8a01e294aa904de5413d78601">conf_start_moh</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#abc34958c9b03014779727e5ca61b93e5">musicclass</a>)
<a name="l01878"></a>01878 {
<a name="l01879"></a>01879    <span class="keywordtype">char</span> *original_moh;
<a name="l01880"></a>01880 
<a name="l01881"></a>01881    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01882"></a>01882    original_moh = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(chan-&gt;musicclass);
<a name="l01883"></a>01883    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan, musicclass, musicclass);
<a name="l01884"></a>01884    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01885"></a>01885 
<a name="l01886"></a>01886    <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, original_moh, NULL);
<a name="l01887"></a>01887 
<a name="l01888"></a>01888    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01889"></a>01889    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(chan, musicclass, original_moh);
<a name="l01890"></a>01890    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01891"></a>01891 }
<a name="l01892"></a>01892 
<a name="l01893"></a><a class="code" href="app__meetme_8c.html#add1f426b8d82cf993d8167e21de8319b">01893</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__meetme_8c.html#add1f426b8d82cf993d8167e21de8319b">get_announce_filename</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bf">announcetypes</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l01894"></a>01894 {
<a name="l01895"></a>01895    <span class="keywordflow">switch</span> (type) {
<a name="l01896"></a>01896    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfafe977bca19aa4a5f72ff226a312b74af">CONF_HASLEFT</a>:
<a name="l01897"></a>01897       <span class="keywordflow">return</span> <span class="stringliteral">&quot;conf-hasleft&quot;</span>;
<a name="l01898"></a>01898       <span class="keywordflow">break</span>;
<a name="l01899"></a>01899    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfa7a2844a08140930251b7a890184cf1f1">CONF_HASJOIN</a>:
<a name="l01900"></a>01900       <span class="keywordflow">return</span> <span class="stringliteral">&quot;conf-hasjoin&quot;</span>;
<a name="l01901"></a>01901       <span class="keywordflow">break</span>;
<a name="l01902"></a>01902    <span class="keywordflow">default</span>:
<a name="l01903"></a>01903       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01904"></a>01904    }
<a name="l01905"></a>01905 }
<a name="l01906"></a>01906 
<a name="l01907"></a><a class="code" href="app__meetme_8c.html#a17b11cfe0e59eab973dd6aa57de91f8b">01907</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app__meetme_8c.html#a17b11cfe0e59eab973dd6aa57de91f8b">announce_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l01908"></a>01908 {
<a name="l01909"></a>01909    <span class="keyword">struct </span><a class="code" href="structannounce__listitem.html">announce_listitem</a> *current;
<a name="l01910"></a>01910    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf = data;
<a name="l01911"></a>01911    <span class="keywordtype">int</span> res;
<a name="l01912"></a>01912    <span class="keywordtype">char</span> filename[PATH_MAX] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l01913"></a>01913    <a class="code" href="linkedlists_8h.html#a117cbef6a40010cd3c84a16fd9ef4ca6" title="Defines a structure to be used to hold a list of specified type (with no lock).">AST_LIST_HEAD_NOLOCK</a>(, <a class="code" href="structannounce__listitem.html">announce_listitem</a>) local_list;
<a name="l01914"></a>01914    <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;local_list);
<a name="l01915"></a>01915 
<a name="l01916"></a>01916    <span class="keywordflow">while</span> (!conf-&gt;announcethread_stop) {
<a name="l01917"></a>01917       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;announcelistlock);
<a name="l01918"></a>01918       <span class="keywordflow">if</span> (conf-&gt;announcethread_stop) {
<a name="l01919"></a>01919          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;announcelistlock);
<a name="l01920"></a>01920          <span class="keywordflow">break</span>;
<a name="l01921"></a>01921       }
<a name="l01922"></a>01922       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;conf-&gt;announcelist))
<a name="l01923"></a>01923          <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;conf-&gt;announcelist_addition, &amp;conf-&gt;announcelistlock);
<a name="l01924"></a>01924 
<a name="l01925"></a>01925       <a class="code" href="linkedlists_8h.html#ad66405f1d0b9e1fb484643d9a36e94ed" title="Appends a whole list to the tail of a list.">AST_LIST_APPEND_LIST</a>(&amp;local_list, &amp;conf-&gt;announcelist, entry);
<a name="l01926"></a>01926       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;conf-&gt;announcelist);
<a name="l01927"></a>01927 
<a name="l01928"></a>01928       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;announcelistlock);
<a name="l01929"></a>01929       <span class="keywordflow">if</span> (conf-&gt;announcethread_stop) {
<a name="l01930"></a>01930          <span class="keywordflow">break</span>;
<a name="l01931"></a>01931       }
<a name="l01932"></a>01932 
<a name="l01933"></a>01933       <span class="keywordflow">for</span> (res = 1; !conf-&gt;announcethread_stop &amp;&amp; (current = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;local_list, entry)); <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(current, -1)) {
<a name="l01934"></a>01934          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;About to play %s\n&quot;</span>, current-&gt;namerecloc);
<a name="l01935"></a>01935          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#ab9b8ab8e5ee34c9b4da25779255cafde" title="Checks for the existence of a given file.">ast_fileexists</a>(current-&gt;namerecloc, NULL, NULL))
<a name="l01936"></a>01936             <span class="keywordflow">continue</span>;
<a name="l01937"></a>01937          <span class="keywordflow">if</span> ((current-&gt;confchan) &amp;&amp; (current-&gt;confusers &gt; 1) &amp;&amp; !<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(current-&gt;confchan)) {
<a name="l01938"></a>01938             <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(current-&gt;confchan, current-&gt;namerecloc, current-&gt;language))
<a name="l01939"></a>01939                res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(current-&gt;confchan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01940"></a>01940             <span class="keywordflow">if</span> (!res) {
<a name="l01941"></a>01941                <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(filename, <a class="code" href="app__meetme_8c.html#add1f426b8d82cf993d8167e21de8319b">get_announce_filename</a>(current-&gt;announcetype), <span class="keyword">sizeof</span>(filename));
<a name="l01942"></a>01942                <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(current-&gt;confchan, filename, current-&gt;language))
<a name="l01943"></a>01943                   <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(current-&gt;confchan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l01944"></a>01944             }
<a name="l01945"></a>01945          }
<a name="l01946"></a>01946          <span class="keywordflow">if</span> (current-&gt;announcetype == <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfafe977bca19aa4a5f72ff226a312b74af">CONF_HASLEFT</a>) {
<a name="l01947"></a>01947             <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(current-&gt;namerecloc, NULL);
<a name="l01948"></a>01948          }
<a name="l01949"></a>01949       }
<a name="l01950"></a>01950    }
<a name="l01951"></a>01951 
<a name="l01952"></a>01952    <span class="comment">/* thread marked to stop, clean up */</span>
<a name="l01953"></a>01953    <span class="keywordflow">while</span> ((current = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;local_list, entry))) {
<a name="l01954"></a>01954       <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(current-&gt;namerecloc, NULL);
<a name="l01955"></a>01955       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(current, -1);
<a name="l01956"></a>01956    }
<a name="l01957"></a>01957    <span class="keywordflow">return</span> NULL;
<a name="l01958"></a>01958 }
<a name="l01959"></a>01959 
<a name="l01960"></a><a class="code" href="app__meetme_8c.html#af7d45bcfd15042438edda998fb3ebf67">01960</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#af7d45bcfd15042438edda998fb3ebf67">can_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">int</span> confflags)
<a name="l01961"></a>01961 {
<a name="l01962"></a>01962    <span class="keywordflow">if</span> (!(confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac13efb0951d66c6cee3936d4a48d2107">CONFFLAG_NO_AUDIO_UNTIL_UP</a>)) {
<a name="l01963"></a>01963       <span class="keywordflow">return</span> 1;
<a name="l01964"></a>01964    }
<a name="l01965"></a>01965 
<a name="l01966"></a>01966    <span class="keywordflow">return</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> == <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>);
<a name="l01967"></a>01967 }
<a name="l01968"></a>01968 
<a name="l01969"></a><a class="code" href="app__meetme_8c.html#a755b9d1d1758de8ecd6c1acb1369f4ba">01969</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a755b9d1d1758de8ecd6c1acb1369f4ba">send_talking_event</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf, <span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">int</span> talking)
<a name="l01970"></a>01970 {
<a name="l01971"></a>01971    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeTalking&quot;</span>,
<a name="l01972"></a>01972          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l01973"></a>01973          <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l01974"></a>01974          <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l01975"></a>01975          <span class="stringliteral">&quot;Usernum: %d\r\n&quot;</span>
<a name="l01976"></a>01976          <span class="stringliteral">&quot;Status: %s\r\n&quot;</span>,
<a name="l01977"></a>01977          chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>, talking ? <span class="stringliteral">&quot;on&quot;</span> : <span class="stringliteral">&quot;off&quot;</span>);
<a name="l01978"></a>01978 }
<a name="l01979"></a>01979 
<a name="l01980"></a><a class="code" href="app__meetme_8c.html#ae1a11424819b90f48a2f8817af8681cd">01980</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#ae1a11424819b90f48a2f8817af8681cd">set_user_talking</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf, <span class="keyword">struct</span> <a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>, <span class="keywordtype">int</span> talking, <span class="keywordtype">int</span> <a class="code" href="chan__phone_8c.html#a4e40373706bcf5cdb9409dac3166d280">monitor</a>)
<a name="l01981"></a>01981 {
<a name="l01982"></a>01982    <span class="keywordtype">int</span> last_talking = user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a>;
<a name="l01983"></a>01983    <span class="keywordflow">if</span> (last_talking == talking)
<a name="l01984"></a>01984       <span class="keywordflow">return</span>;
<a name="l01985"></a>01985 
<a name="l01986"></a>01986    user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> = talking;
<a name="l01987"></a>01987 
<a name="l01988"></a>01988    <span class="keywordflow">if</span> (monitor) {
<a name="l01989"></a>01989       <span class="comment">/* Check if talking state changed. Take care of -1 which means unmonitored */</span>
<a name="l01990"></a>01990       <span class="keywordtype">int</span> was_talking = (last_talking &gt; 0);
<a name="l01991"></a>01991       <span class="keywordtype">int</span> now_talking = (talking &gt; 0);
<a name="l01992"></a>01992       <span class="keywordflow">if</span> (was_talking != now_talking) {
<a name="l01993"></a>01993          <a class="code" href="app__meetme_8c.html#a755b9d1d1758de8ecd6c1acb1369f4ba">send_talking_event</a>(chan, conf, user, now_talking);
<a name="l01994"></a>01994       }
<a name="l01995"></a>01995    }
<a name="l01996"></a>01996 }
<a name="l01997"></a>01997 
<a name="l01998"></a><a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">01998</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf, <span class="keywordtype">int</span> confflags, <span class="keywordtype">char</span> *optargs[])
<a name="l01999"></a>01999 {
<a name="l02000"></a>02000    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l02001"></a>02001    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *usr = NULL;
<a name="l02002"></a>02002    <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6f8059414f0228f0256115e024eeed4b">fd</a>;
<a name="l02003"></a>02003    <span class="keyword">struct </span>dahdi_confinfo dahdic, dahdic_empty;
<a name="l02004"></a>02004    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l02005"></a>02005    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c;
<a name="l02006"></a>02006    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> fr;
<a name="l02007"></a>02007    <span class="keywordtype">int</span> outfd;
<a name="l02008"></a>02008    <span class="keywordtype">int</span> ms;
<a name="l02009"></a>02009    <span class="keywordtype">int</span> nfds;
<a name="l02010"></a>02010    <span class="keywordtype">int</span> res;
<a name="l02011"></a>02011    <span class="keywordtype">int</span> retrydahdi;
<a name="l02012"></a>02012    <span class="keywordtype">int</span> origfd;
<a name="l02013"></a>02013    <span class="keywordtype">int</span> musiconhold = 0, mohtempstopped = 0;
<a name="l02014"></a>02014    <span class="keywordtype">int</span> firstpass = 0;
<a name="l02015"></a>02015    <span class="keywordtype">int</span> lastmarked = 0;
<a name="l02016"></a>02016    <span class="keywordtype">int</span> currentmarked = 0;
<a name="l02017"></a>02017    <span class="keywordtype">int</span> ret = -1;
<a name="l02018"></a>02018    <span class="keywordtype">int</span> x;
<a name="l02019"></a>02019    <span class="keywordtype">int</span> menu_active = 0;
<a name="l02020"></a>02020    <span class="keywordtype">int</span> talkreq_manager = 0;
<a name="l02021"></a>02021    <span class="keywordtype">int</span> using_pseudo = 0;
<a name="l02022"></a>02022    <span class="keywordtype">int</span> duration = 20;
<a name="l02023"></a>02023    <span class="keywordtype">int</span> hr, min, <a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>;
<a name="l02024"></a>02024    <span class="keywordtype">int</span> sent_event = 0;
<a name="l02025"></a>02025    <span class="keywordtype">int</span> checked = 0;
<a name="l02026"></a>02026    <span class="keywordtype">int</span> announcement_played = 0;
<a name="l02027"></a>02027    <span class="keyword">struct </span>timeval now;
<a name="l02028"></a>02028    <span class="keyword">struct </span><a class="code" href="structast__dsp.html">ast_dsp</a> *dsp = NULL;
<a name="l02029"></a>02029    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *agi_app;
<a name="l02030"></a>02030    <span class="keywordtype">char</span> *agifile;
<a name="l02031"></a>02031    <span class="keyword">const</span> <span class="keywordtype">char</span> *agifiledefault = <span class="stringliteral">&quot;conf-background.agi&quot;</span>, *tmpvar;
<a name="l02032"></a>02032    <span class="keywordtype">char</span> meetmesecs[30] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02033"></a>02033    <span class="keywordtype">char</span> <a class="code" href="app__voicemail_8c.html#ae6cb2a817afda0bf313344240f1eacda">exitcontext</a>[<a class="code" href="channel_8h.html#abcf1aea85b924e9cd605040b86241e2a">AST_MAX_CONTEXT</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02034"></a>02034    <span class="keywordtype">char</span> recordingtmp[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02035"></a>02035    <span class="keywordtype">char</span> members[10] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02036"></a>02036    <span class="keywordtype">int</span> dtmf, opt_waitmarked_timeout = 0;
<a name="l02037"></a>02037    time_t timeout = 0;
<a name="l02038"></a>02038    <span class="keyword">struct </span>dahdi_bufferinfo bi;
<a name="l02039"></a>02039    <span class="keywordtype">char</span> __buf[<a class="code" href="app__dahdibarge_8c.html#a2be5f0b8c25b67aa5ca5502d61c16b73">CONF_SIZE</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>];
<a name="l02040"></a>02040    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a> = __buf + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l02041"></a>02041    <span class="keywordtype">char</span> *exitkeys = NULL;
<a name="l02042"></a>02042    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> calldurationlimit = 0;
<a name="l02043"></a>02043    <span class="keywordtype">long</span> timelimit = 0;
<a name="l02044"></a>02044    <span class="keywordtype">long</span> play_warning = 0;
<a name="l02045"></a>02045    <span class="keywordtype">long</span> warning_freq = 0;
<a name="l02046"></a>02046    <span class="keyword">const</span> <span class="keywordtype">char</span> *warning_sound = NULL;
<a name="l02047"></a>02047    <span class="keyword">const</span> <span class="keywordtype">char</span> *end_sound = NULL;
<a name="l02048"></a>02048    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;   
<a name="l02049"></a>02049    <span class="keywordtype">long</span> time_left_ms = 0;
<a name="l02050"></a>02050    <span class="keyword">struct </span>timeval nexteventts = { 0, };
<a name="l02051"></a>02051    <span class="keywordtype">int</span> to;
<a name="l02052"></a>02052    <span class="keywordtype">int</span> setusercount = 0;
<a name="l02053"></a>02053    <span class="keywordtype">int</span> confsilence = 0, totalsilence = 0;
<a name="l02054"></a>02054 
<a name="l02055"></a>02055    <span class="keywordflow">if</span> (!(user = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*user))))
<a name="l02056"></a>02056       <span class="keywordflow">return</span> ret;
<a name="l02057"></a>02057 
<a name="l02058"></a>02058    <span class="comment">/* Possible timeout waiting for marked user */</span>
<a name="l02059"></a>02059    <span class="keywordflow">if</span> ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a6bc154143d10b63764f073b756dbdb4a">CONFFLAG_WAITMARKED</a>) &amp;&amp;
<a name="l02060"></a>02060       !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(optargs[<a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9abfe6814e02021fa3fde4e9dd602d110b">OPT_ARG_WAITMARKED</a>]) &amp;&amp;
<a name="l02061"></a>02061       (sscanf(optargs[OPT_ARG_WAITMARKED], <span class="stringliteral">&quot;%30d&quot;</span>, &amp;opt_waitmarked_timeout) == 1) &amp;&amp;
<a name="l02062"></a>02062       (opt_waitmarked_timeout &gt; 0)) {
<a name="l02063"></a>02063       timeout = time(NULL) + opt_waitmarked_timeout;
<a name="l02064"></a>02064    }
<a name="l02065"></a>02065       
<a name="l02066"></a>02066    <span class="keywordflow">if</span> ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8626cc2dc0a4e9e97be85ecd0ebaef15">CONFFLAG_DURATION_STOP</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(optargs[<a class="code" href="app__dial_8c.html#abed82baf7f470b522273a3e37c24c600a22d5403ad37aee04f7beb26b97518b33">OPT_ARG_DURATION_STOP</a>])) {
<a name="l02067"></a>02067       calldurationlimit = atoi(optargs[OPT_ARG_DURATION_STOP]);
<a name="l02068"></a>02068       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Setting call duration limit to %d seconds.\n&quot;</span>, calldurationlimit);
<a name="l02069"></a>02069    }
<a name="l02070"></a>02070    
<a name="l02071"></a>02071    <span class="keywordflow">if</span> ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a67bec58b805ac5d933829e8a28fa89e6">CONFFLAG_DURATION_LIMIT</a>) &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(optargs[<a class="code" href="app__dial_8c.html#abed82baf7f470b522273a3e37c24c600ab92f4dda872862b445c7ee78b5eca872">OPT_ARG_DURATION_LIMIT</a>])) {
<a name="l02072"></a>02072       <span class="keywordtype">char</span> *limit_str, *warning_str, *warnfreq_str;
<a name="l02073"></a>02073       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l02074"></a>02074  
<a name="l02075"></a>02075       parse = optargs[OPT_ARG_DURATION_LIMIT];
<a name="l02076"></a>02076       limit_str = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;parse, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l02077"></a>02077       warning_str = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;parse, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l02078"></a>02078       warnfreq_str = parse;
<a name="l02079"></a>02079  
<a name="l02080"></a>02080       timelimit = atol(limit_str);
<a name="l02081"></a>02081       <span class="keywordflow">if</span> (warning_str)
<a name="l02082"></a>02082          play_warning = atol(warning_str);
<a name="l02083"></a>02083       <span class="keywordflow">if</span> (warnfreq_str)
<a name="l02084"></a>02084          warning_freq = atol(warnfreq_str);
<a name="l02085"></a>02085  
<a name="l02086"></a>02086       <span class="keywordflow">if</span> (!timelimit) {
<a name="l02087"></a>02087          timelimit = play_warning = warning_freq = 0;
<a name="l02088"></a>02088          warning_sound = NULL;
<a name="l02089"></a>02089       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (play_warning &gt; timelimit) {       
<a name="l02090"></a>02090          <span class="keywordflow">if</span> (!warning_freq) {
<a name="l02091"></a>02091             play_warning = 0;
<a name="l02092"></a>02092          } <span class="keywordflow">else</span> {
<a name="l02093"></a>02093             <span class="keywordflow">while</span> (play_warning &gt; timelimit)
<a name="l02094"></a>02094                play_warning -= warning_freq;
<a name="l02095"></a>02095             <span class="keywordflow">if</span> (play_warning &lt; 1)
<a name="l02096"></a>02096                play_warning = warning_freq = 0;
<a name="l02097"></a>02097          }
<a name="l02098"></a>02098       }
<a name="l02099"></a>02099       
<a name="l02100"></a>02100       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02101"></a>02101       <span class="keywordflow">if</span> ((var = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;CONF_LIMIT_WARNING_FILE&quot;</span>))) {
<a name="l02102"></a>02102          var = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var);
<a name="l02103"></a>02103       }
<a name="l02104"></a>02104       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02105"></a>02105 
<a name="l02106"></a>02106       warning_sound = var ? var : <span class="stringliteral">&quot;timeleft&quot;</span>;
<a name="l02107"></a>02107       
<a name="l02108"></a>02108       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02109"></a>02109       <span class="keywordflow">if</span> ((var = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;CONF_LIMIT_TIMEOUT_FILE&quot;</span>))) {
<a name="l02110"></a>02110          var = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var);
<a name="l02111"></a>02111       }
<a name="l02112"></a>02112       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02113"></a>02113       
<a name="l02114"></a>02114       end_sound = var ? var : NULL;
<a name="l02115"></a>02115          
<a name="l02116"></a>02116       <span class="comment">/* undo effect of S(x) in case they are both used */</span>
<a name="l02117"></a>02117       calldurationlimit = 0;
<a name="l02118"></a>02118       <span class="comment">/* more efficient do it like S(x) does since no advanced opts */</span>
<a name="l02119"></a>02119       <span class="keywordflow">if</span> (!play_warning &amp;&amp; !end_sound &amp;&amp; timelimit) { 
<a name="l02120"></a>02120          calldurationlimit = timelimit / 1000;
<a name="l02121"></a>02121          timelimit = play_warning = warning_freq = 0;
<a name="l02122"></a>02122       } <span class="keywordflow">else</span> {
<a name="l02123"></a>02123          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Limit Data for this call:\n&quot;</span>);
<a name="l02124"></a>02124          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;- timelimit     = %ld\n&quot;</span>, timelimit);
<a name="l02125"></a>02125          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;- play_warning  = %ld\n&quot;</span>, play_warning);
<a name="l02126"></a>02126          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;- warning_freq  = %ld\n&quot;</span>, warning_freq);
<a name="l02127"></a>02127          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;- warning_sound = %s\n&quot;</span>, warning_sound ? warning_sound : <span class="stringliteral">&quot;UNDEF&quot;</span>);
<a name="l02128"></a>02128          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;- end_sound     = %s\n&quot;</span>, end_sound ? end_sound : <span class="stringliteral">&quot;UNDEF&quot;</span>);
<a name="l02129"></a>02129       }
<a name="l02130"></a>02130    }
<a name="l02131"></a>02131 
<a name="l02132"></a>02132    <span class="comment">/* Get exit keys */</span>
<a name="l02133"></a>02133    <span class="keywordflow">if</span> ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aeae3eb825018940e6703d8151f1f20d5">CONFFLAG_KEYEXIT</a>)) {
<a name="l02134"></a>02134       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(optargs[<a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a95e81c82fdf625d648da836620d15dca">OPT_ARG_EXITKEYS</a>]))
<a name="l02135"></a>02135          exitkeys = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(optargs[OPT_ARG_EXITKEYS]);
<a name="l02136"></a>02136       <span class="keywordflow">else</span>
<a name="l02137"></a>02137          exitkeys = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<span class="stringliteral">&quot;#&quot;</span>); <span class="comment">/* Default */</span>
<a name="l02138"></a>02138    }
<a name="l02139"></a>02139    
<a name="l02140"></a>02140    <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a>) {
<a name="l02141"></a>02141       <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>) {
<a name="l02142"></a>02142          <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l02143"></a>02143          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02144"></a>02144          <span class="keywordflow">if</span> ((var = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_RECORDINGFILE&quot;</span>))) {
<a name="l02145"></a>02145             conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(var);
<a name="l02146"></a>02146          }
<a name="l02147"></a>02147          <span class="keywordflow">if</span> ((var = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_RECORDINGFORMAT&quot;</span>))) {
<a name="l02148"></a>02148             conf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(var);
<a name="l02149"></a>02149          }
<a name="l02150"></a>02150          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02151"></a>02151          <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>) {
<a name="l02152"></a>02152             snprintf(recordingtmp, <span class="keyword">sizeof</span>(recordingtmp), <span class="stringliteral">&quot;meetme-conf-rec-%s-%s&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, chan-&gt;uniqueid);
<a name="l02153"></a>02153             conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(recordingtmp);
<a name="l02154"></a>02154          }
<a name="l02155"></a>02155          <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>) {
<a name="l02156"></a>02156             conf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;wav&quot;</span>);
<a name="l02157"></a>02157          }
<a name="l02158"></a>02158          <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Starting recording of MeetMe Conference %s into file %s.%s.\n&quot;</span>,
<a name="l02159"></a>02159                 conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, conf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>, conf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>);
<a name="l02160"></a>02160       }
<a name="l02161"></a>02161    }
<a name="l02162"></a>02162 
<a name="l02163"></a>02163    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a36b5e5ca449d5db4d505c5ceed207e3b">recordthreadlock</a>);
<a name="l02164"></a>02164    <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a> == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) &amp;&amp; (confflags &amp; CONFFLAG_RECORDCONF) &amp;&amp; ((conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a> = <a class="code" href="channel_8h.html#a922b0c040026477b8e2020211abf604a" title="Requests a channel.">ast_request</a>(<span class="stringliteral">&quot;DAHDI&quot;</span>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>, <span class="stringliteral">&quot;pseudo&quot;</span>, NULL)))) {
<a name="l02165"></a>02165       <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l02166"></a>02166       <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l02167"></a>02167       dahdic.chan = 0;
<a name="l02168"></a>02168       dahdic.confno = conf-&gt;<a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a>;
<a name="l02169"></a>02169       dahdic.confmode = DAHDI_CONF_CONFANN | DAHDI_CONF_CONFANNMON;
<a name="l02170"></a>02170       <span class="keywordflow">if</span> (ioctl(conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0], DAHDI_SETCONF, &amp;dahdic)) {
<a name="l02171"></a>02171          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error starting listen channel\n&quot;</span>);
<a name="l02172"></a>02172          <a class="code" href="channel_8h.html#a8f2c0f3dcafbc3a74d84a8dddcce6b9c" title="Hang up a channel.">ast_hangup</a>(conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>);
<a name="l02173"></a>02173          conf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a> = NULL;
<a name="l02174"></a>02174       } <span class="keywordflow">else</span> {
<a name="l02175"></a>02175          <a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a>, NULL, <a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a>, conf);
<a name="l02176"></a>02176       }
<a name="l02177"></a>02177    }
<a name="l02178"></a>02178    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a36b5e5ca449d5db4d505c5ceed207e3b">recordthreadlock</a>);
<a name="l02179"></a>02179 
<a name="l02180"></a>02180    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;announcethreadlock);
<a name="l02181"></a>02181    <span class="keywordflow">if</span> ((conf-&gt;announcethread == <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) &amp;&amp; !(confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a>) &amp;&amp; ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a>) || (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a>))) {
<a name="l02182"></a>02182       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;conf-&gt;announcelistlock);
<a name="l02183"></a>02183       <a class="code" href="linkedlists_8h.html#a0d1f922e093ac18824a7863fe3f5fa27" title="Initializes a list head structure.">AST_LIST_HEAD_INIT_NOLOCK</a>(&amp;conf-&gt;announcelist);
<a name="l02184"></a>02184       <a class="code" href="utils_8h.html#a595e2f8aa398f4bd21e381c3211235fe">ast_pthread_create_background</a>(&amp;conf-&gt;announcethread, NULL, <a class="code" href="app__meetme_8c.html#a17b11cfe0e59eab973dd6aa57de91f8b">announce_thread</a>, conf);
<a name="l02185"></a>02185    }
<a name="l02186"></a>02186    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;announcethreadlock);
<a name="l02187"></a>02187 
<a name="l02188"></a>02188    time(&amp;user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>);
<a name="l02189"></a>02189    
<a name="l02190"></a>02190    user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a> = timelimit;
<a name="l02191"></a>02191    user-&gt;<a class="code" href="structast__conf__user.html#af3d16394c849390df1c8f72569faeb37">play_warning</a> = play_warning;
<a name="l02192"></a>02192    user-&gt;<a class="code" href="structast__conf__user.html#abc09654c9b36de6b0bd0bfd92d31c0c0">warning_freq</a> = warning_freq;
<a name="l02193"></a>02193    user-&gt;<a class="code" href="structast__conf__user.html#a1fa6cb6235cf4abe198a8561e3c18bae">warning_sound</a> = warning_sound;
<a name="l02194"></a>02194    user-&gt;<a class="code" href="structast__conf__user.html#a0b23b4ebfc857809d07d1ced94c9a6eb">end_sound</a> = end_sound;  
<a name="l02195"></a>02195    
<a name="l02196"></a>02196    <span class="keywordflow">if</span> (calldurationlimit &gt; 0) {
<a name="l02197"></a>02197       time(&amp;user-&gt;<a class="code" href="structast__conf__user.html#ae5ad22d81786b1fc2a541ad84f1cd860">kicktime</a>);
<a name="l02198"></a>02198       user-&gt;<a class="code" href="structast__conf__user.html#ae5ad22d81786b1fc2a541ad84f1cd860">kicktime</a> = user-&gt;<a class="code" href="structast__conf__user.html#ae5ad22d81786b1fc2a541ad84f1cd860">kicktime</a> + calldurationlimit;
<a name="l02199"></a>02199    }
<a name="l02200"></a>02200    
<a name="l02201"></a>02201    <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(user-&gt;<a class="code" href="structast__conf__user.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a>))
<a name="l02202"></a>02202       user-&gt;<a class="code" href="structast__conf__user.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02203"></a>02203    time_left_ms = user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a>;
<a name="l02204"></a>02204    
<a name="l02205"></a>02205    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a>) {
<a name="l02206"></a>02206       nexteventts = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(user-&gt;<a class="code" href="structast__conf__user.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a>, 1000));
<a name="l02207"></a>02207       nexteventts = <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(nexteventts, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(user-&gt;<a class="code" href="structast__conf__user.html#af3d16394c849390df1c8f72569faeb37">play_warning</a>, 1000));
<a name="l02208"></a>02208    }
<a name="l02209"></a>02209 
<a name="l02210"></a>02210    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a> &amp;&amp; (!(confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a>))) {
<a name="l02211"></a>02211       <span class="comment">/* Sorry, but this conference is locked! */</span>  
<a name="l02212"></a>02212       <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-locked&quot;</span>, chan-&gt;language))
<a name="l02213"></a>02213          <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02214"></a>02214       <span class="keywordflow">goto</span> outrun;
<a name="l02215"></a>02215    }
<a name="l02216"></a>02216 
<a name="l02217"></a>02217       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l02218"></a>02218 
<a name="l02219"></a>02219    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;conf-&gt;userlist))
<a name="l02220"></a>02220       user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a> = 1;
<a name="l02221"></a>02221    <span class="keywordflow">else</span>
<a name="l02222"></a>02222       user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a> = <a class="code" href="linkedlists_8h.html#a1e37109bb72d95999821eb45f28c261c" title="Returns the last entry contained in a list.">AST_LIST_LAST</a>(&amp;conf-&gt;userlist)-&gt;user_no + 1;
<a name="l02223"></a>02223 
<a name="l02224"></a>02224    <span class="keywordflow">if</span> (rt_schedule &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">maxusers</a>)
<a name="l02225"></a>02225       <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> &gt;= conf-&gt;<a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">maxusers</a>) {
<a name="l02226"></a>02226          <span class="comment">/* Sorry, but this confernce has reached the participant limit! */</span>   
<a name="l02227"></a>02227          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-full&quot;</span>, chan-&gt;language))
<a name="l02228"></a>02228             <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02229"></a>02229          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l02230"></a>02230          user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a> = 0;
<a name="l02231"></a>02231          <span class="keywordflow">goto</span> outrun;
<a name="l02232"></a>02232       }
<a name="l02233"></a>02233 
<a name="l02234"></a>02234    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;conf-&gt;userlist, user, list);
<a name="l02235"></a>02235 
<a name="l02236"></a>02236    user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a> = chan;
<a name="l02237"></a>02237    user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> = confflags;
<a name="l02238"></a>02238    user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> = (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ad7732ac9c48e20f3c0bb5948ff1e01cf">CONFFLAG_STARTMUTED</a>) ? <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> : 0;
<a name="l02239"></a>02239    user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> = -1;
<a name="l02240"></a>02240 
<a name="l02241"></a>02241    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l02242"></a>02242 
<a name="l02243"></a>02243    <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; ((confflags &amp; CONFFLAG_INTROUSER) || (confflags &amp; CONFFLAG_INTROUSERNOREVIEW))) {
<a name="l02244"></a>02244       <span class="keywordtype">char</span> destdir[PATH_MAX];
<a name="l02245"></a>02245 
<a name="l02246"></a>02246       snprintf(destdir, <span class="keyword">sizeof</span>(destdir), <span class="stringliteral">&quot;%s/meetme&quot;</span>, <a class="code" href="paths_8h.html#a95c5b4ffe620dc96d1ea9311b35c4d4f">ast_config_AST_SPOOL_DIR</a>);
<a name="l02247"></a>02247 
<a name="l02248"></a>02248       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a7c38859ed90e96df2b0a0fdf843769d0" title="Recursively create directory path.">ast_mkdir</a>(destdir, 0777) != 0) {
<a name="l02249"></a>02249          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;mkdir &apos;%s&apos; failed: %s\n&quot;</span>, destdir, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02250"></a>02250          <span class="keywordflow">goto</span> outrun;
<a name="l02251"></a>02251       }
<a name="l02252"></a>02252 
<a name="l02253"></a>02253       snprintf(user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>, <span class="keyword">sizeof</span>(user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>),
<a name="l02254"></a>02254           <span class="stringliteral">&quot;%s/meetme-username-%s-%d&quot;</span>, destdir,
<a name="l02255"></a>02255           conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>);
<a name="l02256"></a>02256       <span class="keywordflow">if</span> (confflags &amp; CONFFLAG_INTROUSERNOREVIEW)
<a name="l02257"></a>02257          res = <a class="code" href="app_8h.html#a5189403102ce3cae44bd1b1644ee97a2" title="Record a file for a max amount of time (in seconds), in a given list of formats separated...">ast_play_and_record</a>(chan, <span class="stringliteral">&quot;vm-rec-name&quot;</span>, user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>, 10, <span class="stringliteral">&quot;sln&quot;</span>, &amp;duration, <a class="code" href="dsp_8h.html#aab28c68838eaed4e0c89460a4e554cca" title="Get silence threshold from dsp.conf.">ast_dsp_get_threshold_from_settings</a>(<a class="code" href="dsp_8h.html#a11a8ce2b7eba2230cab37aad708d9abfa40278495f8621707b864e57e1110d20f">THRESHOLD_SILENCE</a>), 0, NULL);
<a name="l02258"></a>02258       <span class="keywordflow">else</span>
<a name="l02259"></a>02259          res = <a class="code" href="app_8h.html#a88b6ee77eea0c8a6cc0a315e1c1fc815" title="Allow to record message and have a review option.">ast_record_review</a>(chan, <span class="stringliteral">&quot;vm-rec-name&quot;</span>, user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>, 10, <span class="stringliteral">&quot;sln&quot;</span>, &amp;duration, NULL);
<a name="l02260"></a>02260       <span class="keywordflow">if</span> (res == -1)
<a name="l02261"></a>02261          <span class="keywordflow">goto</span> outrun;
<a name="l02262"></a>02262    }
<a name="l02263"></a>02263 
<a name="l02264"></a>02264    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l02265"></a>02265 
<a name="l02266"></a>02266    <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">CONFFLAG_MARKEDUSER</a>)
<a name="l02267"></a>02267       conf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>++;
<a name="l02268"></a>02268    conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>++;
<a name="l02269"></a>02269    <span class="keywordflow">if</span> (rt_log_members) {
<a name="l02270"></a>02270       <span class="comment">/* Update table */</span>
<a name="l02271"></a>02271       snprintf(members, <span class="keyword">sizeof</span>(members), <span class="stringliteral">&quot;%d&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>);
<a name="l02272"></a>02272       <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;meetme&quot;</span>,
<a name="l02273"></a>02273          <span class="stringliteral">&quot;confno&quot;</span>, strlen(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>) &gt; 7 ? <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a27acda71d87003db19a6e0b4193a32be">RQ_UINTEGER4</a> : strlen(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>) &gt; 4 ? <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a> : <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>, strlen(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>),
<a name="l02274"></a>02274          <span class="stringliteral">&quot;members&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ae8c94d6fa08e17f6f86792727b201bf9">RQ_UINTEGER1</a>, strlen(members),
<a name="l02275"></a>02275          NULL);
<a name="l02276"></a>02276       <a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="stringliteral">&quot;members&quot;</span>, members, NULL);
<a name="l02277"></a>02277    }
<a name="l02278"></a>02278    setusercount = 1;
<a name="l02279"></a>02279 
<a name="l02280"></a>02280    <span class="comment">/* This device changed state now - if this is the first user */</span>
<a name="l02281"></a>02281    <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> == 1)
<a name="l02282"></a>02282       <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>, <span class="stringliteral">&quot;meetme:%s&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l02283"></a>02283 
<a name="l02284"></a>02284    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#a7ce731bb061f69d8257be3b984f1680f">playlock</a>);
<a name="l02285"></a>02285 
<a name="l02286"></a>02286    <span class="comment">/* return the unique ID of the conference */</span>
<a name="l02287"></a>02287    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETMEUNIQUEID&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#ae42dbdf188676f5840d98c4427e75a4f">uniqueid</a>);
<a name="l02288"></a>02288 
<a name="l02289"></a>02289    <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a61bdcc99c25b743f89316b3da3796cc1">CONFFLAG_EXIT_CONTEXT</a>) {
<a name="l02290"></a>02290       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02291"></a>02291       <span class="keywordflow">if</span> ((tmpvar = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_EXIT_CONTEXT&quot;</span>))) {
<a name="l02292"></a>02292          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exitcontext, tmpvar, <span class="keyword">sizeof</span>(exitcontext));
<a name="l02293"></a>02293       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>)) {
<a name="l02294"></a>02294          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exitcontext, chan-&gt;<a class="code" href="structast__channel.html#a0a602b0f10ece2644f247c3f6ff841e0">macrocontext</a>, <span class="keyword">sizeof</span>(exitcontext));
<a name="l02295"></a>02295       } <span class="keywordflow">else</span> {
<a name="l02296"></a>02296          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(exitcontext, chan-&gt;<a class="code" href="structast__channel.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <span class="keyword">sizeof</span>(exitcontext));
<a name="l02297"></a>02297       }
<a name="l02298"></a>02298       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02299"></a>02299    }
<a name="l02300"></a>02300 
<a name="l02301"></a>02301    <span class="keywordflow">if</span> (!(confflags &amp; (CONFFLAG_QUIET | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acebf32e64aaad2bef9c62ae75ee816b7">CONFFLAG_NOONLYPERSON</a>))) {
<a name="l02302"></a>02302       <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> == 1 &amp;&amp; !(confflags &amp; CONFFLAG_WAITMARKED))
<a name="l02303"></a>02303          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-onlyperson&quot;</span>, chan-&gt;language))
<a name="l02304"></a>02304             <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02305"></a>02305       <span class="keywordflow">if</span> ((confflags &amp; CONFFLAG_WAITMARKED) &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a> == 0)
<a name="l02306"></a>02306          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-waitforleader&quot;</span>, chan-&gt;language))
<a name="l02307"></a>02307             <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02308"></a>02308    }
<a name="l02309"></a>02309 
<a name="l02310"></a>02310    <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a642977b3db866f6c6f87b1d5f7791d5b">CONFFLAG_ANNOUNCEUSERCOUNT</a>) &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> &gt; 1) {
<a name="l02311"></a>02311       <span class="keywordtype">int</span> keepplaying = 1;
<a name="l02312"></a>02312 
<a name="l02313"></a>02313       <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> == 2) { 
<a name="l02314"></a>02314          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-onlyone&quot;</span>, chan-&gt;language)) {
<a name="l02315"></a>02315             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l02316"></a>02316             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02317"></a>02317             <span class="keywordflow">if</span> (res &gt; 0)
<a name="l02318"></a>02318                keepplaying = 0;
<a name="l02319"></a>02319             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1)
<a name="l02320"></a>02320                <span class="keywordflow">goto</span> outrun;
<a name="l02321"></a>02321          }
<a name="l02322"></a>02322       } <span class="keywordflow">else</span> { 
<a name="l02323"></a>02323          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-thereare&quot;</span>, chan-&gt;language)) {
<a name="l02324"></a>02324             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l02325"></a>02325             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02326"></a>02326             <span class="keywordflow">if</span> (res &gt; 0)
<a name="l02327"></a>02327                keepplaying = 0;
<a name="l02328"></a>02328             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1)
<a name="l02329"></a>02329                <span class="keywordflow">goto</span> outrun;
<a name="l02330"></a>02330          }
<a name="l02331"></a>02331          <span class="keywordflow">if</span> (keepplaying) {
<a name="l02332"></a>02332             res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> - 1, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, (<span class="keywordtype">char</span> *) NULL);
<a name="l02333"></a>02333             <span class="keywordflow">if</span> (res &gt; 0)
<a name="l02334"></a>02334                keepplaying = 0;
<a name="l02335"></a>02335             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1)
<a name="l02336"></a>02336                <span class="keywordflow">goto</span> outrun;
<a name="l02337"></a>02337          }
<a name="l02338"></a>02338          <span class="keywordflow">if</span> (keepplaying &amp;&amp; !<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-otherinparty&quot;</span>, chan-&gt;language)) {
<a name="l02339"></a>02339             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l02340"></a>02340             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02341"></a>02341             <span class="keywordflow">if</span> (res &gt; 0)
<a name="l02342"></a>02342                keepplaying = 0;
<a name="l02343"></a>02343             <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == -1) 
<a name="l02344"></a>02344                <span class="keywordflow">goto</span> outrun;
<a name="l02345"></a>02345          }
<a name="l02346"></a>02346       }
<a name="l02347"></a>02347    }
<a name="l02348"></a>02348 
<a name="l02349"></a>02349    <span class="keywordflow">if</span> (!(confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac13efb0951d66c6cee3936d4a48d2107">CONFFLAG_NO_AUDIO_UNTIL_UP</a>)) {
<a name="l02350"></a>02350       <span class="comment">/* We&apos;re leaving this alone until the state gets changed to up */</span>
<a name="l02351"></a>02351       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, -1);
<a name="l02352"></a>02352    }
<a name="l02353"></a>02353 
<a name="l02354"></a>02354    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) &lt; 0) {
<a name="l02355"></a>02355       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set &apos;%s&apos; to write linear mode\n&quot;</span>, chan-&gt;name);
<a name="l02356"></a>02356       <span class="keywordflow">goto</span> outrun;
<a name="l02357"></a>02357    }
<a name="l02358"></a>02358 
<a name="l02359"></a>02359    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) &lt; 0) {
<a name="l02360"></a>02360       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set &apos;%s&apos; to read linear mode\n&quot;</span>, chan-&gt;name);
<a name="l02361"></a>02361       <span class="keywordflow">goto</span> outrun;
<a name="l02362"></a>02362    }
<a name="l02363"></a>02363 
<a name="l02364"></a>02364    retrydahdi = (strcasecmp(chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, <span class="stringliteral">&quot;DAHDI&quot;</span>) || (chan-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> || chan-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>) ? 1 : 0);
<a name="l02365"></a>02365    user-&gt;<a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">dahdichannel</a> = !retrydahdi;
<a name="l02366"></a>02366 
<a name="l02367"></a>02367  dahdiretry:
<a name="l02368"></a>02368    origfd = chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0];
<a name="l02369"></a>02369    <span class="keywordflow">if</span> (retrydahdi) {
<a name="l02370"></a>02370       <span class="comment">/* open pseudo in non-blocking mode */</span>
<a name="l02371"></a>02371       fd = open(<span class="stringliteral">&quot;/dev/dahdi/pseudo&quot;</span>, O_RDWR | O_NONBLOCK);
<a name="l02372"></a>02372       <span class="keywordflow">if</span> (fd &lt; 0) {
<a name="l02373"></a>02373          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to open pseudo channel: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02374"></a>02374          <span class="keywordflow">goto</span> outrun;
<a name="l02375"></a>02375       }
<a name="l02376"></a>02376       using_pseudo = 1;
<a name="l02377"></a>02377       <span class="comment">/* Setup buffering information */</span>
<a name="l02378"></a>02378       memset(&amp;bi, 0, <span class="keyword">sizeof</span>(bi));
<a name="l02379"></a>02379       bi.bufsize = <a class="code" href="app__dahdibarge_8c.html#a2be5f0b8c25b67aa5ca5502d61c16b73">CONF_SIZE</a> / 2;
<a name="l02380"></a>02380       bi.txbufpolicy = DAHDI_POLICY_IMMEDIATE;
<a name="l02381"></a>02381       bi.rxbufpolicy = DAHDI_POLICY_IMMEDIATE;
<a name="l02382"></a>02382       bi.numbufs = audio_buffers;
<a name="l02383"></a>02383       <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SET_BUFINFO, &amp;bi)) {
<a name="l02384"></a>02384          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set buffering information: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02385"></a>02385          close(fd);
<a name="l02386"></a>02386          <span class="keywordflow">goto</span> outrun;
<a name="l02387"></a>02387       }
<a name="l02388"></a>02388       x = 1;
<a name="l02389"></a>02389       <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETLINEAR, &amp;x)) {
<a name="l02390"></a>02390          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set linear mode: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02391"></a>02391          close(fd);
<a name="l02392"></a>02392          <span class="keywordflow">goto</span> outrun;
<a name="l02393"></a>02393       }
<a name="l02394"></a>02394       nfds = 1;
<a name="l02395"></a>02395    } <span class="keywordflow">else</span> {
<a name="l02396"></a>02396       <span class="comment">/* XXX Make sure we&apos;re not running on a pseudo channel XXX */</span>
<a name="l02397"></a>02397       fd = chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0];
<a name="l02398"></a>02398       nfds = 0;
<a name="l02399"></a>02399    }
<a name="l02400"></a>02400    memset(&amp;dahdic, 0, <span class="keyword">sizeof</span>(dahdic));
<a name="l02401"></a>02401    memset(&amp;dahdic_empty, 0, <span class="keyword">sizeof</span>(dahdic_empty));
<a name="l02402"></a>02402    <span class="comment">/* Check to see if we&apos;re in a conference... */</span>
<a name="l02403"></a>02403    dahdic.chan = 0;  
<a name="l02404"></a>02404    <span class="keywordflow">if</span> (ioctl(fd, DAHDI_GETCONF, &amp;dahdic)) {
<a name="l02405"></a>02405       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error getting conference\n&quot;</span>);
<a name="l02406"></a>02406       close(fd);
<a name="l02407"></a>02407       <span class="keywordflow">goto</span> outrun;
<a name="l02408"></a>02408    }
<a name="l02409"></a>02409    <span class="keywordflow">if</span> (dahdic.confmode) {
<a name="l02410"></a>02410       <span class="comment">/* Whoa, already in a conference...  Retry... */</span>
<a name="l02411"></a>02411       <span class="keywordflow">if</span> (!retrydahdi) {
<a name="l02412"></a>02412          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;DAHDI channel is in a conference already, retrying with pseudo\n&quot;</span>);
<a name="l02413"></a>02413          retrydahdi = 1;
<a name="l02414"></a>02414          <span class="keywordflow">goto</span> dahdiretry;
<a name="l02415"></a>02415       }
<a name="l02416"></a>02416    }
<a name="l02417"></a>02417    memset(&amp;dahdic, 0, <span class="keyword">sizeof</span>(dahdic));
<a name="l02418"></a>02418    <span class="comment">/* Add us to the conference */</span>
<a name="l02419"></a>02419    dahdic.chan = 0;  
<a name="l02420"></a>02420    dahdic.confno = conf-&gt;<a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a>;
<a name="l02421"></a>02421 
<a name="l02422"></a>02422    <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; ((confflags &amp; CONFFLAG_INTROUSER) || (confflags &amp; CONFFLAG_INTROUSERNOREVIEW)) &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> &gt; 1) {
<a name="l02423"></a>02423       <span class="keyword">struct </span><a class="code" href="structannounce__listitem.html">announce_listitem</a> *item;
<a name="l02424"></a>02424       <span class="keywordflow">if</span> (!(item = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*item), NULL)))
<a name="l02425"></a>02425          <span class="keywordflow">return</span> -1;
<a name="l02426"></a>02426       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item-&gt;namerecloc, user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>, <span class="keyword">sizeof</span>(item-&gt;namerecloc));
<a name="l02427"></a>02427       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item-&gt;language, chan-&gt;language, <span class="keyword">sizeof</span>(item-&gt;language));
<a name="l02428"></a>02428       item-&gt;confchan = conf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l02429"></a>02429       item-&gt;confusers = conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>;
<a name="l02430"></a>02430       item-&gt;announcetype = <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfa7a2844a08140930251b7a890184cf1f1">CONF_HASJOIN</a>;
<a name="l02431"></a>02431       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;announcelistlock);
<a name="l02432"></a>02432       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(item, +1); <span class="comment">/* add one more so we can determine when announce_thread is done playing it */</span>
<a name="l02433"></a>02433       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;conf-&gt;announcelist, item, entry);
<a name="l02434"></a>02434       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;conf-&gt;announcelist_addition);
<a name="l02435"></a>02435       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;announcelistlock);
<a name="l02436"></a>02436 
<a name="l02437"></a>02437       <span class="keywordflow">while</span> (!<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(conf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>) &amp;&amp; <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(item, 0) == 2 &amp;&amp; !<a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 1000)) {
<a name="l02438"></a>02438          ;
<a name="l02439"></a>02439       }
<a name="l02440"></a>02440       <a class="code" href="astobj2_8h.html#aaca5e8eac39a22f9da1c36fc6c922270">ao2_ref</a>(item, -1);
<a name="l02441"></a>02441    }
<a name="l02442"></a>02442 
<a name="l02443"></a>02443    <span class="keywordflow">if</span> (confflags &amp; CONFFLAG_WAITMARKED &amp;&amp; !conf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>)
<a name="l02444"></a>02444       dahdic.confmode = DAHDI_CONF_CONF;
<a name="l02445"></a>02445    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">CONFFLAG_MONITOR</a>)
<a name="l02446"></a>02446       dahdic.confmode = DAHDI_CONF_CONFMON | DAHDI_CONF_LISTENER;
<a name="l02447"></a>02447    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a39a9c6b58c7b77ef675e56d00c89e0a8">CONFFLAG_TALKER</a>)
<a name="l02448"></a>02448       dahdic.confmode = DAHDI_CONF_CONF | DAHDI_CONF_TALKER;
<a name="l02449"></a>02449    <span class="keywordflow">else</span> 
<a name="l02450"></a>02450       dahdic.confmode = DAHDI_CONF_CONF | DAHDI_CONF_TALKER | DAHDI_CONF_LISTENER;
<a name="l02451"></a>02451 
<a name="l02452"></a>02452    <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l02453"></a>02453       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l02454"></a>02454       close(fd);
<a name="l02455"></a>02455       <span class="keywordflow">goto</span> outrun;
<a name="l02456"></a>02456    }
<a name="l02457"></a>02457    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Placed channel %s in DAHDI conf %d\n&quot;</span>, chan-&gt;name, conf-&gt;<a class="code" href="structast__conference.html#a6d1364322480c8ea03e11c3d8410f767">dahdiconf</a>);
<a name="l02458"></a>02458 
<a name="l02459"></a>02459    <span class="keywordflow">if</span> (!sent_event) {
<a name="l02460"></a>02460       <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeJoin&quot;</span>, 
<a name="l02461"></a>02461                  <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02462"></a>02462                  <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02463"></a>02463             <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l02464"></a>02464             <span class="stringliteral">&quot;Usernum: %d\r\n&quot;</span>
<a name="l02465"></a>02465             <span class="stringliteral">&quot;CallerIDnum: %s\r\n&quot;</span>
<a name="l02466"></a>02466                   <span class="stringliteral">&quot;CallerIDname: %s\r\n&quot;</span>,
<a name="l02467"></a>02467                   chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, 
<a name="l02468"></a>02468             user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>,
<a name="l02469"></a>02469             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l02470"></a>02470             <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>)
<a name="l02471"></a>02471             );
<a name="l02472"></a>02472       sent_event = 1;
<a name="l02473"></a>02473    }
<a name="l02474"></a>02474 
<a name="l02475"></a>02475    <span class="keywordflow">if</span> (!firstpass &amp;&amp; !(confflags &amp; CONFFLAG_MONITOR) &amp;&amp; !(confflags &amp; CONFFLAG_ADMIN)) {
<a name="l02476"></a>02476       firstpass = 1;
<a name="l02477"></a>02477       <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET))
<a name="l02478"></a>02478          <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_WAITMARKED) || ((confflags &amp; CONFFLAG_MARKEDUSER) &amp;&amp; (conf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a> &gt;= 1)))
<a name="l02479"></a>02479             <a class="code" href="app__meetme_8c.html#a645090dd89fa3f8aaff60ea7eb38be18">conf_play</a>(chan, conf, <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49ba951ab68bb8f7daafb78951107080904e">ENTER</a>);
<a name="l02480"></a>02480    }
<a name="l02481"></a>02481 
<a name="l02482"></a>02482    <a class="code" href="app__meetme_8c.html#a42bbab56ce6a8eb0aaf501be26cf5271">conf_flush</a>(fd, chan);
<a name="l02483"></a>02483 
<a name="l02484"></a>02484    <span class="keywordflow">if</span> (!(dsp = <a class="code" href="dsp_8h.html#a0a60e93006c8e1ca8fda922ae0e0da2c">ast_dsp_new</a>())) {
<a name="l02485"></a>02485       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate DSP!\n&quot;</span>);
<a name="l02486"></a>02486       res = -1;
<a name="l02487"></a>02487    }
<a name="l02488"></a>02488 
<a name="l02489"></a>02489    <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76bd08a36963707fcb29643b2d3bb49">CONFFLAG_AGI</a>) {
<a name="l02490"></a>02490       <span class="comment">/* Get name of AGI file to run from $(MEETME_AGI_BACKGROUND)</span>
<a name="l02491"></a>02491 <span class="comment">         or use default filename of conf-background.agi */</span>
<a name="l02492"></a>02492 
<a name="l02493"></a>02493       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l02494"></a>02494       <span class="keywordflow">if</span> ((tmpvar = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_AGI_BACKGROUND&quot;</span>))) {
<a name="l02495"></a>02495          agifile = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(tmpvar);
<a name="l02496"></a>02496       } <span class="keywordflow">else</span> {
<a name="l02497"></a>02497          agifile = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(agifiledefault);
<a name="l02498"></a>02498       }
<a name="l02499"></a>02499       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l02500"></a>02500       
<a name="l02501"></a>02501       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">dahdichannel</a>) {
<a name="l02502"></a>02502          <span class="comment">/*  Set CONFMUTE mode on DAHDI channel to mute DTMF tones */</span>
<a name="l02503"></a>02503          x = 1;
<a name="l02504"></a>02504          <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a31312f6b6c2296e3495ad1d9e198cbf4">AST_OPTION_TONE_VERIFY</a>, &amp;x, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 0);
<a name="l02505"></a>02505       }
<a name="l02506"></a>02506       <span class="comment">/* Find a pointer to the agi app and execute the script */</span>
<a name="l02507"></a>02507       agi_app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(<span class="stringliteral">&quot;agi&quot;</span>);
<a name="l02508"></a>02508       <span class="keywordflow">if</span> (agi_app) {
<a name="l02509"></a>02509          ret = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, agi_app, agifile);
<a name="l02510"></a>02510       } <span class="keywordflow">else</span> {
<a name="l02511"></a>02511          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Could not find application (agi)\n&quot;</span>);
<a name="l02512"></a>02512          ret = -2;
<a name="l02513"></a>02513       }
<a name="l02514"></a>02514       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">dahdichannel</a>) {
<a name="l02515"></a>02515          <span class="comment">/*  Remove CONFMUTE mode on DAHDI channel */</span>
<a name="l02516"></a>02516          x = 0;
<a name="l02517"></a>02517          <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a31312f6b6c2296e3495ad1d9e198cbf4">AST_OPTION_TONE_VERIFY</a>, &amp;x, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 0);
<a name="l02518"></a>02518       }
<a name="l02519"></a>02519    } <span class="keywordflow">else</span> {
<a name="l02520"></a>02520       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">dahdichannel</a> &amp;&amp; (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a8c1f23aabf6a93f20eb6b11fe8e2b857">CONFFLAG_STARMENU</a>)) {
<a name="l02521"></a>02521          <span class="comment">/*  Set CONFMUTE mode on DAHDI channel to mute DTMF tones when the menu is enabled */</span>
<a name="l02522"></a>02522          x = 1;
<a name="l02523"></a>02523          <a class="code" href="channel_8h.html#adcfd8d241b6de48068ead143ac29978d" title="Sets an option on a channel.">ast_channel_setoption</a>(chan, <a class="code" href="frame_8h.html#a31312f6b6c2296e3495ad1d9e198cbf4">AST_OPTION_TONE_VERIFY</a>, &amp;x, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), 0);
<a name="l02524"></a>02524       }  
<a name="l02525"></a>02525       <span class="keywordflow">for</span> (;;) {
<a name="l02526"></a>02526          <span class="keywordtype">int</span> menu_was_active = 0;
<a name="l02527"></a>02527 
<a name="l02528"></a>02528          outfd = -1;
<a name="l02529"></a>02529          ms = -1;
<a name="l02530"></a>02530          now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02531"></a>02531 
<a name="l02532"></a>02532          <span class="keywordflow">if</span> (rt_schedule &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a>) {
<a name="l02533"></a>02533             <span class="keywordtype">char</span> currenttime[32];
<a name="l02534"></a>02534             <span class="keywordtype">long</span> localendtime = 0;
<a name="l02535"></a>02535             <span class="keywordtype">int</span> extended = 0;
<a name="l02536"></a>02536             <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l02537"></a>02537             <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *origvar;
<a name="l02538"></a>02538             <span class="keyword">struct </span>timeval tmp;
<a name="l02539"></a>02539 
<a name="l02540"></a>02540             <span class="keywordflow">if</span> (now.tv_sec % 60 == 0) {
<a name="l02541"></a>02541                <span class="keywordflow">if</span> (!checked) {
<a name="l02542"></a>02542                   <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l02543"></a>02543                   <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(currenttime, <span class="keyword">sizeof</span>(currenttime), <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;tm);
<a name="l02544"></a>02544                   var = origvar = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>,
<a name="l02545"></a>02545                      conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="stringliteral">&quot;starttime &lt;=&quot;</span>, currenttime,
<a name="l02546"></a>02546                       <span class="stringliteral">&quot;endtime &gt;=&quot;</span>, currenttime, NULL);
<a name="l02547"></a>02547 
<a name="l02548"></a>02548                   <span class="keywordflow">for</span> ( ; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l02549"></a>02549                      <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;endtime&quot;</span>)) {
<a name="l02550"></a>02550                         <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> endtime_tm;
<a name="l02551"></a>02551                         <a class="code" href="localtime_8h.html#a3eb2c73accce1b149ce597de80d1677a" title="Special version of strptime(3) which places the answer in the common structure ast_tm...">ast_strptime</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, &amp;endtime_tm);
<a name="l02552"></a>02552                         tmp = <a class="code" href="localtime_8h.html#ae0843e4dbbd1fed36d2676dda58e0c44" title="Timezone-independent version of mktime(3).">ast_mktime</a>(&amp;endtime_tm, NULL);
<a name="l02553"></a>02553                         localendtime = tmp.tv_sec;
<a name="l02554"></a>02554                      }
<a name="l02555"></a>02555                   }
<a name="l02556"></a>02556                   <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(origvar);
<a name="l02557"></a>02557 
<a name="l02558"></a>02558                   <span class="comment">/* A conference can be extended from the</span>
<a name="l02559"></a>02559 <span class="comment">                     Admin/User menu or by an external source */</span>
<a name="l02560"></a>02560                   <span class="keywordflow">if</span> (localendtime &gt; conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a>){
<a name="l02561"></a>02561                      conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a> = localendtime;
<a name="l02562"></a>02562                      extended = 1;
<a name="l02563"></a>02563                   }
<a name="l02564"></a>02564 
<a name="l02565"></a>02565                   <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a> &amp;&amp; (now.tv_sec &gt;= conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a>)) {
<a name="l02566"></a>02566                      <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Quitting time...\n&quot;</span>);
<a name="l02567"></a>02567                      <span class="keywordflow">goto</span> outrun;
<a name="l02568"></a>02568                   }
<a name="l02569"></a>02569 
<a name="l02570"></a>02570                   <span class="keywordflow">if</span> (!announcement_played &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#a35cc725664fd0b4f53fbbb7d0f15c038">endalert</a>) {
<a name="l02571"></a>02571                      <span class="keywordflow">if</span> (now.tv_sec + conf-&gt;<a class="code" href="structast__conference.html#a35cc725664fd0b4f53fbbb7d0f15c038">endalert</a> &gt;= conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a>) {
<a name="l02572"></a>02572                         <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-will-end-in&quot;</span>, chan-&gt;language))
<a name="l02573"></a>02573                            <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02574"></a>02574                         <a class="code" href="say_8h.html#a7cf9dcf6ae6fcedb7752d0deac683b3b" title="says digits">ast_say_digits</a>(chan, (conf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a> - now.tv_sec) / 60, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l02575"></a>02575                         <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;minutes&quot;</span>, chan-&gt;language))
<a name="l02576"></a>02576                            <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02577"></a>02577                         announcement_played = 1;
<a name="l02578"></a>02578                      }
<a name="l02579"></a>02579                   }
<a name="l02580"></a>02580 
<a name="l02581"></a>02581                   <span class="keywordflow">if</span> (extended) {
<a name="l02582"></a>02582                      announcement_played = 0;
<a name="l02583"></a>02583                   }
<a name="l02584"></a>02584 
<a name="l02585"></a>02585                   checked = 1;
<a name="l02586"></a>02586                }
<a name="l02587"></a>02587             } <span class="keywordflow">else</span> {
<a name="l02588"></a>02588                checked = 0;
<a name="l02589"></a>02589             }
<a name="l02590"></a>02590          }
<a name="l02591"></a>02591 
<a name="l02592"></a>02592          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#ae5ad22d81786b1fc2a541ad84f1cd860">kicktime</a> &amp;&amp; (user-&gt;<a class="code" href="structast__conf__user.html#ae5ad22d81786b1fc2a541ad84f1cd860">kicktime</a> &lt;= now.tv_sec)) {
<a name="l02593"></a>02593             <span class="keywordflow">break</span>;
<a name="l02594"></a>02594          }
<a name="l02595"></a>02595   
<a name="l02596"></a>02596          to = -1;
<a name="l02597"></a>02597          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a>) {
<a name="l02598"></a>02598             <span class="keywordtype">int</span> minutes = 0, seconds = 0, remain = 0;
<a name="l02599"></a>02599  
<a name="l02600"></a>02600             to = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(nexteventts, now);
<a name="l02601"></a>02601             <span class="keywordflow">if</span> (to &lt; 0) {
<a name="l02602"></a>02602                to = 0;
<a name="l02603"></a>02603             }
<a name="l02604"></a>02604             time_left_ms = user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a> - <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(now, user-&gt;<a class="code" href="structast__conf__user.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a>);
<a name="l02605"></a>02605             <span class="keywordflow">if</span> (time_left_ms &lt; to) {
<a name="l02606"></a>02606                to = time_left_ms;
<a name="l02607"></a>02607             }
<a name="l02608"></a>02608    
<a name="l02609"></a>02609             <span class="keywordflow">if</span> (time_left_ms &lt;= 0) {
<a name="l02610"></a>02610                <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a0b23b4ebfc857809d07d1ced94c9a6eb">end_sound</a>) {                 
<a name="l02611"></a>02611                   res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, user-&gt;<a class="code" href="structast__conf__user.html#a0b23b4ebfc857809d07d1ced94c9a6eb">end_sound</a>, chan-&gt;language);
<a name="l02612"></a>02612                   res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02613"></a>02613                }
<a name="l02614"></a>02614                <span class="keywordflow">break</span>;
<a name="l02615"></a>02615             }
<a name="l02616"></a>02616             
<a name="l02617"></a>02617             <span class="keywordflow">if</span> (!to) {
<a name="l02618"></a>02618                <span class="keywordflow">if</span> (time_left_ms &gt;= 5000) {                  
<a name="l02619"></a>02619                   
<a name="l02620"></a>02620                   remain = (time_left_ms + 500) / 1000;
<a name="l02621"></a>02621                   <span class="keywordflow">if</span> (remain / 60 &gt;= 1) {
<a name="l02622"></a>02622                      minutes = remain / 60;
<a name="l02623"></a>02623                      seconds = remain % 60;
<a name="l02624"></a>02624                   } <span class="keywordflow">else</span> {
<a name="l02625"></a>02625                      seconds = remain;
<a name="l02626"></a>02626                   }
<a name="l02627"></a>02627                   
<a name="l02628"></a>02628                   <span class="comment">/* force the time left to round up if appropriate */</span>
<a name="l02629"></a>02629                   <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a1fa6cb6235cf4abe198a8561e3c18bae">warning_sound</a> &amp;&amp; user-&gt;<a class="code" href="structast__conf__user.html#af3d16394c849390df1c8f72569faeb37">play_warning</a>) {
<a name="l02630"></a>02630                      <span class="keywordflow">if</span> (!strcmp(user-&gt;<a class="code" href="structast__conf__user.html#a1fa6cb6235cf4abe198a8561e3c18bae">warning_sound</a>, <span class="stringliteral">&quot;timeleft&quot;</span>)) {
<a name="l02631"></a>02631                         
<a name="l02632"></a>02632                         res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;vm-youhave&quot;</span>, chan-&gt;language);
<a name="l02633"></a>02633                         res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02634"></a>02634                         <span class="keywordflow">if</span> (minutes) {
<a name="l02635"></a>02635                            res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, minutes, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, (<span class="keywordtype">char</span> *) NULL);
<a name="l02636"></a>02636                            res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;queue-minutes&quot;</span>, chan-&gt;language);
<a name="l02637"></a>02637                            res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02638"></a>02638                         }
<a name="l02639"></a>02639                         <span class="keywordflow">if</span> (seconds) {
<a name="l02640"></a>02640                            res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, seconds, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, (<span class="keywordtype">char</span> *) NULL);
<a name="l02641"></a>02641                            res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;queue-seconds&quot;</span>, chan-&gt;language);
<a name="l02642"></a>02642                            res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02643"></a>02643                         }
<a name="l02644"></a>02644                      } <span class="keywordflow">else</span> {
<a name="l02645"></a>02645                         res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, user-&gt;<a class="code" href="structast__conf__user.html#a1fa6cb6235cf4abe198a8561e3c18bae">warning_sound</a>, chan-&gt;language);
<a name="l02646"></a>02646                         res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02647"></a>02647                      }
<a name="l02648"></a>02648                   }
<a name="l02649"></a>02649                }
<a name="l02650"></a>02650                <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#abc09654c9b36de6b0bd0bfd92d31c0c0">warning_freq</a>) {
<a name="l02651"></a>02651                   nexteventts = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(nexteventts, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(user-&gt;<a class="code" href="structast__conf__user.html#abc09654c9b36de6b0bd0bfd92d31c0c0">warning_freq</a>, 1000));
<a name="l02652"></a>02652                } <span class="keywordflow">else</span> {
<a name="l02653"></a>02653                   nexteventts = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(user-&gt;<a class="code" href="structast__conf__user.html#ab83335d6897e2ea22f24b1b8afd95b0f">start_time</a>, <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(user-&gt;<a class="code" href="structast__conf__user.html#ab88b1e2ff0d0fed0616512352e723162">timelimit</a>, 1000));
<a name="l02654"></a>02654                }
<a name="l02655"></a>02655             }
<a name="l02656"></a>02656          }
<a name="l02657"></a>02657 
<a name="l02658"></a>02658          now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l02659"></a>02659          <span class="keywordflow">if</span> (timeout &amp;&amp; now.tv_sec &gt;= timeout) {
<a name="l02660"></a>02660             <span class="keywordflow">break</span>;
<a name="l02661"></a>02661          }
<a name="l02662"></a>02662 
<a name="l02663"></a>02663          <span class="comment">/* if we have just exited from the menu, and the user had a channel-driver</span>
<a name="l02664"></a>02664 <span class="comment">            volume adjustment, restore it</span>
<a name="l02665"></a>02665 <span class="comment">         */</span>
<a name="l02666"></a>02666          <span class="keywordflow">if</span> (!menu_active &amp;&amp; menu_was_active &amp;&amp; user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a> &amp;&amp; !user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a>) {
<a name="l02667"></a>02667             <a class="code" href="app__meetme_8c.html#a4a7eef0979d0a4b9267d5bc5d98fde30">set_talk_volume</a>(user, user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a>);
<a name="l02668"></a>02668          }
<a name="l02669"></a>02669 
<a name="l02670"></a>02670          menu_was_active = menu_active;
<a name="l02671"></a>02671 
<a name="l02672"></a>02672          currentmarked = conf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>;
<a name="l02673"></a>02673          <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp;
<a name="l02674"></a>02674              (confflags &amp; CONFFLAG_MARKEDUSER) &amp;&amp;
<a name="l02675"></a>02675              (confflags &amp; CONFFLAG_WAITMARKED) &amp;&amp;
<a name="l02676"></a>02676              lastmarked == 0) {
<a name="l02677"></a>02677             <span class="keywordflow">if</span> (currentmarked == 1 &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> &gt; 1) {
<a name="l02678"></a>02678                <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> - 1, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>, chan-&gt;language, (<span class="keywordtype">char</span> *) NULL);
<a name="l02679"></a>02679                <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> - 1 == 1) {
<a name="l02680"></a>02680                   <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-userwilljoin&quot;</span>, chan-&gt;language)) {
<a name="l02681"></a>02681                      <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02682"></a>02682                   }
<a name="l02683"></a>02683                } <span class="keywordflow">else</span> {
<a name="l02684"></a>02684                   <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-userswilljoin&quot;</span>, chan-&gt;language)) {
<a name="l02685"></a>02685                      <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02686"></a>02686                   }
<a name="l02687"></a>02687                }
<a name="l02688"></a>02688             }
<a name="l02689"></a>02689             <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> == 1 &amp;&amp; ! (confflags &amp; CONFFLAG_MARKEDUSER)) {
<a name="l02690"></a>02690                <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-onlyperson&quot;</span>, chan-&gt;language)) {
<a name="l02691"></a>02691                   <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02692"></a>02692                }
<a name="l02693"></a>02693             }
<a name="l02694"></a>02694          }
<a name="l02695"></a>02695 
<a name="l02696"></a>02696          <span class="comment">/* Update the struct with the actual confflags */</span>
<a name="l02697"></a>02697          user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> = confflags;
<a name="l02698"></a>02698 
<a name="l02699"></a>02699          <span class="keywordflow">if</span> (confflags &amp; CONFFLAG_WAITMARKED) {
<a name="l02700"></a>02700             <span class="keywordflow">if</span> (currentmarked == 0) {
<a name="l02701"></a>02701                <span class="keywordflow">if</span> (lastmarked != 0) {
<a name="l02702"></a>02702                   <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET)) {
<a name="l02703"></a>02703                      <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-leaderhasleft&quot;</span>, chan-&gt;language)) {
<a name="l02704"></a>02704                         <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02705"></a>02705                      }
<a name="l02706"></a>02706                   }
<a name="l02707"></a>02707                   <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a>) {
<a name="l02708"></a>02708                      <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aba8445fa67502f63291f122cb214cb83">CONFFLAG_KICK_CONTINUE</a>) {
<a name="l02709"></a>02709                         ret = 0;
<a name="l02710"></a>02710                      }
<a name="l02711"></a>02711                      <span class="keywordflow">break</span>;
<a name="l02712"></a>02712                   } <span class="keywordflow">else</span> {
<a name="l02713"></a>02713                      dahdic.confmode = DAHDI_CONF_CONF;
<a name="l02714"></a>02714                      <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l02715"></a>02715                         <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l02716"></a>02716                         close(fd);
<a name="l02717"></a>02717                         <span class="keywordflow">goto</span> outrun;
<a name="l02718"></a>02718                      }
<a name="l02719"></a>02719                   }
<a name="l02720"></a>02720                }
<a name="l02721"></a>02721                <span class="keywordflow">if</span> (!musiconhold &amp;&amp; (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">CONFFLAG_MOH</a>)) {
<a name="l02722"></a>02722                   <a class="code" href="app__meetme_8c.html#a5ab93ee8a01e294aa904de5413d78601">conf_start_moh</a>(chan, optargs[<a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">OPT_ARG_MOH_CLASS</a>]);
<a name="l02723"></a>02723                   musiconhold = 1;
<a name="l02724"></a>02724                }
<a name="l02725"></a>02725             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (currentmarked &gt;= 1 &amp;&amp; lastmarked == 0) {
<a name="l02726"></a>02726                <span class="comment">/* Marked user entered, so cancel timeout */</span>
<a name="l02727"></a>02727                timeout = 0;
<a name="l02728"></a>02728                <span class="keywordflow">if</span> (confflags &amp; CONFFLAG_MONITOR) {
<a name="l02729"></a>02729                   dahdic.confmode = DAHDI_CONF_CONFMON | DAHDI_CONF_LISTENER;
<a name="l02730"></a>02730                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (confflags &amp; CONFFLAG_TALKER) {
<a name="l02731"></a>02731                   dahdic.confmode = DAHDI_CONF_CONF | DAHDI_CONF_TALKER;
<a name="l02732"></a>02732                } <span class="keywordflow">else</span> {
<a name="l02733"></a>02733                   dahdic.confmode = DAHDI_CONF_CONF | DAHDI_CONF_TALKER | DAHDI_CONF_LISTENER;
<a name="l02734"></a>02734                }
<a name="l02735"></a>02735                <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l02736"></a>02736                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l02737"></a>02737                   close(fd);
<a name="l02738"></a>02738                   <span class="keywordflow">goto</span> outrun;
<a name="l02739"></a>02739                }
<a name="l02740"></a>02740                <span class="keywordflow">if</span> (musiconhold &amp;&amp; (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">CONFFLAG_MOH</a>)) {
<a name="l02741"></a>02741                   <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l02742"></a>02742                   musiconhold = 0;
<a name="l02743"></a>02743                }
<a name="l02744"></a>02744                <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; !(confflags &amp; CONFFLAG_MARKEDUSER)) {
<a name="l02745"></a>02745                   <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-placeintoconf&quot;</span>, chan-&gt;language)) {
<a name="l02746"></a>02746                      <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02747"></a>02747                   }
<a name="l02748"></a>02748                   <a class="code" href="app__meetme_8c.html#a645090dd89fa3f8aaff60ea7eb38be18">conf_play</a>(chan, conf, <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49ba951ab68bb8f7daafb78951107080904e">ENTER</a>);
<a name="l02749"></a>02749                }
<a name="l02750"></a>02750             }
<a name="l02751"></a>02751          }
<a name="l02752"></a>02752 
<a name="l02753"></a>02753          <span class="comment">/* trying to add moh for single person conf */</span>
<a name="l02754"></a>02754          <span class="keywordflow">if</span> ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">CONFFLAG_MOH</a>) &amp;&amp; !(confflags &amp; CONFFLAG_WAITMARKED)) {
<a name="l02755"></a>02755             <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> == 1) {
<a name="l02756"></a>02756                <span class="keywordflow">if</span> (!musiconhold) {
<a name="l02757"></a>02757                   <a class="code" href="app__meetme_8c.html#a5ab93ee8a01e294aa904de5413d78601">conf_start_moh</a>(chan, optargs[<a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">OPT_ARG_MOH_CLASS</a>]);
<a name="l02758"></a>02758                   musiconhold = 1;
<a name="l02759"></a>02759                } 
<a name="l02760"></a>02760             } <span class="keywordflow">else</span> {
<a name="l02761"></a>02761                <span class="keywordflow">if</span> (musiconhold) {
<a name="l02762"></a>02762                   <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l02763"></a>02763                   musiconhold = 0;
<a name="l02764"></a>02764                }
<a name="l02765"></a>02765             }
<a name="l02766"></a>02766          }
<a name="l02767"></a>02767          
<a name="l02768"></a>02768          <span class="comment">/* Leave if the last marked user left */</span>
<a name="l02769"></a>02769          <span class="keywordflow">if</span> (currentmarked == 0 &amp;&amp; lastmarked != 0 &amp;&amp; (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a>)) {
<a name="l02770"></a>02770             <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409aba8445fa67502f63291f122cb214cb83">CONFFLAG_KICK_CONTINUE</a>) {
<a name="l02771"></a>02771                ret = 0;
<a name="l02772"></a>02772             } <span class="keywordflow">else</span> {
<a name="l02773"></a>02773                ret = -1;
<a name="l02774"></a>02774             }
<a name="l02775"></a>02775             <span class="keywordflow">break</span>;
<a name="l02776"></a>02776          }
<a name="l02777"></a>02777    
<a name="l02778"></a>02778          <span class="comment">/* Check if my modes have changed */</span>
<a name="l02779"></a>02779 
<a name="l02780"></a>02780          <span class="comment">/* If I should be muted but am still talker, mute me */</span>
<a name="l02781"></a>02781          <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) &amp;&amp; (dahdic.confmode &amp; DAHDI_CONF_TALKER)) {
<a name="l02782"></a>02782             dahdic.confmode ^= DAHDI_CONF_TALKER;
<a name="l02783"></a>02783             <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l02784"></a>02784                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference - Un/Mute \n&quot;</span>);
<a name="l02785"></a>02785                ret = -1;
<a name="l02786"></a>02786                <span class="keywordflow">break</span>;
<a name="l02787"></a>02787             }
<a name="l02788"></a>02788 
<a name="l02789"></a>02789             <span class="comment">/* Indicate user is not talking anymore - change him to unmonitored state */</span>
<a name="l02790"></a>02790             <span class="keywordflow">if</span> ((confflags &amp; (<a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">CONFFLAG_OPTIMIZETALKER</a>))) {
<a name="l02791"></a>02791                <a class="code" href="app__meetme_8c.html#ae1a11424819b90f48a2f8817af8681cd">set_user_talking</a>(chan, conf, user, -1, confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a>);
<a name="l02792"></a>02792             }
<a name="l02793"></a>02793 
<a name="l02794"></a>02794             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeMute&quot;</span>, 
<a name="l02795"></a>02795                   <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02796"></a>02796                   <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02797"></a>02797                   <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l02798"></a>02798                   <span class="stringliteral">&quot;Usernum: %i\r\n&quot;</span>
<a name="l02799"></a>02799                   <span class="stringliteral">&quot;Status: on\r\n&quot;</span>,
<a name="l02800"></a>02800                   chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>);
<a name="l02801"></a>02801          }
<a name="l02802"></a>02802 
<a name="l02803"></a>02803          <span class="comment">/* If I should be un-muted but am not talker, un-mute me */</span>
<a name="l02804"></a>02804          <span class="keywordflow">if</span> (!(user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) &amp;&amp; !(confflags &amp; CONFFLAG_MONITOR) &amp;&amp; !(dahdic.confmode &amp; DAHDI_CONF_TALKER)) {
<a name="l02805"></a>02805             dahdic.confmode |= DAHDI_CONF_TALKER;
<a name="l02806"></a>02806             <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l02807"></a>02807                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference - Un/Mute \n&quot;</span>);
<a name="l02808"></a>02808                ret = -1;
<a name="l02809"></a>02809                <span class="keywordflow">break</span>;
<a name="l02810"></a>02810             }
<a name="l02811"></a>02811 
<a name="l02812"></a>02812             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeMute&quot;</span>, 
<a name="l02813"></a>02813                   <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02814"></a>02814                   <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02815"></a>02815                   <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l02816"></a>02816                   <span class="stringliteral">&quot;Usernum: %i\r\n&quot;</span>
<a name="l02817"></a>02817                   <span class="stringliteral">&quot;Status: off\r\n&quot;</span>,
<a name="l02818"></a>02818                   chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>);
<a name="l02819"></a>02819          }
<a name="l02820"></a>02820          
<a name="l02821"></a>02821          <span class="keywordflow">if</span> ((user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) &amp;&amp; 
<a name="l02822"></a>02822             (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>) &amp;&amp; !(talkreq_manager)) {
<a name="l02823"></a>02823             talkreq_manager = 1;
<a name="l02824"></a>02824 
<a name="l02825"></a>02825             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeTalkRequest&quot;</span>, 
<a name="l02826"></a>02826                      <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02827"></a>02827                            <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02828"></a>02828                            <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l02829"></a>02829                            <span class="stringliteral">&quot;Usernum: %i\r\n&quot;</span>
<a name="l02830"></a>02830                            <span class="stringliteral">&quot;Status: on\r\n&quot;</span>,
<a name="l02831"></a>02831                            chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>);
<a name="l02832"></a>02832          }
<a name="l02833"></a>02833 
<a name="l02834"></a>02834          
<a name="l02835"></a>02835          <span class="keywordflow">if</span> (!(user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) &amp;&amp; 
<a name="l02836"></a>02836             !(user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>) &amp;&amp; (talkreq_manager)) {
<a name="l02837"></a>02837             talkreq_manager = 0;
<a name="l02838"></a>02838             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeTalkRequest&quot;</span>, 
<a name="l02839"></a>02839                      <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l02840"></a>02840                            <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l02841"></a>02841                            <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l02842"></a>02842                            <span class="stringliteral">&quot;Usernum: %i\r\n&quot;</span>
<a name="l02843"></a>02843                            <span class="stringliteral">&quot;Status: off\r\n&quot;</span>,
<a name="l02844"></a>02844                           chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>);
<a name="l02845"></a>02845          }
<a name="l02846"></a>02846          
<a name="l02847"></a>02847          <span class="comment">/* If I have been kicked, exit the conference */</span>
<a name="l02848"></a>02848          <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a>) {
<a name="l02849"></a>02849             <span class="comment">/* You have been kicked. */</span>
<a name="l02850"></a>02850             <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; 
<a name="l02851"></a>02851                !<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-kicked&quot;</span>, chan-&gt;language)) {
<a name="l02852"></a>02852                <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02853"></a>02853             }
<a name="l02854"></a>02854             ret = 0;
<a name="l02855"></a>02855             <span class="keywordflow">break</span>;
<a name="l02856"></a>02856          }
<a name="l02857"></a>02857 
<a name="l02858"></a>02858          <span class="comment">/* Perform an extra hangup check just in case */</span>
<a name="l02859"></a>02859          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan)) {
<a name="l02860"></a>02860             <span class="keywordflow">break</span>;
<a name="l02861"></a>02861          }
<a name="l02862"></a>02862 
<a name="l02863"></a>02863          c = <a class="code" href="channel_8h.html#a5e62602ca9e229304f60ab5c2b32e13b" title="Waits for activity on a group of channels.">ast_waitfor_nandfds</a>(&amp;chan, 1, &amp;fd, nfds, NULL, &amp;outfd, &amp;ms);
<a name="l02864"></a>02864 
<a name="l02865"></a>02865          <span class="keywordflow">if</span> (c) {
<a name="l02866"></a>02866             <span class="keywordtype">char</span> <a class="code" href="chan__sip_8c.html#a1d83a7ddc8e158e8f6888c0019dd6ff7" title="mapping between dtmf flags and strings">dtmfstr</a>[2] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l02867"></a>02867 
<a name="l02868"></a>02868             <span class="keywordflow">if</span> (c-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0] != origfd || (user-&gt;<a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">dahdichannel</a> &amp;&amp; (c-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> || c-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>))) {
<a name="l02869"></a>02869                <span class="keywordflow">if</span> (using_pseudo) {
<a name="l02870"></a>02870                   <span class="comment">/* Kill old pseudo */</span>
<a name="l02871"></a>02871                   close(fd);
<a name="l02872"></a>02872                   using_pseudo = 0;
<a name="l02873"></a>02873                }
<a name="l02874"></a>02874                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, something swapped out under us, starting over\n&quot;</span>);
<a name="l02875"></a>02875                retrydahdi = (strcasecmp(c-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, <span class="stringliteral">&quot;DAHDI&quot;</span>) || (c-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> || c-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a>) ? 1 : 0);
<a name="l02876"></a>02876                user-&gt;<a class="code" href="structast__conf__user.html#af950158a50739005416f058684729d28">dahdichannel</a> = !retrydahdi;
<a name="l02877"></a>02877                <span class="keywordflow">goto</span> dahdiretry;
<a name="l02878"></a>02878             }
<a name="l02879"></a>02879             <span class="keywordflow">if</span> ((confflags &amp; CONFFLAG_MONITOR) || (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>))) {
<a name="l02880"></a>02880                f = <a class="code" href="channel_8h.html#a1950f7fe77c02d233de02d299bab8c15" title="Reads a frame, returning AST_FRAME_NULL frame if audio.">ast_read_noaudio</a>(c);
<a name="l02881"></a>02881             } <span class="keywordflow">else</span> {
<a name="l02882"></a>02882                f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(c);
<a name="l02883"></a>02883             }
<a name="l02884"></a>02884             <span class="keywordflow">if</span> (!f) {
<a name="l02885"></a>02885                <span class="keywordflow">break</span>;
<a name="l02886"></a>02886             }
<a name="l02887"></a>02887             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l02888"></a>02888                dtmfstr[0] = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02889"></a>02889                dtmfstr[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l02890"></a>02890             }
<a name="l02891"></a>02891 
<a name="l02892"></a>02892             <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>)) {
<a name="l02893"></a>02893                <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a>) {
<a name="l02894"></a>02894                   <a class="code" href="frame_8h.html#a59b72ee1caa9e8349ca017df01e8ac55" title="Adjusts the volume of the audio samples contained in a frame.">ast_frame_adjust_volume</a>(f, user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a>);
<a name="l02895"></a>02895                }
<a name="l02896"></a>02896 
<a name="l02897"></a>02897                <span class="keywordflow">if</span> (confflags &amp; (<a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">CONFFLAG_OPTIMIZETALKER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a>)) {
<a name="l02898"></a>02898                   <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> == -1) {
<a name="l02899"></a>02899                      user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> = 0;
<a name="l02900"></a>02900                   }
<a name="l02901"></a>02901 
<a name="l02902"></a>02902                   res = <a class="code" href="dsp_8h.html#a3f3b67988bffb3addfbc8a4688fa466d" title="Return non-zero if this is silence. Updates &amp;quot;totalsilence&amp;quot; with the total...">ast_dsp_silence</a>(dsp, f, &amp;totalsilence);
<a name="l02903"></a>02903                   <span class="keywordflow">if</span> (totalsilence &lt; <a class="code" href="app__meetme_8c.html#acb4e9672a8f8da6bfbe4aec38d0f6454">MEETME_DELAYDETECTTALK</a>) {
<a name="l02904"></a>02904                      <a class="code" href="app__meetme_8c.html#ae1a11424819b90f48a2f8817af8681cd">set_user_talking</a>(chan, conf, user, 1, confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a>);
<a name="l02905"></a>02905                   }
<a name="l02906"></a>02906                   <span class="keywordflow">if</span> (totalsilence &gt; <a class="code" href="app__meetme_8c.html#a36a45aad3f831056ed083856012785e3">MEETME_DELAYDETECTENDTALK</a>) {
<a name="l02907"></a>02907                      <a class="code" href="app__meetme_8c.html#ae1a11424819b90f48a2f8817af8681cd">set_user_talking</a>(chan, conf, user, 0, confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac850e96be05d72dedc69db8e9b1ee59f">CONFFLAG_MONITORTALKER</a>);
<a name="l02908"></a>02908                   }
<a name="l02909"></a>02909                }
<a name="l02910"></a>02910                <span class="keywordflow">if</span> (using_pseudo) {
<a name="l02911"></a>02911                   <span class="comment">/* Absolutely do _not_ use careful_write here...</span>
<a name="l02912"></a>02912 <span class="comment">                     it is important that we read data from the channel</span>
<a name="l02913"></a>02913 <span class="comment">                     as fast as it arrives, and feed it into the conference.</span>
<a name="l02914"></a>02914 <span class="comment">                     The buffering in the pseudo channel will take care of any</span>
<a name="l02915"></a>02915 <span class="comment">                     timing differences, unless they are so drastic as to lose</span>
<a name="l02916"></a>02916 <span class="comment">                     audio frames (in which case carefully writing would only</span>
<a name="l02917"></a>02917 <span class="comment">                     have delayed the audio even further).</span>
<a name="l02918"></a>02918 <span class="comment">                  */</span>
<a name="l02919"></a>02919                   <span class="comment">/* As it turns out, we do want to use careful write.  We just</span>
<a name="l02920"></a>02920 <span class="comment">                     don&apos;t want to block, but we do want to at least *try*</span>
<a name="l02921"></a>02921 <span class="comment">                     to write out all the samples.</span>
<a name="l02922"></a>02922 <span class="comment">                   */</span>
<a name="l02923"></a>02923                   <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> || !(confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">CONFFLAG_OPTIMIZETALKER</a>)) {
<a name="l02924"></a>02924                      <a class="code" href="app__meetme_8c.html#a274bd5a5386b1ea0514ec87feb3d8d85">careful_write</a>(fd, f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>, 0);
<a name="l02925"></a>02925                   }
<a name="l02926"></a>02926                }
<a name="l02927"></a>02927             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <span class="charliteral">&apos;*&apos;</span>) &amp;&amp; (confflags &amp; CONFFLAG_STARMENU)) || ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) &amp;&amp; menu_active)) {
<a name="l02928"></a>02928                <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a>) {
<a name="l02929"></a>02929                   <a class="code" href="app__meetme_8c.html#ada5e10a4d240af38d13e13d576b66f4a">conf_queue_dtmf</a>(conf, user, f);
<a name="l02930"></a>02930                }
<a name="l02931"></a>02931                <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic_empty)) {
<a name="l02932"></a>02932                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l02933"></a>02933                   close(fd);
<a name="l02934"></a>02934                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l02935"></a>02935                   <span class="keywordflow">goto</span> outrun;
<a name="l02936"></a>02936                }
<a name="l02937"></a>02937 
<a name="l02938"></a>02938                <span class="comment">/* if we are entering the menu, and the user has a channel-driver</span>
<a name="l02939"></a>02939 <span class="comment">                  volume adjustment, clear it</span>
<a name="l02940"></a>02940 <span class="comment">               */</span>
<a name="l02941"></a>02941                <span class="keywordflow">if</span> (!menu_active &amp;&amp; user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#a3450f7500f843178b4517d0e7ef2b537">desired</a> &amp;&amp; !user-&gt;<a class="code" href="structast__conf__user.html#a1440ae440a844aa11118c561daa182bb">talk</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a>) {
<a name="l02942"></a>02942                   <a class="code" href="app__meetme_8c.html#a4a7eef0979d0a4b9267d5bc5d98fde30">set_talk_volume</a>(user, 0);
<a name="l02943"></a>02943                }
<a name="l02944"></a>02944 
<a name="l02945"></a>02945                <span class="keywordflow">if</span> (musiconhold) {
<a name="l02946"></a>02946                      <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l02947"></a>02947                }
<a name="l02948"></a>02948                <span class="keywordflow">if</span> ((confflags &amp; CONFFLAG_ADMIN)) {
<a name="l02949"></a>02949                   <span class="comment">/* Admin menu */</span>
<a name="l02950"></a>02950                   <span class="keywordflow">if</span> (!menu_active) {
<a name="l02951"></a>02951                      menu_active = 1;
<a name="l02952"></a>02952                      <span class="comment">/* Record this sound! */</span>
<a name="l02953"></a>02953                      <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-adminmenu-162&quot;</span>, chan-&gt;language)) {
<a name="l02954"></a>02954                         dtmf = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l02955"></a>02955                         <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l02956"></a>02956                      } <span class="keywordflow">else</span> {
<a name="l02957"></a>02957                         dtmf = 0;
<a name="l02958"></a>02958                      }
<a name="l02959"></a>02959                   } <span class="keywordflow">else</span> {
<a name="l02960"></a>02960                      dtmf = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l02961"></a>02961                   }
<a name="l02962"></a>02962                   <span class="keywordflow">if</span> (dtmf) {
<a name="l02963"></a>02963                      <span class="keywordflow">switch</span>(dtmf) {
<a name="l02964"></a>02964                      <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: <span class="comment">/* Un/Mute */</span>
<a name="l02965"></a>02965                         menu_active = 0;
<a name="l02966"></a>02966 
<a name="l02967"></a>02967                         <span class="comment">/* for admin, change both admin and use flags */</span>
<a name="l02968"></a>02968                         <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) {
<a name="l02969"></a>02969                            user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp;= ~(<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>);
<a name="l02970"></a>02970                         } <span class="keywordflow">else</span> {
<a name="l02971"></a>02971                            user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>);
<a name="l02972"></a>02972                         }
<a name="l02973"></a>02973 
<a name="l02974"></a>02974                         <span class="keywordflow">if</span> ((confflags &amp; CONFFLAG_MONITOR) || (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>))) {
<a name="l02975"></a>02975                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-muted&quot;</span>, chan-&gt;language)) {
<a name="l02976"></a>02976                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02977"></a>02977                            }
<a name="l02978"></a>02978                         } <span class="keywordflow">else</span> {
<a name="l02979"></a>02979                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-unmuted&quot;</span>, chan-&gt;language)) {
<a name="l02980"></a>02980                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02981"></a>02981                            }
<a name="l02982"></a>02982                         }
<a name="l02983"></a>02983                         <span class="keywordflow">break</span>;
<a name="l02984"></a>02984                      <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>: <span class="comment">/* Un/Lock the Conference */</span>
<a name="l02985"></a>02985                         menu_active = 0;
<a name="l02986"></a>02986                         <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a>) {
<a name="l02987"></a>02987                            conf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a> = 0;
<a name="l02988"></a>02988                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-unlockednow&quot;</span>, chan-&gt;language)) {
<a name="l02989"></a>02989                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02990"></a>02990                            }
<a name="l02991"></a>02991                         } <span class="keywordflow">else</span> {
<a name="l02992"></a>02992                            conf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a> = 1;
<a name="l02993"></a>02993                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-lockednow&quot;</span>, chan-&gt;language)) {
<a name="l02994"></a>02994                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l02995"></a>02995                            }
<a name="l02996"></a>02996                         }
<a name="l02997"></a>02997                         <span class="keywordflow">break</span>;
<a name="l02998"></a>02998                      <span class="keywordflow">case</span> <span class="charliteral">&apos;3&apos;</span>: <span class="comment">/* Eject last user */</span>
<a name="l02999"></a>02999                         menu_active = 0;
<a name="l03000"></a>03000                         usr = <a class="code" href="linkedlists_8h.html#a1e37109bb72d95999821eb45f28c261c" title="Returns the last entry contained in a list.">AST_LIST_LAST</a>(&amp;conf-&gt;userlist);
<a name="l03001"></a>03001                         <span class="keywordflow">if</span> ((usr-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name == chan-&gt;name) || (usr-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; CONFFLAG_ADMIN)) {
<a name="l03002"></a>03002                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-errormenu&quot;</span>, chan-&gt;language)) {
<a name="l03003"></a>03003                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03004"></a>03004                            }
<a name="l03005"></a>03005                         } <span class="keywordflow">else</span> {
<a name="l03006"></a>03006                            usr-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a>;
<a name="l03007"></a>03007                         }
<a name="l03008"></a>03008                         <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l03009"></a>03009                         <span class="keywordflow">break</span>;   
<a name="l03010"></a>03010                      <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l03011"></a>03011                         <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l03012"></a>03012                         <span class="keywordflow">break</span>;
<a name="l03013"></a>03013                      <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l03014"></a>03014                         <span class="comment">/* Extend RT conference */</span>
<a name="l03015"></a>03015                         <span class="keywordflow">if</span> (rt_schedule) {
<a name="l03016"></a>03016                            <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#ab44c6c825cc90e2059d766b860234708">rt_extend_conf</a>(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)) {
<a name="l03017"></a>03017                               <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-extended&quot;</span>, chan-&gt;language)) {
<a name="l03018"></a>03018                                  <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03019"></a>03019                               }
<a name="l03020"></a>03020                            } <span class="keywordflow">else</span> {
<a name="l03021"></a>03021                               <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-nonextended&quot;</span>, chan-&gt;language)) {
<a name="l03022"></a>03022                                  <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03023"></a>03023                               }
<a name="l03024"></a>03024                            }
<a name="l03025"></a>03025                            <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l03026"></a>03026                         }
<a name="l03027"></a>03027                         menu_active = 0;
<a name="l03028"></a>03028                         <span class="keywordflow">break</span>;
<a name="l03029"></a>03029                      <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l03030"></a>03030                         <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l03031"></a>03031                         <span class="keywordflow">break</span>;
<a name="l03032"></a>03032                      <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:
<a name="l03033"></a>03033                         <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l03034"></a>03034                         <span class="keywordflow">break</span>;
<a name="l03035"></a>03035                      <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>:
<a name="l03036"></a>03036                         menu_active = 0;
<a name="l03037"></a>03037                         <span class="keywordflow">break</span>;
<a name="l03038"></a>03038                      <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l03039"></a>03039                         <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l03040"></a>03040                         <span class="keywordflow">break</span>;
<a name="l03041"></a>03041                      <span class="keywordflow">default</span>:
<a name="l03042"></a>03042                         menu_active = 0;
<a name="l03043"></a>03043                         <span class="comment">/* Play an error message! */</span>
<a name="l03044"></a>03044                         <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-errormenu&quot;</span>, chan-&gt;language)) {
<a name="l03045"></a>03045                            <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03046"></a>03046                         }
<a name="l03047"></a>03047                         <span class="keywordflow">break</span>;
<a name="l03048"></a>03048                      }
<a name="l03049"></a>03049                   }
<a name="l03050"></a>03050                } <span class="keywordflow">else</span> {
<a name="l03051"></a>03051                   <span class="comment">/* User menu */</span>
<a name="l03052"></a>03052                   <span class="keywordflow">if</span> (!menu_active) {
<a name="l03053"></a>03053                      menu_active = 1;
<a name="l03054"></a>03054                      <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-usermenu-162&quot;</span>, chan-&gt;language)) {
<a name="l03055"></a>03055                         dtmf = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l03056"></a>03056                         <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l03057"></a>03057                      } <span class="keywordflow">else</span> {
<a name="l03058"></a>03058                         dtmf = 0;
<a name="l03059"></a>03059                      }
<a name="l03060"></a>03060                   } <span class="keywordflow">else</span> {
<a name="l03061"></a>03061                      dtmf = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l03062"></a>03062                   }
<a name="l03063"></a>03063                   <span class="keywordflow">if</span> (dtmf) {
<a name="l03064"></a>03064                      <span class="keywordflow">switch</span> (dtmf) {
<a name="l03065"></a>03065                      <span class="keywordflow">case</span> <span class="charliteral">&apos;1&apos;</span>: <span class="comment">/* Un/Mute */</span>
<a name="l03066"></a>03066                         menu_active = 0;
<a name="l03067"></a>03067 
<a name="l03068"></a>03068                         <span class="comment">/* user can only toggle the self-muted state */</span>
<a name="l03069"></a>03069                         user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> ^= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>;
<a name="l03070"></a>03070 
<a name="l03071"></a>03071                         <span class="comment">/* they can&apos;t override the admin mute state */</span>
<a name="l03072"></a>03072                         <span class="keywordflow">if</span> ((confflags &amp; CONFFLAG_MONITOR) || (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>))) {
<a name="l03073"></a>03073                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-muted&quot;</span>, chan-&gt;language)) {
<a name="l03074"></a>03074                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03075"></a>03075                            }
<a name="l03076"></a>03076                         } <span class="keywordflow">else</span> {
<a name="l03077"></a>03077                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-unmuted&quot;</span>, chan-&gt;language)) {
<a name="l03078"></a>03078                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03079"></a>03079                            }
<a name="l03080"></a>03080                         }
<a name="l03081"></a>03081                         <span class="keywordflow">break</span>;
<a name="l03082"></a>03082                      <span class="keywordflow">case</span> <span class="charliteral">&apos;2&apos;</span>:
<a name="l03083"></a>03083                         menu_active = 0;
<a name="l03084"></a>03084                         <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) {
<a name="l03085"></a>03085                            user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>;
<a name="l03086"></a>03086                         }
<a name="l03087"></a>03087                            
<a name="l03088"></a>03088                         <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>) {
<a name="l03089"></a>03089                            <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;beep&quot;</span>, chan-&gt;language)) {
<a name="l03090"></a>03090                               <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03091"></a>03091                            }
<a name="l03092"></a>03092                         }
<a name="l03093"></a>03093                         <span class="keywordflow">break</span>;
<a name="l03094"></a>03094                      <span class="keywordflow">case</span> <span class="charliteral">&apos;4&apos;</span>:
<a name="l03095"></a>03095                         <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l03096"></a>03096                         <span class="keywordflow">break</span>;
<a name="l03097"></a>03097                      <span class="keywordflow">case</span> <span class="charliteral">&apos;5&apos;</span>:
<a name="l03098"></a>03098                         <span class="comment">/* Extend RT conference */</span>
<a name="l03099"></a>03099                         <span class="keywordflow">if</span> (rt_schedule) {
<a name="l03100"></a>03100                            <a class="code" href="app__meetme_8c.html#ab44c6c825cc90e2059d766b860234708">rt_extend_conf</a>(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l03101"></a>03101                         }
<a name="l03102"></a>03102                         menu_active = 0;
<a name="l03103"></a>03103                         <span class="keywordflow">break</span>;
<a name="l03104"></a>03104                      <span class="keywordflow">case</span> <span class="charliteral">&apos;6&apos;</span>:
<a name="l03105"></a>03105                         <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l03106"></a>03106                         <span class="keywordflow">break</span>;
<a name="l03107"></a>03107                      <span class="keywordflow">case</span> <span class="charliteral">&apos;7&apos;</span>:
<a name="l03108"></a>03108                         <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l03109"></a>03109                         <span class="keywordflow">break</span>;
<a name="l03110"></a>03110                      <span class="keywordflow">case</span> <span class="charliteral">&apos;8&apos;</span>:
<a name="l03111"></a>03111                         menu_active = 0;
<a name="l03112"></a>03112                         <span class="keywordflow">break</span>;
<a name="l03113"></a>03113                      <span class="keywordflow">case</span> <span class="charliteral">&apos;9&apos;</span>:
<a name="l03114"></a>03114                         <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l03115"></a>03115                         <span class="keywordflow">break</span>;
<a name="l03116"></a>03116                      <span class="keywordflow">default</span>:
<a name="l03117"></a>03117                         menu_active = 0;
<a name="l03118"></a>03118                         <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-errormenu&quot;</span>, chan-&gt;language)) {
<a name="l03119"></a>03119                            <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03120"></a>03120                         }
<a name="l03121"></a>03121                         <span class="keywordflow">break</span>;
<a name="l03122"></a>03122                      }
<a name="l03123"></a>03123                   }
<a name="l03124"></a>03124                }
<a name="l03125"></a>03125                <span class="keywordflow">if</span> (musiconhold) {
<a name="l03126"></a>03126                   <a class="code" href="app__meetme_8c.html#a5ab93ee8a01e294aa904de5413d78601">conf_start_moh</a>(chan, optargs[<a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">OPT_ARG_MOH_CLASS</a>]);
<a name="l03127"></a>03127                }
<a name="l03128"></a>03128 
<a name="l03129"></a>03129                <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l03130"></a>03130                   <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l03131"></a>03131                   close(fd);
<a name="l03132"></a>03132                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03133"></a>03133                   <span class="keywordflow">goto</span> outrun;
<a name="l03134"></a>03134                }
<a name="l03135"></a>03135 
<a name="l03136"></a>03136                <a class="code" href="app__meetme_8c.html#a42bbab56ce6a8eb0aaf501be26cf5271">conf_flush</a>(fd, chan);
<a name="l03137"></a>03137             <span class="comment">/* Since this option could absorb DTMF meant for the previous (menu), we have to check this one last */</span>
<a name="l03138"></a>03138             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) &amp;&amp; (confflags &amp; CONFFLAG_EXIT_CONTEXT) &amp;&amp; <a class="code" href="pbx_8h.html#a64a5b8fdc919806135ad427aca9e71b7" title="Determine whether an extension exists.">ast_exists_extension</a>(chan, exitcontext, dtmfstr, 1, <span class="stringliteral">&quot;&quot;</span>)) {
<a name="l03139"></a>03139                <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a>) {
<a name="l03140"></a>03140                   <a class="code" href="app__meetme_8c.html#ada5e10a4d240af38d13e13d576b66f4a">conf_queue_dtmf</a>(conf, user, f);
<a name="l03141"></a>03141                }
<a name="l03142"></a>03142 
<a name="l03143"></a>03143                <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a8f7166f50cb9642179c9b321b8143f55">ast_goto_if_exists</a>(chan, exitcontext, dtmfstr, 1)) {
<a name="l03144"></a>03144                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got DTMF %c, goto context %s\n&quot;</span>, dtmfstr[0], exitcontext);
<a name="l03145"></a>03145                   ret = 0;
<a name="l03146"></a>03146                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03147"></a>03147                   <span class="keywordflow">break</span>;
<a name="l03148"></a>03148                } <span class="keywordflow">else</span> {
<a name="l03149"></a>03149                   <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Exit by single digit did not work in meetme. Extension %s does not exist in context %s\n&quot;</span>, dtmfstr, exitcontext);
<a name="l03150"></a>03150                }
<a name="l03151"></a>03151             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) &amp;&amp; (confflags &amp; CONFFLAG_KEYEXIT) &amp;&amp; (strchr(exitkeys, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>))) {
<a name="l03152"></a>03152                <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_EXIT_KEY&quot;</span>, dtmfstr);
<a name="l03153"></a>03153                   
<a name="l03154"></a>03154                <span class="keywordflow">if</span> (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a>) {
<a name="l03155"></a>03155                   <a class="code" href="app__meetme_8c.html#ada5e10a4d240af38d13e13d576b66f4a">conf_queue_dtmf</a>(conf, user, f);
<a name="l03156"></a>03156                }
<a name="l03157"></a>03157                ret = 0;
<a name="l03158"></a>03158                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03159"></a>03159                <span class="keywordflow">break</span>;
<a name="l03160"></a>03160             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a> || f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>)
<a name="l03161"></a>03161                &amp;&amp; confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a>) {
<a name="l03162"></a>03162                <a class="code" href="app__meetme_8c.html#ada5e10a4d240af38d13e13d576b66f4a">conf_queue_dtmf</a>(conf, user, f);
<a name="l03163"></a>03163             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac793d6a4a78ffd301d51be06a771b70c">CONFFLAG_SLA_STATION</a>) &amp;&amp; f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) {
<a name="l03164"></a>03164                <span class="keywordflow">switch</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) {
<a name="l03165"></a>03165                <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>:
<a name="l03166"></a>03166                   <a class="code" href="app__meetme_8c.html#a5e80b8d035834753764ad2be58e4bb07" title="Queue a SLA event from the conference.">sla_queue_event_conf</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa23fb375274d3c96370d1a64e418f6a40">SLA_EVENT_HOLD</a>, chan, conf);
<a name="l03167"></a>03167                   <span class="keywordflow">break</span>;
<a name="l03168"></a>03168                <span class="keywordflow">default</span>:
<a name="l03169"></a>03169                   <span class="keywordflow">break</span>;
<a name="l03170"></a>03170                }
<a name="l03171"></a>03171             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a29ff71f9d5c7927906ebd437fe372056">AST_FRAME_NULL</a>) {
<a name="l03172"></a>03172                <span class="comment">/* Ignore NULL frames. It is perfectly normal to get these if the person is muted. */</span>
<a name="l03173"></a>03173             } <span class="keywordflow">else</span> {
<a name="l03174"></a>03174                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, 
<a name="l03175"></a>03175                   <span class="stringliteral">&quot;Got unrecognized frame on channel %s, f-&gt;frametype=%d,f-&gt;subclass=%d\n&quot;</span>,
<a name="l03176"></a>03176                   chan-&gt;name, f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l03177"></a>03177             }
<a name="l03178"></a>03178             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03179"></a>03179          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (outfd &gt; -1) {
<a name="l03180"></a>03180             res = read(outfd, buf, <a class="code" href="app__dahdibarge_8c.html#a2be5f0b8c25b67aa5ca5502d61c16b73">CONF_SIZE</a>);
<a name="l03181"></a>03181             <span class="keywordflow">if</span> (res &gt; 0) {
<a name="l03182"></a>03182                memset(&amp;fr, 0, <span class="keyword">sizeof</span>(fr));
<a name="l03183"></a>03183                fr.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l03184"></a>03184                fr.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>;
<a name="l03185"></a>03185                fr.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res;
<a name="l03186"></a>03186                fr.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = res / 2;
<a name="l03187"></a>03187                fr.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = buf;
<a name="l03188"></a>03188                fr.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = AST_FRIENDLY_OFFSET;
<a name="l03189"></a>03189                <span class="keywordflow">if</span> (!user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a> &amp;&amp;
<a name="l03190"></a>03190                   ((confflags &amp; CONFFLAG_MONITOR) ||
<a name="l03191"></a>03191                    (user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; (<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a>)) ||
<a name="l03192"></a>03192                    (!user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> &amp;&amp; (confflags &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a434e3c9758615b337ac4ab431538e60e">CONFFLAG_OPTIMIZETALKER</a>))
<a name="l03193"></a>03193                    )) {
<a name="l03194"></a>03194                   <span class="keywordtype">int</span> idx;
<a name="l03195"></a>03195                   <span class="keywordflow">for</span> (idx = 0; idx &lt; <a class="code" href="app__meetme_8c.html#addd70c99776f00581f71a71d3c10d86f">AST_FRAME_BITS</a>; idx++) {
<a name="l03196"></a>03196                      <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a> &amp; (1 &lt;&lt; idx)) {
<a name="l03197"></a>03197                         <span class="keywordflow">break</span>;
<a name="l03198"></a>03198                      }
<a name="l03199"></a>03199                   }
<a name="l03200"></a>03200                   <span class="keywordflow">if</span> (idx &gt;= AST_FRAME_BITS) {
<a name="l03201"></a>03201                      <span class="keywordflow">goto</span> bailoutandtrynormal;
<a name="l03202"></a>03202                   }
<a name="l03203"></a>03203                   <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l03204"></a>03204                   <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx]) {
<a name="l03205"></a>03205                      <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>) {
<a name="l03206"></a>03206                         <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[idx]) {
<a name="l03207"></a>03207                            conf-&gt;<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[idx] = <a class="code" href="translate_8h.html#ae53a058fb0d55f3f0b3264813b50232a" title="Builds a translator path Build a path (possibly NULL) from source to dest.">ast_translator_build_path</a>((1 &lt;&lt; idx), <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>);
<a name="l03208"></a>03208                         }
<a name="l03209"></a>03209                         <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[idx]) {
<a name="l03210"></a>03210                            conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx] = <a class="code" href="translate_8h.html#ab09d3ccb95d1f828d2871530226f9456" title="translates one or more frames Apply an input frame into the translator and receive...">ast_translate</a>(conf-&gt;<a class="code" href="structast__conference.html#a16f06197fcaec99baf94c770e1549fc8">transpath</a>[idx], conf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>, 0);
<a name="l03211"></a>03211                            <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx]) {
<a name="l03212"></a>03212                               conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx] = &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l03213"></a>03213                            }
<a name="l03214"></a>03214                         }
<a name="l03215"></a>03215                      }
<a name="l03216"></a>03216                   }
<a name="l03217"></a>03217                   <span class="keywordflow">if</span> (conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx]) {
<a name="l03218"></a>03218                      <span class="keywordflow">if</span> ((conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx]-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a29ff71f9d5c7927906ebd437fe372056">AST_FRAME_NULL</a>) &amp;&amp;
<a name="l03219"></a>03219                          <a class="code" href="app__meetme_8c.html#af7d45bcfd15042438edda998fb3ebf67">can_write</a>(chan, confflags)) {
<a name="l03220"></a>03220                         <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *cur;
<a name="l03221"></a>03221                         <span class="keywordflow">if</span> (musiconhold &amp;&amp; !<a class="code" href="dsp_8h.html#a3f3b67988bffb3addfbc8a4688fa466d" title="Return non-zero if this is silence. Updates &amp;quot;totalsilence&amp;quot; with the total...">ast_dsp_silence</a>(dsp, conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx], &amp;confsilence) &amp;&amp; confsilence &lt; <a class="code" href="app__meetme_8c.html#acb4e9672a8f8da6bfbe4aec38d0f6454">MEETME_DELAYDETECTTALK</a>) {
<a name="l03222"></a>03222                            <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l03223"></a>03223                            mohtempstopped = 1;
<a name="l03224"></a>03224                         }
<a name="l03225"></a>03225 
<a name="l03226"></a>03226                         <span class="comment">/* the translator may have returned a list of frames, so</span>
<a name="l03227"></a>03227 <span class="comment">                           write each one onto the channel</span>
<a name="l03228"></a>03228 <span class="comment">                        */</span>
<a name="l03229"></a>03229                         <span class="keywordflow">for</span> (cur = conf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[idx]; cur; cur = <a class="code" href="linkedlists_8h.html#ae234825bcb65b88c0554b995ff1b8ba6" title="Returns the next entry in the list after the given entry.">AST_LIST_NEXT</a>(cur, frame_list)) {
<a name="l03230"></a>03230                            <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, cur)) {
<a name="l03231"></a>03231                               <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to write frame to channel %s\n&quot;</span>, chan-&gt;name);
<a name="l03232"></a>03232                               <span class="keywordflow">break</span>;
<a name="l03233"></a>03233                            }
<a name="l03234"></a>03234                         }
<a name="l03235"></a>03235                         <span class="keywordflow">if</span> (musiconhold &amp;&amp; mohtempstopped &amp;&amp; confsilence &gt; <a class="code" href="app__meetme_8c.html#a36a45aad3f831056ed083856012785e3">MEETME_DELAYDETECTENDTALK</a>) {
<a name="l03236"></a>03236                            mohtempstopped = 0;
<a name="l03237"></a>03237                            <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, NULL, NULL);
<a name="l03238"></a>03238                         }
<a name="l03239"></a>03239                      }
<a name="l03240"></a>03240                   } <span class="keywordflow">else</span> {
<a name="l03241"></a>03241                      <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l03242"></a>03242                      <span class="keywordflow">goto</span> bailoutandtrynormal;
<a name="l03243"></a>03243                   }
<a name="l03244"></a>03244                   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l03245"></a>03245                } <span class="keywordflow">else</span> {
<a name="l03246"></a>03246 bailoutandtrynormal:
<a name="l03247"></a>03247                   <span class="keywordflow">if</span> (musiconhold &amp;&amp; !<a class="code" href="dsp_8h.html#a3f3b67988bffb3addfbc8a4688fa466d" title="Return non-zero if this is silence. Updates &amp;quot;totalsilence&amp;quot; with the total...">ast_dsp_silence</a>(dsp, &amp;fr, &amp;confsilence) &amp;&amp; confsilence &lt; <a class="code" href="app__meetme_8c.html#acb4e9672a8f8da6bfbe4aec38d0f6454">MEETME_DELAYDETECTTALK</a>) {
<a name="l03248"></a>03248                      <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l03249"></a>03249                      mohtempstopped = 1;
<a name="l03250"></a>03250                   }
<a name="l03251"></a>03251                   <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a>) {
<a name="l03252"></a>03252                      <a class="code" href="frame_8h.html#a59b72ee1caa9e8349ca017df01e8ac55" title="Adjusts the volume of the audio samples contained in a frame.">ast_frame_adjust_volume</a>(&amp;fr, user-&gt;<a class="code" href="structast__conf__user.html#a29a97734e4a1ebe507980f5926e02545">listen</a>.<a class="code" href="structvolume.html#ab45b5270856ae9a7c5869af590e53e18">actual</a>);
<a name="l03253"></a>03253                   }
<a name="l03254"></a>03254                   <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#af7d45bcfd15042438edda998fb3ebf67">can_write</a>(chan, confflags) &amp;&amp; <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, &amp;fr) &lt; 0) {
<a name="l03255"></a>03255                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to write frame to channel %s\n&quot;</span>, chan-&gt;name);
<a name="l03256"></a>03256                   }
<a name="l03257"></a>03257                   <span class="keywordflow">if</span> (musiconhold &amp;&amp; mohtempstopped &amp;&amp; confsilence &gt; <a class="code" href="app__meetme_8c.html#a36a45aad3f831056ed083856012785e3">MEETME_DELAYDETECTENDTALK</a>) {
<a name="l03258"></a>03258                      mohtempstopped = 0;
<a name="l03259"></a>03259                      <a class="code" href="musiconhold_8h.html#a2acec01f2fddd8ca494d874003815cf7" title="Turn on music on hold on a given channel.">ast_moh_start</a>(chan, NULL, NULL);
<a name="l03260"></a>03260                   }
<a name="l03261"></a>03261                }
<a name="l03262"></a>03262             } <span class="keywordflow">else</span> {
<a name="l03263"></a>03263                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to read frame: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03264"></a>03264             }
<a name="l03265"></a>03265          }
<a name="l03266"></a>03266          lastmarked = currentmarked;
<a name="l03267"></a>03267       }
<a name="l03268"></a>03268    }
<a name="l03269"></a>03269 
<a name="l03270"></a>03270    <span class="keywordflow">if</span> (musiconhold) {
<a name="l03271"></a>03271       <a class="code" href="musiconhold_8h.html#a52fead32f69533450f3c05b2e6960149" title="Turn off music on hold on a given channel.">ast_moh_stop</a>(chan);
<a name="l03272"></a>03272    }
<a name="l03273"></a>03273    
<a name="l03274"></a>03274    <span class="keywordflow">if</span> (using_pseudo) {
<a name="l03275"></a>03275       close(fd);
<a name="l03276"></a>03276    } <span class="keywordflow">else</span> {
<a name="l03277"></a>03277       <span class="comment">/* Take out of conference */</span>
<a name="l03278"></a>03278       dahdic.chan = 0;  
<a name="l03279"></a>03279       dahdic.confno = 0;
<a name="l03280"></a>03280       dahdic.confmode = 0;
<a name="l03281"></a>03281       <span class="keywordflow">if</span> (ioctl(fd, DAHDI_SETCONF, &amp;dahdic)) {
<a name="l03282"></a>03282          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Error setting conference\n&quot;</span>);
<a name="l03283"></a>03283       }
<a name="l03284"></a>03284    }
<a name="l03285"></a>03285 
<a name="l03286"></a>03286    <a class="code" href="app__meetme_8c.html#a57fc53d582772f2125adafaabe596b01">reset_volumes</a>(user);
<a name="l03287"></a>03287 
<a name="l03288"></a>03288    <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; !(confflags &amp; CONFFLAG_MONITOR) &amp;&amp; !(confflags &amp; CONFFLAG_ADMIN)) {
<a name="l03289"></a>03289       <a class="code" href="app__meetme_8c.html#a645090dd89fa3f8aaff60ea7eb38be18">conf_play</a>(chan, conf, <a class="code" href="app__meetme_8c.html#ab1783b8f12d2bcca727e0f1bd6f9a49bae09e07839103de682cb13fa773793fc0">LEAVE</a>);
<a name="l03290"></a>03290    }
<a name="l03291"></a>03291 
<a name="l03292"></a>03292    <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; ((confflags &amp; CONFFLAG_INTROUSER) || (confflags &amp; CONFFLAG_INTROUSERNOREVIEW)) &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> &gt; 1) {
<a name="l03293"></a>03293       <span class="keyword">struct </span><a class="code" href="structannounce__listitem.html">announce_listitem</a> *item;
<a name="l03294"></a>03294       <span class="keywordflow">if</span> (!(item = <a class="code" href="astobj2_8h.html#ae0422b60d8e25b6962b2d61ae4ddf724">ao2_alloc</a>(<span class="keyword">sizeof</span>(*item), NULL)))
<a name="l03295"></a>03295          <span class="keywordflow">return</span> -1;
<a name="l03296"></a>03296       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item-&gt;namerecloc, user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>, <span class="keyword">sizeof</span>(item-&gt;namerecloc));
<a name="l03297"></a>03297       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(item-&gt;language, chan-&gt;language, <span class="keyword">sizeof</span>(item-&gt;language));
<a name="l03298"></a>03298       item-&gt;confchan = conf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>;
<a name="l03299"></a>03299       item-&gt;confusers = conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>;
<a name="l03300"></a>03300       item-&gt;announcetype = <a class="code" href="app__meetme_8c.html#a3b7f07302bc7a2fc4184e561679749bfafe977bca19aa4a5f72ff226a312b74af">CONF_HASLEFT</a>;
<a name="l03301"></a>03301       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;conf-&gt;announcelistlock);
<a name="l03302"></a>03302       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;conf-&gt;announcelist, item, entry);
<a name="l03303"></a>03303       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;conf-&gt;announcelist_addition);
<a name="l03304"></a>03304       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;conf-&gt;announcelistlock);
<a name="l03305"></a>03305    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!(confflags &amp; CONFFLAG_QUIET) &amp;&amp; ((confflags &amp; CONFFLAG_INTROUSER) || (confflags &amp; CONFFLAG_INTROUSERNOREVIEW)) &amp;&amp; conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a> == 1) {
<a name="l03306"></a>03306       <span class="comment">/* Last person is leaving, so no reason to try and announce, but should delete the name recording */</span>
<a name="l03307"></a>03307       <a class="code" href="file_8h.html#adb15d6efecc1a13b8835bee6d3562ddb" title="Deletes a file.">ast_filedelete</a>(user-&gt;<a class="code" href="structast__conf__user.html#a13694b21aad2389727cbb9dac418fef6">namerecloc</a>, NULL);
<a name="l03308"></a>03308    }
<a name="l03309"></a>03309 
<a name="l03310"></a>03310  outrun:
<a name="l03311"></a>03311    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l03312"></a>03312 
<a name="l03313"></a>03313    <span class="keywordflow">if</span> (dsp) {
<a name="l03314"></a>03314       <a class="code" href="dsp_8h.html#a0a57a1e374549eb2705068688f4046db">ast_dsp_free</a>(dsp);
<a name="l03315"></a>03315    }
<a name="l03316"></a>03316    
<a name="l03317"></a>03317    <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>) { <span class="comment">/* Only cleanup users who really joined! */</span>
<a name="l03318"></a>03318       now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03319"></a>03319       hr = (now.tv_sec - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>) / 3600;
<a name="l03320"></a>03320       min = ((now.tv_sec - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>) % 3600) / 60;
<a name="l03321"></a>03321       sec = (now.tv_sec - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>) % 60;
<a name="l03322"></a>03322 
<a name="l03323"></a>03323       <span class="keywordflow">if</span> (sent_event) {
<a name="l03324"></a>03324          <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, <span class="stringliteral">&quot;MeetmeLeave&quot;</span>,
<a name="l03325"></a>03325                   <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l03326"></a>03326                   <span class="stringliteral">&quot;Uniqueid: %s\r\n&quot;</span>
<a name="l03327"></a>03327                   <span class="stringliteral">&quot;Meetme: %s\r\n&quot;</span>
<a name="l03328"></a>03328                   <span class="stringliteral">&quot;Usernum: %d\r\n&quot;</span>
<a name="l03329"></a>03329                   <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l03330"></a>03330                   <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l03331"></a>03331                   <span class="stringliteral">&quot;Duration: %ld\r\n&quot;</span>,
<a name="l03332"></a>03332                   chan-&gt;name, chan-&gt;uniqueid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, 
<a name="l03333"></a>03333                   user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>,
<a name="l03334"></a>03334                   <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l03335"></a>03335                   <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l03336"></a>03336                   (<span class="keywordtype">long</span>)(now.tv_sec - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>));
<a name="l03337"></a>03337       }
<a name="l03338"></a>03338 
<a name="l03339"></a>03339       <span class="keywordflow">if</span> (setusercount) {
<a name="l03340"></a>03340          conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>--;
<a name="l03341"></a>03341          <span class="keywordflow">if</span> (rt_log_members) {
<a name="l03342"></a>03342             <span class="comment">/* Update table */</span>
<a name="l03343"></a>03343             snprintf(members, <span class="keyword">sizeof</span>(members), <span class="stringliteral">&quot;%d&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>);
<a name="l03344"></a>03344             <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;meetme&quot;</span>,
<a name="l03345"></a>03345                <span class="stringliteral">&quot;confno&quot;</span>, strlen(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>) &gt; 7 ? <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a27acda71d87003db19a6e0b4193a32be">RQ_UINTEGER4</a> : strlen(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>) &gt; 4 ? <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ad3163600ec26815e26092d9eb3e4b0b5">RQ_UINTEGER3</a> : <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>, strlen(conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>),
<a name="l03346"></a>03346                <span class="stringliteral">&quot;members&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ae8c94d6fa08e17f6f86792727b201bf9">RQ_UINTEGER1</a>, strlen(members),
<a name="l03347"></a>03347                NULL);
<a name="l03348"></a>03348             <a class="code" href="config_8h.html#ab845019b2f1bb324ff57e14192d62c39" title="Update realtime configuration.">ast_update_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="stringliteral">&quot;members&quot;</span>, members, NULL);
<a name="l03349"></a>03349          }
<a name="l03350"></a>03350          <span class="keywordflow">if</span> (confflags &amp; CONFFLAG_MARKEDUSER) {
<a name="l03351"></a>03351             conf-&gt;<a class="code" href="structast__conference.html#a296e7410cb3a0e6d09c2e602d783bf15">markedusers</a>--;
<a name="l03352"></a>03352          }
<a name="l03353"></a>03353       }
<a name="l03354"></a>03354       <span class="comment">/* Remove ourselves from the list */</span>
<a name="l03355"></a>03355       <a class="code" href="linkedlists_8h.html#aa36e72b77f1b80881cd0a9fcca66ce19" title="Removes a specific entry from a list.">AST_LIST_REMOVE</a>(&amp;conf-&gt;userlist, user, list);
<a name="l03356"></a>03356 
<a name="l03357"></a>03357       <span class="comment">/* Change any states */</span>
<a name="l03358"></a>03358       <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>) {
<a name="l03359"></a>03359          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>, <span class="stringliteral">&quot;meetme:%s&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l03360"></a>03360       }
<a name="l03361"></a>03361 
<a name="l03362"></a>03362       <span class="comment">/* Return the number of seconds the user was in the conf */</span>
<a name="l03363"></a>03363       snprintf(meetmesecs, <span class="keyword">sizeof</span>(meetmesecs), <span class="stringliteral">&quot;%d&quot;</span>, (<span class="keywordtype">int</span>) (time(NULL) - user-&gt;<a class="code" href="structast__conf__user.html#a12f01daf47a1827d4ae33b345da7d46b">jointime</a>));
<a name="l03364"></a>03364       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETMESECS&quot;</span>, meetmesecs);
<a name="l03365"></a>03365    }
<a name="l03366"></a>03366    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(user);
<a name="l03367"></a>03367    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l03368"></a>03368 
<a name="l03369"></a>03369    <span class="keywordflow">return</span> ret;
<a name="l03370"></a>03370 }
<a name="l03371"></a>03371 
<a name="l03372"></a><a class="code" href="app__meetme_8c.html#a8579cbb47c8b2278452889dd35d03d1e">03372</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *<a class="code" href="app__meetme_8c.html#a8579cbb47c8b2278452889dd35d03d1e">find_conf_realtime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="keywordtype">int</span> make, <span class="keywordtype">int</span> dynamic,
<a name="l03373"></a>03373             <span class="keywordtype">char</span> *dynamic_pin, <span class="keywordtype">size_t</span> pin_buf_len, <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *confflags, <span class="keywordtype">int</span> *too_early)
<a name="l03374"></a>03374 {
<a name="l03375"></a>03375    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>, *origvar;
<a name="l03376"></a>03376    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf;
<a name="l03377"></a>03377 
<a name="l03378"></a>03378    *too_early = 0;
<a name="l03379"></a>03379 
<a name="l03380"></a>03380    <span class="comment">/* Check first in the conference list */</span>
<a name="l03381"></a>03381    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l03382"></a>03382    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l03383"></a>03383       <span class="keywordflow">if</span> (!strcmp(confno, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)) 
<a name="l03384"></a>03384          <span class="keywordflow">break</span>;
<a name="l03385"></a>03385    }
<a name="l03386"></a>03386    <span class="keywordflow">if</span> (cnf) {
<a name="l03387"></a>03387       cnf-&gt;<a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a> += refcount;
<a name="l03388"></a>03388    }
<a name="l03389"></a>03389    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l03390"></a>03390 
<a name="l03391"></a>03391    <span class="keywordflow">if</span> (!cnf) {
<a name="l03392"></a>03392       <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a> = NULL, *<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a> = NULL; <span class="comment">/* For temp use */</span>
<a name="l03393"></a>03393       <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">maxusers</a> = 0;
<a name="l03394"></a>03394       <span class="keyword">struct </span>timeval now;
<a name="l03395"></a>03395       <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03396"></a>03396       <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>[11] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03397"></a>03397       <span class="keywordtype">char</span> currenttime[19] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03398"></a>03398       <span class="keywordtype">char</span> eatime[19] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03399"></a>03399       <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a9c9fece27d0906bb0c5e522e26c92d7f">bookid</a>[51] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03400"></a>03400       <span class="keywordtype">char</span> recordingtmp[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03401"></a>03401       <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">useropts</a>[<a class="code" href="app__meetme_8c.html#a83128aa5fb371ea385d8bc0f6186e20f">OPTIONS_LEN</a> + 1]; <span class="comment">/* Used for RealTime conferences */</span>
<a name="l03402"></a>03402       <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#afa3f2aa238dd1090b0ab5e87b9188f2a">adminopts</a>[<a class="code" href="app__meetme_8c.html#a83128aa5fb371ea385d8bc0f6186e20f">OPTIONS_LEN</a> + 1];
<a name="l03403"></a>03403       <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm, etm;
<a name="l03404"></a>03404       <span class="keyword">struct </span>timeval endtime = { .tv_sec = 0 };
<a name="l03405"></a>03405       <span class="keyword">const</span> <span class="keywordtype">char</span> *var2;
<a name="l03406"></a>03406 
<a name="l03407"></a>03407       <span class="keywordflow">if</span> (rt_schedule) {
<a name="l03408"></a>03408          now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03409"></a>03409 
<a name="l03410"></a>03410          <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l03411"></a>03411          <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(currenttime, <span class="keyword">sizeof</span>(currenttime), <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;tm);
<a name="l03412"></a>03412 
<a name="l03413"></a>03413          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Looking for conference %s that starts after %s\n&quot;</span>, confno, eatime);
<a name="l03414"></a>03414 
<a name="l03415"></a>03415          var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>,
<a name="l03416"></a>03416             confno, <span class="stringliteral">&quot;starttime &lt;= &quot;</span>, currenttime, <span class="stringliteral">&quot;endtime &gt;= &quot;</span>,
<a name="l03417"></a>03417             currenttime, NULL);
<a name="l03418"></a>03418 
<a name="l03419"></a>03419          <span class="keywordflow">if</span> (!var &amp;&amp; fuzzystart) {
<a name="l03420"></a>03420             now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03421"></a>03421             now.tv_sec += fuzzystart;
<a name="l03422"></a>03422 
<a name="l03423"></a>03423             <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;tm, NULL);
<a name="l03424"></a>03424             <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(currenttime, <span class="keyword">sizeof</span>(currenttime), <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;tm);
<a name="l03425"></a>03425             var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>,
<a name="l03426"></a>03426                confno, <span class="stringliteral">&quot;starttime &lt;= &quot;</span>, currenttime, <span class="stringliteral">&quot;endtime &gt;= &quot;</span>,
<a name="l03427"></a>03427                currenttime, NULL);
<a name="l03428"></a>03428          }
<a name="l03429"></a>03429 
<a name="l03430"></a>03430          <span class="keywordflow">if</span> (!var &amp;&amp; earlyalert) {
<a name="l03431"></a>03431             now = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03432"></a>03432             now.tv_sec += earlyalert;
<a name="l03433"></a>03433             <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;now, &amp;etm, NULL);
<a name="l03434"></a>03434             <a class="code" href="localtime_8h.html#aa8e63928b14a347bd3973d680b885f93" title="Special version of strftime(3) that handles fractions of a second. Takes the same...">ast_strftime</a>(eatime, <span class="keyword">sizeof</span>(eatime), <a class="code" href="app__meetme_8c.html#af3a7249af0dc84e61384327caa331213">DATE_FORMAT</a>, &amp;etm);
<a name="l03435"></a>03435             var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>,
<a name="l03436"></a>03436                confno, <span class="stringliteral">&quot;starttime &lt;= &quot;</span>, eatime, <span class="stringliteral">&quot;endtime &gt;= &quot;</span>,
<a name="l03437"></a>03437                currenttime, NULL);
<a name="l03438"></a>03438             <span class="keywordflow">if</span> (var) {
<a name="l03439"></a>03439                *too_early = 1;
<a name="l03440"></a>03440             }
<a name="l03441"></a>03441          }
<a name="l03442"></a>03442 
<a name="l03443"></a>03443       } <span class="keywordflow">else</span> {
<a name="l03444"></a>03444           var = <a class="code" href="config_8h.html#a1a03993603e2bc2463153857836645bb" title="Retrieve realtime configuration.">ast_load_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>, confno, NULL);
<a name="l03445"></a>03445       }
<a name="l03446"></a>03446 
<a name="l03447"></a>03447       <span class="keywordflow">if</span> (!var)
<a name="l03448"></a>03448          <span class="keywordflow">return</span> NULL;
<a name="l03449"></a>03449 
<a name="l03450"></a>03450       <span class="keywordflow">if</span> (rt_schedule &amp;&amp; *too_early) {
<a name="l03451"></a>03451          <span class="comment">/* Announce that the caller is early and exit */</span>
<a name="l03452"></a>03452          <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-has-not-started&quot;</span>, chan-&gt;language))
<a name="l03453"></a>03453             <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03454"></a>03454          <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(var);
<a name="l03455"></a>03455          <span class="keywordflow">return</span> NULL;
<a name="l03456"></a>03456       }
<a name="l03457"></a>03457 
<a name="l03458"></a>03458       <span class="keywordflow">for</span> (origvar = var; var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03459"></a>03459          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;pin&quot;</span>)) {
<a name="l03460"></a>03460             pin = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03461"></a>03461          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;adminpin&quot;</span>)) {
<a name="l03462"></a>03462             pinadmin = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03463"></a>03463          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;bookId&quot;</span>)) {
<a name="l03464"></a>03464             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(bookid, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(bookid));
<a name="l03465"></a>03465          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;opts&quot;</span>)) {
<a name="l03466"></a>03466             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(useropts, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>[<a class="code" href="app__meetme_8c.html#a83128aa5fb371ea385d8bc0f6186e20f">OPTIONS_LEN</a> + 1]));
<a name="l03467"></a>03467          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxusers&quot;</span>)) {
<a name="l03468"></a>03468             maxusers = atoi(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l03469"></a>03469          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;adminopts&quot;</span>)) {
<a name="l03470"></a>03470             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(adminopts, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>[<a class="code" href="app__meetme_8c.html#a83128aa5fb371ea385d8bc0f6186e20f">OPTIONS_LEN</a> + 1]));
<a name="l03471"></a>03471          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;recordingfilename&quot;</span>)) {
<a name="l03472"></a>03472             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(recordingfilename, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(recordingfilename));
<a name="l03473"></a>03473          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;recordingformat&quot;</span>)) {
<a name="l03474"></a>03474             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(recordingformat, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(recordingformat));
<a name="l03475"></a>03475          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;endtime&quot;</span>)) {
<a name="l03476"></a>03476             <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> endtime_tm;
<a name="l03477"></a>03477             <a class="code" href="localtime_8h.html#a3eb2c73accce1b149ce597de80d1677a" title="Special version of strptime(3) which places the answer in the common structure ast_tm...">ast_strptime</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%Y-%m-%d %H:%M:%S&quot;</span>, &amp;endtime_tm);
<a name="l03478"></a>03478             endtime = <a class="code" href="localtime_8h.html#ae0843e4dbbd1fed36d2676dda58e0c44" title="Timezone-independent version of mktime(3).">ast_mktime</a>(&amp;endtime_tm, NULL);
<a name="l03479"></a>03479          }
<a name="l03480"></a>03480       }
<a name="l03481"></a>03481 
<a name="l03482"></a>03482       <a class="code" href="config_8h.html#ad3d8122172af6f13687a07840411d65d" title="Free variable list.">ast_variables_destroy</a>(origvar);
<a name="l03483"></a>03483 
<a name="l03484"></a>03484       cnf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(confno, pin ? pin : <span class="stringliteral">&quot;&quot;</span>, pinadmin ? pinadmin : <span class="stringliteral">&quot;&quot;</span>, make, dynamic, refcount, chan);
<a name="l03485"></a>03485 
<a name="l03486"></a>03486       <span class="keywordflow">if</span> (cnf) {
<a name="l03487"></a>03487          cnf-&gt;<a class="code" href="structast__conference.html#ad7b1f4e72963d085053fb4ef80e9fb33">maxusers</a> = maxusers;
<a name="l03488"></a>03488          cnf-&gt;<a class="code" href="structast__conference.html#a35cc725664fd0b4f53fbbb7d0f15c038">endalert</a> = endalert;
<a name="l03489"></a>03489          cnf-&gt;<a class="code" href="structast__conference.html#afaeff193ffee212d48e41d1b523e21e5">endtime</a> = endtime.tv_sec;
<a name="l03490"></a>03490          cnf-&gt;<a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">useropts</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(useropts);
<a name="l03491"></a>03491          cnf-&gt;<a class="code" href="structast__conference.html#afa3f2aa238dd1090b0ab5e87b9188f2a">adminopts</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(adminopts);
<a name="l03492"></a>03492          cnf-&gt;<a class="code" href="structast__conference.html#a9c9fece27d0906bb0c5e522e26c92d7f">bookid</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(bookid);
<a name="l03493"></a>03493          cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(recordingfilename);
<a name="l03494"></a>03494          cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(recordingformat);
<a name="l03495"></a>03495 
<a name="l03496"></a>03496          <span class="keywordflow">if</span> (strchr(cnf-&gt;<a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">useropts</a>, <span class="charliteral">&apos;r&apos;</span>)) {
<a name="l03497"></a>03497             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(recordingfilename)) { <span class="comment">/* If the recordingfilename in the database is empty, use the channel definition or use the default. */</span>
<a name="l03498"></a>03498                <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l03499"></a>03499                <span class="keywordflow">if</span> ((var2 = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_RECORDINGFILE&quot;</span>))) {
<a name="l03500"></a>03500                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>);
<a name="l03501"></a>03501                   cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(var2);
<a name="l03502"></a>03502                }
<a name="l03503"></a>03503                <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l03504"></a>03504                <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>)) {
<a name="l03505"></a>03505                   snprintf(recordingtmp, <span class="keyword">sizeof</span>(recordingtmp), <span class="stringliteral">&quot;meetme-conf-rec-%s-%s&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, chan-&gt;uniqueid);
<a name="l03506"></a>03506                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>);
<a name="l03507"></a>03507                   cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(recordingtmp);
<a name="l03508"></a>03508                }
<a name="l03509"></a>03509             }
<a name="l03510"></a>03510             <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>)) {<span class="comment">/* If the recording format is empty, use the wav as default */</span>
<a name="l03511"></a>03511                <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l03512"></a>03512                <span class="keywordflow">if</span> ((var2 = <a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;MEETME_RECORDINGFORMAT&quot;</span>))) {
<a name="l03513"></a>03513                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>);
<a name="l03514"></a>03514                   cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(var2);
<a name="l03515"></a>03515                }
<a name="l03516"></a>03516                <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l03517"></a>03517                <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>)) {
<a name="l03518"></a>03518                   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>);
<a name="l03519"></a>03519                   cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a> = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(<span class="stringliteral">&quot;wav&quot;</span>);
<a name="l03520"></a>03520                }
<a name="l03521"></a>03521             }
<a name="l03522"></a>03522             <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Starting recording of MeetMe Conference %s into file %s.%s.\n&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>, cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>);
<a name="l03523"></a>03523          }
<a name="l03524"></a>03524       }
<a name="l03525"></a>03525    }
<a name="l03526"></a>03526 
<a name="l03527"></a>03527    <span class="keywordflow">if</span> (cnf) {
<a name="l03528"></a>03528       <span class="keywordflow">if</span> (confflags &amp;&amp; !cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp;
<a name="l03529"></a>03529           !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a>) &amp;&amp;
<a name="l03530"></a>03530           <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a>)) {
<a name="l03531"></a>03531          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No DAHDI channel available for conference, user introduction disabled (is chan_dahdi loaded?)\n&quot;</span>);
<a name="l03532"></a>03532          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a>);
<a name="l03533"></a>03533       }
<a name="l03534"></a>03534       
<a name="l03535"></a>03535       <span class="keywordflow">if</span> (confflags &amp;&amp; !cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp;
<a name="l03536"></a>03536           <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a>)) {
<a name="l03537"></a>03537          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No DAHDI channel available for conference, conference recording disabled (is chan_dahdi loaded?)\n&quot;</span>);
<a name="l03538"></a>03538          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a>);
<a name="l03539"></a>03539       }
<a name="l03540"></a>03540    }
<a name="l03541"></a>03541 
<a name="l03542"></a>03542    <span class="keywordflow">return</span> cnf;
<a name="l03543"></a>03543 }
<a name="l03544"></a>03544 
<a name="l03545"></a>03545 
<a name="l03546"></a><a class="code" href="app__meetme_8c.html#a0e667c64978e611801b6e8aa02165341">03546</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *<a class="code" href="app__meetme_8c.html#a0e667c64978e611801b6e8aa02165341">find_conf</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">char</span> *<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, <span class="keywordtype">int</span> make, <span class="keywordtype">int</span> dynamic,
<a name="l03547"></a>03547                <span class="keywordtype">char</span> *dynamic_pin, <span class="keywordtype">size_t</span> pin_buf_len, <span class="keywordtype">int</span> <a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>, <span class="keyword">struct</span> <a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> *confflags)
<a name="l03548"></a>03548 {
<a name="l03549"></a>03549    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l03550"></a>03550    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l03551"></a>03551    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l03552"></a>03552    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf;
<a name="l03553"></a>03553 
<a name="l03554"></a>03554    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l03555"></a>03555       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(confno);
<a name="l03556"></a>03556       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>);
<a name="l03557"></a>03557       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>);
<a name="l03558"></a>03558    );
<a name="l03559"></a>03559 
<a name="l03560"></a>03560    <span class="comment">/* Check first in the conference list */</span>
<a name="l03561"></a>03561    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;The requested confno is &apos;%s&apos;?\n&quot;</span>, confno);
<a name="l03562"></a>03562    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l03563"></a>03563    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l03564"></a>03564       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Does conf %s match %s?\n&quot;</span>, confno, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l03565"></a>03565       <span class="keywordflow">if</span> (!strcmp(confno, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)) 
<a name="l03566"></a>03566          <span class="keywordflow">break</span>;
<a name="l03567"></a>03567    }
<a name="l03568"></a>03568    <span class="keywordflow">if</span> (cnf) {
<a name="l03569"></a>03569       cnf-&gt;<a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a> += refcount;
<a name="l03570"></a>03570    }
<a name="l03571"></a>03571    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l03572"></a>03572 
<a name="l03573"></a>03573    <span class="keywordflow">if</span> (!cnf) {
<a name="l03574"></a>03574       <span class="keywordflow">if</span> (dynamic) {
<a name="l03575"></a>03575          <span class="comment">/* No need to parse meetme.conf */</span>
<a name="l03576"></a>03576          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Building dynamic conference &apos;%s&apos;\n&quot;</span>, confno);
<a name="l03577"></a>03577          <span class="keywordflow">if</span> (dynamic_pin) {
<a name="l03578"></a>03578             <span class="keywordflow">if</span> (dynamic_pin[0] == <span class="charliteral">&apos;q&apos;</span>) {
<a name="l03579"></a>03579                <span class="comment">/* Query the user to enter a PIN */</span>
<a name="l03580"></a>03580                <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;conf-getpin&quot;</span>, dynamic_pin, pin_buf_len - 1, 0) &lt; 0)
<a name="l03581"></a>03581                   <span class="keywordflow">return</span> NULL;
<a name="l03582"></a>03582             }
<a name="l03583"></a>03583             cnf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(confno, dynamic_pin, <span class="stringliteral">&quot;&quot;</span>, make, dynamic, refcount, chan);
<a name="l03584"></a>03584          } <span class="keywordflow">else</span> {
<a name="l03585"></a>03585             cnf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(confno, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, make, dynamic, refcount, chan);
<a name="l03586"></a>03586          }
<a name="l03587"></a>03587       } <span class="keywordflow">else</span> {
<a name="l03588"></a>03588          <span class="comment">/* Check the config */</span>
<a name="l03589"></a>03589          cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">CONFIG_FILE_NAME</a>, config_flags);
<a name="l03590"></a>03590          <span class="keywordflow">if</span> (!cfg) {
<a name="l03591"></a>03591             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No %s file :(\n&quot;</span>, <a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">CONFIG_FILE_NAME</a>);
<a name="l03592"></a>03592             <span class="keywordflow">return</span> NULL;
<a name="l03593"></a>03593          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l03594"></a>03594             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">CONFIG_FILE_NAME</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l03595"></a>03595             <span class="keywordflow">return</span> NULL;
<a name="l03596"></a>03596          }
<a name="l03597"></a>03597 
<a name="l03598"></a>03598          <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;rooms&quot;</span>); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l03599"></a>03599             <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>[<a class="code" href="app__meetme_8c.html#afad3aadf1645aabf53eea7d30a839411">MAX_SETTINGS</a>];
<a name="l03600"></a>03600 
<a name="l03601"></a>03601             <span class="keywordflow">if</span> (strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;conf&quot;</span>))
<a name="l03602"></a>03602                <span class="keywordflow">continue</span>;
<a name="l03603"></a>03603 
<a name="l03604"></a>03604             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parse, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(parse));
<a name="l03605"></a>03605 
<a name="l03606"></a>03606             <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l03607"></a>03607             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Will conf %s match %s?\n&quot;</span>, confno, args.confno);
<a name="l03608"></a>03608             <span class="keywordflow">if</span> (!strcasecmp(args.confno, confno)) {
<a name="l03609"></a>03609                <span class="comment">/* Bingo it&apos;s a valid conference */</span>
<a name="l03610"></a>03610                cnf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(args.confno,
<a name="l03611"></a>03611                      <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args.pin, <span class="stringliteral">&quot;&quot;</span>),
<a name="l03612"></a>03612                      <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(args.pinadmin, <span class="stringliteral">&quot;&quot;</span>),
<a name="l03613"></a>03613                      make, dynamic, refcount, chan);
<a name="l03614"></a>03614                <span class="keywordflow">break</span>;
<a name="l03615"></a>03615             }
<a name="l03616"></a>03616          }
<a name="l03617"></a>03617          <span class="keywordflow">if</span> (!var) {
<a name="l03618"></a>03618             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;%s isn&apos;t a valid conference\n&quot;</span>, confno);
<a name="l03619"></a>03619          }
<a name="l03620"></a>03620          <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03621"></a>03621       }
<a name="l03622"></a>03622    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (dynamic_pin) {
<a name="l03623"></a>03623       <span class="comment">/* Correct for the user selecting &apos;D&apos; instead of &apos;d&apos; to have</span>
<a name="l03624"></a>03624 <span class="comment">         someone join into a conference that has already been created</span>
<a name="l03625"></a>03625 <span class="comment">         with a pin. */</span>
<a name="l03626"></a>03626       <span class="keywordflow">if</span> (dynamic_pin[0] == <span class="charliteral">&apos;q&apos;</span>) {
<a name="l03627"></a>03627          dynamic_pin[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03628"></a>03628       }
<a name="l03629"></a>03629    }
<a name="l03630"></a>03630 
<a name="l03631"></a>03631    <span class="keywordflow">if</span> (cnf) {
<a name="l03632"></a>03632       <span class="keywordflow">if</span> (confflags &amp;&amp; !cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp;
<a name="l03633"></a>03633           !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a>) &amp;&amp;
<a name="l03634"></a>03634           <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a>)) {
<a name="l03635"></a>03635          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No DAHDI channel available for conference, user introduction disabled (is chan_dahdi loaded?)\n&quot;</span>);
<a name="l03636"></a>03636          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a35d067d4438a97ce462e0cb2a2dcb2bb">CONFFLAG_INTROUSER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a1ebb7d640cd5b3a979cb419950eb48b6">CONFFLAG_INTROUSERNOREVIEW</a>);
<a name="l03637"></a>03637       }
<a name="l03638"></a>03638       
<a name="l03639"></a>03639       <span class="keywordflow">if</span> (confflags &amp;&amp; !cnf-&gt;<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a> &amp;&amp;
<a name="l03640"></a>03640           <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a>)) {
<a name="l03641"></a>03641          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;No DAHDI channel available for conference, conference recording disabled (is chan_dahdi loaded?)\n&quot;</span>);
<a name="l03642"></a>03642          <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac76f0581b1c02bf15a8d6b8e607ef24a">CONFFLAG_RECORDCONF</a>);
<a name="l03643"></a>03643       }
<a name="l03644"></a>03644    }
<a name="l03645"></a>03645 
<a name="l03646"></a>03646    <span class="keywordflow">return</span> cnf;
<a name="l03647"></a>03647 }
<a name="l03648"></a>03648 <span class="comment"></span>
<a name="l03649"></a>03649 <span class="comment">/*! \brief The MeetmeCount application */</span>
<a name="l03650"></a><a class="code" href="app__meetme_8c.html#ac2605fd5ab063711c6927f212d325fb3">03650</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ac2605fd5ab063711c6927f212d325fb3" title="The MeetmeCount application.">count_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l03651"></a>03651 {
<a name="l03652"></a>03652    <span class="keywordtype">int</span> res = 0;
<a name="l03653"></a>03653    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l03654"></a>03654    <span class="keywordtype">int</span> count;
<a name="l03655"></a>03655    <span class="keywordtype">char</span> *localdata;
<a name="l03656"></a>03656    <span class="keywordtype">char</span> <a class="code" href="structval.html">val</a>[80] = <span class="stringliteral">&quot;0&quot;</span>; 
<a name="l03657"></a>03657    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l03658"></a>03658       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l03659"></a>03659       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(varname);
<a name="l03660"></a>03660    );
<a name="l03661"></a>03661 
<a name="l03662"></a>03662    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l03663"></a>03663       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MeetMeCount requires an argument (conference number)\n&quot;</span>);
<a name="l03664"></a>03664       <span class="keywordflow">return</span> -1;
<a name="l03665"></a>03665    }
<a name="l03666"></a>03666    
<a name="l03667"></a>03667    <span class="keywordflow">if</span> (!(localdata = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data)))
<a name="l03668"></a>03668       <span class="keywordflow">return</span> -1;
<a name="l03669"></a>03669 
<a name="l03670"></a>03670    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, localdata);
<a name="l03671"></a>03671    
<a name="l03672"></a>03672    conf = <a class="code" href="app__meetme_8c.html#a0e667c64978e611801b6e8aa02165341">find_conf</a>(chan, args.confno, 0, 0, NULL, 0, 1, NULL);
<a name="l03673"></a>03673 
<a name="l03674"></a>03674    <span class="keywordflow">if</span> (conf) {
<a name="l03675"></a>03675       count = conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>;
<a name="l03676"></a>03676       <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(conf);
<a name="l03677"></a>03677       conf = NULL;
<a name="l03678"></a>03678    } <span class="keywordflow">else</span>
<a name="l03679"></a>03679       count = 0;
<a name="l03680"></a>03680 
<a name="l03681"></a>03681    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.varname)) {
<a name="l03682"></a>03682       <span class="comment">/* have var so load it and exit */</span>
<a name="l03683"></a>03683       snprintf(val, <span class="keyword">sizeof</span>(val), <span class="stringliteral">&quot;%d&quot;</span>, count);
<a name="l03684"></a>03684       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, args.varname, val);
<a name="l03685"></a>03685    } <span class="keywordflow">else</span> {
<a name="l03686"></a>03686       <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l03687"></a>03687          <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l03688"></a>03688       }
<a name="l03689"></a>03689       res = <a class="code" href="say_8h.html#a899e1f86b2d65a32eeb6e17aabfa1f12" title="says a number">ast_say_number</a>(chan, count, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language, (<span class="keywordtype">char</span> *) NULL); <span class="comment">/* Needs gender */</span>
<a name="l03690"></a>03690    }
<a name="l03691"></a>03691 
<a name="l03692"></a>03692    <span class="keywordflow">return</span> res;
<a name="l03693"></a>03693 }
<a name="l03694"></a>03694 <span class="comment"></span>
<a name="l03695"></a>03695 <span class="comment">/*! \brief The meetme() application */</span>
<a name="l03696"></a><a class="code" href="app__meetme_8c.html#ab3d72f98849ba4b68853af4a26c82d7e">03696</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ab3d72f98849ba4b68853af4a26c82d7e" title="The meetme() application.">conf_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l03697"></a>03697 {
<a name="l03698"></a>03698    <span class="keywordtype">int</span> res = -1;
<a name="l03699"></a>03699    <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>[<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03700"></a>03700    <span class="keywordtype">int</span> allowretry = 0;
<a name="l03701"></a>03701    <span class="keywordtype">int</span> retrycnt = 0;
<a name="l03702"></a>03702    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf = NULL;
<a name="l03703"></a>03703    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> confflags = {0}, <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a> = { 0 };
<a name="l03704"></a>03704    <span class="keywordtype">int</span> dynamic = 0;
<a name="l03705"></a>03705    <span class="keywordtype">int</span> empty = 0, empty_no_pin = 0;
<a name="l03706"></a>03706    <span class="keywordtype">int</span> always_prompt = 0;
<a name="l03707"></a>03707    <span class="keywordtype">char</span> *notdata, *info, the_pin[<a class="code" href="app__meetme_8c.html#a636a212051cf4b5561e4c3ee652a58fe">MAX_PIN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03708"></a>03708    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l03709"></a>03709       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(confno);
<a name="l03710"></a>03710       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l03711"></a>03711       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>);
<a name="l03712"></a>03712    );
<a name="l03713"></a>03713    <span class="keywordtype">char</span> *optargs[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>] = { NULL, };
<a name="l03714"></a>03714 
<a name="l03715"></a>03715    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l03716"></a>03716       allowretry = 1;
<a name="l03717"></a>03717       notdata = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03718"></a>03718    } <span class="keywordflow">else</span> {
<a name="l03719"></a>03719       notdata = data;
<a name="l03720"></a>03720    }
<a name="l03721"></a>03721    
<a name="l03722"></a>03722    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>)
<a name="l03723"></a>03723       <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l03724"></a>03724 
<a name="l03725"></a>03725    info = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(notdata);
<a name="l03726"></a>03726 
<a name="l03727"></a>03727    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, info);  
<a name="l03728"></a>03728 
<a name="l03729"></a>03729    <span class="keywordflow">if</span> (args.confno) {
<a name="l03730"></a>03730       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(confno, args.confno, <span class="keyword">sizeof</span>(confno));
<a name="l03731"></a>03731       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(confno)) {
<a name="l03732"></a>03732          allowretry = 1;
<a name="l03733"></a>03733       }
<a name="l03734"></a>03734    }
<a name="l03735"></a>03735    
<a name="l03736"></a>03736    <span class="keywordflow">if</span> (args.pin)
<a name="l03737"></a>03737       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(the_pin, args.pin, <span class="keyword">sizeof</span>(the_pin));
<a name="l03738"></a>03738 
<a name="l03739"></a>03739    <span class="keywordflow">if</span> (args.options) {
<a name="l03740"></a>03740       <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(meetme_opts, &amp;confflags, optargs, args.options);
<a name="l03741"></a>03741       dynamic = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae83ea6d46f620c57461a6df40e7b321c">CONFFLAG_DYNAMIC</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a85da35a1f1708d3792f40ddfdde12919">CONFFLAG_DYNAMICPIN</a>);
<a name="l03742"></a>03742       <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a85da35a1f1708d3792f40ddfdde12919">CONFFLAG_DYNAMICPIN</a>) &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.pin))
<a name="l03743"></a>03743          strcpy(the_pin, <span class="stringliteral">&quot;q&quot;</span>);
<a name="l03744"></a>03744 
<a name="l03745"></a>03745       empty = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a829c143c29ff7d7c84cf2a4b6a86cfe9">CONFFLAG_EMPTY</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae572ce074f616f8c0d48ce7a7b4d7546">CONFFLAG_EMPTYNOPIN</a>);
<a name="l03746"></a>03746       empty_no_pin = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ae572ce074f616f8c0d48ce7a7b4d7546">CONFFLAG_EMPTYNOPIN</a>);
<a name="l03747"></a>03747       always_prompt = <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a403c4698d20d41dffb30064fdd738c09">CONFFLAG_ALWAYSPROMPT</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a85da35a1f1708d3792f40ddfdde12919">CONFFLAG_DYNAMICPIN</a>);
<a name="l03748"></a>03748    }
<a name="l03749"></a>03749 
<a name="l03750"></a>03750    <span class="keywordflow">do</span> {
<a name="l03751"></a>03751       <span class="keywordflow">if</span> (retrycnt &gt; 3)
<a name="l03752"></a>03752          allowretry = 0;
<a name="l03753"></a>03753       <span class="keywordflow">if</span> (empty) {
<a name="l03754"></a>03754          <span class="keywordtype">int</span> i;
<a name="l03755"></a>03755          <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l03756"></a>03756          <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l03757"></a>03757          <span class="keywordtype">int</span> confno_int;
<a name="l03758"></a>03758 
<a name="l03759"></a>03759          <span class="comment">/* We only need to load the config file for static and empty_no_pin (otherwise we don&apos;t care) */</span>
<a name="l03760"></a>03760          <span class="keywordflow">if</span> ((empty_no_pin) || (!dynamic)) {
<a name="l03761"></a>03761             cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">CONFIG_FILE_NAME</a>, <a class="code" href="app__rpt_8c.html#a1f57f20c1f46890828791a4827fe8752">config_flags</a>);
<a name="l03762"></a>03762             <span class="keywordflow">if</span> (cfg &amp;&amp; cfg != <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l03763"></a>03763                var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, <span class="stringliteral">&quot;rooms&quot;</span>);
<a name="l03764"></a>03764                <span class="keywordflow">while</span> (var) {
<a name="l03765"></a>03765                   <span class="keywordtype">char</span> <a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>[<a class="code" href="app__meetme_8c.html#afad3aadf1645aabf53eea7d30a839411">MAX_SETTINGS</a>], *stringp = parse, *confno_tmp;
<a name="l03766"></a>03766                   <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;conf&quot;</span>)) {
<a name="l03767"></a>03767                      <span class="keywordtype">int</span> found = 0;
<a name="l03768"></a>03768                      <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(parse, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(parse));
<a name="l03769"></a>03769                      confno_tmp = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;|,&quot;</span>);
<a name="l03770"></a>03770                      <span class="keywordflow">if</span> (!dynamic) {
<a name="l03771"></a>03771                         <span class="comment">/* For static:  run through the list and see if this conference is empty */</span>
<a name="l03772"></a>03772                         <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l03773"></a>03773                         <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l03774"></a>03774                            <span class="keywordflow">if</span> (!strcmp(confno_tmp, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)) {
<a name="l03775"></a>03775                               <span class="comment">/* The conference exists, therefore it&apos;s not empty */</span>
<a name="l03776"></a>03776                               found = 1;
<a name="l03777"></a>03777                               <span class="keywordflow">break</span>;
<a name="l03778"></a>03778                            }
<a name="l03779"></a>03779                         }
<a name="l03780"></a>03780                         <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l03781"></a>03781                         <span class="keywordflow">if</span> (!found) {
<a name="l03782"></a>03782                            <span class="comment">/* At this point, we have a confno_tmp (static conference) that is empty */</span>
<a name="l03783"></a>03783                            <span class="keywordflow">if</span> ((empty_no_pin &amp;&amp; <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(stringp)) || (!empty_no_pin)) {
<a name="l03784"></a>03784                               <span class="comment">/* Case 1:  empty_no_pin and pin is nonexistent (NULL)</span>
<a name="l03785"></a>03785 <span class="comment">                               * Case 2:  empty_no_pin and pin is blank (but not NULL)</span>
<a name="l03786"></a>03786 <span class="comment">                               * Case 3:  not empty_no_pin</span>
<a name="l03787"></a>03787 <span class="comment">                               */</span>
<a name="l03788"></a>03788                               <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(confno, confno_tmp, <span class="keyword">sizeof</span>(confno));
<a name="l03789"></a>03789                               <span class="keywordflow">break</span>;
<a name="l03790"></a>03790                               <span class="comment">/* XXX the map is not complete (but we do have a confno) */</span>
<a name="l03791"></a>03791                            }
<a name="l03792"></a>03792                         }
<a name="l03793"></a>03793                      }
<a name="l03794"></a>03794                   }
<a name="l03795"></a>03795                   var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>;
<a name="l03796"></a>03796                }
<a name="l03797"></a>03797                <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l03798"></a>03798             }
<a name="l03799"></a>03799          }
<a name="l03800"></a>03800 
<a name="l03801"></a>03801          <span class="comment">/* Select first conference number not in use */</span>
<a name="l03802"></a>03802          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(confno) &amp;&amp; dynamic) {
<a name="l03803"></a>03803             <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l03804"></a>03804             <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">conf_map</a>); i++) {
<a name="l03805"></a>03805                <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">conf_map</a>[i]) {
<a name="l03806"></a>03806                   snprintf(confno, <span class="keyword">sizeof</span>(confno), <span class="stringliteral">&quot;%d&quot;</span>, i);
<a name="l03807"></a>03807                   <a class="code" href="app__meetme_8c.html#a27bb593e08b2fbe3c75194dcd6e83856">conf_map</a>[i] = 1;
<a name="l03808"></a>03808                   <span class="keywordflow">break</span>;
<a name="l03809"></a>03809                }
<a name="l03810"></a>03810             }
<a name="l03811"></a>03811             <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l03812"></a>03812          }
<a name="l03813"></a>03813 
<a name="l03814"></a>03814          <span class="comment">/* Not found? */</span>
<a name="l03815"></a>03815          <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(confno)) {
<a name="l03816"></a>03816             res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-noempty&quot;</span>, chan-&gt;language);
<a name="l03817"></a>03817             <span class="keywordflow">if</span> (!res)
<a name="l03818"></a>03818                <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03819"></a>03819          } <span class="keywordflow">else</span> {
<a name="l03820"></a>03820             <span class="keywordflow">if</span> (sscanf(confno, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;confno_int) == 1) {
<a name="l03821"></a>03821                <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a>)) {
<a name="l03822"></a>03822                   res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-enteringno&quot;</span>, chan-&gt;language);
<a name="l03823"></a>03823                   <span class="keywordflow">if</span> (!res) {
<a name="l03824"></a>03824                      <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03825"></a>03825                      res = <a class="code" href="say_8h.html#a7cf9dcf6ae6fcedb7752d0deac683b3b" title="says digits">ast_say_digits</a>(chan, confno_int, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language);
<a name="l03826"></a>03826                   }
<a name="l03827"></a>03827                }
<a name="l03828"></a>03828             } <span class="keywordflow">else</span> {
<a name="l03829"></a>03829                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not scan confno &apos;%s&apos;\n&quot;</span>, confno);
<a name="l03830"></a>03830             }
<a name="l03831"></a>03831          }
<a name="l03832"></a>03832       }
<a name="l03833"></a>03833 
<a name="l03834"></a>03834       <span class="keywordflow">while</span> (allowretry &amp;&amp; (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(confno)) &amp;&amp; (++retrycnt &lt; 4)) {
<a name="l03835"></a>03835          <span class="comment">/* Prompt user for conference number */</span>
<a name="l03836"></a>03836          res = <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;conf-getconfno&quot;</span>, confno, <span class="keyword">sizeof</span>(confno) - 1, 0);
<a name="l03837"></a>03837          <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03838"></a>03838             <span class="comment">/* Don&apos;t try to validate when we catch an error */</span>
<a name="l03839"></a>03839             confno[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03840"></a>03840             allowretry = 0;
<a name="l03841"></a>03841             <span class="keywordflow">break</span>;
<a name="l03842"></a>03842          }
<a name="l03843"></a>03843       }
<a name="l03844"></a>03844       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(confno)) {
<a name="l03845"></a>03845          <span class="comment">/* Check the validity of the conference */</span>
<a name="l03846"></a>03846          cnf = <a class="code" href="app__meetme_8c.html#a0e667c64978e611801b6e8aa02165341">find_conf</a>(chan, confno, 1, dynamic, the_pin, 
<a name="l03847"></a>03847             <span class="keyword">sizeof</span>(the_pin), 1, &amp;confflags);
<a name="l03848"></a>03848          <span class="keywordflow">if</span> (!cnf) {
<a name="l03849"></a>03849             <span class="keywordtype">int</span> too_early = 0;
<a name="l03850"></a>03850 
<a name="l03851"></a>03851             cnf = <a class="code" href="app__meetme_8c.html#a8579cbb47c8b2278452889dd35d03d1e">find_conf_realtime</a>(chan, confno, 1, dynamic, 
<a name="l03852"></a>03852                the_pin, <span class="keyword">sizeof</span>(the_pin), 1, &amp;confflags,&amp;too_early);
<a name="l03853"></a>03853             <span class="keywordflow">if</span> (rt_schedule &amp;&amp; too_early)
<a name="l03854"></a>03854                allowretry = 0;
<a name="l03855"></a>03855          }
<a name="l03856"></a>03856 
<a name="l03857"></a>03857          <span class="keywordflow">if</span> (!cnf) {
<a name="l03858"></a>03858             <span class="keywordflow">if</span> (allowretry) {
<a name="l03859"></a>03859                confno[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03860"></a>03860                res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-invalid&quot;</span>, chan-&gt;language);
<a name="l03861"></a>03861                <span class="keywordflow">if</span> (!res)
<a name="l03862"></a>03862                   <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);
<a name="l03863"></a>03863                res = -1;
<a name="l03864"></a>03864             }
<a name="l03865"></a>03865          } <span class="keywordflow">else</span> {
<a name="l03866"></a>03866             <span class="keywordflow">if</span> ((!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>) &amp;&amp;
<a name="l03867"></a>03867                  !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a>)) ||
<a name="l03868"></a>03868                 (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>) &amp;&amp;
<a name="l03869"></a>03869                  <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;confflags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a>))) {
<a name="l03870"></a>03870                <span class="keywordtype">char</span> <a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>[<a class="code" href="app__meetme_8c.html#a636a212051cf4b5561e4c3ee652a58fe">MAX_PIN</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l03871"></a>03871                <span class="keywordtype">int</span> j;
<a name="l03872"></a>03872 
<a name="l03873"></a>03873                <span class="comment">/* Allow the pin to be retried up to 3 times */</span>
<a name="l03874"></a>03874                <span class="keywordflow">for</span> (j = 0; j &lt; 3; j++) {
<a name="l03875"></a>03875                   <span class="keywordflow">if</span> (*the_pin &amp;&amp; (always_prompt == 0)) {
<a name="l03876"></a>03876                      <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(pin, the_pin, <span class="keyword">sizeof</span>(pin));
<a name="l03877"></a>03877                      res = 0;
<a name="l03878"></a>03878                   } <span class="keywordflow">else</span> {
<a name="l03879"></a>03879                      <span class="comment">/* Prompt user for pin if pin is required */</span>
<a name="l03880"></a>03880                      res = <a class="code" href="app_8h.html#af3f76858d4dd513e59dbe5e67bc46220" title="Plays a stream and gets DTMF data from a channel.">ast_app_getdata</a>(chan, <span class="stringliteral">&quot;conf-getpin&quot;</span>, pin + strlen(pin), <span class="keyword">sizeof</span>(pin) - 1 - strlen(pin), 0);
<a name="l03881"></a>03881                   }
<a name="l03882"></a>03882                   <span class="keywordflow">if</span> (res &gt;= 0) {
<a name="l03883"></a>03883                      <span class="keywordflow">if</span> (!strcasecmp(pin, cnf-&gt;<a class="code" href="structast__conference.html#ad3479638ded235d29e4bbba475abe931">pin</a>) ||
<a name="l03884"></a>03884                          (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>) &amp;&amp;
<a name="l03885"></a>03885                           !strcasecmp(pin, cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>))) {
<a name="l03886"></a>03886                         <span class="comment">/* Pin correct */</span>
<a name="l03887"></a>03887                         allowretry = 0;
<a name="l03888"></a>03888                         <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>) &amp;&amp; !strcasecmp(pin, cnf-&gt;<a class="code" href="structast__conference.html#a55bf7560e1af9d7a731e41340e23c669">pinadmin</a>)) {
<a name="l03889"></a>03889                            <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#afa3f2aa238dd1090b0ab5e87b9188f2a">adminopts</a>)) {
<a name="l03890"></a>03890                               <span class="keywordtype">char</span> *opts = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(cnf-&gt;<a class="code" href="structast__conference.html#afa3f2aa238dd1090b0ab5e87b9188f2a">adminopts</a>);
<a name="l03891"></a>03891                               <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(meetme_opts, &amp;confflags, optargs, opts);
<a name="l03892"></a>03892                            }
<a name="l03893"></a>03893                         } <span class="keywordflow">else</span> {
<a name="l03894"></a>03894                            <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(cnf-&gt;<a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">useropts</a>)) {
<a name="l03895"></a>03895                               <span class="keywordtype">char</span> *opts = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(cnf-&gt;<a class="code" href="structast__conference.html#a925d07390890a216d14e47a42b59eb05">useropts</a>);
<a name="l03896"></a>03896                               <a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(meetme_opts, &amp;confflags, optargs, opts);
<a name="l03897"></a>03897                            }
<a name="l03898"></a>03898                         }
<a name="l03899"></a>03899                         <span class="comment">/* Run the conference */</span>
<a name="l03900"></a>03900                         <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(4, <span class="stringliteral">&quot;Starting recording of MeetMe Conference %s into file %s.%s.\n&quot;</span>, cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>, cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>);
<a name="l03901"></a>03901                         res = <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(chan, cnf, confflags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, optargs);
<a name="l03902"></a>03902                         <span class="keywordflow">break</span>;
<a name="l03903"></a>03903                      } <span class="keywordflow">else</span> {
<a name="l03904"></a>03904                         <span class="comment">/* Pin invalid */</span>
<a name="l03905"></a>03905                         <span class="keywordflow">if</span> (!<a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, <span class="stringliteral">&quot;conf-invalidpin&quot;</span>, chan-&gt;language)) {
<a name="l03906"></a>03906                            res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <a class="code" href="file_8h.html#afa92b0106fb7a918ea994c2867ac0a04">AST_DIGIT_ANY</a>);
<a name="l03907"></a>03907                            <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l03908"></a>03908                         } <span class="keywordflow">else</span> {
<a name="l03909"></a>03909                            <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Couldn&apos;t play invalid pin msg!\n&quot;</span>);
<a name="l03910"></a>03910                            <span class="keywordflow">break</span>;
<a name="l03911"></a>03911                         }
<a name="l03912"></a>03912                         <span class="keywordflow">if</span> (res &lt; 0)
<a name="l03913"></a>03913                            <span class="keywordflow">break</span>;
<a name="l03914"></a>03914                         pin[0] = res;
<a name="l03915"></a>03915                         pin[1] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03916"></a>03916                         res = -1;
<a name="l03917"></a>03917                         <span class="keywordflow">if</span> (allowretry)
<a name="l03918"></a>03918                            confno[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l03919"></a>03919                      }
<a name="l03920"></a>03920                   } <span class="keywordflow">else</span> {
<a name="l03921"></a>03921                      <span class="comment">/* failed when getting the pin */</span>
<a name="l03922"></a>03922                      res = -1;
<a name="l03923"></a>03923                      allowretry = 0;
<a name="l03924"></a>03924                      <span class="comment">/* see if we need to get rid of the conference */</span>
<a name="l03925"></a>03925                      <span class="keywordflow">break</span>;
<a name="l03926"></a>03926                   }
<a name="l03927"></a>03927 
<a name="l03928"></a>03928                   <span class="comment">/* Don&apos;t retry pin with a static pin */</span>
<a name="l03929"></a>03929                   <span class="keywordflow">if</span> (*the_pin &amp;&amp; (always_prompt == 0)) {
<a name="l03930"></a>03930                      <span class="keywordflow">break</span>;
<a name="l03931"></a>03931                   }
<a name="l03932"></a>03932                }
<a name="l03933"></a>03933             } <span class="keywordflow">else</span> {
<a name="l03934"></a>03934                <span class="comment">/* No pin required */</span>
<a name="l03935"></a>03935                allowretry = 0;
<a name="l03936"></a>03936 
<a name="l03937"></a>03937                <span class="comment">/* Run the conference */</span>
<a name="l03938"></a>03938                res = <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(chan, cnf, confflags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, optargs);
<a name="l03939"></a>03939             }
<a name="l03940"></a>03940             <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(cnf);
<a name="l03941"></a>03941             cnf = NULL;
<a name="l03942"></a>03942          }
<a name="l03943"></a>03943       }
<a name="l03944"></a>03944    } <span class="keywordflow">while</span> (allowretry);
<a name="l03945"></a>03945 
<a name="l03946"></a>03946    <span class="keywordflow">if</span> (cnf)
<a name="l03947"></a>03947       <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(cnf);
<a name="l03948"></a>03948    
<a name="l03949"></a>03949    <span class="keywordflow">return</span> res;
<a name="l03950"></a>03950 }
<a name="l03951"></a>03951 
<a name="l03952"></a><a class="code" href="app__meetme_8c.html#a98f74798580526d927574ac5e5941b22">03952</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="app__meetme_8c.html#a98f74798580526d927574ac5e5941b22">find_user</a>(<span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf, <span class="keywordtype">char</span> *callerident) 
<a name="l03953"></a>03953 {
<a name="l03954"></a>03954    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l03955"></a>03955    <span class="keywordtype">int</span> cid;
<a name="l03956"></a>03956    
<a name="l03957"></a>03957    sscanf(callerident, <span class="stringliteral">&quot;%30i&quot;</span>, &amp;cid);
<a name="l03958"></a>03958    <span class="keywordflow">if</span> (conf &amp;&amp; callerident) {
<a name="l03959"></a>03959       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conf-&gt;userlist, user, list) {
<a name="l03960"></a>03960          <span class="keywordflow">if</span> (cid == user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>)
<a name="l03961"></a>03961             <span class="keywordflow">return</span> user;
<a name="l03962"></a>03962       }
<a name="l03963"></a>03963    }
<a name="l03964"></a>03964    <span class="keywordflow">return</span> NULL;
<a name="l03965"></a>03965 }
<a name="l03966"></a>03966 <span class="comment"></span>
<a name="l03967"></a>03967 <span class="comment">/*! \brief The MeetMeadmin application */</span>
<a name="l03968"></a>03968 <span class="comment">/* MeetMeAdmin(confno, command, caller) */</span>
<a name="l03969"></a><a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7">03969</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data) {
<a name="l03970"></a>03970    <span class="keywordtype">char</span> *params;
<a name="l03971"></a>03971    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf;
<a name="l03972"></a>03972    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l03973"></a>03973    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l03974"></a>03974       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l03975"></a>03975       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(command);
<a name="l03976"></a>03976       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(user);
<a name="l03977"></a>03977    );
<a name="l03978"></a>03978    <span class="keywordtype">int</span> res = 0;
<a name="l03979"></a>03979 
<a name="l03980"></a>03980    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l03981"></a>03981       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MeetMeAdmin requires an argument!\n&quot;</span>);
<a name="l03982"></a>03982       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETMEADMINSTATUS&quot;</span>, <span class="stringliteral">&quot;NOPARSE&quot;</span>);
<a name="l03983"></a>03983       <span class="keywordflow">return</span> -1;
<a name="l03984"></a>03984    }
<a name="l03985"></a>03985 
<a name="l03986"></a>03986    params = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l03987"></a>03987    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, params);
<a name="l03988"></a>03988 
<a name="l03989"></a>03989    <span class="keywordflow">if</span> (!args.command) {
<a name="l03990"></a>03990       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MeetmeAdmin requires a command!\n&quot;</span>);
<a name="l03991"></a>03991       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETMEADMINSTATUS&quot;</span>, <span class="stringliteral">&quot;NOPARSE&quot;</span>);
<a name="l03992"></a>03992       <span class="keywordflow">return</span> -1;
<a name="l03993"></a>03993    }
<a name="l03994"></a>03994 
<a name="l03995"></a>03995    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l03996"></a>03996    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l03997"></a>03997       <span class="keywordflow">if</span> (!strcmp(cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, args.confno))
<a name="l03998"></a>03998          <span class="keywordflow">break</span>;
<a name="l03999"></a>03999    }
<a name="l04000"></a>04000 
<a name="l04001"></a>04001    <span class="keywordflow">if</span> (!cnf) {
<a name="l04002"></a>04002       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Conference number &apos;%s&apos; not found!\n&quot;</span>, args.confno);
<a name="l04003"></a>04003       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04004"></a>04004       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETMEADMINSTATUS&quot;</span>, <span class="stringliteral">&quot;NOTFOUND&quot;</span>);
<a name="l04005"></a>04005       <span class="keywordflow">return</span> 0;
<a name="l04006"></a>04006    }
<a name="l04007"></a>04007 
<a name="l04008"></a>04008    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#a6022c8a609170c7365fb96e83cb2df48">refcount</a>, 1);
<a name="l04009"></a>04009 
<a name="l04010"></a>04010    <span class="keywordflow">if</span> (args.user)
<a name="l04011"></a>04011       user = <a class="code" href="app__meetme_8c.html#a98f74798580526d927574ac5e5941b22">find_user</a>(cnf, args.user);
<a name="l04012"></a>04012 
<a name="l04013"></a>04013    <span class="keywordflow">switch</span> (*args.command) {
<a name="l04014"></a>04014    <span class="keywordflow">case</span> 76: <span class="comment">/* L: Lock */</span> 
<a name="l04015"></a>04015       cnf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a> = 1;
<a name="l04016"></a>04016       <span class="keywordflow">break</span>;
<a name="l04017"></a>04017    <span class="keywordflow">case</span> 108: <span class="comment">/* l: Unlock */</span> 
<a name="l04018"></a>04018       cnf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a> = 0;
<a name="l04019"></a>04019       <span class="keywordflow">break</span>;
<a name="l04020"></a>04020    <span class="keywordflow">case</span> 75: <span class="comment">/* K: kick all users */</span>
<a name="l04021"></a>04021       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list)
<a name="l04022"></a>04022          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a>;
<a name="l04023"></a>04023       <span class="keywordflow">break</span>;
<a name="l04024"></a>04024    <span class="keywordflow">case</span> 101: <span class="comment">/* e: Eject last user*/</span>
<a name="l04025"></a>04025       user = <a class="code" href="linkedlists_8h.html#a1e37109bb72d95999821eb45f28c261c" title="Returns the last entry contained in a list.">AST_LIST_LAST</a>(&amp;cnf-&gt;userlist);
<a name="l04026"></a>04026       <span class="keywordflow">if</span> (!(user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a>))
<a name="l04027"></a>04027          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a>;
<a name="l04028"></a>04028       <span class="keywordflow">else</span> {
<a name="l04029"></a>04029          res = -1;
<a name="l04030"></a>04030          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Not kicking last user, is an Admin!\n&quot;</span>);
<a name="l04031"></a>04031       }
<a name="l04032"></a>04032       <span class="keywordflow">break</span>;
<a name="l04033"></a>04033    <span class="keywordflow">case</span> 77: <span class="comment">/* M: Mute */</span> 
<a name="l04034"></a>04034       <span class="keywordflow">if</span> (user) {
<a name="l04035"></a>04035          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a>;
<a name="l04036"></a>04036       } <span class="keywordflow">else</span> {
<a name="l04037"></a>04037          res = -2;
<a name="l04038"></a>04038          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04039"></a>04039       }
<a name="l04040"></a>04040       <span class="keywordflow">break</span>;
<a name="l04041"></a>04041    <span class="keywordflow">case</span> 78: <span class="comment">/* N: Mute all (non-admin) users */</span>
<a name="l04042"></a>04042       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04043"></a>04043          <span class="keywordflow">if</span> (!(user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a>)) {
<a name="l04044"></a>04044             user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a>;
<a name="l04045"></a>04045          }
<a name="l04046"></a>04046       }
<a name="l04047"></a>04047       <span class="keywordflow">break</span>;               
<a name="l04048"></a>04048    <span class="keywordflow">case</span> 109: <span class="comment">/* m: Unmute */</span> 
<a name="l04049"></a>04049       <span class="keywordflow">if</span> (user) {
<a name="l04050"></a>04050          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp;= ~(<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>);
<a name="l04051"></a>04051       } <span class="keywordflow">else</span> {
<a name="l04052"></a>04052          res = -2;
<a name="l04053"></a>04053          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04054"></a>04054       }
<a name="l04055"></a>04055       <span class="keywordflow">break</span>;
<a name="l04056"></a>04056    <span class="keywordflow">case</span> 110: <span class="comment">/* n: Unmute all users */</span>
<a name="l04057"></a>04057       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04058"></a>04058          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp;= ~(<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>);
<a name="l04059"></a>04059       }
<a name="l04060"></a>04060       <span class="keywordflow">break</span>;
<a name="l04061"></a>04061    <span class="keywordflow">case</span> 107: <span class="comment">/* k: Kick user */</span> 
<a name="l04062"></a>04062       <span class="keywordflow">if</span> (user) {
<a name="l04063"></a>04063          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a>;
<a name="l04064"></a>04064       } <span class="keywordflow">else</span> {
<a name="l04065"></a>04065          res = -2;
<a name="l04066"></a>04066          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04067"></a>04067       }
<a name="l04068"></a>04068       <span class="keywordflow">break</span>;
<a name="l04069"></a>04069    <span class="keywordflow">case</span> 118: <span class="comment">/* v: Lower all users listen volume */</span>
<a name="l04070"></a>04070       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04071"></a>04071          <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l04072"></a>04072       }
<a name="l04073"></a>04073       <span class="keywordflow">break</span>;
<a name="l04074"></a>04074    <span class="keywordflow">case</span> 86: <span class="comment">/* V: Raise all users listen volume */</span>
<a name="l04075"></a>04075       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04076"></a>04076          <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l04077"></a>04077       }
<a name="l04078"></a>04078       <span class="keywordflow">break</span>;
<a name="l04079"></a>04079    <span class="keywordflow">case</span> 115: <span class="comment">/* s: Lower all users speaking volume */</span>
<a name="l04080"></a>04080       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04081"></a>04081          <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l04082"></a>04082       }
<a name="l04083"></a>04083       <span class="keywordflow">break</span>;
<a name="l04084"></a>04084    <span class="keywordflow">case</span> 83: <span class="comment">/* S: Raise all users speaking volume */</span>
<a name="l04085"></a>04085       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04086"></a>04086          <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l04087"></a>04087       }
<a name="l04088"></a>04088       <span class="keywordflow">break</span>;
<a name="l04089"></a>04089    <span class="keywordflow">case</span> 82: <span class="comment">/* R: Reset all volume levels */</span>
<a name="l04090"></a>04090       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04091"></a>04091          <a class="code" href="app__meetme_8c.html#a57fc53d582772f2125adafaabe596b01">reset_volumes</a>(user);
<a name="l04092"></a>04092       }
<a name="l04093"></a>04093       <span class="keywordflow">break</span>;
<a name="l04094"></a>04094    <span class="keywordflow">case</span> 114: <span class="comment">/* r: Reset user&apos;s volume level */</span>
<a name="l04095"></a>04095       <span class="keywordflow">if</span> (user) {
<a name="l04096"></a>04096          <a class="code" href="app__meetme_8c.html#a57fc53d582772f2125adafaabe596b01">reset_volumes</a>(user);
<a name="l04097"></a>04097       } <span class="keywordflow">else</span> {
<a name="l04098"></a>04098          res = -2;
<a name="l04099"></a>04099          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04100"></a>04100       }
<a name="l04101"></a>04101       <span class="keywordflow">break</span>;
<a name="l04102"></a>04102    <span class="keywordflow">case</span> 85: <span class="comment">/* U: Raise user&apos;s listen volume */</span>
<a name="l04103"></a>04103       <span class="keywordflow">if</span> (user) {
<a name="l04104"></a>04104          <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l04105"></a>04105       } <span class="keywordflow">else</span> {
<a name="l04106"></a>04106          res = -2;
<a name="l04107"></a>04107          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04108"></a>04108       }
<a name="l04109"></a>04109       <span class="keywordflow">break</span>;
<a name="l04110"></a>04110    <span class="keywordflow">case</span> 117: <span class="comment">/* u: Lower user&apos;s listen volume */</span>
<a name="l04111"></a>04111       <span class="keywordflow">if</span> (user) {
<a name="l04112"></a>04112          <a class="code" href="app__meetme_8c.html#a1357a2b3f3188e9ed96885a40c8108b0">tweak_listen_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l04113"></a>04113       } <span class="keywordflow">else</span> {
<a name="l04114"></a>04114          res = -2;
<a name="l04115"></a>04115          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04116"></a>04116       }
<a name="l04117"></a>04117       <span class="keywordflow">break</span>;
<a name="l04118"></a>04118    <span class="keywordflow">case</span> 84: <span class="comment">/* T: Raise user&apos;s talk volume */</span>
<a name="l04119"></a>04119       <span class="keywordflow">if</span> (user) {
<a name="l04120"></a>04120          <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780ba4d83dedb6411e852fbed173dbb216123">VOL_UP</a>);
<a name="l04121"></a>04121       } <span class="keywordflow">else</span> {
<a name="l04122"></a>04122          res = -2;
<a name="l04123"></a>04123          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04124"></a>04124       }
<a name="l04125"></a>04125       <span class="keywordflow">break</span>;
<a name="l04126"></a>04126    <span class="keywordflow">case</span> 116: <span class="comment">/* t: Lower user&apos;s talk volume */</span>
<a name="l04127"></a>04127       <span class="keywordflow">if</span> (user) {
<a name="l04128"></a>04128          <a class="code" href="app__meetme_8c.html#a89c58e019ddc321d5cd5b264a664a7d5">tweak_talk_volume</a>(user, <a class="code" href="app__meetme_8c.html#a18aaa7767ea9a06a32c263e477dc780baeea08ef426ebbd9daa124e73fb7b33e2">VOL_DOWN</a>);
<a name="l04129"></a>04129       } <span class="keywordflow">else</span> {
<a name="l04130"></a>04130          res = -2;
<a name="l04131"></a>04131          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified User not found!\n&quot;</span>);
<a name="l04132"></a>04132       }
<a name="l04133"></a>04133       <span class="keywordflow">break</span>;
<a name="l04134"></a>04134    <span class="keywordflow">case</span> <span class="charliteral">&apos;E&apos;</span>: <span class="comment">/* E: Extend conference */</span>
<a name="l04135"></a>04135       <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#ab44c6c825cc90e2059d766b860234708">rt_extend_conf</a>(args.confno)) {
<a name="l04136"></a>04136          res = -1;
<a name="l04137"></a>04137       }
<a name="l04138"></a>04138       <span class="keywordflow">break</span>;
<a name="l04139"></a>04139    }
<a name="l04140"></a>04140 
<a name="l04141"></a>04141    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04142"></a>04142 
<a name="l04143"></a>04143    <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(cnf);
<a name="l04144"></a>04144    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;MEETMEADMINSTATUS&quot;</span>, res == -2 ? <span class="stringliteral">&quot;NOTFOUND&quot;</span> : res ? <span class="stringliteral">&quot;FAILED&quot;</span> : <span class="stringliteral">&quot;OK&quot;</span>);
<a name="l04145"></a>04145 
<a name="l04146"></a>04146    <span class="keywordflow">return</span> 0;
<a name="l04147"></a>04147 }
<a name="l04148"></a>04148 
<a name="l04149"></a>04149 <span class="comment">/*--- channel_admin_exec: The MeetMeChannelAdmin application */</span>
<a name="l04150"></a>04150 <span class="comment">/* MeetMeChannelAdmin(channel, command) */</span>
<a name="l04151"></a><a class="code" href="app__meetme_8c.html#aa6dfc370c805dae454a69268a537f491">04151</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#aa6dfc370c805dae454a69268a537f491">channel_admin_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data) {
<a name="l04152"></a>04152    <span class="keywordtype">char</span> *params;
<a name="l04153"></a>04153    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf = NULL;
<a name="l04154"></a>04154    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a> = NULL;
<a name="l04155"></a>04155    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l04156"></a>04156       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(channel);
<a name="l04157"></a>04157       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(command);
<a name="l04158"></a>04158    );
<a name="l04159"></a>04159 
<a name="l04160"></a>04160    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l04161"></a>04161       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MeetMeChannelAdmin requires two arguments!\n&quot;</span>);
<a name="l04162"></a>04162       <span class="keywordflow">return</span> -1;
<a name="l04163"></a>04163    }
<a name="l04164"></a>04164    
<a name="l04165"></a>04165    params = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l04166"></a>04166    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, params);
<a name="l04167"></a>04167 
<a name="l04168"></a>04168    <span class="keywordflow">if</span> (!args.channel) {
<a name="l04169"></a>04169       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MeetMeChannelAdmin requires a channel name!\n&quot;</span>);
<a name="l04170"></a>04170       <span class="keywordflow">return</span> -1;
<a name="l04171"></a>04171    }
<a name="l04172"></a>04172 
<a name="l04173"></a>04173    <span class="keywordflow">if</span> (!args.command) {
<a name="l04174"></a>04174       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;MeetMeChannelAdmin requires a command!\n&quot;</span>);
<a name="l04175"></a>04175       <span class="keywordflow">return</span> -1;
<a name="l04176"></a>04176    }
<a name="l04177"></a>04177 
<a name="l04178"></a>04178    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l04179"></a>04179    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, conf, list) {
<a name="l04180"></a>04180       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conf-&gt;userlist, user, list) {
<a name="l04181"></a>04181          <span class="keywordflow">if</span> (!strcmp(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, args.channel))
<a name="l04182"></a>04182             <span class="keywordflow">break</span>;
<a name="l04183"></a>04183       }
<a name="l04184"></a>04184    }
<a name="l04185"></a>04185    
<a name="l04186"></a>04186    <span class="keywordflow">if</span> (!user) {
<a name="l04187"></a>04187       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Specified user (%s) not found\n&quot;</span>, args.channel);
<a name="l04188"></a>04188       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04189"></a>04189       <span class="keywordflow">return</span> 0;
<a name="l04190"></a>04190    }
<a name="l04191"></a>04191    
<a name="l04192"></a>04192    <span class="comment">/* perform the specified action */</span>
<a name="l04193"></a>04193    <span class="keywordflow">switch</span> (*args.command) {
<a name="l04194"></a>04194       <span class="keywordflow">case</span> 77: <span class="comment">/* M: Mute */</span> 
<a name="l04195"></a>04195          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a>;
<a name="l04196"></a>04196          <span class="keywordflow">break</span>;
<a name="l04197"></a>04197       <span class="keywordflow">case</span> 109: <span class="comment">/* m: Unmute */</span> 
<a name="l04198"></a>04198          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp;= ~<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a>;
<a name="l04199"></a>04199          <span class="keywordflow">break</span>;
<a name="l04200"></a>04200       <span class="keywordflow">case</span> 107: <span class="comment">/* k: Kick user */</span> 
<a name="l04201"></a>04201          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a70fd82e787d08cd36d28a9af1e37bd14">ADMINFLAG_KICKME</a>;
<a name="l04202"></a>04202          <span class="keywordflow">break</span>;
<a name="l04203"></a>04203       <span class="keywordflow">default</span>: <span class="comment">/* unknown command */</span>
<a name="l04204"></a>04204          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown MeetMeChannelAdmin command &apos;%s&apos;\n&quot;</span>, args.command);
<a name="l04205"></a>04205          <span class="keywordflow">break</span>;
<a name="l04206"></a>04206    }
<a name="l04207"></a>04207 
<a name="l04208"></a>04208    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04209"></a>04209    
<a name="l04210"></a>04210    <span class="keywordflow">return</span> 0;
<a name="l04211"></a>04211 }
<a name="l04212"></a>04212 
<a name="l04213"></a><a class="code" href="app__meetme_8c.html#a66909c89e7858db0fae73a31805a8d1a">04213</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a66909c89e7858db0fae73a31805a8d1a">meetmemute</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m, <span class="keywordtype">int</span> mute)
<a name="l04214"></a>04214 {
<a name="l04215"></a>04215    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l04216"></a>04216    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l04217"></a>04217    <span class="keyword">const</span> <span class="keywordtype">char</span> *confid = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Meetme&quot;</span>);
<a name="l04218"></a>04218    <span class="keywordtype">char</span> *userid = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(<a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Usernum&quot;</span>));
<a name="l04219"></a>04219    <span class="keywordtype">int</span> userno;
<a name="l04220"></a>04220 
<a name="l04221"></a>04221    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(confid)) {
<a name="l04222"></a>04222       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Meetme conference not specified&quot;</span>);
<a name="l04223"></a>04223       <span class="keywordflow">return</span> 0;
<a name="l04224"></a>04224    }
<a name="l04225"></a>04225 
<a name="l04226"></a>04226    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(userid)) {
<a name="l04227"></a>04227       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Meetme user number not specified&quot;</span>);
<a name="l04228"></a>04228       <span class="keywordflow">return</span> 0;
<a name="l04229"></a>04229    }
<a name="l04230"></a>04230 
<a name="l04231"></a>04231    userno = strtoul(userid, &amp;userid, 10);
<a name="l04232"></a>04232 
<a name="l04233"></a>04233    <span class="keywordflow">if</span> (*userid) {
<a name="l04234"></a>04234       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Invalid user number&quot;</span>);
<a name="l04235"></a>04235       <span class="keywordflow">return</span> 0;
<a name="l04236"></a>04236    }
<a name="l04237"></a>04237 
<a name="l04238"></a>04238    <span class="comment">/* Look in the conference list */</span>
<a name="l04239"></a>04239    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l04240"></a>04240    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, conf, list) {
<a name="l04241"></a>04241       <span class="keywordflow">if</span> (!strcmp(confid, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>))
<a name="l04242"></a>04242          <span class="keywordflow">break</span>;
<a name="l04243"></a>04243    }
<a name="l04244"></a>04244 
<a name="l04245"></a>04245    <span class="keywordflow">if</span> (!conf) {
<a name="l04246"></a>04246       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04247"></a>04247       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;Meetme conference does not exist&quot;</span>);
<a name="l04248"></a>04248       <span class="keywordflow">return</span> 0;
<a name="l04249"></a>04249    }
<a name="l04250"></a>04250 
<a name="l04251"></a>04251    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;conf-&gt;userlist, user, list)
<a name="l04252"></a>04252       <span class="keywordflow">if</span> (user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a> == userno)
<a name="l04253"></a>04253          <span class="keywordflow">break</span>;
<a name="l04254"></a>04254 
<a name="l04255"></a>04255    <span class="keywordflow">if</span> (!user) {
<a name="l04256"></a>04256       <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04257"></a>04257       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;User number not found&quot;</span>);
<a name="l04258"></a>04258       <span class="keywordflow">return</span> 0;
<a name="l04259"></a>04259    }
<a name="l04260"></a>04260 
<a name="l04261"></a>04261    <span class="keywordflow">if</span> (mute)
<a name="l04262"></a>04262       user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> |= <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a>;   <span class="comment">/* request user muting */</span>
<a name="l04263"></a>04263    <span class="keywordflow">else</span>
<a name="l04264"></a>04264       user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp;= ~(<a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> | <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960adbfeb91d218a9c723a2e6394f9ec1f13">ADMINFLAG_T_REQUEST</a>); <span class="comment">/* request user unmuting */</span>
<a name="l04265"></a>04265 
<a name="l04266"></a>04266    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04267"></a>04267 
<a name="l04268"></a>04268    <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Requested to %smute conf %s user %d userchan %s uniqueid %s\n&quot;</span>, mute ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;un&quot;</span>, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>, user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name, user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;uniqueid);
<a name="l04269"></a>04269 
<a name="l04270"></a>04270    <a class="code" href="group__Group__AMI.html#ga77315fa8e29950f0c88120501acda0a3" title="Send ack in manager transaction.">astman_send_ack</a>(s, m, mute ? <span class="stringliteral">&quot;User muted&quot;</span> : <span class="stringliteral">&quot;User unmuted&quot;</span>);
<a name="l04271"></a>04271    <span class="keywordflow">return</span> 0;
<a name="l04272"></a>04272 }
<a name="l04273"></a>04273 
<a name="l04274"></a><a class="code" href="app__meetme_8c.html#aa469d77d3fee8f11b2d48740365fd0d5">04274</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#aa469d77d3fee8f11b2d48740365fd0d5">action_meetmemute</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l04275"></a>04275 {
<a name="l04276"></a>04276    <span class="keywordflow">return</span> <a class="code" href="app__meetme_8c.html#a66909c89e7858db0fae73a31805a8d1a">meetmemute</a>(s, m, 1);
<a name="l04277"></a>04277 }
<a name="l04278"></a>04278 
<a name="l04279"></a><a class="code" href="app__meetme_8c.html#a04a4ee089b212107b1e33943ce45fb3e">04279</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a04a4ee089b212107b1e33943ce45fb3e">action_meetmeunmute</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l04280"></a>04280 {
<a name="l04281"></a>04281    <span class="keywordflow">return</span> <a class="code" href="app__meetme_8c.html#a66909c89e7858db0fae73a31805a8d1a">meetmemute</a>(s, m, 0);
<a name="l04282"></a>04282 }
<a name="l04283"></a>04283 
<a name="l04284"></a><a class="code" href="app__meetme_8c.html#adb83fce9c2fece02e47e2dd107b3bfed">04284</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="app__meetme_8c.html#adb83fce9c2fece02e47e2dd107b3bfed">mandescr_meetmelist</a>[] =
<a name="l04285"></a>04285 <span class="stringliteral">&quot;Description: Lists all users in a particular MeetMe conference.\n&quot;</span>
<a name="l04286"></a>04286 <span class="stringliteral">&quot;MeetmeList will follow as separate events, followed by a final event called\n&quot;</span>
<a name="l04287"></a>04287 <span class="stringliteral">&quot;MeetmeListComplete.\n&quot;</span>
<a name="l04288"></a>04288 <span class="stringliteral">&quot;Variables:\n&quot;</span>
<a name="l04289"></a>04289 <span class="stringliteral">&quot;    *ActionId: &lt;id&gt;\n&quot;</span>
<a name="l04290"></a>04290 <span class="stringliteral">&quot;    *Conference: &lt;confno&gt;\n&quot;</span>;
<a name="l04291"></a>04291 
<a name="l04292"></a><a class="code" href="app__meetme_8c.html#a94e294b5969cdd4c4fb0802b9e6728a4">04292</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a94e294b5969cdd4c4fb0802b9e6728a4">action_meetmelist</a>(<span class="keyword">struct</span> <a class="code" href="structmansession.html">mansession</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structmessage.html">message</a> *m)
<a name="l04293"></a>04293 {
<a name="l04294"></a>04294    <span class="keyword">const</span> <span class="keywordtype">char</span> *actionid = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;ActionID&quot;</span>);
<a name="l04295"></a>04295    <span class="keyword">const</span> <span class="keywordtype">char</span> *conference = <a class="code" href="group__Group__AMI.html#gac6a9f3498f9afffecfd78c485af41556" title="Get header from mananger transaction.">astman_get_header</a>(m, <span class="stringliteral">&quot;Conference&quot;</span>);
<a name="l04296"></a>04296    <span class="keywordtype">char</span> idText[80] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l04297"></a>04297    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf;
<a name="l04298"></a>04298    <span class="keyword">struct </span><a class="code" href="structast__conf__user.html" title="The MeetMe User object.">ast_conf_user</a> *<a class="code" href="structuser.html" title="structure to hold users read from users.conf">user</a>;
<a name="l04299"></a>04299    <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> = 0;
<a name="l04300"></a>04300 
<a name="l04301"></a>04301    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(actionid))
<a name="l04302"></a>04302       snprintf(idText, <span class="keyword">sizeof</span>(idText), <span class="stringliteral">&quot;ActionID: %s\r\n&quot;</span>, actionid);
<a name="l04303"></a>04303 
<a name="l04304"></a>04304    <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;confs)) {
<a name="l04305"></a>04305       <a class="code" href="group__Group__AMI.html#ga31a02a7d3cc36aa66ebebdedfc574d1c" title="Send error in manager transaction.">astman_send_error</a>(s, m, <span class="stringliteral">&quot;No active conferences.&quot;</span>);
<a name="l04306"></a>04306       <span class="keywordflow">return</span> 0;
<a name="l04307"></a>04307    }
<a name="l04308"></a>04308 
<a name="l04309"></a>04309    <a class="code" href="group__Group__AMI.html#ga0ee6ee1f4d200f711e2983bffe770a72" title="Send ack in manager list transaction.">astman_send_listack</a>(s, m, <span class="stringliteral">&quot;Meetme user list will follow&quot;</span>, <span class="stringliteral">&quot;start&quot;</span>);
<a name="l04310"></a>04310 
<a name="l04311"></a>04311    <span class="comment">/* Find the right conference */</span>
<a name="l04312"></a>04312    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l04313"></a>04313    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, cnf, list) {
<a name="l04314"></a>04314       <span class="comment">/* If we ask for one particular, and this isn&apos;t it, skip it */</span>
<a name="l04315"></a>04315       <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(conference) &amp;&amp; strcmp(cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>, conference))
<a name="l04316"></a>04316          <span class="keywordflow">continue</span>;
<a name="l04317"></a>04317 
<a name="l04318"></a>04318       <span class="comment">/* Show all the users */</span>
<a name="l04319"></a>04319       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;cnf-&gt;userlist, user, list) {
<a name="l04320"></a>04320          total++;
<a name="l04321"></a>04321          <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l04322"></a>04322          <span class="stringliteral">&quot;Event: MeetmeList\r\n&quot;</span>
<a name="l04323"></a>04323          <span class="stringliteral">&quot;%s&quot;</span>
<a name="l04324"></a>04324          <span class="stringliteral">&quot;Conference: %s\r\n&quot;</span>
<a name="l04325"></a>04325          <span class="stringliteral">&quot;UserNumber: %d\r\n&quot;</span>
<a name="l04326"></a>04326          <span class="stringliteral">&quot;CallerIDNum: %s\r\n&quot;</span>
<a name="l04327"></a>04327          <span class="stringliteral">&quot;CallerIDName: %s\r\n&quot;</span>
<a name="l04328"></a>04328          <span class="stringliteral">&quot;Channel: %s\r\n&quot;</span>
<a name="l04329"></a>04329          <span class="stringliteral">&quot;Admin: %s\r\n&quot;</span>
<a name="l04330"></a>04330          <span class="stringliteral">&quot;Role: %s\r\n&quot;</span>
<a name="l04331"></a>04331          <span class="stringliteral">&quot;MarkedUser: %s\r\n&quot;</span>
<a name="l04332"></a>04332          <span class="stringliteral">&quot;Muted: %s\r\n&quot;</span>
<a name="l04333"></a>04333          <span class="stringliteral">&quot;Talking: %s\r\n&quot;</span>
<a name="l04334"></a>04334          <span class="stringliteral">&quot;\r\n&quot;</span>,
<a name="l04335"></a>04335          idText,
<a name="l04336"></a>04336          cnf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>,
<a name="l04337"></a>04337          user-&gt;<a class="code" href="structast__conf__user.html#a3cf43577b7bd7604d6b44cb165542d39">user_no</a>,
<a name="l04338"></a>04338          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ac8e0930b3408bc3745d3d841c520fe2f">cid_num</a>, <span class="stringliteral">&quot;&lt;unknown&gt;&quot;</span>),
<a name="l04339"></a>04339          <a class="code" href="strings_8h.html#a2faaa16929951bfd2802b7829a100ba2" title="returns the equivalent of logic or for strings: first one if not empty, otherwise...">S_OR</a>(user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;<a class="code" href="structast__channel.html#ad7a6835087355f91c8a8236e9a2ef23f">cid</a>.<a class="code" href="structast__callerid.html#ab2461abe6e234fe4f763b0a2179184b5">cid_name</a>, <span class="stringliteral">&quot;&lt;no name&gt;&quot;</span>),
<a name="l04340"></a>04340          user-&gt;<a class="code" href="structast__conf__user.html#a84d1435c5b8d387806714ea7079304b7">chan</a>-&gt;name,
<a name="l04341"></a>04341          user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409afaf2b3922ef62a50c702b5456477b3c4">CONFFLAG_ADMIN</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l04342"></a>04342          user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409acbd1ffc2e14f1d51fffc9659b3995274">CONFFLAG_MONITOR</a> ? <span class="stringliteral">&quot;Listen only&quot;</span> : user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a39a9c6b58c7b77ef675e56d00c89e0a8">CONFFLAG_TALKER</a> ? <span class="stringliteral">&quot;Talk only&quot;</span> : <span class="stringliteral">&quot;Talk and listen&quot;</span>,
<a name="l04343"></a>04343          user-&gt;<a class="code" href="structast__conf__user.html#a1d4a9fb0ae1deb63dd142eb66375171d">userflags</a> &amp; <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">CONFFLAG_MARKEDUSER</a> ? <span class="stringliteral">&quot;Yes&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l04344"></a>04344          user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960ac9bb1920b90005281bb9ae728a273954">ADMINFLAG_MUTED</a> ? <span class="stringliteral">&quot;By admin&quot;</span> : user-&gt;<a class="code" href="structast__conf__user.html#a0c5b688fdd12f025eac68318c8d3e1eb">adminflags</a> &amp; <a class="code" href="app__meetme_8c.html#af9bdc3014f3d54c426b6d2df10de4960a1b6d4960faefd92a619429072ea3aa72">ADMINFLAG_SELFMUTED</a> ? <span class="stringliteral">&quot;By self&quot;</span> : <span class="stringliteral">&quot;No&quot;</span>,
<a name="l04345"></a>04345          user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> &gt; 0 ? <span class="stringliteral">&quot;Yes&quot;</span> : user-&gt;<a class="code" href="structast__conf__user.html#a2a2bb86d404ad5f3023f5aff51137095">talking</a> == 0 ? <span class="stringliteral">&quot;No&quot;</span> : <span class="stringliteral">&quot;Not monitored&quot;</span>); 
<a name="l04346"></a>04346       }
<a name="l04347"></a>04347    }
<a name="l04348"></a>04348    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04349"></a>04349    <span class="comment">/* Send final confirmation */</span>
<a name="l04350"></a>04350    <a class="code" href="group__Group__AMI.html#gac2d42f7be13c532b6a70d50f1b8983d2">astman_append</a>(s,
<a name="l04351"></a>04351    <span class="stringliteral">&quot;Event: MeetmeListComplete\r\n&quot;</span>
<a name="l04352"></a>04352    <span class="stringliteral">&quot;EventList: Complete\r\n&quot;</span>
<a name="l04353"></a>04353    <span class="stringliteral">&quot;ListItems: %d\r\n&quot;</span>
<a name="l04354"></a>04354    <span class="stringliteral">&quot;%s&quot;</span>
<a name="l04355"></a>04355    <span class="stringliteral">&quot;\r\n&quot;</span>, total, idText);
<a name="l04356"></a>04356    <span class="keywordflow">return</span> 0;
<a name="l04357"></a>04357 }
<a name="l04358"></a>04358 
<a name="l04359"></a><a class="code" href="app__meetme_8c.html#a3352a8a09d96d39d97562f874eda91fe">04359</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="structast__conference.html#aa9af2bfdaafa007e201fc6f01dfd9f68">recordthread</a>(<span class="keywordtype">void</span> *args)
<a name="l04360"></a>04360 {
<a name="l04361"></a>04361    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *cnf = args;
<a name="l04362"></a>04362    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l04363"></a>04363    <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l04364"></a>04364    <span class="keyword">struct </span><a class="code" href="structast__filestream.html" title="This structure is allocated by file.c in one chunk, together with buf_size and desc_size...">ast_filestream</a> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = NULL;
<a name="l04365"></a>04365    <span class="keywordtype">int</span> res = 0;
<a name="l04366"></a>04366    <span class="keywordtype">int</span> x;
<a name="l04367"></a>04367    <span class="keyword">const</span> <span class="keywordtype">char</span> *oldrecordingfilename = NULL;
<a name="l04368"></a>04368 
<a name="l04369"></a>04369    <span class="keywordflow">if</span> (!cnf || !cnf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>) {
<a name="l04370"></a>04370       pthread_exit(0);
<a name="l04371"></a>04371    }
<a name="l04372"></a>04372 
<a name="l04373"></a>04373    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>);
<a name="l04374"></a>04374    flags = O_CREAT | O_TRUNC | O_WRONLY;
<a name="l04375"></a>04375 
<a name="l04376"></a>04376 
<a name="l04377"></a>04377    cnf-&gt;recording = <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298aed2f74b0993cd2122169387b4ff74113">MEETME_RECORD_ACTIVE</a>;
<a name="l04378"></a>04378    <span class="keywordflow">while</span> (<a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>, -1) &gt; -1) {
<a name="l04379"></a>04379       <span class="keywordflow">if</span> (cnf-&gt;recording == <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a79313598c5f4a645e3b006f59572a75d">MEETME_RECORD_TERMINATE</a>) {
<a name="l04380"></a>04380          <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l04381"></a>04381          <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04382"></a>04382          <span class="keywordflow">break</span>;
<a name="l04383"></a>04383       }
<a name="l04384"></a>04384       <span class="keywordflow">if</span> (!s &amp;&amp; cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> &amp;&amp; (cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a> != oldrecordingfilename)) {
<a name="l04385"></a>04385          s = <a class="code" href="file_8h.html#a964f8ef393c07609d7b9e02937faed52" title="Starts writing a file.">ast_writefile</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>, cnf-&gt;<a class="code" href="structast__conference.html#a091209bdc40e09b9fb355981148455a4">recordingformat</a>, NULL, flags, 0, <a class="code" href="asterisk_8h.html#aa6293b2dae52a2b470494df672a26c42">AST_FILE_MODE</a>);
<a name="l04386"></a>04386          oldrecordingfilename = cnf-&gt;<a class="code" href="structast__conference.html#a9449b89f7363e7ed5f75666d3a1f44e3">recordingfilename</a>;
<a name="l04387"></a>04387       }
<a name="l04388"></a>04388       
<a name="l04389"></a>04389       f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(cnf-&gt;<a class="code" href="structast__conference.html#a9a27d1f216a1903433ae28cb1461c0e1">lchan</a>);
<a name="l04390"></a>04390       <span class="keywordflow">if</span> (!f) {
<a name="l04391"></a>04391          res = -1;
<a name="l04392"></a>04392          <span class="keywordflow">break</span>;
<a name="l04393"></a>04393       }
<a name="l04394"></a>04394       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l04395"></a>04395          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l04396"></a>04396          <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="app__meetme_8c.html#addd70c99776f00581f71a71d3c10d86f">AST_FRAME_BITS</a>; x++) {
<a name="l04397"></a>04397             <span class="comment">/* Free any translations that have occured */</span>
<a name="l04398"></a>04398             <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[x]) {
<a name="l04399"></a>04399                <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(cnf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[x]);
<a name="l04400"></a>04400                cnf-&gt;<a class="code" href="structast__conference.html#a15e719e50c64d30870f83248d614ff2a">transframe</a>[x] = NULL;
<a name="l04401"></a>04401             }
<a name="l04402"></a>04402          }
<a name="l04403"></a>04403          <span class="keywordflow">if</span> (cnf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>)
<a name="l04404"></a>04404             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(cnf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a>);
<a name="l04405"></a>04405          cnf-&gt;<a class="code" href="structast__conference.html#ad77ac2c67a46ee543b07289ecf3caef7">origframe</a> = <a class="code" href="frame_8h.html#a4b23720d208128250a765490b1a4f145" title="Copies a frame.">ast_frdup</a>(f);
<a name="l04406"></a>04406          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;cnf-&gt;<a class="code" href="structast__conference.html#af969a928c15551cd3e470013f454b8f5">listenlock</a>);
<a name="l04407"></a>04407          <span class="keywordflow">if</span> (s)
<a name="l04408"></a>04408             res = <a class="code" href="file_8h.html#a3608386b919ef0949d2858cdeb02d12e" title="Writes a frame to a stream.">ast_writestream</a>(s, f);
<a name="l04409"></a>04409          <span class="keywordflow">if</span> (res) {
<a name="l04410"></a>04410             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l04411"></a>04411             <span class="keywordflow">break</span>;
<a name="l04412"></a>04412          }
<a name="l04413"></a>04413       }
<a name="l04414"></a>04414       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l04415"></a>04415    }
<a name="l04416"></a>04416    cnf-&gt;recording = <a class="code" href="app__meetme_8c.html#a0f5b0308b4ac4029b0300a7a68779298a44a4c13334429a322cb3408ec48c1cfb">MEETME_RECORD_OFF</a>;
<a name="l04417"></a>04417    <span class="keywordflow">if</span> (s)
<a name="l04418"></a>04418       <a class="code" href="file_8h.html#ab53bd2c3c55d509790c7f7620aac6373" title="Closes a stream.">ast_closestream</a>(s);
<a name="l04419"></a>04419    
<a name="l04420"></a>04420    pthread_exit(0);
<a name="l04421"></a>04421 }
<a name="l04422"></a>04422 <span class="comment"></span>
<a name="l04423"></a>04423 <span class="comment">/*! \brief Callback for devicestate providers */</span>
<a name="l04424"></a><a class="code" href="app__meetme_8c.html#a8fc3c28c0edf393e6f7a01f3e0865de6">04424</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="app__meetme_8c.html#a8fc3c28c0edf393e6f7a01f3e0865de6" title="Callback for devicestate providers.">meetmestate</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l04425"></a>04425 {
<a name="l04426"></a>04426    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l04427"></a>04427 
<a name="l04428"></a>04428    <span class="comment">/* Find conference */</span>
<a name="l04429"></a>04429    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l04430"></a>04430    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, conf, list) {
<a name="l04431"></a>04431       <span class="keywordflow">if</span> (!strcmp(data, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>))
<a name="l04432"></a>04432          <span class="keywordflow">break</span>;
<a name="l04433"></a>04433    }
<a name="l04434"></a>04434    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l04435"></a>04435    <span class="keywordflow">if</span> (!conf)
<a name="l04436"></a>04436       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l04437"></a>04437 
<a name="l04438"></a>04438 
<a name="l04439"></a>04439    <span class="comment">/* SKREP to fill */</span>
<a name="l04440"></a>04440    <span class="keywordflow">if</span> (!conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>)
<a name="l04441"></a>04441       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>;
<a name="l04442"></a>04442 
<a name="l04443"></a>04443    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l04444"></a>04444 }
<a name="l04445"></a>04445 
<a name="l04446"></a><a class="code" href="app__meetme_8c.html#aa682c8ee26d1e14b90c31da2b70069db">04446</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#aa682c8ee26d1e14b90c31da2b70069db">load_config_meetme</a>(<span class="keywordtype">void</span>)
<a name="l04447"></a>04447 {
<a name="l04448"></a>04448    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l04449"></a>04449    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l04450"></a>04450    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>;
<a name="l04451"></a>04451 
<a name="l04452"></a>04452    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">CONFIG_FILE_NAME</a>, config_flags))) {
<a name="l04453"></a>04453       <span class="keywordflow">return</span>;
<a name="l04454"></a>04454    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l04455"></a>04455       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="app__meetme_8c.html#a62921b92fa4fb37f1e3a5d4c644fc1d8">CONFIG_FILE_NAME</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l04456"></a>04456       <span class="keywordflow">return</span>;
<a name="l04457"></a>04457    }
<a name="l04458"></a>04458 
<a name="l04459"></a>04459    audio_buffers = <a class="code" href="app__meetme_8c.html#af71d7de559e9731a4d8e57bafa341486">DEFAULT_AUDIO_BUFFERS</a>;
<a name="l04460"></a>04460 
<a name="l04461"></a>04461    <span class="comment">/*  Scheduling support is off by default */</span>
<a name="l04462"></a>04462    rt_schedule = 0;
<a name="l04463"></a>04463    fuzzystart = 0;
<a name="l04464"></a>04464    earlyalert = 0;
<a name="l04465"></a>04465    endalert = 0;
<a name="l04466"></a>04466    extendby = 0;
<a name="l04467"></a>04467 
<a name="l04468"></a>04468    <span class="comment">/*  Logging of participants defaults to ON for compatibility reasons */</span>
<a name="l04469"></a>04469    rt_log_members = 1;  
<a name="l04470"></a>04470 
<a name="l04471"></a>04471    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;audiobuffers&quot;</span>))) {
<a name="l04472"></a>04472       <span class="keywordflow">if</span> ((sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;audio_buffers) != 1)) {
<a name="l04473"></a>04473          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;audiobuffers setting must be a number, not &apos;%s&apos;\n&quot;</span>, val);
<a name="l04474"></a>04474          audio_buffers = <a class="code" href="app__meetme_8c.html#af71d7de559e9731a4d8e57bafa341486">DEFAULT_AUDIO_BUFFERS</a>;
<a name="l04475"></a>04475       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((audio_buffers &lt; DAHDI_DEFAULT_NUM_BUFS) || (audio_buffers &gt; DAHDI_MAX_NUM_BUFS)) {
<a name="l04476"></a>04476          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;audiobuffers setting must be between %d and %d\n&quot;</span>,
<a name="l04477"></a>04477             DAHDI_DEFAULT_NUM_BUFS, DAHDI_MAX_NUM_BUFS);
<a name="l04478"></a>04478          audio_buffers = <a class="code" href="app__meetme_8c.html#af71d7de559e9731a4d8e57bafa341486">DEFAULT_AUDIO_BUFFERS</a>;
<a name="l04479"></a>04479       }
<a name="l04480"></a>04480       <span class="keywordflow">if</span> (audio_buffers != <a class="code" href="app__meetme_8c.html#af71d7de559e9731a4d8e57bafa341486">DEFAULT_AUDIO_BUFFERS</a>)
<a name="l04481"></a>04481          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Audio buffers per channel set to %d\n&quot;</span>, audio_buffers);
<a name="l04482"></a>04482    }
<a name="l04483"></a>04483 
<a name="l04484"></a>04484    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;schedule&quot;</span>)))
<a name="l04485"></a>04485       rt_schedule = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l04486"></a>04486    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;logmembercount&quot;</span>)))
<a name="l04487"></a>04487       rt_log_members = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l04488"></a>04488    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;fuzzystart&quot;</span>))) {
<a name="l04489"></a>04489       <span class="keywordflow">if</span> ((sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;fuzzystart) != 1)) {
<a name="l04490"></a>04490          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fuzzystart must be a number, not &apos;%s&apos;\n&quot;</span>, val);
<a name="l04491"></a>04491          fuzzystart = 0;
<a name="l04492"></a>04492       } 
<a name="l04493"></a>04493    }
<a name="l04494"></a>04494    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;earlyalert&quot;</span>))) {
<a name="l04495"></a>04495       <span class="keywordflow">if</span> ((sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;earlyalert) != 1)) {
<a name="l04496"></a>04496          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;earlyalert must be a number, not &apos;%s&apos;\n&quot;</span>, val);
<a name="l04497"></a>04497          earlyalert = 0;
<a name="l04498"></a>04498       } 
<a name="l04499"></a>04499    }
<a name="l04500"></a>04500    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;endalert&quot;</span>))) {
<a name="l04501"></a>04501       <span class="keywordflow">if</span> ((sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;endalert) != 1)) {
<a name="l04502"></a>04502          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;endalert must be a number, not &apos;%s&apos;\n&quot;</span>, val);
<a name="l04503"></a>04503          endalert = 0;
<a name="l04504"></a>04504       } 
<a name="l04505"></a>04505    }
<a name="l04506"></a>04506    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;extendby&quot;</span>))) {
<a name="l04507"></a>04507       <span class="keywordflow">if</span> ((sscanf(val, <span class="stringliteral">&quot;%30d&quot;</span>, &amp;extendby) != 1)) {
<a name="l04508"></a>04508          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;extendby must be a number, not &apos;%s&apos;\n&quot;</span>, val);
<a name="l04509"></a>04509          extendby = 0;
<a name="l04510"></a>04510       } 
<a name="l04511"></a>04511    }
<a name="l04512"></a>04512 
<a name="l04513"></a>04513    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l04514"></a>04514 }
<a name="l04515"></a>04515 <span class="comment"></span>
<a name="l04516"></a>04516 <span class="comment">/*! \brief Find an SLA trunk by name</span>
<a name="l04517"></a>04517 <span class="comment"> * \note This must be called with the sla_trunks container locked</span>
<a name="l04518"></a>04518 <span class="comment"> */</span>
<a name="l04519"></a><a class="code" href="app__meetme_8c.html#af590722094b4b8eee8319a0ae644a8c1">04519</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *<a class="code" href="app__meetme_8c.html#af590722094b4b8eee8319a0ae644a8c1" title="Find an SLA trunk by name.">sla_find_trunk</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l04520"></a>04520 {
<a name="l04521"></a>04521    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk = NULL;
<a name="l04522"></a>04522 
<a name="l04523"></a>04523    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_trunks, trunk, entry) {
<a name="l04524"></a>04524       <span class="keywordflow">if</span> (!strcasecmp(trunk-&gt;name, name))
<a name="l04525"></a>04525          <span class="keywordflow">break</span>;
<a name="l04526"></a>04526    }
<a name="l04527"></a>04527 
<a name="l04528"></a>04528    <span class="keywordflow">return</span> trunk;
<a name="l04529"></a>04529 }
<a name="l04530"></a>04530 <span class="comment"></span>
<a name="l04531"></a>04531 <span class="comment">/*! \brief Find an SLA station by name</span>
<a name="l04532"></a>04532 <span class="comment"> * \note This must be called with the sla_stations container locked</span>
<a name="l04533"></a>04533 <span class="comment"> */</span>
<a name="l04534"></a><a class="code" href="app__meetme_8c.html#a3c7dabe74df23208e4dce8bc3fbb6d77">04534</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *<a class="code" href="app__meetme_8c.html#a3c7dabe74df23208e4dce8bc3fbb6d77" title="Find an SLA station by name.">sla_find_station</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l04535"></a>04535 {
<a name="l04536"></a>04536    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station = NULL;
<a name="l04537"></a>04537 
<a name="l04538"></a>04538    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l04539"></a>04539       <span class="keywordflow">if</span> (!strcasecmp(station-&gt;name, name))
<a name="l04540"></a>04540          <span class="keywordflow">break</span>;
<a name="l04541"></a>04541    }
<a name="l04542"></a>04542 
<a name="l04543"></a>04543    <span class="keywordflow">return</span> station;
<a name="l04544"></a>04544 }
<a name="l04545"></a>04545 
<a name="l04546"></a><a class="code" href="app__meetme_8c.html#ad180a618fb2ca170f49e36927637775f">04546</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad180a618fb2ca170f49e36927637775f">sla_check_station_hold_access</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk,
<a name="l04547"></a>04547    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04548"></a>04548 {
<a name="l04549"></a>04549    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l04550"></a>04550    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l04551"></a>04551 
<a name="l04552"></a>04552    <span class="comment">/* For each station that has this call on hold, check for private hold. */</span>
<a name="l04553"></a>04553    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;trunk-&gt;stations, station_ref, entry) {
<a name="l04554"></a>04554       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station_ref-&gt;station-&gt;trunks, trunk_ref, entry) {
<a name="l04555"></a>04555          <span class="keywordflow">if</span> (trunk_ref-&gt;trunk != trunk || station_ref-&gt;station == station)
<a name="l04556"></a>04556             <span class="keywordflow">continue</span>;
<a name="l04557"></a>04557          <span class="keywordflow">if</span> (trunk_ref-&gt;state == <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a> &amp;&amp;
<a name="l04558"></a>04558             station_ref-&gt;station-&gt;hold_access == <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">SLA_HOLD_PRIVATE</a>)
<a name="l04559"></a>04559             <span class="keywordflow">return</span> 1;
<a name="l04560"></a>04560          <span class="keywordflow">return</span> 0;
<a name="l04561"></a>04561       }
<a name="l04562"></a>04562    }
<a name="l04563"></a>04563 
<a name="l04564"></a>04564    <span class="keywordflow">return</span> 0;
<a name="l04565"></a>04565 }
<a name="l04566"></a>04566 <span class="comment"></span>
<a name="l04567"></a>04567 <span class="comment">/*! \brief Find a trunk reference on a station by name</span>
<a name="l04568"></a>04568 <span class="comment"> * \param station the station</span>
<a name="l04569"></a>04569 <span class="comment"> * \param name the trunk&apos;s name</span>
<a name="l04570"></a>04570 <span class="comment"> * \return a pointer to the station&apos;s trunk reference.  If the trunk</span>
<a name="l04571"></a>04571 <span class="comment"> *         is not found, it is not idle and barge is disabled, or if</span>
<a name="l04572"></a>04572 <span class="comment"> *         it is on hold and private hold is set, then NULL will be returned.</span>
<a name="l04573"></a>04573 <span class="comment"> */</span>
<a name="l04574"></a><a class="code" href="app__meetme_8c.html#aea0981ea332b08880d6404c65fe64135">04574</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *<a class="code" href="app__meetme_8c.html#aea0981ea332b08880d6404c65fe64135" title="Find a trunk reference on a station by name.">sla_find_trunk_ref_byname</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station,
<a name="l04575"></a>04575    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>)
<a name="l04576"></a>04576 {
<a name="l04577"></a>04577    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref = NULL;
<a name="l04578"></a>04578 
<a name="l04579"></a>04579    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l04580"></a>04580       <span class="keywordflow">if</span> (strcasecmp(trunk_ref-&gt;trunk-&gt;name, name))
<a name="l04581"></a>04581          <span class="keywordflow">continue</span>;
<a name="l04582"></a>04582 
<a name="l04583"></a>04583       <span class="keywordflow">if</span> ( (trunk_ref-&gt;trunk-&gt;barge_disabled 
<a name="l04584"></a>04584          &amp;&amp; trunk_ref-&gt;state == <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>) ||
<a name="l04585"></a>04585          (trunk_ref-&gt;trunk-&gt;hold_stations 
<a name="l04586"></a>04586          &amp;&amp; trunk_ref-&gt;trunk-&gt;hold_access == <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">SLA_HOLD_PRIVATE</a>
<a name="l04587"></a>04587          &amp;&amp; trunk_ref-&gt;state != <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>) ||
<a name="l04588"></a>04588          <a class="code" href="app__meetme_8c.html#ad180a618fb2ca170f49e36927637775f">sla_check_station_hold_access</a>(trunk_ref-&gt;trunk, station) ) 
<a name="l04589"></a>04589       {
<a name="l04590"></a>04590          trunk_ref = NULL;
<a name="l04591"></a>04591       }
<a name="l04592"></a>04592 
<a name="l04593"></a>04593       <span class="keywordflow">break</span>;
<a name="l04594"></a>04594    }
<a name="l04595"></a>04595 
<a name="l04596"></a>04596    <span class="keywordflow">return</span> trunk_ref;
<a name="l04597"></a>04597 }
<a name="l04598"></a>04598 
<a name="l04599"></a><a class="code" href="app__meetme_8c.html#a95a34a9245e87d8481590dddcfd168d2">04599</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *<a class="code" href="app__meetme_8c.html#a95a34a9245e87d8481590dddcfd168d2">sla_create_station_ref</a>(<span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04600"></a>04600 {
<a name="l04601"></a>04601    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l04602"></a>04602 
<a name="l04603"></a>04603    <span class="keywordflow">if</span> (!(station_ref = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*station_ref))))
<a name="l04604"></a>04604       <span class="keywordflow">return</span> NULL;
<a name="l04605"></a>04605 
<a name="l04606"></a>04606    station_ref-&gt;station = station;
<a name="l04607"></a>04607 
<a name="l04608"></a>04608    <span class="keywordflow">return</span> station_ref;
<a name="l04609"></a>04609 }
<a name="l04610"></a>04610 
<a name="l04611"></a><a class="code" href="app__meetme_8c.html#ad714502c1dbeae46a86c3b4e2e210ed1">04611</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *<a class="code" href="app__meetme_8c.html#ad714502c1dbeae46a86c3b4e2e210ed1">sla_create_ringing_station</a>(<span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04612"></a>04612 {
<a name="l04613"></a>04613    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l04614"></a>04614 
<a name="l04615"></a>04615    <span class="keywordflow">if</span> (!(ringing_station = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ringing_station))))
<a name="l04616"></a>04616       <span class="keywordflow">return</span> NULL;
<a name="l04617"></a>04617 
<a name="l04618"></a>04618    ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a> = station;
<a name="l04619"></a>04619    ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a5fad56bdd993af8ceb77ab8a83134f0f">ring_begin</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l04620"></a>04620 
<a name="l04621"></a>04621    <span class="keywordflow">return</span> ringing_station;
<a name="l04622"></a>04622 }
<a name="l04623"></a>04623 
<a name="l04624"></a><a class="code" href="app__meetme_8c.html#ab69997f20dabd9a6a6f42f00dd2290f4">04624</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="app__meetme_8c.html#ab69997f20dabd9a6a6f42f00dd2290f4">sla_state_to_devstate</a>(<span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75">sla_trunk_state</a> <a class="code" href="structstate.html">state</a>)
<a name="l04625"></a>04625 {
<a name="l04626"></a>04626    <span class="keywordflow">switch</span> (state) {
<a name="l04627"></a>04627    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>:
<a name="l04628"></a>04628       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeeadee91fc4886ffc7b4efb8459cef48fe2">AST_DEVICE_NOT_INUSE</a>;
<a name="l04629"></a>04629    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a4822569aa984228bec67e07f5b9862a5">SLA_TRUNK_STATE_RINGING</a>:
<a name="l04630"></a>04630       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea76d91d5d654cfa3edafb2afbe3e09b46">AST_DEVICE_RINGING</a>;
<a name="l04631"></a>04631    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>:
<a name="l04632"></a>04632       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>;
<a name="l04633"></a>04633    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a17322fe34775141bef95a88fd00ed59d">SLA_TRUNK_STATE_ONHOLD</a>:
<a name="l04634"></a>04634    <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>:
<a name="l04635"></a>04635       <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea6b7416bea92d3bc5ee8e36f0a484cdc1">AST_DEVICE_ONHOLD</a>;
<a name="l04636"></a>04636    }
<a name="l04637"></a>04637 
<a name="l04638"></a>04638    <span class="keywordflow">return</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea41983b6678528bfcdf919b24d6e08d9a">AST_DEVICE_UNKNOWN</a>;
<a name="l04639"></a>04639 }
<a name="l04640"></a>04640 
<a name="l04641"></a><a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">04641</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk, <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75">sla_trunk_state</a> <a class="code" href="structstate.html">state</a>, 
<a name="l04642"></a>04642    <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215">sla_which_trunk_refs</a> inactive_only, <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *exclude)
<a name="l04643"></a>04643 {
<a name="l04644"></a>04644    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l04645"></a>04645    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l04646"></a>04646 
<a name="l04647"></a>04647    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l04648"></a>04648       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l04649"></a>04649          <span class="keywordflow">if</span> (trunk_ref-&gt;trunk != trunk || (inactive_only ? trunk_ref-&gt;chan : 0)
<a name="l04650"></a>04650             || trunk_ref == exclude)
<a name="l04651"></a>04651             <span class="keywordflow">continue</span>;
<a name="l04652"></a>04652          trunk_ref-&gt;state = state;
<a name="l04653"></a>04653          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="app__meetme_8c.html#ab69997f20dabd9a6a6f42f00dd2290f4">sla_state_to_devstate</a>(state), 
<a name="l04654"></a>04654             <span class="stringliteral">&quot;SLA:%s_%s&quot;</span>, station-&gt;name, trunk-&gt;name);
<a name="l04655"></a>04655          <span class="keywordflow">break</span>;
<a name="l04656"></a>04656       }
<a name="l04657"></a>04657    }
<a name="l04658"></a>04658 }
<a name="l04659"></a>04659 
<a name="l04660"></a><a class="code" href="structrun__station__args.html">04660</a> <span class="keyword">struct </span><a class="code" href="structrun__station__args.html">run_station_args</a> {
<a name="l04661"></a><a class="code" href="structrun__station__args.html#a0569f66b3f952276c1a8ec5f2ffd5466">04661</a>    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l04662"></a><a class="code" href="structrun__station__args.html#afa55138e79daa65d864f3524cf4843bf">04662</a>    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l04663"></a><a class="code" href="structrun__station__args.html#ad60cf18fa0b7812ab65423aa79f93165">04663</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> *cond_lock;
<a name="l04664"></a><a class="code" href="structrun__station__args.html#a45860a157e8d238e312118ddd5771454">04664</a>    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> *cond;
<a name="l04665"></a>04665 };
<a name="l04666"></a>04666 
<a name="l04667"></a><a class="code" href="app__meetme_8c.html#a7392cc7f56677c79368716971d1ec023">04667</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a7392cc7f56677c79368716971d1ec023">answer_trunk_chan</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>)
<a name="l04668"></a>04668 {
<a name="l04669"></a>04669    <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l04670"></a>04670    <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, -1);
<a name="l04671"></a>04671 }
<a name="l04672"></a>04672 
<a name="l04673"></a><a class="code" href="app__meetme_8c.html#a1e618b1883d308cb371b0e7b0800bf3f">04673</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app__meetme_8c.html#a1e618b1883d308cb371b0e7b0800bf3f">run_station</a>(<span class="keywordtype">void</span> *data)
<a name="l04674"></a>04674 {
<a name="l04675"></a>04675    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l04676"></a>04676    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l04677"></a>04677    <span class="keyword">struct </span><a class="code" href="structast__str.html" title="The descriptor of a dynamic string XXX storage will be optimized later if needed...">ast_str</a> *conf_name = <a class="code" href="strings_8h.html#a8ec37e4acb6ecb20eb6f6edd1141cd76" title="Create a malloc&amp;#39;ed dynamic length string.">ast_str_create</a>(16);
<a name="l04678"></a>04678    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> conf_flags = { 0 };
<a name="l04679"></a>04679    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l04680"></a>04680 
<a name="l04681"></a>04681    {
<a name="l04682"></a>04682       <span class="keyword">struct </span><a class="code" href="structrun__station__args.html">run_station_args</a> *args = data;
<a name="l04683"></a>04683       station = args-&gt;<a class="code" href="structrun__station__args.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>;
<a name="l04684"></a>04684       trunk_ref = args-&gt;<a class="code" href="structrun__station__args.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>;
<a name="l04685"></a>04685       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(args-&gt;<a class="code" href="structrun__station__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l04686"></a>04686       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(args-&gt;<a class="code" href="structrun__station__args.html#a45860a157e8d238e312118ddd5771454">cond</a>);
<a name="l04687"></a>04687       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(args-&gt;<a class="code" href="structrun__station__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l04688"></a>04688       <span class="comment">/* args is no longer valid here. */</span>
<a name="l04689"></a>04689    }
<a name="l04690"></a>04690 
<a name="l04691"></a>04691    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk_ref-&gt;trunk-&gt;active_stations, 1);
<a name="l04692"></a>04692    <a class="code" href="strings_8h.html#a4a3222f04f84c80a1d70f51e2dff00ea" title="Set a dynamic string using variable arguments.">ast_str_set</a>(&amp;conf_name, 0, <span class="stringliteral">&quot;SLA_%s&quot;</span>, trunk_ref-&gt;trunk-&gt;name);
<a name="l04693"></a>04693    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;conf_flags, 
<a name="l04694"></a>04694       <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac793d6a4a78ffd301d51be06a771b70c">CONFFLAG_SLA_STATION</a>);
<a name="l04695"></a>04695    <a class="code" href="app__meetme_8c.html#a7392cc7f56677c79368716971d1ec023">answer_trunk_chan</a>(trunk_ref-&gt;chan);
<a name="l04696"></a>04696    conf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(<a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(conf_name), <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, 0, 1, trunk_ref-&gt;chan);
<a name="l04697"></a>04697    <span class="keywordflow">if</span> (conf) {
<a name="l04698"></a>04698       <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(trunk_ref-&gt;chan, conf, conf_flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, NULL);
<a name="l04699"></a>04699       <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(conf);
<a name="l04700"></a>04700       conf = NULL;
<a name="l04701"></a>04701    }
<a name="l04702"></a>04702    trunk_ref-&gt;chan = NULL;
<a name="l04703"></a>04703    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ac0907a45f05d85848a4f7d5990a4d244" title="decrement *p by 1 and return true if the variable has reached 0. Useful e.g. to check...">ast_atomic_dec_and_test</a>((<span class="keywordtype">int</span> *) &amp;trunk_ref-&gt;trunk-&gt;active_stations) &amp;&amp;
<a name="l04704"></a>04704       trunk_ref-&gt;state != <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>) {
<a name="l04705"></a>04705       <a class="code" href="strings_8h.html#a85cd5a8ef499e39d22b4bfeb8b9a64f7" title="Append to a thread local dynamic string.">ast_str_append</a>(&amp;conf_name, 0, <span class="stringliteral">&quot;,K&quot;</span>);
<a name="l04706"></a>04706       <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(NULL, <a class="code" href="strings_8h.html#a053bdfc229997a75f112bdd7b995e00b" title="Returns the string buffer within the ast_str buf.">ast_str_buffer</a>(conf_name));
<a name="l04707"></a>04707       trunk_ref-&gt;trunk-&gt;hold_stations = 0;
<a name="l04708"></a>04708       <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l04709"></a>04709    }
<a name="l04710"></a>04710 
<a name="l04711"></a>04711    <a class="code" href="dial_8h.html#a726346c9cfd11a81839e0eb580b66059" title="Cancel async thread.">ast_dial_join</a>(station-&gt;dial);
<a name="l04712"></a>04712    <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(station-&gt;dial);
<a name="l04713"></a>04713    station-&gt;dial = NULL;
<a name="l04714"></a>04714    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(conf_name);
<a name="l04715"></a>04715 
<a name="l04716"></a>04716    <span class="keywordflow">return</span> NULL;
<a name="l04717"></a>04717 }
<a name="l04718"></a>04718 
<a name="l04719"></a><a class="code" href="app__meetme_8c.html#a53f8684abfc755b445ce1f77aba6f2c0">04719</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a53f8684abfc755b445ce1f77aba6f2c0">sla_stop_ringing_trunk</a>(<span class="keyword">struct</span> sla_ringing_trunk *ringing_trunk)
<a name="l04720"></a>04720 {
<a name="l04721"></a>04721    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[80];
<a name="l04722"></a>04722    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l04723"></a>04723 
<a name="l04724"></a>04724    snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;SLA_%s,K&quot;</span>, ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;name);
<a name="l04725"></a>04725    <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(NULL, buf);
<a name="l04726"></a>04726    <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l04727"></a>04727 
<a name="l04728"></a>04728    <span class="keywordflow">while</span> ((station_ref = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;ringing_trunk-&gt;timed_out_stations, entry)))
<a name="l04729"></a>04729       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(station_ref);
<a name="l04730"></a>04730 
<a name="l04731"></a>04731    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_trunk);
<a name="l04732"></a>04732 }
<a name="l04733"></a>04733 
<a name="l04734"></a><a class="code" href="app__meetme_8c.html#a81942bf15eb39b2b6fd8ef56f7e3c2ed">04734</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a81942bf15eb39b2b6fd8ef56f7e3c2ed">sla_stop_ringing_station</a>(<span class="keyword">struct</span> <a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station,
<a name="l04735"></a>04735    <span class="keyword">enum</span> <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0">sla_station_hangup</a> hangup)
<a name="l04736"></a>04736 {
<a name="l04737"></a>04737    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l04738"></a>04738    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l04739"></a>04739    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l04740"></a>04740 
<a name="l04741"></a>04741    <a class="code" href="dial_8h.html#a726346c9cfd11a81839e0eb580b66059" title="Cancel async thread.">ast_dial_join</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial);
<a name="l04742"></a>04742    <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial);
<a name="l04743"></a>04743    ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial = NULL;
<a name="l04744"></a>04744 
<a name="l04745"></a>04745    <span class="keywordflow">if</span> (hangup == <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0a0d3359532f25486a8dd30e3ef7c90511">SLA_STATION_HANGUP_NORMAL</a>)
<a name="l04746"></a>04746       <span class="keywordflow">goto</span> done;
<a name="l04747"></a>04747 
<a name="l04748"></a>04748    <span class="comment">/* If the station is being hung up because of a timeout, then add it to the</span>
<a name="l04749"></a>04749 <span class="comment">    * list of timed out stations on each of the ringing trunks.  This is so</span>
<a name="l04750"></a>04750 <span class="comment">    * that when doing further processing to figure out which stations should be</span>
<a name="l04751"></a>04751 <span class="comment">    * ringing, which trunk to answer, determining timeouts, etc., we know which</span>
<a name="l04752"></a>04752 <span class="comment">    * ringing trunks we should ignore. */</span>
<a name="l04753"></a>04753    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l04754"></a>04754       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;trunks, trunk_ref, entry) {
<a name="l04755"></a>04755          <span class="keywordflow">if</span> (ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a> == trunk_ref-&gt;trunk)
<a name="l04756"></a>04756             <span class="keywordflow">break</span>;
<a name="l04757"></a>04757       }
<a name="l04758"></a>04758       <span class="keywordflow">if</span> (!trunk_ref)
<a name="l04759"></a>04759          <span class="keywordflow">continue</span>;
<a name="l04760"></a>04760       <span class="keywordflow">if</span> (!(station_ref = <a class="code" href="app__meetme_8c.html#a95a34a9245e87d8481590dddcfd168d2">sla_create_station_ref</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>)))
<a name="l04761"></a>04761          <span class="keywordflow">continue</span>;
<a name="l04762"></a>04762       <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;ringing_trunk-&gt;timed_out_stations, station_ref, entry);
<a name="l04763"></a>04763    }
<a name="l04764"></a>04764 
<a name="l04765"></a>04765 done:
<a name="l04766"></a>04766    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_station);
<a name="l04767"></a>04767 }
<a name="l04768"></a>04768 
<a name="l04769"></a><a class="code" href="app__meetme_8c.html#a49e602e2f36891d7fc2344119bed7ea8">04769</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a49e602e2f36891d7fc2344119bed7ea8">sla_dial_state_callback</a>(<span class="keyword">struct</span> <a class="code" href="structast__dial.html" title="Main dialing structure. Contains global options, channels being dialed, and more!...">ast_dial</a> *dial)
<a name="l04770"></a>04770 {
<a name="l04771"></a>04771    <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aacd2fcc269af2c1a25641c5afa9109ea3">SLA_EVENT_DIAL_STATE</a>);
<a name="l04772"></a>04772 }
<a name="l04773"></a>04773 <span class="comment"></span>
<a name="l04774"></a>04774 <span class="comment">/*! \brief Check to see if dialing this station already timed out for this ringing trunk</span>
<a name="l04775"></a>04775 <span class="comment"> * \note Assumes sla.lock is locked</span>
<a name="l04776"></a>04776 <span class="comment"> */</span>
<a name="l04777"></a><a class="code" href="app__meetme_8c.html#ae50d2c1eb2f8e66e0895bca7f8056951">04777</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ae50d2c1eb2f8e66e0895bca7f8056951" title="Check to see if dialing this station already timed out for this ringing trunk.">sla_check_timed_out_station</a>(<span class="keyword">const</span> <span class="keyword">struct</span> sla_ringing_trunk *ringing_trunk,
<a name="l04778"></a>04778    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04779"></a>04779 {
<a name="l04780"></a>04780    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *timed_out_station;
<a name="l04781"></a>04781 
<a name="l04782"></a>04782    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;ringing_trunk-&gt;timed_out_stations, timed_out_station, entry) {
<a name="l04783"></a>04783       <span class="keywordflow">if</span> (station == timed_out_station-&gt;station)
<a name="l04784"></a>04784          <span class="keywordflow">return</span> 1;
<a name="l04785"></a>04785    }
<a name="l04786"></a>04786 
<a name="l04787"></a>04787    <span class="keywordflow">return</span> 0;
<a name="l04788"></a>04788 }
<a name="l04789"></a>04789 <span class="comment"></span>
<a name="l04790"></a>04790 <span class="comment">/*! \brief Choose the highest priority ringing trunk for a station</span>
<a name="l04791"></a>04791 <span class="comment"> * \param station the station</span>
<a name="l04792"></a>04792 <span class="comment"> * \param remove remove the ringing trunk once selected</span>
<a name="l04793"></a>04793 <span class="comment"> * \param trunk_ref a place to store the pointer to this stations reference to</span>
<a name="l04794"></a>04794 <span class="comment"> *        the selected trunk</span>
<a name="l04795"></a>04795 <span class="comment"> * \return a pointer to the selected ringing trunk, or NULL if none found</span>
<a name="l04796"></a>04796 <span class="comment"> * \note Assumes that sla.lock is locked</span>
<a name="l04797"></a>04797 <span class="comment"> */</span>
<a name="l04798"></a><a class="code" href="app__meetme_8c.html#aa32d3b0ec852ae1c0c34b3b28286e7d6">04798</a> <span class="keyword">static</span> <span class="keyword">struct </span>sla_ringing_trunk *<a class="code" href="app__meetme_8c.html#aa32d3b0ec852ae1c0c34b3b28286e7d6" title="Choose the highest priority ringing trunk for a station.">sla_choose_ringing_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station, 
<a name="l04799"></a>04799    <span class="keyword">struct</span> <a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> **trunk_ref, <span class="keywordtype">int</span> rm)
<a name="l04800"></a>04800 {
<a name="l04801"></a>04801    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *s_trunk_ref;
<a name="l04802"></a>04802    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk = NULL;
<a name="l04803"></a>04803 
<a name="l04804"></a>04804    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, s_trunk_ref, entry) {
<a name="l04805"></a>04805       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l04806"></a>04806          <span class="comment">/* Make sure this is the trunk we&apos;re looking for */</span>
<a name="l04807"></a>04807          <span class="keywordflow">if</span> (s_trunk_ref-&gt;trunk != ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>)
<a name="l04808"></a>04808             <span class="keywordflow">continue</span>;
<a name="l04809"></a>04809 
<a name="l04810"></a>04810          <span class="comment">/* This trunk on the station is ringing.  But, make sure this station</span>
<a name="l04811"></a>04811 <span class="comment">          * didn&apos;t already time out while this trunk was ringing. */</span>
<a name="l04812"></a>04812          <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#ae50d2c1eb2f8e66e0895bca7f8056951" title="Check to see if dialing this station already timed out for this ringing trunk.">sla_check_timed_out_station</a>(ringing_trunk, station))
<a name="l04813"></a>04813             <span class="keywordflow">continue</span>;
<a name="l04814"></a>04814 
<a name="l04815"></a>04815          <span class="keywordflow">if</span> (rm)
<a name="l04816"></a>04816             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l04817"></a>04817 
<a name="l04818"></a>04818          <span class="keywordflow">if</span> (trunk_ref)
<a name="l04819"></a>04819             *trunk_ref = s_trunk_ref;
<a name="l04820"></a>04820 
<a name="l04821"></a>04821          <span class="keywordflow">break</span>;
<a name="l04822"></a>04822       }
<a name="l04823"></a>04823       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l04824"></a>04824    
<a name="l04825"></a>04825       <span class="keywordflow">if</span> (ringing_trunk)
<a name="l04826"></a>04826          <span class="keywordflow">break</span>;
<a name="l04827"></a>04827    }
<a name="l04828"></a>04828 
<a name="l04829"></a>04829    <span class="keywordflow">return</span> ringing_trunk;
<a name="l04830"></a>04830 }
<a name="l04831"></a>04831 
<a name="l04832"></a><a class="code" href="app__meetme_8c.html#a775a7291ee8f84069224106f4a9cd29f">04832</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a775a7291ee8f84069224106f4a9cd29f">sla_handle_dial_state_event</a>(<span class="keywordtype">void</span>)
<a name="l04833"></a>04833 {
<a name="l04834"></a>04834    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l04835"></a>04835 
<a name="l04836"></a>04836    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations, ringing_station, entry) {
<a name="l04837"></a>04837       <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *s_trunk_ref = NULL;
<a name="l04838"></a>04838       <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk = NULL;
<a name="l04839"></a>04839       <span class="keyword">struct </span><a class="code" href="structrun__station__args.html">run_station_args</a> args;
<a name="l04840"></a>04840       <span class="keyword">enum</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847" title="List of return codes for dial run API calls.">ast_dial_result</a> dial_res;
<a name="l04841"></a>04841       pthread_t dont_care;
<a name="l04842"></a>04842       <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="code" href="structrun__station__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>;
<a name="l04843"></a>04843       <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> cond;
<a name="l04844"></a>04844 
<a name="l04845"></a>04845       <span class="keywordflow">switch</span> ((dial_res = <a class="code" href="dial_8h.html#a051c20e595f3e3c2be10c84b4247dd37" title="Return state of dial.">ast_dial_state</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial))) {
<a name="l04846"></a>04846       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a23fe48f529c8d06fa7dffc976a871a16">AST_DIAL_RESULT_HANGUP</a>:
<a name="l04847"></a>04847       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a33b279a6d9fd2024de7a1f3ccadda2ce">AST_DIAL_RESULT_INVALID</a>:
<a name="l04848"></a>04848       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a077aa090d089e32265755c7ec0f1dac2">AST_DIAL_RESULT_FAILED</a>:
<a name="l04849"></a>04849       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a4bd947d4e1f84bf01d336e228fb431e1">AST_DIAL_RESULT_TIMEOUT</a>:
<a name="l04850"></a>04850       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847ae9986b09a1806d312dd5e508aee3b9ed">AST_DIAL_RESULT_UNANSWERED</a>:
<a name="l04851"></a>04851          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l04852"></a>04852          <a class="code" href="app__meetme_8c.html#a81942bf15eb39b2b6fd8ef56f7e3c2ed">sla_stop_ringing_station</a>(ringing_station, <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0a0d3359532f25486a8dd30e3ef7c90511">SLA_STATION_HANGUP_NORMAL</a>);
<a name="l04853"></a>04853          <span class="keywordflow">break</span>;
<a name="l04854"></a>04854       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a4a8c0d54e6071d1e9a36adae685406d3">AST_DIAL_RESULT_ANSWERED</a>:
<a name="l04855"></a>04855          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l04856"></a>04856          <span class="comment">/* Find the appropriate trunk to answer. */</span>
<a name="l04857"></a>04857          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l04858"></a>04858          ringing_trunk = <a class="code" href="app__meetme_8c.html#aa32d3b0ec852ae1c0c34b3b28286e7d6" title="Choose the highest priority ringing trunk for a station.">sla_choose_ringing_trunk</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>, &amp;s_trunk_ref, 1);
<a name="l04859"></a>04859          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l04860"></a>04860          <span class="keywordflow">if</span> (!ringing_trunk) {
<a name="l04861"></a>04861             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found no ringing trunk for station &apos;%s&apos; to answer!\n&quot;</span>, ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;name);
<a name="l04862"></a>04862             <span class="keywordflow">break</span>;
<a name="l04863"></a>04863          }
<a name="l04864"></a>04864          <span class="comment">/* Track the channel that answered this trunk */</span>
<a name="l04865"></a>04865          s_trunk_ref-&gt;chan = <a class="code" href="dial_8h.html#a83d13a00643c2ad0149758507df60466" title="Return channel that answered.">ast_dial_answered</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial);
<a name="l04866"></a>04866          <span class="comment">/* Actually answer the trunk */</span>
<a name="l04867"></a>04867          <a class="code" href="app__meetme_8c.html#a7392cc7f56677c79368716971d1ec023">answer_trunk_chan</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan);
<a name="l04868"></a>04868          <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l04869"></a>04869          <span class="comment">/* Now, start a thread that will connect this station to the trunk.  The rest of</span>
<a name="l04870"></a>04870 <span class="comment">          * the code here sets up the thread and ensures that it is able to save the arguments</span>
<a name="l04871"></a>04871 <span class="comment">          * before they are no longer valid since they are allocated on the stack. */</span>
<a name="l04872"></a>04872          args.<a class="code" href="structrun__station__args.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a> = s_trunk_ref;
<a name="l04873"></a>04873          args.<a class="code" href="structrun__station__args.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a> = ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>;
<a name="l04874"></a>04874          args.<a class="code" href="structrun__station__args.html#a45860a157e8d238e312118ddd5771454">cond</a> = &amp;cond;
<a name="l04875"></a>04875          args.<a class="code" href="structrun__station__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a> = &amp;cond_lock;
<a name="l04876"></a>04876          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_trunk);
<a name="l04877"></a>04877          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_station);
<a name="l04878"></a>04878          <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;cond_lock);
<a name="l04879"></a>04879          <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;cond, NULL);
<a name="l04880"></a>04880          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;cond_lock);
<a name="l04881"></a>04881          <a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;dont_care, NULL, <a class="code" href="app__meetme_8c.html#a1e618b1883d308cb371b0e7b0800bf3f">run_station</a>, &amp;args);
<a name="l04882"></a>04882          <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;cond, &amp;cond_lock);
<a name="l04883"></a>04883          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;cond_lock);
<a name="l04884"></a>04884          <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;cond_lock);
<a name="l04885"></a>04885          <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;cond);
<a name="l04886"></a>04886          <span class="keywordflow">break</span>;
<a name="l04887"></a>04887       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a5838a3c4774e4d0e9a7d9d3724850ae6">AST_DIAL_RESULT_TRYING</a>:
<a name="l04888"></a>04888       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847aba600b021de0e20a6e8a6c484f27a9e4">AST_DIAL_RESULT_RINGING</a>:
<a name="l04889"></a>04889       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a5cc795503d8ce3f6df21f18e7d30e24e">AST_DIAL_RESULT_PROGRESS</a>:
<a name="l04890"></a>04890       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847ae16711939ebe81a08ebcbd8d7d0aab3d">AST_DIAL_RESULT_PROCEEDING</a>:
<a name="l04891"></a>04891          <span class="keywordflow">break</span>;
<a name="l04892"></a>04892       }
<a name="l04893"></a>04893       <span class="keywordflow">if</span> (dial_res == <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a4a8c0d54e6071d1e9a36adae685406d3">AST_DIAL_RESULT_ANSWERED</a>) {
<a name="l04894"></a>04894          <span class="comment">/* Queue up reprocessing ringing trunks, and then ringing stations again */</span>
<a name="l04895"></a>04895          <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>);
<a name="l04896"></a>04896          <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aacd2fcc269af2c1a25641c5afa9109ea3">SLA_EVENT_DIAL_STATE</a>);
<a name="l04897"></a>04897          <span class="keywordflow">break</span>;
<a name="l04898"></a>04898       }
<a name="l04899"></a>04899    }
<a name="l04900"></a>04900    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l04901"></a>04901 }
<a name="l04902"></a>04902 <span class="comment"></span>
<a name="l04903"></a>04903 <span class="comment">/*! \brief Check to see if this station is already ringing </span>
<a name="l04904"></a>04904 <span class="comment"> * \note Assumes sla.lock is locked </span>
<a name="l04905"></a>04905 <span class="comment"> */</span>
<a name="l04906"></a><a class="code" href="app__meetme_8c.html#ae6b09ff4870f925ad151cac19454021f">04906</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ae6b09ff4870f925ad151cac19454021f" title="Check to see if this station is already ringing.">sla_check_ringing_station</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04907"></a>04907 {
<a name="l04908"></a>04908    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l04909"></a>04909 
<a name="l04910"></a>04910    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations, ringing_station, entry) {
<a name="l04911"></a>04911       <span class="keywordflow">if</span> (station == ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>)
<a name="l04912"></a>04912          <span class="keywordflow">return</span> 1;
<a name="l04913"></a>04913    }
<a name="l04914"></a>04914 
<a name="l04915"></a>04915    <span class="keywordflow">return</span> 0;
<a name="l04916"></a>04916 }
<a name="l04917"></a>04917 <span class="comment"></span>
<a name="l04918"></a>04918 <span class="comment">/*! \brief Check to see if this station has failed to be dialed in the past minute</span>
<a name="l04919"></a>04919 <span class="comment"> * \note assumes sla.lock is locked</span>
<a name="l04920"></a>04920 <span class="comment"> */</span>
<a name="l04921"></a><a class="code" href="app__meetme_8c.html#a226cceaaf022a7ffc67fc7fd57049372">04921</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a226cceaaf022a7ffc67fc7fd57049372" title="Check to see if this station has failed to be dialed in the past minute.">sla_check_failed_station</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04922"></a>04922 {
<a name="l04923"></a>04923    <span class="keyword">struct </span>sla_failed_station *failed_station;
<a name="l04924"></a>04924    <span class="keywordtype">int</span> res = 0;
<a name="l04925"></a>04925 
<a name="l04926"></a>04926    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.failed_stations, failed_station, entry) {
<a name="l04927"></a>04927       <span class="keywordflow">if</span> (station != failed_station-&gt;<a class="code" href="structsla__failed__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>)
<a name="l04928"></a>04928          <span class="keywordflow">continue</span>;
<a name="l04929"></a>04929       <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), failed_station-&gt;<a class="code" href="structsla__failed__station.html#ad0eecb6223757f0f347c81c1e2c14eb6">last_try</a>) &gt; 1000) {
<a name="l04930"></a>04930          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l04931"></a>04931          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(failed_station);
<a name="l04932"></a>04932          <span class="keywordflow">break</span>;
<a name="l04933"></a>04933       }
<a name="l04934"></a>04934       res = 1;
<a name="l04935"></a>04935    }
<a name="l04936"></a>04936    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l04937"></a>04937 
<a name="l04938"></a>04938    <span class="keywordflow">return</span> res;
<a name="l04939"></a>04939 }
<a name="l04940"></a>04940 <span class="comment"></span>
<a name="l04941"></a>04941 <span class="comment">/*! \brief Ring a station</span>
<a name="l04942"></a>04942 <span class="comment"> * \note Assumes sla.lock is locked</span>
<a name="l04943"></a>04943 <span class="comment"> */</span>
<a name="l04944"></a><a class="code" href="app__meetme_8c.html#a2b054c0a7413800ad257ab0f85a82d29">04944</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a2b054c0a7413800ad257ab0f85a82d29" title="Ring a station.">sla_ring_station</a>(<span class="keyword">struct</span> sla_ringing_trunk *ringing_trunk, <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l04945"></a>04945 {
<a name="l04946"></a>04946    <span class="keywordtype">char</span> *tech, *tech_data;
<a name="l04947"></a>04947    <span class="keyword">struct </span><a class="code" href="structast__dial.html" title="Main dialing structure. Contains global options, channels being dialed, and more!...">ast_dial</a> *dial;
<a name="l04948"></a>04948    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l04949"></a>04949    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a> = NULL, *<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a> = NULL;
<a name="l04950"></a>04950    <span class="keyword">enum</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847" title="List of return codes for dial run API calls.">ast_dial_result</a> res;
<a name="l04951"></a>04951 
<a name="l04952"></a>04952    <span class="keywordflow">if</span> (!(dial = <a class="code" href="dial_8h.html#aff55dbc56bc54126828f78a47d1f2282" title="New dialing structure.">ast_dial_create</a>()))
<a name="l04953"></a>04953       <span class="keywordflow">return</span> -1;
<a name="l04954"></a>04954 
<a name="l04955"></a>04955    <a class="code" href="dial_8h.html#a2674932599e61fe027364a09f6d68c4e" title="Set a callback for state changes.">ast_dial_set_state_callback</a>(dial, <a class="code" href="app__meetme_8c.html#a49e602e2f36891d7fc2344119bed7ea8">sla_dial_state_callback</a>);
<a name="l04956"></a>04956    tech_data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(station-&gt;device);
<a name="l04957"></a>04957    tech = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tech_data, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l04958"></a>04958 
<a name="l04959"></a>04959    <span class="keywordflow">if</span> (<a class="code" href="dial_8h.html#abeec986e8b07f021533d46ad27715ec1" title="Append a channel.">ast_dial_append</a>(dial, tech, tech_data) == -1) {
<a name="l04960"></a>04960       <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l04961"></a>04961       <span class="keywordflow">return</span> -1;
<a name="l04962"></a>04962    }
<a name="l04963"></a>04963 
<a name="l04964"></a>04964    <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.attempt_callerid &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_name)) {
<a name="l04965"></a>04965       cid_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_name);
<a name="l04966"></a>04966       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_name);
<a name="l04967"></a>04967       ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_name = NULL;
<a name="l04968"></a>04968    }
<a name="l04969"></a>04969    <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.attempt_callerid &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_num)) {
<a name="l04970"></a>04970       cid_num = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_num);
<a name="l04971"></a>04971       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_num);
<a name="l04972"></a>04972       ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_num = NULL;
<a name="l04973"></a>04973    }
<a name="l04974"></a>04974 
<a name="l04975"></a>04975    res = <a class="code" href="dial_8h.html#a65e30d29847af5495afe1baed823957e" title="Execute dialing synchronously or asynchronously.">ast_dial_run</a>(dial, ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan, 1);
<a name="l04976"></a>04976    
<a name="l04977"></a>04977    <span class="keywordflow">if</span> (cid_name)
<a name="l04978"></a>04978       ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_name = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cid_name);
<a name="l04979"></a>04979    <span class="keywordflow">if</span> (cid_num)
<a name="l04980"></a>04980       ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan-&gt;cid.cid_num = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cid_num);
<a name="l04981"></a>04981    
<a name="l04982"></a>04982    <span class="keywordflow">if</span> (res != <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a5838a3c4774e4d0e9a7d9d3724850ae6">AST_DIAL_RESULT_TRYING</a>) {
<a name="l04983"></a>04983       <span class="keyword">struct </span>sla_failed_station *failed_station;
<a name="l04984"></a>04984       <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l04985"></a>04985       <span class="keywordflow">if</span> (!(failed_station = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*failed_station))))
<a name="l04986"></a>04986          <span class="keywordflow">return</span> -1;
<a name="l04987"></a>04987       failed_station-&gt;<a class="code" href="structsla__failed__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a> = station;
<a name="l04988"></a>04988       failed_station-&gt;<a class="code" href="structsla__failed__station.html#ad0eecb6223757f0f347c81c1e2c14eb6">last_try</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l04989"></a>04989       <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.failed_stations, failed_station, entry);
<a name="l04990"></a>04990       <span class="keywordflow">return</span> -1;
<a name="l04991"></a>04991    }
<a name="l04992"></a>04992    <span class="keywordflow">if</span> (!(ringing_station = <a class="code" href="app__meetme_8c.html#ad714502c1dbeae46a86c3b4e2e210ed1">sla_create_ringing_station</a>(station))) {
<a name="l04993"></a>04993       <a class="code" href="dial_8h.html#a726346c9cfd11a81839e0eb580b66059" title="Cancel async thread.">ast_dial_join</a>(dial);
<a name="l04994"></a>04994       <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l04995"></a>04995       <span class="keywordflow">return</span> -1;
<a name="l04996"></a>04996    }
<a name="l04997"></a>04997 
<a name="l04998"></a>04998    station-&gt;dial = dial;
<a name="l04999"></a>04999 
<a name="l05000"></a>05000    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations, ringing_station, entry);
<a name="l05001"></a>05001 
<a name="l05002"></a>05002    <span class="keywordflow">return</span> 0;
<a name="l05003"></a>05003 }
<a name="l05004"></a>05004 <span class="comment"></span>
<a name="l05005"></a>05005 <span class="comment">/*! \brief Check to see if a station is in use</span>
<a name="l05006"></a>05006 <span class="comment"> */</span>
<a name="l05007"></a><a class="code" href="app__meetme_8c.html#a313d4f30e509464cdd73a39a9af14145">05007</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a313d4f30e509464cdd73a39a9af14145" title="Check to see if a station is in use.">sla_check_inuse_station</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l05008"></a>05008 {
<a name="l05009"></a>05009    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05010"></a>05010 
<a name="l05011"></a>05011    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l05012"></a>05012       <span class="keywordflow">if</span> (trunk_ref-&gt;chan)
<a name="l05013"></a>05013          <span class="keywordflow">return</span> 1;
<a name="l05014"></a>05014    }
<a name="l05015"></a>05015 
<a name="l05016"></a>05016    <span class="keywordflow">return</span> 0;
<a name="l05017"></a>05017 }
<a name="l05018"></a>05018 
<a name="l05019"></a><a class="code" href="app__meetme_8c.html#a9a6475fc98053a8c8320d70e3c8e186f">05019</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *<a class="code" href="app__meetme_8c.html#a9a6475fc98053a8c8320d70e3c8e186f">sla_find_trunk_ref</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station,
<a name="l05020"></a>05020    <span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk)
<a name="l05021"></a>05021 {
<a name="l05022"></a>05022    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref = NULL;
<a name="l05023"></a>05023 
<a name="l05024"></a>05024    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l05025"></a>05025       <span class="keywordflow">if</span> (trunk_ref-&gt;trunk == trunk)
<a name="l05026"></a>05026          <span class="keywordflow">break</span>;
<a name="l05027"></a>05027    }
<a name="l05028"></a>05028 
<a name="l05029"></a>05029    <span class="keywordflow">return</span> trunk_ref;
<a name="l05030"></a>05030 }
<a name="l05031"></a>05031 <span class="comment"></span>
<a name="l05032"></a>05032 <span class="comment">/*! \brief Calculate the ring delay for a given ringing trunk on a station</span>
<a name="l05033"></a>05033 <span class="comment"> * \param station the station</span>
<a name="l05034"></a>05034 <span class="comment"> * \param ringing_trunk the trunk.  If NULL, the highest priority ringing trunk will be used</span>
<a name="l05035"></a>05035 <span class="comment"> * \return the number of ms left before the delay is complete, or INT_MAX if there is no delay</span>
<a name="l05036"></a>05036 <span class="comment"> */</span>
<a name="l05037"></a><a class="code" href="app__meetme_8c.html#abe13fe32f5a19def3086a620f4e05cf9">05037</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#abe13fe32f5a19def3086a620f4e05cf9" title="Calculate the ring delay for a given ringing trunk on a station.">sla_check_station_delay</a>(<span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station, 
<a name="l05038"></a>05038    <span class="keyword">struct</span> sla_ringing_trunk *ringing_trunk)
<a name="l05039"></a>05039 {
<a name="l05040"></a>05040    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05041"></a>05041    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> delay = UINT_MAX;
<a name="l05042"></a>05042    <span class="keywordtype">int</span> time_left, time_elapsed;
<a name="l05043"></a>05043 
<a name="l05044"></a>05044    <span class="keywordflow">if</span> (!ringing_trunk)
<a name="l05045"></a>05045       ringing_trunk = <a class="code" href="app__meetme_8c.html#aa32d3b0ec852ae1c0c34b3b28286e7d6" title="Choose the highest priority ringing trunk for a station.">sla_choose_ringing_trunk</a>(station, &amp;trunk_ref, 0);
<a name="l05046"></a>05046    <span class="keywordflow">else</span>
<a name="l05047"></a>05047       trunk_ref = <a class="code" href="app__meetme_8c.html#a9a6475fc98053a8c8320d70e3c8e186f">sla_find_trunk_ref</a>(station, ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>);
<a name="l05048"></a>05048 
<a name="l05049"></a>05049    <span class="keywordflow">if</span> (!ringing_trunk || !trunk_ref)
<a name="l05050"></a>05050       <span class="keywordflow">return</span> delay;
<a name="l05051"></a>05051 
<a name="l05052"></a>05052    <span class="comment">/* If this station has a ring delay specific to the highest priority</span>
<a name="l05053"></a>05053 <span class="comment">    * ringing trunk, use that.  Otherwise, use the ring delay specified</span>
<a name="l05054"></a>05054 <span class="comment">    * globally for the station. */</span>
<a name="l05055"></a>05055    delay = trunk_ref-&gt;ring_delay;
<a name="l05056"></a>05056    <span class="keywordflow">if</span> (!delay)
<a name="l05057"></a>05057       delay = station-&gt;ring_delay;
<a name="l05058"></a>05058    <span class="keywordflow">if</span> (!delay)
<a name="l05059"></a>05059       <span class="keywordflow">return</span> INT_MAX;
<a name="l05060"></a>05060 
<a name="l05061"></a>05061    time_elapsed = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#a5fad56bdd993af8ceb77ab8a83134f0f">ring_begin</a>);
<a name="l05062"></a>05062    time_left = (delay * 1000) - time_elapsed;
<a name="l05063"></a>05063 
<a name="l05064"></a>05064    <span class="keywordflow">return</span> time_left;
<a name="l05065"></a>05065 }
<a name="l05066"></a>05066 <span class="comment"></span>
<a name="l05067"></a>05067 <span class="comment">/*! \brief Ring stations based on current set of ringing trunks</span>
<a name="l05068"></a>05068 <span class="comment"> * \note Assumes that sla.lock is locked</span>
<a name="l05069"></a>05069 <span class="comment"> */</span>
<a name="l05070"></a><a class="code" href="app__meetme_8c.html#aae1fb3024d55422f49daef5b4737757c">05070</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#aae1fb3024d55422f49daef5b4737757c" title="Ring stations based on current set of ringing trunks.">sla_ring_stations</a>(<span class="keywordtype">void</span>)
<a name="l05071"></a>05071 {
<a name="l05072"></a>05072    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l05073"></a>05073    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05074"></a>05074 
<a name="l05075"></a>05075    <span class="comment">/* Make sure that every station that uses at least one of the ringing</span>
<a name="l05076"></a>05076 <span class="comment">    * trunks, is ringing. */</span>
<a name="l05077"></a>05077    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l05078"></a>05078       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;stations, station_ref, entry) {
<a name="l05079"></a>05079          <span class="keywordtype">int</span> time_left;
<a name="l05080"></a>05080 
<a name="l05081"></a>05081          <span class="comment">/* Is this station already ringing? */</span>
<a name="l05082"></a>05082          <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#ae6b09ff4870f925ad151cac19454021f" title="Check to see if this station is already ringing.">sla_check_ringing_station</a>(station_ref-&gt;station))
<a name="l05083"></a>05083             <span class="keywordflow">continue</span>;
<a name="l05084"></a>05084 
<a name="l05085"></a>05085          <span class="comment">/* Is this station already in a call? */</span>
<a name="l05086"></a>05086          <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a313d4f30e509464cdd73a39a9af14145" title="Check to see if a station is in use.">sla_check_inuse_station</a>(station_ref-&gt;station))
<a name="l05087"></a>05087             <span class="keywordflow">continue</span>;
<a name="l05088"></a>05088 
<a name="l05089"></a>05089          <span class="comment">/* Did we fail to dial this station earlier?  If so, has it been</span>
<a name="l05090"></a>05090 <span class="comment">          * a minute since we tried? */</span>
<a name="l05091"></a>05091          <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a226cceaaf022a7ffc67fc7fd57049372" title="Check to see if this station has failed to be dialed in the past minute.">sla_check_failed_station</a>(station_ref-&gt;station))
<a name="l05092"></a>05092             <span class="keywordflow">continue</span>;
<a name="l05093"></a>05093 
<a name="l05094"></a>05094          <span class="comment">/* If this station already timed out while this trunk was ringing,</span>
<a name="l05095"></a>05095 <span class="comment">          * do not dial it again for this ringing trunk. */</span>
<a name="l05096"></a>05096          <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#ae50d2c1eb2f8e66e0895bca7f8056951" title="Check to see if dialing this station already timed out for this ringing trunk.">sla_check_timed_out_station</a>(ringing_trunk, station_ref-&gt;station))
<a name="l05097"></a>05097             <span class="keywordflow">continue</span>;
<a name="l05098"></a>05098 
<a name="l05099"></a>05099          <span class="comment">/* Check for a ring delay in progress */</span>
<a name="l05100"></a>05100          time_left = <a class="code" href="app__meetme_8c.html#abe13fe32f5a19def3086a620f4e05cf9" title="Calculate the ring delay for a given ringing trunk on a station.">sla_check_station_delay</a>(station_ref-&gt;station, ringing_trunk);
<a name="l05101"></a>05101          <span class="keywordflow">if</span> (time_left != INT_MAX &amp;&amp; time_left &gt; 0)
<a name="l05102"></a>05102             <span class="keywordflow">continue</span>;
<a name="l05103"></a>05103 
<a name="l05104"></a>05104          <span class="comment">/* It is time to make this station begin to ring.  Do it! */</span>
<a name="l05105"></a>05105          <a class="code" href="app__meetme_8c.html#a2b054c0a7413800ad257ab0f85a82d29" title="Ring a station.">sla_ring_station</a>(ringing_trunk, station_ref-&gt;station);
<a name="l05106"></a>05106       }
<a name="l05107"></a>05107    }
<a name="l05108"></a>05108    <span class="comment">/* Now, all of the stations that should be ringing, are ringing. */</span>
<a name="l05109"></a>05109 }
<a name="l05110"></a>05110 
<a name="l05111"></a><a class="code" href="app__meetme_8c.html#adca456136914b6d97720cd49b0923ffe">05111</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#adca456136914b6d97720cd49b0923ffe">sla_hangup_stations</a>(<span class="keywordtype">void</span>)
<a name="l05112"></a>05112 {
<a name="l05113"></a>05113    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05114"></a>05114    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l05115"></a>05115 
<a name="l05116"></a>05116    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations, ringing_station, entry) {
<a name="l05117"></a>05117       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;trunks, trunk_ref, entry) {
<a name="l05118"></a>05118          <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05119"></a>05119          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05120"></a>05120          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l05121"></a>05121             <span class="keywordflow">if</span> (trunk_ref-&gt;trunk == ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>)
<a name="l05122"></a>05122                <span class="keywordflow">break</span>;
<a name="l05123"></a>05123          }
<a name="l05124"></a>05124          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05125"></a>05125          <span class="keywordflow">if</span> (ringing_trunk)
<a name="l05126"></a>05126             <span class="keywordflow">break</span>;
<a name="l05127"></a>05127       }
<a name="l05128"></a>05128       <span class="keywordflow">if</span> (!trunk_ref) {
<a name="l05129"></a>05129          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l05130"></a>05130          <a class="code" href="dial_8h.html#a726346c9cfd11a81839e0eb580b66059" title="Cancel async thread.">ast_dial_join</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial);
<a name="l05131"></a>05131          <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial);
<a name="l05132"></a>05132          ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;dial = NULL;
<a name="l05133"></a>05133          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_station);
<a name="l05134"></a>05134       }
<a name="l05135"></a>05135    }
<a name="l05136"></a>05136    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l05137"></a>05137 }
<a name="l05138"></a>05138 
<a name="l05139"></a><a class="code" href="app__meetme_8c.html#a69102ed9de8dc84bb7d435dac5fe22cf">05139</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a69102ed9de8dc84bb7d435dac5fe22cf">sla_handle_ringing_trunk_event</a>(<span class="keywordtype">void</span>)
<a name="l05140"></a>05140 {
<a name="l05141"></a>05141    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05142"></a>05142    <a class="code" href="app__meetme_8c.html#aae1fb3024d55422f49daef5b4737757c" title="Ring stations based on current set of ringing trunks.">sla_ring_stations</a>();
<a name="l05143"></a>05143    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05144"></a>05144 
<a name="l05145"></a>05145    <span class="comment">/* Find stations that shouldn&apos;t be ringing anymore. */</span>
<a name="l05146"></a>05146    <a class="code" href="app__meetme_8c.html#adca456136914b6d97720cd49b0923ffe">sla_hangup_stations</a>();
<a name="l05147"></a>05147 }
<a name="l05148"></a>05148 
<a name="l05149"></a><a class="code" href="app__meetme_8c.html#ac197e9e3bae472fa5ac27237055a3b9d">05149</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#ac197e9e3bae472fa5ac27237055a3b9d">sla_handle_hold_event</a>(<span class="keyword">struct</span> <a class="code" href="structsla__event.html">sla_event</a> *event)
<a name="l05150"></a>05150 {
<a name="l05151"></a>05151    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>-&gt;trunk-&gt;hold_stations, 1);
<a name="l05152"></a>05152    <span class="keyword">event</span>-&gt;trunk_ref-&gt;state = <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>;
<a name="l05153"></a>05153    <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea6b7416bea92d3bc5ee8e36f0a484cdc1">AST_DEVICE_ONHOLD</a>, <span class="stringliteral">&quot;SLA:%s_%s&quot;</span>, 
<a name="l05154"></a>05154       event-&gt;<a class="code" href="structsla__event.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;name, event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>-&gt;trunk-&gt;name);
<a name="l05155"></a>05155    <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a17322fe34775141bef95a88fd00ed59d">SLA_TRUNK_STATE_ONHOLD</a>, 
<a name="l05156"></a>05156       <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215a5b13df634bb3782cb4a25c0fe0712515">INACTIVE_TRUNK_REFS</a>, event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>);
<a name="l05157"></a>05157 
<a name="l05158"></a>05158    <span class="keywordflow">if</span> (event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>-&gt;trunk-&gt;active_stations == 1) {
<a name="l05159"></a>05159       <span class="comment">/* The station putting it on hold is the only one on the call, so start</span>
<a name="l05160"></a>05160 <span class="comment">       * Music on hold to the trunk. */</span>
<a name="l05161"></a>05161       <span class="keyword">event</span>-&gt;trunk_ref-&gt;trunk-&gt;on_hold = 1;
<a name="l05162"></a>05162       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>-&gt;trunk-&gt;chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>);
<a name="l05163"></a>05163    }
<a name="l05164"></a>05164 
<a name="l05165"></a>05165    <a class="code" href="channel_8h.html#ac2d6607253f7e8b272d4e845474eaa9b" title="Softly hangup up a channel.">ast_softhangup</a>(event-&gt;<a class="code" href="structsla__event.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>-&gt;chan, <a class="code" href="channel_8h.html#a2dbb833ef0dcc466dd02ee76badaf709a2e185ce313026e13ed90ae3a319c9cb7">AST_SOFTHANGUP_DEV</a>);
<a name="l05166"></a>05166    <span class="keyword">event</span>-&gt;trunk_ref-&gt;chan = NULL;
<a name="l05167"></a>05167 }
<a name="l05168"></a>05168 <span class="comment"></span>
<a name="l05169"></a>05169 <span class="comment">/*! \brief Process trunk ring timeouts</span>
<a name="l05170"></a>05170 <span class="comment"> * \note Called with sla.lock locked</span>
<a name="l05171"></a>05171 <span class="comment"> * \return non-zero if a change to the ringing trunks was made</span>
<a name="l05172"></a>05172 <span class="comment"> */</span>
<a name="l05173"></a><a class="code" href="app__meetme_8c.html#acdab27627974ea2e3fbf169bce26523b">05173</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#acdab27627974ea2e3fbf169bce26523b" title="Process trunk ring timeouts.">sla_calc_trunk_timeouts</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *timeout)
<a name="l05174"></a>05174 {
<a name="l05175"></a>05175    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05176"></a>05176    <span class="keywordtype">int</span> res = 0;
<a name="l05177"></a>05177 
<a name="l05178"></a>05178    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l05179"></a>05179       <span class="keywordtype">int</span> time_left, time_elapsed;
<a name="l05180"></a>05180       <span class="keywordflow">if</span> (!ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;ring_timeout)
<a name="l05181"></a>05181          <span class="keywordflow">continue</span>;
<a name="l05182"></a>05182       time_elapsed = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#a5fad56bdd993af8ceb77ab8a83134f0f">ring_begin</a>);
<a name="l05183"></a>05183       time_left = (ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;ring_timeout * 1000) - time_elapsed;
<a name="l05184"></a>05184       <span class="keywordflow">if</span> (time_left &lt;= 0) {
<a name="l05185"></a>05185          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;RINGTIMEOUT&quot;</span>);
<a name="l05186"></a>05186          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l05187"></a>05187          <a class="code" href="app__meetme_8c.html#a53f8684abfc755b445ce1f77aba6f2c0">sla_stop_ringing_trunk</a>(ringing_trunk);
<a name="l05188"></a>05188          res = 1;
<a name="l05189"></a>05189          <span class="keywordflow">continue</span>;
<a name="l05190"></a>05190       }
<a name="l05191"></a>05191       <span class="keywordflow">if</span> (time_left &lt; *timeout)
<a name="l05192"></a>05192          *timeout = time_left;
<a name="l05193"></a>05193    }
<a name="l05194"></a>05194    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l05195"></a>05195 
<a name="l05196"></a>05196    <span class="keywordflow">return</span> res;
<a name="l05197"></a>05197 }
<a name="l05198"></a>05198 <span class="comment"></span>
<a name="l05199"></a>05199 <span class="comment">/*! \brief Process station ring timeouts</span>
<a name="l05200"></a>05200 <span class="comment"> * \note Called with sla.lock locked</span>
<a name="l05201"></a>05201 <span class="comment"> * \return non-zero if a change to the ringing stations was made</span>
<a name="l05202"></a>05202 <span class="comment"> */</span>
<a name="l05203"></a><a class="code" href="app__meetme_8c.html#af94ec9322c762bc23130e081684d09a1">05203</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#af94ec9322c762bc23130e081684d09a1" title="Process station ring timeouts.">sla_calc_station_timeouts</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *timeout)
<a name="l05204"></a>05204 {
<a name="l05205"></a>05205    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05206"></a>05206    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l05207"></a>05207    <span class="keywordtype">int</span> res = 0;
<a name="l05208"></a>05208 
<a name="l05209"></a>05209    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations, ringing_station, entry) {
<a name="l05210"></a>05210       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ring_timeout = 0;
<a name="l05211"></a>05211       <span class="keywordtype">int</span> time_elapsed, time_left = INT_MAX, final_trunk_time_left = INT_MIN;
<a name="l05212"></a>05212       <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05213"></a>05213 
<a name="l05214"></a>05214       <span class="comment">/* If there are any ring timeouts specified for a specific trunk</span>
<a name="l05215"></a>05215 <span class="comment">       * on the station, then use the highest per-trunk ring timeout.</span>
<a name="l05216"></a>05216 <span class="comment">       * Otherwise, use the ring timeout set for the entire station. */</span>
<a name="l05217"></a>05217       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;trunks, trunk_ref, entry) {
<a name="l05218"></a>05218          <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l05219"></a>05219          <span class="keywordtype">int</span> trunk_time_elapsed, trunk_time_left;
<a name="l05220"></a>05220 
<a name="l05221"></a>05221          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l05222"></a>05222             <span class="keywordflow">if</span> (ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a> == trunk_ref-&gt;trunk)
<a name="l05223"></a>05223                <span class="keywordflow">break</span>;
<a name="l05224"></a>05224          }
<a name="l05225"></a>05225          <span class="keywordflow">if</span> (!ringing_trunk)
<a name="l05226"></a>05226             <span class="keywordflow">continue</span>;
<a name="l05227"></a>05227 
<a name="l05228"></a>05228          <span class="comment">/* If there is a trunk that is ringing without a timeout, then the</span>
<a name="l05229"></a>05229 <span class="comment">          * only timeout that could matter is a global station ring timeout. */</span>
<a name="l05230"></a>05230          <span class="keywordflow">if</span> (!trunk_ref-&gt;ring_timeout)
<a name="l05231"></a>05231             <span class="keywordflow">break</span>;
<a name="l05232"></a>05232 
<a name="l05233"></a>05233          <span class="comment">/* This trunk on this station is ringing and has a timeout.</span>
<a name="l05234"></a>05234 <span class="comment">          * However, make sure this trunk isn&apos;t still ringing from a</span>
<a name="l05235"></a>05235 <span class="comment">          * previous timeout.  If so, don&apos;t consider it. */</span>
<a name="l05236"></a>05236          <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;ringing_trunk-&gt;timed_out_stations, station_ref, entry) {
<a name="l05237"></a>05237             <span class="keywordflow">if</span> (station_ref-&gt;station == ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>)
<a name="l05238"></a>05238                <span class="keywordflow">break</span>;
<a name="l05239"></a>05239          }
<a name="l05240"></a>05240          <span class="keywordflow">if</span> (station_ref)
<a name="l05241"></a>05241             <span class="keywordflow">continue</span>;
<a name="l05242"></a>05242 
<a name="l05243"></a>05243          trunk_time_elapsed = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#a5fad56bdd993af8ceb77ab8a83134f0f">ring_begin</a>);
<a name="l05244"></a>05244          trunk_time_left = (trunk_ref-&gt;ring_timeout * 1000) - trunk_time_elapsed;
<a name="l05245"></a>05245          <span class="keywordflow">if</span> (trunk_time_left &gt; final_trunk_time_left)
<a name="l05246"></a>05246             final_trunk_time_left = trunk_time_left;
<a name="l05247"></a>05247       }
<a name="l05248"></a>05248 
<a name="l05249"></a>05249       <span class="comment">/* No timeout was found for ringing trunks, and no timeout for the entire station */</span>
<a name="l05250"></a>05250       <span class="keywordflow">if</span> (final_trunk_time_left == INT_MIN &amp;&amp; !ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;ring_timeout)
<a name="l05251"></a>05251          <span class="keywordflow">continue</span>;
<a name="l05252"></a>05252 
<a name="l05253"></a>05253       <span class="comment">/* Compute how much time is left for a global station timeout */</span>
<a name="l05254"></a>05254       <span class="keywordflow">if</span> (ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;ring_timeout) {
<a name="l05255"></a>05255          ring_timeout = ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a0569f66b3f952276c1a8ec5f2ffd5466">station</a>-&gt;ring_timeout;
<a name="l05256"></a>05256          time_elapsed = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), ringing_station-&gt;<a class="code" href="structsla__ringing__station.html#a5fad56bdd993af8ceb77ab8a83134f0f">ring_begin</a>);
<a name="l05257"></a>05257          time_left = (ring_timeout * 1000) - time_elapsed;
<a name="l05258"></a>05258       }
<a name="l05259"></a>05259 
<a name="l05260"></a>05260       <span class="comment">/* If the time left based on the per-trunk timeouts is smaller than the</span>
<a name="l05261"></a>05261 <span class="comment">       * global station ring timeout, use that. */</span>
<a name="l05262"></a>05262       <span class="keywordflow">if</span> (final_trunk_time_left &gt; INT_MIN &amp;&amp; final_trunk_time_left &lt; time_left)
<a name="l05263"></a>05263          time_left = final_trunk_time_left;
<a name="l05264"></a>05264 
<a name="l05265"></a>05265       <span class="comment">/* If there is no time left, the station needs to stop ringing */</span>
<a name="l05266"></a>05266       <span class="keywordflow">if</span> (time_left &lt;= 0) {
<a name="l05267"></a>05267          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l05268"></a>05268          <a class="code" href="app__meetme_8c.html#a81942bf15eb39b2b6fd8ef56f7e3c2ed">sla_stop_ringing_station</a>(ringing_station, <a class="code" href="app__meetme_8c.html#af1c1448ffe2b0e610323ea6725f412c0aac519ad8347eceb83b914cae3bdc8018">SLA_STATION_HANGUP_TIMEOUT</a>);
<a name="l05269"></a>05269          res = 1;
<a name="l05270"></a>05270          <span class="keywordflow">continue</span>;
<a name="l05271"></a>05271       }
<a name="l05272"></a>05272 
<a name="l05273"></a>05273       <span class="comment">/* There is still some time left for this station to ring, so save that</span>
<a name="l05274"></a>05274 <span class="comment">       * timeout if it is the first event scheduled to occur */</span>
<a name="l05275"></a>05275       <span class="keywordflow">if</span> (time_left &lt; *timeout)
<a name="l05276"></a>05276          *timeout = time_left;
<a name="l05277"></a>05277    }
<a name="l05278"></a>05278    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l05279"></a>05279 
<a name="l05280"></a>05280    <span class="keywordflow">return</span> res;
<a name="l05281"></a>05281 }
<a name="l05282"></a>05282 <span class="comment"></span>
<a name="l05283"></a>05283 <span class="comment">/*! \brief Calculate the ring delay for a station</span>
<a name="l05284"></a>05284 <span class="comment"> * \note Assumes sla.lock is locked</span>
<a name="l05285"></a>05285 <span class="comment"> */</span>
<a name="l05286"></a><a class="code" href="app__meetme_8c.html#a211b086be7f6f888072a0d7818827f64">05286</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a211b086be7f6f888072a0d7818827f64" title="Calculate the ring delay for a station.">sla_calc_station_delays</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *timeout)
<a name="l05287"></a>05287 {
<a name="l05288"></a>05288    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l05289"></a>05289    <span class="keywordtype">int</span> res = 0;
<a name="l05290"></a>05290 
<a name="l05291"></a>05291    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l05292"></a>05292       <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05293"></a>05293       <span class="keywordtype">int</span> time_left;
<a name="l05294"></a>05294 
<a name="l05295"></a>05295       <span class="comment">/* Ignore stations already ringing */</span>
<a name="l05296"></a>05296       <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#ae6b09ff4870f925ad151cac19454021f" title="Check to see if this station is already ringing.">sla_check_ringing_station</a>(station))
<a name="l05297"></a>05297          <span class="keywordflow">continue</span>;
<a name="l05298"></a>05298 
<a name="l05299"></a>05299       <span class="comment">/* Ignore stations already on a call */</span>
<a name="l05300"></a>05300       <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a313d4f30e509464cdd73a39a9af14145" title="Check to see if a station is in use.">sla_check_inuse_station</a>(station))
<a name="l05301"></a>05301          <span class="keywordflow">continue</span>;
<a name="l05302"></a>05302 
<a name="l05303"></a>05303       <span class="comment">/* Ignore stations that don&apos;t have one of their trunks ringing */</span>
<a name="l05304"></a>05304       <span class="keywordflow">if</span> (!(ringing_trunk = <a class="code" href="app__meetme_8c.html#aa32d3b0ec852ae1c0c34b3b28286e7d6" title="Choose the highest priority ringing trunk for a station.">sla_choose_ringing_trunk</a>(station, NULL, 0)))
<a name="l05305"></a>05305          <span class="keywordflow">continue</span>;
<a name="l05306"></a>05306 
<a name="l05307"></a>05307       <span class="keywordflow">if</span> ((time_left = <a class="code" href="app__meetme_8c.html#abe13fe32f5a19def3086a620f4e05cf9" title="Calculate the ring delay for a given ringing trunk on a station.">sla_check_station_delay</a>(station, ringing_trunk)) == INT_MAX)
<a name="l05308"></a>05308          <span class="keywordflow">continue</span>;
<a name="l05309"></a>05309 
<a name="l05310"></a>05310       <span class="comment">/* If there is no time left, then the station needs to start ringing.</span>
<a name="l05311"></a>05311 <span class="comment">       * Return non-zero so that an event will be queued up an event to </span>
<a name="l05312"></a>05312 <span class="comment">       * make that happen. */</span>
<a name="l05313"></a>05313       <span class="keywordflow">if</span> (time_left &lt;= 0) {
<a name="l05314"></a>05314          res = 1;
<a name="l05315"></a>05315          <span class="keywordflow">continue</span>;
<a name="l05316"></a>05316       }
<a name="l05317"></a>05317 
<a name="l05318"></a>05318       <span class="keywordflow">if</span> (time_left &lt; *timeout)
<a name="l05319"></a>05319          *timeout = time_left;
<a name="l05320"></a>05320    }
<a name="l05321"></a>05321 
<a name="l05322"></a>05322    <span class="keywordflow">return</span> res;
<a name="l05323"></a>05323 }
<a name="l05324"></a>05324 <span class="comment"></span>
<a name="l05325"></a>05325 <span class="comment">/*! \brief Calculate the time until the next known event</span>
<a name="l05326"></a>05326 <span class="comment"> *  \note Called with sla.lock locked */</span>
<a name="l05327"></a><a class="code" href="app__meetme_8c.html#ae76e8f359ad4ae53436dc00dfc1434d9">05327</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ae76e8f359ad4ae53436dc00dfc1434d9" title="Calculate the time until the next known event.">sla_process_timers</a>(<span class="keyword">struct</span> timespec *ts)
<a name="l05328"></a>05328 {
<a name="l05329"></a>05329    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timeout = UINT_MAX;
<a name="l05330"></a>05330    <span class="keyword">struct </span>timeval wait;
<a name="l05331"></a>05331    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> change_made = 0;
<a name="l05332"></a>05332 
<a name="l05333"></a>05333    <span class="comment">/* Check for ring timeouts on ringing trunks */</span>
<a name="l05334"></a>05334    <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#acdab27627974ea2e3fbf169bce26523b" title="Process trunk ring timeouts.">sla_calc_trunk_timeouts</a>(&amp;timeout))
<a name="l05335"></a>05335       change_made = 1;
<a name="l05336"></a>05336 
<a name="l05337"></a>05337    <span class="comment">/* Check for ring timeouts on ringing stations */</span>
<a name="l05338"></a>05338    <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#af94ec9322c762bc23130e081684d09a1" title="Process station ring timeouts.">sla_calc_station_timeouts</a>(&amp;timeout))
<a name="l05339"></a>05339       change_made = 1;
<a name="l05340"></a>05340 
<a name="l05341"></a>05341    <span class="comment">/* Check for station ring delays */</span>
<a name="l05342"></a>05342    <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a211b086be7f6f888072a0d7818827f64" title="Calculate the ring delay for a station.">sla_calc_station_delays</a>(&amp;timeout))
<a name="l05343"></a>05343       change_made = 1;
<a name="l05344"></a>05344 
<a name="l05345"></a>05345    <span class="comment">/* queue reprocessing of ringing trunks */</span>
<a name="l05346"></a>05346    <span class="keywordflow">if</span> (change_made)
<a name="l05347"></a>05347       <a class="code" href="app__meetme_8c.html#a45318e8513f0ffb15b49943c18ea0e58">sla_queue_event_nolock</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>);
<a name="l05348"></a>05348 
<a name="l05349"></a>05349    <span class="comment">/* No timeout */</span>
<a name="l05350"></a>05350    <span class="keywordflow">if</span> (timeout == UINT_MAX)
<a name="l05351"></a>05351       <span class="keywordflow">return</span> 0;
<a name="l05352"></a>05352 
<a name="l05353"></a>05353    <span class="keywordflow">if</span> (ts) {
<a name="l05354"></a>05354       wait = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(timeout, 1000));
<a name="l05355"></a>05355       ts-&gt;tv_sec = wait.tv_sec;
<a name="l05356"></a>05356       ts-&gt;tv_nsec = wait.tv_usec * 1000;
<a name="l05357"></a>05357    }
<a name="l05358"></a>05358 
<a name="l05359"></a>05359    <span class="keywordflow">return</span> 1;
<a name="l05360"></a>05360 }
<a name="l05361"></a>05361 
<a name="l05362"></a>05362 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a03d6f53f0d136a93c89b9d848ca0ed0e">sla_load_config</a>(<span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>);
<a name="l05363"></a>05363 <span class="comment"></span>
<a name="l05364"></a>05364 <span class="comment">/*! \brief Check if we can do a reload of SLA, and do it if we can */</span>
<a name="l05365"></a><a class="code" href="app__meetme_8c.html#af2b946f4368d7887d8b72e15ab04952f">05365</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#af2b946f4368d7887d8b72e15ab04952f" title="Check if we can do a reload of SLA, and do it if we can.">sla_check_reload</a>(<span class="keywordtype">void</span>)
<a name="l05366"></a>05366 {
<a name="l05367"></a>05367    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l05368"></a>05368    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l05369"></a>05369 
<a name="l05370"></a>05370    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05371"></a>05371 
<a name="l05372"></a>05372    <span class="keywordflow">if</span> (!<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.event_q) || !<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks) 
<a name="l05373"></a>05373       || !<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations)) {
<a name="l05374"></a>05374       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05375"></a>05375       <span class="keywordflow">return</span>;
<a name="l05376"></a>05376    }
<a name="l05377"></a>05377 
<a name="l05378"></a>05378    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_stations);
<a name="l05379"></a>05379    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l05380"></a>05380       <span class="keywordflow">if</span> (station-&gt;ref_count)
<a name="l05381"></a>05381          <span class="keywordflow">break</span>;
<a name="l05382"></a>05382    }
<a name="l05383"></a>05383    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l05384"></a>05384    <span class="keywordflow">if</span> (station) {
<a name="l05385"></a>05385       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05386"></a>05386       <span class="keywordflow">return</span>;
<a name="l05387"></a>05387    }
<a name="l05388"></a>05388 
<a name="l05389"></a>05389    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l05390"></a>05390    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_trunks, trunk, entry) {
<a name="l05391"></a>05391       <span class="keywordflow">if</span> (trunk-&gt;ref_count)
<a name="l05392"></a>05392          <span class="keywordflow">break</span>;
<a name="l05393"></a>05393    }
<a name="l05394"></a>05394    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l05395"></a>05395    <span class="keywordflow">if</span> (trunk) {
<a name="l05396"></a>05396       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05397"></a>05397       <span class="keywordflow">return</span>;
<a name="l05398"></a>05398    }
<a name="l05399"></a>05399 
<a name="l05400"></a>05400    <span class="comment">/* yay */</span>
<a name="l05401"></a>05401    <a class="code" href="app__meetme_8c.html#a03d6f53f0d136a93c89b9d848ca0ed0e">sla_load_config</a>(1);
<a name="l05402"></a>05402    <a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.reload = 0;
<a name="l05403"></a>05403 
<a name="l05404"></a>05404    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05405"></a>05405 }
<a name="l05406"></a>05406 
<a name="l05407"></a><a class="code" href="app__meetme_8c.html#a4e56f1037f61fa109b10096e3dd11176">05407</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app__meetme_8c.html#a4e56f1037f61fa109b10096e3dd11176">sla_thread</a>(<span class="keywordtype">void</span> *data)
<a name="l05408"></a>05408 {
<a name="l05409"></a>05409    <span class="keyword">struct </span>sla_failed_station *failed_station;
<a name="l05410"></a>05410    <span class="keyword">struct </span><a class="code" href="structsla__ringing__station.html" title="A station that is ringing.">sla_ringing_station</a> *ringing_station;
<a name="l05411"></a>05411 
<a name="l05412"></a>05412    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05413"></a>05413 
<a name="l05414"></a>05414    <span class="keywordflow">while</span> (!<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.stop) {
<a name="l05415"></a>05415       <span class="keyword">struct </span><a class="code" href="structsla__event.html">sla_event</a> *event;
<a name="l05416"></a>05416       <span class="keyword">struct </span>timespec ts = { 0, };
<a name="l05417"></a>05417       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> have_timeout = 0;
<a name="l05418"></a>05418 
<a name="l05419"></a>05419       <span class="keywordflow">if</span> (<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.event_q)) {
<a name="l05420"></a>05420          <span class="keywordflow">if</span> ((have_timeout = <a class="code" href="app__meetme_8c.html#ae76e8f359ad4ae53436dc00dfc1434d9" title="Calculate the time until the next known event.">sla_process_timers</a>(&amp;ts)))
<a name="l05421"></a>05421             <a class="code" href="lock_8h.html#aa6fec4bba2b7190b94a1a4c7b6c541a4">ast_cond_timedwait</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.cond, &amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock, &amp;ts);
<a name="l05422"></a>05422          <span class="keywordflow">else</span>
<a name="l05423"></a>05423             <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.cond, &amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05424"></a>05424          <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.stop)
<a name="l05425"></a>05425             <span class="keywordflow">break</span>;
<a name="l05426"></a>05426       }
<a name="l05427"></a>05427 
<a name="l05428"></a>05428       <span class="keywordflow">if</span> (have_timeout)
<a name="l05429"></a>05429          <a class="code" href="app__meetme_8c.html#ae76e8f359ad4ae53436dc00dfc1434d9" title="Calculate the time until the next known event.">sla_process_timers</a>(NULL);
<a name="l05430"></a>05430 
<a name="l05431"></a>05431       <span class="keywordflow">while</span> ((event = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.event_q, entry))) {
<a name="l05432"></a>05432          <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05433"></a>05433          <span class="keywordflow">switch</span> (event-&gt;<a class="code" href="structsla__event.html#a0c10632f8ed1ab1d182c2d1f9ae163fc">type</a>) {
<a name="l05434"></a>05434          <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa23fb375274d3c96370d1a64e418f6a40">SLA_EVENT_HOLD</a>:
<a name="l05435"></a>05435             <a class="code" href="app__meetme_8c.html#ac197e9e3bae472fa5ac27237055a3b9d">sla_handle_hold_event</a>(event);
<a name="l05436"></a>05436             <span class="keywordflow">break</span>;
<a name="l05437"></a>05437          <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aacd2fcc269af2c1a25641c5afa9109ea3">SLA_EVENT_DIAL_STATE</a>:
<a name="l05438"></a>05438             <a class="code" href="app__meetme_8c.html#a775a7291ee8f84069224106f4a9cd29f">sla_handle_dial_state_event</a>();
<a name="l05439"></a>05439             <span class="keywordflow">break</span>;
<a name="l05440"></a>05440          <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>:
<a name="l05441"></a>05441             <a class="code" href="app__meetme_8c.html#a69102ed9de8dc84bb7d435dac5fe22cf">sla_handle_ringing_trunk_event</a>();
<a name="l05442"></a>05442             <span class="keywordflow">break</span>;
<a name="l05443"></a>05443          <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aabbba56c7b66dbbdd30b170de8ad228ce">SLA_EVENT_RELOAD</a>:
<a name="l05444"></a>05444             <a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.reload = 1;
<a name="l05445"></a>05445          <span class="keywordflow">case</span> <a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>:
<a name="l05446"></a>05446             <span class="keywordflow">break</span>;
<a name="l05447"></a>05447          }
<a name="l05448"></a>05448          <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(event);
<a name="l05449"></a>05449          <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05450"></a>05450       }
<a name="l05451"></a>05451 
<a name="l05452"></a>05452       <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.reload)
<a name="l05453"></a>05453          <a class="code" href="app__meetme_8c.html#af2b946f4368d7887d8b72e15ab04952f" title="Check if we can do a reload of SLA, and do it if we can.">sla_check_reload</a>();
<a name="l05454"></a>05454    }
<a name="l05455"></a>05455 
<a name="l05456"></a>05456    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05457"></a>05457 
<a name="l05458"></a>05458    <span class="keywordflow">while</span> ((ringing_station = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_stations, entry)))
<a name="l05459"></a>05459       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_station);
<a name="l05460"></a>05460 
<a name="l05461"></a>05461    <span class="keywordflow">while</span> ((failed_station = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.failed_stations, entry)))
<a name="l05462"></a>05462       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(failed_station);
<a name="l05463"></a>05463 
<a name="l05464"></a>05464    <span class="keywordflow">return</span> NULL;
<a name="l05465"></a>05465 }
<a name="l05466"></a>05466 
<a name="l05467"></a><a class="code" href="structdial__trunk__args.html">05467</a> <span class="keyword">struct </span><a class="code" href="structdial__trunk__args.html">dial_trunk_args</a> {
<a name="l05468"></a><a class="code" href="structdial__trunk__args.html#afa55138e79daa65d864f3524cf4843bf">05468</a>    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05469"></a><a class="code" href="structdial__trunk__args.html#a0569f66b3f952276c1a8ec5f2ffd5466">05469</a>    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l05470"></a><a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">05470</a>    <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> *cond_lock;
<a name="l05471"></a><a class="code" href="structdial__trunk__args.html#a45860a157e8d238e312118ddd5771454">05471</a>    <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> *cond;
<a name="l05472"></a>05472 };
<a name="l05473"></a>05473 
<a name="l05474"></a><a class="code" href="app__meetme_8c.html#a93908b1fddcb60b4d15ee6a3cf87dac6">05474</a> <span class="keyword">static</span> <span class="keywordtype">void</span> *<a class="code" href="app__meetme_8c.html#a93908b1fddcb60b4d15ee6a3cf87dac6">dial_trunk</a>(<span class="keywordtype">void</span> *data)
<a name="l05475"></a>05475 {
<a name="l05476"></a>05476    <span class="keyword">struct </span><a class="code" href="structdial__trunk__args.html">dial_trunk_args</a> *args = data;
<a name="l05477"></a>05477    <span class="keyword">struct </span><a class="code" href="structast__dial.html" title="Main dialing structure. Contains global options, channels being dialed, and more!...">ast_dial</a> *dial;
<a name="l05478"></a>05478    <span class="keywordtype">char</span> *tech, *tech_data;
<a name="l05479"></a>05479    <span class="keyword">enum</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847" title="List of return codes for dial run API calls.">ast_dial_result</a> dial_res;
<a name="l05480"></a>05480    <span class="keywordtype">char</span> conf_name[<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>];
<a name="l05481"></a>05481    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l05482"></a>05482    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> conf_flags = { 0 };
<a name="l05483"></a>05483    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref = args-&gt;<a class="code" href="structdial__trunk__args.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a>;
<a name="l05484"></a>05484    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#ade5a89f9bee15a492c760ec1765a292d">cid_name</a> = NULL, *<a class="code" href="chan__mgcp_8c.html#a29e973bd94bfbaf59d939bd1bc988c32">cid_num</a> = NULL;
<a name="l05485"></a>05485 
<a name="l05486"></a>05486    <span class="keywordflow">if</span> (!(dial = <a class="code" href="dial_8h.html#aff55dbc56bc54126828f78a47d1f2282" title="New dialing structure.">ast_dial_create</a>())) {
<a name="l05487"></a>05487       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05488"></a>05488       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#a45860a157e8d238e312118ddd5771454">cond</a>);
<a name="l05489"></a>05489       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05490"></a>05490       <span class="keywordflow">return</span> NULL;
<a name="l05491"></a>05491    }
<a name="l05492"></a>05492 
<a name="l05493"></a>05493    tech_data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(trunk_ref-&gt;trunk-&gt;device);
<a name="l05494"></a>05494    tech = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tech_data, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l05495"></a>05495    <span class="keywordflow">if</span> (<a class="code" href="dial_8h.html#abeec986e8b07f021533d46ad27715ec1" title="Append a channel.">ast_dial_append</a>(dial, tech, tech_data) == -1) {
<a name="l05496"></a>05496       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05497"></a>05497       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#a45860a157e8d238e312118ddd5771454">cond</a>);
<a name="l05498"></a>05498       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05499"></a>05499       <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l05500"></a>05500       <span class="keywordflow">return</span> NULL;
<a name="l05501"></a>05501    }
<a name="l05502"></a>05502 
<a name="l05503"></a>05503    <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.attempt_callerid &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk_ref-&gt;chan-&gt;cid.cid_name)) {
<a name="l05504"></a>05504       cid_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(trunk_ref-&gt;chan-&gt;cid.cid_name);
<a name="l05505"></a>05505       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(trunk_ref-&gt;chan-&gt;cid.cid_name);
<a name="l05506"></a>05506       trunk_ref-&gt;chan-&gt;cid.cid_name = NULL;
<a name="l05507"></a>05507    }
<a name="l05508"></a>05508    <span class="keywordflow">if</span> (!<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.attempt_callerid &amp;&amp; !<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk_ref-&gt;chan-&gt;cid.cid_num)) {
<a name="l05509"></a>05509       cid_num = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(trunk_ref-&gt;chan-&gt;cid.cid_num);
<a name="l05510"></a>05510       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(trunk_ref-&gt;chan-&gt;cid.cid_num);
<a name="l05511"></a>05511       trunk_ref-&gt;chan-&gt;cid.cid_num = NULL;
<a name="l05512"></a>05512    }
<a name="l05513"></a>05513 
<a name="l05514"></a>05514    dial_res = <a class="code" href="dial_8h.html#a65e30d29847af5495afe1baed823957e" title="Execute dialing synchronously or asynchronously.">ast_dial_run</a>(dial, trunk_ref-&gt;chan, 1);
<a name="l05515"></a>05515 
<a name="l05516"></a>05516    <span class="keywordflow">if</span> (cid_name)
<a name="l05517"></a>05517       trunk_ref-&gt;chan-&gt;cid.cid_name = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cid_name);
<a name="l05518"></a>05518    <span class="keywordflow">if</span> (cid_num)
<a name="l05519"></a>05519       trunk_ref-&gt;chan-&gt;cid.cid_num = <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(cid_num);
<a name="l05520"></a>05520 
<a name="l05521"></a>05521    <span class="keywordflow">if</span> (dial_res != <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a5838a3c4774e4d0e9a7d9d3724850ae6">AST_DIAL_RESULT_TRYING</a>) {
<a name="l05522"></a>05522       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05523"></a>05523       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#a45860a157e8d238e312118ddd5771454">cond</a>);
<a name="l05524"></a>05524       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05525"></a>05525       <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l05526"></a>05526       <span class="keywordflow">return</span> NULL;
<a name="l05527"></a>05527    }
<a name="l05528"></a>05528 
<a name="l05529"></a>05529    <span class="keywordflow">for</span> (;;) {
<a name="l05530"></a>05530       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> done = 0;
<a name="l05531"></a>05531       <span class="keywordflow">switch</span> ((dial_res = <a class="code" href="dial_8h.html#a051c20e595f3e3c2be10c84b4247dd37" title="Return state of dial.">ast_dial_state</a>(dial))) {
<a name="l05532"></a>05532       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a4a8c0d54e6071d1e9a36adae685406d3">AST_DIAL_RESULT_ANSWERED</a>:
<a name="l05533"></a>05533          trunk_ref-&gt;trunk-&gt;chan = <a class="code" href="dial_8h.html#a83d13a00643c2ad0149758507df60466" title="Return channel that answered.">ast_dial_answered</a>(dial);
<a name="l05534"></a>05534       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a23fe48f529c8d06fa7dffc976a871a16">AST_DIAL_RESULT_HANGUP</a>:
<a name="l05535"></a>05535       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a33b279a6d9fd2024de7a1f3ccadda2ce">AST_DIAL_RESULT_INVALID</a>:
<a name="l05536"></a>05536       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a077aa090d089e32265755c7ec0f1dac2">AST_DIAL_RESULT_FAILED</a>:
<a name="l05537"></a>05537       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a4bd947d4e1f84bf01d336e228fb431e1">AST_DIAL_RESULT_TIMEOUT</a>:
<a name="l05538"></a>05538       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847ae9986b09a1806d312dd5e508aee3b9ed">AST_DIAL_RESULT_UNANSWERED</a>:
<a name="l05539"></a>05539          done = 1;
<a name="l05540"></a>05540       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a5838a3c4774e4d0e9a7d9d3724850ae6">AST_DIAL_RESULT_TRYING</a>:
<a name="l05541"></a>05541       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847aba600b021de0e20a6e8a6c484f27a9e4">AST_DIAL_RESULT_RINGING</a>:
<a name="l05542"></a>05542       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847a5cc795503d8ce3f6df21f18e7d30e24e">AST_DIAL_RESULT_PROGRESS</a>:
<a name="l05543"></a>05543       <span class="keywordflow">case</span> <a class="code" href="dial_8h.html#a2054b1ddc7845e78286254b366a37847ae16711939ebe81a08ebcbd8d7d0aab3d">AST_DIAL_RESULT_PROCEEDING</a>:
<a name="l05544"></a>05544          <span class="keywordflow">break</span>;
<a name="l05545"></a>05545       }
<a name="l05546"></a>05546       <span class="keywordflow">if</span> (done)
<a name="l05547"></a>05547          <span class="keywordflow">break</span>;
<a name="l05548"></a>05548    }
<a name="l05549"></a>05549 
<a name="l05550"></a>05550    <span class="keywordflow">if</span> (!trunk_ref-&gt;trunk-&gt;chan) {
<a name="l05551"></a>05551       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05552"></a>05552       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#a45860a157e8d238e312118ddd5771454">cond</a>);
<a name="l05553"></a>05553       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05554"></a>05554       <a class="code" href="dial_8h.html#a726346c9cfd11a81839e0eb580b66059" title="Cancel async thread.">ast_dial_join</a>(dial);
<a name="l05555"></a>05555       <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l05556"></a>05556       <span class="keywordflow">return</span> NULL;
<a name="l05557"></a>05557    }
<a name="l05558"></a>05558 
<a name="l05559"></a>05559    snprintf(conf_name, <span class="keyword">sizeof</span>(conf_name), <span class="stringliteral">&quot;SLA_%s&quot;</span>, trunk_ref-&gt;trunk-&gt;name);
<a name="l05560"></a>05560    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;conf_flags, 
<a name="l05561"></a>05561       <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">CONFFLAG_MARKEDUSER</a> | 
<a name="l05562"></a>05562       <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac5154b9d3575197ced6458b31fba2143">CONFFLAG_SLA_TRUNK</a>);
<a name="l05563"></a>05563    conf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(conf_name, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 1, 1, 1, trunk_ref-&gt;trunk-&gt;chan);
<a name="l05564"></a>05564 
<a name="l05565"></a>05565    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05566"></a>05566    <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#a45860a157e8d238e312118ddd5771454">cond</a>);
<a name="l05567"></a>05567    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(args-&gt;<a class="code" href="structdial__trunk__args.html#ad60cf18fa0b7812ab65423aa79f93165">cond_lock</a>);
<a name="l05568"></a>05568 
<a name="l05569"></a>05569    <span class="keywordflow">if</span> (conf) {
<a name="l05570"></a>05570       <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(trunk_ref-&gt;trunk-&gt;chan, conf, conf_flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, NULL);
<a name="l05571"></a>05571       <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(conf);
<a name="l05572"></a>05572       conf = NULL;
<a name="l05573"></a>05573    }
<a name="l05574"></a>05574 
<a name="l05575"></a>05575    <span class="comment">/* If the trunk is going away, it is definitely now IDLE. */</span>
<a name="l05576"></a>05576    <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05577"></a>05577 
<a name="l05578"></a>05578    trunk_ref-&gt;trunk-&gt;chan = NULL;
<a name="l05579"></a>05579    trunk_ref-&gt;trunk-&gt;on_hold = 0;
<a name="l05580"></a>05580 
<a name="l05581"></a>05581    <a class="code" href="dial_8h.html#a726346c9cfd11a81839e0eb580b66059" title="Cancel async thread.">ast_dial_join</a>(dial);
<a name="l05582"></a>05582    <a class="code" href="dial_8h.html#ab75c6f2fe91945cf61e7e91939618db2" title="Destroys a dialing structure.">ast_dial_destroy</a>(dial);
<a name="l05583"></a>05583 
<a name="l05584"></a>05584    <span class="keywordflow">return</span> NULL;
<a name="l05585"></a>05585 }
<a name="l05586"></a>05586 <span class="comment"></span>
<a name="l05587"></a>05587 <span class="comment">/*! \brief For a given station, choose the highest priority idle trunk</span>
<a name="l05588"></a>05588 <span class="comment"> */</span>
<a name="l05589"></a><a class="code" href="app__meetme_8c.html#a631bcace98e3013377a69b15c1bd8107">05589</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *<a class="code" href="app__meetme_8c.html#a631bcace98e3013377a69b15c1bd8107" title="For a given station, choose the highest priority idle trunk.">sla_choose_idle_trunk</a>(<span class="keyword">const</span> <span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l05590"></a>05590 {
<a name="l05591"></a>05591    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref = NULL;
<a name="l05592"></a>05592 
<a name="l05593"></a>05593    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l05594"></a>05594       <span class="keywordflow">if</span> (trunk_ref-&gt;state == <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>)
<a name="l05595"></a>05595          <span class="keywordflow">break</span>;
<a name="l05596"></a>05596    }
<a name="l05597"></a>05597 
<a name="l05598"></a>05598    <span class="keywordflow">return</span> trunk_ref;
<a name="l05599"></a>05599 }
<a name="l05600"></a>05600 
<a name="l05601"></a><a class="code" href="app__meetme_8c.html#a612f673b37381608ef31d1305baf6243">05601</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a612f673b37381608ef31d1305baf6243">sla_station_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l05602"></a>05602 {
<a name="l05603"></a>05603    <span class="keywordtype">char</span> *station_name, *trunk_name;
<a name="l05604"></a>05604    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l05605"></a>05605    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref = NULL;
<a name="l05606"></a>05606    <span class="keywordtype">char</span> conf_name[<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>];
<a name="l05607"></a>05607    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> conf_flags = { 0 };
<a name="l05608"></a>05608    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l05609"></a>05609 
<a name="l05610"></a>05610    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05611"></a>05611       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid Arguments to SLAStation!\n&quot;</span>);
<a name="l05612"></a>05612       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLASTATION_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05613"></a>05613       <span class="keywordflow">return</span> 0;
<a name="l05614"></a>05614    }
<a name="l05615"></a>05615 
<a name="l05616"></a>05616    trunk_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l05617"></a>05617    station_name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;trunk_name, <span class="stringliteral">&quot;_&quot;</span>);
<a name="l05618"></a>05618 
<a name="l05619"></a>05619    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(station_name)) {
<a name="l05620"></a>05620       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid Arguments to SLAStation!\n&quot;</span>);
<a name="l05621"></a>05621       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLASTATION_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05622"></a>05622       <span class="keywordflow">return</span> 0;
<a name="l05623"></a>05623    }
<a name="l05624"></a>05624 
<a name="l05625"></a>05625    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_stations);
<a name="l05626"></a>05626    station = <a class="code" href="app__meetme_8c.html#a3c7dabe74df23208e4dce8bc3fbb6d77" title="Find an SLA station by name.">sla_find_station</a>(station_name);
<a name="l05627"></a>05627    <span class="keywordflow">if</span> (station)
<a name="l05628"></a>05628       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;station-&gt;ref_count, 1);
<a name="l05629"></a>05629    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l05630"></a>05630 
<a name="l05631"></a>05631    <span class="keywordflow">if</span> (!station) {
<a name="l05632"></a>05632       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Station &apos;%s&apos; not found!\n&quot;</span>, station_name);
<a name="l05633"></a>05633       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLASTATION_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05634"></a>05634       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);
<a name="l05635"></a>05635       <span class="keywordflow">return</span> 0;
<a name="l05636"></a>05636    }
<a name="l05637"></a>05637 
<a name="l05638"></a>05638    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l05639"></a>05639    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk_name)) {
<a name="l05640"></a>05640       trunk_ref = <a class="code" href="app__meetme_8c.html#aea0981ea332b08880d6404c65fe64135" title="Find a trunk reference on a station by name.">sla_find_trunk_ref_byname</a>(station, trunk_name);
<a name="l05641"></a>05641    } <span class="keywordflow">else</span>
<a name="l05642"></a>05642       trunk_ref = <a class="code" href="app__meetme_8c.html#a631bcace98e3013377a69b15c1bd8107" title="For a given station, choose the highest priority idle trunk.">sla_choose_idle_trunk</a>(station);
<a name="l05643"></a>05643    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l05644"></a>05644 
<a name="l05645"></a>05645    <span class="keywordflow">if</span> (!trunk_ref) {
<a name="l05646"></a>05646       <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk_name))
<a name="l05647"></a>05647          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;No trunks available for call.\n&quot;</span>);
<a name="l05648"></a>05648       <span class="keywordflow">else</span> {
<a name="l05649"></a>05649          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Can&apos;t join existing call on trunk &quot;</span>
<a name="l05650"></a>05650             <span class="stringliteral">&quot;&apos;%s&apos; due to access controls.\n&quot;</span>, trunk_name);
<a name="l05651"></a>05651       }
<a name="l05652"></a>05652       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLASTATION_STATUS&quot;</span>, <span class="stringliteral">&quot;CONGESTION&quot;</span>);
<a name="l05653"></a>05653       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;station-&gt;ref_count, -1);
<a name="l05654"></a>05654       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);
<a name="l05655"></a>05655       <span class="keywordflow">return</span> 0;
<a name="l05656"></a>05656    }
<a name="l05657"></a>05657 
<a name="l05658"></a>05658    <span class="keywordflow">if</span> (trunk_ref-&gt;state == <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>) {
<a name="l05659"></a>05659       <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ac0907a45f05d85848a4f7d5990a4d244" title="decrement *p by 1 and return true if the variable has reached 0. Useful e.g. to check...">ast_atomic_dec_and_test</a>((<span class="keywordtype">int</span> *) &amp;trunk_ref-&gt;trunk-&gt;hold_stations) == 1)
<a name="l05660"></a>05660          <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05661"></a>05661       <span class="keywordflow">else</span> {
<a name="l05662"></a>05662          trunk_ref-&gt;state = <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>;
<a name="l05663"></a>05663          <a class="code" href="devicestate_8h.html#ac91fd8b93a2095c18ab86bd61c19ae46" title="Tells Asterisk the State for Device is changed.">ast_devstate_changed</a>(<a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea23aa227468c09b5ebd0fb01b4c895190">AST_DEVICE_INUSE</a>, 
<a name="l05664"></a>05664             <span class="stringliteral">&quot;SLA:%s_%s&quot;</span>, station-&gt;name, trunk_ref-&gt;trunk-&gt;name);
<a name="l05665"></a>05665       }
<a name="l05666"></a>05666    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (trunk_ref-&gt;state == <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a4822569aa984228bec67e07f5b9862a5">SLA_TRUNK_STATE_RINGING</a>) {
<a name="l05667"></a>05667       <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05668"></a>05668 
<a name="l05669"></a>05669       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05670"></a>05670       <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l05671"></a>05671          <span class="keywordflow">if</span> (ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a> == trunk_ref-&gt;trunk) {
<a name="l05672"></a>05672             <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l05673"></a>05673             <span class="keywordflow">break</span>;
<a name="l05674"></a>05674          }
<a name="l05675"></a>05675       }
<a name="l05676"></a>05676       <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>
<a name="l05677"></a>05677       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05678"></a>05678 
<a name="l05679"></a>05679       <span class="keywordflow">if</span> (ringing_trunk) {
<a name="l05680"></a>05680          <a class="code" href="app__meetme_8c.html#a7392cc7f56677c79368716971d1ec023">answer_trunk_chan</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>-&gt;chan);
<a name="l05681"></a>05681          <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a>, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05682"></a>05682 
<a name="l05683"></a>05683          <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(ringing_trunk);
<a name="l05684"></a>05684 
<a name="l05685"></a>05685          <span class="comment">/* Queue up reprocessing ringing trunks, and then ringing stations again */</span>
<a name="l05686"></a>05686          <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>);
<a name="l05687"></a>05687          <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aacd2fcc269af2c1a25641c5afa9109ea3">SLA_EVENT_DIAL_STATE</a>);
<a name="l05688"></a>05688       }
<a name="l05689"></a>05689    }
<a name="l05690"></a>05690 
<a name="l05691"></a>05691    trunk_ref-&gt;chan = chan;
<a name="l05692"></a>05692 
<a name="l05693"></a>05693    <span class="keywordflow">if</span> (!trunk_ref-&gt;trunk-&gt;chan) {
<a name="l05694"></a>05694       <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> cond_lock;
<a name="l05695"></a>05695       <a class="code" href="lock_8h.html#ab134d98cdfe7de0f7a72b377c0765dc7">ast_cond_t</a> cond;
<a name="l05696"></a>05696       pthread_t dont_care;
<a name="l05697"></a>05697       <span class="keyword">struct </span><a class="code" href="structdial__trunk__args.html">dial_trunk_args</a> args = {
<a name="l05698"></a>05698          .<a class="code" href="structdial__trunk__args.html#afa55138e79daa65d864f3524cf4843bf">trunk_ref</a> = trunk_ref,
<a name="l05699"></a>05699          .station = station,
<a name="l05700"></a>05700          .cond_lock = &amp;cond_lock,
<a name="l05701"></a>05701          .cond = &amp;cond,
<a name="l05702"></a>05702       };
<a name="l05703"></a>05703       <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05704"></a>05704       <span class="comment">/* Create a thread to dial the trunk and dump it into the conference.</span>
<a name="l05705"></a>05705 <span class="comment">       * However, we want to wait until the trunk has been dialed and the</span>
<a name="l05706"></a>05706 <span class="comment">       * conference is created before continuing on here. */</span>
<a name="l05707"></a>05707       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l05708"></a>05708       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;cond_lock);
<a name="l05709"></a>05709       <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;cond, NULL);
<a name="l05710"></a>05710       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;cond_lock);
<a name="l05711"></a>05711       <a class="code" href="utils_8h.html#aa73be876e3a4024b91ce2e09d8b945d1">ast_pthread_create_detached_background</a>(&amp;dont_care, NULL, <a class="code" href="app__meetme_8c.html#a93908b1fddcb60b4d15ee6a3cf87dac6">dial_trunk</a>, &amp;args);
<a name="l05712"></a>05712       <a class="code" href="lock_8h.html#ae454b1ebfb5f5e9948876d470865d9dc">ast_cond_wait</a>(&amp;cond, &amp;cond_lock);
<a name="l05713"></a>05713       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;cond_lock);
<a name="l05714"></a>05714       <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;cond_lock);
<a name="l05715"></a>05715       <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;cond);
<a name="l05716"></a>05716       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l05717"></a>05717       <span class="keywordflow">if</span> (!trunk_ref-&gt;trunk-&gt;chan) {
<a name="l05718"></a>05718          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Trunk didn&apos;t get created. chan: %lx\n&quot;</span>, (<span class="keywordtype">long</span>) trunk_ref-&gt;trunk-&gt;chan);
<a name="l05719"></a>05719          <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLASTATION_STATUS&quot;</span>, <span class="stringliteral">&quot;CONGESTION&quot;</span>);
<a name="l05720"></a>05720          <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05721"></a>05721          trunk_ref-&gt;chan = NULL;
<a name="l05722"></a>05722          <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;station-&gt;ref_count, -1);
<a name="l05723"></a>05723          <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);
<a name="l05724"></a>05724          <span class="keywordflow">return</span> 0;
<a name="l05725"></a>05725       }
<a name="l05726"></a>05726    }
<a name="l05727"></a>05727 
<a name="l05728"></a>05728    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk_ref-&gt;trunk-&gt;active_stations, 1) == 0 &amp;&amp;
<a name="l05729"></a>05729       trunk_ref-&gt;trunk-&gt;on_hold) {
<a name="l05730"></a>05730       trunk_ref-&gt;trunk-&gt;on_hold = 0;
<a name="l05731"></a>05731       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(trunk_ref-&gt;trunk-&gt;chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>);
<a name="l05732"></a>05732       <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a749b58c2aae2b86a1aa84e74d8c3045f">SLA_TRUNK_STATE_UP</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05733"></a>05733    }
<a name="l05734"></a>05734 
<a name="l05735"></a>05735    snprintf(conf_name, <span class="keyword">sizeof</span>(conf_name), <span class="stringliteral">&quot;SLA_%s&quot;</span>, trunk_ref-&gt;trunk-&gt;name);
<a name="l05736"></a>05736    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;conf_flags, 
<a name="l05737"></a>05737       <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac793d6a4a78ffd301d51be06a771b70c">CONFFLAG_SLA_STATION</a>);
<a name="l05738"></a>05738    <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l05739"></a>05739    conf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(conf_name, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, 0, 1, chan);
<a name="l05740"></a>05740    <span class="keywordflow">if</span> (conf) {
<a name="l05741"></a>05741       <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(chan, conf, conf_flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, NULL);
<a name="l05742"></a>05742       <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(conf);
<a name="l05743"></a>05743       conf = NULL;
<a name="l05744"></a>05744    }
<a name="l05745"></a>05745    trunk_ref-&gt;chan = NULL;
<a name="l05746"></a>05746    <span class="keywordflow">if</span> (<a class="code" href="lock_8h.html#ac0907a45f05d85848a4f7d5990a4d244" title="decrement *p by 1 and return true if the variable has reached 0. Useful e.g. to check...">ast_atomic_dec_and_test</a>((<span class="keywordtype">int</span> *) &amp;trunk_ref-&gt;trunk-&gt;active_stations) &amp;&amp;
<a name="l05747"></a>05747       trunk_ref-&gt;state != <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a7de42ff989ac21f01dc409f42c3c2530">SLA_TRUNK_STATE_ONHOLD_BYME</a>) {
<a name="l05748"></a>05748       strncat(conf_name, <span class="stringliteral">&quot;,K&quot;</span>, <span class="keyword">sizeof</span>(conf_name) - strlen(conf_name) - 1);
<a name="l05749"></a>05749       <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>(NULL, conf_name);
<a name="l05750"></a>05750       trunk_ref-&gt;trunk-&gt;hold_stations = 0;
<a name="l05751"></a>05751       <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk_ref-&gt;trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05752"></a>05752    }
<a name="l05753"></a>05753    
<a name="l05754"></a>05754    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLASTATION_STATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l05755"></a>05755 
<a name="l05756"></a>05756    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;station-&gt;ref_count, -1);
<a name="l05757"></a>05757    <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);
<a name="l05758"></a>05758 
<a name="l05759"></a>05759    <span class="keywordflow">return</span> 0;
<a name="l05760"></a>05760 }
<a name="l05761"></a>05761 
<a name="l05762"></a><a class="code" href="app__meetme_8c.html#a89b13052de37686017f177352a20a8d0">05762</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *<a class="code" href="app__meetme_8c.html#a89b13052de37686017f177352a20a8d0">create_trunk_ref</a>(<span class="keyword">struct</span> <a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk)
<a name="l05763"></a>05763 {
<a name="l05764"></a>05764    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05765"></a>05765 
<a name="l05766"></a>05766    <span class="keywordflow">if</span> (!(trunk_ref = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*trunk_ref))))
<a name="l05767"></a>05767       <span class="keywordflow">return</span> NULL;
<a name="l05768"></a>05768 
<a name="l05769"></a>05769    trunk_ref-&gt;trunk = trunk;
<a name="l05770"></a>05770 
<a name="l05771"></a>05771    <span class="keywordflow">return</span> trunk_ref;
<a name="l05772"></a>05772 }
<a name="l05773"></a>05773 
<a name="l05774"></a><a class="code" href="app__meetme_8c.html#a501c3df2a5fe48200560b09c9fdcef73">05774</a> <span class="keyword">static</span> <span class="keyword">struct </span>sla_ringing_trunk *<a class="code" href="app__meetme_8c.html#a501c3df2a5fe48200560b09c9fdcef73">queue_ringing_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk)
<a name="l05775"></a>05775 {
<a name="l05776"></a>05776    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05777"></a>05777 
<a name="l05778"></a>05778    <span class="keywordflow">if</span> (!(ringing_trunk = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*ringing_trunk))))
<a name="l05779"></a>05779       <span class="keywordflow">return</span> NULL;
<a name="l05780"></a>05780    
<a name="l05781"></a>05781    ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a> = trunk;
<a name="l05782"></a>05782    ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#a5fad56bdd993af8ceb77ab8a83134f0f">ring_begin</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l05783"></a>05783 
<a name="l05784"></a>05784    <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75a4822569aa984228bec67e07f5b9862a5">SLA_TRUNK_STATE_RINGING</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05785"></a>05785 
<a name="l05786"></a>05786    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05787"></a>05787    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry);
<a name="l05788"></a>05788    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05789"></a>05789 
<a name="l05790"></a>05790    <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>);
<a name="l05791"></a>05791 
<a name="l05792"></a>05792    <span class="keywordflow">return</span> ringing_trunk;
<a name="l05793"></a>05793 }
<a name="l05794"></a>05794 
<a name="l05795"></a>05795 <span class="keyword">enum</span> {
<a name="l05796"></a><a class="code" href="app__meetme_8c.html#aaf8fd5f0e57d456151c951e0f3715fc4a7c230d0734a626ce84da297e21241b7d">05796</a>    <a class="code" href="app__meetme_8c.html#aaf8fd5f0e57d456151c951e0f3715fc4a7c230d0734a626ce84da297e21241b7d">SLA_TRUNK_OPT_MOH</a> = (1 &lt;&lt; 0),
<a name="l05797"></a>05797 };
<a name="l05798"></a>05798 
<a name="l05799"></a>05799 <span class="keyword">enum</span> {
<a name="l05800"></a><a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310a01a9ae9e3c42b9f83ba7849e41bc9019">05800</a>    <a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310a01a9ae9e3c42b9f83ba7849e41bc9019">SLA_TRUNK_OPT_ARG_MOH_CLASS</a> = 0,
<a name="l05801"></a><a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310ac88d4b53d16b3e05539a0b7e13a215ca">05801</a>    <a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310ac88d4b53d16b3e05539a0b7e13a215ca">SLA_TRUNK_OPT_ARG_ARRAY_SIZE</a> = 1,
<a name="l05802"></a>05802 };
<a name="l05803"></a>05803 
<a name="l05804"></a>05804 <a class="code" href="app_8h.html#a520a3c6b7d57903d9a616051da1a019d" title="Declares an array of options for an application.">AST_APP_OPTIONS</a>(sla_trunk_opts, <a class="code" href="app_8h.html#ab451a4653176c211d131b899e1f91bde">BEGIN_OPTIONS</a>
<a name="l05805"></a>05805    <a class="code" href="app_8h.html#a7549377df87038be737e8cae73acaa9d" title="Declares an application option that accepts an argument.">AST_APP_OPTION_ARG</a>(<span class="charliteral">&apos;M&apos;</span>, <a class="code" href="app__meetme_8c.html#aaf8fd5f0e57d456151c951e0f3715fc4a7c230d0734a626ce84da297e21241b7d">SLA_TRUNK_OPT_MOH</a>, <a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310a01a9ae9e3c42b9f83ba7849e41bc9019">SLA_TRUNK_OPT_ARG_MOH_CLASS</a>),
<a name="l05806"></a>05806 <a class="code" href="app_8h.html#a2a1890787b3e55318c417c0a3e1432c7">END_OPTIONS</a> );
<a name="l05807"></a>05807 
<a name="l05808"></a><a class="code" href="app__meetme_8c.html#a3fd96711c40675a2da40b5c625f6a1ab">05808</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a3fd96711c40675a2da40b5c625f6a1ab">sla_trunk_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l05809"></a>05809 {
<a name="l05810"></a>05810    <span class="keywordtype">char</span> conf_name[<a class="code" href="app__meetme_8c.html#aa062a857f2cbc03c82512074e6c68afd">MAX_CONFNUM</a>];
<a name="l05811"></a>05811    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l05812"></a>05812    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> conf_flags = { 0 };
<a name="l05813"></a>05813    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l05814"></a>05814    <span class="keyword">struct </span>sla_ringing_trunk *ringing_trunk;
<a name="l05815"></a>05815    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l05816"></a>05816       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(trunk_name);
<a name="l05817"></a>05817       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l05818"></a>05818    );
<a name="l05819"></a>05819    <span class="keywordtype">char</span> *opts[<a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310ac88d4b53d16b3e05539a0b7e13a215ca">SLA_TRUNK_OPT_ARG_ARRAY_SIZE</a>] = { NULL, };
<a name="l05820"></a>05820    <span class="keywordtype">char</span> *conf_opt_args[<a class="code" href="app__chanspy_8c.html#a99fb83031ce9923c84392b4e92f956b5aec7326f60e7edad15d96ff935e5616d6">OPT_ARG_ARRAY_SIZE</a>] = { NULL, };
<a name="l05821"></a>05821    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> opt_flags = { 0 };
<a name="l05822"></a>05822    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l05823"></a>05823 
<a name="l05824"></a>05824    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l05825"></a>05825       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;The SLATrunk application requires an argument, the trunk name\n&quot;</span>);
<a name="l05826"></a>05826       <span class="keywordflow">return</span> -1;
<a name="l05827"></a>05827    }
<a name="l05828"></a>05828 
<a name="l05829"></a>05829    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l05830"></a>05830    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l05831"></a>05831    <span class="keywordflow">if</span> (args.argc == 2) {
<a name="l05832"></a>05832       <span class="keywordflow">if</span> (<a class="code" href="app_8h.html#af40039f1c49c16d0f6fa33fe9c43a0cb" title="Parses a string containing application options and sets flags/arguments.">ast_app_parse_options</a>(sla_trunk_opts, &amp;opt_flags, opts, args.options)) {
<a name="l05833"></a>05833          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error parsing options for SLATrunk\n&quot;</span>);
<a name="l05834"></a>05834          <span class="keywordflow">return</span> -1;
<a name="l05835"></a>05835       }
<a name="l05836"></a>05836    }
<a name="l05837"></a>05837 
<a name="l05838"></a>05838    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l05839"></a>05839    trunk = <a class="code" href="app__meetme_8c.html#af590722094b4b8eee8319a0ae644a8c1" title="Find an SLA trunk by name.">sla_find_trunk</a>(args.trunk_name);
<a name="l05840"></a>05840    <span class="keywordflow">if</span> (trunk)
<a name="l05841"></a>05841       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;ref_count, 1);
<a name="l05842"></a>05842    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l05843"></a>05843 
<a name="l05844"></a>05844    <span class="keywordflow">if</span> (!trunk) {
<a name="l05845"></a>05845       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SLA Trunk &apos;%s&apos; not found!\n&quot;</span>, args.trunk_name);
<a name="l05846"></a>05846       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05847"></a>05847       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;ref_count, -1);
<a name="l05848"></a>05848       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);  
<a name="l05849"></a>05849       <span class="keywordflow">return</span> 0;
<a name="l05850"></a>05850    }
<a name="l05851"></a>05851 
<a name="l05852"></a>05852    <span class="keywordflow">if</span> (trunk-&gt;chan) {
<a name="l05853"></a>05853       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Call came in on %s, but the trunk is already in use!\n&quot;</span>,
<a name="l05854"></a>05854          args.trunk_name);
<a name="l05855"></a>05855       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05856"></a>05856       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;ref_count, -1);
<a name="l05857"></a>05857       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);  
<a name="l05858"></a>05858       <span class="keywordflow">return</span> 0;
<a name="l05859"></a>05859    }
<a name="l05860"></a>05860 
<a name="l05861"></a>05861    trunk-&gt;chan = chan;
<a name="l05862"></a>05862 
<a name="l05863"></a>05863    <span class="keywordflow">if</span> (!(ringing_trunk = <a class="code" href="app__meetme_8c.html#a501c3df2a5fe48200560b09c9fdcef73">queue_ringing_trunk</a>(trunk))) {
<a name="l05864"></a>05864       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05865"></a>05865       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;ref_count, -1);
<a name="l05866"></a>05866       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);  
<a name="l05867"></a>05867       <span class="keywordflow">return</span> 0;
<a name="l05868"></a>05868    }
<a name="l05869"></a>05869 
<a name="l05870"></a>05870    snprintf(conf_name, <span class="keyword">sizeof</span>(conf_name), <span class="stringliteral">&quot;SLA_%s&quot;</span>, args.trunk_name);
<a name="l05871"></a>05871    conf = <a class="code" href="app__meetme_8c.html#af4de70f79e54e98cafced8cc6f79d4c0" title="Find or create a conference.">build_conf</a>(conf_name, <span class="stringliteral">&quot;&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 1, 1, 1, chan);
<a name="l05872"></a>05872    <span class="keywordflow">if</span> (!conf) {
<a name="l05873"></a>05873       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;FAILURE&quot;</span>);
<a name="l05874"></a>05874       <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;ref_count, -1);
<a name="l05875"></a>05875       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);  
<a name="l05876"></a>05876       <span class="keywordflow">return</span> 0;
<a name="l05877"></a>05877    }
<a name="l05878"></a>05878    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;conf_flags, 
<a name="l05879"></a>05879       <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a325a89f891e02c6443c550bbe243e764">CONFFLAG_QUIET</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a458c884631705776b67d47722a321038">CONFFLAG_MARKEDEXIT</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a453f4a2b34ad132124a1a643e5ac11d3">CONFFLAG_MARKEDUSER</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a78d4dd89cf67254395c36b435c7180c6">CONFFLAG_PASS_DTMF</a> | <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409ac13efb0951d66c6cee3936d4a48d2107">CONFFLAG_NO_AUDIO_UNTIL_UP</a>);
<a name="l05880"></a>05880 
<a name="l05881"></a>05881    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(&amp;opt_flags, <a class="code" href="app__meetme_8c.html#aaf8fd5f0e57d456151c951e0f3715fc4a7c230d0734a626ce84da297e21241b7d">SLA_TRUNK_OPT_MOH</a>)) {
<a name="l05882"></a>05882       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, -1);
<a name="l05883"></a>05883       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;conf_flags, <a class="code" href="app__meetme_8c.html#adb49720dc49f7d4e4cf9adbf2948e409a9fc9420ac235de446f7a35a766a7bd4b">CONFFLAG_MOH</a>);
<a name="l05884"></a>05884       conf_opt_args[<a class="code" href="app__meetme_8c.html#aae05225933a42f81e7c4a9fb286596f9a17eae9ed5d8e8bb1e6246571c0cd4c75">OPT_ARG_MOH_CLASS</a>] = opts[<a class="code" href="app__meetme_8c.html#a94798fdadfbf49a7c658ace669a1d310a01a9ae9e3c42b9f83ba7849e41bc9019">SLA_TRUNK_OPT_ARG_MOH_CLASS</a>];
<a name="l05885"></a>05885    } <span class="keywordflow">else</span>
<a name="l05886"></a>05886       <a class="code" href="channel_8h.html#aef2af15a597c948e97628da6c5c84f28" title="Indicates condition of channel.">ast_indicate</a>(chan, <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390aa5814e690c23b590bcd4eb43535907a1">AST_CONTROL_RINGING</a>);
<a name="l05887"></a>05887 
<a name="l05888"></a>05888    <a class="code" href="app__meetme_8c.html#ab3db666ab9391d743144b4f2c16a4cb0">conf_run</a>(chan, conf, conf_flags.<a class="code" href="structast__flags.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, opts);
<a name="l05889"></a>05889    <a class="code" href="app__meetme_8c.html#a1cd8b7d01b41ec3bbe98d2c80e388034">dispose_conf</a>(conf);
<a name="l05890"></a>05890    conf = NULL;
<a name="l05891"></a>05891    trunk-&gt;chan = NULL;
<a name="l05892"></a>05892    trunk-&gt;on_hold = 0;
<a name="l05893"></a>05893 
<a name="l05894"></a>05894    <a class="code" href="app__meetme_8c.html#a63ec60efb249ffe48ae1f38956ad7b16">sla_change_trunk_state</a>(trunk, <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>, <a class="code" href="app__meetme_8c.html#a1e79b23a6db109a316e426ce5ccf6215ae98fbe8b2f7a1f822aaf86847d1f17d9">ALL_TRUNK_REFS</a>, NULL);
<a name="l05895"></a>05895 
<a name="l05896"></a>05896    <span class="keywordflow">if</span> (!<a class="code" href="pbx_8h.html#a98c5425b90ec7c5e136a40f529170b1b" title="Return a pointer to the value of the corresponding channel variable.">pbx_builtin_getvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>))
<a name="l05897"></a>05897       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l05898"></a>05898 
<a name="l05899"></a>05899    <span class="comment">/* Remove the entry from the list of ringing trunks if it is still there. */</span>
<a name="l05900"></a>05900    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05901"></a>05901    <a class="code" href="linkedlists_8h.html#aa5be52067bf16bdc7e56ca19b5ba858d" title="Loops safely over (traverses) the entries in a list.">AST_LIST_TRAVERSE_SAFE_BEGIN</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.ringing_trunks, ringing_trunk, entry) {
<a name="l05902"></a>05902       <span class="keywordflow">if</span> (ringing_trunk-&gt;<a class="code" href="structsla__ringing__trunk.html#afd7941b09a11427a48ced58c93402e35">trunk</a> == trunk) {
<a name="l05903"></a>05903          <a class="code" href="linkedlists_8h.html#aa8ac496fa9c717d5afb99a02e1e2760c" title="Removes the current entry from a list during a traversal.">AST_LIST_REMOVE_CURRENT</a>(entry);
<a name="l05904"></a>05904          <span class="keywordflow">break</span>;
<a name="l05905"></a>05905       }
<a name="l05906"></a>05906    }
<a name="l05907"></a>05907    <a class="code" href="linkedlists_8h.html#a712c04b4493919a7052399cd30ee8fb9" title="Closes a safe loop traversal block.">AST_LIST_TRAVERSE_SAFE_END</a>;
<a name="l05908"></a>05908    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l05909"></a>05909    <span class="keywordflow">if</span> (ringing_trunk) {
<a name="l05910"></a>05910       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(ringing_trunk);
<a name="l05911"></a>05911       <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;SLATRUNK_STATUS&quot;</span>, <span class="stringliteral">&quot;UNANSWERED&quot;</span>);
<a name="l05912"></a>05912       <span class="comment">/* Queue reprocessing of ringing trunks to make stations stop ringing</span>
<a name="l05913"></a>05913 <span class="comment">       * that shouldn&apos;t be ringing after this trunk stopped. */</span>
<a name="l05914"></a>05914       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aa204ca078e2f10cd4c3674b86415d87b7">SLA_EVENT_RINGING_TRUNK</a>);
<a name="l05915"></a>05915    }
<a name="l05916"></a>05916 
<a name="l05917"></a>05917    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;ref_count, -1);
<a name="l05918"></a>05918    <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aae9b2ef8adfafb0bac1db8f5771424eb4">SLA_EVENT_CHECK_RELOAD</a>);  
<a name="l05919"></a>05919 
<a name="l05920"></a>05920    <span class="keywordflow">return</span> 0;
<a name="l05921"></a>05921 }
<a name="l05922"></a>05922 
<a name="l05923"></a><a class="code" href="app__meetme_8c.html#ab2f6aeedfe3c63d7c493a1c849893d10">05923</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> <a class="code" href="app__meetme_8c.html#ab2f6aeedfe3c63d7c493a1c849893d10">sla_state</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *data)
<a name="l05924"></a>05924 {
<a name="l05925"></a>05925    <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, *station_name, *trunk_name;
<a name="l05926"></a>05926    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l05927"></a>05927    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05928"></a>05928    <span class="keyword">enum</span> <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eee" title="Device States.">ast_device_state</a> res = <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>;
<a name="l05929"></a>05929 
<a name="l05930"></a>05930    trunk_name = buf = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l05931"></a>05931    station_name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;trunk_name, <span class="stringliteral">&quot;_&quot;</span>);
<a name="l05932"></a>05932 
<a name="l05933"></a>05933    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_stations);
<a name="l05934"></a>05934    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;sla_stations, station, entry) {
<a name="l05935"></a>05935       <span class="keywordflow">if</span> (strcasecmp(station_name, station-&gt;name))
<a name="l05936"></a>05936          <span class="keywordflow">continue</span>;
<a name="l05937"></a>05937       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l05938"></a>05938       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l05939"></a>05939          <span class="keywordflow">if</span> (!strcasecmp(trunk_name, trunk_ref-&gt;trunk-&gt;name))
<a name="l05940"></a>05940             <span class="keywordflow">break</span>;
<a name="l05941"></a>05941       }
<a name="l05942"></a>05942       <span class="keywordflow">if</span> (!trunk_ref) {
<a name="l05943"></a>05943          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l05944"></a>05944          <span class="keywordflow">break</span>;
<a name="l05945"></a>05945       }
<a name="l05946"></a>05946       res = <a class="code" href="app__meetme_8c.html#ab69997f20dabd9a6a6f42f00dd2290f4">sla_state_to_devstate</a>(trunk_ref-&gt;state);
<a name="l05947"></a>05947       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l05948"></a>05948    }
<a name="l05949"></a>05949    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l05950"></a>05950 
<a name="l05951"></a>05951    <span class="keywordflow">if</span> (res == <a class="code" href="devicestate_8h.html#af72f8a5c0601e4c1f8a852749cd44eeea9c008e1d20858cbc3275c157e02ebc94">AST_DEVICE_INVALID</a>) {
<a name="l05952"></a>05952       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not determine state for trunk %s on station %s!\n&quot;</span>,
<a name="l05953"></a>05953          trunk_name, station_name);
<a name="l05954"></a>05954    }
<a name="l05955"></a>05955 
<a name="l05956"></a>05956    <span class="keywordflow">return</span> res;
<a name="l05957"></a>05957 }
<a name="l05958"></a>05958 
<a name="l05959"></a><a class="code" href="app__meetme_8c.html#ab603b1b5243b7a01e6af849e2ab6d327">05959</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#ab603b1b5243b7a01e6af849e2ab6d327">destroy_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk)
<a name="l05960"></a>05960 {
<a name="l05961"></a>05961    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l05962"></a>05962 
<a name="l05963"></a>05963    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk-&gt;autocontext))
<a name="l05964"></a>05964       <a class="code" href="pbx_8h.html#a721c6ba091102f155a586e09b2a526bf" title="Simply remove extension from context.">ast_context_remove_extension</a>(trunk-&gt;autocontext, <span class="stringliteral">&quot;s&quot;</span>, 1, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>);
<a name="l05965"></a>05965 
<a name="l05966"></a>05966    <span class="keywordflow">while</span> ((station_ref = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;trunk-&gt;stations, entry)))
<a name="l05967"></a>05967       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(station_ref);
<a name="l05968"></a>05968 
<a name="l05969"></a>05969    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(trunk);
<a name="l05970"></a>05970    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(trunk);
<a name="l05971"></a>05971 }
<a name="l05972"></a>05972 
<a name="l05973"></a><a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">05973</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">destroy_station</a>(<span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station)
<a name="l05974"></a>05974 {
<a name="l05975"></a>05975    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l05976"></a>05976 
<a name="l05977"></a>05977    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(station-&gt;autocontext)) {
<a name="l05978"></a>05978       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l05979"></a>05979       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l05980"></a>05980          <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l05981"></a>05981          <span class="keywordtype">char</span> hint[<a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a>];
<a name="l05982"></a>05982          snprintf(exten, <span class="keyword">sizeof</span>(exten), <span class="stringliteral">&quot;%s_%s&quot;</span>, station-&gt;name, trunk_ref-&gt;trunk-&gt;name);
<a name="l05983"></a>05983          snprintf(hint, <span class="keyword">sizeof</span>(hint), <span class="stringliteral">&quot;SLA:%s&quot;</span>, exten);
<a name="l05984"></a>05984          <a class="code" href="pbx_8h.html#a721c6ba091102f155a586e09b2a526bf" title="Simply remove extension from context.">ast_context_remove_extension</a>(station-&gt;autocontext, exten, 
<a name="l05985"></a>05985             1, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>);
<a name="l05986"></a>05986          <a class="code" href="pbx_8h.html#a721c6ba091102f155a586e09b2a526bf" title="Simply remove extension from context.">ast_context_remove_extension</a>(station-&gt;autocontext, hint, 
<a name="l05987"></a>05987             <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>);
<a name="l05988"></a>05988       }
<a name="l05989"></a>05989       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l05990"></a>05990    }
<a name="l05991"></a>05991 
<a name="l05992"></a>05992    <span class="keywordflow">while</span> ((trunk_ref = <a class="code" href="linkedlists_8h.html#aadfe2a69fbba4f27c201266a2ca5f989" title="Removes and returns the head entry from a list.">AST_LIST_REMOVE_HEAD</a>(&amp;station-&gt;trunks, entry)))
<a name="l05993"></a>05993       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(trunk_ref);
<a name="l05994"></a>05994 
<a name="l05995"></a>05995    <a class="code" href="stringfields_8h.html#abf60f862ae6a141d2f86a0f5e82792de" title="free all memory - to be called before destroying the object">ast_string_field_free_memory</a>(station);
<a name="l05996"></a>05996    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(station);
<a name="l05997"></a>05997 }
<a name="l05998"></a>05998 
<a name="l05999"></a><a class="code" href="app__meetme_8c.html#abc917c910c7fd37e34c7a985a227e0b9">05999</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#abc917c910c7fd37e34c7a985a227e0b9">sla_destroy</a>(<span class="keywordtype">void</span>)
<a name="l06000"></a>06000 {
<a name="l06001"></a>06001    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l06002"></a>06002    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l06003"></a>06003 
<a name="l06004"></a>06004    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sla_trunks);
<a name="l06005"></a>06005    <span class="keywordflow">while</span> ((trunk = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;sla_trunks, entry)))
<a name="l06006"></a>06006       <a class="code" href="app__meetme_8c.html#ab603b1b5243b7a01e6af849e2ab6d327">destroy_trunk</a>(trunk);
<a name="l06007"></a>06007    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l06008"></a>06008 
<a name="l06009"></a>06009    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sla_stations);
<a name="l06010"></a>06010    <span class="keywordflow">while</span> ((station = <a class="code" href="linkedlists_8h.html#a3d3aa4fb3b4ba38ad8d6d255d97e037c">AST_RWLIST_REMOVE_HEAD</a>(&amp;sla_stations, entry)))
<a name="l06011"></a>06011       <a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">destroy_station</a>(station);
<a name="l06012"></a>06012    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l06013"></a>06013 
<a name="l06014"></a>06014    <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.thread != <a class="code" href="lock_8h.html#a6009440c7a72f8e2e3b1ec97641ad160">AST_PTHREADT_NULL</a>) {
<a name="l06015"></a>06015       <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l06016"></a>06016       <a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.stop = 1;
<a name="l06017"></a>06017       <a class="code" href="lock_8h.html#a02a91e30acdea6d13208d23636d37c87">ast_cond_signal</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.cond);
<a name="l06018"></a>06018       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l06019"></a>06019       pthread_join(<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.thread, NULL);
<a name="l06020"></a>06020    }
<a name="l06021"></a>06021 
<a name="l06022"></a>06022    <span class="comment">/* Drop any created contexts from the dialplan */</span>
<a name="l06023"></a>06023    <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(NULL, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>);
<a name="l06024"></a>06024 
<a name="l06025"></a>06025    <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l06026"></a>06026    <a class="code" href="lock_8h.html#a7752bcadc38f1d7a7a8528c538569115">ast_cond_destroy</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.cond);
<a name="l06027"></a>06027 }
<a name="l06028"></a>06028 
<a name="l06029"></a><a class="code" href="app__meetme_8c.html#a272ffb0f64aec9b1792174c33042cb75">06029</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a272ffb0f64aec9b1792174c33042cb75">sla_check_device</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *device)
<a name="l06030"></a>06030 {
<a name="l06031"></a>06031    <span class="keywordtype">char</span> *tech, *tech_data;
<a name="l06032"></a>06032 
<a name="l06033"></a>06033    tech_data = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(device);
<a name="l06034"></a>06034    tech = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;tech_data, <span class="stringliteral">&quot;/&quot;</span>);
<a name="l06035"></a>06035 
<a name="l06036"></a>06036    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tech) || <a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(tech_data))
<a name="l06037"></a>06037       <span class="keywordflow">return</span> -1;
<a name="l06038"></a>06038 
<a name="l06039"></a>06039    <span class="keywordflow">return</span> 0;
<a name="l06040"></a>06040 }
<a name="l06041"></a>06041 
<a name="l06042"></a><a class="code" href="app__meetme_8c.html#a1f6d3d4a6e263e27a4f665aaf5cad1b3">06042</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a1f6d3d4a6e263e27a4f665aaf5cad1b3">sla_build_trunk</a>(<span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg, <span class="keyword">const</span> <span class="keywordtype">char</span> *cat)
<a name="l06043"></a>06043 {
<a name="l06044"></a>06044    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l06045"></a>06045    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l06046"></a>06046    <span class="keyword">const</span> <span class="keywordtype">char</span> *dev;
<a name="l06047"></a>06047 
<a name="l06048"></a>06048    <span class="keywordflow">if</span> (!(dev = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">&quot;device&quot;</span>))) {
<a name="l06049"></a>06049       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SLA Trunk &apos;%s&apos; defined with no device!\n&quot;</span>, cat);
<a name="l06050"></a>06050       <span class="keywordflow">return</span> -1;
<a name="l06051"></a>06051    }
<a name="l06052"></a>06052 
<a name="l06053"></a>06053    <span class="keywordflow">if</span> (<a class="code" href="app__meetme_8c.html#a272ffb0f64aec9b1792174c33042cb75">sla_check_device</a>(dev)) {
<a name="l06054"></a>06054       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SLA Trunk &apos;%s&apos; define with invalid device &apos;%s&apos;!\n&quot;</span>,
<a name="l06055"></a>06055          cat, dev);
<a name="l06056"></a>06056       <span class="keywordflow">return</span> -1;
<a name="l06057"></a>06057    }
<a name="l06058"></a>06058 
<a name="l06059"></a>06059    <span class="keywordflow">if</span> (!(trunk = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*trunk))))
<a name="l06060"></a>06060       <span class="keywordflow">return</span> -1;
<a name="l06061"></a>06061    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(trunk, 32)) {
<a name="l06062"></a>06062       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(trunk);
<a name="l06063"></a>06063       <span class="keywordflow">return</span> -1;
<a name="l06064"></a>06064    }
<a name="l06065"></a>06065 
<a name="l06066"></a>06066    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(trunk, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, cat);
<a name="l06067"></a>06067    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(trunk, device, dev);
<a name="l06068"></a>06068 
<a name="l06069"></a>06069    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l06070"></a>06070       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autocontext&quot;</span>))
<a name="l06071"></a>06071          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(trunk, autocontext, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l06072"></a>06072       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;ringtimeout&quot;</span>)) {
<a name="l06073"></a>06073          <span class="keywordflow">if</span> (sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;trunk-&gt;ring_timeout) != 1) {
<a name="l06074"></a>06074             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid ringtimeout &apos;%s&apos; specified for trunk &apos;%s&apos;\n&quot;</span>,
<a name="l06075"></a>06075                var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, trunk-&gt;name);
<a name="l06076"></a>06076             trunk-&gt;ring_timeout = 0;
<a name="l06077"></a>06077          }
<a name="l06078"></a>06078       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;barge&quot;</span>))
<a name="l06079"></a>06079          trunk-&gt;barge_disabled = <a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l06080"></a>06080       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;hold&quot;</span>)) {
<a name="l06081"></a>06081          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;private&quot;</span>))
<a name="l06082"></a>06082             trunk-&gt;hold_access = <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">SLA_HOLD_PRIVATE</a>;
<a name="l06083"></a>06083          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;open&quot;</span>))
<a name="l06084"></a>06084             trunk-&gt;hold_access = <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685ca1e46cd00f27d565cf02c15ec55c8be06">SLA_HOLD_OPEN</a>;
<a name="l06085"></a>06085          <span class="keywordflow">else</span> {
<a name="l06086"></a>06086             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &apos;%s&apos; for hold on trunk %s\n&quot;</span>,
<a name="l06087"></a>06087                var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, trunk-&gt;name);
<a name="l06088"></a>06088          }
<a name="l06089"></a>06089       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;type&quot;</span>) &amp;&amp; strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;device&quot;</span>)) {
<a name="l06090"></a>06090          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid option &apos;%s&apos; specified at line %d of %s!\n&quot;</span>,
<a name="l06091"></a>06091             var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>, <a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">SLA_CONFIG_FILE</a>);
<a name="l06092"></a>06092       }
<a name="l06093"></a>06093    }
<a name="l06094"></a>06094 
<a name="l06095"></a>06095    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(trunk-&gt;autocontext)) {
<a name="l06096"></a>06096       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l06097"></a>06097       context = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, trunk-&gt;autocontext, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>);
<a name="l06098"></a>06098       <span class="keywordflow">if</span> (!context) {
<a name="l06099"></a>06099          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to automatically find or create &quot;</span>
<a name="l06100"></a>06100             <span class="stringliteral">&quot;context &apos;%s&apos; for SLA!\n&quot;</span>, trunk-&gt;autocontext);
<a name="l06101"></a>06101          <a class="code" href="app__meetme_8c.html#ab603b1b5243b7a01e6af849e2ab6d327">destroy_trunk</a>(trunk);
<a name="l06102"></a>06102          <span class="keywordflow">return</span> -1;
<a name="l06103"></a>06103       }
<a name="l06104"></a>06104       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(context, 0 <span class="comment">/* don&apos;t replace */</span>, <span class="stringliteral">&quot;s&quot;</span>, 1,
<a name="l06105"></a>06105          NULL, NULL, slatrunk_app, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(trunk-&gt;name), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>)) {
<a name="l06106"></a>06106          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to automatically create extension &quot;</span>
<a name="l06107"></a>06107             <span class="stringliteral">&quot;for trunk &apos;%s&apos;!\n&quot;</span>, trunk-&gt;name);
<a name="l06108"></a>06108          <a class="code" href="app__meetme_8c.html#ab603b1b5243b7a01e6af849e2ab6d327">destroy_trunk</a>(trunk);
<a name="l06109"></a>06109          <span class="keywordflow">return</span> -1;
<a name="l06110"></a>06110       }
<a name="l06111"></a>06111    }
<a name="l06112"></a>06112 
<a name="l06113"></a>06113    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sla_trunks);
<a name="l06114"></a>06114    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;sla_trunks, trunk, entry);
<a name="l06115"></a>06115    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l06116"></a>06116 
<a name="l06117"></a>06117    <span class="keywordflow">return</span> 0;
<a name="l06118"></a>06118 }
<a name="l06119"></a>06119 
<a name="l06120"></a><a class="code" href="app__meetme_8c.html#a68869e7d25e7e313afd63ffb70b95546">06120</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__meetme_8c.html#a68869e7d25e7e313afd63ffb70b95546">sla_add_trunk_to_station</a>(<span class="keyword">struct</span> <a class="code" href="structsla__station.html">sla_station</a> *station, <span class="keyword">struct</span> <a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>)
<a name="l06121"></a>06121 {
<a name="l06122"></a>06122    <span class="keyword">struct </span><a class="code" href="structsla__trunk.html">sla_trunk</a> *trunk;
<a name="l06123"></a>06123    <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l06124"></a>06124    <span class="keyword">struct </span><a class="code" href="structsla__station__ref.html">sla_station_ref</a> *station_ref;
<a name="l06125"></a>06125    <span class="keywordtype">char</span> *trunk_name, *options, *cur;
<a name="l06126"></a>06126 
<a name="l06127"></a>06127    options = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l06128"></a>06128    trunk_name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;options, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l06129"></a>06129    
<a name="l06130"></a>06130    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l06131"></a>06131    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;sla_trunks, trunk, entry) {
<a name="l06132"></a>06132       <span class="keywordflow">if</span> (!strcasecmp(trunk-&gt;name, trunk_name))
<a name="l06133"></a>06133          <span class="keywordflow">break</span>;
<a name="l06134"></a>06134    }
<a name="l06135"></a>06135 
<a name="l06136"></a>06136    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l06137"></a>06137    <span class="keywordflow">if</span> (!trunk) {
<a name="l06138"></a>06138       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Trunk &apos;%s&apos; not found!\n&quot;</span>, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l06139"></a>06139       <span class="keywordflow">return</span>;
<a name="l06140"></a>06140    }
<a name="l06141"></a>06141    <span class="keywordflow">if</span> (!(trunk_ref = <a class="code" href="app__meetme_8c.html#a89b13052de37686017f177352a20a8d0">create_trunk_ref</a>(trunk)))
<a name="l06142"></a>06142       <span class="keywordflow">return</span>;
<a name="l06143"></a>06143    trunk_ref-&gt;state = <a class="code" href="app__meetme_8c.html#a00c9a846446d62f12898047d3d34cc75af3ec0c697a687913a6c051a9b4f0d0f5">SLA_TRUNK_STATE_IDLE</a>;
<a name="l06144"></a>06144 
<a name="l06145"></a>06145    <span class="keywordflow">while</span> ((cur = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;options, <span class="stringliteral">&quot;,&quot;</span>))) {
<a name="l06146"></a>06146       <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *value = cur;
<a name="l06147"></a>06147       name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;value, <span class="stringliteral">&quot;=&quot;</span>);
<a name="l06148"></a>06148       <span class="keywordflow">if</span> (!strcasecmp(name, <span class="stringliteral">&quot;ringtimeout&quot;</span>)) {
<a name="l06149"></a>06149          <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;trunk_ref-&gt;ring_timeout) != 1) {
<a name="l06150"></a>06150             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid ringtimeout value &apos;%s&apos; for &quot;</span>
<a name="l06151"></a>06151                <span class="stringliteral">&quot;trunk &apos;%s&apos; on station &apos;%s&apos;\n&quot;</span>, value, trunk-&gt;name, station-&gt;name);
<a name="l06152"></a>06152             trunk_ref-&gt;ring_timeout = 0;
<a name="l06153"></a>06153          }
<a name="l06154"></a>06154       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(name, <span class="stringliteral">&quot;ringdelay&quot;</span>)) {
<a name="l06155"></a>06155          <span class="keywordflow">if</span> (sscanf(value, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;trunk_ref-&gt;ring_delay) != 1) {
<a name="l06156"></a>06156             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid ringdelay value &apos;%s&apos; for &quot;</span>
<a name="l06157"></a>06157                <span class="stringliteral">&quot;trunk &apos;%s&apos; on station &apos;%s&apos;\n&quot;</span>, value, trunk-&gt;name, station-&gt;name);
<a name="l06158"></a>06158             trunk_ref-&gt;ring_delay = 0;
<a name="l06159"></a>06159          }
<a name="l06160"></a>06160       } <span class="keywordflow">else</span> {
<a name="l06161"></a>06161          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid option &apos;%s&apos; for &quot;</span>
<a name="l06162"></a>06162             <span class="stringliteral">&quot;trunk &apos;%s&apos; on station &apos;%s&apos;\n&quot;</span>, name, trunk-&gt;name, station-&gt;name);
<a name="l06163"></a>06163       }
<a name="l06164"></a>06164    }
<a name="l06165"></a>06165 
<a name="l06166"></a>06166    <span class="keywordflow">if</span> (!(station_ref = <a class="code" href="app__meetme_8c.html#a95a34a9245e87d8481590dddcfd168d2">sla_create_station_ref</a>(station))) {
<a name="l06167"></a>06167       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(trunk_ref);
<a name="l06168"></a>06168       <span class="keywordflow">return</span>;
<a name="l06169"></a>06169    }
<a name="l06170"></a>06170    <a class="code" href="lock_8h.html#a30df186a6f53f66621e88fae2e7adaf9" title="Atomically add v to *p and return * the previous value of *p. This can be used to...">ast_atomic_fetchadd_int</a>((<span class="keywordtype">int</span> *) &amp;trunk-&gt;num_stations, 1);
<a name="l06171"></a>06171    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sla_trunks);
<a name="l06172"></a>06172    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;trunk-&gt;stations, station_ref, entry);
<a name="l06173"></a>06173    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l06174"></a>06174    <a class="code" href="linkedlists_8h.html#a4d258b4525e63c435d7de579d3f46960" title="Appends a list entry to the tail of a list.">AST_LIST_INSERT_TAIL</a>(&amp;station-&gt;trunks, trunk_ref, entry);
<a name="l06175"></a>06175 }
<a name="l06176"></a>06176 
<a name="l06177"></a><a class="code" href="app__meetme_8c.html#a052cc5aec5957d252837e98b2d200384">06177</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a052cc5aec5957d252837e98b2d200384">sla_build_station</a>(<span class="keyword">struct</span> <a class="code" href="structast__config.html">ast_config</a> *cfg, <span class="keyword">const</span> <span class="keywordtype">char</span> *cat)
<a name="l06178"></a>06178 {
<a name="l06179"></a>06179    <span class="keyword">struct </span><a class="code" href="structsla__station.html">sla_station</a> *station;
<a name="l06180"></a>06180    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *<a class="code" href="ast__expr2f_8c.html#a1b0936415a643c88ce543099c10e0d7f">var</a>;
<a name="l06181"></a>06181    <span class="keyword">const</span> <span class="keywordtype">char</span> *dev;
<a name="l06182"></a>06182 
<a name="l06183"></a>06183    <span class="keywordflow">if</span> (!(dev = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">&quot;device&quot;</span>))) {
<a name="l06184"></a>06184       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;SLA Station &apos;%s&apos; defined with no device!\n&quot;</span>, cat);
<a name="l06185"></a>06185       <span class="keywordflow">return</span> -1;
<a name="l06186"></a>06186    }
<a name="l06187"></a>06187 
<a name="l06188"></a>06188    <span class="keywordflow">if</span> (!(station = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*station))))
<a name="l06189"></a>06189       <span class="keywordflow">return</span> -1;
<a name="l06190"></a>06190    <span class="keywordflow">if</span> (<a class="code" href="stringfields_8h.html#a871274fa4fd2687c7a44849a84df3665" title="Initialize a field pool and fields.">ast_string_field_init</a>(station, 32)) {
<a name="l06191"></a>06191       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(station);
<a name="l06192"></a>06192       <span class="keywordflow">return</span> -1;
<a name="l06193"></a>06193    }
<a name="l06194"></a>06194 
<a name="l06195"></a>06195    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(station, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, cat);
<a name="l06196"></a>06196    <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(station, device, dev);
<a name="l06197"></a>06197 
<a name="l06198"></a>06198    <span class="keywordflow">for</span> (var = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(cfg, cat); var; var = var-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l06199"></a>06199       <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;trunk&quot;</span>))
<a name="l06200"></a>06200          <a class="code" href="app__meetme_8c.html#a68869e7d25e7e313afd63ffb70b95546">sla_add_trunk_to_station</a>(station, var);
<a name="l06201"></a>06201       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;autocontext&quot;</span>))
<a name="l06202"></a>06202          <a class="code" href="stringfields_8h.html#a653461abd6e0d16e4e3326ab90e0501d" title="Set a field to a simple string value.">ast_string_field_set</a>(station, autocontext, var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l06203"></a>06203       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;ringtimeout&quot;</span>)) {
<a name="l06204"></a>06204          <span class="keywordflow">if</span> (sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;station-&gt;ring_timeout) != 1) {
<a name="l06205"></a>06205             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid ringtimeout &apos;%s&apos; specified for station &apos;%s&apos;\n&quot;</span>,
<a name="l06206"></a>06206                var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, station-&gt;name);
<a name="l06207"></a>06207             station-&gt;ring_timeout = 0;
<a name="l06208"></a>06208          }
<a name="l06209"></a>06209       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;ringdelay&quot;</span>)) {
<a name="l06210"></a>06210          <span class="keywordflow">if</span> (sscanf(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;%30u&quot;</span>, &amp;station-&gt;ring_delay) != 1) {
<a name="l06211"></a>06211             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid ringdelay &apos;%s&apos; specified for station &apos;%s&apos;\n&quot;</span>,
<a name="l06212"></a>06212                var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, station-&gt;name);
<a name="l06213"></a>06213             station-&gt;ring_delay = 0;
<a name="l06214"></a>06214          }
<a name="l06215"></a>06215       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;hold&quot;</span>)) {
<a name="l06216"></a>06216          <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;private&quot;</span>))
<a name="l06217"></a>06217             station-&gt;hold_access = <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685cab53c785cab44a382700c0c2e7bfabf3b">SLA_HOLD_PRIVATE</a>;
<a name="l06218"></a>06218          <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="stringliteral">&quot;open&quot;</span>))
<a name="l06219"></a>06219             station-&gt;hold_access = <a class="code" href="app__meetme_8c.html#acf4c4ede2cc9c90c07b60b08aaf2685ca1e46cd00f27d565cf02c15ec55c8be06">SLA_HOLD_OPEN</a>;
<a name="l06220"></a>06220          <span class="keywordflow">else</span> {
<a name="l06221"></a>06221             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid value &apos;%s&apos; for hold on station %s\n&quot;</span>,
<a name="l06222"></a>06222                var-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, station-&gt;name);
<a name="l06223"></a>06223          }
<a name="l06224"></a>06224 
<a name="l06225"></a>06225       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;type&quot;</span>) &amp;&amp; strcasecmp(var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;device&quot;</span>)) {
<a name="l06226"></a>06226          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Invalid option &apos;%s&apos; specified at line %d of %s!\n&quot;</span>,
<a name="l06227"></a>06227             var-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, var-&gt;<a class="code" href="structast__variable.html#a501b314f49b3a9ff6e7be599d94686ee">lineno</a>, <a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">SLA_CONFIG_FILE</a>);
<a name="l06228"></a>06228       }
<a name="l06229"></a>06229    }
<a name="l06230"></a>06230 
<a name="l06231"></a>06231    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(station-&gt;autocontext)) {
<a name="l06232"></a>06232       <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>;
<a name="l06233"></a>06233       <span class="keyword">struct </span><a class="code" href="structsla__trunk__ref.html">sla_trunk_ref</a> *trunk_ref;
<a name="l06234"></a>06234       context = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(NULL, NULL, station-&gt;autocontext, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>);
<a name="l06235"></a>06235       <span class="keywordflow">if</span> (!context) {
<a name="l06236"></a>06236          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to automatically find or create &quot;</span>
<a name="l06237"></a>06237             <span class="stringliteral">&quot;context &apos;%s&apos; for SLA!\n&quot;</span>, station-&gt;autocontext);
<a name="l06238"></a>06238          <a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">destroy_station</a>(station);
<a name="l06239"></a>06239          <span class="keywordflow">return</span> -1;
<a name="l06240"></a>06240       }
<a name="l06241"></a>06241       <span class="comment">/* The extension for when the handset goes off-hook.</span>
<a name="l06242"></a>06242 <span class="comment">       * exten =&gt; station1,1,SLAStation(station1) */</span>
<a name="l06243"></a>06243       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(context, 0 <span class="comment">/* don&apos;t replace */</span>, station-&gt;name, 1,
<a name="l06244"></a>06244          NULL, NULL, slastation_app, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(station-&gt;name), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>)) {
<a name="l06245"></a>06245          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to automatically create extension &quot;</span>
<a name="l06246"></a>06246             <span class="stringliteral">&quot;for trunk &apos;%s&apos;!\n&quot;</span>, station-&gt;name);
<a name="l06247"></a>06247          <a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">destroy_station</a>(station);
<a name="l06248"></a>06248          <span class="keywordflow">return</span> -1;
<a name="l06249"></a>06249       }
<a name="l06250"></a>06250       <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;sla_trunks);
<a name="l06251"></a>06251       <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;station-&gt;trunks, trunk_ref, entry) {
<a name="l06252"></a>06252          <span class="keywordtype">char</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>[<a class="code" href="channel_8h.html#af4e59494f74ad9e0c50170d9e276ad31">AST_MAX_EXTENSION</a>];
<a name="l06253"></a>06253          <span class="keywordtype">char</span> hint[<a class="code" href="pbx_8h.html#a3414b82af9b33fe907c9377c5c73c453">AST_MAX_APP</a>];
<a name="l06254"></a>06254          snprintf(exten, <span class="keyword">sizeof</span>(exten), <span class="stringliteral">&quot;%s_%s&quot;</span>, station-&gt;name, trunk_ref-&gt;trunk-&gt;name);
<a name="l06255"></a>06255          snprintf(hint, <span class="keyword">sizeof</span>(hint), <span class="stringliteral">&quot;SLA:%s&quot;</span>, exten);
<a name="l06256"></a>06256          <span class="comment">/* Extension for this line button </span>
<a name="l06257"></a>06257 <span class="comment">          * exten =&gt; station1_line1,1,SLAStation(station1_line1) */</span>
<a name="l06258"></a>06258          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(context, 0 <span class="comment">/* don&apos;t replace */</span>, exten, 1,
<a name="l06259"></a>06259             NULL, NULL, slastation_app, <a class="code" href="astmm_8h.html#a2ef2401ade6b4b773138a82c86c40903">ast_strdup</a>(exten), <a class="code" href="utils_8h.html#a4e6aceb50eca868b7c38064c6c1a4789" title="free() wrapper">ast_free_ptr</a>, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>)) {
<a name="l06260"></a>06260             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to automatically create extension &quot;</span>
<a name="l06261"></a>06261                <span class="stringliteral">&quot;for trunk &apos;%s&apos;!\n&quot;</span>, station-&gt;name);
<a name="l06262"></a>06262             <a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">destroy_station</a>(station);
<a name="l06263"></a>06263             <span class="keywordflow">return</span> -1;
<a name="l06264"></a>06264          }
<a name="l06265"></a>06265          <span class="comment">/* Hint for this line button </span>
<a name="l06266"></a>06266 <span class="comment">          * exten =&gt; station1_line1,hint,SLA:station1_line1 */</span>
<a name="l06267"></a>06267          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a8790db69940f3c32c2d7943ee73f2180" title="Add an extension to an extension context, this time with an ast_context *.">ast_add_extension2</a>(context, 0 <span class="comment">/* don&apos;t replace */</span>, exten, <a class="code" href="pbx_8h.html#ad2e753a683024fad0b34ece3b1aef83a">PRIORITY_HINT</a>,
<a name="l06268"></a>06268             NULL, NULL, hint, NULL, NULL, <a class="code" href="app__meetme_8c.html#af202f7f4426763c7a42b46fa5b868d2d">sla_registrar</a>)) {
<a name="l06269"></a>06269             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Failed to automatically create hint &quot;</span>
<a name="l06270"></a>06270                <span class="stringliteral">&quot;for trunk &apos;%s&apos;!\n&quot;</span>, station-&gt;name);
<a name="l06271"></a>06271             <a class="code" href="app__meetme_8c.html#ac2ba254b295cb12101b65b70972e7b7a">destroy_station</a>(station);
<a name="l06272"></a>06272             <span class="keywordflow">return</span> -1;
<a name="l06273"></a>06273          }
<a name="l06274"></a>06274       }
<a name="l06275"></a>06275       <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_trunks);
<a name="l06276"></a>06276    }
<a name="l06277"></a>06277 
<a name="l06278"></a>06278    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;sla_stations);
<a name="l06279"></a>06279    <a class="code" href="linkedlists_8h.html#aadda916488b2d151af4426e2f06ad332">AST_RWLIST_INSERT_TAIL</a>(&amp;sla_stations, station, entry);
<a name="l06280"></a>06280    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;sla_stations);
<a name="l06281"></a>06281 
<a name="l06282"></a>06282    <span class="keywordflow">return</span> 0;
<a name="l06283"></a>06283 }
<a name="l06284"></a>06284 
<a name="l06285"></a><a class="code" href="app__meetme_8c.html#a03d6f53f0d136a93c89b9d848ca0ed0e">06285</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#a03d6f53f0d136a93c89b9d848ca0ed0e">sla_load_config</a>(<span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l06286"></a>06286 {
<a name="l06287"></a>06287    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l06288"></a>06288    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l06289"></a>06289    <span class="keyword">const</span> <span class="keywordtype">char</span> *cat = NULL;
<a name="l06290"></a>06290    <span class="keywordtype">int</span> res = 0;
<a name="l06291"></a>06291    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structval.html">val</a>;
<a name="l06292"></a>06292 
<a name="l06293"></a>06293    <span class="keywordflow">if</span> (!reload) {
<a name="l06294"></a>06294       <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.lock);
<a name="l06295"></a>06295       <a class="code" href="lock_8h.html#a21f75f462115427718d78aa66cc61f9b">ast_cond_init</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.cond, NULL);
<a name="l06296"></a>06296    }
<a name="l06297"></a>06297 
<a name="l06298"></a>06298    <span class="keywordflow">if</span> (!(cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">SLA_CONFIG_FILE</a>, config_flags))) {
<a name="l06299"></a>06299       <span class="keywordflow">return</span> 0; <span class="comment">/* Treat no config as normal */</span>
<a name="l06300"></a>06300    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l06301"></a>06301       <span class="keywordflow">return</span> 0;
<a name="l06302"></a>06302    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l06303"></a>06303       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file &quot;</span> <a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">SLA_CONFIG_FILE</a> <span class="stringliteral">&quot; is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l06304"></a>06304       <span class="keywordflow">return</span> 0;
<a name="l06305"></a>06305    }
<a name="l06306"></a>06306 
<a name="l06307"></a>06307    <span class="keywordflow">if</span> ((val = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;attemptcallerid&quot;</span>)))
<a name="l06308"></a>06308       <a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.attempt_callerid = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(val);
<a name="l06309"></a>06309 
<a name="l06310"></a>06310    <span class="keywordflow">while</span> ((cat = <a class="code" href="config_8h.html#a611776300f941a63266cb220ac62b4db" title="Goes through categories.">ast_category_browse</a>(cfg, cat)) &amp;&amp; !res) {
<a name="l06311"></a>06311       <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>;
<a name="l06312"></a>06312       <span class="keywordflow">if</span> (!strcasecmp(cat, <span class="stringliteral">&quot;general&quot;</span>))
<a name="l06313"></a>06313          <span class="keywordflow">continue</span>;
<a name="l06314"></a>06314       <span class="keywordflow">if</span> (!(type = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, cat, <span class="stringliteral">&quot;type&quot;</span>))) {
<a name="l06315"></a>06315          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Invalid entry in %s defined with no type!\n&quot;</span>,
<a name="l06316"></a>06316             <a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">SLA_CONFIG_FILE</a>);
<a name="l06317"></a>06317          <span class="keywordflow">continue</span>;
<a name="l06318"></a>06318       }
<a name="l06319"></a>06319       <span class="keywordflow">if</span> (!strcasecmp(type, <span class="stringliteral">&quot;trunk&quot;</span>))
<a name="l06320"></a>06320          res = <a class="code" href="app__meetme_8c.html#a1f6d3d4a6e263e27a4f665aaf5cad1b3">sla_build_trunk</a>(cfg, cat);
<a name="l06321"></a>06321       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(type, <span class="stringliteral">&quot;station&quot;</span>))
<a name="l06322"></a>06322          res = <a class="code" href="app__meetme_8c.html#a052cc5aec5957d252837e98b2d200384">sla_build_station</a>(cfg, cat);
<a name="l06323"></a>06323       <span class="keywordflow">else</span> {
<a name="l06324"></a>06324          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Entry in %s defined with invalid type &apos;%s&apos;!\n&quot;</span>,
<a name="l06325"></a>06325             <a class="code" href="app__meetme_8c.html#a8150bc2c862d46744a596001d6109ffa">SLA_CONFIG_FILE</a>, type);
<a name="l06326"></a>06326       }
<a name="l06327"></a>06327    }
<a name="l06328"></a>06328 
<a name="l06329"></a>06329    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l06330"></a>06330 
<a name="l06331"></a>06331    <span class="keywordflow">if</span> (!reload &amp;&amp; (!<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;sla_stations) || !<a class="code" href="linkedlists_8h.html#a4a1884cde93e53bef32ca85c194a1d05" title="Checks whether the specified list contains any entries.">AST_LIST_EMPTY</a>(&amp;sla_stations)))
<a name="l06332"></a>06332       <a class="code" href="utils_8h.html#a4781fd54a4ca8c7f0f8a32a6cce503c0">ast_pthread_create</a>(&amp;<a class="code" href="app__meetme_8c.html#a5d4391e5aa48e02b96ce4ef51cbc2b0c" title="A structure for data used by the sla thread.">sla</a>.thread, NULL, <a class="code" href="app__meetme_8c.html#a4e56f1037f61fa109b10096e3dd11176">sla_thread</a>, NULL);
<a name="l06333"></a>06333 
<a name="l06334"></a>06334    <span class="keywordflow">return</span> res;
<a name="l06335"></a>06335 }
<a name="l06336"></a>06336 
<a name="l06337"></a><a class="code" href="app__meetme_8c.html#ad8bb45d5bc9a8830ae1202129128f217">06337</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad8bb45d5bc9a8830ae1202129128f217">acf_meetme_info_eval</a>(<span class="keywordtype">char</span> *keyword, <span class="keyword">struct</span> <a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf)
<a name="l06338"></a>06338 {
<a name="l06339"></a>06339    <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;lock&quot;</span>, keyword)) {
<a name="l06340"></a>06340       <span class="keywordflow">return</span> conf-&gt;<a class="code" href="structast__conference.html#afa330a895fe8ef506be047091f21d940">locked</a>;
<a name="l06341"></a>06341    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;parties&quot;</span>, keyword)) {
<a name="l06342"></a>06342       <span class="keywordflow">return</span> conf-&gt;<a class="code" href="structast__conference.html#ac2aec85ac9216c43dbae2d7550741607">users</a>;
<a name="l06343"></a>06343    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;activity&quot;</span>, keyword)) {
<a name="l06344"></a>06344       time_t now;
<a name="l06345"></a>06345       now = time(NULL);
<a name="l06346"></a>06346       <span class="keywordflow">return</span> (now - conf-&gt;<a class="code" href="structast__conference.html#ada310e7f72b38fadd4b24d80ed3438ee">start</a>);
<a name="l06347"></a>06347    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(<span class="stringliteral">&quot;dynamic&quot;</span>, keyword)) {
<a name="l06348"></a>06348       <span class="keywordflow">return</span> conf-&gt;<a class="code" href="structast__conference.html#a0fcf3d8cb0b08a4d668fd87f01bd4192">isdynamic</a>;
<a name="l06349"></a>06349    } <span class="keywordflow">else</span> {
<a name="l06350"></a>06350       <span class="keywordflow">return</span> -1;
<a name="l06351"></a>06351    }
<a name="l06352"></a>06352 
<a name="l06353"></a>06353 }
<a name="l06354"></a>06354 
<a name="l06355"></a><a class="code" href="app__meetme_8c.html#af1a48f6d67bd24c7b9f9891290e04552">06355</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#af1a48f6d67bd24c7b9f9891290e04552">acf_meetme_info</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__conference.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *cmd, <span class="keywordtype">char</span> *data, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l06356"></a>06356 {
<a name="l06357"></a>06357    <span class="keyword">struct </span><a class="code" href="structast__conference.html" title="The MeetMe Conference object.">ast_conference</a> *conf;
<a name="l06358"></a>06358    <span class="keywordtype">char</span> *<a class="code" href="chan__mgcp_8c.html#a2e006acff60d9b3d65d7d60f975d6747">parse</a>;
<a name="l06359"></a>06359    <span class="keywordtype">int</span> result = -2; <span class="comment">/* only non-negative numbers valid, -1 is used elsewhere */</span>
<a name="l06360"></a>06360    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(args,
<a name="l06361"></a>06361       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(keyword);
<a name="l06362"></a>06362       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>);
<a name="l06363"></a>06363    );
<a name="l06364"></a>06364 
<a name="l06365"></a>06365    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l06366"></a>06366       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Syntax: MEETME_INFO() requires two arguments\n&quot;</span>);
<a name="l06367"></a>06367       <span class="keywordflow">return</span> -1;
<a name="l06368"></a>06368    }
<a name="l06369"></a>06369 
<a name="l06370"></a>06370    parse = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l06371"></a>06371    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(args, parse);
<a name="l06372"></a>06372 
<a name="l06373"></a>06373    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.keyword)) {
<a name="l06374"></a>06374       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Syntax: MEETME_INFO() requires a keyword\n&quot;</span>);
<a name="l06375"></a>06375       <span class="keywordflow">return</span> -1;
<a name="l06376"></a>06376    }
<a name="l06377"></a>06377 
<a name="l06378"></a>06378    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(args.confno)) {
<a name="l06379"></a>06379       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Syntax: MEETME_INFO() requires a conference number\n&quot;</span>);
<a name="l06380"></a>06380       <span class="keywordflow">return</span> -1;
<a name="l06381"></a>06381    }
<a name="l06382"></a>06382 
<a name="l06383"></a>06383    <a class="code" href="linkedlists_8h.html#a9140a4e4d781264fa9469c52b1adae40" title="Locks a list.">AST_LIST_LOCK</a>(&amp;confs);
<a name="l06384"></a>06384    <a class="code" href="linkedlists_8h.html#a3008b2f4f236b72d8bcfb80e346324ef" title="Loops over (traverses) the entries in a list.">AST_LIST_TRAVERSE</a>(&amp;confs, conf, list) {
<a name="l06385"></a>06385       <span class="keywordflow">if</span> (!strcmp(args.confno, conf-&gt;<a class="code" href="structast__conference.html#a9dd2948cb0042c35787acc178eca17d4">confno</a>)) {
<a name="l06386"></a>06386          result = <a class="code" href="app__meetme_8c.html#ad8bb45d5bc9a8830ae1202129128f217">acf_meetme_info_eval</a>(args.keyword, conf);
<a name="l06387"></a>06387          <span class="keywordflow">break</span>;
<a name="l06388"></a>06388       }
<a name="l06389"></a>06389    }
<a name="l06390"></a>06390    <a class="code" href="linkedlists_8h.html#ab48cb9e1e612dd486b747ba1c5d68d01" title="Attempts to unlock a list.">AST_LIST_UNLOCK</a>(&amp;confs);
<a name="l06391"></a>06391 
<a name="l06392"></a>06392    <span class="keywordflow">if</span> (result &gt; -1) {
<a name="l06393"></a>06393       snprintf(buf, len, <span class="stringliteral">&quot;%d&quot;</span>, result);
<a name="l06394"></a>06394    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == -1) {
<a name="l06395"></a>06395       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Error: invalid keyword: &apos;%s&apos;\n&quot;</span>, args.keyword);
<a name="l06396"></a>06396       snprintf(buf, len, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l06397"></a>06397    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (result == -2) {
<a name="l06398"></a>06398       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Error: conference (%s) not found\n&quot;</span>, args.confno); 
<a name="l06399"></a>06399       snprintf(buf, len, <span class="stringliteral">&quot;0&quot;</span>);
<a name="l06400"></a>06400    }
<a name="l06401"></a>06401 
<a name="l06402"></a>06402    <span class="keywordflow">return</span> 0;
<a name="l06403"></a>06403 }
<a name="l06404"></a>06404 
<a name="l06405"></a>06405 
<a name="l06406"></a><a class="code" href="app__meetme_8c.html#a0ff1e6e0d1512995dc75af266143dceb">06406</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__custom__function.html" title="Data structure associated with a custom dialplan function.">ast_custom_function</a> <a class="code" href="app__meetme_8c.html#a0ff1e6e0d1512995dc75af266143dceb">meetme_info_acf</a> = {
<a name="l06407"></a>06407    .<a class="code" href="structast__custom__function.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = <span class="stringliteral">&quot;MEETME_INFO&quot;</span>,
<a name="l06408"></a>06408    .synopsis = <span class="stringliteral">&quot;Query a given conference of various properties.&quot;</span>,
<a name="l06409"></a>06409    .syntax = <span class="stringliteral">&quot;MEETME_INFO(&lt;keyword&gt;,&lt;confno&gt;)&quot;</span>,
<a name="l06410"></a>06410    .read = <a class="code" href="app__meetme_8c.html#af1a48f6d67bd24c7b9f9891290e04552">acf_meetme_info</a>,
<a name="l06411"></a>06411    .desc =
<a name="l06412"></a>06412 <span class="stringliteral">&quot;Returns information from a given keyword. (For booleans 1-true, 0-false)\n&quot;</span>
<a name="l06413"></a>06413 <span class="stringliteral">&quot;  Options:\n&quot;</span>
<a name="l06414"></a>06414 <span class="stringliteral">&quot;    lock     - boolean of whether the corresponding conference is locked\n&quot;</span> 
<a name="l06415"></a>06415 <span class="stringliteral">&quot;    parties  - number of parties in a given conference\n&quot;</span>
<a name="l06416"></a>06416 <span class="stringliteral">&quot;    activity - duration of conference in seconds\n&quot;</span>
<a name="l06417"></a>06417 <span class="stringliteral">&quot;    dynamic  - boolean of whether the corresponding coference is dynamic\n&quot;</span>,
<a name="l06418"></a>06418 };
<a name="l06419"></a>06419 
<a name="l06420"></a>06420 
<a name="l06421"></a><a class="code" href="app__meetme_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">06421</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(<span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l06422"></a>06422 {
<a name="l06423"></a>06423    <a class="code" href="app__meetme_8c.html#aa682c8ee26d1e14b90c31da2b70069db">load_config_meetme</a>();
<a name="l06424"></a>06424 
<a name="l06425"></a>06425    <span class="keywordflow">if</span> (reload) {
<a name="l06426"></a>06426       <a class="code" href="app__meetme_8c.html#ab1d7e7f7fa838035c8235e0a6d4de745">sla_queue_event</a>(<a class="code" href="app__meetme_8c.html#a62fd4c125f1aadafcee981304a59261aabbba56c7b66dbbdd30b170de8ad228ce">SLA_EVENT_RELOAD</a>);
<a name="l06427"></a>06427       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;A reload of the SLA configuration has been requested &quot;</span>
<a name="l06428"></a>06428          <span class="stringliteral">&quot;and will be completed when the system is idle.\n&quot;</span>);
<a name="l06429"></a>06429       <span class="keywordflow">return</span> 0;
<a name="l06430"></a>06430    }
<a name="l06431"></a>06431    
<a name="l06432"></a>06432    <span class="keywordflow">return</span> <a class="code" href="app__meetme_8c.html#a03d6f53f0d136a93c89b9d848ca0ed0e">sla_load_config</a>(0);
<a name="l06433"></a>06433 }
<a name="l06434"></a>06434 
<a name="l06435"></a><a class="code" href="app__meetme_8c.html#ad09fa931f468002152a3cc2d5ce25eae">06435</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l06436"></a>06436 {
<a name="l06437"></a>06437    <span class="keywordtype">int</span> res = 0;
<a name="l06438"></a>06438    
<a name="l06439"></a>06439    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_meetme, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_meetme));
<a name="l06440"></a>06440    res = <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;MeetmeMute&quot;</span>);
<a name="l06441"></a>06441    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;MeetmeUnmute&quot;</span>);
<a name="l06442"></a>06442    res |= <a class="code" href="group__Group__AMI.html#ga5a9336fe5bb6b2cf350de9571080809d" title="Unregister a registered manager command.">ast_manager_unregister</a>(<span class="stringliteral">&quot;MeetmeList&quot;</span>);
<a name="l06443"></a>06443    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app4);
<a name="l06444"></a>06444    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app3);
<a name="l06445"></a>06445    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app2);
<a name="l06446"></a>06446    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app);
<a name="l06447"></a>06447    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(slastation_app);
<a name="l06448"></a>06448    res |= <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(slatrunk_app);
<a name="l06449"></a>06449 
<a name="l06450"></a>06450    <a class="code" href="devicestate_8h.html#a1ab579ae15aaca64a904c3c41d8b8b01" title="Remove device state provider.">ast_devstate_prov_del</a>(<span class="stringliteral">&quot;Meetme&quot;</span>);
<a name="l06451"></a>06451    <a class="code" href="devicestate_8h.html#a1ab579ae15aaca64a904c3c41d8b8b01" title="Remove device state provider.">ast_devstate_prov_del</a>(<span class="stringliteral">&quot;SLA&quot;</span>);
<a name="l06452"></a>06452    
<a name="l06453"></a>06453    <a class="code" href="app__meetme_8c.html#abc917c910c7fd37e34c7a985a227e0b9">sla_destroy</a>();
<a name="l06454"></a>06454    
<a name="l06455"></a>06455    res |= <a class="code" href="pbx_8h.html#a965977ea9a3144bc203e0ce7a64680a1" title="Unregister a custom function.">ast_custom_function_unregister</a>(&amp;meetme_info_acf);
<a name="l06456"></a>06456    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>);
<a name="l06457"></a>06457 
<a name="l06458"></a>06458    <span class="keywordflow">return</span> res;
<a name="l06459"></a>06459 }
<a name="l06460"></a>06460 
<a name="l06461"></a><a class="code" href="app__meetme_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">06461</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l06462"></a>06462 {
<a name="l06463"></a>06463    <span class="keywordtype">int</span> res = 0;
<a name="l06464"></a>06464 
<a name="l06465"></a>06465    res |= <a class="code" href="app__meetme_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(0);
<a name="l06466"></a>06466 
<a name="l06467"></a>06467    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_meetme, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_meetme));
<a name="l06468"></a>06468    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;MeetmeMute&quot;</span>, <a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, 
<a name="l06469"></a>06469                 <a class="code" href="app__meetme_8c.html#aa469d77d3fee8f11b2d48740365fd0d5">action_meetmemute</a>, <span class="stringliteral">&quot;Mute a Meetme user&quot;</span>);
<a name="l06470"></a>06470    res |= <a class="code" href="manager_8h.html#a24c8fe57053553be1a1458d4afe8909b" title="External routines may register/unregister manager callbacks this way.">ast_manager_register</a>(<span class="stringliteral">&quot;MeetmeUnmute&quot;</span>, <a class="code" href="manager_8h.html#ab5db3cc603d7e798d61cb4cd94fbb4e2">EVENT_FLAG_CALL</a>, 
<a name="l06471"></a>06471                 <a class="code" href="app__meetme_8c.html#a04a4ee089b212107b1e33943ce45fb3e">action_meetmeunmute</a>, <span class="stringliteral">&quot;Unmute a Meetme user&quot;</span>);
<a name="l06472"></a>06472    res |= <a class="code" href="group__Group__AMI.html#ga332bf7ef48f67d63d849dd9febb18fb2" title="Register a manager command with the manager interface.">ast_manager_register2</a>(<span class="stringliteral">&quot;MeetmeList&quot;</span>, <a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, 
<a name="l06473"></a>06473                 <a class="code" href="app__meetme_8c.html#a94e294b5969cdd4c4fb0802b9e6728a4">action_meetmelist</a>, <span class="stringliteral">&quot;List participants in a conference&quot;</span>, mandescr_meetmelist);
<a name="l06474"></a>06474    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app4, <a class="code" href="app__meetme_8c.html#aa6dfc370c805dae454a69268a537f491">channel_admin_exec</a>);
<a name="l06475"></a>06475    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app3, <a class="code" href="app__meetme_8c.html#afc1834495e75f3f0ee434d3f0e113bd7" title="The MeetMeadmin application.">admin_exec</a>);
<a name="l06476"></a>06476    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app2, <a class="code" href="app__meetme_8c.html#ac2605fd5ab063711c6927f212d325fb3" title="The MeetmeCount application.">count_exec</a>);
<a name="l06477"></a>06477    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app, <a class="code" href="app__meetme_8c.html#ab3d72f98849ba4b68853af4a26c82d7e" title="The meetme() application.">conf_exec</a>);
<a name="l06478"></a>06478    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(slastation_app, <a class="code" href="app__meetme_8c.html#a612f673b37381608ef31d1305baf6243">sla_station_exec</a>);
<a name="l06479"></a>06479    res |= <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(slatrunk_app, <a class="code" href="app__meetme_8c.html#a3fd96711c40675a2da40b5c625f6a1ab">sla_trunk_exec</a>);
<a name="l06480"></a>06480 
<a name="l06481"></a>06481    res |= <a class="code" href="devicestate_8h.html#ae832fcc32c88962e73025ffeafe2961e" title="Add device state provider.">ast_devstate_prov_add</a>(<span class="stringliteral">&quot;Meetme&quot;</span>, <a class="code" href="app__meetme_8c.html#a8fc3c28c0edf393e6f7a01f3e0865de6" title="Callback for devicestate providers.">meetmestate</a>);
<a name="l06482"></a>06482    res |= <a class="code" href="devicestate_8h.html#ae832fcc32c88962e73025ffeafe2961e" title="Add device state provider.">ast_devstate_prov_add</a>(<span class="stringliteral">&quot;SLA&quot;</span>, <a class="code" href="app__meetme_8c.html#ab2f6aeedfe3c63d7c493a1c849893d10">sla_state</a>);
<a name="l06483"></a>06483 
<a name="l06484"></a>06484    res |= <a class="code" href="pbx_8h.html#a8af0e93442a9e468425f63cc52b0ac7b" title="Register a custom function.">ast_custom_function_register</a>(&amp;meetme_info_acf);
<a name="l06485"></a>06485    <a class="code" href="config_8h.html#a403ec8b49645ea204e82cb72bb8cf9f4" title="Inform realtime what fields that may be stored.">ast_realtime_require_field</a>(<span class="stringliteral">&quot;meetme&quot;</span>, <span class="stringliteral">&quot;confno&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3a1ab15af464bf1838c9ca91d32ca7a2a1">RQ_UINTEGER2</a>, 3, <span class="stringliteral">&quot;members&quot;</span>, <a class="code" href="config_8h.html#abbca034b0a98715c687b808347af82a3ae8c94d6fa08e17f6f86792727b201bf9">RQ_UINTEGER1</a>, 3, NULL);
<a name="l06486"></a>06486 
<a name="l06487"></a>06487    <span class="keywordflow">return</span> res;
<a name="l06488"></a>06488 }
<a name="l06489"></a>06489 
<a name="l06490"></a><a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">06490</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l06491"></a>06491 {
<a name="l06492"></a>06492    <a class="code" href="config_8h.html#a66b6af9ceef39cb23b48501efe87219f" title="Release any resources cached for a realtime family.">ast_unload_realtime</a>(<span class="stringliteral">&quot;meetme&quot;</span>);
<a name="l06493"></a>06493    <span class="keywordflow">return</span> <a class="code" href="app__meetme_8c.html#ad0f6114d9cab58a8ec3d9555cb466534">load_config</a>(1);
<a name="l06494"></a>06494 }
<a name="l06495"></a>06495 
<a name="l06496"></a>06496 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;MeetMe conference bridge&quot;</span>,
<a name="l06497"></a>06497       .load = <a class="code" href="app__meetme_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l06498"></a>06498       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l06499"></a>06499       .<a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="app__meetme_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l06500"></a>06500           );
<a name="l06501"></a>06501 
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:25 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
