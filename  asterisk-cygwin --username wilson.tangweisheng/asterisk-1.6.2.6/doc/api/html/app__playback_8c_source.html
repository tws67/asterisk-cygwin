<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:26 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_7739c4bd2a7c382676c2c912043775c7.html">apps</a>
  </div>
</div>
<div class="contents">
<h1>app_playback.c</h1><a href="app__playback_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! \file</span>
<a name="l00020"></a>00020 <span class="comment"> *</span>
<a name="l00021"></a>00021 <span class="comment"> * \brief Trivial application to playback a sound file</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00024"></a>00024 <span class="comment"> * </span>
<a name="l00025"></a>00025 <span class="comment"> * \ingroup applications</span>
<a name="l00026"></a>00026 <span class="comment"> */</span>
<a name="l00027"></a>00027  
<a name="l00028"></a>00028 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00029"></a>00029 
<a name="l00030"></a>00030 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 220292 $&quot;</span>)
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &quot;asterisk/file.h&quot;</span>
<a name="l00033"></a>00033 <span class="preprocessor"></span><span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00034"></a>00034 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &quot;<a class="code" href="app_8h.html" title="Application convenience functions, designed to give consistent look and feel to Asterisk...">asterisk/app.h</a>&quot;</span>
<a name="l00036"></a>00036 <span class="comment">/* This file provides config-file based &apos;say&apos; functions, and implenents</span>
<a name="l00037"></a>00037 <span class="comment"> * some CLI commands.</span>
<a name="l00038"></a>00038 <span class="comment"> */</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="say_8h.html" title="Say numbers and dates (maybe words one day too).">asterisk/say.h</a>&quot;</span>  <span class="comment">/* provides config-file based &apos;say&apos; functions */</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <span class="comment">/*** DOCUMENTATION</span>
<a name="l00043"></a>00043 <span class="comment">   &lt;application name=&quot;Playback&quot; language=&quot;en_US&quot;&gt;</span>
<a name="l00044"></a>00044 <span class="comment">      &lt;synopsis&gt;</span>
<a name="l00045"></a>00045 <span class="comment">         Play a file.</span>
<a name="l00046"></a>00046 <span class="comment">      &lt;/synopsis&gt;</span>
<a name="l00047"></a>00047 <span class="comment">      &lt;syntax&gt;</span>
<a name="l00048"></a>00048 <span class="comment">         &lt;parameter name=&quot;filenames&quot; required=&quot;true&quot; argsep=&quot;&amp;amp;&quot;&gt;</span>
<a name="l00049"></a>00049 <span class="comment">            &lt;argument name=&quot;filename&quot; required=&quot;true&quot; /&gt;</span>
<a name="l00050"></a>00050 <span class="comment">            &lt;argument name=&quot;filename2&quot; multiple=&quot;true&quot; /&gt;</span>
<a name="l00051"></a>00051 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00052"></a>00052 <span class="comment">         &lt;parameter name=&quot;options&quot;&gt;</span>
<a name="l00053"></a>00053 <span class="comment">            &lt;para&gt;Comma separated list of options&lt;/para&gt;</span>
<a name="l00054"></a>00054 <span class="comment">            &lt;optionlist&gt;</span>
<a name="l00055"></a>00055 <span class="comment">               &lt;option name=&quot;skip&quot;&gt;</span>
<a name="l00056"></a>00056 <span class="comment">                  &lt;para&gt;Do not play if not answered&lt;/para&gt;</span>
<a name="l00057"></a>00057 <span class="comment">               &lt;/option&gt;</span>
<a name="l00058"></a>00058 <span class="comment">               &lt;option name=&quot;noanswer&quot;&gt;</span>
<a name="l00059"></a>00059 <span class="comment">                  &lt;para&gt;Playback without answering, otherwise the channel will</span>
<a name="l00060"></a>00060 <span class="comment">                  be answered before the sound is played.&lt;/para&gt;</span>
<a name="l00061"></a>00061 <span class="comment">                  &lt;note&gt;&lt;para&gt;Not all channel types support playing messages while still on hook.&lt;/para&gt;&lt;/note&gt;</span>
<a name="l00062"></a>00062 <span class="comment">               &lt;/option&gt;</span>
<a name="l00063"></a>00063 <span class="comment">            &lt;/optionlist&gt;</span>
<a name="l00064"></a>00064 <span class="comment">         &lt;/parameter&gt;</span>
<a name="l00065"></a>00065 <span class="comment">      &lt;/syntax&gt;</span>
<a name="l00066"></a>00066 <span class="comment">      &lt;description&gt;</span>
<a name="l00067"></a>00067 <span class="comment">         &lt;para&gt;Plays back given filenames (do not put extension of wav/alaw etc).</span>
<a name="l00068"></a>00068 <span class="comment">         The playback command answer the channel if no options are specified.</span>
<a name="l00069"></a>00069 <span class="comment">         If the file is non-existant it will fail&lt;/para&gt;</span>
<a name="l00070"></a>00070 <span class="comment">         &lt;para&gt;This application sets the following channel variable upon completion:&lt;/para&gt;</span>
<a name="l00071"></a>00071 <span class="comment">         &lt;variablelist&gt;</span>
<a name="l00072"></a>00072 <span class="comment">            &lt;variable name=&quot;PLAYBACKSTATUS&quot;&gt;</span>
<a name="l00073"></a>00073 <span class="comment">               &lt;para&gt;The status of the playback attempt as a text string.&lt;/para&gt;</span>
<a name="l00074"></a>00074 <span class="comment">               &lt;value name=&quot;SUCCESS&quot;/&gt;</span>
<a name="l00075"></a>00075 <span class="comment">               &lt;value name=&quot;FAILED&quot;/&gt;</span>
<a name="l00076"></a>00076 <span class="comment">            &lt;/variable&gt;</span>
<a name="l00077"></a>00077 <span class="comment">         &lt;/variablelist&gt;</span>
<a name="l00078"></a>00078 <span class="comment">         &lt;para&gt;See Also: Background (application) -- for playing sound files that are interruptible&lt;/para&gt;</span>
<a name="l00079"></a>00079 <span class="comment">         &lt;para&gt;WaitExten (application) -- wait for digits from caller, optionally play music on hold&lt;/para&gt;</span>
<a name="l00080"></a>00080 <span class="comment">      &lt;/description&gt;</span>
<a name="l00081"></a>00081 <span class="comment">   &lt;/application&gt;</span>
<a name="l00082"></a>00082 <span class="comment"> ***/</span>
<a name="l00083"></a>00083 
<a name="l00084"></a><a class="code" href="app__playback_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">00084</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a> = <span class="stringliteral">&quot;Playback&quot;</span>;
<a name="l00085"></a>00085 
<a name="l00086"></a><a class="code" href="app__playback_8c.html#a00db215c93eb1aa7f9e4b51f59e68eba">00086</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *<a class="code" href="app__playback_8c.html#a00db215c93eb1aa7f9e4b51f59e68eba">say_cfg</a> = NULL;
<a name="l00087"></a>00087 <span class="comment">/* save the say&apos; api calls.</span>
<a name="l00088"></a>00088 <span class="comment"> * The first entry is NULL if we have the standard source,</span>
<a name="l00089"></a>00089 <span class="comment"> * otherwise we are sourcing from here.</span>
<a name="l00090"></a>00090 <span class="comment"> * &apos;say load [new|old]&apos; will enable the new or old method, or report status</span>
<a name="l00091"></a>00091 <span class="comment"> */</span>
<a name="l00092"></a><a class="code" href="app__playback_8c.html#ad87ce02e0a497ed55df785bcc4b972d3">00092</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="app__playback_8c.html#ad87ce02e0a497ed55df785bcc4b972d3">say_api_buf</a>[40];
<a name="l00093"></a><a class="code" href="app__playback_8c.html#ac1fdae30c41c64607c24dfa52cec88cb">00093</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__playback_8c.html#ac1fdae30c41c64607c24dfa52cec88cb">say_old</a> = <span class="stringliteral">&quot;old&quot;</span>;
<a name="l00094"></a><a class="code" href="app__playback_8c.html#ac422ef546f76827faca5846e9c3c6af3">00094</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="app__playback_8c.html#ac422ef546f76827faca5846e9c3c6af3">say_new</a> = <span class="stringliteral">&quot;new&quot;</span>;
<a name="l00095"></a>00095 
<a name="l00096"></a><a class="code" href="app__playback_8c.html#a8be475b9fd73900c271c069a7a318308">00096</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__playback_8c.html#a8be475b9fd73900c271c069a7a318308">save_say_mode</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *arg)
<a name="l00097"></a>00097 {
<a name="l00098"></a>00098    <span class="keywordtype">int</span> i = 0;
<a name="l00099"></a>00099    say_api_buf[i++] = arg;
<a name="l00100"></a>00100 
<a name="l00101"></a>00101    say_api_buf[i++] = <a class="code" href="say_8h.html#af2f2a53bc36d82082a80daebac5d9d0f">ast_say_number_full</a>;
<a name="l00102"></a>00102    say_api_buf[i++] = <a class="code" href="say_8h.html#a68b1108079b31db9dbac0a14f94c7a2c">ast_say_enumeration_full</a>;
<a name="l00103"></a>00103    say_api_buf[i++] = <a class="code" href="say_8h.html#a921b263824a296812f264716e68ab129">ast_say_digit_str_full</a>;
<a name="l00104"></a>00104    say_api_buf[i++] = <a class="code" href="say_8h.html#ade1ca4dd1fef967c239d62fad0795332">ast_say_character_str_full</a>;
<a name="l00105"></a>00105    say_api_buf[i++] = <a class="code" href="say_8h.html#ae361dc17d977422a2fffcb661f8a9a09">ast_say_phonetic_str_full</a>;
<a name="l00106"></a>00106    say_api_buf[i++] = <a class="code" href="say_8h.html#ab193ffdcb257340fa6ac29f90847fb0e">ast_say_datetime</a>;
<a name="l00107"></a>00107    say_api_buf[i++] = <a class="code" href="say_8h.html#a8f8b5df12bf05242a5dfad6dd73065a7">ast_say_time</a>;
<a name="l00108"></a>00108    say_api_buf[i++] = <a class="code" href="say_8h.html#a521f1068d36ad21d7c67d28287d18aad">ast_say_date</a>;
<a name="l00109"></a>00109    say_api_buf[i++] = <a class="code" href="say_8h.html#a12cad12f2f7976bd156a5a1f469727db">ast_say_datetime_from_now</a>;
<a name="l00110"></a>00110    say_api_buf[i++] = <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a>;
<a name="l00111"></a>00111 }
<a name="l00112"></a>00112 
<a name="l00113"></a><a class="code" href="app__playback_8c.html#a4d43101464f79cf2a62c0c928893d386">00113</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="app__playback_8c.html#a4d43101464f79cf2a62c0c928893d386">restore_say_mode</a>(<span class="keywordtype">void</span> *arg)
<a name="l00114"></a>00114 {
<a name="l00115"></a>00115    <span class="keywordtype">int</span> i = 0;
<a name="l00116"></a>00116    say_api_buf[i++] = arg;
<a name="l00117"></a>00117 
<a name="l00118"></a>00118    <a class="code" href="say_8h.html#af2f2a53bc36d82082a80daebac5d9d0f">ast_say_number_full</a> = say_api_buf[i++];
<a name="l00119"></a>00119    <a class="code" href="say_8h.html#a68b1108079b31db9dbac0a14f94c7a2c">ast_say_enumeration_full</a> = say_api_buf[i++];
<a name="l00120"></a>00120    <a class="code" href="say_8h.html#a921b263824a296812f264716e68ab129">ast_say_digit_str_full</a> = say_api_buf[i++];
<a name="l00121"></a>00121    <a class="code" href="say_8h.html#ade1ca4dd1fef967c239d62fad0795332">ast_say_character_str_full</a> = say_api_buf[i++];
<a name="l00122"></a>00122    <a class="code" href="say_8h.html#ae361dc17d977422a2fffcb661f8a9a09">ast_say_phonetic_str_full</a> = say_api_buf[i++];
<a name="l00123"></a>00123    <a class="code" href="say_8h.html#ab193ffdcb257340fa6ac29f90847fb0e">ast_say_datetime</a> = say_api_buf[i++];
<a name="l00124"></a>00124    <a class="code" href="say_8h.html#a8f8b5df12bf05242a5dfad6dd73065a7">ast_say_time</a> = say_api_buf[i++];
<a name="l00125"></a>00125    <a class="code" href="say_8h.html#a521f1068d36ad21d7c67d28287d18aad">ast_say_date</a> = say_api_buf[i++];
<a name="l00126"></a>00126    <a class="code" href="say_8h.html#a12cad12f2f7976bd156a5a1f469727db">ast_say_datetime_from_now</a> = say_api_buf[i++];
<a name="l00127"></a>00127    <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a> = say_api_buf[i++];
<a name="l00128"></a>00128 }
<a name="l00129"></a>00129 
<a name="l00130"></a>00130 <span class="comment">/* </span>
<a name="l00131"></a>00131 <span class="comment"> * Typical &apos;say&apos; arguments in addition to the date or number or string</span>
<a name="l00132"></a>00132 <span class="comment"> * to say. We do not include &apos;options&apos; because they may be different</span>
<a name="l00133"></a>00133 <span class="comment"> * in recursive calls, and so they are better left as an external</span>
<a name="l00134"></a>00134 <span class="comment"> * parameter.</span>
<a name="l00135"></a>00135 <span class="comment"> */</span>
<a name="l00136"></a><a class="code" href="structsay__args__t.html">00136</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{
<a name="l00137"></a><a class="code" href="structsay__args__t.html#a84d1435c5b8d387806714ea7079304b7">00137</a>    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00138"></a><a class="code" href="structsay__args__t.html#aa9421ce0a5d16cd7ddccef77dac55c2b">00138</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints;
<a name="l00139"></a><a class="code" href="structsay__args__t.html#abe05eea72891a8769ef32d9f415eb66d">00139</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#adf416dc058363e2fd5750c77e2d78bee">language</a>;
<a name="l00140"></a><a class="code" href="structsay__args__t.html#a8f624ba1c143d0ae37a0a48eda80ae36">00140</a>    <span class="keywordtype">int</span> audiofd;
<a name="l00141"></a><a class="code" href="structsay__args__t.html#af22557938c5881eeb9023da5b3fe7989">00141</a>    <span class="keywordtype">int</span> ctrlfd;
<a name="l00142"></a>00142 } <a class="code" href="structsay__args__t.html">say_args_t</a>;
<a name="l00143"></a>00143 
<a name="l00144"></a><a class="code" href="app__playback_8c.html#a562694ff8095dc76bf5e0fbf793ca7f4">00144</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a562694ff8095dc76bf5e0fbf793ca7f4">s_streamwait3</a>(<span class="keyword">const</span> <a class="code" href="structsay__args__t.html">say_args_t</a> *a, <span class="keyword">const</span> <span class="keywordtype">char</span> *fn)
<a name="l00145"></a>00145 {
<a name="l00146"></a>00146    <span class="keywordtype">int</span> res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(a-&gt;<a class="code" href="structsay__args__t.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, fn, a-&gt;<a class="code" href="structsay__args__t.html#abe05eea72891a8769ef32d9f415eb66d">language</a>);
<a name="l00147"></a>00147    <span class="keywordflow">if</span> (res) {
<a name="l00148"></a>00148       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to play message %s\n&quot;</span>, fn);
<a name="l00149"></a>00149       <span class="keywordflow">return</span> res;
<a name="l00150"></a>00150    }
<a name="l00151"></a>00151    res = (a-&gt;<a class="code" href="structsay__args__t.html#a8f624ba1c143d0ae37a0a48eda80ae36">audiofd</a>  &gt; -1 &amp;&amp; a-&gt;<a class="code" href="structsay__args__t.html#af22557938c5881eeb9023da5b3fe7989">ctrlfd</a> &gt; -1) ?
<a name="l00152"></a>00152    <a class="code" href="file_8h.html#a3089874cd5223053f670c8499e911ec4">ast_waitstream_full</a>(a-&gt;<a class="code" href="structsay__args__t.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, a-&gt;<a class="code" href="structsay__args__t.html#aa9421ce0a5d16cd7ddccef77dac55c2b">ints</a>, a-&gt;<a class="code" href="structsay__args__t.html#a8f624ba1c143d0ae37a0a48eda80ae36">audiofd</a>, a-&gt;<a class="code" href="structsay__args__t.html#af22557938c5881eeb9023da5b3fe7989">ctrlfd</a>) :
<a name="l00153"></a>00153    <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(a-&gt;<a class="code" href="structsay__args__t.html#a84d1435c5b8d387806714ea7079304b7">chan</a>, a-&gt;<a class="code" href="structsay__args__t.html#aa9421ce0a5d16cd7ddccef77dac55c2b">ints</a>);
<a name="l00154"></a>00154    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(a-&gt;<a class="code" href="structsay__args__t.html#a84d1435c5b8d387806714ea7079304b7">chan</a>);
<a name="l00155"></a>00155    <span class="keywordflow">return</span> res;  
<a name="l00156"></a>00156 }
<a name="l00157"></a>00157 
<a name="l00158"></a>00158 <span class="comment">/*</span>
<a name="l00159"></a>00159 <span class="comment"> * the string is &apos;prefix:data&apos; or prefix:fmt:data&apos;</span>
<a name="l00160"></a>00160 <span class="comment"> * with &apos;:&apos; being invalid in strings.</span>
<a name="l00161"></a>00161 <span class="comment"> */</span>
<a name="l00162"></a><a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">00162</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(<a class="code" href="structsay__args__t.html">say_args_t</a> *a, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *options, <span class="keywordtype">int</span> depth)
<a name="l00163"></a>00163 {
<a name="l00164"></a>00164    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00165"></a>00165    <span class="keywordtype">char</span> *lang, *x, *<a class="code" href="structrule.html">rule</a> = NULL;
<a name="l00166"></a>00166    <span class="keywordtype">int</span> ret = 0;   
<a name="l00167"></a>00167    <span class="keyword">struct </span>varshead head = { .first = NULL, .last = NULL };
<a name="l00168"></a>00168    <span class="keyword">struct </span><a class="code" href="structast__var__t.html">ast_var_t</a> *n;
<a name="l00169"></a>00169 
<a name="l00170"></a>00170    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;string &lt;%s&gt; depth &lt;%d&gt;\n&quot;</span>, s, depth);
<a name="l00171"></a>00171    <span class="keywordflow">if</span> (depth++ &gt; 10) {
<a name="l00172"></a>00172       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;recursion too deep, exiting\n&quot;</span>);
<a name="l00173"></a>00173       <span class="keywordflow">return</span> -1;
<a name="l00174"></a>00174    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!say_cfg) {
<a name="l00175"></a>00175       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;no say.conf, cannot spell &apos;%s&apos;\n&quot;</span>, s);
<a name="l00176"></a>00176       <span class="keywordflow">return</span> -1;
<a name="l00177"></a>00177    }
<a name="l00178"></a>00178 
<a name="l00179"></a>00179    <span class="comment">/* scan languages same as in file.c */</span>
<a name="l00180"></a>00180    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structsay__args__t.html#abe05eea72891a8769ef32d9f415eb66d">language</a> == NULL)
<a name="l00181"></a>00181       a-&gt;<a class="code" href="structsay__args__t.html#abe05eea72891a8769ef32d9f415eb66d">language</a> = <span class="stringliteral">&quot;en&quot;</span>;     <span class="comment">/* default */</span>
<a name="l00182"></a>00182    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;try &lt;%s&gt; in &lt;%s&gt;\n&quot;</span>, s, a-&gt;<a class="code" href="structsay__args__t.html#abe05eea72891a8769ef32d9f415eb66d">language</a>);
<a name="l00183"></a>00183    lang = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(a-&gt;<a class="code" href="structsay__args__t.html#abe05eea72891a8769ef32d9f415eb66d">language</a>);
<a name="l00184"></a>00184    <span class="keywordflow">for</span> (;;) {
<a name="l00185"></a>00185       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(say_cfg, lang); v ; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00186"></a>00186          <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, s)) {
<a name="l00187"></a>00187             rule = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00188"></a>00188             <span class="keywordflow">break</span>;
<a name="l00189"></a>00189          }
<a name="l00190"></a>00190       }
<a name="l00191"></a>00191       <span class="keywordflow">if</span> (rule)
<a name="l00192"></a>00192          <span class="keywordflow">break</span>;
<a name="l00193"></a>00193       <span class="keywordflow">if</span> ( (x = strchr(lang, <span class="charliteral">&apos;_&apos;</span>)) )
<a name="l00194"></a>00194          *x = <span class="charliteral">&apos;\0&apos;</span>;      <span class="comment">/* try without suffix */</span>
<a name="l00195"></a>00195       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(lang, <span class="stringliteral">&quot;en&quot;</span>))
<a name="l00196"></a>00196          lang = <span class="stringliteral">&quot;en&quot;</span>;    <span class="comment">/* last resort, try &apos;en&apos; if not done yet */</span>
<a name="l00197"></a>00197       <span class="keywordflow">else</span>
<a name="l00198"></a>00198          <span class="keywordflow">break</span>;
<a name="l00199"></a>00199    }
<a name="l00200"></a>00200    <span class="keywordflow">if</span> (!rule)
<a name="l00201"></a>00201       <span class="keywordflow">return</span> 0;
<a name="l00202"></a>00202 
<a name="l00203"></a>00203    <span class="comment">/* skip up to two prefixes to get the value */</span>
<a name="l00204"></a>00204    <span class="keywordflow">if</span> ( (x = strchr(s, <span class="charliteral">&apos;:&apos;</span>)) )
<a name="l00205"></a>00205       s = x + 1;
<a name="l00206"></a>00206    <span class="keywordflow">if</span> ( (x = strchr(s, <span class="charliteral">&apos;:&apos;</span>)) )
<a name="l00207"></a>00207       s = x + 1;
<a name="l00208"></a>00208    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;value is &lt;%s&gt;\n&quot;</span>, s);
<a name="l00209"></a>00209    n = <a class="code" href="chanvars_8h.html#a8ea2b5a29fa275115c7ed27a593b727d">ast_var_assign</a>(<span class="stringliteral">&quot;SAY&quot;</span>, s);
<a name="l00210"></a>00210    <a class="code" href="linkedlists_8h.html#aa2ded2af046bb513f77056c27c083307" title="Inserts a list entry at the head of a list.">AST_LIST_INSERT_HEAD</a>(&amp;head, n, entries);
<a name="l00211"></a>00211 
<a name="l00212"></a>00212    <span class="comment">/* scan the body, one piece at a time */</span>
<a name="l00213"></a>00213    <span class="keywordflow">while</span> ( !ret &amp;&amp; (x = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;rule, <span class="stringliteral">&quot;,&quot;</span>)) ) { <span class="comment">/* exit on key */</span>
<a name="l00214"></a>00214       <span class="keywordtype">char</span> fn[128];
<a name="l00215"></a>00215       <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *fmt, *data; <span class="comment">/* format and data pointers */</span>
<a name="l00216"></a>00216 
<a name="l00217"></a>00217       <span class="comment">/* prepare a decent file name */</span>
<a name="l00218"></a>00218       x = <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(x);
<a name="l00219"></a>00219       <a class="code" href="strings_8h.html#ac5899ca9e586caf3041865762e770550" title="Trims trailing whitespace characters from a string.">ast_trim_blanks</a>(x);
<a name="l00220"></a>00220 
<a name="l00221"></a>00221       <span class="comment">/* replace variables */</span>
<a name="l00222"></a>00222       <a class="code" href="pbx_8h.html#a2b3355625306d4b98ca8047cd2245459">pbx_substitute_variables_varshead</a>(&amp;head, x, fn, <span class="keyword">sizeof</span>(fn));
<a name="l00223"></a>00223       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;doing [%s]\n&quot;</span>, fn);
<a name="l00224"></a>00224 
<a name="l00225"></a>00225       <span class="comment">/* locate prefix and data, if any */</span>
<a name="l00226"></a>00226       fmt = strchr(fn, <span class="charliteral">&apos;:&apos;</span>);
<a name="l00227"></a>00227       <span class="keywordflow">if</span> (!fmt || fmt == fn)  {  <span class="comment">/* regular filename */</span>
<a name="l00228"></a>00228          ret = <a class="code" href="app__playback_8c.html#a562694ff8095dc76bf5e0fbf793ca7f4">s_streamwait3</a>(a, fn);
<a name="l00229"></a>00229          <span class="keywordflow">continue</span>;
<a name="l00230"></a>00230       }
<a name="l00231"></a>00231       fmt++;
<a name="l00232"></a>00232       data = strchr(fmt, <span class="charliteral">&apos;:&apos;</span>);   <span class="comment">/* colon before data */</span>
<a name="l00233"></a>00233       <span class="keywordflow">if</span> (!data || data == fmt) {   <span class="comment">/* simple prefix-fmt */</span>
<a name="l00234"></a>00234          ret = <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(a, fn, options, depth);
<a name="l00235"></a>00235          <span class="keywordflow">continue</span>;
<a name="l00236"></a>00236       }
<a name="l00237"></a>00237       <span class="comment">/* prefix:fmt:data */</span>
<a name="l00238"></a>00238       <span class="keywordflow">for</span> (p = fmt; p &lt; data &amp;&amp; ret &lt;= 0; p++) {
<a name="l00239"></a>00239          <span class="keywordtype">char</span> fn2[<span class="keyword">sizeof</span>(fn)];
<a name="l00240"></a>00240          <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos; &apos;</span> || *p == <span class="charliteral">&apos;\t&apos;</span>)  <span class="comment">/* skip blanks */</span>
<a name="l00241"></a>00241             <span class="keywordflow">continue</span>;
<a name="l00242"></a>00242          <span class="keywordflow">if</span> (*p == <span class="charliteral">&apos;\&apos;&apos;</span>) {<span class="comment">/* file name - we trim them */</span>
<a name="l00243"></a>00243             <span class="keywordtype">char</span> *y;
<a name="l00244"></a>00244             strcpy(fn2, <a class="code" href="strings_8h.html#aba29020090d7b4238027c5746e7ad722" title="Gets a pointer to the first non-whitespace character in a string.">ast_skip_blanks</a>(p+1));  <span class="comment">/* make a full copy */</span>
<a name="l00245"></a>00245             y = strchr(fn2, <span class="charliteral">&apos;\&apos;&apos;</span>);
<a name="l00246"></a>00246             <span class="keywordflow">if</span> (!y) {
<a name="l00247"></a>00247                p = data;   <span class="comment">/* invalid. prepare to end */</span>
<a name="l00248"></a>00248                <span class="keywordflow">break</span>;
<a name="l00249"></a>00249             }
<a name="l00250"></a>00250             *y = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00251"></a>00251             <a class="code" href="strings_8h.html#ac5899ca9e586caf3041865762e770550" title="Trims trailing whitespace characters from a string.">ast_trim_blanks</a>(fn2);
<a name="l00252"></a>00252             p = strchr(p+1, <span class="charliteral">&apos;\&apos;&apos;</span>);
<a name="l00253"></a>00253             ret = <a class="code" href="app__playback_8c.html#a562694ff8095dc76bf5e0fbf793ca7f4">s_streamwait3</a>(a, fn2);
<a name="l00254"></a>00254          } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255             <span class="keywordtype">int</span> l = fmt-fn;
<a name="l00256"></a>00256             strcpy(fn2, fn); <span class="comment">/* copy everything */</span>
<a name="l00257"></a>00257             <span class="comment">/* after prefix, append the format */</span>
<a name="l00258"></a>00258             fn2[l++] = *p;
<a name="l00259"></a>00259             strcpy(fn2 + l, data);
<a name="l00260"></a>00260             ret = <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(a, fn2, options, depth);
<a name="l00261"></a>00261          }
<a name="l00262"></a>00262          
<a name="l00263"></a>00263          <span class="keywordflow">if</span> (ret) {
<a name="l00264"></a>00264             <span class="keywordflow">break</span>;
<a name="l00265"></a>00265          }
<a name="l00266"></a>00266       }
<a name="l00267"></a>00267    }
<a name="l00268"></a>00268    <a class="code" href="chanvars_8h.html#a52aaa758ed30031250c2d356b993c6d9">ast_var_delete</a>(n);
<a name="l00269"></a>00269    <span class="keywordflow">return</span> ret;
<a name="l00270"></a>00270 }
<a name="l00271"></a>00271 
<a name="l00272"></a><a class="code" href="app__playback_8c.html#a84469020cae65519918b98fcb0c24ed0">00272</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a84469020cae65519918b98fcb0c24ed0">say_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *<span class="keywordtype">string</span>,
<a name="l00273"></a>00273    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keyword">const</span> <span class="keywordtype">char</span> *options,
<a name="l00274"></a>00274    <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)
<a name="l00275"></a>00275 {
<a name="l00276"></a>00276    <a class="code" href="structsay__args__t.html">say_args_t</a> a = { chan, ints, lang, audiofd, ctrlfd };
<a name="l00277"></a>00277    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(&amp;a, <span class="keywordtype">string</span>, options, 0);
<a name="l00278"></a>00278 }
<a name="l00279"></a>00279 
<a name="l00280"></a><a class="code" href="app__playback_8c.html#a940430bfe74dee70aa34b1928f77ad28">00280</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a940430bfe74dee70aa34b1928f77ad28">say_number_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>,
<a name="l00281"></a>00281    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keyword">const</span> <span class="keywordtype">char</span> *options,
<a name="l00282"></a>00282    <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)
<a name="l00283"></a>00283 {
<a name="l00284"></a>00284    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[64];
<a name="l00285"></a>00285    <a class="code" href="structsay__args__t.html">say_args_t</a> a = { chan, ints, lang, audiofd, ctrlfd };
<a name="l00286"></a>00286    snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;num:%d&quot;</span>, num);
<a name="l00287"></a>00287    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(&amp;a, buf, options, 0);
<a name="l00288"></a>00288 }
<a name="l00289"></a>00289 
<a name="l00290"></a><a class="code" href="app__playback_8c.html#a7a78284c56c3590ffca9feba4d76de5b">00290</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a7a78284c56c3590ffca9feba4d76de5b">say_enumeration_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>,
<a name="l00291"></a>00291    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keyword">const</span> <span class="keywordtype">char</span> *options,
<a name="l00292"></a>00292    <span class="keywordtype">int</span> audiofd, <span class="keywordtype">int</span> ctrlfd)
<a name="l00293"></a>00293 {
<a name="l00294"></a>00294    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[64];
<a name="l00295"></a>00295    <a class="code" href="structsay__args__t.html">say_args_t</a> a = { chan, ints, lang, audiofd, ctrlfd };
<a name="l00296"></a>00296    snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;enum:%d&quot;</span>, num);
<a name="l00297"></a>00297    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(&amp;a, buf, options, 0);
<a name="l00298"></a>00298 }
<a name="l00299"></a>00299 
<a name="l00300"></a><a class="code" href="app__playback_8c.html#a52393c76d7453ad2fe2eb839e7ca209b">00300</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a52393c76d7453ad2fe2eb839e7ca209b">say_date_generic</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, time_t t,
<a name="l00301"></a>00301    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *timezonename, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="http_8c.html#a6f25bc812d09fedb86bf394c01061c56">prefix</a>)
<a name="l00302"></a>00302 {
<a name="l00303"></a>00303    <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[128];
<a name="l00304"></a>00304    <span class="keyword">struct </span><a class="code" href="structast__tm.html">ast_tm</a> tm;
<a name="l00305"></a>00305    <span class="keyword">struct </span>timeval when = { t, 0 };
<a name="l00306"></a>00306    <a class="code" href="structsay__args__t.html">say_args_t</a> a = { chan, ints, lang, -1, -1 };
<a name="l00307"></a>00307    <span class="keywordflow">if</span> (format == NULL)
<a name="l00308"></a>00308       format = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00309"></a>00309 
<a name="l00310"></a>00310    <a class="code" href="localtime_8h.html#ae9fbda728350a9a5b9c09b29214d718e" title="Timezone-independent version of localtime_r(3).">ast_localtime</a>(&amp;when, &amp;tm, NULL);
<a name="l00311"></a>00311    snprintf(buf, <span class="keyword">sizeof</span>(buf), <span class="stringliteral">&quot;%s:%s:%04d%02d%02d%02d%02d.%02d-%d-%3d&quot;</span>,
<a name="l00312"></a>00312       prefix,
<a name="l00313"></a>00313       format,
<a name="l00314"></a>00314       tm.<a class="code" href="structast__tm.html#a994c4f4519ba57e186580d21cc86f9e5">tm_year</a>+1900,
<a name="l00315"></a>00315       tm.<a class="code" href="structast__tm.html#ada983deda100b604bee5716512453658">tm_mon</a>+1,
<a name="l00316"></a>00316       tm.<a class="code" href="structast__tm.html#a02048604d30b880033311cf542d63f92">tm_mday</a>,
<a name="l00317"></a>00317       tm.<a class="code" href="structast__tm.html#a4d171061df9e012fcfbd1172b8440d5f">tm_hour</a>,
<a name="l00318"></a>00318       tm.<a class="code" href="structast__tm.html#a987fa9280fe4cd6c6b8f77409f1c1504">tm_min</a>,
<a name="l00319"></a>00319       tm.<a class="code" href="structast__tm.html#a18df301c1a10c8d493da86ce5c2aea78">tm_sec</a>,
<a name="l00320"></a>00320       tm.<a class="code" href="structast__tm.html#a4412571b90746a85cae9b8841c44c59c">tm_wday</a>,
<a name="l00321"></a>00321       tm.<a class="code" href="structast__tm.html#a74938de584345413d1bf87c4d78d697c">tm_yday</a>);
<a name="l00322"></a>00322    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#aaa788b292f1d22ed01b7fe7496667164">do_say</a>(&amp;a, buf, NULL, 0);
<a name="l00323"></a>00323 }
<a name="l00324"></a>00324 
<a name="l00325"></a><a class="code" href="app__playback_8c.html#a6ef7fdae72847e7cb95fe71b3a674cde">00325</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a6ef7fdae72847e7cb95fe71b3a674cde">say_date_with_format</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, time_t t,
<a name="l00326"></a>00326    <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keyword">const</span> <span class="keywordtype">char</span> *timezonename)
<a name="l00327"></a>00327 {
<a name="l00328"></a>00328    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#a52393c76d7453ad2fe2eb839e7ca209b">say_date_generic</a>(chan, t, ints, lang, format, timezonename, <span class="stringliteral">&quot;datetime&quot;</span>);
<a name="l00329"></a>00329 }
<a name="l00330"></a>00330 
<a name="l00331"></a><a class="code" href="app__playback_8c.html#ae1701ebeea69d48d0e1e1de3759a4c12">00331</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#ae1701ebeea69d48d0e1e1de3759a4c12">say_date</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, time_t t, <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l00332"></a>00332 {
<a name="l00333"></a>00333    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#a52393c76d7453ad2fe2eb839e7ca209b">say_date_generic</a>(chan, t, ints, lang, <span class="stringliteral">&quot;&quot;</span>, NULL, <span class="stringliteral">&quot;date&quot;</span>);
<a name="l00334"></a>00334 }
<a name="l00335"></a>00335 
<a name="l00336"></a><a class="code" href="app__playback_8c.html#a2679ac199e3858d447f6b0dc998e7263">00336</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a2679ac199e3858d447f6b0dc998e7263">say_time</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, time_t t, <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l00337"></a>00337 {
<a name="l00338"></a>00338    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#a52393c76d7453ad2fe2eb839e7ca209b">say_date_generic</a>(chan, t, ints, lang, <span class="stringliteral">&quot;&quot;</span>, NULL, <span class="stringliteral">&quot;time&quot;</span>);
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="app__playback_8c.html#ac420adeb9078de529048f5770187c3d1">00341</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#ac420adeb9078de529048f5770187c3d1">say_datetime</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, time_t t, <span class="keyword">const</span> <span class="keywordtype">char</span> *ints, <span class="keyword">const</span> <span class="keywordtype">char</span> *lang)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343    <span class="keywordflow">return</span> <a class="code" href="app__playback_8c.html#a52393c76d7453ad2fe2eb839e7ca209b">say_date_generic</a>(chan, t, ints, lang, <span class="stringliteral">&quot;&quot;</span>, NULL, <span class="stringliteral">&quot;datetime&quot;</span>);
<a name="l00344"></a>00344 }
<a name="l00345"></a>00345 
<a name="l00346"></a>00346 <span class="comment">/*</span>
<a name="l00347"></a>00347 <span class="comment"> * remap the &apos;say&apos; functions to use those in this file</span>
<a name="l00348"></a>00348 <span class="comment"> */</span>
<a name="l00349"></a><a class="code" href="app__playback_8c.html#aeb55de9af410fac7899bbb9f8d2adabb">00349</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#aeb55de9af410fac7899bbb9f8d2adabb">say_init_mode</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *mode) {
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (!strcmp(mode, say_new)) {
<a name="l00351"></a>00351       <span class="keywordflow">if</span> (say_cfg == NULL) {
<a name="l00352"></a>00352          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;There is no say.conf file to use new mode\n&quot;</span>);
<a name="l00353"></a>00353          <span class="keywordflow">return</span> -1;
<a name="l00354"></a>00354       }
<a name="l00355"></a>00355       <a class="code" href="app__playback_8c.html#a8be475b9fd73900c271c069a7a318308">save_say_mode</a>(say_new);
<a name="l00356"></a>00356       <a class="code" href="say_8h.html#af2f2a53bc36d82082a80daebac5d9d0f">ast_say_number_full</a> = <a class="code" href="app__playback_8c.html#a940430bfe74dee70aa34b1928f77ad28">say_number_full</a>;
<a name="l00357"></a>00357 
<a name="l00358"></a>00358       <a class="code" href="say_8h.html#a68b1108079b31db9dbac0a14f94c7a2c">ast_say_enumeration_full</a> = <a class="code" href="app__playback_8c.html#a7a78284c56c3590ffca9feba4d76de5b">say_enumeration_full</a>;
<a name="l00359"></a>00359 <span class="preprocessor">#if 0</span>
<a name="l00360"></a>00360 <span class="preprocessor"></span>      <a class="code" href="say_8h.html#ac293bae3a692080477911e637dbf3463">ast_say_digits_full</a> = say_digits_full;
<a name="l00361"></a>00361       <a class="code" href="say_8h.html#a921b263824a296812f264716e68ab129">ast_say_digit_str_full</a> = <a class="code" href="say_8c.html#a315074228d9a507cf937510e06d6d356">say_digit_str_full</a>;
<a name="l00362"></a>00362       <a class="code" href="say_8h.html#ade1ca4dd1fef967c239d62fad0795332">ast_say_character_str_full</a> = <a class="code" href="say_8c.html#a28a689ee86ec09fa0858691834d9383c">say_character_str_full</a>;
<a name="l00363"></a>00363       <a class="code" href="say_8h.html#ae361dc17d977422a2fffcb661f8a9a09">ast_say_phonetic_str_full</a> = <a class="code" href="say_8c.html#a359f06f26a33e5cde0df7f979b14078a">say_phonetic_str_full</a>;
<a name="l00364"></a>00364       <a class="code" href="say_8h.html#a12cad12f2f7976bd156a5a1f469727db">ast_say_datetime_from_now</a> = <a class="code" href="say_8c.html#a24f03c61981a21ba6ea1d19de28c75da">say_datetime_from_now</a>;
<a name="l00365"></a>00365 <span class="preprocessor">#endif</span>
<a name="l00366"></a>00366 <span class="preprocessor"></span>      <a class="code" href="say_8h.html#ab193ffdcb257340fa6ac29f90847fb0e">ast_say_datetime</a> = <a class="code" href="app__playback_8c.html#ac420adeb9078de529048f5770187c3d1">say_datetime</a>;
<a name="l00367"></a>00367       <a class="code" href="say_8h.html#a8f8b5df12bf05242a5dfad6dd73065a7">ast_say_time</a> = <a class="code" href="app__playback_8c.html#a2679ac199e3858d447f6b0dc998e7263">say_time</a>;
<a name="l00368"></a>00368       <a class="code" href="say_8h.html#a521f1068d36ad21d7c67d28287d18aad">ast_say_date</a> = <a class="code" href="app__playback_8c.html#ae1701ebeea69d48d0e1e1de3759a4c12">say_date</a>;
<a name="l00369"></a>00369       <a class="code" href="say_8h.html#aeb81fb9f912659f3e8de0d7d931eb372">ast_say_date_with_format</a> = <a class="code" href="app__playback_8c.html#a6ef7fdae72847e7cb95fe71b3a674cde">say_date_with_format</a>;
<a name="l00370"></a>00370    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(mode, say_old) &amp;&amp; say_api_buf[0] == say_new) {
<a name="l00371"></a>00371       <a class="code" href="app__playback_8c.html#a4d43101464f79cf2a62c0c928893d386">restore_say_mode</a>(NULL);
<a name="l00372"></a>00372    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (strcmp(mode, say_old)) {
<a name="l00373"></a>00373       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;unrecognized mode %s\n&quot;</span>, mode);
<a name="l00374"></a>00374       <span class="keywordflow">return</span> -1;
<a name="l00375"></a>00375    }
<a name="l00376"></a>00376    
<a name="l00377"></a>00377    <span class="keywordflow">return</span> 0;
<a name="l00378"></a>00378 }
<a name="l00379"></a>00379 
<a name="l00380"></a><a class="code" href="app__playback_8c.html#ac2b75f313b6d508da80855035e2cc996">00380</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="app__playback_8c.html#ac2b75f313b6d508da80855035e2cc996">__say_cli_init</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l00381"></a>00381 {
<a name="l00382"></a>00382    <span class="keyword">const</span> <span class="keywordtype">char</span> *old_mode = say_api_buf[0] ? say_new : say_old;
<a name="l00383"></a>00383    <span class="keywordtype">char</span> *mode;
<a name="l00384"></a>00384    <span class="keywordflow">switch</span> (cmd) {
<a name="l00385"></a>00385    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l00386"></a>00386       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;say load [new|old]&quot;</span>;
<a name="l00387"></a>00387       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> = 
<a name="l00388"></a>00388          <span class="stringliteral">&quot;Usage: say load [new|old]\n&quot;</span>
<a name="l00389"></a>00389          <span class="stringliteral">&quot;       say load\n&quot;</span>
<a name="l00390"></a>00390          <span class="stringliteral">&quot;           Report status of current say mode\n&quot;</span>
<a name="l00391"></a>00391          <span class="stringliteral">&quot;       say load new\n&quot;</span>
<a name="l00392"></a>00392          <span class="stringliteral">&quot;           Set say method, configured in say.conf\n&quot;</span>
<a name="l00393"></a>00393          <span class="stringliteral">&quot;       say load old\n&quot;</span>
<a name="l00394"></a>00394          <span class="stringliteral">&quot;           Set old say method, coded in asterisk core\n&quot;</span>;
<a name="l00395"></a>00395       <span class="keywordflow">return</span> NULL;
<a name="l00396"></a>00396    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l00397"></a>00397       <span class="keywordflow">return</span> NULL;
<a name="l00398"></a>00398    }
<a name="l00399"></a>00399    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == 2) {
<a name="l00400"></a>00400       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;say mode is [%s]\n&quot;</span>, old_mode);
<a name="l00401"></a>00401       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00402"></a>00402    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l00403"></a>00403       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l00404"></a>00404    mode = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[2];
<a name="l00405"></a>00405    <span class="keywordflow">if</span> (!strcmp(mode, old_mode))
<a name="l00406"></a>00406       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;say mode is %s already\n&quot;</span>, mode);
<a name="l00407"></a>00407    <span class="keywordflow">else</span>
<a name="l00408"></a>00408       <span class="keywordflow">if</span> (<a class="code" href="app__playback_8c.html#aeb55de9af410fac7899bbb9f8d2adabb">say_init_mode</a>(mode) == 0)
<a name="l00409"></a>00409          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;setting say mode from %s to %s\n&quot;</span>, old_mode, mode);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00414"></a><a class="code" href="app__playback_8c.html#aa5bc05f709f05f5e07f1aaaa2e530b9d">00414</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="app__playback_8c.html#aa5bc05f709f05f5e07f1aaaa2e530b9d">cli_playback</a>[] = {
<a name="l00415"></a>00415    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="app__playback_8c.html#ac2b75f313b6d508da80855035e2cc996">__say_cli_init</a>, <span class="stringliteral">&quot;Set or show the say mode&quot;</span>),
<a name="l00416"></a>00416 };
<a name="l00417"></a>00417 
<a name="l00418"></a><a class="code" href="app__playback_8c.html#a9321dd7386df094f22773a409d1926de">00418</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#a9321dd7386df094f22773a409d1926de">playback_exec</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">void</span> *data)
<a name="l00419"></a>00419 {
<a name="l00420"></a>00420    <span class="keywordtype">int</span> res = 0;
<a name="l00421"></a>00421    <span class="keywordtype">int</span> mres = 0;
<a name="l00422"></a>00422    <span class="keywordtype">char</span> *tmp;
<a name="l00423"></a>00423    <span class="keywordtype">int</span> option_skip=0;
<a name="l00424"></a>00424    <span class="keywordtype">int</span> option_say=0;
<a name="l00425"></a>00425    <span class="keywordtype">int</span> option_noanswer = 0;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    <a class="code" href="app_8h.html#a80cd3f6f786b59b742bcecfc0b3be7c2" title="Declare a structure to hold an application&amp;#39;s arguments.">AST_DECLARE_APP_ARGS</a>(<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>,
<a name="l00428"></a>00428       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(filenames);
<a name="l00429"></a>00429       <a class="code" href="app_8h.html#a037e9a5b28477b17e7c9acbe7ecb21d5" title="Define an application argument.">AST_APP_ARG</a>(options);
<a name="l00430"></a>00430    );
<a name="l00431"></a>00431    
<a name="l00432"></a>00432    <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(data)) {
<a name="l00433"></a>00433       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Playback requires an argument (filename)\n&quot;</span>);
<a name="l00434"></a>00434       <span class="keywordflow">return</span> -1;
<a name="l00435"></a>00435    }
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    tmp = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(data);
<a name="l00438"></a>00438    <a class="code" href="app_8h.html#ac08f7eb1eb9476b30987c73e1052ada8" title="Performs the &amp;#39;standard&amp;#39; argument separation process for an application.">AST_STANDARD_APP_ARGS</a>(<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>, tmp);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <span class="keywordflow">if</span> (<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>.options) {
<a name="l00441"></a>00441       <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>.options, <span class="stringliteral">&quot;skip&quot;</span>))
<a name="l00442"></a>00442          option_skip = 1;
<a name="l00443"></a>00443       <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>.options, <span class="stringliteral">&quot;say&quot;</span>))
<a name="l00444"></a>00444          option_say = 1;
<a name="l00445"></a>00445       <span class="keywordflow">if</span> (<a class="code" href="agi_2strcompat_8c.html#ae9229017a4501f8d6a637b4498cfed2e">strcasestr</a>(<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>.options, <span class="stringliteral">&quot;noanswer&quot;</span>))
<a name="l00446"></a>00446          option_noanswer = 1;
<a name="l00447"></a>00447    } 
<a name="l00448"></a>00448    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#abc7d0b575ffea0b65ce604e0e4c99d3d">_state</a> != <a class="code" href="channel_8h.html#a03585bc87e5bbd0f4d11bc789734c660aa8ab4bcda7378ccc17c39dfd880cba3d">AST_STATE_UP</a>) {
<a name="l00449"></a>00449       <span class="keywordflow">if</span> (option_skip) {
<a name="l00450"></a>00450          <span class="comment">/* At the user&apos;s option, skip if the line is not up */</span>
<a name="l00451"></a>00451          <span class="keywordflow">goto</span> done;
<a name="l00452"></a>00452       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!option_noanswer) {
<a name="l00453"></a>00453          <span class="comment">/* Otherwise answer unless we&apos;re supposed to send this while on-hook */</span>
<a name="l00454"></a>00454          res = <a class="code" href="channel_8h.html#aec583a3e25358ee552a4f3df53914cd0" title="Answer a channel.">ast_answer</a>(chan);
<a name="l00455"></a>00455       }
<a name="l00456"></a>00456    }
<a name="l00457"></a>00457    <span class="keywordflow">if</span> (!res) {
<a name="l00458"></a>00458       <span class="keywordtype">char</span> *back = <a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>.filenames;
<a name="l00459"></a>00459       <span class="keywordtype">char</span> *front;
<a name="l00460"></a>00460 
<a name="l00461"></a>00461       <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00462"></a>00462       <span class="keywordflow">while</span> (!res &amp;&amp; (front = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;back, <span class="stringliteral">&quot;&amp;&quot;</span>))) {
<a name="l00463"></a>00463          <span class="keywordflow">if</span> (option_say)
<a name="l00464"></a>00464             res = <a class="code" href="app__playback_8c.html#a84469020cae65519918b98fcb0c24ed0">say_full</a>(chan, front, <span class="stringliteral">&quot;&quot;</span>, chan-&gt;language, NULL, -1, -1);
<a name="l00465"></a>00465          <span class="keywordflow">else</span>
<a name="l00466"></a>00466             res = <a class="code" href="file_8h.html#a67c7e271b4ca70aca6d48fd48d121857" title="Streams a file.">ast_streamfile</a>(chan, front, chan-&gt;language);
<a name="l00467"></a>00467          <span class="keywordflow">if</span> (!res) { 
<a name="l00468"></a>00468             res = <a class="code" href="file_8h.html#affc21cb57c6bf72a2cb7ec8a379b2137" title="Waits for a stream to stop or digit to be pressed.">ast_waitstream</a>(chan, <span class="stringliteral">&quot;&quot;</span>);  
<a name="l00469"></a>00469             <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00470"></a>00470          } <span class="keywordflow">else</span> {
<a name="l00471"></a>00471             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ast_streamfile failed on %s for %s\n&quot;</span>, chan-&gt;name, (<span class="keywordtype">char</span> *)data);
<a name="l00472"></a>00472             res = 0;
<a name="l00473"></a>00473             mres = 1;
<a name="l00474"></a>00474          }
<a name="l00475"></a>00475       }
<a name="l00476"></a>00476    }
<a name="l00477"></a>00477 done:
<a name="l00478"></a>00478    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;PLAYBACKSTATUS&quot;</span>, mres ? <span class="stringliteral">&quot;FAILED&quot;</span> : <span class="stringliteral">&quot;SUCCESS&quot;</span>);
<a name="l00479"></a>00479    <span class="keywordflow">return</span> res;
<a name="l00480"></a>00480 }
<a name="l00481"></a>00481 
<a name="l00482"></a><a class="code" href="app__playback_8c.html#ad1982509765f4870f1f63412a53ea668">00482</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l00483"></a>00483 {
<a name="l00484"></a>00484    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00485"></a>00485    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> };
<a name="l00486"></a>00486    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *newcfg;
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    <span class="keywordflow">if</span> ((newcfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;say.conf&quot;</span>, config_flags)) == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a>) {
<a name="l00489"></a>00489       <span class="keywordflow">return</span> 0;
<a name="l00490"></a>00490    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (newcfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00491"></a>00491       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Config file say.conf is in an invalid format.  Aborting.\n&quot;</span>);
<a name="l00492"></a>00492       <span class="keywordflow">return</span> 0;
<a name="l00493"></a>00493    }
<a name="l00494"></a>00494 
<a name="l00495"></a>00495    <span class="keywordflow">if</span> (say_cfg) {
<a name="l00496"></a>00496       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(say_cfg);
<a name="l00497"></a>00497       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Reloading say.conf\n&quot;</span>);
<a name="l00498"></a>00498       say_cfg = newcfg;
<a name="l00499"></a>00499    }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501    <span class="keywordflow">if</span> (say_cfg) {
<a name="l00502"></a>00502       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(say_cfg, <span class="stringliteral">&quot;general&quot;</span>); v ; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00503"></a>00503             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mode&quot;</span>)) {
<a name="l00504"></a>00504             <a class="code" href="app__playback_8c.html#aeb55de9af410fac7899bbb9f8d2adabb">say_init_mode</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00505"></a>00505             <span class="keywordflow">break</span>;
<a name="l00506"></a>00506          }
<a name="l00507"></a>00507       }
<a name="l00508"></a>00508    }
<a name="l00509"></a>00509    
<a name="l00510"></a>00510    <span class="comment">/*</span>
<a name="l00511"></a>00511 <span class="comment">    * XXX here we should sort rules according to the same order</span>
<a name="l00512"></a>00512 <span class="comment">    * we have in pbx.c so we have the same matching behaviour.</span>
<a name="l00513"></a>00513 <span class="comment">    */</span>
<a name="l00514"></a>00514    <span class="keywordflow">return</span> 0;
<a name="l00515"></a>00515 }
<a name="l00516"></a>00516 
<a name="l00517"></a><a class="code" href="app__playback_8c.html#ad09fa931f468002152a3cc2d5ce25eae">00517</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l00518"></a>00518 {
<a name="l00519"></a>00519    <span class="keywordtype">int</span> res;
<a name="l00520"></a>00520 
<a name="l00521"></a>00521    res = <a class="code" href="module_8h.html#ad2ca15621101154f29748cf1dac3c3cf" title="Unregister an application.">ast_unregister_application</a>(app);
<a name="l00522"></a>00522 
<a name="l00523"></a>00523    <a class="code" href="cli_8h.html#a56b6b59ee2eaa994597a5b0f4e9f9d09" title="Unregister multiple commands.">ast_cli_unregister_multiple</a>(cli_playback, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_playback));
<a name="l00524"></a>00524 
<a name="l00525"></a>00525    <span class="keywordflow">if</span> (say_cfg)
<a name="l00526"></a>00526       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(say_cfg);
<a name="l00527"></a>00527 
<a name="l00528"></a>00528    <span class="keywordflow">return</span> res; 
<a name="l00529"></a>00529 }
<a name="l00530"></a>00530 
<a name="l00531"></a><a class="code" href="app__playback_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">00531</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="app__playback_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l00532"></a>00532 {
<a name="l00533"></a>00533    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l00534"></a>00534    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { 0 };
<a name="l00535"></a>00535 
<a name="l00536"></a>00536    say_cfg = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;say.conf&quot;</span>, config_flags);
<a name="l00537"></a>00537    <span class="keywordflow">if</span> (say_cfg &amp;&amp; say_cfg != <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l00538"></a>00538       <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(say_cfg, <span class="stringliteral">&quot;general&quot;</span>); v ; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l00539"></a>00539             <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;mode&quot;</span>)) {
<a name="l00540"></a>00540             <a class="code" href="app__playback_8c.html#aeb55de9af410fac7899bbb9f8d2adabb">say_init_mode</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l00541"></a>00541             <span class="keywordflow">break</span>;
<a name="l00542"></a>00542          }
<a name="l00543"></a>00543       }
<a name="l00544"></a>00544    }
<a name="l00545"></a>00545 
<a name="l00546"></a>00546    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_playback, <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(cli_playback));
<a name="l00547"></a>00547    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#afba4eb7a910b10969041ae4cd488729d" title="Register an application using XML documentation.">ast_register_application_xml</a>(app, <a class="code" href="app__playback_8c.html#a9321dd7386df094f22773a409d1926de">playback_exec</a>);
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a>00550 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;Sound File Playback Application&quot;</span>,
<a name="l00551"></a>00551       .load = <a class="code" href="app__playback_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l00552"></a>00552       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l00553"></a>00553       .<a class="code" href="app__playback_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="app__playback_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l00554"></a>00554           );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:26 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
