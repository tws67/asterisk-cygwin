<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:22:53 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_6ae6169cd48d88136f0d813c029ee18c.html">pbx</a>
  </div>
</div>
<div class="contents">
<h1>pbx_lua.c File Reference</h1>
<p>Lua PBX Switch.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="asterisk_8h_source.html">asterisk.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="logger_8h_source.html">asterisk/logger.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="channel_8h_source.html">asterisk/channel.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="pbx_8h_source.html">asterisk/pbx.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="module_8h_source.html">asterisk/module.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="cli_8h_source.html">asterisk/cli.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="utils_8h_source.html">asterisk/utils.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="term_8h_source.html">asterisk/term.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="paths_8h_source.html">asterisk/paths.h</a>&quot;</code><br/>
<code>#include &quot;<a class="el" href="hashtab_8h_source.html">asterisk/hashtab.h</a>&quot;</code><br/>
<code>#include &lt;lua.h&gt;</code><br/>
<code>#include &lt;lauxlib.h&gt;</code><br/>
<code>#include &lt;lualib.h&gt;</code><br/>

<p><a href="pbx__lua_8c_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Defines</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a599a30638feeaa8bece87a6f4eb4bae1">LUA_BUF_SIZE</a>&nbsp;&nbsp;&nbsp;4096</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">#define&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a8f0cf0337474a0b28ed30ab13f729f80">LUA_EXT_DATA_SIZE</a>&nbsp;&nbsp;&nbsp;256</td></tr>
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a88b7c88fed6b80fd18f34f97757dfc04">__reg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#afeab1257bd17282b95875499393a147a">__unreg_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a161611b39a822c50ab75c350a69eedd2">canmatch</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, int priority, const char *callerid, const char *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a0ea9753b753253d4c74b215c6d290e52">exec</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, int priority, const char *callerid, const char *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#af22e601a6d901abccea13ee3cc3fc1ff">exists</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, int priority, const char *callerid, const char *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a0cd4a8176fed2b7bfae5c20d088a16ad">load_or_reload_lua_stuff</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a6a4cd826d657c3b3e9b478737b0a5156">lua_autoservice_start</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Tell pbx_lua to maintain an autoservice on this channel (for access from lua, don't call directly)  <a href="#a6a4cd826d657c3b3e9b478737b0a5156"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a0b737399142ce1ebed5c05e95be06905">lua_autoservice_status</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Get the status of the autoservice flag (for access from lua, don't call directly)  <a href="#a0b737399142ce1ebed5c05e95be06905"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a85180f91f6455d854f4c64f14293a3c5">lua_autoservice_stop</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Tell pbx_lua to stop maintaning an autoservice on this channel (for access from lua, don't call directly)  <a href="#a85180f91f6455d854f4c64f14293a3c5"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a511b9a4cb9c4a8b32540be7a2c290ec3">lua_check_hangup</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Check if this channel has been hungup or not (for access from lua, don't call directly)  <a href="#a511b9a4cb9c4a8b32540be7a2c290ec3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a57515b7151fb9d9f61f1273b64c053f6">lua_create_app_table</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the global 'app' table for executing applications.  <a href="#a57515b7151fb9d9f61f1273b64c053f6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a175cbb4330c4e669860e390890c4f36b">lua_create_application_metatable</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the 'application' metatable, used to execute asterisk applications from lua.  <a href="#a175cbb4330c4e669860e390890c4f36b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a2d0ef4e67695479b96e068aa3094c249">lua_create_autoservice_functions</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the autoservice functions.  <a href="#a2d0ef4e67695479b96e068aa3094c249"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ab29bd5e4bee0b4526e66354deae95d75">lua_create_channel_table</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the global 'channel' table for accesing channel variables.  <a href="#ab29bd5e4bee0b4526e66354deae95d75"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a134a2cbe4ac0e35ea02622cc5a92a7d6">lua_create_hangup_function</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the hangup check function.  <a href="#a134a2cbe4ac0e35ea02622cc5a92a7d6"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ab906c45be529901f58f56dacae7beaa2">lua_create_variable_metatable</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create the 'variable' metatable, used to retrieve channel variables.  <a href="#ab906c45be529901f58f56dacae7beaa2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a01738bdaf962b0e78d4e4aa72cf78cd3">lua_error_function</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Handle lua errors (for access from lua, don't call directly)  <a href="#a01738bdaf962b0e78d4e4aa72cf78cd3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#aa8acaadbc4a75cf7152db60003c564b2">lua_extension_cmp</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Compare two extensions (for access from lua, don't call directly)  <a href="#aa8acaadbc4a75cf7152db60003c564b2"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#aac6067451861a42c261f10a9a3a1aa6d">lua_find_extension</a> (lua_State *L, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, int priority, <a class="el" href="pbx_8h.html#a93ee7200f8a12fa56224b85d2483693d">ast_switch_f</a> *func, int push_func)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Locate an extensions and optionally push the matching function on the stack.  <a href="#aac6067451861a42c261f10a9a3a1aa6d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a2555949b938e7a61910dab4b1584a45e">lua_free_extensions</a> ()</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Free the internal extensions buffer.  <a href="#a2555949b938e7a61910dab4b1584a45e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a6c6b10bc3f870b99a1c49c1739382e09">lua_func_read</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Create a 'variable' object for accessing a dialplan function (for access from lua, don't call directly)  <a href="#a6c6b10bc3f870b99a1c49c1739382e09"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static lua_State *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e">lua_get_state</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Get the lua_State for this channel.  <a href="#ad50255c1af5d6d906cded525f8418b5e"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#aded2079ad83f5f3eb6298bcfe77a30d1">lua_get_variable</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Return a lua 'variable' object (for access from lua, don't call directly)  <a href="#aded2079ad83f5f3eb6298bcfe77a30d1"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a28934dd2a760fd2d1a8b2ba25dac5c86">lua_get_variable_value</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Used to get the value of a variable or dialplan function (for access from lua, don't call directly)  <a href="#a28934dd2a760fd2d1a8b2ba25dac5c86"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#acba99420a91648953bbd8ce463a4dfd3">lua_load_extensions</a> (lua_State *L, struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Load the extensions.lua file from the internal buffer.  <a href="#acba99420a91648953bbd8ce463a4dfd3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a905bd9391828306c844ed88d28ab00c3">lua_pbx_exec</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] This function is part of the 'application' metatable and is used to execute applications similar to <a class="el" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec()</a> (for access from lua, don't call directly)  <a href="#a905bd9391828306c844ed88d28ab00c3"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a509cf8d60309eeb98d81c62d5f6642f8">lua_pbx_findapp</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Find an app and return it in a lua table (for access from lua, don't call directly)  <a href="#a509cf8d60309eeb98d81c62d5f6642f8"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a27fbef4dae2cd7fe0889b739d4466496">lua_push_variable_table</a> (lua_State *L, const char *<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Push a 'variable' table on the stack for access the channel variable with the given name.  <a href="#a27fbef4dae2cd7fe0889b739d4466496"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a0ba76f3093bed14d623cb8f1b256e40f">lua_read_extensions_file</a> (lua_State *L, long *size)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Load the extensions.lua file in to a buffer and execute the file.  <a href="#a0ba76f3093bed14d623cb8f1b256e40f"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#add206b06d14d62c6f190df4492a79ab7">lua_register_switches</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Register dialplan <a class="el" href="structswitches.html">switches</a> for our pbx_lua contexs.  <a href="#add206b06d14d62c6f190df4492a79ab7"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a5da7e8e127e797b0e15a2200400e546a">lua_reload_extensions</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Reload the extensions file and update the internal buffers if it loads correctly.  <a href="#a5da7e8e127e797b0e15a2200400e546a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a2432380cd99744c518404a10e05252ab">lua_set_variable</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Set the value of a channel variable or dialplan function (for access from lua, don't call directly)  <a href="#a2432380cd99744c518404a10e05252ab"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a6dc56ee4d2399626018669620002778d">lua_set_variable_value</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">[lua_CFunction] Used to set the value of a variable or dialplan function (for access from lua, don't call directly)  <a href="#a6dc56ee4d2399626018669620002778d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#aca3ce86b468f3bd615cae1b5f364c0dc">lua_sort_extensions</a> (lua_State *L)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Store the sort order of each context.  <a href="#aca3ce86b468f3bd615cae1b5f364c0dc"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a1af58c32d2d752784fc3e9194a1a15ff">lua_state_destroy</a> (void *data)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">The destructor for lua_datastore.  <a href="#a1af58c32d2d752784fc3e9194a1a15ff"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a5aeda87e3d4092383a71cf6cceded87b">lua_update_registry</a> (lua_State *L, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, int priority)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Update the lua registry with the given context, exten, and priority.  <a href="#a5aeda87e3d4092383a71cf6cceded87b"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a01d4c61c8065333033ddb5325bfd2032">matchmore</a> (struct <a class="el" href="structast__channel.html">ast_channel</a> *<a class="el" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, const char *<a class="el" href="chan__phone_8c.html#a579ca8125bbf48d9ce8691d522f99933">context</a>, const char *<a class="el" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, int priority, const char *callerid, const char *data)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> (void)</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ad09fa931f468002152a3cc2d5ce25eae">unload_module</a> (void)</td></tr>
<tr><td colspan="2"><h2>Variables</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Lua PBX Switch&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__module__info.html">ast_module_info</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ae25b9f3970870610911f8850897e8ead">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a> = &quot;extensions.lua&quot;</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static <a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">long&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a2d7c1872fa6e3a83bb32f9314da5550b">config_file_size</a> = 0</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__context.html">ast_context</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__hashtab.html">ast_hashtab</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a> = NULL</td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__datastore__info.html">ast_datastore_info</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a11cd8c2600fb5e70db6e795fbabdfefb">lua_datastore</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static struct <a class="el" href="structast__switch.html">ast_switch</a>&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#a1fbd4b9cbb88f00961f746f04ee90da1">lua_switch</a></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">static char *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="pbx__lua_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a> = &quot;pbx_lua&quot;</td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>Lua PBX Switch. </p>
<dl class="author"><dt><b>Author:</b></dt><dd>Matthew Nicholson &lt;<a href="mailto:mnicholson@digium.com">mnicholson@digium.com</a>&gt; </dd></dl>

<p>Definition in file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>
<hr/><h2>Define Documentation</h2>
<a class="anchor" id="a599a30638feeaa8bece87a6f4eb4bae1"></a><!-- doxytag: member="pbx_lua.c::LUA_BUF_SIZE" ref="a599a30638feeaa8bece87a6f4eb4bae1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LUA_BUF_SIZE&nbsp;&nbsp;&nbsp;4096</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00059">59</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00515">lua_get_variable()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00260">lua_get_variable_value()</a>.</p>

</div>
</div>
<a class="anchor" id="a8f0cf0337474a0b28ed30ab13f729f80"></a><!-- doxytag: member="pbx_lua.c::LUA_EXT_DATA_SIZE" ref="a8f0cf0337474a0b28ed30ab13f729f80" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">#define LUA_EXT_DATA_SIZE&nbsp;&nbsp;&nbsp;256</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00058">58</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00596">lua_func_read()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00165">lua_pbx_exec()</a>.</p>

</div>
</div>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a88b7c88fed6b80fd18f34f97757dfc04"></a><!-- doxytag: member="pbx_lua.c::__reg_module" ref="a88b7c88fed6b80fd18f34f97757dfc04" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __reg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01480">1480</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="afeab1257bd17282b95875499393a147a"></a><!-- doxytag: member="pbx_lua.c::__unreg_module" ref="afeab1257bd17282b95875499393a147a" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void __unreg_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01480">1480</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="a161611b39a822c50ab75c350a69eedd2"></a><!-- doxytag: member="pbx_lua.c::canmatch" ref="a161611b39a822c50ab75c350a69eedd2" args="(struct ast_channel *chan, const char *context, const char *exten, int priority, const char *callerid, const char *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int canmatch </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>priority</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>callerid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01167">1167</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00240">ast_module_user_add</a>, <a class="el" href="module_8h_source.html#l00241">ast_module_user_remove</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx__lua_8c_source.html#l01285">lua_find_extension()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01082">lua_get_state()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01285">lua_find_extension()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01168"></a>01168 {
<a name="l01169"></a>01169    <span class="keywordtype">int</span> res;
<a name="l01170"></a>01170    lua_State *L;
<a name="l01171"></a>01171    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l01172"></a>01172    <span class="keywordflow">if</span> (!u) {
<a name="l01173"></a>01173       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error adjusting use count, probably could not allocate memory\n&quot;</span>);
<a name="l01174"></a>01174       <span class="keywordflow">return</span> 0;
<a name="l01175"></a>01175    }
<a name="l01176"></a>01176 
<a name="l01177"></a>01177    L = <a class="code" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e" title="Get the lua_State for this channel.">lua_get_state</a>(chan);
<a name="l01178"></a>01178    <span class="keywordflow">if</span> (!L) {
<a name="l01179"></a>01179       <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01180"></a>01180       <span class="keywordflow">return</span> 0;
<a name="l01181"></a>01181    }
<a name="l01182"></a>01182 
<a name="l01183"></a>01183    res = <a class="code" href="pbx__lua_8c.html#aac6067451861a42c261f10a9a3a1aa6d" title="Locate an extensions and optionally push the matching function on the stack.">lua_find_extension</a>(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, priority, &amp;<a class="code" href="pbx__lua_8c.html#a161611b39a822c50ab75c350a69eedd2">canmatch</a>, 0);
<a name="l01184"></a>01184 
<a name="l01185"></a>01185    <span class="keywordflow">if</span> (!chan) lua_close(L);
<a name="l01186"></a>01186    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01187"></a>01187    <span class="keywordflow">return</span> res;
<a name="l01188"></a>01188 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ea9753b753253d4c74b215c6d290e52"></a><!-- doxytag: member="pbx_lua.c::exec" ref="a0ea9753b753253d4c74b215c6d290e52" args="(struct ast_channel *chan, const char *context, const char *exten, int priority, const char *callerid, const char *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int exec </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>priority</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>callerid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01214">1214</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00240">ast_module_user_add</a>, <a class="el" href="module_8h_source.html#l00241">ast_module_user_remove</a>, <a class="el" href="pbx__lua_8c_source.html#l01144">exists()</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx__lua_8c_source.html#l00732">lua_error_function()</a>, <a class="el" href="pbx__lua_8c_source.html#l01285">lua_find_extension()</a>, <a class="el" href="pbx__lua_8c_source.html#l01082">lua_get_state()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00364">lua_update_registry()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01215"></a>01215 {
<a name="l01216"></a>01216    <span class="keywordtype">int</span> res, error_func;
<a name="l01217"></a>01217    lua_State *L;
<a name="l01218"></a>01218    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l01219"></a>01219    <span class="keywordflow">if</span> (!u) {
<a name="l01220"></a>01220       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error adjusting use count, probably could not allocate memory\n&quot;</span>);
<a name="l01221"></a>01221       <span class="keywordflow">return</span> -1;
<a name="l01222"></a>01222    }
<a name="l01223"></a>01223    
<a name="l01224"></a>01224    L = <a class="code" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e" title="Get the lua_State for this channel.">lua_get_state</a>(chan);
<a name="l01225"></a>01225    <span class="keywordflow">if</span> (!L) {
<a name="l01226"></a>01226       <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01227"></a>01227       <span class="keywordflow">return</span> -1;
<a name="l01228"></a>01228    }
<a name="l01229"></a>01229 
<a name="l01230"></a>01230    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a01738bdaf962b0e78d4e4aa72cf78cd3" title="[lua_CFunction] Handle lua errors (for access from lua, don&amp;#39;t call directly)">lua_error_function</a>);
<a name="l01231"></a>01231    error_func = lua_gettop(L);
<a name="l01232"></a>01232 
<a name="l01233"></a>01233    <span class="comment">/* push the extension function onto the stack */</span>
<a name="l01234"></a>01234    <span class="keywordflow">if</span> (!<a class="code" href="pbx__lua_8c.html#aac6067451861a42c261f10a9a3a1aa6d" title="Locate an extensions and optionally push the matching function on the stack.">lua_find_extension</a>(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, priority, &amp;<a class="code" href="pbx__lua_8c.html#af22e601a6d901abccea13ee3cc3fc1ff">exists</a>, 1)) {
<a name="l01235"></a>01235       lua_pop(L, 1); <span class="comment">/* pop the debug function */</span>
<a name="l01236"></a>01236       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Could not find extension %s in context %s\n&quot;</span>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01237"></a>01237       <span class="keywordflow">if</span> (!chan) lua_close(L);
<a name="l01238"></a>01238       <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01239"></a>01239       <span class="keywordflow">return</span> -1;
<a name="l01240"></a>01240    }
<a name="l01241"></a>01241       
<a name="l01242"></a>01242    <a class="code" href="pbx__lua_8c.html#a5aeda87e3d4092383a71cf6cceded87b" title="Update the lua registry with the given context, exten, and priority.">lua_update_registry</a>(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, priority);
<a name="l01243"></a>01243    
<a name="l01244"></a>01244    lua_pushstring(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01245"></a>01245    lua_pushstring(L, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l01246"></a>01246    
<a name="l01247"></a>01247    res = lua_pcall(L, 2, 0, error_func);
<a name="l01248"></a>01248    <span class="keywordflow">if</span> (res) {
<a name="l01249"></a>01249       <span class="keywordflow">if</span> (res == LUA_ERRRUN) {
<a name="l01250"></a>01250          res = -1;
<a name="l01251"></a>01251          <span class="keywordflow">if</span> (lua_isnumber(L, -1)) {
<a name="l01252"></a>01252             res = lua_tointeger(L, -1);
<a name="l01253"></a>01253          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (lua_isstring(L, -1)) {
<a name="l01254"></a>01254             <span class="keyword">const</span> <span class="keywordtype">char</span> *error = lua_tostring(L, -1);
<a name="l01255"></a>01255             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error executing lua extension: %s\n&quot;</span>, error);
<a name="l01256"></a>01256          }
<a name="l01257"></a>01257       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == LUA_ERRERR) {
<a name="l01258"></a>01258          res = -1;
<a name="l01259"></a>01259          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error in the lua error handler (this is probably a bug in pbx_lua)\n&quot;</span>);
<a name="l01260"></a>01260       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (res == LUA_ERRMEM) {
<a name="l01261"></a>01261          res = -1;
<a name="l01262"></a>01262          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Memory allocation error\n&quot;</span>);
<a name="l01263"></a>01263       }
<a name="l01264"></a>01264       lua_pop(L, 1);
<a name="l01265"></a>01265    }
<a name="l01266"></a>01266    lua_remove(L, error_func);
<a name="l01267"></a>01267    <span class="keywordflow">if</span> (!chan) lua_close(L);
<a name="l01268"></a>01268    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01269"></a>01269    <span class="keywordflow">return</span> res;
<a name="l01270"></a>01270 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="af22e601a6d901abccea13ee3cc3fc1ff"></a><!-- doxytag: member="pbx_lua.c::exists" ref="af22e601a6d901abccea13ee3cc3fc1ff" args="(struct ast_channel *chan, const char *context, const char *exten, int priority, const char *callerid, const char *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int exists </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>priority</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>callerid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01144">1144</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00240">ast_module_user_add</a>, <a class="el" href="module_8h_source.html#l00241">ast_module_user_remove</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx__lua_8c_source.html#l01285">lua_find_extension()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01082">lua_get_state()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01214">exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01145"></a>01145 {
<a name="l01146"></a>01146    <span class="keywordtype">int</span> res;
<a name="l01147"></a>01147    lua_State *L;
<a name="l01148"></a>01148    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l01149"></a>01149    <span class="keywordflow">if</span> (!u) {
<a name="l01150"></a>01150       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error adjusting use count, probably could not allocate memory\n&quot;</span>);
<a name="l01151"></a>01151       <span class="keywordflow">return</span> 0;
<a name="l01152"></a>01152    }
<a name="l01153"></a>01153 
<a name="l01154"></a>01154    L = <a class="code" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e" title="Get the lua_State for this channel.">lua_get_state</a>(chan);
<a name="l01155"></a>01155    <span class="keywordflow">if</span> (!L) {
<a name="l01156"></a>01156       <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01157"></a>01157       <span class="keywordflow">return</span> 0;
<a name="l01158"></a>01158    }
<a name="l01159"></a>01159 
<a name="l01160"></a>01160    res = <a class="code" href="pbx__lua_8c.html#aac6067451861a42c261f10a9a3a1aa6d" title="Locate an extensions and optionally push the matching function on the stack.">lua_find_extension</a>(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, priority, &amp;<a class="code" href="pbx__lua_8c.html#af22e601a6d901abccea13ee3cc3fc1ff">exists</a>, 0);
<a name="l01161"></a>01161 
<a name="l01162"></a>01162    <span class="keywordflow">if</span> (!chan) lua_close(L);
<a name="l01163"></a>01163    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01164"></a>01164    <span class="keywordflow">return</span> res;
<a name="l01165"></a>01165 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ac3382bf6da54c56b37069bd76bbdf4f9"></a><!-- doxytag: member="pbx_lua.c::load_module" ref="ac3382bf6da54c56b37069bd76bbdf4f9" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01461">1461</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="pbx_8c_source.html#l05157">ast_register_switch()</a>, <a class="el" href="pbx__lua_8c_source.html#l01428">load_or_reload_lua_stuff()</a>, and <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01462"></a>01462 {
<a name="l01463"></a>01463    <span class="keywordtype">int</span> res;
<a name="l01464"></a>01464 
<a name="l01465"></a>01465    <span class="keywordflow">if</span> ((res = <a class="code" href="pbx__lua_8c.html#a0cd4a8176fed2b7bfae5c20d088a16ad">load_or_reload_lua_stuff</a>()))
<a name="l01466"></a>01466       <span class="keywordflow">return</span> res;
<a name="l01467"></a>01467 
<a name="l01468"></a>01468    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a5297fa9c52ff50da5b08c7217d9251b4" title="Register an alternative dialplan switch.">ast_register_switch</a>(&amp;<a class="code" href="pbx__lua_8c.html#a1fbd4b9cbb88f00961f746f04ee90da1">lua_switch</a>)) {
<a name="l01469"></a>01469       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to register LUA PBX switch\n&quot;</span>);
<a name="l01470"></a>01470       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01471"></a>01471    }
<a name="l01472"></a>01472 
<a name="l01473"></a>01473    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01474"></a>01474 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0cd4a8176fed2b7bfae5c20d088a16ad"></a><!-- doxytag: member="pbx_lua.c::load_or_reload_lua_stuff" ref="a0cd4a8176fed2b7bfae5c20d088a16ad" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int load_or_reload_lua_stuff </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01428">1428</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00062">AST_MODULE_LOAD_DECLINE</a>, <a class="el" href="module_8h_source.html#l00061">AST_MODULE_LOAD_SUCCESS</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="pbx__lua_8c_source.html#l01026">lua_reload_extensions()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01461">load_module()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01456">reload()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01429"></a>01429 {
<a name="l01430"></a>01430    <span class="keywordtype">int</span> res = <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01431"></a>01431 
<a name="l01432"></a>01432    lua_State *L = luaL_newstate();
<a name="l01433"></a>01433    <span class="keywordflow">if</span> (!L) {
<a name="l01434"></a>01434       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error allocating lua_State, no memory\n&quot;</span>);
<a name="l01435"></a>01435       <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01436"></a>01436    }
<a name="l01437"></a>01437 
<a name="l01438"></a>01438    <span class="keywordflow">if</span> (<a class="code" href="pbx__lua_8c.html#a5da7e8e127e797b0e15a2200400e546a" title="Reload the extensions file and update the internal buffers if it loads correctly...">lua_reload_extensions</a>(L)) {
<a name="l01439"></a>01439       <span class="keyword">const</span> <span class="keywordtype">char</span> *error = lua_tostring(L, -1);
<a name="l01440"></a>01440       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error loading extensions.lua: %s\n&quot;</span>, error);
<a name="l01441"></a>01441       res = <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfac742921e9f9512d28f62c74ea2affe57">AST_MODULE_LOAD_DECLINE</a>;
<a name="l01442"></a>01442    }
<a name="l01443"></a>01443 
<a name="l01444"></a>01444    lua_close(L);
<a name="l01445"></a>01445    <span class="keywordflow">return</span> res;
<a name="l01446"></a>01446 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6a4cd826d657c3b3e9b478737b0a5156"></a><!-- doxytag: member="pbx_lua.c::lua_autoservice_start" ref="a6a4cd826d657c3b3e9b478737b0a5156" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_autoservice_start </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Tell pbx_lua to maintain an autoservice on this channel (for access from lua, don't call directly) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use</td></tr>
  </table>
  </dd>
</dl>
<p>This function will set a flag that will cause pbx_lua to maintain an autoservice on this channel. The autoservice will automatically be stopped and restarted before calling applications and functions.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>This function returns the result of the <a class="el" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start()</a> function as a boolean to its lua caller. </dd></dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00643">643</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, and <a class="el" href="adsistub_8c_source.html#l00049">chan</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00477">lua_create_autoservice_functions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00644"></a>00644 {
<a name="l00645"></a>00645    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00646"></a>00646    <span class="keywordtype">int</span> res;
<a name="l00647"></a>00647 
<a name="l00648"></a>00648    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00649"></a>00649    chan = lua_touserdata(L, -1);
<a name="l00650"></a>00650    lua_pop(L, 1);
<a name="l00651"></a>00651 
<a name="l00652"></a>00652    res = <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00653"></a>00653 
<a name="l00654"></a>00654    lua_pushboolean(L, !res);
<a name="l00655"></a>00655    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00656"></a>00656 
<a name="l00657"></a>00657    lua_pushboolean(L, !res);
<a name="l00658"></a>00658    <span class="keywordflow">return</span> 1;
<a name="l00659"></a>00659 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0b737399142ce1ebed5c05e95be06905"></a><!-- doxytag: member="pbx_lua.c::lua_autoservice_status" ref="a0b737399142ce1ebed5c05e95be06905" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_autoservice_status </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Get the status of the autoservice flag (for access from lua, don't call directly) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>This function returns the status of the autoservice flag as a boolean to its lua caller. </dd></dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00701">701</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00477">lua_create_autoservice_functions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00702"></a>00702 {
<a name="l00703"></a>00703    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00704"></a>00704    <span class="keywordflow">return</span> 1;
<a name="l00705"></a>00705 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a85180f91f6455d854f4c64f14293a3c5"></a><!-- doxytag: member="pbx_lua.c::lua_autoservice_stop" ref="a85180f91f6455d854f4c64f14293a3c5" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_autoservice_stop </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Tell pbx_lua to stop maintaning an autoservice on this channel (for access from lua, don't call directly) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use</td></tr>
  </table>
  </dd>
</dl>
<p>This function will stop any autoservice running and turn off the autoservice flag. If this function returns false, it's probably because no autoservice was running to begin with.</p>
<dl class="return"><dt><b>Returns:</b></dt><dd>This function returns the result of the <a class="el" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop()</a> function as a boolean to its lua caller. </dd></dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00674">674</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, and <a class="el" href="adsistub_8c_source.html#l00049">chan</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00477">lua_create_autoservice_functions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00675"></a>00675 {
<a name="l00676"></a>00676    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00677"></a>00677    <span class="keywordtype">int</span> res;
<a name="l00678"></a>00678 
<a name="l00679"></a>00679    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00680"></a>00680    chan = lua_touserdata(L, -1);
<a name="l00681"></a>00681    lua_pop(L, 1);
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    res = <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00684"></a>00684 
<a name="l00685"></a>00685    lua_pushboolean(L, 0);
<a name="l00686"></a>00686    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00687"></a>00687 
<a name="l00688"></a>00688    lua_pushboolean(L, !res);
<a name="l00689"></a>00689    <span class="keywordflow">return</span> 1;
<a name="l00690"></a>00690 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a511b9a4cb9c4a8b32540be7a2c290ec3"></a><!-- doxytag: member="pbx_lua.c::lua_check_hangup" ref="a511b9a4cb9c4a8b32540be7a2c290ec3" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_check_hangup </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Check if this channel has been hungup or not (for access from lua, don't call directly) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use</td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>This function returns true if the channel was hungup </dd></dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00715">715</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="channel_8c_source.html#l00461">ast_check_hangup()</a>, and <a class="el" href="adsistub_8c_source.html#l00049">chan</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00497">lua_create_hangup_function()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00716"></a>00716 {
<a name="l00717"></a>00717    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00718"></a>00718    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00719"></a>00719    chan = lua_touserdata(L, -1);
<a name="l00720"></a>00720    lua_pop(L, 1);
<a name="l00721"></a>00721 
<a name="l00722"></a>00722    lua_pushboolean(L, <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(chan));
<a name="l00723"></a>00723    <span class="keywordflow">return</span> 1;
<a name="l00724"></a>00724 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a57515b7151fb9d9f61f1273b64c053f6"></a><!-- doxytag: member="pbx_lua.c::lua_create_app_table" ref="a57515b7151fb9d9f61f1273b64c053f6" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_create_app_table </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create the global 'app' table for executing applications. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00404">404</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00134">lua_pbx_findapp()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00405"></a>00405 {
<a name="l00406"></a>00406    lua_newtable(L);
<a name="l00407"></a>00407    luaL_newmetatable(L, <span class="stringliteral">&quot;app&quot;</span>);
<a name="l00408"></a>00408 
<a name="l00409"></a>00409    lua_pushstring(L, <span class="stringliteral">&quot;__index&quot;</span>);
<a name="l00410"></a>00410    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a509cf8d60309eeb98d81c62d5f6642f8" title="[lua_CFunction] Find an app and return it in a lua table (for access from lua, don&amp;#39;t...">lua_pbx_findapp</a>);
<a name="l00411"></a>00411    lua_settable(L, -3);
<a name="l00412"></a>00412 
<a name="l00413"></a>00413    lua_setmetatable(L, -2);
<a name="l00414"></a>00414    lua_setglobal(L, <span class="stringliteral">&quot;app&quot;</span>);
<a name="l00415"></a>00415 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a175cbb4330c4e669860e390890c4f36b"></a><!-- doxytag: member="pbx_lua.c::lua_create_application_metatable" ref="a175cbb4330c4e669860e390890c4f36b" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_create_application_metatable </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create the 'application' metatable, used to execute asterisk applications from lua. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00461">461</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00165">lua_pbx_exec()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00462"></a>00462 {
<a name="l00463"></a>00463    luaL_newmetatable(L, <span class="stringliteral">&quot;application&quot;</span>);
<a name="l00464"></a>00464 
<a name="l00465"></a>00465    lua_pushstring(L, <span class="stringliteral">&quot;__call&quot;</span>);
<a name="l00466"></a>00466    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a905bd9391828306c844ed88d28ab00c3" title="[lua_CFunction] This function is part of the &amp;#39;application&amp;#39; metatable and...">lua_pbx_exec</a>);
<a name="l00467"></a>00467    lua_settable(L, -3);
<a name="l00468"></a>00468 
<a name="l00469"></a>00469    lua_pop(L, 1);
<a name="l00470"></a>00470 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2d0ef4e67695479b96e068aa3094c249"></a><!-- doxytag: member="pbx_lua.c::lua_create_autoservice_functions" ref="a2d0ef4e67695479b96e068aa3094c249" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_create_autoservice_functions </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create the autoservice functions. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00477">477</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00643">lua_autoservice_start()</a>, <a class="el" href="pbx__lua_8c_source.html#l00701">lua_autoservice_status()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00674">lua_autoservice_stop()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00478"></a>00478 {
<a name="l00479"></a>00479    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a6a4cd826d657c3b3e9b478737b0a5156" title="[lua_CFunction] Tell pbx_lua to maintain an autoservice on this channel (for access...">lua_autoservice_start</a>);
<a name="l00480"></a>00480    lua_setglobal(L, <span class="stringliteral">&quot;autoservice_start&quot;</span>);
<a name="l00481"></a>00481    
<a name="l00482"></a>00482    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a85180f91f6455d854f4c64f14293a3c5" title="[lua_CFunction] Tell pbx_lua to stop maintaning an autoservice on this channel (for...">lua_autoservice_stop</a>);
<a name="l00483"></a>00483    lua_setglobal(L, <span class="stringliteral">&quot;autoservice_stop&quot;</span>);
<a name="l00484"></a>00484 
<a name="l00485"></a>00485    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a0b737399142ce1ebed5c05e95be06905" title="[lua_CFunction] Get the status of the autoservice flag (for access from lua, don&amp;#39;t...">lua_autoservice_status</a>);
<a name="l00486"></a>00486    lua_setglobal(L, <span class="stringliteral">&quot;autoservice_status&quot;</span>);
<a name="l00487"></a>00487 
<a name="l00488"></a>00488    lua_pushboolean(L, 0);
<a name="l00489"></a>00489    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00490"></a>00490 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab29bd5e4bee0b4526e66354deae95d75"></a><!-- doxytag: member="pbx_lua.c::lua_create_channel_table" ref="ab29bd5e4bee0b4526e66354deae95d75" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_create_channel_table </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create the global 'channel' table for accesing channel variables. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00422">422</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00515">lua_get_variable()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00554">lua_set_variable()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00423"></a>00423 {
<a name="l00424"></a>00424    lua_newtable(L);
<a name="l00425"></a>00425    luaL_newmetatable(L, <span class="stringliteral">&quot;channel_data&quot;</span>);
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    lua_pushstring(L, <span class="stringliteral">&quot;__index&quot;</span>);
<a name="l00428"></a>00428    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#aded2079ad83f5f3eb6298bcfe77a30d1" title="[lua_CFunction] Return a lua &amp;#39;variable&amp;#39; object (for access from lua, don&amp;#39;t...">lua_get_variable</a>);
<a name="l00429"></a>00429    lua_settable(L, -3);
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    lua_pushstring(L, <span class="stringliteral">&quot;__newindex&quot;</span>);
<a name="l00432"></a>00432    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a2432380cd99744c518404a10e05252ab" title="[lua_CFunction] Set the value of a channel variable or dialplan function (for access...">lua_set_variable</a>);
<a name="l00433"></a>00433    lua_settable(L, -3);
<a name="l00434"></a>00434 
<a name="l00435"></a>00435    lua_setmetatable(L, -2);
<a name="l00436"></a>00436    lua_setglobal(L, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00437"></a>00437 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a134a2cbe4ac0e35ea02622cc5a92a7d6"></a><!-- doxytag: member="pbx_lua.c::lua_create_hangup_function" ref="a134a2cbe4ac0e35ea02622cc5a92a7d6" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_create_hangup_function </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create the hangup check function. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00497">497</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00715">lua_check_hangup()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00498"></a>00498 {
<a name="l00499"></a>00499    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a511b9a4cb9c4a8b32540be7a2c290ec3" title="[lua_CFunction] Check if this channel has been hungup or not (for access from lua...">lua_check_hangup</a>);
<a name="l00500"></a>00500    lua_setglobal(L, <span class="stringliteral">&quot;check_hangup&quot;</span>);
<a name="l00501"></a>00501 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ab906c45be529901f58f56dacae7beaa2"></a><!-- doxytag: member="pbx_lua.c::lua_create_variable_metatable" ref="ab906c45be529901f58f56dacae7beaa2" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_create_variable_metatable </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create the 'variable' metatable, used to retrieve channel variables. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00444">444</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00596">lua_func_read()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00445"></a>00445 {
<a name="l00446"></a>00446    luaL_newmetatable(L, <span class="stringliteral">&quot;variable&quot;</span>);
<a name="l00447"></a>00447 
<a name="l00448"></a>00448    lua_pushstring(L, <span class="stringliteral">&quot;__call&quot;</span>);
<a name="l00449"></a>00449    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a6c6b10bc3f870b99a1c49c1739382e09" title="[lua_CFunction] Create a &amp;#39;variable&amp;#39; object for accessing a dialplan function...">lua_func_read</a>);
<a name="l00450"></a>00450    lua_settable(L, -3);
<a name="l00451"></a>00451 
<a name="l00452"></a>00452    lua_pop(L, 1);
<a name="l00453"></a>00453 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a01738bdaf962b0e78d4e4aa72cf78cd3"></a><!-- doxytag: member="pbx_lua.c::lua_error_function" ref="a01738bdaf962b0e78d4e4aa72cf78cd3" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_error_function </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Handle lua errors (for access from lua, don't call directly) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00732">732</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01214">exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00733"></a>00733 {
<a name="l00734"></a>00734    <span class="keywordtype">int</span> message_index;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736    <span class="comment">/* pass number arguments right through back to asterisk*/</span>
<a name="l00737"></a>00737    <span class="keywordflow">if</span> (lua_isnumber(L, -1)) {
<a name="l00738"></a>00738       <span class="keywordflow">return</span> 1;
<a name="l00739"></a>00739    }
<a name="l00740"></a>00740 
<a name="l00741"></a>00741    <span class="comment">/* if we are here then we have a string error message, let&apos;s attach a</span>
<a name="l00742"></a>00742 <span class="comment">    * backtrace to it */</span>
<a name="l00743"></a>00743    message_index = lua_gettop(L);
<a name="l00744"></a>00744 
<a name="l00745"></a>00745    lua_getglobal(L, <span class="stringliteral">&quot;debug&quot;</span>);
<a name="l00746"></a>00746    lua_getfield(L, -1, <span class="stringliteral">&quot;traceback&quot;</span>);
<a name="l00747"></a>00747    lua_remove(L, -2); <span class="comment">/* remove the &apos;debug&apos; table */</span>
<a name="l00748"></a>00748 
<a name="l00749"></a>00749    lua_pushvalue(L, message_index);
<a name="l00750"></a>00750    lua_remove(L, message_index);
<a name="l00751"></a>00751 
<a name="l00752"></a>00752    lua_pushnumber(L, 2);
<a name="l00753"></a>00753 
<a name="l00754"></a>00754    lua_call(L, 2, 1);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756    <span class="keywordflow">return</span> 1;
<a name="l00757"></a>00757 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aa8acaadbc4a75cf7152db60003c564b2"></a><!-- doxytag: member="pbx_lua.c::lua_extension_cmp" ref="aa8acaadbc4a75cf7152db60003c564b2" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_extension_cmp </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Compare two extensions (for access from lua, don't call directly) </p>
<p>This function returns true if the first <a class="el" href="structextension.html">extension</a> passed should match after the second. It behaves like the '&lt;' operator. </p>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00903">903</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l02209">ast_extension_cmp()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00767">lua_sort_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00904"></a>00904 {
<a name="l00905"></a>00905    <span class="keyword">const</span> <span class="keywordtype">char</span> *a = luaL_checkstring(L, -2);
<a name="l00906"></a>00906    <span class="keyword">const</span> <span class="keywordtype">char</span> *b = luaL_checkstring(L, -1);
<a name="l00907"></a>00907 
<a name="l00908"></a>00908    <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#aa9130cb982e3e236c465136e0637cfaa" title="Determine if one extension should match before another.">ast_extension_cmp</a>(a, b) == -1)
<a name="l00909"></a>00909       lua_pushboolean(L, 1);
<a name="l00910"></a>00910    <span class="keywordflow">else</span>
<a name="l00911"></a>00911       lua_pushboolean(L, 0);
<a name="l00912"></a>00912 
<a name="l00913"></a>00913    <span class="keywordflow">return</span> 1;
<a name="l00914"></a>00914 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aac6067451861a42c261f10a9a3a1aa6d"></a><!-- doxytag: member="pbx_lua.c::lua_find_extension" ref="aac6067451861a42c261f10a9a3a1aa6d" args="(lua_State *L, const char *context, const char *exten, int priority, ast_switch_f *func, int push_func)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_find_extension </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>priority</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype"><a class="el" href="pbx_8h.html#a93ee7200f8a12fa56224b85d2483693d">ast_switch_f</a> *&nbsp;</td>
          <td class="paramname"> <em>func</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>push_func</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Locate an extensions and optionally push the matching function on the stack. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>context</em>&nbsp;</td><td>the context to look in </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>exten</em>&nbsp;</td><td>the <a class="el" href="structextension.html">extension</a> to look up </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>priority</em>&nbsp;</td><td>the priority to check, '1' is the only valid priority </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>func</em>&nbsp;</td><td>the calling func, used to adjust matching behavior between, match, canmatch, and matchmore </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>push_func</em>&nbsp;</td><td>whether or not to push the lua function for the given <a class="el" href="structextension.html">extension</a> onto the stack </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01285">1285</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8h_source.html#l00213">ast_debug</a>, <a class="el" href="pbx_8c_source.html#l02407">ast_extension_close()</a>, <a class="el" href="pbx_8c_source.html#l02402">ast_extension_match()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="pbx__lua_8c_source.html#l01167">canmatch()</a>, <a class="el" href="extconf_8h_source.html#l00217">E_CANMATCH</a>, <a class="el" href="extconf_8h_source.html#l00216">E_MATCHMORE</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="chan__iax2_8c_source.html#l01834">match()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01190">matchmore()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01167">canmatch()</a>, <a class="el" href="pbx__lua_8c_source.html#l01214">exec()</a>, <a class="el" href="pbx__lua_8c_source.html#l01144">exists()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01190">matchmore()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01286"></a>01286 {
<a name="l01287"></a>01287    <span class="keywordtype">int</span> context_table, context_order_table, i;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Looking up %s@%s:%i\n&quot;</span>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l01290"></a>01290    <span class="keywordflow">if</span> (<a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a> != 1)
<a name="l01291"></a>01291       <span class="keywordflow">return</span> 0;
<a name="l01292"></a>01292 
<a name="l01293"></a>01293    <span class="comment">/* load the &apos;extensions&apos; table */</span>
<a name="l01294"></a>01294    lua_getglobal(L, <span class="stringliteral">&quot;extensions&quot;</span>);
<a name="l01295"></a>01295    <span class="keywordflow">if</span> (lua_isnil(L, -1)) {
<a name="l01296"></a>01296       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unable to find &apos;extensions&apos; table in extensions.lua\n&quot;</span>);
<a name="l01297"></a>01297       lua_pop(L, 1);
<a name="l01298"></a>01298       <span class="keywordflow">return</span> 0;
<a name="l01299"></a>01299    }
<a name="l01300"></a>01300 
<a name="l01301"></a>01301    <span class="comment">/* load the given context */</span>
<a name="l01302"></a>01302    lua_getfield(L, -1, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01303"></a>01303    <span class="keywordflow">if</span> (lua_isnil(L, -1)) {
<a name="l01304"></a>01304       lua_pop(L, 2);
<a name="l01305"></a>01305       <span class="keywordflow">return</span> 0;
<a name="l01306"></a>01306    }
<a name="l01307"></a>01307 
<a name="l01308"></a>01308    <span class="comment">/* remove the extensions table */</span>
<a name="l01309"></a>01309    lua_remove(L, -2);
<a name="l01310"></a>01310 
<a name="l01311"></a>01311    context_table = lua_gettop(L);
<a name="l01312"></a>01312 
<a name="l01313"></a>01313    <span class="comment">/* load the extensions order table for this context */</span>
<a name="l01314"></a>01314    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;extensions_order&quot;</span>);
<a name="l01315"></a>01315    lua_getfield(L, -1, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l01316"></a>01316 
<a name="l01317"></a>01317    lua_remove(L, -2);  <span class="comment">/* remove the extensions order table */</span>
<a name="l01318"></a>01318 
<a name="l01319"></a>01319    context_order_table = lua_gettop(L);
<a name="l01320"></a>01320    
<a name="l01321"></a>01321    <span class="comment">/* step through the extensions looking for a match */</span>
<a name="l01322"></a>01322    <span class="keywordflow">for</span> (i = 1; i &lt; lua_objlen(L, context_order_table) + 1; i++) {
<a name="l01323"></a>01323       <span class="keywordtype">int</span> e_index, e_index_copy, <a class="code" href="chan__iax2_8c.html#aa27930d6214f6421994d6bef51efb7aa">match</a> = 0;
<a name="l01324"></a>01324       <span class="keyword">const</span> <span class="keywordtype">char</span> *e;
<a name="l01325"></a>01325 
<a name="l01326"></a>01326       lua_pushinteger(L, i);
<a name="l01327"></a>01327       lua_gettable(L, context_order_table);
<a name="l01328"></a>01328       e_index = lua_gettop(L);
<a name="l01329"></a>01329 
<a name="l01330"></a>01330       <span class="comment">/* copy the key at the top of the stack for use later */</span>
<a name="l01331"></a>01331       lua_pushvalue(L, -1);
<a name="l01332"></a>01332       e_index_copy = lua_gettop(L);
<a name="l01333"></a>01333 
<a name="l01334"></a>01334       <span class="keywordflow">if</span> (!(e = lua_tostring(L, e_index_copy))) {
<a name="l01335"></a>01335          lua_pop(L, 2);
<a name="l01336"></a>01336          <span class="keywordflow">continue</span>;
<a name="l01337"></a>01337       }
<a name="l01338"></a>01338 
<a name="l01339"></a>01339       <span class="comment">/* make sure this is not the &apos;include&apos; extension */</span>
<a name="l01340"></a>01340       <span class="keywordflow">if</span> (!strcasecmp(e, <span class="stringliteral">&quot;include&quot;</span>)) {
<a name="l01341"></a>01341          lua_pop(L, 2);
<a name="l01342"></a>01342          <span class="keywordflow">continue</span>;
<a name="l01343"></a>01343       }
<a name="l01344"></a>01344 
<a name="l01345"></a>01345       <span class="keywordflow">if</span> (func == &amp;<a class="code" href="pbx__lua_8c.html#a01d4c61c8065333033ddb5325bfd2032">matchmore</a>)
<a name="l01346"></a>01346          match = <a class="code" href="pbx_8h.html#a83192a0099558f6a539fdb4e065ff99d">ast_extension_close</a>(e, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea7e20dcb277877b81e8099470cd631277">E_MATCHMORE</a>);
<a name="l01347"></a>01347       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (func == &amp;<a class="code" href="pbx__lua_8c.html#a161611b39a822c50ab75c350a69eedd2">canmatch</a>)
<a name="l01348"></a>01348          match = <a class="code" href="pbx_8h.html#a83192a0099558f6a539fdb4e065ff99d">ast_extension_close</a>(e, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="extconf_8h.html#a2b7f0fafc6995b2630658a4fd8df26bea413c09377a892aa154e7669cbdaf27ba">E_CANMATCH</a>);
<a name="l01349"></a>01349       <span class="keywordflow">else</span>
<a name="l01350"></a>01350          match = <a class="code" href="pbx_8h.html#a94cf2f099462a906620b5566871af797" title="Determine if a given extension matches a given pattern (in NXX format).">ast_extension_match</a>(e, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l01351"></a>01351 
<a name="l01352"></a>01352       <span class="comment">/* the extension matching functions return 0 on fail, 1 on</span>
<a name="l01353"></a>01353 <span class="comment">       * match, 2 on earlymatch */</span>
<a name="l01354"></a>01354 
<a name="l01355"></a>01355       <span class="keywordflow">if</span> (!match) {
<a name="l01356"></a>01356          <span class="comment">/* pop the copy and the extension */</span>
<a name="l01357"></a>01357          lua_pop(L, 2);
<a name="l01358"></a>01358          <span class="keywordflow">continue</span>;   <span class="comment">/* keep trying */</span>
<a name="l01359"></a>01359       }
<a name="l01360"></a>01360 
<a name="l01361"></a>01361       <span class="keywordflow">if</span> (func == &amp;<a class="code" href="pbx__lua_8c.html#a01d4c61c8065333033ddb5325bfd2032">matchmore</a> &amp;&amp; match == 2) {
<a name="l01362"></a>01362          <span class="comment">/* We match an extension ending in &apos;!&apos;. The decision in</span>
<a name="l01363"></a>01363 <span class="comment">          * this case is final and counts as no match. */</span>
<a name="l01364"></a>01364          lua_pop(L, 4);
<a name="l01365"></a>01365          <span class="keywordflow">return</span> 0;
<a name="l01366"></a>01366       }
<a name="l01367"></a>01367 
<a name="l01368"></a>01368       <span class="comment">/* remove the context table, the context order table, the</span>
<a name="l01369"></a>01369 <span class="comment">       * extension, and the extension copy (or replace the extension</span>
<a name="l01370"></a>01370 <span class="comment">       * with the corresponding function) */</span>
<a name="l01371"></a>01371       <span class="keywordflow">if</span> (push_func) {
<a name="l01372"></a>01372          lua_pop(L, 1);  <span class="comment">/* pop the copy */</span>
<a name="l01373"></a>01373          lua_gettable(L, context_table);
<a name="l01374"></a>01374          lua_insert(L, -3);
<a name="l01375"></a>01375          lua_pop(L, 2);
<a name="l01376"></a>01376       } <span class="keywordflow">else</span> {
<a name="l01377"></a>01377          lua_pop(L, 4);
<a name="l01378"></a>01378       }
<a name="l01379"></a>01379 
<a name="l01380"></a>01380       <span class="keywordflow">return</span> 1;
<a name="l01381"></a>01381    }
<a name="l01382"></a>01382 
<a name="l01383"></a>01383    <span class="comment">/* load the includes for this context */</span>
<a name="l01384"></a>01384    lua_getfield(L, context_table, <span class="stringliteral">&quot;include&quot;</span>);
<a name="l01385"></a>01385    <span class="keywordflow">if</span> (lua_isnil(L, -1)) {
<a name="l01386"></a>01386       lua_pop(L, 3);
<a name="l01387"></a>01387       <span class="keywordflow">return</span> 0;
<a name="l01388"></a>01388    }
<a name="l01389"></a>01389 
<a name="l01390"></a>01390    <span class="comment">/* remove the context and the order table*/</span>
<a name="l01391"></a>01391    lua_remove(L, context_order_table);
<a name="l01392"></a>01392    lua_remove(L, context_table);
<a name="l01393"></a>01393 
<a name="l01394"></a>01394    <span class="comment">/* Now try any includes we have in this context */</span>
<a name="l01395"></a>01395    <span class="keywordflow">for</span> (lua_pushnil(L); lua_next(L, -2); lua_pop(L, 1)) {
<a name="l01396"></a>01396       <span class="keyword">const</span> <span class="keywordtype">char</span> *c = lua_tostring(L, -1);
<a name="l01397"></a>01397       <span class="keywordflow">if</span> (!c)
<a name="l01398"></a>01398          <span class="keywordflow">continue</span>;
<a name="l01399"></a>01399 
<a name="l01400"></a>01400       <span class="keywordflow">if</span> (<a class="code" href="pbx__lua_8c.html#aac6067451861a42c261f10a9a3a1aa6d" title="Locate an extensions and optionally push the matching function on the stack.">lua_find_extension</a>(L, c, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, <a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, func, push_func)) {
<a name="l01401"></a>01401          <span class="comment">/* remove the value, the key, and the includes table</span>
<a name="l01402"></a>01402 <span class="comment">          * from the stack.  Leave the function behind if</span>
<a name="l01403"></a>01403 <span class="comment">          * necessary */</span>
<a name="l01404"></a>01404 
<a name="l01405"></a>01405          <span class="keywordflow">if</span> (push_func)
<a name="l01406"></a>01406             lua_insert(L, -4);
<a name="l01407"></a>01407 
<a name="l01408"></a>01408          lua_pop(L, 3);
<a name="l01409"></a>01409          <span class="keywordflow">return</span> 1;
<a name="l01410"></a>01410       }
<a name="l01411"></a>01411    }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413    <span class="comment">/* pop the includes table */</span>
<a name="l01414"></a>01414    lua_pop(L, 1);
<a name="l01415"></a>01415    <span class="keywordflow">return</span> 0;
<a name="l01416"></a>01416 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2555949b938e7a61910dab4b1584a45e"></a><!-- doxytag: member="pbx_lua.c::lua_free_extensions" ref="a2555949b938e7a61910dab4b1584a45e" args="()" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_free_extensions </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Free the internal extensions buffer. </p>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01061">1061</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00101">config_file_lock</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01448">unload_module()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01062"></a>01062 {
<a name="l01063"></a>01063    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l01064"></a>01064    <a class="code" href="pbx__lua_8c.html#a2d7c1872fa6e3a83bb32f9314da5550b">config_file_size</a> = 0;
<a name="l01065"></a>01065    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a>);
<a name="l01066"></a>01066    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l01067"></a>01067 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6c6b10bc3f870b99a1c49c1739382e09"></a><!-- doxytag: member="pbx_lua.c::lua_func_read" ref="a6c6b10bc3f870b99a1c49c1739382e09" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_func_read </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Create a 'variable' object for accessing a dialplan function (for access from lua, don't call directly) </p>
<p>This function is called to create a 'variable' object to access a dialplan function. It would be called in the following example as would be seen in extensions.lua.</p>
<div class="fragment"><pre class="fragment"> channel.func(<span class="stringliteral">&quot;arg1&quot;</span>, <span class="stringliteral">&quot;arg2&quot;</span>, <span class="stringliteral">&quot;arg3&quot;</span>)
</pre></div><p>To actually do anything with the resulting value you must use the 'get()' and 'set()' methods (the reason is the resulting value is not a value, but an object in the form of a lua table). </p>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00596">596</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="utils_8c_source.html#l01299">ast_build_string()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="pbx__lua_8c_source.html#l00058">LUA_EXT_DATA_SIZE</a>, <a class="el" href="pbx__lua_8c_source.html#l00383">lua_push_variable_table()</a>, and <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00444">lua_create_variable_metatable()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00597"></a>00597 {
<a name="l00598"></a>00598    <span class="keywordtype">int</span> nargs = lua_gettop(L);
<a name="l00599"></a>00599    <span class="keywordtype">char</span> fullname[<a class="code" href="pbx__lua_8c.html#a8f0cf0337474a0b28ed30ab13f729f80">LUA_EXT_DATA_SIZE</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00600"></a>00600    <span class="keywordtype">char</span> *fullname_next = fullname, *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00601"></a>00601    <span class="keywordtype">size_t</span> fullname_left = <span class="keyword">sizeof</span>(fullname);
<a name="l00602"></a>00602    
<a name="l00603"></a>00603    lua_getfield(L, 1, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00604"></a>00604    name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(lua_tostring(L, -1));
<a name="l00605"></a>00605    lua_pop(L, 1);
<a name="l00606"></a>00606 
<a name="l00607"></a>00607    <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;fullname_next, &amp;fullname_left, <span class="stringliteral">&quot;%s(&quot;</span>, name);
<a name="l00608"></a>00608    
<a name="l00609"></a>00609    <span class="keywordflow">if</span> (nargs &gt; 1) {
<a name="l00610"></a>00610       <span class="keywordtype">int</span> i;
<a name="l00611"></a>00611 
<a name="l00612"></a>00612       <span class="keywordflow">if</span> (!lua_isnil(L, 2))
<a name="l00613"></a>00613          <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;fullname_next, &amp;fullname_left, <span class="stringliteral">&quot;%s&quot;</span>, luaL_checkstring(L, 2));
<a name="l00614"></a>00614 
<a name="l00615"></a>00615       <span class="keywordflow">for</span> (i = 3; i &lt;= nargs; i++) {
<a name="l00616"></a>00616          <span class="keywordflow">if</span> (lua_isnil(L, i))
<a name="l00617"></a>00617             <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;fullname_next, &amp;fullname_left, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00618"></a>00618          <span class="keywordflow">else</span>
<a name="l00619"></a>00619             <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;fullname_next, &amp;fullname_left, <span class="stringliteral">&quot;,%s&quot;</span>, luaL_checkstring(L, i));
<a name="l00620"></a>00620       }
<a name="l00621"></a>00621    }
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;fullname_next, &amp;fullname_left, <span class="stringliteral">&quot;)&quot;</span>);
<a name="l00624"></a>00624    
<a name="l00625"></a>00625    <a class="code" href="pbx__lua_8c.html#a27fbef4dae2cd7fe0889b739d4466496" title="Push a &amp;#39;variable&amp;#39; table on the stack for access the channel variable with...">lua_push_variable_table</a>(L, fullname);
<a name="l00626"></a>00626    
<a name="l00627"></a>00627    <span class="keywordflow">return</span> 1;
<a name="l00628"></a>00628 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad50255c1af5d6d906cded525f8418b5e"></a><!-- doxytag: member="pbx_lua.c::lua_get_state" ref="ad50255c1af5d6d906cded525f8418b5e" args="(struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static lua_State * lua_get_state </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Get the lua_State for this channel. </p>
<p>If no channel is passed then a new <a class="el" href="structstate.html">state</a> is allocated. States with no channel assocatied with them should only be used for matching extensions. If the channel does not yet have a lua <a class="el" href="structstate.html">state</a> associated with it, one will be created.</p>
<dl class="note"><dt><b>Note:</b></dt><dd>If no channel was passed then the caller is expected to free the <a class="el" href="structstate.html">state</a> using lua_close().</dd></dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a lua_State </dd></dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01082">1082</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="channel_8c_source.html#l01534">ast_channel_datastore_add()</a>, <a class="el" href="channel_8c_source.html#l01548">ast_channel_datastore_find()</a>, <a class="el" href="channel_8c_source.html#l01543">ast_channel_datastore_remove()</a>, <a class="el" href="lock_8h_source.html#l02031">ast_channel_lock</a>, <a class="el" href="lock_8h_source.html#l02034">ast_channel_unlock</a>, <a class="el" href="datastore_8h_source.html#l00071">ast_datastore_alloc</a>, <a class="el" href="datastore_8c_source.html#l00058">ast_datastore_free()</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="datastore_8h_source.html#l00056">ast_datastore::data</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, and <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01167">canmatch()</a>, <a class="el" href="pbx__lua_8c_source.html#l01214">exec()</a>, <a class="el" href="pbx__lua_8c_source.html#l01144">exists()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01190">matchmore()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01083"></a>01083 {
<a name="l01084"></a>01084    <span class="keyword">struct </span><a class="code" href="structast__datastore.html" title="Structure for a data store object.">ast_datastore</a> *datastore = NULL;
<a name="l01085"></a>01085    lua_State *L;
<a name="l01086"></a>01086 
<a name="l01087"></a>01087    <span class="keywordflow">if</span> (!chan) {
<a name="l01088"></a>01088       lua_State *L = luaL_newstate();
<a name="l01089"></a>01089       <span class="keywordflow">if</span> (!L) {
<a name="l01090"></a>01090          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error allocating lua_State, no memory\n&quot;</span>);
<a name="l01091"></a>01091          <span class="keywordflow">return</span> NULL;
<a name="l01092"></a>01092       }
<a name="l01093"></a>01093 
<a name="l01094"></a>01094       <span class="keywordflow">if</span> (<a class="code" href="pbx__lua_8c.html#acba99420a91648953bbd8ce463a4dfd3" title="Load the extensions.lua file from the internal buffer.">lua_load_extensions</a>(L, NULL)) {
<a name="l01095"></a>01095          <span class="keyword">const</span> <span class="keywordtype">char</span> *error = lua_tostring(L, -1);
<a name="l01096"></a>01096          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error loading extensions.lua: %s\n&quot;</span>, error);
<a name="l01097"></a>01097          lua_close(L);
<a name="l01098"></a>01098          <span class="keywordflow">return</span> NULL;
<a name="l01099"></a>01099       }
<a name="l01100"></a>01100       <span class="keywordflow">return</span> L;
<a name="l01101"></a>01101    } <span class="keywordflow">else</span> {
<a name="l01102"></a>01102       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01103"></a>01103       datastore = <a class="code" href="channel_8h.html#aad1e09cd7c79237d05cffb45d6cdfd7c" title="Find a datastore on a channel.">ast_channel_datastore_find</a>(chan, &amp;<a class="code" href="pbx__lua_8c.html#a11cd8c2600fb5e70db6e795fbabdfefb">lua_datastore</a>, NULL);
<a name="l01104"></a>01104       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01105"></a>01105 
<a name="l01106"></a>01106       <span class="keywordflow">if</span> (!datastore) {
<a name="l01107"></a>01107          <span class="comment">/* nothing found, allocate a new lua state */</span>
<a name="l01108"></a>01108          datastore = <a class="code" href="datastore_8h.html#a666afb07fd77d50782cc10f83e029159">ast_datastore_alloc</a>(&amp;<a class="code" href="pbx__lua_8c.html#a11cd8c2600fb5e70db6e795fbabdfefb">lua_datastore</a>, NULL);
<a name="l01109"></a>01109          <span class="keywordflow">if</span> (!datastore) {
<a name="l01110"></a>01110             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error allocation channel datastore for lua_State\n&quot;</span>);
<a name="l01111"></a>01111             <span class="keywordflow">return</span> NULL;
<a name="l01112"></a>01112          }
<a name="l01113"></a>01113 
<a name="l01114"></a>01114          datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a> = luaL_newstate();
<a name="l01115"></a>01115          <span class="keywordflow">if</span> (!datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>) {
<a name="l01116"></a>01116             <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(datastore);
<a name="l01117"></a>01117             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error allocating lua_State, no memory\n&quot;</span>);
<a name="l01118"></a>01118             <span class="keywordflow">return</span> NULL;
<a name="l01119"></a>01119          }
<a name="l01120"></a>01120 
<a name="l01121"></a>01121          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01122"></a>01122          <a class="code" href="channel_8h.html#a1ed3e98d33d5587948a0e2ef67a81f52" title="Add a datastore to a channel.">ast_channel_datastore_add</a>(chan, datastore);
<a name="l01123"></a>01123          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01124"></a>01124 
<a name="l01125"></a>01125          L = datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l01126"></a>01126 
<a name="l01127"></a>01127          <span class="keywordflow">if</span> (<a class="code" href="pbx__lua_8c.html#acba99420a91648953bbd8ce463a4dfd3" title="Load the extensions.lua file from the internal buffer.">lua_load_extensions</a>(L, chan)) {
<a name="l01128"></a>01128             <span class="keyword">const</span> <span class="keywordtype">char</span> *error = lua_tostring(L, -1);
<a name="l01129"></a>01129             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error loading extensions.lua for %s: %s\n&quot;</span>, chan-&gt;name, error);
<a name="l01130"></a>01130 
<a name="l01131"></a>01131             <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l01132"></a>01132             <a class="code" href="channel_8h.html#a1ff1c62b6d50823da93a920575c9c0c9" title="Remove a datastore from a channel.">ast_channel_datastore_remove</a>(chan, datastore);
<a name="l01133"></a>01133             <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l01134"></a>01134 
<a name="l01135"></a>01135             <a class="code" href="datastore_8h.html#aee27286888b30c6448a9bce928040a14" title="Free a data store object.">ast_datastore_free</a>(datastore);
<a name="l01136"></a>01136             <span class="keywordflow">return</span> NULL;
<a name="l01137"></a>01137          }
<a name="l01138"></a>01138       }
<a name="l01139"></a>01139 
<a name="l01140"></a>01140       <span class="keywordflow">return</span> datastore-&gt;<a class="code" href="structast__datastore.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l01141"></a>01141    }
<a name="l01142"></a>01142 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aded2079ad83f5f3eb6298bcfe77a30d1"></a><!-- doxytag: member="pbx_lua.c::lua_get_variable" ref="aded2079ad83f5f3eb6298bcfe77a30d1" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_get_variable </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Return a lua 'variable' object (for access from lua, don't call directly) </p>
<p>This function is called to lookup a variable construct a 'variable' object. It would be called in the following example as would be seen in extensions.lua.</p>
<div class="fragment"><pre class="fragment"> channel.variable
</pre></div> 
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00515">515</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="adsistub_8c_source.html#l00049">chan</a>, <a class="el" href="pbx__lua_8c_source.html#l00059">LUA_BUF_SIZE</a>, <a class="el" href="pbx__lua_8c_source.html#l00383">lua_push_variable_table()</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="pbx_8c_source.html#l02867">pbx_retrieve_variable()</a>, and <a class="el" href="channel_8h_source.html#l00446">ast_channel::varshead</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00422">lua_create_channel_table()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00516"></a>00516 {
<a name="l00517"></a>00517    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00518"></a>00518    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(luaL_checkstring(L, 2));
<a name="l00519"></a>00519    <span class="keywordtype">char</span> *value = NULL;
<a name="l00520"></a>00520    <span class="keywordtype">char</span> *workspace = alloca(<a class="code" href="pbx__lua_8c.html#a599a30638feeaa8bece87a6f4eb4bae1">LUA_BUF_SIZE</a>);
<a name="l00521"></a>00521    workspace[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00522"></a>00522    
<a name="l00523"></a>00523    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00524"></a>00524    chan = lua_touserdata(L, -1);
<a name="l00525"></a>00525    lua_pop(L, 1);
<a name="l00526"></a>00526 
<a name="l00527"></a>00527    <a class="code" href="pbx__lua_8c.html#a27fbef4dae2cd7fe0889b739d4466496" title="Push a &amp;#39;variable&amp;#39; table on the stack for access the channel variable with...">lua_push_variable_table</a>(L, name);
<a name="l00528"></a>00528    
<a name="l00529"></a>00529    <span class="comment">/* if this is not a request for a dialplan funciton attempt to retrieve</span>
<a name="l00530"></a>00530 <span class="comment">    * the value of the variable */</span>
<a name="l00531"></a>00531    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(name) &amp;&amp; name[strlen(name) - 1] != <span class="charliteral">&apos;)&apos;</span>) {
<a name="l00532"></a>00532       <a class="code" href="pbx_8h.html#aaf906a18ba2dcd53c35f59869757521f" title="Retrieve the value of a builtin variable or variable from the channel variable stack...">pbx_retrieve_variable</a>(chan, name, &amp;value, workspace, <a class="code" href="pbx__lua_8c.html#a599a30638feeaa8bece87a6f4eb4bae1">LUA_BUF_SIZE</a>, &amp;chan-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>);
<a name="l00533"></a>00533    }
<a name="l00534"></a>00534 
<a name="l00535"></a>00535    <span class="keywordflow">if</span> (value) {
<a name="l00536"></a>00536       lua_pushstring(L, value);
<a name="l00537"></a>00537       lua_setfield(L, -2, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l00538"></a>00538    }
<a name="l00539"></a>00539 
<a name="l00540"></a>00540    <span class="keywordflow">return</span> 1;   
<a name="l00541"></a>00541 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a28934dd2a760fd2d1a8b2ba25dac5c86"></a><!-- doxytag: member="pbx_lua.c::lua_get_variable_value" ref="a28934dd2a760fd2d1a8b2ba25dac5c86" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_get_variable_value </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Used to get the value of a variable or dialplan function (for access from lua, don't call directly) </p>
<p>The value of the variable or function is returned. This function is the 'get()' function in the following example as would be seen in extensions.lua.</p>
<div class="fragment"><pre class="fragment"> channel.variable:<span class="keyword">get</span>()
</pre></div> 
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00260">260</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="pbx_8c_source.html#l03356">ast_func_read()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="strings_8h_source.html#l00063">ast_strlen_zero()</a>, <a class="el" href="adsistub_8c_source.html#l00049">chan</a>, <a class="el" href="pbx__lua_8c_source.html#l00059">LUA_BUF_SIZE</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, <a class="el" href="pbx_8c_source.html#l02867">pbx_retrieve_variable()</a>, and <a class="el" href="channel_8h_source.html#l00446">ast_channel::varshead</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00383">lua_push_variable_table()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00261"></a>00261 {
<a name="l00262"></a>00262    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00263"></a>00263    <span class="keywordtype">char</span> *value = NULL, *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>;
<a name="l00264"></a>00264    <span class="keywordtype">char</span> *workspace = alloca(<a class="code" href="pbx__lua_8c.html#a599a30638feeaa8bece87a6f4eb4bae1">LUA_BUF_SIZE</a>);
<a name="l00265"></a>00265    <span class="keywordtype">int</span> autoservice;
<a name="l00266"></a>00266 
<a name="l00267"></a>00267    workspace[0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00268"></a>00268 
<a name="l00269"></a>00269    <span class="keywordflow">if</span> (!lua_istable(L, 1)) {
<a name="l00270"></a>00270       lua_pushstring(L, <span class="stringliteral">&quot;User probably used &apos;.&apos; instead of &apos;:&apos; for retrieving a channel variable value&quot;</span>);
<a name="l00271"></a>00271       <span class="keywordflow">return</span> lua_error(L);
<a name="l00272"></a>00272    }
<a name="l00273"></a>00273    
<a name="l00274"></a>00274    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00275"></a>00275    chan = lua_touserdata(L, -1);
<a name="l00276"></a>00276    lua_pop(L, 1);
<a name="l00277"></a>00277 
<a name="l00278"></a>00278    lua_getfield(L, 1, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00279"></a>00279    name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(lua_tostring(L, -1));
<a name="l00280"></a>00280    lua_pop(L, 1);
<a name="l00281"></a>00281    
<a name="l00282"></a>00282    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00283"></a>00283    autoservice = lua_toboolean(L, -1);
<a name="l00284"></a>00284    lua_pop(L, 1);
<a name="l00285"></a>00285 
<a name="l00286"></a>00286    <span class="keywordflow">if</span> (autoservice)
<a name="l00287"></a>00287       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00288"></a>00288    
<a name="l00289"></a>00289    <span class="comment">/* if this is a dialplan function then use ast_func_read(), otherwise</span>
<a name="l00290"></a>00290 <span class="comment">    * use pbx_retrieve_variable() */</span>
<a name="l00291"></a>00291    <span class="keywordflow">if</span> (!<a class="code" href="strings_8h.html#a5c8aa5212ecb665fb072eac00c799da6">ast_strlen_zero</a>(name) &amp;&amp; name[strlen(name) - 1] == <span class="charliteral">&apos;)&apos;</span>) {
<a name="l00292"></a>00292       value = <a class="code" href="pbx_8h.html#aa4e9618aa036a586af7d7663afd9b507" title="executes a read operation on a function">ast_func_read</a>(chan, name, workspace, <a class="code" href="pbx__lua_8c.html#a599a30638feeaa8bece87a6f4eb4bae1">LUA_BUF_SIZE</a>) ? NULL : workspace;
<a name="l00293"></a>00293    } <span class="keywordflow">else</span> {
<a name="l00294"></a>00294       <a class="code" href="pbx_8h.html#aaf906a18ba2dcd53c35f59869757521f" title="Retrieve the value of a builtin variable or variable from the channel variable stack...">pbx_retrieve_variable</a>(chan, name, &amp;value, workspace, <a class="code" href="pbx__lua_8c.html#a599a30638feeaa8bece87a6f4eb4bae1">LUA_BUF_SIZE</a>, &amp;chan-&gt;<a class="code" href="structast__channel.html#a9ffb22045a8f14bef8f2137cd779ab25">varshead</a>);
<a name="l00295"></a>00295    }
<a name="l00296"></a>00296    
<a name="l00297"></a>00297    <span class="keywordflow">if</span> (autoservice)
<a name="l00298"></a>00298       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00299"></a>00299 
<a name="l00300"></a>00300    <span class="keywordflow">if</span> (value) {
<a name="l00301"></a>00301       lua_pushstring(L, value);
<a name="l00302"></a>00302    } <span class="keywordflow">else</span> {
<a name="l00303"></a>00303       lua_pushnil(L);
<a name="l00304"></a>00304    }
<a name="l00305"></a>00305 
<a name="l00306"></a>00306    <span class="keywordflow">return</span> 1;
<a name="l00307"></a>00307 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="acba99420a91648953bbd8ce463a4dfd3"></a><!-- doxytag: member="pbx_lua.c::lua_load_extensions" ref="acba99420a91648953bbd8ce463a4dfd3" args="(lua_State *L, struct ast_channel *chan)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_load_extensions </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Load the extensions.lua file from the internal buffer. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>chan</em>&nbsp;</td><td>channel to work on</td></tr>
  </table>
  </dd>
</dl>
<p>This function also sets up some constructs used by the extensions.lua file. In the event of an error, an error string will be pushed onto the lua stack.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00983">983</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="pbx__lua_8c_source.html#l00101">config_file_lock</a>, <a class="el" href="pbx__lua_8c_source.html#l00404">lua_create_app_table()</a>, <a class="el" href="pbx__lua_8c_source.html#l00461">lua_create_application_metatable()</a>, <a class="el" href="pbx__lua_8c_source.html#l00477">lua_create_autoservice_functions()</a>, <a class="el" href="pbx__lua_8c_source.html#l00422">lua_create_channel_table()</a>, <a class="el" href="pbx__lua_8c_source.html#l00497">lua_create_hangup_function()</a>, <a class="el" href="pbx__lua_8c_source.html#l00444">lua_create_variable_metatable()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00767">lua_sort_extensions()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01082">lua_get_state()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00984"></a>00984 {
<a name="l00985"></a>00985    
<a name="l00986"></a>00986    <span class="comment">/* store a pointer to this channel */</span>
<a name="l00987"></a>00987    lua_pushlightuserdata(L, chan);
<a name="l00988"></a>00988    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00989"></a>00989    
<a name="l00990"></a>00990    luaL_openlibs(L);
<a name="l00991"></a>00991 
<a name="l00992"></a>00992    <span class="comment">/* load and sort extensions */</span>
<a name="l00993"></a>00993    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l00994"></a>00994    <span class="keywordflow">if</span> (luaL_loadbuffer(L, <a class="code" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a>, <a class="code" href="pbx__lua_8c.html#a2d7c1872fa6e3a83bb32f9314da5550b">config_file_size</a>, <span class="stringliteral">&quot;extensions.lua&quot;</span>)
<a name="l00995"></a>00995          || lua_pcall(L, 0, LUA_MULTRET, 0)
<a name="l00996"></a>00996          || <a class="code" href="pbx__lua_8c.html#aca3ce86b468f3bd615cae1b5f364c0dc" title="Store the sort order of each context.">lua_sort_extensions</a>(L)) {
<a name="l00997"></a>00997       <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l00998"></a>00998       <span class="keywordflow">return</span> 1;
<a name="l00999"></a>00999    }
<a name="l01000"></a>01000    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l01001"></a>01001 
<a name="l01002"></a>01002    <span class="comment">/* now we setup special tables and functions */</span>
<a name="l01003"></a>01003 
<a name="l01004"></a>01004    <a class="code" href="pbx__lua_8c.html#a57515b7151fb9d9f61f1273b64c053f6" title="Create the global &amp;#39;app&amp;#39; table for executing applications.">lua_create_app_table</a>(L);
<a name="l01005"></a>01005    <a class="code" href="pbx__lua_8c.html#ab29bd5e4bee0b4526e66354deae95d75" title="Create the global &amp;#39;channel&amp;#39; table for accesing channel variables.">lua_create_channel_table</a>(L);
<a name="l01006"></a>01006 
<a name="l01007"></a>01007    <a class="code" href="pbx__lua_8c.html#ab906c45be529901f58f56dacae7beaa2" title="Create the &amp;#39;variable&amp;#39; metatable, used to retrieve channel variables.">lua_create_variable_metatable</a>(L);
<a name="l01008"></a>01008    <a class="code" href="pbx__lua_8c.html#a175cbb4330c4e669860e390890c4f36b" title="Create the &amp;#39;application&amp;#39; metatable, used to execute asterisk applications...">lua_create_application_metatable</a>(L);
<a name="l01009"></a>01009 
<a name="l01010"></a>01010    <a class="code" href="pbx__lua_8c.html#a2d0ef4e67695479b96e068aa3094c249" title="Create the autoservice functions.">lua_create_autoservice_functions</a>(L);
<a name="l01011"></a>01011    <a class="code" href="pbx__lua_8c.html#a134a2cbe4ac0e35ea02622cc5a92a7d6" title="Create the hangup check function.">lua_create_hangup_function</a>(L);
<a name="l01012"></a>01012 
<a name="l01013"></a>01013    <span class="keywordflow">return</span> 0;
<a name="l01014"></a>01014 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a905bd9391828306c844ed88d28ab00c3"></a><!-- doxytag: member="pbx_lua.c::lua_pbx_exec" ref="a905bd9391828306c844ed88d28ab00c3" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_pbx_exec </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] This function is part of the 'application' metatable and is used to execute applications similar to <a class="el" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec()</a> (for access from lua, don't call directly) </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>nothing</dd></dl>
<p>This funciton is executed as the '()' operator for <a class="el" href="structapps.html">apps</a> accessed through the 'app' table.</p>
<div class="fragment"><pre class="fragment"> <a class="code" href="app__adsiprog_8c.html#a9e5f57131367eff409b9e0bd7b31aa1a">app</a>.playback(<span class="stringliteral">&apos;demo-congrats&apos;</span>)
</pre></div> 
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00165">165</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="adsistub_8c_source.html#l00053">app</a>, <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="utils_8c_source.html#l01299">ast_build_string()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="logger_8h_source.html#l00220">ast_verb</a>, <a class="el" href="adsistub_8c_source.html#l00049">chan</a>, <a class="el" href="term_8h_source.html#l00060">COLOR_BRCYAN</a>, <a class="el" href="term_8h_source.html#l00058">COLOR_BRMAGENTA</a>, <a class="el" href="chan__alsa_8c_source.html#l00105">context</a>, <a class="el" href="chan__alsa_8c_source.html#l00107">exten</a>, <a class="el" href="pbx__lua_8c_source.html#l00058">LUA_EXT_DATA_SIZE</a>, <a class="el" href="pbx_8c_source.html#l01322">pbx_exec()</a>, <a class="el" href="pbx_8c_source.html#l01363">pbx_findapp()</a>, and <a class="el" href="term_8c_source.html#l00168">term_color()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00461">lua_create_application_metatable()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00166"></a>00166 {
<a name="l00167"></a>00167    <span class="keywordtype">int</span> res, nargs = lua_gettop(L);
<a name="l00168"></a>00168    <span class="keywordtype">char</span> <a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>[<a class="code" href="pbx__lua_8c.html#a8f0cf0337474a0b28ed30ab13f729f80">LUA_EXT_DATA_SIZE</a>] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00169"></a>00169    <span class="keywordtype">char</span> *data_next = data, *app_name;
<a name="l00170"></a>00170    <span class="keywordtype">char</span> *<a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, *<a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>;
<a name="l00171"></a>00171    <span class="keywordtype">char</span> tmp[80], tmp2[80], tmp3[<a class="code" href="pbx__lua_8c.html#a8f0cf0337474a0b28ed30ab13f729f80">LUA_EXT_DATA_SIZE</a>];
<a name="l00172"></a>00172    <span class="keywordtype">int</span> <a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>, autoservice;
<a name="l00173"></a>00173    <span class="keywordtype">size_t</span> data_left = <span class="keyword">sizeof</span>(data);
<a name="l00174"></a>00174    <span class="keyword">struct </span><a class="code" href="structast__app.html" title="ast_app: A registered application">ast_app</a> *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>;
<a name="l00175"></a>00175    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00176"></a>00176    
<a name="l00177"></a>00177    lua_getfield(L, 1, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00178"></a>00178    app_name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(lua_tostring(L, -1));
<a name="l00179"></a>00179    lua_pop(L, 1);
<a name="l00180"></a>00180    
<a name="l00181"></a>00181    <span class="keywordflow">if</span> (!(app = <a class="code" href="pbx_8h.html#a0db9808b647984133225652170b22b79" title="Look up an application.">pbx_findapp</a>(app_name))) {
<a name="l00182"></a>00182       lua_pushstring(L, <span class="stringliteral">&quot;application &apos;&quot;</span>);
<a name="l00183"></a>00183       lua_pushstring(L, app_name);
<a name="l00184"></a>00184       lua_pushstring(L, <span class="stringliteral">&quot;&apos; not found&quot;</span>);
<a name="l00185"></a>00185       lua_concat(L, 3);
<a name="l00186"></a>00186       <span class="keywordflow">return</span> lua_error(L);
<a name="l00187"></a>00187    }
<a name="l00188"></a>00188    
<a name="l00189"></a>00189 
<a name="l00190"></a>00190    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00191"></a>00191    chan = lua_touserdata(L, -1);
<a name="l00192"></a>00192    lua_pop(L, 1);
<a name="l00193"></a>00193    
<a name="l00194"></a>00194    
<a name="l00195"></a>00195    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;context&quot;</span>);
<a name="l00196"></a>00196    context = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(lua_tostring(L, -1));
<a name="l00197"></a>00197    lua_pop(L, 1);
<a name="l00198"></a>00198    
<a name="l00199"></a>00199    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;exten&quot;</span>);
<a name="l00200"></a>00200    exten = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(lua_tostring(L, -1));
<a name="l00201"></a>00201    lua_pop(L, 1);
<a name="l00202"></a>00202    
<a name="l00203"></a>00203    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;priority&quot;</span>);
<a name="l00204"></a>00204    priority = lua_tointeger(L, -1);
<a name="l00205"></a>00205    lua_pop(L, 1);
<a name="l00206"></a>00206 
<a name="l00207"></a>00207 
<a name="l00208"></a>00208    <span class="keywordflow">if</span> (nargs &gt; 1) {
<a name="l00209"></a>00209       <span class="keywordtype">int</span> i;
<a name="l00210"></a>00210 
<a name="l00211"></a>00211       <span class="keywordflow">if</span> (!lua_isnil(L, 2))
<a name="l00212"></a>00212          <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;data_next, &amp;data_left, <span class="stringliteral">&quot;%s&quot;</span>, luaL_checkstring(L, 2));
<a name="l00213"></a>00213 
<a name="l00214"></a>00214       <span class="keywordflow">for</span> (i = 3; i &lt;= nargs; i++) {
<a name="l00215"></a>00215          <span class="keywordflow">if</span> (lua_isnil(L, i))
<a name="l00216"></a>00216             <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;data_next, &amp;data_left, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l00217"></a>00217          <span class="keywordflow">else</span>
<a name="l00218"></a>00218             <a class="code" href="strings_8h.html#a603020160399d4876ec09fd299ebcaf9" title="Build a string in a buffer, designed to be called repeatedly.">ast_build_string</a>(&amp;data_next, &amp;data_left, <span class="stringliteral">&quot;,%s&quot;</span>, luaL_checkstring(L, i));
<a name="l00219"></a>00219       }
<a name="l00220"></a>00220    }
<a name="l00221"></a>00221    
<a name="l00222"></a>00222    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Executing [%s@%s:%d] %s(\&quot;%s\&quot;, \&quot;%s\&quot;)\n&quot;</span>,
<a name="l00223"></a>00223          exten, context, priority,
<a name="l00224"></a>00224          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp, app_name, <a class="code" href="term_8h.html#a23aeefae76b2cacc1a6162de88c3fff0">COLOR_BRCYAN</a>, 0, <span class="keyword">sizeof</span>(tmp)),
<a name="l00225"></a>00225          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp2, chan-&gt;name, <a class="code" href="term_8h.html#aee88b2ffd7fd2128fe38896cffb1a71a">COLOR_BRMAGENTA</a>, 0, <span class="keyword">sizeof</span>(tmp2)),
<a name="l00226"></a>00226          <a class="code" href="term_8h.html#a7b6c72116c334f40bf7c1e50e793c93b">term_color</a>(tmp3, data, <a class="code" href="term_8h.html#aee88b2ffd7fd2128fe38896cffb1a71a">COLOR_BRMAGENTA</a>, 0, <span class="keyword">sizeof</span>(tmp3)));
<a name="l00227"></a>00227 
<a name="l00228"></a>00228    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00229"></a>00229    autoservice = lua_toboolean(L, -1);
<a name="l00230"></a>00230    lua_pop(L, 1);
<a name="l00231"></a>00231 
<a name="l00232"></a>00232    <span class="keywordflow">if</span> (autoservice)
<a name="l00233"></a>00233       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00234"></a>00234 
<a name="l00235"></a>00235    res = <a class="code" href="pbx_8h.html#afb87ff7a4504ef6031a45ae4170acaad" title="Execute an application.">pbx_exec</a>(chan, app, data);
<a name="l00236"></a>00236    
<a name="l00237"></a>00237    <span class="keywordflow">if</span> (autoservice)
<a name="l00238"></a>00238       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00239"></a>00239 
<a name="l00240"></a>00240    <span class="comment">/* error executing an application, report it */</span>
<a name="l00241"></a>00241    <span class="keywordflow">if</span> (res) {
<a name="l00242"></a>00242       lua_pushinteger(L, res);
<a name="l00243"></a>00243       <span class="keywordflow">return</span> lua_error(L);
<a name="l00244"></a>00244    }
<a name="l00245"></a>00245    <span class="keywordflow">return</span> 0;
<a name="l00246"></a>00246 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a509cf8d60309eeb98d81c62d5f6642f8"></a><!-- doxytag: member="pbx_lua.c::lua_pbx_findapp" ref="a509cf8d60309eeb98d81c62d5f6642f8" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_pbx_findapp </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Find an app and return it in a lua table (for access from lua, don't call directly) </p>
<p>This function would be called in the following example as it would be found in extensions.lua.</p>
<div class="fragment"><pre class="fragment"> app.dial
</pre></div> 
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00134">134</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00404">lua_create_app_table()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00135"></a>00135 {
<a name="l00136"></a>00136    <span class="keyword">const</span> <span class="keywordtype">char</span> *app_name = luaL_checkstring(L, 2);
<a name="l00137"></a>00137    
<a name="l00138"></a>00138    lua_newtable(L);
<a name="l00139"></a>00139 
<a name="l00140"></a>00140    lua_pushstring(L, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00141"></a>00141    lua_pushstring(L, app_name);
<a name="l00142"></a>00142    lua_settable(L, -3);
<a name="l00143"></a>00143 
<a name="l00144"></a>00144    luaL_getmetatable(L, <span class="stringliteral">&quot;application&quot;</span>);
<a name="l00145"></a>00145    lua_setmetatable(L, -2);
<a name="l00146"></a>00146 
<a name="l00147"></a>00147    <span class="keywordflow">return</span> 1;
<a name="l00148"></a>00148 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a27fbef4dae2cd7fe0889b739d4466496"></a><!-- doxytag: member="pbx_lua.c::lua_push_variable_table" ref="a27fbef4dae2cd7fe0889b739d4466496" args="(lua_State *L, const char *name)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_push_variable_table </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>name</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Push a 'variable' table on the stack for access the channel variable with the given name. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>name</em>&nbsp;</td><td>the name of the variable </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00383">383</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l00260">lua_get_variable_value()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00320">lua_set_variable_value()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00596">lua_func_read()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00515">lua_get_variable()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00384"></a>00384 {
<a name="l00385"></a>00385    lua_newtable(L);
<a name="l00386"></a>00386    luaL_getmetatable(L, <span class="stringliteral">&quot;variable&quot;</span>);
<a name="l00387"></a>00387    lua_setmetatable(L, -2);
<a name="l00388"></a>00388 
<a name="l00389"></a>00389    lua_pushstring(L, <a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>);
<a name="l00390"></a>00390    lua_setfield(L, -2, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00391"></a>00391    
<a name="l00392"></a>00392    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a28934dd2a760fd2d1a8b2ba25dac5c86" title="[lua_CFunction] Used to get the value of a variable or dialplan function (for access...">lua_get_variable_value</a>);
<a name="l00393"></a>00393    lua_setfield(L, -2, <span class="stringliteral">&quot;get&quot;</span>);
<a name="l00394"></a>00394    
<a name="l00395"></a>00395    lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#a6dc56ee4d2399626018669620002778d" title="[lua_CFunction] Used to set the value of a variable or dialplan function (for access...">lua_set_variable_value</a>);
<a name="l00396"></a>00396    lua_setfield(L, -2, <span class="stringliteral">&quot;set&quot;</span>);
<a name="l00397"></a>00397 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a0ba76f3093bed14d623cb8f1b256e40f"></a><!-- doxytag: member="pbx_lua.c::lua_read_extensions_file" ref="a0ba76f3093bed14d623cb8f1b256e40f" args="(lua_State *L, long *size)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static char * lua_read_extensions_file </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">long *&nbsp;</td>
          <td class="paramname"> <em>size</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Load the extensions.lua file in to a buffer and execute the file. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>size</em>&nbsp;</td><td>a pointer to store the size of the buffer</td></tr>
  </table>
  </dd>
</dl>
<dl class="note"><dt><b>Note:</b></dt><dd>The caller is expected to free the buffer at some point.</dd></dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>a pointer to the buffer </dd></dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00926">926</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="asterisk_8c_source.html#l00248">ast_config_AST_CONFIG_DIR</a>, <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="astmm_8h_source.html#l00081">ast_malloc</a>, <a class="el" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>, <a class="el" href="format__g726_8c_source.html#l00177">f</a>, <a class="el" href="logger_8h_source.html#l00152">LOG_WARNING</a>, <a class="el" href="pbx__lua_8c_source.html#l00845">lua_register_switches()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00767">lua_sort_extensions()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01026">lua_reload_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00927"></a>00927 {
<a name="l00928"></a>00928    FILE *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00929"></a>00929    <span class="keywordtype">char</span> *<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>;
<a name="l00930"></a>00930    <span class="keywordtype">char</span> *path = alloca(strlen(<a class="code" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>) + strlen(<a class="code" href="paths_8h.html#a7d3836e5581e433c9f5edd30300cc187">ast_config_AST_CONFIG_DIR</a>) + 2);
<a name="l00931"></a>00931    sprintf(path, <span class="stringliteral">&quot;%s/%s&quot;</span>, <a class="code" href="paths_8h.html#a7d3836e5581e433c9f5edd30300cc187">ast_config_AST_CONFIG_DIR</a>, <a class="code" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a>);
<a name="l00932"></a>00932 
<a name="l00933"></a>00933    <span class="keywordflow">if</span> (!(f = fopen(path, <span class="stringliteral">&quot;r&quot;</span>))) {
<a name="l00934"></a>00934       lua_pushstring(L, <span class="stringliteral">&quot;cannot open &apos;&quot;</span>);
<a name="l00935"></a>00935       lua_pushstring(L, path);
<a name="l00936"></a>00936       lua_pushstring(L, <span class="stringliteral">&quot;&apos; for reading: &quot;</span>);
<a name="l00937"></a>00937       lua_pushstring(L, strerror(errno));
<a name="l00938"></a>00938       lua_concat(L, 4);
<a name="l00939"></a>00939 
<a name="l00940"></a>00940       <span class="keywordflow">return</span> NULL;
<a name="l00941"></a>00941    }
<a name="l00942"></a>00942 
<a name="l00943"></a>00943    fseek(f, 0l, SEEK_END);
<a name="l00944"></a>00944    *size = ftell(f);
<a name="l00945"></a>00945 
<a name="l00946"></a>00946    fseek(f, 0l, SEEK_SET);
<a name="l00947"></a>00947 
<a name="l00948"></a>00948    <span class="keywordflow">if</span> (!(data = <a class="code" href="astmm_8h.html#a64a0e7a3ab511a3777ac56f5d43c628e">ast_malloc</a>(*size))) {
<a name="l00949"></a>00949       *size = 0;
<a name="l00950"></a>00950       fclose(f);
<a name="l00951"></a>00951       lua_pushstring(L, <span class="stringliteral">&quot;not enough memory&quot;</span>);
<a name="l00952"></a>00952       <span class="keywordflow">return</span> NULL;
<a name="l00953"></a>00953    }
<a name="l00954"></a>00954 
<a name="l00955"></a>00955    <span class="keywordflow">if</span> (fread(data, <span class="keyword">sizeof</span>(<span class="keywordtype">char</span>), *size, f) != *size) {
<a name="l00956"></a>00956       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;fread() failed: %s\n&quot;</span>, strerror(errno));
<a name="l00957"></a>00957    }
<a name="l00958"></a>00958    fclose(f);
<a name="l00959"></a>00959 
<a name="l00960"></a>00960    <span class="keywordflow">if</span> (luaL_loadbuffer(L, data, *size, <span class="stringliteral">&quot;extensions.lua&quot;</span>)
<a name="l00961"></a>00961          || lua_pcall(L, 0, LUA_MULTRET, 0)
<a name="l00962"></a>00962          || <a class="code" href="pbx__lua_8c.html#aca3ce86b468f3bd615cae1b5f364c0dc" title="Store the sort order of each context.">lua_sort_extensions</a>(L)
<a name="l00963"></a>00963          || <a class="code" href="pbx__lua_8c.html#add206b06d14d62c6f190df4492a79ab7" title="Register dialplan switches for our pbx_lua contexs.">lua_register_switches</a>(L)) {
<a name="l00964"></a>00964       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(data);
<a name="l00965"></a>00965       data = NULL;
<a name="l00966"></a>00966       *size = 0;
<a name="l00967"></a>00967    }
<a name="l00968"></a>00968    <span class="keywordflow">return</span> data;
<a name="l00969"></a>00969 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="add206b06d14d62c6f190df4492a79ab7"></a><!-- doxytag: member="pbx_lua.c::lua_register_switches" ref="add206b06d14d62c6f190df4492a79ab7" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_register_switches </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Register dialplan <a class="el" href="structswitches.html">switches</a> for our pbx_lua contexs. </p>
<p>In the event of an error, an error string will be pushed onto the lua stack.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00845">845</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l07114">ast_context_add_switch2()</a>, <a class="el" href="pbx_8c_source.html#l06424">ast_context_find_or_create()</a>, <a class="el" href="pbx_8c_source.html#l00994">ast_hashtab_compare_contexts()</a>, <a class="el" href="hashtab_8c_source.html#l00222">ast_hashtab_create()</a>, <a class="el" href="pbx_8c_source.html#l01037">ast_hashtab_hash_contexts()</a>, <a class="el" href="hashtab_8c_source.html#l00127">ast_hashtab_newsize_java()</a>, <a class="el" href="hashtab_8c_source.html#l00084">ast_hashtab_resize_java()</a>, and <a class="el" href="chan__alsa_8c_source.html#l00105">context</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00926">lua_read_extensions_file()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00846"></a>00846 {
<a name="l00847"></a>00847    <span class="keywordtype">int</span> extensions;
<a name="l00848"></a>00848    <span class="keyword">struct </span><a class="code" href="structast__context.html" title="ast_context: An extension context">ast_context</a> *con = NULL;
<a name="l00849"></a>00849 
<a name="l00850"></a>00850    <span class="comment">/* create the hash table for our contexts */</span>
<a name="l00851"></a>00851    <span class="comment">/* XXX do we ever need to destroy this? pbx_config does not */</span>
<a name="l00852"></a>00852    <span class="keywordflow">if</span> (!<a class="code" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a>)
<a name="l00853"></a>00853       <a class="code" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a> = <a class="code" href="hashtab_8h.html#a85701d44df4ea1e746bde709a91a4192" title="Create the hashtable list.">ast_hashtab_create</a>(17, <a class="code" href="pbx_8h.html#a20a2f5668173430437db02cdd0acc9f3" title="hashtable functions for contexts">ast_hashtab_compare_contexts</a>, <a class="code" href="hashtab_8h.html#aef63906caa0b965e9c8d8561600038e9" title="Determines if a table resize should occur using the Java algorithm (if the table...">ast_hashtab_resize_java</a>, <a class="code" href="hashtab_8h.html#a743bfd52a8c9eb5d939ff5944758d846" title="Create a prime number roughly 2x the current table size.">ast_hashtab_newsize_java</a>, <a class="code" href="pbx_8h.html#a56461864a4e21b14e753b78f9ac7afb7">ast_hashtab_hash_contexts</a>, 0);
<a name="l00854"></a>00854 
<a name="l00855"></a>00855    <span class="comment">/* load the &apos;extensions&apos; table */</span>
<a name="l00856"></a>00856    lua_getglobal(L, <span class="stringliteral">&quot;extensions&quot;</span>);
<a name="l00857"></a>00857    extensions = lua_gettop(L);
<a name="l00858"></a>00858    <span class="keywordflow">if</span> (lua_isnil(L, -1)) {
<a name="l00859"></a>00859       lua_pop(L, 1);
<a name="l00860"></a>00860       lua_pushstring(L, <span class="stringliteral">&quot;Unable to find &apos;extensions&apos; table in extensions.lua\n&quot;</span>);
<a name="l00861"></a>00861       <span class="keywordflow">return</span> 1;
<a name="l00862"></a>00862    }
<a name="l00863"></a>00863 
<a name="l00864"></a>00864    <span class="comment">/* iterate through the extensions table and register a context and</span>
<a name="l00865"></a>00865 <span class="comment">    * dialplan switch for each lua context</span>
<a name="l00866"></a>00866 <span class="comment">    */</span>
<a name="l00867"></a>00867    <span class="keywordflow">for</span> (lua_pushnil(L); lua_next(L, extensions); lua_pop(L, 1)) {
<a name="l00868"></a>00868       <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> = lua_gettop(L);
<a name="l00869"></a>00869       <span class="keywordtype">int</span> context_name = context - 1;
<a name="l00870"></a>00870       <span class="keyword">const</span> <span class="keywordtype">char</span> *context_str = lua_tostring(L, context_name);
<a name="l00871"></a>00871 
<a name="l00872"></a>00872       <span class="comment">/* find or create this context */</span>
<a name="l00873"></a>00873       con = <a class="code" href="pbx_8h.html#a8a07400b41b3302edf8aef9f53644698" title="Register a new context or find an existing one.">ast_context_find_or_create</a>(&amp;<a class="code" href="pbx__lua_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a>, <a class="code" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a>, context_str, <a class="code" href="pbx__lua_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l00874"></a>00874       <span class="keywordflow">if</span> (!con) {
<a name="l00875"></a>00875          <span class="comment">/* remove extensions table and context key and value */</span>
<a name="l00876"></a>00876          lua_pop(L, 3);
<a name="l00877"></a>00877          lua_pushstring(L, <span class="stringliteral">&quot;Failed to find or create context\n&quot;</span>);
<a name="l00878"></a>00878          <span class="keywordflow">return</span> 1;
<a name="l00879"></a>00879       }
<a name="l00880"></a>00880 
<a name="l00881"></a>00881       <span class="comment">/* register the switch */</span>
<a name="l00882"></a>00882       <span class="keywordflow">if</span> (<a class="code" href="pbx_8h.html#a98b8af4a068416ee570f9d78cb9af724" title="Adds a switch (first param is a ast_context).">ast_context_add_switch2</a>(con, <span class="stringliteral">&quot;Lua&quot;</span>, <span class="stringliteral">&quot;&quot;</span>, 0, <a class="code" href="pbx__lua_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>)) {
<a name="l00883"></a>00883          <span class="comment">/* remove extensions table and context key and value */</span>
<a name="l00884"></a>00884          lua_pop(L, 3);
<a name="l00885"></a>00885          lua_pushstring(L, <span class="stringliteral">&quot;Unable to create switch for context\n&quot;</span>);
<a name="l00886"></a>00886          <span class="keywordflow">return</span> 1;
<a name="l00887"></a>00887       }
<a name="l00888"></a>00888    }
<a name="l00889"></a>00889    
<a name="l00890"></a>00890    <span class="comment">/* remove the extensions table */</span>
<a name="l00891"></a>00891    lua_pop(L, 1);
<a name="l00892"></a>00892    <span class="keywordflow">return</span> 0;
<a name="l00893"></a>00893 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5da7e8e127e797b0e15a2200400e546a"></a><!-- doxytag: member="pbx_lua.c::lua_reload_extensions" ref="a5da7e8e127e797b0e15a2200400e546a" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_reload_extensions </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Reload the extensions file and update the internal buffers if it loads correctly. </p>
<dl class="warning"><dt><b>Warning:</b></dt><dd>This function should not be called on a lua_State returned from <a class="el" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e" title="Get the lua_State for this channel.">lua_get_state()</a>.</dd></dl>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use (must be freshly allocated with luaL_newstate(), don't use <a class="el" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e" title="Get the lua_State for this channel.">lua_get_state()</a>) </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01026">1026</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="astmm_8h_source.html#l00087">ast_free</a>, <a class="el" href="pbx_8c_source.html#l06623">ast_merge_contexts_and_delete()</a>, <a class="el" href="lock_8h_source.html#l01717">ast_mutex_lock()</a>, <a class="el" href="lock_8h_source.html#l01707">ast_mutex_unlock()</a>, <a class="el" href="pbx__lua_8c_source.html#l00101">config_file_lock</a>, and <a class="el" href="pbx__lua_8c_source.html#l00926">lua_read_extensions_file()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01428">load_or_reload_lua_stuff()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01027"></a>01027 {
<a name="l01028"></a>01028    <span class="keywordtype">long</span> size = 0;
<a name="l01029"></a>01029    <span class="keywordtype">char</span> *data = NULL;
<a name="l01030"></a>01030 
<a name="l01031"></a>01031    luaL_openlibs(L);
<a name="l01032"></a>01032 
<a name="l01033"></a>01033    <span class="keywordflow">if</span> (!(data = <a class="code" href="pbx__lua_8c.html#a0ba76f3093bed14d623cb8f1b256e40f" title="Load the extensions.lua file in to a buffer and execute the file.">lua_read_extensions_file</a>(L, &amp;size))) {
<a name="l01034"></a>01034       <span class="keywordflow">return</span> 1;
<a name="l01035"></a>01035    }
<a name="l01036"></a>01036 
<a name="l01037"></a>01037    <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039    <span class="keywordflow">if</span> (<a class="code" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a>)
<a name="l01040"></a>01040       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(<a class="code" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a>);
<a name="l01041"></a>01041 
<a name="l01042"></a>01042    <a class="code" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a> = data;
<a name="l01043"></a>01043    <a class="code" href="pbx__lua_8c.html#a2d7c1872fa6e3a83bb32f9314da5550b">config_file_size</a> = size;
<a name="l01044"></a>01044    
<a name="l01045"></a>01045    <span class="comment">/* merge our new contexts */</span>
<a name="l01046"></a>01046    <a class="code" href="pbx_8h.html#a833a703b21d8f6bcb9f68e57185bca67" title="Merge the temporary contexts into a global contexts list and delete from the global...">ast_merge_contexts_and_delete</a>(&amp;<a class="code" href="pbx__lua_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a>, <a class="code" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a>, <a class="code" href="pbx__lua_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l01047"></a>01047    <span class="comment">/* merge_contexts_and_delete will actually, at the correct moment, </span>
<a name="l01048"></a>01048 <span class="comment">      set the global dialplan pointers to your local_contexts and local_table.</span>
<a name="l01049"></a>01049 <span class="comment">      It then will free up the old tables itself. Just be sure not to</span>
<a name="l01050"></a>01050 <span class="comment">      hang onto the pointers. */</span>
<a name="l01051"></a>01051    <a class="code" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a> = NULL;
<a name="l01052"></a>01052    <a class="code" href="pbx__lua_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a> = NULL;
<a name="l01053"></a>01053 
<a name="l01054"></a>01054    <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;<a class="code" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a>);
<a name="l01055"></a>01055    <span class="keywordflow">return</span> 0;
<a name="l01056"></a>01056 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a2432380cd99744c518404a10e05252ab"></a><!-- doxytag: member="pbx_lua.c::lua_set_variable" ref="a2432380cd99744c518404a10e05252ab" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_set_variable </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Set the value of a channel variable or dialplan function (for access from lua, don't call directly) </p>
<p>This function is called to set a variable or dialplan function. It would be called in the following example as would be seen in extensions.lua.</p>
<div class="fragment"><pre class="fragment"> channel.variable = <span class="stringliteral">&quot;value&quot;</span>
</pre></div> 
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00554">554</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="adsistub_8c_source.html#l00049">chan</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, and <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00422">lua_create_channel_table()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00555"></a>00555 {
<a name="l00556"></a>00556    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00557"></a>00557    <span class="keywordtype">int</span> autoservice;
<a name="l00558"></a>00558    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = luaL_checkstring(L, 2);
<a name="l00559"></a>00559    <span class="keyword">const</span> <span class="keywordtype">char</span> *value = luaL_checkstring(L, 3);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00562"></a>00562    chan = lua_touserdata(L, -1);
<a name="l00563"></a>00563    lua_pop(L, 1);
<a name="l00564"></a>00564 
<a name="l00565"></a>00565    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00566"></a>00566    autoservice = lua_toboolean(L, -1);
<a name="l00567"></a>00567    lua_pop(L, 1);
<a name="l00568"></a>00568 
<a name="l00569"></a>00569    <span class="keywordflow">if</span> (autoservice)
<a name="l00570"></a>00570       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00571"></a>00571 
<a name="l00572"></a>00572    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, name, value);
<a name="l00573"></a>00573    
<a name="l00574"></a>00574    <span class="keywordflow">if</span> (autoservice)
<a name="l00575"></a>00575       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00576"></a>00576 
<a name="l00577"></a>00577    <span class="keywordflow">return</span> 0;
<a name="l00578"></a>00578 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a6dc56ee4d2399626018669620002778d"></a><!-- doxytag: member="pbx_lua.c::lua_set_variable_value" ref="a6dc56ee4d2399626018669620002778d" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_set_variable_value </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>[lua_CFunction] Used to set the value of a variable or dialplan function (for access from lua, don't call directly) </p>
<p>This function is the 'set()' function in the following example as would be seen in extensions.lua.</p>
<div class="fragment"><pre class="fragment"> channel.variable:<span class="keyword">set</span>(<span class="stringliteral">&quot;value&quot;</span>)
</pre></div> 
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00320">320</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="autoservice_8c_source.html#l00192">ast_autoservice_start()</a>, <a class="el" href="autoservice_8c_source.html#l00251">ast_autoservice_stop()</a>, <a class="el" href="utils_8h_source.html#l00616">ast_strdupa</a>, <a class="el" href="adsistub_8c_source.html#l00049">chan</a>, <a class="el" href="cdr__adaptive__odbc_8c_source.html#l00053">name</a>, and <a class="el" href="pbx_8c_source.html#l09023">pbx_builtin_setvar_helper()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00383">lua_push_variable_table()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00321"></a>00321 {
<a name="l00322"></a>00322    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *value;
<a name="l00323"></a>00323    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>;
<a name="l00324"></a>00324    <span class="keywordtype">int</span> autoservice;
<a name="l00325"></a>00325 
<a name="l00326"></a>00326    <span class="keywordflow">if</span> (!lua_istable(L, 1)) {
<a name="l00327"></a>00327       lua_pushstring(L, <span class="stringliteral">&quot;User probably used &apos;.&apos; instead of &apos;:&apos; for setting a channel variable&quot;</span>);
<a name="l00328"></a>00328       <span class="keywordflow">return</span> lua_error(L);
<a name="l00329"></a>00329    }
<a name="l00330"></a>00330 
<a name="l00331"></a>00331    lua_getfield(L, 1, <span class="stringliteral">&quot;name&quot;</span>);
<a name="l00332"></a>00332    name = <a class="code" href="utils_8h.html#ab5f0750cc80ba337fdcbddea2d3a1ee6" title="duplicate a string in memory from the stack">ast_strdupa</a>(lua_tostring(L, -1));
<a name="l00333"></a>00333    lua_pop(L, 1);
<a name="l00334"></a>00334 
<a name="l00335"></a>00335    value = luaL_checkstring(L, 2);
<a name="l00336"></a>00336    
<a name="l00337"></a>00337    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;channel&quot;</span>);
<a name="l00338"></a>00338    chan = lua_touserdata(L, -1);
<a name="l00339"></a>00339    lua_pop(L, 1);
<a name="l00340"></a>00340 
<a name="l00341"></a>00341    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;autoservice&quot;</span>);
<a name="l00342"></a>00342    autoservice = lua_toboolean(L, -1);
<a name="l00343"></a>00343    lua_pop(L, 1);
<a name="l00344"></a>00344 
<a name="l00345"></a>00345    <span class="keywordflow">if</span> (autoservice)
<a name="l00346"></a>00346       <a class="code" href="channel_8h.html#a08bde7d8cf72457fc8c519a4443b413b" title="Stop servicing a channel for us...">ast_autoservice_stop</a>(chan);
<a name="l00347"></a>00347 
<a name="l00348"></a>00348    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, name, value);
<a name="l00349"></a>00349    
<a name="l00350"></a>00350    <span class="keywordflow">if</span> (autoservice)
<a name="l00351"></a>00351       <a class="code" href="channel_8h.html#a7a8f6a50f3db42cb40cad7cfbd1d54f9" title="Automatically service a channel for us...">ast_autoservice_start</a>(chan);
<a name="l00352"></a>00352 
<a name="l00353"></a>00353    <span class="keywordflow">return</span> 0;
<a name="l00354"></a>00354 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="aca3ce86b468f3bd615cae1b5f364c0dc"></a><!-- doxytag: member="pbx_lua.c::lua_sort_extensions" ref="aca3ce86b468f3bd615cae1b5f364c0dc" args="(lua_State *L)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int lua_sort_extensions </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Store the sort order of each context. </p>
<p>In the event of an error, an error string will be pushed onto the lua stack.</p>
<dl><dt><b>Return values:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>0</em>&nbsp;</td><td>success </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>1</em>&nbsp;</td><td>failure </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00767">767</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="chan__alsa_8c_source.html#l00105">context</a>, <a class="el" href="chan__alsa_8c_source.html#l00107">exten</a>, and <a class="el" href="pbx__lua_8c_source.html#l00903">lua_extension_cmp()</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>, and <a class="el" href="pbx__lua_8c_source.html#l00926">lua_read_extensions_file()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00768"></a>00768 {
<a name="l00769"></a>00769    <span class="keywordtype">int</span> extensions, extensions_order;
<a name="l00770"></a>00770 
<a name="l00771"></a>00771    <span class="comment">/* create the extensions_order table */</span>
<a name="l00772"></a>00772    lua_newtable(L);
<a name="l00773"></a>00773    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;extensions_order&quot;</span>);
<a name="l00774"></a>00774    lua_getfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;extensions_order&quot;</span>);
<a name="l00775"></a>00775    extensions_order = lua_gettop(L);
<a name="l00776"></a>00776 
<a name="l00777"></a>00777    <span class="comment">/* sort each context in the extensions table */</span>
<a name="l00778"></a>00778    <span class="comment">/* load the &apos;extensions&apos; table */</span>
<a name="l00779"></a>00779    lua_getglobal(L, <span class="stringliteral">&quot;extensions&quot;</span>);
<a name="l00780"></a>00780    extensions = lua_gettop(L);
<a name="l00781"></a>00781    <span class="keywordflow">if</span> (lua_isnil(L, -1)) {
<a name="l00782"></a>00782       lua_pop(L, 1);
<a name="l00783"></a>00783       lua_pushstring(L, <span class="stringliteral">&quot;Unable to find &apos;extensions&apos; table in extensions.lua\n&quot;</span>);
<a name="l00784"></a>00784       <span class="keywordflow">return</span> 1;
<a name="l00785"></a>00785    }
<a name="l00786"></a>00786 
<a name="l00787"></a>00787    <span class="comment">/* iterate through the extensions table and create a</span>
<a name="l00788"></a>00788 <span class="comment">    * matching table (holding the sort order) in the</span>
<a name="l00789"></a>00789 <span class="comment">    * extensions_order table for each context that is found</span>
<a name="l00790"></a>00790 <span class="comment">    */</span>
<a name="l00791"></a>00791    <span class="keywordflow">for</span> (lua_pushnil(L); lua_next(L, extensions); lua_pop(L, 1)) {
<a name="l00792"></a>00792       <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a> = lua_gettop(L);
<a name="l00793"></a>00793       <span class="keywordtype">int</span> context_name = context - 1;
<a name="l00794"></a>00794       <span class="keywordtype">int</span> context_order;
<a name="l00795"></a>00795 
<a name="l00796"></a>00796       lua_pushvalue(L, context_name);
<a name="l00797"></a>00797       lua_newtable(L);
<a name="l00798"></a>00798       context_order = lua_gettop(L);
<a name="l00799"></a>00799 
<a name="l00800"></a>00800       <span class="comment">/* iterate through this context an popluate the corrisponding</span>
<a name="l00801"></a>00801 <span class="comment">       * table in the extensions_order table */</span>
<a name="l00802"></a>00802       <span class="keywordflow">for</span> (lua_pushnil(L); lua_next(L, context); lua_pop(L, 1)) {
<a name="l00803"></a>00803          <span class="keywordtype">int</span> <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a> = lua_gettop(L) - 1;
<a name="l00804"></a>00804 
<a name="l00805"></a>00805          lua_pushinteger(L, lua_objlen(L, context_order) + 1);
<a name="l00806"></a>00806          lua_pushvalue(L, exten);
<a name="l00807"></a>00807          lua_settable(L, context_order);
<a name="l00808"></a>00808       }
<a name="l00809"></a>00809       lua_settable(L, extensions_order); <span class="comment">/* put the context_order table in the extensions_order table */</span>
<a name="l00810"></a>00810 
<a name="l00811"></a>00811       <span class="comment">/* now sort the new table */</span>
<a name="l00812"></a>00812 
<a name="l00813"></a>00813       <span class="comment">/* push the table.sort function */</span>
<a name="l00814"></a>00814       lua_getglobal(L, <span class="stringliteral">&quot;table&quot;</span>);
<a name="l00815"></a>00815       lua_getfield(L, -1, <span class="stringliteral">&quot;sort&quot;</span>);
<a name="l00816"></a>00816       lua_remove(L, -2); <span class="comment">/* remove the &apos;table&apos; table */</span>
<a name="l00817"></a>00817 
<a name="l00818"></a>00818       <span class="comment">/* push the context_order table */</span>
<a name="l00819"></a>00819       lua_pushvalue(L, context_name);
<a name="l00820"></a>00820       lua_gettable(L, extensions_order);
<a name="l00821"></a>00821 
<a name="l00822"></a>00822       <span class="comment">/* push the comp function */</span>
<a name="l00823"></a>00823       lua_pushcfunction(L, &amp;<a class="code" href="pbx__lua_8c.html#aa8acaadbc4a75cf7152db60003c564b2" title="[lua_CFunction] Compare two extensions (for access from lua, don&amp;#39;t call directly)...">lua_extension_cmp</a>);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825       <span class="keywordflow">if</span> (lua_pcall(L, 2, 0, 0)) {
<a name="l00826"></a>00826          lua_insert(L, -5);
<a name="l00827"></a>00827          lua_pop(L, 4);
<a name="l00828"></a>00828          <span class="keywordflow">return</span> 1;
<a name="l00829"></a>00829       }
<a name="l00830"></a>00830    }
<a name="l00831"></a>00831    
<a name="l00832"></a>00832    <span class="comment">/* remove the extensions table and the extensions_order table */</span>
<a name="l00833"></a>00833    lua_pop(L, 2);
<a name="l00834"></a>00834    <span class="keywordflow">return</span> 0;
<a name="l00835"></a>00835 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a1af58c32d2d752784fc3e9194a1a15ff"></a><!-- doxytag: member="pbx_lua.c::lua_state_destroy" ref="a1af58c32d2d752784fc3e9194a1a15ff" args="(void *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void lua_state_destroy </td>
          <td>(</td>
          <td class="paramtype">void *&nbsp;</td>
          <td class="paramname"> <em>data</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>The destructor for lua_datastore. </p>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00117">117</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00118"></a>00118 {
<a name="l00119"></a>00119    <span class="keywordflow">if</span> (<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>)
<a name="l00120"></a>00120       lua_close(<a class="code" href="structast__channel.html#a8f64897c7ccc5c13f276d1d07c4e7095">data</a>);
<a name="l00121"></a>00121 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a5aeda87e3d4092383a71cf6cceded87b"></a><!-- doxytag: member="pbx_lua.c::lua_update_registry" ref="a5aeda87e3d4092383a71cf6cceded87b" args="(lua_State *L, const char *context, const char *exten, int priority)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static void lua_update_registry </td>
          <td>(</td>
          <td class="paramtype">lua_State *&nbsp;</td>
          <td class="paramname"> <em>L</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>priority</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Update the lua registry with the given context, exten, and priority. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>L</em>&nbsp;</td><td>the lua_State to use </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>context</em>&nbsp;</td><td>the new context </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>exten</em>&nbsp;</td><td>the new exten </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>priority</em>&nbsp;</td><td>the new priority </td></tr>
  </table>
  </dd>
</dl>

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00364">364</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01214">exec()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l00365"></a>00365 {
<a name="l00366"></a>00366    lua_pushstring(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>);
<a name="l00367"></a>00367    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;context&quot;</span>);
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    lua_pushstring(L, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>);
<a name="l00370"></a>00370    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;exten&quot;</span>);
<a name="l00371"></a>00371 
<a name="l00372"></a>00372    lua_pushinteger(L, <a class="code" href="structast__channel.html#acec9ce2df15222151ad66fcb1d74eb9f">priority</a>);
<a name="l00373"></a>00373    lua_setfield(L, LUA_REGISTRYINDEX, <span class="stringliteral">&quot;priority&quot;</span>);
<a name="l00374"></a>00374 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="a01d4c61c8065333033ddb5325bfd2032"></a><!-- doxytag: member="pbx_lua.c::matchmore" ref="a01d4c61c8065333033ddb5325bfd2032" args="(struct ast_channel *chan, const char *context, const char *exten, int priority, const char *callerid, const char *data)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int matchmore </td>
          <td>(</td>
          <td class="paramtype">struct <a class="el" href="structast__channel.html">ast_channel</a> *&nbsp;</td>
          <td class="paramname"> <em>chan</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>context</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>exten</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">int&nbsp;</td>
          <td class="paramname"> <em>priority</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>callerid</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>data</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01190">1190</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="logger_8c_source.html#l01090">ast_log()</a>, <a class="el" href="module_8h_source.html#l00240">ast_module_user_add</a>, <a class="el" href="module_8h_source.html#l00241">ast_module_user_remove</a>, <a class="el" href="logger_8h_source.html#l00163">LOG_ERROR</a>, <a class="el" href="pbx__lua_8c_source.html#l01285">lua_find_extension()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01082">lua_get_state()</a>.</p>

<p>Referenced by <a class="el" href="chan__iax2_8c_source.html#l07979">complete_dpreply()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01285">lua_find_extension()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01191"></a>01191 {
<a name="l01192"></a>01192    <span class="keywordtype">int</span> res;
<a name="l01193"></a>01193    lua_State *L;
<a name="l01194"></a>01194    <span class="keyword">struct </span><a class="code" href="structast__module__user.html">ast_module_user</a> *u = <a class="code" href="module_8h.html#ab941a600dc47b469ab225f140bc0973f">ast_module_user_add</a>(chan);
<a name="l01195"></a>01195    <span class="keywordflow">if</span> (!u) {
<a name="l01196"></a>01196       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Error adjusting use count, probably could not allocate memory\n&quot;</span>);
<a name="l01197"></a>01197       <span class="keywordflow">return</span> 0;
<a name="l01198"></a>01198    }
<a name="l01199"></a>01199 
<a name="l01200"></a>01200    L = <a class="code" href="pbx__lua_8c.html#ad50255c1af5d6d906cded525f8418b5e" title="Get the lua_State for this channel.">lua_get_state</a>(chan);
<a name="l01201"></a>01201    <span class="keywordflow">if</span> (!L) {
<a name="l01202"></a>01202       <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01203"></a>01203       <span class="keywordflow">return</span> 0;
<a name="l01204"></a>01204    }
<a name="l01205"></a>01205    
<a name="l01206"></a>01206    res = <a class="code" href="pbx__lua_8c.html#aac6067451861a42c261f10a9a3a1aa6d" title="Locate an extensions and optionally push the matching function on the stack.">lua_find_extension</a>(L, <a class="code" href="chan__alsa_8c.html#ac25ea00ee3f082df06e0cf468cbde240">context</a>, <a class="code" href="chan__alsa_8c.html#a78d4847658b695383d849efd12399b38">exten</a>, priority, &amp;<a class="code" href="pbx__lua_8c.html#a01d4c61c8065333033ddb5325bfd2032">matchmore</a>, 0);
<a name="l01207"></a>01207 
<a name="l01208"></a>01208    <span class="keywordflow">if</span> (!chan) lua_close(L);
<a name="l01209"></a>01209    <a class="code" href="module_8h.html#aac87725d61b6daf4ce7d7b505f1b68c9">ast_module_user_remove</a>(u);
<a name="l01210"></a>01210    <span class="keywordflow">return</span> res;
<a name="l01211"></a>01211 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad1982509765f4870f1f63412a53ea668"></a><!-- doxytag: member="pbx_lua.c::reload" ref="ad1982509765f4870f1f63412a53ea668" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int reload </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01456">1456</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx__lua_8c_source.html#l01428">load_or_reload_lua_stuff()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01457"></a>01457 {
<a name="l01458"></a>01458    <span class="keywordflow">return</span> <a class="code" href="pbx__lua_8c.html#a0cd4a8176fed2b7bfae5c20d088a16ad">load_or_reload_lua_stuff</a>();
<a name="l01459"></a>01459 }
</pre></div></p>

</div>
</div>
<a class="anchor" id="ad09fa931f468002152a3cc2d5ce25eae"></a><!-- doxytag: member="pbx_lua.c::unload_module" ref="ad09fa931f468002152a3cc2d5ce25eae" args="(void)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">static int unload_module </td>
          <td>(</td>
          <td class="paramtype">void&nbsp;</td>
          <td class="paramname"></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01448">1448</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>References <a class="el" href="pbx_8c_source.html#l08415">ast_context_destroy()</a>, <a class="el" href="pbx_8c_source.html#l05175">ast_unregister_switch()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01061">lua_free_extensions()</a>.</p>

<p><div class="fragment"><pre class="fragment"><a name="l01449"></a>01449 {
<a name="l01450"></a>01450    <a class="code" href="pbx_8h.html#a9546b830c22c693a2baed08e48569401" title="Destroy a context (matches the specified context (or ANY context if NULL).">ast_context_destroy</a>(NULL, <a class="code" href="pbx__lua_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a>);
<a name="l01451"></a>01451    <a class="code" href="pbx_8h.html#a4b11d763a689cb0df33a4a16c9d89ef3" title="Unregister an alternative switch.">ast_unregister_switch</a>(&amp;<a class="code" href="pbx__lua_8c.html#a1fbd4b9cbb88f00961f746f04ee90da1">lua_switch</a>);
<a name="l01452"></a>01452    <a class="code" href="pbx__lua_8c.html#a2555949b938e7a61910dab4b1584a45e" title="Free the internal extensions buffer.">lua_free_extensions</a>();
<a name="l01453"></a>01453    <span class="keywordflow">return</span> 0;
<a name="l01454"></a>01454 }
</pre></div></p>

</div>
</div>
<hr/><h2>Variable Documentation</h2>
<a class="anchor" id="ab22f32016155f7f403e7178767163d7d"></a><!-- doxytag: member="pbx_lua.c::__mod_info" ref="ab22f32016155f7f403e7178767163d7d" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a> <a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a> = { .<a class="el" href="channel_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a> = AST_MODULE, .flags = AST_MODFLAG_GLOBAL_SYMBOLS , .<a class="el" href="callerid_8c.html#a68344fa88cf4e86b5079fd69a5c22d57">description</a> = &quot;Lua PBX Switch&quot; , .key = &quot;This paragraph is copyright (c) 2006 by Digium, Inc. \In order for your module to load, it must return this \key via a function called \&quot;key\&quot;. Any code which \includes this paragraph must be licensed under the GNU \General Public License <a class="el" href="res__config__pgsql_8c.html#aad880fc4455c253781e8968f2239d56f">version</a> 2 or later (at your \option). In addition to Digium's general reservations \of rights, Digium expressly reserves the right to \allow other parties to license this paragraph under \different terms. Any use of Digium, Inc. trademarks or \logos (including \&quot;Asterisk\&quot; or \&quot;Digium\&quot;) without \express written <a class="el" href="structpermission.html">permission</a> of Digium, Inc. is prohibited.\n&quot; , .buildopt_sum = &quot;aefddfaffd51bc118c14a748e96eb9a0&quot; , .load = load_module, .unload = unload_module, .reload = reload, }<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01480">1480</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="ae25b9f3970870610911f8850897e8ead"></a><!-- doxytag: member="pbx_lua.c::ast_module_info" ref="ae25b9f3970870610911f8850897e8ead" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__module__info.html">ast_module_info</a>* <a class="el" href="structast__module__info.html">ast_module_info</a> = &amp;<a class="el" href="res__timing__timerfd_8c.html#ab22f32016155f7f403e7178767163d7d">__mod_info</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01480">1480</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="a74bb62276efdf39dd94048e007fca05b"></a><!-- doxytag: member="pbx_lua.c::config" ref="a74bb62276efdf39dd94048e007fca05b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="pbx__lua_8c.html#a74bb62276efdf39dd94048e007fca05b">config</a> = &quot;extensions.lua&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00055">55</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab0104eb126a2c3a140da12ce8a6d0ce4"></a><!-- doxytag: member="pbx_lua.c::config_file_data" ref="ab0104eb126a2c3a140da12ce8a6d0ce4" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="pbx__lua_8c.html#ab0104eb126a2c3a140da12ce8a6d0ce4">config_file_data</a> = NULL</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00102">102</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="af0f360abe75984080b57c1f37c120e69"></a><!-- doxytag: member="pbx_lua.c::config_file_lock" ref="af0f360abe75984080b57c1f37c120e69" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname"><a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> <a class="el" href="pbx__lua_8c.html#af0f360abe75984080b57c1f37c120e69">config_file_lock</a> = ((<a class="el" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a>) PTHREAD_MUTEX_INITIALIZER )<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00101">101</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

<p>Referenced by <a class="el" href="pbx__lua_8c_source.html#l01061">lua_free_extensions()</a>, <a class="el" href="pbx__lua_8c_source.html#l00983">lua_load_extensions()</a>, and <a class="el" href="pbx__lua_8c_source.html#l01026">lua_reload_extensions()</a>.</p>

</div>
</div>
<a class="anchor" id="a2d7c1872fa6e3a83bb32f9314da5550b"></a><!-- doxytag: member="pbx_lua.c::config_file_size" ref="a2d7c1872fa6e3a83bb32f9314da5550b" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">long <a class="el" href="pbx__lua_8c.html#a2d7c1872fa6e3a83bb32f9314da5550b">config_file_size</a> = 0</td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00103">103</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="a71549c9ba7fb62eeb7c04b697e716543"></a><!-- doxytag: member="pbx_lua.c::local_contexts" ref="a71549c9ba7fb62eeb7c04b697e716543" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__context.html">ast_context</a>* <a class="el" href="pbx__lua_8c.html#a71549c9ba7fb62eeb7c04b697e716543">local_contexts</a> = NULL<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00105">105</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="aef1908f65d352529fe334d22f9df25cb"></a><!-- doxytag: member="pbx_lua.c::local_table" ref="aef1908f65d352529fe334d22f9df25cb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__hashtab.html">ast_hashtab</a>* <a class="el" href="pbx__lua_8c.html#aef1908f65d352529fe334d22f9df25cb">local_table</a> = NULL<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00106">106</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="a11cd8c2600fb5e70db6e795fbabdfefb"></a><!-- doxytag: member="pbx_lua.c::lua_datastore" ref="a11cd8c2600fb5e70db6e795fbabdfefb" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__datastore__info.html">ast_datastore_info</a> <a class="el" href="pbx__lua_8c.html#a11cd8c2600fb5e70db6e795fbabdfefb">lua_datastore</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">
<b>Initial value:</b><div class="fragment"><pre class="fragment"> {
   .type = <span class="stringliteral">&quot;lua&quot;</span>,
   .destroy = <a class="code" href="pbx__lua_8c.html#a1af58c32d2d752784fc3e9194a1a15ff" title="The destructor for lua_datastore.">lua_state_destroy</a>,
}
</pre></div>
<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00108">108</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="a1fbd4b9cbb88f00961f746f04ee90da1"></a><!-- doxytag: member="pbx_lua.c::lua_switch" ref="a1fbd4b9cbb88f00961f746f04ee90da1" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structast__switch.html">ast_switch</a> <a class="el" href="pbx__lua_8c.html#a1fbd4b9cbb88f00961f746f04ee90da1">lua_switch</a><code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l01418">1418</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
<a class="anchor" id="ab990a3529ebde2681a00468cad7c0b48"></a><!-- doxytag: member="pbx_lua.c::registrar" ref="ab990a3529ebde2681a00468cad7c0b48" args="" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">char* <a class="el" href="pval_8c.html#ab990a3529ebde2681a00468cad7c0b48">registrar</a> = &quot;pbx_lua&quot;<code> [static]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Definition at line <a class="el" href="pbx__lua_8c_source.html#l00056">56</a> of file <a class="el" href="pbx__lua_8c_source.html">pbx_lua.c</a>.</p>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:22:54 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
