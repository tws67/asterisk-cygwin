<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:45 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_318a70d4e812a718d9ecaeea98fff199.html">res</a>
  </div>
</div>
<div class="contents">
<h1>res_adsi.c</h1><a href="res__adsi_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2005, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * Includes code and algorithms from the Zapata library.</span>
<a name="l00009"></a>00009 <span class="comment"> *</span>
<a name="l00010"></a>00010 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00011"></a>00011 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00012"></a>00012 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00013"></a>00013 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00014"></a>00014 <span class="comment"> * channels for your use.</span>
<a name="l00015"></a>00015 <span class="comment"> *</span>
<a name="l00016"></a>00016 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00017"></a>00017 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00018"></a>00018 <span class="comment"> * at the top of the source tree.</span>
<a name="l00019"></a>00019 <span class="comment"> */</span>
<a name="l00020"></a>00020 <span class="comment"></span>
<a name="l00021"></a>00021 <span class="comment">/*! \file</span>
<a name="l00022"></a>00022 <span class="comment"> *</span>
<a name="l00023"></a>00023 <span class="comment"> * \brief ADSI support </span>
<a name="l00024"></a>00024 <span class="comment"> *</span>
<a name="l00025"></a>00025 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt; </span>
<a name="l00026"></a>00026 <span class="comment"> *</span>
<a name="l00027"></a>00027 <span class="comment"> * \note this module is required by app_voicemail and app_getcpeid</span>
<a name="l00028"></a>00028 <span class="comment"> * \todo Move app_getcpeid into this module</span>
<a name="l00029"></a>00029 <span class="comment"> * \todo Create a core layer so that app_voicemail does not require</span>
<a name="l00030"></a>00030 <span class="comment"> *    res_adsi to load</span>
<a name="l00031"></a>00031 <span class="comment"> */</span>
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 142992 $&quot;</span>)
<a name="l00036"></a>00036 
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor"></span><span class="preprocessor">#include &lt;math.h&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="adsi_8h.html" title="ADSI Support (built upon Caller*ID).">asterisk/adsi.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="ulaw_8h.html" title="u-Law to Signed linear conversion">asterisk/ulaw.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="alaw_8h.html" title="A-Law to Signed linear conversion.">asterisk/alaw.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="callerid_8h.html" title="CallerID (and other GR30) management and generation Includes code and algorithms...">asterisk/callerid.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="fskmodem_8h.html" title="FSK Modem Support.">asterisk/fskmodem.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="module_8h.html" title="Asterisk module definitions.">asterisk/module.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="file_8h.html" title="Generic File Format Support. Should be included by clients of the file handling routines...">asterisk/file.h</a>&quot;</span>
<a name="l00049"></a>00049 
<a name="l00050"></a><a class="code" href="res__adsi_8c.html#ae78e909f3afca606cb096d3e2aaeeddf">00050</a> <span class="preprocessor">#define DEFAULT_ADSI_MAX_RETRIES 3</span>
<a name="l00051"></a>00051 <span class="preprocessor"></span>
<a name="l00052"></a><a class="code" href="res__adsi_8c.html#a883381de25fae11725272776402f66ed">00052</a> <span class="preprocessor">#define ADSI_MAX_INTRO 20</span>
<a name="l00053"></a><a class="code" href="res__adsi_8c.html#a811570484466fddfd91a3695c25a2aed">00053</a> <span class="preprocessor"></span><span class="preprocessor">#define ADSI_MAX_SPEED_DIAL 6</span>
<a name="l00054"></a>00054 <span class="preprocessor"></span>
<a name="l00055"></a><a class="code" href="res__adsi_8c.html#a2447f977e8fdc689f10e33b81d96311c">00055</a> <span class="preprocessor">#define ADSI_FLAG_DATAMODE (1 &lt;&lt; 8)</span>
<a name="l00056"></a>00056 <span class="preprocessor"></span>
<a name="l00057"></a><a class="code" href="res__adsi_8c.html#ac35730743cfe5d3cb0971c186fb1788a">00057</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac35730743cfe5d3cb0971c186fb1788a">maxretries</a> = <a class="code" href="res__adsi_8c.html#ae78e909f3afca606cb096d3e2aaeeddf">DEFAULT_ADSI_MAX_RETRIES</a>;
<a name="l00058"></a>00058 
<a name="l00059"></a>00059 <span class="comment">/* Asterisk ADSI button definitions */</span>
<a name="l00060"></a><a class="code" href="res__adsi_8c.html#aea7435fd1af44d9caec35b913e0d6dd1">00060</a> <span class="preprocessor">#define ADSI_SPEED_DIAL    10 </span><span class="comment">/* 10-15 are reserved for speed dial */</span>
<a name="l00061"></a>00061 
<a name="l00062"></a><a class="code" href="res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">00062</a> <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__adsi_8c.html#ac5f1985e4c8cb8439ac70ea293e819c7">intro</a>[<a class="code" href="res__adsi_8c.html#a883381de25fae11725272776402f66ed">ADSI_MAX_INTRO</a>][20];
<a name="l00063"></a><a class="code" href="res__adsi_8c.html#a3c0aea0124e427b4551cf369b176e731">00063</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a3c0aea0124e427b4551cf369b176e731">aligns</a>[<a class="code" href="res__adsi_8c.html#a883381de25fae11725272776402f66ed">ADSI_MAX_INTRO</a>];
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="res__adsi_8c.html#a7960db0a226b9ee534e59e459ed228ef">00065</a> <span class="preprocessor">#define  SPEEDDIAL_MAX_LEN 20</span>
<a name="l00066"></a><a class="code" href="res__adsi_8c.html#a9a2a460cdc221724359c10c82ed56b3d">00066</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="res__adsi_8c.html#a9a2a460cdc221724359c10c82ed56b3d">speeddial</a>[<a class="code" href="res__adsi_8c.html#a811570484466fddfd91a3695c25a2aed">ADSI_MAX_SPEED_DIAL</a>][3][<a class="code" href="res__adsi_8c.html#a7960db0a226b9ee534e59e459ed228ef">SPEEDDIAL_MAX_LEN</a>];
<a name="l00067"></a>00067 
<a name="l00068"></a><a class="code" href="res__adsi_8c.html#a81b537b1af8936fc6ca2eda76d70430f">00068</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a81b537b1af8936fc6ca2eda76d70430f">alignment</a> = 0;
<a name="l00069"></a>00069 
<a name="l00070"></a><a class="code" href="res__adsi_8c.html#a77b039b5598e8fecbc0732ac7d28149e">00070</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a77b039b5598e8fecbc0732ac7d28149e">adsi_generate</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#ad1cc5e2494e96eecb8611fb7247ffc89">msgtype</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, <span class="keywordtype">int</span> msgnum, <span class="keywordtype">int</span> <a class="code" href="devicestate_8c.html#a43a8def62ee15449794285cbbc0f79af">last</a>, <span class="keywordtype">int</span> codec)
<a name="l00071"></a>00071 {
<a name="l00072"></a>00072    <span class="keywordtype">int</span> sum, x, bytes = 0;
<a name="l00073"></a>00073    <span class="comment">/* Initial carrier (imaginary) */</span>
<a name="l00074"></a>00074    <span class="keywordtype">float</span> cr = 1.0, ci = 0.0, scont = 0.0;
<a name="l00075"></a>00075 
<a name="l00076"></a>00076    <span class="keywordflow">if</span> (msglen &gt; 255)
<a name="l00077"></a>00077       msglen = 255;
<a name="l00078"></a>00078 
<a name="l00079"></a>00079    <span class="comment">/* If first message, Send 150ms of MARK&apos;s */</span>
<a name="l00080"></a>00080    <span class="keywordflow">if</span> (msgnum == 1) {
<a name="l00081"></a>00081       <span class="keywordflow">for</span> (x = 0; x &lt; 150; x++)  <span class="comment">/* was 150 */</span>
<a name="l00082"></a>00082          <a class="code" href="callerid_8h.html#a7ce7cf8db165eb44e64e704c3ced9774">PUT_CLID_MARKMS</a>;
<a name="l00083"></a>00083    }
<a name="l00084"></a>00084 
<a name="l00085"></a>00085    <span class="comment">/* Put message type */</span>
<a name="l00086"></a>00086    <a class="code" href="callerid_8h.html#a02c7254b3ec648f815c15bd6f8cce39b">PUT_CLID</a>(msgtype);
<a name="l00087"></a>00087    sum = msgtype;
<a name="l00088"></a>00088 
<a name="l00089"></a>00089    <span class="comment">/* Put message length (plus one  for the message number) */</span>
<a name="l00090"></a>00090    <a class="code" href="callerid_8h.html#a02c7254b3ec648f815c15bd6f8cce39b">PUT_CLID</a>(msglen + 1);
<a name="l00091"></a>00091    sum += msglen + 1;
<a name="l00092"></a>00092 
<a name="l00093"></a>00093    <span class="comment">/* Put message number */</span>
<a name="l00094"></a>00094    <a class="code" href="callerid_8h.html#a02c7254b3ec648f815c15bd6f8cce39b">PUT_CLID</a>(msgnum);
<a name="l00095"></a>00095    sum += msgnum;
<a name="l00096"></a>00096 
<a name="l00097"></a>00097    <span class="comment">/* Put actual message */</span>
<a name="l00098"></a>00098    <span class="keywordflow">for</span> (x = 0; x &lt; msglen; x++) {
<a name="l00099"></a>00099       <a class="code" href="callerid_8h.html#a02c7254b3ec648f815c15bd6f8cce39b">PUT_CLID</a>(msg[x]);
<a name="l00100"></a>00100       sum += msg[x];
<a name="l00101"></a>00101    }
<a name="l00102"></a>00102 
<a name="l00103"></a>00103    <span class="comment">/* Put 2&apos;s compliment of sum */</span>
<a name="l00104"></a>00104    <a class="code" href="callerid_8h.html#a02c7254b3ec648f815c15bd6f8cce39b">PUT_CLID</a>(256-(sum &amp; 0xff));
<a name="l00105"></a>00105 
<a name="l00106"></a>00106 <span class="preprocessor">#if 0</span>
<a name="l00107"></a>00107 <span class="preprocessor"></span>   <span class="keywordflow">if</span> (last) {
<a name="l00108"></a>00108       <span class="comment">/* Put trailing marks */</span>
<a name="l00109"></a>00109       <span class="keywordflow">for</span> (x = 0; x &lt; 50; x++)
<a name="l00110"></a>00110          <a class="code" href="callerid_8h.html#a7ce7cf8db165eb44e64e704c3ced9774">PUT_CLID_MARKMS</a>;
<a name="l00111"></a>00111    }
<a name="l00112"></a>00112 <span class="preprocessor">#endif</span>
<a name="l00113"></a>00113 <span class="preprocessor"></span>   <span class="keywordflow">return</span> bytes;
<a name="l00114"></a>00114 
<a name="l00115"></a>00115 }
<a name="l00116"></a>00116 
<a name="l00117"></a><a class="code" href="res__adsi_8c.html#a7d4b85bd5838855639db8c52fdf984d4">00117</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a7d4b85bd5838855639db8c52fdf984d4">adsi_careful_send</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> *remain)
<a name="l00118"></a>00118 {
<a name="l00119"></a>00119    <span class="comment">/* Sends carefully on a full duplex channel by using reading for</span>
<a name="l00120"></a>00120 <span class="comment">      timing */</span>
<a name="l00121"></a>00121    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *inf, outf;
<a name="l00122"></a>00122    <span class="keywordtype">int</span> amt;
<a name="l00123"></a>00123 
<a name="l00124"></a>00124    <span class="comment">/* Zero out our outgoing frame */</span>
<a name="l00125"></a>00125    memset(&amp;outf, 0, <span class="keyword">sizeof</span>(outf));
<a name="l00126"></a>00126 
<a name="l00127"></a>00127    <span class="keywordflow">if</span> (remain &amp;&amp; *remain) {
<a name="l00128"></a>00128       amt = len;
<a name="l00129"></a>00129 
<a name="l00130"></a>00130       <span class="comment">/* Send remainder if provided */</span>
<a name="l00131"></a>00131       <span class="keywordflow">if</span> (amt &gt; *remain)
<a name="l00132"></a>00132          amt = *remain;
<a name="l00133"></a>00133       <span class="keywordflow">else</span>
<a name="l00134"></a>00134          *remain = *remain - amt;
<a name="l00135"></a>00135       outf.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l00136"></a>00136       outf.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l00137"></a>00137       outf.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = buf;
<a name="l00138"></a>00138       outf.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = amt;
<a name="l00139"></a>00139       outf.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = amt;
<a name="l00140"></a>00140       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, &amp;outf)) {
<a name="l00141"></a>00141          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to carefully write frame\n&quot;</span>);
<a name="l00142"></a>00142          <span class="keywordflow">return</span> -1;
<a name="l00143"></a>00143       }
<a name="l00144"></a>00144       <span class="comment">/* Update pointers and lengths */</span>
<a name="l00145"></a>00145       buf += amt;
<a name="l00146"></a>00146       len -= amt;
<a name="l00147"></a>00147    }
<a name="l00148"></a>00148 
<a name="l00149"></a>00149    <span class="keywordflow">while</span>(len) {
<a name="l00150"></a>00150       amt = len;
<a name="l00151"></a>00151       <span class="comment">/* If we don&apos;t get anything at all back in a second, forget</span>
<a name="l00152"></a>00152 <span class="comment">         about it */</span>
<a name="l00153"></a>00153       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, 1000) &lt; 1)
<a name="l00154"></a>00154          <span class="keywordflow">return</span> -1;
<a name="l00155"></a>00155       <span class="comment">/* Detect hangup */</span>
<a name="l00156"></a>00156       <span class="keywordflow">if</span> (!(inf = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan)))
<a name="l00157"></a>00157          <span class="keywordflow">return</span> -1;
<a name="l00158"></a>00158 
<a name="l00159"></a>00159       <span class="comment">/* Drop any frames that are not voice */</span>
<a name="l00160"></a>00160       <span class="keywordflow">if</span> (inf-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l00161"></a>00161          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(inf);
<a name="l00162"></a>00162          <span class="keywordflow">continue</span>;
<a name="l00163"></a>00163       }
<a name="l00164"></a>00164       
<a name="l00165"></a>00165       <span class="keywordflow">if</span> (inf-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> != <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>) {
<a name="l00166"></a>00166          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel not in ulaw?\n&quot;</span>);
<a name="l00167"></a>00167          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(inf);
<a name="l00168"></a>00168          <span class="keywordflow">return</span> -1;
<a name="l00169"></a>00169       }
<a name="l00170"></a>00170       <span class="comment">/* Send no more than they sent us */</span>
<a name="l00171"></a>00171       <span class="keywordflow">if</span> (amt &gt; inf-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l00172"></a>00172          amt = inf-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;
<a name="l00173"></a>00173       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (remain)
<a name="l00174"></a>00174          *remain = inf-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - amt;
<a name="l00175"></a>00175       outf.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>;
<a name="l00176"></a>00176       outf.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>;
<a name="l00177"></a>00177       outf.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = buf;
<a name="l00178"></a>00178       outf.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = amt;
<a name="l00179"></a>00179       outf.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = amt;
<a name="l00180"></a>00180       <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(chan, &amp;outf)) {
<a name="l00181"></a>00181          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to carefully write frame\n&quot;</span>);
<a name="l00182"></a>00182          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(inf);
<a name="l00183"></a>00183          <span class="keywordflow">return</span> -1;
<a name="l00184"></a>00184       }
<a name="l00185"></a>00185       <span class="comment">/* Update pointers and lengths */</span>
<a name="l00186"></a>00186       buf += amt;
<a name="l00187"></a>00187       len -= amt;
<a name="l00188"></a>00188       <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(inf);
<a name="l00189"></a>00189    }
<a name="l00190"></a>00190    <span class="keywordflow">return</span> 0;
<a name="l00191"></a>00191 }
<a name="l00192"></a>00192 
<a name="l00193"></a><a class="code" href="res__adsi_8c.html#a2efe248249d58ae6b4ffe4d535f9ab27">00193</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a2efe248249d58ae6b4ffe4d535f9ab27">__adsi_transmit_messages</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> **<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> *<a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, <span class="keywordtype">int</span> *<a class="code" href="adsistub_8c.html#ad1cc5e2494e96eecb8611fb7247ffc89">msgtype</a>)
<a name="l00194"></a>00194 {
<a name="l00195"></a>00195    <span class="comment">/* msglen must be no more than 256 bits, each */</span>
<a name="l00196"></a>00196    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[24000 * 5];
<a name="l00197"></a>00197    <span class="keywordtype">int</span> pos = 0, res, x, start = 0, retries = 0, waittime, rem = 0, def;
<a name="l00198"></a>00198    <span class="keywordtype">char</span> ack[3];
<a name="l00199"></a>00199    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l00200"></a>00200 
<a name="l00201"></a>00201    <span class="keywordflow">if</span> (chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> == <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda5f0673b46cfdba3094393b3fbce084ff">AST_ADSI_UNAVAILABLE</a>) {
<a name="l00202"></a>00202       <span class="comment">/* Don&apos;t bother if we know they don&apos;t support ADSI */</span>
<a name="l00203"></a>00203       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOSYS;
<a name="l00204"></a>00204       <span class="keywordflow">return</span> -1;
<a name="l00205"></a>00205    }
<a name="l00206"></a>00206 
<a name="l00207"></a>00207    <span class="keywordflow">while</span>(retries &lt; maxretries) {
<a name="l00208"></a>00208       <span class="keywordflow">if</span> (!(chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> &amp; <a class="code" href="res__adsi_8c.html#a2447f977e8fdc689f10e33b81d96311c">ADSI_FLAG_DATAMODE</a>)) {
<a name="l00209"></a>00209          <span class="comment">/* Generate CAS (no SAS) */</span>
<a name="l00210"></a>00210          <a class="code" href="callerid_8h.html#a571971ad3245bec086419b6fdc77b6e5">ast_gen_cas</a>(buf, 0, 680, <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>);
<a name="l00211"></a>00211       
<a name="l00212"></a>00212          <span class="comment">/* Send CAS */</span>
<a name="l00213"></a>00213          <span class="keywordflow">if</span> (<a class="code" href="res__adsi_8c.html#a7d4b85bd5838855639db8c52fdf984d4">adsi_careful_send</a>(chan, buf, 680, NULL))
<a name="l00214"></a>00214             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to send CAS\n&quot;</span>);
<a name="l00215"></a>00215 
<a name="l00216"></a>00216          <span class="comment">/* Wait For DTMF result */</span>
<a name="l00217"></a>00217          waittime = 500;
<a name="l00218"></a>00218          <span class="keywordflow">for</span>(;;) {
<a name="l00219"></a>00219             <span class="keywordflow">if</span> (((res = <a class="code" href="channel_8h.html#a60e0bcaed001e8d5ed1ba0eb2644b3cc" title="Wait for input on a channel.">ast_waitfor</a>(chan, waittime)) &lt; 1)) {
<a name="l00220"></a>00220                <span class="comment">/* Didn&apos;t get back DTMF A in time */</span>
<a name="l00221"></a>00221                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No ADSI CPE detected (%d)\n&quot;</span>, res);
<a name="l00222"></a>00222                <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a>)
<a name="l00223"></a>00223                   chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda5f0673b46cfdba3094393b3fbce084ff">AST_ADSI_UNAVAILABLE</a>;
<a name="l00224"></a>00224                <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ENOSYS;
<a name="l00225"></a>00225                <span class="keywordflow">return</span> -1;
<a name="l00226"></a>00226             }
<a name="l00227"></a>00227             waittime = res;
<a name="l00228"></a>00228             <span class="keywordflow">if</span> (!(f = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(chan))) {
<a name="l00229"></a>00229                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Hangup in ADSI\n&quot;</span>);
<a name="l00230"></a>00230                <span class="keywordflow">return</span> -1;
<a name="l00231"></a>00231             }
<a name="l00232"></a>00232             <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#a248afd6c02044259a386f6b7aee922a2">AST_FRAME_DTMF</a>) {
<a name="l00233"></a>00233                <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <span class="charliteral">&apos;A&apos;</span>) {
<a name="l00234"></a>00234                   <span class="comment">/* Okay, this is an ADSI CPE.  Note this for future reference, too */</span>
<a name="l00235"></a>00235                   <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a>)
<a name="l00236"></a>00236                      chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda760a7f7c7ffc838f278b34db7bb69e4d">AST_ADSI_AVAILABLE</a>;
<a name="l00237"></a>00237                   <span class="keywordflow">break</span>;
<a name="l00238"></a>00238                } <span class="keywordflow">else</span> {
<a name="l00239"></a>00239                   <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <span class="charliteral">&apos;D&apos;</span>)
<a name="l00240"></a>00240                      <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Off-hook capable CPE only, not ADSI\n&quot;</span>);
<a name="l00241"></a>00241                   <span class="keywordflow">else</span>
<a name="l00242"></a>00242                      <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unknown ADSI response &apos;%c&apos;\n&quot;</span>, f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l00243"></a>00243                   <span class="keywordflow">if</span> (!chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a>)
<a name="l00244"></a>00244                      chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda5f0673b46cfdba3094393b3fbce084ff">AST_ADSI_UNAVAILABLE</a>;
<a name="l00245"></a>00245                   <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> =  ENOSYS;
<a name="l00246"></a>00246                   <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00247"></a>00247                   <span class="keywordflow">return</span> -1;
<a name="l00248"></a>00248                }
<a name="l00249"></a>00249             }
<a name="l00250"></a>00250             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l00251"></a>00251          }
<a name="l00252"></a>00252 
<a name="l00253"></a>00253          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;ADSI Compatible CPE Detected\n&quot;</span>);
<a name="l00254"></a>00254       } <span class="keywordflow">else</span> {
<a name="l00255"></a>00255          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Already in data mode\n&quot;</span>);
<a name="l00256"></a>00256       }
<a name="l00257"></a>00257 
<a name="l00258"></a>00258       x = 0;
<a name="l00259"></a>00259       pos = 0;
<a name="l00260"></a>00260 <span class="preprocessor">#if 1</span>
<a name="l00261"></a>00261 <span class="preprocessor"></span>      def= <a class="code" href="channel_8h.html#aeaeb784665c384163aefb975ddf8bbe8" title="Set defer DTMF flag on channel.">ast_channel_defer_dtmf</a>(chan);
<a name="l00262"></a>00262 <span class="preprocessor">#endif</span>
<a name="l00263"></a>00263 <span class="preprocessor"></span>      <span class="keywordflow">while</span> ((x &lt; 6) &amp;&amp; msg[x]) {
<a name="l00264"></a>00264          <span class="keywordflow">if</span> ((res = <a class="code" href="res__adsi_8c.html#a77b039b5598e8fecbc0732ac7d28149e">adsi_generate</a>(buf + pos, msgtype[x], msg[x], msglen[x], x+1 - start, (x == 5) || !msg[x+1], <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>)) &lt; 0) {
<a name="l00265"></a>00265             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Failed to generate ADSI message %d on channel %s\n&quot;</span>, x + 1, chan-&gt;name);
<a name="l00266"></a>00266             <span class="keywordflow">return</span> -1;
<a name="l00267"></a>00267          }
<a name="l00268"></a>00268          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Message %d, of %d input bytes, %d output bytes\n&quot;</span>, x + 1, msglen[x], res);
<a name="l00269"></a>00269          pos += res; 
<a name="l00270"></a>00270          x++;
<a name="l00271"></a>00271       }
<a name="l00272"></a>00272 
<a name="l00273"></a>00273 
<a name="l00274"></a>00274       rem = 0;
<a name="l00275"></a>00275       res = <a class="code" href="res__adsi_8c.html#a7d4b85bd5838855639db8c52fdf984d4">adsi_careful_send</a>(chan, buf, pos, &amp;rem); 
<a name="l00276"></a>00276       <span class="keywordflow">if</span> (!def)
<a name="l00277"></a>00277          <a class="code" href="channel_8h.html#a6e558e6f257935744c3c7f9cd79b169a" title="Unset defer DTMF flag on channel.">ast_channel_undefer_dtmf</a>(chan);
<a name="l00278"></a>00278       <span class="keywordflow">if</span> (res)
<a name="l00279"></a>00279          <span class="keywordflow">return</span> -1;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sent total spill of %d bytes\n&quot;</span>, pos);
<a name="l00282"></a>00282 
<a name="l00283"></a>00283       memset(ack, 0, <span class="keyword">sizeof</span>(ack));
<a name="l00284"></a>00284       <span class="comment">/* Get real result and check for hangup */</span>
<a name="l00285"></a>00285       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, ack, 2, 1000, 1000, <span class="stringliteral">&quot;&quot;</span>)) &lt; 0)
<a name="l00286"></a>00286          <span class="keywordflow">return</span> -1;
<a name="l00287"></a>00287       <span class="keywordflow">if</span> (ack[0] == <span class="charliteral">&apos;D&apos;</span>) {
<a name="l00288"></a>00288          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Acked up to message %d\n&quot;</span>, atoi(ack + 1)); start += atoi(ack + 1);
<a name="l00289"></a>00289          <span class="keywordflow">if</span> (start &gt;= x)
<a name="l00290"></a>00290             <span class="keywordflow">break</span>;
<a name="l00291"></a>00291          <span class="keywordflow">else</span> {
<a name="l00292"></a>00292             retries++;
<a name="l00293"></a>00293             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Retransmitting (%d), from %d\n&quot;</span>, retries, start + 1);
<a name="l00294"></a>00294          }
<a name="l00295"></a>00295       } <span class="keywordflow">else</span> {
<a name="l00296"></a>00296          retries++;
<a name="l00297"></a>00297          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unexpected response to ack: %s (retry %d)\n&quot;</span>, ack, retries);
<a name="l00298"></a>00298       } 
<a name="l00299"></a>00299    }
<a name="l00300"></a>00300    <span class="keywordflow">if</span> (retries &gt;= maxretries) {
<a name="l00301"></a>00301       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Maximum ADSI Retries (%d) exceeded\n&quot;</span>, maxretries);
<a name="l00302"></a>00302       <a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> = ETIMEDOUT;
<a name="l00303"></a>00303       <span class="keywordflow">return</span> -1;
<a name="l00304"></a>00304    }
<a name="l00305"></a>00305    <span class="keywordflow">return</span> 0;
<a name="l00306"></a>00306    
<a name="l00307"></a>00307 }
<a name="l00308"></a>00308 
<a name="l00309"></a><a class="code" href="res__adsi_8c.html#ac13abcb7cbb0d4053a9f1d0a4fa0d160">00309</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac13abcb7cbb0d4053a9f1d0a4fa0d160">_ast_adsi_begin_download</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aed36d154f8ca19a029fd633b46371aac">fdn</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>, <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>)
<a name="l00310"></a>00310 {
<a name="l00311"></a>00311    <span class="keywordtype">int</span> bytes = 0;
<a name="l00312"></a>00312    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l00313"></a>00313    <span class="keywordtype">char</span> ack[2];
<a name="l00314"></a>00314 
<a name="l00315"></a>00315    <span class="comment">/* Setup the resident soft key stuff, a piece at a time */</span>
<a name="l00316"></a>00316    <span class="comment">/* Upload what scripts we can for voicemail ahead of time */</span>
<a name="l00317"></a>00317    bytes += <a class="code" href="adsi_8h.html#a7391fa1749bf0c1aa8d0b5bf0bdf38be" title="Begin an ADSI script download.">ast_adsi_download_connect</a>(buf + bytes, service, fdn, sec, version);
<a name="l00318"></a>00318    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>, 0))
<a name="l00319"></a>00319       <span class="keywordflow">return</span> -1;
<a name="l00320"></a>00320    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, ack, 1, 10000, 10000, <span class="stringliteral">&quot;&quot;</span>))
<a name="l00321"></a>00321       <span class="keywordflow">return</span> -1;
<a name="l00322"></a>00322    <span class="keywordflow">if</span> (ack[0] == <span class="charliteral">&apos;B&apos;</span>)
<a name="l00323"></a>00323       <span class="keywordflow">return</span> 0;
<a name="l00324"></a>00324    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Download was denied by CPE\n&quot;</span>);
<a name="l00325"></a>00325    <span class="keywordflow">return</span> -1;
<a name="l00326"></a>00326 }
<a name="l00327"></a>00327 
<a name="l00328"></a><a class="code" href="res__adsi_8c.html#a29967b8b5479aa0e560e990d2236af94">00328</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a29967b8b5479aa0e560e990d2236af94">_ast_adsi_end_download</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00329"></a>00329 {
<a name="l00330"></a>00330    <span class="keywordtype">int</span> bytes = 0;
<a name="l00331"></a>00331    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256];
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         <span class="comment">/* Setup the resident soft key stuff, a piece at a time */</span>
<a name="l00334"></a>00334         <span class="comment">/* Upload what scripts we can for voicemail ahead of time */</span>
<a name="l00335"></a>00335         bytes += <a class="code" href="adsi_8h.html#aaff06e2b870849b76f084c8edc7453a8" title="Disconnects (and hopefully saves) a downloaded script.">ast_adsi_download_disconnect</a>(buf + bytes);
<a name="l00336"></a>00336    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a2e0a51a5c3ebbb2933612622c37cd8e0">ADSI_MSG_DOWNLOAD</a>, 0))
<a name="l00337"></a>00337       <span class="keywordflow">return</span> -1;
<a name="l00338"></a>00338    <span class="keywordflow">return</span> 0;
<a name="l00339"></a>00339 }
<a name="l00340"></a>00340 
<a name="l00341"></a><a class="code" href="res__adsi_8c.html#ac24dbeed53fd61f998121588dc00c507">00341</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac24dbeed53fd61f998121588dc00c507">_ast_adsi_transmit_message_full</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#ad1cc5e2494e96eecb8611fb7247ffc89">msgtype</a>, <span class="keywordtype">int</span> dowait)
<a name="l00342"></a>00342 {
<a name="l00343"></a>00343    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *msgs[5] = { NULL, NULL, NULL, NULL, NULL };
<a name="l00344"></a>00344    <span class="keywordtype">int</span> msglens[5], msgtypes[5], newdatamode = (chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> &amp; <a class="code" href="res__adsi_8c.html#a2447f977e8fdc689f10e33b81d96311c">ADSI_FLAG_DATAMODE</a>), res, x, writeformat = chan-&gt;<a class="code" href="structast__channel.html#a00f5ce2ad53ff8523f8e46ea5aceba48">writeformat</a>, readformat = chan-&gt;<a class="code" href="structast__channel.html#ab7786a0f5b9a9ebf83daed87be4f3868">readformat</a>, waitforswitch = 0;
<a name="l00345"></a>00345 
<a name="l00346"></a>00346    for (x = 0; x &lt; msglen; x += (msg[x+1]+2)) {
<a name="l00347"></a>00347       <span class="keywordflow">if</span> (msg[x] == <a class="code" href="adsi_8h.html#a16edf72296b754eb3050a925514e5668">ADSI_SWITCH_TO_DATA</a>) {
<a name="l00348"></a>00348          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Switch to data is sent!\n&quot;</span>);
<a name="l00349"></a>00349          waitforswitch++;
<a name="l00350"></a>00350          newdatamode = <a class="code" href="res__adsi_8c.html#a2447f977e8fdc689f10e33b81d96311c">ADSI_FLAG_DATAMODE</a>;
<a name="l00351"></a>00351       }
<a name="l00352"></a>00352       
<a name="l00353"></a>00353       <span class="keywordflow">if</span> (msg[x] == <a class="code" href="adsi_8h.html#a9b6de4f95cabfc85caa0feb7981da6e2">ADSI_SWITCH_TO_VOICE</a>) {
<a name="l00354"></a>00354          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Switch to voice is sent!\n&quot;</span>);
<a name="l00355"></a>00355          waitforswitch++;
<a name="l00356"></a>00356          newdatamode = 0;
<a name="l00357"></a>00357       }
<a name="l00358"></a>00358    }
<a name="l00359"></a>00359    msgs[0] = msg;
<a name="l00360"></a>00360 
<a name="l00361"></a>00361    msglens[0] = msglen;
<a name="l00362"></a>00362    msgtypes[0] = msgtype;
<a name="l00363"></a>00363 
<a name="l00364"></a>00364    <span class="keywordflow">if</span> (msglen &gt; 253) {
<a name="l00365"></a>00365       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t send ADSI message of %d bytes, too large\n&quot;</span>, msglen);
<a name="l00366"></a>00366       <span class="keywordflow">return</span> -1;
<a name="l00367"></a>00367    }
<a name="l00368"></a>00368 
<a name="l00369"></a>00369    <a class="code" href="file_8h.html#a3092bf11d4bba66f646562759608b1bc" title="Stops a stream.">ast_stopstream</a>(chan);
<a name="l00370"></a>00370 
<a name="l00371"></a>00371    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>)) {
<a name="l00372"></a>00372       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set write format to ULAW\n&quot;</span>);
<a name="l00373"></a>00373       <span class="keywordflow">return</span> -1;
<a name="l00374"></a>00374    }
<a name="l00375"></a>00375 
<a name="l00376"></a>00376    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>)) {
<a name="l00377"></a>00377       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to set read format to ULAW\n&quot;</span>);
<a name="l00378"></a>00378       <span class="keywordflow">if</span> (writeformat) {
<a name="l00379"></a>00379          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, writeformat)) 
<a name="l00380"></a>00380             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to restore write format to %d\n&quot;</span>, writeformat);
<a name="l00381"></a>00381       }
<a name="l00382"></a>00382       <span class="keywordflow">return</span> -1;
<a name="l00383"></a>00383    }
<a name="l00384"></a>00384    res = <a class="code" href="res__adsi_8c.html#a2efe248249d58ae6b4ffe4d535f9ab27">__adsi_transmit_messages</a>(chan, msgs, msglens, msgtypes);
<a name="l00385"></a>00385 
<a name="l00386"></a>00386    <span class="keywordflow">if</span> (dowait) {
<a name="l00387"></a>00387       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Wait for switch is &apos;%d&apos;\n&quot;</span>, waitforswitch);
<a name="l00388"></a>00388       <span class="keywordflow">while</span> (waitforswitch-- &amp;&amp; ((res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 1000)) &gt; 0)) { 
<a name="l00389"></a>00389          res = 0; 
<a name="l00390"></a>00390          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Waiting for &apos;B&apos;...\n&quot;</span>);
<a name="l00391"></a>00391       }
<a name="l00392"></a>00392    }
<a name="l00393"></a>00393    
<a name="l00394"></a>00394    <span class="keywordflow">if</span> (!res)
<a name="l00395"></a>00395       chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> = (chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> &amp; ~<a class="code" href="res__adsi_8c.html#a2447f977e8fdc689f10e33b81d96311c">ADSI_FLAG_DATAMODE</a>) | newdatamode;
<a name="l00396"></a>00396 
<a name="l00397"></a>00397    <span class="keywordflow">if</span> (writeformat)
<a name="l00398"></a>00398       <a class="code" href="channel_8h.html#a978161a52d98fdaee374d1f6e1359544" title="Sets write format on channel chan Set write format for channel to whichever component...">ast_set_write_format</a>(chan, writeformat);
<a name="l00399"></a>00399    <span class="keywordflow">if</span> (readformat)
<a name="l00400"></a>00400       <a class="code" href="channel_8h.html#a72d53065c6bc2b6092fa41eefa03f1ad" title="Sets read format on channel chan Set read format for channel to whichever component...">ast_set_read_format</a>(chan, readformat);
<a name="l00401"></a>00401 
<a name="l00402"></a>00402    <span class="keywordflow">if</span> (!res)
<a name="l00403"></a>00403       res = <a class="code" href="channel_8h.html#af10e3bd01602095e1908d3926afc3b76" title="Wait for a specified amount of time, looking for hangups.">ast_safe_sleep</a>(chan, 100 );
<a name="l00404"></a>00404    <span class="keywordflow">return</span> res;
<a name="l00405"></a>00405 }
<a name="l00406"></a>00406 
<a name="l00407"></a><a class="code" href="res__adsi_8c.html#acb14a139a356dfa5d8f366e53c350d6f">00407</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#acb14a139a356dfa5d8f366e53c350d6f">_ast_adsi_transmit_message</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#ad1cc5e2494e96eecb8611fb7247ffc89">msgtype</a>)
<a name="l00408"></a>00408 {
<a name="l00409"></a>00409    <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, msg, msglen, msgtype, 1);
<a name="l00410"></a>00410 }
<a name="l00411"></a>00411 
<a name="l00412"></a><a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">00412</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *dst, <span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a>, <span class="keywordtype">int</span> max)
<a name="l00413"></a>00413 {
<a name="l00414"></a>00414    <span class="keywordtype">int</span> x = 0;
<a name="l00415"></a>00415    <span class="comment">/* Carefully copy the requested data */</span>
<a name="l00416"></a>00416    <span class="keywordflow">while</span> ((x &lt; max) &amp;&amp; src[x] &amp;&amp; (src[x] != 0xff)) {
<a name="l00417"></a>00417       dst[x] = src[x];
<a name="l00418"></a>00418       x++;
<a name="l00419"></a>00419    }
<a name="l00420"></a>00420    <span class="keywordflow">return</span> x;
<a name="l00421"></a>00421 }
<a name="l00422"></a>00422 
<a name="l00423"></a><a class="code" href="res__adsi_8c.html#a160707152b2b257d21072a45366cf75f">00423</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a160707152b2b257d21072a45366cf75f">_ast_adsi_load_soft_key</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> key, <span class="keyword">const</span> <span class="keywordtype">char</span> *llabel, <span class="keyword">const</span> <span class="keywordtype">char</span> *slabel, <span class="keywordtype">char</span> *ret, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l00424"></a>00424 {
<a name="l00425"></a>00425    <span class="keywordtype">int</span> bytes = 0;
<a name="l00426"></a>00426 
<a name="l00427"></a>00427    <span class="comment">/* Abort if invalid key specified */</span>
<a name="l00428"></a>00428    <span class="keywordflow">if</span> ((key &lt; 2) || (key &gt; 33))
<a name="l00429"></a>00429       <span class="keywordflow">return</span> -1;
<a name="l00430"></a>00430 
<a name="l00431"></a>00431    buf[bytes++] = <a class="code" href="adsi_8h.html#aaf3c22fc852fbfb723a41e039f2293cc">ADSI_LOAD_SOFTKEY</a>;
<a name="l00432"></a>00432    <span class="comment">/* Reserve for length */</span>
<a name="l00433"></a>00433    bytes++;
<a name="l00434"></a>00434    <span class="comment">/* Which key */</span>
<a name="l00435"></a>00435    buf[bytes++] = key;
<a name="l00436"></a>00436 
<a name="l00437"></a>00437    <span class="comment">/* Carefully copy long label */</span>
<a name="l00438"></a>00438    bytes += <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)llabel, 18);
<a name="l00439"></a>00439 
<a name="l00440"></a>00440    <span class="comment">/* Place delimiter */</span>
<a name="l00441"></a>00441    buf[bytes++] = 0xff;
<a name="l00442"></a>00442 
<a name="l00443"></a>00443    <span class="comment">/* Short label */</span>
<a name="l00444"></a>00444    bytes += <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)slabel, 7);
<a name="l00445"></a>00445 
<a name="l00446"></a>00446 
<a name="l00447"></a>00447    <span class="comment">/* If specified, copy return string */</span>
<a name="l00448"></a>00448    <span class="keywordflow">if</span> (ret) {
<a name="l00449"></a>00449       <span class="comment">/* Place delimiter */</span>
<a name="l00450"></a>00450       buf[bytes++] = 0xff;
<a name="l00451"></a>00451       <span class="keywordflow">if</span> (data)
<a name="l00452"></a>00452          buf[bytes++] = <a class="code" href="adsi_8h.html#aaa4a2a29878b2604b340db4a297c3fb9">ADSI_SWITCH_TO_DATA2</a>;
<a name="l00453"></a>00453       <span class="comment">/* Carefully copy return string */</span>
<a name="l00454"></a>00454       bytes += <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keyword">const</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)ret, 20);
<a name="l00455"></a>00455 
<a name="l00456"></a>00456    }
<a name="l00457"></a>00457    <span class="comment">/* Replace parameter length */</span>
<a name="l00458"></a>00458    buf[1] = bytes - 2;
<a name="l00459"></a>00459    <span class="keywordflow">return</span> bytes;
<a name="l00460"></a>00460    
<a name="l00461"></a>00461 }
<a name="l00462"></a>00462 
<a name="l00463"></a><a class="code" href="res__adsi_8c.html#a8d6e97b9794110a25d921df6e12dcdcb">00463</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a8d6e97b9794110a25d921df6e12dcdcb">_ast_adsi_connect_session</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aed36d154f8ca19a029fd633b46371aac">fdn</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a4408245b2edc5f227220ea4f24ea0fab">ver</a>)
<a name="l00464"></a>00464 {
<a name="l00465"></a>00465    <span class="keywordtype">int</span> bytes = 0, x;
<a name="l00466"></a>00466 
<a name="l00467"></a>00467    <span class="comment">/* Message type */</span>
<a name="l00468"></a>00468    buf[bytes++] = <a class="code" href="adsi_8h.html#a394cd4ba355d88e199d43148907c38e9">ADSI_CONNECT_SESSION</a>;
<a name="l00469"></a>00469 
<a name="l00470"></a>00470    <span class="comment">/* Reserve space for length */</span>
<a name="l00471"></a>00471    bytes++;
<a name="l00472"></a>00472 
<a name="l00473"></a>00473    <span class="keywordflow">if</span> (fdn) {
<a name="l00474"></a>00474       <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++)
<a name="l00475"></a>00475          buf[bytes++] = fdn[x];
<a name="l00476"></a>00476       <span class="keywordflow">if</span> (ver &gt; -1)
<a name="l00477"></a>00477          buf[bytes++] = ver &amp; 0xff;
<a name="l00478"></a>00478    }
<a name="l00479"></a>00479 
<a name="l00480"></a>00480    buf[1] = bytes - 2;
<a name="l00481"></a>00481    <span class="keywordflow">return</span> bytes;
<a name="l00482"></a>00482 
<a name="l00483"></a>00483 }
<a name="l00484"></a>00484 
<a name="l00485"></a><a class="code" href="res__adsi_8c.html#a0e2db152b3c7d2aaef9db9ee0339f7d8">00485</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a0e2db152b3c7d2aaef9db9ee0339f7d8">_ast_adsi_download_connect</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#ad61354ac038c6aaed26fded971a8843b">service</a>,  <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aed36d154f8ca19a029fd633b46371aac">fdn</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a4408245b2edc5f227220ea4f24ea0fab">ver</a>)
<a name="l00486"></a>00486 {
<a name="l00487"></a>00487    <span class="keywordtype">int</span> bytes = 0, x;
<a name="l00488"></a>00488 
<a name="l00489"></a>00489    <span class="comment">/* Message type */</span>
<a name="l00490"></a>00490    buf[bytes++] = <a class="code" href="adsi_8h.html#a188c71e011cd5cd36351f43325c7c5c4">ADSI_DOWNLOAD_CONNECT</a>;
<a name="l00491"></a>00491 
<a name="l00492"></a>00492    <span class="comment">/* Reserve space for length */</span>
<a name="l00493"></a>00493    bytes++;
<a name="l00494"></a>00494 
<a name="l00495"></a>00495    <span class="comment">/* Primary column */</span>
<a name="l00496"></a>00496    bytes+= <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)service, 18);
<a name="l00497"></a>00497 
<a name="l00498"></a>00498    <span class="comment">/* Delimiter */</span>
<a name="l00499"></a>00499    buf[bytes++] = 0xff;
<a name="l00500"></a>00500    
<a name="l00501"></a>00501    <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++)
<a name="l00502"></a>00502       buf[bytes++] = fdn[x];
<a name="l00503"></a>00503 
<a name="l00504"></a>00504    <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++)
<a name="l00505"></a>00505       buf[bytes++] = sec[x];
<a name="l00506"></a>00506 
<a name="l00507"></a>00507    buf[bytes++] = ver &amp; 0xff;
<a name="l00508"></a>00508 
<a name="l00509"></a>00509    buf[1] = bytes - 2;
<a name="l00510"></a>00510 
<a name="l00511"></a>00511    <span class="keywordflow">return</span> bytes;
<a name="l00512"></a>00512 
<a name="l00513"></a>00513 }
<a name="l00514"></a>00514 
<a name="l00515"></a><a class="code" href="res__adsi_8c.html#ac334bd9d230084d4e3f06345c7ca22ca">00515</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac334bd9d230084d4e3f06345c7ca22ca">_ast_adsi_disconnect_session</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00516"></a>00516 {
<a name="l00517"></a>00517    <span class="keywordtype">int</span> bytes = 0;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519    <span class="comment">/* Message type */</span>
<a name="l00520"></a>00520    buf[bytes++] = <a class="code" href="adsi_8h.html#a1e7820db46b95b4a6760cd8c113c60fd">ADSI_DISC_SESSION</a>;
<a name="l00521"></a>00521 
<a name="l00522"></a>00522    <span class="comment">/* Reserve space for length */</span>
<a name="l00523"></a>00523    bytes++;
<a name="l00524"></a>00524 
<a name="l00525"></a>00525    buf[1] = bytes - 2;
<a name="l00526"></a>00526    <span class="keywordflow">return</span> bytes;
<a name="l00527"></a>00527 
<a name="l00528"></a>00528 }
<a name="l00529"></a>00529 
<a name="l00530"></a><a class="code" href="res__adsi_8c.html#a3fde69c7cb9251547a60e80001d7312c">00530</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a3fde69c7cb9251547a60e80001d7312c">_ast_adsi_query_cpeid</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00531"></a>00531 {
<a name="l00532"></a>00532    <span class="keywordtype">int</span> bytes = 0;
<a name="l00533"></a>00533    buf[bytes++] = <a class="code" href="adsi_8h.html#aff99f9bf4e20af23cdb941f3088f71a2">ADSI_QUERY_CPEID</a>;
<a name="l00534"></a>00534    <span class="comment">/* Reserve space for length */</span>
<a name="l00535"></a>00535    bytes++;
<a name="l00536"></a>00536    buf[1] = bytes - 2;
<a name="l00537"></a>00537    <span class="keywordflow">return</span> bytes;
<a name="l00538"></a>00538 }
<a name="l00539"></a>00539 
<a name="l00540"></a><a class="code" href="res__adsi_8c.html#a8f16d3b25eae7e9f8722f5b09aad2b32">00540</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a8f16d3b25eae7e9f8722f5b09aad2b32">_ast_adsi_query_cpeinfo</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00541"></a>00541 {
<a name="l00542"></a>00542    <span class="keywordtype">int</span> bytes = 0;
<a name="l00543"></a>00543    buf[bytes++] = <a class="code" href="adsi_8h.html#af5a91ea1cf1c31009596aa6c1589f678">ADSI_QUERY_CONFIG</a>;
<a name="l00544"></a>00544    <span class="comment">/* Reserve space for length */</span>
<a name="l00545"></a>00545    bytes++;
<a name="l00546"></a>00546    buf[1] = bytes - 2;
<a name="l00547"></a>00547    <span class="keywordflow">return</span> bytes;
<a name="l00548"></a>00548 }
<a name="l00549"></a>00549 
<a name="l00550"></a><a class="code" href="res__adsi_8c.html#a64e6a0df9be73d73510896ac188ad742">00550</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a64e6a0df9be73d73510896ac188ad742">_ast_adsi_read_encoded_dtmf</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> maxlen)
<a name="l00551"></a>00551 {
<a name="l00552"></a>00552    <span class="keywordtype">int</span> bytes = 0, res, gotstar = 0, pos = 0;
<a name="l00553"></a>00553    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> current = 0;
<a name="l00554"></a>00554 
<a name="l00555"></a>00555    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l00556"></a>00556 
<a name="l00557"></a>00557    <span class="keywordflow">while</span>(bytes &lt;= maxlen) {
<a name="l00558"></a>00558       <span class="comment">/* Wait up to a second for a digit */</span>
<a name="l00559"></a>00559       <span class="keywordflow">if</span> (!(res = <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 1000)))
<a name="l00560"></a>00560          <span class="keywordflow">break</span>;
<a name="l00561"></a>00561       <span class="keywordflow">if</span> (res == <span class="charliteral">&apos;*&apos;</span>) {
<a name="l00562"></a>00562          gotstar = 1;   
<a name="l00563"></a>00563          <span class="keywordflow">continue</span>;
<a name="l00564"></a>00564       }
<a name="l00565"></a>00565       <span class="comment">/* Ignore anything other than a digit */</span>
<a name="l00566"></a>00566       <span class="keywordflow">if</span> ((res &lt; <span class="charliteral">&apos;0&apos;</span>) || (res &gt; <span class="charliteral">&apos;9&apos;</span>))
<a name="l00567"></a>00567          <span class="keywordflow">continue</span>;
<a name="l00568"></a>00568       res -= <span class="charliteral">&apos;0&apos;</span>;
<a name="l00569"></a>00569       <span class="keywordflow">if</span> (gotstar)
<a name="l00570"></a>00570          res += 9;
<a name="l00571"></a>00571       <span class="keywordflow">if</span> (pos)  {
<a name="l00572"></a>00572          pos = 0;
<a name="l00573"></a>00573          buf[bytes++] = (res &lt;&lt; 4) | current;
<a name="l00574"></a>00574       } <span class="keywordflow">else</span> {
<a name="l00575"></a>00575          pos = 1;
<a name="l00576"></a>00576          current = res;
<a name="l00577"></a>00577       }
<a name="l00578"></a>00578       gotstar = 0;
<a name="l00579"></a>00579    }
<a name="l00580"></a>00580 
<a name="l00581"></a>00581    <span class="keywordflow">return</span> bytes;
<a name="l00582"></a>00582 }
<a name="l00583"></a>00583 
<a name="l00584"></a><a class="code" href="res__adsi_8c.html#afc6b3c3af43b59b9eb0a49053a3c2213">00584</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#afc6b3c3af43b59b9eb0a49053a3c2213">_ast_adsi_get_cpeid</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *cpeid, <span class="keywordtype">int</span> voice)
<a name="l00585"></a>00585 {
<a name="l00586"></a>00586    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00587"></a>00587    <span class="keywordtype">int</span> bytes = 0, res;
<a name="l00588"></a>00588 
<a name="l00589"></a>00589    bytes += <a class="code" href="adsi_8h.html#a80b703aa4e9a1342400af797dd5e603a" title="Puts CPE in data mode.">ast_adsi_data_mode</a>(buf);
<a name="l00590"></a>00590    <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00591"></a>00591 
<a name="l00592"></a>00592    bytes = 0;
<a name="l00593"></a>00593    bytes += <a class="code" href="adsi_8h.html#a7153dd3cdc96955dba61f8ae71e18583">ast_adsi_query_cpeid</a>(buf);
<a name="l00594"></a>00594    <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00595"></a>00595 
<a name="l00596"></a>00596    <span class="comment">/* Get response */</span>
<a name="l00597"></a>00597    res = <a class="code" href="adsi_8h.html#a715279ed5fb32199562f459fa6f75c65">ast_adsi_read_encoded_dtmf</a>(chan, cpeid, 4);
<a name="l00598"></a>00598    <span class="keywordflow">if</span> (res != 4) {
<a name="l00599"></a>00599       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got %d bytes back of encoded DTMF, expecting 4\n&quot;</span>, res);
<a name="l00600"></a>00600       res = 0;
<a name="l00601"></a>00601    } <span class="keywordflow">else</span> {
<a name="l00602"></a>00602       res = 1;
<a name="l00603"></a>00603    }
<a name="l00604"></a>00604 
<a name="l00605"></a>00605    <span class="keywordflow">if</span> (voice) {
<a name="l00606"></a>00606       bytes = 0;
<a name="l00607"></a>00607       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf, 0);
<a name="l00608"></a>00608       <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00609"></a>00609       <span class="comment">/* Ignore the resulting DTMF B announcing it&apos;s in voice mode */</span>
<a name="l00610"></a>00610       <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 1000);
<a name="l00611"></a>00611    }
<a name="l00612"></a>00612    <span class="keywordflow">return</span> res;
<a name="l00613"></a>00613 }
<a name="l00614"></a>00614 
<a name="l00615"></a><a class="code" href="res__adsi_8c.html#a892848235a850a8afa5580b11b9ca090">00615</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a892848235a850a8afa5580b11b9ca090">_ast_adsi_get_cpeinfo</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">int</span> *<a class="code" href="adsistub_8c.html#ad78a47d2fcbb8c10e8e6eb4dcbf54fe6">width</a>, <span class="keywordtype">int</span> *<a class="code" href="adsistub_8c.html#a99568342c1eec10ff2d1a75b26e4d030">height</a>, <span class="keywordtype">int</span> *<a class="code" href="adsistub_8c.html#a49f4939e3cdfcf9e7277dcd4c294d2e5">buttons</a>, <span class="keywordtype">int</span> voice)
<a name="l00616"></a>00616 {
<a name="l00617"></a>00617    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00618"></a>00618    <span class="keywordtype">int</span> bytes = 0, res;
<a name="l00619"></a>00619 
<a name="l00620"></a>00620    bytes += <a class="code" href="adsi_8h.html#a80b703aa4e9a1342400af797dd5e603a" title="Puts CPE in data mode.">ast_adsi_data_mode</a>(buf);
<a name="l00621"></a>00621    <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00622"></a>00622 
<a name="l00623"></a>00623    bytes = 0;
<a name="l00624"></a>00624    bytes += <a class="code" href="adsi_8h.html#a869fe89998f0bb826ea3b731eb7473d3">ast_adsi_query_cpeinfo</a>(buf);
<a name="l00625"></a>00625    <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00626"></a>00626 
<a name="l00627"></a>00627    <span class="comment">/* Get width */</span>
<a name="l00628"></a>00628    <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, (<span class="keywordtype">char</span> *)buf, 2, 1000, 500, <span class="stringliteral">&quot;&quot;</span>)) &lt; 0)
<a name="l00629"></a>00629       <span class="keywordflow">return</span> res;
<a name="l00630"></a>00630    <span class="keywordflow">if</span> (strlen((<span class="keywordtype">char</span> *)buf) != 2) {
<a name="l00631"></a>00631       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got %d bytes of width, expecting 2\n&quot;</span>, res);
<a name="l00632"></a>00632       res = 0;
<a name="l00633"></a>00633    } <span class="keywordflow">else</span> {
<a name="l00634"></a>00634       res = 1;
<a name="l00635"></a>00635    }
<a name="l00636"></a>00636    <span class="keywordflow">if</span> (width)
<a name="l00637"></a>00637       *width = atoi((<span class="keywordtype">char</span> *)buf);
<a name="l00638"></a>00638    <span class="comment">/* Get height */</span>
<a name="l00639"></a>00639    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l00640"></a>00640    <span class="keywordflow">if</span> (res) {
<a name="l00641"></a>00641       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, (<span class="keywordtype">char</span> *)buf, 2, 1000, 500, <span class="stringliteral">&quot;&quot;</span>)) &lt; 0)
<a name="l00642"></a>00642          <span class="keywordflow">return</span> res;
<a name="l00643"></a>00643       <span class="keywordflow">if</span> (strlen((<span class="keywordtype">char</span> *)buf) != 2) {
<a name="l00644"></a>00644          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got %d bytes of height, expecting 2\n&quot;</span>, res);
<a name="l00645"></a>00645          res = 0;
<a name="l00646"></a>00646       } <span class="keywordflow">else</span> {
<a name="l00647"></a>00647          res = 1;
<a name="l00648"></a>00648       }  
<a name="l00649"></a>00649       <span class="keywordflow">if</span> (height)
<a name="l00650"></a>00650          *height= atoi((<span class="keywordtype">char</span> *)buf);
<a name="l00651"></a>00651    }
<a name="l00652"></a>00652    <span class="comment">/* Get buttons */</span>
<a name="l00653"></a>00653    memset(buf, 0, <span class="keyword">sizeof</span>(buf));
<a name="l00654"></a>00654    <span class="keywordflow">if</span> (res) {
<a name="l00655"></a>00655       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, (<span class="keywordtype">char</span> *)buf, 1, 1000, 500, <span class="stringliteral">&quot;&quot;</span>)) &lt; 0)
<a name="l00656"></a>00656          <span class="keywordflow">return</span> res;
<a name="l00657"></a>00657       <span class="keywordflow">if</span> (strlen((<span class="keywordtype">char</span> *)buf) != 1) {
<a name="l00658"></a>00658          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got %d bytes of buttons, expecting 1\n&quot;</span>, res);
<a name="l00659"></a>00659          res = 0;
<a name="l00660"></a>00660       } <span class="keywordflow">else</span> {
<a name="l00661"></a>00661          res = 1;
<a name="l00662"></a>00662       }  
<a name="l00663"></a>00663       <span class="keywordflow">if</span> (buttons)
<a name="l00664"></a>00664          *buttons = atoi((<span class="keywordtype">char</span> *)buf);
<a name="l00665"></a>00665    }
<a name="l00666"></a>00666    <span class="keywordflow">if</span> (voice) {
<a name="l00667"></a>00667       bytes = 0;
<a name="l00668"></a>00668       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf, 0);
<a name="l00669"></a>00669       <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00670"></a>00670       <span class="comment">/* Ignore the resulting DTMF B announcing it&apos;s in voice mode */</span>
<a name="l00671"></a>00671       <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 1000);
<a name="l00672"></a>00672    }
<a name="l00673"></a>00673    <span class="keywordflow">return</span> res;
<a name="l00674"></a>00674 }
<a name="l00675"></a>00675 
<a name="l00676"></a><a class="code" href="res__adsi_8c.html#a39061c919cdf2440bff8caed4a1d26bd">00676</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a39061c919cdf2440bff8caed4a1d26bd">_ast_adsi_data_mode</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00677"></a>00677 {
<a name="l00678"></a>00678    <span class="keywordtype">int</span> bytes = 0;
<a name="l00679"></a>00679 
<a name="l00680"></a>00680    <span class="comment">/* Message type */</span>
<a name="l00681"></a>00681    buf[bytes++] = <a class="code" href="adsi_8h.html#a16edf72296b754eb3050a925514e5668">ADSI_SWITCH_TO_DATA</a>;
<a name="l00682"></a>00682 
<a name="l00683"></a>00683    <span class="comment">/* Reserve space for length */</span>
<a name="l00684"></a>00684    bytes++;
<a name="l00685"></a>00685 
<a name="l00686"></a>00686    buf[1] = bytes - 2;
<a name="l00687"></a>00687    <span class="keywordflow">return</span> bytes;
<a name="l00688"></a>00688 
<a name="l00689"></a>00689 }
<a name="l00690"></a>00690 
<a name="l00691"></a><a class="code" href="res__adsi_8c.html#a9b7feab70b284d96e4cab7ef9308f28e">00691</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a9b7feab70b284d96e4cab7ef9308f28e">_ast_adsi_clear_soft_keys</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00692"></a>00692 {
<a name="l00693"></a>00693    <span class="keywordtype">int</span> bytes = 0;
<a name="l00694"></a>00694 
<a name="l00695"></a>00695    <span class="comment">/* Message type */</span>
<a name="l00696"></a>00696    buf[bytes++] = <a class="code" href="adsi_8h.html#a8a49d9035f2791f6928429799c52e62b">ADSI_CLEAR_SOFTKEY</a>;
<a name="l00697"></a>00697 
<a name="l00698"></a>00698    <span class="comment">/* Reserve space for length */</span>
<a name="l00699"></a>00699    bytes++;
<a name="l00700"></a>00700 
<a name="l00701"></a>00701    buf[1] = bytes - 2;
<a name="l00702"></a>00702    <span class="keywordflow">return</span> bytes;
<a name="l00703"></a>00703 
<a name="l00704"></a>00704 }
<a name="l00705"></a>00705 
<a name="l00706"></a><a class="code" href="res__adsi_8c.html#ab80ba869e7a63d4e961fb29d582132e9">00706</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ab80ba869e7a63d4e961fb29d582132e9">_ast_adsi_clear_screen</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00707"></a>00707 {
<a name="l00708"></a>00708    <span class="keywordtype">int</span> bytes = 0;
<a name="l00709"></a>00709 
<a name="l00710"></a>00710    <span class="comment">/* Message type */</span>
<a name="l00711"></a>00711    buf[bytes++] = <a class="code" href="adsi_8h.html#ab84213f96af4e9b0641cd2e8db2853a9">ADSI_CLEAR_SCREEN</a>;
<a name="l00712"></a>00712 
<a name="l00713"></a>00713    <span class="comment">/* Reserve space for length */</span>
<a name="l00714"></a>00714    bytes++;
<a name="l00715"></a>00715 
<a name="l00716"></a>00716    buf[1] = bytes - 2;
<a name="l00717"></a>00717    <span class="keywordflow">return</span> bytes;
<a name="l00718"></a>00718 
<a name="l00719"></a>00719 }
<a name="l00720"></a>00720 
<a name="l00721"></a><a class="code" href="res__adsi_8c.html#a299fd07f8620c66e261e334dae649801">00721</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a299fd07f8620c66e261e334dae649801">_ast_adsi_voice_mode</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> when)
<a name="l00722"></a>00722 {
<a name="l00723"></a>00723    <span class="keywordtype">int</span> bytes = 0;
<a name="l00724"></a>00724 
<a name="l00725"></a>00725    <span class="comment">/* Message type */</span>
<a name="l00726"></a>00726    buf[bytes++] = <a class="code" href="adsi_8h.html#a9b6de4f95cabfc85caa0feb7981da6e2">ADSI_SWITCH_TO_VOICE</a>;
<a name="l00727"></a>00727 
<a name="l00728"></a>00728    <span class="comment">/* Reserve space for length */</span>
<a name="l00729"></a>00729    bytes++;
<a name="l00730"></a>00730 
<a name="l00731"></a>00731    buf[bytes++] = when &amp; 0x7f;
<a name="l00732"></a>00732 
<a name="l00733"></a>00733    buf[1] = bytes - 2;
<a name="l00734"></a>00734    <span class="keywordflow">return</span> bytes;
<a name="l00735"></a>00735 
<a name="l00736"></a>00736 }
<a name="l00737"></a>00737 
<a name="l00738"></a><a class="code" href="res__adsi_8c.html#a6ddbaf6160713327cc99e51a4374b682">00738</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a6ddbaf6160713327cc99e51a4374b682">_ast_adsi_available</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00739"></a>00739 {
<a name="l00740"></a>00740    <span class="keywordtype">int</span> cpe = chan-&gt;<a class="code" href="structast__channel.html#a4507948aab513e976b52d2253376ee7f">adsicpe</a> &amp; 0xff;
<a name="l00741"></a>00741    <span class="keywordflow">if</span> ((cpe == <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda760a7f7c7ffc838f278b34db7bb69e4d">AST_ADSI_AVAILABLE</a>) ||
<a name="l00742"></a>00742        (cpe == <a class="code" href="channel_8h.html#a828f537544a2ad2352c56c078390a0bda163e3c7fdbfeb7a7bb55df3872546131">AST_ADSI_UNKNOWN</a>))
<a name="l00743"></a>00743       <span class="keywordflow">return</span> 1;
<a name="l00744"></a>00744    <span class="keywordflow">return</span> 0;
<a name="l00745"></a>00745 }
<a name="l00746"></a>00746 
<a name="l00747"></a><a class="code" href="res__adsi_8c.html#a3d98e9a079f69987ccc7c6f852f56c73">00747</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a3d98e9a079f69987ccc7c6f852f56c73">_ast_adsi_download_disconnect</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>)
<a name="l00748"></a>00748 {
<a name="l00749"></a>00749    <span class="keywordtype">int</span> bytes = 0;
<a name="l00750"></a>00750 
<a name="l00751"></a>00751    <span class="comment">/* Message type */</span>
<a name="l00752"></a>00752    buf[bytes++] = <a class="code" href="adsi_8h.html#a86fce3ce5951241b865ca665e8eb73f0">ADSI_DOWNLOAD_DISC</a>;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754    <span class="comment">/* Reserve space for length */</span>
<a name="l00755"></a>00755    bytes++;
<a name="l00756"></a>00756 
<a name="l00757"></a>00757    buf[1] = bytes - 2;
<a name="l00758"></a>00758    <span class="keywordflow">return</span> bytes;
<a name="l00759"></a>00759 
<a name="l00760"></a>00760 }
<a name="l00761"></a>00761 
<a name="l00762"></a><a class="code" href="res__adsi_8c.html#a44f6bbca6744a3f565f75f4e92583db3">00762</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a44f6bbca6744a3f565f75f4e92583db3">_ast_adsi_display</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a68cf50bee509a6b69603c25cb19921c6">page</a>, <span class="keywordtype">int</span> line, <span class="keywordtype">int</span> just, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#adea7bb5d7dfdd8001561ecee51cbfbae">wrap</a>, 
<a name="l00763"></a>00763        <span class="keywordtype">char</span> *col1, <span class="keywordtype">char</span> *col2)
<a name="l00764"></a>00764 {
<a name="l00765"></a>00765    <span class="keywordtype">int</span> bytes = 0;
<a name="l00766"></a>00766 
<a name="l00767"></a>00767    <span class="comment">/* Sanity check line number */</span>
<a name="l00768"></a>00768 
<a name="l00769"></a>00769    <span class="keywordflow">if</span> (page) {
<a name="l00770"></a>00770       <span class="keywordflow">if</span> (line &gt; 4) <span class="keywordflow">return</span> -1;
<a name="l00771"></a>00771    } <span class="keywordflow">else</span> {
<a name="l00772"></a>00772       <span class="keywordflow">if</span> (line &gt; 33) <span class="keywordflow">return</span> -1;
<a name="l00773"></a>00773    }
<a name="l00774"></a>00774 
<a name="l00775"></a>00775    <span class="keywordflow">if</span> (line &lt; 1)
<a name="l00776"></a>00776       <span class="keywordflow">return</span> -1;
<a name="l00777"></a>00777    <span class="comment">/* Parameter type */</span>
<a name="l00778"></a>00778    buf[bytes++] = <a class="code" href="adsi_8h.html#aeb401263fd5741a7ad1b6bee95eeebb5">ADSI_LOAD_VIRTUAL_DISP</a>;
<a name="l00779"></a>00779    
<a name="l00780"></a>00780    <span class="comment">/* Reserve space for size */</span>
<a name="l00781"></a>00781    bytes++;
<a name="l00782"></a>00782 
<a name="l00783"></a>00783    <span class="comment">/* Page and wrap indicator */</span>
<a name="l00784"></a>00784    buf[bytes++] = ((page &amp; 0x1) &lt;&lt; 7) | ((wrap &amp; 0x1) &lt;&lt; 6) | (line &amp; 0x3f);
<a name="l00785"></a>00785 
<a name="l00786"></a>00786    <span class="comment">/* Justification */</span>
<a name="l00787"></a>00787    buf[bytes++] = (just &amp; 0x3) &lt;&lt; 5;
<a name="l00788"></a>00788 
<a name="l00789"></a>00789    <span class="comment">/* Omit highlight mode definition */</span>
<a name="l00790"></a>00790    buf[bytes++] = 0xff;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792    <span class="comment">/* Primary column */</span>
<a name="l00793"></a>00793    bytes+= <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)col1, 20);
<a name="l00794"></a>00794 
<a name="l00795"></a>00795    <span class="comment">/* Delimiter */</span>
<a name="l00796"></a>00796    buf[bytes++] = 0xff;
<a name="l00797"></a>00797    
<a name="l00798"></a>00798    <span class="comment">/* Secondary column */</span>
<a name="l00799"></a>00799    bytes += <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)col2, 20);
<a name="l00800"></a>00800 
<a name="l00801"></a>00801    <span class="comment">/* Update length */</span>
<a name="l00802"></a>00802    buf[1] = bytes - 2;
<a name="l00803"></a>00803    
<a name="l00804"></a>00804    <span class="keywordflow">return</span> bytes;
<a name="l00805"></a>00805 
<a name="l00806"></a>00806 }
<a name="l00807"></a>00807 
<a name="l00808"></a><a class="code" href="res__adsi_8c.html#a768e101bd5a6b7ed87cd94601bddea44">00808</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a768e101bd5a6b7ed87cd94601bddea44">_ast_adsi_input_control</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a68cf50bee509a6b69603c25cb19921c6">page</a>, <span class="keywordtype">int</span> line, <span class="keywordtype">int</span> display, <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>, <span class="keywordtype">int</span> just)
<a name="l00809"></a>00809 {
<a name="l00810"></a>00810    <span class="keywordtype">int</span> bytes = 0;
<a name="l00811"></a>00811 
<a name="l00812"></a>00812    <span class="keywordflow">if</span> (page) {
<a name="l00813"></a>00813       <span class="keywordflow">if</span> (line &gt; 4) <span class="keywordflow">return</span> -1;
<a name="l00814"></a>00814    } <span class="keywordflow">else</span> {
<a name="l00815"></a>00815       <span class="keywordflow">if</span> (line &gt; 33) <span class="keywordflow">return</span> -1;
<a name="l00816"></a>00816    }
<a name="l00817"></a>00817 
<a name="l00818"></a>00818    <span class="keywordflow">if</span> (line &lt; 1)
<a name="l00819"></a>00819       <span class="keywordflow">return</span> -1;
<a name="l00820"></a>00820 
<a name="l00821"></a>00821    buf[bytes++] = <a class="code" href="adsi_8h.html#a014a1cb303fccc438698ab8053de09a5">ADSI_INPUT_CONTROL</a>;
<a name="l00822"></a>00822    bytes++;
<a name="l00823"></a>00823    buf[bytes++] = ((page &amp; 1) &lt;&lt; 7) | (line &amp; 0x3f);
<a name="l00824"></a>00824    buf[bytes++] = ((display &amp; 1) &lt;&lt; 7) | ((just &amp; 0x3) &lt;&lt; 4) | (format &amp; 0x7);
<a name="l00825"></a>00825    
<a name="l00826"></a>00826    buf[1] = bytes - 2;
<a name="l00827"></a>00827    <span class="keywordflow">return</span> bytes;
<a name="l00828"></a>00828 
<a name="l00829"></a>00829 }
<a name="l00830"></a>00830 
<a name="l00831"></a><a class="code" href="res__adsi_8c.html#a1eb66b5ce237afd03795f4d525b501be">00831</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a1eb66b5ce237afd03795f4d525b501be">_ast_adsi_input_format</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#af6fc584548091f45267cfaf7066119bd">num</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a946c6fe93168120f0fa86002b4e9d575">dir</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#adea7bb5d7dfdd8001561ecee51cbfbae">wrap</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#a0167ace304e5350959f8f7bce953bdd8">format1</a>, <span class="keywordtype">char</span> *format2)
<a name="l00832"></a>00832 {
<a name="l00833"></a>00833    <span class="keywordtype">int</span> bytes = 0;
<a name="l00834"></a>00834 
<a name="l00835"></a>00835    <span class="keywordflow">if</span> (!strlen((<span class="keywordtype">char</span> *)format1))
<a name="l00836"></a>00836       <span class="keywordflow">return</span> -1;
<a name="l00837"></a>00837 
<a name="l00838"></a>00838    buf[bytes++] = <a class="code" href="adsi_8h.html#ae13ba15b81c0f47abfa2d5b227017f68">ADSI_INPUT_FORMAT</a>;
<a name="l00839"></a>00839    bytes++;
<a name="l00840"></a>00840    buf[bytes++] = ((dir &amp; 1) &lt;&lt; 7) | ((wrap &amp; 1) &lt;&lt; 6) | (num &amp; 0x7);
<a name="l00841"></a>00841    bytes += <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)format1, 20);
<a name="l00842"></a>00842    buf[bytes++] = 0xff;
<a name="l00843"></a>00843    <span class="keywordflow">if</span> (format2 &amp;&amp; strlen((<span class="keywordtype">char</span> *)format2)) {
<a name="l00844"></a>00844       bytes += <a class="code" href="res__adsi_8c.html#ae56f642b9fec346fb38ea1777bb8374f">ccopy</a>(buf + bytes, (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)format2, 20);
<a name="l00845"></a>00845    }
<a name="l00846"></a>00846    buf[1] = bytes - 2;
<a name="l00847"></a>00847    <span class="keywordflow">return</span> bytes;
<a name="l00848"></a>00848 }
<a name="l00849"></a>00849 
<a name="l00850"></a><a class="code" href="res__adsi_8c.html#a9f9b792f269b81ef44100c5764390e4d">00850</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a9f9b792f269b81ef44100c5764390e4d">_ast_adsi_set_keys</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structkeys.html">keys</a>)
<a name="l00851"></a>00851 {
<a name="l00852"></a>00852    <span class="keywordtype">int</span> bytes = 0, x;
<a name="l00853"></a>00853 
<a name="l00854"></a>00854    <span class="comment">/* Message type */</span>
<a name="l00855"></a>00855    buf[bytes++] = <a class="code" href="adsi_8h.html#acfa6efe6ed2c08d62ae15d0837708f00">ADSI_INIT_SOFTKEY_LINE</a>;
<a name="l00856"></a>00856    <span class="comment">/* Space for size */</span>
<a name="l00857"></a>00857    bytes++;
<a name="l00858"></a>00858    <span class="comment">/* Key definitions */</span>
<a name="l00859"></a>00859    <span class="keywordflow">for</span> (x = 0; x &lt; 6; x++)
<a name="l00860"></a>00860       buf[bytes++] = (keys[x] &amp; 0x3f) ? keys[x] : (keys[x] | 0x1);
<a name="l00861"></a>00861    buf[1] = bytes - 2;
<a name="l00862"></a>00862    <span class="keywordflow">return</span> bytes;
<a name="l00863"></a>00863 }
<a name="l00864"></a>00864 
<a name="l00865"></a><a class="code" href="res__adsi_8c.html#a8758839f34f4e5b19df463e23eb8779e">00865</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a8758839f34f4e5b19df463e23eb8779e">_ast_adsi_set_line</a>(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a68cf50bee509a6b69603c25cb19921c6">page</a>, <span class="keywordtype">int</span> line)
<a name="l00866"></a>00866 {
<a name="l00867"></a>00867    <span class="keywordtype">int</span> bytes = 0;
<a name="l00868"></a>00868 
<a name="l00869"></a>00869    <span class="comment">/* Sanity check line number */</span>
<a name="l00870"></a>00870 
<a name="l00871"></a>00871    <span class="keywordflow">if</span> (page) {
<a name="l00872"></a>00872       <span class="keywordflow">if</span> (line &gt; 4) <span class="keywordflow">return</span> -1;
<a name="l00873"></a>00873    } <span class="keywordflow">else</span> {
<a name="l00874"></a>00874       <span class="keywordflow">if</span> (line &gt; 33) <span class="keywordflow">return</span> -1;
<a name="l00875"></a>00875    }
<a name="l00876"></a>00876 
<a name="l00877"></a>00877    <span class="keywordflow">if</span> (line &lt; 1)
<a name="l00878"></a>00878       <span class="keywordflow">return</span> -1;
<a name="l00879"></a>00879    <span class="comment">/* Parameter type */</span>
<a name="l00880"></a>00880    buf[bytes++] = <a class="code" href="adsi_8h.html#a1f4532a53a8647e31ec86dd5bf303e11">ADSI_LINE_CONTROL</a>;
<a name="l00881"></a>00881    
<a name="l00882"></a>00882    <span class="comment">/* Reserve space for size */</span>
<a name="l00883"></a>00883    bytes++;
<a name="l00884"></a>00884 
<a name="l00885"></a>00885    <span class="comment">/* Page and line */</span>
<a name="l00886"></a>00886    buf[bytes++] = ((page &amp; 0x1) &lt;&lt; 7) | (line &amp; 0x3f);
<a name="l00887"></a>00887 
<a name="l00888"></a>00888    buf[1] = bytes - 2;
<a name="l00889"></a>00889    <span class="keywordflow">return</span> bytes;
<a name="l00890"></a>00890 
<a name="l00891"></a>00891 };
<a name="l00892"></a>00892 
<a name="l00893"></a><a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">00893</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac7af894858cf396a219d632f40afdc8d">total</a> = 0;
<a name="l00894"></a><a class="code" href="res__adsi_8c.html#a08471dfaed9bfbf2ffbf72a52fe4fffb">00894</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a08471dfaed9bfbf2ffbf72a52fe4fffb">speeds</a> = 0;
<a name="l00895"></a>00895 
<a name="l00896"></a><a class="code" href="res__adsi_8c.html#abeaadba70d97120e27a281af9947f361">00896</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#abeaadba70d97120e27a281af9947f361">_ast_adsi_channel_restore</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00897"></a>00897 {
<a name="l00898"></a>00898    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsp[256] = <span class="stringliteral">&quot;&quot;</span>, keyd[6] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00899"></a>00899    <span class="keywordtype">int</span> bytes, x;
<a name="l00900"></a>00900 
<a name="l00901"></a>00901    <span class="comment">/* Start with initial display setup */</span>
<a name="l00902"></a>00902    bytes = 0;
<a name="l00903"></a>00903    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(dsp + bytes, <a class="code" href="adsi_8h.html#a1024eb317e88742fde2143333130b0b6">ADSI_INFO_PAGE</a>, 1);
<a name="l00904"></a>00904 
<a name="l00905"></a>00905    <span class="comment">/* Prepare key setup messages */</span>
<a name="l00906"></a>00906 
<a name="l00907"></a>00907    <span class="keywordflow">if</span> (speeds) {
<a name="l00908"></a>00908       <span class="keywordflow">for</span> (x = 0; x &lt; speeds; x++)
<a name="l00909"></a>00909          keyd[x] = <a class="code" href="res__adsi_8c.html#aea7435fd1af44d9caec35b913e0d6dd1">ADSI_SPEED_DIAL</a> + x;
<a name="l00910"></a>00910       bytes += <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a>(dsp + bytes, keyd);
<a name="l00911"></a>00911    }
<a name="l00912"></a>00912    <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, dsp, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00913"></a>00913    <span class="keywordflow">return</span> 0;
<a name="l00914"></a>00914 
<a name="l00915"></a>00915 }
<a name="l00916"></a>00916 
<a name="l00917"></a><a class="code" href="res__adsi_8c.html#a0eb0f780d53702b2060b4f1c36dd01a2">00917</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a0eb0f780d53702b2060b4f1c36dd01a2">_ast_adsi_print</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">char</span> **lines, <span class="keywordtype">int</span> *alignments, <span class="keywordtype">int</span> voice)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[4096];
<a name="l00920"></a>00920    <span class="keywordtype">int</span> bytes = 0, res, x;
<a name="l00921"></a>00921 
<a name="l00922"></a>00922    <span class="keywordflow">for</span>(x = 0; lines[x]; x++) 
<a name="l00923"></a>00923       bytes += <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a>(buf + bytes, <a class="code" href="adsi_8h.html#a1024eb317e88742fde2143333130b0b6">ADSI_INFO_PAGE</a>, x+1, alignments[x], 0, lines[x], <span class="stringliteral">&quot;&quot;</span>);
<a name="l00924"></a>00924    bytes += <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a>(buf + bytes, <a class="code" href="adsi_8h.html#a1024eb317e88742fde2143333130b0b6">ADSI_INFO_PAGE</a>, 1);
<a name="l00925"></a>00925    <span class="keywordflow">if</span> (voice)
<a name="l00926"></a>00926       bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(buf + bytes, 0);
<a name="l00927"></a>00927    res = <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, buf, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0);
<a name="l00928"></a>00928    <span class="keywordflow">if</span> (voice)
<a name="l00929"></a>00929       <span class="comment">/* Ignore the resulting DTMF B announcing it&apos;s in voice mode */</span>
<a name="l00930"></a>00930       <a class="code" href="channel_8h.html#a050bec9a4abc1a599b6573a6091b080c" title="Waits for a digit.">ast_waitfordigit</a>(chan, 1000);
<a name="l00931"></a>00931    <span class="keywordflow">return</span> res;
<a name="l00932"></a>00932 }
<a name="l00933"></a>00933 
<a name="l00934"></a><a class="code" href="res__adsi_8c.html#a7ecd44858aea2d3fceda58484b0984a4">00934</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a7ecd44858aea2d3fceda58484b0984a4">_ast_adsi_load_session</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#ad194d73de26c0d836555e029d245493d">app</a>, <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a4408245b2edc5f227220ea4f24ea0fab">ver</a>, <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsp[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00937"></a>00937    <span class="keywordtype">int</span> bytes = 0, res;
<a name="l00938"></a>00938    <span class="keywordtype">char</span> resp[2];
<a name="l00939"></a>00939 
<a name="l00940"></a>00940    <span class="comment">/* Connect to session */</span>
<a name="l00941"></a>00941    bytes += <a class="code" href="adsi_8h.html#a35a1ca8d1094e66a2cf13cc72d0f0c76" title="Connects an ADSI Display Session.">ast_adsi_connect_session</a>(dsp + bytes, app, ver);
<a name="l00942"></a>00942 
<a name="l00943"></a>00943    <span class="keywordflow">if</span> (data)
<a name="l00944"></a>00944       bytes += <a class="code" href="adsi_8h.html#a80b703aa4e9a1342400af797dd5e603a" title="Puts CPE in data mode.">ast_adsi_data_mode</a>(dsp + bytes);
<a name="l00945"></a>00945 
<a name="l00946"></a>00946    <span class="comment">/* Prepare key setup messages */</span>
<a name="l00947"></a>00947    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, dsp, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0))
<a name="l00948"></a>00948       <span class="keywordflow">return</span> -1;
<a name="l00949"></a>00949    <span class="keywordflow">if</span> (app) {
<a name="l00950"></a>00950       <span class="keywordflow">if</span> ((res = <a class="code" href="channel_8h.html#ae68c6e4af7aba456ec08906cb9fb3140">ast_readstring</a>(chan, resp, 1, 1200, 1200, <span class="stringliteral">&quot;&quot;</span>)) &lt; 0)
<a name="l00951"></a>00951          <span class="keywordflow">return</span> -1;
<a name="l00952"></a>00952       <span class="keywordflow">if</span> (res) {
<a name="l00953"></a>00953          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;No response from CPE about version.  Assuming not there.\n&quot;</span>);
<a name="l00954"></a>00954          <span class="keywordflow">return</span> 0;
<a name="l00955"></a>00955       }
<a name="l00956"></a>00956       <span class="keywordflow">if</span> (!strcmp(resp, <span class="stringliteral">&quot;B&quot;</span>)) {
<a name="l00957"></a>00957          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;CPE has script &apos;%s&apos; version %d already loaded\n&quot;</span>, app, ver);
<a name="l00958"></a>00958          <span class="keywordflow">return</span> 1;
<a name="l00959"></a>00959       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcmp(resp, <span class="stringliteral">&quot;A&quot;</span>)) {
<a name="l00960"></a>00960          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;CPE hasn&apos;t script &apos;%s&apos; version %d already loaded\n&quot;</span>, app, ver);
<a name="l00961"></a>00961       } <span class="keywordflow">else</span> {
<a name="l00962"></a>00962          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unexpected CPE response to script query: %s\n&quot;</span>, resp);
<a name="l00963"></a>00963       }
<a name="l00964"></a>00964    } <span class="keywordflow">else</span>
<a name="l00965"></a>00965       <span class="keywordflow">return</span> 1;
<a name="l00966"></a>00966    <span class="keywordflow">return</span> 0;
<a name="l00967"></a>00967 
<a name="l00968"></a>00968 }
<a name="l00969"></a>00969 
<a name="l00970"></a><a class="code" href="res__adsi_8c.html#a81ebf4f4418206c661ae5d74560f077e">00970</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#a81ebf4f4418206c661ae5d74560f077e">_ast_adsi_unload_session</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l00971"></a>00971 {
<a name="l00972"></a>00972    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> dsp[256] = <span class="stringliteral">&quot;&quot;</span>;
<a name="l00973"></a>00973    <span class="keywordtype">int</span> bytes = 0;
<a name="l00974"></a>00974 
<a name="l00975"></a>00975    <span class="comment">/* Connect to session */</span>
<a name="l00976"></a>00976    bytes += <a class="code" href="adsi_8h.html#ae99c2c3e01269d831cbe479cadc0add6" title="Disconnects a running session.">ast_adsi_disconnect_session</a>(dsp + bytes);
<a name="l00977"></a>00977    bytes += <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a>(dsp + bytes, 0);
<a name="l00978"></a>00978 
<a name="l00979"></a>00979    <span class="comment">/* Prepare key setup messages */</span>
<a name="l00980"></a>00980    <span class="keywordflow">if</span> (<a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a>(chan, dsp, bytes, <a class="code" href="adsi_8h.html#a5f65b445dd274af93d891153a82808cf">ADSI_MSG_DISPLAY</a>, 0))
<a name="l00981"></a>00981       <span class="keywordflow">return</span> -1;
<a name="l00982"></a>00982 
<a name="l00983"></a>00983    <span class="keywordflow">return</span> 0;
<a name="l00984"></a>00984 }
<a name="l00985"></a>00985 
<a name="l00986"></a><a class="code" href="res__adsi_8c.html#adc0c676ad5a60ff13f432a9c7359484e">00986</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#adc0c676ad5a60ff13f432a9c7359484e">str2align</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>)
<a name="l00987"></a>00987 {
<a name="l00988"></a>00988    <span class="keywordflow">if</span> (!strncasecmp(s, <span class="stringliteral">&quot;l&quot;</span>, 1))
<a name="l00989"></a>00989       <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#a730b24255e33ddaa2bc4e52b51220100">ADSI_JUST_LEFT</a>;
<a name="l00990"></a>00990    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(s, <span class="stringliteral">&quot;r&quot;</span>, 1))
<a name="l00991"></a>00991       <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#a245f8f8cfbe048c9878c7a87cfa8f346">ADSI_JUST_RIGHT</a>;
<a name="l00992"></a>00992    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(s, <span class="stringliteral">&quot;i&quot;</span>, 1))
<a name="l00993"></a>00993       <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#af033da31eb4860309432a42681bc41e3">ADSI_JUST_IND</a>;
<a name="l00994"></a>00994    <span class="keywordflow">else</span>
<a name="l00995"></a>00995       <span class="keywordflow">return</span> <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>;
<a name="l00996"></a>00996 }
<a name="l00997"></a>00997 
<a name="l00998"></a><a class="code" href="res__adsi_8c.html#ad83a81c0586755098baa52a61599a2b8">00998</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__adsi_8c.html#ad83a81c0586755098baa52a61599a2b8">init_state</a>(<span class="keywordtype">void</span>)
<a name="l00999"></a>00999 {
<a name="l01000"></a>01000    <span class="keywordtype">int</span> x;
<a name="l01001"></a>01001 
<a name="l01002"></a>01002    <span class="keywordflow">for</span> (x = 0; x &lt; <a class="code" href="res__adsi_8c.html#a883381de25fae11725272776402f66ed">ADSI_MAX_INTRO</a>; x++)
<a name="l01003"></a>01003       aligns[x] = <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>;
<a name="l01004"></a>01004    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(intro[0], <span class="stringliteral">&quot;Welcome to the&quot;</span>, <span class="keyword">sizeof</span>(intro[0]));
<a name="l01005"></a>01005    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(intro[1], <span class="stringliteral">&quot;Asterisk&quot;</span>, <span class="keyword">sizeof</span>(intro[1]));
<a name="l01006"></a>01006    <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(intro[2], <span class="stringliteral">&quot;Open Source PBX&quot;</span>, <span class="keyword">sizeof</span>(intro[2]));
<a name="l01007"></a>01007    total = 3;
<a name="l01008"></a>01008    speeds = 0;
<a name="l01009"></a>01009    <span class="keywordflow">for</span> (x = 3; x &lt; ADSI_MAX_INTRO; x++)
<a name="l01010"></a>01010       intro[x][0] = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l01011"></a>01011    memset(speeddial, 0, <span class="keyword">sizeof</span>(speeddial));
<a name="l01012"></a>01012    alignment = <a class="code" href="adsi_8h.html#a518a772e38d00198d7570756559c0761">ADSI_JUST_CENT</a>;
<a name="l01013"></a>01013 }
<a name="l01014"></a>01014 
<a name="l01015"></a><a class="code" href="res__adsi_8c.html#abc66d7b12a89c85738ac76ef774e2f82">01015</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="res__adsi_8c.html#abc66d7b12a89c85738ac76ef774e2f82">adsi_load</a>(<span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l01016"></a>01016 {
<a name="l01017"></a>01017    <span class="keywordtype">int</span> x = 0;
<a name="l01018"></a>01018    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *conf = NULL;
<a name="l01019"></a>01019    <span class="keyword">struct </span><a class="code" href="structast__variable.html" title="Structure for variables, used for configurations and for channel variables.">ast_variable</a> *v;
<a name="l01020"></a>01020    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l01021"></a>01021    <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a>, *sname;
<a name="l01022"></a>01022    <a class="code" href="res__adsi_8c.html#ad83a81c0586755098baa52a61599a2b8">init_state</a>();
<a name="l01023"></a>01023 
<a name="l01024"></a>01024    conf = <a class="code" href="config_8h.html#a0a07ddd6bbcf44485e01c14c96109482">ast_config_load</a>(<span class="stringliteral">&quot;adsi.conf&quot;</span>, config_flags);
<a name="l01025"></a>01025    <span class="keywordflow">if</span> (conf == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || conf == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || conf == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l01026"></a>01026       <span class="keywordflow">return</span>;
<a name="l01027"></a>01027    }
<a name="l01028"></a>01028    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(conf, <span class="stringliteral">&quot;intro&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01029"></a>01029       <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;alignment&quot;</span>))
<a name="l01030"></a>01030          alignment = <a class="code" href="res__adsi_8c.html#adc0c676ad5a60ff13f432a9c7359484e">str2align</a>(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01031"></a>01031       <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;greeting&quot;</span>)) {
<a name="l01032"></a>01032          <span class="keywordflow">if</span> (x &lt; <a class="code" href="res__adsi_8c.html#a883381de25fae11725272776402f66ed">ADSI_MAX_INTRO</a>) {
<a name="l01033"></a>01033             aligns[x] = alignment;
<a name="l01034"></a>01034             <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(intro[x], v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(intro[x]));
<a name="l01035"></a>01035             x++;
<a name="l01036"></a>01036          }
<a name="l01037"></a>01037       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strcasecmp(v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="stringliteral">&quot;maxretries&quot;</span>)) {
<a name="l01038"></a>01038          <span class="keywordflow">if</span> (atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>) &gt; 0)
<a name="l01039"></a>01039             maxretries = atoi(v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>);
<a name="l01040"></a>01040       }
<a name="l01041"></a>01041    }
<a name="l01042"></a>01042    <span class="keywordflow">if</span> (x)
<a name="l01043"></a>01043       total = x;
<a name="l01044"></a>01044       
<a name="l01045"></a>01045    x = 0;
<a name="l01046"></a>01046    <span class="keywordflow">for</span> (v = <a class="code" href="config_8h.html#a935ccfa153100ddd320c8918bd6e941b" title="Goes through variables Somewhat similar in intent as the ast_category_browse. List...">ast_variable_browse</a>(conf, <span class="stringliteral">&quot;speeddial&quot;</span>); v; v = v-&gt;<a class="code" href="structast__variable.html#a46f18867e3894852bc489a4cd9cfa516">next</a>) {
<a name="l01047"></a>01047       <span class="keywordtype">char</span> <a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>[3 * <a class="code" href="res__adsi_8c.html#a7960db0a226b9ee534e59e459ed228ef">SPEEDDIAL_MAX_LEN</a>];
<a name="l01048"></a>01048       <span class="keywordtype">char</span> *stringp = buf;
<a name="l01049"></a>01049       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(buf, v-&gt;<a class="code" href="structast__variable.html#a8556878012feffc9e0beb86cd78f424d">value</a>, <span class="keyword">sizeof</span>(buf));
<a name="l01050"></a>01050       name = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01051"></a>01051       sname = <a class="code" href="agi_2strcompat_8c.html#a40eca58273c74a20a17f137d18ba826c">strsep</a>(&amp;stringp, <span class="stringliteral">&quot;,&quot;</span>);
<a name="l01052"></a>01052       <span class="keywordflow">if</span> (!sname) 
<a name="l01053"></a>01053          sname = name;
<a name="l01054"></a>01054       <span class="keywordflow">if</span> (x &lt; <a class="code" href="res__adsi_8c.html#a811570484466fddfd91a3695c25a2aed">ADSI_MAX_SPEED_DIAL</a>) {
<a name="l01055"></a>01055          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(speeddial[x][0], v-&gt;<a class="code" href="structast__variable.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, <span class="keyword">sizeof</span>(speeddial[x][0]));
<a name="l01056"></a>01056          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(speeddial[x][1], name, 18);
<a name="l01057"></a>01057          <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(speeddial[x][2], sname, 7);
<a name="l01058"></a>01058          x++;
<a name="l01059"></a>01059       }
<a name="l01060"></a>01060    }
<a name="l01061"></a>01061    <span class="keywordflow">if</span> (x)
<a name="l01062"></a>01062       speeds = x;
<a name="l01063"></a>01063    <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(conf);
<a name="l01064"></a>01064 
<a name="l01065"></a>01065    <span class="keywordflow">return</span>;
<a name="l01066"></a>01066 }
<a name="l01067"></a>01067 
<a name="l01068"></a><a class="code" href="res__adsi_8c.html#ad1982509765f4870f1f63412a53ea668">01068</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>(<span class="keywordtype">void</span>)
<a name="l01069"></a>01069 {
<a name="l01070"></a>01070    <a class="code" href="res__adsi_8c.html#abc66d7b12a89c85738ac76ef774e2f82">adsi_load</a>(1);
<a name="l01071"></a>01071    <span class="keywordflow">return</span> 0;
<a name="l01072"></a>01072 }
<a name="l01073"></a>01073 
<a name="l01074"></a><a class="code" href="res__adsi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">01074</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="res__adsi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>(<span class="keywordtype">void</span>)
<a name="l01075"></a>01075 {
<a name="l01076"></a>01076    <a class="code" href="res__adsi_8c.html#abc66d7b12a89c85738ac76ef774e2f82">adsi_load</a>(0);
<a name="l01077"></a>01077 
<a name="l01078"></a>01078    <a class="code" href="adsi_8h.html#a8f98a667128bb0296f9a2e09786f61bb">ast_adsi_begin_download</a> = <a class="code" href="res__adsi_8c.html#ac13abcb7cbb0d4053a9f1d0a4fa0d160">_ast_adsi_begin_download</a>;
<a name="l01079"></a>01079    <a class="code" href="adsi_8h.html#a12c4576517435afede8d83ca1ea8e7dd">ast_adsi_end_download</a> = <a class="code" href="res__adsi_8c.html#a29967b8b5479aa0e560e990d2236af94">_ast_adsi_end_download</a>;
<a name="l01080"></a>01080    <a class="code" href="adsi_8h.html#ac79b7f9ae118f8585c651ea3d062a5a0">ast_adsi_channel_restore</a> = <a class="code" href="res__adsi_8c.html#abeaadba70d97120e27a281af9947f361">_ast_adsi_channel_restore</a>;
<a name="l01081"></a>01081    <a class="code" href="adsi_8h.html#a6c89ea70599bb3b2de0aba1a3e2defa5" title="Display some stuff on the screen.">ast_adsi_print</a> = <a class="code" href="res__adsi_8c.html#a0eb0f780d53702b2060b4f1c36dd01a2">_ast_adsi_print</a>;
<a name="l01082"></a>01082    <a class="code" href="adsi_8h.html#a4c7e441bdf356ad4cbc6e549c2ff0ea1" title="Check if scripts for a given app are already loaded. Version may be -1, if any version...">ast_adsi_load_session</a> = <a class="code" href="res__adsi_8c.html#a7ecd44858aea2d3fceda58484b0984a4">_ast_adsi_load_session</a>;
<a name="l01083"></a>01083    <a class="code" href="adsi_8h.html#aa65291a80a241bda57a53d4f26ec5bed">ast_adsi_unload_session</a> = <a class="code" href="res__adsi_8c.html#a81ebf4f4418206c661ae5d74560f077e">_ast_adsi_unload_session</a>;
<a name="l01084"></a>01084    <a class="code" href="adsi_8h.html#ade0991b7687ddb977a60f3699753e8df">ast_adsi_transmit_message</a> = <a class="code" href="res__adsi_8c.html#acb14a139a356dfa5d8f366e53c350d6f">_ast_adsi_transmit_message</a>;
<a name="l01085"></a>01085    <a class="code" href="adsi_8h.html#acaf0374b7ac25dcb371e60f9bf7a4a00">ast_adsi_transmit_message_full</a> = <a class="code" href="res__adsi_8c.html#ac24dbeed53fd61f998121588dc00c507">_ast_adsi_transmit_message_full</a>;
<a name="l01086"></a>01086    <a class="code" href="adsi_8h.html#a715279ed5fb32199562f459fa6f75c65">ast_adsi_read_encoded_dtmf</a> = <a class="code" href="res__adsi_8c.html#a64e6a0df9be73d73510896ac188ad742">_ast_adsi_read_encoded_dtmf</a>;
<a name="l01087"></a>01087    <a class="code" href="adsi_8h.html#a35a1ca8d1094e66a2cf13cc72d0f0c76" title="Connects an ADSI Display Session.">ast_adsi_connect_session</a> = <a class="code" href="res__adsi_8c.html#a8d6e97b9794110a25d921df6e12dcdcb">_ast_adsi_connect_session</a>;
<a name="l01088"></a>01088    <a class="code" href="adsi_8h.html#a7153dd3cdc96955dba61f8ae71e18583">ast_adsi_query_cpeid</a> = <a class="code" href="res__adsi_8c.html#a3fde69c7cb9251547a60e80001d7312c">_ast_adsi_query_cpeid</a>;
<a name="l01089"></a>01089    <a class="code" href="adsi_8h.html#a869fe89998f0bb826ea3b731eb7473d3">ast_adsi_query_cpeinfo</a> = <a class="code" href="res__adsi_8c.html#a8f16d3b25eae7e9f8722f5b09aad2b32">_ast_adsi_query_cpeinfo</a>;
<a name="l01090"></a>01090    <a class="code" href="adsi_8h.html#a5b8ef968b54b0fe76852f1971b0231f5">ast_adsi_get_cpeid</a> = <a class="code" href="res__adsi_8c.html#afc6b3c3af43b59b9eb0a49053a3c2213">_ast_adsi_get_cpeid</a>;
<a name="l01091"></a>01091    <a class="code" href="adsi_8h.html#affffae11c46bb068900c4a814af55ac7">ast_adsi_get_cpeinfo</a> = <a class="code" href="res__adsi_8c.html#a892848235a850a8afa5580b11b9ca090">_ast_adsi_get_cpeinfo</a>;
<a name="l01092"></a>01092    <a class="code" href="adsi_8h.html#a7391fa1749bf0c1aa8d0b5bf0bdf38be" title="Begin an ADSI script download.">ast_adsi_download_connect</a> = <a class="code" href="res__adsi_8c.html#a0e2db152b3c7d2aaef9db9ee0339f7d8">_ast_adsi_download_connect</a>;
<a name="l01093"></a>01093    <a class="code" href="adsi_8h.html#ae99c2c3e01269d831cbe479cadc0add6" title="Disconnects a running session.">ast_adsi_disconnect_session</a> = <a class="code" href="res__adsi_8c.html#ac334bd9d230084d4e3f06345c7ca22ca">_ast_adsi_disconnect_session</a>;
<a name="l01094"></a>01094    <a class="code" href="adsi_8h.html#aaff06e2b870849b76f084c8edc7453a8" title="Disconnects (and hopefully saves) a downloaded script.">ast_adsi_download_disconnect</a> = <a class="code" href="res__adsi_8c.html#a3d98e9a079f69987ccc7c6f852f56c73">_ast_adsi_download_disconnect</a>;
<a name="l01095"></a>01095    <a class="code" href="adsi_8h.html#a80b703aa4e9a1342400af797dd5e603a" title="Puts CPE in data mode.">ast_adsi_data_mode</a> = <a class="code" href="res__adsi_8c.html#a39061c919cdf2440bff8caed4a1d26bd">_ast_adsi_data_mode</a>;
<a name="l01096"></a>01096    <a class="code" href="adsi_8h.html#a5d06bb6a9f8b115c17d8276548634df5">ast_adsi_clear_soft_keys</a> = <a class="code" href="res__adsi_8c.html#a9b7feab70b284d96e4cab7ef9308f28e">_ast_adsi_clear_soft_keys</a>;
<a name="l01097"></a>01097    <a class="code" href="adsi_8h.html#adec47cc159d3998a1108e69394618031">ast_adsi_clear_screen</a> = <a class="code" href="res__adsi_8c.html#ab80ba869e7a63d4e961fb29d582132e9">_ast_adsi_clear_screen</a>;
<a name="l01098"></a>01098    <a class="code" href="adsi_8h.html#a4f2642ed9f63e3b1ddc1020a96b1f0d9" title="Puts CPE in voice mode.">ast_adsi_voice_mode</a> = <a class="code" href="res__adsi_8c.html#a299fd07f8620c66e261e334dae649801">_ast_adsi_voice_mode</a>;
<a name="l01099"></a>01099    <a class="code" href="adsi_8h.html#af28e8c6a680742f32b9c39ea26e398f3" title="Returns non-zero if Channel does or might support ADSI.">ast_adsi_available</a> = <a class="code" href="res__adsi_8c.html#a6ddbaf6160713327cc99e51a4374b682">_ast_adsi_available</a>;
<a name="l01100"></a>01100    <a class="code" href="adsi_8h.html#a4ef17399d8bd69e82a97b7673d599ec2" title="Loads a line of info into the display.">ast_adsi_display</a> = <a class="code" href="res__adsi_8c.html#a44f6bbca6744a3f565f75f4e92583db3">_ast_adsi_display</a>;
<a name="l01101"></a>01101    <a class="code" href="adsi_8h.html#a14a3721e40e8ebc9b56271d9fd9e93af" title="Sets the current line and page.">ast_adsi_set_line</a> = <a class="code" href="res__adsi_8c.html#a8758839f34f4e5b19df463e23eb8779e">_ast_adsi_set_line</a>;
<a name="l01102"></a>01102    <a class="code" href="adsi_8h.html#a982f0252bac8d1be1f9b7cd64f8f2243" title="Creates &amp;quot;load soft key&amp;quot; parameters.">ast_adsi_load_soft_key</a> = <a class="code" href="res__adsi_8c.html#a160707152b2b257d21072a45366cf75f">_ast_adsi_load_soft_key</a>;
<a name="l01103"></a>01103    <a class="code" href="adsi_8h.html#aa17d05074a52bf9e2ce8ecf9a49099e9" title="Set which soft keys should be displayed.">ast_adsi_set_keys</a> = <a class="code" href="res__adsi_8c.html#a9f9b792f269b81ef44100c5764390e4d">_ast_adsi_set_keys</a>;
<a name="l01104"></a>01104    <a class="code" href="adsi_8h.html#a9fa4ae76cd4fb95fafcdddc8ce5fc955" title="Set input information.">ast_adsi_input_control</a> = <a class="code" href="res__adsi_8c.html#a768e101bd5a6b7ed87cd94601bddea44">_ast_adsi_input_control</a>;
<a name="l01105"></a>01105    <a class="code" href="adsi_8h.html#af964448bdeaae9b285547109cba5f1b1" title="Set input format.">ast_adsi_input_format</a> = <a class="code" href="res__adsi_8c.html#a1eb66b5ce237afd03795f4d525b501be">_ast_adsi_input_format</a>;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107    <span class="keywordflow">return</span> <a class="code" href="module_8h.html#adc09474f0ff557e9925b722ee5b952dfa89bb877ade9ce418ad6663f3d936f314">AST_MODULE_LOAD_SUCCESS</a>;
<a name="l01108"></a>01108 }
<a name="l01109"></a>01109 
<a name="l01110"></a><a class="code" href="res__adsi_8c.html#ad09fa931f468002152a3cc2d5ce25eae">01110</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>(<span class="keywordtype">void</span>)
<a name="l01111"></a>01111 {
<a name="l01112"></a>01112    <span class="comment">/* Can&apos;t unload this once we&apos;re loaded */</span>
<a name="l01113"></a>01113    <span class="keywordflow">return</span> -1;
<a name="l01114"></a>01114 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116 <a class="code" href="module_8h.html#a9f4aa0e21486bdbcef428335268690c9">AST_MODULE_INFO</a>(<a class="code" href="module_8h.html#aba2c8d4be709a254658b21a834f8294a" title="The text the key() function should return.">ASTERISK_GPL_KEY</a>, <a class="code" href="module_8h.html#a155a0df9c59e04e305d4a2fa3e35f843a54af2a9b29d140908cc9dffd0618951b">AST_MODFLAG_DEFAULT</a>, <span class="stringliteral">&quot;ADSI Resource&quot;</span>,
<a name="l01117"></a>01117       .load = <a class="code" href="res__adsi_8c.html#ac3382bf6da54c56b37069bd76bbdf4f9">load_module</a>,
<a name="l01118"></a>01118       .unload = <a class="code" href="agent_8c.html#a95bac1db604c69a01ef7b3995342cd7a">unload_module</a>,
<a name="l01119"></a>01119       .<a class="code" href="res__adsi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a> = <a class="code" href="res__adsi_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>,
<a name="l01120"></a><a class="code" href="res__adsi_8c.html#ae25b9f3970870610911f8850897e8ead">01120</a>           );
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:45 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
