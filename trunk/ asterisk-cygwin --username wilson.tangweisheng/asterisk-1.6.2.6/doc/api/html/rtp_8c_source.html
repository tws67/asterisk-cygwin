<HTML>
    <HEAD>
      <TITLE>Asterisk.org: Developer Documentation (5 May 2010)</TITLE>
      <LINK HREF="doxygen.css" REL="stylesheet" TYPE="text/css">
    </HEAD>
    <BODY BGCOLOR="#FFFFFF">
<div><font size="2" align="right">Wed May 5 15:18:47 2010</font></div>

<h2>Asterisk developer's documentation</h2>
<hr/>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_afe38fc0ccf2e9eefca5d5c6b03503d9.html">main</a>
  </div>
</div>
<div class="contents">
<h1>rtp.c</h1><a href="rtp_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Asterisk -- An open source telephony toolkit.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * Copyright (C) 1999 - 2006, Digium, Inc.</span>
<a name="l00005"></a>00005 <span class="comment"> *</span>
<a name="l00006"></a>00006 <span class="comment"> * Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See http://www.asterisk.org for more information about</span>
<a name="l00009"></a>00009 <span class="comment"> * the Asterisk project. Please do not directly contact</span>
<a name="l00010"></a>00010 <span class="comment"> * any of the maintainers of this project for assistance;</span>
<a name="l00011"></a>00011 <span class="comment"> * the project provides a web site, mailing lists and IRC</span>
<a name="l00012"></a>00012 <span class="comment"> * channels for your use.</span>
<a name="l00013"></a>00013 <span class="comment"> *</span>
<a name="l00014"></a>00014 <span class="comment"> * This program is free software, distributed under the terms of</span>
<a name="l00015"></a>00015 <span class="comment"> * the GNU General Public License Version 2. See the LICENSE file</span>
<a name="l00016"></a>00016 <span class="comment"> * at the top of the source tree.</span>
<a name="l00017"></a>00017 <span class="comment"> */</span>
<a name="l00018"></a>00018 <span class="comment"></span>
<a name="l00019"></a>00019 <span class="comment">/*! </span>
<a name="l00020"></a>00020 <span class="comment"> * \file </span>
<a name="l00021"></a>00021 <span class="comment"> *</span>
<a name="l00022"></a>00022 <span class="comment"> * \brief Supports RTP and RTCP with Symmetric RTP support for NAT traversal.</span>
<a name="l00023"></a>00023 <span class="comment"> *</span>
<a name="l00024"></a>00024 <span class="comment"> * \author Mark Spencer &lt;markster@digium.com&gt;</span>
<a name="l00025"></a>00025 <span class="comment"> * </span>
<a name="l00026"></a>00026 <span class="comment"> * \note RTP is defined in RFC 3550.</span>
<a name="l00027"></a>00027 <span class="comment"> */</span>
<a name="l00028"></a>00028 
<a name="l00029"></a>00029 <span class="preprocessor">#include &quot;<a class="code" href="asterisk_8h.html" title="Asterisk main include file. File version handling, generic pbx functions.">asterisk.h</a>&quot;</span>
<a name="l00030"></a>00030 
<a name="l00031"></a>00031 <a class="code" href="asterisk_8h.html#ab0390be60f8c539a2662df2faf9985c7" title="Register/unregister a source code file with the core.">ASTERISK_FILE_VERSION</a>(__FILE__, <span class="stringliteral">&quot;$Revision: 241721 $&quot;</span>)
<a name="l00032"></a>00032 
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
<a name="l00034"></a>00034 <span class="preprocessor"></span><span class="preprocessor">#include &lt;signal.h&gt;</span>
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;fcntl.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;math.h&gt;</span> 
<a name="l00037"></a>00037 
<a name="l00038"></a>00038 <span class="preprocessor">#include &quot;<a class="code" href="rtp_8h.html" title="Supports RTP and RTCP with Symmetric RTP support for NAT traversal.">asterisk/rtp.h</a>&quot;</span>
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="pbx_8h.html" title="Core PBX routines and definitions.">asterisk/pbx.h</a>&quot;</span>
<a name="l00040"></a>00040 <span class="preprocessor">#include &quot;<a class="code" href="frame_8h.html" title="Asterisk internal frame definitions.">asterisk/frame.h</a>&quot;</span>
<a name="l00041"></a>00041 <span class="preprocessor">#include &quot;<a class="code" href="channel_8h.html" title="General Asterisk PBX channel definitions.">asterisk/channel.h</a>&quot;</span>
<a name="l00042"></a>00042 <span class="preprocessor">#include &quot;<a class="code" href="acl_8h.html" title="Access Control of various sorts.">asterisk/acl.h</a>&quot;</span>
<a name="l00043"></a>00043 <span class="preprocessor">#include &quot;<a class="code" href="config_8h.html" title="Configuration File Parser.">asterisk/config.h</a>&quot;</span>
<a name="l00044"></a>00044 <span class="preprocessor">#include &quot;<a class="code" href="lock_8h.html" title="Asterisk locking-related definitions:ast_mutext_t, ast_rwlock_t and related functions;atomic...">asterisk/lock.h</a>&quot;</span>
<a name="l00045"></a>00045 <span class="preprocessor">#include &quot;<a class="code" href="utils_8h.html" title="Utility functions.">asterisk/utils.h</a>&quot;</span>
<a name="l00046"></a>00046 <span class="preprocessor">#include &quot;<a class="code" href="netsock_8h.html" title="Network socket handling.">asterisk/netsock.h</a>&quot;</span>
<a name="l00047"></a>00047 <span class="preprocessor">#include &quot;<a class="code" href="cli_8h.html" title="Standard Command Line Interface.">asterisk/cli.h</a>&quot;</span>
<a name="l00048"></a>00048 <span class="preprocessor">#include &quot;<a class="code" href="manager_8h.html" title="The AMI - Asterisk Manager Interface - is a TCP protocol created to manage Asterisk...">asterisk/manager.h</a>&quot;</span>
<a name="l00049"></a>00049 <span class="preprocessor">#include &quot;<a class="code" href="unaligned_8h.html" title="Handle unaligned data access.">asterisk/unaligned.h</a>&quot;</span>
<a name="l00050"></a>00050 
<a name="l00051"></a><a class="code" href="rtp_8c.html#a12a850150b82a6ce1077e204d4f5638c">00051</a> <span class="preprocessor">#define MAX_TIMESTAMP_SKEW 640</span>
<a name="l00052"></a>00052 <span class="preprocessor"></span>
<a name="l00053"></a><a class="code" href="rtp_8c.html#af3a188c3caa83026e351d58ef855424a">00053</a> <span class="preprocessor">#define RTP_SEQ_MOD     (1&lt;&lt;16)  </span><span class="comment">/*!&lt; A sequence number can&apos;t be more than 16 bits */</span>
<a name="l00054"></a><a class="code" href="rtp_8c.html#a3a8359edb63fbe2754be0314451ce8b3">00054</a> <span class="preprocessor">#define RTCP_DEFAULT_INTERVALMS   5000 </span><span class="comment">/*!&lt; Default milli-seconds between RTCP reports we send */</span>
<a name="l00055"></a><a class="code" href="rtp_8c.html#abc283785a565edd42110d25d9ade9080">00055</a> <span class="preprocessor">#define RTCP_MIN_INTERVALMS       500  </span><span class="comment">/*!&lt; Min milli-seconds between RTCP reports we send */</span>
<a name="l00056"></a><a class="code" href="rtp_8c.html#a40ff8a6874204fbbe6c375ae79d17b5e">00056</a> <span class="preprocessor">#define RTCP_MAX_INTERVALMS       60000   </span><span class="comment">/*!&lt; Max milli-seconds between RTCP reports we send */</span>
<a name="l00057"></a>00057 
<a name="l00058"></a><a class="code" href="rtp_8c.html#a38fce7504b6d0ac96b1f07fa86598ce8">00058</a> <span class="preprocessor">#define RTCP_PT_FUR     192</span>
<a name="l00059"></a><a class="code" href="rtp_8c.html#abe50a9d9c36c702889863e206f4502c6">00059</a> <span class="preprocessor"></span><span class="preprocessor">#define RTCP_PT_SR      200</span>
<a name="l00060"></a><a class="code" href="rtp_8c.html#a4d8564f9c96df1cd1076ad4f6faed7ab">00060</a> <span class="preprocessor"></span><span class="preprocessor">#define RTCP_PT_RR      201</span>
<a name="l00061"></a><a class="code" href="rtp_8c.html#aa6a84235b636497872f31a832a8b17af">00061</a> <span class="preprocessor"></span><span class="preprocessor">#define RTCP_PT_SDES    202</span>
<a name="l00062"></a><a class="code" href="rtp_8c.html#a5723708baf43b6326706331795fcd52f">00062</a> <span class="preprocessor"></span><span class="preprocessor">#define RTCP_PT_BYE     203</span>
<a name="l00063"></a><a class="code" href="rtp_8c.html#a9a6a8ff12e4ca01f1783dd6a8ab2e449">00063</a> <span class="preprocessor"></span><span class="preprocessor">#define RTCP_PT_APP     204</span>
<a name="l00064"></a>00064 <span class="preprocessor"></span>
<a name="l00065"></a><a class="code" href="rtp_8c.html#ad8037e984fd1fcc8777ec928d65b9ded">00065</a> <span class="preprocessor">#define RTP_MTU      1200</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span>
<a name="l00067"></a><a class="code" href="rtp_8c.html#a3d5f788ed405ca3ab6a778892570b2a2">00067</a> <span class="preprocessor">#define DEFAULT_DTMF_TIMEOUT (150 * (8000 / 1000)) </span><span class="comment">/*!&lt; samples */</span>
<a name="l00068"></a>00068 
<a name="l00069"></a><a class="code" href="rtp_8c.html#aead922624018c01780f0f060df89e6a7">00069</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#aead922624018c01780f0f060df89e6a7">dtmftimeout</a> = <a class="code" href="rtp_8c.html#a3d5f788ed405ca3ab6a778892570b2a2">DEFAULT_DTMF_TIMEOUT</a>;
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="rtp_8c.html#aa3d9ba5adbb6566211600f0ab4a027c7">00071</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#aa3d9ba5adbb6566211600f0ab4a027c7">rtpstart</a> = 5000;     <span class="comment">/*!&lt; First port for RTP sessions (set in rtp.conf) */</span>
<a name="l00072"></a><a class="code" href="rtp_8c.html#a4b0895b04a97fb8d38e0f15dfed4c9e0">00072</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a4b0895b04a97fb8d38e0f15dfed4c9e0">rtpend</a> = 31000;      <span class="comment">/*!&lt; Last port for RTP sessions (set in rtp.conf) */</span>
<a name="l00073"></a><a class="code" href="rtp_8c.html#a147859009ddb300c602e8e9ca3c85983">00073</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a147859009ddb300c602e8e9ca3c85983">rtpdebug</a>;       <span class="comment">/*!&lt; Are we debugging? */</span>
<a name="l00074"></a><a class="code" href="rtp_8c.html#a98b686456fe95fe15497ea37b4eb7198">00074</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a98b686456fe95fe15497ea37b4eb7198">rtcpdebug</a>;         <span class="comment">/*!&lt; Are we debugging RTCP? */</span>
<a name="l00075"></a><a class="code" href="rtp_8c.html#af31fe34042d18a4597e04781f84f0e3c">00075</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#af31fe34042d18a4597e04781f84f0e3c">rtcpstats</a>;         <span class="comment">/*!&lt; Are we debugging RTCP? */</span>
<a name="l00076"></a><a class="code" href="rtp_8c.html#a9426365d90a1b664b096a41d3a099a9f">00076</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a9426365d90a1b664b096a41d3a099a9f">rtcpinterval</a> = <a class="code" href="rtp_8c.html#a3a8359edb63fbe2754be0314451ce8b3">RTCP_DEFAULT_INTERVALMS</a>; <span class="comment">/*!&lt; Time between rtcp reports in millisecs */</span>
<a name="l00077"></a><a class="code" href="rtp_8c.html#a2e497785a2f0681dbebf11c6d83e948f">00077</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a2e497785a2f0681dbebf11c6d83e948f">stundebug</a>;         <span class="comment">/*!&lt; Are we debugging stun? */</span>
<a name="l00078"></a><a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">00078</a> <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in <a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>;   <span class="comment">/*!&lt; Debug packets to/from this host */</span>
<a name="l00079"></a><a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">00079</a> <span class="keyword">static</span> <span class="keyword">struct </span>sockaddr_in <a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>;  <span class="comment">/*!&lt; Debug RTCP packets to/from this host */</span>
<a name="l00080"></a>00080 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> nochecksums;
<a name="l00082"></a>00082 <span class="preprocessor">#endif</span>
<a name="l00083"></a><a class="code" href="rtp_8c.html#a96336b3ac9e5b66f365f0ca5ba613995">00083</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a96336b3ac9e5b66f365f0ca5ba613995">strictrtp</a>;
<a name="l00084"></a>00084 
<a name="l00085"></a><a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4b">00085</a> <span class="keyword">enum</span> <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4b">strict_rtp_state</a> {
<a name="l00086"></a><a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4bab82bff21db6795dfa152e316f6ae6bc1">00086</a>    <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4bab82bff21db6795dfa152e316f6ae6bc1">STRICT_RTP_OPEN</a> = 0, <span class="comment">/*! No RTP packets should be dropped, all sources accepted */</span>
<a name="l00087"></a><a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4ba0c26c1144bb830775979deb20e049368">00087</a>    <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4ba0c26c1144bb830775979deb20e049368">STRICT_RTP_LEARN</a>,    <span class="comment">/*! Accept next packet as source */</span>
<a name="l00088"></a><a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4baff585ea9a2059021ce5a5f4a7ed8895f">00088</a>    <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4baff585ea9a2059021ce5a5f4a7ed8895f">STRICT_RTP_CLOSED</a>,   <span class="comment">/*! Drop all RTP packets not coming from source that was learned */</span>
<a name="l00089"></a>00089 };
<a name="l00090"></a>00090 
<a name="l00091"></a>00091 <span class="comment">/* Uncomment this to enable more intense native bridging, but note: this is currently buggy */</span>
<a name="l00092"></a>00092 <span class="comment">/* #define P2P_INTENSE */</span>
<a name="l00093"></a>00093 <span class="comment"></span>
<a name="l00094"></a>00094 <span class="comment">/*!</span>
<a name="l00095"></a>00095 <span class="comment"> * \brief Structure representing a RTP session.</span>
<a name="l00096"></a>00096 <span class="comment"> *</span>
<a name="l00097"></a>00097 <span class="comment"> * RTP session is defined on page 9 of RFC 3550: &quot;An association among a set of participants communicating with RTP.  A participant may be involved in multiple RTP sessions at the same time [...]&quot;</span>
<a name="l00098"></a>00098 <span class="comment"> *</span>
<a name="l00099"></a>00099 <span class="comment"> */</span>
<a name="l00100"></a>00100 <span class="comment"></span>
<a name="l00101"></a>00101 <span class="comment">/*! \brief RTP session description */</span>
<a name="l00102"></a><a class="code" href="structast__rtp.html">00102</a> <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> {
<a name="l00103"></a><a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">00103</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>;
<a name="l00104"></a><a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">00104</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>;
<a name="l00105"></a><a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">00105</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a>[8192 + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>];
<a name="l00106"></a><a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">00106</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>;      <span class="comment">/*!&lt; Synchronization source, RFC 3550, page 10. */</span>
<a name="l00107"></a><a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">00107</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>;     <span class="comment">/*!&lt; Their SSRC */</span>
<a name="l00108"></a><a class="code" href="structast__rtp.html#a943da98a0ca2d0342765831c6c3d5f3f">00108</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a943da98a0ca2d0342765831c6c3d5f3f">rxssrc</a>;
<a name="l00109"></a><a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">00109</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>;
<a name="l00110"></a><a class="code" href="structast__rtp.html#ab4b9ba00bb47d86340c9c150f17d7c69">00110</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ab4b9ba00bb47d86340c9c150f17d7c69">lastrxts</a>;
<a name="l00111"></a><a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">00111</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">lastividtimestamp</a>;
<a name="l00112"></a><a class="code" href="structast__rtp.html#a9a2293b0120398a3a10aed1a98a5ea59">00112</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a9a2293b0120398a3a10aed1a98a5ea59">lastovidtimestamp</a>;
<a name="l00113"></a><a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">00113</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">lastitexttimestamp</a>;
<a name="l00114"></a><a class="code" href="structast__rtp.html#abf1f99fdbacb09d2077fdc250bccc269">00114</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#abf1f99fdbacb09d2077fdc250bccc269">lastotexttimestamp</a>;
<a name="l00115"></a><a class="code" href="structast__rtp.html#a4ffa1ce6767ea0893237a918ac1aa251">00115</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a4ffa1ce6767ea0893237a918ac1aa251">lasteventseqn</a>;
<a name="l00116"></a><a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">00116</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a>;                <span class="comment">/*!&lt; Last received sequence number */</span>
<a name="l00117"></a><a class="code" href="structast__rtp.html#a39b8d9a63bb7be44fbb707bb23721092">00117</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structast__rtp.html#a39b8d9a63bb7be44fbb707bb23721092">seedrxseqno</a>;     <span class="comment">/*!&lt; What sequence number did they start with?*/</span>
<a name="l00118"></a><a class="code" href="structast__rtp.html#aa9d357f51d7983d9a150c8c433306f7c">00118</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#aa9d357f51d7983d9a150c8c433306f7c">seedrxts</a>;          <span class="comment">/*!&lt; What RTP timestamp did they start with? */</span>
<a name="l00119"></a><a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">00119</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;           <span class="comment">/*!&lt; How many packets have we received? */</span>
<a name="l00120"></a><a class="code" href="structast__rtp.html#a6755911cdc9335fc23089602dbbcd048">00120</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a6755911cdc9335fc23089602dbbcd048">rxoctetcount</a>;      <span class="comment">/*!&lt; How many octets have we received? should be rxcount *160*/</span>
<a name="l00121"></a><a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">00121</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>;           <span class="comment">/*!&lt; How many packets have we sent? */</span>
<a name="l00122"></a><a class="code" href="structast__rtp.html#aed963fd645cea41f8f9a7dd144810204">00122</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#aed963fd645cea41f8f9a7dd144810204">txoctetcount</a>;      <span class="comment">/*!&lt; How many octets have we sent? (txcount*160)*/</span>
<a name="l00123"></a><a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">00123</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a>;            <span class="comment">/*!&lt; Shifted count of sequence number cycles */</span>
<a name="l00124"></a><a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">00124</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>;                <span class="comment">/*!&lt; Interarrival jitter at the moment */</span>
<a name="l00125"></a><a class="code" href="structast__rtp.html#a03de90eeef260174916d063af8db743b">00125</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtp.html#a03de90eeef260174916d063af8db743b">rxtransit</a>;               <span class="comment">/*!&lt; Relative transit time for previous packet */</span>
<a name="l00126"></a><a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">00126</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a>;
<a name="l00127"></a><a class="code" href="structast__rtp.html#ac39112ee85d1c736329776a40537daf9">00127</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ac39112ee85d1c736329776a40537daf9">lastrxformat</a>;
<a name="l00128"></a>00128 
<a name="l00129"></a><a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">00129</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a>;         <span class="comment">/*!&lt; RTP timeout time (negative or zero means disabled, negative value means temporarily disabled) */</span>
<a name="l00130"></a><a class="code" href="structast__rtp.html#a9c8c363bb6d84360b92945bb18bb0451">00130</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a9c8c363bb6d84360b92945bb18bb0451">rtpholdtimeout</a>;     <span class="comment">/*!&lt; RTP timeout when on hold (negative or zero means disabled, negative value means temporarily disabled). */</span>
<a name="l00131"></a><a class="code" href="structast__rtp.html#a9472cfc2a7a21f124c161f7baaf9d5dc">00131</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a9472cfc2a7a21f124c161f7baaf9d5dc">rtpkeepalive</a>;    <span class="comment">/*!&lt; Send RTP comfort noice packets for keepalive */</span>
<a name="l00132"></a>00132 
<a name="l00133"></a>00133    <span class="comment">/* DTMF Reception Variables */</span>
<a name="l00134"></a><a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">00134</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>;
<a name="l00135"></a><a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">00135</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a>;
<a name="l00136"></a><a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">00136</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a>;     <span class="comment">/*!&lt; Total duration in samples since the digit start event */</span>
<a name="l00137"></a><a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">00137</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a>;      <span class="comment">/*!&lt; When this timestamp is reached we consider END frame lost and forcibly abort digit */</span>
<a name="l00138"></a><a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">00138</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a>;
<a name="l00139"></a>00139    <span class="comment">/* DTMF Transmission Variables */</span>
<a name="l00140"></a><a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">00140</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>;
<a name="l00141"></a><a class="code" href="structast__rtp.html#af637078f896cfd75467174c20d0cb217">00141</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtp.html#af637078f896cfd75467174c20d0cb217">sending_digit</a>;  <span class="comment">/*!&lt; boolean - are we sending digits */</span>
<a name="l00142"></a><a class="code" href="structast__rtp.html#a0ed4b8b544ecc0632341499d5a8f199e">00142</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtp.html#a0ed4b8b544ecc0632341499d5a8f199e">send_digit</a>;  <span class="comment">/*!&lt; digit we are sending */</span>
<a name="l00143"></a><a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">00143</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a>;
<a name="l00144"></a><a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">00144</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a>;
<a name="l00145"></a><a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">00145</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a>;
<a name="l00146"></a><a class="code" href="structast__rtp.html#ac92588540e8c1d014a08cd8a45462b19">00146</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l00147"></a><a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">00147</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>;     <span class="comment">/*!&lt; Socket representation of the local endpoint. */</span>
<a name="l00148"></a><a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">00148</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>;   <span class="comment">/*!&lt; Socket representation of the remote endpoint. */</span>
<a name="l00149"></a><a class="code" href="structast__rtp.html#a567178215831a573c88f6370305a2997">00149</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtp.html#a567178215831a573c88f6370305a2997">altthem</a>;   <span class="comment">/*!&lt; Alternate source of remote media */</span>
<a name="l00150"></a><a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">00150</a>    <span class="keyword">struct </span>timeval <a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>;
<a name="l00151"></a><a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">00151</a>    <span class="keyword">struct </span>timeval <a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>;
<a name="l00152"></a><a class="code" href="structast__rtp.html#aa0016ad6315851ed2b2f45f38b72d4e2">00152</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtp.html#aa0016ad6315851ed2b2f45f38b72d4e2">drxcore</a>;                 <span class="comment">/*!&lt; The double representation of the first received packet */</span>
<a name="l00153"></a><a class="code" href="structast__rtp.html#ac2c44e1c22933cc8ca85bccc4a8c361d">00153</a>    <span class="keyword">struct </span>timeval <a class="code" href="structast__rtp.html#ac2c44e1c22933cc8ca85bccc4a8c361d">lastrx</a>;          <span class="comment">/*!&lt; timeval when we last received a packet */</span>
<a name="l00154"></a><a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">00154</a>    <span class="keyword">struct </span>timeval <a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a>;
<a name="l00155"></a><a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">00155</a>    <span class="keyword">struct </span><a class="code" href="structast__smoother.html">ast_smoother</a> *<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>;
<a name="l00156"></a><a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">00156</a>    <span class="keywordtype">int</span> *<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a>;
<a name="l00157"></a><a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">00157</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>;      <span class="comment">/*!&lt; Sequence number, RFC 3550, page 13. */</span>
<a name="l00158"></a><a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">00158</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">rxseqno</a>;
<a name="l00159"></a><a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">00159</a>    <span class="keyword">struct </span><a class="code" href="structsched__context.html">sched_context</a> *<a class="code" href="structsched.html">sched</a>;
<a name="l00160"></a><a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">00160</a>    <span class="keyword">struct </span><a class="code" href="structio__context.html" title="Global IO variables are now in a struct in order to be made threadsafe.">io_context</a> *<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>;
<a name="l00161"></a><a class="code" href="structast__rtp.html#a735984d41155bc1032e09bece8f8d66d">00161</a>    <span class="keywordtype">void</span> *<a class="code" href="structast__rtp.html#a735984d41155bc1032e09bece8f8d66d">data</a>;
<a name="l00162"></a><a class="code" href="structast__rtp.html#ac7c7a9968aa83f15b39dfe8fd533fd34">00162</a>    <a class="code" href="rtp_8h.html#a8d640c81e33ce90c44ae443dbd9f38cb">ast_rtp_callback</a> <a class="code" href="structast__rtp.html#ac7c7a9968aa83f15b39dfe8fd533fd34">callback</a>;
<a name="l00163"></a>00163 <span class="preprocessor">#ifdef P2P_INTENSE</span>
<a name="l00164"></a>00164 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#a2d9118a2a8939f115eea771bce3a52f2">ast_mutex_t</a> bridge_lock;
<a name="l00165"></a>00165 <span class="preprocessor">#endif</span>
<a name="l00166"></a><a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">00166</a> <span class="preprocessor"></span>   <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> <a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[<a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>];
<a name="l00167"></a><a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">00167</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a>; <span class="comment">/*!&lt; a cache for the result of rtp_lookup_code(): */</span>
<a name="l00168"></a><a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">00168</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a>;
<a name="l00169"></a><a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">00169</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a>;
<a name="l00170"></a><a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">00170</a>    <span class="keyword">struct </span><a class="code" href="structast__rtcp.html" title="Structure defining an RTCP session.">ast_rtcp</a> *<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>;
<a name="l00171"></a><a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">00171</a>    <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> <a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a>;
<a name="l00172"></a><a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">00172</a>    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">bridged</a>;        <span class="comment">/*!&lt; Who we are Packet bridged to */</span>
<a name="l00173"></a>00173 
<a name="l00174"></a><a class="code" href="structast__rtp.html#a64730d554c32f13303a5a19f39cbd826">00174</a>    <span class="keyword">enum</span> <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4b">strict_rtp_state</a> <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4b">strict_rtp_state</a>; <span class="comment">/*!&lt; Current state that strict RTP protection is in */</span>
<a name="l00175"></a><a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">00175</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>;  <span class="comment">/*!&lt; Remote address information for strict RTP purposes */</span>
<a name="l00176"></a>00176 
<a name="l00177"></a><a class="code" href="structast__rtp.html#a1089b0c7f83ef826379989c20a11fd4b">00177</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a1089b0c7f83ef826379989c20a11fd4b">set_marker_bit</a>:1;           <span class="comment">/*!&lt; Whether to set the marker bit or not */</span>
<a name="l00178"></a><a class="code" href="structast__rtp.html#a06f00722236fa7f3e3f695e26a37179b">00178</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#a06f00722236fa7f3e3f695e26a37179b">constantssrc</a>:1;
<a name="l00179"></a><a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">00179</a>    <span class="keyword">struct </span><a class="code" href="structrtp__red.html">rtp_red</a> *<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>;
<a name="l00180"></a>00180 };
<a name="l00181"></a>00181 
<a name="l00182"></a>00182 <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8c.html#ae290f54e950a7b43fc6252366758745c" title="Construct a redundant frame.">red_t140_to_red</a>(<span class="keyword">struct</span> <a class="code" href="structrtp__red.html">rtp_red</a> *red);
<a name="l00183"></a>00183 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#af8fe2466849c65c9d60466c769ea5f2d" title="Write t140 redundacy frame.">red_write</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>);
<a name="l00184"></a>00184  
<a name="l00185"></a><a class="code" href="structrtp__red.html">00185</a> <span class="keyword">struct </span><a class="code" href="structrtp__red.html">rtp_red</a> {
<a name="l00186"></a><a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">00186</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>;  <span class="comment">/*!&lt; Primary data  */</span>
<a name="l00187"></a><a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">00187</a>    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> <a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a>;   <span class="comment">/*!&lt; Redundant t140*/</span>
<a name="l00188"></a><a class="code" href="structrtp__red.html#adc4566d7080c1656aefc4560df8f6093">00188</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structrtp__red.html#adc4566d7080c1656aefc4560df8f6093">pt</a>[<a class="code" href="rtp_8h.html#af72998d88fc2e3a7b7225e6d5bd37e30">RED_MAX_GENERATION</a>];  <span class="comment">/*!&lt; Payload types for redundancy data */</span>
<a name="l00189"></a><a class="code" href="structrtp__red.html#a843295b09905ce50cee094c29a8bc7c4">00189</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structrtp__red.html#a843295b09905ce50cee094c29a8bc7c4">ts</a>[<a class="code" href="rtp_8h.html#af72998d88fc2e3a7b7225e6d5bd37e30">RED_MAX_GENERATION</a>]; <span class="comment">/*!&lt; Time stamps */</span>
<a name="l00190"></a><a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">00190</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[<a class="code" href="rtp_8h.html#af72998d88fc2e3a7b7225e6d5bd37e30">RED_MAX_GENERATION</a>]; <span class="comment">/*!&lt; length of each generation */</span>
<a name="l00191"></a><a class="code" href="structrtp__red.html#a616e41679f381ce34cf536b20e24011a">00191</a>    <span class="keywordtype">int</span> <a class="code" href="structrtp__red.html#a616e41679f381ce34cf536b20e24011a">num_gen</a>; <span class="comment">/*!&lt; Number of generations */</span>
<a name="l00192"></a><a class="code" href="structrtp__red.html#a1083e2d34bb1a32645f4681a7ee78b41">00192</a>    <span class="keywordtype">int</span> <a class="code" href="structrtp__red.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>; <span class="comment">/*!&lt; Timer id */</span>
<a name="l00193"></a><a class="code" href="structrtp__red.html#ab15c864bf1bd92d2931e58603cfa7898">00193</a>    <span class="keywordtype">int</span> <a class="code" href="structrtp__red.html#ab15c864bf1bd92d2931e58603cfa7898">ti</a>; <span class="comment">/*!&lt; How long to buffer data before send */</span>
<a name="l00194"></a><a class="code" href="structrtp__red.html#a13f1cf445ea8c204653722d23fc867b2">00194</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structrtp__red.html#a13f1cf445ea8c204653722d23fc867b2">t140red_data</a>[64000];  
<a name="l00195"></a><a class="code" href="structrtp__red.html#a7f4fdeaff8e8d4e34a0f75b9863a69e0">00195</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structrtp__red.html#a7f4fdeaff8e8d4e34a0f75b9863a69e0">buf_data</a>[64000]; <span class="comment">/*!&lt; buffered primary data */</span>
<a name="l00196"></a><a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">00196</a>    <span class="keywordtype">int</span> <a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">hdrlen</a>; 
<a name="l00197"></a><a class="code" href="structrtp__red.html#ab142ba70d4b23b2c1f230a1f7e7d833a">00197</a>    <span class="keywordtype">long</span> <span class="keywordtype">int</span> <a class="code" href="structrtp__red.html#ab142ba70d4b23b2c1f230a1f7e7d833a">prev_ts</a>;
<a name="l00198"></a>00198 };
<a name="l00199"></a>00199 
<a name="l00200"></a>00200 <span class="comment">/* Forward declarations */</span>
<a name="l00201"></a>00201 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#aff89c2855ec73ffa6efdc958bb71c2e8" title="Write and RTCP packet to the far end.">ast_rtcp_write</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>);
<a name="l00202"></a>00202 <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#ae07b5d23a23d4d09988c4a1c5d477d14">timeval2ntp</a>(<span class="keyword">struct</span> timeval tv, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *msw, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *lsw);
<a name="l00203"></a>00203 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#af9fe82760c62b9bfe98044b3e53acef5" title="Send RTCP sender&amp;#39;s report.">ast_rtcp_write_sr</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>);
<a name="l00204"></a>00204 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#ab76376f8b65ba8f04a89699200b02e42" title="Send RTCP recipient&amp;#39;s report.">ast_rtcp_write_rr</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>);
<a name="l00205"></a>00205 <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#ae8c264c840c8c9b4e8ca062746000506">ast_rtcp_calc_interval</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp);
<a name="l00206"></a>00206 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#acfdeaf8e752856ad7b49174eee6e9fea" title="Send continuation frame for DTMF.">ast_rtp_senddigit_continuation</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp);
<a name="l00207"></a>00207 <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a75bc4adaf04f7e5348fc73608c3b1ebc" title="Send end packets for DTMF.">ast_rtp_senddigit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">char</span> digit);
<a name="l00208"></a>00208 
<a name="l00209"></a><a class="code" href="rtp_8c.html#a1b696f676e4e78260e3356973f647034">00209</a> <span class="preprocessor">#define FLAG_3389_WARNING     (1 &lt;&lt; 0)</span>
<a name="l00210"></a><a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">00210</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_NAT_ACTIVE       (3 &lt;&lt; 1)</span>
<a name="l00211"></a><a class="code" href="rtp_8c.html#a7ea8f10bd8b1fab6990526c3271a7b59">00211</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_NAT_INACTIVE     (0 &lt;&lt; 1)</span>
<a name="l00212"></a><a class="code" href="rtp_8c.html#ad2adc4c49cf65121c15dc838f43c6cb0">00212</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_NAT_INACTIVE_NOWARN (1 &lt;&lt; 1)</span>
<a name="l00213"></a><a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">00213</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_HAS_DTMF         (1 &lt;&lt; 3)</span>
<a name="l00214"></a><a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">00214</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_P2P_SENT_MARK              (1 &lt;&lt; 4)</span>
<a name="l00215"></a><a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">00215</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_P2P_NEED_DTMF              (1 &lt;&lt; 5)</span>
<a name="l00216"></a><a class="code" href="rtp_8c.html#ae8197382d4f12048520dcba52cd1461c">00216</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_CALLBACK_MODE              (1 &lt;&lt; 6)</span>
<a name="l00217"></a><a class="code" href="rtp_8c.html#a512509bde2176b98fbdcbceb1a528f6d">00217</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_DTMF_COMPENSATE            (1 &lt;&lt; 7)</span>
<a name="l00218"></a><a class="code" href="rtp_8c.html#a126661ec52d7d5caab56e2fbfd511d65">00218</a> <span class="preprocessor"></span><span class="preprocessor">#define FLAG_HAS_STUN                   (1 &lt;&lt; 8)</span>
<a name="l00219"></a>00219 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00220"></a>00220 <span class="comment">/*!</span>
<a name="l00221"></a>00221 <span class="comment"> * \brief Structure defining an RTCP session.</span>
<a name="l00222"></a>00222 <span class="comment"> * </span>
<a name="l00223"></a>00223 <span class="comment"> * The concept &quot;RTCP session&quot; is not defined in RFC 3550, but since </span>
<a name="l00224"></a>00224 <span class="comment"> * this structure is analogous to ast_rtp, which tracks a RTP session, </span>
<a name="l00225"></a>00225 <span class="comment"> * it is logical to think of this as a RTCP session.</span>
<a name="l00226"></a>00226 <span class="comment"> *</span>
<a name="l00227"></a>00227 <span class="comment"> * RTCP packet is defined on page 9 of RFC 3550.</span>
<a name="l00228"></a>00228 <span class="comment"> * </span>
<a name="l00229"></a>00229 <span class="comment"> */</span>
<a name="l00230"></a><a class="code" href="structast__rtcp.html">00230</a> <span class="keyword">struct </span><a class="code" href="structast__rtcp.html" title="Structure defining an RTCP session.">ast_rtcp</a> {
<a name="l00231"></a><a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">00231</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">rtcp_info</a>;
<a name="l00232"></a><a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">00232</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>;            <span class="comment">/*!&lt; Socket */</span>
<a name="l00233"></a><a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">00233</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>;     <span class="comment">/*!&lt; Socket representation of the local endpoint. */</span>
<a name="l00234"></a><a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">00234</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>;   <span class="comment">/*!&lt; Socket representation of the remote endpoint. */</span>
<a name="l00235"></a><a class="code" href="structast__rtcp.html#a567178215831a573c88f6370305a2997">00235</a>    <span class="keyword">struct </span>sockaddr_in <a class="code" href="structast__rtcp.html#a567178215831a573c88f6370305a2997">altthem</a>;   <span class="comment">/*!&lt; Alternate source for RTCP */</span>
<a name="l00236"></a><a class="code" href="structast__rtcp.html#a5559c53d2e48d42237cc342fff7dab72">00236</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a5559c53d2e48d42237cc342fff7dab72">soc</a>;    <span class="comment">/*!&lt; What they told us */</span>
<a name="l00237"></a><a class="code" href="structast__rtcp.html#a959172bce678fc4a84719bd16af5ae2b">00237</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a959172bce678fc4a84719bd16af5ae2b">spc</a>;    <span class="comment">/*!&lt; What they told us */</span>
<a name="l00238"></a><a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">00238</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a>;    <span class="comment">/*!&lt; The middle 32 bits of the NTP timestamp in the last received SR*/</span>
<a name="l00239"></a><a class="code" href="structast__rtcp.html#ad96a304ae7c0f3dd877c1db41a5a668e">00239</a>    <span class="keyword">struct </span>timeval <a class="code" href="structast__rtcp.html#ad96a304ae7c0f3dd877c1db41a5a668e">rxlsr</a>;      <span class="comment">/*!&lt; Time when we got their last SR */</span>
<a name="l00240"></a><a class="code" href="structast__rtcp.html#a9256f90f81a2d68ecff5d80919d62f1f">00240</a>    <span class="keyword">struct </span>timeval <a class="code" href="structast__rtcp.html#a9256f90f81a2d68ecff5d80919d62f1f">txlsr</a>;      <span class="comment">/*!&lt; Time when we sent or last SR*/</span>
<a name="l00241"></a><a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">00241</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a>;  <span class="comment">/*!&lt; no. packets in previous interval */</span>
<a name="l00242"></a><a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">00242</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>;  <span class="comment">/*!&lt; no. packets received in previous interval */</span>
<a name="l00243"></a><a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">00243</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>;         <span class="comment">/*!&lt; Schedid returned from ast_sched_add() to schedule RTCP-transmissions*/</span>
<a name="l00244"></a><a class="code" href="structast__rtcp.html#abfdd17fa9ca6b018fea2fe58c5738712">00244</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#abfdd17fa9ca6b018fea2fe58c5738712">rr_count</a>;     <span class="comment">/*!&lt; number of RRs we&apos;ve sent, not including report blocks in SR&apos;s */</span>
<a name="l00245"></a><a class="code" href="structast__rtcp.html#a2fd3216670496c31020fd37341c0b8fd">00245</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a2fd3216670496c31020fd37341c0b8fd">sr_count</a>;     <span class="comment">/*!&lt; number of SRs we&apos;ve sent */</span>
<a name="l00246"></a><a class="code" href="structast__rtcp.html#a57d4e77faf4a4a7994bb396945c5e0c2">00246</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a57d4e77faf4a4a7994bb396945c5e0c2">lastsrtxcount</a>;     <span class="comment">/*!&lt; Transmit packet count when last SR sent */</span>
<a name="l00247"></a><a class="code" href="structast__rtcp.html#a8e759d4e39d3d6531987a55158af3c40">00247</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a8e759d4e39d3d6531987a55158af3c40">accumulated_transit</a>;   <span class="comment">/*!&lt; accumulated a-dlsr-lsr */</span>
<a name="l00248"></a><a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">00248</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a>;       <span class="comment">/*!&lt; Last reported rtt */</span>
<a name="l00249"></a><a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">00249</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a>; <span class="comment">/*!&lt; The contents of their last jitter entry in the RR */</span>
<a name="l00250"></a><a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">00250</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>;   <span class="comment">/*!&lt; Reported lost packets in their RR */</span>
<a name="l00251"></a><a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">00251</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">quality</a>[<a class="code" href="cdr_8h.html#ada78f1b5f7ec61480c433280f4dfd0a4">AST_MAX_USER_FIELD</a>];
<a name="l00252"></a><a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">00252</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">quality_jitter</a>[<a class="code" href="cdr_8h.html#ada78f1b5f7ec61480c433280f4dfd0a4">AST_MAX_USER_FIELD</a>];
<a name="l00253"></a><a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">00253</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">quality_loss</a>[<a class="code" href="cdr_8h.html#ada78f1b5f7ec61480c433280f4dfd0a4">AST_MAX_USER_FIELD</a>];
<a name="l00254"></a><a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">00254</a>    <span class="keywordtype">char</span> <a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">quality_rtt</a>[<a class="code" href="cdr_8h.html#ada78f1b5f7ec61480c433280f4dfd0a4">AST_MAX_USER_FIELD</a>];
<a name="l00255"></a>00255 
<a name="l00256"></a><a class="code" href="structast__rtcp.html#a30d52d11d41c2eb613686f33a5decc9c">00256</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a30d52d11d41c2eb613686f33a5decc9c">reported_maxjitter</a>;
<a name="l00257"></a><a class="code" href="structast__rtcp.html#ace87dcab8278d048a1aec3c529aae3e8">00257</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#ace87dcab8278d048a1aec3c529aae3e8">reported_minjitter</a>;
<a name="l00258"></a><a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">00258</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">reported_normdev_jitter</a>;
<a name="l00259"></a><a class="code" href="structast__rtcp.html#a752c1c70fc3a23f882d1c59da8dde021">00259</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a752c1c70fc3a23f882d1c59da8dde021">reported_stdev_jitter</a>;
<a name="l00260"></a><a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">00260</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a>;
<a name="l00261"></a>00261 
<a name="l00262"></a><a class="code" href="structast__rtcp.html#abbf709761c24a05feba0f0dc2ee23b31">00262</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#abbf709761c24a05feba0f0dc2ee23b31">reported_maxlost</a>;
<a name="l00263"></a><a class="code" href="structast__rtcp.html#a336c76200bd6e5390ae94cc780e602b6">00263</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a336c76200bd6e5390ae94cc780e602b6">reported_minlost</a>;
<a name="l00264"></a><a class="code" href="structast__rtcp.html#a326f467bbb9a1439c7c2295e7965a9b1">00264</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a326f467bbb9a1439c7c2295e7965a9b1">reported_normdev_lost</a>;
<a name="l00265"></a><a class="code" href="structast__rtcp.html#a90913f9d1e572535345617ac4d9ae2a4">00265</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a90913f9d1e572535345617ac4d9ae2a4">reported_stdev_lost</a>;
<a name="l00266"></a>00266 
<a name="l00267"></a><a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">00267</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>;
<a name="l00268"></a><a class="code" href="structast__rtcp.html#a156d5626391bfdfe33ff9ae0dd400ab0">00268</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a156d5626391bfdfe33ff9ae0dd400ab0">maxrxlost</a>;
<a name="l00269"></a><a class="code" href="structast__rtcp.html#ad247636bc55f7b98c145f64c6a0e89fc">00269</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#ad247636bc55f7b98c145f64c6a0e89fc">minrxlost</a>;
<a name="l00270"></a><a class="code" href="structast__rtcp.html#aa37952d4fb2366b7301fbb9066351eb1">00270</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#aa37952d4fb2366b7301fbb9066351eb1">normdev_rxlost</a>;
<a name="l00271"></a><a class="code" href="structast__rtcp.html#afb902f4eaea30d57054a372e3bda4082">00271</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#afb902f4eaea30d57054a372e3bda4082">stdev_rxlost</a>;
<a name="l00272"></a><a class="code" href="structast__rtcp.html#abc391f094db19cec2988652fa901aef9">00272</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#abc391f094db19cec2988652fa901aef9">rxlost_count</a>;
<a name="l00273"></a>00273 
<a name="l00274"></a><a class="code" href="structast__rtcp.html#ab23a4f4246d6a5d538cd97104db12ab2">00274</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#ab23a4f4246d6a5d538cd97104db12ab2">maxrxjitter</a>;
<a name="l00275"></a><a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">00275</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">minrxjitter</a>;
<a name="l00276"></a><a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">00276</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">normdev_rxjitter</a>;
<a name="l00277"></a><a class="code" href="structast__rtcp.html#ac18eba100dbfe48f0f6d0377cf8c76c1">00277</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#ac18eba100dbfe48f0f6d0377cf8c76c1">stdev_rxjitter</a>;
<a name="l00278"></a><a class="code" href="structast__rtcp.html#a9c2d8b256c256eff415ef34d51c09b47">00278</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a9c2d8b256c256eff415ef34d51c09b47">rxjitter_count</a>;
<a name="l00279"></a><a class="code" href="structast__rtcp.html#ad9e0112e5a3834937c4f84604c175ba6">00279</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#ad9e0112e5a3834937c4f84604c175ba6">maxrtt</a>;
<a name="l00280"></a><a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">00280</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">minrtt</a>;
<a name="l00281"></a><a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">00281</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">normdevrtt</a>;
<a name="l00282"></a><a class="code" href="structast__rtcp.html#a484c5279646a0804e4beba6b3f0828c9">00282</a>    <span class="keywordtype">double</span> <a class="code" href="structast__rtcp.html#a484c5279646a0804e4beba6b3f0828c9">stdevrtt</a>;
<a name="l00283"></a><a class="code" href="structast__rtcp.html#ab11c205b744d7793062ac51aea74b122">00283</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#ab11c205b744d7793062ac51aea74b122">rtt_count</a>;
<a name="l00284"></a><a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">00284</a>    <span class="keywordtype">int</span> <a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">sendfur</a>;
<a name="l00285"></a>00285 };
<a name="l00286"></a>00286 <span class="comment"></span>
<a name="l00287"></a>00287 <span class="comment">/*!</span>
<a name="l00288"></a>00288 <span class="comment"> * \brief STUN support code</span>
<a name="l00289"></a>00289 <span class="comment"> *</span>
<a name="l00290"></a>00290 <span class="comment"> * This code provides some support for doing STUN transactions.</span>
<a name="l00291"></a>00291 <span class="comment"> * Eventually it should be moved elsewhere as other protocols</span>
<a name="l00292"></a>00292 <span class="comment"> * than RTP can benefit from it - e.g. SIP.</span>
<a name="l00293"></a>00293 <span class="comment"> * STUN is described in RFC3489 and it is based on the exchange</span>
<a name="l00294"></a>00294 <span class="comment"> * of UDP packets between a client and one or more servers to</span>
<a name="l00295"></a>00295 <span class="comment"> * determine the externally visible address (and port) of the client</span>
<a name="l00296"></a>00296 <span class="comment"> * once it has gone through the NAT boxes that connect it to the</span>
<a name="l00297"></a>00297 <span class="comment"> * outside.</span>
<a name="l00298"></a>00298 <span class="comment"> * The simplest request packet is just the header defined in</span>
<a name="l00299"></a>00299 <span class="comment"> * struct stun_header, and from the response we may just look at</span>
<a name="l00300"></a>00300 <span class="comment"> * one attribute, STUN_MAPPED_ADDRESS, that we find in the response.</span>
<a name="l00301"></a>00301 <span class="comment"> * By doing more transactions with different server addresses we</span>
<a name="l00302"></a>00302 <span class="comment"> * may determine more about the behaviour of the NAT boxes, of</span>
<a name="l00303"></a>00303 <span class="comment"> * course - the details are in the RFC.</span>
<a name="l00304"></a>00304 <span class="comment"> *</span>
<a name="l00305"></a>00305 <span class="comment"> * All STUN packets start with a simple header made of a type,</span>
<a name="l00306"></a>00306 <span class="comment"> * length (excluding the header) and a 16-byte random transaction id.</span>
<a name="l00307"></a>00307 <span class="comment"> * Following the header we may have zero or more attributes, each</span>
<a name="l00308"></a>00308 <span class="comment"> * structured as a type, length and a value (whose format depends</span>
<a name="l00309"></a>00309 <span class="comment"> * on the type, but often contains addresses).</span>
<a name="l00310"></a>00310 <span class="comment"> * Of course all fields are in network format.</span>
<a name="l00311"></a>00311 <span class="comment"> */</span>
<a name="l00312"></a>00312 
<a name="l00313"></a><a class="code" href="structstun__trans__id.html#a31e6678265b0f7e0d931fa8429fdd2eb">00313</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>{ <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <span class="keywordtype">id</span>[4]; } __attribute__((packed)) <a class="code" href="structstun__trans__id.html" title="STUN support code.">stun_trans_id</a>;
<a name="l00314"></a>00314 
<a name="l00315"></a><a class="code" href="structstun__header.html">00315</a> struct <a class="code" href="structstun__header.html">stun_header</a> {
<a name="l00316"></a><a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">00316</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#ad1cc5e2494e96eecb8611fb7247ffc89">msgtype</a>;
<a name="l00317"></a><a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">00317</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="adsistub_8c.html#a40bce598bbb78b0eafa2df93bf8d694a">msglen</a>;
<a name="l00318"></a><a class="code" href="structstun__header.html#acff5f4b3a2e643d3614b724509f4650e">00318</a>    stun_trans_id  <a class="code" href="app__queue_8c.html#acd1f0e9b4730ec60f62cb0806cb06ef1">id</a>;
<a name="l00319"></a><a class="code" href="structstun__header.html#a401a6190b88ef972e67575a2d95b2c32">00319</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ies[0];
<a name="l00320"></a>00320 } __attribute__((packed));
<a name="l00321"></a>00321 
<a name="l00322"></a><a class="code" href="structstun__attr.html">00322</a> <span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> {
<a name="l00323"></a><a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">00323</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>;
<a name="l00324"></a><a class="code" href="structstun__attr.html#ad4c01009aad5a218ea64c329ebfe653d">00324</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structstun__attr.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>;
<a name="l00325"></a><a class="code" href="structstun__attr.html#af75ae4a7a4f2a57416386f6c70609cb3">00325</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structstun__attr.html#af75ae4a7a4f2a57416386f6c70609cb3">value</a>[0];
<a name="l00326"></a>00326 } __attribute__((packed));
<a name="l00327"></a>00327 
<a name="l00328"></a>00328 <span class="comment">/*</span>
<a name="l00329"></a>00329 <span class="comment"> * The format normally used for addresses carried by STUN messages.</span>
<a name="l00330"></a>00330 <span class="comment"> */</span>
<a name="l00331"></a><a class="code" href="structstun__addr.html">00331</a> <span class="keyword">struct </span><a class="code" href="structstun__addr.html">stun_addr</a> {
<a name="l00332"></a><a class="code" href="structstun__addr.html#ad10d012877d07ca3b2e818f11bf97a0f">00332</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structstun__addr.html#ad10d012877d07ca3b2e818f11bf97a0f">unused</a>;
<a name="l00333"></a><a class="code" href="structstun__addr.html#a6f1c3e3a98f91eb22d3bbb7ea4828c86">00333</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="structstun__addr.html#a6f1c3e3a98f91eb22d3bbb7ea4828c86">family</a>;
<a name="l00334"></a><a class="code" href="structstun__addr.html#ab85ff85aa1f60f4a1c1ca1225a9dad06">00334</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="structstun__addr.html#ab85ff85aa1f60f4a1c1ca1225a9dad06">port</a>;
<a name="l00335"></a><a class="code" href="structstun__addr.html#ab36863a07751ac73459d46b677c33b57">00335</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structstun__addr.html#ab36863a07751ac73459d46b677c33b57">addr</a>;
<a name="l00336"></a>00336 } __attribute__((packed));
<a name="l00337"></a>00337 
<a name="l00338"></a><a class="code" href="rtp_8c.html#a935d4d3b32784ce267fc85d8694d9905">00338</a> <span class="preprocessor">#define STUN_IGNORE     (0)</span>
<a name="l00339"></a><a class="code" href="rtp_8c.html#a99997ca32f4f4f6e229dd8aaacd71ec0">00339</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_ACCEPT     (1)</span>
<a name="l00340"></a>00340 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00341"></a>00341 <span class="comment">/*! \brief STUN message types</span>
<a name="l00342"></a>00342 <span class="comment"> * &apos;BIND&apos; refers to transactions used to determine the externally</span>
<a name="l00343"></a>00343 <span class="comment"> * visible addresses. &apos;SEC&apos; refers to transactions used to establish</span>
<a name="l00344"></a>00344 <span class="comment"> * a session key for subsequent requests.</span>
<a name="l00345"></a>00345 <span class="comment"> * &apos;SEC&apos; functionality is not supported here.</span>
<a name="l00346"></a>00346 <span class="comment"> */</span>
<a name="l00347"></a>00347  
<a name="l00348"></a><a class="code" href="rtp_8c.html#a9f7821e6aef705d2aedf21df474f61c9">00348</a> <span class="preprocessor">#define STUN_BINDREQ 0x0001</span>
<a name="l00349"></a><a class="code" href="rtp_8c.html#a35c2b6f0f5b1a87e1f60a4cdad8b68f5">00349</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_BINDRESP   0x0101</span>
<a name="l00350"></a><a class="code" href="rtp_8c.html#a93bdbdc59d6204c9751e5dc5ef038faa">00350</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_BINDERR 0x0111</span>
<a name="l00351"></a><a class="code" href="rtp_8c.html#a9348e183663f0cda41279ae849a969d5">00351</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_SECREQ  0x0002</span>
<a name="l00352"></a><a class="code" href="rtp_8c.html#a568cd5dc401c94c8973a5a850c9338b9">00352</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_SECRESP 0x0102</span>
<a name="l00353"></a><a class="code" href="rtp_8c.html#a474372753c6b0f2c4b320769f3a63fd3">00353</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_SECERR  0x0112</span>
<a name="l00354"></a>00354 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00355"></a>00355 <span class="comment">/*! \brief Basic attribute types in stun messages.</span>
<a name="l00356"></a>00356 <span class="comment"> * Messages can also contain custom attributes (codes above 0x7fff)</span>
<a name="l00357"></a>00357 <span class="comment"> */</span>
<a name="l00358"></a><a class="code" href="rtp_8c.html#a4d17b635a86a35f71ab4869e17e06f7c">00358</a> <span class="preprocessor">#define STUN_MAPPED_ADDRESS   0x0001</span>
<a name="l00359"></a><a class="code" href="rtp_8c.html#a088d8c8341b8eeffeab1e1080e0aed31">00359</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_RESPONSE_ADDRESS 0x0002</span>
<a name="l00360"></a><a class="code" href="rtp_8c.html#af83fe913b9677dee01764350472039a9">00360</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_CHANGE_REQUEST   0x0003</span>
<a name="l00361"></a><a class="code" href="rtp_8c.html#a85d4f6a2c69a1986aa68d3b4701c76fd">00361</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_SOURCE_ADDRESS   0x0004</span>
<a name="l00362"></a><a class="code" href="rtp_8c.html#a234c54a1ae0086dbc9315ebaeed780ea">00362</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_CHANGED_ADDRESS  0x0005</span>
<a name="l00363"></a><a class="code" href="rtp_8c.html#a7fdb97142af9ab7163e0c46091e27ebf">00363</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_USERNAME      0x0006</span>
<a name="l00364"></a><a class="code" href="rtp_8c.html#a46bf8accf920c2386a79a332bcf93902">00364</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_PASSWORD      0x0007</span>
<a name="l00365"></a><a class="code" href="rtp_8c.html#adfb2e15a2978134366f1e61c1932492e">00365</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_MESSAGE_INTEGRITY   0x0008</span>
<a name="l00366"></a><a class="code" href="rtp_8c.html#a770ad40dd94b67a7872a6c70213d4e0d">00366</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_ERROR_CODE    0x0009</span>
<a name="l00367"></a><a class="code" href="rtp_8c.html#adc242b031c6e26f105345b9314c6e12e">00367</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_UNKNOWN_ATTRIBUTES  0x000a</span>
<a name="l00368"></a><a class="code" href="rtp_8c.html#a6bf831d925be274a521b44ca4c42d896">00368</a> <span class="preprocessor"></span><span class="preprocessor">#define STUN_REFLECTED_FROM   0x000b</span>
<a name="l00369"></a>00369 <span class="preprocessor"></span><span class="comment"></span>
<a name="l00370"></a>00370 <span class="comment">/*! \brief helper function to print message names */</span>
<a name="l00371"></a><a class="code" href="rtp_8c.html#aa27c7a598b9e3dcd1eb79f0a1ac32d58">00371</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#aa27c7a598b9e3dcd1eb79f0a1ac32d58" title="helper function to print message names">stun_msg2str</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l00372"></a>00372 {
<a name="l00373"></a>00373    <span class="keywordflow">switch</span> (msg) {
<a name="l00374"></a>00374    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a9f7821e6aef705d2aedf21df474f61c9" title="STUN message types &amp;#39;BIND&amp;#39; refers to transactions used to determine the externally...">STUN_BINDREQ</a>:
<a name="l00375"></a>00375       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Binding Request&quot;</span>;
<a name="l00376"></a>00376    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a35c2b6f0f5b1a87e1f60a4cdad8b68f5">STUN_BINDRESP</a>:
<a name="l00377"></a>00377       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Binding Response&quot;</span>;
<a name="l00378"></a>00378    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a93bdbdc59d6204c9751e5dc5ef038faa">STUN_BINDERR</a>:
<a name="l00379"></a>00379       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Binding Error Response&quot;</span>;
<a name="l00380"></a>00380    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a9348e183663f0cda41279ae849a969d5">STUN_SECREQ</a>:
<a name="l00381"></a>00381       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Shared Secret Request&quot;</span>;
<a name="l00382"></a>00382    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a568cd5dc401c94c8973a5a850c9338b9">STUN_SECRESP</a>:
<a name="l00383"></a>00383       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Shared Secret Response&quot;</span>;
<a name="l00384"></a>00384    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a474372753c6b0f2c4b320769f3a63fd3">STUN_SECERR</a>:
<a name="l00385"></a>00385       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Shared Secret Error Response&quot;</span>;
<a name="l00386"></a>00386    }
<a name="l00387"></a>00387    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Non-RFC3489 Message&quot;</span>;
<a name="l00388"></a>00388 }
<a name="l00389"></a>00389 <span class="comment"></span>
<a name="l00390"></a>00390 <span class="comment">/*! \brief helper function to print attribute names */</span>
<a name="l00391"></a><a class="code" href="rtp_8c.html#ac28b49995f12c4a3adc54986a6751998">00391</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#ac28b49995f12c4a3adc54986a6751998" title="helper function to print attribute names">stun_attr2str</a>(<span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a0dee90db1d6eb30329bee1ae6cec036a">msg</a>)
<a name="l00392"></a>00392 {
<a name="l00393"></a>00393    <span class="keywordflow">switch</span> (msg) {
<a name="l00394"></a>00394    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a4d17b635a86a35f71ab4869e17e06f7c" title="Basic attribute types in stun messages. Messages can also contain custom attributes...">STUN_MAPPED_ADDRESS</a>:
<a name="l00395"></a>00395       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Mapped Address&quot;</span>;
<a name="l00396"></a>00396    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a088d8c8341b8eeffeab1e1080e0aed31">STUN_RESPONSE_ADDRESS</a>:
<a name="l00397"></a>00397       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Response Address&quot;</span>;
<a name="l00398"></a>00398    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#af83fe913b9677dee01764350472039a9">STUN_CHANGE_REQUEST</a>:
<a name="l00399"></a>00399       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Change Request&quot;</span>;
<a name="l00400"></a>00400    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a85d4f6a2c69a1986aa68d3b4701c76fd">STUN_SOURCE_ADDRESS</a>:
<a name="l00401"></a>00401       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Source Address&quot;</span>;
<a name="l00402"></a>00402    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a234c54a1ae0086dbc9315ebaeed780ea">STUN_CHANGED_ADDRESS</a>:
<a name="l00403"></a>00403       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Changed Address&quot;</span>;
<a name="l00404"></a>00404    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a7fdb97142af9ab7163e0c46091e27ebf">STUN_USERNAME</a>:
<a name="l00405"></a>00405       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Username&quot;</span>;
<a name="l00406"></a>00406    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a46bf8accf920c2386a79a332bcf93902">STUN_PASSWORD</a>:
<a name="l00407"></a>00407       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Password&quot;</span>;
<a name="l00408"></a>00408    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#adfb2e15a2978134366f1e61c1932492e">STUN_MESSAGE_INTEGRITY</a>:
<a name="l00409"></a>00409       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Message Integrity&quot;</span>;
<a name="l00410"></a>00410    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a770ad40dd94b67a7872a6c70213d4e0d">STUN_ERROR_CODE</a>:
<a name="l00411"></a>00411       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Error Code&quot;</span>;
<a name="l00412"></a>00412    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#adc242b031c6e26f105345b9314c6e12e">STUN_UNKNOWN_ATTRIBUTES</a>:
<a name="l00413"></a>00413       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Unknown Attributes&quot;</span>;
<a name="l00414"></a>00414    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a6bf831d925be274a521b44ca4c42d896">STUN_REFLECTED_FROM</a>:
<a name="l00415"></a>00415       <span class="keywordflow">return</span> <span class="stringliteral">&quot;Reflected From&quot;</span>;
<a name="l00416"></a>00416    }
<a name="l00417"></a>00417    <span class="keywordflow">return</span> <span class="stringliteral">&quot;Non-RFC3489 Attribute&quot;</span>;
<a name="l00418"></a>00418 }
<a name="l00419"></a>00419 <span class="comment"></span>
<a name="l00420"></a>00420 <span class="comment">/*! \brief here we store credentials extracted from a message */</span>
<a name="l00421"></a><a class="code" href="structstun__state.html">00421</a> <span class="keyword">struct </span><a class="code" href="structstun__state.html" title="here we store credentials extracted from a message">stun_state</a> {
<a name="l00422"></a><a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">00422</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">username</a>;
<a name="l00423"></a><a class="code" href="structstun__state.html#aa4a2ebcb494493f648ae1e6975672575">00423</a>    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="structstun__state.html#aa4a2ebcb494493f648ae1e6975672575">password</a>;
<a name="l00424"></a>00424 };
<a name="l00425"></a>00425 
<a name="l00426"></a><a class="code" href="rtp_8c.html#ac213051c78483c9b4db5bdd50816ebad">00426</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#ac213051c78483c9b4db5bdd50816ebad">stun_process_attr</a>(<span class="keyword">struct</span> <a class="code" href="structstun__state.html" title="here we store credentials extracted from a message">stun_state</a> *<a class="code" href="structstate.html">state</a>, <span class="keyword">struct</span> <a class="code" href="structstun__attr.html">stun_attr</a> *attr)
<a name="l00427"></a>00427 {
<a name="l00428"></a>00428    <span class="keywordflow">if</span> (stundebug)
<a name="l00429"></a>00429       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Found STUN Attribute %s (%04x), length %d\n&quot;</span>,
<a name="l00430"></a>00430              <a class="code" href="rtp_8c.html#ac28b49995f12c4a3adc54986a6751998" title="helper function to print attribute names">stun_attr2str</a>(ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>)), ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>), ntohs(attr-&gt;<a class="code" href="structstun__attr.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>));
<a name="l00431"></a>00431    <span class="keywordflow">switch</span> (ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>)) {
<a name="l00432"></a>00432    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a7fdb97142af9ab7163e0c46091e27ebf">STUN_USERNAME</a>:
<a name="l00433"></a>00433       state-&gt;<a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">username</a> = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) (attr-&gt;<a class="code" href="structstun__attr.html#af75ae4a7a4f2a57416386f6c70609cb3">value</a>);
<a name="l00434"></a>00434       <span class="keywordflow">break</span>;
<a name="l00435"></a>00435    <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a46bf8accf920c2386a79a332bcf93902">STUN_PASSWORD</a>:
<a name="l00436"></a>00436       state-&gt;<a class="code" href="structstun__state.html#aa4a2ebcb494493f648ae1e6975672575">password</a> = (<span class="keyword">const</span> <span class="keywordtype">char</span> *) (attr-&gt;<a class="code" href="structstun__attr.html#af75ae4a7a4f2a57416386f6c70609cb3">value</a>);
<a name="l00437"></a>00437       <span class="keywordflow">break</span>;
<a name="l00438"></a>00438    <span class="keywordflow">default</span>:
<a name="l00439"></a>00439       <span class="keywordflow">if</span> (stundebug)
<a name="l00440"></a>00440          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Ignoring STUN attribute %s (%04x), length %d\n&quot;</span>, 
<a name="l00441"></a>00441                 <a class="code" href="rtp_8c.html#ac28b49995f12c4a3adc54986a6751998" title="helper function to print attribute names">stun_attr2str</a>(ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>)), ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>), ntohs(attr-&gt;<a class="code" href="structstun__attr.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>));
<a name="l00442"></a>00442    }
<a name="l00443"></a>00443    <span class="keywordflow">return</span> 0;
<a name="l00444"></a>00444 }
<a name="l00445"></a>00445 <span class="comment"></span>
<a name="l00446"></a>00446 <span class="comment">/*! \brief append a string to an STUN message */</span>
<a name="l00447"></a><a class="code" href="rtp_8c.html#af9fd00095b0279f4bab24fba7a249eb2">00447</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#af9fd00095b0279f4bab24fba7a249eb2" title="append a string to an STUN message">append_attr_string</a>(<span class="keyword">struct</span> <a class="code" href="structstun__attr.html">stun_attr</a> **attr, <span class="keywordtype">int</span> attrval, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keywordtype">int</span> *<a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> *left)
<a name="l00448"></a>00448 {
<a name="l00449"></a>00449    <span class="keywordtype">int</span> size = <span class="keyword">sizeof</span>(**attr) + strlen(s);
<a name="l00450"></a>00450    <span class="keywordflow">if</span> (*left &gt; size) {
<a name="l00451"></a>00451       (*attr)-&gt;attr = htons(attrval);
<a name="l00452"></a>00452       (*attr)-&gt;len = htons(strlen(s));
<a name="l00453"></a>00453       memcpy((*attr)-&gt;value, s, strlen(s));
<a name="l00454"></a>00454       (*attr) = (<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *)((*attr)-&gt;value + strlen(s));
<a name="l00455"></a>00455       *len += size;
<a name="l00456"></a>00456       *left -= size;
<a name="l00457"></a>00457    }
<a name="l00458"></a>00458 }
<a name="l00459"></a>00459 <span class="comment"></span>
<a name="l00460"></a>00460 <span class="comment">/*! \brief append an address to an STUN message */</span>
<a name="l00461"></a><a class="code" href="rtp_8c.html#a836031ef3aefaa00e913a004090a125e">00461</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#a836031ef3aefaa00e913a004090a125e" title="append an address to an STUN message">append_attr_address</a>(<span class="keyword">struct</span> <a class="code" href="structstun__attr.html">stun_attr</a> **<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>, <span class="keywordtype">int</span> attrval, <span class="keyword">struct</span> sockaddr_in *sock_in, <span class="keywordtype">int</span> *<a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> *left)
<a name="l00462"></a>00462 {
<a name="l00463"></a>00463    <span class="keywordtype">int</span> size = <span class="keyword">sizeof</span>(**attr) + 8;
<a name="l00464"></a>00464    <span class="keyword">struct </span><a class="code" href="structstun__addr.html">stun_addr</a> *<a class="code" href="structstun__addr.html#ab36863a07751ac73459d46b677c33b57">addr</a>;
<a name="l00465"></a>00465    <span class="keywordflow">if</span> (*left &gt; size) {
<a name="l00466"></a>00466       (*attr)-&gt;attr = htons(attrval);
<a name="l00467"></a>00467       (*attr)-&gt;len = htons(8);
<a name="l00468"></a>00468       addr = (<span class="keyword">struct </span><a class="code" href="structstun__addr.html">stun_addr</a> *)((*attr)-&gt;value);
<a name="l00469"></a>00469       addr-&gt;<a class="code" href="structstun__addr.html#ad10d012877d07ca3b2e818f11bf97a0f">unused</a> = 0;
<a name="l00470"></a>00470       addr-&gt;<a class="code" href="structstun__addr.html#a6f1c3e3a98f91eb22d3bbb7ea4828c86">family</a> = 0x01;
<a name="l00471"></a>00471       addr-&gt;<a class="code" href="structstun__addr.html#ab85ff85aa1f60f4a1c1ca1225a9dad06">port</a> = sock_in-&gt;sin_port;
<a name="l00472"></a>00472       addr-&gt;<a class="code" href="structstun__addr.html#ab36863a07751ac73459d46b677c33b57">addr</a> = sock_in-&gt;sin_addr.s_addr;
<a name="l00473"></a>00473       (*attr) = (<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *)((*attr)-&gt;value + 8);
<a name="l00474"></a>00474       *len += size;
<a name="l00475"></a>00475       *left -= size;
<a name="l00476"></a>00476    }
<a name="l00477"></a>00477 }
<a name="l00478"></a>00478 <span class="comment"></span>
<a name="l00479"></a>00479 <span class="comment">/*! \brief wrapper to send an STUN message */</span>
<a name="l00480"></a><a class="code" href="rtp_8c.html#ae29344f09db98900eba592c6a2816b62">00480</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#ae29344f09db98900eba592c6a2816b62" title="wrapper to send an STUN message">stun_send</a>(<span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">struct</span> sockaddr_in *dst, <span class="keyword">struct</span> <a class="code" href="structstun__header.html">stun_header</a> *resp)
<a name="l00481"></a>00481 {
<a name="l00482"></a>00482    <span class="keywordflow">return</span> sendto(s, resp, ntohs(resp-&gt;<a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">msglen</a>) + <span class="keyword">sizeof</span>(*resp), 0,
<a name="l00483"></a>00483             (<span class="keyword">struct</span> sockaddr *)dst, <span class="keyword">sizeof</span>(*dst));
<a name="l00484"></a>00484 }
<a name="l00485"></a>00485 <span class="comment"></span>
<a name="l00486"></a>00486 <span class="comment">/*! \brief helper function to generate a random request id */</span>
<a name="l00487"></a><a class="code" href="rtp_8c.html#add7eb4e6f907c0ab7a1c42cc1ed853b1">00487</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#add7eb4e6f907c0ab7a1c42cc1ed853b1" title="helper function to generate a random request id">stun_req_id</a>(<span class="keyword">struct</span> <a class="code" href="structstun__header.html">stun_header</a> *req)
<a name="l00488"></a>00488 {
<a name="l00489"></a>00489    <span class="keywordtype">int</span> x;
<a name="l00490"></a>00490    <span class="keywordflow">for</span> (x = 0; x &lt; 4; x++)
<a name="l00491"></a>00491       req-&gt;<a class="code" href="structstun__header.html#acff5f4b3a2e643d3614b724509f4650e">id</a>.<a class="code" href="structstun__trans__id.html#a31e6678265b0f7e0d931fa8429fdd2eb">id</a>[x] = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>();
<a name="l00492"></a>00492 }
<a name="l00493"></a>00493 
<a name="l00494"></a><a class="code" href="rtp_8c.html#a697378663e75e6a9591aaf728c0fb968">00494</a> <span class="keywordtype">size_t</span> <a class="code" href="rtp_8h.html#a697378663e75e6a9591aaf728c0fb968" title="Get the amount of space required to hold an RTP session.">ast_rtp_alloc_size</a>(<span class="keywordtype">void</span>)
<a name="l00495"></a>00495 {
<a name="l00496"></a>00496    <span class="keywordflow">return</span> <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>);
<a name="l00497"></a>00497 }
<a name="l00498"></a>00498 <span class="comment"></span>
<a name="l00499"></a>00499 <span class="comment">/*! \brief callback type to be invoked on stun responses. */</span>
<a name="l00500"></a><a class="code" href="rtp_8c.html#a91bc8af1b521e365bb8ded801a541ef9">00500</a> <span class="keyword">typedef</span> int (<a class="code" href="rtp_8c.html#a91bc8af1b521e365bb8ded801a541ef9" title="callback type to be invoked on stun responses.">stun_cb_f</a>)(<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>, <span class="keywordtype">void</span> *arg);
<a name="l00501"></a>00501 <span class="comment"></span>
<a name="l00502"></a>00502 <span class="comment">/*! \brief handle an incoming STUN message.</span>
<a name="l00503"></a>00503 <span class="comment"> *</span>
<a name="l00504"></a>00504 <span class="comment"> * Do some basic sanity checks on packet size and content,</span>
<a name="l00505"></a>00505 <span class="comment"> * try to extract a bit of information, and possibly reply.</span>
<a name="l00506"></a>00506 <span class="comment"> * At the moment this only processes BIND requests, and returns</span>
<a name="l00507"></a>00507 <span class="comment"> * the externally visible address of the request.</span>
<a name="l00508"></a>00508 <span class="comment"> * If a callback is specified, invoke it with the attribute.</span>
<a name="l00509"></a>00509 <span class="comment"> */</span>
<a name="l00510"></a><a class="code" href="rtp_8c.html#a0599391b62cb92d0a020334f6d63fdd0">00510</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a0599391b62cb92d0a020334f6d63fdd0" title="handle an incoming STUN message.">stun_handle_packet</a>(<span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">struct</span> sockaddr_in *src,
<a name="l00511"></a>00511    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *data, <span class="keywordtype">size_t</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <a class="code" href="rtp_8c.html#a91bc8af1b521e365bb8ded801a541ef9" title="callback type to be invoked on stun responses.">stun_cb_f</a> *stun_cb, <span class="keywordtype">void</span> *arg)
<a name="l00512"></a>00512 {
<a name="l00513"></a>00513    <span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a> *hdr = (<span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a> *)data;
<a name="l00514"></a>00514    <span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *attr;
<a name="l00515"></a>00515    <span class="keyword">struct </span><a class="code" href="structstun__state.html" title="here we store credentials extracted from a message">stun_state</a> st;
<a name="l00516"></a>00516    <span class="keywordtype">int</span> ret = <a class="code" href="rtp_8c.html#a935d4d3b32784ce267fc85d8694d9905">STUN_IGNORE</a>;  
<a name="l00517"></a>00517    <span class="keywordtype">int</span> x;
<a name="l00518"></a>00518 
<a name="l00519"></a>00519    <span class="comment">/* On entry, &apos;len&apos; is the length of the udp payload. After the</span>
<a name="l00520"></a>00520 <span class="comment">    * initial checks it becomes the size of unprocessed options,</span>
<a name="l00521"></a>00521 <span class="comment">    * while &apos;data&apos; is advanced accordingly.</span>
<a name="l00522"></a>00522 <span class="comment">    */</span>
<a name="l00523"></a>00523    <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstun__header.html">stun_header</a>)) {
<a name="l00524"></a>00524       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Runt STUN packet (only %d, wanting at least %d)\n&quot;</span>, (<span class="keywordtype">int</span>) len, (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstun__header.html">stun_header</a>));
<a name="l00525"></a>00525       <span class="keywordflow">return</span> -1;
<a name="l00526"></a>00526    }
<a name="l00527"></a>00527    len -= <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a>);
<a name="l00528"></a>00528    data += <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a>);
<a name="l00529"></a>00529    x = ntohs(hdr-&gt;<a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">msglen</a>); <span class="comment">/* len as advertised in the message */</span>
<a name="l00530"></a>00530    <span class="keywordflow">if</span> (stundebug)
<a name="l00531"></a>00531       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;STUN Packet, msg %s (%04x), length: %d\n&quot;</span>, <a class="code" href="rtp_8c.html#aa27c7a598b9e3dcd1eb79f0a1ac32d58" title="helper function to print message names">stun_msg2str</a>(ntohs(hdr-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a>)), ntohs(hdr-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a>), x);
<a name="l00532"></a>00532    <span class="keywordflow">if</span> (x &gt; len) {
<a name="l00533"></a>00533       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Scrambled STUN packet length (got %d, expecting %d)\n&quot;</span>, x, (<span class="keywordtype">int</span>)len);
<a name="l00534"></a>00534    } <span class="keywordflow">else</span>
<a name="l00535"></a>00535       len = x;
<a name="l00536"></a>00536    memset(&amp;st, 0, <span class="keyword">sizeof</span>(st));
<a name="l00537"></a>00537    <span class="keywordflow">while</span> (len) {
<a name="l00538"></a>00538       <span class="keywordflow">if</span> (len &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstun__attr.html">stun_attr</a>)) {
<a name="l00539"></a>00539          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Runt Attribute (got %d, expecting %d)\n&quot;</span>, (<span class="keywordtype">int</span>)len, (<span class="keywordtype">int</span>) <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstun__attr.html">stun_attr</a>));
<a name="l00540"></a>00540          <span class="keywordflow">break</span>;
<a name="l00541"></a>00541       }
<a name="l00542"></a>00542       attr = (<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *)data;
<a name="l00543"></a>00543       <span class="comment">/* compute total attribute length */</span>
<a name="l00544"></a>00544       x = ntohs(attr-&gt;<a class="code" href="structstun__attr.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>) + <span class="keyword">sizeof</span>(<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a>);
<a name="l00545"></a>00545       <span class="keywordflow">if</span> (x &gt; len) {
<a name="l00546"></a>00546          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Inconsistent Attribute (length %d exceeds remaining msg len %d)\n&quot;</span>, x, (<span class="keywordtype">int</span>)len);
<a name="l00547"></a>00547          <span class="keywordflow">break</span>;
<a name="l00548"></a>00548       }
<a name="l00549"></a>00549       <span class="keywordflow">if</span> (stun_cb)
<a name="l00550"></a>00550          stun_cb(attr, arg);
<a name="l00551"></a>00551       <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#ac213051c78483c9b4db5bdd50816ebad">stun_process_attr</a>(&amp;st, attr)) {
<a name="l00552"></a>00552          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Failed to handle attribute %s (%04x)\n&quot;</span>, <a class="code" href="rtp_8c.html#ac28b49995f12c4a3adc54986a6751998" title="helper function to print attribute names">stun_attr2str</a>(ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>)), ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>));
<a name="l00553"></a>00553          <span class="keywordflow">break</span>;
<a name="l00554"></a>00554       }
<a name="l00555"></a>00555       <span class="comment">/* Clear attribute id: in case previous entry was a string,</span>
<a name="l00556"></a>00556 <span class="comment">       * this will act as the terminator for the string.</span>
<a name="l00557"></a>00557 <span class="comment">       */</span>
<a name="l00558"></a>00558       attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a> = 0;
<a name="l00559"></a>00559       data += x;
<a name="l00560"></a>00560       len -= x;
<a name="l00561"></a>00561    }
<a name="l00562"></a>00562    <span class="comment">/* Null terminate any string.</span>
<a name="l00563"></a>00563 <span class="comment">    * XXX NOTE, we write past the size of the buffer passed by the</span>
<a name="l00564"></a>00564 <span class="comment">    * caller, so this is potentially dangerous. The only thing that</span>
<a name="l00565"></a>00565 <span class="comment">    * saves us is that usually we read the incoming message in a</span>
<a name="l00566"></a>00566 <span class="comment">    * much larger buffer in the struct ast_rtp</span>
<a name="l00567"></a>00567 <span class="comment">    */</span>
<a name="l00568"></a>00568    *data = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l00569"></a>00569 
<a name="l00570"></a>00570    <span class="comment">/* Now prepare to generate a reply, which at the moment is done</span>
<a name="l00571"></a>00571 <span class="comment">    * only for properly formed (len == 0) STUN_BINDREQ messages.</span>
<a name="l00572"></a>00572 <span class="comment">    */</span>
<a name="l00573"></a>00573    <span class="keywordflow">if</span> (len == 0) {
<a name="l00574"></a>00574       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> respdata[1024];
<a name="l00575"></a>00575       <span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a> *resp = (<span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a> *)respdata;
<a name="l00576"></a>00576       <span class="keywordtype">int</span> resplen = 0;  <span class="comment">/* len excluding header */</span>
<a name="l00577"></a>00577       <span class="keywordtype">int</span> respleft = <span class="keyword">sizeof</span>(respdata) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstun__header.html">stun_header</a>);
<a name="l00578"></a>00578 
<a name="l00579"></a>00579       resp-&gt;<a class="code" href="structstun__header.html#acff5f4b3a2e643d3614b724509f4650e">id</a> = hdr-&gt;<a class="code" href="structstun__header.html#acff5f4b3a2e643d3614b724509f4650e">id</a>;
<a name="l00580"></a>00580       resp-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a> = 0;
<a name="l00581"></a>00581       resp-&gt;<a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">msglen</a> = 0;
<a name="l00582"></a>00582       attr = (<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *)resp-&gt;<a class="code" href="structstun__header.html#a401a6190b88ef972e67575a2d95b2c32">ies</a>;
<a name="l00583"></a>00583       switch (ntohs(hdr-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a>)) {
<a name="l00584"></a>00584       <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a9f7821e6aef705d2aedf21df474f61c9" title="STUN message types &amp;#39;BIND&amp;#39; refers to transactions used to determine the externally...">STUN_BINDREQ</a>:
<a name="l00585"></a>00585          <span class="keywordflow">if</span> (stundebug)
<a name="l00586"></a>00586             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;STUN Bind Request, username: %s\n&quot;</span>, 
<a name="l00587"></a>00587                    st.<a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">username</a> ? st.<a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">username</a> : <span class="stringliteral">&quot;&lt;none&gt;&quot;</span>);
<a name="l00588"></a>00588          <span class="keywordflow">if</span> (st.<a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">username</a>)
<a name="l00589"></a>00589             <a class="code" href="rtp_8c.html#af9fd00095b0279f4bab24fba7a249eb2" title="append a string to an STUN message">append_attr_string</a>(&amp;attr, <a class="code" href="rtp_8c.html#a7fdb97142af9ab7163e0c46091e27ebf">STUN_USERNAME</a>, st.<a class="code" href="structstun__state.html#aba2dfcdfda80edcb531a5a7115d3e043">username</a>, &amp;resplen, &amp;respleft);
<a name="l00590"></a>00590          <a class="code" href="rtp_8c.html#a836031ef3aefaa00e913a004090a125e" title="append an address to an STUN message">append_attr_address</a>(&amp;attr, <a class="code" href="rtp_8c.html#a4d17b635a86a35f71ab4869e17e06f7c" title="Basic attribute types in stun messages. Messages can also contain custom attributes...">STUN_MAPPED_ADDRESS</a>, src, &amp;resplen, &amp;respleft);
<a name="l00591"></a>00591          resp-&gt;<a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">msglen</a> = htons(resplen);
<a name="l00592"></a>00592          resp-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a> = htons(<a class="code" href="rtp_8c.html#a35c2b6f0f5b1a87e1f60a4cdad8b68f5">STUN_BINDRESP</a>);
<a name="l00593"></a>00593          <a class="code" href="rtp_8c.html#ae29344f09db98900eba592c6a2816b62" title="wrapper to send an STUN message">stun_send</a>(s, src, resp);
<a name="l00594"></a>00594          ret = <a class="code" href="rtp_8c.html#a99997ca32f4f4f6e229dd8aaacd71ec0">STUN_ACCEPT</a>;
<a name="l00595"></a>00595          <span class="keywordflow">break</span>;
<a name="l00596"></a>00596       <span class="keywordflow">default</span>:
<a name="l00597"></a>00597          <span class="keywordflow">if</span> (stundebug)
<a name="l00598"></a>00598             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Dunno what to do with STUN message %04x (%s)\n&quot;</span>, ntohs(hdr-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a>), <a class="code" href="rtp_8c.html#aa27c7a598b9e3dcd1eb79f0a1ac32d58" title="helper function to print message names">stun_msg2str</a>(ntohs(hdr-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a>)));
<a name="l00599"></a>00599       }
<a name="l00600"></a>00600    }
<a name="l00601"></a>00601    <span class="keywordflow">return</span> ret;
<a name="l00602"></a>00602 }
<a name="l00603"></a>00603 <span class="comment"></span>
<a name="l00604"></a>00604 <span class="comment">/*! \brief Extract the STUN_MAPPED_ADDRESS from the stun response.</span>
<a name="l00605"></a>00605 <span class="comment"> * This is used as a callback for stun_handle_response</span>
<a name="l00606"></a>00606 <span class="comment"> * when called from ast_stun_request.</span>
<a name="l00607"></a>00607 <span class="comment"> */</span>
<a name="l00608"></a><a class="code" href="rtp_8c.html#a02f47d389424487fb9b4483433828adf">00608</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a02f47d389424487fb9b4483433828adf" title="Extract the STUN_MAPPED_ADDRESS from the stun response. This is used as a callback...">stun_get_mapped</a>(<span class="keyword">struct</span> <a class="code" href="structstun__attr.html">stun_attr</a> *attr, <span class="keywordtype">void</span> *arg)
<a name="l00609"></a>00609 {
<a name="l00610"></a>00610    <span class="keyword">struct </span><a class="code" href="structstun__addr.html">stun_addr</a> *<a class="code" href="structstun__addr.html#ab36863a07751ac73459d46b677c33b57">addr</a> = (<span class="keyword">struct </span><a class="code" href="structstun__addr.html">stun_addr</a> *)(attr + 1);
<a name="l00611"></a>00611    <span class="keyword">struct </span>sockaddr_in *sa = (<span class="keyword">struct </span>sockaddr_in *)arg;
<a name="l00612"></a>00612 
<a name="l00613"></a>00613    <span class="keywordflow">if</span> (ntohs(attr-&gt;<a class="code" href="structstun__attr.html#add3ba4b027e41df6d301c704fba01f2d">attr</a>) != <a class="code" href="rtp_8c.html#a4d17b635a86a35f71ab4869e17e06f7c" title="Basic attribute types in stun messages. Messages can also contain custom attributes...">STUN_MAPPED_ADDRESS</a> || ntohs(attr-&gt;<a class="code" href="structstun__attr.html#ad4c01009aad5a218ea64c329ebfe653d">len</a>) != 8)
<a name="l00614"></a>00614       <span class="keywordflow">return</span> 1;   <span class="comment">/* not us. */</span>
<a name="l00615"></a>00615    sa-&gt;sin_port = addr-&gt;<a class="code" href="structstun__addr.html#ab85ff85aa1f60f4a1c1ca1225a9dad06">port</a>;
<a name="l00616"></a>00616    sa-&gt;sin_addr.s_addr = addr-&gt;<a class="code" href="structstun__addr.html#ab36863a07751ac73459d46b677c33b57">addr</a>;
<a name="l00617"></a>00617    <span class="keywordflow">return</span> 0;
<a name="l00618"></a>00618 }
<a name="l00619"></a>00619 <span class="comment"></span>
<a name="l00620"></a>00620 <span class="comment">/*! \brief Generic STUN request</span>
<a name="l00621"></a>00621 <span class="comment"> * Send a generic stun request to the server specified,</span>
<a name="l00622"></a>00622 <span class="comment"> * possibly waiting for a reply and filling the &apos;reply&apos; field with</span>
<a name="l00623"></a>00623 <span class="comment"> * the externally visible address. Note that in this case the request</span>
<a name="l00624"></a>00624 <span class="comment"> * will be blocking.</span>
<a name="l00625"></a>00625 <span class="comment"> * (Note, the interface may change slightly in the future).</span>
<a name="l00626"></a>00626 <span class="comment"> *</span>
<a name="l00627"></a>00627 <span class="comment"> * \param s the socket used to send the request</span>
<a name="l00628"></a>00628 <span class="comment"> * \param dst the address of the STUN server</span>
<a name="l00629"></a>00629 <span class="comment"> * \param username if non null, add the username in the request</span>
<a name="l00630"></a>00630 <span class="comment"> * \param answer if non null, the function waits for a response and</span>
<a name="l00631"></a>00631 <span class="comment"> *    puts here the externally visible address.</span>
<a name="l00632"></a>00632 <span class="comment"> * \return 0 on success, other values on error.</span>
<a name="l00633"></a>00633 <span class="comment"> */</span>
<a name="l00634"></a><a class="code" href="rtp_8c.html#a494a72723299c0e75e1c2cf092135ea6">00634</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a494a72723299c0e75e1c2cf092135ea6" title="Generic STUN request send a generic stun request to the server specified.">ast_stun_request</a>(<span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>, <span class="keyword">struct</span> sockaddr_in *dst,
<a name="l00635"></a>00635    <span class="keyword">const</span> <span class="keywordtype">char</span> *username, <span class="keyword">struct</span> sockaddr_in *answer)
<a name="l00636"></a>00636 {
<a name="l00637"></a>00637    <span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a> *req;
<a name="l00638"></a>00638    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> reqdata[1024];
<a name="l00639"></a>00639    <span class="keywordtype">int</span> reqlen, reqleft;
<a name="l00640"></a>00640    <span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *attr;
<a name="l00641"></a>00641    <span class="keywordtype">int</span> res = 0;
<a name="l00642"></a>00642    <span class="keywordtype">int</span> retry;
<a name="l00643"></a>00643    
<a name="l00644"></a>00644    req = (<span class="keyword">struct </span><a class="code" href="structstun__header.html">stun_header</a> *)reqdata;
<a name="l00645"></a>00645    <a class="code" href="rtp_8c.html#add7eb4e6f907c0ab7a1c42cc1ed853b1" title="helper function to generate a random request id">stun_req_id</a>(req);
<a name="l00646"></a>00646    reqlen = 0;
<a name="l00647"></a>00647    reqleft = <span class="keyword">sizeof</span>(reqdata) - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structstun__header.html">stun_header</a>);
<a name="l00648"></a>00648    req-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a> = 0;
<a name="l00649"></a>00649    req-&gt;<a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">msglen</a> = 0;
<a name="l00650"></a>00650    attr = (<span class="keyword">struct </span><a class="code" href="structstun__attr.html">stun_attr</a> *)req-&gt;<a class="code" href="structstun__header.html#a401a6190b88ef972e67575a2d95b2c32">ies</a>;
<a name="l00651"></a>00651    if (username)
<a name="l00652"></a>00652       <a class="code" href="rtp_8c.html#af9fd00095b0279f4bab24fba7a249eb2" title="append a string to an STUN message">append_attr_string</a>(&amp;attr, <a class="code" href="rtp_8c.html#a7fdb97142af9ab7163e0c46091e27ebf">STUN_USERNAME</a>, username, &amp;reqlen, &amp;reqleft);
<a name="l00653"></a>00653    req-&gt;<a class="code" href="structstun__header.html#aaf6a1387ecab029331e2d6d48a6179f4">msglen</a> = htons(reqlen);
<a name="l00654"></a>00654    req-&gt;<a class="code" href="structstun__header.html#a849329b477142ee81454d566f371e008">msgtype</a> = htons(<a class="code" href="rtp_8c.html#a9f7821e6aef705d2aedf21df474f61c9" title="STUN message types &amp;#39;BIND&amp;#39; refers to transactions used to determine the externally...">STUN_BINDREQ</a>);
<a name="l00655"></a>00655    <span class="keywordflow">for</span> (retry = 0; retry &lt; 3; retry++) {  <span class="comment">/* XXX make retries configurable */</span>
<a name="l00656"></a>00656       <span class="comment">/* send request, possibly wait for reply */</span>
<a name="l00657"></a>00657       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> reply_buf[1024];
<a name="l00658"></a>00658       fd_set rfds;
<a name="l00659"></a>00659       <span class="keyword">struct </span>timeval to = { 3, 0 }; <span class="comment">/* timeout, make it configurable */</span>
<a name="l00660"></a>00660       <span class="keyword">struct </span>sockaddr_in src;
<a name="l00661"></a>00661       socklen_t srclen;
<a name="l00662"></a>00662 
<a name="l00663"></a>00663       res = <a class="code" href="rtp_8c.html#ae29344f09db98900eba592c6a2816b62" title="wrapper to send an STUN message">stun_send</a>(s, dst, req);
<a name="l00664"></a>00664       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00665"></a>00665          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ast_stun_request send #%d failed error %d, retry\n&quot;</span>,
<a name="l00666"></a>00666             retry, res);
<a name="l00667"></a>00667          <span class="keywordflow">continue</span>;
<a name="l00668"></a>00668       }
<a name="l00669"></a>00669       <span class="keywordflow">if</span> (answer == NULL)
<a name="l00670"></a>00670          <span class="keywordflow">break</span>;
<a name="l00671"></a>00671       FD_ZERO(&amp;rfds);
<a name="l00672"></a>00672       FD_SET(s, &amp;rfds);
<a name="l00673"></a>00673       res = <a class="code" href="channel_8h.html#a056ed4f99440f01c251b2e8ca4501a56" title="Waits for activity on a group of channels.">ast_select</a>(s + 1, &amp;rfds, NULL, NULL, &amp;to);
<a name="l00674"></a>00674       <span class="keywordflow">if</span> (res &lt;= 0)  <span class="comment">/* timeout or error */</span>
<a name="l00675"></a>00675          <span class="keywordflow">continue</span>;
<a name="l00676"></a>00676       memset(&amp;src, <span class="charliteral">&apos;\0&apos;</span>, <span class="keyword">sizeof</span>(src));
<a name="l00677"></a>00677       srclen = <span class="keyword">sizeof</span>(src);
<a name="l00678"></a>00678       <span class="comment">/* XXX pass -1 in the size, because stun_handle_packet might</span>
<a name="l00679"></a>00679 <span class="comment">       * write past the end of the buffer.</span>
<a name="l00680"></a>00680 <span class="comment">       */</span>
<a name="l00681"></a>00681       res = recvfrom(s, reply_buf, <span class="keyword">sizeof</span>(reply_buf) - 1,
<a name="l00682"></a>00682          0, (<span class="keyword">struct</span> sockaddr *)&amp;src, &amp;srclen);
<a name="l00683"></a>00683       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l00684"></a>00684          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;ast_stun_request recvfrom #%d failed error %d, retry\n&quot;</span>,
<a name="l00685"></a>00685             retry, res);
<a name="l00686"></a>00686          <span class="keywordflow">continue</span>;
<a name="l00687"></a>00687       }
<a name="l00688"></a>00688       memset(answer, <span class="charliteral">&apos;\0&apos;</span>, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> sockaddr_in));
<a name="l00689"></a>00689       <a class="code" href="rtp_8c.html#a0599391b62cb92d0a020334f6d63fdd0" title="handle an incoming STUN message.">stun_handle_packet</a>(s, &amp;src, reply_buf, res,
<a name="l00690"></a>00690          <a class="code" href="rtp_8c.html#a02f47d389424487fb9b4483433828adf" title="Extract the STUN_MAPPED_ADDRESS from the stun response. This is used as a callback...">stun_get_mapped</a>, answer);
<a name="l00691"></a>00691       res = 0; <span class="comment">/* signal regular exit */</span>
<a name="l00692"></a>00692       <span class="keywordflow">break</span>;
<a name="l00693"></a>00693    }
<a name="l00694"></a>00694    <span class="keywordflow">return</span> res;
<a name="l00695"></a>00695 }
<a name="l00696"></a>00696 <span class="comment"></span>
<a name="l00697"></a>00697 <span class="comment">/*! \brief send a STUN BIND request to the given destination.</span>
<a name="l00698"></a>00698 <span class="comment"> * Optionally, add a username if specified.</span>
<a name="l00699"></a>00699 <span class="comment"> */</span>
<a name="l00700"></a><a class="code" href="rtp_8c.html#a07235f64f5a9df68065cfe08ee6d9f44">00700</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a07235f64f5a9df68065cfe08ee6d9f44" title="Send STUN request for an RTP socket Deprecated, this is just a wrapper for ast_rtp_stun_request()...">ast_rtp_stun_request</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> sockaddr_in *suggestion, <span class="keyword">const</span> <span class="keywordtype">char</span> *username)
<a name="l00701"></a>00701 {
<a name="l00702"></a>00702    <a class="code" href="rtp_8h.html#a494a72723299c0e75e1c2cf092135ea6" title="Generic STUN request send a generic stun request to the server specified.">ast_stun_request</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, suggestion, username, NULL);
<a name="l00703"></a>00703 }
<a name="l00704"></a>00704 <span class="comment"></span>
<a name="l00705"></a>00705 <span class="comment">/*! \brief List of current sessions */</span>
<a name="l00706"></a><a class="code" href="structprotos.html#ace4e0066a5b24f84b90536e9906619f6">00706</a> <span class="keyword">static</span> <a class="code" href="linkedlists_8h.html#a39918fd433ac42184b152c86016ef139" title="Defines a structure to be used to hold a read/write list of specified type, statically...">AST_RWLIST_HEAD_STATIC</a>(<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>, <a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a>);
<a name="l00707"></a>00707 
<a name="l00708"></a><a class="code" href="rtp_8c.html#ae07b5d23a23d4d09988c4a1c5d477d14">00708</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#ae07b5d23a23d4d09988c4a1c5d477d14">timeval2ntp</a>(<span class="keyword">struct</span> timeval when, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *msw, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *lsw)
<a name="l00709"></a>00709 {
<a name="l00710"></a>00710    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="adsistub_8c.html#a4ea74e506098ab381b9efa0200b1e1a4">sec</a>, usec, frac;
<a name="l00711"></a>00711    sec = when.tv_sec + 2208988800u; <span class="comment">/* Sec between 1900 and 1970 */</span>
<a name="l00712"></a>00712    usec = when.tv_usec;
<a name="l00713"></a>00713    frac = (usec &lt;&lt; 12) + (usec &lt;&lt; 8) - ((usec * 3650) &gt;&gt; 6);
<a name="l00714"></a>00714    *msw = sec;
<a name="l00715"></a>00715    *lsw = frac;
<a name="l00716"></a>00716 }
<a name="l00717"></a>00717 
<a name="l00718"></a><a class="code" href="rtp_8c.html#a9a990d85fb0aac29bda48777f0f86108">00718</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a9a990d85fb0aac29bda48777f0f86108">ast_rtp_fd</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00719"></a>00719 {
<a name="l00720"></a>00720    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>;
<a name="l00721"></a>00721 }
<a name="l00722"></a>00722 
<a name="l00723"></a><a class="code" href="rtp_8c.html#ac3e115dfd0bfe82479060b55dd41601f">00723</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#ac3e115dfd0bfe82479060b55dd41601f">ast_rtcp_fd</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00724"></a>00724 {
<a name="l00725"></a>00725    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>)
<a name="l00726"></a>00726       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>;
<a name="l00727"></a>00727    <span class="keywordflow">return</span> -1;
<a name="l00728"></a>00728 }
<a name="l00729"></a>00729 
<a name="l00730"></a><a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">00730</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(<span class="keywordtype">int</span> subclass)
<a name="l00731"></a>00731 {
<a name="l00732"></a>00732    <span class="keywordflow">return</span> (subclass == <a class="code" href="frame_8h.html#a4a0e8720928940d26abf28fff2e6586d">AST_FORMAT_G722</a>) ? 8000 : <a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(subclass);
<a name="l00733"></a>00733 }
<a name="l00734"></a>00734 
<a name="l00735"></a><a class="code" href="rtp_8c.html#ae8c264c840c8c9b4e8ca062746000506">00735</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#ae8c264c840c8c9b4e8ca062746000506">ast_rtcp_calc_interval</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00736"></a>00736 {
<a name="l00737"></a>00737    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> interval;<span class="comment"></span>
<a name="l00738"></a>00738 <span class="comment">   /*! \todo XXX Do a more reasonable calculation on this one</span>
<a name="l00739"></a>00739 <span class="comment">    * Look in RFC 3550 Section A.7 for an example*/</span>
<a name="l00740"></a>00740    interval = rtcpinterval;
<a name="l00741"></a>00741    <span class="keywordflow">return</span> interval;
<a name="l00742"></a>00742 }
<a name="l00743"></a>00743 
<a name="l00744"></a>00744 <span class="comment">/* \brief Put RTP timeout timers on hold during another transaction, like T.38 */</span>
<a name="l00745"></a><a class="code" href="rtp_8c.html#aa50e1394275ae2a2fd61da5659c5cb57">00745</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#aa50e1394275ae2a2fd61da5659c5cb57">ast_rtp_set_rtptimers_onhold</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00746"></a>00746 {
<a name="l00747"></a>00747    rtp-&gt;<a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a> = (-1) * rtp-&gt;<a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a>;
<a name="l00748"></a>00748    rtp-&gt;<a class="code" href="structast__rtp.html#a9c8c363bb6d84360b92945bb18bb0451">rtpholdtimeout</a> = (-1) * rtp-&gt;<a class="code" href="structast__rtp.html#a9c8c363bb6d84360b92945bb18bb0451">rtpholdtimeout</a>;
<a name="l00749"></a>00749 }
<a name="l00750"></a>00750 <span class="comment"></span>
<a name="l00751"></a>00751 <span class="comment">/*! \brief Set rtp timeout */</span>
<a name="l00752"></a><a class="code" href="rtp_8c.html#a30d6a83648ee8345a70aa1a2ccd311c7">00752</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a30d6a83648ee8345a70aa1a2ccd311c7" title="Set rtp timeout.">ast_rtp_set_rtptimeout</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> timeout)
<a name="l00753"></a>00753 {
<a name="l00754"></a>00754    rtp-&gt;<a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a> = timeout;
<a name="l00755"></a>00755 }
<a name="l00756"></a>00756 <span class="comment"></span>
<a name="l00757"></a>00757 <span class="comment">/*! \brief Set rtp hold timeout */</span>
<a name="l00758"></a><a class="code" href="rtp_8c.html#a3d6eab4ad6579f8616f1f9457aa6bba7">00758</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a3d6eab4ad6579f8616f1f9457aa6bba7" title="Set rtp hold timeout.">ast_rtp_set_rtpholdtimeout</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> timeout)
<a name="l00759"></a>00759 {
<a name="l00760"></a>00760    rtp-&gt;<a class="code" href="structast__rtp.html#a9c8c363bb6d84360b92945bb18bb0451">rtpholdtimeout</a> = timeout;
<a name="l00761"></a>00761 }
<a name="l00762"></a>00762 <span class="comment"></span>
<a name="l00763"></a>00763 <span class="comment">/*! \brief set RTP keepalive interval */</span>
<a name="l00764"></a><a class="code" href="rtp_8c.html#a519628da9d60698b3b630697f6df0ed4">00764</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a519628da9d60698b3b630697f6df0ed4" title="set RTP keepalive interval">ast_rtp_set_rtpkeepalive</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> period)
<a name="l00765"></a>00765 {
<a name="l00766"></a>00766    rtp-&gt;<a class="code" href="structast__rtp.html#a9472cfc2a7a21f124c161f7baaf9d5dc">rtpkeepalive</a> = period;
<a name="l00767"></a>00767 }
<a name="l00768"></a>00768 <span class="comment"></span>
<a name="l00769"></a>00769 <span class="comment">/*! \brief Get rtp timeout */</span>
<a name="l00770"></a><a class="code" href="rtp_8c.html#a09840fa9ab8d07f139c5d0729cfebe13">00770</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a09840fa9ab8d07f139c5d0729cfebe13" title="Get rtp timeout.">ast_rtp_get_rtptimeout</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00771"></a>00771 {
<a name="l00772"></a>00772    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a> &lt; 0)   <span class="comment">/* We&apos;re not checking, but remembering the setting (during T.38 transmission) */</span>
<a name="l00773"></a>00773       <span class="keywordflow">return</span> 0;
<a name="l00774"></a>00774    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a>;
<a name="l00775"></a>00775 }
<a name="l00776"></a>00776 <span class="comment"></span>
<a name="l00777"></a>00777 <span class="comment">/*! \brief Get rtp hold timeout */</span>
<a name="l00778"></a><a class="code" href="rtp_8c.html#a3a2d59587ce0c7d5259a33726f1c1e5c">00778</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a3a2d59587ce0c7d5259a33726f1c1e5c" title="Get rtp hold timeout.">ast_rtp_get_rtpholdtimeout</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00779"></a>00779 {
<a name="l00780"></a>00780    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a96c64be67b0bcd897efa8db0eced9ab8">rtptimeout</a> &lt; 0)   <span class="comment">/* We&apos;re not checking, but remembering the setting (during T.38 transmission) */</span>
<a name="l00781"></a>00781       <span class="keywordflow">return</span> 0;
<a name="l00782"></a>00782    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a9c8c363bb6d84360b92945bb18bb0451">rtpholdtimeout</a>;
<a name="l00783"></a>00783 }
<a name="l00784"></a>00784 <span class="comment"></span>
<a name="l00785"></a>00785 <span class="comment">/*! \brief Get RTP keepalive interval */</span>
<a name="l00786"></a><a class="code" href="rtp_8c.html#a003294c332c246f8ad007df22ecd5a16">00786</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a003294c332c246f8ad007df22ecd5a16" title="Get RTP keepalive interval.">ast_rtp_get_rtpkeepalive</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00787"></a>00787 {
<a name="l00788"></a>00788    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a9472cfc2a7a21f124c161f7baaf9d5dc">rtpkeepalive</a>;
<a name="l00789"></a>00789 }
<a name="l00790"></a>00790 
<a name="l00791"></a><a class="code" href="rtp_8c.html#adeb9cc3c3a7b7b8bf4a7e63e395a56b6">00791</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#adeb9cc3c3a7b7b8bf4a7e63e395a56b6">ast_rtp_set_data</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">void</span> *data)
<a name="l00792"></a>00792 {
<a name="l00793"></a>00793    rtp-&gt;<a class="code" href="structast__rtp.html#a735984d41155bc1032e09bece8f8d66d">data</a> = data;
<a name="l00794"></a>00794 }
<a name="l00795"></a>00795 
<a name="l00796"></a><a class="code" href="rtp_8c.html#a5919a5a4eef238a45254313d782a864c">00796</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a5919a5a4eef238a45254313d782a864c">ast_rtp_set_callback</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <a class="code" href="rtp_8h.html#a8d640c81e33ce90c44ae443dbd9f38cb">ast_rtp_callback</a> callback)
<a name="l00797"></a>00797 {
<a name="l00798"></a>00798    rtp-&gt;<a class="code" href="structast__rtp.html#ac7c7a9968aa83f15b39dfe8fd533fd34">callback</a> = callback;
<a name="l00799"></a>00799 }
<a name="l00800"></a>00800 
<a name="l00801"></a><a class="code" href="rtp_8c.html#ad7fd9b0ac09fc5378dcf120bc5d18c03">00801</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#ad7fd9b0ac09fc5378dcf120bc5d18c03">ast_rtp_setnat</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a>)
<a name="l00802"></a>00802 {
<a name="l00803"></a>00803    rtp-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a> = nat;
<a name="l00804"></a>00804 }
<a name="l00805"></a>00805 
<a name="l00806"></a><a class="code" href="rtp_8c.html#a036fcb49050c5f45a075d18b2f20c96a">00806</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a036fcb49050c5f45a075d18b2f20c96a">ast_rtp_getnat</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00807"></a>00807 {
<a name="l00808"></a>00808    <span class="keywordflow">return</span> <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>);
<a name="l00809"></a>00809 }
<a name="l00810"></a>00810 
<a name="l00811"></a><a class="code" href="rtp_8c.html#a60e7859e5819265bbc0ba619f852b0aa">00811</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a60e7859e5819265bbc0ba619f852b0aa" title="Indicate whether this RTP session is carrying DTMF or not.">ast_rtp_setdtmf</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> dtmf)
<a name="l00812"></a>00812 {
<a name="l00813"></a>00813    <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(rtp, dtmf ? 1 : 0, <a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">FLAG_HAS_DTMF</a>);
<a name="l00814"></a>00814 }
<a name="l00815"></a>00815 
<a name="l00816"></a><a class="code" href="rtp_8c.html#af89b655b02f586e920c3a27d06a590b1">00816</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#af89b655b02f586e920c3a27d06a590b1" title="Compensate for devices that send RFC2833 packets all at once.">ast_rtp_setdtmfcompensate</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> compensate)
<a name="l00817"></a>00817 {
<a name="l00818"></a>00818    <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(rtp, compensate ? 1 : 0, <a class="code" href="rtp_8c.html#a512509bde2176b98fbdcbceb1a528f6d">FLAG_DTMF_COMPENSATE</a>);
<a name="l00819"></a>00819 }
<a name="l00820"></a>00820 
<a name="l00821"></a><a class="code" href="rtp_8c.html#a7c4ba34d21a78cb29bed9a286858180b">00821</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a7c4ba34d21a78cb29bed9a286858180b" title="Enable STUN capability.">ast_rtp_setstun</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> stun_enable)
<a name="l00822"></a>00822 {
<a name="l00823"></a>00823    <a class="code" href="utils_8h.html#a67b6713ff86cf82aaed821e9a87d1c21">ast_set2_flag</a>(rtp, stun_enable ? 1 : 0, <a class="code" href="rtp_8c.html#a126661ec52d7d5caab56e2fbfd511d65">FLAG_HAS_STUN</a>);
<a name="l00824"></a>00824 }
<a name="l00825"></a>00825 
<a name="l00826"></a><a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">00826</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00827"></a>00827 {
<a name="l00828"></a>00828 <span class="preprocessor">#ifdef P2P_INTENSE</span>
<a name="l00829"></a>00829 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#ad941566de4050aa7358493af94d2ba4d">ast_mutex_lock</a>(&amp;rtp-&gt;bridge_lock);
<a name="l00830"></a>00830 <span class="preprocessor">#endif</span>
<a name="l00831"></a>00831 <span class="preprocessor"></span>   <span class="keywordflow">return</span>;
<a name="l00832"></a>00832 }
<a name="l00833"></a>00833 
<a name="l00834"></a><a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">00834</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l00835"></a>00835 {
<a name="l00836"></a>00836 <span class="preprocessor">#ifdef P2P_INTENSE</span>
<a name="l00837"></a>00837 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#aa9b39f0e22f44a7e7f587d4252e41a0b">ast_mutex_unlock</a>(&amp;rtp-&gt;bridge_lock);
<a name="l00838"></a>00838 <span class="preprocessor">#endif</span>
<a name="l00839"></a>00839 <span class="preprocessor"></span>   <span class="keywordflow">return</span>;
<a name="l00840"></a>00840 }
<a name="l00841"></a>00841 <span class="comment"></span>
<a name="l00842"></a>00842 <span class="comment">/*! \brief Calculate normal deviation */</span>
<a name="l00843"></a><a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561">00843</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561" title="Calculate normal deviation.">normdev_compute</a>(<span class="keywordtype">double</span> normdev, <span class="keywordtype">double</span> sample, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sample_count)
<a name="l00844"></a>00844 {
<a name="l00845"></a>00845    normdev = normdev * sample_count + sample;
<a name="l00846"></a>00846    sample_count++;
<a name="l00847"></a>00847 
<a name="l00848"></a>00848    <span class="keywordflow">return</span> normdev / sample_count;
<a name="l00849"></a>00849 }
<a name="l00850"></a>00850 
<a name="l00851"></a><a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">00851</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">stddev_compute</a>(<span class="keywordtype">double</span> stddev, <span class="keywordtype">double</span> sample, <span class="keywordtype">double</span> normdev, <span class="keywordtype">double</span> normdev_curent, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sample_count)
<a name="l00852"></a>00852 {
<a name="l00853"></a>00853 <span class="comment">/*</span>
<a name="l00854"></a>00854 <span class="comment">      for the formula check http://www.cs.umd.edu/~austinjp/constSD.pdf</span>
<a name="l00855"></a>00855 <span class="comment">      return sqrt( (sample_count*pow(stddev,2) + sample_count*pow((sample-normdev)/(sample_count+1),2) + pow(sample-normdev_curent,2)) / (sample_count+1));</span>
<a name="l00856"></a>00856 <span class="comment">      we can compute the sigma^2 and that way we would have to do the sqrt only 1 time at the end and would save another pow 2 compute</span>
<a name="l00857"></a>00857 <span class="comment">      optimized formula</span>
<a name="l00858"></a>00858 <span class="comment">*/</span>
<a name="l00859"></a>00859 <span class="preprocessor">#define SQUARE(x) ((x) * (x))</span>
<a name="l00860"></a>00860 <span class="preprocessor"></span>
<a name="l00861"></a>00861    stddev = sample_count * stddev;
<a name="l00862"></a>00862    sample_count++;
<a name="l00863"></a>00863 
<a name="l00864"></a>00864    <span class="keywordflow">return</span> stddev + 
<a name="l00865"></a>00865           ( sample_count * <a class="code" href="rtp_8c.html#aa1cf70a99e21bc2032e8867c6cafbb43">SQUARE</a>( (sample - normdev) / sample_count ) ) + 
<a name="l00866"></a>00866           ( <a class="code" href="rtp_8c.html#aa1cf70a99e21bc2032e8867c6cafbb43">SQUARE</a>(sample - normdev_curent) / sample_count );
<a name="l00867"></a>00867 
<a name="l00868"></a>00868 <span class="preprocessor">#undef SQUARE</span>
<a name="l00869"></a>00869 <span class="preprocessor"></span>}
<a name="l00870"></a>00870 
<a name="l00871"></a><a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">00871</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">enum</span> <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0" title="Frame types.">ast_frame_type</a> <a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l00872"></a>00872 {
<a name="l00873"></a>00873    <span class="keywordflow">if</span> (((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#a512509bde2176b98fbdcbceb1a528f6d">FLAG_DTMF_COMPENSATE</a>) &amp;&amp; type == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>) ||
<a name="l00874"></a>00874         (type == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>)) &amp;&amp; <a class="code" href="time_8h.html#acc9e13e54ed18f92956c748a38f82430" title="Compres two struct timeval instances returning -1, 0, 1 if the first arg is smaller...">ast_tvcmp</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), rtp-&gt;<a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a>) &lt; 0) {
<a name="l00875"></a>00875       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ignore potential DTMF echo from &apos;%s&apos;\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr));
<a name="l00876"></a>00876       rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = 0;
<a name="l00877"></a>00877       rtp-&gt;<a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a> = 0;
<a name="l00878"></a>00878       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l00879"></a>00879    }
<a name="l00880"></a>00880    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Sending dtmf: %d (%c), at %s\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr));
<a name="l00881"></a>00881    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> == <span class="charliteral">&apos;X&apos;</span>) {
<a name="l00882"></a>00882       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>;
<a name="l00883"></a>00883       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ae8f2cd460fdc81e0a774434fa002e4bf">AST_CONTROL_FLASH</a>;
<a name="l00884"></a>00884    } <span class="keywordflow">else</span> {
<a name="l00885"></a>00885       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = type;
<a name="l00886"></a>00886       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>;
<a name="l00887"></a>00887    }
<a name="l00888"></a>00888    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l00889"></a>00889    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l00890"></a>00890    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l00891"></a>00891    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;RTP&quot;</span>;
<a name="l00892"></a>00892    <span class="keywordflow">return</span> &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>;
<a name="l00893"></a>00893    
<a name="l00894"></a>00894 }
<a name="l00895"></a>00895 
<a name="l00896"></a><a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">00896</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(<span class="keyword">struct</span> sockaddr_in *addr)
<a name="l00897"></a>00897 {
<a name="l00898"></a>00898    <span class="keywordflow">if</span> (rtpdebug == 0)
<a name="l00899"></a>00899       <span class="keywordflow">return</span> 0;
<a name="l00900"></a>00900    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_addr.s_addr) {
<a name="l00901"></a>00901       <span class="keywordflow">if</span> (((ntohs(<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_port) != 0)
<a name="l00902"></a>00902            &amp;&amp; (<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_port != addr-&gt;sin_port))
<a name="l00903"></a>00903           || (<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_addr.s_addr != addr-&gt;sin_addr.s_addr))
<a name="l00904"></a>00904          <span class="keywordflow">return</span> 0;
<a name="l00905"></a>00905    }
<a name="l00906"></a>00906    <span class="keywordflow">return</span> 1;
<a name="l00907"></a>00907 }
<a name="l00908"></a>00908 
<a name="l00909"></a><a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">00909</a> <span class="keyword">static</span> <span class="keyword">inline</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(<span class="keyword">struct</span> sockaddr_in *addr)
<a name="l00910"></a>00910 {
<a name="l00911"></a>00911    <span class="keywordflow">if</span> (rtcpdebug == 0)
<a name="l00912"></a>00912       <span class="keywordflow">return</span> 0;
<a name="l00913"></a>00913    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_addr.s_addr) {
<a name="l00914"></a>00914       <span class="keywordflow">if</span> (((ntohs(<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_port) != 0)
<a name="l00915"></a>00915            &amp;&amp; (<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_port != addr-&gt;sin_port))
<a name="l00916"></a>00916           || (<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_addr.s_addr != addr-&gt;sin_addr.s_addr))
<a name="l00917"></a>00917          <span class="keywordflow">return</span> 0;
<a name="l00918"></a>00918    }
<a name="l00919"></a>00919    <span class="keywordflow">return</span> 1;
<a name="l00920"></a>00920 }
<a name="l00921"></a>00921 
<a name="l00922"></a>00922 
<a name="l00923"></a><a class="code" href="rtp_8c.html#a51335dc07892d8a1e1db2ffbaf1178cd">00923</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8c.html#a51335dc07892d8a1e1db2ffbaf1178cd">process_cisco_dtmf</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l00924"></a>00924 {
<a name="l00925"></a>00925    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> event;
<a name="l00926"></a>00926    <span class="keywordtype">char</span> resp = 0;
<a name="l00927"></a>00927    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l00928"></a>00928    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="app__sms_8c.html#a8514112da88a5d13451aaf8c9b064017">seq</a>;
<a name="l00929"></a>00929    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>;
<a name="l00930"></a>00930    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> power;
<a name="l00931"></a>00931 
<a name="l00932"></a>00932    <span class="comment">/* We should have at least 4 bytes in RTP data */</span>
<a name="l00933"></a>00933    <span class="keywordflow">if</span> (len &lt; 4)
<a name="l00934"></a>00934       <span class="keywordflow">return</span> f;
<a name="l00935"></a>00935 
<a name="l00936"></a>00936    <span class="comment">/* The format of Cisco RTP DTMF packet looks like next:</span>
<a name="l00937"></a>00937 <span class="comment">      +0          - sequence number of DTMF RTP packet (begins from 1,</span>
<a name="l00938"></a>00938 <span class="comment">                    wrapped to 0)</span>
<a name="l00939"></a>00939 <span class="comment">      +1          - set of flags</span>
<a name="l00940"></a>00940 <span class="comment">      +1 (bit 0)     - flaps by different DTMF digits delimited by audio</span>
<a name="l00941"></a>00941 <span class="comment">                    or repeated digit without audio???</span>
<a name="l00942"></a>00942 <span class="comment">      +2 (+4,+6,...) - power level? (rises from 0 to 32 at begin of tone</span>
<a name="l00943"></a>00943 <span class="comment">                    then falls to 0 at its end)</span>
<a name="l00944"></a>00944 <span class="comment">      +3 (+5,+7,...) - detected DTMF digit (0..9,*,#,A-D,...)</span>
<a name="l00945"></a>00945 <span class="comment">      Repeated DTMF information (bytes 4/5, 6/7) is history shifted right</span>
<a name="l00946"></a>00946 <span class="comment">      by each new packet and thus provides some redudancy.</span>
<a name="l00947"></a>00947 <span class="comment">      </span>
<a name="l00948"></a>00948 <span class="comment">      Sample of Cisco RTP DTMF packet is (all data in hex):</span>
<a name="l00949"></a>00949 <span class="comment">         19 07 00 02 12 02 20 02</span>
<a name="l00950"></a>00950 <span class="comment">      showing end of DTMF digit &apos;2&apos;.</span>
<a name="l00951"></a>00951 <span class="comment"></span>
<a name="l00952"></a>00952 <span class="comment">      The packets</span>
<a name="l00953"></a>00953 <span class="comment">         27 07 00 02 0A 02 20 02</span>
<a name="l00954"></a>00954 <span class="comment">         28 06 20 02 00 02 0A 02</span>
<a name="l00955"></a>00955 <span class="comment">      shows begin of new digit &apos;2&apos; with very short pause (20 ms) after</span>
<a name="l00956"></a>00956 <span class="comment">      previous digit &apos;2&apos;. Bit +1.0 flips at begin of new digit.</span>
<a name="l00957"></a>00957 <span class="comment">      </span>
<a name="l00958"></a>00958 <span class="comment">      Cisco RTP DTMF packets comes as replacement of audio RTP packets</span>
<a name="l00959"></a>00959 <span class="comment">      so its uses the same sequencing and timestamping rules as replaced</span>
<a name="l00960"></a>00960 <span class="comment">      audio packets. Repeat interval of DTMF packets is 20 ms and not rely</span>
<a name="l00961"></a>00961 <span class="comment">      on audio framing parameters. Marker bit isn&apos;t used within stream of</span>
<a name="l00962"></a>00962 <span class="comment">      DTMFs nor audio stream coming immediately after DTMF stream. Timestamps</span>
<a name="l00963"></a>00963 <span class="comment">      are not sequential at borders between DTMF and audio streams,</span>
<a name="l00964"></a>00964 <span class="comment">   */</span>
<a name="l00965"></a>00965 
<a name="l00966"></a>00966    seq = data[0];
<a name="l00967"></a>00967    flags = data[1];
<a name="l00968"></a>00968    power = data[2];
<a name="l00969"></a>00969    <span class="keyword">event</span> = data[3] &amp; 0x1f;
<a name="l00970"></a>00970 
<a name="l00971"></a>00971    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2 || rtpdebug)
<a name="l00972"></a>00972       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;Cisco DTMF Digit: %02x (len=%d, seq=%d, flags=%02x, power=%d, history count=%d)\n&quot;</span>, event, len, seq, flags, power, (len - 4) / 2);
<a name="l00973"></a>00973    <span class="keywordflow">if</span> (event &lt; 10) {
<a name="l00974"></a>00974       resp = <span class="charliteral">&apos;0&apos;</span> + event;
<a name="l00975"></a>00975    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 11) {
<a name="l00976"></a>00976       resp = <span class="charliteral">&apos;*&apos;</span>;
<a name="l00977"></a>00977    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 12) {
<a name="l00978"></a>00978       resp = <span class="charliteral">&apos;#&apos;</span>;
<a name="l00979"></a>00979    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 16) {
<a name="l00980"></a>00980       resp = <span class="charliteral">&apos;A&apos;</span> + (<span class="keyword">event</span> - 12);
<a name="l00981"></a>00981    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 17) {
<a name="l00982"></a>00982       resp = <span class="charliteral">&apos;X&apos;</span>;
<a name="l00983"></a>00983    }
<a name="l00984"></a>00984    <span class="keywordflow">if</span> ((!rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> &amp;&amp; power) || (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> &amp;&amp; (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> != resp))) {
<a name="l00985"></a>00985       rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = resp;
<a name="l00986"></a>00986       <span class="comment">/* Why we should care on DTMF compensation at reception? */</span>
<a name="l00987"></a>00987       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#a512509bde2176b98fbdcbceb1a528f6d">FLAG_DTMF_COMPENSATE</a>)) {
<a name="l00988"></a>00988          f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>);
<a name="l00989"></a>00989          rtp-&gt;<a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a> = 0;
<a name="l00990"></a>00990       }
<a name="l00991"></a>00991    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> == resp) &amp;&amp; !power) {
<a name="l00992"></a>00992       f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>);
<a name="l00993"></a>00993       f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a> * (<a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000);
<a name="l00994"></a>00994       rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = 0;
<a name="l00995"></a>00995    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> == resp)
<a name="l00996"></a>00996       rtp-&gt;<a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a> += 20 * (<a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000);
<a name="l00997"></a>00997    rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = dtmftimeout;
<a name="l00998"></a>00998    <span class="keywordflow">return</span> f;
<a name="l00999"></a>00999 }
<a name="l01000"></a>01000 <span class="comment"></span>
<a name="l01001"></a>01001 <span class="comment">/*! </span>
<a name="l01002"></a>01002 <span class="comment"> * \brief Process RTP DTMF and events according to RFC 2833.</span>
<a name="l01003"></a>01003 <span class="comment"> * </span>
<a name="l01004"></a>01004 <span class="comment"> * RFC 2833 is &quot;RTP Payload for DTMF Digits, Telephony Tones and Telephony Signals&quot;.</span>
<a name="l01005"></a>01005 <span class="comment"> * </span>
<a name="l01006"></a>01006 <span class="comment"> * \param rtp</span>
<a name="l01007"></a>01007 <span class="comment"> * \param data</span>
<a name="l01008"></a>01008 <span class="comment"> * \param len</span>
<a name="l01009"></a>01009 <span class="comment"> * \param seqno</span>
<a name="l01010"></a>01010 <span class="comment"> * \param timestamp</span>
<a name="l01011"></a>01011 <span class="comment"> * \returns</span>
<a name="l01012"></a>01012 <span class="comment"> */</span>
<a name="l01013"></a><a class="code" href="rtp_8c.html#ad58e8d31a0ace316b213e752c7939ac7">01013</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8c.html#ad58e8d31a0ace316b213e752c7939ac7" title="Process RTP DTMF and events according to RFC 2833.">process_rfc2833</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#ab793262012344621455faf9266acbac2">seqno</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestamp)
<a name="l01014"></a>01014 {
<a name="l01015"></a>01015    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> event;
<a name="l01016"></a>01016    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> event_end;
<a name="l01017"></a>01017    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l01018"></a>01018    <span class="keywordtype">char</span> resp = 0;
<a name="l01019"></a>01019    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l01020"></a>01020 
<a name="l01021"></a>01021    <span class="comment">/* Figure out event, event end, and samples */</span>
<a name="l01022"></a>01022    <span class="keyword">event</span> = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(data)));
<a name="l01023"></a>01023    <span class="keyword">event</span> &gt;&gt;= 24;
<a name="l01024"></a>01024    event_end = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(data)));
<a name="l01025"></a>01025    event_end &lt;&lt;= 8;
<a name="l01026"></a>01026    event_end &gt;&gt;= 24;
<a name="l01027"></a>01027    samples = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(data)));
<a name="l01028"></a>01028    samples &amp;= 0xFFFF;
<a name="l01029"></a>01029 
<a name="l01030"></a>01030    <span class="comment">/* Print out debug if turned on */</span>
<a name="l01031"></a>01031    <span class="keywordflow">if</span> (rtpdebug || <a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l01032"></a>01032       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;- RTP 2833 Event: %08x (len = %d)\n&quot;</span>, event, len);
<a name="l01033"></a>01033 
<a name="l01034"></a>01034    <span class="comment">/* Figure out what digit was pressed */</span>
<a name="l01035"></a>01035    <span class="keywordflow">if</span> (event &lt; 10) {
<a name="l01036"></a>01036       resp = <span class="charliteral">&apos;0&apos;</span> + event;
<a name="l01037"></a>01037    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 11) {
<a name="l01038"></a>01038       resp = <span class="charliteral">&apos;*&apos;</span>;
<a name="l01039"></a>01039    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 12) {
<a name="l01040"></a>01040       resp = <span class="charliteral">&apos;#&apos;</span>;
<a name="l01041"></a>01041    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 16) {
<a name="l01042"></a>01042       resp = <span class="charliteral">&apos;A&apos;</span> + (<span class="keyword">event</span> - 12);
<a name="l01043"></a>01043    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (event &lt; 17) {   <span class="comment">/* Event 16: Hook flash */</span>
<a name="l01044"></a>01044       resp = <span class="charliteral">&apos;X&apos;</span>; 
<a name="l01045"></a>01045    } <span class="keywordflow">else</span> {
<a name="l01046"></a>01046       <span class="comment">/* Not a supported event */</span>
<a name="l01047"></a>01047       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Ignoring RTP 2833 Event: %08x. Not a DTMF Digit.\n&quot;</span>, event);
<a name="l01048"></a>01048       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01049"></a>01049    }
<a name="l01050"></a>01050 
<a name="l01051"></a>01051    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#a512509bde2176b98fbdcbceb1a528f6d">FLAG_DTMF_COMPENSATE</a>)) {
<a name="l01052"></a>01052       <span class="keywordflow">if</span> ((rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> != timestamp) || (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> != resp)) {
<a name="l01053"></a>01053          rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = resp;
<a name="l01054"></a>01054          rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = 0;
<a name="l01055"></a>01055          f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>);
<a name="l01056"></a>01056          f-&gt;<a class="code" href="structast__frame.html#aaccba9d5adc3f6c39aad767db95ba484">len</a> = 0;
<a name="l01057"></a>01057          rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> = timestamp;
<a name="l01058"></a>01058       }
<a name="l01059"></a>01059    } <span class="keywordflow">else</span> {
<a name="l01060"></a>01060       <span class="comment">/*  The duration parameter measures the complete</span>
<a name="l01061"></a>01061 <span class="comment">          duration of the event (from the beginning) - RFC2833.</span>
<a name="l01062"></a>01062 <span class="comment">          Account for the fact that duration is only 16 bits long</span>
<a name="l01063"></a>01063 <span class="comment">          (about 8 seconds at 8000 Hz) and can wrap is digit</span>
<a name="l01064"></a>01064 <span class="comment">          is hold for too long. */</span>
<a name="l01065"></a>01065       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> new_duration = rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a>;
<a name="l01066"></a>01066       <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> last_duration = new_duration &amp; 0xFFFF;
<a name="l01067"></a>01067 
<a name="l01068"></a>01068       <span class="keywordflow">if</span> (last_duration &gt; 64000 &amp;&amp; samples &lt; last_duration)
<a name="l01069"></a>01069          new_duration += 0xFFFF + 1;
<a name="l01070"></a>01070       new_duration = (new_duration &amp; ~0xFFFF) | samples;
<a name="l01071"></a>01071 
<a name="l01072"></a>01072       <span class="keywordflow">if</span> (event_end &amp; 0x80) {
<a name="l01073"></a>01073          <span class="comment">/* End event */</span>
<a name="l01074"></a>01074          <span class="keywordflow">if</span> ((rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> != seqno) &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>) {
<a name="l01075"></a>01075             rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> = new_duration;
<a name="l01076"></a>01076             f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>);
<a name="l01077"></a>01077             f-&gt;<a class="code" href="structast__frame.html#aaccba9d5adc3f6c39aad767db95ba484">len</a> = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a>, <a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)), <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0));
<a name="l01078"></a>01078             rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = 0;
<a name="l01079"></a>01079             rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = 0;
<a name="l01080"></a>01080          }
<a name="l01081"></a>01081       } <span class="keywordflow">else</span> {
<a name="l01082"></a>01082          <span class="comment">/* Begin/continuation */</span>
<a name="l01083"></a>01083 
<a name="l01084"></a>01084          <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> != resp) {
<a name="l01085"></a>01085             <span class="comment">/* Another digit already began. End it */</span>
<a name="l01086"></a>01086             f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>);
<a name="l01087"></a>01087             f-&gt;<a class="code" href="structast__frame.html#aaccba9d5adc3f6c39aad767db95ba484">len</a> = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a>, <a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)), <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0));
<a name="l01088"></a>01088             rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = 0;
<a name="l01089"></a>01089             rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = 0;
<a name="l01090"></a>01090          }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092 
<a name="l01093"></a>01093          <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>) {
<a name="l01094"></a>01094             <span class="comment">/* Digit continues */</span>
<a name="l01095"></a>01095             rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> = new_duration;
<a name="l01096"></a>01096          } <span class="keywordflow">else</span> {
<a name="l01097"></a>01097             <span class="comment">/* New digit began */</span>
<a name="l01098"></a>01098             rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = resp;
<a name="l01099"></a>01099             f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>);
<a name="l01100"></a>01100             rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> = samples;
<a name="l01101"></a>01101          }
<a name="l01102"></a>01102 
<a name="l01103"></a>01103          rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = timestamp + rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> + dtmftimeout;
<a name="l01104"></a>01104       }
<a name="l01105"></a>01105 
<a name="l01106"></a>01106       rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> = seqno;
<a name="l01107"></a>01107    }
<a name="l01108"></a>01108 
<a name="l01109"></a>01109    rtp-&gt;<a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a> = samples;
<a name="l01110"></a>01110 
<a name="l01111"></a>01111    <span class="keywordflow">return</span> f;
<a name="l01112"></a>01112 }
<a name="l01113"></a>01113 <span class="comment"></span>
<a name="l01114"></a>01114 <span class="comment">/*!</span>
<a name="l01115"></a>01115 <span class="comment"> * \brief Process Comfort Noise RTP.</span>
<a name="l01116"></a>01116 <span class="comment"> * </span>
<a name="l01117"></a>01117 <span class="comment"> * This is incomplete at the moment.</span>
<a name="l01118"></a>01118 <span class="comment"> * </span>
<a name="l01119"></a>01119 <span class="comment">*/</span>
<a name="l01120"></a><a class="code" href="rtp_8c.html#a663c1a4adafaed5f3c26b2a0c0735365">01120</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8c.html#a663c1a4adafaed5f3c26b2a0c0735365" title="Process Comfort Noise RTP.">process_rfc3389</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>)
<a name="l01121"></a>01121 {
<a name="l01122"></a>01122    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l01123"></a>01123    <span class="comment">/* Convert comfort noise into audio with various codecs.  Unfortunately this doesn&apos;t</span>
<a name="l01124"></a>01124 <span class="comment">      totally help us out becuase we don&apos;t have an engine to keep it going and we are not</span>
<a name="l01125"></a>01125 <span class="comment">      guaranteed to have it every 20ms or anything */</span>
<a name="l01126"></a>01126    <span class="keywordflow">if</span> (rtpdebug)
<a name="l01127"></a>01127       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;- RTP 3389 Comfort noise event: Level %d (len = %d)\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#ac39112ee85d1c736329776a40537daf9">lastrxformat</a>, len);
<a name="l01128"></a>01128 
<a name="l01129"></a>01129    <span class="keywordflow">if</span> (!(<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8h.html#a1b696f676e4e78260e3356973f647034">FLAG_3389_WARNING</a>))) {
<a name="l01130"></a>01130       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Comfort noise support incomplete in Asterisk (RFC 3389). Please turn off on client if possible. Client IP: %s\n&quot;</span>,
<a name="l01131"></a>01131          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr));
<a name="l01132"></a>01132       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8h.html#a1b696f676e4e78260e3356973f647034">FLAG_3389_WARNING</a>);
<a name="l01133"></a>01133    }
<a name="l01134"></a>01134    
<a name="l01135"></a>01135    <span class="comment">/* Must have at least one byte */</span>
<a name="l01136"></a>01136    <span class="keywordflow">if</span> (!len)
<a name="l01137"></a>01137       <span class="keywordflow">return</span> NULL;
<a name="l01138"></a>01138    <span class="keywordflow">if</span> (len &lt; 24) {
<a name="l01139"></a>01139       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l01140"></a>01140       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = len - 1;
<a name="l01141"></a>01141       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l01142"></a>01142       memcpy(rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, data + 1, len - 1);
<a name="l01143"></a>01143    } <span class="keywordflow">else</span> {
<a name="l01144"></a>01144       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = NULL;
<a name="l01145"></a>01145       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = 0;
<a name="l01146"></a>01146       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l01147"></a>01147    }
<a name="l01148"></a>01148    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a8089c2a7198a1063db9e6c3f904482a4">AST_FRAME_CNG</a>;
<a name="l01149"></a>01149    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = data[0] &amp; 0x7f;
<a name="l01150"></a>01150    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l01151"></a>01151    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>.tv_usec = rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>.tv_sec = 0;
<a name="l01152"></a>01152    f = &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>;
<a name="l01153"></a>01153    <span class="keywordflow">return</span> f;
<a name="l01154"></a>01154 }
<a name="l01155"></a>01155 
<a name="l01156"></a><a class="code" href="rtp_8c.html#acc27c454a55b589c7a228a8d78542db3">01156</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#acc27c454a55b589c7a228a8d78542db3">rtpread</a>(<span class="keywordtype">int</span> *<span class="keywordtype">id</span>, <span class="keywordtype">int</span> fd, <span class="keywordtype">short</span> <a class="code" href="app__adsiprog_8c.html#a31547b3fbfe860fc4518ce2332297f9b">events</a>, <span class="keywordtype">void</span> *cbdata)
<a name="l01157"></a>01157 {
<a name="l01158"></a>01158    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = cbdata;
<a name="l01159"></a>01159    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01160"></a>01160    f = <a class="code" href="rtp_8h.html#ac0a9d31f175e3de83fa1dda629c11674">ast_rtp_read</a>(rtp);
<a name="l01161"></a>01161    <span class="keywordflow">if</span> (f) {
<a name="l01162"></a>01162       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#ac7c7a9968aa83f15b39dfe8fd533fd34">callback</a>)
<a name="l01163"></a>01163          rtp-&gt;<a class="code" href="structast__rtp.html#ac7c7a9968aa83f15b39dfe8fd533fd34">callback</a>(rtp, f, rtp-&gt;<a class="code" href="structast__rtp.html#a735984d41155bc1032e09bece8f8d66d">data</a>);
<a name="l01164"></a>01164    }
<a name="l01165"></a>01165    <span class="keywordflow">return</span> 1;
<a name="l01166"></a>01166 }
<a name="l01167"></a>01167 
<a name="l01168"></a><a class="code" href="rtp_8c.html#ad2add11e197fbff70b7ff710f90e617f">01168</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8h.html#ad2add11e197fbff70b7ff710f90e617f">ast_rtcp_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l01169"></a>01169 {
<a name="l01170"></a>01170    socklen_t <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01171"></a>01171    <span class="keywordtype">int</span> position, i, packetwords;
<a name="l01172"></a>01172    <span class="keywordtype">int</span> res;
<a name="l01173"></a>01173    <span class="keyword">struct </span>sockaddr_in sock_in;
<a name="l01174"></a>01174    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> rtcpdata[8192 + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>];
<a name="l01175"></a>01175    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtcpheader;
<a name="l01176"></a>01176    <span class="keywordtype">int</span> pt;
<a name="l01177"></a>01177    <span class="keyword">struct </span>timeval now;
<a name="l01178"></a>01178    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> length;
<a name="l01179"></a>01179    <span class="keywordtype">int</span> rc;
<a name="l01180"></a>01180    <span class="keywordtype">double</span> rttsec;
<a name="l01181"></a>01181    uint64_t rtt = 0;
<a name="l01182"></a>01182    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> dlsr;
<a name="l01183"></a>01183    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lsr;
<a name="l01184"></a>01184    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> msw;
<a name="l01185"></a>01185    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lsw;
<a name="l01186"></a>01186    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> comp;
<a name="l01187"></a>01187    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01188"></a>01188    
<a name="l01189"></a>01189    <span class="keywordtype">double</span> reported_jitter;
<a name="l01190"></a>01190    <span class="keywordtype">double</span> reported_normdev_jitter_current;
<a name="l01191"></a>01191    <span class="keywordtype">double</span> normdevrtt_current;
<a name="l01192"></a>01192    <span class="keywordtype">double</span> reported_lost;
<a name="l01193"></a>01193    <span class="keywordtype">double</span> reported_normdev_lost_current;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195    <span class="keywordflow">if</span> (!rtp || !rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>)
<a name="l01196"></a>01196       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01197"></a>01197 
<a name="l01198"></a>01198    len = <span class="keyword">sizeof</span>(sock_in);
<a name="l01199"></a>01199    
<a name="l01200"></a>01200    res = recvfrom(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>, rtcpdata + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>, <span class="keyword">sizeof</span>(rtcpdata) - <span class="keyword">sizeof</span>(<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) * <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>,
<a name="l01201"></a>01201                0, (<span class="keyword">struct</span> sockaddr *)&amp;sock_in, &amp;len);
<a name="l01202"></a>01202    rtcpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(rtcpdata + AST_FRIENDLY_OFFSET);
<a name="l01203"></a>01203    
<a name="l01204"></a>01204    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01205"></a>01205       <a class="code" href="utils_8h.html#a24374da24af1931d8a7ccde5b352bb2c">ast_assert</a>(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EBADF);
<a name="l01206"></a>01206       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EAGAIN) {
<a name="l01207"></a>01207          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RTCP Read error: %s.  Hanging up.\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01208"></a>01208          <span class="keywordflow">return</span> NULL;
<a name="l01209"></a>01209       }
<a name="l01210"></a>01210       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01211"></a>01211    }
<a name="l01212"></a>01212 
<a name="l01213"></a>01213    packetwords = res / 4;
<a name="l01214"></a>01214    
<a name="l01215"></a>01215    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a>) {
<a name="l01216"></a>01216       <span class="comment">/* Send to whoever sent to us */</span>
<a name="l01217"></a>01217       <span class="keywordflow">if</span> (((rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr != sock_in.sin_addr.s_addr) ||
<a name="l01218"></a>01218           (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port != sock_in.sin_port)) &amp;&amp; 
<a name="l01219"></a>01219           ((rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_addr.s_addr != sock_in.sin_addr.s_addr) || 
<a name="l01220"></a>01220           (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_port != sock_in.sin_port))) {
<a name="l01221"></a>01221          memcpy(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, &amp;sock_in, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l01222"></a>01222          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l01223"></a>01223             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;RTCP NAT: Got RTCP from other end. Now sending to address %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l01224"></a>01224       }
<a name="l01225"></a>01225    }
<a name="l01226"></a>01226 
<a name="l01227"></a>01227    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got RTCP report of %d bytes\n&quot;</span>, res);
<a name="l01228"></a>01228 
<a name="l01229"></a>01229    <span class="comment">/* Process a compound packet */</span>
<a name="l01230"></a>01230    position = 0;
<a name="l01231"></a>01231    <span class="keywordflow">while</span> (position &lt; packetwords) {
<a name="l01232"></a>01232       i = position;
<a name="l01233"></a>01233       length = ntohl(rtcpheader[i]);
<a name="l01234"></a>01234       pt = (length &amp; 0xff0000) &gt;&gt; 16;
<a name="l01235"></a>01235       rc = (length &amp; 0x1f000000) &gt;&gt; 24;
<a name="l01236"></a>01236       length &amp;= 0xffff;
<a name="l01237"></a>01237  
<a name="l01238"></a>01238       <span class="keywordflow">if</span> ((i + length) &gt; packetwords) {
<a name="l01239"></a>01239          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l01240"></a>01240             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;RTCP Read too short\n&quot;</span>);
<a name="l01241"></a>01241          <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01242"></a>01242       }
<a name="l01243"></a>01243       
<a name="l01244"></a>01244       <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in)) {
<a name="l01245"></a>01245          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\n\nGot RTCP from %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sock_in.sin_addr), ntohs(sock_in.sin_port));
<a name="l01246"></a>01246          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;PT: %d(%s)\n&quot;</span>, pt, (pt == 200) ? <span class="stringliteral">&quot;Sender Report&quot;</span> : (pt == 201) ? <span class="stringliteral">&quot;Receiver Report&quot;</span> : (pt == 192) ? <span class="stringliteral">&quot;H.261 FUR&quot;</span> : <span class="stringliteral">&quot;Unknown&quot;</span>);
<a name="l01247"></a>01247          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Reception reports: %d\n&quot;</span>, rc);
<a name="l01248"></a>01248          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;SSRC of sender: %u\n&quot;</span>, rtcpheader[i + 1]);
<a name="l01249"></a>01249       }
<a name="l01250"></a>01250  
<a name="l01251"></a>01251       i += 2; <span class="comment">/* Advance past header and ssrc */</span>
<a name="l01252"></a>01252       
<a name="l01253"></a>01253       <span class="keywordflow">switch</span> (pt) {
<a name="l01254"></a>01254       <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#abe50a9d9c36c702889863e206f4502c6">RTCP_PT_SR</a>:
<a name="l01255"></a>01255          gettimeofday(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad96a304ae7c0f3dd877c1db41a5a668e">rxlsr</a>,NULL); <span class="comment">/* To be able to populate the dlsr */</span>
<a name="l01256"></a>01256          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a959172bce678fc4a84719bd16af5ae2b">spc</a> = ntohl(rtcpheader[i+3]);
<a name="l01257"></a>01257          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a5559c53d2e48d42237cc342fff7dab72">soc</a> = ntohl(rtcpheader[i + 4]);
<a name="l01258"></a>01258          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a> = ((ntohl(rtcpheader[i]) &amp; 0x0000ffff) &lt;&lt; 16) | ((ntohl(rtcpheader[i + 1]) &amp; 0xffff0000) &gt;&gt; 16); <span class="comment">/* Going to LSR in RR*/</span>
<a name="l01259"></a>01259  
<a name="l01260"></a>01260          <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in)) {
<a name="l01261"></a>01261             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;NTP timestamp: %lu.%010lu\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i]), (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 1]) * 4096);
<a name="l01262"></a>01262             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;RTP timestamp: %lu\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 2]));
<a name="l01263"></a>01263             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;SPC: %lu\tSOC: %lu\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 3]), (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]));
<a name="l01264"></a>01264          }
<a name="l01265"></a>01265          i += 5;
<a name="l01266"></a>01266          <span class="keywordflow">if</span> (rc &lt; 1)
<a name="l01267"></a>01267             <span class="keywordflow">break</span>;
<a name="l01268"></a>01268          <span class="comment">/* Intentional fall through */</span>
<a name="l01269"></a>01269       <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a4d8564f9c96df1cd1076ad4f6faed7ab">RTCP_PT_RR</a>:
<a name="l01270"></a>01270          <span class="comment">/* Don&apos;t handle multiple reception reports (rc &gt; 1) yet */</span>
<a name="l01271"></a>01271          <span class="comment">/* Calculate RTT per RFC */</span>
<a name="l01272"></a>01272          gettimeofday(&amp;now, NULL);
<a name="l01273"></a>01273          <a class="code" href="rtp_8c.html#ae07b5d23a23d4d09988c4a1c5d477d14">timeval2ntp</a>(now, &amp;msw, &amp;lsw);
<a name="l01274"></a>01274          <span class="keywordflow">if</span> (ntohl(rtcpheader[i + 4]) &amp;&amp; ntohl(rtcpheader[i + 5])) { <span class="comment">/* We must have the LSR &amp;&amp; DLSR */</span>
<a name="l01275"></a>01275             comp = ((msw &amp; 0xffff) &lt;&lt; 16) | ((lsw &amp; 0xffff0000) &gt;&gt; 16);
<a name="l01276"></a>01276             lsr = ntohl(rtcpheader[i + 4]);
<a name="l01277"></a>01277             dlsr = ntohl(rtcpheader[i + 5]);
<a name="l01278"></a>01278             rtt = comp - lsr - dlsr;
<a name="l01279"></a>01279 
<a name="l01280"></a>01280             <span class="comment">/* Convert end to end delay to usec (keeping the calculation in 64bit space)</span>
<a name="l01281"></a>01281 <span class="comment">               sess-&gt;ee_delay = (eedelay * 1000) / 65536; */</span>
<a name="l01282"></a>01282             <span class="keywordflow">if</span> (rtt &lt; 4294) {
<a name="l01283"></a>01283                 rtt = (rtt * 1000000) &gt;&gt; 16;
<a name="l01284"></a>01284             } <span class="keywordflow">else</span> {
<a name="l01285"></a>01285                 rtt = (rtt * 1000) &gt;&gt; 16;
<a name="l01286"></a>01286                 rtt *= 1000;
<a name="l01287"></a>01287             }
<a name="l01288"></a>01288             rtt = rtt / 1000.;
<a name="l01289"></a>01289             rttsec = rtt / 1000.;
<a name="l01290"></a>01290             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a> = rttsec;
<a name="l01291"></a>01291 
<a name="l01292"></a>01292             <span class="keywordflow">if</span> (comp - dlsr &gt;= lsr) {
<a name="l01293"></a>01293                rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a8e759d4e39d3d6531987a55158af3c40">accumulated_transit</a> += rttsec;
<a name="l01294"></a>01294 
<a name="l01295"></a>01295                <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab11c205b744d7793062ac51aea74b122">rtt_count</a> == 0) 
<a name="l01296"></a>01296                   rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">minrtt</a> = rttsec;
<a name="l01297"></a>01297 
<a name="l01298"></a>01298                <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad9e0112e5a3834937c4f84604c175ba6">maxrtt</a>&lt;rttsec)
<a name="l01299"></a>01299                   rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad9e0112e5a3834937c4f84604c175ba6">maxrtt</a> = rttsec;
<a name="l01300"></a>01300 
<a name="l01301"></a>01301                <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">minrtt</a>&gt;rttsec)
<a name="l01302"></a>01302                   rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">minrtt</a> = rttsec;
<a name="l01303"></a>01303 
<a name="l01304"></a>01304                normdevrtt_current = <a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561" title="Calculate normal deviation.">normdev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">normdevrtt</a>, rttsec, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab11c205b744d7793062ac51aea74b122">rtt_count</a>);
<a name="l01305"></a>01305 
<a name="l01306"></a>01306                rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a484c5279646a0804e4beba6b3f0828c9">stdevrtt</a> = <a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">stddev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a484c5279646a0804e4beba6b3f0828c9">stdevrtt</a>, rttsec, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">normdevrtt</a>, normdevrtt_current, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab11c205b744d7793062ac51aea74b122">rtt_count</a>);
<a name="l01307"></a>01307 
<a name="l01308"></a>01308                rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">normdevrtt</a> = normdevrtt_current;
<a name="l01309"></a>01309 
<a name="l01310"></a>01310                rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab11c205b744d7793062ac51aea74b122">rtt_count</a>++;
<a name="l01311"></a>01311             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in)) {
<a name="l01312"></a>01312                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Internal RTCP NTP clock skew detected: &quot;</span>
<a name="l01313"></a>01313                         <span class="stringliteral">&quot;lsr=%u, now=%u, dlsr=%u (%d:%03dms), &quot;</span>
<a name="l01314"></a>01314                         <span class="stringliteral">&quot;diff=%d\n&quot;</span>,
<a name="l01315"></a>01315                         lsr, comp, dlsr, dlsr / 65536,
<a name="l01316"></a>01316                         (dlsr % 65536) * 1000 / 65536,
<a name="l01317"></a>01317                         dlsr - (comp - lsr));
<a name="l01318"></a>01318             }
<a name="l01319"></a>01319          }
<a name="l01320"></a>01320 
<a name="l01321"></a>01321          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a> = ntohl(rtcpheader[i + 3]);
<a name="l01322"></a>01322          reported_jitter = (double) rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a>;
<a name="l01323"></a>01323 
<a name="l01324"></a>01324          if (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a> == 0) 
<a name="l01325"></a>01325             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ace87dcab8278d048a1aec3c529aae3e8">reported_minjitter</a> = reported_jitter;
<a name="l01326"></a>01326 
<a name="l01327"></a>01327          <span class="keywordflow">if</span> (reported_jitter &lt; rtp-&gt;rtcp-&gt;reported_minjitter) 
<a name="l01328"></a>01328             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ace87dcab8278d048a1aec3c529aae3e8">reported_minjitter</a> = reported_jitter;
<a name="l01329"></a>01329 
<a name="l01330"></a>01330          <span class="keywordflow">if</span> (reported_jitter &gt; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a30d52d11d41c2eb613686f33a5decc9c">reported_maxjitter</a>) 
<a name="l01331"></a>01331             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a30d52d11d41c2eb613686f33a5decc9c">reported_maxjitter</a> = reported_jitter;
<a name="l01332"></a>01332 
<a name="l01333"></a>01333          reported_normdev_jitter_current = <a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561" title="Calculate normal deviation.">normdev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">reported_normdev_jitter</a>, reported_jitter, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a>);
<a name="l01334"></a>01334 
<a name="l01335"></a>01335          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a752c1c70fc3a23f882d1c59da8dde021">reported_stdev_jitter</a> = <a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">stddev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a752c1c70fc3a23f882d1c59da8dde021">reported_stdev_jitter</a>, reported_jitter, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">reported_normdev_jitter</a>, reported_normdev_jitter_current, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a>);
<a name="l01336"></a>01336 
<a name="l01337"></a>01337          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">reported_normdev_jitter</a> = reported_normdev_jitter_current;
<a name="l01338"></a>01338 
<a name="l01339"></a>01339          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a> = ntohl(rtcpheader[i + 1]) &amp; 0xffffff;
<a name="l01340"></a>01340 
<a name="l01341"></a>01341          reported_lost = (double) rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>;
<a name="l01342"></a>01342 
<a name="l01343"></a>01343          <span class="comment">/* using same counter as for jitter */</span>
<a name="l01344"></a>01344          if (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a> == 0)
<a name="l01345"></a>01345             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a336c76200bd6e5390ae94cc780e602b6">reported_minlost</a> = reported_lost;
<a name="l01346"></a>01346 
<a name="l01347"></a>01347          <span class="keywordflow">if</span> (reported_lost &lt; rtp-&gt;rtcp-&gt;reported_minlost)
<a name="l01348"></a>01348             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a336c76200bd6e5390ae94cc780e602b6">reported_minlost</a> = reported_lost;
<a name="l01349"></a>01349 
<a name="l01350"></a>01350          <span class="keywordflow">if</span> (reported_lost &gt; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abbf709761c24a05feba0f0dc2ee23b31">reported_maxlost</a>) 
<a name="l01351"></a>01351             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abbf709761c24a05feba0f0dc2ee23b31">reported_maxlost</a> = reported_lost;
<a name="l01352"></a>01352 
<a name="l01353"></a>01353          reported_normdev_lost_current = <a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561" title="Calculate normal deviation.">normdev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a326f467bbb9a1439c7c2295e7965a9b1">reported_normdev_lost</a>, reported_lost, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a>);
<a name="l01354"></a>01354 
<a name="l01355"></a>01355          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a90913f9d1e572535345617ac4d9ae2a4">reported_stdev_lost</a> = <a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">stddev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a90913f9d1e572535345617ac4d9ae2a4">reported_stdev_lost</a>, reported_lost, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a326f467bbb9a1439c7c2295e7965a9b1">reported_normdev_lost</a>, reported_normdev_lost_current, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a>);
<a name="l01356"></a>01356 
<a name="l01357"></a>01357          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a326f467bbb9a1439c7c2295e7965a9b1">reported_normdev_lost</a> = reported_normdev_lost_current;
<a name="l01358"></a>01358 
<a name="l01359"></a>01359          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a82658051e9c12f5af4d0969a497d2319">reported_jitter_count</a>++;
<a name="l01360"></a>01360 
<a name="l01361"></a>01361          <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in)) {
<a name="l01362"></a>01362             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Fraction lost: %ld\n&quot;</span>, (((<span class="keywordtype">long</span>) ntohl(rtcpheader[i + 1]) &amp; 0xff000000) &gt;&gt; 24));
<a name="l01363"></a>01363             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Packets lost so far: %d\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>);
<a name="l01364"></a>01364             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Highest sequence number: %ld\n&quot;</span>, (<span class="keywordtype">long</span>) (ntohl(rtcpheader[i + 2]) &amp; 0xffff));
<a name="l01365"></a>01365             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Sequence number cycles: %ld\n&quot;</span>, (<span class="keywordtype">long</span>) (ntohl(rtcpheader[i + 2]) &amp; 0xffff) &gt;&gt; 16);
<a name="l01366"></a>01366             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Interarrival jitter: %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a>);
<a name="l01367"></a>01367             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Last SR(our NTP): %lu.%010lu\n&quot;</span>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]) &gt;&gt; 16,((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]) &lt;&lt; 16) * 4096);
<a name="l01368"></a>01368             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  DLSR: %4.4f (sec)\n&quot;</span>,ntohl(rtcpheader[i + 5])/65536.0);
<a name="l01369"></a>01369             <span class="keywordflow">if</span> (rtt)
<a name="l01370"></a>01370                <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  RTT: %lu(sec)\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) rtt);
<a name="l01371"></a>01371          }
<a name="l01372"></a>01372 
<a name="l01373"></a>01373          <span class="keywordflow">if</span> (rtt) {
<a name="l01374"></a>01374             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <span class="stringliteral">&quot;RTCPReceived&quot;</span>, <span class="stringliteral">&quot;From: %s:%d\r\n&quot;</span>
<a name="l01375"></a>01375                             <span class="stringliteral">&quot;PT: %d(%s)\r\n&quot;</span>
<a name="l01376"></a>01376                             <span class="stringliteral">&quot;ReceptionReports: %d\r\n&quot;</span>
<a name="l01377"></a>01377                             <span class="stringliteral">&quot;SenderSSRC: %u\r\n&quot;</span>
<a name="l01378"></a>01378                             <span class="stringliteral">&quot;FractionLost: %ld\r\n&quot;</span>
<a name="l01379"></a>01379                             <span class="stringliteral">&quot;PacketsLost: %d\r\n&quot;</span>
<a name="l01380"></a>01380                             <span class="stringliteral">&quot;HighestSequence: %ld\r\n&quot;</span>
<a name="l01381"></a>01381                             <span class="stringliteral">&quot;SequenceNumberCycles: %ld\r\n&quot;</span>
<a name="l01382"></a>01382                             <span class="stringliteral">&quot;IAJitter: %u\r\n&quot;</span>
<a name="l01383"></a>01383                             <span class="stringliteral">&quot;LastSR: %lu.%010lu\r\n&quot;</span>
<a name="l01384"></a>01384                             <span class="stringliteral">&quot;DLSR: %4.4f(sec)\r\n&quot;</span>
<a name="l01385"></a>01385                             <span class="stringliteral">&quot;RTT: %llu(sec)\r\n&quot;</span>,
<a name="l01386"></a>01386                             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sock_in.sin_addr), ntohs(sock_in.sin_port),
<a name="l01387"></a>01387                             pt, (pt == 200) ? <span class="stringliteral">&quot;Sender Report&quot;</span> : (pt == 201) ? <span class="stringliteral">&quot;Receiver Report&quot;</span> : (pt == 192) ? <span class="stringliteral">&quot;H.261 FUR&quot;</span> : <span class="stringliteral">&quot;Unknown&quot;</span>,
<a name="l01388"></a>01388                             rc,
<a name="l01389"></a>01389                             rtcpheader[i + 1],
<a name="l01390"></a>01390                             (((<span class="keywordtype">long</span>) ntohl(rtcpheader[i + 1]) &amp; 0xff000000) &gt;&gt; 24),
<a name="l01391"></a>01391                             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>,
<a name="l01392"></a>01392                             (<span class="keywordtype">long</span>) (ntohl(rtcpheader[i + 2]) &amp; 0xffff),
<a name="l01393"></a>01393                             (<span class="keywordtype">long</span>) (ntohl(rtcpheader[i + 2]) &amp; 0xffff) &gt;&gt; 16,
<a name="l01394"></a>01394                             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a>,
<a name="l01395"></a>01395                             (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]) &gt;&gt; 16, ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]) &lt;&lt; 16) * 4096,
<a name="l01396"></a>01396                             ntohl(rtcpheader[i + 5])/65536.0,
<a name="l01397"></a>01397                             (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> <span class="keywordtype">long</span>)rtt);
<a name="l01398"></a>01398          } <span class="keywordflow">else</span> {
<a name="l01399"></a>01399             <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <span class="stringliteral">&quot;RTCPReceived&quot;</span>, <span class="stringliteral">&quot;From: %s:%d\r\n&quot;</span>
<a name="l01400"></a>01400                             <span class="stringliteral">&quot;PT: %d(%s)\r\n&quot;</span>
<a name="l01401"></a>01401                             <span class="stringliteral">&quot;ReceptionReports: %d\r\n&quot;</span>
<a name="l01402"></a>01402                             <span class="stringliteral">&quot;SenderSSRC: %u\r\n&quot;</span>
<a name="l01403"></a>01403                             <span class="stringliteral">&quot;FractionLost: %ld\r\n&quot;</span>
<a name="l01404"></a>01404                             <span class="stringliteral">&quot;PacketsLost: %d\r\n&quot;</span>
<a name="l01405"></a>01405                             <span class="stringliteral">&quot;HighestSequence: %ld\r\n&quot;</span>
<a name="l01406"></a>01406                             <span class="stringliteral">&quot;SequenceNumberCycles: %ld\r\n&quot;</span>
<a name="l01407"></a>01407                             <span class="stringliteral">&quot;IAJitter: %u\r\n&quot;</span>
<a name="l01408"></a>01408                             <span class="stringliteral">&quot;LastSR: %lu.%010lu\r\n&quot;</span>
<a name="l01409"></a>01409                             <span class="stringliteral">&quot;DLSR: %4.4f(sec)\r\n&quot;</span>,
<a name="l01410"></a>01410                             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sock_in.sin_addr), ntohs(sock_in.sin_port),
<a name="l01411"></a>01411                             pt, (pt == 200) ? <span class="stringliteral">&quot;Sender Report&quot;</span> : (pt == 201) ? <span class="stringliteral">&quot;Receiver Report&quot;</span> : (pt == 192) ? <span class="stringliteral">&quot;H.261 FUR&quot;</span> : <span class="stringliteral">&quot;Unknown&quot;</span>,
<a name="l01412"></a>01412                             rc,
<a name="l01413"></a>01413                             rtcpheader[i + 1],
<a name="l01414"></a>01414                             (((<span class="keywordtype">long</span>) ntohl(rtcpheader[i + 1]) &amp; 0xff000000) &gt;&gt; 24),
<a name="l01415"></a>01415                             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>,
<a name="l01416"></a>01416                             (<span class="keywordtype">long</span>) (ntohl(rtcpheader[i + 2]) &amp; 0xffff),
<a name="l01417"></a>01417                             (<span class="keywordtype">long</span>) (ntohl(rtcpheader[i + 2]) &amp; 0xffff) &gt;&gt; 16,
<a name="l01418"></a>01418                             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a>,
<a name="l01419"></a>01419                             (<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]) &gt;&gt; 16,
<a name="l01420"></a>01420                             ((<span class="keywordtype">unsigned</span> <span class="keywordtype">long</span>) ntohl(rtcpheader[i + 4]) &lt;&lt; 16) * 4096,
<a name="l01421"></a>01421                             ntohl(rtcpheader[i + 5])/65536.0);
<a name="l01422"></a>01422          }
<a name="l01423"></a>01423          <span class="keywordflow">break</span>;
<a name="l01424"></a>01424       <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a38fce7504b6d0ac96b1f07fa86598ce8">RTCP_PT_FUR</a>:
<a name="l01425"></a>01425          <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in))
<a name="l01426"></a>01426             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Received an RTCP Fast Update Request\n&quot;</span>);
<a name="l01427"></a>01427          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>;
<a name="l01428"></a>01428          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>;
<a name="l01429"></a>01429          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l01430"></a>01430          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = 0;
<a name="l01431"></a>01431          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l01432"></a>01432          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;RTP&quot;</span>;
<a name="l01433"></a>01433          f = &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>;
<a name="l01434"></a>01434          <span class="keywordflow">break</span>;
<a name="l01435"></a>01435       <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#aa6a84235b636497872f31a832a8b17af">RTCP_PT_SDES</a>:
<a name="l01436"></a>01436          <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in))
<a name="l01437"></a>01437             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Received an SDES from %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l01438"></a>01438          <span class="keywordflow">break</span>;
<a name="l01439"></a>01439       <span class="keywordflow">case</span> <a class="code" href="rtp_8c.html#a5723708baf43b6326706331795fcd52f">RTCP_PT_BYE</a>:
<a name="l01440"></a>01440          <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;sock_in))
<a name="l01441"></a>01441             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Received a BYE from %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l01442"></a>01442          <span class="keywordflow">break</span>;
<a name="l01443"></a>01443       <span class="keywordflow">default</span>:
<a name="l01444"></a>01444          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Unknown RTCP packet (pt=%d) received from %s:%d\n&quot;</span>, pt, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l01445"></a>01445          <span class="keywordflow">break</span>;
<a name="l01446"></a>01446       }
<a name="l01447"></a>01447       position += (length + 1);
<a name="l01448"></a>01448    }
<a name="l01449"></a>01449    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">rtcp_info</a> = 1;  
<a name="l01450"></a>01450    <span class="keywordflow">return</span> f;
<a name="l01451"></a>01451 }
<a name="l01452"></a>01452 
<a name="l01453"></a><a class="code" href="rtp_8c.html#a6134fd2180fca7829793af724a013344">01453</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#a6134fd2180fca7829793af724a013344">calc_rxstamp</a>(<span class="keyword">struct</span> timeval *when, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestamp, <span class="keywordtype">int</span> mark)
<a name="l01454"></a>01454 {
<a name="l01455"></a>01455    <span class="keyword">struct </span>timeval now;
<a name="l01456"></a>01456    <span class="keyword">struct </span>timeval tmp;
<a name="l01457"></a>01457    <span class="keywordtype">double</span> transit;
<a name="l01458"></a>01458    <span class="keywordtype">double</span> current_time;
<a name="l01459"></a>01459    <span class="keywordtype">double</span> d;
<a name="l01460"></a>01460    <span class="keywordtype">double</span> dtv;
<a name="l01461"></a>01461    <span class="keywordtype">double</span> prog;
<a name="l01462"></a>01462    <span class="keywordtype">double</span> normdev_rxjitter_current;
<a name="l01463"></a>01463    <span class="keywordtype">int</span> rate = <a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>);
<a name="l01464"></a>01464 
<a name="l01465"></a>01465    <span class="keywordflow">if</span> ((!rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_sec &amp;&amp; !rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec) || mark) {
<a name="l01466"></a>01466       gettimeofday(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, NULL);
<a name="l01467"></a>01467       rtp-&gt;<a class="code" href="structast__rtp.html#aa0016ad6315851ed2b2f45f38b72d4e2">drxcore</a> = (double) rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_sec + (<span class="keywordtype">double</span>) rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec / 1000000;
<a name="l01468"></a>01468       <span class="comment">/* map timestamp to a real time */</span>
<a name="l01469"></a>01469       rtp-&gt;<a class="code" href="structast__rtp.html#aa9d357f51d7983d9a150c8c433306f7c">seedrxts</a> = timestamp; <span class="comment">/* Their RTP timestamp started with this */</span>
<a name="l01470"></a>01470       tmp = <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(timestamp, rate);
<a name="l01471"></a>01471       rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a> = <a class="code" href="time_8h.html#aa13b651c18bc6004cab21ac041d44dd8" title="Returns the difference of two timevals a - b.">ast_tvsub</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, tmp);
<a name="l01472"></a>01472       <span class="comment">/* Round to 0.1ms for nice, pretty timestamps */</span>
<a name="l01473"></a>01473       rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec -= rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>.tv_usec % 100;
<a name="l01474"></a>01474    }
<a name="l01475"></a>01475 
<a name="l01476"></a>01476    gettimeofday(&amp;now,NULL);
<a name="l01477"></a>01477    <span class="comment">/* rxcore is the mapping between the RTP timestamp and _our_ real time from gettimeofday() */</span>
<a name="l01478"></a>01478    tmp = <a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(timestamp, rate);
<a name="l01479"></a>01479    *when = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, tmp);
<a name="l01480"></a>01480 
<a name="l01481"></a>01481    prog = (double)((timestamp-rtp-&gt;<a class="code" href="structast__rtp.html#aa9d357f51d7983d9a150c8c433306f7c">seedrxts</a>)/(float)(rate));
<a name="l01482"></a>01482    dtv = (double)rtp-&gt;<a class="code" href="structast__rtp.html#aa0016ad6315851ed2b2f45f38b72d4e2">drxcore</a> + (<span class="keywordtype">double</span>)(prog);
<a name="l01483"></a>01483    current_time = (double)now.tv_sec + (<span class="keywordtype">double</span>)now.tv_usec/1000000;
<a name="l01484"></a>01484    transit = current_time - dtv;
<a name="l01485"></a>01485    d = transit - rtp-&gt;<a class="code" href="structast__rtp.html#a03de90eeef260174916d063af8db743b">rxtransit</a>;
<a name="l01486"></a>01486    rtp-&gt;<a class="code" href="structast__rtp.html#a03de90eeef260174916d063af8db743b">rxtransit</a> = transit;
<a name="l01487"></a>01487    <span class="keywordflow">if</span> (d&lt;0)
<a name="l01488"></a>01488       d=-d;
<a name="l01489"></a>01489    rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a> += (1./16.) * (d - rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>);
<a name="l01490"></a>01490 
<a name="l01491"></a>01491    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l01492"></a>01492       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a> &gt; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab23a4f4246d6a5d538cd97104db12ab2">maxrxjitter</a>)
<a name="l01493"></a>01493          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab23a4f4246d6a5d538cd97104db12ab2">maxrxjitter</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>;
<a name="l01494"></a>01494       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a9c2d8b256c256eff415ef34d51c09b47">rxjitter_count</a> == 1) 
<a name="l01495"></a>01495          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">minrxjitter</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>;
<a name="l01496"></a>01496       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a> &lt; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">minrxjitter</a>)
<a name="l01497"></a>01497          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">minrxjitter</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>;
<a name="l01498"></a>01498          
<a name="l01499"></a>01499       normdev_rxjitter_current = <a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561" title="Calculate normal deviation.">normdev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">normdev_rxjitter</a>,rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a9c2d8b256c256eff415ef34d51c09b47">rxjitter_count</a>);
<a name="l01500"></a>01500       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ac18eba100dbfe48f0f6d0377cf8c76c1">stdev_rxjitter</a> = <a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">stddev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ac18eba100dbfe48f0f6d0377cf8c76c1">stdev_rxjitter</a>,rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">normdev_rxjitter</a>,normdev_rxjitter_current,rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a9c2d8b256c256eff415ef34d51c09b47">rxjitter_count</a>);
<a name="l01501"></a>01501 
<a name="l01502"></a>01502       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">normdev_rxjitter</a> = normdev_rxjitter_current;
<a name="l01503"></a>01503       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a9c2d8b256c256eff415ef34d51c09b47">rxjitter_count</a>++;
<a name="l01504"></a>01504    }
<a name="l01505"></a>01505 }
<a name="l01506"></a>01506 <span class="comment"></span>
<a name="l01507"></a>01507 <span class="comment">/*! \brief Perform a Packet2Packet RTP write */</span>
<a name="l01508"></a><a class="code" href="rtp_8c.html#a5c67ce326f00a810520a5c0bc4500df6">01508</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a5c67ce326f00a810520a5c0bc4500df6" title="Perform a Packet2Packet RTP write.">bridge_p2p_rtp_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *bridged, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtpheader, <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>, <span class="keywordtype">int</span> hdrlen)
<a name="l01509"></a>01509 {
<a name="l01510"></a>01510    <span class="keywordtype">int</span> res = 0, payload = 0, bridged_payload = 0, mark;
<a name="l01511"></a>01511    <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> rtpPT;
<a name="l01512"></a>01512    <span class="keywordtype">int</span> <a class="code" href="codec__g726_8c.html#aab1f392cff37399fc43db0d4b2cc11c8">reconstruct</a> = ntohl(rtpheader[0]);
<a name="l01513"></a>01513 
<a name="l01514"></a>01514    <span class="comment">/* Get fields from packet */</span>
<a name="l01515"></a>01515    payload = (reconstruct &amp; 0x7f0000) &gt;&gt; 16;
<a name="l01516"></a>01516    mark = (((reconstruct &amp; 0x800000) &gt;&gt; 23) != 0);
<a name="l01517"></a>01517 
<a name="l01518"></a>01518    <span class="comment">/* Check what the payload value should be */</span>
<a name="l01519"></a>01519    rtpPT = <a class="code" href="rtp_8h.html#a9fdf56baeb1e0ca97859d10826bdd1de" title="Mapping between RTP payload format codes and Asterisk codes:.">ast_rtp_lookup_pt</a>(rtp, payload);
<a name="l01520"></a>01520 
<a name="l01521"></a>01521    <span class="comment">/* If the payload is DTMF, and we are listening for DTMF - then feed it into the core */</span>
<a name="l01522"></a>01522    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>) &amp;&amp; !rtpPT.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> &amp;&amp; rtpPT.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> == <a class="code" href="rtp_8h.html#a3cc8001677e3b955b9b5ceb4267a76ec">AST_RTP_DTMF</a>)
<a name="l01523"></a>01523       <span class="keywordflow">return</span> -1;
<a name="l01524"></a>01524 
<a name="l01525"></a>01525    <span class="comment">/* Otherwise adjust bridged payload to match */</span>
<a name="l01526"></a>01526    bridged_payload = <a class="code" href="rtp_8h.html#a4daa559b8f2ef25bc33d8f5d8fd937d1" title="Looks up an RTP code out of our *static* outbound list.">ast_rtp_lookup_code</a>(bridged, rtpPT.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>, rtpPT.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>);
<a name="l01527"></a>01527 
<a name="l01528"></a>01528    <span class="comment">/* If the payload coming in is not one of the negotiated ones then send it to the core, this will cause formats to change and the bridge to break */</span>
<a name="l01529"></a>01529    <span class="keywordflow">if</span> (!bridged-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[bridged_payload].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>)
<a name="l01530"></a>01530       <span class="keywordflow">return</span> -1;
<a name="l01531"></a>01531 
<a name="l01532"></a>01532 
<a name="l01533"></a>01533    <span class="comment">/* If the mark bit has not been sent yet... do it now */</span>
<a name="l01534"></a>01534    <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>)) {
<a name="l01535"></a>01535       mark = 1;
<a name="l01536"></a>01536       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>);
<a name="l01537"></a>01537    }
<a name="l01538"></a>01538 
<a name="l01539"></a>01539    <span class="comment">/* Reconstruct part of the packet */</span>
<a name="l01540"></a>01540    reconstruct &amp;= 0xFF80FFFF;
<a name="l01541"></a>01541    reconstruct |= (bridged_payload &lt;&lt; 16);
<a name="l01542"></a>01542    reconstruct |= (mark &lt;&lt; 23);
<a name="l01543"></a>01543    rtpheader[0] = htonl(reconstruct);
<a name="l01544"></a>01544 
<a name="l01545"></a>01545    <span class="comment">/* Send the packet back out */</span>
<a name="l01546"></a>01546    res = sendto(bridged-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">void</span> *)rtpheader, len, 0, (<span class="keyword">struct</span> sockaddr *)&amp;bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l01547"></a>01547    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01548"></a>01548       <span class="keywordflow">if</span> (!bridged-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a> || (bridged-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a> &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(bridged, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>) == <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>))) {
<a name="l01549"></a>01549          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;RTP Transmission error of packet to %s:%d: %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01550"></a>01550       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(bridged, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>) == <a class="code" href="rtp_8c.html#a7ea8f10bd8b1fab6990526c3271a7b59">FLAG_NAT_INACTIVE</a>) || rtpdebug) &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(bridged, <a class="code" href="rtp_8c.html#ad2adc4c49cf65121c15dc838f43c6cb0">FLAG_NAT_INACTIVE_NOWARN</a>)) {
<a name="l01551"></a>01551          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l01552"></a>01552             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;RTP NAT: Can&apos;t write RTP to private address %s:%d, waiting for other end to send audio...\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l01553"></a>01553          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(bridged, <a class="code" href="rtp_8c.html#ad2adc4c49cf65121c15dc838f43c6cb0">FLAG_NAT_INACTIVE_NOWARN</a>);
<a name="l01554"></a>01554       }
<a name="l01555"></a>01555       <span class="keywordflow">return</span> 0;
<a name="l01556"></a>01556    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>))
<a name="l01557"></a>01557          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Sent RTP P2P packet to %s:%u (type %-2.2d, len %-6.6u)\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(bridged-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), bridged_payload, len - hdrlen);
<a name="l01558"></a>01558 
<a name="l01559"></a>01559    <span class="keywordflow">return</span> 0;
<a name="l01560"></a>01560 }
<a name="l01561"></a>01561 
<a name="l01562"></a><a class="code" href="rtp_8c.html#ac0a9d31f175e3de83fa1dda629c11674">01562</a> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8h.html#ac0a9d31f175e3de83fa1dda629c11674">ast_rtp_read</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l01563"></a>01563 {
<a name="l01564"></a>01564    <span class="keywordtype">int</span> res;
<a name="l01565"></a>01565    <span class="keyword">struct </span>sockaddr_in sock_in;
<a name="l01566"></a>01566    socklen_t <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l01567"></a>01567    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> seqno;
<a name="l01568"></a>01568    <span class="keywordtype">int</span> <a class="code" href="res__config__ldap_8c.html#aad880fc4455c253781e8968f2239d56f">version</a>;
<a name="l01569"></a>01569    <span class="keywordtype">int</span> payloadtype;
<a name="l01570"></a>01570    <span class="keywordtype">int</span> hdrlen = 12;
<a name="l01571"></a>01571    <span class="keywordtype">int</span> padding;
<a name="l01572"></a>01572    <span class="keywordtype">int</span> mark;
<a name="l01573"></a>01573    <span class="keywordtype">int</span> <a class="code" href="http_8c.html#af9b32121c4ad80b0887a3d73fd24de5f">ext</a>;
<a name="l01574"></a>01574    <span class="keywordtype">int</span> cc;
<a name="l01575"></a>01575    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ssrc;
<a name="l01576"></a>01576    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> timestamp;
<a name="l01577"></a>01577    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtpheader;
<a name="l01578"></a>01578    <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> rtpPT;
<a name="l01579"></a>01579    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">bridged</a> = NULL;
<a name="l01580"></a>01580    <span class="keywordtype">int</span> prev_seqno;
<a name="l01581"></a>01581    
<a name="l01582"></a>01582    <span class="comment">/* If time is up, kill it */</span>
<a name="l01583"></a>01583    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#af637078f896cfd75467174c20d0cb217">sending_digit</a>)
<a name="l01584"></a>01584       <a class="code" href="rtp_8c.html#acfdeaf8e752856ad7b49174eee6e9fea" title="Send continuation frame for DTMF.">ast_rtp_senddigit_continuation</a>(rtp);
<a name="l01585"></a>01585 
<a name="l01586"></a>01586    len = <span class="keyword">sizeof</span>(sock_in);
<a name="l01587"></a>01587    
<a name="l01588"></a>01588    <span class="comment">/* Cache where the header will go */</span>
<a name="l01589"></a>01589    res = recvfrom(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a>) - <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>,
<a name="l01590"></a>01590                0, (<span class="keyword">struct</span> sockaddr *)&amp;sock_in, &amp;len);
<a name="l01591"></a>01591 
<a name="l01592"></a>01592    <span class="comment">/* If strict RTP protection is enabled see if we need to learn this address or if the packet should be dropped */</span>
<a name="l01593"></a>01593    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a64730d554c32f13303a5a19f39cbd826">strict_rtp_state</a> == <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4ba0c26c1144bb830775979deb20e049368">STRICT_RTP_LEARN</a>) {
<a name="l01594"></a>01594       <span class="comment">/* Copy over address that this packet was received on */</span>
<a name="l01595"></a>01595       memcpy(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>, &amp;sock_in, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>));
<a name="l01596"></a>01596       <span class="comment">/* Now move over to actually protecting the RTP port */</span>
<a name="l01597"></a>01597       rtp-&gt;<a class="code" href="structast__rtp.html#a64730d554c32f13303a5a19f39cbd826">strict_rtp_state</a> = <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4baff585ea9a2059021ce5a5f4a7ed8895f">STRICT_RTP_CLOSED</a>;
<a name="l01598"></a>01598       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Learned remote address is %s:%d for strict RTP purposes, now protecting the port.\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>.sin_port));
<a name="l01599"></a>01599    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a64730d554c32f13303a5a19f39cbd826">strict_rtp_state</a> == <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4baff585ea9a2059021ce5a5f4a7ed8895f">STRICT_RTP_CLOSED</a>) {
<a name="l01600"></a>01600       <span class="comment">/* If the address we previously learned doesn&apos;t match the address this packet came in on simply drop it */</span>
<a name="l01601"></a>01601       <span class="keywordflow">if</span> ((rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>.sin_addr.s_addr != sock_in.sin_addr.s_addr) || (rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>.sin_port != sock_in.sin_port)) {
<a name="l01602"></a>01602          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Received RTP packet from %s:%d, dropping due to strict RTP protection. Expected it to be from %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sock_in.sin_addr), ntohs(sock_in.sin_port), <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a4953f3ad9f3006fa1cc3b2b19fa19783">strict_rtp_address</a>.sin_port));
<a name="l01603"></a>01603          <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01604"></a>01604       }
<a name="l01605"></a>01605    }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607    rtpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>);
<a name="l01608"></a>01608    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l01609"></a>01609       <a class="code" href="utils_8h.html#a24374da24af1931d8a7ccde5b352bb2c">ast_assert</a>(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EBADF);
<a name="l01610"></a>01610       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EAGAIN) {
<a name="l01611"></a>01611          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RTP Read error: %s.  Hanging up.\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l01612"></a>01612          <span class="keywordflow">return</span> NULL;
<a name="l01613"></a>01613       }
<a name="l01614"></a>01614       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01615"></a>01615    }
<a name="l01616"></a>01616    
<a name="l01617"></a>01617    <span class="keywordflow">if</span> (res &lt; hdrlen) {
<a name="l01618"></a>01618       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RTP Read too short\n&quot;</span>);
<a name="l01619"></a>01619       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01620"></a>01620    }
<a name="l01621"></a>01621 
<a name="l01622"></a>01622    <span class="comment">/* Get fields */</span>
<a name="l01623"></a>01623    seqno = ntohl(rtpheader[0]);
<a name="l01624"></a>01624 
<a name="l01625"></a>01625    <span class="comment">/* Check RTP version */</span>
<a name="l01626"></a>01626    version = (seqno &amp; 0xC0000000) &gt;&gt; 30;
<a name="l01627"></a>01627    <span class="keywordflow">if</span> (!version) {
<a name="l01628"></a>01628       <span class="comment">/* If the two high bits are 0, this might be a</span>
<a name="l01629"></a>01629 <span class="comment">       * STUN message, so process it. stun_handle_packet()</span>
<a name="l01630"></a>01630 <span class="comment">       * answers to requests, and it returns STUN_ACCEPT</span>
<a name="l01631"></a>01631 <span class="comment">       * if the request is valid.</span>
<a name="l01632"></a>01632 <span class="comment">       */</span>
<a name="l01633"></a>01633       <span class="keywordflow">if</span> ((<a class="code" href="rtp_8c.html#a0599391b62cb92d0a020334f6d63fdd0" title="handle an incoming STUN message.">stun_handle_packet</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, &amp;sock_in, rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>, res, NULL, NULL) == <a class="code" href="rtp_8c.html#a99997ca32f4f4f6e229dd8aaacd71ec0">STUN_ACCEPT</a>) &amp;&amp;
<a name="l01634"></a>01634          (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port &amp;&amp; !rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr)) {
<a name="l01635"></a>01635          memcpy(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, &amp;sock_in, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l01636"></a>01636       }
<a name="l01637"></a>01637       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01638"></a>01638    }
<a name="l01639"></a>01639 
<a name="l01640"></a>01640 <span class="preprocessor">#if 0 </span><span class="comment">/* Allow to receive RTP stream with closed transmission path */</span>
<a name="l01641"></a>01641    <span class="comment">/* If we don&apos;t have the other side&apos;s address, then ignore this */</span>
<a name="l01642"></a>01642    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr || !rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port)
<a name="l01643"></a>01643       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01644"></a>01644 <span class="preprocessor">#endif</span>
<a name="l01645"></a>01645 <span class="preprocessor"></span>
<a name="l01646"></a>01646    <span class="comment">/* Send to whoever send to us if NAT is turned on */</span>
<a name="l01647"></a>01647    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a>) {
<a name="l01648"></a>01648       <span class="keywordflow">if</span> (((rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr != sock_in.sin_addr.s_addr) ||
<a name="l01649"></a>01649           (rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port != sock_in.sin_port)) &amp;&amp; 
<a name="l01650"></a>01650           ((rtp-&gt;<a class="code" href="structast__rtp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_addr.s_addr != sock_in.sin_addr.s_addr) ||
<a name="l01651"></a>01651           (rtp-&gt;<a class="code" href="structast__rtp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_port != sock_in.sin_port))) {
<a name="l01652"></a>01652          rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a> = sock_in;
<a name="l01653"></a>01653          <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l01654"></a>01654             <span class="keywordtype">int</span> h = 0;
<a name="l01655"></a>01655             memcpy(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, &amp;sock_in, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l01656"></a>01656             h = ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port);
<a name="l01657"></a>01657             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port = htons(h + 1);
<a name="l01658"></a>01658          }
<a name="l01659"></a>01659          rtp-&gt;<a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">rxseqno</a> = 0;
<a name="l01660"></a>01660          <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>);
<a name="l01661"></a>01661          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l01662"></a>01662             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;RTP NAT: Got audio from other end. Now sending to address %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l01663"></a>01663       }
<a name="l01664"></a>01664    }
<a name="l01665"></a>01665 
<a name="l01666"></a>01666    <span class="comment">/* If we are bridged to another RTP stream, send direct */</span>
<a name="l01667"></a>01667    <span class="keywordflow">if</span> ((bridged = <a class="code" href="rtp_8h.html#af7dc32ebdfacbbf446321de6fcfe2d9a">ast_rtp_get_bridged</a>(rtp)) &amp;&amp; !<a class="code" href="rtp_8c.html#a5c67ce326f00a810520a5c0bc4500df6" title="Perform a Packet2Packet RTP write.">bridge_p2p_rtp_write</a>(rtp, bridged, rtpheader, res, hdrlen))
<a name="l01668"></a>01668       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01669"></a>01669 
<a name="l01670"></a>01670    <span class="keywordflow">if</span> (version != 2)
<a name="l01671"></a>01671       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01672"></a>01672 
<a name="l01673"></a>01673    payloadtype = (seqno &amp; 0x7f0000) &gt;&gt; 16;
<a name="l01674"></a>01674    padding = seqno &amp; (1 &lt;&lt; 29);
<a name="l01675"></a>01675    mark = seqno &amp; (1 &lt;&lt; 23);
<a name="l01676"></a>01676    ext = seqno &amp; (1 &lt;&lt; 28);
<a name="l01677"></a>01677    cc = (seqno &amp; 0xF000000) &gt;&gt; 24;
<a name="l01678"></a>01678    seqno &amp;= 0xffff;
<a name="l01679"></a>01679    timestamp = ntohl(rtpheader[1]);
<a name="l01680"></a>01680    ssrc = ntohl(rtpheader[2]);
<a name="l01681"></a>01681    
<a name="l01682"></a>01682    <span class="keywordflow">if</span> (!mark &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a943da98a0ca2d0342765831c6c3d5f3f">rxssrc</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a943da98a0ca2d0342765831c6c3d5f3f">rxssrc</a> != ssrc) {
<a name="l01683"></a>01683       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l01684"></a>01684          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;Forcing Marker bit, because SSRC has changed\n&quot;</span>);
<a name="l01685"></a>01685       mark = 1;
<a name="l01686"></a>01686    }
<a name="l01687"></a>01687 
<a name="l01688"></a>01688    rtp-&gt;<a class="code" href="structast__rtp.html#a943da98a0ca2d0342765831c6c3d5f3f">rxssrc</a> = ssrc;
<a name="l01689"></a>01689    
<a name="l01690"></a>01690    <span class="keywordflow">if</span> (padding) {
<a name="l01691"></a>01691       <span class="comment">/* Remove padding bytes */</span>
<a name="l01692"></a>01692       res -= rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a>[<a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> + res - 1];
<a name="l01693"></a>01693    }
<a name="l01694"></a>01694    
<a name="l01695"></a>01695    <span class="keywordflow">if</span> (cc) {
<a name="l01696"></a>01696       <span class="comment">/* CSRC fields present */</span>
<a name="l01697"></a>01697       hdrlen += cc*4;
<a name="l01698"></a>01698    }
<a name="l01699"></a>01699 
<a name="l01700"></a>01700    <span class="keywordflow">if</span> (ext) {
<a name="l01701"></a>01701       <span class="comment">/* RTP Extension present */</span>
<a name="l01702"></a>01702       hdrlen += (ntohl(rtpheader[hdrlen/4]) &amp; 0xffff) &lt;&lt; 2;
<a name="l01703"></a>01703       hdrlen += 4;
<a name="l01704"></a>01704       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l01705"></a>01705          <span class="keywordtype">int</span> profile;
<a name="l01706"></a>01706          profile = (ntohl(rtpheader[3]) &amp; 0xffff0000) &gt;&gt; 16;
<a name="l01707"></a>01707          <span class="keywordflow">if</span> (profile == 0x505a)
<a name="l01708"></a>01708             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found Zfone extension in RTP stream - zrtp - not supported.\n&quot;</span>);
<a name="l01709"></a>01709          <span class="keywordflow">else</span>
<a name="l01710"></a>01710             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Found unknown RTP Extensions %x\n&quot;</span>, profile);
<a name="l01711"></a>01711       }
<a name="l01712"></a>01712    }
<a name="l01713"></a>01713 
<a name="l01714"></a>01714    <span class="keywordflow">if</span> (res &lt; hdrlen) {
<a name="l01715"></a>01715       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RTP Read too short (%d, expecting %d)\n&quot;</span>, res, hdrlen);
<a name="l01716"></a>01716       <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01717"></a>01717    }
<a name="l01718"></a>01718 
<a name="l01719"></a>01719    rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>++; <span class="comment">/* Only count reasonably valid packets, this&apos;ll make the rtcp stats more accurate */</span>
<a name="l01720"></a>01720 
<a name="l01721"></a>01721    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>==1) {
<a name="l01722"></a>01722       <span class="comment">/* This is the first RTP packet successfully received from source */</span>
<a name="l01723"></a>01723       rtp-&gt;<a class="code" href="structast__rtp.html#a39b8d9a63bb7be44fbb707bb23721092">seedrxseqno</a> = seqno;
<a name="l01724"></a>01724    }
<a name="l01725"></a>01725 
<a name="l01726"></a>01726    <span class="comment">/* Do not schedule RR if RTCP isn&apos;t run */</span>
<a name="l01727"></a>01727    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a> &lt; 1) {
<a name="l01728"></a>01728       <span class="comment">/* Schedule transmission of Receiver Report */</span>
<a name="l01729"></a>01729       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a> = <a class="code" href="sched_8h.html#a97176531282ac4e70aa107b2e8ee5543" title="Adds a scheduled event Schedule an event to take place at some point in the future...">ast_sched_add</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, <a class="code" href="rtp_8c.html#ae8c264c840c8c9b4e8ca062746000506">ast_rtcp_calc_interval</a>(rtp), <a class="code" href="rtp_8c.html#aff89c2855ec73ffa6efdc958bb71c2e8" title="Write and RTCP packet to the far end.">ast_rtcp_write</a>, rtp);
<a name="l01730"></a>01730    }
<a name="l01731"></a>01731    <span class="keywordflow">if</span> ((<span class="keywordtype">int</span>)rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a> - (<span class="keywordtype">int</span>)seqno  &gt; 100) <span class="comment">/* if so it would indicate that the sender cycled; allow for misordering */</span>
<a name="l01732"></a>01732       rtp-&gt;<a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a> += <a class="code" href="rtp_8c.html#af3a188c3caa83026e351d58ef855424a">RTP_SEQ_MOD</a>;
<a name="l01733"></a>01733    
<a name="l01734"></a>01734    prev_seqno = rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a>;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736    rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a> = seqno;
<a name="l01737"></a>01737    
<a name="l01738"></a>01738    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>)
<a name="l01739"></a>01739       rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a> = ntohl(rtpheader[2]); <span class="comment">/* Record their SSRC to put in future RR */</span>
<a name="l01740"></a>01740    
<a name="l01741"></a>01741    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;sock_in))
<a name="l01742"></a>01742       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Got  RTP packet from    %s:%u (type %-2.2d, seq %-6.6u, ts %-6.6u, len %-6.6u)\n&quot;</span>,
<a name="l01743"></a>01743          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sock_in.sin_addr), ntohs(sock_in.sin_port), payloadtype, seqno, timestamp,res - hdrlen);
<a name="l01744"></a>01744 
<a name="l01745"></a>01745    rtpPT = <a class="code" href="rtp_8h.html#a9fdf56baeb1e0ca97859d10826bdd1de" title="Mapping between RTP payload format codes and Asterisk codes:.">ast_rtp_lookup_pt</a>(rtp, payloadtype);
<a name="l01746"></a>01746    <span class="keywordflow">if</span> (!rtpPT.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>) {
<a name="l01747"></a>01747       <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a> = NULL;
<a name="l01748"></a>01748 
<a name="l01749"></a>01749       <span class="comment">/* This is special in-band data that&apos;s not one of our codecs */</span>
<a name="l01750"></a>01750       <span class="keywordflow">if</span> (rtpPT.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> == <a class="code" href="rtp_8h.html#a3cc8001677e3b955b9b5ceb4267a76ec">AST_RTP_DTMF</a>) {
<a name="l01751"></a>01751          <span class="comment">/* It&apos;s special -- rfc2833 process it */</span>
<a name="l01752"></a>01752          <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;sock_in)) {
<a name="l01753"></a>01753             <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>;
<a name="l01754"></a>01754             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> event;
<a name="l01755"></a>01755             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> event_end;
<a name="l01756"></a>01756             <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> duration;
<a name="l01757"></a>01757             data = rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> + hdrlen;
<a name="l01758"></a>01758             <span class="keyword">event</span> = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(data)));
<a name="l01759"></a>01759             <span class="keyword">event</span> &gt;&gt;= 24;
<a name="l01760"></a>01760             event_end = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(data)));
<a name="l01761"></a>01761             event_end &lt;&lt;= 8;
<a name="l01762"></a>01762             event_end &gt;&gt;= 24;
<a name="l01763"></a>01763             duration = ntohl(*((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(data)));
<a name="l01764"></a>01764             duration &amp;= 0xFFFF;
<a name="l01765"></a>01765             <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Got  RTP RFC2833 from   %s:%u (type %-2.2d, seq %-6.6u, ts %-6.6u, len %-6.6u, mark %d, event %08x, end %d, duration %-5.5d) \n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(sock_in.sin_addr), ntohs(sock_in.sin_port), payloadtype, seqno, timestamp, res - hdrlen, (mark?1:0), event, ((event_end &amp; 0x80)?1:0), duration);
<a name="l01766"></a>01766          }
<a name="l01767"></a>01767          f = <a class="code" href="rtp_8c.html#ad58e8d31a0ace316b213e752c7939ac7" title="Process RTP DTMF and events according to RFC 2833.">process_rfc2833</a>(rtp, rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> + hdrlen, res - hdrlen, seqno, timestamp);
<a name="l01768"></a>01768       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rtpPT.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> == <a class="code" href="rtp_8h.html#afd196e2ba79659dff0799d49494e8b45">AST_RTP_CISCO_DTMF</a>) {
<a name="l01769"></a>01769          <span class="comment">/* It&apos;s really special -- process it the Cisco way */</span>
<a name="l01770"></a>01770          <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> &lt;= seqno || (rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> &gt;= 65530 &amp;&amp; seqno &lt;= 6)) {
<a name="l01771"></a>01771             f = <a class="code" href="rtp_8c.html#a51335dc07892d8a1e1db2ffbaf1178cd">process_cisco_dtmf</a>(rtp, rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> + hdrlen, res - hdrlen);
<a name="l01772"></a>01772             rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> = seqno;
<a name="l01773"></a>01773          }
<a name="l01774"></a>01774       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rtpPT.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> == <a class="code" href="rtp_8h.html#ad924782a38efb3a8f9edbb92d3135541">AST_RTP_CN</a>) {
<a name="l01775"></a>01775          <span class="comment">/* Comfort Noise */</span>
<a name="l01776"></a>01776          f = <a class="code" href="rtp_8c.html#a663c1a4adafaed5f3c26b2a0c0735365" title="Process Comfort Noise RTP.">process_rfc3389</a>(rtp, rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a> + hdrlen, res - hdrlen);
<a name="l01777"></a>01777       } <span class="keywordflow">else</span> {
<a name="l01778"></a>01778          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;Unknown RTP codec %d received from &apos;%s&apos;\n&quot;</span>, payloadtype, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr));
<a name="l01779"></a>01779       }
<a name="l01780"></a>01780       <span class="keywordflow">return</span> f ? f : &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01781"></a>01781    }
<a name="l01782"></a>01782    rtp-&gt;<a class="code" href="structast__rtp.html#ac39112ee85d1c736329776a40537daf9">lastrxformat</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = rtpPT.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>;
<a name="l01783"></a>01783    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>) ? <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a> : (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; <a class="code" href="frame_8h.html#ad048231af8a6271706585e3c8630dc69">AST_FORMAT_VIDEO_MASK</a>) ? <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a> : <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>;
<a name="l01784"></a>01784 
<a name="l01785"></a>01785    rtp-&gt;<a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">rxseqno</a> = seqno;
<a name="l01786"></a>01786 
<a name="l01787"></a>01787    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> &lt; timestamp) {
<a name="l01788"></a>01788       rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = 0;
<a name="l01789"></a>01789 
<a name="l01790"></a>01790       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a>) {
<a name="l01791"></a>01791          <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l01792"></a>01792          f = <a class="code" href="rtp_8c.html#a7731cfa4c6712ca675ee296e4f0a1918">send_dtmf</a>(rtp, <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>);
<a name="l01793"></a>01793          f-&gt;<a class="code" href="structast__frame.html#aaccba9d5adc3f6c39aad767db95ba484">len</a> = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(<a class="code" href="time_8h.html#a147d132412d7188c1dcebf25b8d31c0c" title="Returns a timeval corresponding to the duration of n samples at rate r. Useful to...">ast_samp2tv</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a>, <a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>)), <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 0));
<a name="l01794"></a>01794          rtp-&gt;<a class="code" href="structast__rtp.html#a617de34b6fe254a4d2c04e2a064267ee">resp</a> = 0;
<a name="l01795"></a>01795          rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a19848123ee0962b2880fffaea19a9392">dtmf_duration</a> = 0;
<a name="l01796"></a>01796          <span class="keywordflow">return</span> f;
<a name="l01797"></a>01797       }
<a name="l01798"></a>01798    }
<a name="l01799"></a>01799 
<a name="l01800"></a>01800    <span class="comment">/* Record received timestamp as last received now */</span>
<a name="l01801"></a>01801    rtp-&gt;<a class="code" href="structast__rtp.html#ab4b9ba00bb47d86340c9c150f17d7c69">lastrxts</a> = timestamp;
<a name="l01802"></a>01802 
<a name="l01803"></a>01803    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed16590d48f41d89f31e0cf347f5cd99">mallocd</a> = 0;
<a name="l01804"></a>01804    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = res - hdrlen;
<a name="l01805"></a>01805    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + hdrlen + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>;
<a name="l01806"></a>01806    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> = hdrlen + AST_FRIENDLY_OFFSET;
<a name="l01807"></a>01807    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ab793262012344621455faf9266acbac2">seqno</a> = seqno;
<a name="l01808"></a>01808 
<a name="l01809"></a>01809    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#a721e65ac52ff8eca03ea163544e695b6">AST_FORMAT_T140</a> &amp;&amp; (<span class="keywordtype">int</span>)seqno - (prev_seqno+1) &gt; 0 &amp;&amp; (<span class="keywordtype">int</span>)seqno - (prev_seqno+1) &lt; 10) {
<a name="l01810"></a>01810         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;
<a name="l01811"></a>01811         
<a name="l01812"></a>01812         memmove(rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>+3, rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l01813"></a>01813         rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> +=3;
<a name="l01814"></a>01814         *data++ = 0xEF;
<a name="l01815"></a>01815         *data++ = 0xBF;
<a name="l01816"></a>01816         *data = 0xBD;
<a name="l01817"></a>01817    }
<a name="l01818"></a>01818  
<a name="l01819"></a>01819    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa43d17815b58f27836a45fb310d33959">AST_FORMAT_T140RED</a>) {
<a name="l01820"></a>01820       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;
<a name="l01821"></a>01821       <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *header_end;
<a name="l01822"></a>01822       <span class="keywordtype">int</span> num_generations;
<a name="l01823"></a>01823       <span class="keywordtype">int</span> header_length;
<a name="l01824"></a>01824       <span class="keywordtype">int</span> length;
<a name="l01825"></a>01825       <span class="keywordtype">int</span> diff =(int)seqno - (prev_seqno+1); <span class="comment">/* if diff = 0, no drop*/</span>
<a name="l01826"></a>01826       <span class="keywordtype">int</span> x;
<a name="l01827"></a>01827 
<a name="l01828"></a>01828       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#a721e65ac52ff8eca03ea163544e695b6">AST_FORMAT_T140</a>;
<a name="l01829"></a>01829       header_end = memchr(data, ((*data) &amp; 0x7f), rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l01830"></a>01830       <span class="keywordflow">if</span> (header_end == NULL) {
<a name="l01831"></a>01831          <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01832"></a>01832       }
<a name="l01833"></a>01833       header_end++;
<a name="l01834"></a>01834       
<a name="l01835"></a>01835       header_length = header_end - data;
<a name="l01836"></a>01836       num_generations = header_length / 4;
<a name="l01837"></a>01837       length = header_length;
<a name="l01838"></a>01838 
<a name="l01839"></a>01839       <span class="keywordflow">if</span> (!diff) {
<a name="l01840"></a>01840          <span class="keywordflow">for</span> (x = 0; x &lt; num_generations; x++)
<a name="l01841"></a>01841             length += data[x * 4 + 3];
<a name="l01842"></a>01842          
<a name="l01843"></a>01843          <span class="keywordflow">if</span> (!(rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> - length))
<a name="l01844"></a>01844             <span class="keywordflow">return</span> &amp;<a class="code" href="frame_8h.html#af203379aca2fd704fe8d86a9445596b6">ast_null_frame</a>;
<a name="l01845"></a>01845          
<a name="l01846"></a>01846          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> += length;
<a name="l01847"></a>01847          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> -= length;
<a name="l01848"></a>01848       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (diff &gt; num_generations &amp;&amp; diff &lt; 10) {
<a name="l01849"></a>01849          length -= 3;
<a name="l01850"></a>01850          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> += length;
<a name="l01851"></a>01851          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> -= length;
<a name="l01852"></a>01852          
<a name="l01853"></a>01853          data = rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;
<a name="l01854"></a>01854          *data++ = 0xEF;
<a name="l01855"></a>01855          *data++ = 0xBF;
<a name="l01856"></a>01856          *data = 0xBD;
<a name="l01857"></a>01857       } <span class="keywordflow">else</span>   {
<a name="l01858"></a>01858          <span class="keywordflow">for</span> ( x = 0; x &lt; num_generations - diff; x++) 
<a name="l01859"></a>01859             length += data[x * 4 + 3];
<a name="l01860"></a>01860          
<a name="l01861"></a>01861          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> += length;
<a name="l01862"></a>01862          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> -= length;
<a name="l01863"></a>01863       }
<a name="l01864"></a>01864    }
<a name="l01865"></a>01865 
<a name="l01866"></a>01866    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; <a class="code" href="frame_8h.html#a3f680b9c15596de927d507a664fd2803">AST_FORMAT_AUDIO_MASK</a>) {
<a name="l01867"></a>01867       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = <a class="code" href="frame_8h.html#aedec72ae8357bb6c334111f93d283713" title="Returns the number of samples contained in the frame.">ast_codec_get_samples</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>);
<a name="l01868"></a>01868       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>) 
<a name="l01869"></a>01869          <a class="code" href="frame_8h.html#a0eb09df2bca453c21ced51b12b52a88b">ast_frame_byteswap_be</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>);
<a name="l01870"></a>01870       <a class="code" href="rtp_8c.html#a6134fd2180fca7829793af724a013344">calc_rxstamp</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>, rtp, timestamp, mark);
<a name="l01871"></a>01871       <span class="comment">/* Add timing data to let ast_generic_bridge() put the frame into a jitterbuf */</span>
<a name="l01872"></a>01872       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>, <a class="code" href="frame_8h.html#a0ae1e3bf78c960c83e2d437efd802058ae8f674e19f6450e2b746c8a52c11649a">AST_FRFLAG_HAS_TIMING_INFO</a>);
<a name="l01873"></a>01873       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a> = timestamp / (<a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000);
<a name="l01874"></a>01874       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#aaccba9d5adc3f6c39aad767db95ba484">len</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> / ((<a class="code" href="frame_8h.html#a29a7b93f4295966d4d441e91bff2b01e" title="Get the sample rate for a given format.">ast_format_rate</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000));
<a name="l01875"></a>01875    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; <a class="code" href="frame_8h.html#ad048231af8a6271706585e3c8630dc69">AST_FORMAT_VIDEO_MASK</a>) {
<a name="l01876"></a>01876       <span class="comment">/* Video -- samples is # of samples vs. 90000 */</span>
<a name="l01877"></a>01877       <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">lastividtimestamp</a>)
<a name="l01878"></a>01878          rtp-&gt;<a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">lastividtimestamp</a> = timestamp;
<a name="l01879"></a>01879       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = timestamp - rtp-&gt;<a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">lastividtimestamp</a>;
<a name="l01880"></a>01880       rtp-&gt;<a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">lastividtimestamp</a> = timestamp;
<a name="l01881"></a>01881       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>.tv_sec = 0;
<a name="l01882"></a>01882       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>.tv_usec = 0;
<a name="l01883"></a>01883       <span class="comment">/* Pass the RTP marker bit as bit 0 in the subclass field.</span>
<a name="l01884"></a>01884 <span class="comment">       * This is ok because subclass is actually a bitmask, and</span>
<a name="l01885"></a>01885 <span class="comment">       * the low bits represent audio formats, that are not</span>
<a name="l01886"></a>01886 <span class="comment">       * involved here since we deal with video.</span>
<a name="l01887"></a>01887 <span class="comment">       */</span>
<a name="l01888"></a>01888       <span class="keywordflow">if</span> (mark)
<a name="l01889"></a>01889          rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> |= 0x1;
<a name="l01890"></a>01890    } <span class="keywordflow">else</span> {
<a name="l01891"></a>01891       <span class="comment">/* TEXT -- samples is # of samples vs. 1000 */</span>
<a name="l01892"></a>01892       <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">lastitexttimestamp</a>)
<a name="l01893"></a>01893          rtp-&gt;<a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">lastitexttimestamp</a> = timestamp;
<a name="l01894"></a>01894       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> = timestamp - rtp-&gt;<a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">lastitexttimestamp</a>;
<a name="l01895"></a>01895       rtp-&gt;<a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">lastitexttimestamp</a> = timestamp;
<a name="l01896"></a>01896       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>.tv_sec = 0;
<a name="l01897"></a>01897       rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>.tv_usec = 0;
<a name="l01898"></a>01898    }
<a name="l01899"></a>01899    rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>.<a class="code" href="structast__frame.html#af51e37c9331049b1e3d250a7c8bc3c26">src</a> = <span class="stringliteral">&quot;RTP&quot;</span>;
<a name="l01900"></a>01900    <span class="keywordflow">return</span> &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a735f764b1095611ace084e7c6c06857d">f</a>;
<a name="l01901"></a>01901 }
<a name="l01902"></a>01902 
<a name="l01903"></a>01903 <span class="comment">/* The following array defines the MIME Media type (and subtype) for each</span>
<a name="l01904"></a>01904 <span class="comment">   of our codecs, or RTP-specific data type. */</span>
<a name="l01905"></a><a class="code" href="structmimeType.html">01905</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structmimeType.html">mimeType</a> {
<a name="l01906"></a><a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">01906</a>    <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> <a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">payloadType</a>;
<a name="l01907"></a><a class="code" href="structmimeType.html#a23506fc4821ab6d9671f3e6222591a96">01907</a>    <span class="keywordtype">char</span> *<a class="code" href="structmimeType.html#a23506fc4821ab6d9671f3e6222591a96">type</a>;
<a name="l01908"></a><a class="code" href="structmimeType.html#a2f076846fbd6b30183ba3ab61e3334e5">01908</a>    <span class="keywordtype">char</span> *<a class="code" href="structmimeType.html#a2f076846fbd6b30183ba3ab61e3334e5">subtype</a>;
<a name="l01909"></a><a class="code" href="structmimeType.html#a1c086f81c095b0efd7a87ee29fc5ba7e">01909</a>    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="structmimeType.html#a1c086f81c095b0efd7a87ee29fc5ba7e">sample_rate</a>;
<a name="l01910"></a>01910 } <a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[] = {
<a name="l01911"></a>01911    {{1, <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G723&quot;</span>, 8000},
<a name="l01912"></a>01912    {{1, <a class="code" href="frame_8h.html#a85106ada66147a674b36f0a55297d29d">AST_FORMAT_GSM</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;GSM&quot;</span>, 8000},
<a name="l01913"></a>01913    {{1, <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;PCMU&quot;</span>, 8000},
<a name="l01914"></a>01914    {{1, <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G711U&quot;</span>, 8000},
<a name="l01915"></a>01915    {{1, <a class="code" href="frame_8h.html#aa58cc980a9c9108522effc64e9aff2d6">AST_FORMAT_ALAW</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;PCMA&quot;</span>, 8000},
<a name="l01916"></a>01916    {{1, <a class="code" href="frame_8h.html#aa58cc980a9c9108522effc64e9aff2d6">AST_FORMAT_ALAW</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G711A&quot;</span>, 8000},
<a name="l01917"></a>01917    {{1, <a class="code" href="frame_8h.html#a030c77081bc2aff5ae5a384769f46418">AST_FORMAT_G726</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G726-32&quot;</span>, 8000},
<a name="l01918"></a>01918    {{1, <a class="code" href="frame_8h.html#a933964fc376c2642f9471c176fb7ae7d">AST_FORMAT_ADPCM</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;DVI4&quot;</span>, 8000},
<a name="l01919"></a>01919    {{1, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;L16&quot;</span>, 8000},
<a name="l01920"></a>01920    {{1, <a class="code" href="frame_8h.html#ac816c6f1fd32b02a6d20af297d96d04f">AST_FORMAT_LPC10</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;LPC&quot;</span>, 8000},
<a name="l01921"></a>01921    {{1, <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G729&quot;</span>, 8000},
<a name="l01922"></a>01922    {{1, <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G729A&quot;</span>, 8000},
<a name="l01923"></a>01923    {{1, <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G.729&quot;</span>, 8000},
<a name="l01924"></a>01924    {{1, <a class="code" href="frame_8h.html#a1a05dee116bf73c0f1ca8410bdb48c62">AST_FORMAT_SPEEX</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;speex&quot;</span>, 8000},
<a name="l01925"></a>01925    {{1, <a class="code" href="frame_8h.html#a8330d06ea408802c37e9af61a513c6a1">AST_FORMAT_ILBC</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;iLBC&quot;</span>, 8000},
<a name="l01926"></a>01926    <span class="comment">/* this is the sample rate listed in the RTP profile for the G.722</span>
<a name="l01927"></a>01927 <span class="comment">      codec, *NOT* the actual sample rate of the media stream</span>
<a name="l01928"></a>01928 <span class="comment">   */</span>
<a name="l01929"></a>01929    {{1, <a class="code" href="frame_8h.html#a4a0e8720928940d26abf28fff2e6586d">AST_FORMAT_G722</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G722&quot;</span>, 8000},
<a name="l01930"></a>01930    {{1, <a class="code" href="frame_8h.html#a536fbd427f197a33e679c7721afad420">AST_FORMAT_G726_AAL2</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;AAL2-G726-32&quot;</span>, 8000},
<a name="l01931"></a>01931    {{0, <a class="code" href="rtp_8h.html#a3cc8001677e3b955b9b5ceb4267a76ec">AST_RTP_DTMF</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;telephone-event&quot;</span>, 8000},
<a name="l01932"></a>01932    {{0, <a class="code" href="rtp_8h.html#afd196e2ba79659dff0799d49494e8b45">AST_RTP_CISCO_DTMF</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;cisco-telephone-event&quot;</span>, 8000},
<a name="l01933"></a>01933    {{0, <a class="code" href="rtp_8h.html#ad924782a38efb3a8f9edbb92d3135541">AST_RTP_CN</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;CN&quot;</span>, 8000},
<a name="l01934"></a>01934    {{1, <a class="code" href="frame_8h.html#a9f42fbac3d6631f67cb0fb9a91091ec5">AST_FORMAT_JPEG</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;JPEG&quot;</span>, 90000},
<a name="l01935"></a>01935    {{1, <a class="code" href="frame_8h.html#a66201142be0584b5741786416aa3e446">AST_FORMAT_PNG</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;PNG&quot;</span>, 90000},
<a name="l01936"></a>01936    {{1, <a class="code" href="frame_8h.html#a876fb06c385409451b7842fe1af6c42e">AST_FORMAT_H261</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;H261&quot;</span>, 90000},
<a name="l01937"></a>01937    {{1, <a class="code" href="frame_8h.html#a750506bc6e9117c66a5a6ad2dc82bc85">AST_FORMAT_H263</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;H263&quot;</span>, 90000},
<a name="l01938"></a>01938    {{1, <a class="code" href="frame_8h.html#aea05b09095ebe8302b1187f4f0b0d042">AST_FORMAT_H263_PLUS</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;h263-1998&quot;</span>, 90000},
<a name="l01939"></a>01939    {{1, <a class="code" href="frame_8h.html#a884a71784d2a563dd54eb15c2cfc57b0">AST_FORMAT_H264</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;H264&quot;</span>, 90000},
<a name="l01940"></a>01940    {{1, <a class="code" href="frame_8h.html#a315d4a14bcf11a55ea8df52dd3a74d35">AST_FORMAT_MP4_VIDEO</a>}, <span class="stringliteral">&quot;video&quot;</span>, <span class="stringliteral">&quot;MP4V-ES&quot;</span>, 90000},
<a name="l01941"></a>01941    {{1, <a class="code" href="frame_8h.html#aa43d17815b58f27836a45fb310d33959">AST_FORMAT_T140RED</a>}, <span class="stringliteral">&quot;text&quot;</span>, <span class="stringliteral">&quot;RED&quot;</span>, 1000},
<a name="l01942"></a>01942    {{1, <a class="code" href="frame_8h.html#a721e65ac52ff8eca03ea163544e695b6">AST_FORMAT_T140</a>}, <span class="stringliteral">&quot;text&quot;</span>, <span class="stringliteral">&quot;T140&quot;</span>, 1000},
<a name="l01943"></a>01943    {{1, <a class="code" href="frame_8h.html#a13092663dddb1492d81571f9f0ae4506">AST_FORMAT_SIREN7</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G7221&quot;</span>, 16000},
<a name="l01944"></a>01944    {{1, <a class="code" href="frame_8h.html#a590224283a5c1527fab938e4d02686cc">AST_FORMAT_SIREN14</a>}, <span class="stringliteral">&quot;audio&quot;</span>, <span class="stringliteral">&quot;G7221&quot;</span>, 32000},
<a name="l01945"></a>01945 };
<a name="l01946"></a>01946 <span class="comment"></span>
<a name="l01947"></a>01947 <span class="comment">/*! </span>
<a name="l01948"></a>01948 <span class="comment"> * \brief Mapping between Asterisk codecs and rtp payload types</span>
<a name="l01949"></a>01949 <span class="comment"> *</span>
<a name="l01950"></a>01950 <span class="comment"> * Static (i.e., well-known) RTP payload types for our &quot;AST_FORMAT...&quot;s:</span>
<a name="l01951"></a>01951 <span class="comment"> * also, our own choices for dynamic payload types.  This is our master</span>
<a name="l01952"></a>01952 <span class="comment"> * table for transmission </span>
<a name="l01953"></a>01953 <span class="comment"> * </span>
<a name="l01954"></a>01954 <span class="comment"> * See http://www.iana.org/assignments/rtp-parameters for a list of</span>
<a name="l01955"></a>01955 <span class="comment"> * assigned values</span>
<a name="l01956"></a>01956 <span class="comment"> */</span>
<a name="l01957"></a><a class="code" href="rtp_8c.html#aee0ddbbc121110ad6d1d3342eddec5f2">01957</a> <span class="keyword">static</span> <span class="keyword">const</span> <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> <a class="code" href="rtp_8c.html#aee0ddbbc121110ad6d1d3342eddec5f2" title="Mapping between Asterisk codecs and rtp payload types.">static_RTP_PT</a>[<a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>] = {
<a name="l01958"></a>01958    [0] = {1, <a class="code" href="frame_8h.html#ab602cf455d4a96a3adba2e3ba8cd2b2c">AST_FORMAT_ULAW</a>},
<a name="l01959"></a>01959 <span class="preprocessor">#ifdef USE_DEPRECATED_G726</span>
<a name="l01960"></a>01960 <span class="preprocessor"></span>   [2] = {1, <a class="code" href="frame_8h.html#a030c77081bc2aff5ae5a384769f46418">AST_FORMAT_G726</a>}, <span class="comment">/* Technically this is G.721, but if Cisco can do it, so can we... */</span>
<a name="l01961"></a>01961 <span class="preprocessor">#endif</span>
<a name="l01962"></a>01962 <span class="preprocessor"></span>   [3] = {1, <a class="code" href="frame_8h.html#a85106ada66147a674b36f0a55297d29d">AST_FORMAT_GSM</a>},
<a name="l01963"></a>01963    [4] = {1, <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>},
<a name="l01964"></a>01964    [5] = {1, <a class="code" href="frame_8h.html#a933964fc376c2642f9471c176fb7ae7d">AST_FORMAT_ADPCM</a>}, <span class="comment">/* 8 kHz */</span>
<a name="l01965"></a>01965    [6] = {1, <a class="code" href="frame_8h.html#a933964fc376c2642f9471c176fb7ae7d">AST_FORMAT_ADPCM</a>}, <span class="comment">/* 16 kHz */</span>
<a name="l01966"></a>01966    [7] = {1, <a class="code" href="frame_8h.html#ac816c6f1fd32b02a6d20af297d96d04f">AST_FORMAT_LPC10</a>},
<a name="l01967"></a>01967    [8] = {1, <a class="code" href="frame_8h.html#aa58cc980a9c9108522effc64e9aff2d6">AST_FORMAT_ALAW</a>},
<a name="l01968"></a>01968    [9] = {1, <a class="code" href="frame_8h.html#a4a0e8720928940d26abf28fff2e6586d">AST_FORMAT_G722</a>},
<a name="l01969"></a>01969    [10] = {1, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>}, <span class="comment">/* 2 channels */</span>
<a name="l01970"></a>01970    [11] = {1, <a class="code" href="frame_8h.html#aa68ce7f14882005613a3e1fb0f4181b7">AST_FORMAT_SLINEAR</a>}, <span class="comment">/* 1 channel */</span>
<a name="l01971"></a>01971    [13] = {0, <a class="code" href="rtp_8h.html#ad924782a38efb3a8f9edbb92d3135541">AST_RTP_CN</a>},
<a name="l01972"></a>01972    [16] = {1, <a class="code" href="frame_8h.html#a933964fc376c2642f9471c176fb7ae7d">AST_FORMAT_ADPCM</a>}, <span class="comment">/* 11.025 kHz */</span>
<a name="l01973"></a>01973    [17] = {1, <a class="code" href="frame_8h.html#a933964fc376c2642f9471c176fb7ae7d">AST_FORMAT_ADPCM</a>}, <span class="comment">/* 22.050 kHz */</span>
<a name="l01974"></a>01974    [18] = {1, <a class="code" href="frame_8h.html#a8c5f13161448f613baaf42dea11f520a">AST_FORMAT_G729A</a>},
<a name="l01975"></a>01975    [19] = {0, <a class="code" href="rtp_8h.html#ad924782a38efb3a8f9edbb92d3135541">AST_RTP_CN</a>},    <span class="comment">/* Also used for CN */</span>
<a name="l01976"></a>01976    [26] = {1, <a class="code" href="frame_8h.html#a9f42fbac3d6631f67cb0fb9a91091ec5">AST_FORMAT_JPEG</a>},
<a name="l01977"></a>01977    [31] = {1, <a class="code" href="frame_8h.html#a876fb06c385409451b7842fe1af6c42e">AST_FORMAT_H261</a>},
<a name="l01978"></a>01978    [34] = {1, <a class="code" href="frame_8h.html#a750506bc6e9117c66a5a6ad2dc82bc85">AST_FORMAT_H263</a>},
<a name="l01979"></a>01979    [97] = {1, <a class="code" href="frame_8h.html#a8330d06ea408802c37e9af61a513c6a1">AST_FORMAT_ILBC</a>},
<a name="l01980"></a>01980    [98] = {1, <a class="code" href="frame_8h.html#aea05b09095ebe8302b1187f4f0b0d042">AST_FORMAT_H263_PLUS</a>},
<a name="l01981"></a>01981    [99] = {1, <a class="code" href="frame_8h.html#a884a71784d2a563dd54eb15c2cfc57b0">AST_FORMAT_H264</a>},
<a name="l01982"></a>01982    [101] = {0, <a class="code" href="rtp_8h.html#a3cc8001677e3b955b9b5ceb4267a76ec">AST_RTP_DTMF</a>},
<a name="l01983"></a>01983    [102] = {1, <a class="code" href="frame_8h.html#a13092663dddb1492d81571f9f0ae4506">AST_FORMAT_SIREN7</a>},
<a name="l01984"></a>01984    [103] = {1, <a class="code" href="frame_8h.html#aea05b09095ebe8302b1187f4f0b0d042">AST_FORMAT_H263_PLUS</a>},
<a name="l01985"></a>01985    [104] = {1, <a class="code" href="frame_8h.html#a315d4a14bcf11a55ea8df52dd3a74d35">AST_FORMAT_MP4_VIDEO</a>},
<a name="l01986"></a>01986    [105] = {1, <a class="code" href="frame_8h.html#aa43d17815b58f27836a45fb310d33959">AST_FORMAT_T140RED</a>}, <span class="comment">/* Real time text chat (with redundancy encoding) */</span>
<a name="l01987"></a>01987    [106] = {1, <a class="code" href="frame_8h.html#a721e65ac52ff8eca03ea163544e695b6">AST_FORMAT_T140</a>}, <span class="comment">/* Real time text chat */</span>
<a name="l01988"></a>01988    [110] = {1, <a class="code" href="frame_8h.html#a1a05dee116bf73c0f1ca8410bdb48c62">AST_FORMAT_SPEEX</a>},
<a name="l01989"></a>01989    [111] = {1, <a class="code" href="frame_8h.html#a030c77081bc2aff5ae5a384769f46418">AST_FORMAT_G726</a>},
<a name="l01990"></a>01990    [112] = {1, <a class="code" href="frame_8h.html#a536fbd427f197a33e679c7721afad420">AST_FORMAT_G726_AAL2</a>},
<a name="l01991"></a>01991    [115] = {1, <a class="code" href="frame_8h.html#a590224283a5c1527fab938e4d02686cc">AST_FORMAT_SIREN14</a>},
<a name="l01992"></a>01992    [121] = {0, <a class="code" href="rtp_8h.html#afd196e2ba79659dff0799d49494e8b45">AST_RTP_CISCO_DTMF</a>}, <span class="comment">/* Must be type 121 */</span>
<a name="l01993"></a>01993 };
<a name="l01994"></a>01994 
<a name="l01995"></a><a class="code" href="rtp_8c.html#ac008cc5d5e4b915062b98ff2f202cc38">01995</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#ac008cc5d5e4b915062b98ff2f202cc38" title="Setting RTP payload types from lines in a SDP description:.">ast_rtp_pt_clear</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp) 
<a name="l01996"></a>01996 {
<a name="l01997"></a>01997    <span class="keywordtype">int</span> i;
<a name="l01998"></a>01998 
<a name="l01999"></a>01999    <span class="keywordflow">if</span> (!rtp)
<a name="l02000"></a>02000       <span class="keywordflow">return</span>;
<a name="l02001"></a>02001 
<a name="l02002"></a>02002    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02003"></a>02003 
<a name="l02004"></a>02004    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>; ++i) {
<a name="l02005"></a>02005       rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> = 0;
<a name="l02006"></a>02006       rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> = 0;
<a name="l02007"></a>02007    }
<a name="l02008"></a>02008 
<a name="l02009"></a>02009    rtp-&gt;<a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a> = 0;
<a name="l02010"></a>02010    rtp-&gt;<a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a> = 0;
<a name="l02011"></a>02011    rtp-&gt;<a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a> = 0;
<a name="l02012"></a>02012 
<a name="l02013"></a>02013    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02014"></a>02014 }
<a name="l02015"></a>02015 
<a name="l02016"></a><a class="code" href="rtp_8c.html#af9ebff17643c46897280902ccd33ff40">02016</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#af9ebff17643c46897280902ccd33ff40" title="Set payload types to defaults.">ast_rtp_pt_default</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp) 
<a name="l02017"></a>02017 {
<a name="l02018"></a>02018    <span class="keywordtype">int</span> i;
<a name="l02019"></a>02019 
<a name="l02020"></a>02020    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02021"></a>02021 
<a name="l02022"></a>02022    <span class="comment">/* Initialize to default payload types */</span>
<a name="l02023"></a>02023    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>; ++i) {
<a name="l02024"></a>02024       rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> = static_RTP_PT[i].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>;
<a name="l02025"></a>02025       rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> = static_RTP_PT[i].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>;
<a name="l02026"></a>02026    }
<a name="l02027"></a>02027 
<a name="l02028"></a>02028    rtp-&gt;<a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a> = 0;
<a name="l02029"></a>02029    rtp-&gt;<a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a> = 0;
<a name="l02030"></a>02030    rtp-&gt;<a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a> = 0;
<a name="l02031"></a>02031 
<a name="l02032"></a>02032    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02033"></a>02033 }
<a name="l02034"></a>02034 
<a name="l02035"></a><a class="code" href="rtp_8c.html#a30cfc736f18627e5d0d25196a116faa1">02035</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a30cfc736f18627e5d0d25196a116faa1" title="Copy payload types between RTP structures.">ast_rtp_pt_copy</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *dest, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *src)
<a name="l02036"></a>02036 {
<a name="l02037"></a>02037    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02038"></a>02038 
<a name="l02039"></a>02039    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(dest);
<a name="l02040"></a>02040    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(src);
<a name="l02041"></a>02041 
<a name="l02042"></a>02042    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>; ++i) {
<a name="l02043"></a>02043       dest-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> = 
<a name="l02044"></a>02044          src-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>;
<a name="l02045"></a>02045       dest-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> = 
<a name="l02046"></a>02046          src-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[i].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>; 
<a name="l02047"></a>02047    }
<a name="l02048"></a>02048    dest-&gt;<a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a> = 0;
<a name="l02049"></a>02049    dest-&gt;<a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a> = 0;
<a name="l02050"></a>02050    dest-&gt;<a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a> = 0;
<a name="l02051"></a>02051 
<a name="l02052"></a>02052    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(src);
<a name="l02053"></a>02053    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(dest);
<a name="l02054"></a>02054 }
<a name="l02055"></a>02055 <span class="comment"></span>
<a name="l02056"></a>02056 <span class="comment">/*! \brief Get channel driver interface structure */</span>
<a name="l02057"></a><a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd">02057</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *<a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>)
<a name="l02058"></a>02058 {
<a name="l02059"></a>02059    <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *cur = NULL;
<a name="l02060"></a>02060 
<a name="l02061"></a>02061    <a class="code" href="linkedlists_8h.html#a0a0fe104cc2cc36a43784f886f3ae7dc" title="Read locks a list.">AST_RWLIST_RDLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l02062"></a>02062    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>, cur, <a class="code" href="structast__rtp__protocol.html#a469dabffbf9f8b4a86b7360069260aef">list</a>) {
<a name="l02063"></a>02063       <span class="keywordflow">if</span> (cur-&gt;<a class="code" href="structast__rtp__protocol.html#a8ff938fb2f815be425fd2859a21e6d61">type</a> == chan-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>)
<a name="l02064"></a>02064          <span class="keywordflow">break</span>;
<a name="l02065"></a>02065    }
<a name="l02066"></a>02066    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l02067"></a>02067 
<a name="l02068"></a>02068    <span class="keywordflow">return</span> cur;
<a name="l02069"></a>02069 }
<a name="l02070"></a>02070 
<a name="l02071"></a><a class="code" href="rtp_8c.html#aba89225382987d42ec798462d15930e6">02071</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#aba89225382987d42ec798462d15930e6" title="If possible, create an early bridge directly between the devices without having to...">ast_rtp_early_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c1)
<a name="l02072"></a>02072 {
<a name="l02073"></a>02073    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *destp = NULL, *srcp = NULL;     <span class="comment">/* Audio RTP Channels */</span>
<a name="l02074"></a>02074    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *vdestp = NULL, *vsrcp = NULL;      <span class="comment">/* Video RTP channels */</span>
<a name="l02075"></a>02075    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tdestp = NULL, *tsrcp = NULL;      <span class="comment">/* Text RTP channels */</span>
<a name="l02076"></a>02076    <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *destpr = NULL, *srcpr = NULL;
<a name="l02077"></a>02077    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> audio_dest_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, video_dest_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, text_dest_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02078"></a>02078    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> audio_src_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, video_src_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, text_src_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02079"></a>02079    <span class="keywordtype">int</span> srccodec, destcodec, nat_active = 0;
<a name="l02080"></a>02080 
<a name="l02081"></a>02081    <span class="comment">/* Lock channels */</span>
<a name="l02082"></a>02082    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(c0);
<a name="l02083"></a>02083    <span class="keywordflow">if</span> (c1) {
<a name="l02084"></a>02084       <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(c1)) {
<a name="l02085"></a>02085          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l02086"></a>02086          usleep(1);
<a name="l02087"></a>02087          <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(c0);
<a name="l02088"></a>02088       }
<a name="l02089"></a>02089    }
<a name="l02090"></a>02090 
<a name="l02091"></a>02091    <span class="comment">/* Find channel driver interfaces */</span>
<a name="l02092"></a>02092    destpr = <a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(c0);
<a name="l02093"></a>02093    <span class="keywordflow">if</span> (c1)
<a name="l02094"></a>02094       srcpr = <a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(c1);
<a name="l02095"></a>02095    <span class="keywordflow">if</span> (!destpr) {
<a name="l02096"></a>02096       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Channel &apos;%s&apos; has no RTP, not doing anything\n&quot;</span>, c0-&gt;name);
<a name="l02097"></a>02097       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l02098"></a>02098       <span class="keywordflow">if</span> (c1)
<a name="l02099"></a>02099          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l02100"></a>02100       <span class="keywordflow">return</span> -1;
<a name="l02101"></a>02101    }
<a name="l02102"></a>02102    <span class="keywordflow">if</span> (!srcpr) {
<a name="l02103"></a>02103       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Channel &apos;%s&apos; has no RTP, not doing anything\n&quot;</span>, c1 ? c1-&gt;name : <span class="stringliteral">&quot;&lt;unspecified&gt;&quot;</span>);
<a name="l02104"></a>02104       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l02105"></a>02105       <span class="keywordflow">if</span> (c1)
<a name="l02106"></a>02106          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l02107"></a>02107       <span class="keywordflow">return</span> -1;
<a name="l02108"></a>02108    }
<a name="l02109"></a>02109 
<a name="l02110"></a>02110    <span class="comment">/* Get audio, video  and text interface (if native bridge is possible) */</span>
<a name="l02111"></a>02111    audio_dest_res = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aad2be0227a36efe9efc1fea51dd407a5">get_rtp_info</a>(c0, &amp;destp);
<a name="l02112"></a>02112    video_dest_res = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aea1ff20567813f95ff79f94c554fff27">get_vrtp_info</a> ? destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aea1ff20567813f95ff79f94c554fff27">get_vrtp_info</a>(c0, &amp;vdestp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02113"></a>02113    text_dest_res = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#ae3c52f1d063f37511bf26a747639254a">get_trtp_info</a> ? destpr-&gt;<a class="code" href="structast__rtp__protocol.html#ae3c52f1d063f37511bf26a747639254a">get_trtp_info</a>(c0, &amp;tdestp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02114"></a>02114    <span class="keywordflow">if</span> (srcpr) {
<a name="l02115"></a>02115       audio_src_res = srcpr-&gt;get_rtp_info(c1, &amp;srcp);
<a name="l02116"></a>02116       video_src_res = srcpr-&gt;get_vrtp_info ? srcpr-&gt;get_vrtp_info(c1, &amp;vsrcp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02117"></a>02117       text_src_res = srcpr-&gt;get_trtp_info ? srcpr-&gt;get_trtp_info(c1, &amp;tsrcp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02118"></a>02118    }
<a name="l02119"></a>02119 
<a name="l02120"></a>02120    <span class="comment">/* Check if bridge is still possible (In SIP directmedia=no stops this, like NAT) */</span>
<a name="l02121"></a>02121    <span class="keywordflow">if</span> (audio_dest_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> || (video_dest_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> &amp;&amp; video_dest_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>)) {
<a name="l02122"></a>02122       <span class="comment">/* Somebody doesn&apos;t want to play... */</span>
<a name="l02123"></a>02123       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l02124"></a>02124       <span class="keywordflow">if</span> (c1)
<a name="l02125"></a>02125          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l02126"></a>02126       <span class="keywordflow">return</span> -1;
<a name="l02127"></a>02127    }
<a name="l02128"></a>02128    <span class="keywordflow">if</span> (audio_src_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> &amp;&amp; (video_src_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> || video_src_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>) &amp;&amp; srcpr-&gt;get_codec)
<a name="l02129"></a>02129       srccodec = srcpr-&gt;get_codec(c1);
<a name="l02130"></a>02130    <span class="keywordflow">else</span>
<a name="l02131"></a>02131       srccodec = 0;
<a name="l02132"></a>02132    <span class="keywordflow">if</span> (audio_dest_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> &amp;&amp; (video_dest_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> || video_dest_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>) &amp;&amp; destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>)
<a name="l02133"></a>02133       destcodec = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(c0);
<a name="l02134"></a>02134    <span class="keywordflow">else</span>
<a name="l02135"></a>02135       destcodec = 0;
<a name="l02136"></a>02136    <span class="comment">/* Ensure we have at least one matching codec */</span>
<a name="l02137"></a>02137    <span class="keywordflow">if</span> (srcp &amp;&amp; !(srccodec &amp; destcodec)) {
<a name="l02138"></a>02138       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l02139"></a>02139       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l02140"></a>02140       <span class="keywordflow">return</span> 0;
<a name="l02141"></a>02141    }
<a name="l02142"></a>02142    <span class="comment">/* Consider empty media as non-existent */</span>
<a name="l02143"></a>02143    <span class="keywordflow">if</span> (audio_src_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> &amp;&amp; !srcp-&gt;them.sin_addr.s_addr)
<a name="l02144"></a>02144       srcp = NULL;
<a name="l02145"></a>02145    <span class="keywordflow">if</span> (srcp &amp;&amp; (srcp-&gt;nat || <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(srcp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>)))
<a name="l02146"></a>02146       nat_active = 1;
<a name="l02147"></a>02147    <span class="comment">/* Bridge media early */</span>
<a name="l02148"></a>02148    <span class="keywordflow">if</span> (destpr-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, srcp, vsrcp, tsrcp, srccodec, nat_active))
<a name="l02149"></a>02149       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to setup early bridge to &apos;%s&apos;\n&quot;</span>, c0-&gt;name, c1 ? c1-&gt;name : <span class="stringliteral">&quot;&lt;unspecified&gt;&quot;</span>);
<a name="l02150"></a>02150    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l02151"></a>02151    <span class="keywordflow">if</span> (c1)
<a name="l02152"></a>02152       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l02153"></a>02153    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Setting early bridge SDP of &apos;%s&apos; with that of &apos;%s&apos;\n&quot;</span>, c0-&gt;name, c1 ? c1-&gt;name : <span class="stringliteral">&quot;&lt;unspecified&gt;&quot;</span>);
<a name="l02154"></a>02154    <span class="keywordflow">return</span> 0;
<a name="l02155"></a>02155 }
<a name="l02156"></a>02156 
<a name="l02157"></a><a class="code" href="rtp_8c.html#ad410e7253fcf8b398328276412d4232e">02157</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#ad410e7253fcf8b398328276412d4232e">ast_rtp_make_compatible</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *dest, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *src, <span class="keywordtype">int</span> media)
<a name="l02158"></a>02158 {
<a name="l02159"></a>02159    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *destp = NULL, *srcp = NULL;     <span class="comment">/* Audio RTP Channels */</span>
<a name="l02160"></a>02160    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *vdestp = NULL, *vsrcp = NULL;      <span class="comment">/* Video RTP channels */</span>
<a name="l02161"></a>02161    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tdestp = NULL, *tsrcp = NULL;      <span class="comment">/* Text RTP channels */</span>
<a name="l02162"></a>02162    <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *destpr = NULL, *srcpr = NULL;
<a name="l02163"></a>02163    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> audio_dest_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, video_dest_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, text_dest_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02164"></a>02164    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> audio_src_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, video_src_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, text_src_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>; 
<a name="l02165"></a>02165    <span class="keywordtype">int</span> srccodec, destcodec;
<a name="l02166"></a>02166 
<a name="l02167"></a>02167    <span class="comment">/* Lock channels */</span>
<a name="l02168"></a>02168    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(dest);
<a name="l02169"></a>02169    <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(src)) {
<a name="l02170"></a>02170       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(dest);
<a name="l02171"></a>02171       usleep(1);
<a name="l02172"></a>02172       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(dest);
<a name="l02173"></a>02173    }
<a name="l02174"></a>02174 
<a name="l02175"></a>02175    <span class="comment">/* Find channel driver interfaces */</span>
<a name="l02176"></a>02176    <span class="keywordflow">if</span> (!(destpr = <a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(dest))) {
<a name="l02177"></a>02177       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Channel &apos;%s&apos; has no RTP, not doing anything\n&quot;</span>, dest-&gt;name);
<a name="l02178"></a>02178       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(dest);
<a name="l02179"></a>02179       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(src);
<a name="l02180"></a>02180       <span class="keywordflow">return</span> 0;
<a name="l02181"></a>02181    }
<a name="l02182"></a>02182    <span class="keywordflow">if</span> (!(srcpr = <a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(src))) {
<a name="l02183"></a>02183       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Channel &apos;%s&apos; has no RTP, not doing anything\n&quot;</span>, src-&gt;name);
<a name="l02184"></a>02184       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(dest);
<a name="l02185"></a>02185       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(src);
<a name="l02186"></a>02186       <span class="keywordflow">return</span> 0;
<a name="l02187"></a>02187    }
<a name="l02188"></a>02188 
<a name="l02189"></a>02189    <span class="comment">/* Get audio and video interface (if native bridge is possible) */</span>
<a name="l02190"></a>02190    audio_dest_res = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aad2be0227a36efe9efc1fea51dd407a5">get_rtp_info</a>(dest, &amp;destp);
<a name="l02191"></a>02191    video_dest_res = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aea1ff20567813f95ff79f94c554fff27">get_vrtp_info</a> ? destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aea1ff20567813f95ff79f94c554fff27">get_vrtp_info</a>(dest, &amp;vdestp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02192"></a>02192    text_dest_res = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#ae3c52f1d063f37511bf26a747639254a">get_trtp_info</a> ? destpr-&gt;<a class="code" href="structast__rtp__protocol.html#ae3c52f1d063f37511bf26a747639254a">get_trtp_info</a>(dest, &amp;tdestp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02193"></a>02193    audio_src_res = srcpr-&gt;get_rtp_info(src, &amp;srcp);
<a name="l02194"></a>02194    video_src_res = srcpr-&gt;get_vrtp_info ? srcpr-&gt;get_vrtp_info(src, &amp;vsrcp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02195"></a>02195    text_src_res = srcpr-&gt;get_trtp_info ? srcpr-&gt;get_trtp_info(src, &amp;tsrcp) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l02196"></a>02196 
<a name="l02197"></a>02197    <span class="comment">/* Ensure we have at least one matching codec */</span>
<a name="l02198"></a>02198    <span class="keywordflow">if</span> (srcpr-&gt;get_codec)
<a name="l02199"></a>02199       srccodec = srcpr-&gt;get_codec(src);
<a name="l02200"></a>02200    <span class="keywordflow">else</span>
<a name="l02201"></a>02201       srccodec = 0;
<a name="l02202"></a>02202    <span class="keywordflow">if</span> (destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>)
<a name="l02203"></a>02203       destcodec = destpr-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(dest);
<a name="l02204"></a>02204    <span class="keywordflow">else</span>
<a name="l02205"></a>02205       destcodec = 0;
<a name="l02206"></a>02206 
<a name="l02207"></a>02207    <span class="comment">/* Check if bridge is still possible (In SIP directmedia=no stops this, like NAT) */</span>
<a name="l02208"></a>02208    <span class="keywordflow">if</span> (audio_dest_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> || (video_dest_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> &amp;&amp; video_dest_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>) || audio_src_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> || (video_src_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> &amp;&amp; video_src_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>) || !(srccodec &amp; destcodec)) {
<a name="l02209"></a>02209       <span class="comment">/* Somebody doesn&apos;t want to play... */</span>
<a name="l02210"></a>02210       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(dest);
<a name="l02211"></a>02211       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(src);
<a name="l02212"></a>02212       <span class="keywordflow">return</span> 0;
<a name="l02213"></a>02213    }
<a name="l02214"></a>02214    <a class="code" href="rtp_8h.html#a30cfc736f18627e5d0d25196a116faa1" title="Copy payload types between RTP structures.">ast_rtp_pt_copy</a>(destp, srcp);
<a name="l02215"></a>02215    <span class="keywordflow">if</span> (vdestp &amp;&amp; vsrcp)
<a name="l02216"></a>02216       <a class="code" href="rtp_8h.html#a30cfc736f18627e5d0d25196a116faa1" title="Copy payload types between RTP structures.">ast_rtp_pt_copy</a>(vdestp, vsrcp);
<a name="l02217"></a>02217    <span class="keywordflow">if</span> (tdestp &amp;&amp; tsrcp)
<a name="l02218"></a>02218       <a class="code" href="rtp_8h.html#a30cfc736f18627e5d0d25196a116faa1" title="Copy payload types between RTP structures.">ast_rtp_pt_copy</a>(tdestp, tsrcp);
<a name="l02219"></a>02219    <span class="keywordflow">if</span> (media) {
<a name="l02220"></a>02220       <span class="comment">/* Bridge early */</span>
<a name="l02221"></a>02221       <span class="keywordflow">if</span> (destpr-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(dest, srcp, vsrcp, tsrcp, srccodec, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(srcp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>)))
<a name="l02222"></a>02222          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to setup early bridge to &apos;%s&apos;\n&quot;</span>, dest-&gt;name, src-&gt;name);
<a name="l02223"></a>02223    }
<a name="l02224"></a>02224    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(dest);
<a name="l02225"></a>02225    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(src);
<a name="l02226"></a>02226    <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Seeded SDP of &apos;%s&apos; with that of &apos;%s&apos;\n&quot;</span>, dest-&gt;name, src-&gt;name);
<a name="l02227"></a>02227    <span class="keywordflow">return</span> 1;
<a name="l02228"></a>02228 }
<a name="l02229"></a>02229 <span class="comment"></span>
<a name="l02230"></a>02230 <span class="comment">/*! \brief  Make a note of a RTP payload type that was seen in a SDP &quot;m=&quot; line.</span>
<a name="l02231"></a>02231 <span class="comment"> * By default, use the well-known value for this type (although it may </span>
<a name="l02232"></a>02232 <span class="comment"> * still be set to a different value by a subsequent &quot;a=rtpmap:&quot; line)</span>
<a name="l02233"></a>02233 <span class="comment"> */</span>
<a name="l02234"></a><a class="code" href="rtp_8c.html#a83fe16478ba4b99f0bc1798f1064baef">02234</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a83fe16478ba4b99f0bc1798f1064baef" title="Activate payload type.">ast_rtp_set_m_type</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp, <span class="keywordtype">int</span> pt) 
<a name="l02235"></a>02235 {
<a name="l02236"></a>02236    <span class="keywordflow">if</span> (pt &lt; 0 || pt &gt;= <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a> || static_RTP_PT[pt].code == 0) 
<a name="l02237"></a>02237       <span class="keywordflow">return</span>; <span class="comment">/* bogus payload type */</span>
<a name="l02238"></a>02238 
<a name="l02239"></a>02239    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02240"></a>02240    rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt] = static_RTP_PT[pt];
<a name="l02241"></a>02241    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02242"></a>02242 } 
<a name="l02243"></a>02243 <span class="comment"></span>
<a name="l02244"></a>02244 <span class="comment">/*! \brief remove setting from payload type list if the rtpmap header indicates</span>
<a name="l02245"></a>02245 <span class="comment">   an unknown media type */</span>
<a name="l02246"></a><a class="code" href="rtp_8c.html#af509d36b6cbaefc1c0c5f7c754967555">02246</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#af509d36b6cbaefc1c0c5f7c754967555" title="clear payload type">ast_rtp_unset_m_type</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp, <span class="keywordtype">int</span> pt) 
<a name="l02247"></a>02247 {
<a name="l02248"></a>02248    <span class="keywordflow">if</span> (pt &lt; 0 || pt &gt;= <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>)
<a name="l02249"></a>02249       <span class="keywordflow">return</span>; <span class="comment">/* bogus payload type */</span>
<a name="l02250"></a>02250 
<a name="l02251"></a>02251    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02252"></a>02252    rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> = 0;
<a name="l02253"></a>02253    rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> = 0;
<a name="l02254"></a>02254    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02255"></a>02255 }
<a name="l02256"></a>02256 <span class="comment"></span>
<a name="l02257"></a>02257 <span class="comment">/*! \brief Make a note of a RTP payload type (with MIME type) that was seen in</span>
<a name="l02258"></a>02258 <span class="comment"> * an SDP &quot;a=rtpmap:&quot; line.</span>
<a name="l02259"></a>02259 <span class="comment"> * \return 0 if the MIME type was found and set, -1 if it wasn&apos;t found</span>
<a name="l02260"></a>02260 <span class="comment"> */</span>
<a name="l02261"></a><a class="code" href="rtp_8c.html#a1c0ef66aed0fb55f27f44154cce3e238">02261</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a1c0ef66aed0fb55f27f44154cce3e238" title="Set payload type to a known MIME media type for a codec with a specific sample rate...">ast_rtp_set_rtpmap_type_rate</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> pt,
<a name="l02262"></a>02262              <span class="keywordtype">char</span> *<a class="code" href="structmimeType.html">mimeType</a>, <span class="keywordtype">char</span> *mimeSubtype,
<a name="l02263"></a>02263              <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#a95ccef8388e3b0e9c9639e393d4081b6">ast_rtp_options</a> options,
<a name="l02264"></a>02264              <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> sample_rate)
<a name="l02265"></a>02265 {
<a name="l02266"></a>02266    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02267"></a>02267    <span class="keywordtype">int</span> found = 0;
<a name="l02268"></a>02268 
<a name="l02269"></a>02269    <span class="keywordflow">if</span> (pt &lt; 0 || pt &gt;= <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>)
<a name="l02270"></a>02270       <span class="keywordflow">return</span> -1; <span class="comment">/* bogus payload type */</span>
<a name="l02271"></a>02271 
<a name="l02272"></a>02272    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02273"></a>02273 
<a name="l02274"></a>02274    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>); ++i) {
<a name="l02275"></a>02275       <span class="keyword">const</span> <span class="keyword">struct </span>mimeType *t = &amp;<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i];
<a name="l02276"></a>02276 
<a name="l02277"></a>02277       <span class="keywordflow">if</span> (strcasecmp(mimeSubtype, t-&gt;<a class="code" href="structmimeType.html#a2f076846fbd6b30183ba3ab61e3334e5">subtype</a>)) {
<a name="l02278"></a>02278          <span class="keywordflow">continue</span>;
<a name="l02279"></a>02279       }
<a name="l02280"></a>02280 
<a name="l02281"></a>02281       <span class="keywordflow">if</span> (strcasecmp(mimeType, t-&gt;<a class="code" href="structmimeType.html#a23506fc4821ab6d9671f3e6222591a96">type</a>)) {
<a name="l02282"></a>02282          <span class="keywordflow">continue</span>;
<a name="l02283"></a>02283       }
<a name="l02284"></a>02284 
<a name="l02285"></a>02285       <span class="comment">/* if both sample rates have been supplied, and they don&apos;t match,</span>
<a name="l02286"></a>02286 <span class="comment">         then this not a match; if one has not been supplied, then the</span>
<a name="l02287"></a>02287 <span class="comment">         rates are not compared */</span>
<a name="l02288"></a>02288       <span class="keywordflow">if</span> (sample_rate &amp;&amp; t-&gt;<a class="code" href="structmimeType.html#a1c086f81c095b0efd7a87ee29fc5ba7e">sample_rate</a> &amp;&amp;
<a name="l02289"></a>02289           (sample_rate != t-&gt;<a class="code" href="structmimeType.html#a1c086f81c095b0efd7a87ee29fc5ba7e">sample_rate</a>)) {
<a name="l02290"></a>02290          <span class="keywordflow">continue</span>;
<a name="l02291"></a>02291       }
<a name="l02292"></a>02292 
<a name="l02293"></a>02293       found = 1;
<a name="l02294"></a>02294       rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt] = t-&gt;<a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">payloadType</a>;
<a name="l02295"></a>02295 
<a name="l02296"></a>02296       <span class="keywordflow">if</span> ((t-&gt;<a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">payloadType</a>.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> == <a class="code" href="frame_8h.html#a030c77081bc2aff5ae5a384769f46418">AST_FORMAT_G726</a>) &amp;&amp;
<a name="l02297"></a>02297           t-&gt;<a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">payloadType</a>.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> &amp;&amp;
<a name="l02298"></a>02298           (options &amp; <a class="code" href="rtp_8h.html#a95ccef8388e3b0e9c9639e393d4081b6ad570d49420fe15c4660793d1fc2f0fc8">AST_RTP_OPT_G726_NONSTANDARD</a>)) {
<a name="l02299"></a>02299          rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> = <a class="code" href="frame_8h.html#a536fbd427f197a33e679c7721afad420">AST_FORMAT_G726_AAL2</a>;
<a name="l02300"></a>02300       }
<a name="l02301"></a>02301 
<a name="l02302"></a>02302       <span class="keywordflow">break</span>;
<a name="l02303"></a>02303    }
<a name="l02304"></a>02304 
<a name="l02305"></a>02305    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02306"></a>02306 
<a name="l02307"></a>02307    <span class="keywordflow">return</span> (found ? 0 : -2);
<a name="l02308"></a>02308 }
<a name="l02309"></a>02309 
<a name="l02310"></a><a class="code" href="rtp_8c.html#a02a3ba4e11691cafd933cbb1e6225b3e">02310</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a02a3ba4e11691cafd933cbb1e6225b3e" title="Set payload type to a known MIME media type for a codec.">ast_rtp_set_rtpmap_type</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> pt,
<a name="l02311"></a>02311              <span class="keywordtype">char</span> *<a class="code" href="structmimeType.html">mimeType</a>, <span class="keywordtype">char</span> *mimeSubtype,
<a name="l02312"></a>02312              <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#a95ccef8388e3b0e9c9639e393d4081b6">ast_rtp_options</a> options)
<a name="l02313"></a>02313 {
<a name="l02314"></a>02314    <span class="keywordflow">return</span> <a class="code" href="rtp_8h.html#a1c0ef66aed0fb55f27f44154cce3e238" title="Set payload type to a known MIME media type for a codec with a specific sample rate...">ast_rtp_set_rtpmap_type_rate</a>(rtp, pt, mimeType, mimeSubtype, options, 0);
<a name="l02315"></a>02315 }
<a name="l02316"></a>02316 <span class="comment"></span>
<a name="l02317"></a>02317 <span class="comment">/*! \brief Return the union of all of the codecs that were set by rtp_set...() calls </span>
<a name="l02318"></a>02318 <span class="comment"> * They&apos;re returned as two distinct sets: AST_FORMATs, and AST_RTPs */</span>
<a name="l02319"></a><a class="code" href="rtp_8c.html#a0af7232148535d9bc024fc01579d4ec8">02319</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a0af7232148535d9bc024fc01579d4ec8" title="Return the union of all of the codecs that were set by rtp_set...() calls They&amp;#39;re...">ast_rtp_get_current_formats</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp,
<a name="l02320"></a>02320              <span class="keywordtype">int</span>* astFormats, <span class="keywordtype">int</span>* nonAstFormats)
<a name="l02321"></a>02321 {
<a name="l02322"></a>02322    <span class="keywordtype">int</span> pt;
<a name="l02323"></a>02323    
<a name="l02324"></a>02324    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02325"></a>02325    
<a name="l02326"></a>02326    *astFormats = *nonAstFormats = 0;
<a name="l02327"></a>02327    <span class="keywordflow">for</span> (pt = 0; pt &lt; <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>; ++pt) {
<a name="l02328"></a>02328       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>) {
<a name="l02329"></a>02329          *astFormats |= rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>;
<a name="l02330"></a>02330       } <span class="keywordflow">else</span> {
<a name="l02331"></a>02331          *nonAstFormats |= rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>;
<a name="l02332"></a>02332       }
<a name="l02333"></a>02333    }
<a name="l02334"></a>02334 
<a name="l02335"></a>02335    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02336"></a>02336 }
<a name="l02337"></a>02337 
<a name="l02338"></a><a class="code" href="rtp_8c.html#a9fdf56baeb1e0ca97859d10826bdd1de">02338</a> <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> <a class="code" href="rtp_8h.html#a9fdf56baeb1e0ca97859d10826bdd1de" title="Mapping between RTP payload format codes and Asterisk codes:.">ast_rtp_lookup_pt</a>(struct <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp, <span class="keywordtype">int</span> pt) 
<a name="l02339"></a>02339 {
<a name="l02340"></a>02340    <span class="keyword">struct </span><a class="code" href="structrtpPayloadType.html" title="The value of each payload format mapping:.">rtpPayloadType</a> result;
<a name="l02341"></a>02341 
<a name="l02342"></a>02342    result.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> = result.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> = 0;
<a name="l02343"></a>02343 
<a name="l02344"></a>02344    <span class="keywordflow">if</span> (pt &lt; 0 || pt &gt;= <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>) 
<a name="l02345"></a>02345       <span class="keywordflow">return</span> result; <span class="comment">/* bogus payload type */</span>
<a name="l02346"></a>02346 
<a name="l02347"></a>02347    <span class="comment">/* Start with negotiated codecs */</span>
<a name="l02348"></a>02348    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02349"></a>02349    result = rtp-&gt;current_RTP_PT[pt];
<a name="l02350"></a>02350    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02351"></a>02351 
<a name="l02352"></a>02352    <span class="comment">/* If it doesn&apos;t exist, check our static RTP type list, just in case */</span>
<a name="l02353"></a>02353    <span class="keywordflow">if</span> (!result.<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>) 
<a name="l02354"></a>02354       result = static_RTP_PT[pt];
<a name="l02355"></a>02355 
<a name="l02356"></a>02356    <span class="keywordflow">return</span> result;
<a name="l02357"></a>02357 }
<a name="l02358"></a>02358 <span class="comment"></span>
<a name="l02359"></a>02359 <span class="comment">/*! \brief Looks up an RTP code out of our *static* outbound list */</span>
<a name="l02360"></a><a class="code" href="rtp_8c.html#a6ef467a579e8d4febb2923c1c161cbe5">02360</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a4daa559b8f2ef25bc33d8f5d8fd937d1" title="Looks up an RTP code out of our *static* outbound list.">ast_rtp_lookup_code</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>* rtp, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>)
<a name="l02361"></a>02361 {
<a name="l02362"></a>02362    <span class="keywordtype">int</span> pt = 0;
<a name="l02363"></a>02363 
<a name="l02364"></a>02364    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02365"></a>02365 
<a name="l02366"></a>02366    <span class="keywordflow">if</span> (isAstFormat == rtp-&gt;<a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a> &amp;&amp;
<a name="l02367"></a>02367       code == rtp-&gt;<a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a>) {
<a name="l02368"></a>02368       <span class="comment">/* Use our cached mapping, to avoid the overhead of the loop below */</span>
<a name="l02369"></a>02369       pt = rtp-&gt;<a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a>;
<a name="l02370"></a>02370       <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02371"></a>02371       <span class="keywordflow">return</span> pt;
<a name="l02372"></a>02372    }
<a name="l02373"></a>02373 
<a name="l02374"></a>02374    <span class="comment">/* Check the dynamic list first */</span>
<a name="l02375"></a>02375    <span class="keywordflow">for</span> (pt = 0; pt &lt; <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>; ++pt) {
<a name="l02376"></a>02376       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a> == code &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a326c376c0e9d4d7572cc3706205dbd01">current_RTP_PT</a>[pt].<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> == isAstFormat) {
<a name="l02377"></a>02377          rtp-&gt;<a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a> = isAstFormat;
<a name="l02378"></a>02378          rtp-&gt;<a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a> = code;
<a name="l02379"></a>02379          rtp-&gt;<a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a> = pt;
<a name="l02380"></a>02380          <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02381"></a>02381          <span class="keywordflow">return</span> pt;
<a name="l02382"></a>02382       }
<a name="l02383"></a>02383    }
<a name="l02384"></a>02384 
<a name="l02385"></a>02385    <span class="comment">/* Then the static list */</span>
<a name="l02386"></a>02386    <span class="keywordflow">for</span> (pt = 0; pt &lt; MAX_RTP_PT; ++pt) {
<a name="l02387"></a>02387       <span class="keywordflow">if</span> (static_RTP_PT[pt].code == code &amp;&amp; static_RTP_PT[pt].isAstFormat == isAstFormat) {
<a name="l02388"></a>02388          rtp-&gt;<a class="code" href="structast__rtp.html#ab087642ddcdd0db71470c90429925385">rtp_lookup_code_cache_isAstFormat</a> = isAstFormat;
<a name="l02389"></a>02389          rtp-&gt;<a class="code" href="structast__rtp.html#aaf7a119e1a2e85949f9340b0a63f9c4c">rtp_lookup_code_cache_code</a> = code;
<a name="l02390"></a>02390          rtp-&gt;<a class="code" href="structast__rtp.html#a7c7662b43c622f94d684c20139efc983">rtp_lookup_code_cache_result</a> = pt;
<a name="l02391"></a>02391          <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02392"></a>02392          <span class="keywordflow">return</span> pt;
<a name="l02393"></a>02393       }
<a name="l02394"></a>02394    }
<a name="l02395"></a>02395 
<a name="l02396"></a>02396    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02397"></a>02397 
<a name="l02398"></a>02398    <span class="keywordflow">return</span> -1;
<a name="l02399"></a>02399 }
<a name="l02400"></a>02400 
<a name="l02401"></a><a class="code" href="rtp_8c.html#a20fb5eacf32b2b35fa0a40c8b2384f42">02401</a> <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8h.html#ac740a1df73c95aecb587ccc0d46251a5" title="Mapping an Asterisk code into a MIME subtype (string):.">ast_rtp_lookup_mime_subtype</a>(<span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>,
<a name="l02402"></a>02402               <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#a95ccef8388e3b0e9c9639e393d4081b6">ast_rtp_options</a> options)
<a name="l02403"></a>02403 {
<a name="l02404"></a>02404    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02405"></a>02405 
<a name="l02406"></a>02406    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>); ++i) {
<a name="l02407"></a>02407       <span class="keywordflow">if</span> ((<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i].payloadType.code == code) &amp;&amp; (<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i].<a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">payloadType</a>.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> == isAstFormat)) {
<a name="l02408"></a>02408          <span class="keywordflow">if</span> (isAstFormat &amp;&amp;
<a name="l02409"></a>02409              (code == <a class="code" href="frame_8h.html#a536fbd427f197a33e679c7721afad420">AST_FORMAT_G726_AAL2</a>) &amp;&amp;
<a name="l02410"></a>02410              (options &amp; <a class="code" href="rtp_8h.html#a95ccef8388e3b0e9c9639e393d4081b6ad570d49420fe15c4660793d1fc2f0fc8">AST_RTP_OPT_G726_NONSTANDARD</a>))
<a name="l02411"></a>02411             <span class="keywordflow">return</span> <span class="stringliteral">&quot;G726-32&quot;</span>;
<a name="l02412"></a>02412          <span class="keywordflow">else</span>
<a name="l02413"></a>02413             <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i].<a class="code" href="structmimeType.html#a2f076846fbd6b30183ba3ab61e3334e5">subtype</a>;
<a name="l02414"></a>02414       }
<a name="l02415"></a>02415    }
<a name="l02416"></a>02416 
<a name="l02417"></a>02417    <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l02418"></a>02418 }
<a name="l02419"></a>02419 
<a name="l02420"></a><a class="code" href="rtp_8c.html#af081370a8afd454b1f8cae5bdc55be09">02420</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#af081370a8afd454b1f8cae5bdc55be09" title="Get the sample rate associated with known RTP payload types.">ast_rtp_lookup_sample_rate</a>(<span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>, <span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>)
<a name="l02421"></a>02421 {
<a name="l02422"></a>02422    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
<a name="l02423"></a>02423 
<a name="l02424"></a>02424    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="isdn__lib_8c.html#ab9129b977a587b50ea801daac75e178f">ARRAY_LEN</a>(<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>); ++i) {
<a name="l02425"></a>02425       <span class="keywordflow">if</span> ((<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i].payloadType.code == code) &amp;&amp; (<a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i].<a class="code" href="structmimeType.html#a18e919f09824102c5924529a8e2bf3a5">payloadType</a>.<a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a> == isAstFormat)) {
<a name="l02426"></a>02426          <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#ac28159d67093186b89f90cc742d611f4">mimeTypes</a>[i].<a class="code" href="structmimeType.html#a1c086f81c095b0efd7a87ee29fc5ba7e">sample_rate</a>;
<a name="l02427"></a>02427       }
<a name="l02428"></a>02428    }
<a name="l02429"></a>02429 
<a name="l02430"></a>02430    <span class="keywordflow">return</span> 0;
<a name="l02431"></a>02431 }
<a name="l02432"></a>02432 
<a name="l02433"></a><a class="code" href="rtp_8c.html#a00ae5fb20d1016e2fdf140befbebff05">02433</a> <span class="keywordtype">char</span> *<a class="code" href="rtp_8h.html#a00ae5fb20d1016e2fdf140befbebff05" title="Build a string of MIME subtype names from a capability list.">ast_rtp_lookup_mime_multiple</a>(<span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">size_t</span> size, <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="chan__mgcp_8c.html#afa05b14ff7f76f303c784c00c4c63fa7">capability</a>,
<a name="l02434"></a>02434                <span class="keyword">const</span> <span class="keywordtype">int</span> <a class="code" href="structrtpPayloadType.html#a6916911180850cb1b6045fa9b6927b02">isAstFormat</a>, <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#a95ccef8388e3b0e9c9639e393d4081b6">ast_rtp_options</a> options)
<a name="l02435"></a>02435 {
<a name="l02436"></a>02436    <span class="keywordtype">int</span> <a class="code" href="cdr__custom_8c.html#a2177723f86d0a496f395614f4493cd7f">format</a>;
<a name="l02437"></a>02437    <span class="keywordtype">unsigned</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l02438"></a>02438    <span class="keywordtype">char</span> *end = buf;
<a name="l02439"></a>02439    <span class="keywordtype">char</span> *start = buf;
<a name="l02440"></a>02440 
<a name="l02441"></a>02441    <span class="keywordflow">if</span> (!buf || !size)
<a name="l02442"></a>02442       <span class="keywordflow">return</span> NULL;
<a name="l02443"></a>02443 
<a name="l02444"></a>02444    snprintf(end, size, <span class="stringliteral">&quot;0x%x (&quot;</span>, capability);
<a name="l02445"></a>02445 
<a name="l02446"></a>02446    len = strlen(end);
<a name="l02447"></a>02447    end += len;
<a name="l02448"></a>02448    size -= len;
<a name="l02449"></a>02449    start = end;
<a name="l02450"></a>02450 
<a name="l02451"></a>02451    <span class="keywordflow">for</span> (format = 1; format &lt; <a class="code" href="rtp_8h.html#ae89f572a6b37614f05f4e210afcffa8c">AST_RTP_MAX</a>; format &lt;&lt;= 1) {
<a name="l02452"></a>02452       <span class="keywordflow">if</span> (capability &amp; format) {
<a name="l02453"></a>02453          <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="cdr__adaptive__odbc_8c.html#a5ac083a645d964373f022d03df4849c8">name</a> = <a class="code" href="rtp_8h.html#ac740a1df73c95aecb587ccc0d46251a5" title="Mapping an Asterisk code into a MIME subtype (string):.">ast_rtp_lookup_mime_subtype</a>(isAstFormat, format, options);
<a name="l02454"></a>02454 
<a name="l02455"></a>02455          snprintf(end, size, <span class="stringliteral">&quot;%s|&quot;</span>, name);
<a name="l02456"></a>02456          len = strlen(end);
<a name="l02457"></a>02457          end += len;
<a name="l02458"></a>02458          size -= len;
<a name="l02459"></a>02459       }
<a name="l02460"></a>02460    }
<a name="l02461"></a>02461 
<a name="l02462"></a>02462    <span class="keywordflow">if</span> (start == end)
<a name="l02463"></a>02463       <a class="code" href="strings_8h.html#a17df4d252f3e2ecb230b526475ac4d93" title="Size-limited null-terminating string copy.">ast_copy_string</a>(start, <span class="stringliteral">&quot;nothing)&quot;</span>, size); 
<a name="l02464"></a>02464    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (size &gt; 1)
<a name="l02465"></a>02465       *(end -1) = <span class="charliteral">&apos;)&apos;</span>;
<a name="l02466"></a>02466    
<a name="l02467"></a>02467    <span class="keywordflow">return</span> buf;
<a name="l02468"></a>02468 }
<a name="l02469"></a>02469 <span class="comment"></span>
<a name="l02470"></a>02470 <span class="comment">/*! \brief Open RTP or RTCP socket for a session.</span>
<a name="l02471"></a>02471 <span class="comment"> * Print a message on failure. </span>
<a name="l02472"></a>02472 <span class="comment"> */</span>
<a name="l02473"></a><a class="code" href="rtp_8c.html#a55bb1a68c0eb9c45c39ccc4924f8ad12">02473</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a55bb1a68c0eb9c45c39ccc4924f8ad12" title="Open RTP or RTCP socket for a session. Print a message on failure.">rtp_socket</a>(<span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="evt_8c.html#a69e2889a94aeb9ac881abb82d3c22116">type</a>)
<a name="l02474"></a>02474 {
<a name="l02475"></a>02475    <span class="keywordtype">int</span> <a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a> = socket(AF_INET, SOCK_DGRAM, 0);
<a name="l02476"></a>02476    <span class="keywordflow">if</span> (s &lt; 0) {
<a name="l02477"></a>02477       <span class="keywordflow">if</span> (type == NULL)
<a name="l02478"></a>02478          type = <span class="stringliteral">&quot;RTP/RTCP&quot;</span>;
<a name="l02479"></a>02479       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to allocate %s socket: %s\n&quot;</span>, type, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02480"></a>02480    } <span class="keywordflow">else</span> {
<a name="l02481"></a>02481       <span class="keywordtype">long</span> flags = fcntl(s, F_GETFL);
<a name="l02482"></a>02482       fcntl(s, F_SETFL, flags | O_NONBLOCK);
<a name="l02483"></a>02483 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l02484"></a>02484 <span class="preprocessor"></span>      <span class="keywordflow">if</span> (nochecksums)
<a name="l02485"></a>02485          setsockopt(s, SOL_SOCKET, SO_NO_CHECK, &amp;nochecksums, <span class="keyword">sizeof</span>(nochecksums));
<a name="l02486"></a>02486 <span class="preprocessor">#endif</span>
<a name="l02487"></a>02487 <span class="preprocessor"></span>   }
<a name="l02488"></a>02488    <span class="keywordflow">return</span> s;
<a name="l02489"></a>02489 }
<a name="l02490"></a>02490 <span class="comment"></span>
<a name="l02491"></a>02491 <span class="comment">/*!</span>
<a name="l02492"></a>02492 <span class="comment"> * \brief Initialize a new RTCP session.</span>
<a name="l02493"></a>02493 <span class="comment"> * </span>
<a name="l02494"></a>02494 <span class="comment"> * \returns The newly initialized RTCP session.</span>
<a name="l02495"></a>02495 <span class="comment"> */</span>
<a name="l02496"></a><a class="code" href="rtp_8c.html#a0acdf171f7e8718a377fa0c0a5125455">02496</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__rtcp.html" title="Structure defining an RTCP session.">ast_rtcp</a> *<a class="code" href="rtp_8c.html#a0acdf171f7e8718a377fa0c0a5125455" title="Initialize a new RTCP session.">ast_rtcp_new</a>(<span class="keywordtype">void</span>)
<a name="l02497"></a>02497 {
<a name="l02498"></a>02498    <span class="keyword">struct </span><a class="code" href="structast__rtcp.html" title="Structure defining an RTCP session.">ast_rtcp</a> *rtcp;
<a name="l02499"></a>02499 
<a name="l02500"></a>02500    <span class="keywordflow">if</span> (!(rtcp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*rtcp))))
<a name="l02501"></a>02501       <span class="keywordflow">return</span> NULL;
<a name="l02502"></a>02502    rtcp-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a> = <a class="code" href="rtp_8c.html#a55bb1a68c0eb9c45c39ccc4924f8ad12" title="Open RTP or RTCP socket for a session. Print a message on failure.">rtp_socket</a>(<span class="stringliteral">&quot;RTCP&quot;</span>);
<a name="l02503"></a>02503    rtcp-&gt;<a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_family = AF_INET;
<a name="l02504"></a>02504    rtcp-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_family = AF_INET;
<a name="l02505"></a>02505    rtcp-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a> = -1;
<a name="l02506"></a>02506 
<a name="l02507"></a>02507    <span class="keywordflow">if</span> (rtcp-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a> &lt; 0) {
<a name="l02508"></a>02508       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rtcp);
<a name="l02509"></a>02509       <span class="keywordflow">return</span> NULL;
<a name="l02510"></a>02510    }
<a name="l02511"></a>02511 
<a name="l02512"></a>02512    <span class="keywordflow">return</span> rtcp;
<a name="l02513"></a>02513 }
<a name="l02514"></a>02514 <span class="comment"></span>
<a name="l02515"></a>02515 <span class="comment">/*!</span>
<a name="l02516"></a>02516 <span class="comment"> * \brief Initialize a new RTP structure.</span>
<a name="l02517"></a>02517 <span class="comment"> *</span>
<a name="l02518"></a>02518 <span class="comment"> */</span>
<a name="l02519"></a><a class="code" href="rtp_8c.html#ad1235778d2cb1fbe8b1339b43ca3602c">02519</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#ad1235778d2cb1fbe8b1339b43ca3602c" title="Initialize a new RTP structure.">ast_rtp_new_init</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02520"></a>02520 {
<a name="l02521"></a>02521 <span class="preprocessor">#ifdef P2P_INTENSE</span>
<a name="l02522"></a>02522 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#a5dc895fe6e8c089175159fc22e33fc3b">ast_mutex_init</a>(&amp;rtp-&gt;bridge_lock);
<a name="l02523"></a>02523 <span class="preprocessor">#endif</span>
<a name="l02524"></a>02524 <span class="preprocessor"></span>
<a name="l02525"></a>02525    rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_family = AF_INET;
<a name="l02526"></a>02526    rtp-&gt;<a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_family = AF_INET;
<a name="l02527"></a>02527    rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>();
<a name="l02528"></a>02528    rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() &amp; 0xffff;
<a name="l02529"></a>02529    <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">FLAG_HAS_DTMF</a>);
<a name="l02530"></a>02530    rtp-&gt;<a class="code" href="structast__rtp.html#a64730d554c32f13303a5a19f39cbd826">strict_rtp_state</a> = (strictrtp ? <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4ba0c26c1144bb830775979deb20e049368">STRICT_RTP_LEARN</a> : <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4bab82bff21db6795dfa152e316f6ae6bc1">STRICT_RTP_OPEN</a>);
<a name="l02531"></a>02531 }
<a name="l02532"></a>02532 
<a name="l02533"></a><a class="code" href="rtp_8c.html#a487ea42535e9bbbeee4553b1fdcc3547">02533</a> <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="rtp_8h.html#a10d5296cd50be78954103b0a0c754640" title="Initializate a RTP session using an in_addr structure.">ast_rtp_new_with_bindaddr</a>(<span class="keyword">struct</span> <a class="code" href="structsched__context.html">sched_context</a> *<a class="code" href="structsched.html">sched</a>, <span class="keyword">struct</span> <a class="code" href="structio__context.html" title="Global IO variables are now in a struct in order to be made threadsafe.">io_context</a> *<a class="code" href="chan__gtalk_8c.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, <span class="keywordtype">int</span> rtcpenable, <span class="keywordtype">int</span> callbackmode, <span class="keyword">struct</span> in_addr addr)
<a name="l02534"></a>02534 {
<a name="l02535"></a>02535    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp;
<a name="l02536"></a>02536    <span class="keywordtype">int</span> x;
<a name="l02537"></a>02537    <span class="keywordtype">int</span> startplace;
<a name="l02538"></a>02538    
<a name="l02539"></a>02539    <span class="keywordflow">if</span> (!(rtp = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(*rtp))))
<a name="l02540"></a>02540       <span class="keywordflow">return</span> NULL;
<a name="l02541"></a>02541 
<a name="l02542"></a>02542    <a class="code" href="rtp_8h.html#ad1235778d2cb1fbe8b1339b43ca3602c" title="Initialize a new RTP structure.">ast_rtp_new_init</a>(rtp);
<a name="l02543"></a>02543 
<a name="l02544"></a>02544    rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a> = <a class="code" href="rtp_8c.html#a55bb1a68c0eb9c45c39ccc4924f8ad12" title="Open RTP or RTCP socket for a session. Print a message on failure.">rtp_socket</a>(<span class="stringliteral">&quot;RTP&quot;</span>);
<a name="l02545"></a>02545    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a> &lt; 0)
<a name="l02546"></a>02546       <span class="keywordflow">goto</span> fail;
<a name="l02547"></a>02547    <span class="keywordflow">if</span> (sched &amp;&amp; rtcpenable) {
<a name="l02548"></a>02548       rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a> = sched;
<a name="l02549"></a>02549       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> = <a class="code" href="rtp_8c.html#a0acdf171f7e8718a377fa0c0a5125455" title="Initialize a new RTCP session.">ast_rtcp_new</a>();
<a name="l02550"></a>02550    }
<a name="l02551"></a>02551    
<a name="l02552"></a>02552    <span class="comment">/*</span>
<a name="l02553"></a>02553 <span class="comment">    * Try to bind the RTP port, x, and possibly the RTCP port, x+1 as well.</span>
<a name="l02554"></a>02554 <span class="comment">    * Start from a random (even, by RTP spec) port number, and</span>
<a name="l02555"></a>02555 <span class="comment">    * iterate until success or no ports are available.</span>
<a name="l02556"></a>02556 <span class="comment">    * Note that the requirement of RTP port being even, or RTCP being the</span>
<a name="l02557"></a>02557 <span class="comment">    * next one, cannot be enforced in presence of a NAT box because the</span>
<a name="l02558"></a>02558 <span class="comment">    * mapping is not under our control.</span>
<a name="l02559"></a>02559 <span class="comment">    */</span>
<a name="l02560"></a>02560    x = (rtpend == rtpstart) ? rtpstart : (<a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>() % (rtpend - rtpstart)) + rtpstart;
<a name="l02561"></a>02561    x = x &amp; ~1;    <span class="comment">/* make it an even number */</span>
<a name="l02562"></a>02562    startplace = x;      <span class="comment">/* remember the starting point */</span>
<a name="l02563"></a>02563    <span class="comment">/* this is constant across the loop */</span>
<a name="l02564"></a>02564    rtp-&gt;<a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr = addr;
<a name="l02565"></a>02565    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>)
<a name="l02566"></a>02566       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_addr = addr;
<a name="l02567"></a>02567    <span class="keywordflow">for</span> (;;) {
<a name="l02568"></a>02568       rtp-&gt;<a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_port = htons(x);
<a name="l02569"></a>02569       <span class="keywordflow">if</span> (!bind(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keyword">struct</span> sockaddr *)&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>))) {
<a name="l02570"></a>02570          <span class="comment">/* bind succeeded, if no rtcp then we are done */</span>
<a name="l02571"></a>02571          <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>)
<a name="l02572"></a>02572             <span class="keywordflow">break</span>;
<a name="l02573"></a>02573          <span class="comment">/* have rtcp, try to bind it */</span>
<a name="l02574"></a>02574          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>.sin_port = htons(x + 1);
<a name="l02575"></a>02575          <span class="keywordflow">if</span> (!bind(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keyword">struct</span> sockaddr *)&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>)))
<a name="l02576"></a>02576             <span class="keywordflow">break</span>;   <span class="comment">/* success again, we are really done */</span>
<a name="l02577"></a>02577          <span class="comment">/*</span>
<a name="l02578"></a>02578 <span class="comment">          * RTCP bind failed, so close and recreate the</span>
<a name="l02579"></a>02579 <span class="comment">          * already bound RTP socket for the next round.</span>
<a name="l02580"></a>02580 <span class="comment">          */</span>
<a name="l02581"></a>02581          close(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>);
<a name="l02582"></a>02582          rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a> = <a class="code" href="rtp_8c.html#a55bb1a68c0eb9c45c39ccc4924f8ad12" title="Open RTP or RTCP socket for a session. Print a message on failure.">rtp_socket</a>(<span class="stringliteral">&quot;RTP&quot;</span>);
<a name="l02583"></a>02583          <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a> &lt; 0)
<a name="l02584"></a>02584             <span class="keywordflow">goto</span> fail;
<a name="l02585"></a>02585       }
<a name="l02586"></a>02586       <span class="comment">/*</span>
<a name="l02587"></a>02587 <span class="comment">       * If we get here, there was an error in one of the bind()</span>
<a name="l02588"></a>02588 <span class="comment">       * calls, so make sure it is nothing unexpected.</span>
<a name="l02589"></a>02589 <span class="comment">       */</span>
<a name="l02590"></a>02590       <span class="keywordflow">if</span> (<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a> != EADDRINUSE) {
<a name="l02591"></a>02591          <span class="comment">/* We got an error that wasn&apos;t expected, abort! */</span>
<a name="l02592"></a>02592          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;Unexpected bind error: %s\n&quot;</span>, strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l02593"></a>02593          <span class="keywordflow">goto</span> fail;
<a name="l02594"></a>02594       }
<a name="l02595"></a>02595       <span class="comment">/*</span>
<a name="l02596"></a>02596 <span class="comment">       * One of the ports is in use. For the next iteration,</span>
<a name="l02597"></a>02597 <span class="comment">       * increment by two and handle wraparound.</span>
<a name="l02598"></a>02598 <span class="comment">       * If we reach the starting point, then declare failure.</span>
<a name="l02599"></a>02599 <span class="comment">       */</span>
<a name="l02600"></a>02600       x += 2;
<a name="l02601"></a>02601       <span class="keywordflow">if</span> (x &gt; rtpend)
<a name="l02602"></a>02602          x = (rtpstart + 1) &amp; ~1;
<a name="l02603"></a>02603       <span class="keywordflow">if</span> (x == startplace) {
<a name="l02604"></a>02604          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;No RTP ports remaining. Can&apos;t setup media stream for this call.\n&quot;</span>);
<a name="l02605"></a>02605          <span class="keywordflow">goto</span> fail;
<a name="l02606"></a>02606       }
<a name="l02607"></a>02607    }
<a name="l02608"></a>02608    rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a> = sched;
<a name="l02609"></a>02609    rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a> = io;
<a name="l02610"></a>02610    <span class="keywordflow">if</span> (callbackmode) {
<a name="l02611"></a>02611       rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a> = <a class="code" href="io_8h.html#aa250c3f6541dc5734deb966d6821da7a" title="Adds an IO context.">ast_io_add</a>(rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, <a class="code" href="rtp_8c.html#acc27c454a55b589c7a228a8d78542db3">rtpread</a>, <a class="code" href="io_8h.html#a0d9e01f215782a343a1b71b5be362080">AST_IO_IN</a>, rtp);
<a name="l02612"></a>02612       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8c.html#ae8197382d4f12048520dcba52cd1461c">FLAG_CALLBACK_MODE</a>);
<a name="l02613"></a>02613    }
<a name="l02614"></a>02614    <a class="code" href="rtp_8h.html#af9ebff17643c46897280902ccd33ff40" title="Set payload types to defaults.">ast_rtp_pt_default</a>(rtp);
<a name="l02615"></a>02615    <span class="keywordflow">return</span> rtp;
<a name="l02616"></a>02616 
<a name="l02617"></a>02617 fail:
<a name="l02618"></a>02618    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a> &gt;= 0)
<a name="l02619"></a>02619       close(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>);
<a name="l02620"></a>02620    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l02621"></a>02621       close(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>);
<a name="l02622"></a>02622       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>);
<a name="l02623"></a>02623    }
<a name="l02624"></a>02624    <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rtp);
<a name="l02625"></a>02625    <span class="keywordflow">return</span> NULL;
<a name="l02626"></a>02626 }
<a name="l02627"></a>02627 
<a name="l02628"></a><a class="code" href="rtp_8c.html#a7736ea5b51cac9412ae82d6f009d7055">02628</a> <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="rtp_8h.html#a7736ea5b51cac9412ae82d6f009d7055" title="Initializate a RTP session.">ast_rtp_new</a>(<span class="keyword">struct</span> <a class="code" href="structsched__context.html">sched_context</a> *<a class="code" href="structsched.html">sched</a>, <span class="keyword">struct</span> <a class="code" href="structio__context.html" title="Global IO variables are now in a struct in order to be made threadsafe.">io_context</a> *<a class="code" href="chan__gtalk_8c.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, <span class="keywordtype">int</span> rtcpenable, <span class="keywordtype">int</span> callbackmode)
<a name="l02629"></a>02629 {
<a name="l02630"></a>02630    <span class="keyword">struct </span>in_addr ia;
<a name="l02631"></a>02631 
<a name="l02632"></a>02632    memset(&amp;ia, 0, <span class="keyword">sizeof</span>(ia));
<a name="l02633"></a>02633    <span class="keywordflow">return</span> <a class="code" href="rtp_8h.html#a10d5296cd50be78954103b0a0c754640" title="Initializate a RTP session using an in_addr structure.">ast_rtp_new_with_bindaddr</a>(sched, io, rtcpenable, callbackmode, ia);
<a name="l02634"></a>02634 }
<a name="l02635"></a>02635 
<a name="l02636"></a><a class="code" href="rtp_8c.html#aa5172a28daef5ee028e7bc5f8fe572e6">02636</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#af8579b7a7b2815a83cd80bf1c23d7824">ast_rtp_setqos</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> type_of_service, <span class="keywordtype">int</span> class_of_service, <span class="keywordtype">char</span> *<a class="code" href="channel_8c.html#a710bce51374aba96ab04912897666c35">desc</a>)
<a name="l02637"></a>02637 {
<a name="l02638"></a>02638    <span class="keywordflow">return</span> <a class="code" href="netsock_8h.html#aef64bf03f17c3251f549b08b6620bc24">ast_netsock_set_qos</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, type_of_service, class_of_service, desc);
<a name="l02639"></a>02639 }
<a name="l02640"></a>02640 
<a name="l02641"></a><a class="code" href="rtp_8c.html#a4bbc4b17d1c8afe7d831346edf73e6d2">02641</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a4bbc4b17d1c8afe7d831346edf73e6d2" title="When changing sources, don&amp;#39;t generate a new SSRC.">ast_rtp_set_constantssrc</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02642"></a>02642 {
<a name="l02643"></a>02643    rtp-&gt;<a class="code" href="structast__rtp.html#a06f00722236fa7f3e3f695e26a37179b">constantssrc</a> = 1;
<a name="l02644"></a>02644 }
<a name="l02645"></a>02645 
<a name="l02646"></a><a class="code" href="rtp_8c.html#a858a9803ad1b78fc1b9602bb9cad1411">02646</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a858a9803ad1b78fc1b9602bb9cad1411">ast_rtp_new_source</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02647"></a>02647 {
<a name="l02648"></a>02648    <span class="keywordflow">if</span> (rtp) {
<a name="l02649"></a>02649       rtp-&gt;<a class="code" href="structast__rtp.html#a1089b0c7f83ef826379989c20a11fd4b">set_marker_bit</a> = 1;
<a name="l02650"></a>02650       <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#a06f00722236fa7f3e3f695e26a37179b">constantssrc</a>) {
<a name="l02651"></a>02651          rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a> = <a class="code" href="utils_8h.html#a7b4f10b070e95ba413e258a3e4b03c20">ast_random</a>();
<a name="l02652"></a>02652       }
<a name="l02653"></a>02653    }
<a name="l02654"></a>02654 }
<a name="l02655"></a>02655 
<a name="l02656"></a><a class="code" href="rtp_8c.html#a8731e858c93551d3bb56a2f297a9ef59">02656</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a8731e858c93551d3bb56a2f297a9ef59">ast_rtp_set_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> sockaddr_in *them)
<a name="l02657"></a>02657 {
<a name="l02658"></a>02658    rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port = them-&gt;sin_port;
<a name="l02659"></a>02659    rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr = them-&gt;sin_addr;
<a name="l02660"></a>02660    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l02661"></a>02661       <span class="keywordtype">int</span> h = ntohs(them-&gt;sin_port);
<a name="l02662"></a>02662       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port = htons(h + 1);
<a name="l02663"></a>02663       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr = them-&gt;sin_addr;
<a name="l02664"></a>02664    }
<a name="l02665"></a>02665    rtp-&gt;<a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">rxseqno</a> = 0;
<a name="l02666"></a>02666    <span class="comment">/* If strict RTP protection is enabled switch back to the learn state so we don&apos;t drop packets from above */</span>
<a name="l02667"></a>02667    <span class="keywordflow">if</span> (strictrtp)
<a name="l02668"></a>02668       rtp-&gt;<a class="code" href="structast__rtp.html#a64730d554c32f13303a5a19f39cbd826">strict_rtp_state</a> = <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4ba0c26c1144bb830775979deb20e049368">STRICT_RTP_LEARN</a>;
<a name="l02669"></a>02669 }
<a name="l02670"></a>02670 
<a name="l02671"></a><a class="code" href="rtp_8c.html#ac80a75863b5a15612ec319f181c4da7f">02671</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#ac80a75863b5a15612ec319f181c4da7f" title="set potential alternate source for RTP media">ast_rtp_set_alt_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> sockaddr_in *alt)
<a name="l02672"></a>02672 {
<a name="l02673"></a>02673    rtp-&gt;<a class="code" href="structast__rtp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_port = alt-&gt;sin_port;
<a name="l02674"></a>02674    rtp-&gt;<a class="code" href="structast__rtp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_addr = alt-&gt;sin_addr;
<a name="l02675"></a>02675    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l02676"></a>02676       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_port = htons(ntohs(alt-&gt;sin_port) + 1);
<a name="l02677"></a>02677       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a567178215831a573c88f6370305a2997">altthem</a>.sin_addr = alt-&gt;sin_addr;
<a name="l02678"></a>02678    }
<a name="l02679"></a>02679 }
<a name="l02680"></a>02680 
<a name="l02681"></a><a class="code" href="rtp_8c.html#aa1ffde0e800995c386729bc5eaf82e7c">02681</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> sockaddr_in *them)
<a name="l02682"></a>02682 {
<a name="l02683"></a>02683    <span class="keywordflow">if</span> ((them-&gt;sin_family != AF_INET) ||
<a name="l02684"></a>02684       (them-&gt;sin_port != rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port) ||
<a name="l02685"></a>02685       (them-&gt;sin_addr.s_addr != rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr)) {
<a name="l02686"></a>02686       them-&gt;sin_family = AF_INET;
<a name="l02687"></a>02687       them-&gt;sin_port = rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port;
<a name="l02688"></a>02688       them-&gt;sin_addr = rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr;
<a name="l02689"></a>02689       <span class="keywordflow">return</span> 1;
<a name="l02690"></a>02690    }
<a name="l02691"></a>02691    <span class="keywordflow">return</span> 0;
<a name="l02692"></a>02692 }
<a name="l02693"></a>02693 
<a name="l02694"></a><a class="code" href="rtp_8c.html#a307269685e6f067a6abe35a184c3bae6">02694</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a307269685e6f067a6abe35a184c3bae6">ast_rtp_get_us</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> sockaddr_in *us)
<a name="l02695"></a>02695 {
<a name="l02696"></a>02696    *us = rtp-&gt;<a class="code" href="structast__rtp.html#a3c2346010ce32cf02b7c85203c76a20d">us</a>;
<a name="l02697"></a>02697 }
<a name="l02698"></a>02698 
<a name="l02699"></a><a class="code" href="rtp_8c.html#af7dc32ebdfacbbf446321de6fcfe2d9a">02699</a> <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="rtp_8h.html#af7dc32ebdfacbbf446321de6fcfe2d9a">ast_rtp_get_bridged</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02700"></a>02700 {
<a name="l02701"></a>02701    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *<a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">bridged</a> = NULL;
<a name="l02702"></a>02702 
<a name="l02703"></a>02703    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp);
<a name="l02704"></a>02704    bridged = rtp-&gt;<a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">bridged</a>;
<a name="l02705"></a>02705    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp);
<a name="l02706"></a>02706 
<a name="l02707"></a>02707    <span class="keywordflow">return</span> bridged;
<a name="l02708"></a>02708 }
<a name="l02709"></a>02709 
<a name="l02710"></a><a class="code" href="rtp_8c.html#a55123d53642a71a4bd834fcc0c0f00c5">02710</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a55123d53642a71a4bd834fcc0c0f00c5">ast_rtp_stop</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02711"></a>02711 {
<a name="l02712"></a>02712    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l02713"></a>02713       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l02714"></a>02714    }
<a name="l02715"></a>02715    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>) {
<a name="l02716"></a>02716       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>-&gt;<a class="code" href="structrtp__red.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l02717"></a>02717       <a class="code" href="astmm_8h.html#aa7157aa9480bb73f090dca36776419bf">free</a>(rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>);
<a name="l02718"></a>02718       rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a> = NULL;
<a name="l02719"></a>02719    }
<a name="l02720"></a>02720 
<a name="l02721"></a>02721    memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr));
<a name="l02722"></a>02722    memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l02723"></a>02723    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l02724"></a>02724       memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr));
<a name="l02725"></a>02725       memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l02726"></a>02726    }
<a name="l02727"></a>02727    
<a name="l02728"></a>02728    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(rtp, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>);
<a name="l02729"></a>02729 }
<a name="l02730"></a>02730 
<a name="l02731"></a><a class="code" href="rtp_8c.html#a40fda91dae06184092d7d70663b19416">02731</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a40fda91dae06184092d7d70663b19416">ast_rtp_reset</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02732"></a>02732 {
<a name="l02733"></a>02733    memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a6c1c58433fa534368c6e3ec2fa24037b">rxcore</a>));
<a name="l02734"></a>02734    memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>));
<a name="l02735"></a>02735    memset(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a>, 0, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a>));
<a name="l02736"></a>02736    rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = 0;
<a name="l02737"></a>02737    rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a> = 0;
<a name="l02738"></a>02738    rtp-&gt;<a class="code" href="structast__rtp.html#ab4b9ba00bb47d86340c9c150f17d7c69">lastrxts</a> = 0;
<a name="l02739"></a>02739    rtp-&gt;<a class="code" href="structast__rtp.html#a19258cc54fe0aafdf3bbe1f4fcc29218">lastividtimestamp</a> = 0;
<a name="l02740"></a>02740    rtp-&gt;<a class="code" href="structast__rtp.html#a9a2293b0120398a3a10aed1a98a5ea59">lastovidtimestamp</a> = 0;
<a name="l02741"></a>02741    rtp-&gt;<a class="code" href="structast__rtp.html#ae62094357b73bc730994119ae220bbd2">lastitexttimestamp</a> = 0;
<a name="l02742"></a>02742    rtp-&gt;<a class="code" href="structast__rtp.html#abf1f99fdbacb09d2077fdc250bccc269">lastotexttimestamp</a> = 0;
<a name="l02743"></a>02743    rtp-&gt;<a class="code" href="structast__rtp.html#a4ffa1ce6767ea0893237a918ac1aa251">lasteventseqn</a> = 0;
<a name="l02744"></a>02744    rtp-&gt;<a class="code" href="structast__rtp.html#a981a2adf6e3b11f40e35adccf12969f2">lastevent</a> = 0;
<a name="l02745"></a>02745    rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a> = 0;
<a name="l02746"></a>02746    rtp-&gt;<a class="code" href="structast__rtp.html#ac39112ee85d1c736329776a40537daf9">lastrxformat</a> = 0;
<a name="l02747"></a>02747    rtp-&gt;<a class="code" href="structast__rtp.html#a82decffa117c6037813bb76ce6227e11">dtmf_timeout</a> = 0;
<a name="l02748"></a>02748    rtp-&gt;<a class="code" href="structast__rtp.html#a1df09572b336a1f64f36ee43ced45d3d">dtmfsamples</a> = 0;
<a name="l02749"></a>02749    rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a> = 0;
<a name="l02750"></a>02750    rtp-&gt;<a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">rxseqno</a> = 0;
<a name="l02751"></a>02751 }
<a name="l02752"></a>02752 <span class="comment"></span>
<a name="l02753"></a>02753 <span class="comment">/*! Get QoS values from RTP and RTCP data (used in &quot;sip show channelstats&quot;) */</span>
<a name="l02754"></a><a class="code" href="rtp_8c.html#a78d6d7ba670a9b2eebe039db90b00fb4">02754</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a78d6d7ba670a9b2eebe039db90b00fb4" title="Return RTP and RTCP QoS values.">ast_rtp_get_qosvalue</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199f" title="Variables used in ast_rtcp_get function.">ast_rtp_qos_vars</a> value)
<a name="l02755"></a>02755 {
<a name="l02756"></a>02756    <span class="keywordflow">if</span> (rtp == NULL) {
<a name="l02757"></a>02757       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 1)
<a name="l02758"></a>02758          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;NO RTP Structure? Kidding me? \n&quot;</span>);
<a name="l02759"></a>02759       <span class="keywordflow">return</span> 0;
<a name="l02760"></a>02760    }
<a name="l02761"></a>02761    <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 1 &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> == NULL) {
<a name="l02762"></a>02762       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;NO RTCP structure. Maybe in RTP p2p bridging mode? \n&quot;</span>);
<a name="l02763"></a>02763    }
<a name="l02764"></a>02764 
<a name="l02765"></a>02765    <span class="keywordflow">switch</span> (value) {
<a name="l02766"></a>02766    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fa7693b0a1e7eace7864bdc786233f6fcd">AST_RTP_TXCOUNT</a>:
<a name="l02767"></a>02767       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>;
<a name="l02768"></a>02768    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fa3b1506d914a21ac0ab82c85fc67e35d2">AST_RTP_RXCOUNT</a>:
<a name="l02769"></a>02769       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l02770"></a>02770    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fa349dc7902b65436f8fb251d5df5f2711">AST_RTP_TXJITTER</a>:
<a name="l02771"></a>02771       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a> * 1000.0);
<a name="l02772"></a>02772    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fa5bf842efa73289a66d780670fd68e9c4">AST_RTP_RXJITTER</a>:
<a name="l02773"></a>02773       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a> / (<span class="keywordtype">unsigned</span> int) 65536.0) : 0);
<a name="l02774"></a>02774    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fa61c9ec686ce215425f2d5ce98d6d3603">AST_RTP_RXPLOSS</a>:
<a name="l02775"></a>02775       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>) : 0;
<a name="l02776"></a>02776    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fada74b59f8703038f54e74dea998d0a5a">AST_RTP_TXPLOSS</a>:
<a name="l02777"></a>02777       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a> : 0;
<a name="l02778"></a>02778    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a58b8acdd5acd2a70aa1a6d7040db199fa00e0735389375cf9b1dd3eb72f83d940">AST_RTP_RTT</a>:
<a name="l02779"></a>02779       <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a> * 100) : 0);
<a name="l02780"></a>02780    }
<a name="l02781"></a>02781    <span class="keywordflow">return</span> 0;   <span class="comment">/* To make the compiler happy */</span>
<a name="l02782"></a>02782 }
<a name="l02783"></a>02783 
<a name="l02784"></a><a class="code" href="rtp_8c.html#ab81dca76e0e5b8261c7294e680509c94">02784</a> <span class="keyword">static</span> <span class="keywordtype">double</span> <a class="code" href="rtp_8c.html#ab81dca76e0e5b8261c7294e680509c94">__ast_rtp_get_qos</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>, <span class="keywordtype">int</span> *found)
<a name="l02785"></a>02785 {
<a name="l02786"></a>02786    *found = 1;
<a name="l02787"></a>02787 
<a name="l02788"></a>02788    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;remote_maxjitter&quot;</span>))
<a name="l02789"></a>02789       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a30d52d11d41c2eb613686f33a5decc9c">reported_maxjitter</a> * 1000.0;
<a name="l02790"></a>02790    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;remote_minjitter&quot;</span>))
<a name="l02791"></a>02791       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ace87dcab8278d048a1aec3c529aae3e8">reported_minjitter</a> * 1000.0;
<a name="l02792"></a>02792    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;remote_normdevjitter&quot;</span>))
<a name="l02793"></a>02793       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">reported_normdev_jitter</a> * 1000.0;
<a name="l02794"></a>02794    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;remote_stdevjitter&quot;</span>))
<a name="l02795"></a>02795       <span class="keywordflow">return</span> sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a752c1c70fc3a23f882d1c59da8dde021">reported_stdev_jitter</a>) * 1000.0;
<a name="l02796"></a>02796 
<a name="l02797"></a>02797    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;local_maxjitter&quot;</span>))
<a name="l02798"></a>02798       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab23a4f4246d6a5d538cd97104db12ab2">maxrxjitter</a> * 1000.0;
<a name="l02799"></a>02799    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;local_minjitter&quot;</span>))
<a name="l02800"></a>02800       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">minrxjitter</a> * 1000.0;
<a name="l02801"></a>02801    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;local_normdevjitter&quot;</span>))
<a name="l02802"></a>02802       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">normdev_rxjitter</a> * 1000.0;
<a name="l02803"></a>02803    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;local_stdevjitter&quot;</span>))
<a name="l02804"></a>02804       <span class="keywordflow">return</span> sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ac18eba100dbfe48f0f6d0377cf8c76c1">stdev_rxjitter</a>) * 1000.0;
<a name="l02805"></a>02805 
<a name="l02806"></a>02806    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;maxrtt&quot;</span>))
<a name="l02807"></a>02807       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad9e0112e5a3834937c4f84604c175ba6">maxrtt</a> * 1000.0;
<a name="l02808"></a>02808    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;minrtt&quot;</span>))
<a name="l02809"></a>02809       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">minrtt</a> * 1000.0;
<a name="l02810"></a>02810    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;normdevrtt&quot;</span>))
<a name="l02811"></a>02811       <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">normdevrtt</a> * 1000.0;
<a name="l02812"></a>02812    <span class="keywordflow">if</span> (!strcasecmp(qos, <span class="stringliteral">&quot;stdevrtt&quot;</span>))
<a name="l02813"></a>02813       <span class="keywordflow">return</span> sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a484c5279646a0804e4beba6b3f0828c9">stdevrtt</a>) * 1000.0;
<a name="l02814"></a>02814 
<a name="l02815"></a>02815    *found = 0;
<a name="l02816"></a>02816 
<a name="l02817"></a>02817    <span class="keywordflow">return</span> 0.0;
<a name="l02818"></a>02818 }
<a name="l02819"></a>02819 
<a name="l02820"></a><a class="code" href="rtp_8c.html#ae8c09b6f55ec0b7444a9b48038157d22">02820</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#ae8c09b6f55ec0b7444a9b48038157d22" title="Get QOS stats on a RTP channel.">ast_rtp_get_qos</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="chan__iax2_8c.html#a1cc9e939c54c81f5c6cacb377cbb85e6">qos</a>, <span class="keywordtype">char</span> *<a class="code" href="adsistub_8c.html#aa95cbf1d00929438101e64ee5a216d0c">buf</a>, <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> buflen)
<a name="l02821"></a>02821 {
<a name="l02822"></a>02822    <span class="keywordtype">double</span> value;
<a name="l02823"></a>02823    <span class="keywordtype">int</span> found;
<a name="l02824"></a>02824 
<a name="l02825"></a>02825    value = <a class="code" href="rtp_8c.html#ab81dca76e0e5b8261c7294e680509c94">__ast_rtp_get_qos</a>(rtp, qos, &amp;found);
<a name="l02826"></a>02826 
<a name="l02827"></a>02827    <span class="keywordflow">if</span> (!found)
<a name="l02828"></a>02828       <span class="keywordflow">return</span> -1;
<a name="l02829"></a>02829 
<a name="l02830"></a>02830    snprintf(buf, buflen, <span class="stringliteral">&quot;%.0lf&quot;</span>, value);
<a name="l02831"></a>02831 
<a name="l02832"></a>02832    <span class="keywordflow">return</span> 0;
<a name="l02833"></a>02833 }
<a name="l02834"></a>02834 
<a name="l02835"></a><a class="code" href="rtp_8c.html#a787203f0e9b0ad978ee7d381cb280d2a">02835</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a787203f0e9b0ad978ee7d381cb280d2a" title="Set RTPAUDIOQOS(...) variables on a channel when it is being hung up.">ast_rtp_set_vars</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp) {
<a name="l02836"></a>02836    <span class="keywordtype">char</span> *audioqos;
<a name="l02837"></a>02837    <span class="keywordtype">char</span> *audioqos_jitter;
<a name="l02838"></a>02838    <span class="keywordtype">char</span> *audioqos_loss;
<a name="l02839"></a>02839    <span class="keywordtype">char</span> *audioqos_rtt;
<a name="l02840"></a>02840    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="structast__channel.html#a4fe7571e3c1759f3689d4453c132bdb7">bridge</a>;
<a name="l02841"></a>02841 
<a name="l02842"></a>02842    <span class="keywordflow">if</span> (!rtp || !chan)
<a name="l02843"></a>02843       <span class="keywordflow">return</span>;
<a name="l02844"></a>02844 
<a name="l02845"></a>02845    bridge = <a class="code" href="channel_8h.html#a3f52a5e35d47d8986ccaa66a86018e3a" title="Find bridged channel.">ast_bridged_channel</a>(chan);
<a name="l02846"></a>02846 
<a name="l02847"></a>02847    audioqos        = <a class="code" href="rtp_8h.html#ab704d9412f9a12c656f51baf77f65a08" title="Return RTCP quality string.">ast_rtp_get_quality</a>(rtp, NULL, <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6a7f88830a41aa42bfb5e25f40f8184019">RTPQOS_SUMMARY</a>);
<a name="l02848"></a>02848    audioqos_jitter = <a class="code" href="rtp_8h.html#ab704d9412f9a12c656f51baf77f65a08" title="Return RTCP quality string.">ast_rtp_get_quality</a>(rtp, NULL, <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6aa977210a30c7eeab8d2592df4e197d4b">RTPQOS_JITTER</a>);
<a name="l02849"></a>02849    audioqos_loss   = <a class="code" href="rtp_8h.html#ab704d9412f9a12c656f51baf77f65a08" title="Return RTCP quality string.">ast_rtp_get_quality</a>(rtp, NULL, <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6a06685070e92abe94bdd33cd1abaa30c1">RTPQOS_LOSS</a>);
<a name="l02850"></a>02850    audioqos_rtt    = <a class="code" href="rtp_8h.html#ab704d9412f9a12c656f51baf77f65a08" title="Return RTCP quality string.">ast_rtp_get_quality</a>(rtp, NULL, <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6acecf9cdfe1b45c0f19c4e9516c0d68ae">RTPQOS_RTT</a>);
<a name="l02851"></a>02851 
<a name="l02852"></a>02852    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RTPAUDIOQOS&quot;</span>, audioqos);
<a name="l02853"></a>02853    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RTPAUDIOQOSJITTER&quot;</span>, audioqos_jitter);
<a name="l02854"></a>02854    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RTPAUDIOQOSLOSS&quot;</span>, audioqos_loss);
<a name="l02855"></a>02855    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(chan, <span class="stringliteral">&quot;RTPAUDIOQOSRTT&quot;</span>, audioqos_rtt);
<a name="l02856"></a>02856 
<a name="l02857"></a>02857    <span class="keywordflow">if</span> (!bridge)
<a name="l02858"></a>02858       <span class="keywordflow">return</span>;
<a name="l02859"></a>02859 
<a name="l02860"></a>02860    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(bridge, <span class="stringliteral">&quot;RTPAUDIOQOSBRIDGED&quot;</span>, audioqos);
<a name="l02861"></a>02861    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(bridge, <span class="stringliteral">&quot;RTPAUDIOQOSJITTERBRIDGED&quot;</span>, audioqos_jitter);
<a name="l02862"></a>02862    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(bridge, <span class="stringliteral">&quot;RTPAUDIOQOSLOSSBRIDGED&quot;</span>, audioqos_loss);
<a name="l02863"></a>02863    <a class="code" href="pbx_8h.html#ac74f20f5a5f022a60fdf2db0dc84889c" title="Add a variable to the channel variable stack, removing the most recently set value...">pbx_builtin_setvar_helper</a>(bridge, <span class="stringliteral">&quot;RTPAUDIOQOSRTTBRIDGED&quot;</span>, audioqos_rtt);
<a name="l02864"></a>02864 }
<a name="l02865"></a>02865 
<a name="l02866"></a><a class="code" href="rtp_8c.html#a89408d117ae87f301d7cd0869f6c6f9b">02866</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a89408d117ae87f301d7cd0869f6c6f9b">__ast_rtp_get_quality_jitter</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02867"></a>02867 {
<a name="l02868"></a>02868    <span class="comment">/*</span>
<a name="l02869"></a>02869 <span class="comment">   *ssrc          our ssrc</span>
<a name="l02870"></a>02870 <span class="comment">   *themssrc      their ssrc</span>
<a name="l02871"></a>02871 <span class="comment">   *lp            lost packets</span>
<a name="l02872"></a>02872 <span class="comment">   *rxjitter      our calculated jitter(rx)</span>
<a name="l02873"></a>02873 <span class="comment">   *rxcount       no. received packets</span>
<a name="l02874"></a>02874 <span class="comment">   *txjitter      reported jitter of the other end</span>
<a name="l02875"></a>02875 <span class="comment">   *txcount       transmitted packets</span>
<a name="l02876"></a>02876 <span class="comment">   *rlp           remote lost packets</span>
<a name="l02877"></a>02877 <span class="comment">   *rtt           round trip time</span>
<a name="l02878"></a>02878 <span class="comment">   */</span>
<a name="l02879"></a>02879 <span class="preprocessor">#define RTCP_JITTER_FORMAT1 \</span>
<a name="l02880"></a>02880 <span class="preprocessor">   &quot;minrxjitter=%f;&quot; \</span>
<a name="l02881"></a>02881 <span class="preprocessor">   &quot;maxrxjitter=%f;&quot; \</span>
<a name="l02882"></a>02882 <span class="preprocessor">   &quot;avgrxjitter=%f;&quot; \</span>
<a name="l02883"></a>02883 <span class="preprocessor">   &quot;stdevrxjitter=%f;&quot; \</span>
<a name="l02884"></a>02884 <span class="preprocessor">   &quot;reported_minjitter=%f;&quot; \</span>
<a name="l02885"></a>02885 <span class="preprocessor">   &quot;reported_maxjitter=%f;&quot; \</span>
<a name="l02886"></a>02886 <span class="preprocessor">   &quot;reported_avgjitter=%f;&quot; \</span>
<a name="l02887"></a>02887 <span class="preprocessor">   &quot;reported_stdevjitter=%f;&quot;</span>
<a name="l02888"></a>02888 <span class="preprocessor"></span>
<a name="l02889"></a>02889 <span class="preprocessor">#define RTCP_JITTER_FORMAT2 \</span>
<a name="l02890"></a>02890 <span class="preprocessor">   &quot;rxjitter=%f;&quot;</span>
<a name="l02891"></a>02891 <span class="preprocessor"></span>
<a name="l02892"></a>02892    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">rtcp_info</a>) {
<a name="l02893"></a>02893       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">quality_jitter</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">quality_jitter</a>), <a class="code" href="rtp_8c.html#a32bc4f3e2b4bd5c73075d80e023e0977">RTCP_JITTER_FORMAT1</a>,
<a name="l02894"></a>02894          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a50826af23ba8f8cfa8cd63a7d5e5f1de">minrxjitter</a>,
<a name="l02895"></a>02895          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab23a4f4246d6a5d538cd97104db12ab2">maxrxjitter</a>,
<a name="l02896"></a>02896          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a8baf22880f2093a9f88901fe4b9aa3f3">normdev_rxjitter</a>,
<a name="l02897"></a>02897          sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ac18eba100dbfe48f0f6d0377cf8c76c1">stdev_rxjitter</a>),
<a name="l02898"></a>02898          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ace87dcab8278d048a1aec3c529aae3e8">reported_minjitter</a>,
<a name="l02899"></a>02899          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a30d52d11d41c2eb613686f33a5decc9c">reported_maxjitter</a>,
<a name="l02900"></a>02900          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ab5b714627a5bc33b066206bb8d01b27f">reported_normdev_jitter</a>,
<a name="l02901"></a>02901          sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a752c1c70fc3a23f882d1c59da8dde021">reported_stdev_jitter</a>)
<a name="l02902"></a>02902       );
<a name="l02903"></a>02903    } <span class="keywordflow">else</span> {
<a name="l02904"></a>02904       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">quality_jitter</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">quality_jitter</a>), <a class="code" href="rtp_8c.html#a4051d9059eb643639514b733024cdd98">RTCP_JITTER_FORMAT2</a>,
<a name="l02905"></a>02905          rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>
<a name="l02906"></a>02906       );
<a name="l02907"></a>02907    }
<a name="l02908"></a>02908 
<a name="l02909"></a>02909    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a7765aebb1a0fb70f72f3e8c89ee72db8">quality_jitter</a>;
<a name="l02910"></a>02910 
<a name="l02911"></a>02911 <span class="preprocessor">#undef RTCP_JITTER_FORMAT1</span>
<a name="l02912"></a>02912 <span class="preprocessor"></span><span class="preprocessor">#undef RTCP_JITTER_FORMAT2</span>
<a name="l02913"></a>02913 <span class="preprocessor"></span>}
<a name="l02914"></a>02914 
<a name="l02915"></a><a class="code" href="rtp_8c.html#a64f910e3c1755080ab29b5c4d31d17f2">02915</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a64f910e3c1755080ab29b5c4d31d17f2">__ast_rtp_get_quality_loss</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02916"></a>02916 {
<a name="l02917"></a>02917    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lost;
<a name="l02918"></a>02918    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extended;
<a name="l02919"></a>02919    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> expected;
<a name="l02920"></a>02920    <span class="keywordtype">int</span> fraction;
<a name="l02921"></a>02921 
<a name="l02922"></a>02922 <span class="preprocessor">#define RTCP_LOSS_FORMAT1 \</span>
<a name="l02923"></a>02923 <span class="preprocessor">   &quot;minrxlost=%f;&quot; \</span>
<a name="l02924"></a>02924 <span class="preprocessor">   &quot;maxrxlost=%f;&quot; \</span>
<a name="l02925"></a>02925 <span class="preprocessor">   &quot;avgrxlostr=%f;&quot; \</span>
<a name="l02926"></a>02926 <span class="preprocessor">   &quot;stdevrxlost=%f;&quot; \</span>
<a name="l02927"></a>02927 <span class="preprocessor">   &quot;reported_minlost=%f;&quot; \</span>
<a name="l02928"></a>02928 <span class="preprocessor">   &quot;reported_maxlost=%f;&quot; \</span>
<a name="l02929"></a>02929 <span class="preprocessor">   &quot;reported_avglost=%f;&quot; \</span>
<a name="l02930"></a>02930 <span class="preprocessor">   &quot;reported_stdevlost=%f;&quot;</span>
<a name="l02931"></a>02931 <span class="preprocessor"></span>
<a name="l02932"></a>02932 <span class="preprocessor">#define RTCP_LOSS_FORMAT2 \</span>
<a name="l02933"></a>02933 <span class="preprocessor">   &quot;lost=%d;&quot; \</span>
<a name="l02934"></a>02934 <span class="preprocessor">   &quot;expected=%d;&quot;</span>
<a name="l02935"></a>02935 <span class="preprocessor"></span>   
<a name="l02936"></a>02936    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">rtcp_info</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a156d5626391bfdfe33ff9ae0dd400ab0">maxrxlost</a> &gt; 0) {
<a name="l02937"></a>02937       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">quality_loss</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">quality_loss</a>), <a class="code" href="rtp_8c.html#a9470ed1a308ebcc4fe6d12a4a5a22006">RTCP_LOSS_FORMAT1</a>,
<a name="l02938"></a>02938          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad247636bc55f7b98c145f64c6a0e89fc">minrxlost</a>,
<a name="l02939"></a>02939          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a156d5626391bfdfe33ff9ae0dd400ab0">maxrxlost</a>,
<a name="l02940"></a>02940          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa37952d4fb2366b7301fbb9066351eb1">normdev_rxlost</a>,
<a name="l02941"></a>02941          sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#afb902f4eaea30d57054a372e3bda4082">stdev_rxlost</a>),
<a name="l02942"></a>02942          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a336c76200bd6e5390ae94cc780e602b6">reported_minlost</a>,
<a name="l02943"></a>02943          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abbf709761c24a05feba0f0dc2ee23b31">reported_maxlost</a>,
<a name="l02944"></a>02944          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a326f467bbb9a1439c7c2295e7965a9b1">reported_normdev_lost</a>,
<a name="l02945"></a>02945          sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a90913f9d1e572535345617ac4d9ae2a4">reported_stdev_lost</a>)
<a name="l02946"></a>02946       );
<a name="l02947"></a>02947    } <span class="keywordflow">else</span> {
<a name="l02948"></a>02948       extended = rtp-&gt;<a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a> + rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a>;
<a name="l02949"></a>02949       expected = extended - rtp-&gt;<a class="code" href="structast__rtp.html#a39b8d9a63bb7be44fbb707bb23721092">seedrxseqno</a> + 1;
<a name="l02950"></a>02950       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a> &gt; expected) 
<a name="l02951"></a>02951          expected += rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a> - expected;
<a name="l02952"></a>02952       lost = expected - rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l02953"></a>02953 
<a name="l02954"></a>02954       <span class="keywordflow">if</span> (!expected || lost &lt;= 0)
<a name="l02955"></a>02955          fraction = 0;
<a name="l02956"></a>02956       <span class="keywordflow">else</span>
<a name="l02957"></a>02957          fraction = (lost &lt;&lt; 8) / expected;
<a name="l02958"></a>02958 
<a name="l02959"></a>02959       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">quality_loss</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">quality_loss</a>), <a class="code" href="rtp_8c.html#ad964eca76824420d560d1f0d6159f458">RTCP_LOSS_FORMAT2</a>,
<a name="l02960"></a>02960          lost,
<a name="l02961"></a>02961          expected
<a name="l02962"></a>02962       );
<a name="l02963"></a>02963    }
<a name="l02964"></a>02964 
<a name="l02965"></a>02965    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a389ae891643b19b1b6b4598ec66d0cf1">quality_loss</a>;
<a name="l02966"></a>02966 
<a name="l02967"></a>02967 <span class="preprocessor">#undef RTCP_LOSS_FORMAT1</span>
<a name="l02968"></a>02968 <span class="preprocessor"></span><span class="preprocessor">#undef RTCP_LOSS_FORMAT2</span>
<a name="l02969"></a>02969 <span class="preprocessor"></span>}
<a name="l02970"></a>02970 
<a name="l02971"></a><a class="code" href="rtp_8c.html#a0802bfd23cbf2bc10a3fa89a8cfcc5e6">02971</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a0802bfd23cbf2bc10a3fa89a8cfcc5e6">__ast_rtp_get_quality_rtt</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02972"></a>02972 {
<a name="l02973"></a>02973    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">rtcp_info</a>) {
<a name="l02974"></a>02974       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">quality_rtt</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">quality_rtt</a>), <span class="stringliteral">&quot;minrtt=%f;maxrtt=%f;avgrtt=%f;stdevrtt=%f;&quot;</span>,
<a name="l02975"></a>02975          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa5e4ba49724f6bb86be553f4c823b510">minrtt</a>,
<a name="l02976"></a>02976          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad9e0112e5a3834937c4f84604c175ba6">maxrtt</a>,
<a name="l02977"></a>02977          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a41960a911bf90300e198a29deac4a02f">normdevrtt</a>,
<a name="l02978"></a>02978          sqrt(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a484c5279646a0804e4beba6b3f0828c9">stdevrtt</a>)
<a name="l02979"></a>02979       );
<a name="l02980"></a>02980    } <span class="keywordflow">else</span> {
<a name="l02981"></a>02981       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">quality_rtt</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">quality_rtt</a>), <span class="stringliteral">&quot;Not available&quot;</span>);
<a name="l02982"></a>02982    }
<a name="l02983"></a>02983 
<a name="l02984"></a>02984    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a59446a31e93e48f3a8a58359209d55bc">quality_rtt</a>;
<a name="l02985"></a>02985 }
<a name="l02986"></a>02986 
<a name="l02987"></a><a class="code" href="rtp_8c.html#af326d3cad5ebb9be27ac6cedd901a605">02987</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#af326d3cad5ebb9be27ac6cedd901a605">__ast_rtp_get_quality</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l02988"></a>02988 {
<a name="l02989"></a>02989    <span class="comment">/*</span>
<a name="l02990"></a>02990 <span class="comment">   *ssrc          our ssrc</span>
<a name="l02991"></a>02991 <span class="comment">   *themssrc      their ssrc</span>
<a name="l02992"></a>02992 <span class="comment">   *lp            lost packets</span>
<a name="l02993"></a>02993 <span class="comment">   *rxjitter      our calculated jitter(rx)</span>
<a name="l02994"></a>02994 <span class="comment">   *rxcount       no. received packets</span>
<a name="l02995"></a>02995 <span class="comment">   *txjitter      reported jitter of the other end</span>
<a name="l02996"></a>02996 <span class="comment">   *txcount       transmitted packets</span>
<a name="l02997"></a>02997 <span class="comment">   *rlp           remote lost packets</span>
<a name="l02998"></a>02998 <span class="comment">   *rtt           round trip time</span>
<a name="l02999"></a>02999 <span class="comment">   */</span> 
<a name="l03000"></a>03000 
<a name="l03001"></a>03001    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aac35a3d79ed32a54ee5b9e86e386df53">rtcp_info</a>) {
<a name="l03002"></a>03002       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">quality</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">quality</a>),
<a name="l03003"></a>03003          <span class="stringliteral">&quot;ssrc=%u;themssrc=%u;lp=%u;rxjitter=%f;rxcount=%u;txjitter=%f;txcount=%u;rlp=%u;rtt=%f&quot;</span>,
<a name="l03004"></a>03004          rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>,
<a name="l03005"></a>03005          rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>,
<a name="l03006"></a>03006          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>,
<a name="l03007"></a>03007          rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,
<a name="l03008"></a>03008          rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>,
<a name="l03009"></a>03009          (<span class="keywordtype">double</span>)rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a> / 65536.0,
<a name="l03010"></a>03010          rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>,
<a name="l03011"></a>03011          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>,
<a name="l03012"></a>03012          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a>
<a name="l03013"></a>03013       );
<a name="l03014"></a>03014    } <span class="keywordflow">else</span> {
<a name="l03015"></a>03015       snprintf(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">quality</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">quality</a>), <span class="stringliteral">&quot;ssrc=%u;themssrc=%u;rxjitter=%f;rxcount=%u;txcount=%u;&quot;</span>,
<a name="l03016"></a>03016          rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>,
<a name="l03017"></a>03017          rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>,
<a name="l03018"></a>03018          rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,
<a name="l03019"></a>03019          rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>,
<a name="l03020"></a>03020          rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>
<a name="l03021"></a>03021       );
<a name="l03022"></a>03022    }
<a name="l03023"></a>03023 
<a name="l03024"></a>03024    <span class="keywordflow">return</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a29a918a5c722d02d5e9a2c5d2bdb4324">quality</a>;
<a name="l03025"></a>03025 }
<a name="l03026"></a>03026 
<a name="l03027"></a><a class="code" href="rtp_8c.html#ab704d9412f9a12c656f51baf77f65a08">03027</a> <span class="keywordtype">char</span> *<a class="code" href="rtp_8h.html#ab704d9412f9a12c656f51baf77f65a08" title="Return RTCP quality string.">ast_rtp_get_quality</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> <a class="code" href="structast__rtp__quality.html" title="RTCP quality report storage.">ast_rtp_quality</a> *qual, <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6">ast_rtp_quality_type</a> qtype) 
<a name="l03028"></a>03028 {
<a name="l03029"></a>03029    <span class="keywordflow">if</span> (qual &amp;&amp; rtp) {
<a name="l03030"></a>03030       qual-&gt;<a class="code" href="structast__rtp__quality.html#a345269c0d57add15c919b781d140e011">local_ssrc</a>   = rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>;
<a name="l03031"></a>03031       qual-&gt;<a class="code" href="structast__rtp__quality.html#aefacf30cd67e10c500a46ffb878231c5">local_jitter</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>;
<a name="l03032"></a>03032       qual-&gt;<a class="code" href="structast__rtp__quality.html#ac217351226d153aa3b4d04c0e06dce4e">local_count</a>  = rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l03033"></a>03033       qual-&gt;<a class="code" href="structast__rtp__quality.html#a052c95f741f3e25e6ab9217a01affb53">remote_ssrc</a>  = rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>;
<a name="l03034"></a>03034       qual-&gt;<a class="code" href="structast__rtp__quality.html#a8f2976bbc0880a387467334441a9b60e">remote_count</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>;
<a name="l03035"></a>03035 
<a name="l03036"></a>03036       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l03037"></a>03037          qual-&gt;<a class="code" href="structast__rtp__quality.html#af942b1527ce61d3e19333fca67cf7499">local_lostpackets</a>  = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>;
<a name="l03038"></a>03038          qual-&gt;<a class="code" href="structast__rtp__quality.html#a5cb628d0a1af4affc08064059bee9dbd">remote_lostpackets</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a>;
<a name="l03039"></a>03039          qual-&gt;<a class="code" href="structast__rtp__quality.html#aaf1b2598fc572dd7eafd438f85212dcd">remote_jitter</a>      = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a> / 65536.0;
<a name="l03040"></a>03040          qual-&gt;<a class="code" href="structast__rtp__quality.html#abc953dca5930a67736d6cd8f72353794">rtt</a>                = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a>;
<a name="l03041"></a>03041       }
<a name="l03042"></a>03042    }
<a name="l03043"></a>03043 
<a name="l03044"></a>03044    <span class="keywordflow">switch</span> (qtype) {
<a name="l03045"></a>03045    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6a7f88830a41aa42bfb5e25f40f8184019">RTPQOS_SUMMARY</a>:
<a name="l03046"></a>03046       <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#af326d3cad5ebb9be27ac6cedd901a605">__ast_rtp_get_quality</a>(rtp);
<a name="l03047"></a>03047    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6aa977210a30c7eeab8d2592df4e197d4b">RTPQOS_JITTER</a>:
<a name="l03048"></a>03048       <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#a89408d117ae87f301d7cd0869f6c6f9b">__ast_rtp_get_quality_jitter</a>(rtp);
<a name="l03049"></a>03049    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6a06685070e92abe94bdd33cd1abaa30c1">RTPQOS_LOSS</a>:
<a name="l03050"></a>03050       <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#a64f910e3c1755080ab29b5c4d31d17f2">__ast_rtp_get_quality_loss</a>(rtp);
<a name="l03051"></a>03051    <span class="keywordflow">case</span> <a class="code" href="rtp_8h.html#a756ea404ff32087dee22a779a8d277a6acecf9cdfe1b45c0f19c4e9516c0d68ae">RTPQOS_RTT</a>:
<a name="l03052"></a>03052       <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#a0802bfd23cbf2bc10a3fa89a8cfcc5e6">__ast_rtp_get_quality_rtt</a>(rtp);
<a name="l03053"></a>03053    }
<a name="l03054"></a>03054 
<a name="l03055"></a>03055    <span class="keywordflow">return</span> NULL;
<a name="l03056"></a>03056 }
<a name="l03057"></a>03057 
<a name="l03058"></a><a class="code" href="rtp_8c.html#a6d2addabf879eb321a660932e3bd57eb">03058</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a6d2addabf879eb321a660932e3bd57eb">ast_rtp_destroy</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l03059"></a>03059 {
<a name="l03060"></a>03060    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>) || rtcpstats) {
<a name="l03061"></a>03061       <span class="comment">/*Print some info on the call here */</span>
<a name="l03062"></a>03062       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  RTP-stats\n&quot;</span>);
<a name="l03063"></a>03063       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;* Our Receiver:\n&quot;</span>);
<a name="l03064"></a>03064       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  SSRC:     %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>);
<a name="l03065"></a>03065       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Received packets: %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>);
<a name="l03066"></a>03066       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Lost packets:   %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>) : 0);
<a name="l03067"></a>03067       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Jitter:      %.4f\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>);
<a name="l03068"></a>03068       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Transit:     %.4f\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a03de90eeef260174916d063af8db743b">rxtransit</a>);
<a name="l03069"></a>03069       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  RR-count:    %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abfdd17fa9ca6b018fea2fe58c5738712">rr_count</a> : 0);
<a name="l03070"></a>03070       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;* Our Sender:\n&quot;</span>);
<a name="l03071"></a>03071       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  SSRC:     %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);
<a name="l03072"></a>03072       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Sent packets:   %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>);
<a name="l03073"></a>03073       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Lost packets:   %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a> : 0);
<a name="l03074"></a>03074       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Jitter:      %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a> / (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)65536.0) : 0);
<a name="l03075"></a>03075       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  SR-count:    %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2fd3216670496c31020fd37341c0b8fd">sr_count</a> : 0);
<a name="l03076"></a>03076       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  RTT:      %f\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a> : 0);
<a name="l03077"></a>03077    }
<a name="l03078"></a>03078 
<a name="l03079"></a>03079    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <span class="stringliteral">&quot;RTPReceiverStat&quot;</span>, <span class="stringliteral">&quot;SSRC: %u\r\n&quot;</span>
<a name="l03080"></a>03080                    <span class="stringliteral">&quot;ReceivedPackets: %u\r\n&quot;</span>
<a name="l03081"></a>03081                    <span class="stringliteral">&quot;LostPackets: %u\r\n&quot;</span>
<a name="l03082"></a>03082                    <span class="stringliteral">&quot;Jitter: %.4f\r\n&quot;</span>
<a name="l03083"></a>03083                    <span class="stringliteral">&quot;Transit: %.4f\r\n&quot;</span>
<a name="l03084"></a>03084                    <span class="stringliteral">&quot;RRCount: %u\r\n&quot;</span>,
<a name="l03085"></a>03085                    rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>,
<a name="l03086"></a>03086                    rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>,
<a name="l03087"></a>03087                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>) : 0,
<a name="l03088"></a>03088                    rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,
<a name="l03089"></a>03089                    rtp-&gt;<a class="code" href="structast__rtp.html#a03de90eeef260174916d063af8db743b">rxtransit</a>,
<a name="l03090"></a>03090                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abfdd17fa9ca6b018fea2fe58c5738712">rr_count</a> : 0);
<a name="l03091"></a>03091    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <span class="stringliteral">&quot;RTPSenderStat&quot;</span>, <span class="stringliteral">&quot;SSRC: %u\r\n&quot;</span>
<a name="l03092"></a>03092                    <span class="stringliteral">&quot;SentPackets: %u\r\n&quot;</span>
<a name="l03093"></a>03093                    <span class="stringliteral">&quot;LostPackets: %u\r\n&quot;</span>
<a name="l03094"></a>03094                    <span class="stringliteral">&quot;Jitter: %u\r\n&quot;</span>
<a name="l03095"></a>03095                    <span class="stringliteral">&quot;SRCount: %u\r\n&quot;</span>
<a name="l03096"></a>03096                    <span class="stringliteral">&quot;RTT: %f\r\n&quot;</span>,
<a name="l03097"></a>03097                    rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>,
<a name="l03098"></a>03098                    rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>,
<a name="l03099"></a>03099                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a735181229b9c3facc1081e30fe7e532e">reported_lost</a> : 0,
<a name="l03100"></a>03100                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1b3b9edcf4981174716c8afafd8c10f5">reported_jitter</a> : 0,
<a name="l03101"></a>03101                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2fd3216670496c31020fd37341c0b8fd">sr_count</a> : 0,
<a name="l03102"></a>03102                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> ? rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc953dca5930a67736d6cd8f72353794">rtt</a> : 0);
<a name="l03103"></a>03103    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>)
<a name="l03104"></a>03104       <a class="code" href="frame_8h.html#a6d3b71e0a81af743bae6c33c02b64f1f">ast_smoother_free</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>);
<a name="l03105"></a>03105    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a>)
<a name="l03106"></a>03106       <a class="code" href="io_8h.html#afbf1092b96128d07d0dd08dfa898f4d5" title="Removes an IO context.">ast_io_remove</a>(rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a>);
<a name="l03107"></a>03107    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a> &gt; -1)
<a name="l03108"></a>03108       close(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>);
<a name="l03109"></a>03109    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>) {
<a name="l03110"></a>03110       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l03111"></a>03111       close(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>);
<a name="l03112"></a>03112       <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>);
<a name="l03113"></a>03113       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>=NULL;
<a name="l03114"></a>03114    }
<a name="l03115"></a>03115 <span class="preprocessor">#ifdef P2P_INTENSE</span>
<a name="l03116"></a>03116 <span class="preprocessor"></span>   <a class="code" href="lock_8h.html#ab237e70b569019bfb490ab0c3c09b8c5">ast_mutex_destroy</a>(&amp;rtp-&gt;bridge_lock);
<a name="l03117"></a>03117 <span class="preprocessor">#endif</span>
<a name="l03118"></a>03118 <span class="preprocessor"></span>   <a class="code" href="astmm_8h.html#a402072d6789f6ed9e3a81da27504127e">ast_free</a>(rtp);
<a name="l03119"></a>03119 }
<a name="l03120"></a>03120 
<a name="l03121"></a><a class="code" href="rtp_8c.html#a4c3a6d3e3a2ffc5044526e5db91fb6b5">03121</a> <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a4c3a6d3e3a2ffc5044526e5db91fb6b5">calc_txstamp</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> timeval *delivery)
<a name="l03122"></a>03122 {
<a name="l03123"></a>03123    <span class="keyword">struct </span>timeval t;
<a name="l03124"></a>03124    <span class="keywordtype">long</span> ms;
<a name="l03125"></a>03125    <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>)) {
<a name="l03126"></a>03126       rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a> = <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03127"></a>03127       <span class="comment">/* Round to 20ms for nice, pretty timestamps */</span>
<a name="l03128"></a>03128       rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>.tv_usec -= rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>.tv_usec % 20000;
<a name="l03129"></a>03129    }
<a name="l03130"></a>03130    <span class="comment">/* Use previous txcore if available */</span>
<a name="l03131"></a>03131    t = (delivery &amp;&amp; !<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(*delivery)) ? *delivery : <a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>();
<a name="l03132"></a>03132    ms = <a class="code" href="time_8h.html#a74e35cffcd45ad6cd7c8587921e8a4c2" title="Computes the difference (in milliseconds) between two struct timeval instances.">ast_tvdiff_ms</a>(t, rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a>);
<a name="l03133"></a>03133    <span class="keywordflow">if</span> (ms &lt; 0)
<a name="l03134"></a>03134       ms = 0;
<a name="l03135"></a>03135    <span class="comment">/* Use what we just got for next time */</span>
<a name="l03136"></a>03136    rtp-&gt;<a class="code" href="structast__rtp.html#a3b8c38b9fc18e1d870dfe93c532af41a">txcore</a> = t;
<a name="l03137"></a>03137    <span class="keywordflow">return</span> (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>) ms;
<a name="l03138"></a>03138 }
<a name="l03139"></a>03139 <span class="comment"></span>
<a name="l03140"></a>03140 <span class="comment">/*! \brief Send begin frames for DTMF */</span>
<a name="l03141"></a><a class="code" href="rtp_8c.html#ad67b565977122712cc970d5a12f124b2">03141</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#ad67b565977122712cc970d5a12f124b2" title="Send begin frames for DTMF.">ast_rtp_senddigit_begin</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">char</span> digit)
<a name="l03142"></a>03142 {
<a name="l03143"></a>03143    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtpheader;
<a name="l03144"></a>03144    <span class="keywordtype">int</span> hdrlen = 12, res = 0, i = 0, payload = 0;
<a name="l03145"></a>03145    <span class="keywordtype">char</span> data[256];
<a name="l03146"></a>03146 
<a name="l03147"></a>03147    <span class="keywordflow">if</span> ((digit &lt;= <span class="charliteral">&apos;9&apos;</span>) &amp;&amp; (digit &gt;= <span class="charliteral">&apos;0&apos;</span>))
<a name="l03148"></a>03148       digit -= <span class="charliteral">&apos;0&apos;</span>;
<a name="l03149"></a>03149    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;*&apos;</span>)
<a name="l03150"></a>03150       digit = 10;
<a name="l03151"></a>03151    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;#&apos;</span>)
<a name="l03152"></a>03152       digit = 11;
<a name="l03153"></a>03153    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((digit &gt;= <span class="charliteral">&apos;A&apos;</span>) &amp;&amp; (digit &lt;= <span class="charliteral">&apos;D&apos;</span>))
<a name="l03154"></a>03154       digit = digit - <span class="charliteral">&apos;A&apos;</span> + 12;
<a name="l03155"></a>03155    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((digit &gt;= <span class="charliteral">&apos;a&apos;</span>) &amp;&amp; (digit &lt;= <span class="charliteral">&apos;d&apos;</span>))
<a name="l03156"></a>03156       digit = digit - <span class="charliteral">&apos;a&apos;</span> + 12;
<a name="l03157"></a>03157    <span class="keywordflow">else</span> {
<a name="l03158"></a>03158       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to represent &apos;%c&apos;\n&quot;</span>, digit);
<a name="l03159"></a>03159       <span class="keywordflow">return</span> 0;
<a name="l03160"></a>03160    }
<a name="l03161"></a>03161 
<a name="l03162"></a>03162    <span class="comment">/* If we have no peer, return immediately */</span> 
<a name="l03163"></a>03163    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr || !rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port)
<a name="l03164"></a>03164       <span class="keywordflow">return</span> 0;
<a name="l03165"></a>03165 
<a name="l03166"></a>03166    payload = <a class="code" href="rtp_8h.html#a4daa559b8f2ef25bc33d8f5d8fd937d1" title="Looks up an RTP code out of our *static* outbound list.">ast_rtp_lookup_code</a>(rtp, 0, <a class="code" href="rtp_8h.html#a3cc8001677e3b955b9b5ceb4267a76ec">AST_RTP_DTMF</a>);
<a name="l03167"></a>03167 
<a name="l03168"></a>03168    rtp-&gt;<a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 500000));
<a name="l03169"></a>03169    rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a> = 160;
<a name="l03170"></a>03170    rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> + rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a>;
<a name="l03171"></a>03171    
<a name="l03172"></a>03172    <span class="comment">/* Get a pointer to the header */</span>
<a name="l03173"></a>03173    rtpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)data;
<a name="l03174"></a>03174    rtpheader[0] = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 23) | (payload &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>));
<a name="l03175"></a>03175    rtpheader[1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>);
<a name="l03176"></a>03176    rtpheader[2] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>); 
<a name="l03177"></a>03177 
<a name="l03178"></a>03178    <span class="keywordflow">for</span> (i = 0; i &lt; 2; i++) {
<a name="l03179"></a>03179       rtpheader[3] = htonl((digit &lt;&lt; 24) | (0xa &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a>));
<a name="l03180"></a>03180       res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">void</span> *) rtpheader, hdrlen + 4, 0, (<span class="keyword">struct</span> sockaddr *) &amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03181"></a>03181       <span class="keywordflow">if</span> (res &lt; 0) 
<a name="l03182"></a>03182          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTP Transmission error to %s:%u: %s\n&quot;</span>,
<a name="l03183"></a>03183             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03184"></a>03184             ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03185"></a>03185       <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>))
<a name="l03186"></a>03186          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Sent RTP DTMF packet to %s:%u (type %-2.2d, seq %-6.6u, ts %-6.6u, len %-6.6u)\n&quot;</span>,
<a name="l03187"></a>03187                 <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03188"></a>03188                 ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), payload, rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>, rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>, res - hdrlen);
<a name="l03189"></a>03189       <span class="comment">/* Increment sequence number */</span>
<a name="l03190"></a>03190       rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>++;
<a name="l03191"></a>03191       <span class="comment">/* Increment duration */</span>
<a name="l03192"></a>03192       rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a> += 160;
<a name="l03193"></a>03193       <span class="comment">/* Clear marker bit and set seqno */</span>
<a name="l03194"></a>03194       rtpheader[0] = htonl((2 &lt;&lt; 30) | (payload &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>));
<a name="l03195"></a>03195    }
<a name="l03196"></a>03196 
<a name="l03197"></a>03197    <span class="comment">/* Since we received a begin, we can safely store the digit and disable any compensation */</span>
<a name="l03198"></a>03198    rtp-&gt;<a class="code" href="structast__rtp.html#af637078f896cfd75467174c20d0cb217">sending_digit</a> = 1;
<a name="l03199"></a>03199    rtp-&gt;<a class="code" href="structast__rtp.html#a0ed4b8b544ecc0632341499d5a8f199e">send_digit</a> = digit;
<a name="l03200"></a>03200    rtp-&gt;<a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a> = payload;
<a name="l03201"></a>03201 
<a name="l03202"></a>03202    <span class="keywordflow">return</span> 0;
<a name="l03203"></a>03203 }
<a name="l03204"></a>03204 <span class="comment"></span>
<a name="l03205"></a>03205 <span class="comment">/*! \brief Send continuation frame for DTMF */</span>
<a name="l03206"></a><a class="code" href="rtp_8c.html#acfdeaf8e752856ad7b49174eee6e9fea">03206</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#acfdeaf8e752856ad7b49174eee6e9fea" title="Send continuation frame for DTMF.">ast_rtp_senddigit_continuation</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l03207"></a>03207 {
<a name="l03208"></a>03208    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtpheader;
<a name="l03209"></a>03209    <span class="keywordtype">int</span> hdrlen = 12, res = 0;
<a name="l03210"></a>03210    <span class="keywordtype">char</span> data[256];
<a name="l03211"></a>03211 
<a name="l03212"></a>03212    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr || !rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port)
<a name="l03213"></a>03213       <span class="keywordflow">return</span> 0;
<a name="l03214"></a>03214 
<a name="l03215"></a>03215    <span class="comment">/* Setup packet to send */</span>
<a name="l03216"></a>03216    rtpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)data;
<a name="l03217"></a>03217    rtpheader[0] = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 23) | (rtp-&gt;<a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a> &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>));
<a name="l03218"></a>03218    rtpheader[1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>);
<a name="l03219"></a>03219    rtpheader[2] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);
<a name="l03220"></a>03220    rtpheader[3] = htonl((rtp-&gt;<a class="code" href="structast__rtp.html#a0ed4b8b544ecc0632341499d5a8f199e">send_digit</a> &lt;&lt; 24) | (0xa &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a>));
<a name="l03221"></a>03221    rtpheader[0] = htonl((2 &lt;&lt; 30) | (rtp-&gt;<a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a> &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>));
<a name="l03222"></a>03222    
<a name="l03223"></a>03223    <span class="comment">/* Transmit */</span>
<a name="l03224"></a>03224    res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">void</span> *) rtpheader, hdrlen + 4, 0, (<span class="keyword">struct</span> sockaddr *) &amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03225"></a>03225    <span class="keywordflow">if</span> (res &lt; 0)
<a name="l03226"></a>03226       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTP Transmission error to %s:%d: %s\n&quot;</span>,
<a name="l03227"></a>03227          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03228"></a>03228          ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03229"></a>03229    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>))
<a name="l03230"></a>03230       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Sent RTP DTMF packet to %s:%u (type %-2.2d, seq %-6.6u, ts %-6.6u, len %-6.6u)\n&quot;</span>,
<a name="l03231"></a>03231              <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03232"></a>03232              ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), rtp-&gt;<a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>, rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>, res - hdrlen);
<a name="l03233"></a>03233 
<a name="l03234"></a>03234    <span class="comment">/* Increment sequence number */</span>
<a name="l03235"></a>03235    rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>++;
<a name="l03236"></a>03236    <span class="comment">/* Increment duration */</span>
<a name="l03237"></a>03237    rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a> += 160;
<a name="l03238"></a>03238 
<a name="l03239"></a>03239    <span class="keywordflow">return</span> 0;
<a name="l03240"></a>03240 }
<a name="l03241"></a>03241 <span class="comment"></span>
<a name="l03242"></a>03242 <span class="comment">/*! \brief Send end packets for DTMF */</span>
<a name="l03243"></a><a class="code" href="rtp_8c.html#a75bc4adaf04f7e5348fc73608c3b1ebc">03243</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a75bc4adaf04f7e5348fc73608c3b1ebc" title="Send end packets for DTMF.">ast_rtp_senddigit_end</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">char</span> digit)
<a name="l03244"></a>03244 {
<a name="l03245"></a>03245    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtpheader;
<a name="l03246"></a>03246    <span class="keywordtype">int</span> hdrlen = 12, res = 0, i = 0;
<a name="l03247"></a>03247    <span class="keywordtype">char</span> data[256];
<a name="l03248"></a>03248    
<a name="l03249"></a>03249    <span class="comment">/* If no address, then bail out */</span>
<a name="l03250"></a>03250    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr || !rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port)
<a name="l03251"></a>03251       <span class="keywordflow">return</span> 0;
<a name="l03252"></a>03252    
<a name="l03253"></a>03253    <span class="keywordflow">if</span> ((digit &lt;= <span class="charliteral">&apos;9&apos;</span>) &amp;&amp; (digit &gt;= <span class="charliteral">&apos;0&apos;</span>))
<a name="l03254"></a>03254       digit -= <span class="charliteral">&apos;0&apos;</span>;
<a name="l03255"></a>03255    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;*&apos;</span>)
<a name="l03256"></a>03256       digit = 10;
<a name="l03257"></a>03257    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (digit == <span class="charliteral">&apos;#&apos;</span>)
<a name="l03258"></a>03258       digit = 11;
<a name="l03259"></a>03259    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((digit &gt;= <span class="charliteral">&apos;A&apos;</span>) &amp;&amp; (digit &lt;= <span class="charliteral">&apos;D&apos;</span>))
<a name="l03260"></a>03260       digit = digit - <span class="charliteral">&apos;A&apos;</span> + 12;
<a name="l03261"></a>03261    <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((digit &gt;= <span class="charliteral">&apos;a&apos;</span>) &amp;&amp; (digit &lt;= <span class="charliteral">&apos;d&apos;</span>))
<a name="l03262"></a>03262       digit = digit - <span class="charliteral">&apos;a&apos;</span> + 12;
<a name="l03263"></a>03263    <span class="keywordflow">else</span> {
<a name="l03264"></a>03264       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to represent &apos;%c&apos;\n&quot;</span>, digit);
<a name="l03265"></a>03265       <span class="keywordflow">return</span> 0;
<a name="l03266"></a>03266    }
<a name="l03267"></a>03267 
<a name="l03268"></a>03268    rtp-&gt;<a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 500000));
<a name="l03269"></a>03269 
<a name="l03270"></a>03270    rtpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)data;
<a name="l03271"></a>03271    rtpheader[1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>);
<a name="l03272"></a>03272    rtpheader[2] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);
<a name="l03273"></a>03273    rtpheader[3] = htonl((digit &lt;&lt; 24) | (0xa &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a>));
<a name="l03274"></a>03274    <span class="comment">/* Set end bit */</span>
<a name="l03275"></a>03275    rtpheader[3] |= htonl((1 &lt;&lt; 23));
<a name="l03276"></a>03276 
<a name="l03277"></a>03277    <span class="comment">/* Send 3 termination packets */</span>
<a name="l03278"></a>03278    <span class="keywordflow">for</span> (i = 0; i &lt; 3; i++) {
<a name="l03279"></a>03279       rtpheader[0] = htonl((2 &lt;&lt; 30) | (rtp-&gt;<a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a> &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>));
<a name="l03280"></a>03280       res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">void</span> *) rtpheader, hdrlen + 4, 0, (<span class="keyword">struct</span> sockaddr *) &amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03281"></a>03281       rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>++;
<a name="l03282"></a>03282       <span class="keywordflow">if</span> (res &lt; 0)
<a name="l03283"></a>03283          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTP Transmission error to %s:%d: %s\n&quot;</span>,
<a name="l03284"></a>03284             <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03285"></a>03285             ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03286"></a>03286       <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>))
<a name="l03287"></a>03287          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Sent RTP DTMF packet to %s:%u (type %-2.2d, seq %-6.6u, ts %-6.6u, len %-6.6u)\n&quot;</span>,
<a name="l03288"></a>03288                 <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03289"></a>03289                 ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), rtp-&gt;<a class="code" href="structast__rtp.html#a73a34cdfca2c2e6b2dec74be721db576">send_payload</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>, rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>, res - hdrlen);
<a name="l03290"></a>03290    }
<a name="l03291"></a>03291    rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> += rtp-&gt;<a class="code" href="structast__rtp.html#a852e7cb93889aa792fe4be8e5cfdf1ab">send_duration</a>;
<a name="l03292"></a>03292    rtp-&gt;<a class="code" href="structast__rtp.html#af637078f896cfd75467174c20d0cb217">sending_digit</a> = 0;
<a name="l03293"></a>03293    rtp-&gt;<a class="code" href="structast__rtp.html#a0ed4b8b544ecc0632341499d5a8f199e">send_digit</a> = 0;
<a name="l03294"></a>03294 
<a name="l03295"></a>03295    <span class="keywordflow">return</span> res;
<a name="l03296"></a>03296 }
<a name="l03297"></a>03297 <span class="comment"></span>
<a name="l03298"></a>03298 <span class="comment">/*! \brief Public function: Send an H.261 fast update request, some devices need this rather than SIP XML */</span>
<a name="l03299"></a><a class="code" href="rtp_8c.html#a90ca590267510860f846c606e9e764a8">03299</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a90ca590267510860f846c606e9e764a8" title="Send an H.261 fast update request. Some devices need this rather than the XML message...">ast_rtcp_send_h261fur</a>(<span class="keywordtype">void</span> *data)
<a name="l03300"></a>03300 {
<a name="l03301"></a>03301    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = data;
<a name="l03302"></a>03302    <span class="keywordtype">int</span> res;
<a name="l03303"></a>03303 
<a name="l03304"></a>03304    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">sendfur</a> = 1;
<a name="l03305"></a>03305    res = <a class="code" href="rtp_8c.html#aff89c2855ec73ffa6efdc958bb71c2e8" title="Write and RTCP packet to the far end.">ast_rtcp_write</a>(data);
<a name="l03306"></a>03306    
<a name="l03307"></a>03307    <span class="keywordflow">return</span> res;
<a name="l03308"></a>03308 }
<a name="l03309"></a>03309 <span class="comment"></span>
<a name="l03310"></a>03310 <span class="comment">/*! \brief Send RTCP sender&apos;s report */</span>
<a name="l03311"></a><a class="code" href="rtp_8c.html#af9fe82760c62b9bfe98044b3e53acef5">03311</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#af9fe82760c62b9bfe98044b3e53acef5" title="Send RTCP sender&amp;#39;s report.">ast_rtcp_write_sr</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *<a class="code" href="structast__rtp.html#a735984d41155bc1032e09bece8f8d66d">data</a>)
<a name="l03312"></a>03312 {
<a name="l03313"></a>03313    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = (<span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *)data;
<a name="l03314"></a>03314    <span class="keywordtype">int</span> res;
<a name="l03315"></a>03315    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = 0;
<a name="l03316"></a>03316    <span class="keyword">struct </span>timeval now;
<a name="l03317"></a>03317    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> now_lsw;
<a name="l03318"></a>03318    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> now_msw;
<a name="l03319"></a>03319    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtcpheader;
<a name="l03320"></a>03320    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lost;
<a name="l03321"></a>03321    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extended;
<a name="l03322"></a>03322    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> expected;
<a name="l03323"></a>03323    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> expected_interval;
<a name="l03324"></a>03324    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> received_interval;
<a name="l03325"></a>03325    <span class="keywordtype">int</span> lost_interval;
<a name="l03326"></a>03326    <span class="keywordtype">int</span> fraction;
<a name="l03327"></a>03327    <span class="keyword">struct </span>timeval dlsr;
<a name="l03328"></a>03328    <span class="keywordtype">char</span> bdata[512];
<a name="l03329"></a>03329 
<a name="l03330"></a>03330    <span class="comment">/* Commented condition is always not NULL if rtp-&gt;rtcp is not NULL */</span>
<a name="l03331"></a>03331    <span class="keywordflow">if</span> (!rtp || !rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a><span class="comment">/* || (&amp;rtp-&gt;rtcp-&gt;them.sin_addr == 0)*/</span>)
<a name="l03332"></a>03332       <span class="keywordflow">return</span> 0;
<a name="l03333"></a>03333    
<a name="l03334"></a>03334    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr) {  <span class="comment">/* This&apos;ll stop rtcp for this rtp session */</span>
<a name="l03335"></a>03335       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;RTCP SR transmission error, rtcp halted\n&quot;</span>);
<a name="l03336"></a>03336       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l03337"></a>03337       <span class="keywordflow">return</span> 0;
<a name="l03338"></a>03338    }
<a name="l03339"></a>03339 
<a name="l03340"></a>03340    gettimeofday(&amp;now, NULL);
<a name="l03341"></a>03341    <a class="code" href="rtp_8c.html#ae07b5d23a23d4d09988c4a1c5d477d14">timeval2ntp</a>(now, &amp;now_msw, &amp;now_lsw); <span class="comment">/* fill thses ones in from utils.c*/</span>
<a name="l03342"></a>03342    rtcpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)bdata;
<a name="l03343"></a>03343    rtcpheader[1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);               <span class="comment">/* Our SSRC */</span>
<a name="l03344"></a>03344    rtcpheader[2] = htonl(now_msw);                 <span class="comment">/* now, MSW. gettimeofday() + SEC_BETWEEN_1900_AND_1970*/</span>
<a name="l03345"></a>03345    rtcpheader[3] = htonl(now_lsw);                 <span class="comment">/* now, LSW */</span>
<a name="l03346"></a>03346    rtcpheader[4] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>);             <span class="comment">/* FIXME shouldn&apos;t be that, it should be now */</span>
<a name="l03347"></a>03347    rtcpheader[5] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>);            <span class="comment">/* No. packets sent */</span>
<a name="l03348"></a>03348    rtcpheader[6] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#aed963fd645cea41f8f9a7dd144810204">txoctetcount</a>);       <span class="comment">/* No. bytes sent */</span>
<a name="l03349"></a>03349    len += 28;
<a name="l03350"></a>03350    
<a name="l03351"></a>03351    extended = rtp-&gt;<a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a> + rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a>;
<a name="l03352"></a>03352    expected = extended - rtp-&gt;<a class="code" href="structast__rtp.html#a39b8d9a63bb7be44fbb707bb23721092">seedrxseqno</a> + 1;
<a name="l03353"></a>03353    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a> &gt; expected) 
<a name="l03354"></a>03354       expected += rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a> - expected;
<a name="l03355"></a>03355    lost = expected - rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l03356"></a>03356    expected_interval = expected - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a>;
<a name="l03357"></a>03357    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> = expected;
<a name="l03358"></a>03358    received_interval = rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>;
<a name="l03359"></a>03359    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l03360"></a>03360    lost_interval = expected_interval - received_interval;
<a name="l03361"></a>03361    <span class="keywordflow">if</span> (expected_interval == 0 || lost_interval &lt;= 0)
<a name="l03362"></a>03362       fraction = 0;
<a name="l03363"></a>03363    <span class="keywordflow">else</span>
<a name="l03364"></a>03364       fraction = (lost_interval &lt;&lt; 8) / expected_interval;
<a name="l03365"></a>03365    timersub(&amp;now, &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad96a304ae7c0f3dd877c1db41a5a668e">rxlsr</a>, &amp;dlsr);
<a name="l03366"></a>03366    rtcpheader[7] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>);
<a name="l03367"></a>03367    rtcpheader[8] = htonl(((fraction &amp; 0xff) &lt;&lt; 24) | (lost &amp; 0xffffff));
<a name="l03368"></a>03368    rtcpheader[9] = htonl((rtp-&gt;<a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a>) | ((rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a> &amp; 0xffff)));
<a name="l03369"></a>03369    rtcpheader[10] = htonl((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a> * 65536.));
<a name="l03370"></a>03370    rtcpheader[11] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a>);
<a name="l03371"></a>03371    rtcpheader[12] = htonl((((dlsr.tv_sec * 1000) + (dlsr.tv_usec / 1000)) * 65536) / 1000);
<a name="l03372"></a>03372    len += 24;
<a name="l03373"></a>03373    
<a name="l03374"></a>03374    rtcpheader[0] = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 24) | (<a class="code" href="rtp_8c.html#abe50a9d9c36c702889863e206f4502c6">RTCP_PT_SR</a> &lt;&lt; 16) | ((len/4)-1));
<a name="l03375"></a>03375 
<a name="l03376"></a>03376    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">sendfur</a>) {
<a name="l03377"></a>03377       rtcpheader[13] = htonl((2 &lt;&lt; 30) | (0 &lt;&lt; 24) | (<a class="code" href="rtp_8c.html#a38fce7504b6d0ac96b1f07fa86598ce8">RTCP_PT_FUR</a> &lt;&lt; 16) | 1);
<a name="l03378"></a>03378       rtcpheader[14] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);               <span class="comment">/* Our SSRC */</span>
<a name="l03379"></a>03379       len += 8;
<a name="l03380"></a>03380       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">sendfur</a> = 0;
<a name="l03381"></a>03381    }
<a name="l03382"></a>03382    
<a name="l03383"></a>03383    <span class="comment">/* Insert SDES here. Probably should make SDES text equal to mimetypes[code].type (not subtype &apos;cos */</span> 
<a name="l03384"></a>03384    <span class="comment">/* it can change mid call, and SDES can&apos;t) */</span>
<a name="l03385"></a>03385    rtcpheader[len/4]     = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 24) | (<a class="code" href="rtp_8c.html#aa6a84235b636497872f31a832a8b17af">RTCP_PT_SDES</a> &lt;&lt; 16) | 2);
<a name="l03386"></a>03386    rtcpheader[(len/4)+1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);               <span class="comment">/* Our SSRC */</span>
<a name="l03387"></a>03387    rtcpheader[(len/4)+2] = htonl(0x01 &lt;&lt; 24);                    <span class="comment">/* Empty for the moment */</span>
<a name="l03388"></a>03388    len += 12;
<a name="l03389"></a>03389    
<a name="l03390"></a>03390    res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)rtcpheader, len, 0, (<span class="keyword">struct</span> sockaddr *)&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03391"></a>03391    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03392"></a>03392       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTCP SR transmission error to %s:%d, rtcp halted %s\n&quot;</span>,<a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03393"></a>03393       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l03394"></a>03394       <span class="keywordflow">return</span> 0;
<a name="l03395"></a>03395    }
<a name="l03396"></a>03396    
<a name="l03397"></a>03397    <span class="comment">/* FIXME Don&apos;t need to get a new one */</span>
<a name="l03398"></a>03398    gettimeofday(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a9256f90f81a2d68ecff5d80919d62f1f">txlsr</a>, NULL);
<a name="l03399"></a>03399    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2fd3216670496c31020fd37341c0b8fd">sr_count</a>++;
<a name="l03400"></a>03400 
<a name="l03401"></a>03401    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a57d4e77faf4a4a7994bb396945c5e0c2">lastsrtxcount</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>;  
<a name="l03402"></a>03402    
<a name="l03403"></a>03403    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>)) {
<a name="l03404"></a>03404       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;* Sent RTCP SR to %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l03405"></a>03405       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Our SSRC: %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);
<a name="l03406"></a>03406       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Sent(NTP): %u.%010u\n&quot;</span>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)now.tv_sec, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)now.tv_usec*4096);
<a name="l03407"></a>03407       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Sent(RTP): %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>);
<a name="l03408"></a>03408       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Sent packets: %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>);
<a name="l03409"></a>03409       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Sent octets: %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#aed963fd645cea41f8f9a7dd144810204">txoctetcount</a>);
<a name="l03410"></a>03410       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Report block:\n&quot;</span>);
<a name="l03411"></a>03411       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Fraction lost: %u\n&quot;</span>, fraction);
<a name="l03412"></a>03412       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Cumulative loss: %u\n&quot;</span>, lost);
<a name="l03413"></a>03413       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  IA jitter: %.4f\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>);
<a name="l03414"></a>03414       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  Their last SR: %u\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a>);
<a name="l03415"></a>03415       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;  DLSR: %4.4f (sec)\n\n&quot;</span>, (<span class="keywordtype">double</span>)(ntohl(rtcpheader[12])/65536.0));
<a name="l03416"></a>03416    }
<a name="l03417"></a>03417    <a class="code" href="manager_8h.html#a1ef0ee0044dbbeb4c3a5abc6c046b208" title="External routines may send asterisk manager events this way.">manager_event</a>(<a class="code" href="manager_8h.html#a0b1b4140c2836696a6950e92ab48a580">EVENT_FLAG_REPORTING</a>, <span class="stringliteral">&quot;RTCPSent&quot;</span>, <span class="stringliteral">&quot;To: %s:%d\r\n&quot;</span>
<a name="l03418"></a>03418                    <span class="stringliteral">&quot;OurSSRC: %u\r\n&quot;</span>
<a name="l03419"></a>03419                    <span class="stringliteral">&quot;SentNTP: %u.%010u\r\n&quot;</span>
<a name="l03420"></a>03420                    <span class="stringliteral">&quot;SentRTP: %u\r\n&quot;</span>
<a name="l03421"></a>03421                    <span class="stringliteral">&quot;SentPackets: %u\r\n&quot;</span>
<a name="l03422"></a>03422                    <span class="stringliteral">&quot;SentOctets: %u\r\n&quot;</span>
<a name="l03423"></a>03423                    <span class="stringliteral">&quot;ReportBlock:\r\n&quot;</span>
<a name="l03424"></a>03424                    <span class="stringliteral">&quot;FractionLost: %u\r\n&quot;</span>
<a name="l03425"></a>03425                    <span class="stringliteral">&quot;CumulativeLoss: %u\r\n&quot;</span>
<a name="l03426"></a>03426                    <span class="stringliteral">&quot;IAJitter: %.4f\r\n&quot;</span>
<a name="l03427"></a>03427                    <span class="stringliteral">&quot;TheirLastSR: %u\r\n&quot;</span>
<a name="l03428"></a>03428                    <span class="stringliteral">&quot;DLSR: %4.4f (sec)\r\n&quot;</span>,
<a name="l03429"></a>03429                    <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port),
<a name="l03430"></a>03430                    rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>,
<a name="l03431"></a>03431                    (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)now.tv_sec, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)now.tv_usec*4096,
<a name="l03432"></a>03432                    rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>,
<a name="l03433"></a>03433                    rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>,
<a name="l03434"></a>03434                    rtp-&gt;<a class="code" href="structast__rtp.html#aed963fd645cea41f8f9a7dd144810204">txoctetcount</a>,
<a name="l03435"></a>03435                    fraction,
<a name="l03436"></a>03436                    lost,
<a name="l03437"></a>03437                    rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,
<a name="l03438"></a>03438                    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a>,
<a name="l03439"></a>03439                    (<span class="keywordtype">double</span>)(ntohl(rtcpheader[12])/65536.0));
<a name="l03440"></a>03440    <span class="keywordflow">return</span> res;
<a name="l03441"></a>03441 }
<a name="l03442"></a>03442 <span class="comment"></span>
<a name="l03443"></a>03443 <span class="comment">/*! \brief Send RTCP recipient&apos;s report */</span>
<a name="l03444"></a><a class="code" href="rtp_8c.html#ab76376f8b65ba8f04a89699200b02e42">03444</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#ab76376f8b65ba8f04a89699200b02e42" title="Send RTCP recipient&amp;#39;s report.">ast_rtcp_write_rr</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l03445"></a>03445 {
<a name="l03446"></a>03446    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = (<span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *)data;
<a name="l03447"></a>03447    <span class="keywordtype">int</span> res;
<a name="l03448"></a>03448    <span class="keywordtype">int</span> <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a> = 32;
<a name="l03449"></a>03449    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> lost;
<a name="l03450"></a>03450    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> extended;
<a name="l03451"></a>03451    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> expected;
<a name="l03452"></a>03452    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> expected_interval;
<a name="l03453"></a>03453    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> received_interval;
<a name="l03454"></a>03454    <span class="keywordtype">int</span> lost_interval;
<a name="l03455"></a>03455    <span class="keyword">struct </span>timeval now;
<a name="l03456"></a>03456    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtcpheader;
<a name="l03457"></a>03457    <span class="keywordtype">char</span> bdata[1024];
<a name="l03458"></a>03458    <span class="keyword">struct </span>timeval dlsr;
<a name="l03459"></a>03459    <span class="keywordtype">int</span> fraction;
<a name="l03460"></a>03460 
<a name="l03461"></a>03461    <span class="keywordtype">double</span> rxlost_current;
<a name="l03462"></a>03462    
<a name="l03463"></a>03463    <span class="keywordflow">if</span> (!rtp || !rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> || (&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr == 0))
<a name="l03464"></a>03464       <span class="keywordflow">return</span> 0;
<a name="l03465"></a>03465      
<a name="l03466"></a>03466    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr) {
<a name="l03467"></a>03467       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTCP RR transmission error, rtcp halted\n&quot;</span>);
<a name="l03468"></a>03468       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l03469"></a>03469       <span class="keywordflow">return</span> 0;
<a name="l03470"></a>03470    }
<a name="l03471"></a>03471 
<a name="l03472"></a>03472    extended = rtp-&gt;<a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a> + rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a>;
<a name="l03473"></a>03473    expected = extended - rtp-&gt;<a class="code" href="structast__rtp.html#a39b8d9a63bb7be44fbb707bb23721092">seedrxseqno</a> + 1;
<a name="l03474"></a>03474    lost = expected - rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l03475"></a>03475    expected_interval = expected - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a>;
<a name="l03476"></a>03476    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#af31acee9b731924c67c51fd05723c731">expected_prior</a> = expected;
<a name="l03477"></a>03477    received_interval = rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a> - rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a>;
<a name="l03478"></a>03478    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a2b107901d7cf12cb119aad6e54b5adb7">received_prior</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a066dafb1cdc02b25e6c2329ef7e7a810">rxcount</a>;
<a name="l03479"></a>03479    lost_interval = expected_interval - received_interval;
<a name="l03480"></a>03480 
<a name="l03481"></a>03481    <span class="keywordflow">if</span> (lost_interval &lt;= 0)
<a name="l03482"></a>03482       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a> = 0;
<a name="l03483"></a>03483    <span class="keywordflow">else</span> rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>;
<a name="l03484"></a>03484    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc391f094db19cec2988652fa901aef9">rxlost_count</a> == 0)
<a name="l03485"></a>03485       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad247636bc55f7b98c145f64c6a0e89fc">minrxlost</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>;
<a name="l03486"></a>03486    <span class="keywordflow">if</span> (lost_interval &lt; rtp-&gt;rtcp-&gt;minrxlost) 
<a name="l03487"></a>03487       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad247636bc55f7b98c145f64c6a0e89fc">minrxlost</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>;
<a name="l03488"></a>03488    <span class="keywordflow">if</span> (lost_interval &gt; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a156d5626391bfdfe33ff9ae0dd400ab0">maxrxlost</a>) 
<a name="l03489"></a>03489       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a156d5626391bfdfe33ff9ae0dd400ab0">maxrxlost</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>;
<a name="l03490"></a>03490 
<a name="l03491"></a>03491    rxlost_current = <a class="code" href="rtp_8c.html#a86102202cb3c77be2ceec5d9dcf84561" title="Calculate normal deviation.">normdev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa37952d4fb2366b7301fbb9066351eb1">normdev_rxlost</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc391f094db19cec2988652fa901aef9">rxlost_count</a>);
<a name="l03492"></a>03492    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#afb902f4eaea30d57054a372e3bda4082">stdev_rxlost</a> = <a class="code" href="rtp_8c.html#a31d5d9d7642101b098206acf2b4bf496">stddev_compute</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#afb902f4eaea30d57054a372e3bda4082">stdev_rxlost</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a6c68d12aeb69b6e57468fcab5c30b10d">rxlost</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa37952d4fb2366b7301fbb9066351eb1">normdev_rxlost</a>, rxlost_current, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc391f094db19cec2988652fa901aef9">rxlost_count</a>);
<a name="l03493"></a>03493    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aa37952d4fb2366b7301fbb9066351eb1">normdev_rxlost</a> = rxlost_current;
<a name="l03494"></a>03494    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abc391f094db19cec2988652fa901aef9">rxlost_count</a>++;
<a name="l03495"></a>03495 
<a name="l03496"></a>03496    <span class="keywordflow">if</span> (expected_interval == 0 || lost_interval &lt;= 0)
<a name="l03497"></a>03497       fraction = 0;
<a name="l03498"></a>03498    <span class="keywordflow">else</span>
<a name="l03499"></a>03499       fraction = (lost_interval &lt;&lt; 8) / expected_interval;
<a name="l03500"></a>03500    gettimeofday(&amp;now, NULL);
<a name="l03501"></a>03501    timersub(&amp;now, &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#ad96a304ae7c0f3dd877c1db41a5a668e">rxlsr</a>, &amp;dlsr);
<a name="l03502"></a>03502    rtcpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)bdata;
<a name="l03503"></a>03503    rtcpheader[0] = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 24) | (<a class="code" href="rtp_8c.html#a4d8564f9c96df1cd1076ad4f6faed7ab">RTCP_PT_RR</a> &lt;&lt; 16) | ((len/4)-1));
<a name="l03504"></a>03504    rtcpheader[1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);
<a name="l03505"></a>03505    rtcpheader[2] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>);
<a name="l03506"></a>03506    rtcpheader[3] = htonl(((fraction &amp; 0xff) &lt;&lt; 24) | (lost &amp; 0xffffff));
<a name="l03507"></a>03507    rtcpheader[4] = htonl((rtp-&gt;<a class="code" href="structast__rtp.html#a93c8f827085bb8e8e17e59ad2495ecc7">cycles</a>) | ((rtp-&gt;<a class="code" href="structast__rtp.html#a184e1597cfcf7b28d1cf5d4857892a91">lastrxseqno</a> &amp; 0xffff)));
<a name="l03508"></a>03508    rtcpheader[5] = htonl((<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span>)(rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a> * 65536.));
<a name="l03509"></a>03509    rtcpheader[6] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a>);
<a name="l03510"></a>03510    rtcpheader[7] = htonl((((dlsr.tv_sec * 1000) + (dlsr.tv_usec / 1000)) * 65536) / 1000);
<a name="l03511"></a>03511 
<a name="l03512"></a>03512    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">sendfur</a>) {
<a name="l03513"></a>03513       rtcpheader[8] = htonl((2 &lt;&lt; 30) | (0 &lt;&lt; 24) | (<a class="code" href="rtp_8c.html#a38fce7504b6d0ac96b1f07fa86598ce8">RTCP_PT_FUR</a> &lt;&lt; 16) | 1); <span class="comment">/* Header from page 36 in RFC 3550 */</span>
<a name="l03514"></a>03514       rtcpheader[9] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);               <span class="comment">/* Our SSRC */</span>
<a name="l03515"></a>03515       len += 8;
<a name="l03516"></a>03516       rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a81f0ffde0bcf0d037264b8f9ed68ab4b">sendfur</a> = 0;
<a name="l03517"></a>03517    }
<a name="l03518"></a>03518 <span class="comment"></span>
<a name="l03519"></a>03519 <span class="comment">   /*! \note Insert SDES here. Probably should make SDES text equal to mimetypes[code].type (not subtype &apos;cos </span>
<a name="l03520"></a>03520 <span class="comment">   it can change mid call, and SDES can&apos;t) */</span>
<a name="l03521"></a>03521    rtcpheader[len/4]     = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 24) | (<a class="code" href="rtp_8c.html#aa6a84235b636497872f31a832a8b17af">RTCP_PT_SDES</a> &lt;&lt; 16) | 2);
<a name="l03522"></a>03522    rtcpheader[(len/4)+1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>);               <span class="comment">/* Our SSRC */</span>
<a name="l03523"></a>03523    rtcpheader[(len/4)+2] = htonl(0x01 &lt;&lt; 24);              <span class="comment">/* Empty for the moment */</span>
<a name="l03524"></a>03524    len += 12;
<a name="l03525"></a>03525    
<a name="l03526"></a>03526    res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)rtcpheader, len, 0, (<span class="keyword">struct</span> sockaddr *)&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03527"></a>03527 
<a name="l03528"></a>03528    <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03529"></a>03529       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTCP RR transmission error, rtcp halted: %s\n&quot;</span>,strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03530"></a>03530       <span class="comment">/* Remove the scheduler */</span>
<a name="l03531"></a>03531       <a class="code" href="sched_8h.html#a25647782014f8dc012994efcd1b81d32" title="a loop construct to ensure that the scheduled task get deleted. The idea is that...">AST_SCHED_DEL</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a>);
<a name="l03532"></a>03532       <span class="keywordflow">return</span> 0;
<a name="l03533"></a>03533    }
<a name="l03534"></a>03534 
<a name="l03535"></a>03535    rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#abfdd17fa9ca6b018fea2fe58c5738712">rr_count</a>++;
<a name="l03536"></a>03536 
<a name="l03537"></a>03537    <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a24040ef125f03db4df56ee0113beee9e">rtcp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>)) {
<a name="l03538"></a>03538       <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;\n* Sending RTCP RR to %s:%d\n&quot;</span>
<a name="l03539"></a>03539          <span class="stringliteral">&quot;  Our SSRC: %u\nTheir SSRC: %u\niFraction lost: %d\nCumulative loss: %u\n&quot;</span> 
<a name="l03540"></a>03540          <span class="stringliteral">&quot;  IA jitter: %.4f\n&quot;</span> 
<a name="l03541"></a>03541          <span class="stringliteral">&quot;  Their last SR: %u\n&quot;</span> 
<a name="l03542"></a>03542          <span class="stringliteral">&quot;  DLSR: %4.4f (sec)\n\n&quot;</span>,
<a name="l03543"></a>03543          <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr),
<a name="l03544"></a>03544          ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port),
<a name="l03545"></a>03545          rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>, rtp-&gt;<a class="code" href="structast__rtp.html#afe92c8ff0d37afbf84f8715f4144ca27">themssrc</a>, fraction, lost,
<a name="l03546"></a>03546          rtp-&gt;<a class="code" href="structast__rtp.html#a80552fd3f7f852d51e944dc4105da800">rxjitter</a>,
<a name="l03547"></a>03547          rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1a01ee9eadfc673fe172181c754928f5">themrxlsr</a>,
<a name="l03548"></a>03548          (<span class="keywordtype">double</span>)(ntohl(rtcpheader[7])/65536.0));
<a name="l03549"></a>03549    }
<a name="l03550"></a>03550 
<a name="l03551"></a>03551    <span class="keywordflow">return</span> res;
<a name="l03552"></a>03552 }
<a name="l03553"></a>03553 <span class="comment"></span>
<a name="l03554"></a>03554 <span class="comment">/*! \brief Write and RTCP packet to the far end</span>
<a name="l03555"></a>03555 <span class="comment"> * \note Decide if we are going to send an SR (with Reception Block) or RR </span>
<a name="l03556"></a>03556 <span class="comment"> * RR is sent if we have not sent any rtp packets in the previous interval */</span>
<a name="l03557"></a><a class="code" href="rtp_8c.html#aff89c2855ec73ffa6efdc958bb71c2e8">03557</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#aff89c2855ec73ffa6efdc958bb71c2e8" title="Write and RTCP packet to the far end.">ast_rtcp_write</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l03558"></a>03558 {
<a name="l03559"></a>03559    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = (<span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *)data;
<a name="l03560"></a>03560    <span class="keywordtype">int</span> res;
<a name="l03561"></a>03561    
<a name="l03562"></a>03562    <span class="keywordflow">if</span> (!rtp || !rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>)
<a name="l03563"></a>03563       <span class="keywordflow">return</span> 0;
<a name="l03564"></a>03564 
<a name="l03565"></a>03565    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a> &gt; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a57d4e77faf4a4a7994bb396945c5e0c2">lastsrtxcount</a>)
<a name="l03566"></a>03566       res = <a class="code" href="rtp_8c.html#af9fe82760c62b9bfe98044b3e53acef5" title="Send RTCP sender&amp;#39;s report.">ast_rtcp_write_sr</a>(data);
<a name="l03567"></a>03567    <span class="keywordflow">else</span>
<a name="l03568"></a>03568       res = <a class="code" href="rtp_8c.html#ab76376f8b65ba8f04a89699200b02e42" title="Send RTCP recipient&amp;#39;s report.">ast_rtcp_write_rr</a>(data);
<a name="l03569"></a>03569    
<a name="l03570"></a>03570    <span class="keywordflow">return</span> res;
<a name="l03571"></a>03571 }
<a name="l03572"></a>03572 <span class="comment"></span>
<a name="l03573"></a>03573 <span class="comment">/*! \brief generate comfort noice (CNG) */</span>
<a name="l03574"></a><a class="code" href="rtp_8c.html#ab1a31f2e24aafee3087c227e50eb4ee8">03574</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#ab1a31f2e24aafee3087c227e50eb4ee8" title="generate comfort noice (CNG)">ast_rtp_sendcng</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> level)
<a name="l03575"></a>03575 {
<a name="l03576"></a>03576    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *rtpheader;
<a name="l03577"></a>03577    <span class="keywordtype">int</span> hdrlen = 12;
<a name="l03578"></a>03578    <span class="keywordtype">int</span> res;
<a name="l03579"></a>03579    <span class="keywordtype">int</span> payload;
<a name="l03580"></a>03580    <span class="keywordtype">char</span> <a class="code" href="structast__rtp.html#a735984d41155bc1032e09bece8f8d66d">data</a>[256];
<a name="l03581"></a>03581    level = 127 - (level &amp; 0x7f);
<a name="l03582"></a>03582    payload = <a class="code" href="rtp_8h.html#a4daa559b8f2ef25bc33d8f5d8fd937d1" title="Looks up an RTP code out of our *static* outbound list.">ast_rtp_lookup_code</a>(rtp, 0, <a class="code" href="rtp_8h.html#ad924782a38efb3a8f9edbb92d3135541">AST_RTP_CN</a>);
<a name="l03583"></a>03583 
<a name="l03584"></a>03584    <span class="comment">/* If we have no peer, return immediately */</span> 
<a name="l03585"></a>03585    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr)
<a name="l03586"></a>03586       <span class="keywordflow">return</span> 0;
<a name="l03587"></a>03587 
<a name="l03588"></a>03588    rtp-&gt;<a class="code" href="structast__rtp.html#acb642f88034264b2a2e1ef4a89647909">dtmfmute</a> = <a class="code" href="time_8h.html#a97e1bb8fbd7a103212789e87e7ed6073" title="Returns the sum of two timevals a + b.">ast_tvadd</a>(<a class="code" href="time_8h.html#abd5ba75c20787bcc479809c53b58406e" title="Returns current timeval. Meant to replace calls to gettimeofday().">ast_tvnow</a>(), <a class="code" href="time_8h.html#af46dec59fc43982d018a757f7b499669" title="Returns a timeval from sec, usec.">ast_tv</a>(0, 500000));
<a name="l03589"></a>03589 
<a name="l03590"></a>03590    <span class="comment">/* Get a pointer to the header */</span>
<a name="l03591"></a>03591    rtpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)data;
<a name="l03592"></a>03592    rtpheader[0] = htonl((2 &lt;&lt; 30) | (1 &lt;&lt; 23) | (payload &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>++));
<a name="l03593"></a>03593    rtpheader[1] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>);
<a name="l03594"></a>03594    rtpheader[2] = htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>); 
<a name="l03595"></a>03595    data[12] = level;
<a name="l03596"></a>03596    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr) {
<a name="l03597"></a>03597       res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">void</span> *)rtpheader, hdrlen + 1, 0, (<span class="keyword">struct</span> sockaddr *)&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03598"></a>03598       <span class="keywordflow">if</span> (res &lt;0) 
<a name="l03599"></a>03599          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#aced66975c154ea0e2a8ec3bc818b4e08">LOG_ERROR</a>, <span class="stringliteral">&quot;RTP Comfort Noise Transmission error to %s:%d: %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03600"></a>03600       <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>))
<a name="l03601"></a>03601          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Sent Comfort Noise RTP packet to %s:%u (type %d, seq %u, ts %u, len %d)\n&quot;</span>
<a name="l03602"></a>03602                , <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), payload, rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>,res - hdrlen);         
<a name="l03603"></a>03603          
<a name="l03604"></a>03604    }
<a name="l03605"></a>03605    <span class="keywordflow">return</span> 0;
<a name="l03606"></a>03606 }
<a name="l03607"></a>03607 <span class="comment"></span>
<a name="l03608"></a>03608 <span class="comment">/*! \brief Write RTP packet with audio or video media frames into UDP packet */</span>
<a name="l03609"></a><a class="code" href="rtp_8c.html#a8aca902dc9d1d2540319c23b3c4943e1">03609</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a8aca902dc9d1d2540319c23b3c4943e1" title="Write RTP packet with audio or video media frames into UDP packet.">ast_rtp_raw_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>, <span class="keywordtype">int</span> codec)
<a name="l03610"></a>03610 {
<a name="l03611"></a>03611    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *rtpheader;
<a name="l03612"></a>03612    <span class="keywordtype">int</span> hdrlen = 12;
<a name="l03613"></a>03613    <span class="keywordtype">int</span> res;
<a name="l03614"></a>03614    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> ms;
<a name="l03615"></a>03615    <span class="keywordtype">int</span> pred;
<a name="l03616"></a>03616    <span class="keywordtype">int</span> mark = 0;
<a name="l03617"></a>03617    <span class="keywordtype">int</span> rate = <a class="code" href="rtp_8c.html#a8e6e4d6b1e4a0eb553b5e8531dd9eff7">rtp_get_rate</a>(f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>) / 1000;
<a name="l03618"></a>03618 
<a name="l03619"></a>03619    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#a4a0e8720928940d26abf28fff2e6586d">AST_FORMAT_G722</a>) {
<a name="l03620"></a>03620       f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a> /= 2;
<a name="l03621"></a>03621    }
<a name="l03622"></a>03622 
<a name="l03623"></a>03623    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#af637078f896cfd75467174c20d0cb217">sending_digit</a>) {
<a name="l03624"></a>03624       <span class="keywordflow">return</span> 0;
<a name="l03625"></a>03625    }
<a name="l03626"></a>03626 
<a name="l03627"></a>03627    ms = <a class="code" href="rtp_8c.html#a4c3a6d3e3a2ffc5044526e5db91fb6b5">calc_txstamp</a>(rtp, &amp;f-&gt;<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>);
<a name="l03628"></a>03628    <span class="comment">/* Default prediction */</span>
<a name="l03629"></a>03629    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) {
<a name="l03630"></a>03630       pred = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> + f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l03631"></a>03631 
<a name="l03632"></a>03632       <span class="comment">/* Re-calculate last TS */</span>
<a name="l03633"></a>03633       rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> + ms * rate;
<a name="l03634"></a>03634       <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(f-&gt;<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>)) {
<a name="l03635"></a>03635          <span class="comment">/* If this isn&apos;t an absolute delivery time, Check if it is close to our prediction, </span>
<a name="l03636"></a>03636 <span class="comment">            and if so, go with our prediction */</span>
<a name="l03637"></a>03637          <span class="keywordflow">if</span> (abs(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> - pred) &lt; <a class="code" href="chan__iax2_8c.html#a12a850150b82a6ce1077e204d4f5638c">MAX_TIMESTAMP_SKEW</a>)
<a name="l03638"></a>03638             rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = pred;
<a name="l03639"></a>03639          <span class="keywordflow">else</span> {
<a name="l03640"></a>03640             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Difference is %d, ms is %d\n&quot;</span>, abs(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> - pred), ms);
<a name="l03641"></a>03641             mark = 1;
<a name="l03642"></a>03642          }
<a name="l03643"></a>03643       }
<a name="l03644"></a>03644    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) {
<a name="l03645"></a>03645       mark = f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> &amp; 0x1;
<a name="l03646"></a>03646       pred = rtp-&gt;<a class="code" href="structast__rtp.html#a9a2293b0120398a3a10aed1a98a5ea59">lastovidtimestamp</a> + f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l03647"></a>03647       <span class="comment">/* Re-calculate last TS */</span>
<a name="l03648"></a>03648       rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> + ms * 90;
<a name="l03649"></a>03649       <span class="comment">/* If it&apos;s close to our prediction, go for it */</span>
<a name="l03650"></a>03650       <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(f-&gt;<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>)) {
<a name="l03651"></a>03651          <span class="keywordflow">if</span> (abs(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> - pred) &lt; 7200) {
<a name="l03652"></a>03652             rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = pred;
<a name="l03653"></a>03653             rtp-&gt;<a class="code" href="structast__rtp.html#a9a2293b0120398a3a10aed1a98a5ea59">lastovidtimestamp</a> += f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l03654"></a>03654          } <span class="keywordflow">else</span> {
<a name="l03655"></a>03655             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Difference is %d, ms is %d (%d), pred/ts/samples %d/%d/%d\n&quot;</span>, abs(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> - pred), ms, ms * 90, rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>, pred, f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>);
<a name="l03656"></a>03656             rtp-&gt;<a class="code" href="structast__rtp.html#a9a2293b0120398a3a10aed1a98a5ea59">lastovidtimestamp</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>;
<a name="l03657"></a>03657          }
<a name="l03658"></a>03658       }
<a name="l03659"></a>03659    } <span class="keywordflow">else</span> {
<a name="l03660"></a>03660       pred = rtp-&gt;<a class="code" href="structast__rtp.html#abf1f99fdbacb09d2077fdc250bccc269">lastotexttimestamp</a> + f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l03661"></a>03661       <span class="comment">/* Re-calculate last TS */</span>
<a name="l03662"></a>03662       rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> + ms;
<a name="l03663"></a>03663       <span class="comment">/* If it&apos;s close to our prediction, go for it */</span>
<a name="l03664"></a>03664       <span class="keywordflow">if</span> (<a class="code" href="time_8h.html#a1b7c6177ea781fc11512de25805fc144" title="Returns true if the argument is 0,0.">ast_tvzero</a>(f-&gt;<a class="code" href="structast__frame.html#a41a708025486b4c9383e7432e9ba3f0e">delivery</a>)) {
<a name="l03665"></a>03665          <span class="keywordflow">if</span> (abs(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> - pred) &lt; 7200) {
<a name="l03666"></a>03666             rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = pred;
<a name="l03667"></a>03667             rtp-&gt;<a class="code" href="structast__rtp.html#abf1f99fdbacb09d2077fdc250bccc269">lastotexttimestamp</a> += f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>;
<a name="l03668"></a>03668          } <span class="keywordflow">else</span> {
<a name="l03669"></a>03669             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Difference is %d, ms is %d, pred/ts/samples %d/%d/%d\n&quot;</span>, abs(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> - pred), ms, rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>, pred, f-&gt;<a class="code" href="structast__frame.html#a37672e6b906143604cefd3e959777b31">samples</a>);
<a name="l03670"></a>03670             rtp-&gt;<a class="code" href="structast__rtp.html#abf1f99fdbacb09d2077fdc250bccc269">lastotexttimestamp</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>;
<a name="l03671"></a>03671          }
<a name="l03672"></a>03672       }
<a name="l03673"></a>03673    }
<a name="l03674"></a>03674 
<a name="l03675"></a>03675    <span class="comment">/* If we have been explicitly told to set the marker bit do so */</span>
<a name="l03676"></a>03676    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a1089b0c7f83ef826379989c20a11fd4b">set_marker_bit</a>) {
<a name="l03677"></a>03677       mark = 1;
<a name="l03678"></a>03678       rtp-&gt;<a class="code" href="structast__rtp.html#a1089b0c7f83ef826379989c20a11fd4b">set_marker_bit</a> = 0;
<a name="l03679"></a>03679    }
<a name="l03680"></a>03680 
<a name="l03681"></a>03681    <span class="comment">/* If the timestamp for non-digit packets has moved beyond the timestamp</span>
<a name="l03682"></a>03682 <span class="comment">      for digits, update the digit timestamp.</span>
<a name="l03683"></a>03683 <span class="comment">   */</span>
<a name="l03684"></a>03684    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> &gt; rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a>)
<a name="l03685"></a>03685       rtp-&gt;<a class="code" href="structast__rtp.html#aed4ece79ac99ad5381829fc0392bc542">lastdigitts</a> = rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>;
<a name="l03686"></a>03686 
<a name="l03687"></a>03687    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(f, <a class="code" href="frame_8h.html#a0ae1e3bf78c960c83e2d437efd802058ae8f674e19f6450e2b746c8a52c11649a">AST_FRFLAG_HAS_TIMING_INFO</a>))
<a name="l03688"></a>03688       rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a> = f-&gt;<a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a> * rate;
<a name="l03689"></a>03689 
<a name="l03690"></a>03690    <span class="comment">/* Get a pointer to the header */</span>
<a name="l03691"></a>03691    rtpheader = (<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *)(f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> - hdrlen);
<a name="l03692"></a>03692 
<a name="l03693"></a>03693    <a class="code" href="unaligned_8h.html#ae0b7823a3fab76dbec84f308adeb7f5a">put_unaligned_uint32</a>(rtpheader, htonl((2 &lt;&lt; 30) | (codec &lt;&lt; 16) | (rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>) | (mark &lt;&lt; 23)));
<a name="l03694"></a>03694    <a class="code" href="unaligned_8h.html#ae0b7823a3fab76dbec84f308adeb7f5a">put_unaligned_uint32</a>(rtpheader + 4, htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>));
<a name="l03695"></a>03695    <a class="code" href="unaligned_8h.html#ae0b7823a3fab76dbec84f308adeb7f5a">put_unaligned_uint32</a>(rtpheader + 8, htonl(rtp-&gt;<a class="code" href="structast__rtp.html#a9e10385ac55d32d10ef322d1a08a699d">ssrc</a>)); 
<a name="l03696"></a>03696 
<a name="l03697"></a>03697    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr) {
<a name="l03698"></a>03698       res = sendto(rtp-&gt;<a class="code" href="structast__rtp.html#a339d22b3e442946380f98ed19e320db2">s</a>, (<span class="keywordtype">void</span> *)rtpheader, f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> + hdrlen, 0, (<span class="keyword">struct</span> sockaddr *)&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>));
<a name="l03699"></a>03699       <span class="keywordflow">if</span> (res &lt; 0) {
<a name="l03700"></a>03700          <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a> || (rtp-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a> &amp;&amp; (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>) == <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>))) {
<a name="l03701"></a>03701             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;RTP Transmission error of packet %d to %s:%d: %s\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), strerror(<a class="code" href="private_8h.html#ad65a8842cc674e3ddf69355898c0ecbf">errno</a>));
<a name="l03702"></a>03702          } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>) == <a class="code" href="rtp_8c.html#a7ea8f10bd8b1fab6990526c3271a7b59">FLAG_NAT_INACTIVE</a>) || rtpdebug) &amp;&amp; !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#ad2adc4c49cf65121c15dc838f43c6cb0">FLAG_NAT_INACTIVE_NOWARN</a>)) {
<a name="l03703"></a>03703             <span class="comment">/* Only give this error message once if we are not RTP debugging */</span>
<a name="l03704"></a>03704             <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l03705"></a>03705                <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;RTP NAT: Can&apos;t write RTP to private address %s:%d, waiting for other end to send audio...\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l03706"></a>03706             <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8c.html#ad2adc4c49cf65121c15dc838f43c6cb0">FLAG_NAT_INACTIVE_NOWARN</a>);
<a name="l03707"></a>03707          }
<a name="l03708"></a>03708       } <span class="keywordflow">else</span> {
<a name="l03709"></a>03709          rtp-&gt;<a class="code" href="structast__rtp.html#a887918839240a36d118b4e1cb46a4de9">txcount</a>++;
<a name="l03710"></a>03710          rtp-&gt;<a class="code" href="structast__rtp.html#aed963fd645cea41f8f9a7dd144810204">txoctetcount</a> +=(res - hdrlen);
<a name="l03711"></a>03711          
<a name="l03712"></a>03712          <span class="comment">/* Do not schedule RR if RTCP isn&apos;t run */</span>
<a name="l03713"></a>03713          <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a> &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr &amp;&amp; rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a> &lt; 1) {
<a name="l03714"></a>03714             rtp-&gt;<a class="code" href="structast__rtp.html#a76ff89d752f6ec207621cf92c9a93d09">rtcp</a>-&gt;<a class="code" href="structast__rtcp.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a> = <a class="code" href="sched_8h.html#a97176531282ac4e70aa107b2e8ee5543" title="Adds a scheduled event Schedule an event to take place at some point in the future...">ast_sched_add</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, <a class="code" href="rtp_8c.html#ae8c264c840c8c9b4e8ca062746000506">ast_rtcp_calc_interval</a>(rtp), <a class="code" href="rtp_8c.html#aff89c2855ec73ffa6efdc958bb71c2e8" title="Write and RTCP packet to the far end.">ast_rtcp_write</a>, rtp);
<a name="l03715"></a>03715          }
<a name="l03716"></a>03716       }
<a name="l03717"></a>03717             
<a name="l03718"></a>03718       <span class="keywordflow">if</span> (<a class="code" href="rtp_8c.html#a204c446f295fb302b05363d78f2d8d34">rtp_debug_test_addr</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>))
<a name="l03719"></a>03719          <a class="code" href="logger_8h.html#afcd8b407dfb3f461488abf7d1ed70fb9">ast_verbose</a>(<span class="stringliteral">&quot;Sent RTP packet to      %s:%u (type %-2.2d, seq %-6.6u, ts %-6.6u, len %-6.6u)\n&quot;</span>,
<a name="l03720"></a>03720                <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port), codec, rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a2eb3b9494c999b0dd38c4d40bfdc55b4">lastts</a>,res - hdrlen);
<a name="l03721"></a>03721    }
<a name="l03722"></a>03722 
<a name="l03723"></a>03723    rtp-&gt;<a class="code" href="structast__rtp.html#a66d741481aec999a0e8bc17f70db4ebe">seqno</a>++;
<a name="l03724"></a>03724 
<a name="l03725"></a>03725    <span class="keywordflow">return</span> 0;
<a name="l03726"></a>03726 }
<a name="l03727"></a>03727 
<a name="l03728"></a><a class="code" href="rtp_8c.html#ae6a1acd75aaf08afc6954bd5ac671c6a">03728</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#ae6a1acd75aaf08afc6954bd5ac671c6a" title="Set codec preference.">ast_rtp_codec_setpref</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> <a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *<a class="code" href="chan__iax2_8c.html#a46262e3cc2baf55a72542567ccfe86d9">prefs</a>)
<a name="l03729"></a>03729 {
<a name="l03730"></a>03730    <span class="keyword">struct </span><a class="code" href="structast__format__list.html" title="Definition of supported media formats (codecs).">ast_format_list</a> current_format_old, current_format_new;
<a name="l03731"></a>03731 
<a name="l03732"></a>03732    <span class="comment">/* if no packets have been sent through this session yet, then</span>
<a name="l03733"></a>03733 <span class="comment">    *  changing preferences does not require any extra work</span>
<a name="l03734"></a>03734 <span class="comment">    */</span>
<a name="l03735"></a>03735    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a> == 0) {
<a name="l03736"></a>03736       rtp-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a> = *prefs;
<a name="l03737"></a>03737       <span class="keywordflow">return</span>;
<a name="l03738"></a>03738    }
<a name="l03739"></a>03739 
<a name="l03740"></a>03740    current_format_old = <a class="code" href="frame_8h.html#ac9789499b866949ab31bab025b497964" title="Get packet size for codec.">ast_codec_pref_getsize</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a>, rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a>);
<a name="l03741"></a>03741 
<a name="l03742"></a>03742    rtp-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a> = *prefs;
<a name="l03743"></a>03743 
<a name="l03744"></a>03744    current_format_new = <a class="code" href="frame_8h.html#ac9789499b866949ab31bab025b497964" title="Get packet size for codec.">ast_codec_pref_getsize</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a>, rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a>);
<a name="l03745"></a>03745 
<a name="l03746"></a>03746    <span class="comment">/* if the framing desired for the current format has changed, we may have to create</span>
<a name="l03747"></a>03747 <span class="comment">    * or adjust the smoother for this session</span>
<a name="l03748"></a>03748 <span class="comment">    */</span>
<a name="l03749"></a>03749    <span class="keywordflow">if</span> ((current_format_new.<a class="code" href="structast__format__list.html#a05368e07b33c55c5588a16887e0d1937">inc_ms</a> != 0) &amp;&amp;
<a name="l03750"></a>03750        (current_format_new.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a> != current_format_old.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>)) {
<a name="l03751"></a>03751       <span class="keywordtype">int</span> new_size = (current_format_new.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a> * current_format_new.<a class="code" href="structast__format__list.html#a9e1771ccc63dc75f22fb3ea58841fc9c">fr_len</a>) / current_format_new.<a class="code" href="structast__format__list.html#a05368e07b33c55c5588a16887e0d1937">inc_ms</a>;
<a name="l03752"></a>03752 
<a name="l03753"></a>03753       if (rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>) {
<a name="l03754"></a>03754          <a class="code" href="frame_8h.html#a34c247d5417aed64069bbeac7fc09728" title="Reconfigure an existing smoother to output a different number of bytes per frame...">ast_smoother_reconfigure</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>, new_size);
<a name="l03755"></a>03755          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l03756"></a>03756             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Adjusted smoother to %d ms and %d bytes\n&quot;</span>, current_format_new.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>, new_size);
<a name="l03757"></a>03757          }
<a name="l03758"></a>03758       } <span class="keywordflow">else</span> {
<a name="l03759"></a>03759          <span class="keywordflow">if</span> (!(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a> = <a class="code" href="frame_8h.html#a6f1c795e5db00c9eb553e540dce7a503">ast_smoother_new</a>(new_size))) {
<a name="l03760"></a>03760             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create smoother: format: %d ms: %d len: %d\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a>, current_format_new.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>, new_size);
<a name="l03761"></a>03761             <span class="keywordflow">return</span>;
<a name="l03762"></a>03762          }
<a name="l03763"></a>03763          <span class="keywordflow">if</span> (current_format_new.<a class="code" href="structast__format__list.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>) {
<a name="l03764"></a>03764             <a class="code" href="frame_8h.html#a2bf0a4739b534e4f317230763ec3afcb">ast_smoother_set_flags</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>, current_format_new.<a class="code" href="structast__format__list.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>);
<a name="l03765"></a>03765          }
<a name="l03766"></a>03766          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a>) {
<a name="l03767"></a>03767             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#a6ff63e8955665c4a58b1598f2b07c51a">LOG_DEBUG</a>, <span class="stringliteral">&quot;Created smoother: format: %d ms: %d len: %d\n&quot;</span>, rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a>, current_format_new.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>, new_size);
<a name="l03768"></a>03768          }
<a name="l03769"></a>03769       }
<a name="l03770"></a>03770    }
<a name="l03771"></a>03771 
<a name="l03772"></a>03772 }
<a name="l03773"></a>03773 
<a name="l03774"></a><a class="code" href="rtp_8c.html#af759eaf34ade34d4f118d45655fcd6bc">03774</a> <span class="keyword">struct </span><a class="code" href="structast__codec__pref.html">ast_codec_pref</a> *<a class="code" href="rtp_8h.html#af759eaf34ade34d4f118d45655fcd6bc" title="Get codec preference.">ast_rtp_codec_getpref</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp)
<a name="l03775"></a>03775 {
<a name="l03776"></a>03776    <span class="keywordflow">return</span> &amp;rtp-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a>;
<a name="l03777"></a>03777 }
<a name="l03778"></a>03778 
<a name="l03779"></a><a class="code" href="rtp_8c.html#a6fbba7cab174d951968e91cc94afb200">03779</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a6fbba7cab174d951968e91cc94afb200" title="get format from predefined dynamic payload format">ast_rtp_codec_getformat</a>(<span class="keywordtype">int</span> pt)
<a name="l03780"></a>03780 {
<a name="l03781"></a>03781    <span class="keywordflow">if</span> (pt &lt; 0 || pt &gt;= <a class="code" href="rtp_8h.html#ac8aa85cd14ebbc20fc0043f6f72b968d">MAX_RTP_PT</a>)
<a name="l03782"></a>03782       <span class="keywordflow">return</span> 0; <span class="comment">/* bogus payload type */</span>
<a name="l03783"></a>03783 
<a name="l03784"></a>03784    <span class="keywordflow">if</span> (static_RTP_PT[pt].isAstFormat)
<a name="l03785"></a>03785       <span class="keywordflow">return</span> static_RTP_PT[pt].<a class="code" href="structrtpPayloadType.html#a45a5b7c00a796a23f01673cef1dbe0a9">code</a>;
<a name="l03786"></a>03786    <span class="keywordflow">else</span>
<a name="l03787"></a>03787       <span class="keywordflow">return</span> 0;
<a name="l03788"></a>03788 }
<a name="l03789"></a>03789 
<a name="l03790"></a><a class="code" href="rtp_8c.html#a8a5e029f4d48bcdd51f4f1837f80f182">03790</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a7a8ffdcbe10f04c3ca29e7cad359a68c">ast_rtp_write</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *_f)
<a name="l03791"></a>03791 {
<a name="l03792"></a>03792    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>;
<a name="l03793"></a>03793    <span class="keywordtype">int</span> codec;
<a name="l03794"></a>03794    <span class="keywordtype">int</span> hdrlen = 12;
<a name="l03795"></a>03795    <span class="keywordtype">int</span> <a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l03796"></a>03796    
<a name="l03797"></a>03797 
<a name="l03798"></a>03798    <span class="comment">/* If we have no peer, return immediately */</span> 
<a name="l03799"></a>03799    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr)
<a name="l03800"></a>03800       <span class="keywordflow">return</span> 0;
<a name="l03801"></a>03801 
<a name="l03802"></a>03802    <span class="comment">/* If there is no data length, return immediately */</span>
<a name="l03803"></a>03803    <span class="keywordflow">if</span> (!_f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &amp;&amp; !rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>)
<a name="l03804"></a>03804       <span class="keywordflow">return</span> 0;
<a name="l03805"></a>03805    
<a name="l03806"></a>03806    <span class="comment">/* Make sure we have enough space for RTP header */</span>
<a name="l03807"></a>03807    <span class="keywordflow">if</span> ((_f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) &amp;&amp; (_f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) &amp;&amp; (_f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> != <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>)) {
<a name="l03808"></a>03808       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;RTP can only send voice, video and text\n&quot;</span>);
<a name="l03809"></a>03809       <span class="keywordflow">return</span> -1;
<a name="l03810"></a>03810    }
<a name="l03811"></a>03811 
<a name="l03812"></a>03812    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>) {
<a name="l03813"></a>03813       <span class="comment">/* return 0; */</span>
<a name="l03814"></a>03814       <span class="comment">/* no primary data or generations to send */</span>
<a name="l03815"></a>03815       <span class="keywordflow">if</span> ((_f = <a class="code" href="rtp_8c.html#ae290f54e950a7b43fc6252366758745c" title="Construct a redundant frame.">red_t140_to_red</a>(rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>)) == NULL) 
<a name="l03816"></a>03816          <span class="keywordflow">return</span> 0;
<a name="l03817"></a>03817    }
<a name="l03818"></a>03818 
<a name="l03819"></a>03819    <span class="comment">/* The bottom bit of a video subclass contains the marker bit */</span>
<a name="l03820"></a>03820    subclass = _f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>;
<a name="l03821"></a>03821    <span class="keywordflow">if</span> (_f-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>)
<a name="l03822"></a>03822       subclass &amp;= ~0x1;
<a name="l03823"></a>03823 
<a name="l03824"></a>03824    codec = <a class="code" href="rtp_8h.html#a4daa559b8f2ef25bc33d8f5d8fd937d1" title="Looks up an RTP code out of our *static* outbound list.">ast_rtp_lookup_code</a>(rtp, 1, subclass);
<a name="l03825"></a>03825    <span class="keywordflow">if</span> (codec &lt; 0) {
<a name="l03826"></a>03826       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Don&apos;t know how to send format %s packets with RTP\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(_f-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>));
<a name="l03827"></a>03827       <span class="keywordflow">return</span> -1;
<a name="l03828"></a>03828    }
<a name="l03829"></a>03829 
<a name="l03830"></a>03830    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a> != subclass) {
<a name="l03831"></a>03831       <span class="comment">/* New format, reset the smoother */</span>
<a name="l03832"></a>03832       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, format changed from %s to %s\n&quot;</span>, <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a>), <a class="code" href="frame_8h.html#afe8f690984f8ba95cd01a431198c10bf" title="Get the name of a format.">ast_getformatname</a>(subclass));
<a name="l03833"></a>03833       rtp-&gt;<a class="code" href="structast__rtp.html#aad2a54a4541520f7f134aa28717fe1e7">lasttxformat</a> = subclass;
<a name="l03834"></a>03834       <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>)
<a name="l03835"></a>03835          <a class="code" href="frame_8h.html#a6d3b71e0a81af743bae6c33c02b64f1f">ast_smoother_free</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>);
<a name="l03836"></a>03836       rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a> = NULL;
<a name="l03837"></a>03837    }
<a name="l03838"></a>03838 
<a name="l03839"></a>03839    <span class="keywordflow">if</span> (!rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>) {
<a name="l03840"></a>03840       <span class="keyword">struct </span><a class="code" href="structast__format__list.html" title="Definition of supported media formats (codecs).">ast_format_list</a> fmt = <a class="code" href="frame_8h.html#ac9789499b866949ab31bab025b497964" title="Get packet size for codec.">ast_codec_pref_getsize</a>(&amp;rtp-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a>, subclass);
<a name="l03841"></a>03841 
<a name="l03842"></a>03842       <span class="keywordflow">switch</span> (subclass) {
<a name="l03843"></a>03843       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a1a05dee116bf73c0f1ca8410bdb48c62">AST_FORMAT_SPEEX</a>:
<a name="l03844"></a>03844       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#ad90b56ed6ada6e4f13224512668e20fb">AST_FORMAT_G723_1</a>:
<a name="l03845"></a>03845       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a13092663dddb1492d81571f9f0ae4506">AST_FORMAT_SIREN7</a>:
<a name="l03846"></a>03846       <span class="keywordflow">case</span> <a class="code" href="frame_8h.html#a590224283a5c1527fab938e4d02686cc">AST_FORMAT_SIREN14</a>:
<a name="l03847"></a>03847          <span class="comment">/* these are all frame-based codecs and cannot be safely run through</span>
<a name="l03848"></a>03848 <span class="comment">            a smoother */</span>
<a name="l03849"></a>03849          <span class="keywordflow">break</span>;
<a name="l03850"></a>03850       <span class="keywordflow">default</span>:
<a name="l03851"></a>03851          <span class="keywordflow">if</span> (fmt.<a class="code" href="structast__format__list.html#a05368e07b33c55c5588a16887e0d1937">inc_ms</a>) { <span class="comment">/* if codec parameters is set / avoid division by zero */</span>
<a name="l03852"></a>03852             <span class="keywordflow">if</span> (!(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a> = <a class="code" href="frame_8h.html#a6f1c795e5db00c9eb553e540dce7a503">ast_smoother_new</a>((fmt.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a> * fmt.<a class="code" href="structast__format__list.html#a9e1771ccc63dc75f22fb3ea58841fc9c">fr_len</a>) / fmt.<a class="code" href="structast__format__list.html#a05368e07b33c55c5588a16887e0d1937">inc_ms</a>))) {
<a name="l03853"></a>03853                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unable to create smoother: format: %d ms: %d len: %d\n&quot;</span>, subclass, fmt.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>, ((fmt.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a> * fmt.<a class="code" href="structast__format__list.html#a9e1771ccc63dc75f22fb3ea58841fc9c">fr_len</a>) / fmt.<a class="code" href="structast__format__list.html#a05368e07b33c55c5588a16887e0d1937">inc_ms</a>));
<a name="l03854"></a>03854                <span class="keywordflow">return</span> -1;
<a name="l03855"></a>03855             }
<a name="l03856"></a>03856             <span class="keywordflow">if</span> (fmt.<a class="code" href="structast__format__list.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>)
<a name="l03857"></a>03857                <a class="code" href="frame_8h.html#a2bf0a4739b534e4f317230763ec3afcb">ast_smoother_set_flags</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>, fmt.<a class="code" href="structast__format__list.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>);
<a name="l03858"></a>03858             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Created smoother: format: %d ms: %d len: %d\n&quot;</span>, subclass, fmt.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>, ((fmt.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a> * fmt.<a class="code" href="structast__format__list.html#a9e1771ccc63dc75f22fb3ea58841fc9c">fr_len</a>) / fmt.<a class="code" href="structast__format__list.html#a05368e07b33c55c5588a16887e0d1937">inc_ms</a>));
<a name="l03859"></a>03859          }
<a name="l03860"></a>03860       }
<a name="l03861"></a>03861    }
<a name="l03862"></a>03862    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>) {
<a name="l03863"></a>03863       <span class="keywordflow">if</span> (<a class="code" href="frame_8h.html#a3d6997c8a03e68d88c52f784c16c069f">ast_smoother_test_flag</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>, <a class="code" href="frame_8h.html#af2e180889cb2b85cd10823803b9eb005">AST_SMOOTHER_FLAG_BE</a>)) {
<a name="l03864"></a>03864          <a class="code" href="frame_8h.html#a3af01c93b369d5de7caccd2be0b97c4a">ast_smoother_feed_be</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>, _f);
<a name="l03865"></a>03865       } <span class="keywordflow">else</span> {
<a name="l03866"></a>03866          <a class="code" href="frame_8h.html#aab5808a118c74febd13f39746bcce96c">ast_smoother_feed</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>, _f);
<a name="l03867"></a>03867       }
<a name="l03868"></a>03868 
<a name="l03869"></a>03869       <span class="keywordflow">while</span> ((f = <a class="code" href="frame_8h.html#af8d6dcd265eaf403b1b1139770c885d8">ast_smoother_read</a>(rtp-&gt;<a class="code" href="structast__rtp.html#a34ee6625e0f7d45c4e35cd409cb42e21">smoother</a>)) &amp;&amp; (f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>)) {
<a name="l03870"></a>03870          <a class="code" href="rtp_8c.html#a8aca902dc9d1d2540319c23b3c4943e1" title="Write RTP packet with audio or video media frames into UDP packet.">ast_rtp_raw_write</a>(rtp, f, codec);
<a name="l03871"></a>03871       }
<a name="l03872"></a>03872    } <span class="keywordflow">else</span> {
<a name="l03873"></a>03873       <span class="comment">/* Don&apos;t buffer outgoing frames; send them one-per-packet: */</span>
<a name="l03874"></a>03874       <span class="keywordflow">if</span> (_f-&gt;<a class="code" href="structast__frame.html#aed7ea92f45bd273dde380a45ddced592">offset</a> &lt; hdrlen) 
<a name="l03875"></a>03875          f = <a class="code" href="frame_8h.html#a4b23720d208128250a765490b1a4f145" title="Copies a frame.">ast_frdup</a>(_f);   <span class="comment">/*! \bug XXX this might never be free&apos;d. Why do we do this? */</span>
<a name="l03876"></a>03876       <span class="keywordflow">else</span>
<a name="l03877"></a>03877          f = _f;
<a name="l03878"></a>03878       <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>)
<a name="l03879"></a>03879          <a class="code" href="rtp_8c.html#a8aca902dc9d1d2540319c23b3c4943e1" title="Write RTP packet with audio or video media frames into UDP packet.">ast_rtp_raw_write</a>(rtp, f, codec);
<a name="l03880"></a>03880       <span class="keywordflow">if</span> (f != _f)
<a name="l03881"></a>03881          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(f);
<a name="l03882"></a>03882    }
<a name="l03883"></a>03883       
<a name="l03884"></a>03884    <span class="keywordflow">return</span> 0;
<a name="l03885"></a>03885 }
<a name="l03886"></a>03886 <span class="comment"></span>
<a name="l03887"></a>03887 <span class="comment">/*! \brief Unregister interface to channel driver */</span>
<a name="l03888"></a><a class="code" href="rtp_8c.html#a39d797fe6097e914323998f72b13420c">03888</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a39d797fe6097e914323998f72b13420c" title="Unregister an RTP channel client.">ast_rtp_proto_unregister</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *proto)
<a name="l03889"></a>03889 {
<a name="l03890"></a>03890    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l03891"></a>03891    <a class="code" href="linkedlists_8h.html#a6091f0518f8b6f443fd9f5150f3ac407">AST_RWLIST_REMOVE</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>, proto, list);
<a name="l03892"></a>03892    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l03893"></a>03893 }
<a name="l03894"></a>03894 <span class="comment"></span>
<a name="l03895"></a>03895 <span class="comment">/*! \brief Register interface to channel driver */</span>
<a name="l03896"></a><a class="code" href="rtp_8c.html#a00b94396faf3f52b0c3ea612a9af334d">03896</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a00b94396faf3f52b0c3ea612a9af334d" title="Register an RTP channel client.">ast_rtp_proto_register</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *proto)
<a name="l03897"></a>03897 {
<a name="l03898"></a>03898    <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *cur;
<a name="l03899"></a>03899 
<a name="l03900"></a>03900    <a class="code" href="linkedlists_8h.html#a2d0cf4182bade9f773fb16ff12abe595" title="Write locks a list.">AST_RWLIST_WRLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l03901"></a>03901    <a class="code" href="linkedlists_8h.html#a944b82566722f2247aa35f1328402c98">AST_RWLIST_TRAVERSE</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>, cur, <a class="code" href="structast__rtp__protocol.html#a469dabffbf9f8b4a86b7360069260aef">list</a>) { 
<a name="l03902"></a>03902       <span class="keywordflow">if</span> (!strcmp(cur-&gt;<a class="code" href="structast__rtp__protocol.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>, proto-&gt;<a class="code" href="structast__rtp__protocol.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>)) {
<a name="l03903"></a>03903          <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Tried to register same protocol &apos;%s&apos; twice\n&quot;</span>, cur-&gt;<a class="code" href="structast__rtp__protocol.html#a8ff938fb2f815be425fd2859a21e6d61">type</a>);
<a name="l03904"></a>03904          <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l03905"></a>03905          <span class="keywordflow">return</span> -1;
<a name="l03906"></a>03906       }
<a name="l03907"></a>03907    }
<a name="l03908"></a>03908    <a class="code" href="linkedlists_8h.html#aacc5f6b7c25e361d11d40137fd55a8e8">AST_RWLIST_INSERT_HEAD</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>, proto, <a class="code" href="structast__rtp__protocol.html#a469dabffbf9f8b4a86b7360069260aef">list</a>);
<a name="l03909"></a>03909    <a class="code" href="linkedlists_8h.html#a2e9a2518b5029b96671aff6701bd5138" title="Attempts to unlock a read/write based list.">AST_RWLIST_UNLOCK</a>(&amp;<a class="code" href="structprotos.html" title="List of current sessions.">protos</a>);
<a name="l03910"></a>03910    
<a name="l03911"></a>03911    <span class="keywordflow">return</span> 0;
<a name="l03912"></a>03912 }
<a name="l03913"></a>03913 <span class="comment"></span>
<a name="l03914"></a>03914 <span class="comment">/*! \brief Bridge loop for true native bridge (reinvite) */</span>
<a name="l03915"></a><a class="code" href="rtp_8c.html#a2e5b6817e5bb2de05f716709b7d177c6">03915</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> <a class="code" href="rtp_8c.html#a2e5b6817e5bb2de05f716709b7d177c6" title="Bridge loop for true native bridge (reinvite).">bridge_native_loop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c1, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *p0, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *p1, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *vp0, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *vp1, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tp0, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tp1, <span class="keyword">struct</span> <a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *pr0, <span class="keyword">struct</span> <a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *pr1, <span class="keywordtype">int</span> codec0, <span class="keywordtype">int</span> codec1, <span class="keywordtype">int</span> timeoutms, <span class="keywordtype">int</span> flags, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> **fo, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **rc, <span class="keywordtype">void</span> *pvt0, <span class="keywordtype">void</span> *pvt1)
<a name="l03916"></a>03916 {
<a name="l03917"></a>03917    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr = NULL;
<a name="l03918"></a>03918    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *who = NULL, *other = NULL, *cs[3] = {NULL, };
<a name="l03919"></a>03919    <span class="keywordtype">int</span> oldcodec0 = codec0, oldcodec1 = codec1;
<a name="l03920"></a>03920    <span class="keyword">struct </span>sockaddr_in ac1 = {0,}, vac1 = {0,}, tac1 = {0,}, ac0 = {0,}, vac0 = {0,}, tac0 = {0,};
<a name="l03921"></a>03921    <span class="keyword">struct </span>sockaddr_in t1 = {0,}, vt1 = {0,}, tt1 = {0,}, t0 = {0,}, vt0 = {0,}, tt0 = {0,};
<a name="l03922"></a>03922    
<a name="l03923"></a>03923    <span class="comment">/* Set it up so audio goes directly between the two endpoints */</span>
<a name="l03924"></a>03924 
<a name="l03925"></a>03925    <span class="comment">/* Test the first channel */</span>
<a name="l03926"></a>03926    <span class="keywordflow">if</span> (!(pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, p1, vp1, tp1, codec1, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>)))) {
<a name="l03927"></a>03927       <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(p1, &amp;ac1);
<a name="l03928"></a>03928       <span class="keywordflow">if</span> (vp1)
<a name="l03929"></a>03929          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(vp1, &amp;vac1);
<a name="l03930"></a>03930       <span class="keywordflow">if</span> (tp1)
<a name="l03931"></a>03931          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(tp1, &amp;tac1);
<a name="l03932"></a>03932    } <span class="keywordflow">else</span>
<a name="l03933"></a>03933       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to talk to &apos;%s&apos;\n&quot;</span>, c0-&gt;name, c1-&gt;name);
<a name="l03934"></a>03934    
<a name="l03935"></a>03935    <span class="comment">/* Test the second channel */</span>
<a name="l03936"></a>03936    <span class="keywordflow">if</span> (!(pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, p0, vp0, tp0, codec0, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>)))) {
<a name="l03937"></a>03937       <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(p0, &amp;ac0);
<a name="l03938"></a>03938       <span class="keywordflow">if</span> (vp0)
<a name="l03939"></a>03939          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(vp0, &amp;vac0);
<a name="l03940"></a>03940       <span class="keywordflow">if</span> (tp0)
<a name="l03941"></a>03941          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(tp0, &amp;tac0);
<a name="l03942"></a>03942    } <span class="keywordflow">else</span>
<a name="l03943"></a>03943       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to talk to &apos;%s&apos;\n&quot;</span>, c1-&gt;name, c0-&gt;name);
<a name="l03944"></a>03944 
<a name="l03945"></a>03945    <span class="comment">/* Now we can unlock and move into our loop */</span>
<a name="l03946"></a>03946    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l03947"></a>03947    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l03948"></a>03948 
<a name="l03949"></a>03949    <a class="code" href="channel_8h.html#a1b3f92e2239cd9e9bc20c783e1dedc80">ast_poll_channel_add</a>(c0, c1);
<a name="l03950"></a>03950 
<a name="l03951"></a>03951    <span class="comment">/* Throw our channels into the structure and enter the loop */</span>
<a name="l03952"></a>03952    cs[0] = c0;
<a name="l03953"></a>03953    cs[1] = c1;
<a name="l03954"></a>03954    cs[2] = NULL;
<a name="l03955"></a>03955    <span class="keywordflow">for</span> (;;) {
<a name="l03956"></a>03956       <span class="comment">/* Check if anything changed */</span>
<a name="l03957"></a>03957       <span class="keywordflow">if</span> ((c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> != pvt0) ||
<a name="l03958"></a>03958           (c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> != pvt1) ||
<a name="l03959"></a>03959           (c0-&gt;<a class="code" href="structast__channel.html#ae38ae730b987d648a6fe1c84c8a13442">masq</a> || c0-&gt;<a class="code" href="structast__channel.html#abb53278bc00235a5ff76fc8badbe6363">masqr</a> || c1-&gt;<a class="code" href="structast__channel.html#ae38ae730b987d648a6fe1c84c8a13442">masq</a> || c1-&gt;<a class="code" href="structast__channel.html#abb53278bc00235a5ff76fc8badbe6363">masqr</a>) ||
<a name="l03960"></a>03960           (c0-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a> || c0-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> || c1-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a> || c1-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>)) {
<a name="l03961"></a>03961          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Oooh, something is weird, backing out\n&quot;</span>);
<a name="l03962"></a>03962          <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> == pvt0)
<a name="l03963"></a>03963             <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, NULL, NULL, NULL, 0, 0))
<a name="l03964"></a>03964                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c0-&gt;name);
<a name="l03965"></a>03965          <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> == pvt1)
<a name="l03966"></a>03966             <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, NULL, NULL, NULL, 0, 0))
<a name="l03967"></a>03967                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c1-&gt;name);
<a name="l03968"></a>03968          <a class="code" href="channel_8h.html#a6b2da1bbe090143571ba1db7f94055a0">ast_poll_channel_del</a>(c0, c1);
<a name="l03969"></a>03969          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ac83c1441a620f7bdae5ef84692f8e7a5">AST_BRIDGE_RETRY</a>;
<a name="l03970"></a>03970       }
<a name="l03971"></a>03971 
<a name="l03972"></a>03972       <span class="comment">/* Check if they have changed their address */</span>
<a name="l03973"></a>03973       <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(p1, &amp;t1);
<a name="l03974"></a>03974       <span class="keywordflow">if</span> (vp1)
<a name="l03975"></a>03975          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(vp1, &amp;vt1);
<a name="l03976"></a>03976       <span class="keywordflow">if</span> (tp1)
<a name="l03977"></a>03977          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(tp1, &amp;tt1);
<a name="l03978"></a>03978       <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>)
<a name="l03979"></a>03979          codec1 = pr1-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(c1);
<a name="l03980"></a>03980       <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(p0, &amp;t0);
<a name="l03981"></a>03981       <span class="keywordflow">if</span> (vp0)
<a name="l03982"></a>03982          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(vp0, &amp;vt0);
<a name="l03983"></a>03983       <span class="keywordflow">if</span> (tp0)
<a name="l03984"></a>03984          <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(tp0, &amp;tt0);
<a name="l03985"></a>03985       <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>)
<a name="l03986"></a>03986          codec0 = pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(c0);
<a name="l03987"></a>03987       <span class="keywordflow">if</span> ((<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;t1, &amp;ac1)) ||
<a name="l03988"></a>03988           (vp1 &amp;&amp; <a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;vt1, &amp;vac1)) ||
<a name="l03989"></a>03989           (tp1 &amp;&amp; <a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;tt1, &amp;tac1)) ||
<a name="l03990"></a>03990           (codec1 != oldcodec1)) {
<a name="l03991"></a>03991          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; changed end address to %s:%d (format %d)\n&quot;</span>,
<a name="l03992"></a>03992             c1-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(t1.sin_addr), ntohs(t1.sin_port), codec1);
<a name="l03993"></a>03993          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; changed end vaddress to %s:%d (format %d)\n&quot;</span>,
<a name="l03994"></a>03994             c1-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(vt1.sin_addr), ntohs(vt1.sin_port), codec1);
<a name="l03995"></a>03995          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; changed end taddress to %s:%d (format %d)\n&quot;</span>,
<a name="l03996"></a>03996             c1-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tt1.sin_addr), ntohs(tt1.sin_port), codec1);
<a name="l03997"></a>03997          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; was %s:%d/(format %d)\n&quot;</span>,
<a name="l03998"></a>03998             c1-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(ac1.sin_addr), ntohs(ac1.sin_port), oldcodec1);
<a name="l03999"></a>03999          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; was %s:%d/(format %d)\n&quot;</span>,
<a name="l04000"></a>04000             c1-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(vac1.sin_addr), ntohs(vac1.sin_port), oldcodec1);
<a name="l04001"></a>04001          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; was %s:%d/(format %d)\n&quot;</span>,
<a name="l04002"></a>04002             c1-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(tac1.sin_addr), ntohs(tac1.sin_port), oldcodec1);
<a name="l04003"></a>04003          <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, t1.sin_addr.s_addr ? p1 : NULL, vt1.sin_addr.s_addr ? vp1 : NULL, tt1.sin_addr.s_addr ? tp1 : NULL, codec1, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>)))
<a name="l04004"></a>04004             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to update to &apos;%s&apos;\n&quot;</span>, c0-&gt;name, c1-&gt;name);
<a name="l04005"></a>04005          memcpy(&amp;ac1, &amp;t1, <span class="keyword">sizeof</span>(ac1));
<a name="l04006"></a>04006          memcpy(&amp;vac1, &amp;vt1, <span class="keyword">sizeof</span>(vac1));
<a name="l04007"></a>04007          memcpy(&amp;tac1, &amp;tt1, <span class="keyword">sizeof</span>(tac1));
<a name="l04008"></a>04008          oldcodec1 = codec1;
<a name="l04009"></a>04009       }
<a name="l04010"></a>04010       <span class="keywordflow">if</span> ((<a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;t0, &amp;ac0)) ||
<a name="l04011"></a>04011           (vp0 &amp;&amp; <a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;vt0, &amp;vac0)) ||
<a name="l04012"></a>04012           (tp0 &amp;&amp; <a class="code" href="network_8h.html#a645471815fc2fff930c75b0494197b3d" title="Compares the source address and port of two sockaddr_in.">inaddrcmp</a>(&amp;tt0, &amp;tac0)) ||
<a name="l04013"></a>04013           (codec0 != oldcodec0)) {
<a name="l04014"></a>04014          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; changed end address to %s:%d (format %d)\n&quot;</span>,
<a name="l04015"></a>04015             c0-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(t0.sin_addr), ntohs(t0.sin_port), codec0);
<a name="l04016"></a>04016          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(2, <span class="stringliteral">&quot;Oooh, &apos;%s&apos; was %s:%d/(format %d)\n&quot;</span>,
<a name="l04017"></a>04017             c0-&gt;name, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(ac0.sin_addr), ntohs(ac0.sin_port), oldcodec0);
<a name="l04018"></a>04018          <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, t0.sin_addr.s_addr ? p0 : NULL, vt0.sin_addr.s_addr ? vp0 : NULL, tt0.sin_addr.s_addr ? tp0 : NULL, codec0, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>)))
<a name="l04019"></a>04019             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to update to &apos;%s&apos;\n&quot;</span>, c1-&gt;name, c0-&gt;name);
<a name="l04020"></a>04020          memcpy(&amp;ac0, &amp;t0, <span class="keyword">sizeof</span>(ac0));
<a name="l04021"></a>04021          memcpy(&amp;vac0, &amp;vt0, <span class="keyword">sizeof</span>(vac0));
<a name="l04022"></a>04022          memcpy(&amp;tac0, &amp;tt0, <span class="keyword">sizeof</span>(tac0));
<a name="l04023"></a>04023          oldcodec0 = codec0;
<a name="l04024"></a>04024       }
<a name="l04025"></a>04025 
<a name="l04026"></a>04026       <span class="comment">/* Wait for frame to come in on the channels */</span>
<a name="l04027"></a>04027       <span class="keywordflow">if</span> (!(who = <a class="code" href="channel_8h.html#aec8ce59b78afbd3651f3de011f13290a" title="Waits for input on a group of channels Wait for input on an array of channels for...">ast_waitfor_n</a>(cs, 2, &amp;timeoutms))) {
<a name="l04028"></a>04028          <span class="keywordflow">if</span> (!timeoutms) {
<a name="l04029"></a>04029             <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, NULL, NULL, NULL, 0, 0))
<a name="l04030"></a>04030                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c0-&gt;name);
<a name="l04031"></a>04031             <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, NULL, NULL, NULL, 0, 0))
<a name="l04032"></a>04032                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c1-&gt;name);
<a name="l04033"></a>04033             <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ac83c1441a620f7bdae5ef84692f8e7a5">AST_BRIDGE_RETRY</a>;
<a name="l04034"></a>04034          }
<a name="l04035"></a>04035          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Ooh, empty read...\n&quot;</span>);
<a name="l04036"></a>04036          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c0) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c1))
<a name="l04037"></a>04037             <span class="keywordflow">break</span>;
<a name="l04038"></a>04038          <span class="keywordflow">continue</span>;
<a name="l04039"></a>04039       }
<a name="l04040"></a>04040       fr = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(who);
<a name="l04041"></a>04041       other = (who == c0) ? c1 : c0;
<a name="l04042"></a>04042       <span class="keywordflow">if</span> (!fr || ((fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a> || fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>) &amp;&amp;
<a name="l04043"></a>04043              (((who == c0) &amp;&amp; (flags &amp; <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a>)) ||
<a name="l04044"></a>04044               ((who == c1) &amp;&amp; (flags &amp; <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>))))) {
<a name="l04045"></a>04045          <span class="comment">/* Break out of bridge */</span>
<a name="l04046"></a>04046          *fo = fr;
<a name="l04047"></a>04047          *rc = who;
<a name="l04048"></a>04048          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Oooh, got a %s\n&quot;</span>, fr ? <span class="stringliteral">&quot;digit&quot;</span> : <span class="stringliteral">&quot;hangup&quot;</span>);
<a name="l04049"></a>04049          <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> == pvt0)
<a name="l04050"></a>04050             <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, NULL, NULL, NULL, 0, 0))
<a name="l04051"></a>04051                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c0-&gt;name);
<a name="l04052"></a>04052          <span class="keywordflow">if</span> (c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> == pvt1)
<a name="l04053"></a>04053             <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, NULL, NULL, NULL, 0, 0))
<a name="l04054"></a>04054                <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c1-&gt;name);
<a name="l04055"></a>04055          <a class="code" href="channel_8h.html#a6b2da1bbe090143571ba1db7f94055a0">ast_poll_channel_del</a>(c0, c1);
<a name="l04056"></a>04056          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l04057"></a>04057       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) &amp;&amp; !(flags &amp; <a class="code" href="channel_8h.html#aed24107184d7fd2cfb1ad32cba4d6bfd" title="Ignore all signal frames except NULL.">AST_BRIDGE_IGNORE_SIGS</a>)) {
<a name="l04058"></a>04058          <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>) ||
<a name="l04059"></a>04059              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>) ||
<a name="l04060"></a>04060              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>) ||
<a name="l04061"></a>04061              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a009e81151b19671f42b5e84ab6a619f4">AST_CONTROL_SRCUPDATE</a>) ||
<a name="l04062"></a>04062              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a7334c9d27a6d70fe7c85b60b864788fc">AST_CONTROL_T38_PARAMETERS</a>)) {
<a name="l04063"></a>04063             <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>) {
<a name="l04064"></a>04064                <span class="comment">/* If we someone went on hold we want the other side to reinvite back to us */</span>
<a name="l04065"></a>04065                <span class="keywordflow">if</span> (who == c0)
<a name="l04066"></a>04066                   pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, NULL, NULL, NULL, 0, 0);
<a name="l04067"></a>04067                <span class="keywordflow">else</span>
<a name="l04068"></a>04068                   pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, NULL, NULL, NULL, 0, 0);
<a name="l04069"></a>04069             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>) {
<a name="l04070"></a>04070                <span class="comment">/* If they went off hold they should go back to being direct */</span>
<a name="l04071"></a>04071                <span class="keywordflow">if</span> (who == c0)
<a name="l04072"></a>04072                   pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, p0, vp0, tp0, codec0, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>));
<a name="l04073"></a>04073                <span class="keywordflow">else</span>
<a name="l04074"></a>04074                   pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, p1, vp1, tp1, codec1, <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>));
<a name="l04075"></a>04075             }
<a name="l04076"></a>04076             <span class="comment">/* Update local address information */</span>
<a name="l04077"></a>04077             <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(p0, &amp;t0);
<a name="l04078"></a>04078             memcpy(&amp;ac0, &amp;t0, <span class="keyword">sizeof</span>(ac0));
<a name="l04079"></a>04079             <a class="code" href="rtp_8h.html#aa1ffde0e800995c386729bc5eaf82e7c">ast_rtp_get_peer</a>(p1, &amp;t1);
<a name="l04080"></a>04080             memcpy(&amp;ac1, &amp;t1, <span class="keyword">sizeof</span>(ac1));
<a name="l04081"></a>04081             <span class="comment">/* Update codec information */</span>
<a name="l04082"></a>04082             <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a> &amp;&amp; c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>)
<a name="l04083"></a>04083                oldcodec0 = codec0 = pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(c0);
<a name="l04084"></a>04084             <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a> &amp;&amp; c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>)
<a name="l04085"></a>04085                oldcodec1 = codec1 = pr1-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(c1);
<a name="l04086"></a>04086             <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(other, fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, fr-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, fr-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l04087"></a>04087             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l04088"></a>04088          } <span class="keywordflow">else</span> {
<a name="l04089"></a>04089             *fo = fr;
<a name="l04090"></a>04090             *rc = who;
<a name="l04091"></a>04091             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Got a FRAME_CONTROL (%d) frame on channel %s\n&quot;</span>, fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, who-&gt;name);
<a name="l04092"></a>04092             <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l04093"></a>04093          }
<a name="l04094"></a>04094       } <span class="keywordflow">else</span> {
<a name="l04095"></a>04095          <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>) ||
<a name="l04096"></a>04096              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>) ||
<a name="l04097"></a>04097              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) ||
<a name="l04098"></a>04098              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) ||
<a name="l04099"></a>04099              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a>) ||
<a name="l04100"></a>04100              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a3d91bab33583f560197e21532a02a895">AST_FRAME_HTML</a>) ||
<a name="l04101"></a>04101              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ad99b86353343f422bda01163898b2eea">AST_FRAME_MODEM</a>) ||
<a name="l04102"></a>04102              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>)) {
<a name="l04103"></a>04103             <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(other, fr);
<a name="l04104"></a>04104          }
<a name="l04105"></a>04105          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l04106"></a>04106       }
<a name="l04107"></a>04107       <span class="comment">/* Swap priority */</span>
<a name="l04108"></a>04108 <span class="preprocessor">#ifndef HAVE_EPOLL</span>
<a name="l04109"></a>04109 <span class="preprocessor"></span>      cs[2] = cs[0];
<a name="l04110"></a>04110       cs[0] = cs[1];
<a name="l04111"></a>04111       cs[1] = cs[2];
<a name="l04112"></a>04112 <span class="preprocessor">#endif</span>
<a name="l04113"></a>04113 <span class="preprocessor"></span>   }
<a name="l04114"></a>04114 
<a name="l04115"></a>04115    <a class="code" href="channel_8h.html#a6b2da1bbe090143571ba1db7f94055a0">ast_poll_channel_del</a>(c0, c1);
<a name="l04116"></a>04116 
<a name="l04117"></a>04117    <span class="keywordflow">if</span> (pr0-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c0, NULL, NULL, NULL, 0, 0))
<a name="l04118"></a>04118       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c0-&gt;name);
<a name="l04119"></a>04119    <span class="keywordflow">if</span> (pr1-&gt;<a class="code" href="structast__rtp__protocol.html#a321bf6332b1fa0f6c9d85abc03c1f3df">set_rtp_peer</a>(c1, NULL, NULL, NULL, 0, 0))
<a name="l04120"></a>04120       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Channel &apos;%s&apos; failed to break RTP bridge\n&quot;</span>, c1-&gt;name);
<a name="l04121"></a>04121 
<a name="l04122"></a>04122    <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l04123"></a>04123 }
<a name="l04124"></a>04124 <span class="comment"></span>
<a name="l04125"></a>04125 <span class="comment">/*! \brief P2P RTP Callback */</span>
<a name="l04126"></a>04126 <span class="preprocessor">#ifdef P2P_INTENSE</span>
<a name="l04127"></a>04127 <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> p2p_rtp_callback(<span class="keywordtype">int</span> *<span class="keywordtype">id</span>, <span class="keywordtype">int</span> fd, <span class="keywordtype">short</span> <a class="code" href="app__adsiprog_8c.html#a31547b3fbfe860fc4518ce2332297f9b">events</a>, <span class="keywordtype">void</span> *cbdata)
<a name="l04128"></a>04128 {
<a name="l04129"></a>04129    <span class="keywordtype">int</span> res = 0, hdrlen = 12;
<a name="l04130"></a>04130    <span class="keyword">struct </span>sockaddr_in sin;
<a name="l04131"></a>04131    socklen_t <a class="code" href="func__strings_8c.html#af24e73aaf92f3000fda15d285e66df24">len</a>;
<a name="l04132"></a>04132    <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *header;
<a name="l04133"></a>04133    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = cbdata, *<a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">bridged</a> = NULL;
<a name="l04134"></a>04134 
<a name="l04135"></a>04135    <span class="keywordflow">if</span> (!rtp)
<a name="l04136"></a>04136       <span class="keywordflow">return</span> 1;
<a name="l04137"></a>04137 
<a name="l04138"></a>04138    len = <span class="keyword">sizeof</span>(sin);
<a name="l04139"></a>04139    <span class="keywordflow">if</span> ((res = recvfrom(fd, rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>, <span class="keyword">sizeof</span>(rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a>) - <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>, 0, (<span class="keyword">struct</span> sockaddr *)&amp;sin, &amp;len)) &lt; 0)
<a name="l04140"></a>04140       <span class="keywordflow">return</span> 1;
<a name="l04141"></a>04141 
<a name="l04142"></a>04142    header = (<span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> *)(rtp-&gt;<a class="code" href="structast__rtp.html#a8af53bd0e8b4f1e9275d51d2a4065991">rawdata</a> + <a class="code" href="frame_8h.html#ac8f7380b8620c80443286b44481f641c" title="Offset into a frame&amp;#39;s data buffer.">AST_FRIENDLY_OFFSET</a>);
<a name="l04143"></a>04143    
<a name="l04144"></a>04144    <span class="comment">/* If NAT support is turned on, then see if we need to change their address */</span>
<a name="l04145"></a>04145    <span class="keywordflow">if</span> ((rtp-&gt;<a class="code" href="structast__rtp.html#ada540a5f25f7302dc1a3d17ccfa59b10">nat</a>) &amp;&amp; 
<a name="l04146"></a>04146        ((rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr.s_addr != sin.sin_addr.s_addr) ||
<a name="l04147"></a>04147         (rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port != sin.sin_port))) {
<a name="l04148"></a>04148       rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a> = sin;
<a name="l04149"></a>04149       rtp-&gt;<a class="code" href="structast__rtp.html#a5406ab4bd6c88a7b08f103e810dfff9e">rxseqno</a> = 0;
<a name="l04150"></a>04150       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(rtp, <a class="code" href="rtp_8c.html#ab67e21f67a96dd6a9e1b0450ecddecf3">FLAG_NAT_ACTIVE</a>);
<a name="l04151"></a>04151       <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> || rtpdebug)
<a name="l04152"></a>04152          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(0, <span class="stringliteral">&quot;P2P RTP NAT: Got audio from other end. Now sending to address %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_addr), ntohs(rtp-&gt;<a class="code" href="structast__rtp.html#aaf2178b155c6b17c2da143fb7e12eb78">them</a>.sin_port));
<a name="l04153"></a>04153    }
<a name="l04154"></a>04154 
<a name="l04155"></a>04155    <span class="comment">/* Write directly out to other RTP stream if bridged */</span>
<a name="l04156"></a>04156    <span class="keywordflow">if</span> ((bridged = <a class="code" href="rtp_8h.html#af7dc32ebdfacbbf446321de6fcfe2d9a">ast_rtp_get_bridged</a>(rtp)))
<a name="l04157"></a>04157       <a class="code" href="rtp_8c.html#a5c67ce326f00a810520a5c0bc4500df6" title="Perform a Packet2Packet RTP write.">bridge_p2p_rtp_write</a>(rtp, bridged, header, res, hdrlen);
<a name="l04158"></a>04158    
<a name="l04159"></a>04159    <span class="keywordflow">return</span> 1;
<a name="l04160"></a>04160 }
<a name="l04161"></a>04161 <span class="comment"></span>
<a name="l04162"></a>04162 <span class="comment">/*! \brief Helper function to switch a channel and RTP stream into callback mode */</span>
<a name="l04163"></a>04163 <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6" title="P2P RTP Callback.">p2p_callback_enable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *<a class="code" href="adsistub_8c.html#a322af389d034b8f1282da0a853ffb921">chan</a>, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> **iod)
<a name="l04164"></a>04164 {
<a name="l04165"></a>04165    <span class="comment">/* If we need DTMF, are looking for STUN, or we have no IO structure then we can&apos;t do direct callback */</span>
<a name="l04166"></a>04166    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>) || <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#a126661ec52d7d5caab56e2fbfd511d65">FLAG_HAS_STUN</a>) || !rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>)
<a name="l04167"></a>04167       <span class="keywordflow">return</span> 0;
<a name="l04168"></a>04168 
<a name="l04169"></a>04169    <span class="comment">/* If the RTP structure is already in callback mode, remove it temporarily */</span>
<a name="l04170"></a>04170    <span class="keywordflow">if</span> (rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a>) {
<a name="l04171"></a>04171       <a class="code" href="io_8h.html#afbf1092b96128d07d0dd08dfa898f4d5" title="Removes an IO context.">ast_io_remove</a>(rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a>);
<a name="l04172"></a>04172       rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a> = NULL;
<a name="l04173"></a>04173    }
<a name="l04174"></a>04174 
<a name="l04175"></a>04175    <span class="comment">/* Steal the file descriptors from the channel */</span>
<a name="l04176"></a>04176    chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0] = -1;
<a name="l04177"></a>04177 
<a name="l04178"></a>04178    <span class="comment">/* Now, fire up callback mode */</span>
<a name="l04179"></a>04179    iod[0] = <a class="code" href="io_8h.html#aa250c3f6541dc5734deb966d6821da7a" title="Adds an IO context.">ast_io_add</a>(rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, <a class="code" href="rtp_8h.html#a9a990d85fb0aac29bda48777f0f86108">ast_rtp_fd</a>(rtp), p2p_rtp_callback, <a class="code" href="io_8h.html#a0d9e01f215782a343a1b71b5be362080">AST_IO_IN</a>, rtp);
<a name="l04180"></a>04180 
<a name="l04181"></a>04181    <span class="keywordflow">return</span> 1;
<a name="l04182"></a>04182 }
<a name="l04183"></a>04183 <span class="preprocessor">#else</span>
<a name="l04184"></a><a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6">04184</a> <span class="preprocessor"></span><span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6" title="P2P RTP Callback.">p2p_callback_enable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> **iod)
<a name="l04185"></a>04185 {
<a name="l04186"></a>04186    <span class="keywordflow">return</span> 0;
<a name="l04187"></a>04187 }
<a name="l04188"></a>04188 <span class="preprocessor">#endif</span>
<a name="l04189"></a>04189 <span class="preprocessor"></span><span class="comment"></span>
<a name="l04190"></a>04190 <span class="comment">/*! \brief Helper function to switch a channel and RTP stream out of callback mode */</span>
<a name="l04191"></a><a class="code" href="rtp_8c.html#a8265c4eae4df1ec9d19e4fe76e756b24">04191</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a8265c4eae4df1ec9d19e4fe76e756b24" title="Helper function to switch a channel and RTP stream out of callback mode.">p2p_callback_disable</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *chan, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> **iod)
<a name="l04192"></a>04192 {
<a name="l04193"></a>04193    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(chan);
<a name="l04194"></a>04194 
<a name="l04195"></a>04195    <span class="comment">/* Remove the callback from the IO context */</span>
<a name="l04196"></a>04196    <a class="code" href="io_8h.html#afbf1092b96128d07d0dd08dfa898f4d5" title="Removes an IO context.">ast_io_remove</a>(rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, iod[0]);
<a name="l04197"></a>04197 
<a name="l04198"></a>04198    <span class="comment">/* Restore file descriptors */</span>
<a name="l04199"></a>04199    chan-&gt;<a class="code" href="structast__channel.html#aef68cd3879b791a3b6c12cdb750f8e6a">fds</a>[0] = <a class="code" href="rtp_8h.html#a9a990d85fb0aac29bda48777f0f86108">ast_rtp_fd</a>(rtp);
<a name="l04200"></a>04200    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(chan);
<a name="l04201"></a>04201 
<a name="l04202"></a>04202    <span class="comment">/* Restore callback mode if previously used */</span>
<a name="l04203"></a>04203    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(rtp, <a class="code" href="rtp_8c.html#ae8197382d4f12048520dcba52cd1461c">FLAG_CALLBACK_MODE</a>))
<a name="l04204"></a>04204       rtp-&gt;<a class="code" href="structast__rtp.html#a378e4ecae74acafadf99a691f65f2419">ioid</a> = <a class="code" href="io_8h.html#aa250c3f6541dc5734deb966d6821da7a" title="Adds an IO context.">ast_io_add</a>(rtp-&gt;<a class="code" href="structast__rtp.html#abda48311b6abe5a4dd8b6904ddde0a6d">io</a>, <a class="code" href="rtp_8h.html#a9a990d85fb0aac29bda48777f0f86108">ast_rtp_fd</a>(rtp), <a class="code" href="rtp_8c.html#acc27c454a55b589c7a228a8d78542db3">rtpread</a>, <a class="code" href="io_8h.html#a0d9e01f215782a343a1b71b5be362080">AST_IO_IN</a>, rtp);
<a name="l04205"></a>04205 
<a name="l04206"></a>04206    <span class="keywordflow">return</span> 0;
<a name="l04207"></a>04207 }
<a name="l04208"></a>04208 <span class="comment"></span>
<a name="l04209"></a>04209 <span class="comment">/*! \brief Helper function that sets what an RTP structure is bridged to */</span>
<a name="l04210"></a><a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a">04210</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp0, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp1)
<a name="l04211"></a>04211 {
<a name="l04212"></a>04212    <a class="code" href="rtp_8c.html#a67f38276600b7655f400f5b6c6118f8b">rtp_bridge_lock</a>(rtp0);
<a name="l04213"></a>04213    rtp0-&gt;<a class="code" href="structast__rtp.html#a22611fd046dd9e42a34b4a6e3ace0069">bridged</a> = rtp1;
<a name="l04214"></a>04214    <a class="code" href="rtp_8c.html#afabb78b03298d9f7b7e26b60ad0d02e4">rtp_bridge_unlock</a>(rtp0);
<a name="l04215"></a>04215 }
<a name="l04216"></a>04216 <span class="comment"></span>
<a name="l04217"></a>04217 <span class="comment">/*! \brief Bridge loop for partial native bridge (packet2packet) </span>
<a name="l04218"></a>04218 <span class="comment"></span>
<a name="l04219"></a>04219 <span class="comment">   In p2p mode, Asterisk is a very basic RTP proxy, just forwarding whatever</span>
<a name="l04220"></a>04220 <span class="comment">   rtp/rtcp we get in to the channel. </span>
<a name="l04221"></a>04221 <span class="comment">   \note this currently only works for Audio</span>
<a name="l04222"></a>04222 <span class="comment">*/</span>
<a name="l04223"></a><a class="code" href="rtp_8c.html#ab1f0de9367de02dc9983e85eab3f8b88">04223</a> <span class="keyword">static</span> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> <a class="code" href="rtp_8c.html#ab1f0de9367de02dc9983e85eab3f8b88" title="Bridge loop for partial native bridge (packet2packet).">bridge_p2p_loop</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c1, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *p0, <span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *p1, <span class="keywordtype">int</span> timeoutms, <span class="keywordtype">int</span> <a class="code" href="structast__rtp.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> **fo, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **rc, <span class="keywordtype">void</span> *pvt0, <span class="keywordtype">void</span> *pvt1)
<a name="l04224"></a>04224 {
<a name="l04225"></a>04225    <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *fr = NULL;
<a name="l04226"></a>04226    <span class="keyword">struct </span><a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *who = NULL, *other = NULL, *cs[3] = {NULL, };
<a name="l04227"></a>04227    <span class="keywordtype">int</span> *p0_iod[2] = {NULL, NULL}, *p1_iod[2] = {NULL, NULL};
<a name="l04228"></a>04228    <span class="keywordtype">int</span> p0_callback = 0, p1_callback = 0;
<a name="l04229"></a>04229    <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l04230"></a>04230 
<a name="l04231"></a>04231    <span class="comment">/* Okay, setup each RTP structure to do P2P forwarding */</span>
<a name="l04232"></a>04232    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(p0, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>);
<a name="l04233"></a>04233    <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p0, p1);
<a name="l04234"></a>04234    <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(p1, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>);
<a name="l04235"></a>04235    <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p1, p0);
<a name="l04236"></a>04236 
<a name="l04237"></a>04237    <span class="comment">/* Activate callback modes if possible */</span>
<a name="l04238"></a>04238    p0_callback = <a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6" title="P2P RTP Callback.">p2p_callback_enable</a>(c0, p0, &amp;p0_iod[0]);
<a name="l04239"></a>04239    p1_callback = <a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6" title="P2P RTP Callback.">p2p_callback_enable</a>(c1, p1, &amp;p1_iod[0]);
<a name="l04240"></a>04240 
<a name="l04241"></a>04241    <span class="comment">/* Now let go of the channel locks and be on our way */</span>
<a name="l04242"></a>04242    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04243"></a>04243    <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04244"></a>04244 
<a name="l04245"></a>04245    <a class="code" href="channel_8h.html#a1b3f92e2239cd9e9bc20c783e1dedc80">ast_poll_channel_add</a>(c0, c1);
<a name="l04246"></a>04246 
<a name="l04247"></a>04247    <span class="comment">/* Go into a loop forwarding frames until we don&apos;t need to anymore */</span>
<a name="l04248"></a>04248    cs[0] = c0;
<a name="l04249"></a>04249    cs[1] = c1;
<a name="l04250"></a>04250    cs[2] = NULL;
<a name="l04251"></a>04251    <span class="keywordflow">for</span> (;;) {
<a name="l04252"></a>04252       <span class="comment">/* If the underlying formats have changed force this bridge to break */</span>
<a name="l04253"></a>04253       <span class="keywordflow">if</span> ((c0-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> != c1-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a>) || (c1-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> != c0-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a>)) {
<a name="l04254"></a>04254          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;p2p-rtp-bridge: Oooh, formats changed, backing out\n&quot;</span>);
<a name="l04255"></a>04255          res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04256"></a>04256          <span class="keywordflow">break</span>;
<a name="l04257"></a>04257       }
<a name="l04258"></a>04258       <span class="comment">/* Check if anything changed */</span>
<a name="l04259"></a>04259       <span class="keywordflow">if</span> ((c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> != pvt0) ||
<a name="l04260"></a>04260           (c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a> != pvt1) ||
<a name="l04261"></a>04261           (c0-&gt;<a class="code" href="structast__channel.html#ae38ae730b987d648a6fe1c84c8a13442">masq</a> || c0-&gt;<a class="code" href="structast__channel.html#abb53278bc00235a5ff76fc8badbe6363">masqr</a> || c1-&gt;<a class="code" href="structast__channel.html#ae38ae730b987d648a6fe1c84c8a13442">masq</a> || c1-&gt;<a class="code" href="structast__channel.html#abb53278bc00235a5ff76fc8badbe6363">masqr</a>) ||
<a name="l04262"></a>04262           (c0-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a> || c0-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a> || c1-&gt;<a class="code" href="structast__channel.html#a4254cefdfaeb5200f89e7ba3ae6f0922">monitor</a> || c1-&gt;<a class="code" href="structast__channel.html#adb878b3a8ff24d396a59dda13418a301">audiohooks</a>)) {
<a name="l04263"></a>04263          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;p2p-rtp-bridge: Oooh, something is weird, backing out\n&quot;</span>);
<a name="l04264"></a>04264          <span class="comment">/* If a masquerade needs to happen we have to try to read in a frame so that it actually happens. Without this we risk being called again and going into a loop */</span>
<a name="l04265"></a>04265          <span class="keywordflow">if</span> ((c0-&gt;<a class="code" href="structast__channel.html#ae38ae730b987d648a6fe1c84c8a13442">masq</a> || c0-&gt;<a class="code" href="structast__channel.html#abb53278bc00235a5ff76fc8badbe6363">masqr</a>) &amp;&amp; (fr = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(c0)))
<a name="l04266"></a>04266             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l04267"></a>04267          <span class="keywordflow">if</span> ((c1-&gt;<a class="code" href="structast__channel.html#ae38ae730b987d648a6fe1c84c8a13442">masq</a> || c1-&gt;<a class="code" href="structast__channel.html#abb53278bc00235a5ff76fc8badbe6363">masqr</a>) &amp;&amp; (fr = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(c1)))
<a name="l04268"></a>04268             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l04269"></a>04269          res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ac83c1441a620f7bdae5ef84692f8e7a5">AST_BRIDGE_RETRY</a>;
<a name="l04270"></a>04270          <span class="keywordflow">break</span>;
<a name="l04271"></a>04271       }
<a name="l04272"></a>04272       <span class="comment">/* Wait on a channel to feed us a frame */</span>
<a name="l04273"></a>04273       <span class="keywordflow">if</span> (!(who = <a class="code" href="channel_8h.html#aec8ce59b78afbd3651f3de011f13290a" title="Waits for input on a group of channels Wait for input on an array of channels for...">ast_waitfor_n</a>(cs, 2, &amp;timeoutms))) {
<a name="l04274"></a>04274          <span class="keywordflow">if</span> (!timeoutms) {
<a name="l04275"></a>04275             res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ac83c1441a620f7bdae5ef84692f8e7a5">AST_BRIDGE_RETRY</a>;
<a name="l04276"></a>04276             <span class="keywordflow">break</span>;
<a name="l04277"></a>04277          }
<a name="l04278"></a>04278          <span class="keywordflow">if</span> (<a class="code" href="group__main__options.html#ga40f8fb2e731031d99f732f515cec680f">option_debug</a> &gt; 2)
<a name="l04279"></a>04279             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#ad89ee324d180cdcd7defcc709ff9ca42">LOG_NOTICE</a>, <span class="stringliteral">&quot;p2p-rtp-bridge: Ooh, empty read...\n&quot;</span>);
<a name="l04280"></a>04280          <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c0) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c1))
<a name="l04281"></a>04281             <span class="keywordflow">break</span>;
<a name="l04282"></a>04282          <span class="keywordflow">continue</span>;
<a name="l04283"></a>04283       }
<a name="l04284"></a>04284       <span class="comment">/* Read in frame from channel */</span>
<a name="l04285"></a>04285       fr = <a class="code" href="channel_8h.html#a7ef6737309dc9e8b6c4a7cb4800638b1" title="Reads a frame.">ast_read</a>(who);
<a name="l04286"></a>04286       other = (who == c0) ? c1 : c0;
<a name="l04287"></a>04287       <span class="comment">/* Depending on the frame we may need to break out of our bridge */</span>
<a name="l04288"></a>04288       <span class="keywordflow">if</span> (!fr || ((fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a> || fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>) &amp;&amp;
<a name="l04289"></a>04289              ((who == c0) &amp;&amp; (flags &amp; <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a>)) |
<a name="l04290"></a>04290              ((who == c1) &amp;&amp; (flags &amp; <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>)))) {
<a name="l04291"></a>04291          <span class="comment">/* Record received frame and who */</span>
<a name="l04292"></a>04292          *fo = fr;
<a name="l04293"></a>04293          *rc = who;
<a name="l04294"></a>04294          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;p2p-rtp-bridge: Ooh, got a %s\n&quot;</span>, fr ? <span class="stringliteral">&quot;digit&quot;</span> : <span class="stringliteral">&quot;hangup&quot;</span>);
<a name="l04295"></a>04295          res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l04296"></a>04296          <span class="keywordflow">break</span>;
<a name="l04297"></a>04297       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ae1dae388b0d70825876e137ae95bb0c1">AST_FRAME_CONTROL</a>) &amp;&amp; !(flags &amp; <a class="code" href="channel_8h.html#aed24107184d7fd2cfb1ad32cba4d6bfd" title="Ignore all signal frames except NULL.">AST_BRIDGE_IGNORE_SIGS</a>)) {
<a name="l04298"></a>04298          <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>) ||
<a name="l04299"></a>04299              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>) ||
<a name="l04300"></a>04300              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a417bc8ac5817cc1525a3b530abfc1528">AST_CONTROL_VIDUPDATE</a>) ||
<a name="l04301"></a>04301              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a009e81151b19671f42b5e84ab6a619f4">AST_CONTROL_SRCUPDATE</a>) ||
<a name="l04302"></a>04302              (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a7334c9d27a6d70fe7c85b60b864788fc">AST_CONTROL_T38_PARAMETERS</a>)) {
<a name="l04303"></a>04303             <span class="comment">/* If we are going on hold, then break callback mode and P2P bridging */</span>
<a name="l04304"></a>04304             <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390ab99a3d1c08c5ae8bca078c7cd1ec02f5">AST_CONTROL_HOLD</a>) {
<a name="l04305"></a>04305                <span class="keywordflow">if</span> (p0_callback)
<a name="l04306"></a>04306                   p0_callback = <a class="code" href="rtp_8c.html#a8265c4eae4df1ec9d19e4fe76e756b24" title="Helper function to switch a channel and RTP stream out of callback mode.">p2p_callback_disable</a>(c0, p0, &amp;p0_iod[0]);
<a name="l04307"></a>04307                <span class="keywordflow">if</span> (p1_callback)
<a name="l04308"></a>04308                   p1_callback = <a class="code" href="rtp_8c.html#a8265c4eae4df1ec9d19e4fe76e756b24" title="Helper function to switch a channel and RTP stream out of callback mode.">p2p_callback_disable</a>(c1, p1, &amp;p1_iod[0]);
<a name="l04309"></a>04309                <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p0, NULL);
<a name="l04310"></a>04310                <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p1, NULL);
<a name="l04311"></a>04311             } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> == <a class="code" href="frame_8h.html#aedda41918e992000fe921f8f7363b390a3e7629b5f7e39f1cc8ad2e51e266f91e">AST_CONTROL_UNHOLD</a>) {
<a name="l04312"></a>04312                <span class="comment">/* If we are off hold, then go back to callback mode and P2P bridging */</span>
<a name="l04313"></a>04313                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(p0, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>);
<a name="l04314"></a>04314                <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p0, p1);
<a name="l04315"></a>04315                <a class="code" href="utils_8h.html#a7b260320610a09017a9416398acd0a70">ast_clear_flag</a>(p1, <a class="code" href="rtp_8c.html#ad6cbb00f5252760c3114cd269ca05d3c">FLAG_P2P_SENT_MARK</a>);
<a name="l04316"></a>04316                <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p1, p0);
<a name="l04317"></a>04317                p0_callback = <a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6" title="P2P RTP Callback.">p2p_callback_enable</a>(c0, p0, &amp;p0_iod[0]);
<a name="l04318"></a>04318                p1_callback = <a class="code" href="rtp_8c.html#abae1f0f415764250dabf6df3dd6fb9a6" title="P2P RTP Callback.">p2p_callback_enable</a>(c1, p1, &amp;p1_iod[0]);
<a name="l04319"></a>04319             }
<a name="l04320"></a>04320             <a class="code" href="channel_8h.html#aa8c3522af1bc639cbd5b38f5fdf171fa" title="Indicates condition of channel, with payload.">ast_indicate_data</a>(other, fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, fr-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, fr-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l04321"></a>04321             <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l04322"></a>04322          } <span class="keywordflow">else</span> {
<a name="l04323"></a>04323             *fo = fr;
<a name="l04324"></a>04324             *rc = who;
<a name="l04325"></a>04325             <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;p2p-rtp-bridge: Got a FRAME_CONTROL (%d) frame on channel %s\n&quot;</span>, fr-&gt;<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a>, who-&gt;name);
<a name="l04326"></a>04326             res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05ada47e397237355168a082a189cf13ee1">AST_BRIDGE_COMPLETE</a>;
<a name="l04327"></a>04327             <span class="keywordflow">break</span>;
<a name="l04328"></a>04328          }
<a name="l04329"></a>04329       } <span class="keywordflow">else</span> {
<a name="l04330"></a>04330          <span class="keywordflow">if</span> ((fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a9b350360a64b55c7590f1ec03db480be">AST_FRAME_DTMF_BEGIN</a>) ||
<a name="l04331"></a>04331              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a98e65764bc963016c394bcc1bad6540b">AST_FRAME_DTMF_END</a>) ||
<a name="l04332"></a>04332              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0aa457fe7005f11bb7b21453f9bb4caa8f">AST_FRAME_VOICE</a>) ||
<a name="l04333"></a>04333              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a17ae96b6ea8a2388bb0d409e8124ff30">AST_FRAME_VIDEO</a>) ||
<a name="l04334"></a>04334              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a6c9398ee8989239124295d096a87bf32">AST_FRAME_IMAGE</a>) ||
<a name="l04335"></a>04335              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0a3d91bab33583f560197e21532a02a895">AST_FRAME_HTML</a>) ||
<a name="l04336"></a>04336              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0ad99b86353343f422bda01163898b2eea">AST_FRAME_MODEM</a>) ||
<a name="l04337"></a>04337              (fr-&gt;<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> == <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>)) {
<a name="l04338"></a>04338             <a class="code" href="channel_8h.html#a79c413d51b7135404d5cacf811649a61" title="Write a frame to a channel This function writes the given frame to the indicated...">ast_write</a>(other, fr);
<a name="l04339"></a>04339          }
<a name="l04340"></a>04340 
<a name="l04341"></a>04341          <a class="code" href="frame_8h.html#a6440d070425a2efe8e0aa71e8d9e47b7">ast_frfree</a>(fr);
<a name="l04342"></a>04342       }
<a name="l04343"></a>04343       <span class="comment">/* Swap priority */</span>
<a name="l04344"></a>04344 <span class="preprocessor">#ifndef HAVE_EPOLL</span>
<a name="l04345"></a>04345 <span class="preprocessor"></span>      cs[2] = cs[0];
<a name="l04346"></a>04346       cs[0] = cs[1];
<a name="l04347"></a>04347       cs[1] = cs[2];
<a name="l04348"></a>04348 <span class="preprocessor">#endif</span>
<a name="l04349"></a>04349 <span class="preprocessor"></span>   }
<a name="l04350"></a>04350 
<a name="l04351"></a>04351    <span class="comment">/* If we are totally avoiding the core, then restore our link to it */</span>
<a name="l04352"></a>04352    <span class="keywordflow">if</span> (p0_callback)
<a name="l04353"></a>04353       p0_callback = <a class="code" href="rtp_8c.html#a8265c4eae4df1ec9d19e4fe76e756b24" title="Helper function to switch a channel and RTP stream out of callback mode.">p2p_callback_disable</a>(c0, p0, &amp;p0_iod[0]);
<a name="l04354"></a>04354    <span class="keywordflow">if</span> (p1_callback)
<a name="l04355"></a>04355       p1_callback = <a class="code" href="rtp_8c.html#a8265c4eae4df1ec9d19e4fe76e756b24" title="Helper function to switch a channel and RTP stream out of callback mode.">p2p_callback_disable</a>(c1, p1, &amp;p1_iod[0]);
<a name="l04356"></a>04356 
<a name="l04357"></a>04357    <span class="comment">/* Break out of the direct bridge */</span>
<a name="l04358"></a>04358    <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p0, NULL);
<a name="l04359"></a>04359    <a class="code" href="rtp_8c.html#abcd093dfb4f68466824f8d1dd227d49a" title="Helper function that sets what an RTP structure is bridged to.">p2p_set_bridge</a>(p1, NULL);
<a name="l04360"></a>04360 
<a name="l04361"></a>04361    <a class="code" href="channel_8h.html#a6b2da1bbe090143571ba1db7f94055a0">ast_poll_channel_del</a>(c0, c1);
<a name="l04362"></a>04362 
<a name="l04363"></a>04363    <span class="keywordflow">return</span> res;
<a name="l04364"></a>04364 }
<a name="l04365"></a>04365 <span class="comment"></span>
<a name="l04366"></a>04366 <span class="comment">/*! \page AstRTPbridge The Asterisk RTP bridge </span>
<a name="l04367"></a>04367 <span class="comment">   The RTP bridge is called from the channel drivers that are using the RTP</span>
<a name="l04368"></a>04368 <span class="comment">   subsystem in Asterisk - like SIP, H.323 and Jingle/Google Talk.</span>
<a name="l04369"></a>04369 <span class="comment"></span>
<a name="l04370"></a>04370 <span class="comment">   This bridge aims to offload the Asterisk server by setting up</span>
<a name="l04371"></a>04371 <span class="comment">   the media stream directly between the endpoints, keeping the</span>
<a name="l04372"></a>04372 <span class="comment">   signalling in Asterisk.</span>
<a name="l04373"></a>04373 <span class="comment"></span>
<a name="l04374"></a>04374 <span class="comment">   It checks with the channel driver, using a callback function, if</span>
<a name="l04375"></a>04375 <span class="comment">   there are possibilities for a remote bridge.</span>
<a name="l04376"></a>04376 <span class="comment"></span>
<a name="l04377"></a>04377 <span class="comment">   If this fails, the bridge hands off to the core bridge. Reasons</span>
<a name="l04378"></a>04378 <span class="comment">   can be NAT support needed, DTMF features in audio needed by</span>
<a name="l04379"></a>04379 <span class="comment">   the PBX for transfers or spying/monitoring on channels.</span>
<a name="l04380"></a>04380 <span class="comment"></span>
<a name="l04381"></a>04381 <span class="comment">   If transcoding is needed - we can&apos;t do a remote bridge.</span>
<a name="l04382"></a>04382 <span class="comment">   If only NAT support is needed, we&apos;re using Asterisk in</span>
<a name="l04383"></a>04383 <span class="comment">   RTP proxy mode with the p2p RTP bridge, basically</span>
<a name="l04384"></a>04384 <span class="comment">   forwarding incoming audio packets to the outbound</span>
<a name="l04385"></a>04385 <span class="comment">   stream on a network level.</span>
<a name="l04386"></a>04386 <span class="comment"></span>
<a name="l04387"></a>04387 <span class="comment">   References:</span>
<a name="l04388"></a>04388 <span class="comment">   - ast_rtp_bridge()</span>
<a name="l04389"></a>04389 <span class="comment">   - ast_channel_early_bridge()</span>
<a name="l04390"></a>04390 <span class="comment">   - ast_channel_bridge()</span>
<a name="l04391"></a>04391 <span class="comment">   - rtp.c</span>
<a name="l04392"></a>04392 <span class="comment">   - rtp.h</span>
<a name="l04393"></a>04393 <span class="comment">*/</span><span class="comment"></span>
<a name="l04394"></a>04394 <span class="comment">/*! \brief Bridge calls. If possible and allowed, initiate</span>
<a name="l04395"></a>04395 <span class="comment">   re-invite so the peers exchange media directly outside </span>
<a name="l04396"></a>04396 <span class="comment">   of Asterisk. </span>
<a name="l04397"></a>04397 <span class="comment">*/</span>
<a name="l04398"></a><a class="code" href="rtp_8c.html#aa8b05110c5ee3771f31458ef00ae4fba">04398</a> <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> <a class="code" href="rtp_8h.html#af45b92414bcb435f50e82c819e77649c" title="The RTP bridge.">ast_rtp_bridge</a>(<span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c0, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> *c1, <span class="keywordtype">int</span> <a class="code" href="structast__channel.html#ac92588540e8c1d014a08cd8a45462b19">flags</a>, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> **fo, <span class="keyword">struct</span> <a class="code" href="structast__channel.html" title="Main Channel structure associated with a channel. This is the side of it mostly used...">ast_channel</a> **rc, <span class="keywordtype">int</span> timeoutms)
<a name="l04399"></a>04399 {
<a name="l04400"></a>04400    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *p0 = NULL, *p1 = NULL;    <span class="comment">/* Audio RTP Channels */</span>
<a name="l04401"></a>04401    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *vp0 = NULL, *vp1 = NULL;  <span class="comment">/* Video RTP channels */</span>
<a name="l04402"></a>04402    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *tp0 = NULL, *tp1 = NULL;  <span class="comment">/* Text RTP channels */</span>
<a name="l04403"></a>04403    <span class="keyword">struct </span><a class="code" href="structast__rtp__protocol.html" title="This is the structure that binds a channel (SIP/Jingle/H.323) to the RTP subsystem...">ast_rtp_protocol</a> *pr0 = NULL, *pr1 = NULL;
<a name="l04404"></a>04404    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> audio_p0_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, video_p0_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, text_p0_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04405"></a>04405    <span class="keyword">enum</span> <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95">ast_rtp_get_result</a> audio_p1_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, video_p1_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>, text_p1_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04406"></a>04406    <span class="keyword">enum</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05">ast_bridge_result</a> res = <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l04407"></a>04407    <span class="keywordtype">int</span> codec0 = 0, codec1 = 0;
<a name="l04408"></a>04408    <span class="keywordtype">void</span> *pvt0 = NULL, *pvt1 = NULL;
<a name="l04409"></a>04409 
<a name="l04410"></a>04410    <span class="comment">/* Lock channels */</span>
<a name="l04411"></a>04411    <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(c0);
<a name="l04412"></a>04412    <span class="keywordflow">while</span> (<a class="code" href="lock_8h.html#a8b8532d377bd19e8411000ddccfa6607" title="Try locking a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_trylock</a>(c1)) {
<a name="l04413"></a>04413       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04414"></a>04414       usleep(1);
<a name="l04415"></a>04415       <a class="code" href="lock_8h.html#acbcec0b11bb6e43e0ebcd82828bc8684" title="Lock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_lock</a>(c0);
<a name="l04416"></a>04416    }
<a name="l04417"></a>04417 
<a name="l04418"></a>04418    <span class="comment">/* Ensure neither channel got hungup during lock avoidance */</span>
<a name="l04419"></a>04419    <span class="keywordflow">if</span> (<a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c0) || <a class="code" href="channel_8h.html#a9c63fff1d736568d1ee332dd7ea502bd" title="Check to see if a channel is needing hang up.">ast_check_hangup</a>(c1)) {
<a name="l04420"></a>04420       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Got hangup while attempting to bridge &apos;%s&apos; and &apos;%s&apos;\n&quot;</span>, c0-&gt;name, c1-&gt;name);
<a name="l04421"></a>04421       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04422"></a>04422       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04423"></a>04423       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l04424"></a>04424    }
<a name="l04425"></a>04425       
<a name="l04426"></a>04426    <span class="comment">/* Find channel driver interfaces */</span>
<a name="l04427"></a>04427    <span class="keywordflow">if</span> (!(pr0 = <a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(c0))) {
<a name="l04428"></a>04428       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t find native functions for channel &apos;%s&apos;\n&quot;</span>, c0-&gt;name);
<a name="l04429"></a>04429       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04430"></a>04430       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04431"></a>04431       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l04432"></a>04432    }
<a name="l04433"></a>04433    <span class="keywordflow">if</span> (!(pr1 = <a class="code" href="rtp_8c.html#aaff70ed852bc78df19b0615bbb1885cd" title="Get channel driver interface structure.">get_proto</a>(c1))) {
<a name="l04434"></a>04434       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Can&apos;t find native functions for channel &apos;%s&apos;\n&quot;</span>, c1-&gt;name);
<a name="l04435"></a>04435       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04436"></a>04436       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04437"></a>04437       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05afcae35649bbc24a8c2080bec8d592c40">AST_BRIDGE_FAILED</a>;
<a name="l04438"></a>04438    }
<a name="l04439"></a>04439 
<a name="l04440"></a>04440    <span class="comment">/* Get channel specific interface structures */</span>
<a name="l04441"></a>04441    pvt0 = c0-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l04442"></a>04442    pvt1 = c1-&gt;<a class="code" href="structast__channel.html#a19aa04db5508cf9496602e694dc69e2f">tech_pvt</a>;
<a name="l04443"></a>04443 
<a name="l04444"></a>04444    <span class="comment">/* Get audio and video interface (if native bridge is possible) */</span>
<a name="l04445"></a>04445    audio_p0_res = pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aad2be0227a36efe9efc1fea51dd407a5">get_rtp_info</a>(c0, &amp;p0);
<a name="l04446"></a>04446    video_p0_res = pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aea1ff20567813f95ff79f94c554fff27">get_vrtp_info</a> ? pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aea1ff20567813f95ff79f94c554fff27">get_vrtp_info</a>(c0, &amp;vp0) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04447"></a>04447    text_p0_res = pr0-&gt;<a class="code" href="structast__rtp__protocol.html#ae3c52f1d063f37511bf26a747639254a">get_trtp_info</a> ? pr0-&gt;<a class="code" href="structast__rtp__protocol.html#ae3c52f1d063f37511bf26a747639254a">get_trtp_info</a>(c0, &amp;vp0) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04448"></a>04448    audio_p1_res = pr1-&gt;get_rtp_info(c1, &amp;p1);
<a name="l04449"></a>04449    video_p1_res = pr1-&gt;get_vrtp_info ? pr1-&gt;get_vrtp_info(c1, &amp;vp1) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04450"></a>04450    text_p1_res = pr1-&gt;get_trtp_info ? pr1-&gt;get_trtp_info(c1, &amp;vp1) : <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04451"></a>04451 
<a name="l04452"></a>04452    <span class="comment">/* If we are carrying video, and both sides are not reinviting... then fail the native bridge */</span>
<a name="l04453"></a>04453    <span class="keywordflow">if</span> (video_p0_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> &amp;&amp; (audio_p0_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> || video_p0_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>))
<a name="l04454"></a>04454       audio_p0_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04455"></a>04455    <span class="keywordflow">if</span> (video_p1_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> &amp;&amp; (audio_p1_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a> || video_p1_res != <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ab591abc73866492b4b33dd96d9925136">AST_RTP_TRY_NATIVE</a>))
<a name="l04456"></a>04456       audio_p1_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>;
<a name="l04457"></a>04457 
<a name="l04458"></a>04458    <span class="comment">/* Check if a bridge is possible (partial/native) */</span>
<a name="l04459"></a>04459    <span class="keywordflow">if</span> (audio_p0_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a> || audio_p1_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95ac5576eebb6765a96bed3a6e123c8f6c4">AST_RTP_GET_FAILED</a>) {
<a name="l04460"></a>04460       <span class="comment">/* Somebody doesn&apos;t want to play... */</span>
<a name="l04461"></a>04461       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04462"></a>04462       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04463"></a>04463       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04464"></a>04464    }
<a name="l04465"></a>04465 
<a name="l04466"></a>04466    <span class="comment">/* If we need to feed DTMF frames into the core then only do a partial native bridge */</span>
<a name="l04467"></a>04467    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">FLAG_HAS_DTMF</a>) &amp;&amp; (flags &amp; <a class="code" href="channel_8h.html#a2bd5879255a0f6a758c99b58fcab2f27" title="Report DTMF on channel 0.">AST_BRIDGE_DTMF_CHANNEL_0</a>)) {
<a name="l04468"></a>04468       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p0, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>);
<a name="l04469"></a>04469       audio_p0_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a>;
<a name="l04470"></a>04470    }
<a name="l04471"></a>04471 
<a name="l04472"></a>04472    <span class="keywordflow">if</span> (<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">FLAG_HAS_DTMF</a>) &amp;&amp; (flags &amp; <a class="code" href="channel_8h.html#a7dbb6edabad3e02e80d605ca5d254c35" title="Report DTMF on channel 1.">AST_BRIDGE_DTMF_CHANNEL_1</a>)) {
<a name="l04473"></a>04473       <a class="code" href="utils_8h.html#ab5033a1f3d781d45e7ccc27598114510">ast_set_flag</a>(p1, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>);
<a name="l04474"></a>04474       audio_p1_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a>;
<a name="l04475"></a>04475    }
<a name="l04476"></a>04476 
<a name="l04477"></a>04477    <span class="comment">/* If both sides are not using the same method of DTMF transmission </span>
<a name="l04478"></a>04478 <span class="comment">    * (ie: one is RFC2833, other is INFO... then we can not do direct media. </span>
<a name="l04479"></a>04479 <span class="comment">    * --------------------------------------------------</span>
<a name="l04480"></a>04480 <span class="comment">    * | DTMF Mode |  HAS_DTMF  |  Accepts Begin Frames |</span>
<a name="l04481"></a>04481 <span class="comment">    * |-----------|------------|-----------------------|</span>
<a name="l04482"></a>04482 <span class="comment">    * | Inband    | False      | True                  |</span>
<a name="l04483"></a>04483 <span class="comment">    * | RFC2833   | True       | True                  |</span>
<a name="l04484"></a>04484 <span class="comment">    * | SIP INFO  | False      | False                 |</span>
<a name="l04485"></a>04485 <span class="comment">    * --------------------------------------------------</span>
<a name="l04486"></a>04486 <span class="comment">    * However, if DTMF from both channels is being monitored by the core, then</span>
<a name="l04487"></a>04487 <span class="comment">    * we can still do packet-to-packet bridging, because passing through the </span>
<a name="l04488"></a>04488 <span class="comment">    * core will handle DTMF mode translation.</span>
<a name="l04489"></a>04489 <span class="comment">    */</span>
<a name="l04490"></a>04490    <span class="keywordflow">if</span> ((<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">FLAG_HAS_DTMF</a>) != <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#a3da84400ccc8d31229b3c91d505ca7af">FLAG_HAS_DTMF</a>)) ||
<a name="l04491"></a>04491       (!c0-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a83b4c653034ecac13d1abc179d0535d8" title="Start sending a literal DTMF digit.">send_digit_begin</a> != !c1-&gt;<a class="code" href="structast__channel.html#a0716a334727b22adf0290792bd80de10">tech</a>-&gt;<a class="code" href="structast__channel__tech.html#a83b4c653034ecac13d1abc179d0535d8" title="Start sending a literal DTMF digit.">send_digit_begin</a>)) {
<a name="l04492"></a>04492       <span class="keywordflow">if</span> (!<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>) || !<a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>)) {
<a name="l04493"></a>04493          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04494"></a>04494          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04495"></a>04495          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04496"></a>04496       }
<a name="l04497"></a>04497       audio_p0_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a>;
<a name="l04498"></a>04498       audio_p1_res = <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a>;
<a name="l04499"></a>04499    }
<a name="l04500"></a>04500 
<a name="l04501"></a>04501    <span class="comment">/* If we need to feed frames into the core don&apos;t do a P2P bridge */</span>
<a name="l04502"></a>04502    <span class="keywordflow">if</span> ((audio_p0_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a> &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p0, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>)) ||
<a name="l04503"></a>04503        (audio_p1_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a> &amp;&amp; <a class="code" href="utils_8h.html#a00d4c9254c9827d6fa44f17a326744a5">ast_test_flag</a>(p1, <a class="code" href="rtp_8c.html#a74430081871d2b537f65fbb01e2d7e16">FLAG_P2P_NEED_DTMF</a>))) {
<a name="l04504"></a>04504       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04505"></a>04505       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04506"></a>04506       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04507"></a>04507    }
<a name="l04508"></a>04508 
<a name="l04509"></a>04509    <span class="comment">/* Get codecs from both sides */</span>
<a name="l04510"></a>04510    codec0 = pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a> ? pr0-&gt;<a class="code" href="structast__rtp__protocol.html#aef0f5483a05126d99b826a0312ea7992">get_codec</a>(c0) : 0;
<a name="l04511"></a>04511    codec1 = pr1-&gt;get_codec ? pr1-&gt;get_codec(c1) : 0;
<a name="l04512"></a>04512    <span class="keywordflow">if</span> (codec0 &amp;&amp; codec1 &amp;&amp; !(codec0 &amp; codec1)) {
<a name="l04513"></a>04513       <span class="comment">/* Hey, we can&apos;t do native bridging if both parties speak different codecs */</span>
<a name="l04514"></a>04514       <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(3, <span class="stringliteral">&quot;Channel codec0 = %d is not codec1 = %d, cannot native bridge in RTP.\n&quot;</span>, codec0, codec1);
<a name="l04515"></a>04515       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04516"></a>04516       <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04517"></a>04517       <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04518"></a>04518    }
<a name="l04519"></a>04519 
<a name="l04520"></a>04520    <span class="comment">/* If either side can only do a partial bridge, then don&apos;t try for a true native bridge */</span>
<a name="l04521"></a>04521    <span class="keywordflow">if</span> (audio_p0_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a> || audio_p1_res == <a class="code" href="rtp_8h.html#adb5c0a29db09eb234a36f24b25766a95a8bc993394ab95ca4c2ac98f9477518fe">AST_RTP_TRY_PARTIAL</a>) {
<a name="l04522"></a>04522       <span class="keyword">struct </span><a class="code" href="structast__format__list.html" title="Definition of supported media formats (codecs).">ast_format_list</a> fmt0, fmt1;
<a name="l04523"></a>04523 
<a name="l04524"></a>04524       <span class="comment">/* In order to do Packet2Packet bridging both sides must be in the same rawread/rawwrite */</span>
<a name="l04525"></a>04525       <span class="keywordflow">if</span> (c0-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> != c1-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a> || c1-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a> != c0-&gt;<a class="code" href="structast__channel.html#a045b6dfdee84adceb7e86b6c5c4f9a86">rawwriteformat</a>) {
<a name="l04526"></a>04526          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Cannot packet2packet bridge - raw formats are incompatible\n&quot;</span>);
<a name="l04527"></a>04527          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04528"></a>04528          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04529"></a>04529          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04530"></a>04530       }
<a name="l04531"></a>04531       <span class="comment">/* They must also be using the same packetization */</span>
<a name="l04532"></a>04532       fmt0 = <a class="code" href="frame_8h.html#ac9789499b866949ab31bab025b497964" title="Get packet size for codec.">ast_codec_pref_getsize</a>(&amp;p0-&gt;<a class="code" href="structast__rtp.html#a19c23d44fca820c7b8c868f4c9075b56">pref</a>, c0-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>);
<a name="l04533"></a>04533       fmt1 = <a class="code" href="frame_8h.html#ac9789499b866949ab31bab025b497964" title="Get packet size for codec.">ast_codec_pref_getsize</a>(&amp;p1-&gt;pref, c1-&gt;<a class="code" href="structast__channel.html#a6fcf944239e3718e282e0ba7512e66c6">rawreadformat</a>);
<a name="l04534"></a>04534       <span class="keywordflow">if</span> (fmt0.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a> != fmt1.<a class="code" href="structast__format__list.html#a8082330d5592ca639ddd6f7be0c0c39b">cur_ms</a>) {
<a name="l04535"></a>04535          <a class="code" href="logger_8h.html#a3f248112c8d6ce7e3959aa723dade648" title="Log a DEBUG message.">ast_debug</a>(1, <span class="stringliteral">&quot;Cannot packet2packet bridge - packetization settings prevent it\n&quot;</span>);
<a name="l04536"></a>04536          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c0);
<a name="l04537"></a>04537          <a class="code" href="lock_8h.html#a853c07107a1385c83c5d2a0ab7e01d79" title="Unlock a channel. If DEBUG_CHANNEL_LOCKS is defined in the Makefile, print relevant...">ast_channel_unlock</a>(c1);
<a name="l04538"></a>04538          <span class="keywordflow">return</span> <a class="code" href="channel_8h.html#aadd815141298769e39efd4c3f70a7f05a4368c9e8d0072a09af3086c79790abfb">AST_BRIDGE_FAILED_NOWARN</a>;
<a name="l04539"></a>04539       }
<a name="l04540"></a>04540 
<a name="l04541"></a>04541       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Packet2Packet bridging %s and %s\n&quot;</span>, c0-&gt;name, c1-&gt;name);
<a name="l04542"></a>04542       res = <a class="code" href="rtp_8c.html#ab1f0de9367de02dc9983e85eab3f8b88" title="Bridge loop for partial native bridge (packet2packet).">bridge_p2p_loop</a>(c0, c1, p0, p1, timeoutms, flags, fo, rc, pvt0, pvt1);
<a name="l04543"></a>04543    } <span class="keywordflow">else</span> {
<a name="l04544"></a>04544       <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(3, <span class="stringliteral">&quot;Native bridging %s and %s\n&quot;</span>, c0-&gt;name, c1-&gt;name);
<a name="l04545"></a>04545       res = <a class="code" href="rtp_8c.html#a2e5b6817e5bb2de05f716709b7d177c6" title="Bridge loop for true native bridge (reinvite).">bridge_native_loop</a>(c0, c1, p0, p1, vp0, vp1, tp0, tp1, pr0, pr1, codec0, codec1, timeoutms, flags, fo, rc, pvt0, pvt1);
<a name="l04546"></a>04546    }
<a name="l04547"></a>04547 
<a name="l04548"></a>04548    <span class="keywordflow">return</span> res;
<a name="l04549"></a>04549 }
<a name="l04550"></a>04550 
<a name="l04551"></a><a class="code" href="rtp_8c.html#a07116c4a926b544b84936ff2f788883f">04551</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a07116c4a926b544b84936ff2f788883f">rtp_do_debug_ip</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l04552"></a>04552 {
<a name="l04553"></a>04553    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l04554"></a>04554    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l04555"></a>04555    <span class="keywordtype">int</span> port = 0;
<a name="l04556"></a>04556    <span class="keywordtype">char</span> *p, *arg;
<a name="l04557"></a>04557 
<a name="l04558"></a>04558    arg = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3];
<a name="l04559"></a>04559    p = strstr(arg, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l04560"></a>04560    <span class="keywordflow">if</span> (p) {
<a name="l04561"></a>04561       *p = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04562"></a>04562       p++;
<a name="l04563"></a>04563       port = atoi(p);
<a name="l04564"></a>04564    }
<a name="l04565"></a>04565    hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(arg, &amp;ahp);
<a name="l04566"></a>04566    <span class="keywordflow">if</span> (hp == NULL) {
<a name="l04567"></a>04567       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Lookup failed for &apos;%s&apos;\n&quot;</span>, arg);
<a name="l04568"></a>04568       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l04569"></a>04569    }
<a name="l04570"></a>04570    <a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_family = AF_INET;
<a name="l04571"></a>04571    memcpy(&amp;<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_addr));
<a name="l04572"></a>04572    <a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_port = htons(port);
<a name="l04573"></a>04573    <span class="keywordflow">if</span> (port == 0)
<a name="l04574"></a>04574       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTP Debugging Enabled for IP: %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_addr));
<a name="l04575"></a>04575    <span class="keywordflow">else</span>
<a name="l04576"></a>04576       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTP Debugging Enabled for IP: %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>.sin_addr), port);
<a name="l04577"></a>04577    rtpdebug = 1;
<a name="l04578"></a>04578    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04579"></a>04579 }
<a name="l04580"></a>04580 
<a name="l04581"></a><a class="code" href="rtp_8c.html#ac5880d6e79bbf0f0fc09483c25ece2b6">04581</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#ac5880d6e79bbf0f0fc09483c25ece2b6">rtcp_do_debug_ip</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l04582"></a>04582 {
<a name="l04583"></a>04583    <span class="keyword">struct </span>hostent *<a class="code" href="chan__skinny_8c.html#aa0f575fa3882aa394cc287edba645a35">hp</a>;
<a name="l04584"></a>04584    <span class="keyword">struct </span><a class="code" href="structast__hostent.html">ast_hostent</a> ahp;
<a name="l04585"></a>04585    <span class="keywordtype">int</span> port = 0;
<a name="l04586"></a>04586    <span class="keywordtype">char</span> *p, *arg;
<a name="l04587"></a>04587 
<a name="l04588"></a>04588    arg = a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[3];
<a name="l04589"></a>04589    p = strstr(arg, <span class="stringliteral">&quot;:&quot;</span>);
<a name="l04590"></a>04590    <span class="keywordflow">if</span> (p) {
<a name="l04591"></a>04591       *p = <span class="charliteral">&apos;\0&apos;</span>;
<a name="l04592"></a>04592       p++;
<a name="l04593"></a>04593       port = atoi(p);
<a name="l04594"></a>04594    }
<a name="l04595"></a>04595    hp = <a class="code" href="utils_8h.html#ad3b63ee1041593219ef0765b28d70442" title="Thread-safe gethostbyname function to use in Asterisk.">ast_gethostbyname</a>(arg, &amp;ahp);
<a name="l04596"></a>04596    <span class="keywordflow">if</span> (hp == NULL) {
<a name="l04597"></a>04597       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;Lookup failed for &apos;%s&apos;\n&quot;</span>, arg);
<a name="l04598"></a>04598       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#ae47751901c430ebb833e59291a5e0b3f">CLI_FAILURE</a>;
<a name="l04599"></a>04599    }
<a name="l04600"></a>04600    <a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_family = AF_INET;
<a name="l04601"></a>04601    memcpy(&amp;<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_addr, hp-&gt;h_addr, <span class="keyword">sizeof</span>(<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_addr));
<a name="l04602"></a>04602    <a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_port = htons(port);
<a name="l04603"></a>04603    <span class="keywordflow">if</span> (port == 0)
<a name="l04604"></a>04604       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTCP Debugging Enabled for IP: %s\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_addr));
<a name="l04605"></a>04605    <span class="keywordflow">else</span>
<a name="l04606"></a>04606       <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTCP Debugging Enabled for IP: %s:%d\n&quot;</span>, <a class="code" href="network_8h.html#a5a735cb59e8a8ddd78078d396db7e106" title="thread-safe replacement for inet_ntoa().">ast_inet_ntoa</a>(<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>.sin_addr), port);
<a name="l04607"></a>04607    rtcpdebug = 1;
<a name="l04608"></a>04608    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04609"></a>04609 }
<a name="l04610"></a>04610 
<a name="l04611"></a><a class="code" href="rtp_8c.html#a7a54e80a72f7a13775f84d6b98497499">04611</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a7a54e80a72f7a13775f84d6b98497499">handle_cli_rtp_set_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l04612"></a>04612 {
<a name="l04613"></a>04613    <span class="keywordflow">switch</span> (cmd) {
<a name="l04614"></a>04614    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04615"></a>04615       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;rtp set debug {on|off|ip}&quot;</span>;
<a name="l04616"></a>04616       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04617"></a>04617          <span class="stringliteral">&quot;Usage: rtp set debug {on|off|ip host[:port]}\n&quot;</span>
<a name="l04618"></a>04618          <span class="stringliteral">&quot;       Enable/Disable dumping of all RTP packets. If &apos;ip&apos; is\n&quot;</span>
<a name="l04619"></a>04619          <span class="stringliteral">&quot;       specified, limit the dumped packets to those to and from\n&quot;</span>
<a name="l04620"></a>04620          <span class="stringliteral">&quot;       the specified &apos;host&apos; with optional port.\n&quot;</span>;
<a name="l04621"></a>04621       <span class="keywordflow">return</span> NULL;
<a name="l04622"></a>04622    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04623"></a>04623       <span class="keywordflow">return</span> NULL;
<a name="l04624"></a>04624    }
<a name="l04625"></a>04625 
<a name="l04626"></a>04626    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) { <span class="comment">/* set on or off */</span>
<a name="l04627"></a>04627       <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l04628"></a>04628          rtpdebug = 1;
<a name="l04629"></a>04629          memset(&amp;<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="rtp_8c.html#adf02ce429cbdfcebf2df6e8f66a6658c">rtpdebugaddr</a>));
<a name="l04630"></a>04630          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTP Debugging Enabled\n&quot;</span>);
<a name="l04631"></a>04631          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04632"></a>04632       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;off&quot;</span>, 3)) {
<a name="l04633"></a>04633          rtpdebug = 0;
<a name="l04634"></a>04634          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTP Debugging Disabled\n&quot;</span>);
<a name="l04635"></a>04635          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04636"></a>04636       }
<a name="l04637"></a>04637    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> +1) { <span class="comment">/* ip */</span>
<a name="l04638"></a>04638       <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#a07116c4a926b544b84936ff2f788883f">rtp_do_debug_ip</a>(a);
<a name="l04639"></a>04639    }
<a name="l04640"></a>04640 
<a name="l04641"></a>04641    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;   <span class="comment">/* default, failure */</span>
<a name="l04642"></a>04642 }
<a name="l04643"></a>04643 
<a name="l04644"></a><a class="code" href="rtp_8c.html#a6ec75d08ff56cd99acc84c2c9fe390e3">04644</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a6ec75d08ff56cd99acc84c2c9fe390e3">handle_cli_rtcp_set_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l04645"></a>04645 {
<a name="l04646"></a>04646    <span class="keywordflow">switch</span> (cmd) {
<a name="l04647"></a>04647    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04648"></a>04648       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;rtcp set debug {on|off|ip}&quot;</span>;
<a name="l04649"></a>04649       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04650"></a>04650          <span class="stringliteral">&quot;Usage: rtcp set debug {on|off|ip host[:port]}\n&quot;</span>
<a name="l04651"></a>04651          <span class="stringliteral">&quot;       Enable/Disable dumping of all RTCP packets. If &apos;ip&apos; is\n&quot;</span>
<a name="l04652"></a>04652          <span class="stringliteral">&quot;       specified, limit the dumped packets to those to and from\n&quot;</span>
<a name="l04653"></a>04653          <span class="stringliteral">&quot;       the specified &apos;host&apos; with optional port.\n&quot;</span>;
<a name="l04654"></a>04654       <span class="keywordflow">return</span> NULL;
<a name="l04655"></a>04655    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04656"></a>04656       <span class="keywordflow">return</span> NULL;
<a name="l04657"></a>04657    }
<a name="l04658"></a>04658 
<a name="l04659"></a>04659    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>) { <span class="comment">/* set on or off */</span>
<a name="l04660"></a>04660       <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;on&quot;</span>, 2)) {
<a name="l04661"></a>04661          rtcpdebug = 1;
<a name="l04662"></a>04662          memset(&amp;<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>, 0, <span class="keyword">sizeof</span>(<a class="code" href="rtp_8c.html#a937741861b28eec2a8dc9836cee2bfa3">rtcpdebugaddr</a>));
<a name="l04663"></a>04663          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTCP Debugging Enabled\n&quot;</span>);
<a name="l04664"></a>04664          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04665"></a>04665       } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;off&quot;</span>, 3)) {
<a name="l04666"></a>04666          rtcpdebug = 0;
<a name="l04667"></a>04667          <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTCP Debugging Disabled\n&quot;</span>);
<a name="l04668"></a>04668          <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04669"></a>04669       }
<a name="l04670"></a>04670    } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> == e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a> +1) { <span class="comment">/* ip */</span>
<a name="l04671"></a>04671       <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#ac5880d6e79bbf0f0fc09483c25ece2b6">rtcp_do_debug_ip</a>(a);
<a name="l04672"></a>04672    }
<a name="l04673"></a>04673 
<a name="l04674"></a>04674    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;   <span class="comment">/* default, failure */</span>
<a name="l04675"></a>04675 }
<a name="l04676"></a>04676 
<a name="l04677"></a><a class="code" href="rtp_8c.html#a96a3270020e5335d892ddeed13d689ee">04677</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#a96a3270020e5335d892ddeed13d689ee">handle_cli_rtcp_set_stats</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l04678"></a>04678 {
<a name="l04679"></a>04679    <span class="keywordflow">switch</span> (cmd) {
<a name="l04680"></a>04680    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04681"></a>04681       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;rtcp set stats {on|off}&quot;</span>;
<a name="l04682"></a>04682       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04683"></a>04683          <span class="stringliteral">&quot;Usage: rtcp set stats {on|off}\n&quot;</span>
<a name="l04684"></a>04684          <span class="stringliteral">&quot;       Enable/Disable dumping of RTCP stats.\n&quot;</span>;
<a name="l04685"></a>04685       <span class="keywordflow">return</span> NULL;
<a name="l04686"></a>04686    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04687"></a>04687       <span class="keywordflow">return</span> NULL;
<a name="l04688"></a>04688    }
<a name="l04689"></a>04689 
<a name="l04690"></a>04690    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l04691"></a>04691       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l04692"></a>04692 
<a name="l04693"></a>04693    <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;on&quot;</span>, 2))
<a name="l04694"></a>04694       rtcpstats = 1;
<a name="l04695"></a>04695    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;off&quot;</span>, 3))
<a name="l04696"></a>04696       rtcpstats = 0;
<a name="l04697"></a>04697    <span class="keywordflow">else</span>
<a name="l04698"></a>04698       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l04699"></a>04699 
<a name="l04700"></a>04700    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;RTCP Stats %s\n&quot;</span>, rtcpstats ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l04701"></a>04701    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04702"></a>04702 }
<a name="l04703"></a>04703 
<a name="l04704"></a><a class="code" href="rtp_8c.html#ae5d3d0dae07a60e93e7b8601f3d86898">04704</a> <span class="keyword">static</span> <span class="keywordtype">char</span> *<a class="code" href="rtp_8c.html#ae5d3d0dae07a60e93e7b8601f3d86898">handle_cli_stun_set_debug</a>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> *e, <span class="keywordtype">int</span> cmd, <span class="keyword">struct</span> <a class="code" href="structast__cli__args.html">ast_cli_args</a> *a)
<a name="l04705"></a>04705 {
<a name="l04706"></a>04706    <span class="keywordflow">switch</span> (cmd) {
<a name="l04707"></a>04707    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea71745eb63dd093f560a1add3e430d2a9">CLI_INIT</a>:
<a name="l04708"></a>04708       e-&gt;<a class="code" href="structast__cli__entry.html#ade9cba72805fe52685a1deea307a8e82">command</a> = <span class="stringliteral">&quot;stun set debug {on|off}&quot;</span>;
<a name="l04709"></a>04709       e-&gt;<a class="code" href="structast__cli__entry.html#aef1bd6ad890a110b466cb0e8088507a2">usage</a> =
<a name="l04710"></a>04710          <span class="stringliteral">&quot;Usage: stun set debug {on|off}\n&quot;</span>
<a name="l04711"></a>04711          <span class="stringliteral">&quot;       Enable/Disable STUN (Simple Traversal of UDP through NATs)\n&quot;</span>
<a name="l04712"></a>04712          <span class="stringliteral">&quot;       debugging\n&quot;</span>;
<a name="l04713"></a>04713       <span class="keywordflow">return</span> NULL;
<a name="l04714"></a>04714    <span class="keywordflow">case</span> <a class="code" href="cli_8h.html#a1c31538430e3fbd1b13483cec8d38feea76bf33139279b03ec1691f2be2d1be40">CLI_GENERATE</a>:
<a name="l04715"></a>04715       <span class="keywordflow">return</span> NULL;
<a name="l04716"></a>04716    }
<a name="l04717"></a>04717 
<a name="l04718"></a>04718    <span class="keywordflow">if</span> (a-&gt;<a class="code" href="structast__cli__args.html#ad1447518f4372828b8435ae82e48499e">argc</a> != e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>)
<a name="l04719"></a>04719       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l04720"></a>04720 
<a name="l04721"></a>04721    <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;on&quot;</span>, 2))
<a name="l04722"></a>04722       stundebug = 1;
<a name="l04723"></a>04723    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (!strncasecmp(a-&gt;<a class="code" href="structast__cli__args.html#af2efa898e9eed6fe6715279cb1ec35b0">argv</a>[e-&gt;<a class="code" href="structast__cli__entry.html#a1bd7a8575ca2650132d636d65dcda2f6" title="This gets set in ast_cli_register().">args</a>-1], <span class="stringliteral">&quot;off&quot;</span>, 3))
<a name="l04724"></a>04724       stundebug = 0;
<a name="l04725"></a>04725    <span class="keywordflow">else</span>
<a name="l04726"></a>04726       <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a0873456096960dab21fff0ce68c95acb">CLI_SHOWUSAGE</a>;
<a name="l04727"></a>04727 
<a name="l04728"></a>04728    <a class="code" href="cli_8h.html#a791bf9f5637185bee5e8f0907c762130">ast_cli</a>(a-&gt;<a class="code" href="structast__cli__args.html#a6f8059414f0228f0256115e024eeed4b">fd</a>, <span class="stringliteral">&quot;STUN Debugging %s\n&quot;</span>, stundebug ? <span class="stringliteral">&quot;Enabled&quot;</span> : <span class="stringliteral">&quot;Disabled&quot;</span>);
<a name="l04729"></a>04729    <span class="keywordflow">return</span> <a class="code" href="cli_8h.html#a50989f00b32eeb2516a3803cb2ffb766">CLI_SUCCESS</a>;
<a name="l04730"></a>04730 }
<a name="l04731"></a>04731 
<a name="l04732"></a><a class="code" href="rtp_8c.html#aa5f5020c8ed253374c8aead44db57c16">04732</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a> <a class="code" href="rtp_8c.html#aa5f5020c8ed253374c8aead44db57c16">cli_rtp</a>[] = {
<a name="l04733"></a>04733    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="rtp_8c.html#a7a54e80a72f7a13775f84d6b98497499">handle_cli_rtp_set_debug</a>,  <span class="stringliteral">&quot;Enable/Disable RTP debugging&quot;</span>),
<a name="l04734"></a>04734    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="rtp_8c.html#a6ec75d08ff56cd99acc84c2c9fe390e3">handle_cli_rtcp_set_debug</a>, <span class="stringliteral">&quot;Enable/Disable RTCP debugging&quot;</span>),
<a name="l04735"></a>04735    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="rtp_8c.html#a96a3270020e5335d892ddeed13d689ee">handle_cli_rtcp_set_stats</a>, <span class="stringliteral">&quot;Enable/Disable RTCP stats&quot;</span>),
<a name="l04736"></a>04736    <a class="code" href="cli_8h.html#a5c4130cf8f1e93acfdd84416cebf1aef">AST_CLI_DEFINE</a>(<a class="code" href="rtp_8c.html#ae5d3d0dae07a60e93e7b8601f3d86898">handle_cli_stun_set_debug</a>, <span class="stringliteral">&quot;Enable/Disable STUN debugging&quot;</span>),
<a name="l04737"></a>04737 };
<a name="l04738"></a>04738 
<a name="l04739"></a><a class="code" href="rtp_8c.html#a1dd1c9755cf7af11379a3d23a70c0bcf">04739</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#a1dd1c9755cf7af11379a3d23a70c0bcf">__ast_rtp_reload</a>(<span class="keywordtype">int</span> <a class="code" href="app__amd_8c.html#ad1982509765f4870f1f63412a53ea668">reload</a>)
<a name="l04740"></a>04740 {
<a name="l04741"></a>04741    <span class="keyword">struct </span><a class="code" href="structast__config.html">ast_config</a> *cfg;
<a name="l04742"></a>04742    <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="aesopt_8h.html#a20c782a91c883391b9bdf9e3176e447c">s</a>;
<a name="l04743"></a>04743    <span class="keyword">struct </span><a class="code" href="structast__flags.html" title="Structure used to handle boolean flags.">ast_flags</a> config_flags = { reload ? <a class="code" href="config_8h.html#a2d5492e116eebd5075f247d21fb9db26afa887389dc380bbdcffb65fec379f037">CONFIG_FLAG_FILEUNCHANGED</a> : 0 };
<a name="l04744"></a>04744 
<a name="l04745"></a>04745    cfg = <a class="code" href="config_8h.html#aab3eac8fa82a86a93c074deb7b77dbc9" title="Load a config file.">ast_config_load2</a>(<span class="stringliteral">&quot;rtp.conf&quot;</span>, <span class="stringliteral">&quot;rtp&quot;</span>, config_flags);
<a name="l04746"></a>04746    <span class="keywordflow">if</span> (cfg == <a class="code" href="config_8h.html#a39bacaabcacf47583204c7634e64a2a0">CONFIG_STATUS_FILEMISSING</a> || cfg == <a class="code" href="config_8h.html#a846844eb2c4eb44554445936b3770711">CONFIG_STATUS_FILEUNCHANGED</a> || cfg == <a class="code" href="config_8h.html#a8d1a63cdf2c7aff22a77b6e75d93b377">CONFIG_STATUS_FILEINVALID</a>) {
<a name="l04747"></a>04747       <span class="keywordflow">return</span> 0;
<a name="l04748"></a>04748    }
<a name="l04749"></a>04749 
<a name="l04750"></a>04750    rtpstart = 5000;
<a name="l04751"></a>04751    rtpend = 31000;
<a name="l04752"></a>04752    dtmftimeout = <a class="code" href="rtp_8c.html#a3d5f788ed405ca3ab6a778892570b2a2">DEFAULT_DTMF_TIMEOUT</a>;
<a name="l04753"></a>04753    strictrtp = <a class="code" href="rtp_8c.html#aca6484d75ee9d79a5d4447149f9c8c4bab82bff21db6795dfa152e316f6ae6bc1">STRICT_RTP_OPEN</a>;
<a name="l04754"></a>04754    <span class="keywordflow">if</span> (cfg) {
<a name="l04755"></a>04755       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;rtpstart&quot;</span>))) {
<a name="l04756"></a>04756          rtpstart = atoi(s);
<a name="l04757"></a>04757          <span class="keywordflow">if</span> (rtpstart &lt; 1024)
<a name="l04758"></a>04758             rtpstart = 1024;
<a name="l04759"></a>04759          <span class="keywordflow">if</span> (rtpstart &gt; 65535)
<a name="l04760"></a>04760             rtpstart = 65535;
<a name="l04761"></a>04761       }
<a name="l04762"></a>04762       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;rtpend&quot;</span>))) {
<a name="l04763"></a>04763          rtpend = atoi(s);
<a name="l04764"></a>04764          <span class="keywordflow">if</span> (rtpend &lt; 1024)
<a name="l04765"></a>04765             rtpend = 1024;
<a name="l04766"></a>04766          <span class="keywordflow">if</span> (rtpend &gt; 65535)
<a name="l04767"></a>04767             rtpend = 65535;
<a name="l04768"></a>04768       }
<a name="l04769"></a>04769       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;rtcpinterval&quot;</span>))) {
<a name="l04770"></a>04770          rtcpinterval = atoi(s);
<a name="l04771"></a>04771          <span class="keywordflow">if</span> (rtcpinterval == 0)
<a name="l04772"></a>04772             rtcpinterval = 0; <span class="comment">/* Just so we&apos;re clear... it&apos;s zero */</span>
<a name="l04773"></a>04773          <span class="keywordflow">if</span> (rtcpinterval &lt; <a class="code" href="rtp_8c.html#abc283785a565edd42110d25d9ade9080">RTCP_MIN_INTERVALMS</a>)
<a name="l04774"></a>04774             rtcpinterval = <a class="code" href="rtp_8c.html#abc283785a565edd42110d25d9ade9080">RTCP_MIN_INTERVALMS</a>; <span class="comment">/* This catches negative numbers too */</span>
<a name="l04775"></a>04775          <span class="keywordflow">if</span> (rtcpinterval &gt; <a class="code" href="rtp_8c.html#a40ff8a6874204fbbe6c375ae79d17b5e">RTCP_MAX_INTERVALMS</a>)
<a name="l04776"></a>04776             rtcpinterval = <a class="code" href="rtp_8c.html#a40ff8a6874204fbbe6c375ae79d17b5e">RTCP_MAX_INTERVALMS</a>;
<a name="l04777"></a>04777       }
<a name="l04778"></a>04778       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;rtpchecksums&quot;</span>))) {
<a name="l04779"></a>04779 <span class="preprocessor">#ifdef SO_NO_CHECK</span>
<a name="l04780"></a>04780 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(s))
<a name="l04781"></a>04781             nochecksums = 1;
<a name="l04782"></a>04782          <span class="keywordflow">else</span>
<a name="l04783"></a>04783             nochecksums = 0;
<a name="l04784"></a>04784 <span class="preprocessor">#else</span>
<a name="l04785"></a>04785 <span class="preprocessor"></span>         <span class="keywordflow">if</span> (<a class="code" href="strings_8h.html#a6c3dc0bad204e9dd9890325c1c861e38" title="Make sure something is false. Determine if a string containing a boolean value is...">ast_false</a>(s))
<a name="l04786"></a>04786             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Disabling RTP checksums is not supported on this operating system!\n&quot;</span>);
<a name="l04787"></a>04787 <span class="preprocessor">#endif</span>
<a name="l04788"></a>04788 <span class="preprocessor"></span>      }
<a name="l04789"></a>04789       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;dtmftimeout&quot;</span>))) {
<a name="l04790"></a>04790          dtmftimeout = atoi(s);
<a name="l04791"></a>04791          <span class="keywordflow">if</span> ((dtmftimeout &lt; 0) || (dtmftimeout &gt; 64000)) {
<a name="l04792"></a>04792             <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;DTMF timeout of &apos;%d&apos; outside range, using default of &apos;%d&apos; instead\n&quot;</span>,
<a name="l04793"></a>04793                dtmftimeout, <a class="code" href="rtp_8c.html#a3d5f788ed405ca3ab6a778892570b2a2">DEFAULT_DTMF_TIMEOUT</a>);
<a name="l04794"></a>04794             dtmftimeout = <a class="code" href="rtp_8c.html#a3d5f788ed405ca3ab6a778892570b2a2">DEFAULT_DTMF_TIMEOUT</a>;
<a name="l04795"></a>04795          };
<a name="l04796"></a>04796       }
<a name="l04797"></a>04797       <span class="keywordflow">if</span> ((s = <a class="code" href="config_8h.html#ab87fa38c79226e5a0105ad9d2e2e9ae5" title="Gets a variable.">ast_variable_retrieve</a>(cfg, <span class="stringliteral">&quot;general&quot;</span>, <span class="stringliteral">&quot;strictrtp&quot;</span>))) {
<a name="l04798"></a>04798          strictrtp = <a class="code" href="strings_8h.html#a387a69b3871ca31061566a73f45d20f4" title="Make sure something is true. Determine if a string containing a boolean value is...">ast_true</a>(s);
<a name="l04799"></a>04799       }
<a name="l04800"></a>04800       <a class="code" href="config_8h.html#a710f0b2a897849572b77dd0854b8dc03" title="Destroys a config.">ast_config_destroy</a>(cfg);
<a name="l04801"></a>04801    }
<a name="l04802"></a>04802    <span class="keywordflow">if</span> (rtpstart &gt;= rtpend) {
<a name="l04803"></a>04803       <a class="code" href="logger_8h.html#a93dd824dff97fe84941d6d71b7a3710e" title="Used for sending a log message This is the standard logger function. Probably the...">ast_log</a>(<a class="code" href="logger_8h.html#adf4476a6a4ea6c74231c826e899d7189">LOG_WARNING</a>, <span class="stringliteral">&quot;Unreasonable values for RTP start/end port in rtp.conf\n&quot;</span>);
<a name="l04804"></a>04804       rtpstart = 5000;
<a name="l04805"></a>04805       rtpend = 31000;
<a name="l04806"></a>04806    }
<a name="l04807"></a>04807    <a class="code" href="logger_8h.html#ad770f83c71e237e1f64163358ce4e13d">ast_verb</a>(2, <span class="stringliteral">&quot;RTP Allocating from port range %d -&gt; %d\n&quot;</span>, rtpstart, rtpend);
<a name="l04808"></a>04808    <span class="keywordflow">return</span> 0;
<a name="l04809"></a>04809 }
<a name="l04810"></a>04810 
<a name="l04811"></a><a class="code" href="rtp_8c.html#a939d33729da677d7fc093f99c558e8e6">04811</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#a939d33729da677d7fc093f99c558e8e6">ast_rtp_reload</a>(<span class="keywordtype">void</span>)
<a name="l04812"></a>04812 {
<a name="l04813"></a>04813    <span class="keywordflow">return</span> <a class="code" href="rtp_8c.html#a1dd1c9755cf7af11379a3d23a70c0bcf">__ast_rtp_reload</a>(1);
<a name="l04814"></a>04814 }
<a name="l04815"></a>04815 <span class="comment"></span>
<a name="l04816"></a>04816 <span class="comment">/*! \brief Initialize the RTP system in Asterisk */</span>
<a name="l04817"></a><a class="code" href="rtp_8c.html#a2e910d500d92f02ebf8d571f585d6dd3">04817</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#a2e910d500d92f02ebf8d571f585d6dd3" title="Initialize the RTP system in Asterisk.">ast_rtp_init</a>(<span class="keywordtype">void</span>)
<a name="l04818"></a>04818 {
<a name="l04819"></a>04819    <a class="code" href="cli_8h.html#aadeef34f3106bb78aeb3414032ad7fb7" title="Register multiple commands.">ast_cli_register_multiple</a>(cli_rtp, <span class="keyword">sizeof</span>(cli_rtp) / <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structast__cli__entry.html" title="descriptor for a cli entry.">ast_cli_entry</a>));
<a name="l04820"></a>04820    <a class="code" href="rtp_8c.html#a1dd1c9755cf7af11379a3d23a70c0bcf">__ast_rtp_reload</a>(0);
<a name="l04821"></a>04821 }
<a name="l04822"></a>04822 <span class="comment"></span>
<a name="l04823"></a>04823 <span class="comment">/*! \brief Write t140 redundacy frame </span>
<a name="l04824"></a>04824 <span class="comment"> * \param data primary data to be buffered</span>
<a name="l04825"></a>04825 <span class="comment"> */</span>
<a name="l04826"></a><a class="code" href="rtp_8c.html#af8fe2466849c65c9d60466c769ea5f2d">04826</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rtp_8c.html#af8fe2466849c65c9d60466c769ea5f2d" title="Write t140 redundacy frame.">red_write</a>(<span class="keyword">const</span> <span class="keywordtype">void</span> *data)
<a name="l04827"></a>04827 {
<a name="l04828"></a>04828    <span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp = (<span class="keyword">struct </span><a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a>*) data;
<a name="l04829"></a>04829    
<a name="l04830"></a>04830    <a class="code" href="rtp_8h.html#a7a8ffdcbe10f04c3ca29e7cad359a68c">ast_rtp_write</a>(rtp, &amp;rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>); 
<a name="l04831"></a>04831 
<a name="l04832"></a>04832    <span class="keywordflow">return</span> 1;   
<a name="l04833"></a>04833 }
<a name="l04834"></a>04834 <span class="comment"></span>
<a name="l04835"></a>04835 <span class="comment">/*! \brief Construct a redundant frame </span>
<a name="l04836"></a>04836 <span class="comment"> * \param red redundant data structure</span>
<a name="l04837"></a>04837 <span class="comment"> */</span>
<a name="l04838"></a><a class="code" href="rtp_8c.html#ae290f54e950a7b43fc6252366758745c">04838</a> <span class="keyword">static</span> <span class="keyword">struct </span><a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="rtp_8c.html#ae290f54e950a7b43fc6252366758745c" title="Construct a redundant frame.">red_t140_to_red</a>(<span class="keyword">struct</span> <a class="code" href="structrtp__red.html">rtp_red</a> *red) {
<a name="l04839"></a>04839    <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a> = red-&gt;<a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>;
<a name="l04840"></a>04840    <span class="keywordtype">int</span> len = 0;
<a name="l04841"></a>04841    <span class="keywordtype">int</span> i;
<a name="l04842"></a>04842 
<a name="l04843"></a>04843    <span class="comment">/* replace most aged generation */</span>
<a name="l04844"></a>04844    <span class="keywordflow">if</span> (red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[0]) {
<a name="l04845"></a>04845       <span class="keywordflow">for</span> (i = 1; i &lt; red-&gt;<a class="code" href="structrtp__red.html#a616e41679f381ce34cf536b20e24011a">num_gen</a>+1; i++)
<a name="l04846"></a>04846          len += red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[i];
<a name="l04847"></a>04847 
<a name="l04848"></a>04848       memmove(&amp;data[red-&gt;<a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">hdrlen</a>], &amp;data[red-&gt;<a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">hdrlen</a>+red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[0]], len); 
<a name="l04849"></a>04849    }
<a name="l04850"></a>04850    
<a name="l04851"></a>04851    <span class="comment">/* Store length of each generation and primary data length*/</span>
<a name="l04852"></a>04852    <span class="keywordflow">for</span> (i = 0; i &lt; red-&gt;<a class="code" href="structrtp__red.html#a616e41679f381ce34cf536b20e24011a">num_gen</a>; i++)
<a name="l04853"></a>04853       red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[i] = red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[i+1];
<a name="l04854"></a>04854    red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[i] = red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;
<a name="l04855"></a>04855    
<a name="l04856"></a>04856    <span class="comment">/* write each generation length in red header */</span>
<a name="l04857"></a>04857    len = red-&gt;<a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">hdrlen</a>;
<a name="l04858"></a>04858    for (i = 0; i &lt; red-&gt;<a class="code" href="structrtp__red.html#a616e41679f381ce34cf536b20e24011a">num_gen</a>; i++)
<a name="l04859"></a>04859       len += data[i*4+3] = red-&gt;<a class="code" href="structrtp__red.html#a282db9d5b339e975a53fd7b57e398617">len</a>[i];
<a name="l04860"></a>04860    
<a name="l04861"></a>04861    <span class="comment">/* add primary data to buffer */</span>
<a name="l04862"></a>04862    memcpy(&amp;data[len], red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>); 
<a name="l04863"></a>04863    red-&gt;<a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = len + red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;
<a name="l04864"></a>04864    
<a name="l04865"></a>04865    <span class="comment">/* no primary data and no generations to send */</span>
<a name="l04866"></a>04866    <span class="keywordflow">if</span> (len == red-&gt;<a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">hdrlen</a> &amp;&amp; !red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>)
<a name="l04867"></a>04867       <span class="keywordflow">return</span> NULL;
<a name="l04868"></a>04868 
<a name="l04869"></a>04869    <span class="comment">/* reset t.140 buffer */</span>
<a name="l04870"></a>04870    red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0; 
<a name="l04871"></a>04871    
<a name="l04872"></a>04872    <span class="keywordflow">return</span> &amp;red-&gt;<a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a>;
<a name="l04873"></a>04873 }
<a name="l04874"></a>04874 <span class="comment"></span>
<a name="l04875"></a>04875 <span class="comment">/*! \brief Initialize t140 redundancy </span>
<a name="l04876"></a>04876 <span class="comment"> * \param rtp</span>
<a name="l04877"></a>04877 <span class="comment"> * \param ti buffer t140 for ti (msecs) before sending redundant frame</span>
<a name="l04878"></a>04878 <span class="comment"> * \param red_data_pt Payloadtypes for primary- and generation-data</span>
<a name="l04879"></a>04879 <span class="comment"> * \param num_gen numbers of generations (primary generation not encounted)</span>
<a name="l04880"></a>04880 <span class="comment"> *</span>
<a name="l04881"></a>04881 <span class="comment">*/</span>
<a name="l04882"></a><a class="code" href="rtp_8c.html#a35fed4b7e1a6bf60fe12b242231e6f99">04882</a> <span class="keywordtype">int</span> <a class="code" href="rtp_8h.html#abb328c934231a434fa342680b881e49a" title="Initalize t.140 redudancy.">rtp_red_init</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keywordtype">int</span> ti, <span class="keywordtype">int</span> *red_data_pt, <span class="keywordtype">int</span> num_gen)
<a name="l04883"></a>04883 {
<a name="l04884"></a>04884    <span class="keyword">struct </span><a class="code" href="structrtp__red.html">rtp_red</a> *r;
<a name="l04885"></a>04885    <span class="keywordtype">int</span> x;
<a name="l04886"></a>04886    
<a name="l04887"></a>04887    <span class="keywordflow">if</span> (!(r = <a class="code" href="astmm_8h.html#a1cb33b63d94fbbde94234b062249e015">ast_calloc</a>(1, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> <a class="code" href="structrtp__red.html">rtp_red</a>))))
<a name="l04888"></a>04888       <span class="keywordflow">return</span> -1;
<a name="l04889"></a>04889 
<a name="l04890"></a>04890    r-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#a6937b93c56cb473b547eda454dca7b4c">frametype</a> = <a class="code" href="frame_8h.html#ae2e1a9c4e048da387b761f619312d6e0af7728b18670d3cd075f63d67f8867078">AST_FRAME_TEXT</a>;
<a name="l04891"></a>04891    r-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#a8690cd2e4b0ef8477711b72a120ae086">subclass</a> = <a class="code" href="frame_8h.html#aa43d17815b58f27836a45fb310d33959">AST_FORMAT_T140RED</a>;
<a name="l04892"></a>04892    r-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = &amp;r-&gt;<a class="code" href="structrtp__red.html#a7f4fdeaff8e8d4e34a0f75b9863a69e0">buf_data</a>; 
<a name="l04893"></a>04893 
<a name="l04894"></a>04894    r-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a> = 0;
<a name="l04895"></a>04895    r-&gt;<a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a> = r-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>;
<a name="l04896"></a>04896    r-&gt;<a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a>.<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a> = &amp;r-&gt;<a class="code" href="structrtp__red.html#a13f1cf445ea8c204653722d23fc867b2">t140red_data</a>;
<a name="l04897"></a>04897    r-&gt;<a class="code" href="structrtp__red.html#adfe7111938aee5781b7eb99f86db13cd">t140red</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l04898"></a>04898    r-&gt;<a class="code" href="structrtp__red.html#ab15c864bf1bd92d2931e58603cfa7898">ti</a> = ti;
<a name="l04899"></a>04899    r-&gt;<a class="code" href="structrtp__red.html#a616e41679f381ce34cf536b20e24011a">num_gen</a> = num_gen;
<a name="l04900"></a>04900    r-&gt;<a class="code" href="structrtp__red.html#aba689c8df7cf733548a05ee5c649fd79">hdrlen</a> = num_gen * 4 + 1;
<a name="l04901"></a>04901    r-&gt;<a class="code" href="structrtp__red.html#ab142ba70d4b23b2c1f230a1f7e7d833a">prev_ts</a> = 0;
<a name="l04902"></a>04902 
<a name="l04903"></a>04903    <span class="keywordflow">for</span> (x = 0; x &lt; num_gen; x++) {
<a name="l04904"></a>04904       r-&gt;<a class="code" href="structrtp__red.html#adc4566d7080c1656aefc4560df8f6093">pt</a>[x] = red_data_pt[x];
<a name="l04905"></a>04905       r-&gt;<a class="code" href="structrtp__red.html#adc4566d7080c1656aefc4560df8f6093">pt</a>[x] |= 1 &lt;&lt; 7; <span class="comment">/* mark redundant generations pt */</span> 
<a name="l04906"></a>04906       r-&gt;<a class="code" href="structrtp__red.html#a13f1cf445ea8c204653722d23fc867b2">t140red_data</a>[x*4] = r-&gt;<a class="code" href="structrtp__red.html#adc4566d7080c1656aefc4560df8f6093">pt</a>[x];
<a name="l04907"></a>04907    }
<a name="l04908"></a>04908    r-&gt;<a class="code" href="structrtp__red.html#a13f1cf445ea8c204653722d23fc867b2">t140red_data</a>[x*4] = r-&gt;<a class="code" href="structrtp__red.html#adc4566d7080c1656aefc4560df8f6093">pt</a>[x] = red_data_pt[x]; <span class="comment">/* primary pt */</span>
<a name="l04909"></a>04909    r-&gt;<a class="code" href="structrtp__red.html#a1083e2d34bb1a32645f4681a7ee78b41">schedid</a> = <a class="code" href="sched_8h.html#a97176531282ac4e70aa107b2e8ee5543" title="Adds a scheduled event Schedule an event to take place at some point in the future...">ast_sched_add</a>(rtp-&gt;<a class="code" href="structast__rtp.html#aea6233539fc73fc5303bf7525ec27e73">sched</a>, ti, <a class="code" href="rtp_8c.html#af8fe2466849c65c9d60466c769ea5f2d" title="Write t140 redundacy frame.">red_write</a>, rtp);
<a name="l04910"></a>04910    rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a> = r;
<a name="l04911"></a>04911 
<a name="l04912"></a>04912    r-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> = 0;
<a name="l04913"></a>04913    
<a name="l04914"></a>04914    <span class="keywordflow">return</span> 0;
<a name="l04915"></a>04915 }
<a name="l04916"></a>04916 <span class="comment"></span>
<a name="l04917"></a>04917 <span class="comment">/*! \brief Buffer t140 from chan_sip</span>
<a name="l04918"></a>04918 <span class="comment"> * \param rtp</span>
<a name="l04919"></a>04919 <span class="comment"> * \param f frame</span>
<a name="l04920"></a>04920 <span class="comment"> */</span>
<a name="l04921"></a><a class="code" href="rtp_8c.html#aea735d249de828c184131bdb74863210">04921</a> <span class="keywordtype">void</span> <a class="code" href="rtp_8h.html#aea735d249de828c184131bdb74863210" title="Buffer t.140 data.">red_buffer_t140</a>(<span class="keyword">struct</span> <a class="code" href="structast__rtp.html" title="Structure representing a RTP session.">ast_rtp</a> *rtp, <span class="keyword">struct</span> <a class="code" href="structast__frame.html" title="Data structure associated with a single frame of data.">ast_frame</a> *<a class="code" href="format__g726_8c.html#a6add0b75a88c25db4ccbf690acda6d7f">f</a>)
<a name="l04922"></a>04922 {
<a name="l04923"></a>04923    <span class="keywordflow">if</span> (f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> &gt; -1) {
<a name="l04924"></a>04924       <span class="keyword">struct </span><a class="code" href="structrtp__red.html">rtp_red</a> *red = rtp-&gt;<a class="code" href="structast__rtp.html#af970d6ad39c43d25fcbb1e2bba07189c">red</a>;
<a name="l04925"></a>04925       memcpy(&amp;red-&gt;<a class="code" href="structrtp__red.html#a7f4fdeaff8e8d4e34a0f75b9863a69e0">buf_data</a>[red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>], f-&gt;<a class="code" href="structast__frame.html#a7c81436eb90123aabf892413fc5bf849">data</a>.<a class="code" href="structast__frame.html#add9af9569af79ec26dd741fb226b38ba">ptr</a>, f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>);
<a name="l04926"></a>04926       red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a> += f-&gt;<a class="code" href="structast__frame.html#ad67e07841d1233e596e6f822a3c81f6b">datalen</a>;
<a name="l04927"></a>04927       red-&gt;<a class="code" href="structrtp__red.html#a0a9f2f354cbd850064f42809bcee83dc">t140</a>.<a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a> = f-&gt;<a class="code" href="structast__frame.html#a1eb46dcb363821328c0d2a758549216b">ts</a>;
<a name="l04928"></a>04928    }
<a name="l04929"></a>04929 }
</pre></div></div>
<hr size="1"/><address style="text-align: right;"><small>Generated on Wed May 5 15:18:47 2010 for Asterisk - the Open Source PBX by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
